<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html" class="current">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7235713">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7235768">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7235822">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7235873">package</span>&nbsp;<span class="ident" id="7235881">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7235886">import</span>&nbsp;<span class="op" id="7235893">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7235896">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7235919">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7235929">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7235936">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7235942">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7235949">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7235957">&#34;strconv&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7235968">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7235979">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7235987">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7235998">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7236005">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7236008">var</span>&nbsp;<span class="ident" id="7236012">_</span>&nbsp;<span class="op" id="7236014">=</span>&nbsp;<span class="ident" id="7236016">log</span><span class="op" id="7236019">.</span><span class="ident" id="7236020">Printf</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7236028">//&nbsp;fakeDriver&nbsp;is&nbsp;a&nbsp;fake&nbsp;database&nbsp;that&nbsp;implements&nbsp;Go&#39;s&nbsp;driver.Driver</span><br>
<span class="lineno"></span><span class="comment" id="7236096">//&nbsp;interface,&nbsp;just&nbsp;for&nbsp;testing.</span><br>
<span class="lineno">25</span><span class="comment" id="7236128">//</span><br>
<span class="lineno"></span><span class="comment" id="7236131">//&nbsp;It&nbsp;speaks&nbsp;a&nbsp;query&nbsp;language&nbsp;that&#39;s&nbsp;semantically&nbsp;similar&nbsp;to&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="7236196">//&nbsp;syntactically&nbsp;different&nbsp;and&nbsp;simpler&nbsp;than&nbsp;SQL.&nbsp;&nbsp;The&nbsp;syntax&nbsp;is&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="7236263">//&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="7236275">//</span><br>
<span class="lineno">30</span><span class="comment" id="7236278">//&nbsp;&nbsp;&nbsp;WIPE</span><br>
<span class="lineno"></span><span class="comment" id="7236288">//&nbsp;&nbsp;&nbsp;CREATE|&lt;tablename&gt;|&lt;col&gt;=&lt;type&gt;,&lt;col&gt;=&lt;type&gt;,...</span><br>
<span class="lineno"></span><span class="comment" id="7236342">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;types&nbsp;are:&nbsp;&#34;string&#34;,&nbsp;[u]int{8,16,32,64},&nbsp;&#34;bool&#34;</span><br>
<span class="lineno"></span><span class="comment" id="7236403">//&nbsp;&nbsp;&nbsp;INSERT|&lt;tablename&gt;|col=val,col2=val2,col3=?</span><br>
<span class="lineno"></span><span class="comment" id="7236452">//&nbsp;&nbsp;&nbsp;SELECT|&lt;tablename&gt;|projectcol1,projectcol2|filtercol=?,filtercol2=?</span><br>
<span class="lineno">35</span><span class="comment" id="7236525">//</span><br>
<span class="lineno"></span><span class="comment" id="7236528">//&nbsp;When&nbsp;opening&nbsp;a&nbsp;fakeDriver&#39;s&nbsp;database,&nbsp;it&nbsp;starts&nbsp;empty&nbsp;with&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="7236593">//&nbsp;tables.&nbsp;&nbsp;All&nbsp;tables&nbsp;and&nbsp;data&nbsp;are&nbsp;stored&nbsp;in&nbsp;memory&nbsp;only.</span><br>
<span class="lineno"></span><span class="keyword" id="7236652">type</span>&nbsp;<span class="ident" id="7236657">fakeDriver</span>&nbsp;<span class="keyword" id="7236668">struct</span>&nbsp;<span class="op" id="7236675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7236678">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7236689">sync</span><span class="op" id="7236693">.</span><span class="ident" id="7236694">Mutex</span>&nbsp;<span class="comment" id="7236700">//&nbsp;guards&nbsp;3&nbsp;following&nbsp;fields</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7236730">openCount</span>&nbsp;&nbsp;<span class="builtintype" id="7236741">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7236752">//&nbsp;conn&nbsp;opens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7236767">closeCount</span>&nbsp;<span class="builtintype" id="7236778">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7236789">//&nbsp;conn&nbsp;closes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7236805">waitCh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7236816">chan</span>&nbsp;<span class="keyword" id="7236821">struct</span><span class="op" id="7236827">{</span><span class="op" id="7236828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7236831">waitingCh</span>&nbsp;&nbsp;<span class="keyword" id="7236842">chan</span>&nbsp;<span class="keyword" id="7236847">struct</span><span class="op" id="7236853">{</span><span class="op" id="7236854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7236857">dbs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7236868">map</span><span class="op" id="7236871">[</span><span class="builtintype" id="7236872">string</span><span class="op" id="7236878">]</span><span class="op" id="7236879">*</span><span class="ident" id="7236880">fakeDB</span><br>
<span class="lineno">45</span><span class="op" id="7236887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7236890">type</span>&nbsp;<span class="ident" id="7236895">fakeDB</span>&nbsp;<span class="keyword" id="7236902">struct</span>&nbsp;<span class="op" id="7236909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7236912">name</span>&nbsp;<span class="builtintype" id="7236917">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7236926">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7236934">sync</span><span class="op" id="7236938">.</span><span class="ident" id="7236939">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7236946">free</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7236954">[</span><span class="op" id="7236955">]</span><span class="op" id="7236956">*</span><span class="ident" id="7236957">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7236967">tables</span>&nbsp;&nbsp;<span class="keyword" id="7236975">map</span><span class="op" id="7236978">[</span><span class="builtintype" id="7236979">string</span><span class="op" id="7236985">]</span><span class="op" id="7236986">*</span><span class="ident" id="7236987">table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7236994">badConn</span>&nbsp;<span class="builtintype" id="7237002">bool</span><br>
<span class="lineno"></span><span class="op" id="7237007">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="7237010">type</span>&nbsp;<span class="ident" id="7237015">table</span>&nbsp;<span class="keyword" id="7237021">struct</span>&nbsp;<span class="op" id="7237028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237031">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237039">sync</span><span class="op" id="7237043">.</span><span class="ident" id="7237044">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237051">colname</span>&nbsp;<span class="op" id="7237059">[</span><span class="op" id="7237060">]</span><span class="builtintype" id="7237061">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237069">coltype</span>&nbsp;<span class="op" id="7237077">[</span><span class="op" id="7237078">]</span><span class="builtintype" id="7237079">string</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237087">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7237095">[</span><span class="op" id="7237096">]</span><span class="op" id="7237097">*</span><span class="ident" id="7237098">row</span><br>
<span class="lineno"></span><span class="op" id="7237102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7237105">func</span>&nbsp;<span class="op" id="7237110">(</span><span class="ident" id="7237111">t</span>&nbsp;<span class="op" id="7237113">*</span><span class="ident" id="7237114">table</span><span class="op" id="7237119">)</span>&nbsp;<span class="ident" id="7237121">columnIndex</span><span class="op" id="7237132">(</span><span class="ident" id="7237133">name</span>&nbsp;<span class="builtintype" id="7237138">string</span><span class="op" id="7237144">)</span>&nbsp;<span class="builtintype" id="7237146">int</span>&nbsp;<span class="op" id="7237150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7237153">for</span>&nbsp;<span class="ident" id="7237157">n</span><span class="op" id="7237158">,</span>&nbsp;<span class="ident" id="7237160">nname</span>&nbsp;<span class="op" id="7237166">:=</span>&nbsp;<span class="keyword" id="7237169">range</span>&nbsp;<span class="ident" id="7237175">t</span><span class="op" id="7237176">.</span><span class="ident" id="7237177">colname</span>&nbsp;<span class="op" id="7237185">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7237189">if</span>&nbsp;<span class="ident" id="7237192">name</span>&nbsp;<span class="op" id="7237197">==</span>&nbsp;<span class="ident" id="7237200">nname</span>&nbsp;<span class="op" id="7237206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7237211">return</span>&nbsp;<span class="ident" id="7237218">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7237222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7237225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7237228">return</span>&nbsp;<span class="op" id="7237235">-</span><span class="num" id="7237236">1</span><br>
<span class="lineno">70</span><span class="op" id="7237238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7237241">type</span>&nbsp;<span class="ident" id="7237246">row</span>&nbsp;<span class="keyword" id="7237250">struct</span>&nbsp;<span class="op" id="7237257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237260">cols</span>&nbsp;<span class="op" id="7237265">[</span><span class="op" id="7237266">]</span><span class="keyword" id="7237267">interface</span><span class="op" id="7237276">{</span><span class="op" id="7237277">}</span>&nbsp;<span class="comment" id="7237279">//&nbsp;must&nbsp;be&nbsp;same&nbsp;size&nbsp;as&nbsp;its&nbsp;table&nbsp;colname&nbsp;+&nbsp;coltype</span><br>
<span class="lineno"></span><span class="op" id="7237331">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="7237334">func</span>&nbsp;<span class="op" id="7237339">(</span><span class="ident" id="7237340">r</span>&nbsp;<span class="op" id="7237342">*</span><span class="ident" id="7237343">row</span><span class="op" id="7237346">)</span>&nbsp;<span class="ident" id="7237348">clone</span><span class="op" id="7237353">(</span><span class="op" id="7237354">)</span>&nbsp;<span class="op" id="7237356">*</span><span class="ident" id="7237357">row</span>&nbsp;<span class="op" id="7237361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237364">nrow</span>&nbsp;<span class="op" id="7237369">:=</span>&nbsp;<span class="op" id="7237372">&amp;</span><span class="ident" id="7237373">row</span><span class="op" id="7237376">{</span><span class="ident" id="7237377">cols</span><span class="op" id="7237381">:</span>&nbsp;<span class="builtinfunc" id="7237383">make</span><span class="op" id="7237387">(</span><span class="op" id="7237388">[</span><span class="op" id="7237389">]</span><span class="keyword" id="7237390">interface</span><span class="op" id="7237399">{</span><span class="op" id="7237400">}</span><span class="op" id="7237401">,</span>&nbsp;<span class="builtinfunc" id="7237403">len</span><span class="op" id="7237406">(</span><span class="ident" id="7237407">r</span><span class="op" id="7237408">.</span><span class="ident" id="7237409">cols</span><span class="op" id="7237413">)</span><span class="op" id="7237414">)</span><span class="op" id="7237415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7237418">copy</span><span class="op" id="7237422">(</span><span class="ident" id="7237423">nrow</span><span class="op" id="7237427">.</span><span class="ident" id="7237428">cols</span><span class="op" id="7237432">,</span>&nbsp;<span class="ident" id="7237434">r</span><span class="op" id="7237435">.</span><span class="ident" id="7237436">cols</span><span class="op" id="7237440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7237443">return</span>&nbsp;<span class="ident" id="7237450">nrow</span><br>
<span class="lineno">80</span><span class="op" id="7237455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7237458">type</span>&nbsp;<span class="ident" id="7237463">fakeConn</span>&nbsp;<span class="keyword" id="7237472">struct</span>&nbsp;<span class="op" id="7237479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237482">db</span>&nbsp;<span class="op" id="7237485">*</span><span class="ident" id="7237486">fakeDB</span>&nbsp;<span class="comment" id="7237493">//&nbsp;where&nbsp;to&nbsp;return&nbsp;ourselves&nbsp;to</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237527">currTx</span>&nbsp;<span class="op" id="7237534">*</span><span class="ident" id="7237535">fakeTx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7237544">//&nbsp;Stats&nbsp;for&nbsp;tests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237565">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237577">sync</span><span class="op" id="7237581">.</span><span class="ident" id="7237582">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237589">stmtsMade</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7237601">int</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237606">stmtsClosed</span>&nbsp;<span class="builtintype" id="7237618">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237623">numPrepare</span>&nbsp;&nbsp;<span class="builtintype" id="7237635">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237640">bad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7237652">bool</span><br>
<span class="lineno"></span><span class="op" id="7237657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7237660">func</span>&nbsp;<span class="op" id="7237665">(</span><span class="ident" id="7237666">c</span>&nbsp;<span class="op" id="7237668">*</span><span class="ident" id="7237669">fakeConn</span><span class="op" id="7237677">)</span>&nbsp;<span class="ident" id="7237679">incrStat</span><span class="op" id="7237687">(</span><span class="ident" id="7237688">v</span>&nbsp;<span class="op" id="7237690">*</span><span class="builtintype" id="7237691">int</span><span class="op" id="7237694">)</span>&nbsp;<span class="op" id="7237696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237699">c</span><span class="op" id="7237700">.</span><span class="ident" id="7237701">mu</span><span class="op" id="7237703">.</span><span class="ident" id="7237704">Lock</span><span class="op" id="7237708">(</span><span class="op" id="7237709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7237712">*</span><span class="ident" id="7237713">v</span><span class="op" id="7237714">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237718">c</span><span class="op" id="7237719">.</span><span class="ident" id="7237720">mu</span><span class="op" id="7237722">.</span><span class="ident" id="7237723">Unlock</span><span class="op" id="7237729">(</span><span class="op" id="7237730">)</span><br>
<span class="lineno"></span><span class="op" id="7237732">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="7237735">type</span>&nbsp;<span class="ident" id="7237740">fakeTx</span>&nbsp;<span class="keyword" id="7237747">struct</span>&nbsp;<span class="op" id="7237754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237757">c</span>&nbsp;<span class="op" id="7237759">*</span><span class="ident" id="7237760">fakeConn</span><br>
<span class="lineno"></span><span class="op" id="7237769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="7237772">type</span>&nbsp;<span class="ident" id="7237777">fakeStmt</span>&nbsp;<span class="keyword" id="7237786">struct</span>&nbsp;<span class="op" id="7237793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237796">c</span>&nbsp;<span class="op" id="7237798">*</span><span class="ident" id="7237799">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237809">q</span>&nbsp;<span class="builtintype" id="7237811">string</span>&nbsp;<span class="comment" id="7237818">//&nbsp;just&nbsp;for&nbsp;debugging</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237842">cmd</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7237848">string</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237856">table</span>&nbsp;<span class="builtintype" id="7237862">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237871">closed</span>&nbsp;<span class="builtintype" id="7237878">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237885">colName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7237898">[</span><span class="op" id="7237899">]</span><span class="builtintype" id="7237900">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7237912">//&nbsp;used&nbsp;by&nbsp;CREATE,&nbsp;INSERT,&nbsp;SELECT&nbsp;(selected&nbsp;columns)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7237966">colType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7237979">[</span><span class="op" id="7237980">]</span><span class="builtintype" id="7237981">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7237993">//&nbsp;used&nbsp;by&nbsp;CREATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7238012">colValue</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7238025">[</span><span class="op" id="7238026">]</span><span class="keyword" id="7238027">interface</span><span class="op" id="7238036">{</span><span class="op" id="7238037">}</span>&nbsp;<span class="comment" id="7238039">//&nbsp;used&nbsp;by&nbsp;INSERT&nbsp;(mix&nbsp;of&nbsp;strings&nbsp;and&nbsp;&#34;?&#34;&nbsp;for&nbsp;bound&nbsp;params)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7238100">placeholders</span>&nbsp;<span class="builtintype" id="7238113">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7238127">//&nbsp;used&nbsp;by&nbsp;INSERT/SELECT:&nbsp;number&nbsp;of&nbsp;?&nbsp;params</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7238174">whereCol</span>&nbsp;<span class="op" id="7238183">[</span><span class="op" id="7238184">]</span><span class="builtintype" id="7238185">string</span>&nbsp;<span class="comment" id="7238192">//&nbsp;used&nbsp;by&nbsp;SELECT&nbsp;(all&nbsp;placeholders)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7238231">placeholderConverter</span>&nbsp;<span class="op" id="7238252">[</span><span class="op" id="7238253">]</span><span class="ident" id="7238254">driver</span><span class="op" id="7238260">.</span><span class="ident" id="7238261">ValueConverter</span>&nbsp;<span class="comment" id="7238276">//&nbsp;used&nbsp;by&nbsp;INSERT</span><br>
<span class="lineno"></span><span class="op" id="7238294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7238297">var</span>&nbsp;<span class="ident" id="7238301">fdriver</span>&nbsp;<span class="ident" id="7238309">driver</span><span class="op" id="7238315">.</span><span class="ident" id="7238316">Driver</span>&nbsp;<span class="op" id="7238323">=</span>&nbsp;<span class="op" id="7238325">&amp;</span><span class="ident" id="7238326">fakeDriver</span><span class="op" id="7238336">{</span><span class="op" id="7238337">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="7238340">func</span>&nbsp;<span class="ident" id="7238345">init</span><span class="op" id="7238349">(</span><span class="op" id="7238350">)</span>&nbsp;<span class="op" id="7238352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7238355">Register</span><span class="op" id="7238363">(</span><span class="string" id="7238364">&#34;test&#34;</span><span class="op" id="7238370">,</span>&nbsp;<span class="ident" id="7238372">fdriver</span><span class="op" id="7238379">)</span><br>
<span class="lineno"></span><span class="op" id="7238381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="7238384">func</span>&nbsp;<span class="ident" id="7238389">contains</span><span class="op" id="7238397">(</span><span class="ident" id="7238398">list</span>&nbsp;<span class="op" id="7238403">[</span><span class="op" id="7238404">]</span><span class="builtintype" id="7238405">string</span><span class="op" id="7238411">,</span>&nbsp;<span class="ident" id="7238413">y</span>&nbsp;<span class="builtintype" id="7238415">string</span><span class="op" id="7238421">)</span>&nbsp;<span class="builtintype" id="7238423">bool</span>&nbsp;<span class="op" id="7238428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7238431">for</span>&nbsp;<span class="ident" id="7238435">_</span><span class="op" id="7238436">,</span>&nbsp;<span class="ident" id="7238438">x</span>&nbsp;<span class="op" id="7238440">:=</span>&nbsp;<span class="keyword" id="7238443">range</span>&nbsp;<span class="ident" id="7238449">list</span>&nbsp;<span class="op" id="7238454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7238458">if</span>&nbsp;<span class="ident" id="7238461">x</span>&nbsp;<span class="op" id="7238463">==</span>&nbsp;<span class="ident" id="7238466">y</span>&nbsp;<span class="op" id="7238468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7238473">return</span>&nbsp;<span class="builtintype" id="7238480">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7238487">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7238490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7238493">return</span>&nbsp;<span class="builtintype" id="7238500">false</span><br>
<span class="lineno"></span><span class="op" id="7238506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7238509">type</span>&nbsp;<span class="ident" id="7238514">Dummy</span>&nbsp;<span class="keyword" id="7238520">struct</span>&nbsp;<span class="op" id="7238527">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7238530">driver</span><span class="op" id="7238536">.</span><span class="ident" id="7238537">Driver</span><br>
<span class="lineno"></span><span class="op" id="7238544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7238547">func</span>&nbsp;<span class="ident" id="7238552">TestDrivers</span><span class="op" id="7238563">(</span><span class="ident" id="7238564">t</span>&nbsp;<span class="op" id="7238566">*</span><span class="ident" id="7238567">testing</span><span class="op" id="7238574">.</span><span class="ident" id="7238575">T</span><span class="op" id="7238576">)</span>&nbsp;<span class="op" id="7238578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7238581">unregisterAllDrivers</span><span class="op" id="7238601">(</span><span class="op" id="7238602">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7238605">Register</span><span class="op" id="7238613">(</span><span class="string" id="7238614">&#34;test&#34;</span><span class="op" id="7238620">,</span>&nbsp;<span class="ident" id="7238622">fdriver</span><span class="op" id="7238629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7238632">Register</span><span class="op" id="7238640">(</span><span class="string" id="7238641">&#34;invalid&#34;</span><span class="op" id="7238650">,</span>&nbsp;<span class="ident" id="7238652">Dummy</span><span class="op" id="7238657">{</span><span class="op" id="7238658">}</span><span class="op" id="7238659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7238662">all</span>&nbsp;<span class="op" id="7238666">:=</span>&nbsp;<span class="ident" id="7238669">Drivers</span><span class="op" id="7238676">(</span><span class="op" id="7238677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7238680">if</span>&nbsp;<span class="builtinfunc" id="7238683">len</span><span class="op" id="7238686">(</span><span class="ident" id="7238687">all</span><span class="op" id="7238690">)</span>&nbsp;<span class="op" id="7238692">&lt;</span>&nbsp;<span class="num" id="7238694">2</span>&nbsp;<span class="op" id="7238696">||</span>&nbsp;<span class="op" id="7238699">!</span><span class="ident" id="7238700">sort</span><span class="op" id="7238704">.</span><span class="ident" id="7238705">StringsAreSorted</span><span class="op" id="7238721">(</span><span class="ident" id="7238722">all</span><span class="op" id="7238725">)</span>&nbsp;<span class="op" id="7238727">||</span>&nbsp;<span class="op" id="7238730">!</span><span class="ident" id="7238731">contains</span><span class="op" id="7238739">(</span><span class="ident" id="7238740">all</span><span class="op" id="7238743">,</span>&nbsp;<span class="string" id="7238745">&#34;test&#34;</span><span class="op" id="7238751">)</span>&nbsp;<span class="op" id="7238753">||</span>&nbsp;<span class="op" id="7238756">!</span><span class="ident" id="7238757">contains</span><span class="op" id="7238765">(</span><span class="ident" id="7238766">all</span><span class="op" id="7238769">,</span>&nbsp;<span class="string" id="7238771">&#34;invalid&#34;</span><span class="op" id="7238780">)</span>&nbsp;<span class="op" id="7238782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7238786">t</span><span class="op" id="7238787">.</span><span class="ident" id="7238788">Fatalf</span><span class="op" id="7238794">(</span><span class="string" id="7238795">&#34;Drivers&nbsp;=&nbsp;%v,&nbsp;want&nbsp;sorted&nbsp;list&nbsp;with&nbsp;at&nbsp;least&nbsp;[invalid,&nbsp;test]&#34;</span><span class="op" id="7238857">,</span>&nbsp;<span class="ident" id="7238859">all</span><span class="op" id="7238862">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7238865">}</span><br>
<span class="lineno"></span><span class="op" id="7238867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7238870">//&nbsp;Supports&nbsp;dsn&nbsp;forms:</span><br>
<span class="lineno"></span><span class="comment" id="7238893">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;</span><br>
<span class="lineno">155</span><span class="comment" id="7238908">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;;&lt;opts&gt;&nbsp;&nbsp;(only&nbsp;currently&nbsp;supported&nbsp;option&nbsp;is&nbsp;`badConn`,</span><br>
<span class="lineno"></span><span class="comment" id="7238978">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;causes&nbsp;driver.ErrBadConn&nbsp;to&nbsp;be&nbsp;returned&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="7239051">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;every&nbsp;other&nbsp;conn.Begin())</span><br>
<span class="lineno"></span><span class="keyword" id="7239101">func</span>&nbsp;<span class="op" id="7239106">(</span><span class="ident" id="7239107">d</span>&nbsp;<span class="op" id="7239109">*</span><span class="ident" id="7239110">fakeDriver</span><span class="op" id="7239120">)</span>&nbsp;<span class="ident" id="7239122">Open</span><span class="op" id="7239126">(</span><span class="ident" id="7239127">dsn</span>&nbsp;<span class="builtintype" id="7239131">string</span><span class="op" id="7239137">)</span>&nbsp;<span class="op" id="7239139">(</span><span class="ident" id="7239140">driver</span><span class="op" id="7239146">.</span><span class="ident" id="7239147">Conn</span><span class="op" id="7239151">,</span>&nbsp;<span class="builtintype" id="7239153">error</span><span class="op" id="7239158">)</span>&nbsp;<span class="op" id="7239160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239163">parts</span>&nbsp;<span class="op" id="7239169">:=</span>&nbsp;<span class="ident" id="7239172">strings</span><span class="op" id="7239179">.</span><span class="ident" id="7239180">Split</span><span class="op" id="7239185">(</span><span class="ident" id="7239186">dsn</span><span class="op" id="7239189">,</span>&nbsp;<span class="string" id="7239191">&#34;;&#34;</span><span class="op" id="7239194">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7239197">if</span>&nbsp;<span class="builtinfunc" id="7239200">len</span><span class="op" id="7239203">(</span><span class="ident" id="7239204">parts</span><span class="op" id="7239209">)</span>&nbsp;<span class="op" id="7239211">&lt;</span>&nbsp;<span class="num" id="7239213">1</span>&nbsp;<span class="op" id="7239215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7239219">return</span>&nbsp;<span class="ident" id="7239226">nil</span><span class="op" id="7239229">,</span>&nbsp;<span class="ident" id="7239231">errors</span><span class="op" id="7239237">.</span><span class="ident" id="7239238">New</span><span class="op" id="7239241">(</span><span class="string" id="7239242">&#34;fakedb:&nbsp;no&nbsp;database&nbsp;name&#34;</span><span class="op" id="7239268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7239271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239274">name</span>&nbsp;<span class="op" id="7239279">:=</span>&nbsp;<span class="ident" id="7239282">parts</span><span class="op" id="7239287">[</span><span class="num" id="7239288">0</span><span class="op" id="7239289">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239293">db</span>&nbsp;<span class="op" id="7239296">:=</span>&nbsp;<span class="ident" id="7239299">d</span><span class="op" id="7239300">.</span><span class="ident" id="7239301">getDB</span><span class="op" id="7239306">(</span><span class="ident" id="7239307">name</span><span class="op" id="7239311">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239315">d</span><span class="op" id="7239316">.</span><span class="ident" id="7239317">mu</span><span class="op" id="7239319">.</span><span class="ident" id="7239320">Lock</span><span class="op" id="7239324">(</span><span class="op" id="7239325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239328">d</span><span class="op" id="7239329">.</span><span class="ident" id="7239330">openCount</span><span class="op" id="7239339">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239343">d</span><span class="op" id="7239344">.</span><span class="ident" id="7239345">mu</span><span class="op" id="7239347">.</span><span class="ident" id="7239348">Unlock</span><span class="op" id="7239354">(</span><span class="op" id="7239355">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239358">conn</span>&nbsp;<span class="op" id="7239363">:=</span>&nbsp;<span class="op" id="7239366">&amp;</span><span class="ident" id="7239367">fakeConn</span><span class="op" id="7239375">{</span><span class="ident" id="7239376">db</span><span class="op" id="7239378">:</span>&nbsp;<span class="ident" id="7239380">db</span><span class="op" id="7239382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7239386">if</span>&nbsp;<span class="builtinfunc" id="7239389">len</span><span class="op" id="7239392">(</span><span class="ident" id="7239393">parts</span><span class="op" id="7239398">)</span>&nbsp;<span class="op" id="7239400">&gt;=</span>&nbsp;<span class="num" id="7239403">2</span>&nbsp;<span class="op" id="7239405">&amp;&amp;</span>&nbsp;<span class="ident" id="7239408">parts</span><span class="op" id="7239413">[</span><span class="num" id="7239414">1</span><span class="op" id="7239415">]</span>&nbsp;<span class="op" id="7239417">==</span>&nbsp;<span class="string" id="7239420">&#34;badConn&#34;</span>&nbsp;<span class="op" id="7239430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239434">conn</span><span class="op" id="7239438">.</span><span class="ident" id="7239439">bad</span>&nbsp;<span class="op" id="7239443">=</span>&nbsp;<span class="builtintype" id="7239445">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7239451">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7239454">if</span>&nbsp;<span class="ident" id="7239457">d</span><span class="op" id="7239458">.</span><span class="ident" id="7239459">waitCh</span>&nbsp;<span class="op" id="7239466">!=</span>&nbsp;<span class="ident" id="7239469">nil</span>&nbsp;<span class="op" id="7239473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239477">d</span><span class="op" id="7239478">.</span><span class="ident" id="7239479">waitingCh</span>&nbsp;<span class="op" id="7239489">&lt;-</span>&nbsp;<span class="keyword" id="7239492">struct</span><span class="op" id="7239498">{</span><span class="op" id="7239499">}</span><span class="op" id="7239500">{</span><span class="op" id="7239501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7239505">&lt;-</span><span class="ident" id="7239507">d</span><span class="op" id="7239508">.</span><span class="ident" id="7239509">waitCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239518">d</span><span class="op" id="7239519">.</span><span class="ident" id="7239520">waitCh</span>&nbsp;<span class="op" id="7239527">=</span>&nbsp;<span class="ident" id="7239529">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239535">d</span><span class="op" id="7239536">.</span><span class="ident" id="7239537">waitingCh</span>&nbsp;<span class="op" id="7239547">=</span>&nbsp;<span class="ident" id="7239549">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7239554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7239557">return</span>&nbsp;<span class="ident" id="7239564">conn</span><span class="op" id="7239568">,</span>&nbsp;<span class="ident" id="7239570">nil</span><br>
<span class="lineno"></span><span class="op" id="7239574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7239577">func</span>&nbsp;<span class="op" id="7239582">(</span><span class="ident" id="7239583">d</span>&nbsp;<span class="op" id="7239585">*</span><span class="ident" id="7239586">fakeDriver</span><span class="op" id="7239596">)</span>&nbsp;<span class="ident" id="7239598">getDB</span><span class="op" id="7239603">(</span><span class="ident" id="7239604">name</span>&nbsp;<span class="builtintype" id="7239609">string</span><span class="op" id="7239615">)</span>&nbsp;<span class="op" id="7239617">*</span><span class="ident" id="7239618">fakeDB</span>&nbsp;<span class="op" id="7239625">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239628">d</span><span class="op" id="7239629">.</span><span class="ident" id="7239630">mu</span><span class="op" id="7239632">.</span><span class="ident" id="7239633">Lock</span><span class="op" id="7239637">(</span><span class="op" id="7239638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7239641">defer</span>&nbsp;<span class="ident" id="7239647">d</span><span class="op" id="7239648">.</span><span class="ident" id="7239649">mu</span><span class="op" id="7239651">.</span><span class="ident" id="7239652">Unlock</span><span class="op" id="7239658">(</span><span class="op" id="7239659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7239662">if</span>&nbsp;<span class="ident" id="7239665">d</span><span class="op" id="7239666">.</span><span class="ident" id="7239667">dbs</span>&nbsp;<span class="op" id="7239671">==</span>&nbsp;<span class="ident" id="7239674">nil</span>&nbsp;<span class="op" id="7239678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239682">d</span><span class="op" id="7239683">.</span><span class="ident" id="7239684">dbs</span>&nbsp;<span class="op" id="7239688">=</span>&nbsp;<span class="builtinfunc" id="7239690">make</span><span class="op" id="7239694">(</span><span class="keyword" id="7239695">map</span><span class="op" id="7239698">[</span><span class="builtintype" id="7239699">string</span><span class="op" id="7239705">]</span><span class="op" id="7239706">*</span><span class="ident" id="7239707">fakeDB</span><span class="op" id="7239713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7239716">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239719">db</span><span class="op" id="7239721">,</span>&nbsp;<span class="ident" id="7239723">ok</span>&nbsp;<span class="op" id="7239726">:=</span>&nbsp;<span class="ident" id="7239729">d</span><span class="op" id="7239730">.</span><span class="ident" id="7239731">dbs</span><span class="op" id="7239734">[</span><span class="ident" id="7239735">name</span><span class="op" id="7239739">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7239742">if</span>&nbsp;<span class="op" id="7239745">!</span><span class="ident" id="7239746">ok</span>&nbsp;<span class="op" id="7239749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239753">db</span>&nbsp;<span class="op" id="7239756">=</span>&nbsp;<span class="op" id="7239758">&amp;</span><span class="ident" id="7239759">fakeDB</span><span class="op" id="7239765">{</span><span class="ident" id="7239766">name</span><span class="op" id="7239770">:</span>&nbsp;<span class="ident" id="7239772">name</span><span class="op" id="7239776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239780">d</span><span class="op" id="7239781">.</span><span class="ident" id="7239782">dbs</span><span class="op" id="7239785">[</span><span class="ident" id="7239786">name</span><span class="op" id="7239790">]</span>&nbsp;<span class="op" id="7239792">=</span>&nbsp;<span class="ident" id="7239794">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7239798">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7239801">return</span>&nbsp;<span class="ident" id="7239808">db</span><br>
<span class="lineno"></span><span class="op" id="7239811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7239814">func</span>&nbsp;<span class="op" id="7239819">(</span><span class="ident" id="7239820">db</span>&nbsp;<span class="op" id="7239823">*</span><span class="ident" id="7239824">fakeDB</span><span class="op" id="7239830">)</span>&nbsp;<span class="ident" id="7239832">wipe</span><span class="op" id="7239836">(</span><span class="op" id="7239837">)</span>&nbsp;<span class="op" id="7239839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239842">db</span><span class="op" id="7239844">.</span><span class="ident" id="7239845">mu</span><span class="op" id="7239847">.</span><span class="ident" id="7239848">Lock</span><span class="op" id="7239852">(</span><span class="op" id="7239853">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7239856">defer</span>&nbsp;<span class="ident" id="7239862">db</span><span class="op" id="7239864">.</span><span class="ident" id="7239865">mu</span><span class="op" id="7239867">.</span><span class="ident" id="7239868">Unlock</span><span class="op" id="7239874">(</span><span class="op" id="7239875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239878">db</span><span class="op" id="7239880">.</span><span class="ident" id="7239881">tables</span>&nbsp;<span class="op" id="7239888">=</span>&nbsp;<span class="ident" id="7239890">nil</span><br>
<span class="lineno"></span><span class="op" id="7239894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7239897">func</span>&nbsp;<span class="op" id="7239902">(</span><span class="ident" id="7239903">db</span>&nbsp;<span class="op" id="7239906">*</span><span class="ident" id="7239907">fakeDB</span><span class="op" id="7239913">)</span>&nbsp;<span class="ident" id="7239915">createTable</span><span class="op" id="7239926">(</span><span class="ident" id="7239927">name</span>&nbsp;<span class="builtintype" id="7239932">string</span><span class="op" id="7239938">,</span>&nbsp;<span class="ident" id="7239940">columnNames</span><span class="op" id="7239951">,</span>&nbsp;<span class="ident" id="7239953">columnTypes</span>&nbsp;<span class="op" id="7239965">[</span><span class="op" id="7239966">]</span><span class="builtintype" id="7239967">string</span><span class="op" id="7239973">)</span>&nbsp;<span class="builtintype" id="7239975">error</span>&nbsp;<span class="op" id="7239981">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7239984">db</span><span class="op" id="7239986">.</span><span class="ident" id="7239987">mu</span><span class="op" id="7239989">.</span><span class="ident" id="7239990">Lock</span><span class="op" id="7239994">(</span><span class="op" id="7239995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7239998">defer</span>&nbsp;<span class="ident" id="7240004">db</span><span class="op" id="7240006">.</span><span class="ident" id="7240007">mu</span><span class="op" id="7240009">.</span><span class="ident" id="7240010">Unlock</span><span class="op" id="7240016">(</span><span class="op" id="7240017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240020">if</span>&nbsp;<span class="ident" id="7240023">db</span><span class="op" id="7240025">.</span><span class="ident" id="7240026">tables</span>&nbsp;<span class="op" id="7240033">==</span>&nbsp;<span class="ident" id="7240036">nil</span>&nbsp;<span class="op" id="7240040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7240044">db</span><span class="op" id="7240046">.</span><span class="ident" id="7240047">tables</span>&nbsp;<span class="op" id="7240054">=</span>&nbsp;<span class="builtinfunc" id="7240056">make</span><span class="op" id="7240060">(</span><span class="keyword" id="7240061">map</span><span class="op" id="7240064">[</span><span class="builtintype" id="7240065">string</span><span class="op" id="7240071">]</span><span class="op" id="7240072">*</span><span class="ident" id="7240073">table</span><span class="op" id="7240078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7240081">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240084">if</span>&nbsp;<span class="ident" id="7240087">_</span><span class="op" id="7240088">,</span>&nbsp;<span class="ident" id="7240090">exist</span>&nbsp;<span class="op" id="7240096">:=</span>&nbsp;<span class="ident" id="7240099">db</span><span class="op" id="7240101">.</span><span class="ident" id="7240102">tables</span><span class="op" id="7240108">[</span><span class="ident" id="7240109">name</span><span class="op" id="7240113">]</span><span class="op" id="7240114">;</span>&nbsp;<span class="ident" id="7240116">exist</span>&nbsp;<span class="op" id="7240122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240126">return</span>&nbsp;<span class="ident" id="7240133">fmt</span><span class="op" id="7240136">.</span><span class="ident" id="7240137">Errorf</span><span class="op" id="7240143">(</span><span class="string" id="7240144">&#34;table&nbsp;%q&nbsp;already&nbsp;exists&#34;</span><span class="op" id="7240169">,</span>&nbsp;<span class="ident" id="7240171">name</span><span class="op" id="7240175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7240178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240181">if</span>&nbsp;<span class="builtinfunc" id="7240184">len</span><span class="op" id="7240187">(</span><span class="ident" id="7240188">columnNames</span><span class="op" id="7240199">)</span>&nbsp;<span class="op" id="7240201">!=</span>&nbsp;<span class="builtinfunc" id="7240204">len</span><span class="op" id="7240207">(</span><span class="ident" id="7240208">columnTypes</span><span class="op" id="7240219">)</span>&nbsp;<span class="op" id="7240221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240225">return</span>&nbsp;<span class="ident" id="7240232">fmt</span><span class="op" id="7240235">.</span><span class="ident" id="7240236">Errorf</span><span class="op" id="7240242">(</span><span class="string" id="7240243">&#34;create&nbsp;table&nbsp;of&nbsp;%q&nbsp;len(names)&nbsp;!=&nbsp;len(types):&nbsp;%d&nbsp;vs&nbsp;%d&#34;</span><span class="op" id="7240298">,</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7240303">name</span><span class="op" id="7240307">,</span>&nbsp;<span class="builtinfunc" id="7240309">len</span><span class="op" id="7240312">(</span><span class="ident" id="7240313">columnNames</span><span class="op" id="7240324">)</span><span class="op" id="7240325">,</span>&nbsp;<span class="builtinfunc" id="7240327">len</span><span class="op" id="7240330">(</span><span class="ident" id="7240331">columnTypes</span><span class="op" id="7240342">)</span><span class="op" id="7240343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7240346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7240349">db</span><span class="op" id="7240351">.</span><span class="ident" id="7240352">tables</span><span class="op" id="7240358">[</span><span class="ident" id="7240359">name</span><span class="op" id="7240363">]</span>&nbsp;<span class="op" id="7240365">=</span>&nbsp;<span class="op" id="7240367">&amp;</span><span class="ident" id="7240368">table</span><span class="op" id="7240373">{</span><span class="ident" id="7240374">colname</span><span class="op" id="7240381">:</span>&nbsp;<span class="ident" id="7240383">columnNames</span><span class="op" id="7240394">,</span>&nbsp;<span class="ident" id="7240396">coltype</span><span class="op" id="7240403">:</span>&nbsp;<span class="ident" id="7240405">columnTypes</span><span class="op" id="7240416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240419">return</span>&nbsp;<span class="ident" id="7240426">nil</span><br>
<span class="lineno"></span><span class="op" id="7240430">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="7240433">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;db.mu&nbsp;lock&nbsp;held</span><br>
<span class="lineno"></span><span class="keyword" id="7240472">func</span>&nbsp;<span class="op" id="7240477">(</span><span class="ident" id="7240478">db</span>&nbsp;<span class="op" id="7240481">*</span><span class="ident" id="7240482">fakeDB</span><span class="op" id="7240488">)</span>&nbsp;<span class="ident" id="7240490">table</span><span class="op" id="7240495">(</span><span class="ident" id="7240496">table</span>&nbsp;<span class="builtintype" id="7240502">string</span><span class="op" id="7240508">)</span>&nbsp;<span class="op" id="7240510">(</span><span class="op" id="7240511">*</span><span class="ident" id="7240512">table</span><span class="op" id="7240517">,</span>&nbsp;<span class="builtintype" id="7240519">bool</span><span class="op" id="7240523">)</span>&nbsp;<span class="op" id="7240525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240528">if</span>&nbsp;<span class="ident" id="7240531">db</span><span class="op" id="7240533">.</span><span class="ident" id="7240534">tables</span>&nbsp;<span class="op" id="7240541">==</span>&nbsp;<span class="ident" id="7240544">nil</span>&nbsp;<span class="op" id="7240548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240552">return</span>&nbsp;<span class="ident" id="7240559">nil</span><span class="op" id="7240562">,</span>&nbsp;<span class="builtintype" id="7240564">false</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7240571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7240574">t</span><span class="op" id="7240575">,</span>&nbsp;<span class="ident" id="7240577">ok</span>&nbsp;<span class="op" id="7240580">:=</span>&nbsp;<span class="ident" id="7240583">db</span><span class="op" id="7240585">.</span><span class="ident" id="7240586">tables</span><span class="op" id="7240592">[</span><span class="ident" id="7240593">table</span><span class="op" id="7240598">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240601">return</span>&nbsp;<span class="ident" id="7240608">t</span><span class="op" id="7240609">,</span>&nbsp;<span class="ident" id="7240611">ok</span><br>
<span class="lineno"></span><span class="op" id="7240614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="7240617">func</span>&nbsp;<span class="op" id="7240622">(</span><span class="ident" id="7240623">db</span>&nbsp;<span class="op" id="7240626">*</span><span class="ident" id="7240627">fakeDB</span><span class="op" id="7240633">)</span>&nbsp;<span class="ident" id="7240635">columnType</span><span class="op" id="7240645">(</span><span class="ident" id="7240646">table</span><span class="op" id="7240651">,</span>&nbsp;<span class="ident" id="7240653">column</span>&nbsp;<span class="builtintype" id="7240660">string</span><span class="op" id="7240666">)</span>&nbsp;<span class="op" id="7240668">(</span><span class="ident" id="7240669">typ</span>&nbsp;<span class="builtintype" id="7240673">string</span><span class="op" id="7240679">,</span>&nbsp;<span class="ident" id="7240681">ok</span>&nbsp;<span class="builtintype" id="7240684">bool</span><span class="op" id="7240688">)</span>&nbsp;<span class="op" id="7240690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7240693">db</span><span class="op" id="7240695">.</span><span class="ident" id="7240696">mu</span><span class="op" id="7240698">.</span><span class="ident" id="7240699">Lock</span><span class="op" id="7240703">(</span><span class="op" id="7240704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240707">defer</span>&nbsp;<span class="ident" id="7240713">db</span><span class="op" id="7240715">.</span><span class="ident" id="7240716">mu</span><span class="op" id="7240718">.</span><span class="ident" id="7240719">Unlock</span><span class="op" id="7240725">(</span><span class="op" id="7240726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7240729">t</span><span class="op" id="7240730">,</span>&nbsp;<span class="ident" id="7240732">ok</span>&nbsp;<span class="op" id="7240735">:=</span>&nbsp;<span class="ident" id="7240738">db</span><span class="op" id="7240740">.</span><span class="ident" id="7240741">table</span><span class="op" id="7240746">(</span><span class="ident" id="7240747">table</span><span class="op" id="7240752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240755">if</span>&nbsp;<span class="op" id="7240758">!</span><span class="ident" id="7240759">ok</span>&nbsp;<span class="op" id="7240762">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240766">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7240774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240777">for</span>&nbsp;<span class="ident" id="7240781">n</span><span class="op" id="7240782">,</span>&nbsp;<span class="ident" id="7240784">cname</span>&nbsp;<span class="op" id="7240790">:=</span>&nbsp;<span class="keyword" id="7240793">range</span>&nbsp;<span class="ident" id="7240799">t</span><span class="op" id="7240800">.</span><span class="ident" id="7240801">colname</span>&nbsp;<span class="op" id="7240809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240813">if</span>&nbsp;<span class="ident" id="7240816">cname</span>&nbsp;<span class="op" id="7240822">==</span>&nbsp;<span class="ident" id="7240825">column</span>&nbsp;<span class="op" id="7240832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240837">return</span>&nbsp;<span class="ident" id="7240844">t</span><span class="op" id="7240845">.</span><span class="ident" id="7240846">coltype</span><span class="op" id="7240853">[</span><span class="ident" id="7240854">n</span><span class="op" id="7240855">]</span><span class="op" id="7240856">,</span>&nbsp;<span class="builtintype" id="7240858">true</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7240865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7240868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240871">return</span>&nbsp;<span class="string" id="7240878">&#34;&#34;</span><span class="op" id="7240880">,</span>&nbsp;<span class="builtintype" id="7240882">false</span><br>
<span class="lineno"></span><span class="op" id="7240888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="keyword" id="7240891">func</span>&nbsp;<span class="op" id="7240896">(</span><span class="ident" id="7240897">c</span>&nbsp;<span class="op" id="7240899">*</span><span class="ident" id="7240900">fakeConn</span><span class="op" id="7240908">)</span>&nbsp;<span class="ident" id="7240910">isBad</span><span class="op" id="7240915">(</span><span class="op" id="7240916">)</span>&nbsp;<span class="builtintype" id="7240918">bool</span>&nbsp;<span class="op" id="7240923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7240926">//&nbsp;if&nbsp;not&nbsp;simulating&nbsp;bad&nbsp;conn,&nbsp;do&nbsp;nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240969">if</span>&nbsp;<span class="op" id="7240972">!</span><span class="ident" id="7240973">c</span><span class="op" id="7240974">.</span><span class="ident" id="7240975">bad</span>&nbsp;<span class="op" id="7240979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7240983">return</span>&nbsp;<span class="builtintype" id="7240990">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7240997">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7241000">//&nbsp;alternate&nbsp;between&nbsp;bad&nbsp;conn&nbsp;and&nbsp;not&nbsp;bad&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7241048">c</span><span class="op" id="7241049">.</span><span class="ident" id="7241050">db</span><span class="op" id="7241052">.</span><span class="ident" id="7241053">badConn</span>&nbsp;<span class="op" id="7241061">=</span>&nbsp;<span class="op" id="7241063">!</span><span class="ident" id="7241064">c</span><span class="op" id="7241065">.</span><span class="ident" id="7241066">db</span><span class="op" id="7241068">.</span><span class="ident" id="7241069">badConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7241078">return</span>&nbsp;<span class="ident" id="7241085">c</span><span class="op" id="7241086">.</span><span class="ident" id="7241087">db</span><span class="op" id="7241089">.</span><span class="ident" id="7241090">badConn</span><br>
<span class="lineno"></span><span class="op" id="7241098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="7241101">func</span>&nbsp;<span class="op" id="7241106">(</span><span class="ident" id="7241107">c</span>&nbsp;<span class="op" id="7241109">*</span><span class="ident" id="7241110">fakeConn</span><span class="op" id="7241118">)</span>&nbsp;<span class="ident" id="7241120">Begin</span><span class="op" id="7241125">(</span><span class="op" id="7241126">)</span>&nbsp;<span class="op" id="7241128">(</span><span class="ident" id="7241129">driver</span><span class="op" id="7241135">.</span><span class="ident" id="7241136">Tx</span><span class="op" id="7241138">,</span>&nbsp;<span class="builtintype" id="7241140">error</span><span class="op" id="7241145">)</span>&nbsp;<span class="op" id="7241147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7241150">if</span>&nbsp;<span class="ident" id="7241153">c</span><span class="op" id="7241154">.</span><span class="ident" id="7241155">isBad</span><span class="op" id="7241160">(</span><span class="op" id="7241161">)</span>&nbsp;<span class="op" id="7241163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7241167">return</span>&nbsp;<span class="ident" id="7241174">nil</span><span class="op" id="7241177">,</span>&nbsp;<span class="ident" id="7241179">driver</span><span class="op" id="7241185">.</span><span class="ident" id="7241186">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7241198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7241201">if</span>&nbsp;<span class="ident" id="7241204">c</span><span class="op" id="7241205">.</span><span class="ident" id="7241206">currTx</span>&nbsp;<span class="op" id="7241213">!=</span>&nbsp;<span class="ident" id="7241216">nil</span>&nbsp;<span class="op" id="7241220">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7241224">return</span>&nbsp;<span class="ident" id="7241231">nil</span><span class="op" id="7241234">,</span>&nbsp;<span class="ident" id="7241236">errors</span><span class="op" id="7241242">.</span><span class="ident" id="7241243">New</span><span class="op" id="7241246">(</span><span class="string" id="7241247">&#34;already&nbsp;in&nbsp;a&nbsp;transaction&#34;</span><span class="op" id="7241273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7241276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7241279">c</span><span class="op" id="7241280">.</span><span class="ident" id="7241281">currTx</span>&nbsp;<span class="op" id="7241288">=</span>&nbsp;<span class="op" id="7241290">&amp;</span><span class="ident" id="7241291">fakeTx</span><span class="op" id="7241297">{</span><span class="ident" id="7241298">c</span><span class="op" id="7241299">:</span>&nbsp;<span class="ident" id="7241301">c</span><span class="op" id="7241302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7241305">return</span>&nbsp;<span class="ident" id="7241312">c</span><span class="op" id="7241313">.</span><span class="ident" id="7241314">currTx</span><span class="op" id="7241320">,</span>&nbsp;<span class="ident" id="7241322">nil</span><br>
<span class="lineno"></span><span class="op" id="7241326">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="7241329">var</span>&nbsp;<span class="ident" id="7241333">hookPostCloseConn</span>&nbsp;<span class="keyword" id="7241351">struct</span>&nbsp;<span class="op" id="7241358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7241361">sync</span><span class="op" id="7241365">.</span><span class="ident" id="7241366">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7241373">fn</span>&nbsp;<span class="keyword" id="7241376">func</span><span class="op" id="7241380">(</span><span class="op" id="7241381">*</span><span class="ident" id="7241382">fakeConn</span><span class="op" id="7241390">,</span>&nbsp;<span class="builtintype" id="7241392">error</span><span class="op" id="7241397">)</span><br>
<span class="lineno"></span><span class="op" id="7241399">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="7241402">func</span>&nbsp;<span class="ident" id="7241407">setHookpostCloseConn</span><span class="op" id="7241427">(</span><span class="ident" id="7241428">fn</span>&nbsp;<span class="keyword" id="7241431">func</span><span class="op" id="7241435">(</span><span class="op" id="7241436">*</span><span class="ident" id="7241437">fakeConn</span><span class="op" id="7241445">,</span>&nbsp;<span class="builtintype" id="7241447">error</span><span class="op" id="7241452">)</span><span class="op" id="7241453">)</span>&nbsp;<span class="op" id="7241455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7241458">hookPostCloseConn</span><span class="op" id="7241475">.</span><span class="ident" id="7241476">Lock</span><span class="op" id="7241480">(</span><span class="op" id="7241481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7241484">defer</span>&nbsp;<span class="ident" id="7241490">hookPostCloseConn</span><span class="op" id="7241507">.</span><span class="ident" id="7241508">Unlock</span><span class="op" id="7241514">(</span><span class="op" id="7241515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7241518">hookPostCloseConn</span><span class="op" id="7241535">.</span><span class="ident" id="7241536">fn</span>&nbsp;<span class="op" id="7241539">=</span>&nbsp;<span class="ident" id="7241541">fn</span><br>
<span class="lineno">275</span><span class="op" id="7241544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7241547">var</span>&nbsp;<span class="ident" id="7241551">testStrictClose</span>&nbsp;<span class="op" id="7241567">*</span><span class="ident" id="7241568">testing</span><span class="op" id="7241575">.</span><span class="ident" id="7241576">T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7241579">//&nbsp;setStrictFakeConnClose&nbsp;sets&nbsp;the&nbsp;t&nbsp;to&nbsp;Errorf&nbsp;on&nbsp;when&nbsp;fakeConn.Close</span><br>
<span class="lineno">280</span><span class="comment" id="7241649">//&nbsp;fails&nbsp;to&nbsp;close.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;check&nbsp;is&nbsp;disabled.</span><br>
<span class="lineno"></span><span class="keyword" id="7241699">func</span>&nbsp;<span class="ident" id="7241704">setStrictFakeConnClose</span><span class="op" id="7241726">(</span><span class="ident" id="7241727">t</span>&nbsp;<span class="op" id="7241729">*</span><span class="ident" id="7241730">testing</span><span class="op" id="7241737">.</span><span class="ident" id="7241738">T</span><span class="op" id="7241739">)</span>&nbsp;<span class="op" id="7241741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7241744">testStrictClose</span>&nbsp;<span class="op" id="7241760">=</span>&nbsp;<span class="ident" id="7241762">t</span><br>
<span class="lineno"></span><span class="op" id="7241764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="7241767">func</span>&nbsp;<span class="op" id="7241772">(</span><span class="ident" id="7241773">c</span>&nbsp;<span class="op" id="7241775">*</span><span class="ident" id="7241776">fakeConn</span><span class="op" id="7241784">)</span>&nbsp;<span class="ident" id="7241786">Close</span><span class="op" id="7241791">(</span><span class="op" id="7241792">)</span>&nbsp;<span class="op" id="7241794">(</span><span class="ident" id="7241795">err</span>&nbsp;<span class="builtintype" id="7241799">error</span><span class="op" id="7241804">)</span>&nbsp;<span class="op" id="7241806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7241809">drv</span>&nbsp;<span class="op" id="7241813">:=</span>&nbsp;<span class="ident" id="7241816">fdriver</span><span class="op" id="7241823">.</span><span class="op" id="7241824">(</span><span class="op" id="7241825">*</span><span class="ident" id="7241826">fakeDriver</span><span class="op" id="7241836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7241839">defer</span>&nbsp;<span class="keyword" id="7241845">func</span><span class="op" id="7241849">(</span><span class="op" id="7241850">)</span>&nbsp;<span class="op" id="7241852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7241856">if</span>&nbsp;<span class="ident" id="7241859">err</span>&nbsp;<span class="op" id="7241863">!=</span>&nbsp;<span class="ident" id="7241866">nil</span>&nbsp;<span class="op" id="7241870">&amp;&amp;</span>&nbsp;<span class="ident" id="7241873">testStrictClose</span>&nbsp;<span class="op" id="7241889">!=</span>&nbsp;<span class="ident" id="7241892">nil</span>&nbsp;<span class="op" id="7241896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7241901">testStrictClose</span><span class="op" id="7241916">.</span><span class="ident" id="7241917">Errorf</span><span class="op" id="7241923">(</span><span class="string" id="7241924">&#34;failed&nbsp;to&nbsp;close&nbsp;a&nbsp;test&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7241961">,</span>&nbsp;<span class="ident" id="7241963">err</span><span class="op" id="7241966">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7241970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7241974">hookPostCloseConn</span><span class="op" id="7241991">.</span><span class="ident" id="7241992">Lock</span><span class="op" id="7241996">(</span><span class="op" id="7241997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7242001">fn</span>&nbsp;<span class="op" id="7242004">:=</span>&nbsp;<span class="ident" id="7242007">hookPostCloseConn</span><span class="op" id="7242024">.</span><span class="ident" id="7242025">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7242030">hookPostCloseConn</span><span class="op" id="7242047">.</span><span class="ident" id="7242048">Unlock</span><span class="op" id="7242054">(</span><span class="op" id="7242055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7242059">if</span>&nbsp;<span class="ident" id="7242062">fn</span>&nbsp;<span class="op" id="7242065">!=</span>&nbsp;<span class="ident" id="7242068">nil</span>&nbsp;<span class="op" id="7242072">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7242077">fn</span><span class="op" id="7242079">(</span><span class="ident" id="7242080">c</span><span class="op" id="7242081">,</span>&nbsp;<span class="ident" id="7242083">err</span><span class="op" id="7242086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7242090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7242094">if</span>&nbsp;<span class="ident" id="7242097">err</span>&nbsp;<span class="op" id="7242101">==</span>&nbsp;<span class="ident" id="7242104">nil</span>&nbsp;<span class="op" id="7242108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7242113">drv</span><span class="op" id="7242116">.</span><span class="ident" id="7242117">mu</span><span class="op" id="7242119">.</span><span class="ident" id="7242120">Lock</span><span class="op" id="7242124">(</span><span class="op" id="7242125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7242130">drv</span><span class="op" id="7242133">.</span><span class="ident" id="7242134">closeCount</span><span class="op" id="7242144">++</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7242150">drv</span><span class="op" id="7242153">.</span><span class="ident" id="7242154">mu</span><span class="op" id="7242156">.</span><span class="ident" id="7242157">Unlock</span><span class="op" id="7242163">(</span><span class="op" id="7242164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7242168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7242171">}</span><span class="op" id="7242172">(</span><span class="op" id="7242173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7242176">if</span>&nbsp;<span class="ident" id="7242179">c</span><span class="op" id="7242180">.</span><span class="ident" id="7242181">currTx</span>&nbsp;<span class="op" id="7242188">!=</span>&nbsp;<span class="ident" id="7242191">nil</span>&nbsp;<span class="op" id="7242195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7242199">return</span>&nbsp;<span class="ident" id="7242206">errors</span><span class="op" id="7242212">.</span><span class="ident" id="7242213">New</span><span class="op" id="7242216">(</span><span class="string" id="7242217">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;in&nbsp;a&nbsp;Transaction&#34;</span><span class="op" id="7242257">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7242260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7242263">if</span>&nbsp;<span class="ident" id="7242266">c</span><span class="op" id="7242267">.</span><span class="ident" id="7242268">db</span>&nbsp;<span class="op" id="7242271">==</span>&nbsp;<span class="ident" id="7242274">nil</span>&nbsp;<span class="op" id="7242278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7242282">return</span>&nbsp;<span class="ident" id="7242289">errors</span><span class="op" id="7242295">.</span><span class="ident" id="7242296">New</span><span class="op" id="7242299">(</span><span class="string" id="7242300">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;already&nbsp;closed&#34;</span><span class="op" id="7242338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7242341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7242344">if</span>&nbsp;<span class="ident" id="7242347">c</span><span class="op" id="7242348">.</span><span class="ident" id="7242349">stmtsMade</span>&nbsp;<span class="op" id="7242359">&gt;</span>&nbsp;<span class="ident" id="7242361">c</span><span class="op" id="7242362">.</span><span class="ident" id="7242363">stmtsClosed</span>&nbsp;<span class="op" id="7242375">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7242379">return</span>&nbsp;<span class="ident" id="7242386">errors</span><span class="op" id="7242392">.</span><span class="ident" id="7242393">New</span><span class="op" id="7242396">(</span><span class="string" id="7242397">&#34;can&#39;t&nbsp;close;&nbsp;dangling&nbsp;statement(s)&#34;</span><span class="op" id="7242433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7242436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7242439">c</span><span class="op" id="7242440">.</span><span class="ident" id="7242441">db</span>&nbsp;<span class="op" id="7242444">=</span>&nbsp;<span class="ident" id="7242446">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7242451">return</span>&nbsp;<span class="ident" id="7242458">nil</span><br>
<span class="lineno"></span><span class="op" id="7242462">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="7242465">func</span>&nbsp;<span class="ident" id="7242470">checkSubsetTypes</span><span class="op" id="7242486">(</span><span class="ident" id="7242487">args</span>&nbsp;<span class="op" id="7242492">[</span><span class="op" id="7242493">]</span><span class="ident" id="7242494">driver</span><span class="op" id="7242500">.</span><span class="ident" id="7242501">Value</span><span class="op" id="7242506">)</span>&nbsp;<span class="builtintype" id="7242508">error</span>&nbsp;<span class="op" id="7242514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7242517">for</span>&nbsp;<span class="ident" id="7242521">n</span><span class="op" id="7242522">,</span>&nbsp;<span class="ident" id="7242524">arg</span>&nbsp;<span class="op" id="7242528">:=</span>&nbsp;<span class="keyword" id="7242531">range</span>&nbsp;<span class="ident" id="7242537">args</span>&nbsp;<span class="op" id="7242542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7242546">switch</span>&nbsp;<span class="ident" id="7242553">arg</span><span class="op" id="7242556">.</span><span class="op" id="7242557">(</span><span class="keyword" id="7242558">type</span><span class="op" id="7242562">)</span>&nbsp;<span class="op" id="7242564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7242568">case</span>&nbsp;<span class="ident" id="7242573">int64</span><span class="op" id="7242578">,</span>&nbsp;<span class="builtintype" id="7242580">float64</span><span class="op" id="7242587">,</span>&nbsp;<span class="builtintype" id="7242589">bool</span><span class="op" id="7242593">,</span>&nbsp;<span class="ident" id="7242595">nil</span><span class="op" id="7242598">,</span>&nbsp;<span class="op" id="7242600">[</span><span class="op" id="7242601">]</span><span class="builtintype" id="7242602">byte</span><span class="op" id="7242606">,</span>&nbsp;<span class="builtintype" id="7242608">string</span><span class="op" id="7242614">,</span>&nbsp;<span class="ident" id="7242616">time</span><span class="op" id="7242620">.</span><span class="ident" id="7242621">Time</span><span class="op" id="7242625">:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7242629">default</span><span class="op" id="7242636">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7242641">return</span>&nbsp;<span class="ident" id="7242648">fmt</span><span class="op" id="7242651">.</span><span class="ident" id="7242652">Errorf</span><span class="op" id="7242658">(</span><span class="string" id="7242659">&#34;fakedb_test:&nbsp;invalid&nbsp;argument&nbsp;#%d:&nbsp;%v,&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7242707">,</span>&nbsp;<span class="ident" id="7242709">n</span><span class="op" id="7242710">+</span><span class="num" id="7242711">1</span><span class="op" id="7242712">,</span>&nbsp;<span class="ident" id="7242714">arg</span><span class="op" id="7242717">,</span>&nbsp;<span class="ident" id="7242719">arg</span><span class="op" id="7242722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7242726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7242729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7242732">return</span>&nbsp;<span class="ident" id="7242739">nil</span><br>
<span class="lineno">325</span><span class="op" id="7242743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7242746">func</span>&nbsp;<span class="op" id="7242751">(</span><span class="ident" id="7242752">c</span>&nbsp;<span class="op" id="7242754">*</span><span class="ident" id="7242755">fakeConn</span><span class="op" id="7242763">)</span>&nbsp;<span class="ident" id="7242765">Exec</span><span class="op" id="7242769">(</span><span class="ident" id="7242770">query</span>&nbsp;<span class="builtintype" id="7242776">string</span><span class="op" id="7242782">,</span>&nbsp;<span class="ident" id="7242784">args</span>&nbsp;<span class="op" id="7242789">[</span><span class="op" id="7242790">]</span><span class="ident" id="7242791">driver</span><span class="op" id="7242797">.</span><span class="ident" id="7242798">Value</span><span class="op" id="7242803">)</span>&nbsp;<span class="op" id="7242805">(</span><span class="ident" id="7242806">driver</span><span class="op" id="7242812">.</span><span class="ident" id="7242813">Result</span><span class="op" id="7242819">,</span>&nbsp;<span class="builtintype" id="7242821">error</span><span class="op" id="7242826">)</span>&nbsp;<span class="op" id="7242828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7242831">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7242892">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7242953">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7243012">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7243039">err</span>&nbsp;<span class="op" id="7243043">:=</span>&nbsp;<span class="ident" id="7243046">checkSubsetTypes</span><span class="op" id="7243062">(</span><span class="ident" id="7243063">args</span><span class="op" id="7243067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7243070">if</span>&nbsp;<span class="ident" id="7243073">err</span>&nbsp;<span class="op" id="7243077">!=</span>&nbsp;<span class="ident" id="7243080">nil</span>&nbsp;<span class="op" id="7243084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7243088">return</span>&nbsp;<span class="ident" id="7243095">nil</span><span class="op" id="7243098">,</span>&nbsp;<span class="ident" id="7243100">err</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7243105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7243108">return</span>&nbsp;<span class="ident" id="7243115">nil</span><span class="op" id="7243118">,</span>&nbsp;<span class="ident" id="7243120">driver</span><span class="op" id="7243126">.</span><span class="ident" id="7243127">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="7243135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7243138">func</span>&nbsp;<span class="op" id="7243143">(</span><span class="ident" id="7243144">c</span>&nbsp;<span class="op" id="7243146">*</span><span class="ident" id="7243147">fakeConn</span><span class="op" id="7243155">)</span>&nbsp;<span class="ident" id="7243157">Query</span><span class="op" id="7243162">(</span><span class="ident" id="7243163">query</span>&nbsp;<span class="builtintype" id="7243169">string</span><span class="op" id="7243175">,</span>&nbsp;<span class="ident" id="7243177">args</span>&nbsp;<span class="op" id="7243182">[</span><span class="op" id="7243183">]</span><span class="ident" id="7243184">driver</span><span class="op" id="7243190">.</span><span class="ident" id="7243191">Value</span><span class="op" id="7243196">)</span>&nbsp;<span class="op" id="7243198">(</span><span class="ident" id="7243199">driver</span><span class="op" id="7243205">.</span><span class="ident" id="7243206">Rows</span><span class="op" id="7243210">,</span>&nbsp;<span class="builtintype" id="7243212">error</span><span class="op" id="7243217">)</span>&nbsp;<span class="op" id="7243219">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7243222">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7243283">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7243344">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7243403">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7243430">err</span>&nbsp;<span class="op" id="7243434">:=</span>&nbsp;<span class="ident" id="7243437">checkSubsetTypes</span><span class="op" id="7243453">(</span><span class="ident" id="7243454">args</span><span class="op" id="7243458">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7243461">if</span>&nbsp;<span class="ident" id="7243464">err</span>&nbsp;<span class="op" id="7243468">!=</span>&nbsp;<span class="ident" id="7243471">nil</span>&nbsp;<span class="op" id="7243475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7243479">return</span>&nbsp;<span class="ident" id="7243486">nil</span><span class="op" id="7243489">,</span>&nbsp;<span class="ident" id="7243491">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7243496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7243499">return</span>&nbsp;<span class="ident" id="7243506">nil</span><span class="op" id="7243509">,</span>&nbsp;<span class="ident" id="7243511">driver</span><span class="op" id="7243517">.</span><span class="ident" id="7243518">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="7243526">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="7243529">func</span>&nbsp;<span class="ident" id="7243534">errf</span><span class="op" id="7243538">(</span><span class="ident" id="7243539">msg</span>&nbsp;<span class="builtintype" id="7243543">string</span><span class="op" id="7243549">,</span>&nbsp;<span class="ident" id="7243551">args</span>&nbsp;<span class="op" id="7243556">...</span><span class="keyword" id="7243559">interface</span><span class="op" id="7243568">{</span><span class="op" id="7243569">}</span><span class="op" id="7243570">)</span>&nbsp;<span class="builtintype" id="7243572">error</span>&nbsp;<span class="op" id="7243578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7243581">return</span>&nbsp;<span class="ident" id="7243588">errors</span><span class="op" id="7243594">.</span><span class="ident" id="7243595">New</span><span class="op" id="7243598">(</span><span class="string" id="7243599">&#34;fakedb:&nbsp;&#34;</span>&nbsp;<span class="op" id="7243610">+</span>&nbsp;<span class="ident" id="7243612">fmt</span><span class="op" id="7243615">.</span><span class="ident" id="7243616">Sprintf</span><span class="op" id="7243623">(</span><span class="ident" id="7243624">msg</span><span class="op" id="7243627">,</span>&nbsp;<span class="ident" id="7243629">args</span><span class="op" id="7243633">...</span><span class="op" id="7243636">)</span><span class="op" id="7243637">)</span><br>
<span class="lineno"></span><span class="op" id="7243639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="7243642">//&nbsp;parts&nbsp;are&nbsp;table|selectCol1,selectCol2|whereCol=?,whereCol2=?</span><br>
<span class="lineno"></span><span class="comment" id="7243706">//&nbsp;(note&nbsp;that&nbsp;where&nbsp;columns&nbsp;must&nbsp;always&nbsp;contain&nbsp;?&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="7243763">//&nbsp;&nbsp;just&nbsp;a&nbsp;limitation&nbsp;for&nbsp;fakedb)</span><br>
<span class="lineno"></span><span class="keyword" id="7243797">func</span>&nbsp;<span class="op" id="7243802">(</span><span class="ident" id="7243803">c</span>&nbsp;<span class="op" id="7243805">*</span><span class="ident" id="7243806">fakeConn</span><span class="op" id="7243814">)</span>&nbsp;<span class="ident" id="7243816">prepareSelect</span><span class="op" id="7243829">(</span><span class="ident" id="7243830">stmt</span>&nbsp;<span class="op" id="7243835">*</span><span class="ident" id="7243836">fakeStmt</span><span class="op" id="7243844">,</span>&nbsp;<span class="ident" id="7243846">parts</span>&nbsp;<span class="op" id="7243852">[</span><span class="op" id="7243853">]</span><span class="builtintype" id="7243854">string</span><span class="op" id="7243860">)</span>&nbsp;<span class="op" id="7243862">(</span><span class="ident" id="7243863">driver</span><span class="op" id="7243869">.</span><span class="ident" id="7243870">Stmt</span><span class="op" id="7243874">,</span>&nbsp;<span class="builtintype" id="7243876">error</span><span class="op" id="7243881">)</span>&nbsp;<span class="op" id="7243883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7243886">if</span>&nbsp;<span class="builtinfunc" id="7243889">len</span><span class="op" id="7243892">(</span><span class="ident" id="7243893">parts</span><span class="op" id="7243898">)</span>&nbsp;<span class="op" id="7243900">!=</span>&nbsp;<span class="num" id="7243903">3</span>&nbsp;<span class="op" id="7243905">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7243909">stmt</span><span class="op" id="7243913">.</span><span class="ident" id="7243914">Close</span><span class="op" id="7243919">(</span><span class="op" id="7243920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7243924">return</span>&nbsp;<span class="ident" id="7243931">nil</span><span class="op" id="7243934">,</span>&nbsp;<span class="ident" id="7243936">errf</span><span class="op" id="7243940">(</span><span class="string" id="7243941">&#34;invalid&nbsp;SELECT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;3&#34;</span><span class="op" id="7243986">,</span>&nbsp;<span class="builtinfunc" id="7243988">len</span><span class="op" id="7243991">(</span><span class="ident" id="7243992">parts</span><span class="op" id="7243997">)</span><span class="op" id="7243998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7244001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7244004">stmt</span><span class="op" id="7244008">.</span><span class="ident" id="7244009">table</span>&nbsp;<span class="op" id="7244015">=</span>&nbsp;<span class="ident" id="7244017">parts</span><span class="op" id="7244022">[</span><span class="num" id="7244023">0</span><span class="op" id="7244024">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7244027">stmt</span><span class="op" id="7244031">.</span><span class="ident" id="7244032">colName</span>&nbsp;<span class="op" id="7244040">=</span>&nbsp;<span class="ident" id="7244042">strings</span><span class="op" id="7244049">.</span><span class="ident" id="7244050">Split</span><span class="op" id="7244055">(</span><span class="ident" id="7244056">parts</span><span class="op" id="7244061">[</span><span class="num" id="7244062">1</span><span class="op" id="7244063">]</span><span class="op" id="7244064">,</span>&nbsp;<span class="string" id="7244066">&#34;,&#34;</span><span class="op" id="7244069">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7244072">for</span>&nbsp;<span class="ident" id="7244076">n</span><span class="op" id="7244077">,</span>&nbsp;<span class="ident" id="7244079">colspec</span>&nbsp;<span class="op" id="7244087">:=</span>&nbsp;<span class="keyword" id="7244090">range</span>&nbsp;<span class="ident" id="7244096">strings</span><span class="op" id="7244103">.</span><span class="ident" id="7244104">Split</span><span class="op" id="7244109">(</span><span class="ident" id="7244110">parts</span><span class="op" id="7244115">[</span><span class="num" id="7244116">2</span><span class="op" id="7244117">]</span><span class="op" id="7244118">,</span>&nbsp;<span class="string" id="7244120">&#34;,&#34;</span><span class="op" id="7244123">)</span>&nbsp;<span class="op" id="7244125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7244129">if</span>&nbsp;<span class="ident" id="7244132">colspec</span>&nbsp;<span class="op" id="7244140">==</span>&nbsp;<span class="string" id="7244143">&#34;&#34;</span>&nbsp;<span class="op" id="7244146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7244151">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7244162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7244166">nameVal</span>&nbsp;<span class="op" id="7244174">:=</span>&nbsp;<span class="ident" id="7244177">strings</span><span class="op" id="7244184">.</span><span class="ident" id="7244185">Split</span><span class="op" id="7244190">(</span><span class="ident" id="7244191">colspec</span><span class="op" id="7244198">,</span>&nbsp;<span class="string" id="7244200">&#34;=&#34;</span><span class="op" id="7244203">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7244207">if</span>&nbsp;<span class="builtinfunc" id="7244210">len</span><span class="op" id="7244213">(</span><span class="ident" id="7244214">nameVal</span><span class="op" id="7244221">)</span>&nbsp;<span class="op" id="7244223">!=</span>&nbsp;<span class="num" id="7244226">2</span>&nbsp;<span class="op" id="7244228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7244233">stmt</span><span class="op" id="7244237">.</span><span class="ident" id="7244238">Close</span><span class="op" id="7244243">(</span><span class="op" id="7244244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7244249">return</span>&nbsp;<span class="ident" id="7244256">nil</span><span class="op" id="7244259">,</span>&nbsp;<span class="ident" id="7244261">errf</span><span class="op" id="7244265">(</span><span class="string" id="7244266">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7244327">,</span>&nbsp;<span class="ident" id="7244329">stmt</span><span class="op" id="7244333">.</span><span class="ident" id="7244334">table</span><span class="op" id="7244339">,</span>&nbsp;<span class="ident" id="7244341">colspec</span><span class="op" id="7244348">,</span>&nbsp;<span class="ident" id="7244350">n</span><span class="op" id="7244351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7244355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7244359">column</span><span class="op" id="7244365">,</span>&nbsp;<span class="ident" id="7244367">value</span>&nbsp;<span class="op" id="7244373">:=</span>&nbsp;<span class="ident" id="7244376">nameVal</span><span class="op" id="7244383">[</span><span class="num" id="7244384">0</span><span class="op" id="7244385">]</span><span class="op" id="7244386">,</span>&nbsp;<span class="ident" id="7244388">nameVal</span><span class="op" id="7244395">[</span><span class="num" id="7244396">1</span><span class="op" id="7244397">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7244401">_</span><span class="op" id="7244402">,</span>&nbsp;<span class="ident" id="7244404">ok</span>&nbsp;<span class="op" id="7244407">:=</span>&nbsp;<span class="ident" id="7244410">c</span><span class="op" id="7244411">.</span><span class="ident" id="7244412">db</span><span class="op" id="7244414">.</span><span class="ident" id="7244415">columnType</span><span class="op" id="7244425">(</span><span class="ident" id="7244426">stmt</span><span class="op" id="7244430">.</span><span class="ident" id="7244431">table</span><span class="op" id="7244436">,</span>&nbsp;<span class="ident" id="7244438">column</span><span class="op" id="7244444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7244448">if</span>&nbsp;<span class="op" id="7244451">!</span><span class="ident" id="7244452">ok</span>&nbsp;<span class="op" id="7244455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7244460">stmt</span><span class="op" id="7244464">.</span><span class="ident" id="7244465">Close</span><span class="op" id="7244470">(</span><span class="op" id="7244471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7244476">return</span>&nbsp;<span class="ident" id="7244483">nil</span><span class="op" id="7244486">,</span>&nbsp;<span class="ident" id="7244488">errf</span><span class="op" id="7244492">(</span><span class="string" id="7244493">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7244547">,</span>&nbsp;<span class="ident" id="7244549">stmt</span><span class="op" id="7244553">.</span><span class="ident" id="7244554">table</span><span class="op" id="7244559">,</span>&nbsp;<span class="ident" id="7244561">column</span><span class="op" id="7244567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7244571">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7244575">if</span>&nbsp;<span class="ident" id="7244578">value</span>&nbsp;<span class="op" id="7244584">!=</span>&nbsp;<span class="string" id="7244587">&#34;?&#34;</span>&nbsp;<span class="op" id="7244591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7244596">stmt</span><span class="op" id="7244600">.</span><span class="ident" id="7244601">Close</span><span class="op" id="7244606">(</span><span class="op" id="7244607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7244612">return</span>&nbsp;<span class="ident" id="7244619">nil</span><span class="op" id="7244622">,</span>&nbsp;<span class="ident" id="7244624">errf</span><span class="op" id="7244628">(</span><span class="string" id="7244629">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;pre-bound&nbsp;value&nbsp;for&nbsp;where&nbsp;column&nbsp;%q;&nbsp;need&nbsp;a&nbsp;question&nbsp;mark&#34;</span><span class="op" id="7244711">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7244717">stmt</span><span class="op" id="7244721">.</span><span class="ident" id="7244722">table</span><span class="op" id="7244727">,</span>&nbsp;<span class="ident" id="7244729">column</span><span class="op" id="7244735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7244739">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7244743">stmt</span><span class="op" id="7244747">.</span><span class="ident" id="7244748">whereCol</span>&nbsp;<span class="op" id="7244757">=</span>&nbsp;<span class="builtinfunc" id="7244759">append</span><span class="op" id="7244765">(</span><span class="ident" id="7244766">stmt</span><span class="op" id="7244770">.</span><span class="ident" id="7244771">whereCol</span><span class="op" id="7244779">,</span>&nbsp;<span class="ident" id="7244781">column</span><span class="op" id="7244787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7244791">stmt</span><span class="op" id="7244795">.</span><span class="ident" id="7244796">placeholders</span><span class="op" id="7244808">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7244812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7244815">return</span>&nbsp;<span class="ident" id="7244822">stmt</span><span class="op" id="7244826">,</span>&nbsp;<span class="ident" id="7244828">nil</span><br>
<span class="lineno"></span><span class="op" id="7244832">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="7244835">//&nbsp;parts&nbsp;are&nbsp;table|col=type,col2=type2</span><br>
<span class="lineno"></span><span class="keyword" id="7244874">func</span>&nbsp;<span class="op" id="7244879">(</span><span class="ident" id="7244880">c</span>&nbsp;<span class="op" id="7244882">*</span><span class="ident" id="7244883">fakeConn</span><span class="op" id="7244891">)</span>&nbsp;<span class="ident" id="7244893">prepareCreate</span><span class="op" id="7244906">(</span><span class="ident" id="7244907">stmt</span>&nbsp;<span class="op" id="7244912">*</span><span class="ident" id="7244913">fakeStmt</span><span class="op" id="7244921">,</span>&nbsp;<span class="ident" id="7244923">parts</span>&nbsp;<span class="op" id="7244929">[</span><span class="op" id="7244930">]</span><span class="builtintype" id="7244931">string</span><span class="op" id="7244937">)</span>&nbsp;<span class="op" id="7244939">(</span><span class="ident" id="7244940">driver</span><span class="op" id="7244946">.</span><span class="ident" id="7244947">Stmt</span><span class="op" id="7244951">,</span>&nbsp;<span class="builtintype" id="7244953">error</span><span class="op" id="7244958">)</span>&nbsp;<span class="op" id="7244960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7244963">if</span>&nbsp;<span class="builtinfunc" id="7244966">len</span><span class="op" id="7244969">(</span><span class="ident" id="7244970">parts</span><span class="op" id="7244975">)</span>&nbsp;<span class="op" id="7244977">!=</span>&nbsp;<span class="num" id="7244980">2</span>&nbsp;<span class="op" id="7244982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7244986">stmt</span><span class="op" id="7244990">.</span><span class="ident" id="7244991">Close</span><span class="op" id="7244996">(</span><span class="op" id="7244997">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7245001">return</span>&nbsp;<span class="ident" id="7245008">nil</span><span class="op" id="7245011">,</span>&nbsp;<span class="ident" id="7245013">errf</span><span class="op" id="7245017">(</span><span class="string" id="7245018">&#34;invalid&nbsp;CREATE&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="7245063">,</span>&nbsp;<span class="builtinfunc" id="7245065">len</span><span class="op" id="7245068">(</span><span class="ident" id="7245069">parts</span><span class="op" id="7245074">)</span><span class="op" id="7245075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7245078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7245081">stmt</span><span class="op" id="7245085">.</span><span class="ident" id="7245086">table</span>&nbsp;<span class="op" id="7245092">=</span>&nbsp;<span class="ident" id="7245094">parts</span><span class="op" id="7245099">[</span><span class="num" id="7245100">0</span><span class="op" id="7245101">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7245104">for</span>&nbsp;<span class="ident" id="7245108">n</span><span class="op" id="7245109">,</span>&nbsp;<span class="ident" id="7245111">colspec</span>&nbsp;<span class="op" id="7245119">:=</span>&nbsp;<span class="keyword" id="7245122">range</span>&nbsp;<span class="ident" id="7245128">strings</span><span class="op" id="7245135">.</span><span class="ident" id="7245136">Split</span><span class="op" id="7245141">(</span><span class="ident" id="7245142">parts</span><span class="op" id="7245147">[</span><span class="num" id="7245148">1</span><span class="op" id="7245149">]</span><span class="op" id="7245150">,</span>&nbsp;<span class="string" id="7245152">&#34;,&#34;</span><span class="op" id="7245155">)</span>&nbsp;<span class="op" id="7245157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7245161">nameType</span>&nbsp;<span class="op" id="7245170">:=</span>&nbsp;<span class="ident" id="7245173">strings</span><span class="op" id="7245180">.</span><span class="ident" id="7245181">Split</span><span class="op" id="7245186">(</span><span class="ident" id="7245187">colspec</span><span class="op" id="7245194">,</span>&nbsp;<span class="string" id="7245196">&#34;=&#34;</span><span class="op" id="7245199">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7245203">if</span>&nbsp;<span class="builtinfunc" id="7245206">len</span><span class="op" id="7245209">(</span><span class="ident" id="7245210">nameType</span><span class="op" id="7245218">)</span>&nbsp;<span class="op" id="7245220">!=</span>&nbsp;<span class="num" id="7245223">2</span>&nbsp;<span class="op" id="7245225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7245230">stmt</span><span class="op" id="7245234">.</span><span class="ident" id="7245235">Close</span><span class="op" id="7245240">(</span><span class="op" id="7245241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7245246">return</span>&nbsp;<span class="ident" id="7245253">nil</span><span class="op" id="7245256">,</span>&nbsp;<span class="ident" id="7245258">errf</span><span class="op" id="7245262">(</span><span class="string" id="7245263">&#34;CREATE&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7245321">,</span>&nbsp;<span class="ident" id="7245323">stmt</span><span class="op" id="7245327">.</span><span class="ident" id="7245328">table</span><span class="op" id="7245333">,</span>&nbsp;<span class="ident" id="7245335">colspec</span><span class="op" id="7245342">,</span>&nbsp;<span class="ident" id="7245344">n</span><span class="op" id="7245345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7245349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7245353">stmt</span><span class="op" id="7245357">.</span><span class="ident" id="7245358">colName</span>&nbsp;<span class="op" id="7245366">=</span>&nbsp;<span class="builtinfunc" id="7245368">append</span><span class="op" id="7245374">(</span><span class="ident" id="7245375">stmt</span><span class="op" id="7245379">.</span><span class="ident" id="7245380">colName</span><span class="op" id="7245387">,</span>&nbsp;<span class="ident" id="7245389">nameType</span><span class="op" id="7245397">[</span><span class="num" id="7245398">0</span><span class="op" id="7245399">]</span><span class="op" id="7245400">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7245404">stmt</span><span class="op" id="7245408">.</span><span class="ident" id="7245409">colType</span>&nbsp;<span class="op" id="7245417">=</span>&nbsp;<span class="builtinfunc" id="7245419">append</span><span class="op" id="7245425">(</span><span class="ident" id="7245426">stmt</span><span class="op" id="7245430">.</span><span class="ident" id="7245431">colType</span><span class="op" id="7245438">,</span>&nbsp;<span class="ident" id="7245440">nameType</span><span class="op" id="7245448">[</span><span class="num" id="7245449">1</span><span class="op" id="7245450">]</span><span class="op" id="7245451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7245454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7245457">return</span>&nbsp;<span class="ident" id="7245464">stmt</span><span class="op" id="7245468">,</span>&nbsp;<span class="ident" id="7245470">nil</span><br>
<span class="lineno"></span><span class="op" id="7245474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="7245477">//&nbsp;parts&nbsp;are&nbsp;table|col=?,col2=val</span><br>
<span class="lineno"></span><span class="keyword" id="7245511">func</span>&nbsp;<span class="op" id="7245516">(</span><span class="ident" id="7245517">c</span>&nbsp;<span class="op" id="7245519">*</span><span class="ident" id="7245520">fakeConn</span><span class="op" id="7245528">)</span>&nbsp;<span class="ident" id="7245530">prepareInsert</span><span class="op" id="7245543">(</span><span class="ident" id="7245544">stmt</span>&nbsp;<span class="op" id="7245549">*</span><span class="ident" id="7245550">fakeStmt</span><span class="op" id="7245558">,</span>&nbsp;<span class="ident" id="7245560">parts</span>&nbsp;<span class="op" id="7245566">[</span><span class="op" id="7245567">]</span><span class="builtintype" id="7245568">string</span><span class="op" id="7245574">)</span>&nbsp;<span class="op" id="7245576">(</span><span class="ident" id="7245577">driver</span><span class="op" id="7245583">.</span><span class="ident" id="7245584">Stmt</span><span class="op" id="7245588">,</span>&nbsp;<span class="builtintype" id="7245590">error</span><span class="op" id="7245595">)</span>&nbsp;<span class="op" id="7245597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7245600">if</span>&nbsp;<span class="builtinfunc" id="7245603">len</span><span class="op" id="7245606">(</span><span class="ident" id="7245607">parts</span><span class="op" id="7245612">)</span>&nbsp;<span class="op" id="7245614">!=</span>&nbsp;<span class="num" id="7245617">2</span>&nbsp;<span class="op" id="7245619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7245623">stmt</span><span class="op" id="7245627">.</span><span class="ident" id="7245628">Close</span><span class="op" id="7245633">(</span><span class="op" id="7245634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7245638">return</span>&nbsp;<span class="ident" id="7245645">nil</span><span class="op" id="7245648">,</span>&nbsp;<span class="ident" id="7245650">errf</span><span class="op" id="7245654">(</span><span class="string" id="7245655">&#34;invalid&nbsp;INSERT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="7245700">,</span>&nbsp;<span class="builtinfunc" id="7245702">len</span><span class="op" id="7245705">(</span><span class="ident" id="7245706">parts</span><span class="op" id="7245711">)</span><span class="op" id="7245712">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7245715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7245718">stmt</span><span class="op" id="7245722">.</span><span class="ident" id="7245723">table</span>&nbsp;<span class="op" id="7245729">=</span>&nbsp;<span class="ident" id="7245731">parts</span><span class="op" id="7245736">[</span><span class="num" id="7245737">0</span><span class="op" id="7245738">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7245741">for</span>&nbsp;<span class="ident" id="7245745">n</span><span class="op" id="7245746">,</span>&nbsp;<span class="ident" id="7245748">colspec</span>&nbsp;<span class="op" id="7245756">:=</span>&nbsp;<span class="keyword" id="7245759">range</span>&nbsp;<span class="ident" id="7245765">strings</span><span class="op" id="7245772">.</span><span class="ident" id="7245773">Split</span><span class="op" id="7245778">(</span><span class="ident" id="7245779">parts</span><span class="op" id="7245784">[</span><span class="num" id="7245785">1</span><span class="op" id="7245786">]</span><span class="op" id="7245787">,</span>&nbsp;<span class="string" id="7245789">&#34;,&#34;</span><span class="op" id="7245792">)</span>&nbsp;<span class="op" id="7245794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7245798">nameVal</span>&nbsp;<span class="op" id="7245806">:=</span>&nbsp;<span class="ident" id="7245809">strings</span><span class="op" id="7245816">.</span><span class="ident" id="7245817">Split</span><span class="op" id="7245822">(</span><span class="ident" id="7245823">colspec</span><span class="op" id="7245830">,</span>&nbsp;<span class="string" id="7245832">&#34;=&#34;</span><span class="op" id="7245835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7245839">if</span>&nbsp;<span class="builtinfunc" id="7245842">len</span><span class="op" id="7245845">(</span><span class="ident" id="7245846">nameVal</span><span class="op" id="7245853">)</span>&nbsp;<span class="op" id="7245855">!=</span>&nbsp;<span class="num" id="7245858">2</span>&nbsp;<span class="op" id="7245860">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7245865">stmt</span><span class="op" id="7245869">.</span><span class="ident" id="7245870">Close</span><span class="op" id="7245875">(</span><span class="op" id="7245876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7245881">return</span>&nbsp;<span class="ident" id="7245888">nil</span><span class="op" id="7245891">,</span>&nbsp;<span class="ident" id="7245893">errf</span><span class="op" id="7245897">(</span><span class="string" id="7245898">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7245956">,</span>&nbsp;<span class="ident" id="7245958">stmt</span><span class="op" id="7245962">.</span><span class="ident" id="7245963">table</span><span class="op" id="7245968">,</span>&nbsp;<span class="ident" id="7245970">colspec</span><span class="op" id="7245977">,</span>&nbsp;<span class="ident" id="7245979">n</span><span class="op" id="7245980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7245984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7245988">column</span><span class="op" id="7245994">,</span>&nbsp;<span class="ident" id="7245996">value</span>&nbsp;<span class="op" id="7246002">:=</span>&nbsp;<span class="ident" id="7246005">nameVal</span><span class="op" id="7246012">[</span><span class="num" id="7246013">0</span><span class="op" id="7246014">]</span><span class="op" id="7246015">,</span>&nbsp;<span class="ident" id="7246017">nameVal</span><span class="op" id="7246024">[</span><span class="num" id="7246025">1</span><span class="op" id="7246026">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7246030">ctype</span><span class="op" id="7246035">,</span>&nbsp;<span class="ident" id="7246037">ok</span>&nbsp;<span class="op" id="7246040">:=</span>&nbsp;<span class="ident" id="7246043">c</span><span class="op" id="7246044">.</span><span class="ident" id="7246045">db</span><span class="op" id="7246047">.</span><span class="ident" id="7246048">columnType</span><span class="op" id="7246058">(</span><span class="ident" id="7246059">stmt</span><span class="op" id="7246063">.</span><span class="ident" id="7246064">table</span><span class="op" id="7246069">,</span>&nbsp;<span class="ident" id="7246071">column</span><span class="op" id="7246077">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7246081">if</span>&nbsp;<span class="op" id="7246084">!</span><span class="ident" id="7246085">ok</span>&nbsp;<span class="op" id="7246088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7246093">stmt</span><span class="op" id="7246097">.</span><span class="ident" id="7246098">Close</span><span class="op" id="7246103">(</span><span class="op" id="7246104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7246109">return</span>&nbsp;<span class="ident" id="7246116">nil</span><span class="op" id="7246119">,</span>&nbsp;<span class="ident" id="7246121">errf</span><span class="op" id="7246125">(</span><span class="string" id="7246126">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7246177">,</span>&nbsp;<span class="ident" id="7246179">stmt</span><span class="op" id="7246183">.</span><span class="ident" id="7246184">table</span><span class="op" id="7246189">,</span>&nbsp;<span class="ident" id="7246191">column</span><span class="op" id="7246197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7246201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7246205">stmt</span><span class="op" id="7246209">.</span><span class="ident" id="7246210">colName</span>&nbsp;<span class="op" id="7246218">=</span>&nbsp;<span class="builtinfunc" id="7246220">append</span><span class="op" id="7246226">(</span><span class="ident" id="7246227">stmt</span><span class="op" id="7246231">.</span><span class="ident" id="7246232">colName</span><span class="op" id="7246239">,</span>&nbsp;<span class="ident" id="7246241">column</span><span class="op" id="7246247">)</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7246252">if</span>&nbsp;<span class="ident" id="7246255">value</span>&nbsp;<span class="op" id="7246261">!=</span>&nbsp;<span class="string" id="7246264">&#34;?&#34;</span>&nbsp;<span class="op" id="7246268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7246273">var</span>&nbsp;<span class="ident" id="7246277">subsetVal</span>&nbsp;<span class="keyword" id="7246287">interface</span><span class="op" id="7246296">{</span><span class="op" id="7246297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7246302">//&nbsp;Convert&nbsp;to&nbsp;driver&nbsp;subset&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7246338">switch</span>&nbsp;<span class="ident" id="7246345">ctype</span>&nbsp;<span class="op" id="7246351">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7246356">case</span>&nbsp;<span class="string" id="7246361">&#34;string&#34;</span><span class="op" id="7246369">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7246375">subsetVal</span>&nbsp;<span class="op" id="7246385">=</span>&nbsp;<span class="op" id="7246387">[</span><span class="op" id="7246388">]</span><span class="builtintype" id="7246389">byte</span><span class="op" id="7246393">(</span><span class="ident" id="7246394">value</span><span class="op" id="7246399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7246404">case</span>&nbsp;<span class="string" id="7246409">&#34;blob&#34;</span><span class="op" id="7246415">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7246421">subsetVal</span>&nbsp;<span class="op" id="7246431">=</span>&nbsp;<span class="op" id="7246433">[</span><span class="op" id="7246434">]</span><span class="builtintype" id="7246435">byte</span><span class="op" id="7246439">(</span><span class="ident" id="7246440">value</span><span class="op" id="7246445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7246450">case</span>&nbsp;<span class="string" id="7246455">&#34;int32&#34;</span><span class="op" id="7246462">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7246468">i</span><span class="op" id="7246469">,</span>&nbsp;<span class="ident" id="7246471">err</span>&nbsp;<span class="op" id="7246475">:=</span>&nbsp;<span class="ident" id="7246478">strconv</span><span class="op" id="7246485">.</span><span class="ident" id="7246486">Atoi</span><span class="op" id="7246490">(</span><span class="ident" id="7246491">value</span><span class="op" id="7246496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7246502">if</span>&nbsp;<span class="ident" id="7246505">err</span>&nbsp;<span class="op" id="7246509">!=</span>&nbsp;<span class="ident" id="7246512">nil</span>&nbsp;<span class="op" id="7246516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7246523">stmt</span><span class="op" id="7246527">.</span><span class="ident" id="7246528">Close</span><span class="op" id="7246533">(</span><span class="op" id="7246534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7246541">return</span>&nbsp;<span class="ident" id="7246548">nil</span><span class="op" id="7246551">,</span>&nbsp;<span class="ident" id="7246553">errf</span><span class="op" id="7246557">(</span><span class="string" id="7246558">&#34;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;%q&#34;</span><span class="op" id="7246595">,</span>&nbsp;<span class="ident" id="7246597">value</span><span class="op" id="7246602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7246608">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7246614">subsetVal</span>&nbsp;<span class="op" id="7246624">=</span>&nbsp;<span class="ident" id="7246626">int64</span><span class="op" id="7246631">(</span><span class="ident" id="7246632">i</span><span class="op" id="7246633">)</span>&nbsp;<span class="comment" id="7246635">//&nbsp;int64&nbsp;is&nbsp;a&nbsp;subset&nbsp;type,&nbsp;but&nbsp;not&nbsp;int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7246679">default</span><span class="op" id="7246686">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7246692">stmt</span><span class="op" id="7246696">.</span><span class="ident" id="7246697">Close</span><span class="op" id="7246702">(</span><span class="op" id="7246703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7246709">return</span>&nbsp;<span class="ident" id="7246716">nil</span><span class="op" id="7246719">,</span>&nbsp;<span class="ident" id="7246721">errf</span><span class="op" id="7246725">(</span><span class="string" id="7246726">&#34;unsupported&nbsp;conversion&nbsp;for&nbsp;pre-bound&nbsp;parameter&nbsp;%q&nbsp;to&nbsp;type&nbsp;%q&#34;</span><span class="op" id="7246788">,</span>&nbsp;<span class="ident" id="7246790">value</span><span class="op" id="7246795">,</span>&nbsp;<span class="ident" id="7246797">ctype</span><span class="op" id="7246802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7246807">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7246812">stmt</span><span class="op" id="7246816">.</span><span class="ident" id="7246817">colValue</span>&nbsp;<span class="op" id="7246826">=</span>&nbsp;<span class="builtinfunc" id="7246828">append</span><span class="op" id="7246834">(</span><span class="ident" id="7246835">stmt</span><span class="op" id="7246839">.</span><span class="ident" id="7246840">colValue</span><span class="op" id="7246848">,</span>&nbsp;<span class="ident" id="7246850">subsetVal</span><span class="op" id="7246859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7246863">}</span>&nbsp;<span class="keyword" id="7246865">else</span>&nbsp;<span class="op" id="7246870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7246875">stmt</span><span class="op" id="7246879">.</span><span class="ident" id="7246880">placeholders</span><span class="op" id="7246892">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7246898">stmt</span><span class="op" id="7246902">.</span><span class="ident" id="7246903">placeholderConverter</span>&nbsp;<span class="op" id="7246924">=</span>&nbsp;<span class="builtinfunc" id="7246926">append</span><span class="op" id="7246932">(</span><span class="ident" id="7246933">stmt</span><span class="op" id="7246937">.</span><span class="ident" id="7246938">placeholderConverter</span><span class="op" id="7246958">,</span>&nbsp;<span class="ident" id="7246960">converterForType</span><span class="op" id="7246976">(</span><span class="ident" id="7246977">ctype</span><span class="op" id="7246982">)</span><span class="op" id="7246983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7246988">stmt</span><span class="op" id="7246992">.</span><span class="ident" id="7246993">colValue</span>&nbsp;<span class="op" id="7247002">=</span>&nbsp;<span class="builtinfunc" id="7247004">append</span><span class="op" id="7247010">(</span><span class="ident" id="7247011">stmt</span><span class="op" id="7247015">.</span><span class="ident" id="7247016">colValue</span><span class="op" id="7247024">,</span>&nbsp;<span class="string" id="7247026">&#34;?&#34;</span><span class="op" id="7247029">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7247033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7247036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247039">return</span>&nbsp;<span class="ident" id="7247046">stmt</span><span class="op" id="7247050">,</span>&nbsp;<span class="ident" id="7247052">nil</span><br>
<span class="lineno"></span><span class="op" id="7247056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="7247059">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="7247098">var</span>&nbsp;<span class="ident" id="7247102">hookPrepareBadConn</span>&nbsp;<span class="keyword" id="7247121">func</span><span class="op" id="7247125">(</span><span class="op" id="7247126">)</span>&nbsp;<span class="builtintype" id="7247128">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7247134">func</span>&nbsp;<span class="op" id="7247139">(</span><span class="ident" id="7247140">c</span>&nbsp;<span class="op" id="7247142">*</span><span class="ident" id="7247143">fakeConn</span><span class="op" id="7247151">)</span>&nbsp;<span class="ident" id="7247153">Prepare</span><span class="op" id="7247160">(</span><span class="ident" id="7247161">query</span>&nbsp;<span class="builtintype" id="7247167">string</span><span class="op" id="7247173">)</span>&nbsp;<span class="op" id="7247175">(</span><span class="ident" id="7247176">driver</span><span class="op" id="7247182">.</span><span class="ident" id="7247183">Stmt</span><span class="op" id="7247187">,</span>&nbsp;<span class="builtintype" id="7247189">error</span><span class="op" id="7247194">)</span>&nbsp;<span class="op" id="7247196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7247199">c</span><span class="op" id="7247200">.</span><span class="ident" id="7247201">numPrepare</span><span class="op" id="7247211">++</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247215">if</span>&nbsp;<span class="ident" id="7247218">c</span><span class="op" id="7247219">.</span><span class="ident" id="7247220">db</span>&nbsp;<span class="op" id="7247223">==</span>&nbsp;<span class="ident" id="7247226">nil</span>&nbsp;<span class="op" id="7247230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7247234">panic</span><span class="op" id="7247239">(</span><span class="string" id="7247240">&#34;nil&nbsp;c.db;&nbsp;conn&nbsp;=&nbsp;&#34;</span>&nbsp;<span class="op" id="7247260">+</span>&nbsp;<span class="ident" id="7247262">fmt</span><span class="op" id="7247265">.</span><span class="ident" id="7247266">Sprintf</span><span class="op" id="7247273">(</span><span class="string" id="7247274">&#34;%#v&#34;</span><span class="op" id="7247279">,</span>&nbsp;<span class="ident" id="7247281">c</span><span class="op" id="7247282">)</span><span class="op" id="7247283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7247286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247290">if</span>&nbsp;<span class="ident" id="7247293">hookPrepareBadConn</span>&nbsp;<span class="op" id="7247312">!=</span>&nbsp;<span class="ident" id="7247315">nil</span>&nbsp;<span class="op" id="7247319">&amp;&amp;</span>&nbsp;<span class="ident" id="7247322">hookPrepareBadConn</span><span class="op" id="7247340">(</span><span class="op" id="7247341">)</span>&nbsp;<span class="op" id="7247343">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247347">return</span>&nbsp;<span class="ident" id="7247354">nil</span><span class="op" id="7247357">,</span>&nbsp;<span class="ident" id="7247359">driver</span><span class="op" id="7247365">.</span><span class="ident" id="7247366">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7247378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7247382">parts</span>&nbsp;<span class="op" id="7247388">:=</span>&nbsp;<span class="ident" id="7247391">strings</span><span class="op" id="7247398">.</span><span class="ident" id="7247399">Split</span><span class="op" id="7247404">(</span><span class="ident" id="7247405">query</span><span class="op" id="7247410">,</span>&nbsp;<span class="string" id="7247412">&#34;|&#34;</span><span class="op" id="7247415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247418">if</span>&nbsp;<span class="builtinfunc" id="7247421">len</span><span class="op" id="7247424">(</span><span class="ident" id="7247425">parts</span><span class="op" id="7247430">)</span>&nbsp;<span class="op" id="7247432">&lt;</span>&nbsp;<span class="num" id="7247434">1</span>&nbsp;<span class="op" id="7247436">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247440">return</span>&nbsp;<span class="ident" id="7247447">nil</span><span class="op" id="7247450">,</span>&nbsp;<span class="ident" id="7247452">errf</span><span class="op" id="7247456">(</span><span class="string" id="7247457">&#34;empty&nbsp;query&#34;</span><span class="op" id="7247470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7247473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7247476">cmd</span>&nbsp;<span class="op" id="7247480">:=</span>&nbsp;<span class="ident" id="7247483">parts</span><span class="op" id="7247488">[</span><span class="num" id="7247489">0</span><span class="op" id="7247490">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7247493">parts</span>&nbsp;<span class="op" id="7247499">=</span>&nbsp;<span class="ident" id="7247501">parts</span><span class="op" id="7247506">[</span><span class="num" id="7247507">1</span><span class="op" id="7247508">:</span><span class="op" id="7247509">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7247512">stmt</span>&nbsp;<span class="op" id="7247517">:=</span>&nbsp;<span class="op" id="7247520">&amp;</span><span class="ident" id="7247521">fakeStmt</span><span class="op" id="7247529">{</span><span class="ident" id="7247530">q</span><span class="op" id="7247531">:</span>&nbsp;<span class="ident" id="7247533">query</span><span class="op" id="7247538">,</span>&nbsp;<span class="ident" id="7247540">c</span><span class="op" id="7247541">:</span>&nbsp;<span class="ident" id="7247543">c</span><span class="op" id="7247544">,</span>&nbsp;<span class="ident" id="7247546">cmd</span><span class="op" id="7247549">:</span>&nbsp;<span class="ident" id="7247551">cmd</span><span class="op" id="7247554">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7247557">c</span><span class="op" id="7247558">.</span><span class="ident" id="7247559">incrStat</span><span class="op" id="7247567">(</span><span class="op" id="7247568">&amp;</span><span class="ident" id="7247569">c</span><span class="op" id="7247570">.</span><span class="ident" id="7247571">stmtsMade</span><span class="op" id="7247580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247583">switch</span>&nbsp;<span class="ident" id="7247590">cmd</span>&nbsp;<span class="op" id="7247594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247597">case</span>&nbsp;<span class="string" id="7247602">&#34;WIPE&#34;</span><span class="op" id="7247608">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7247612">//&nbsp;Nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247624">case</span>&nbsp;<span class="string" id="7247629">&#34;SELECT&#34;</span><span class="op" id="7247637">:</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247641">return</span>&nbsp;<span class="ident" id="7247648">c</span><span class="op" id="7247649">.</span><span class="ident" id="7247650">prepareSelect</span><span class="op" id="7247663">(</span><span class="ident" id="7247664">stmt</span><span class="op" id="7247668">,</span>&nbsp;<span class="ident" id="7247670">parts</span><span class="op" id="7247675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247678">case</span>&nbsp;<span class="string" id="7247683">&#34;CREATE&#34;</span><span class="op" id="7247691">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247695">return</span>&nbsp;<span class="ident" id="7247702">c</span><span class="op" id="7247703">.</span><span class="ident" id="7247704">prepareCreate</span><span class="op" id="7247717">(</span><span class="ident" id="7247718">stmt</span><span class="op" id="7247722">,</span>&nbsp;<span class="ident" id="7247724">parts</span><span class="op" id="7247729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247732">case</span>&nbsp;<span class="string" id="7247737">&#34;INSERT&#34;</span><span class="op" id="7247745">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247749">return</span>&nbsp;<span class="ident" id="7247756">c</span><span class="op" id="7247757">.</span><span class="ident" id="7247758">prepareInsert</span><span class="op" id="7247771">(</span><span class="ident" id="7247772">stmt</span><span class="op" id="7247776">,</span>&nbsp;<span class="ident" id="7247778">parts</span><span class="op" id="7247783">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247786">case</span>&nbsp;<span class="string" id="7247791">&#34;NOSERT&#34;</span><span class="op" id="7247799">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7247803">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7247883">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247927">return</span>&nbsp;<span class="ident" id="7247934">c</span><span class="op" id="7247935">.</span><span class="ident" id="7247936">prepareInsert</span><span class="op" id="7247949">(</span><span class="ident" id="7247950">stmt</span><span class="op" id="7247954">,</span>&nbsp;<span class="ident" id="7247956">parts</span><span class="op" id="7247961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247964">default</span><span class="op" id="7247971">:</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7247975">stmt</span><span class="op" id="7247979">.</span><span class="ident" id="7247980">Close</span><span class="op" id="7247985">(</span><span class="op" id="7247986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7247990">return</span>&nbsp;<span class="ident" id="7247997">nil</span><span class="op" id="7248000">,</span>&nbsp;<span class="ident" id="7248002">errf</span><span class="op" id="7248006">(</span><span class="string" id="7248007">&#34;unsupported&nbsp;command&nbsp;type&nbsp;%q&#34;</span><span class="op" id="7248036">,</span>&nbsp;<span class="ident" id="7248038">cmd</span><span class="op" id="7248041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7248044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248047">return</span>&nbsp;<span class="ident" id="7248054">stmt</span><span class="op" id="7248058">,</span>&nbsp;<span class="ident" id="7248060">nil</span><br>
<span class="lineno"></span><span class="op" id="7248064">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="7248067">func</span>&nbsp;<span class="op" id="7248072">(</span><span class="ident" id="7248073">s</span>&nbsp;<span class="op" id="7248075">*</span><span class="ident" id="7248076">fakeStmt</span><span class="op" id="7248084">)</span>&nbsp;<span class="ident" id="7248086">ColumnConverter</span><span class="op" id="7248101">(</span><span class="ident" id="7248102">idx</span>&nbsp;<span class="builtintype" id="7248106">int</span><span class="op" id="7248109">)</span>&nbsp;<span class="ident" id="7248111">driver</span><span class="op" id="7248117">.</span><span class="ident" id="7248118">ValueConverter</span>&nbsp;<span class="op" id="7248133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248136">if</span>&nbsp;<span class="builtinfunc" id="7248139">len</span><span class="op" id="7248142">(</span><span class="ident" id="7248143">s</span><span class="op" id="7248144">.</span><span class="ident" id="7248145">placeholderConverter</span><span class="op" id="7248165">)</span>&nbsp;<span class="op" id="7248167">==</span>&nbsp;<span class="num" id="7248170">0</span>&nbsp;<span class="op" id="7248172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248176">return</span>&nbsp;<span class="ident" id="7248183">driver</span><span class="op" id="7248189">.</span><span class="ident" id="7248190">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7248217">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248220">return</span>&nbsp;<span class="ident" id="7248227">s</span><span class="op" id="7248228">.</span><span class="ident" id="7248229">placeholderConverter</span><span class="op" id="7248249">[</span><span class="ident" id="7248250">idx</span><span class="op" id="7248253">]</span><br>
<span class="lineno"></span><span class="op" id="7248255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7248258">func</span>&nbsp;<span class="op" id="7248263">(</span><span class="ident" id="7248264">s</span>&nbsp;<span class="op" id="7248266">*</span><span class="ident" id="7248267">fakeStmt</span><span class="op" id="7248275">)</span>&nbsp;<span class="ident" id="7248277">Close</span><span class="op" id="7248282">(</span><span class="op" id="7248283">)</span>&nbsp;<span class="builtintype" id="7248285">error</span>&nbsp;<span class="op" id="7248291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248294">if</span>&nbsp;<span class="ident" id="7248297">s</span><span class="op" id="7248298">.</span><span class="ident" id="7248299">c</span>&nbsp;<span class="op" id="7248301">==</span>&nbsp;<span class="ident" id="7248304">nil</span>&nbsp;<span class="op" id="7248308">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7248312">panic</span><span class="op" id="7248317">(</span><span class="string" id="7248318">&#34;nil&nbsp;conn&nbsp;in&nbsp;fakeStmt.Close&#34;</span><span class="op" id="7248346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7248349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248352">if</span>&nbsp;<span class="ident" id="7248355">s</span><span class="op" id="7248356">.</span><span class="ident" id="7248357">c</span><span class="op" id="7248358">.</span><span class="ident" id="7248359">db</span>&nbsp;<span class="op" id="7248362">==</span>&nbsp;<span class="ident" id="7248365">nil</span>&nbsp;<span class="op" id="7248369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7248373">panic</span><span class="op" id="7248378">(</span><span class="string" id="7248379">&#34;in&nbsp;fakeStmt.Close,&nbsp;conn&#39;s&nbsp;db&nbsp;is&nbsp;nil&nbsp;(already&nbsp;closed)&#34;</span><span class="op" id="7248433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7248436">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248439">if</span>&nbsp;<span class="op" id="7248442">!</span><span class="ident" id="7248443">s</span><span class="op" id="7248444">.</span><span class="ident" id="7248445">closed</span>&nbsp;<span class="op" id="7248452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7248456">s</span><span class="op" id="7248457">.</span><span class="ident" id="7248458">c</span><span class="op" id="7248459">.</span><span class="ident" id="7248460">incrStat</span><span class="op" id="7248468">(</span><span class="op" id="7248469">&amp;</span><span class="ident" id="7248470">s</span><span class="op" id="7248471">.</span><span class="ident" id="7248472">c</span><span class="op" id="7248473">.</span><span class="ident" id="7248474">stmtsClosed</span><span class="op" id="7248485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7248489">s</span><span class="op" id="7248490">.</span><span class="ident" id="7248491">closed</span>&nbsp;<span class="op" id="7248498">=</span>&nbsp;<span class="builtintype" id="7248500">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7248506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248509">return</span>&nbsp;<span class="ident" id="7248516">nil</span><br>
<span class="lineno">520</span><span class="op" id="7248520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7248523">var</span>&nbsp;<span class="ident" id="7248527">errClosed</span>&nbsp;<span class="op" id="7248537">=</span>&nbsp;<span class="ident" id="7248539">errors</span><span class="op" id="7248545">.</span><span class="ident" id="7248546">New</span><span class="op" id="7248549">(</span><span class="string" id="7248550">&#34;fakedb:&nbsp;statement&nbsp;has&nbsp;been&nbsp;closed&#34;</span><span class="op" id="7248585">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7248588">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno">525</span><span class="keyword" id="7248627">var</span>&nbsp;<span class="ident" id="7248631">hookExecBadConn</span>&nbsp;<span class="keyword" id="7248647">func</span><span class="op" id="7248651">(</span><span class="op" id="7248652">)</span>&nbsp;<span class="builtintype" id="7248654">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7248660">func</span>&nbsp;<span class="op" id="7248665">(</span><span class="ident" id="7248666">s</span>&nbsp;<span class="op" id="7248668">*</span><span class="ident" id="7248669">fakeStmt</span><span class="op" id="7248677">)</span>&nbsp;<span class="ident" id="7248679">Exec</span><span class="op" id="7248683">(</span><span class="ident" id="7248684">args</span>&nbsp;<span class="op" id="7248689">[</span><span class="op" id="7248690">]</span><span class="ident" id="7248691">driver</span><span class="op" id="7248697">.</span><span class="ident" id="7248698">Value</span><span class="op" id="7248703">)</span>&nbsp;<span class="op" id="7248705">(</span><span class="ident" id="7248706">driver</span><span class="op" id="7248712">.</span><span class="ident" id="7248713">Result</span><span class="op" id="7248719">,</span>&nbsp;<span class="builtintype" id="7248721">error</span><span class="op" id="7248726">)</span>&nbsp;<span class="op" id="7248728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248731">if</span>&nbsp;<span class="ident" id="7248734">s</span><span class="op" id="7248735">.</span><span class="ident" id="7248736">closed</span>&nbsp;<span class="op" id="7248743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248747">return</span>&nbsp;<span class="ident" id="7248754">nil</span><span class="op" id="7248757">,</span>&nbsp;<span class="ident" id="7248759">errClosed</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7248770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248774">if</span>&nbsp;<span class="ident" id="7248777">hookExecBadConn</span>&nbsp;<span class="op" id="7248793">!=</span>&nbsp;<span class="ident" id="7248796">nil</span>&nbsp;<span class="op" id="7248800">&amp;&amp;</span>&nbsp;<span class="ident" id="7248803">hookExecBadConn</span><span class="op" id="7248818">(</span><span class="op" id="7248819">)</span>&nbsp;<span class="op" id="7248821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248825">return</span>&nbsp;<span class="ident" id="7248832">nil</span><span class="op" id="7248835">,</span>&nbsp;<span class="ident" id="7248837">driver</span><span class="op" id="7248843">.</span><span class="ident" id="7248844">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7248856">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7248860">err</span>&nbsp;<span class="op" id="7248864">:=</span>&nbsp;<span class="ident" id="7248867">checkSubsetTypes</span><span class="op" id="7248883">(</span><span class="ident" id="7248884">args</span><span class="op" id="7248888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248891">if</span>&nbsp;<span class="ident" id="7248894">err</span>&nbsp;<span class="op" id="7248898">!=</span>&nbsp;<span class="ident" id="7248901">nil</span>&nbsp;<span class="op" id="7248905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248909">return</span>&nbsp;<span class="ident" id="7248916">nil</span><span class="op" id="7248919">,</span>&nbsp;<span class="ident" id="7248921">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7248926">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7248930">db</span>&nbsp;<span class="op" id="7248933">:=</span>&nbsp;<span class="ident" id="7248936">s</span><span class="op" id="7248937">.</span><span class="ident" id="7248938">c</span><span class="op" id="7248939">.</span><span class="ident" id="7248940">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248944">switch</span>&nbsp;<span class="ident" id="7248951">s</span><span class="op" id="7248952">.</span><span class="ident" id="7248953">cmd</span>&nbsp;<span class="op" id="7248957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248960">case</span>&nbsp;<span class="string" id="7248965">&#34;WIPE&#34;</span><span class="op" id="7248971">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7248975">db</span><span class="op" id="7248977">.</span><span class="ident" id="7248978">wipe</span><span class="op" id="7248982">(</span><span class="op" id="7248983">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7248987">return</span>&nbsp;<span class="ident" id="7248994">driver</span><span class="op" id="7249000">.</span><span class="ident" id="7249001">ResultNoRows</span><span class="op" id="7249013">,</span>&nbsp;<span class="ident" id="7249015">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7249020">case</span>&nbsp;<span class="string" id="7249025">&#34;CREATE&#34;</span><span class="op" id="7249033">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7249037">if</span>&nbsp;<span class="ident" id="7249040">err</span>&nbsp;<span class="op" id="7249044">:=</span>&nbsp;<span class="ident" id="7249047">db</span><span class="op" id="7249049">.</span><span class="ident" id="7249050">createTable</span><span class="op" id="7249061">(</span><span class="ident" id="7249062">s</span><span class="op" id="7249063">.</span><span class="ident" id="7249064">table</span><span class="op" id="7249069">,</span>&nbsp;<span class="ident" id="7249071">s</span><span class="op" id="7249072">.</span><span class="ident" id="7249073">colName</span><span class="op" id="7249080">,</span>&nbsp;<span class="ident" id="7249082">s</span><span class="op" id="7249083">.</span><span class="ident" id="7249084">colType</span><span class="op" id="7249091">)</span><span class="op" id="7249092">;</span>&nbsp;<span class="ident" id="7249094">err</span>&nbsp;<span class="op" id="7249098">!=</span>&nbsp;<span class="ident" id="7249101">nil</span>&nbsp;<span class="op" id="7249105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7249110">return</span>&nbsp;<span class="ident" id="7249117">nil</span><span class="op" id="7249120">,</span>&nbsp;<span class="ident" id="7249122">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7249128">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7249132">return</span>&nbsp;<span class="ident" id="7249139">driver</span><span class="op" id="7249145">.</span><span class="ident" id="7249146">ResultNoRows</span><span class="op" id="7249158">,</span>&nbsp;<span class="ident" id="7249160">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7249165">case</span>&nbsp;<span class="string" id="7249170">&#34;INSERT&#34;</span><span class="op" id="7249178">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7249182">return</span>&nbsp;<span class="ident" id="7249189">s</span><span class="op" id="7249190">.</span><span class="ident" id="7249191">execInsert</span><span class="op" id="7249201">(</span><span class="ident" id="7249202">args</span><span class="op" id="7249206">,</span>&nbsp;<span class="builtintype" id="7249208">true</span><span class="op" id="7249212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7249215">case</span>&nbsp;<span class="string" id="7249220">&#34;NOSERT&#34;</span><span class="op" id="7249228">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7249232">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7249312">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7249356">return</span>&nbsp;<span class="ident" id="7249363">s</span><span class="op" id="7249364">.</span><span class="ident" id="7249365">execInsert</span><span class="op" id="7249375">(</span><span class="ident" id="7249376">args</span><span class="op" id="7249380">,</span>&nbsp;<span class="builtintype" id="7249382">false</span><span class="op" id="7249387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7249390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7249393">fmt</span><span class="op" id="7249396">.</span><span class="ident" id="7249397">Printf</span><span class="op" id="7249403">(</span><span class="string" id="7249404">&#34;EXEC&nbsp;statement,&nbsp;cmd=%q:&nbsp;%#v\n&#34;</span><span class="op" id="7249435">,</span>&nbsp;<span class="ident" id="7249437">s</span><span class="op" id="7249438">.</span><span class="ident" id="7249439">cmd</span><span class="op" id="7249442">,</span>&nbsp;<span class="ident" id="7249444">s</span><span class="op" id="7249445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7249448">return</span>&nbsp;<span class="ident" id="7249455">nil</span><span class="op" id="7249458">,</span>&nbsp;<span class="ident" id="7249460">fmt</span><span class="op" id="7249463">.</span><span class="ident" id="7249464">Errorf</span><span class="op" id="7249470">(</span><span class="string" id="7249471">&#34;unimplemented&nbsp;statement&nbsp;Exec&nbsp;command&nbsp;type&nbsp;of&nbsp;%q&#34;</span><span class="op" id="7249520">,</span>&nbsp;<span class="ident" id="7249522">s</span><span class="op" id="7249523">.</span><span class="ident" id="7249524">cmd</span><span class="op" id="7249527">)</span><br>
<span class="lineno">560</span><span class="op" id="7249529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7249532">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;true,&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span><span class="comment" id="7249584">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;false&nbsp;do&nbsp;prep-work&nbsp;and&nbsp;error&nbsp;checking,&nbsp;but&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="7249653">//&nbsp;actually&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno">565</span><span class="keyword" id="7249691">func</span>&nbsp;<span class="op" id="7249696">(</span><span class="ident" id="7249697">s</span>&nbsp;<span class="op" id="7249699">*</span><span class="ident" id="7249700">fakeStmt</span><span class="op" id="7249708">)</span>&nbsp;<span class="ident" id="7249710">execInsert</span><span class="op" id="7249720">(</span><span class="ident" id="7249721">args</span>&nbsp;<span class="op" id="7249726">[</span><span class="op" id="7249727">]</span><span class="ident" id="7249728">driver</span><span class="op" id="7249734">.</span><span class="ident" id="7249735">Value</span><span class="op" id="7249740">,</span>&nbsp;<span class="ident" id="7249742">doInsert</span>&nbsp;<span class="builtintype" id="7249751">bool</span><span class="op" id="7249755">)</span>&nbsp;<span class="op" id="7249757">(</span><span class="ident" id="7249758">driver</span><span class="op" id="7249764">.</span><span class="ident" id="7249765">Result</span><span class="op" id="7249771">,</span>&nbsp;<span class="builtintype" id="7249773">error</span><span class="op" id="7249778">)</span>&nbsp;<span class="op" id="7249780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7249783">db</span>&nbsp;<span class="op" id="7249786">:=</span>&nbsp;<span class="ident" id="7249789">s</span><span class="op" id="7249790">.</span><span class="ident" id="7249791">c</span><span class="op" id="7249792">.</span><span class="ident" id="7249793">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7249797">if</span>&nbsp;<span class="builtinfunc" id="7249800">len</span><span class="op" id="7249803">(</span><span class="ident" id="7249804">args</span><span class="op" id="7249808">)</span>&nbsp;<span class="op" id="7249810">!=</span>&nbsp;<span class="ident" id="7249813">s</span><span class="op" id="7249814">.</span><span class="ident" id="7249815">placeholders</span>&nbsp;<span class="op" id="7249828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7249832">panic</span><span class="op" id="7249837">(</span><span class="string" id="7249838">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="7249896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7249899">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7249902">db</span><span class="op" id="7249904">.</span><span class="ident" id="7249905">mu</span><span class="op" id="7249907">.</span><span class="ident" id="7249908">Lock</span><span class="op" id="7249912">(</span><span class="op" id="7249913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7249916">t</span><span class="op" id="7249917">,</span>&nbsp;<span class="ident" id="7249919">ok</span>&nbsp;<span class="op" id="7249922">:=</span>&nbsp;<span class="ident" id="7249925">db</span><span class="op" id="7249927">.</span><span class="ident" id="7249928">table</span><span class="op" id="7249933">(</span><span class="ident" id="7249934">s</span><span class="op" id="7249935">.</span><span class="ident" id="7249936">table</span><span class="op" id="7249941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7249944">db</span><span class="op" id="7249946">.</span><span class="ident" id="7249947">mu</span><span class="op" id="7249949">.</span><span class="ident" id="7249950">Unlock</span><span class="op" id="7249956">(</span><span class="op" id="7249957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7249960">if</span>&nbsp;<span class="op" id="7249963">!</span><span class="ident" id="7249964">ok</span>&nbsp;<span class="op" id="7249967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7249971">return</span>&nbsp;<span class="ident" id="7249978">nil</span><span class="op" id="7249981">,</span>&nbsp;<span class="ident" id="7249983">fmt</span><span class="op" id="7249986">.</span><span class="ident" id="7249987">Errorf</span><span class="op" id="7249993">(</span><span class="string" id="7249994">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="7250026">,</span>&nbsp;<span class="ident" id="7250028">s</span><span class="op" id="7250029">.</span><span class="ident" id="7250030">table</span><span class="op" id="7250035">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7250038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7250042">t</span><span class="op" id="7250043">.</span><span class="ident" id="7250044">mu</span><span class="op" id="7250046">.</span><span class="ident" id="7250047">Lock</span><span class="op" id="7250051">(</span><span class="op" id="7250052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7250055">defer</span>&nbsp;<span class="ident" id="7250061">t</span><span class="op" id="7250062">.</span><span class="ident" id="7250063">mu</span><span class="op" id="7250065">.</span><span class="ident" id="7250066">Unlock</span><span class="op" id="7250072">(</span><span class="op" id="7250073">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7250077">var</span>&nbsp;<span class="ident" id="7250081">cols</span>&nbsp;<span class="op" id="7250086">[</span><span class="op" id="7250087">]</span><span class="keyword" id="7250088">interface</span><span class="op" id="7250097">{</span><span class="op" id="7250098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7250101">if</span>&nbsp;<span class="ident" id="7250104">doInsert</span>&nbsp;<span class="op" id="7250113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7250117">cols</span>&nbsp;<span class="op" id="7250122">=</span>&nbsp;<span class="builtinfunc" id="7250124">make</span><span class="op" id="7250128">(</span><span class="op" id="7250129">[</span><span class="op" id="7250130">]</span><span class="keyword" id="7250131">interface</span><span class="op" id="7250140">{</span><span class="op" id="7250141">}</span><span class="op" id="7250142">,</span>&nbsp;<span class="builtinfunc" id="7250144">len</span><span class="op" id="7250147">(</span><span class="ident" id="7250148">t</span><span class="op" id="7250149">.</span><span class="ident" id="7250150">colname</span><span class="op" id="7250157">)</span><span class="op" id="7250158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7250161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7250164">argPos</span>&nbsp;<span class="op" id="7250171">:=</span>&nbsp;<span class="num" id="7250174">0</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7250177">for</span>&nbsp;<span class="ident" id="7250181">n</span><span class="op" id="7250182">,</span>&nbsp;<span class="ident" id="7250184">colname</span>&nbsp;<span class="op" id="7250192">:=</span>&nbsp;<span class="keyword" id="7250195">range</span>&nbsp;<span class="ident" id="7250201">s</span><span class="op" id="7250202">.</span><span class="ident" id="7250203">colName</span>&nbsp;<span class="op" id="7250211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7250215">colidx</span>&nbsp;<span class="op" id="7250222">:=</span>&nbsp;<span class="ident" id="7250225">t</span><span class="op" id="7250226">.</span><span class="ident" id="7250227">columnIndex</span><span class="op" id="7250238">(</span><span class="ident" id="7250239">colname</span><span class="op" id="7250246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7250250">if</span>&nbsp;<span class="ident" id="7250253">colidx</span>&nbsp;<span class="op" id="7250260">==</span>&nbsp;<span class="op" id="7250263">-</span><span class="num" id="7250264">1</span>&nbsp;<span class="op" id="7250266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7250271">return</span>&nbsp;<span class="ident" id="7250278">nil</span><span class="op" id="7250281">,</span>&nbsp;<span class="ident" id="7250283">fmt</span><span class="op" id="7250286">.</span><span class="ident" id="7250287">Errorf</span><span class="op" id="7250293">(</span><span class="string" id="7250294">&#34;fakedb:&nbsp;column&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&nbsp;or&nbsp;dropped&nbsp;since&nbsp;prepared&nbsp;statement&nbsp;was&nbsp;created&#34;</span><span class="op" id="7250375">,</span>&nbsp;<span class="ident" id="7250377">colname</span><span class="op" id="7250384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7250388">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7250392">var</span>&nbsp;<span class="ident" id="7250396">val</span>&nbsp;<span class="keyword" id="7250400">interface</span><span class="op" id="7250409">{</span><span class="op" id="7250410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7250414">if</span>&nbsp;<span class="ident" id="7250417">strvalue</span><span class="op" id="7250425">,</span>&nbsp;<span class="ident" id="7250427">ok</span>&nbsp;<span class="op" id="7250430">:=</span>&nbsp;<span class="ident" id="7250433">s</span><span class="op" id="7250434">.</span><span class="ident" id="7250435">colValue</span><span class="op" id="7250443">[</span><span class="ident" id="7250444">n</span><span class="op" id="7250445">]</span><span class="op" id="7250446">.</span><span class="op" id="7250447">(</span><span class="builtintype" id="7250448">string</span><span class="op" id="7250454">)</span><span class="op" id="7250455">;</span>&nbsp;<span class="ident" id="7250457">ok</span>&nbsp;<span class="op" id="7250460">&amp;&amp;</span>&nbsp;<span class="ident" id="7250463">strvalue</span>&nbsp;<span class="op" id="7250472">==</span>&nbsp;<span class="string" id="7250475">&#34;?&#34;</span>&nbsp;<span class="op" id="7250479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7250484">val</span>&nbsp;<span class="op" id="7250488">=</span>&nbsp;<span class="ident" id="7250490">args</span><span class="op" id="7250494">[</span><span class="ident" id="7250495">argPos</span><span class="op" id="7250501">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7250506">argPos</span><span class="op" id="7250512">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7250517">}</span>&nbsp;<span class="keyword" id="7250519">else</span>&nbsp;<span class="op" id="7250524">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7250529">val</span>&nbsp;<span class="op" id="7250533">=</span>&nbsp;<span class="ident" id="7250535">s</span><span class="op" id="7250536">.</span><span class="ident" id="7250537">colValue</span><span class="op" id="7250545">[</span><span class="ident" id="7250546">n</span><span class="op" id="7250547">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7250551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7250555">if</span>&nbsp;<span class="ident" id="7250558">doInsert</span>&nbsp;<span class="op" id="7250567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7250572">cols</span><span class="op" id="7250576">[</span><span class="ident" id="7250577">colidx</span><span class="op" id="7250583">]</span>&nbsp;<span class="op" id="7250585">=</span>&nbsp;<span class="ident" id="7250587">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7250593">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7250596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7250600">if</span>&nbsp;<span class="ident" id="7250603">doInsert</span>&nbsp;<span class="op" id="7250612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7250616">t</span><span class="op" id="7250617">.</span><span class="ident" id="7250618">rows</span>&nbsp;<span class="op" id="7250623">=</span>&nbsp;<span class="builtinfunc" id="7250625">append</span><span class="op" id="7250631">(</span><span class="ident" id="7250632">t</span><span class="op" id="7250633">.</span><span class="ident" id="7250634">rows</span><span class="op" id="7250638">,</span>&nbsp;<span class="op" id="7250640">&amp;</span><span class="ident" id="7250641">row</span><span class="op" id="7250644">{</span><span class="ident" id="7250645">cols</span><span class="op" id="7250649">:</span>&nbsp;<span class="ident" id="7250651">cols</span><span class="op" id="7250655">}</span><span class="op" id="7250656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7250659">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7250662">return</span>&nbsp;<span class="ident" id="7250669">driver</span><span class="op" id="7250675">.</span><span class="ident" id="7250676">RowsAffected</span><span class="op" id="7250688">(</span><span class="num" id="7250689">1</span><span class="op" id="7250690">)</span><span class="op" id="7250691">,</span>&nbsp;<span class="ident" id="7250693">nil</span><br>
<span class="lineno"></span><span class="op" id="7250697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7250700">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="7250739">var</span>&nbsp;<span class="ident" id="7250743">hookQueryBadConn</span>&nbsp;<span class="keyword" id="7250760">func</span><span class="op" id="7250764">(</span><span class="op" id="7250765">)</span>&nbsp;<span class="builtintype" id="7250767">bool</span><br>
<span class="lineno">610</span><br>
<span class="lineno"></span><span class="keyword" id="7250773">func</span>&nbsp;<span class="op" id="7250778">(</span><span class="ident" id="7250779">s</span>&nbsp;<span class="op" id="7250781">*</span><span class="ident" id="7250782">fakeStmt</span><span class="op" id="7250790">)</span>&nbsp;<span class="ident" id="7250792">Query</span><span class="op" id="7250797">(</span><span class="ident" id="7250798">args</span>&nbsp;<span class="op" id="7250803">[</span><span class="op" id="7250804">]</span><span class="ident" id="7250805">driver</span><span class="op" id="7250811">.</span><span class="ident" id="7250812">Value</span><span class="op" id="7250817">)</span>&nbsp;<span class="op" id="7250819">(</span><span class="ident" id="7250820">driver</span><span class="op" id="7250826">.</span><span class="ident" id="7250827">Rows</span><span class="op" id="7250831">,</span>&nbsp;<span class="builtintype" id="7250833">error</span><span class="op" id="7250838">)</span>&nbsp;<span class="op" id="7250840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7250843">if</span>&nbsp;<span class="ident" id="7250846">s</span><span class="op" id="7250847">.</span><span class="ident" id="7250848">closed</span>&nbsp;<span class="op" id="7250855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7250859">return</span>&nbsp;<span class="ident" id="7250866">nil</span><span class="op" id="7250869">,</span>&nbsp;<span class="ident" id="7250871">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7250882">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7250886">if</span>&nbsp;<span class="ident" id="7250889">hookQueryBadConn</span>&nbsp;<span class="op" id="7250906">!=</span>&nbsp;<span class="ident" id="7250909">nil</span>&nbsp;<span class="op" id="7250913">&amp;&amp;</span>&nbsp;<span class="ident" id="7250916">hookQueryBadConn</span><span class="op" id="7250932">(</span><span class="op" id="7250933">)</span>&nbsp;<span class="op" id="7250935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7250939">return</span>&nbsp;<span class="ident" id="7250946">nil</span><span class="op" id="7250949">,</span>&nbsp;<span class="ident" id="7250951">driver</span><span class="op" id="7250957">.</span><span class="ident" id="7250958">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7250970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7250974">err</span>&nbsp;<span class="op" id="7250978">:=</span>&nbsp;<span class="ident" id="7250981">checkSubsetTypes</span><span class="op" id="7250997">(</span><span class="ident" id="7250998">args</span><span class="op" id="7251002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7251005">if</span>&nbsp;<span class="ident" id="7251008">err</span>&nbsp;<span class="op" id="7251012">!=</span>&nbsp;<span class="ident" id="7251015">nil</span>&nbsp;<span class="op" id="7251019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7251023">return</span>&nbsp;<span class="ident" id="7251030">nil</span><span class="op" id="7251033">,</span>&nbsp;<span class="ident" id="7251035">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7251040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7251044">db</span>&nbsp;<span class="op" id="7251047">:=</span>&nbsp;<span class="ident" id="7251050">s</span><span class="op" id="7251051">.</span><span class="ident" id="7251052">c</span><span class="op" id="7251053">.</span><span class="ident" id="7251054">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7251058">if</span>&nbsp;<span class="builtinfunc" id="7251061">len</span><span class="op" id="7251064">(</span><span class="ident" id="7251065">args</span><span class="op" id="7251069">)</span>&nbsp;<span class="op" id="7251071">!=</span>&nbsp;<span class="ident" id="7251074">s</span><span class="op" id="7251075">.</span><span class="ident" id="7251076">placeholders</span>&nbsp;<span class="op" id="7251089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7251093">panic</span><span class="op" id="7251098">(</span><span class="string" id="7251099">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="7251157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7251160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7251164">db</span><span class="op" id="7251166">.</span><span class="ident" id="7251167">mu</span><span class="op" id="7251169">.</span><span class="ident" id="7251170">Lock</span><span class="op" id="7251174">(</span><span class="op" id="7251175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7251178">t</span><span class="op" id="7251179">,</span>&nbsp;<span class="ident" id="7251181">ok</span>&nbsp;<span class="op" id="7251184">:=</span>&nbsp;<span class="ident" id="7251187">db</span><span class="op" id="7251189">.</span><span class="ident" id="7251190">table</span><span class="op" id="7251195">(</span><span class="ident" id="7251196">s</span><span class="op" id="7251197">.</span><span class="ident" id="7251198">table</span><span class="op" id="7251203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7251206">db</span><span class="op" id="7251208">.</span><span class="ident" id="7251209">mu</span><span class="op" id="7251211">.</span><span class="ident" id="7251212">Unlock</span><span class="op" id="7251218">(</span><span class="op" id="7251219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7251222">if</span>&nbsp;<span class="op" id="7251225">!</span><span class="ident" id="7251226">ok</span>&nbsp;<span class="op" id="7251229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7251233">return</span>&nbsp;<span class="ident" id="7251240">nil</span><span class="op" id="7251243">,</span>&nbsp;<span class="ident" id="7251245">fmt</span><span class="op" id="7251248">.</span><span class="ident" id="7251249">Errorf</span><span class="op" id="7251255">(</span><span class="string" id="7251256">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="7251288">,</span>&nbsp;<span class="ident" id="7251290">s</span><span class="op" id="7251291">.</span><span class="ident" id="7251292">table</span><span class="op" id="7251297">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7251300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7251304">if</span>&nbsp;<span class="ident" id="7251307">s</span><span class="op" id="7251308">.</span><span class="ident" id="7251309">table</span>&nbsp;<span class="op" id="7251315">==</span>&nbsp;<span class="string" id="7251318">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="7251331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7251335">if</span>&nbsp;<span class="builtinfunc" id="7251338">len</span><span class="op" id="7251341">(</span><span class="ident" id="7251342">s</span><span class="op" id="7251343">.</span><span class="ident" id="7251344">whereCol</span><span class="op" id="7251352">)</span>&nbsp;<span class="op" id="7251354">==</span>&nbsp;<span class="num" id="7251357">2</span>&nbsp;<span class="op" id="7251359">&amp;&amp;</span>&nbsp;<span class="ident" id="7251362">s</span><span class="op" id="7251363">.</span><span class="ident" id="7251364">whereCol</span><span class="op" id="7251372">[</span><span class="num" id="7251373">0</span><span class="op" id="7251374">]</span>&nbsp;<span class="op" id="7251376">==</span>&nbsp;<span class="string" id="7251379">&#34;op&#34;</span>&nbsp;<span class="op" id="7251384">&amp;&amp;</span>&nbsp;<span class="ident" id="7251387">s</span><span class="op" id="7251388">.</span><span class="ident" id="7251389">whereCol</span><span class="op" id="7251397">[</span><span class="num" id="7251398">1</span><span class="op" id="7251399">]</span>&nbsp;<span class="op" id="7251401">==</span>&nbsp;<span class="string" id="7251404">&#34;millis&#34;</span>&nbsp;<span class="op" id="7251413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7251418">if</span>&nbsp;<span class="ident" id="7251421">args</span><span class="op" id="7251425">[</span><span class="num" id="7251426">0</span><span class="op" id="7251427">]</span>&nbsp;<span class="op" id="7251429">==</span>&nbsp;<span class="string" id="7251432">&#34;sleep&#34;</span>&nbsp;<span class="op" id="7251440">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7251446">time</span><span class="op" id="7251450">.</span><span class="ident" id="7251451">Sleep</span><span class="op" id="7251456">(</span><span class="ident" id="7251457">time</span><span class="op" id="7251461">.</span><span class="ident" id="7251462">Duration</span><span class="op" id="7251470">(</span><span class="ident" id="7251471">args</span><span class="op" id="7251475">[</span><span class="num" id="7251476">1</span><span class="op" id="7251477">]</span><span class="op" id="7251478">.</span><span class="op" id="7251479">(</span><span class="ident" id="7251480">int64</span><span class="op" id="7251485">)</span><span class="op" id="7251486">)</span>&nbsp;<span class="op" id="7251488">*</span>&nbsp;<span class="ident" id="7251490">time</span><span class="op" id="7251494">.</span><span class="ident" id="7251495">Millisecond</span><span class="op" id="7251506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7251511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7251515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7251518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7251522">t</span><span class="op" id="7251523">.</span><span class="ident" id="7251524">mu</span><span class="op" id="7251526">.</span><span class="ident" id="7251527">Lock</span><span class="op" id="7251531">(</span><span class="op" id="7251532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7251535">defer</span>&nbsp;<span class="ident" id="7251541">t</span><span class="op" id="7251542">.</span><span class="ident" id="7251543">mu</span><span class="op" id="7251545">.</span><span class="ident" id="7251546">Unlock</span><span class="op" id="7251552">(</span><span class="op" id="7251553">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7251557">colIdx</span>&nbsp;<span class="op" id="7251564">:=</span>&nbsp;<span class="builtinfunc" id="7251567">make</span><span class="op" id="7251571">(</span><span class="keyword" id="7251572">map</span><span class="op" id="7251575">[</span><span class="builtintype" id="7251576">string</span><span class="op" id="7251582">]</span><span class="builtintype" id="7251583">int</span><span class="op" id="7251586">)</span>&nbsp;<span class="comment" id="7251588">//&nbsp;select&nbsp;column&nbsp;name&nbsp;-&gt;&nbsp;column&nbsp;index&nbsp;in&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7251636">for</span>&nbsp;<span class="ident" id="7251640">_</span><span class="op" id="7251641">,</span>&nbsp;<span class="ident" id="7251643">name</span>&nbsp;<span class="op" id="7251648">:=</span>&nbsp;<span class="keyword" id="7251651">range</span>&nbsp;<span class="ident" id="7251657">s</span><span class="op" id="7251658">.</span><span class="ident" id="7251659">colName</span>&nbsp;<span class="op" id="7251667">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7251671">idx</span>&nbsp;<span class="op" id="7251675">:=</span>&nbsp;<span class="ident" id="7251678">t</span><span class="op" id="7251679">.</span><span class="ident" id="7251680">columnIndex</span><span class="op" id="7251691">(</span><span class="ident" id="7251692">name</span><span class="op" id="7251696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7251700">if</span>&nbsp;<span class="ident" id="7251703">idx</span>&nbsp;<span class="op" id="7251707">==</span>&nbsp;<span class="op" id="7251710">-</span><span class="num" id="7251711">1</span>&nbsp;<span class="op" id="7251713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7251718">return</span>&nbsp;<span class="ident" id="7251725">nil</span><span class="op" id="7251728">,</span>&nbsp;<span class="ident" id="7251730">fmt</span><span class="op" id="7251733">.</span><span class="ident" id="7251734">Errorf</span><span class="op" id="7251740">(</span><span class="string" id="7251741">&#34;fakedb:&nbsp;unknown&nbsp;column&nbsp;name&nbsp;%q&#34;</span><span class="op" id="7251773">,</span>&nbsp;<span class="ident" id="7251775">name</span><span class="op" id="7251779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7251783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7251787">colIdx</span><span class="op" id="7251793">[</span><span class="ident" id="7251794">name</span><span class="op" id="7251798">]</span>&nbsp;<span class="op" id="7251800">=</span>&nbsp;<span class="ident" id="7251802">idx</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7251807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7251811">mrows</span>&nbsp;<span class="op" id="7251817">:=</span>&nbsp;<span class="op" id="7251820">[</span><span class="op" id="7251821">]</span><span class="op" id="7251822">*</span><span class="ident" id="7251823">row</span><span class="op" id="7251826">{</span><span class="op" id="7251827">}</span><br>
<span class="lineno"></span><span class="ident" id="7251829">rows</span><span class="op" id="7251833">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7251836">for</span>&nbsp;<span class="ident" id="7251840">_</span><span class="op" id="7251841">,</span>&nbsp;<span class="ident" id="7251843">trow</span>&nbsp;<span class="op" id="7251848">:=</span>&nbsp;<span class="keyword" id="7251851">range</span>&nbsp;<span class="ident" id="7251857">t</span><span class="op" id="7251858">.</span><span class="ident" id="7251859">rows</span>&nbsp;<span class="op" id="7251864">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7251868">//&nbsp;Process&nbsp;the&nbsp;where&nbsp;clause,&nbsp;skipping&nbsp;non-match&nbsp;rows.&nbsp;This&nbsp;is&nbsp;lazy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7251937">//&nbsp;and&nbsp;just&nbsp;uses&nbsp;fmt.Sprintf(&#34;%v&#34;)&nbsp;to&nbsp;test&nbsp;equality.&nbsp;&nbsp;Good&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7252005">//&nbsp;for&nbsp;test&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7252025">for</span>&nbsp;<span class="ident" id="7252029">widx</span><span class="op" id="7252033">,</span>&nbsp;<span class="ident" id="7252035">wcol</span>&nbsp;<span class="op" id="7252040">:=</span>&nbsp;<span class="keyword" id="7252043">range</span>&nbsp;<span class="ident" id="7252049">s</span><span class="op" id="7252050">.</span><span class="ident" id="7252051">whereCol</span>&nbsp;<span class="op" id="7252060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252065">idx</span>&nbsp;<span class="op" id="7252069">:=</span>&nbsp;<span class="ident" id="7252072">t</span><span class="op" id="7252073">.</span><span class="ident" id="7252074">columnIndex</span><span class="op" id="7252085">(</span><span class="ident" id="7252086">wcol</span><span class="op" id="7252090">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7252095">if</span>&nbsp;<span class="ident" id="7252098">idx</span>&nbsp;<span class="op" id="7252102">==</span>&nbsp;<span class="op" id="7252105">-</span><span class="num" id="7252106">1</span>&nbsp;<span class="op" id="7252108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7252114">return</span>&nbsp;<span class="ident" id="7252121">nil</span><span class="op" id="7252124">,</span>&nbsp;<span class="ident" id="7252126">fmt</span><span class="op" id="7252129">.</span><span class="ident" id="7252130">Errorf</span><span class="op" id="7252136">(</span><span class="string" id="7252137">&#34;db:&nbsp;invalid&nbsp;where&nbsp;clause&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7252173">,</span>&nbsp;<span class="ident" id="7252175">wcol</span><span class="op" id="7252179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7252184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252189">tcol</span>&nbsp;<span class="op" id="7252194">:=</span>&nbsp;<span class="ident" id="7252197">trow</span><span class="op" id="7252201">.</span><span class="ident" id="7252202">cols</span><span class="op" id="7252206">[</span><span class="ident" id="7252207">idx</span><span class="op" id="7252210">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7252215">if</span>&nbsp;<span class="ident" id="7252218">bs</span><span class="op" id="7252220">,</span>&nbsp;<span class="ident" id="7252222">ok</span>&nbsp;<span class="op" id="7252225">:=</span>&nbsp;<span class="ident" id="7252228">tcol</span><span class="op" id="7252232">.</span><span class="op" id="7252233">(</span><span class="op" id="7252234">[</span><span class="op" id="7252235">]</span><span class="builtintype" id="7252236">byte</span><span class="op" id="7252240">)</span><span class="op" id="7252241">;</span>&nbsp;<span class="ident" id="7252243">ok</span>&nbsp;<span class="op" id="7252246">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7252252">//&nbsp;lazy&nbsp;hack&nbsp;to&nbsp;avoid&nbsp;sprintf&nbsp;%v&nbsp;on&nbsp;a&nbsp;[]byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252301">tcol</span>&nbsp;<span class="op" id="7252306">=</span>&nbsp;<span class="builtintype" id="7252308">string</span><span class="op" id="7252314">(</span><span class="ident" id="7252315">bs</span><span class="op" id="7252317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7252322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7252327">if</span>&nbsp;<span class="ident" id="7252330">fmt</span><span class="op" id="7252333">.</span><span class="ident" id="7252334">Sprintf</span><span class="op" id="7252341">(</span><span class="string" id="7252342">&#34;%v&#34;</span><span class="op" id="7252346">,</span>&nbsp;<span class="ident" id="7252348">tcol</span><span class="op" id="7252352">)</span>&nbsp;<span class="op" id="7252354">!=</span>&nbsp;<span class="ident" id="7252357">fmt</span><span class="op" id="7252360">.</span><span class="ident" id="7252361">Sprintf</span><span class="op" id="7252368">(</span><span class="string" id="7252369">&#34;%v&#34;</span><span class="op" id="7252373">,</span>&nbsp;<span class="ident" id="7252375">args</span><span class="op" id="7252379">[</span><span class="ident" id="7252380">widx</span><span class="op" id="7252384">]</span><span class="op" id="7252385">)</span>&nbsp;<span class="op" id="7252387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7252393">continue</span>&nbsp;<span class="ident" id="7252402">rows</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7252410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7252414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252418">mrow</span>&nbsp;<span class="op" id="7252423">:=</span>&nbsp;<span class="op" id="7252426">&amp;</span><span class="ident" id="7252427">row</span><span class="op" id="7252430">{</span><span class="ident" id="7252431">cols</span><span class="op" id="7252435">:</span>&nbsp;<span class="builtinfunc" id="7252437">make</span><span class="op" id="7252441">(</span><span class="op" id="7252442">[</span><span class="op" id="7252443">]</span><span class="keyword" id="7252444">interface</span><span class="op" id="7252453">{</span><span class="op" id="7252454">}</span><span class="op" id="7252455">,</span>&nbsp;<span class="builtinfunc" id="7252457">len</span><span class="op" id="7252460">(</span><span class="ident" id="7252461">s</span><span class="op" id="7252462">.</span><span class="ident" id="7252463">colName</span><span class="op" id="7252470">)</span><span class="op" id="7252471">)</span><span class="op" id="7252472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7252476">for</span>&nbsp;<span class="ident" id="7252480">seli</span><span class="op" id="7252484">,</span>&nbsp;<span class="ident" id="7252486">name</span>&nbsp;<span class="op" id="7252491">:=</span>&nbsp;<span class="keyword" id="7252494">range</span>&nbsp;<span class="ident" id="7252500">s</span><span class="op" id="7252501">.</span><span class="ident" id="7252502">colName</span>&nbsp;<span class="op" id="7252510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252515">mrow</span><span class="op" id="7252519">.</span><span class="ident" id="7252520">cols</span><span class="op" id="7252524">[</span><span class="ident" id="7252525">seli</span><span class="op" id="7252529">]</span>&nbsp;<span class="op" id="7252531">=</span>&nbsp;<span class="ident" id="7252533">trow</span><span class="op" id="7252537">.</span><span class="ident" id="7252538">cols</span><span class="op" id="7252542">[</span><span class="ident" id="7252543">colIdx</span><span class="op" id="7252549">[</span><span class="ident" id="7252550">name</span><span class="op" id="7252554">]</span><span class="op" id="7252555">]</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7252559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252563">mrows</span>&nbsp;<span class="op" id="7252569">=</span>&nbsp;<span class="builtinfunc" id="7252571">append</span><span class="op" id="7252577">(</span><span class="ident" id="7252578">mrows</span><span class="op" id="7252583">,</span>&nbsp;<span class="ident" id="7252585">mrow</span><span class="op" id="7252589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7252592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252596">cursor</span>&nbsp;<span class="op" id="7252603">:=</span>&nbsp;<span class="op" id="7252606">&amp;</span><span class="ident" id="7252607">rowsCursor</span><span class="op" id="7252617">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252621">pos</span><span class="op" id="7252624">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7252629">-</span><span class="num" id="7252630">1</span><span class="op" id="7252631">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252635">rows</span><span class="op" id="7252639">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7252643">mrows</span><span class="op" id="7252648">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252652">cols</span><span class="op" id="7252656">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7252660">s</span><span class="op" id="7252661">.</span><span class="ident" id="7252662">colName</span><span class="op" id="7252669">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252673">errPos</span><span class="op" id="7252679">:</span>&nbsp;<span class="op" id="7252681">-</span><span class="num" id="7252682">1</span><span class="op" id="7252683">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7252686">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7252689">return</span>&nbsp;<span class="ident" id="7252696">cursor</span><span class="op" id="7252702">,</span>&nbsp;<span class="ident" id="7252704">nil</span><br>
<span class="lineno"></span><span class="op" id="7252708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7252711">func</span>&nbsp;<span class="op" id="7252716">(</span><span class="ident" id="7252717">s</span>&nbsp;<span class="op" id="7252719">*</span><span class="ident" id="7252720">fakeStmt</span><span class="op" id="7252728">)</span>&nbsp;<span class="ident" id="7252730">NumInput</span><span class="op" id="7252738">(</span><span class="op" id="7252739">)</span>&nbsp;<span class="builtintype" id="7252741">int</span>&nbsp;<span class="op" id="7252745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7252748">return</span>&nbsp;<span class="ident" id="7252755">s</span><span class="op" id="7252756">.</span><span class="ident" id="7252757">placeholders</span><br>
<span class="lineno">695</span><span class="op" id="7252770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7252773">func</span>&nbsp;<span class="op" id="7252778">(</span><span class="ident" id="7252779">tx</span>&nbsp;<span class="op" id="7252782">*</span><span class="ident" id="7252783">fakeTx</span><span class="op" id="7252789">)</span>&nbsp;<span class="ident" id="7252791">Commit</span><span class="op" id="7252797">(</span><span class="op" id="7252798">)</span>&nbsp;<span class="builtintype" id="7252800">error</span>&nbsp;<span class="op" id="7252806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252809">tx</span><span class="op" id="7252811">.</span><span class="ident" id="7252812">c</span><span class="op" id="7252813">.</span><span class="ident" id="7252814">currTx</span>&nbsp;<span class="op" id="7252821">=</span>&nbsp;<span class="ident" id="7252823">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7252828">return</span>&nbsp;<span class="ident" id="7252835">nil</span><br>
<span class="lineno">700</span><span class="op" id="7252839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7252842">func</span>&nbsp;<span class="op" id="7252847">(</span><span class="ident" id="7252848">tx</span>&nbsp;<span class="op" id="7252851">*</span><span class="ident" id="7252852">fakeTx</span><span class="op" id="7252858">)</span>&nbsp;<span class="ident" id="7252860">Rollback</span><span class="op" id="7252868">(</span><span class="op" id="7252869">)</span>&nbsp;<span class="builtintype" id="7252871">error</span>&nbsp;<span class="op" id="7252877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252880">tx</span><span class="op" id="7252882">.</span><span class="ident" id="7252883">c</span><span class="op" id="7252884">.</span><span class="ident" id="7252885">currTx</span>&nbsp;<span class="op" id="7252892">=</span>&nbsp;<span class="ident" id="7252894">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7252899">return</span>&nbsp;<span class="ident" id="7252906">nil</span><br>
<span class="lineno">705</span><span class="op" id="7252910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7252913">type</span>&nbsp;<span class="ident" id="7252918">rowsCursor</span>&nbsp;<span class="keyword" id="7252929">struct</span>&nbsp;<span class="op" id="7252936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252939">cols</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7252946">[</span><span class="op" id="7252947">]</span><span class="builtintype" id="7252948">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252956">pos</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7252963">int</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252968">rows</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7252975">[</span><span class="op" id="7252976">]</span><span class="op" id="7252977">*</span><span class="ident" id="7252978">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7252983">closed</span>&nbsp;<span class="builtintype" id="7252990">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7252997">//&nbsp;errPos&nbsp;and&nbsp;err&nbsp;are&nbsp;for&nbsp;making&nbsp;Next&nbsp;return&nbsp;early&nbsp;with&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7253061">errPos</span>&nbsp;<span class="builtintype" id="7253068">int</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7253073">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7253080">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7253088">//&nbsp;a&nbsp;clone&nbsp;of&nbsp;slices&nbsp;to&nbsp;give&nbsp;out&nbsp;to&nbsp;clients,&nbsp;indexed&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7253149">//&nbsp;the&nbsp;original&nbsp;slice&#39;s&nbsp;first&nbsp;byte&nbsp;address.&nbsp;&nbsp;we&nbsp;clone&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7253209">//&nbsp;just&nbsp;so&nbsp;we&#39;re&nbsp;able&nbsp;to&nbsp;corrupt&nbsp;them&nbsp;on&nbsp;close.</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7253258">bytesClone</span>&nbsp;<span class="keyword" id="7253269">map</span><span class="op" id="7253272">[</span><span class="op" id="7253273">*</span><span class="builtintype" id="7253274">byte</span><span class="op" id="7253278">]</span><span class="op" id="7253279">[</span><span class="op" id="7253280">]</span><span class="builtintype" id="7253281">byte</span><br>
<span class="lineno"></span><span class="op" id="7253286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7253289">func</span>&nbsp;<span class="op" id="7253294">(</span><span class="ident" id="7253295">rc</span>&nbsp;<span class="op" id="7253298">*</span><span class="ident" id="7253299">rowsCursor</span><span class="op" id="7253309">)</span>&nbsp;<span class="ident" id="7253311">Close</span><span class="op" id="7253316">(</span><span class="op" id="7253317">)</span>&nbsp;<span class="builtintype" id="7253319">error</span>&nbsp;<span class="op" id="7253325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7253328">if</span>&nbsp;<span class="op" id="7253331">!</span><span class="ident" id="7253332">rc</span><span class="op" id="7253334">.</span><span class="ident" id="7253335">closed</span>&nbsp;<span class="op" id="7253342">{</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7253346">for</span>&nbsp;<span class="ident" id="7253350">_</span><span class="op" id="7253351">,</span>&nbsp;<span class="ident" id="7253353">bs</span>&nbsp;<span class="op" id="7253356">:=</span>&nbsp;<span class="keyword" id="7253359">range</span>&nbsp;<span class="ident" id="7253365">rc</span><span class="op" id="7253367">.</span><span class="ident" id="7253368">bytesClone</span>&nbsp;<span class="op" id="7253379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7253384">bs</span><span class="op" id="7253386">[</span><span class="num" id="7253387">0</span><span class="op" id="7253388">]</span>&nbsp;<span class="op" id="7253390">=</span>&nbsp;<span class="num" id="7253392">255</span>&nbsp;<span class="comment" id="7253396">//&nbsp;first&nbsp;byte&nbsp;corrupted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7253422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7253425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7253428">rc</span><span class="op" id="7253430">.</span><span class="ident" id="7253431">closed</span>&nbsp;<span class="op" id="7253438">=</span>&nbsp;<span class="builtintype" id="7253440">true</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7253446">return</span>&nbsp;<span class="ident" id="7253453">nil</span><br>
<span class="lineno"></span><span class="op" id="7253457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7253460">func</span>&nbsp;<span class="op" id="7253465">(</span><span class="ident" id="7253466">rc</span>&nbsp;<span class="op" id="7253469">*</span><span class="ident" id="7253470">rowsCursor</span><span class="op" id="7253480">)</span>&nbsp;<span class="ident" id="7253482">Columns</span><span class="op" id="7253489">(</span><span class="op" id="7253490">)</span>&nbsp;<span class="op" id="7253492">[</span><span class="op" id="7253493">]</span><span class="builtintype" id="7253494">string</span>&nbsp;<span class="op" id="7253501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7253504">return</span>&nbsp;<span class="ident" id="7253511">rc</span><span class="op" id="7253513">.</span><span class="ident" id="7253514">cols</span><br>
<span class="lineno">735</span><span class="op" id="7253519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7253522">var</span>&nbsp;<span class="ident" id="7253526">rowsCursorNextHook</span>&nbsp;<span class="keyword" id="7253545">func</span><span class="op" id="7253549">(</span><span class="ident" id="7253550">dest</span>&nbsp;<span class="op" id="7253555">[</span><span class="op" id="7253556">]</span><span class="ident" id="7253557">driver</span><span class="op" id="7253563">.</span><span class="ident" id="7253564">Value</span><span class="op" id="7253569">)</span>&nbsp;<span class="builtintype" id="7253571">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7253578">func</span>&nbsp;<span class="op" id="7253583">(</span><span class="ident" id="7253584">rc</span>&nbsp;<span class="op" id="7253587">*</span><span class="ident" id="7253588">rowsCursor</span><span class="op" id="7253598">)</span>&nbsp;<span class="ident" id="7253600">Next</span><span class="op" id="7253604">(</span><span class="ident" id="7253605">dest</span>&nbsp;<span class="op" id="7253610">[</span><span class="op" id="7253611">]</span><span class="ident" id="7253612">driver</span><span class="op" id="7253618">.</span><span class="ident" id="7253619">Value</span><span class="op" id="7253624">)</span>&nbsp;<span class="builtintype" id="7253626">error</span>&nbsp;<span class="op" id="7253632">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7253635">if</span>&nbsp;<span class="ident" id="7253638">rowsCursorNextHook</span>&nbsp;<span class="op" id="7253657">!=</span>&nbsp;<span class="ident" id="7253660">nil</span>&nbsp;<span class="op" id="7253664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7253668">return</span>&nbsp;<span class="ident" id="7253675">rowsCursorNextHook</span><span class="op" id="7253693">(</span><span class="ident" id="7253694">dest</span><span class="op" id="7253698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7253701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7253705">if</span>&nbsp;<span class="ident" id="7253708">rc</span><span class="op" id="7253710">.</span><span class="ident" id="7253711">closed</span>&nbsp;<span class="op" id="7253718">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7253722">return</span>&nbsp;<span class="ident" id="7253729">errors</span><span class="op" id="7253735">.</span><span class="ident" id="7253736">New</span><span class="op" id="7253739">(</span><span class="string" id="7253740">&#34;fakedb:&nbsp;cursor&nbsp;is&nbsp;closed&#34;</span><span class="op" id="7253766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7253769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7253772">rc</span><span class="op" id="7253774">.</span><span class="ident" id="7253775">pos</span><span class="op" id="7253778">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7253782">if</span>&nbsp;<span class="ident" id="7253785">rc</span><span class="op" id="7253787">.</span><span class="ident" id="7253788">pos</span>&nbsp;<span class="op" id="7253792">==</span>&nbsp;<span class="ident" id="7253795">rc</span><span class="op" id="7253797">.</span><span class="ident" id="7253798">errPos</span>&nbsp;<span class="op" id="7253805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7253809">return</span>&nbsp;<span class="ident" id="7253816">rc</span><span class="op" id="7253818">.</span><span class="ident" id="7253819">err</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7253824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7253827">if</span>&nbsp;<span class="ident" id="7253830">rc</span><span class="op" id="7253832">.</span><span class="ident" id="7253833">pos</span>&nbsp;<span class="op" id="7253837">&gt;=</span>&nbsp;<span class="builtinfunc" id="7253840">len</span><span class="op" id="7253843">(</span><span class="ident" id="7253844">rc</span><span class="op" id="7253846">.</span><span class="ident" id="7253847">rows</span><span class="op" id="7253851">)</span>&nbsp;<span class="op" id="7253853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7253857">return</span>&nbsp;<span class="ident" id="7253864">io</span><span class="op" id="7253866">.</span><span class="ident" id="7253867">EOF</span>&nbsp;<span class="comment" id="7253871">//&nbsp;per&nbsp;interface&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7253894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7253897">for</span>&nbsp;<span class="ident" id="7253901">i</span><span class="op" id="7253902">,</span>&nbsp;<span class="ident" id="7253904">v</span>&nbsp;<span class="op" id="7253906">:=</span>&nbsp;<span class="keyword" id="7253909">range</span>&nbsp;<span class="ident" id="7253915">rc</span><span class="op" id="7253917">.</span><span class="ident" id="7253918">rows</span><span class="op" id="7253922">[</span><span class="ident" id="7253923">rc</span><span class="op" id="7253925">.</span><span class="ident" id="7253926">pos</span><span class="op" id="7253929">]</span><span class="op" id="7253930">.</span><span class="ident" id="7253931">cols</span>&nbsp;<span class="op" id="7253936">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7253940">//&nbsp;TODO(bradfitz):&nbsp;convert&nbsp;to&nbsp;subset&nbsp;types?&nbsp;naah,&nbsp;I</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7253994">//&nbsp;think&nbsp;the&nbsp;subset&nbsp;types&nbsp;should&nbsp;only&nbsp;be&nbsp;input&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7254046">//&nbsp;driver,&nbsp;but&nbsp;the&nbsp;sql&nbsp;package&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7254104">//&nbsp;a&nbsp;wider&nbsp;range&nbsp;of&nbsp;types&nbsp;coming&nbsp;out&nbsp;of&nbsp;drivers.&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7254159">//&nbsp;for&nbsp;ease&nbsp;of&nbsp;drivers,&nbsp;and&nbsp;to&nbsp;prevent&nbsp;drivers&nbsp;from</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7254213">//&nbsp;messing&nbsp;up&nbsp;conversions&nbsp;or&nbsp;doing&nbsp;them&nbsp;differently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7254268">dest</span><span class="op" id="7254272">[</span><span class="ident" id="7254273">i</span><span class="op" id="7254274">]</span>&nbsp;<span class="op" id="7254276">=</span>&nbsp;<span class="ident" id="7254278">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7254283">if</span>&nbsp;<span class="ident" id="7254286">bs</span><span class="op" id="7254288">,</span>&nbsp;<span class="ident" id="7254290">ok</span>&nbsp;<span class="op" id="7254293">:=</span>&nbsp;<span class="ident" id="7254296">v</span><span class="op" id="7254297">.</span><span class="op" id="7254298">(</span><span class="op" id="7254299">[</span><span class="op" id="7254300">]</span><span class="builtintype" id="7254301">byte</span><span class="op" id="7254305">)</span><span class="op" id="7254306">;</span>&nbsp;<span class="ident" id="7254308">ok</span>&nbsp;<span class="op" id="7254311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7254316">if</span>&nbsp;<span class="ident" id="7254319">rc</span><span class="op" id="7254321">.</span><span class="ident" id="7254322">bytesClone</span>&nbsp;<span class="op" id="7254333">==</span>&nbsp;<span class="ident" id="7254336">nil</span>&nbsp;<span class="op" id="7254340">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7254346">rc</span><span class="op" id="7254348">.</span><span class="ident" id="7254349">bytesClone</span>&nbsp;<span class="op" id="7254360">=</span>&nbsp;<span class="builtinfunc" id="7254362">make</span><span class="op" id="7254366">(</span><span class="keyword" id="7254367">map</span><span class="op" id="7254370">[</span><span class="op" id="7254371">*</span><span class="builtintype" id="7254372">byte</span><span class="op" id="7254376">]</span><span class="op" id="7254377">[</span><span class="op" id="7254378">]</span><span class="builtintype" id="7254379">byte</span><span class="op" id="7254383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7254388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7254393">clone</span><span class="op" id="7254398">,</span>&nbsp;<span class="ident" id="7254400">ok</span>&nbsp;<span class="op" id="7254403">:=</span>&nbsp;<span class="ident" id="7254406">rc</span><span class="op" id="7254408">.</span><span class="ident" id="7254409">bytesClone</span><span class="op" id="7254419">[</span><span class="op" id="7254420">&amp;</span><span class="ident" id="7254421">bs</span><span class="op" id="7254423">[</span><span class="num" id="7254424">0</span><span class="op" id="7254425">]</span><span class="op" id="7254426">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7254431">if</span>&nbsp;<span class="op" id="7254434">!</span><span class="ident" id="7254435">ok</span>&nbsp;<span class="op" id="7254438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7254444">clone</span>&nbsp;<span class="op" id="7254450">=</span>&nbsp;<span class="builtinfunc" id="7254452">make</span><span class="op" id="7254456">(</span><span class="op" id="7254457">[</span><span class="op" id="7254458">]</span><span class="builtintype" id="7254459">byte</span><span class="op" id="7254463">,</span>&nbsp;<span class="builtinfunc" id="7254465">len</span><span class="op" id="7254468">(</span><span class="ident" id="7254469">bs</span><span class="op" id="7254471">)</span><span class="op" id="7254472">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7254478">copy</span><span class="op" id="7254482">(</span><span class="ident" id="7254483">clone</span><span class="op" id="7254488">,</span>&nbsp;<span class="ident" id="7254490">bs</span><span class="op" id="7254492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7254498">rc</span><span class="op" id="7254500">.</span><span class="ident" id="7254501">bytesClone</span><span class="op" id="7254511">[</span><span class="op" id="7254512">&amp;</span><span class="ident" id="7254513">bs</span><span class="op" id="7254515">[</span><span class="num" id="7254516">0</span><span class="op" id="7254517">]</span><span class="op" id="7254518">]</span>&nbsp;<span class="op" id="7254520">=</span>&nbsp;<span class="ident" id="7254522">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7254531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7254536">dest</span><span class="op" id="7254540">[</span><span class="ident" id="7254541">i</span><span class="op" id="7254542">]</span>&nbsp;<span class="op" id="7254544">=</span>&nbsp;<span class="ident" id="7254546">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7254554">}</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7254557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7254560">return</span>&nbsp;<span class="ident" id="7254567">nil</span><br>
<span class="lineno"></span><span class="op" id="7254571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7254574">//&nbsp;fakeDriverString&nbsp;is&nbsp;like&nbsp;driver.String,&nbsp;but&nbsp;indirects&nbsp;pointers&nbsp;like</span><br>
<span class="lineno">780</span><span class="comment" id="7254645">//&nbsp;DefaultValueConverter.</span><br>
<span class="lineno"></span><span class="comment" id="7254671">//</span><br>
<span class="lineno"></span><span class="comment" id="7254674">//&nbsp;This&nbsp;could&nbsp;be&nbsp;surprising&nbsp;behavior&nbsp;to&nbsp;retroactively&nbsp;apply&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="7254737">//&nbsp;driver.String&nbsp;now&nbsp;that&nbsp;Go1&nbsp;is&nbsp;out,&nbsp;but&nbsp;this&nbsp;is&nbsp;convenient&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="7254802">//&nbsp;our&nbsp;TestPointerParamsAndScans.</span><br>
<span class="lineno">785</span><span class="comment" id="7254836">//</span><br>
<span class="lineno"></span><span class="keyword" id="7254839">type</span>&nbsp;<span class="ident" id="7254844">fakeDriverString</span>&nbsp;<span class="keyword" id="7254861">struct</span><span class="op" id="7254867">{</span><span class="op" id="7254868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7254871">func</span>&nbsp;<span class="op" id="7254876">(</span><span class="ident" id="7254877">fakeDriverString</span><span class="op" id="7254893">)</span>&nbsp;<span class="ident" id="7254895">ConvertValue</span><span class="op" id="7254907">(</span><span class="ident" id="7254908">v</span>&nbsp;<span class="keyword" id="7254910">interface</span><span class="op" id="7254919">{</span><span class="op" id="7254920">}</span><span class="op" id="7254921">)</span>&nbsp;<span class="op" id="7254923">(</span><span class="ident" id="7254924">driver</span><span class="op" id="7254930">.</span><span class="ident" id="7254931">Value</span><span class="op" id="7254936">,</span>&nbsp;<span class="builtintype" id="7254938">error</span><span class="op" id="7254943">)</span>&nbsp;<span class="op" id="7254945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7254948">switch</span>&nbsp;<span class="ident" id="7254955">c</span>&nbsp;<span class="op" id="7254957">:=</span>&nbsp;<span class="ident" id="7254960">v</span><span class="op" id="7254961">.</span><span class="op" id="7254962">(</span><span class="keyword" id="7254963">type</span><span class="op" id="7254967">)</span>&nbsp;<span class="op" id="7254969">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7254972">case</span>&nbsp;<span class="builtintype" id="7254977">string</span><span class="op" id="7254983">,</span>&nbsp;<span class="op" id="7254985">[</span><span class="op" id="7254986">]</span><span class="builtintype" id="7254987">byte</span><span class="op" id="7254991">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7254995">return</span>&nbsp;<span class="ident" id="7255002">v</span><span class="op" id="7255003">,</span>&nbsp;<span class="ident" id="7255005">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255010">case</span>&nbsp;<span class="op" id="7255015">*</span><span class="builtintype" id="7255016">string</span><span class="op" id="7255022">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255026">if</span>&nbsp;<span class="ident" id="7255029">c</span>&nbsp;<span class="op" id="7255031">==</span>&nbsp;<span class="ident" id="7255034">nil</span>&nbsp;<span class="op" id="7255038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255043">return</span>&nbsp;<span class="ident" id="7255050">nil</span><span class="op" id="7255053">,</span>&nbsp;<span class="ident" id="7255055">nil</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7255061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255065">return</span>&nbsp;<span class="op" id="7255072">*</span><span class="ident" id="7255073">c</span><span class="op" id="7255074">,</span>&nbsp;<span class="ident" id="7255076">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7255081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255084">return</span>&nbsp;<span class="ident" id="7255091">fmt</span><span class="op" id="7255094">.</span><span class="ident" id="7255095">Sprintf</span><span class="op" id="7255102">(</span><span class="string" id="7255103">&#34;%v&#34;</span><span class="op" id="7255107">,</span>&nbsp;<span class="ident" id="7255109">v</span><span class="op" id="7255110">)</span><span class="op" id="7255111">,</span>&nbsp;<span class="ident" id="7255113">nil</span><br>
<span class="lineno"></span><span class="op" id="7255117">}</span><br>
<span class="lineno">800</span><br>
<span class="lineno"></span><span class="keyword" id="7255120">func</span>&nbsp;<span class="ident" id="7255125">converterForType</span><span class="op" id="7255141">(</span><span class="ident" id="7255142">typ</span>&nbsp;<span class="builtintype" id="7255146">string</span><span class="op" id="7255152">)</span>&nbsp;<span class="ident" id="7255154">driver</span><span class="op" id="7255160">.</span><span class="ident" id="7255161">ValueConverter</span>&nbsp;<span class="op" id="7255176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255179">switch</span>&nbsp;<span class="ident" id="7255186">typ</span>&nbsp;<span class="op" id="7255190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255193">case</span>&nbsp;<span class="string" id="7255198">&#34;bool&#34;</span><span class="op" id="7255204">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255208">return</span>&nbsp;<span class="ident" id="7255215">driver</span><span class="op" id="7255221">.</span><span class="ident" id="7255222">Bool</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255228">case</span>&nbsp;<span class="string" id="7255233">&#34;nullbool&#34;</span><span class="op" id="7255243">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255247">return</span>&nbsp;<span class="ident" id="7255254">driver</span><span class="op" id="7255260">.</span><span class="ident" id="7255261">Null</span><span class="op" id="7255265">{</span><span class="ident" id="7255266">Converter</span><span class="op" id="7255275">:</span>&nbsp;<span class="ident" id="7255277">driver</span><span class="op" id="7255283">.</span><span class="ident" id="7255284">Bool</span><span class="op" id="7255288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255291">case</span>&nbsp;<span class="string" id="7255296">&#34;int32&#34;</span><span class="op" id="7255303">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255307">return</span>&nbsp;<span class="ident" id="7255314">driver</span><span class="op" id="7255320">.</span><span class="ident" id="7255321">Int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255328">case</span>&nbsp;<span class="string" id="7255333">&#34;string&#34;</span><span class="op" id="7255341">:</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255345">return</span>&nbsp;<span class="ident" id="7255352">driver</span><span class="op" id="7255358">.</span><span class="ident" id="7255359">NotNull</span><span class="op" id="7255366">{</span><span class="ident" id="7255367">Converter</span><span class="op" id="7255376">:</span>&nbsp;<span class="ident" id="7255378">fakeDriverString</span><span class="op" id="7255394">{</span><span class="op" id="7255395">}</span><span class="op" id="7255396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255399">case</span>&nbsp;<span class="string" id="7255404">&#34;nullstring&#34;</span><span class="op" id="7255416">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255420">return</span>&nbsp;<span class="ident" id="7255427">driver</span><span class="op" id="7255433">.</span><span class="ident" id="7255434">Null</span><span class="op" id="7255438">{</span><span class="ident" id="7255439">Converter</span><span class="op" id="7255448">:</span>&nbsp;<span class="ident" id="7255450">fakeDriverString</span><span class="op" id="7255466">{</span><span class="op" id="7255467">}</span><span class="op" id="7255468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255471">case</span>&nbsp;<span class="string" id="7255476">&#34;int64&#34;</span><span class="op" id="7255483">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7255487">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255539">return</span>&nbsp;<span class="ident" id="7255546">driver</span><span class="op" id="7255552">.</span><span class="ident" id="7255553">NotNull</span><span class="op" id="7255560">{</span><span class="ident" id="7255561">Converter</span><span class="op" id="7255570">:</span>&nbsp;<span class="ident" id="7255572">driver</span><span class="op" id="7255578">.</span><span class="ident" id="7255579">DefaultParameterConverter</span><span class="op" id="7255604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255607">case</span>&nbsp;<span class="string" id="7255612">&#34;nullint64&#34;</span><span class="op" id="7255623">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7255627">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255679">return</span>&nbsp;<span class="ident" id="7255686">driver</span><span class="op" id="7255692">.</span><span class="ident" id="7255693">Null</span><span class="op" id="7255697">{</span><span class="ident" id="7255698">Converter</span><span class="op" id="7255707">:</span>&nbsp;<span class="ident" id="7255709">driver</span><span class="op" id="7255715">.</span><span class="ident" id="7255716">DefaultParameterConverter</span><span class="op" id="7255741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255744">case</span>&nbsp;<span class="string" id="7255749">&#34;float64&#34;</span><span class="op" id="7255758">:</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7255762">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255814">return</span>&nbsp;<span class="ident" id="7255821">driver</span><span class="op" id="7255827">.</span><span class="ident" id="7255828">NotNull</span><span class="op" id="7255835">{</span><span class="ident" id="7255836">Converter</span><span class="op" id="7255845">:</span>&nbsp;<span class="ident" id="7255847">driver</span><span class="op" id="7255853">.</span><span class="ident" id="7255854">DefaultParameterConverter</span><span class="op" id="7255879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255882">case</span>&nbsp;<span class="string" id="7255887">&#34;nullfloat64&#34;</span><span class="op" id="7255900">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7255904">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7255956">return</span>&nbsp;<span class="ident" id="7255963">driver</span><span class="op" id="7255969">.</span><span class="ident" id="7255970">Null</span><span class="op" id="7255974">{</span><span class="ident" id="7255975">Converter</span><span class="op" id="7255984">:</span>&nbsp;<span class="ident" id="7255986">driver</span><span class="op" id="7255992">.</span><span class="ident" id="7255993">DefaultParameterConverter</span><span class="op" id="7256018">}</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7256021">case</span>&nbsp;<span class="string" id="7256026">&#34;datetime&#34;</span><span class="op" id="7256036">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7256040">return</span>&nbsp;<span class="ident" id="7256047">driver</span><span class="op" id="7256053">.</span><span class="ident" id="7256054">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7256081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7256084">panic</span><span class="op" id="7256089">(</span><span class="string" id="7256090">&#34;invalid&nbsp;fakedb&nbsp;column&nbsp;type&nbsp;of&nbsp;&#34;</span>&nbsp;<span class="op" id="7256123">+</span>&nbsp;<span class="ident" id="7256125">typ</span><span class="op" id="7256128">)</span><br>
<span class="lineno"></span><span class="op" id="7256130">}</span>
</div>
</body>
</html>
