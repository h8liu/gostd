<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/smtp</h2>
<ul>
<li><a href="/gostd/net/smtp/auth.go.html">auth.go</a></li>
<li><a href="/gostd/net/smtp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/smtp/smtp.go.html">smtp.go</a></li>
<li><a href="/gostd/net/smtp/smtp_test.go.html">smtp_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6612784">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6612839">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6612893">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6612944">package</span>&nbsp;<span class="ident" id="6612952">smtp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6612958">import</span>&nbsp;<span class="op" id="6612965">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6612968">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6612977">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6612986">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6613000">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6613015">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6613021">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6613028">&#34;net/textproto&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6613045">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6613056">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6613067">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6613074">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="6613077">type</span>&nbsp;<span class="ident" id="6613082">authTest</span>&nbsp;<span class="keyword" id="6613091">struct</span>&nbsp;<span class="op" id="6613098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613101">auth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6613112">Auth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613118">challenges</span>&nbsp;<span class="op" id="6613129">[</span><span class="op" id="6613130">]</span><span class="builtintype" id="6613131">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613139">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6613150">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613158">responses</span>&nbsp;&nbsp;<span class="op" id="6613169">[</span><span class="op" id="6613170">]</span><span class="builtintype" id="6613171">string</span><br>
<span class="lineno">25</span><span class="op" id="6613178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6613181">var</span>&nbsp;<span class="ident" id="6613185">authTests</span>&nbsp;<span class="op" id="6613195">=</span>&nbsp;<span class="op" id="6613197">[</span><span class="op" id="6613198">]</span><span class="ident" id="6613199">authTest</span><span class="op" id="6613207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6613210">{</span><span class="ident" id="6613211">PlainAuth</span><span class="op" id="6613220">(</span><span class="string" id="6613221">&#34;&#34;</span><span class="op" id="6613223">,</span>&nbsp;<span class="string" id="6613225">&#34;user&#34;</span><span class="op" id="6613231">,</span>&nbsp;<span class="string" id="6613233">&#34;pass&#34;</span><span class="op" id="6613239">,</span>&nbsp;<span class="string" id="6613241">&#34;testserver&#34;</span><span class="op" id="6613253">)</span><span class="op" id="6613254">,</span>&nbsp;<span class="op" id="6613256">[</span><span class="op" id="6613257">]</span><span class="builtintype" id="6613258">string</span><span class="op" id="6613264">{</span><span class="op" id="6613265">}</span><span class="op" id="6613266">,</span>&nbsp;<span class="string" id="6613268">&#34;PLAIN&#34;</span><span class="op" id="6613275">,</span>&nbsp;<span class="op" id="6613277">[</span><span class="op" id="6613278">]</span><span class="builtintype" id="6613279">string</span><span class="op" id="6613285">{</span><span class="string" id="6613286">&#34;\x00user\x00pass&#34;</span><span class="op" id="6613304">}</span><span class="op" id="6613305">}</span><span class="op" id="6613306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6613309">{</span><span class="ident" id="6613310">PlainAuth</span><span class="op" id="6613319">(</span><span class="string" id="6613320">&#34;foo&#34;</span><span class="op" id="6613325">,</span>&nbsp;<span class="string" id="6613327">&#34;bar&#34;</span><span class="op" id="6613332">,</span>&nbsp;<span class="string" id="6613334">&#34;baz&#34;</span><span class="op" id="6613339">,</span>&nbsp;<span class="string" id="6613341">&#34;testserver&#34;</span><span class="op" id="6613353">)</span><span class="op" id="6613354">,</span>&nbsp;<span class="op" id="6613356">[</span><span class="op" id="6613357">]</span><span class="builtintype" id="6613358">string</span><span class="op" id="6613364">{</span><span class="op" id="6613365">}</span><span class="op" id="6613366">,</span>&nbsp;<span class="string" id="6613368">&#34;PLAIN&#34;</span><span class="op" id="6613375">,</span>&nbsp;<span class="op" id="6613377">[</span><span class="op" id="6613378">]</span><span class="builtintype" id="6613379">string</span><span class="op" id="6613385">{</span><span class="string" id="6613386">&#34;foo\x00bar\x00baz&#34;</span><span class="op" id="6613405">}</span><span class="op" id="6613406">}</span><span class="op" id="6613407">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6613410">{</span><span class="ident" id="6613411">CRAMMD5Auth</span><span class="op" id="6613422">(</span><span class="string" id="6613423">&#34;user&#34;</span><span class="op" id="6613429">,</span>&nbsp;<span class="string" id="6613431">&#34;pass&#34;</span><span class="op" id="6613437">)</span><span class="op" id="6613438">,</span>&nbsp;<span class="op" id="6613440">[</span><span class="op" id="6613441">]</span><span class="builtintype" id="6613442">string</span><span class="op" id="6613448">{</span><span class="string" id="6613449">&#34;&lt;123456.1322876914@testserver&gt;&#34;</span><span class="op" id="6613481">}</span><span class="op" id="6613482">,</span>&nbsp;<span class="string" id="6613484">&#34;CRAM-MD5&#34;</span><span class="op" id="6613494">,</span>&nbsp;<span class="op" id="6613496">[</span><span class="op" id="6613497">]</span><span class="builtintype" id="6613498">string</span><span class="op" id="6613504">{</span><span class="string" id="6613505">&#34;&#34;</span><span class="op" id="6613507">,</span>&nbsp;<span class="string" id="6613509">&#34;user&nbsp;287eb355114cf5c471c26a875f1ca4ae&#34;</span><span class="op" id="6613548">}</span><span class="op" id="6613549">}</span><span class="op" id="6613550">,</span><br>
<span class="lineno"></span><span class="op" id="6613552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6613555">func</span>&nbsp;<span class="ident" id="6613560">TestAuth</span><span class="op" id="6613568">(</span><span class="ident" id="6613569">t</span>&nbsp;<span class="op" id="6613571">*</span><span class="ident" id="6613572">testing</span><span class="op" id="6613579">.</span><span class="ident" id="6613580">T</span><span class="op" id="6613581">)</span>&nbsp;<span class="op" id="6613583">{</span><br>
<span class="lineno"></span><span class="ident" id="6613585">testLoop</span><span class="op" id="6613593">:</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6613596">for</span>&nbsp;<span class="ident" id="6613600">i</span><span class="op" id="6613601">,</span>&nbsp;<span class="ident" id="6613603">test</span>&nbsp;<span class="op" id="6613608">:=</span>&nbsp;<span class="keyword" id="6613611">range</span>&nbsp;<span class="ident" id="6613617">authTests</span>&nbsp;<span class="op" id="6613627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613631">name</span><span class="op" id="6613635">,</span>&nbsp;<span class="ident" id="6613637">resp</span><span class="op" id="6613641">,</span>&nbsp;<span class="ident" id="6613643">err</span>&nbsp;<span class="op" id="6613647">:=</span>&nbsp;<span class="ident" id="6613650">test</span><span class="op" id="6613654">.</span><span class="ident" id="6613655">auth</span><span class="op" id="6613659">.</span><span class="ident" id="6613660">Start</span><span class="op" id="6613665">(</span><span class="op" id="6613666">&amp;</span><span class="ident" id="6613667">ServerInfo</span><span class="op" id="6613677">{</span><span class="string" id="6613678">&#34;testserver&#34;</span><span class="op" id="6613690">,</span>&nbsp;<span class="builtintype" id="6613692">true</span><span class="op" id="6613696">,</span>&nbsp;<span class="ident" id="6613698">nil</span><span class="op" id="6613701">}</span><span class="op" id="6613702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6613706">if</span>&nbsp;<span class="ident" id="6613709">name</span>&nbsp;<span class="op" id="6613714">!=</span>&nbsp;<span class="ident" id="6613717">test</span><span class="op" id="6613721">.</span><span class="ident" id="6613722">name</span>&nbsp;<span class="op" id="6613727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613732">t</span><span class="op" id="6613733">.</span><span class="ident" id="6613734">Errorf</span><span class="op" id="6613740">(</span><span class="string" id="6613741">&#34;#%d&nbsp;got&nbsp;name&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="6613771">,</span>&nbsp;<span class="ident" id="6613773">i</span><span class="op" id="6613774">,</span>&nbsp;<span class="ident" id="6613776">name</span><span class="op" id="6613780">,</span>&nbsp;<span class="ident" id="6613782">test</span><span class="op" id="6613786">.</span><span class="ident" id="6613787">name</span><span class="op" id="6613791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6613795">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6613799">if</span>&nbsp;<span class="op" id="6613802">!</span><span class="ident" id="6613803">bytes</span><span class="op" id="6613808">.</span><span class="ident" id="6613809">Equal</span><span class="op" id="6613814">(</span><span class="ident" id="6613815">resp</span><span class="op" id="6613819">,</span>&nbsp;<span class="op" id="6613821">[</span><span class="op" id="6613822">]</span><span class="builtintype" id="6613823">byte</span><span class="op" id="6613827">(</span><span class="ident" id="6613828">test</span><span class="op" id="6613832">.</span><span class="ident" id="6613833">responses</span><span class="op" id="6613842">[</span><span class="num" id="6613843">0</span><span class="op" id="6613844">]</span><span class="op" id="6613845">)</span><span class="op" id="6613846">)</span>&nbsp;<span class="op" id="6613848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613853">t</span><span class="op" id="6613854">.</span><span class="ident" id="6613855">Errorf</span><span class="op" id="6613861">(</span><span class="string" id="6613862">&#34;#%d&nbsp;got&nbsp;response&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="6613896">,</span>&nbsp;<span class="ident" id="6613898">i</span><span class="op" id="6613899">,</span>&nbsp;<span class="ident" id="6613901">resp</span><span class="op" id="6613905">,</span>&nbsp;<span class="ident" id="6613907">test</span><span class="op" id="6613911">.</span><span class="ident" id="6613912">responses</span><span class="op" id="6613921">[</span><span class="num" id="6613922">0</span><span class="op" id="6613923">]</span><span class="op" id="6613924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6613928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6613932">if</span>&nbsp;<span class="ident" id="6613935">err</span>&nbsp;<span class="op" id="6613939">!=</span>&nbsp;<span class="ident" id="6613942">nil</span>&nbsp;<span class="op" id="6613946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613951">t</span><span class="op" id="6613952">.</span><span class="ident" id="6613953">Errorf</span><span class="op" id="6613959">(</span><span class="string" id="6613960">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="6613975">,</span>&nbsp;<span class="ident" id="6613977">i</span><span class="op" id="6613978">,</span>&nbsp;<span class="ident" id="6613980">err</span><span class="op" id="6613983">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6613987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6613991">for</span>&nbsp;<span class="ident" id="6613995">j</span>&nbsp;<span class="op" id="6613997">:=</span>&nbsp;<span class="keyword" id="6614000">range</span>&nbsp;<span class="ident" id="6614006">test</span><span class="op" id="6614010">.</span><span class="ident" id="6614011">challenges</span>&nbsp;<span class="op" id="6614022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614027">challenge</span>&nbsp;<span class="op" id="6614037">:=</span>&nbsp;<span class="op" id="6614040">[</span><span class="op" id="6614041">]</span><span class="builtintype" id="6614042">byte</span><span class="op" id="6614046">(</span><span class="ident" id="6614047">test</span><span class="op" id="6614051">.</span><span class="ident" id="6614052">challenges</span><span class="op" id="6614062">[</span><span class="ident" id="6614063">j</span><span class="op" id="6614064">]</span><span class="op" id="6614065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614070">expected</span>&nbsp;<span class="op" id="6614079">:=</span>&nbsp;<span class="op" id="6614082">[</span><span class="op" id="6614083">]</span><span class="builtintype" id="6614084">byte</span><span class="op" id="6614088">(</span><span class="ident" id="6614089">test</span><span class="op" id="6614093">.</span><span class="ident" id="6614094">responses</span><span class="op" id="6614103">[</span><span class="ident" id="6614104">j</span><span class="op" id="6614105">+</span><span class="num" id="6614106">1</span><span class="op" id="6614107">]</span><span class="op" id="6614108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614113">resp</span><span class="op" id="6614117">,</span>&nbsp;<span class="ident" id="6614119">err</span>&nbsp;<span class="op" id="6614123">:=</span>&nbsp;<span class="ident" id="6614126">test</span><span class="op" id="6614130">.</span><span class="ident" id="6614131">auth</span><span class="op" id="6614135">.</span><span class="ident" id="6614136">Next</span><span class="op" id="6614140">(</span><span class="ident" id="6614141">challenge</span><span class="op" id="6614150">,</span>&nbsp;<span class="builtintype" id="6614152">true</span><span class="op" id="6614156">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614161">if</span>&nbsp;<span class="ident" id="6614164">err</span>&nbsp;<span class="op" id="6614168">!=</span>&nbsp;<span class="ident" id="6614171">nil</span>&nbsp;<span class="op" id="6614175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614181">t</span><span class="op" id="6614182">.</span><span class="ident" id="6614183">Errorf</span><span class="op" id="6614189">(</span><span class="string" id="6614190">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="6614205">,</span>&nbsp;<span class="ident" id="6614207">i</span><span class="op" id="6614208">,</span>&nbsp;<span class="ident" id="6614210">err</span><span class="op" id="6614213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614219">continue</span>&nbsp;<span class="ident" id="6614228">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614245">if</span>&nbsp;<span class="op" id="6614248">!</span><span class="ident" id="6614249">bytes</span><span class="op" id="6614254">.</span><span class="ident" id="6614255">Equal</span><span class="op" id="6614260">(</span><span class="ident" id="6614261">resp</span><span class="op" id="6614265">,</span>&nbsp;<span class="ident" id="6614267">expected</span><span class="op" id="6614275">)</span>&nbsp;<span class="op" id="6614277">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614283">t</span><span class="op" id="6614284">.</span><span class="ident" id="6614285">Errorf</span><span class="op" id="6614291">(</span><span class="string" id="6614292">&#34;#%d&nbsp;got&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="6614317">,</span>&nbsp;<span class="ident" id="6614319">i</span><span class="op" id="6614320">,</span>&nbsp;<span class="ident" id="6614322">resp</span><span class="op" id="6614326">,</span>&nbsp;<span class="ident" id="6614328">expected</span><span class="op" id="6614336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614342">continue</span>&nbsp;<span class="ident" id="6614351">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614370">}</span><br>
<span class="lineno">60</span><span class="op" id="6614372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6614375">func</span>&nbsp;<span class="ident" id="6614380">TestAuthPlain</span><span class="op" id="6614393">(</span><span class="ident" id="6614394">t</span>&nbsp;<span class="op" id="6614396">*</span><span class="ident" id="6614397">testing</span><span class="op" id="6614404">.</span><span class="ident" id="6614405">T</span><span class="op" id="6614406">)</span>&nbsp;<span class="op" id="6614408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614411">auth</span>&nbsp;<span class="op" id="6614416">:=</span>&nbsp;<span class="ident" id="6614419">PlainAuth</span><span class="op" id="6614428">(</span><span class="string" id="6614429">&#34;foo&#34;</span><span class="op" id="6614434">,</span>&nbsp;<span class="string" id="6614436">&#34;bar&#34;</span><span class="op" id="6614441">,</span>&nbsp;<span class="string" id="6614443">&#34;baz&#34;</span><span class="op" id="6614448">,</span>&nbsp;<span class="string" id="6614450">&#34;servername&#34;</span><span class="op" id="6614462">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614466">tests</span>&nbsp;<span class="op" id="6614472">:=</span>&nbsp;<span class="op" id="6614475">[</span><span class="op" id="6614476">]</span><span class="keyword" id="6614477">struct</span>&nbsp;<span class="op" id="6614484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614488">server</span>&nbsp;<span class="op" id="6614495">*</span><span class="ident" id="6614496">ServerInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614509">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6614516">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614524">}</span><span class="op" id="6614525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614529">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614534">server</span><span class="op" id="6614540">:</span>&nbsp;<span class="op" id="6614542">&amp;</span><span class="ident" id="6614543">ServerInfo</span><span class="op" id="6614553">{</span><span class="ident" id="6614554">Name</span><span class="op" id="6614558">:</span>&nbsp;<span class="string" id="6614560">&#34;servername&#34;</span><span class="op" id="6614572">,</span>&nbsp;<span class="ident" id="6614574">TLS</span><span class="op" id="6614577">:</span>&nbsp;<span class="builtintype" id="6614579">true</span><span class="op" id="6614583">}</span><span class="op" id="6614584">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614588">}</span><span class="op" id="6614589">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6614598">//&nbsp;Okay;&nbsp;explicitly&nbsp;advertised&nbsp;by&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614643">server</span><span class="op" id="6614649">:</span>&nbsp;<span class="op" id="6614651">&amp;</span><span class="ident" id="6614652">ServerInfo</span><span class="op" id="6614662">{</span><span class="ident" id="6614663">Name</span><span class="op" id="6614667">:</span>&nbsp;<span class="string" id="6614669">&#34;servername&#34;</span><span class="op" id="6614681">,</span>&nbsp;<span class="ident" id="6614683">Auth</span><span class="op" id="6614687">:</span>&nbsp;<span class="op" id="6614689">[</span><span class="op" id="6614690">]</span><span class="builtintype" id="6614691">string</span><span class="op" id="6614697">{</span><span class="string" id="6614698">&#34;PLAIN&#34;</span><span class="op" id="6614705">}</span><span class="op" id="6614706">}</span><span class="op" id="6614707">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614711">}</span><span class="op" id="6614712">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614721">server</span><span class="op" id="6614727">:</span>&nbsp;<span class="op" id="6614729">&amp;</span><span class="ident" id="6614730">ServerInfo</span><span class="op" id="6614740">{</span><span class="ident" id="6614741">Name</span><span class="op" id="6614745">:</span>&nbsp;<span class="string" id="6614747">&#34;servername&#34;</span><span class="op" id="6614759">,</span>&nbsp;<span class="ident" id="6614761">Auth</span><span class="op" id="6614765">:</span>&nbsp;<span class="op" id="6614767">[</span><span class="op" id="6614768">]</span><span class="builtintype" id="6614769">string</span><span class="op" id="6614775">{</span><span class="string" id="6614776">&#34;CRAM-MD5&#34;</span><span class="op" id="6614786">}</span><span class="op" id="6614787">}</span><span class="op" id="6614788">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614793">err</span><span class="op" id="6614796">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6614801">&#34;unencrypted&nbsp;connection&#34;</span><span class="op" id="6614825">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614829">}</span><span class="op" id="6614830">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614839">server</span><span class="op" id="6614845">:</span>&nbsp;<span class="op" id="6614847">&amp;</span><span class="ident" id="6614848">ServerInfo</span><span class="op" id="6614858">{</span><span class="ident" id="6614859">Name</span><span class="op" id="6614863">:</span>&nbsp;<span class="string" id="6614865">&#34;attacker&#34;</span><span class="op" id="6614875">,</span>&nbsp;<span class="ident" id="6614877">TLS</span><span class="op" id="6614880">:</span>&nbsp;<span class="builtintype" id="6614882">true</span><span class="op" id="6614886">}</span><span class="op" id="6614887">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614892">err</span><span class="op" id="6614895">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6614900">&#34;wrong&nbsp;host&nbsp;name&#34;</span><span class="op" id="6614917">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614921">}</span><span class="op" id="6614922">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614925">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614928">for</span>&nbsp;<span class="ident" id="6614932">i</span><span class="op" id="6614933">,</span>&nbsp;<span class="ident" id="6614935">tt</span>&nbsp;<span class="op" id="6614938">:=</span>&nbsp;<span class="keyword" id="6614941">range</span>&nbsp;<span class="ident" id="6614947">tests</span>&nbsp;<span class="op" id="6614953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614957">_</span><span class="op" id="6614958">,</span>&nbsp;<span class="ident" id="6614960">_</span><span class="op" id="6614961">,</span>&nbsp;<span class="ident" id="6614963">err</span>&nbsp;<span class="op" id="6614967">:=</span>&nbsp;<span class="ident" id="6614970">auth</span><span class="op" id="6614974">.</span><span class="ident" id="6614975">Start</span><span class="op" id="6614980">(</span><span class="ident" id="6614981">tt</span><span class="op" id="6614983">.</span><span class="ident" id="6614984">server</span><span class="op" id="6614990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614994">got</span>&nbsp;<span class="op" id="6614998">:=</span>&nbsp;<span class="string" id="6615001">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6615006">if</span>&nbsp;<span class="ident" id="6615009">err</span>&nbsp;<span class="op" id="6615013">!=</span>&nbsp;<span class="ident" id="6615016">nil</span>&nbsp;<span class="op" id="6615020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6615025">got</span>&nbsp;<span class="op" id="6615029">=</span>&nbsp;<span class="ident" id="6615031">err</span><span class="op" id="6615034">.</span><span class="ident" id="6615035">Error</span><span class="op" id="6615040">(</span><span class="op" id="6615041">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6615045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6615049">if</span>&nbsp;<span class="ident" id="6615052">got</span>&nbsp;<span class="op" id="6615056">!=</span>&nbsp;<span class="ident" id="6615059">tt</span><span class="op" id="6615061">.</span><span class="ident" id="6615062">err</span>&nbsp;<span class="op" id="6615066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6615071">t</span><span class="op" id="6615072">.</span><span class="ident" id="6615073">Errorf</span><span class="op" id="6615079">(</span><span class="string" id="6615080">&#34;%d.&nbsp;got&nbsp;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6615109">,</span>&nbsp;<span class="ident" id="6615111">i</span><span class="op" id="6615112">,</span>&nbsp;<span class="ident" id="6615114">got</span><span class="op" id="6615117">,</span>&nbsp;<span class="ident" id="6615119">tt</span><span class="op" id="6615121">.</span><span class="ident" id="6615122">err</span><span class="op" id="6615125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6615129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6615132">}</span><br>
<span class="lineno">95</span><span class="op" id="6615134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6615137">type</span>&nbsp;<span class="ident" id="6615142">faker</span>&nbsp;<span class="keyword" id="6615148">struct</span>&nbsp;<span class="op" id="6615155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6615158">io</span><span class="op" id="6615160">.</span><span class="ident" id="6615161">ReadWriter</span><br>
<span class="lineno"></span><span class="op" id="6615172">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="6615175">func</span>&nbsp;<span class="op" id="6615180">(</span><span class="ident" id="6615181">f</span>&nbsp;<span class="ident" id="6615183">faker</span><span class="op" id="6615188">)</span>&nbsp;<span class="ident" id="6615190">Close</span><span class="op" id="6615195">(</span><span class="op" id="6615196">)</span>&nbsp;<span class="builtintype" id="6615198">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6615224">{</span>&nbsp;<span class="keyword" id="6615226">return</span>&nbsp;<span class="ident" id="6615233">nil</span>&nbsp;<span class="op" id="6615237">}</span><br>
<span class="lineno"></span><span class="keyword" id="6615239">func</span>&nbsp;<span class="op" id="6615244">(</span><span class="ident" id="6615245">f</span>&nbsp;<span class="ident" id="6615247">faker</span><span class="op" id="6615252">)</span>&nbsp;<span class="ident" id="6615254">LocalAddr</span><span class="op" id="6615263">(</span><span class="op" id="6615264">)</span>&nbsp;<span class="ident" id="6615266">net</span><span class="op" id="6615269">.</span><span class="ident" id="6615270">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6615288">{</span>&nbsp;<span class="keyword" id="6615290">return</span>&nbsp;<span class="ident" id="6615297">nil</span>&nbsp;<span class="op" id="6615301">}</span><br>
<span class="lineno"></span><span class="keyword" id="6615303">func</span>&nbsp;<span class="op" id="6615308">(</span><span class="ident" id="6615309">f</span>&nbsp;<span class="ident" id="6615311">faker</span><span class="op" id="6615316">)</span>&nbsp;<span class="ident" id="6615318">RemoteAddr</span><span class="op" id="6615328">(</span><span class="op" id="6615329">)</span>&nbsp;<span class="ident" id="6615331">net</span><span class="op" id="6615334">.</span><span class="ident" id="6615335">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6615352">{</span>&nbsp;<span class="keyword" id="6615354">return</span>&nbsp;<span class="ident" id="6615361">nil</span>&nbsp;<span class="op" id="6615365">}</span><br>
<span class="lineno"></span><span class="keyword" id="6615367">func</span>&nbsp;<span class="op" id="6615372">(</span><span class="ident" id="6615373">f</span>&nbsp;<span class="ident" id="6615375">faker</span><span class="op" id="6615380">)</span>&nbsp;<span class="ident" id="6615382">SetDeadline</span><span class="op" id="6615393">(</span><span class="ident" id="6615394">time</span><span class="op" id="6615398">.</span><span class="ident" id="6615399">Time</span><span class="op" id="6615403">)</span>&nbsp;<span class="builtintype" id="6615405">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6615416">{</span>&nbsp;<span class="keyword" id="6615418">return</span>&nbsp;<span class="ident" id="6615425">nil</span>&nbsp;<span class="op" id="6615429">}</span><br>
<span class="lineno">105</span><span class="keyword" id="6615431">func</span>&nbsp;<span class="op" id="6615436">(</span><span class="ident" id="6615437">f</span>&nbsp;<span class="ident" id="6615439">faker</span><span class="op" id="6615444">)</span>&nbsp;<span class="ident" id="6615446">SetReadDeadline</span><span class="op" id="6615461">(</span><span class="ident" id="6615462">time</span><span class="op" id="6615466">.</span><span class="ident" id="6615467">Time</span><span class="op" id="6615471">)</span>&nbsp;<span class="builtintype" id="6615473">error</span>&nbsp;&nbsp;<span class="op" id="6615480">{</span>&nbsp;<span class="keyword" id="6615482">return</span>&nbsp;<span class="ident" id="6615489">nil</span>&nbsp;<span class="op" id="6615493">}</span><br>
<span class="lineno"></span><span class="keyword" id="6615495">func</span>&nbsp;<span class="op" id="6615500">(</span><span class="ident" id="6615501">f</span>&nbsp;<span class="ident" id="6615503">faker</span><span class="op" id="6615508">)</span>&nbsp;<span class="ident" id="6615510">SetWriteDeadline</span><span class="op" id="6615526">(</span><span class="ident" id="6615527">time</span><span class="op" id="6615531">.</span><span class="ident" id="6615532">Time</span><span class="op" id="6615536">)</span>&nbsp;<span class="builtintype" id="6615538">error</span>&nbsp;<span class="op" id="6615544">{</span>&nbsp;<span class="keyword" id="6615546">return</span>&nbsp;<span class="ident" id="6615553">nil</span>&nbsp;<span class="op" id="6615557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6615560">func</span>&nbsp;<span class="ident" id="6615565">TestBasic</span><span class="op" id="6615574">(</span><span class="ident" id="6615575">t</span>&nbsp;<span class="op" id="6615577">*</span><span class="ident" id="6615578">testing</span><span class="op" id="6615585">.</span><span class="ident" id="6615586">T</span><span class="op" id="6615587">)</span>&nbsp;<span class="op" id="6615589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6615592">server</span>&nbsp;<span class="op" id="6615599">:=</span>&nbsp;<span class="ident" id="6615602">strings</span><span class="op" id="6615609">.</span><span class="ident" id="6615610">Join</span><span class="op" id="6615614">(</span><span class="ident" id="6615615">strings</span><span class="op" id="6615622">.</span><span class="ident" id="6615623">Split</span><span class="op" id="6615628">(</span><span class="ident" id="6615629">basicServer</span><span class="op" id="6615640">,</span>&nbsp;<span class="string" id="6615642">&#34;\n&#34;</span><span class="op" id="6615646">)</span><span class="op" id="6615647">,</span>&nbsp;<span class="string" id="6615649">&#34;\r\n&#34;</span><span class="op" id="6615655">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6615658">client</span>&nbsp;<span class="op" id="6615665">:=</span>&nbsp;<span class="ident" id="6615668">strings</span><span class="op" id="6615675">.</span><span class="ident" id="6615676">Join</span><span class="op" id="6615680">(</span><span class="ident" id="6615681">strings</span><span class="op" id="6615688">.</span><span class="ident" id="6615689">Split</span><span class="op" id="6615694">(</span><span class="ident" id="6615695">basicClient</span><span class="op" id="6615706">,</span>&nbsp;<span class="string" id="6615708">&#34;\n&#34;</span><span class="op" id="6615712">)</span><span class="op" id="6615713">,</span>&nbsp;<span class="string" id="6615715">&#34;\r\n&#34;</span><span class="op" id="6615721">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6615725">var</span>&nbsp;<span class="ident" id="6615729">cmdbuf</span>&nbsp;<span class="ident" id="6615736">bytes</span><span class="op" id="6615741">.</span><span class="ident" id="6615742">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6615750">bcmdbuf</span>&nbsp;<span class="op" id="6615758">:=</span>&nbsp;<span class="ident" id="6615761">bufio</span><span class="op" id="6615766">.</span><span class="ident" id="6615767">NewWriter</span><span class="op" id="6615776">(</span><span class="op" id="6615777">&amp;</span><span class="ident" id="6615778">cmdbuf</span><span class="op" id="6615784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6615787">var</span>&nbsp;<span class="ident" id="6615791">fake</span>&nbsp;<span class="ident" id="6615796">faker</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6615803">fake</span><span class="op" id="6615807">.</span><span class="ident" id="6615808">ReadWriter</span>&nbsp;<span class="op" id="6615819">=</span>&nbsp;<span class="ident" id="6615821">bufio</span><span class="op" id="6615826">.</span><span class="ident" id="6615827">NewReadWriter</span><span class="op" id="6615840">(</span><span class="ident" id="6615841">bufio</span><span class="op" id="6615846">.</span><span class="ident" id="6615847">NewReader</span><span class="op" id="6615856">(</span><span class="ident" id="6615857">strings</span><span class="op" id="6615864">.</span><span class="ident" id="6615865">NewReader</span><span class="op" id="6615874">(</span><span class="ident" id="6615875">server</span><span class="op" id="6615881">)</span><span class="op" id="6615882">)</span><span class="op" id="6615883">,</span>&nbsp;<span class="ident" id="6615885">bcmdbuf</span><span class="op" id="6615892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6615895">c</span>&nbsp;<span class="op" id="6615897">:=</span>&nbsp;<span class="op" id="6615900">&amp;</span><span class="ident" id="6615901">Client</span><span class="op" id="6615907">{</span><span class="ident" id="6615908">Text</span><span class="op" id="6615912">:</span>&nbsp;<span class="ident" id="6615914">textproto</span><span class="op" id="6615923">.</span><span class="ident" id="6615924">NewConn</span><span class="op" id="6615931">(</span><span class="ident" id="6615932">fake</span><span class="op" id="6615936">)</span><span class="op" id="6615937">,</span>&nbsp;<span class="ident" id="6615939">localName</span><span class="op" id="6615948">:</span>&nbsp;<span class="string" id="6615950">&#34;localhost&#34;</span><span class="op" id="6615961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6615965">if</span>&nbsp;<span class="ident" id="6615968">err</span>&nbsp;<span class="op" id="6615972">:=</span>&nbsp;<span class="ident" id="6615975">c</span><span class="op" id="6615976">.</span><span class="ident" id="6615977">helo</span><span class="op" id="6615981">(</span><span class="op" id="6615982">)</span><span class="op" id="6615983">;</span>&nbsp;<span class="ident" id="6615985">err</span>&nbsp;<span class="op" id="6615989">!=</span>&nbsp;<span class="ident" id="6615992">nil</span>&nbsp;<span class="op" id="6615996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6616000">t</span><span class="op" id="6616001">.</span><span class="ident" id="6616002">Fatalf</span><span class="op" id="6616008">(</span><span class="string" id="6616009">&#34;HELO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6616026">,</span>&nbsp;<span class="ident" id="6616028">err</span><span class="op" id="6616031">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6616034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616037">if</span>&nbsp;<span class="ident" id="6616040">err</span>&nbsp;<span class="op" id="6616044">:=</span>&nbsp;<span class="ident" id="6616047">c</span><span class="op" id="6616048">.</span><span class="ident" id="6616049">ehlo</span><span class="op" id="6616053">(</span><span class="op" id="6616054">)</span><span class="op" id="6616055">;</span>&nbsp;<span class="ident" id="6616057">err</span>&nbsp;<span class="op" id="6616061">==</span>&nbsp;<span class="ident" id="6616064">nil</span>&nbsp;<span class="op" id="6616068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6616072">t</span><span class="op" id="6616073">.</span><span class="ident" id="6616074">Fatalf</span><span class="op" id="6616080">(</span><span class="string" id="6616081">&#34;Expected&nbsp;first&nbsp;EHLO&nbsp;to&nbsp;fail&#34;</span><span class="op" id="6616110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6616113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616116">if</span>&nbsp;<span class="ident" id="6616119">err</span>&nbsp;<span class="op" id="6616123">:=</span>&nbsp;<span class="ident" id="6616126">c</span><span class="op" id="6616127">.</span><span class="ident" id="6616128">ehlo</span><span class="op" id="6616132">(</span><span class="op" id="6616133">)</span><span class="op" id="6616134">;</span>&nbsp;<span class="ident" id="6616136">err</span>&nbsp;<span class="op" id="6616140">!=</span>&nbsp;<span class="ident" id="6616143">nil</span>&nbsp;<span class="op" id="6616147">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6616151">t</span><span class="op" id="6616152">.</span><span class="ident" id="6616153">Fatalf</span><span class="op" id="6616159">(</span><span class="string" id="6616160">&#34;Second&nbsp;EHLO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6616184">,</span>&nbsp;<span class="ident" id="6616186">err</span><span class="op" id="6616189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6616192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6616196">c</span><span class="op" id="6616197">.</span><span class="ident" id="6616198">didHello</span>&nbsp;<span class="op" id="6616207">=</span>&nbsp;<span class="builtintype" id="6616209">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616215">if</span>&nbsp;<span class="ident" id="6616218">ok</span><span class="op" id="6616220">,</span>&nbsp;<span class="ident" id="6616222">args</span>&nbsp;<span class="op" id="6616227">:=</span>&nbsp;<span class="ident" id="6616230">c</span><span class="op" id="6616231">.</span><span class="ident" id="6616232">Extension</span><span class="op" id="6616241">(</span><span class="string" id="6616242">&#34;aUtH&#34;</span><span class="op" id="6616248">)</span><span class="op" id="6616249">;</span>&nbsp;<span class="op" id="6616251">!</span><span class="ident" id="6616252">ok</span>&nbsp;<span class="op" id="6616255">||</span>&nbsp;<span class="ident" id="6616258">args</span>&nbsp;<span class="op" id="6616263">!=</span>&nbsp;<span class="string" id="6616266">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="6616280">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6616284">t</span><span class="op" id="6616285">.</span><span class="ident" id="6616286">Fatalf</span><span class="op" id="6616292">(</span><span class="string" id="6616293">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="6616318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6616321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616324">if</span>&nbsp;<span class="ident" id="6616327">ok</span><span class="op" id="6616329">,</span>&nbsp;<span class="ident" id="6616331">_</span>&nbsp;<span class="op" id="6616333">:=</span>&nbsp;<span class="ident" id="6616336">c</span><span class="op" id="6616337">.</span><span class="ident" id="6616338">Extension</span><span class="op" id="6616347">(</span><span class="string" id="6616348">&#34;DSN&#34;</span><span class="op" id="6616353">)</span><span class="op" id="6616354">;</span>&nbsp;<span class="ident" id="6616356">ok</span>&nbsp;<span class="op" id="6616359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6616363">t</span><span class="op" id="6616364">.</span><span class="ident" id="6616365">Fatalf</span><span class="op" id="6616371">(</span><span class="string" id="6616372">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="6616395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6616398">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616402">if</span>&nbsp;<span class="ident" id="6616405">err</span>&nbsp;<span class="op" id="6616409">:=</span>&nbsp;<span class="ident" id="6616412">c</span><span class="op" id="6616413">.</span><span class="ident" id="6616414">Mail</span><span class="op" id="6616418">(</span><span class="string" id="6616419">&#34;user@gmail.com&#34;</span><span class="op" id="6616435">)</span><span class="op" id="6616436">;</span>&nbsp;<span class="ident" id="6616438">err</span>&nbsp;<span class="op" id="6616442">==</span>&nbsp;<span class="ident" id="6616445">nil</span>&nbsp;<span class="op" id="6616449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6616453">t</span><span class="op" id="6616454">.</span><span class="ident" id="6616455">Fatalf</span><span class="op" id="6616461">(</span><span class="string" id="6616462">&#34;MAIL&nbsp;should&nbsp;require&nbsp;authentication&#34;</span><span class="op" id="6616498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6616501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616505">if</span>&nbsp;<span class="ident" id="6616508">err</span>&nbsp;<span class="op" id="6616512">:=</span>&nbsp;<span class="ident" id="6616515">c</span><span class="op" id="6616516">.</span><span class="ident" id="6616517">Verify</span><span class="op" id="6616523">(</span><span class="string" id="6616524">&#34;user1@gmail.com&#34;</span><span class="op" id="6616541">)</span><span class="op" id="6616542">;</span>&nbsp;<span class="ident" id="6616544">err</span>&nbsp;<span class="op" id="6616548">==</span>&nbsp;<span class="ident" id="6616551">nil</span>&nbsp;<span class="op" id="6616555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6616559">t</span><span class="op" id="6616560">.</span><span class="ident" id="6616561">Fatalf</span><span class="op" id="6616567">(</span><span class="string" id="6616568">&#34;First&nbsp;VRFY:&nbsp;expected&nbsp;no&nbsp;verification&#34;</span><span class="op" id="6616606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6616609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616612">if</span>&nbsp;<span class="ident" id="6616615">err</span>&nbsp;<span class="op" id="6616619">:=</span>&nbsp;<span class="ident" id="6616622">c</span><span class="op" id="6616623">.</span><span class="ident" id="6616624">Verify</span><span class="op" id="6616630">(</span><span class="string" id="6616631">&#34;user2@gmail.com&#34;</span><span class="op" id="6616648">)</span><span class="op" id="6616649">;</span>&nbsp;<span class="ident" id="6616651">err</span>&nbsp;<span class="op" id="6616655">!=</span>&nbsp;<span class="ident" id="6616658">nil</span>&nbsp;<span class="op" id="6616662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6616666">t</span><span class="op" id="6616667">.</span><span class="ident" id="6616668">Fatalf</span><span class="op" id="6616674">(</span><span class="string" id="6616675">&#34;Second&nbsp;VRFY:&nbsp;expected&nbsp;verification,&nbsp;got&nbsp;%s&#34;</span><span class="op" id="6616719">,</span>&nbsp;<span class="ident" id="6616721">err</span><span class="op" id="6616724">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6616727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6616731">//&nbsp;fake&nbsp;TLS&nbsp;so&nbsp;authentication&nbsp;won&#39;t&nbsp;complain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6616777">c</span><span class="op" id="6616778">.</span><span class="ident" id="6616779">tls</span>&nbsp;<span class="op" id="6616783">=</span>&nbsp;<span class="builtintype" id="6616785">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6616791">c</span><span class="op" id="6616792">.</span><span class="ident" id="6616793">serverName</span>&nbsp;<span class="op" id="6616804">=</span>&nbsp;<span class="string" id="6616806">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616825">if</span>&nbsp;<span class="ident" id="6616828">err</span>&nbsp;<span class="op" id="6616832">:=</span>&nbsp;<span class="ident" id="6616835">c</span><span class="op" id="6616836">.</span><span class="ident" id="6616837">Auth</span><span class="op" id="6616841">(</span><span class="ident" id="6616842">PlainAuth</span><span class="op" id="6616851">(</span><span class="string" id="6616852">&#34;&#34;</span><span class="op" id="6616854">,</span>&nbsp;<span class="string" id="6616856">&#34;user&#34;</span><span class="op" id="6616862">,</span>&nbsp;<span class="string" id="6616864">&#34;pass&#34;</span><span class="op" id="6616870">,</span>&nbsp;<span class="string" id="6616872">&#34;smtp.google.com&#34;</span><span class="op" id="6616889">)</span><span class="op" id="6616890">)</span><span class="op" id="6616891">;</span>&nbsp;<span class="ident" id="6616893">err</span>&nbsp;<span class="op" id="6616897">!=</span>&nbsp;<span class="ident" id="6616900">nil</span>&nbsp;<span class="op" id="6616904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6616908">t</span><span class="op" id="6616909">.</span><span class="ident" id="6616910">Fatalf</span><span class="op" id="6616916">(</span><span class="string" id="6616917">&#34;AUTH&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6616934">,</span>&nbsp;<span class="ident" id="6616936">err</span><span class="op" id="6616939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6616942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616946">if</span>&nbsp;<span class="ident" id="6616949">err</span>&nbsp;<span class="op" id="6616953">:=</span>&nbsp;<span class="ident" id="6616956">c</span><span class="op" id="6616957">.</span><span class="ident" id="6616958">Mail</span><span class="op" id="6616962">(</span><span class="string" id="6616963">&#34;user@gmail.com&#34;</span><span class="op" id="6616979">)</span><span class="op" id="6616980">;</span>&nbsp;<span class="ident" id="6616982">err</span>&nbsp;<span class="op" id="6616986">!=</span>&nbsp;<span class="ident" id="6616989">nil</span>&nbsp;<span class="op" id="6616993">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6616997">t</span><span class="op" id="6616998">.</span><span class="ident" id="6616999">Fatalf</span><span class="op" id="6617005">(</span><span class="string" id="6617006">&#34;MAIL&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6617023">,</span>&nbsp;<span class="ident" id="6617025">err</span><span class="op" id="6617028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6617031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617034">if</span>&nbsp;<span class="ident" id="6617037">err</span>&nbsp;<span class="op" id="6617041">:=</span>&nbsp;<span class="ident" id="6617044">c</span><span class="op" id="6617045">.</span><span class="ident" id="6617046">Rcpt</span><span class="op" id="6617050">(</span><span class="string" id="6617051">&#34;golang-nuts@googlegroups.com&#34;</span><span class="op" id="6617081">)</span><span class="op" id="6617082">;</span>&nbsp;<span class="ident" id="6617084">err</span>&nbsp;<span class="op" id="6617088">!=</span>&nbsp;<span class="ident" id="6617091">nil</span>&nbsp;<span class="op" id="6617095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617099">t</span><span class="op" id="6617100">.</span><span class="ident" id="6617101">Fatalf</span><span class="op" id="6617107">(</span><span class="string" id="6617108">&#34;RCPT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6617125">,</span>&nbsp;<span class="ident" id="6617127">err</span><span class="op" id="6617130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6617133">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617136">msg</span>&nbsp;<span class="op" id="6617140">:=</span>&nbsp;<span class="string" id="6617143">`From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno"></span>Line&nbsp;1<br>
<span class="lineno">165</span>.Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617260">w</span><span class="op" id="6617261">,</span>&nbsp;<span class="ident" id="6617263">err</span>&nbsp;<span class="op" id="6617267">:=</span>&nbsp;<span class="ident" id="6617270">c</span><span class="op" id="6617271">.</span><span class="ident" id="6617272">Data</span><span class="op" id="6617276">(</span><span class="op" id="6617277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617280">if</span>&nbsp;<span class="ident" id="6617283">err</span>&nbsp;<span class="op" id="6617287">!=</span>&nbsp;<span class="ident" id="6617290">nil</span>&nbsp;<span class="op" id="6617294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617298">t</span><span class="op" id="6617299">.</span><span class="ident" id="6617300">Fatalf</span><span class="op" id="6617306">(</span><span class="string" id="6617307">&#34;DATA&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6617324">,</span>&nbsp;<span class="ident" id="6617326">err</span><span class="op" id="6617329">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6617332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617335">if</span>&nbsp;<span class="ident" id="6617338">_</span><span class="op" id="6617339">,</span>&nbsp;<span class="ident" id="6617341">err</span>&nbsp;<span class="op" id="6617345">:=</span>&nbsp;<span class="ident" id="6617348">w</span><span class="op" id="6617349">.</span><span class="ident" id="6617350">Write</span><span class="op" id="6617355">(</span><span class="op" id="6617356">[</span><span class="op" id="6617357">]</span><span class="builtintype" id="6617358">byte</span><span class="op" id="6617362">(</span><span class="ident" id="6617363">msg</span><span class="op" id="6617366">)</span><span class="op" id="6617367">)</span><span class="op" id="6617368">;</span>&nbsp;<span class="ident" id="6617370">err</span>&nbsp;<span class="op" id="6617374">!=</span>&nbsp;<span class="ident" id="6617377">nil</span>&nbsp;<span class="op" id="6617381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617385">t</span><span class="op" id="6617386">.</span><span class="ident" id="6617387">Fatalf</span><span class="op" id="6617393">(</span><span class="string" id="6617394">&#34;Data&nbsp;write&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6617417">,</span>&nbsp;<span class="ident" id="6617419">err</span><span class="op" id="6617422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6617425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617428">if</span>&nbsp;<span class="ident" id="6617431">err</span>&nbsp;<span class="op" id="6617435">:=</span>&nbsp;<span class="ident" id="6617438">w</span><span class="op" id="6617439">.</span><span class="ident" id="6617440">Close</span><span class="op" id="6617445">(</span><span class="op" id="6617446">)</span><span class="op" id="6617447">;</span>&nbsp;<span class="ident" id="6617449">err</span>&nbsp;<span class="op" id="6617453">!=</span>&nbsp;<span class="ident" id="6617456">nil</span>&nbsp;<span class="op" id="6617460">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617464">t</span><span class="op" id="6617465">.</span><span class="ident" id="6617466">Fatalf</span><span class="op" id="6617472">(</span><span class="string" id="6617473">&#34;Bad&nbsp;data&nbsp;response:&nbsp;%s&#34;</span><span class="op" id="6617496">,</span>&nbsp;<span class="ident" id="6617498">err</span><span class="op" id="6617501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6617504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617508">if</span>&nbsp;<span class="ident" id="6617511">err</span>&nbsp;<span class="op" id="6617515">:=</span>&nbsp;<span class="ident" id="6617518">c</span><span class="op" id="6617519">.</span><span class="ident" id="6617520">Quit</span><span class="op" id="6617524">(</span><span class="op" id="6617525">)</span><span class="op" id="6617526">;</span>&nbsp;<span class="ident" id="6617528">err</span>&nbsp;<span class="op" id="6617532">!=</span>&nbsp;<span class="ident" id="6617535">nil</span>&nbsp;<span class="op" id="6617539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617543">t</span><span class="op" id="6617544">.</span><span class="ident" id="6617545">Fatalf</span><span class="op" id="6617551">(</span><span class="string" id="6617552">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6617569">,</span>&nbsp;<span class="ident" id="6617571">err</span><span class="op" id="6617574">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6617577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617581">bcmdbuf</span><span class="op" id="6617588">.</span><span class="ident" id="6617589">Flush</span><span class="op" id="6617594">(</span><span class="op" id="6617595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617598">actualcmds</span>&nbsp;<span class="op" id="6617609">:=</span>&nbsp;<span class="ident" id="6617612">cmdbuf</span><span class="op" id="6617618">.</span><span class="ident" id="6617619">String</span><span class="op" id="6617625">(</span><span class="op" id="6617626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617629">if</span>&nbsp;<span class="ident" id="6617632">client</span>&nbsp;<span class="op" id="6617639">!=</span>&nbsp;<span class="ident" id="6617642">actualcmds</span>&nbsp;<span class="op" id="6617653">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617657">t</span><span class="op" id="6617658">.</span><span class="ident" id="6617659">Fatalf</span><span class="op" id="6617665">(</span><span class="string" id="6617666">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6617691">,</span>&nbsp;<span class="ident" id="6617693">actualcmds</span><span class="op" id="6617703">,</span>&nbsp;<span class="ident" id="6617705">client</span><span class="op" id="6617711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6617714">}</span><br>
<span class="lineno"></span><span class="op" id="6617716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6617719">var</span>&nbsp;<span class="ident" id="6617723">basicServer</span>&nbsp;<span class="op" id="6617735">=</span>&nbsp;<span class="string" id="6617737">`250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno">190</span>502&nbsp;Unrecognized&nbsp;command.<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">195</span>530&nbsp;Authentication&nbsp;required<br>
<span class="lineno"></span>252&nbsp;Send&nbsp;some&nbsp;mail,&nbsp;I&#39;ll&nbsp;try&nbsp;my&nbsp;best<br>
<span class="lineno"></span>250&nbsp;User&nbsp;is&nbsp;valid<br>
<span class="lineno"></span>235&nbsp;Accepted<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;OK<br>
<span class="lineno">200</span>250&nbsp;Receiver&nbsp;OK<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;OK<br>
<span class="lineno"></span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="6618045">var</span>&nbsp;<span class="ident" id="6618049">basicClient</span>&nbsp;<span class="op" id="6618061">=</span>&nbsp;<span class="string" id="6618063">`HELO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno">210</span>VRFY&nbsp;user1@gmail.com<br>
<span class="lineno"></span>VRFY&nbsp;user2@gmail.com<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;golang-nuts@googlegroups.com&gt;<br>
<span class="lineno">215</span>DATA<br>
<span class="lineno"></span>From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno">220</span>Line&nbsp;1<br>
<span class="lineno"></span>..Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">225</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6618430">func</span>&nbsp;<span class="ident" id="6618435">TestNewClient</span><span class="op" id="6618448">(</span><span class="ident" id="6618449">t</span>&nbsp;<span class="op" id="6618451">*</span><span class="ident" id="6618452">testing</span><span class="op" id="6618459">.</span><span class="ident" id="6618460">T</span><span class="op" id="6618461">)</span>&nbsp;<span class="op" id="6618463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618466">server</span>&nbsp;<span class="op" id="6618473">:=</span>&nbsp;<span class="ident" id="6618476">strings</span><span class="op" id="6618483">.</span><span class="ident" id="6618484">Join</span><span class="op" id="6618488">(</span><span class="ident" id="6618489">strings</span><span class="op" id="6618496">.</span><span class="ident" id="6618497">Split</span><span class="op" id="6618502">(</span><span class="ident" id="6618503">newClientServer</span><span class="op" id="6618518">,</span>&nbsp;<span class="string" id="6618520">&#34;\n&#34;</span><span class="op" id="6618524">)</span><span class="op" id="6618525">,</span>&nbsp;<span class="string" id="6618527">&#34;\r\n&#34;</span><span class="op" id="6618533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618536">client</span>&nbsp;<span class="op" id="6618543">:=</span>&nbsp;<span class="ident" id="6618546">strings</span><span class="op" id="6618553">.</span><span class="ident" id="6618554">Join</span><span class="op" id="6618558">(</span><span class="ident" id="6618559">strings</span><span class="op" id="6618566">.</span><span class="ident" id="6618567">Split</span><span class="op" id="6618572">(</span><span class="ident" id="6618573">newClientClient</span><span class="op" id="6618588">,</span>&nbsp;<span class="string" id="6618590">&#34;\n&#34;</span><span class="op" id="6618594">)</span><span class="op" id="6618595">,</span>&nbsp;<span class="string" id="6618597">&#34;\r\n&#34;</span><span class="op" id="6618603">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6618607">var</span>&nbsp;<span class="ident" id="6618611">cmdbuf</span>&nbsp;<span class="ident" id="6618618">bytes</span><span class="op" id="6618623">.</span><span class="ident" id="6618624">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618632">bcmdbuf</span>&nbsp;<span class="op" id="6618640">:=</span>&nbsp;<span class="ident" id="6618643">bufio</span><span class="op" id="6618648">.</span><span class="ident" id="6618649">NewWriter</span><span class="op" id="6618658">(</span><span class="op" id="6618659">&amp;</span><span class="ident" id="6618660">cmdbuf</span><span class="op" id="6618666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618669">out</span>&nbsp;<span class="op" id="6618673">:=</span>&nbsp;<span class="keyword" id="6618676">func</span><span class="op" id="6618680">(</span><span class="op" id="6618681">)</span>&nbsp;<span class="builtintype" id="6618683">string</span>&nbsp;<span class="op" id="6618690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618694">bcmdbuf</span><span class="op" id="6618701">.</span><span class="ident" id="6618702">Flush</span><span class="op" id="6618707">(</span><span class="op" id="6618708">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6618712">return</span>&nbsp;<span class="ident" id="6618719">cmdbuf</span><span class="op" id="6618725">.</span><span class="ident" id="6618726">String</span><span class="op" id="6618732">(</span><span class="op" id="6618733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6618736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6618739">var</span>&nbsp;<span class="ident" id="6618743">fake</span>&nbsp;<span class="ident" id="6618748">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618755">fake</span><span class="op" id="6618759">.</span><span class="ident" id="6618760">ReadWriter</span>&nbsp;<span class="op" id="6618771">=</span>&nbsp;<span class="ident" id="6618773">bufio</span><span class="op" id="6618778">.</span><span class="ident" id="6618779">NewReadWriter</span><span class="op" id="6618792">(</span><span class="ident" id="6618793">bufio</span><span class="op" id="6618798">.</span><span class="ident" id="6618799">NewReader</span><span class="op" id="6618808">(</span><span class="ident" id="6618809">strings</span><span class="op" id="6618816">.</span><span class="ident" id="6618817">NewReader</span><span class="op" id="6618826">(</span><span class="ident" id="6618827">server</span><span class="op" id="6618833">)</span><span class="op" id="6618834">)</span><span class="op" id="6618835">,</span>&nbsp;<span class="ident" id="6618837">bcmdbuf</span><span class="op" id="6618844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618847">c</span><span class="op" id="6618848">,</span>&nbsp;<span class="ident" id="6618850">err</span>&nbsp;<span class="op" id="6618854">:=</span>&nbsp;<span class="ident" id="6618857">NewClient</span><span class="op" id="6618866">(</span><span class="ident" id="6618867">fake</span><span class="op" id="6618871">,</span>&nbsp;<span class="string" id="6618873">&#34;fake.host&#34;</span><span class="op" id="6618884">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6618887">if</span>&nbsp;<span class="ident" id="6618890">err</span>&nbsp;<span class="op" id="6618894">!=</span>&nbsp;<span class="ident" id="6618897">nil</span>&nbsp;<span class="op" id="6618901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618905">t</span><span class="op" id="6618906">.</span><span class="ident" id="6618907">Fatalf</span><span class="op" id="6618913">(</span><span class="string" id="6618914">&#34;NewClient:&nbsp;%v\n(after&nbsp;%v)&#34;</span><span class="op" id="6618941">,</span>&nbsp;<span class="ident" id="6618943">err</span><span class="op" id="6618946">,</span>&nbsp;<span class="ident" id="6618948">out</span><span class="op" id="6618951">(</span><span class="op" id="6618952">)</span><span class="op" id="6618953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6618956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6618959">defer</span>&nbsp;<span class="ident" id="6618965">c</span><span class="op" id="6618966">.</span><span class="ident" id="6618967">Close</span><span class="op" id="6618972">(</span><span class="op" id="6618973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6618976">if</span>&nbsp;<span class="ident" id="6618979">ok</span><span class="op" id="6618981">,</span>&nbsp;<span class="ident" id="6618983">args</span>&nbsp;<span class="op" id="6618988">:=</span>&nbsp;<span class="ident" id="6618991">c</span><span class="op" id="6618992">.</span><span class="ident" id="6618993">Extension</span><span class="op" id="6619002">(</span><span class="string" id="6619003">&#34;aUtH&#34;</span><span class="op" id="6619009">)</span><span class="op" id="6619010">;</span>&nbsp;<span class="op" id="6619012">!</span><span class="ident" id="6619013">ok</span>&nbsp;<span class="op" id="6619016">||</span>&nbsp;<span class="ident" id="6619019">args</span>&nbsp;<span class="op" id="6619024">!=</span>&nbsp;<span class="string" id="6619027">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="6619041">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619045">t</span><span class="op" id="6619046">.</span><span class="ident" id="6619047">Fatalf</span><span class="op" id="6619053">(</span><span class="string" id="6619054">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="6619079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6619082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619085">if</span>&nbsp;<span class="ident" id="6619088">ok</span><span class="op" id="6619090">,</span>&nbsp;<span class="ident" id="6619092">_</span>&nbsp;<span class="op" id="6619094">:=</span>&nbsp;<span class="ident" id="6619097">c</span><span class="op" id="6619098">.</span><span class="ident" id="6619099">Extension</span><span class="op" id="6619108">(</span><span class="string" id="6619109">&#34;DSN&#34;</span><span class="op" id="6619114">)</span><span class="op" id="6619115">;</span>&nbsp;<span class="ident" id="6619117">ok</span>&nbsp;<span class="op" id="6619120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619124">t</span><span class="op" id="6619125">.</span><span class="ident" id="6619126">Fatalf</span><span class="op" id="6619132">(</span><span class="string" id="6619133">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="6619156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6619159">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619162">if</span>&nbsp;<span class="ident" id="6619165">err</span>&nbsp;<span class="op" id="6619169">:=</span>&nbsp;<span class="ident" id="6619172">c</span><span class="op" id="6619173">.</span><span class="ident" id="6619174">Quit</span><span class="op" id="6619178">(</span><span class="op" id="6619179">)</span><span class="op" id="6619180">;</span>&nbsp;<span class="ident" id="6619182">err</span>&nbsp;<span class="op" id="6619186">!=</span>&nbsp;<span class="ident" id="6619189">nil</span>&nbsp;<span class="op" id="6619193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619197">t</span><span class="op" id="6619198">.</span><span class="ident" id="6619199">Fatalf</span><span class="op" id="6619205">(</span><span class="string" id="6619206">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6619223">,</span>&nbsp;<span class="ident" id="6619225">err</span><span class="op" id="6619228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6619231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619235">actualcmds</span>&nbsp;<span class="op" id="6619246">:=</span>&nbsp;<span class="ident" id="6619249">out</span><span class="op" id="6619252">(</span><span class="op" id="6619253">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619256">if</span>&nbsp;<span class="ident" id="6619259">client</span>&nbsp;<span class="op" id="6619266">!=</span>&nbsp;<span class="ident" id="6619269">actualcmds</span>&nbsp;<span class="op" id="6619280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619284">t</span><span class="op" id="6619285">.</span><span class="ident" id="6619286">Fatalf</span><span class="op" id="6619292">(</span><span class="string" id="6619293">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6619318">,</span>&nbsp;<span class="ident" id="6619320">actualcmds</span><span class="op" id="6619330">,</span>&nbsp;<span class="ident" id="6619332">client</span><span class="op" id="6619338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6619341">}</span><br>
<span class="lineno"></span><span class="op" id="6619343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword" id="6619346">var</span>&nbsp;<span class="ident" id="6619350">newClientServer</span>&nbsp;<span class="op" id="6619366">=</span>&nbsp;<span class="string" id="6619368">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">265</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6619481">var</span>&nbsp;<span class="ident" id="6619485">newClientClient</span>&nbsp;<span class="op" id="6619501">=</span>&nbsp;<span class="string" id="6619503">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">270</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6619527">func</span>&nbsp;<span class="ident" id="6619532">TestNewClient2</span><span class="op" id="6619546">(</span><span class="ident" id="6619547">t</span>&nbsp;<span class="op" id="6619549">*</span><span class="ident" id="6619550">testing</span><span class="op" id="6619557">.</span><span class="ident" id="6619558">T</span><span class="op" id="6619559">)</span>&nbsp;<span class="op" id="6619561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619564">server</span>&nbsp;<span class="op" id="6619571">:=</span>&nbsp;<span class="ident" id="6619574">strings</span><span class="op" id="6619581">.</span><span class="ident" id="6619582">Join</span><span class="op" id="6619586">(</span><span class="ident" id="6619587">strings</span><span class="op" id="6619594">.</span><span class="ident" id="6619595">Split</span><span class="op" id="6619600">(</span><span class="ident" id="6619601">newClient2Server</span><span class="op" id="6619617">,</span>&nbsp;<span class="string" id="6619619">&#34;\n&#34;</span><span class="op" id="6619623">)</span><span class="op" id="6619624">,</span>&nbsp;<span class="string" id="6619626">&#34;\r\n&#34;</span><span class="op" id="6619632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619635">client</span>&nbsp;<span class="op" id="6619642">:=</span>&nbsp;<span class="ident" id="6619645">strings</span><span class="op" id="6619652">.</span><span class="ident" id="6619653">Join</span><span class="op" id="6619657">(</span><span class="ident" id="6619658">strings</span><span class="op" id="6619665">.</span><span class="ident" id="6619666">Split</span><span class="op" id="6619671">(</span><span class="ident" id="6619672">newClient2Client</span><span class="op" id="6619688">,</span>&nbsp;<span class="string" id="6619690">&#34;\n&#34;</span><span class="op" id="6619694">)</span><span class="op" id="6619695">,</span>&nbsp;<span class="string" id="6619697">&#34;\r\n&#34;</span><span class="op" id="6619703">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619707">var</span>&nbsp;<span class="ident" id="6619711">cmdbuf</span>&nbsp;<span class="ident" id="6619718">bytes</span><span class="op" id="6619723">.</span><span class="ident" id="6619724">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619732">bcmdbuf</span>&nbsp;<span class="op" id="6619740">:=</span>&nbsp;<span class="ident" id="6619743">bufio</span><span class="op" id="6619748">.</span><span class="ident" id="6619749">NewWriter</span><span class="op" id="6619758">(</span><span class="op" id="6619759">&amp;</span><span class="ident" id="6619760">cmdbuf</span><span class="op" id="6619766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619769">var</span>&nbsp;<span class="ident" id="6619773">fake</span>&nbsp;<span class="ident" id="6619778">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619785">fake</span><span class="op" id="6619789">.</span><span class="ident" id="6619790">ReadWriter</span>&nbsp;<span class="op" id="6619801">=</span>&nbsp;<span class="ident" id="6619803">bufio</span><span class="op" id="6619808">.</span><span class="ident" id="6619809">NewReadWriter</span><span class="op" id="6619822">(</span><span class="ident" id="6619823">bufio</span><span class="op" id="6619828">.</span><span class="ident" id="6619829">NewReader</span><span class="op" id="6619838">(</span><span class="ident" id="6619839">strings</span><span class="op" id="6619846">.</span><span class="ident" id="6619847">NewReader</span><span class="op" id="6619856">(</span><span class="ident" id="6619857">server</span><span class="op" id="6619863">)</span><span class="op" id="6619864">)</span><span class="op" id="6619865">,</span>&nbsp;<span class="ident" id="6619867">bcmdbuf</span><span class="op" id="6619874">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619877">c</span><span class="op" id="6619878">,</span>&nbsp;<span class="ident" id="6619880">err</span>&nbsp;<span class="op" id="6619884">:=</span>&nbsp;<span class="ident" id="6619887">NewClient</span><span class="op" id="6619896">(</span><span class="ident" id="6619897">fake</span><span class="op" id="6619901">,</span>&nbsp;<span class="string" id="6619903">&#34;fake.host&#34;</span><span class="op" id="6619914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619917">if</span>&nbsp;<span class="ident" id="6619920">err</span>&nbsp;<span class="op" id="6619924">!=</span>&nbsp;<span class="ident" id="6619927">nil</span>&nbsp;<span class="op" id="6619931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619935">t</span><span class="op" id="6619936">.</span><span class="ident" id="6619937">Fatalf</span><span class="op" id="6619943">(</span><span class="string" id="6619944">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="6619959">,</span>&nbsp;<span class="ident" id="6619961">err</span><span class="op" id="6619964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6619967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619970">defer</span>&nbsp;<span class="ident" id="6619976">c</span><span class="op" id="6619977">.</span><span class="ident" id="6619978">Close</span><span class="op" id="6619983">(</span><span class="op" id="6619984">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619987">if</span>&nbsp;<span class="ident" id="6619990">ok</span><span class="op" id="6619992">,</span>&nbsp;<span class="ident" id="6619994">_</span>&nbsp;<span class="op" id="6619996">:=</span>&nbsp;<span class="ident" id="6619999">c</span><span class="op" id="6620000">.</span><span class="ident" id="6620001">Extension</span><span class="op" id="6620010">(</span><span class="string" id="6620011">&#34;DSN&#34;</span><span class="op" id="6620016">)</span><span class="op" id="6620017">;</span>&nbsp;<span class="ident" id="6620019">ok</span>&nbsp;<span class="op" id="6620022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620026">t</span><span class="op" id="6620027">.</span><span class="ident" id="6620028">Fatalf</span><span class="op" id="6620034">(</span><span class="string" id="6620035">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="6620058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6620061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620064">if</span>&nbsp;<span class="ident" id="6620067">err</span>&nbsp;<span class="op" id="6620071">:=</span>&nbsp;<span class="ident" id="6620074">c</span><span class="op" id="6620075">.</span><span class="ident" id="6620076">Quit</span><span class="op" id="6620080">(</span><span class="op" id="6620081">)</span><span class="op" id="6620082">;</span>&nbsp;<span class="ident" id="6620084">err</span>&nbsp;<span class="op" id="6620088">!=</span>&nbsp;<span class="ident" id="6620091">nil</span>&nbsp;<span class="op" id="6620095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620099">t</span><span class="op" id="6620100">.</span><span class="ident" id="6620101">Fatalf</span><span class="op" id="6620107">(</span><span class="string" id="6620108">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6620125">,</span>&nbsp;<span class="ident" id="6620127">err</span><span class="op" id="6620130">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6620133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620137">bcmdbuf</span><span class="op" id="6620144">.</span><span class="ident" id="6620145">Flush</span><span class="op" id="6620150">(</span><span class="op" id="6620151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620154">actualcmds</span>&nbsp;<span class="op" id="6620165">:=</span>&nbsp;<span class="ident" id="6620168">cmdbuf</span><span class="op" id="6620174">.</span><span class="ident" id="6620175">String</span><span class="op" id="6620181">(</span><span class="op" id="6620182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620185">if</span>&nbsp;<span class="ident" id="6620188">client</span>&nbsp;<span class="op" id="6620195">!=</span>&nbsp;<span class="ident" id="6620198">actualcmds</span>&nbsp;<span class="op" id="6620209">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620213">t</span><span class="op" id="6620214">.</span><span class="ident" id="6620215">Fatalf</span><span class="op" id="6620221">(</span><span class="string" id="6620222">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6620247">,</span>&nbsp;<span class="ident" id="6620249">actualcmds</span><span class="op" id="6620259">,</span>&nbsp;<span class="ident" id="6620261">client</span><span class="op" id="6620267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6620270">}</span><br>
<span class="lineno"></span><span class="op" id="6620272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6620275">var</span>&nbsp;<span class="ident" id="6620279">newClient2Server</span>&nbsp;<span class="op" id="6620296">=</span>&nbsp;<span class="string" id="6620298">`220&nbsp;hello&nbsp;world<br>
<span class="lineno">300</span>502&nbsp;EH?<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">305</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6620419">var</span>&nbsp;<span class="ident" id="6620423">newClient2Client</span>&nbsp;<span class="op" id="6620440">=</span>&nbsp;<span class="string" id="6620442">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno">310</span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6620481">func</span>&nbsp;<span class="ident" id="6620486">TestHello</span><span class="op" id="6620495">(</span><span class="ident" id="6620496">t</span>&nbsp;<span class="op" id="6620498">*</span><span class="ident" id="6620499">testing</span><span class="op" id="6620506">.</span><span class="ident" id="6620507">T</span><span class="op" id="6620508">)</span>&nbsp;<span class="op" id="6620510">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620514">if</span>&nbsp;<span class="builtinfunc" id="6620517">len</span><span class="op" id="6620520">(</span><span class="ident" id="6620521">helloServer</span><span class="op" id="6620532">)</span>&nbsp;<span class="op" id="6620534">!=</span>&nbsp;<span class="builtinfunc" id="6620537">len</span><span class="op" id="6620540">(</span><span class="ident" id="6620541">helloClient</span><span class="op" id="6620552">)</span>&nbsp;<span class="op" id="6620554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620558">t</span><span class="op" id="6620559">.</span><span class="ident" id="6620560">Fatalf</span><span class="op" id="6620566">(</span><span class="string" id="6620567">&#34;Hello&nbsp;server&nbsp;and&nbsp;client&nbsp;size&nbsp;mismatch&#34;</span><span class="op" id="6620606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6620609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620613">for</span>&nbsp;<span class="ident" id="6620617">i</span>&nbsp;<span class="op" id="6620619">:=</span>&nbsp;<span class="num" id="6620622">0</span><span class="op" id="6620623">;</span>&nbsp;<span class="ident" id="6620625">i</span>&nbsp;<span class="op" id="6620627">&lt;</span>&nbsp;<span class="builtinfunc" id="6620629">len</span><span class="op" id="6620632">(</span><span class="ident" id="6620633">helloServer</span><span class="op" id="6620644">)</span><span class="op" id="6620645">;</span>&nbsp;<span class="ident" id="6620647">i</span><span class="op" id="6620648">++</span>&nbsp;<span class="op" id="6620651">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620655">server</span>&nbsp;<span class="op" id="6620662">:=</span>&nbsp;<span class="ident" id="6620665">strings</span><span class="op" id="6620672">.</span><span class="ident" id="6620673">Join</span><span class="op" id="6620677">(</span><span class="ident" id="6620678">strings</span><span class="op" id="6620685">.</span><span class="ident" id="6620686">Split</span><span class="op" id="6620691">(</span><span class="ident" id="6620692">baseHelloServer</span><span class="op" id="6620707">+</span><span class="ident" id="6620708">helloServer</span><span class="op" id="6620719">[</span><span class="ident" id="6620720">i</span><span class="op" id="6620721">]</span><span class="op" id="6620722">,</span>&nbsp;<span class="string" id="6620724">&#34;\n&#34;</span><span class="op" id="6620728">)</span><span class="op" id="6620729">,</span>&nbsp;<span class="string" id="6620731">&#34;\r\n&#34;</span><span class="op" id="6620737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620741">client</span>&nbsp;<span class="op" id="6620748">:=</span>&nbsp;<span class="ident" id="6620751">strings</span><span class="op" id="6620758">.</span><span class="ident" id="6620759">Join</span><span class="op" id="6620763">(</span><span class="ident" id="6620764">strings</span><span class="op" id="6620771">.</span><span class="ident" id="6620772">Split</span><span class="op" id="6620777">(</span><span class="ident" id="6620778">baseHelloClient</span><span class="op" id="6620793">+</span><span class="ident" id="6620794">helloClient</span><span class="op" id="6620805">[</span><span class="ident" id="6620806">i</span><span class="op" id="6620807">]</span><span class="op" id="6620808">,</span>&nbsp;<span class="string" id="6620810">&#34;\n&#34;</span><span class="op" id="6620814">)</span><span class="op" id="6620815">,</span>&nbsp;<span class="string" id="6620817">&#34;\r\n&#34;</span><span class="op" id="6620823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620827">var</span>&nbsp;<span class="ident" id="6620831">cmdbuf</span>&nbsp;<span class="ident" id="6620838">bytes</span><span class="op" id="6620843">.</span><span class="ident" id="6620844">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620853">bcmdbuf</span>&nbsp;<span class="op" id="6620861">:=</span>&nbsp;<span class="ident" id="6620864">bufio</span><span class="op" id="6620869">.</span><span class="ident" id="6620870">NewWriter</span><span class="op" id="6620879">(</span><span class="op" id="6620880">&amp;</span><span class="ident" id="6620881">cmdbuf</span><span class="op" id="6620887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620891">var</span>&nbsp;<span class="ident" id="6620895">fake</span>&nbsp;<span class="ident" id="6620900">faker</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620908">fake</span><span class="op" id="6620912">.</span><span class="ident" id="6620913">ReadWriter</span>&nbsp;<span class="op" id="6620924">=</span>&nbsp;<span class="ident" id="6620926">bufio</span><span class="op" id="6620931">.</span><span class="ident" id="6620932">NewReadWriter</span><span class="op" id="6620945">(</span><span class="ident" id="6620946">bufio</span><span class="op" id="6620951">.</span><span class="ident" id="6620952">NewReader</span><span class="op" id="6620961">(</span><span class="ident" id="6620962">strings</span><span class="op" id="6620969">.</span><span class="ident" id="6620970">NewReader</span><span class="op" id="6620979">(</span><span class="ident" id="6620980">server</span><span class="op" id="6620986">)</span><span class="op" id="6620987">)</span><span class="op" id="6620988">,</span>&nbsp;<span class="ident" id="6620990">bcmdbuf</span><span class="op" id="6620997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621001">c</span><span class="op" id="6621002">,</span>&nbsp;<span class="ident" id="6621004">err</span>&nbsp;<span class="op" id="6621008">:=</span>&nbsp;<span class="ident" id="6621011">NewClient</span><span class="op" id="6621020">(</span><span class="ident" id="6621021">fake</span><span class="op" id="6621025">,</span>&nbsp;<span class="string" id="6621027">&#34;fake.host&#34;</span><span class="op" id="6621038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621042">if</span>&nbsp;<span class="ident" id="6621045">err</span>&nbsp;<span class="op" id="6621049">!=</span>&nbsp;<span class="ident" id="6621052">nil</span>&nbsp;<span class="op" id="6621056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621061">t</span><span class="op" id="6621062">.</span><span class="ident" id="6621063">Fatalf</span><span class="op" id="6621069">(</span><span class="string" id="6621070">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="6621085">,</span>&nbsp;<span class="ident" id="6621087">err</span><span class="op" id="6621090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621094">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621098">defer</span>&nbsp;<span class="ident" id="6621104">c</span><span class="op" id="6621105">.</span><span class="ident" id="6621106">Close</span><span class="op" id="6621111">(</span><span class="op" id="6621112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621116">c</span><span class="op" id="6621117">.</span><span class="ident" id="6621118">localName</span>&nbsp;<span class="op" id="6621128">=</span>&nbsp;<span class="string" id="6621130">&#34;customhost&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621145">err</span>&nbsp;<span class="op" id="6621149">=</span>&nbsp;<span class="ident" id="6621151">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621158">switch</span>&nbsp;<span class="ident" id="6621165">i</span>&nbsp;<span class="op" id="6621167">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621171">case</span>&nbsp;<span class="num" id="6621176">0</span><span class="op" id="6621177">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621182">err</span>&nbsp;<span class="op" id="6621186">=</span>&nbsp;<span class="ident" id="6621188">c</span><span class="op" id="6621189">.</span><span class="ident" id="6621190">Hello</span><span class="op" id="6621195">(</span><span class="string" id="6621196">&#34;customhost&#34;</span><span class="op" id="6621208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621212">case</span>&nbsp;<span class="num" id="6621217">1</span><span class="op" id="6621218">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621223">err</span>&nbsp;<span class="op" id="6621227">=</span>&nbsp;<span class="ident" id="6621229">c</span><span class="op" id="6621230">.</span><span class="ident" id="6621231">StartTLS</span><span class="op" id="6621239">(</span><span class="ident" id="6621240">nil</span><span class="op" id="6621243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621248">if</span>&nbsp;<span class="ident" id="6621251">err</span><span class="op" id="6621254">.</span><span class="ident" id="6621255">Error</span><span class="op" id="6621260">(</span><span class="op" id="6621261">)</span>&nbsp;<span class="op" id="6621263">==</span>&nbsp;<span class="string" id="6621266">&#34;502&nbsp;Not&nbsp;implemented&#34;</span>&nbsp;<span class="op" id="6621288">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621294">err</span>&nbsp;<span class="op" id="6621298">=</span>&nbsp;<span class="ident" id="6621300">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621311">case</span>&nbsp;<span class="num" id="6621316">2</span><span class="op" id="6621317">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621322">err</span>&nbsp;<span class="op" id="6621326">=</span>&nbsp;<span class="ident" id="6621328">c</span><span class="op" id="6621329">.</span><span class="ident" id="6621330">Verify</span><span class="op" id="6621336">(</span><span class="string" id="6621337">&#34;test@example.com&#34;</span><span class="op" id="6621355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621359">case</span>&nbsp;<span class="num" id="6621364">3</span><span class="op" id="6621365">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621370">c</span><span class="op" id="6621371">.</span><span class="ident" id="6621372">tls</span>&nbsp;<span class="op" id="6621376">=</span>&nbsp;<span class="builtintype" id="6621378">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621386">c</span><span class="op" id="6621387">.</span><span class="ident" id="6621388">serverName</span>&nbsp;<span class="op" id="6621399">=</span>&nbsp;<span class="string" id="6621401">&#34;smtp.google.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621422">err</span>&nbsp;<span class="op" id="6621426">=</span>&nbsp;<span class="ident" id="6621428">c</span><span class="op" id="6621429">.</span><span class="ident" id="6621430">Auth</span><span class="op" id="6621434">(</span><span class="ident" id="6621435">PlainAuth</span><span class="op" id="6621444">(</span><span class="string" id="6621445">&#34;&#34;</span><span class="op" id="6621447">,</span>&nbsp;<span class="string" id="6621449">&#34;user&#34;</span><span class="op" id="6621455">,</span>&nbsp;<span class="string" id="6621457">&#34;pass&#34;</span><span class="op" id="6621463">,</span>&nbsp;<span class="string" id="6621465">&#34;smtp.google.com&#34;</span><span class="op" id="6621482">)</span><span class="op" id="6621483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621487">case</span>&nbsp;<span class="num" id="6621492">4</span><span class="op" id="6621493">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621498">err</span>&nbsp;<span class="op" id="6621502">=</span>&nbsp;<span class="ident" id="6621504">c</span><span class="op" id="6621505">.</span><span class="ident" id="6621506">Mail</span><span class="op" id="6621510">(</span><span class="string" id="6621511">&#34;test@example.com&#34;</span><span class="op" id="6621529">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621533">case</span>&nbsp;<span class="num" id="6621538">5</span><span class="op" id="6621539">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621544">ok</span><span class="op" id="6621546">,</span>&nbsp;<span class="ident" id="6621548">_</span>&nbsp;<span class="op" id="6621550">:=</span>&nbsp;<span class="ident" id="6621553">c</span><span class="op" id="6621554">.</span><span class="ident" id="6621555">Extension</span><span class="op" id="6621564">(</span><span class="string" id="6621565">&#34;feature&#34;</span><span class="op" id="6621574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621579">if</span>&nbsp;<span class="ident" id="6621582">ok</span>&nbsp;<span class="op" id="6621585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621591">t</span><span class="op" id="6621592">.</span><span class="ident" id="6621593">Errorf</span><span class="op" id="6621599">(</span><span class="string" id="6621600">&#34;Expected&nbsp;FEATURE&nbsp;not&nbsp;to&nbsp;be&nbsp;supported&#34;</span><span class="op" id="6621638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621643">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621647">case</span>&nbsp;<span class="num" id="6621652">6</span><span class="op" id="6621653">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621658">err</span>&nbsp;<span class="op" id="6621662">=</span>&nbsp;<span class="ident" id="6621664">c</span><span class="op" id="6621665">.</span><span class="ident" id="6621666">Reset</span><span class="op" id="6621671">(</span><span class="op" id="6621672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621676">case</span>&nbsp;<span class="num" id="6621681">7</span><span class="op" id="6621682">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621687">err</span>&nbsp;<span class="op" id="6621691">=</span>&nbsp;<span class="ident" id="6621693">c</span><span class="op" id="6621694">.</span><span class="ident" id="6621695">Quit</span><span class="op" id="6621699">(</span><span class="op" id="6621700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621704">case</span>&nbsp;<span class="num" id="6621709">8</span><span class="op" id="6621710">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621715">err</span>&nbsp;<span class="op" id="6621719">=</span>&nbsp;<span class="ident" id="6621721">c</span><span class="op" id="6621722">.</span><span class="ident" id="6621723">Verify</span><span class="op" id="6621729">(</span><span class="string" id="6621730">&#34;test@example.com&#34;</span><span class="op" id="6621748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621753">if</span>&nbsp;<span class="ident" id="6621756">err</span>&nbsp;<span class="op" id="6621760">!=</span>&nbsp;<span class="ident" id="6621763">nil</span>&nbsp;<span class="op" id="6621767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621773">err</span>&nbsp;<span class="op" id="6621777">=</span>&nbsp;<span class="ident" id="6621779">c</span><span class="op" id="6621780">.</span><span class="ident" id="6621781">Hello</span><span class="op" id="6621786">(</span><span class="string" id="6621787">&#34;customhost&#34;</span><span class="op" id="6621799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621805">if</span>&nbsp;<span class="ident" id="6621808">err</span>&nbsp;<span class="op" id="6621812">!=</span>&nbsp;<span class="ident" id="6621815">nil</span>&nbsp;<span class="op" id="6621819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621826">t</span><span class="op" id="6621827">.</span><span class="ident" id="6621828">Errorf</span><span class="op" id="6621834">(</span><span class="string" id="6621835">&#34;Want&nbsp;error,&nbsp;got&nbsp;none&#34;</span><span class="op" id="6621857">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621872">default</span><span class="op" id="6621879">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621884">t</span><span class="op" id="6621885">.</span><span class="ident" id="6621886">Fatalf</span><span class="op" id="6621892">(</span><span class="string" id="6621893">&#34;Unhandled&nbsp;command&#34;</span><span class="op" id="6621912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621916">}</span><br>
<span class="lineno">370</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621921">if</span>&nbsp;<span class="ident" id="6621924">err</span>&nbsp;<span class="op" id="6621928">!=</span>&nbsp;<span class="ident" id="6621931">nil</span>&nbsp;<span class="op" id="6621935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621940">t</span><span class="op" id="6621941">.</span><span class="ident" id="6621942">Errorf</span><span class="op" id="6621948">(</span><span class="string" id="6621949">&#34;Command&nbsp;%d&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6621972">,</span>&nbsp;<span class="ident" id="6621974">i</span><span class="op" id="6621975">,</span>&nbsp;<span class="ident" id="6621977">err</span><span class="op" id="6621980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621989">bcmdbuf</span><span class="op" id="6621996">.</span><span class="ident" id="6621997">Flush</span><span class="op" id="6622002">(</span><span class="op" id="6622003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622007">actualcmds</span>&nbsp;<span class="op" id="6622018">:=</span>&nbsp;<span class="ident" id="6622021">cmdbuf</span><span class="op" id="6622027">.</span><span class="ident" id="6622028">String</span><span class="op" id="6622034">(</span><span class="op" id="6622035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6622039">if</span>&nbsp;<span class="ident" id="6622042">client</span>&nbsp;<span class="op" id="6622049">!=</span>&nbsp;<span class="ident" id="6622052">actualcmds</span>&nbsp;<span class="op" id="6622063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622068">t</span><span class="op" id="6622069">.</span><span class="ident" id="6622070">Errorf</span><span class="op" id="6622076">(</span><span class="string" id="6622077">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6622102">,</span>&nbsp;<span class="ident" id="6622104">actualcmds</span><span class="op" id="6622114">,</span>&nbsp;<span class="ident" id="6622116">client</span><span class="op" id="6622122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6622126">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6622129">}</span><br>
<span class="lineno"></span><span class="op" id="6622131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6622134">var</span>&nbsp;<span class="ident" id="6622138">baseHelloServer</span>&nbsp;<span class="op" id="6622154">=</span>&nbsp;<span class="string" id="6622156">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno">385</span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;FEATURE<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6622230">var</span>&nbsp;<span class="ident" id="6622234">helloServer</span>&nbsp;<span class="op" id="6622246">=</span>&nbsp;<span class="op" id="6622248">[</span><span class="op" id="6622249">]</span><span class="builtintype" id="6622250">string</span><span class="op" id="6622256">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622259">&#34;&#34;</span><span class="op" id="6622261">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622264">&#34;502&nbsp;Not&nbsp;implemented\n&#34;</span><span class="op" id="6622287">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622290">&#34;250&nbsp;User&nbsp;is&nbsp;valid\n&#34;</span><span class="op" id="6622311">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622314">&#34;235&nbsp;Accepted\n&#34;</span><span class="op" id="6622330">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622333">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="6622350">,</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622353">&#34;&#34;</span><span class="op" id="6622355">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622358">&#34;250&nbsp;Reset&nbsp;ok\n&#34;</span><span class="op" id="6622374">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622377">&#34;221&nbsp;Goodbye\n&#34;</span><span class="op" id="6622392">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622395">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="6622412">,</span><br>
<span class="lineno"></span><span class="op" id="6622414">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="6622417">var</span>&nbsp;<span class="ident" id="6622421">baseHelloClient</span>&nbsp;<span class="op" id="6622437">=</span>&nbsp;<span class="string" id="6622439">`EHLO&nbsp;customhost<br>
<span class="lineno"></span>HELO&nbsp;customhost<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="6622475">var</span>&nbsp;<span class="ident" id="6622479">helloClient</span>&nbsp;<span class="op" id="6622491">=</span>&nbsp;<span class="op" id="6622493">[</span><span class="op" id="6622494">]</span><span class="builtintype" id="6622495">string</span><span class="op" id="6622501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622504">&#34;&#34;</span><span class="op" id="6622506">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622509">&#34;STARTTLS\n&#34;</span><span class="op" id="6622521">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622524">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="6622549">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622552">&#34;AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==\n&#34;</span><span class="op" id="6622583">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622586">&#34;MAIL&nbsp;FROM:&lt;test@example.com&gt;\n&#34;</span><span class="op" id="6622618">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622621">&#34;&#34;</span><span class="op" id="6622623">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622626">&#34;RSET\n&#34;</span><span class="op" id="6622634">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622637">&#34;QUIT\n&#34;</span><span class="op" id="6622645">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6622648">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="6622673">,</span><br>
<span class="lineno">415</span><span class="op" id="6622675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6622678">func</span>&nbsp;<span class="ident" id="6622683">TestSendMail</span><span class="op" id="6622695">(</span><span class="ident" id="6622696">t</span>&nbsp;<span class="op" id="6622698">*</span><span class="ident" id="6622699">testing</span><span class="op" id="6622706">.</span><span class="ident" id="6622707">T</span><span class="op" id="6622708">)</span>&nbsp;<span class="op" id="6622710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622713">server</span>&nbsp;<span class="op" id="6622720">:=</span>&nbsp;<span class="ident" id="6622723">strings</span><span class="op" id="6622730">.</span><span class="ident" id="6622731">Join</span><span class="op" id="6622735">(</span><span class="ident" id="6622736">strings</span><span class="op" id="6622743">.</span><span class="ident" id="6622744">Split</span><span class="op" id="6622749">(</span><span class="ident" id="6622750">sendMailServer</span><span class="op" id="6622764">,</span>&nbsp;<span class="string" id="6622766">&#34;\n&#34;</span><span class="op" id="6622770">)</span><span class="op" id="6622771">,</span>&nbsp;<span class="string" id="6622773">&#34;\r\n&#34;</span><span class="op" id="6622779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622782">client</span>&nbsp;<span class="op" id="6622789">:=</span>&nbsp;<span class="ident" id="6622792">strings</span><span class="op" id="6622799">.</span><span class="ident" id="6622800">Join</span><span class="op" id="6622804">(</span><span class="ident" id="6622805">strings</span><span class="op" id="6622812">.</span><span class="ident" id="6622813">Split</span><span class="op" id="6622818">(</span><span class="ident" id="6622819">sendMailClient</span><span class="op" id="6622833">,</span>&nbsp;<span class="string" id="6622835">&#34;\n&#34;</span><span class="op" id="6622839">)</span><span class="op" id="6622840">,</span>&nbsp;<span class="string" id="6622842">&#34;\r\n&#34;</span><span class="op" id="6622848">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6622851">var</span>&nbsp;<span class="ident" id="6622855">cmdbuf</span>&nbsp;<span class="ident" id="6622862">bytes</span><span class="op" id="6622867">.</span><span class="ident" id="6622868">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622876">bcmdbuf</span>&nbsp;<span class="op" id="6622884">:=</span>&nbsp;<span class="ident" id="6622887">bufio</span><span class="op" id="6622892">.</span><span class="ident" id="6622893">NewWriter</span><span class="op" id="6622902">(</span><span class="op" id="6622903">&amp;</span><span class="ident" id="6622904">cmdbuf</span><span class="op" id="6622910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622913">l</span><span class="op" id="6622914">,</span>&nbsp;<span class="ident" id="6622916">err</span>&nbsp;<span class="op" id="6622920">:=</span>&nbsp;<span class="ident" id="6622923">net</span><span class="op" id="6622926">.</span><span class="ident" id="6622927">Listen</span><span class="op" id="6622933">(</span><span class="string" id="6622934">&#34;tcp&#34;</span><span class="op" id="6622939">,</span>&nbsp;<span class="string" id="6622941">&#34;127.0.0.1:0&#34;</span><span class="op" id="6622954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6622957">if</span>&nbsp;<span class="ident" id="6622960">err</span>&nbsp;<span class="op" id="6622964">!=</span>&nbsp;<span class="ident" id="6622967">nil</span>&nbsp;<span class="op" id="6622971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622975">t</span><span class="op" id="6622976">.</span><span class="ident" id="6622977">Fatalf</span><span class="op" id="6622983">(</span><span class="string" id="6622984">&#34;Unable&nbsp;to&nbsp;to&nbsp;create&nbsp;listener:&nbsp;%v&#34;</span><span class="op" id="6623018">,</span>&nbsp;<span class="ident" id="6623020">err</span><span class="op" id="6623023">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623029">defer</span>&nbsp;<span class="ident" id="6623035">l</span><span class="op" id="6623036">.</span><span class="ident" id="6623037">Close</span><span class="op" id="6623042">(</span><span class="op" id="6623043">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6623047">//&nbsp;prevent&nbsp;data&nbsp;race&nbsp;on&nbsp;bcmdbuf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623080">var</span>&nbsp;<span class="ident" id="6623084">done</span>&nbsp;<span class="op" id="6623089">=</span>&nbsp;<span class="builtinfunc" id="6623091">make</span><span class="op" id="6623095">(</span><span class="keyword" id="6623096">chan</span>&nbsp;<span class="keyword" id="6623101">struct</span><span class="op" id="6623107">{</span><span class="op" id="6623108">}</span><span class="op" id="6623109">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623112">go</span>&nbsp;<span class="keyword" id="6623115">func</span><span class="op" id="6623119">(</span><span class="ident" id="6623120">data</span>&nbsp;<span class="op" id="6623125">[</span><span class="op" id="6623126">]</span><span class="builtintype" id="6623127">string</span><span class="op" id="6623133">)</span>&nbsp;<span class="op" id="6623135">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623140">defer</span>&nbsp;<span class="builtinfunc" id="6623146">close</span><span class="op" id="6623151">(</span><span class="ident" id="6623152">done</span><span class="op" id="6623156">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623161">conn</span><span class="op" id="6623165">,</span>&nbsp;<span class="ident" id="6623167">err</span>&nbsp;<span class="op" id="6623171">:=</span>&nbsp;<span class="ident" id="6623174">l</span><span class="op" id="6623175">.</span><span class="ident" id="6623176">Accept</span><span class="op" id="6623182">(</span><span class="op" id="6623183">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623187">if</span>&nbsp;<span class="ident" id="6623190">err</span>&nbsp;<span class="op" id="6623194">!=</span>&nbsp;<span class="ident" id="6623197">nil</span>&nbsp;<span class="op" id="6623201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623206">t</span><span class="op" id="6623207">.</span><span class="ident" id="6623208">Errorf</span><span class="op" id="6623214">(</span><span class="string" id="6623215">&#34;Accept&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6623233">,</span>&nbsp;<span class="ident" id="6623235">err</span><span class="op" id="6623238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623243">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623256">defer</span>&nbsp;<span class="ident" id="6623262">conn</span><span class="op" id="6623266">.</span><span class="ident" id="6623267">Close</span><span class="op" id="6623272">(</span><span class="op" id="6623273">)</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623278">tc</span>&nbsp;<span class="op" id="6623281">:=</span>&nbsp;<span class="ident" id="6623284">textproto</span><span class="op" id="6623293">.</span><span class="ident" id="6623294">NewConn</span><span class="op" id="6623301">(</span><span class="ident" id="6623302">conn</span><span class="op" id="6623306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623310">for</span>&nbsp;<span class="ident" id="6623314">i</span>&nbsp;<span class="op" id="6623316">:=</span>&nbsp;<span class="num" id="6623319">0</span><span class="op" id="6623320">;</span>&nbsp;<span class="ident" id="6623322">i</span>&nbsp;<span class="op" id="6623324">&lt;</span>&nbsp;<span class="builtinfunc" id="6623326">len</span><span class="op" id="6623329">(</span><span class="ident" id="6623330">data</span><span class="op" id="6623334">)</span>&nbsp;<span class="op" id="6623336">&amp;&amp;</span>&nbsp;<span class="ident" id="6623339">data</span><span class="op" id="6623343">[</span><span class="ident" id="6623344">i</span><span class="op" id="6623345">]</span>&nbsp;<span class="op" id="6623347">!=</span>&nbsp;<span class="string" id="6623350">&#34;&#34;</span><span class="op" id="6623352">;</span>&nbsp;<span class="ident" id="6623354">i</span><span class="op" id="6623355">++</span>&nbsp;<span class="op" id="6623358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623363">tc</span><span class="op" id="6623365">.</span><span class="ident" id="6623366">PrintfLine</span><span class="op" id="6623376">(</span><span class="ident" id="6623377">data</span><span class="op" id="6623381">[</span><span class="ident" id="6623382">i</span><span class="op" id="6623383">]</span><span class="op" id="6623384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623389">for</span>&nbsp;<span class="builtinfunc" id="6623393">len</span><span class="op" id="6623396">(</span><span class="ident" id="6623397">data</span><span class="op" id="6623401">[</span><span class="ident" id="6623402">i</span><span class="op" id="6623403">]</span><span class="op" id="6623404">)</span>&nbsp;<span class="op" id="6623406">&gt;=</span>&nbsp;<span class="num" id="6623409">4</span>&nbsp;<span class="op" id="6623411">&amp;&amp;</span>&nbsp;<span class="ident" id="6623414">data</span><span class="op" id="6623418">[</span><span class="ident" id="6623419">i</span><span class="op" id="6623420">]</span><span class="op" id="6623421">[</span><span class="num" id="6623422">3</span><span class="op" id="6623423">]</span>&nbsp;<span class="op" id="6623425">==</span>&nbsp;<span class="string" id="6623428">&#39;-&#39;</span>&nbsp;<span class="op" id="6623432">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623438">i</span><span class="op" id="6623439">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623446">tc</span><span class="op" id="6623448">.</span><span class="ident" id="6623449">PrintfLine</span><span class="op" id="6623459">(</span><span class="ident" id="6623460">data</span><span class="op" id="6623464">[</span><span class="ident" id="6623465">i</span><span class="op" id="6623466">]</span><span class="op" id="6623467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623477">if</span>&nbsp;<span class="ident" id="6623480">data</span><span class="op" id="6623484">[</span><span class="ident" id="6623485">i</span><span class="op" id="6623486">]</span>&nbsp;<span class="op" id="6623488">==</span>&nbsp;<span class="string" id="6623491">&#34;221&nbsp;Goodbye&#34;</span>&nbsp;<span class="op" id="6623505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623511">return</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623526">read</span>&nbsp;<span class="op" id="6623531">:=</span>&nbsp;<span class="builtintype" id="6623534">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623543">for</span>&nbsp;<span class="op" id="6623547">!</span><span class="ident" id="6623548">read</span>&nbsp;<span class="op" id="6623553">||</span>&nbsp;<span class="ident" id="6623556">data</span><span class="op" id="6623560">[</span><span class="ident" id="6623561">i</span><span class="op" id="6623562">]</span>&nbsp;<span class="op" id="6623564">==</span>&nbsp;<span class="string" id="6623567">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="6623582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623588">msg</span><span class="op" id="6623591">,</span>&nbsp;<span class="ident" id="6623593">err</span>&nbsp;<span class="op" id="6623597">:=</span>&nbsp;<span class="ident" id="6623600">tc</span><span class="op" id="6623602">.</span><span class="ident" id="6623603">ReadLine</span><span class="op" id="6623611">(</span><span class="op" id="6623612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623618">bcmdbuf</span><span class="op" id="6623625">.</span><span class="ident" id="6623626">Write</span><span class="op" id="6623631">(</span><span class="op" id="6623632">[</span><span class="op" id="6623633">]</span><span class="builtintype" id="6623634">byte</span><span class="op" id="6623638">(</span><span class="ident" id="6623639">msg</span>&nbsp;<span class="op" id="6623643">+</span>&nbsp;<span class="string" id="6623645">&#34;\r\n&#34;</span><span class="op" id="6623651">)</span><span class="op" id="6623652">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623658">read</span>&nbsp;<span class="op" id="6623663">=</span>&nbsp;<span class="builtintype" id="6623665">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623674">if</span>&nbsp;<span class="ident" id="6623677">err</span>&nbsp;<span class="op" id="6623681">!=</span>&nbsp;<span class="ident" id="6623684">nil</span>&nbsp;<span class="op" id="6623688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623695">t</span><span class="op" id="6623696">.</span><span class="ident" id="6623697">Errorf</span><span class="op" id="6623703">(</span><span class="string" id="6623704">&#34;Read&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6623720">,</span>&nbsp;<span class="ident" id="6623722">err</span><span class="op" id="6623725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623732">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623743">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623749">if</span>&nbsp;<span class="ident" id="6623752">data</span><span class="op" id="6623756">[</span><span class="ident" id="6623757">i</span><span class="op" id="6623758">]</span>&nbsp;<span class="op" id="6623760">==</span>&nbsp;<span class="string" id="6623763">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="6623778">&amp;&amp;</span>&nbsp;<span class="ident" id="6623781">msg</span>&nbsp;<span class="op" id="6623785">==</span>&nbsp;<span class="string" id="6623788">&#34;.&#34;</span>&nbsp;<span class="op" id="6623792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623799">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623818">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623821">}</span><span class="op" id="6623822">(</span><span class="ident" id="6623823">strings</span><span class="op" id="6623830">.</span><span class="ident" id="6623831">Split</span><span class="op" id="6623836">(</span><span class="ident" id="6623837">server</span><span class="op" id="6623843">,</span>&nbsp;<span class="string" id="6623845">&#34;\r\n&#34;</span><span class="op" id="6623851">)</span><span class="op" id="6623852">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623856">err</span>&nbsp;<span class="op" id="6623860">=</span>&nbsp;<span class="ident" id="6623862">SendMail</span><span class="op" id="6623870">(</span><span class="ident" id="6623871">l</span><span class="op" id="6623872">.</span><span class="ident" id="6623873">Addr</span><span class="op" id="6623877">(</span><span class="op" id="6623878">)</span><span class="op" id="6623879">.</span><span class="ident" id="6623880">String</span><span class="op" id="6623886">(</span><span class="op" id="6623887">)</span><span class="op" id="6623888">,</span>&nbsp;<span class="ident" id="6623890">nil</span><span class="op" id="6623893">,</span>&nbsp;<span class="string" id="6623895">&#34;test@example.com&#34;</span><span class="op" id="6623913">,</span>&nbsp;<span class="op" id="6623915">[</span><span class="op" id="6623916">]</span><span class="builtintype" id="6623917">string</span><span class="op" id="6623923">{</span><span class="string" id="6623924">&#34;other@example.com&#34;</span><span class="op" id="6623943">}</span><span class="op" id="6623944">,</span>&nbsp;<span class="op" id="6623946">[</span><span class="op" id="6623947">]</span><span class="builtintype" id="6623948">byte</span><span class="op" id="6623952">(</span><span class="ident" id="6623953">strings</span><span class="op" id="6623960">.</span><span class="ident" id="6623961">Replace</span><span class="op" id="6623968">(</span><span class="string" id="6623969">`From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno">470</span><br>
<span class="lineno"></span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>`</span><span class="op" id="6624068">,</span>&nbsp;<span class="string" id="6624070">&#34;\n&#34;</span><span class="op" id="6624074">,</span>&nbsp;<span class="string" id="6624076">&#34;\r\n&#34;</span><span class="op" id="6624082">,</span>&nbsp;<span class="op" id="6624084">-</span><span class="num" id="6624085">1</span><span class="op" id="6624086">)</span><span class="op" id="6624087">)</span><span class="op" id="6624088">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6624092">if</span>&nbsp;<span class="ident" id="6624095">err</span>&nbsp;<span class="op" id="6624099">!=</span>&nbsp;<span class="ident" id="6624102">nil</span>&nbsp;<span class="op" id="6624106">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624110">t</span><span class="op" id="6624111">.</span><span class="ident" id="6624112">Errorf</span><span class="op" id="6624118">(</span><span class="string" id="6624119">&#34;%v&#34;</span><span class="op" id="6624123">,</span>&nbsp;<span class="ident" id="6624125">err</span><span class="op" id="6624128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6624131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6624135">&lt;-</span><span class="ident" id="6624137">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624143">bcmdbuf</span><span class="op" id="6624150">.</span><span class="ident" id="6624151">Flush</span><span class="op" id="6624156">(</span><span class="op" id="6624157">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624160">actualcmds</span>&nbsp;<span class="op" id="6624171">:=</span>&nbsp;<span class="ident" id="6624174">cmdbuf</span><span class="op" id="6624180">.</span><span class="ident" id="6624181">String</span><span class="op" id="6624187">(</span><span class="op" id="6624188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6624191">if</span>&nbsp;<span class="ident" id="6624194">client</span>&nbsp;<span class="op" id="6624201">!=</span>&nbsp;<span class="ident" id="6624204">actualcmds</span>&nbsp;<span class="op" id="6624215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624219">t</span><span class="op" id="6624220">.</span><span class="ident" id="6624221">Errorf</span><span class="op" id="6624227">(</span><span class="string" id="6624228">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6624253">,</span>&nbsp;<span class="ident" id="6624255">actualcmds</span><span class="op" id="6624265">,</span>&nbsp;<span class="ident" id="6624267">client</span><span class="op" id="6624273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6624276">}</span><br>
<span class="lineno"></span><span class="op" id="6624278">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="6624281">var</span>&nbsp;<span class="ident" id="6624285">sendMailServer</span>&nbsp;<span class="op" id="6624300">=</span>&nbsp;<span class="string" id="6624302">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno"></span>250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;ok<br>
<span class="lineno">490</span>250&nbsp;Receiver&nbsp;ok<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;ok<br>
<span class="lineno"></span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="keyword" id="6624431">var</span>&nbsp;<span class="ident" id="6624435">sendMailClient</span>&nbsp;<span class="op" id="6624450">=</span>&nbsp;<span class="string" id="6624452">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;test@example.com&gt;<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;other@example.com&gt;<br>
<span class="lineno">500</span>DATA<br>
<span class="lineno"></span>From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno"></span><br>
<span class="lineno">505</span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="6624652">func</span>&nbsp;<span class="ident" id="6624657">TestAuthFailed</span><span class="op" id="6624671">(</span><span class="ident" id="6624672">t</span>&nbsp;<span class="op" id="6624674">*</span><span class="ident" id="6624675">testing</span><span class="op" id="6624682">.</span><span class="ident" id="6624683">T</span><span class="op" id="6624684">)</span>&nbsp;<span class="op" id="6624686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624689">server</span>&nbsp;<span class="op" id="6624696">:=</span>&nbsp;<span class="ident" id="6624699">strings</span><span class="op" id="6624706">.</span><span class="ident" id="6624707">Join</span><span class="op" id="6624711">(</span><span class="ident" id="6624712">strings</span><span class="op" id="6624719">.</span><span class="ident" id="6624720">Split</span><span class="op" id="6624725">(</span><span class="ident" id="6624726">authFailedServer</span><span class="op" id="6624742">,</span>&nbsp;<span class="string" id="6624744">&#34;\n&#34;</span><span class="op" id="6624748">)</span><span class="op" id="6624749">,</span>&nbsp;<span class="string" id="6624751">&#34;\r\n&#34;</span><span class="op" id="6624757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624760">client</span>&nbsp;<span class="op" id="6624767">:=</span>&nbsp;<span class="ident" id="6624770">strings</span><span class="op" id="6624777">.</span><span class="ident" id="6624778">Join</span><span class="op" id="6624782">(</span><span class="ident" id="6624783">strings</span><span class="op" id="6624790">.</span><span class="ident" id="6624791">Split</span><span class="op" id="6624796">(</span><span class="ident" id="6624797">authFailedClient</span><span class="op" id="6624813">,</span>&nbsp;<span class="string" id="6624815">&#34;\n&#34;</span><span class="op" id="6624819">)</span><span class="op" id="6624820">,</span>&nbsp;<span class="string" id="6624822">&#34;\r\n&#34;</span><span class="op" id="6624828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6624831">var</span>&nbsp;<span class="ident" id="6624835">cmdbuf</span>&nbsp;<span class="ident" id="6624842">bytes</span><span class="op" id="6624847">.</span><span class="ident" id="6624848">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624856">bcmdbuf</span>&nbsp;<span class="op" id="6624864">:=</span>&nbsp;<span class="ident" id="6624867">bufio</span><span class="op" id="6624872">.</span><span class="ident" id="6624873">NewWriter</span><span class="op" id="6624882">(</span><span class="op" id="6624883">&amp;</span><span class="ident" id="6624884">cmdbuf</span><span class="op" id="6624890">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6624893">var</span>&nbsp;<span class="ident" id="6624897">fake</span>&nbsp;<span class="ident" id="6624902">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624909">fake</span><span class="op" id="6624913">.</span><span class="ident" id="6624914">ReadWriter</span>&nbsp;<span class="op" id="6624925">=</span>&nbsp;<span class="ident" id="6624927">bufio</span><span class="op" id="6624932">.</span><span class="ident" id="6624933">NewReadWriter</span><span class="op" id="6624946">(</span><span class="ident" id="6624947">bufio</span><span class="op" id="6624952">.</span><span class="ident" id="6624953">NewReader</span><span class="op" id="6624962">(</span><span class="ident" id="6624963">strings</span><span class="op" id="6624970">.</span><span class="ident" id="6624971">NewReader</span><span class="op" id="6624980">(</span><span class="ident" id="6624981">server</span><span class="op" id="6624987">)</span><span class="op" id="6624988">)</span><span class="op" id="6624989">,</span>&nbsp;<span class="ident" id="6624991">bcmdbuf</span><span class="op" id="6624998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625001">c</span><span class="op" id="6625002">,</span>&nbsp;<span class="ident" id="6625004">err</span>&nbsp;<span class="op" id="6625008">:=</span>&nbsp;<span class="ident" id="6625011">NewClient</span><span class="op" id="6625020">(</span><span class="ident" id="6625021">fake</span><span class="op" id="6625025">,</span>&nbsp;<span class="string" id="6625027">&#34;fake.host&#34;</span><span class="op" id="6625038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625041">if</span>&nbsp;<span class="ident" id="6625044">err</span>&nbsp;<span class="op" id="6625048">!=</span>&nbsp;<span class="ident" id="6625051">nil</span>&nbsp;<span class="op" id="6625055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625059">t</span><span class="op" id="6625060">.</span><span class="ident" id="6625061">Fatalf</span><span class="op" id="6625067">(</span><span class="string" id="6625068">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="6625083">,</span>&nbsp;<span class="ident" id="6625085">err</span><span class="op" id="6625088">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6625091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625094">defer</span>&nbsp;<span class="ident" id="6625100">c</span><span class="op" id="6625101">.</span><span class="ident" id="6625102">Close</span><span class="op" id="6625107">(</span><span class="op" id="6625108">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625112">c</span><span class="op" id="6625113">.</span><span class="ident" id="6625114">tls</span>&nbsp;<span class="op" id="6625118">=</span>&nbsp;<span class="builtintype" id="6625120">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625126">c</span><span class="op" id="6625127">.</span><span class="ident" id="6625128">serverName</span>&nbsp;<span class="op" id="6625139">=</span>&nbsp;<span class="string" id="6625141">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625160">err</span>&nbsp;<span class="op" id="6625164">=</span>&nbsp;<span class="ident" id="6625166">c</span><span class="op" id="6625167">.</span><span class="ident" id="6625168">Auth</span><span class="op" id="6625172">(</span><span class="ident" id="6625173">PlainAuth</span><span class="op" id="6625182">(</span><span class="string" id="6625183">&#34;&#34;</span><span class="op" id="6625185">,</span>&nbsp;<span class="string" id="6625187">&#34;user&#34;</span><span class="op" id="6625193">,</span>&nbsp;<span class="string" id="6625195">&#34;pass&#34;</span><span class="op" id="6625201">,</span>&nbsp;<span class="string" id="6625203">&#34;smtp.google.com&#34;</span><span class="op" id="6625220">)</span><span class="op" id="6625221">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625225">if</span>&nbsp;<span class="ident" id="6625228">err</span>&nbsp;<span class="op" id="6625232">==</span>&nbsp;<span class="ident" id="6625235">nil</span>&nbsp;<span class="op" id="6625239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625243">t</span><span class="op" id="6625244">.</span><span class="ident" id="6625245">Error</span><span class="op" id="6625250">(</span><span class="string" id="6625251">&#34;Auth:&nbsp;expected&nbsp;error;&nbsp;got&nbsp;none&#34;</span><span class="op" id="6625283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6625286">}</span>&nbsp;<span class="keyword" id="6625288">else</span>&nbsp;<span class="keyword" id="6625293">if</span>&nbsp;<span class="ident" id="6625296">err</span><span class="op" id="6625299">.</span><span class="ident" id="6625300">Error</span><span class="op" id="6625305">(</span><span class="op" id="6625306">)</span>&nbsp;<span class="op" id="6625308">!=</span>&nbsp;<span class="string" id="6625311">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span>&nbsp;<span class="op" id="6625365">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625369">t</span><span class="op" id="6625370">.</span><span class="ident" id="6625371">Errorf</span><span class="op" id="6625377">(</span><span class="string" id="6625378">&#34;Auth:&nbsp;got&nbsp;error:&nbsp;%v,&nbsp;want:&nbsp;%s&#34;</span><span class="op" id="6625409">,</span>&nbsp;<span class="ident" id="6625411">err</span><span class="op" id="6625414">,</span>&nbsp;<span class="string" id="6625416">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span><span class="op" id="6625469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6625472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625476">bcmdbuf</span><span class="op" id="6625483">.</span><span class="ident" id="6625484">Flush</span><span class="op" id="6625489">(</span><span class="op" id="6625490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625493">actualcmds</span>&nbsp;<span class="op" id="6625504">:=</span>&nbsp;<span class="ident" id="6625507">cmdbuf</span><span class="op" id="6625513">.</span><span class="ident" id="6625514">String</span><span class="op" id="6625520">(</span><span class="op" id="6625521">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625524">if</span>&nbsp;<span class="ident" id="6625527">client</span>&nbsp;<span class="op" id="6625534">!=</span>&nbsp;<span class="ident" id="6625537">actualcmds</span>&nbsp;<span class="op" id="6625548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625552">t</span><span class="op" id="6625553">.</span><span class="ident" id="6625554">Errorf</span><span class="op" id="6625560">(</span><span class="string" id="6625561">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6625586">,</span>&nbsp;<span class="ident" id="6625588">actualcmds</span><span class="op" id="6625598">,</span>&nbsp;<span class="ident" id="6625600">client</span><span class="op" id="6625606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6625609">}</span><br>
<span class="lineno"></span><span class="op" id="6625611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">540</span><span class="keyword" id="6625614">var</span>&nbsp;<span class="ident" id="6625618">authFailedServer</span>&nbsp;<span class="op" id="6625635">=</span>&nbsp;<span class="string" id="6625637">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>535-Invalid&nbsp;credentials<br>
<span class="lineno"></span>535&nbsp;please&nbsp;see&nbsp;www.example.com<br>
<span class="lineno">545</span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6625779">var</span>&nbsp;<span class="ident" id="6625783">authFailedClient</span>&nbsp;<span class="op" id="6625800">=</span>&nbsp;<span class="string" id="6625802">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno">550</span>*<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6625856">func</span>&nbsp;<span class="ident" id="6625861">TestTLSClient</span><span class="op" id="6625874">(</span><span class="ident" id="6625875">t</span>&nbsp;<span class="op" id="6625877">*</span><span class="ident" id="6625878">testing</span><span class="op" id="6625885">.</span><span class="ident" id="6625886">T</span><span class="op" id="6625887">)</span>&nbsp;<span class="op" id="6625889">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625892">ln</span>&nbsp;<span class="op" id="6625895">:=</span>&nbsp;<span class="ident" id="6625898">newLocalListener</span><span class="op" id="6625914">(</span><span class="ident" id="6625915">t</span><span class="op" id="6625916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625919">defer</span>&nbsp;<span class="ident" id="6625925">ln</span><span class="op" id="6625927">.</span><span class="ident" id="6625928">Close</span><span class="op" id="6625933">(</span><span class="op" id="6625934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625937">errc</span>&nbsp;<span class="op" id="6625942">:=</span>&nbsp;<span class="builtinfunc" id="6625945">make</span><span class="op" id="6625949">(</span><span class="keyword" id="6625950">chan</span>&nbsp;<span class="builtintype" id="6625955">error</span><span class="op" id="6625960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625963">go</span>&nbsp;<span class="keyword" id="6625966">func</span><span class="op" id="6625970">(</span><span class="op" id="6625971">)</span>&nbsp;<span class="op" id="6625973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625977">errc</span>&nbsp;<span class="op" id="6625982">&lt;-</span>&nbsp;<span class="ident" id="6625985">sendMail</span><span class="op" id="6625993">(</span><span class="ident" id="6625994">ln</span><span class="op" id="6625996">.</span><span class="ident" id="6625997">Addr</span><span class="op" id="6626001">(</span><span class="op" id="6626002">)</span><span class="op" id="6626003">.</span><span class="ident" id="6626004">String</span><span class="op" id="6626010">(</span><span class="op" id="6626011">)</span><span class="op" id="6626012">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626015">}</span><span class="op" id="6626016">(</span><span class="op" id="6626017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626020">conn</span><span class="op" id="6626024">,</span>&nbsp;<span class="ident" id="6626026">err</span>&nbsp;<span class="op" id="6626030">:=</span>&nbsp;<span class="ident" id="6626033">ln</span><span class="op" id="6626035">.</span><span class="ident" id="6626036">Accept</span><span class="op" id="6626042">(</span><span class="op" id="6626043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626046">if</span>&nbsp;<span class="ident" id="6626049">err</span>&nbsp;<span class="op" id="6626053">!=</span>&nbsp;<span class="ident" id="6626056">nil</span>&nbsp;<span class="op" id="6626060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626064">t</span><span class="op" id="6626065">.</span><span class="ident" id="6626066">Fatalf</span><span class="op" id="6626072">(</span><span class="string" id="6626073">&#34;failed&nbsp;to&nbsp;accept&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="6626106">,</span>&nbsp;<span class="ident" id="6626108">err</span><span class="op" id="6626111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626114">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626117">defer</span>&nbsp;<span class="ident" id="6626123">conn</span><span class="op" id="6626127">.</span><span class="ident" id="6626128">Close</span><span class="op" id="6626133">(</span><span class="op" id="6626134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626137">if</span>&nbsp;<span class="ident" id="6626140">err</span>&nbsp;<span class="op" id="6626144">:=</span>&nbsp;<span class="ident" id="6626147">serverHandle</span><span class="op" id="6626159">(</span><span class="ident" id="6626160">conn</span><span class="op" id="6626164">,</span>&nbsp;<span class="ident" id="6626166">t</span><span class="op" id="6626167">)</span><span class="op" id="6626168">;</span>&nbsp;<span class="ident" id="6626170">err</span>&nbsp;<span class="op" id="6626174">!=</span>&nbsp;<span class="ident" id="6626177">nil</span>&nbsp;<span class="op" id="6626181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626185">t</span><span class="op" id="6626186">.</span><span class="ident" id="6626187">Fatalf</span><span class="op" id="6626193">(</span><span class="string" id="6626194">&#34;failed&nbsp;to&nbsp;handle&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="6626227">,</span>&nbsp;<span class="ident" id="6626229">err</span><span class="op" id="6626232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626238">if</span>&nbsp;<span class="ident" id="6626241">err</span>&nbsp;<span class="op" id="6626245">:=</span>&nbsp;<span class="op" id="6626248">&lt;-</span><span class="ident" id="6626250">errc</span><span class="op" id="6626254">;</span>&nbsp;<span class="ident" id="6626256">err</span>&nbsp;<span class="op" id="6626260">!=</span>&nbsp;<span class="ident" id="6626263">nil</span>&nbsp;<span class="op" id="6626267">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626271">t</span><span class="op" id="6626272">.</span><span class="ident" id="6626273">Fatalf</span><span class="op" id="6626279">(</span><span class="string" id="6626280">&#34;client&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6626298">,</span>&nbsp;<span class="ident" id="6626300">err</span><span class="op" id="6626303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626306">}</span><br>
<span class="lineno"></span><span class="op" id="6626308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6626311">func</span>&nbsp;<span class="ident" id="6626316">newLocalListener</span><span class="op" id="6626332">(</span><span class="ident" id="6626333">t</span>&nbsp;<span class="op" id="6626335">*</span><span class="ident" id="6626336">testing</span><span class="op" id="6626343">.</span><span class="ident" id="6626344">T</span><span class="op" id="6626345">)</span>&nbsp;<span class="ident" id="6626347">net</span><span class="op" id="6626350">.</span><span class="ident" id="6626351">Listener</span>&nbsp;<span class="op" id="6626360">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626363">ln</span><span class="op" id="6626365">,</span>&nbsp;<span class="ident" id="6626367">err</span>&nbsp;<span class="op" id="6626371">:=</span>&nbsp;<span class="ident" id="6626374">net</span><span class="op" id="6626377">.</span><span class="ident" id="6626378">Listen</span><span class="op" id="6626384">(</span><span class="string" id="6626385">&#34;tcp&#34;</span><span class="op" id="6626390">,</span>&nbsp;<span class="string" id="6626392">&#34;127.0.0.1:0&#34;</span><span class="op" id="6626405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626408">if</span>&nbsp;<span class="ident" id="6626411">err</span>&nbsp;<span class="op" id="6626415">!=</span>&nbsp;<span class="ident" id="6626418">nil</span>&nbsp;<span class="op" id="6626422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626426">ln</span><span class="op" id="6626428">,</span>&nbsp;<span class="ident" id="6626430">err</span>&nbsp;<span class="op" id="6626434">=</span>&nbsp;<span class="ident" id="6626436">net</span><span class="op" id="6626439">.</span><span class="ident" id="6626440">Listen</span><span class="op" id="6626446">(</span><span class="string" id="6626447">&#34;tcp6&#34;</span><span class="op" id="6626453">,</span>&nbsp;<span class="string" id="6626455">&#34;[::1]:0&#34;</span><span class="op" id="6626464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626470">if</span>&nbsp;<span class="ident" id="6626473">err</span>&nbsp;<span class="op" id="6626477">!=</span>&nbsp;<span class="ident" id="6626480">nil</span>&nbsp;<span class="op" id="6626484">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626488">t</span><span class="op" id="6626489">.</span><span class="ident" id="6626490">Fatal</span><span class="op" id="6626495">(</span><span class="ident" id="6626496">err</span><span class="op" id="6626499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626505">return</span>&nbsp;<span class="ident" id="6626512">ln</span><br>
<span class="lineno"></span><span class="op" id="6626515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span><span class="keyword" id="6626518">type</span>&nbsp;<span class="ident" id="6626523">smtpSender</span>&nbsp;<span class="keyword" id="6626534">struct</span>&nbsp;<span class="op" id="6626541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626544">w</span>&nbsp;<span class="ident" id="6626546">io</span><span class="op" id="6626548">.</span><span class="ident" id="6626549">Writer</span><br>
<span class="lineno"></span><span class="op" id="6626556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6626559">func</span>&nbsp;<span class="op" id="6626564">(</span><span class="ident" id="6626565">s</span>&nbsp;<span class="ident" id="6626567">smtpSender</span><span class="op" id="6626577">)</span>&nbsp;<span class="ident" id="6626579">send</span><span class="op" id="6626583">(</span><span class="ident" id="6626584">f</span>&nbsp;<span class="builtintype" id="6626586">string</span><span class="op" id="6626592">)</span>&nbsp;<span class="op" id="6626594">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626597">s</span><span class="op" id="6626598">.</span><span class="ident" id="6626599">w</span><span class="op" id="6626600">.</span><span class="ident" id="6626601">Write</span><span class="op" id="6626606">(</span><span class="op" id="6626607">[</span><span class="op" id="6626608">]</span><span class="builtintype" id="6626609">byte</span><span class="op" id="6626613">(</span><span class="ident" id="6626614">f</span>&nbsp;<span class="op" id="6626616">+</span>&nbsp;<span class="string" id="6626618">&#34;\r\n&#34;</span><span class="op" id="6626624">)</span><span class="op" id="6626625">)</span><br>
<span class="lineno"></span><span class="op" id="6626627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6626630">//&nbsp;smtp&nbsp;server,&nbsp;finely&nbsp;tailored&nbsp;to&nbsp;deal&nbsp;with&nbsp;our&nbsp;own&nbsp;client&nbsp;only!</span><br>
<span class="lineno"></span><span class="keyword" id="6626696">func</span>&nbsp;<span class="ident" id="6626701">serverHandle</span><span class="op" id="6626713">(</span><span class="ident" id="6626714">c</span>&nbsp;<span class="ident" id="6626716">net</span><span class="op" id="6626719">.</span><span class="ident" id="6626720">Conn</span><span class="op" id="6626724">,</span>&nbsp;<span class="ident" id="6626726">t</span>&nbsp;<span class="op" id="6626728">*</span><span class="ident" id="6626729">testing</span><span class="op" id="6626736">.</span><span class="ident" id="6626737">T</span><span class="op" id="6626738">)</span>&nbsp;<span class="builtintype" id="6626740">error</span>&nbsp;<span class="op" id="6626746">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626749">send</span>&nbsp;<span class="op" id="6626754">:=</span>&nbsp;<span class="ident" id="6626757">smtpSender</span><span class="op" id="6626767">{</span><span class="ident" id="6626768">c</span><span class="op" id="6626769">}</span><span class="op" id="6626770">.</span><span class="ident" id="6626771">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626777">send</span><span class="op" id="6626781">(</span><span class="string" id="6626782">&#34;220&nbsp;127.0.0.1&nbsp;ESMTP&nbsp;service&nbsp;ready&#34;</span><span class="op" id="6626817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626820">s</span>&nbsp;<span class="op" id="6626822">:=</span>&nbsp;<span class="ident" id="6626825">bufio</span><span class="op" id="6626830">.</span><span class="ident" id="6626831">NewScanner</span><span class="op" id="6626841">(</span><span class="ident" id="6626842">c</span><span class="op" id="6626843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626846">for</span>&nbsp;<span class="ident" id="6626850">s</span><span class="op" id="6626851">.</span><span class="ident" id="6626852">Scan</span><span class="op" id="6626856">(</span><span class="op" id="6626857">)</span>&nbsp;<span class="op" id="6626859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626863">switch</span>&nbsp;<span class="ident" id="6626870">s</span><span class="op" id="6626871">.</span><span class="ident" id="6626872">Text</span><span class="op" id="6626876">(</span><span class="op" id="6626877">)</span>&nbsp;<span class="op" id="6626879">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626883">case</span>&nbsp;<span class="string" id="6626888">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="6626904">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626909">send</span><span class="op" id="6626913">(</span><span class="string" id="6626914">&#34;250-127.0.0.1&nbsp;ESMTP&nbsp;offers&nbsp;a&nbsp;warm&nbsp;hug&nbsp;of&nbsp;welcome&#34;</span><span class="op" id="6626964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626969">send</span><span class="op" id="6626973">(</span><span class="string" id="6626974">&#34;250-STARTTLS&#34;</span><span class="op" id="6626988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626993">send</span><span class="op" id="6626997">(</span><span class="string" id="6626998">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6627006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627010">case</span>&nbsp;<span class="string" id="6627015">&#34;STARTTLS&#34;</span><span class="op" id="6627025">:</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627030">send</span><span class="op" id="6627034">(</span><span class="string" id="6627035">&#34;220&nbsp;Go&nbsp;ahead&#34;</span><span class="op" id="6627049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627054">keypair</span><span class="op" id="6627061">,</span>&nbsp;<span class="ident" id="6627063">err</span>&nbsp;<span class="op" id="6627067">:=</span>&nbsp;<span class="ident" id="6627070">tls</span><span class="op" id="6627073">.</span><span class="ident" id="6627074">X509KeyPair</span><span class="op" id="6627085">(</span><span class="ident" id="6627086">localhostCert</span><span class="op" id="6627099">,</span>&nbsp;<span class="ident" id="6627101">localhostKey</span><span class="op" id="6627113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627118">if</span>&nbsp;<span class="ident" id="6627121">err</span>&nbsp;<span class="op" id="6627125">!=</span>&nbsp;<span class="ident" id="6627128">nil</span>&nbsp;<span class="op" id="6627132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627138">return</span>&nbsp;<span class="ident" id="6627145">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6627152">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627157">config</span>&nbsp;<span class="op" id="6627164">:=</span>&nbsp;<span class="op" id="6627167">&amp;</span><span class="ident" id="6627168">tls</span><span class="op" id="6627171">.</span><span class="ident" id="6627172">Config</span><span class="op" id="6627178">{</span><span class="ident" id="6627179">Certificates</span><span class="op" id="6627191">:</span>&nbsp;<span class="op" id="6627193">[</span><span class="op" id="6627194">]</span><span class="ident" id="6627195">tls</span><span class="op" id="6627198">.</span><span class="ident" id="6627199">Certificate</span><span class="op" id="6627210">{</span><span class="ident" id="6627211">keypair</span><span class="op" id="6627218">}</span><span class="op" id="6627219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627224">c</span>&nbsp;<span class="op" id="6627226">=</span>&nbsp;<span class="ident" id="6627228">tls</span><span class="op" id="6627231">.</span><span class="ident" id="6627232">Server</span><span class="op" id="6627238">(</span><span class="ident" id="6627239">c</span><span class="op" id="6627240">,</span>&nbsp;<span class="ident" id="6627242">config</span><span class="op" id="6627248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627253">defer</span>&nbsp;<span class="ident" id="6627259">c</span><span class="op" id="6627260">.</span><span class="ident" id="6627261">Close</span><span class="op" id="6627266">(</span><span class="op" id="6627267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627272">return</span>&nbsp;<span class="ident" id="6627279">serverHandleTLS</span><span class="op" id="6627294">(</span><span class="ident" id="6627295">c</span><span class="op" id="6627296">,</span>&nbsp;<span class="ident" id="6627298">t</span><span class="op" id="6627299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627303">default</span><span class="op" id="6627310">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627315">t</span><span class="op" id="6627316">.</span><span class="ident" id="6627317">Fatalf</span><span class="op" id="6627323">(</span><span class="string" id="6627324">&#34;unrecognized&nbsp;command:&nbsp;%q&#34;</span><span class="op" id="6627350">,</span>&nbsp;<span class="ident" id="6627352">s</span><span class="op" id="6627353">.</span><span class="ident" id="6627354">Text</span><span class="op" id="6627358">(</span><span class="op" id="6627359">)</span><span class="op" id="6627360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6627364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6627367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627370">return</span>&nbsp;<span class="ident" id="6627377">s</span><span class="op" id="6627378">.</span><span class="ident" id="6627379">Err</span><span class="op" id="6627382">(</span><span class="op" id="6627383">)</span><br>
<span class="lineno"></span><span class="op" id="6627385">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="6627388">func</span>&nbsp;<span class="ident" id="6627393">serverHandleTLS</span><span class="op" id="6627408">(</span><span class="ident" id="6627409">c</span>&nbsp;<span class="ident" id="6627411">net</span><span class="op" id="6627414">.</span><span class="ident" id="6627415">Conn</span><span class="op" id="6627419">,</span>&nbsp;<span class="ident" id="6627421">t</span>&nbsp;<span class="op" id="6627423">*</span><span class="ident" id="6627424">testing</span><span class="op" id="6627431">.</span><span class="ident" id="6627432">T</span><span class="op" id="6627433">)</span>&nbsp;<span class="builtintype" id="6627435">error</span>&nbsp;<span class="op" id="6627441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627444">send</span>&nbsp;<span class="op" id="6627449">:=</span>&nbsp;<span class="ident" id="6627452">smtpSender</span><span class="op" id="6627462">{</span><span class="ident" id="6627463">c</span><span class="op" id="6627464">}</span><span class="op" id="6627465">.</span><span class="ident" id="6627466">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627472">s</span>&nbsp;<span class="op" id="6627474">:=</span>&nbsp;<span class="ident" id="6627477">bufio</span><span class="op" id="6627482">.</span><span class="ident" id="6627483">NewScanner</span><span class="op" id="6627493">(</span><span class="ident" id="6627494">c</span><span class="op" id="6627495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627498">for</span>&nbsp;<span class="ident" id="6627502">s</span><span class="op" id="6627503">.</span><span class="ident" id="6627504">Scan</span><span class="op" id="6627508">(</span><span class="op" id="6627509">)</span>&nbsp;<span class="op" id="6627511">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627515">switch</span>&nbsp;<span class="ident" id="6627522">s</span><span class="op" id="6627523">.</span><span class="ident" id="6627524">Text</span><span class="op" id="6627528">(</span><span class="op" id="6627529">)</span>&nbsp;<span class="op" id="6627531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627535">case</span>&nbsp;<span class="string" id="6627540">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="6627556">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627561">send</span><span class="op" id="6627565">(</span><span class="string" id="6627566">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6627574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627578">case</span>&nbsp;<span class="string" id="6627583">&#34;MAIL&nbsp;FROM:&lt;joe1@example.com&gt;&#34;</span><span class="op" id="6627613">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627618">send</span><span class="op" id="6627622">(</span><span class="string" id="6627623">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6627631">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627635">case</span>&nbsp;<span class="string" id="6627640">&#34;RCPT&nbsp;TO:&lt;joe2@example.com&gt;&#34;</span><span class="op" id="6627668">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627673">send</span><span class="op" id="6627677">(</span><span class="string" id="6627678">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6627686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627690">case</span>&nbsp;<span class="string" id="6627695">&#34;DATA&#34;</span><span class="op" id="6627701">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627706">send</span><span class="op" id="6627710">(</span><span class="string" id="6627711">&#34;354&nbsp;send&nbsp;the&nbsp;mail&nbsp;data,&nbsp;end&nbsp;with&nbsp;.&#34;</span><span class="op" id="6627747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627752">send</span><span class="op" id="6627756">(</span><span class="string" id="6627757">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6627765">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627769">case</span>&nbsp;<span class="string" id="6627774">&#34;Subject:&nbsp;test&#34;</span><span class="op" id="6627789">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627793">case</span>&nbsp;<span class="string" id="6627798">&#34;&#34;</span><span class="op" id="6627800">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627804">case</span>&nbsp;<span class="string" id="6627809">&#34;howdy!&#34;</span><span class="op" id="6627817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627821">case</span>&nbsp;<span class="string" id="6627826">&#34;.&#34;</span><span class="op" id="6627829">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627833">case</span>&nbsp;<span class="string" id="6627838">&#34;QUIT&#34;</span><span class="op" id="6627844">:</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627849">send</span><span class="op" id="6627853">(</span><span class="string" id="6627854">&#34;221&nbsp;127.0.0.1&nbsp;Service&nbsp;closing&nbsp;transmission&nbsp;channel&#34;</span><span class="op" id="6627906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627911">return</span>&nbsp;<span class="ident" id="6627918">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627924">default</span><span class="op" id="6627931">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627936">t</span><span class="op" id="6627937">.</span><span class="ident" id="6627938">Fatalf</span><span class="op" id="6627944">(</span><span class="string" id="6627945">&#34;unrecognized&nbsp;command&nbsp;during&nbsp;TLS:&nbsp;%q&#34;</span><span class="op" id="6627982">,</span>&nbsp;<span class="ident" id="6627984">s</span><span class="op" id="6627985">.</span><span class="ident" id="6627986">Text</span><span class="op" id="6627990">(</span><span class="op" id="6627991">)</span><span class="op" id="6627992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6627996">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6627999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6628002">return</span>&nbsp;<span class="ident" id="6628009">s</span><span class="op" id="6628010">.</span><span class="ident" id="6628011">Err</span><span class="op" id="6628014">(</span><span class="op" id="6628015">)</span><br>
<span class="lineno"></span><span class="op" id="6628017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6628020">func</span>&nbsp;<span class="ident" id="6628025">init</span><span class="op" id="6628029">(</span><span class="op" id="6628030">)</span>&nbsp;<span class="op" id="6628032">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628035">testRootCAs</span>&nbsp;<span class="op" id="6628047">:=</span>&nbsp;<span class="ident" id="6628050">x509</span><span class="op" id="6628054">.</span><span class="ident" id="6628055">NewCertPool</span><span class="op" id="6628066">(</span><span class="op" id="6628067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628070">testRootCAs</span><span class="op" id="6628081">.</span><span class="ident" id="6628082">AppendCertsFromPEM</span><span class="op" id="6628100">(</span><span class="ident" id="6628101">localhostCert</span><span class="op" id="6628114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628117">testHookStartTLS</span>&nbsp;<span class="op" id="6628134">=</span>&nbsp;<span class="keyword" id="6628136">func</span><span class="op" id="6628140">(</span><span class="ident" id="6628141">config</span>&nbsp;<span class="op" id="6628148">*</span><span class="ident" id="6628149">tls</span><span class="op" id="6628152">.</span><span class="ident" id="6628153">Config</span><span class="op" id="6628159">)</span>&nbsp;<span class="op" id="6628161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628165">config</span><span class="op" id="6628171">.</span><span class="ident" id="6628172">RootCAs</span>&nbsp;<span class="op" id="6628180">=</span>&nbsp;<span class="ident" id="6628182">testRootCAs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6628195">}</span><br>
<span class="lineno">655</span><span class="op" id="6628197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6628200">func</span>&nbsp;<span class="ident" id="6628205">sendMail</span><span class="op" id="6628213">(</span><span class="ident" id="6628214">hostPort</span>&nbsp;<span class="builtintype" id="6628223">string</span><span class="op" id="6628229">)</span>&nbsp;<span class="builtintype" id="6628231">error</span>&nbsp;<span class="op" id="6628237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628240">host</span><span class="op" id="6628244">,</span>&nbsp;<span class="ident" id="6628246">_</span><span class="op" id="6628247">,</span>&nbsp;<span class="ident" id="6628249">err</span>&nbsp;<span class="op" id="6628253">:=</span>&nbsp;<span class="ident" id="6628256">net</span><span class="op" id="6628259">.</span><span class="ident" id="6628260">SplitHostPort</span><span class="op" id="6628273">(</span><span class="ident" id="6628274">hostPort</span><span class="op" id="6628282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6628285">if</span>&nbsp;<span class="ident" id="6628288">err</span>&nbsp;<span class="op" id="6628292">!=</span>&nbsp;<span class="ident" id="6628295">nil</span>&nbsp;<span class="op" id="6628299">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6628303">return</span>&nbsp;<span class="ident" id="6628310">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6628315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628318">auth</span>&nbsp;<span class="op" id="6628323">:=</span>&nbsp;<span class="ident" id="6628326">PlainAuth</span><span class="op" id="6628335">(</span><span class="string" id="6628336">&#34;&#34;</span><span class="op" id="6628338">,</span>&nbsp;<span class="string" id="6628340">&#34;&#34;</span><span class="op" id="6628342">,</span>&nbsp;<span class="string" id="6628344">&#34;&#34;</span><span class="op" id="6628346">,</span>&nbsp;<span class="ident" id="6628348">host</span><span class="op" id="6628352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628355">from</span>&nbsp;<span class="op" id="6628360">:=</span>&nbsp;<span class="string" id="6628363">&#34;joe1@example.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628383">to</span>&nbsp;<span class="op" id="6628386">:=</span>&nbsp;<span class="op" id="6628389">[</span><span class="op" id="6628390">]</span><span class="builtintype" id="6628391">string</span><span class="op" id="6628397">{</span><span class="string" id="6628398">&#34;joe2@example.com&#34;</span><span class="op" id="6628416">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6628419">return</span>&nbsp;<span class="ident" id="6628426">SendMail</span><span class="op" id="6628434">(</span><span class="ident" id="6628435">hostPort</span><span class="op" id="6628443">,</span>&nbsp;<span class="ident" id="6628445">auth</span><span class="op" id="6628449">,</span>&nbsp;<span class="ident" id="6628451">from</span><span class="op" id="6628455">,</span>&nbsp;<span class="ident" id="6628457">to</span><span class="op" id="6628459">,</span>&nbsp;<span class="op" id="6628461">[</span><span class="op" id="6628462">]</span><span class="builtintype" id="6628463">byte</span><span class="op" id="6628467">(</span><span class="string" id="6628468">&#34;Subject:&nbsp;test\n\nhowdy!&#34;</span><span class="op" id="6628493">)</span><span class="op" id="6628494">)</span><br>
<span class="lineno"></span><span class="op" id="6628496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6628499">//&nbsp;(copied&nbsp;from&nbsp;net/http/httptest)</span><br>
<span class="lineno"></span><span class="comment" id="6628534">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno">670</span><span class="comment" id="6628590">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno"></span><span class="comment" id="6628663">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="6628682">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="6628716">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="6628852">var</span>&nbsp;<span class="ident" id="6628856">localhostCert</span>&nbsp;<span class="op" id="6628870">=</span>&nbsp;<span class="op" id="6628872">[</span><span class="op" id="6628873">]</span><span class="builtintype" id="6628874">byte</span><span class="op" id="6628878">(</span><span class="string" id="6628879">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno">675</span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno"></span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno">680</span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno"></span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="6629450">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span><span class="comment" id="6629453">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno"></span><span class="keyword" id="6629507">var</span>&nbsp;<span class="ident" id="6629511">localhostKey</span>&nbsp;<span class="op" id="6629524">=</span>&nbsp;<span class="op" id="6629526">[</span><span class="op" id="6629527">]</span><span class="builtintype" id="6629528">byte</span><span class="op" id="6629532">(</span><span class="string" id="6629533">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno">690</span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno"></span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="6630031">)</span>
</div>
</body>
</html>
