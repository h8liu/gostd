<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>log/syslog</h2>
<ul>
<li><a href="/gostd/log/syslog/syslog.go.html">syslog.go</a></li>
<li><a href="/gostd/log/syslog/syslog_test.go.html" class="current">syslog_test.go</a></li>
<li><a href="/gostd/log/syslog/syslog_unix.go.html">syslog_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8048797">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8048852">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8048906">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8048957">//&nbsp;+build&nbsp;!windows,!nacl,!plan9</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8048990">package</span>&nbsp;<span class="ident" id="8048998">syslog</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8049006">import</span>&nbsp;<span class="op" id="8049013">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8049016">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8049025">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8049032">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8049038">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8049051">&#34;log&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8049058">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8049065">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8049071">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8049079">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8049090">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="8049097">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8049100">func</span>&nbsp;<span class="ident" id="8049105">runPktSyslog</span><span class="op" id="8049117">(</span><span class="ident" id="8049118">c</span>&nbsp;<span class="ident" id="8049120">net</span><span class="op" id="8049123">.</span><span class="ident" id="8049124">PacketConn</span><span class="op" id="8049134">,</span>&nbsp;<span class="ident" id="8049136">done</span>&nbsp;<span class="keyword" id="8049141">chan</span><span class="op" id="8049145">&lt;-</span>&nbsp;<span class="builtintype" id="8049148">string</span><span class="op" id="8049154">)</span>&nbsp;<span class="op" id="8049156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049159">var</span>&nbsp;<span class="ident" id="8049163">buf</span>&nbsp;<span class="op" id="8049167">[</span><span class="num" id="8049168">4096</span><span class="op" id="8049172">]</span><span class="builtintype" id="8049173">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049179">var</span>&nbsp;<span class="ident" id="8049183">rcvd</span>&nbsp;<span class="builtintype" id="8049188">string</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8049196">ct</span>&nbsp;<span class="op" id="8049199">:=</span>&nbsp;<span class="num" id="8049202">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049205">for</span>&nbsp;<span class="op" id="8049209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049213">var</span>&nbsp;<span class="ident" id="8049217">n</span>&nbsp;<span class="builtintype" id="8049219">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049225">var</span>&nbsp;<span class="ident" id="8049229">err</span>&nbsp;<span class="builtintype" id="8049233">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8049242">c</span><span class="op" id="8049243">.</span><span class="ident" id="8049244">SetReadDeadline</span><span class="op" id="8049259">(</span><span class="ident" id="8049260">time</span><span class="op" id="8049264">.</span><span class="ident" id="8049265">Now</span><span class="op" id="8049268">(</span><span class="op" id="8049269">)</span><span class="op" id="8049270">.</span><span class="ident" id="8049271">Add</span><span class="op" id="8049274">(</span><span class="num" id="8049275">100</span>&nbsp;<span class="op" id="8049279">*</span>&nbsp;<span class="ident" id="8049281">time</span><span class="op" id="8049285">.</span><span class="ident" id="8049286">Millisecond</span><span class="op" id="8049297">)</span><span class="op" id="8049298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8049302">n</span><span class="op" id="8049303">,</span>&nbsp;<span class="ident" id="8049305">_</span><span class="op" id="8049306">,</span>&nbsp;<span class="ident" id="8049308">err</span>&nbsp;<span class="op" id="8049312">=</span>&nbsp;<span class="ident" id="8049314">c</span><span class="op" id="8049315">.</span><span class="ident" id="8049316">ReadFrom</span><span class="op" id="8049324">(</span><span class="ident" id="8049325">buf</span><span class="op" id="8049328">[</span><span class="op" id="8049329">:</span><span class="op" id="8049330">]</span><span class="op" id="8049331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8049335">rcvd</span>&nbsp;<span class="op" id="8049340">+=</span>&nbsp;<span class="builtintype" id="8049343">string</span><span class="op" id="8049349">(</span><span class="ident" id="8049350">buf</span><span class="op" id="8049353">[</span><span class="op" id="8049354">:</span><span class="ident" id="8049355">n</span><span class="op" id="8049356">]</span><span class="op" id="8049357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049361">if</span>&nbsp;<span class="ident" id="8049364">err</span>&nbsp;<span class="op" id="8049368">!=</span>&nbsp;<span class="builtintype" id="8049371">nil</span>&nbsp;<span class="op" id="8049375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049380">if</span>&nbsp;<span class="ident" id="8049383">oe</span><span class="op" id="8049385">,</span>&nbsp;<span class="ident" id="8049387">ok</span>&nbsp;<span class="op" id="8049390">:=</span>&nbsp;<span class="ident" id="8049393">err</span><span class="op" id="8049396">.</span><span class="op" id="8049397">(</span><span class="op" id="8049398">*</span><span class="ident" id="8049399">net</span><span class="op" id="8049402">.</span><span class="ident" id="8049403">OpError</span><span class="op" id="8049410">)</span><span class="op" id="8049411">;</span>&nbsp;<span class="ident" id="8049413">ok</span>&nbsp;<span class="op" id="8049416">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049422">if</span>&nbsp;<span class="ident" id="8049425">ct</span>&nbsp;<span class="op" id="8049428">&lt;</span>&nbsp;<span class="num" id="8049430">3</span>&nbsp;<span class="op" id="8049432">&amp;&amp;</span>&nbsp;<span class="ident" id="8049435">oe</span><span class="op" id="8049437">.</span><span class="ident" id="8049438">Temporary</span><span class="op" id="8049447">(</span><span class="op" id="8049448">)</span>&nbsp;<span class="op" id="8049450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8049457">ct</span><span class="op" id="8049459">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049467">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8049480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8049485">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049490">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8049498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8049501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8049504">c</span><span class="op" id="8049505">.</span><span class="ident" id="8049506">Close</span><span class="op" id="8049511">(</span><span class="op" id="8049512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8049515">done</span>&nbsp;<span class="op" id="8049520">&lt;-</span>&nbsp;<span class="ident" id="8049523">rcvd</span><br>
<span class="lineno">45</span><span class="op" id="8049528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8049531">var</span>&nbsp;<span class="ident" id="8049535">crashy</span>&nbsp;<span class="op" id="8049542">=</span>&nbsp;<span class="builtintype" id="8049544">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8049551">func</span>&nbsp;<span class="ident" id="8049556">runStreamSyslog</span><span class="op" id="8049571">(</span><span class="ident" id="8049572">l</span>&nbsp;<span class="ident" id="8049574">net</span><span class="op" id="8049577">.</span><span class="ident" id="8049578">Listener</span><span class="op" id="8049586">,</span>&nbsp;<span class="ident" id="8049588">done</span>&nbsp;<span class="keyword" id="8049593">chan</span><span class="op" id="8049597">&lt;-</span>&nbsp;<span class="builtintype" id="8049600">string</span><span class="op" id="8049606">,</span>&nbsp;<span class="ident" id="8049608">wg</span>&nbsp;<span class="op" id="8049611">*</span><span class="ident" id="8049612">sync</span><span class="op" id="8049616">.</span><span class="ident" id="8049617">WaitGroup</span><span class="op" id="8049626">)</span>&nbsp;<span class="op" id="8049628">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049631">for</span>&nbsp;<span class="op" id="8049635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049639">var</span>&nbsp;<span class="ident" id="8049643">c</span>&nbsp;<span class="ident" id="8049645">net</span><span class="op" id="8049648">.</span><span class="ident" id="8049649">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049656">var</span>&nbsp;<span class="ident" id="8049660">err</span>&nbsp;<span class="builtintype" id="8049664">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049672">if</span>&nbsp;<span class="ident" id="8049675">c</span><span class="op" id="8049676">,</span>&nbsp;<span class="ident" id="8049678">err</span>&nbsp;<span class="op" id="8049682">=</span>&nbsp;<span class="ident" id="8049684">l</span><span class="op" id="8049685">.</span><span class="ident" id="8049686">Accept</span><span class="op" id="8049692">(</span><span class="op" id="8049693">)</span><span class="op" id="8049694">;</span>&nbsp;<span class="ident" id="8049696">err</span>&nbsp;<span class="op" id="8049700">!=</span>&nbsp;<span class="builtintype" id="8049703">nil</span>&nbsp;<span class="op" id="8049707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049712">return</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8049721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8049725">wg</span><span class="op" id="8049727">.</span><span class="ident" id="8049728">Add</span><span class="op" id="8049731">(</span><span class="num" id="8049732">1</span><span class="op" id="8049733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049737">go</span>&nbsp;<span class="keyword" id="8049740">func</span><span class="op" id="8049744">(</span><span class="ident" id="8049745">c</span>&nbsp;<span class="ident" id="8049747">net</span><span class="op" id="8049750">.</span><span class="ident" id="8049751">Conn</span><span class="op" id="8049755">)</span>&nbsp;<span class="op" id="8049757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049762">defer</span>&nbsp;<span class="ident" id="8049768">wg</span><span class="op" id="8049770">.</span><span class="ident" id="8049771">Done</span><span class="op" id="8049775">(</span><span class="op" id="8049776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8049781">c</span><span class="op" id="8049782">.</span><span class="ident" id="8049783">SetReadDeadline</span><span class="op" id="8049798">(</span><span class="ident" id="8049799">time</span><span class="op" id="8049803">.</span><span class="ident" id="8049804">Now</span><span class="op" id="8049807">(</span><span class="op" id="8049808">)</span><span class="op" id="8049809">.</span><span class="ident" id="8049810">Add</span><span class="op" id="8049813">(</span><span class="num" id="8049814">5</span>&nbsp;<span class="op" id="8049816">*</span>&nbsp;<span class="ident" id="8049818">time</span><span class="op" id="8049822">.</span><span class="ident" id="8049823">Second</span><span class="op" id="8049829">)</span><span class="op" id="8049830">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8049835">b</span>&nbsp;<span class="op" id="8049837">:=</span>&nbsp;<span class="ident" id="8049840">bufio</span><span class="op" id="8049845">.</span><span class="ident" id="8049846">NewReader</span><span class="op" id="8049855">(</span><span class="ident" id="8049856">c</span><span class="op" id="8049857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049862">for</span>&nbsp;<span class="ident" id="8049866">ct</span>&nbsp;<span class="op" id="8049869">:=</span>&nbsp;<span class="num" id="8049872">1</span><span class="op" id="8049873">;</span>&nbsp;<span class="op" id="8049875">!</span><span class="ident" id="8049876">crashy</span>&nbsp;<span class="op" id="8049883">||</span>&nbsp;<span class="ident" id="8049886">ct</span><span class="op" id="8049888">&amp;</span><span class="num" id="8049889">7</span>&nbsp;<span class="op" id="8049891">!=</span>&nbsp;<span class="num" id="8049894">0</span><span class="op" id="8049895">;</span>&nbsp;<span class="ident" id="8049897">ct</span><span class="op" id="8049899">++</span>&nbsp;<span class="op" id="8049902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8049908">s</span><span class="op" id="8049909">,</span>&nbsp;<span class="ident" id="8049911">err</span>&nbsp;<span class="op" id="8049915">:=</span>&nbsp;<span class="ident" id="8049918">b</span><span class="op" id="8049919">.</span><span class="ident" id="8049920">ReadString</span><span class="op" id="8049930">(</span><span class="string" id="8049931">&#39;\n&#39;</span><span class="op" id="8049935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049941">if</span>&nbsp;<span class="ident" id="8049944">err</span>&nbsp;<span class="op" id="8049948">!=</span>&nbsp;<span class="builtintype" id="8049951">nil</span>&nbsp;<span class="op" id="8049955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8049962">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8049972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8049978">done</span>&nbsp;<span class="op" id="8049983">&lt;-</span>&nbsp;<span class="ident" id="8049986">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8049991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8049996">c</span><span class="op" id="8049997">.</span><span class="ident" id="8049998">Close</span><span class="op" id="8050003">(</span><span class="op" id="8050004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8050008">}</span><span class="op" id="8050009">(</span><span class="ident" id="8050010">c</span><span class="op" id="8050011">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8050014">}</span><br>
<span class="lineno"></span><span class="op" id="8050016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8050019">func</span>&nbsp;<span class="ident" id="8050024">startServer</span><span class="op" id="8050035">(</span><span class="ident" id="8050036">n</span><span class="op" id="8050037">,</span>&nbsp;<span class="ident" id="8050039">la</span>&nbsp;<span class="builtintype" id="8050042">string</span><span class="op" id="8050048">,</span>&nbsp;<span class="ident" id="8050050">done</span>&nbsp;<span class="keyword" id="8050055">chan</span><span class="op" id="8050059">&lt;-</span>&nbsp;<span class="builtintype" id="8050062">string</span><span class="op" id="8050068">)</span>&nbsp;<span class="op" id="8050070">(</span><span class="ident" id="8050071">addr</span>&nbsp;<span class="builtintype" id="8050076">string</span><span class="op" id="8050082">,</span>&nbsp;<span class="ident" id="8050084">sock</span>&nbsp;<span class="ident" id="8050089">io</span><span class="op" id="8050091">.</span><span class="ident" id="8050092">Closer</span><span class="op" id="8050098">,</span>&nbsp;<span class="ident" id="8050100">wg</span>&nbsp;<span class="op" id="8050103">*</span><span class="ident" id="8050104">sync</span><span class="op" id="8050108">.</span><span class="ident" id="8050109">WaitGroup</span><span class="op" id="8050118">)</span>&nbsp;<span class="op" id="8050120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8050123">if</span>&nbsp;<span class="ident" id="8050126">n</span>&nbsp;<span class="op" id="8050128">==</span>&nbsp;<span class="string" id="8050131">&#34;udp&#34;</span>&nbsp;<span class="op" id="8050137">||</span>&nbsp;<span class="ident" id="8050140">n</span>&nbsp;<span class="op" id="8050142">==</span>&nbsp;<span class="string" id="8050145">&#34;tcp&#34;</span>&nbsp;<span class="op" id="8050151">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050155">la</span>&nbsp;<span class="op" id="8050158">=</span>&nbsp;<span class="string" id="8050160">&#34;127.0.0.1:0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8050175">}</span>&nbsp;<span class="keyword" id="8050177">else</span>&nbsp;<span class="op" id="8050182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8050186">//&nbsp;unix&nbsp;and&nbsp;unixgram:&nbsp;choose&nbsp;an&nbsp;address&nbsp;if&nbsp;none&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8050242">if</span>&nbsp;<span class="ident" id="8050245">la</span>&nbsp;<span class="op" id="8050248">==</span>&nbsp;<span class="string" id="8050251">&#34;&#34;</span>&nbsp;<span class="op" id="8050254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8050259">//&nbsp;use&nbsp;ioutil.TempFile&nbsp;to&nbsp;get&nbsp;a&nbsp;name&nbsp;that&nbsp;is&nbsp;unique</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050314">f</span><span class="op" id="8050315">,</span>&nbsp;<span class="ident" id="8050317">err</span>&nbsp;<span class="op" id="8050321">:=</span>&nbsp;<span class="ident" id="8050324">ioutil</span><span class="op" id="8050330">.</span><span class="ident" id="8050331">TempFile</span><span class="op" id="8050339">(</span><span class="string" id="8050340">&#34;&#34;</span><span class="op" id="8050342">,</span>&nbsp;<span class="string" id="8050344">&#34;syslogtest&#34;</span><span class="op" id="8050356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8050361">if</span>&nbsp;<span class="ident" id="8050364">err</span>&nbsp;<span class="op" id="8050368">!=</span>&nbsp;<span class="builtintype" id="8050371">nil</span>&nbsp;<span class="op" id="8050375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050381">log</span><span class="op" id="8050384">.</span><span class="ident" id="8050385">Fatal</span><span class="op" id="8050390">(</span><span class="string" id="8050391">&#34;TempFile:&nbsp;&#34;</span><span class="op" id="8050403">,</span>&nbsp;<span class="ident" id="8050405">err</span><span class="op" id="8050408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8050413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050418">f</span><span class="op" id="8050419">.</span><span class="ident" id="8050420">Close</span><span class="op" id="8050425">(</span><span class="op" id="8050426">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050431">la</span>&nbsp;<span class="op" id="8050434">=</span>&nbsp;<span class="ident" id="8050436">f</span><span class="op" id="8050437">.</span><span class="ident" id="8050438">Name</span><span class="op" id="8050442">(</span><span class="op" id="8050443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8050447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050451">os</span><span class="op" id="8050453">.</span><span class="ident" id="8050454">Remove</span><span class="op" id="8050460">(</span><span class="ident" id="8050461">la</span><span class="op" id="8050463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8050466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050470">wg</span>&nbsp;<span class="op" id="8050473">=</span>&nbsp;<span class="builtinfunc" id="8050475">new</span><span class="op" id="8050478">(</span><span class="ident" id="8050479">sync</span><span class="op" id="8050483">.</span><span class="ident" id="8050484">WaitGroup</span><span class="op" id="8050493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8050496">if</span>&nbsp;<span class="ident" id="8050499">n</span>&nbsp;<span class="op" id="8050501">==</span>&nbsp;<span class="string" id="8050504">&#34;udp&#34;</span>&nbsp;<span class="op" id="8050510">||</span>&nbsp;<span class="ident" id="8050513">n</span>&nbsp;<span class="op" id="8050515">==</span>&nbsp;<span class="string" id="8050518">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="8050529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050533">l</span><span class="op" id="8050534">,</span>&nbsp;<span class="ident" id="8050536">e</span>&nbsp;<span class="op" id="8050538">:=</span>&nbsp;<span class="ident" id="8050541">net</span><span class="op" id="8050544">.</span><span class="ident" id="8050545">ListenPacket</span><span class="op" id="8050557">(</span><span class="ident" id="8050558">n</span><span class="op" id="8050559">,</span>&nbsp;<span class="ident" id="8050561">la</span><span class="op" id="8050563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8050567">if</span>&nbsp;<span class="ident" id="8050570">e</span>&nbsp;<span class="op" id="8050572">!=</span>&nbsp;<span class="builtintype" id="8050575">nil</span>&nbsp;<span class="op" id="8050579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050584">log</span><span class="op" id="8050587">.</span><span class="ident" id="8050588">Fatalf</span><span class="op" id="8050594">(</span><span class="string" id="8050595">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8050619">,</span>&nbsp;<span class="ident" id="8050621">e</span><span class="op" id="8050622">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8050626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050630">addr</span>&nbsp;<span class="op" id="8050635">=</span>&nbsp;<span class="ident" id="8050637">l</span><span class="op" id="8050638">.</span><span class="ident" id="8050639">LocalAddr</span><span class="op" id="8050648">(</span><span class="op" id="8050649">)</span><span class="op" id="8050650">.</span><span class="ident" id="8050651">String</span><span class="op" id="8050657">(</span><span class="op" id="8050658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050662">sock</span>&nbsp;<span class="op" id="8050667">=</span>&nbsp;<span class="ident" id="8050669">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050673">wg</span><span class="op" id="8050675">.</span><span class="ident" id="8050676">Add</span><span class="op" id="8050679">(</span><span class="num" id="8050680">1</span><span class="op" id="8050681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8050685">go</span>&nbsp;<span class="keyword" id="8050688">func</span><span class="op" id="8050692">(</span><span class="op" id="8050693">)</span>&nbsp;<span class="op" id="8050695">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8050700">defer</span>&nbsp;<span class="ident" id="8050706">wg</span><span class="op" id="8050708">.</span><span class="ident" id="8050709">Done</span><span class="op" id="8050713">(</span><span class="op" id="8050714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050719">runPktSyslog</span><span class="op" id="8050731">(</span><span class="ident" id="8050732">l</span><span class="op" id="8050733">,</span>&nbsp;<span class="ident" id="8050735">done</span><span class="op" id="8050739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8050743">}</span><span class="op" id="8050744">(</span><span class="op" id="8050745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8050748">}</span>&nbsp;<span class="keyword" id="8050750">else</span>&nbsp;<span class="op" id="8050755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050759">l</span><span class="op" id="8050760">,</span>&nbsp;<span class="ident" id="8050762">e</span>&nbsp;<span class="op" id="8050764">:=</span>&nbsp;<span class="ident" id="8050767">net</span><span class="op" id="8050770">.</span><span class="ident" id="8050771">Listen</span><span class="op" id="8050777">(</span><span class="ident" id="8050778">n</span><span class="op" id="8050779">,</span>&nbsp;<span class="ident" id="8050781">la</span><span class="op" id="8050783">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8050787">if</span>&nbsp;<span class="ident" id="8050790">e</span>&nbsp;<span class="op" id="8050792">!=</span>&nbsp;<span class="builtintype" id="8050795">nil</span>&nbsp;<span class="op" id="8050799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050804">log</span><span class="op" id="8050807">.</span><span class="ident" id="8050808">Fatalf</span><span class="op" id="8050814">(</span><span class="string" id="8050815">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8050839">,</span>&nbsp;<span class="ident" id="8050841">e</span><span class="op" id="8050842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8050846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050850">addr</span>&nbsp;<span class="op" id="8050855">=</span>&nbsp;<span class="ident" id="8050857">l</span><span class="op" id="8050858">.</span><span class="ident" id="8050859">Addr</span><span class="op" id="8050863">(</span><span class="op" id="8050864">)</span><span class="op" id="8050865">.</span><span class="ident" id="8050866">String</span><span class="op" id="8050872">(</span><span class="op" id="8050873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050877">sock</span>&nbsp;<span class="op" id="8050882">=</span>&nbsp;<span class="ident" id="8050884">l</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050888">wg</span><span class="op" id="8050890">.</span><span class="ident" id="8050891">Add</span><span class="op" id="8050894">(</span><span class="num" id="8050895">1</span><span class="op" id="8050896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8050900">go</span>&nbsp;<span class="keyword" id="8050903">func</span><span class="op" id="8050907">(</span><span class="op" id="8050908">)</span>&nbsp;<span class="op" id="8050910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8050915">defer</span>&nbsp;<span class="ident" id="8050921">wg</span><span class="op" id="8050923">.</span><span class="ident" id="8050924">Done</span><span class="op" id="8050928">(</span><span class="op" id="8050929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8050934">runStreamSyslog</span><span class="op" id="8050949">(</span><span class="ident" id="8050950">l</span><span class="op" id="8050951">,</span>&nbsp;<span class="ident" id="8050953">done</span><span class="op" id="8050957">,</span>&nbsp;<span class="ident" id="8050959">wg</span><span class="op" id="8050961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8050965">}</span><span class="op" id="8050966">(</span><span class="op" id="8050967">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8050970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8050973">return</span><br>
<span class="lineno"></span><span class="op" id="8050980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8050983">func</span>&nbsp;<span class="ident" id="8050988">TestWithSimulated</span><span class="op" id="8051005">(</span><span class="ident" id="8051006">t</span>&nbsp;<span class="op" id="8051008">*</span><span class="ident" id="8051009">testing</span><span class="op" id="8051016">.</span><span class="ident" id="8051017">T</span><span class="op" id="8051018">)</span>&nbsp;<span class="op" id="8051020">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051023">msg</span>&nbsp;<span class="op" id="8051027">:=</span>&nbsp;<span class="string" id="8051030">&#34;Test&nbsp;123&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051042">transport</span>&nbsp;<span class="op" id="8051052">:=</span>&nbsp;<span class="op" id="8051055">[</span><span class="op" id="8051056">]</span><span class="builtintype" id="8051057">string</span><span class="op" id="8051063">{</span><span class="string" id="8051064">&#34;unix&#34;</span><span class="op" id="8051070">,</span>&nbsp;<span class="string" id="8051072">&#34;unixgram&#34;</span><span class="op" id="8051082">,</span>&nbsp;<span class="string" id="8051084">&#34;udp&#34;</span><span class="op" id="8051089">,</span>&nbsp;<span class="string" id="8051091">&#34;tcp&#34;</span><span class="op" id="8051096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8051100">for</span>&nbsp;<span class="ident" id="8051104">_</span><span class="op" id="8051105">,</span>&nbsp;<span class="ident" id="8051107">tr</span>&nbsp;<span class="op" id="8051110">:=</span>&nbsp;<span class="keyword" id="8051113">range</span>&nbsp;<span class="ident" id="8051119">transport</span>&nbsp;<span class="op" id="8051129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051133">done</span>&nbsp;<span class="op" id="8051138">:=</span>&nbsp;<span class="builtinfunc" id="8051141">make</span><span class="op" id="8051145">(</span><span class="keyword" id="8051146">chan</span>&nbsp;<span class="builtintype" id="8051151">string</span><span class="op" id="8051157">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051161">addr</span><span class="op" id="8051165">,</span>&nbsp;<span class="ident" id="8051167">sock</span><span class="op" id="8051171">,</span>&nbsp;<span class="ident" id="8051173">srvWG</span>&nbsp;<span class="op" id="8051179">:=</span>&nbsp;<span class="ident" id="8051182">startServer</span><span class="op" id="8051193">(</span><span class="ident" id="8051194">tr</span><span class="op" id="8051196">,</span>&nbsp;<span class="string" id="8051198">&#34;&#34;</span><span class="op" id="8051200">,</span>&nbsp;<span class="ident" id="8051202">done</span><span class="op" id="8051206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8051210">defer</span>&nbsp;<span class="ident" id="8051216">srvWG</span><span class="op" id="8051221">.</span><span class="ident" id="8051222">Wait</span><span class="op" id="8051226">(</span><span class="op" id="8051227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8051231">defer</span>&nbsp;<span class="ident" id="8051237">sock</span><span class="op" id="8051241">.</span><span class="ident" id="8051242">Close</span><span class="op" id="8051247">(</span><span class="op" id="8051248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8051252">if</span>&nbsp;<span class="ident" id="8051255">tr</span>&nbsp;<span class="op" id="8051258">==</span>&nbsp;<span class="string" id="8051261">&#34;unix&#34;</span>&nbsp;<span class="op" id="8051268">||</span>&nbsp;<span class="ident" id="8051271">tr</span>&nbsp;<span class="op" id="8051274">==</span>&nbsp;<span class="string" id="8051277">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="8051288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8051293">defer</span>&nbsp;<span class="ident" id="8051299">os</span><span class="op" id="8051301">.</span><span class="ident" id="8051302">Remove</span><span class="op" id="8051308">(</span><span class="ident" id="8051309">addr</span><span class="op" id="8051313">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8051317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051321">s</span><span class="op" id="8051322">,</span>&nbsp;<span class="ident" id="8051324">err</span>&nbsp;<span class="op" id="8051328">:=</span>&nbsp;<span class="ident" id="8051331">Dial</span><span class="op" id="8051335">(</span><span class="ident" id="8051336">tr</span><span class="op" id="8051338">,</span>&nbsp;<span class="ident" id="8051340">addr</span><span class="op" id="8051344">,</span>&nbsp;<span class="ident" id="8051346">LOG_INFO</span><span class="op" id="8051354">|</span><span class="ident" id="8051355">LOG_USER</span><span class="op" id="8051363">,</span>&nbsp;<span class="string" id="8051365">&#34;syslog_test&#34;</span><span class="op" id="8051378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8051382">if</span>&nbsp;<span class="ident" id="8051385">err</span>&nbsp;<span class="op" id="8051389">!=</span>&nbsp;<span class="builtintype" id="8051392">nil</span>&nbsp;<span class="op" id="8051396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051401">t</span><span class="op" id="8051402">.</span><span class="ident" id="8051403">Fatalf</span><span class="op" id="8051409">(</span><span class="string" id="8051410">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8051429">,</span>&nbsp;<span class="ident" id="8051431">err</span><span class="op" id="8051434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8051438">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051442">err</span>&nbsp;<span class="op" id="8051446">=</span>&nbsp;<span class="ident" id="8051448">s</span><span class="op" id="8051449">.</span><span class="ident" id="8051450">Info</span><span class="op" id="8051454">(</span><span class="ident" id="8051455">msg</span><span class="op" id="8051458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8051462">if</span>&nbsp;<span class="ident" id="8051465">err</span>&nbsp;<span class="op" id="8051469">!=</span>&nbsp;<span class="builtintype" id="8051472">nil</span>&nbsp;<span class="op" id="8051476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051481">t</span><span class="op" id="8051482">.</span><span class="ident" id="8051483">Fatalf</span><span class="op" id="8051489">(</span><span class="string" id="8051490">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8051506">,</span>&nbsp;<span class="ident" id="8051508">err</span><span class="op" id="8051511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8051515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051519">check</span><span class="op" id="8051524">(</span><span class="ident" id="8051525">t</span><span class="op" id="8051526">,</span>&nbsp;<span class="ident" id="8051528">msg</span><span class="op" id="8051531">,</span>&nbsp;<span class="op" id="8051533">&lt;-</span><span class="ident" id="8051535">done</span><span class="op" id="8051539">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051543">s</span><span class="op" id="8051544">.</span><span class="ident" id="8051545">Close</span><span class="op" id="8051550">(</span><span class="op" id="8051551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8051554">}</span><br>
<span class="lineno"></span><span class="op" id="8051556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8051559">func</span>&nbsp;<span class="ident" id="8051564">TestFlap</span><span class="op" id="8051572">(</span><span class="ident" id="8051573">t</span>&nbsp;<span class="op" id="8051575">*</span><span class="ident" id="8051576">testing</span><span class="op" id="8051583">.</span><span class="ident" id="8051584">T</span><span class="op" id="8051585">)</span>&nbsp;<span class="op" id="8051587">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051590">net</span>&nbsp;<span class="op" id="8051594">:=</span>&nbsp;<span class="string" id="8051597">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051605">done</span>&nbsp;<span class="op" id="8051610">:=</span>&nbsp;<span class="builtinfunc" id="8051613">make</span><span class="op" id="8051617">(</span><span class="keyword" id="8051618">chan</span>&nbsp;<span class="builtintype" id="8051623">string</span><span class="op" id="8051629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051632">addr</span><span class="op" id="8051636">,</span>&nbsp;<span class="ident" id="8051638">sock</span><span class="op" id="8051642">,</span>&nbsp;<span class="ident" id="8051644">srvWG</span>&nbsp;<span class="op" id="8051650">:=</span>&nbsp;<span class="ident" id="8051653">startServer</span><span class="op" id="8051664">(</span><span class="ident" id="8051665">net</span><span class="op" id="8051668">,</span>&nbsp;<span class="string" id="8051670">&#34;&#34;</span><span class="op" id="8051672">,</span>&nbsp;<span class="ident" id="8051674">done</span><span class="op" id="8051678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8051681">defer</span>&nbsp;<span class="ident" id="8051687">srvWG</span><span class="op" id="8051692">.</span><span class="ident" id="8051693">Wait</span><span class="op" id="8051697">(</span><span class="op" id="8051698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8051701">defer</span>&nbsp;<span class="ident" id="8051707">os</span><span class="op" id="8051709">.</span><span class="ident" id="8051710">Remove</span><span class="op" id="8051716">(</span><span class="ident" id="8051717">addr</span><span class="op" id="8051721">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8051724">defer</span>&nbsp;<span class="ident" id="8051730">sock</span><span class="op" id="8051734">.</span><span class="ident" id="8051735">Close</span><span class="op" id="8051740">(</span><span class="op" id="8051741">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051745">s</span><span class="op" id="8051746">,</span>&nbsp;<span class="ident" id="8051748">err</span>&nbsp;<span class="op" id="8051752">:=</span>&nbsp;<span class="ident" id="8051755">Dial</span><span class="op" id="8051759">(</span><span class="ident" id="8051760">net</span><span class="op" id="8051763">,</span>&nbsp;<span class="ident" id="8051765">addr</span><span class="op" id="8051769">,</span>&nbsp;<span class="ident" id="8051771">LOG_INFO</span><span class="op" id="8051779">|</span><span class="ident" id="8051780">LOG_USER</span><span class="op" id="8051788">,</span>&nbsp;<span class="string" id="8051790">&#34;syslog_test&#34;</span><span class="op" id="8051803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8051806">if</span>&nbsp;<span class="ident" id="8051809">err</span>&nbsp;<span class="op" id="8051813">!=</span>&nbsp;<span class="builtintype" id="8051816">nil</span>&nbsp;<span class="op" id="8051820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051824">t</span><span class="op" id="8051825">.</span><span class="ident" id="8051826">Fatalf</span><span class="op" id="8051832">(</span><span class="string" id="8051833">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8051852">,</span>&nbsp;<span class="ident" id="8051854">err</span><span class="op" id="8051857">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8051860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051863">msg</span>&nbsp;<span class="op" id="8051867">:=</span>&nbsp;<span class="string" id="8051870">&#34;Moo&nbsp;2&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051879">err</span>&nbsp;<span class="op" id="8051883">=</span>&nbsp;<span class="ident" id="8051885">s</span><span class="op" id="8051886">.</span><span class="ident" id="8051887">Info</span><span class="op" id="8051891">(</span><span class="ident" id="8051892">msg</span><span class="op" id="8051895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8051898">if</span>&nbsp;<span class="ident" id="8051901">err</span>&nbsp;<span class="op" id="8051905">!=</span>&nbsp;<span class="builtintype" id="8051908">nil</span>&nbsp;<span class="op" id="8051912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051916">t</span><span class="op" id="8051917">.</span><span class="ident" id="8051918">Fatalf</span><span class="op" id="8051924">(</span><span class="string" id="8051925">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8051941">,</span>&nbsp;<span class="ident" id="8051943">err</span><span class="op" id="8051946">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8051949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051952">check</span><span class="op" id="8051957">(</span><span class="ident" id="8051958">t</span><span class="op" id="8051959">,</span>&nbsp;<span class="ident" id="8051961">msg</span><span class="op" id="8051964">,</span>&nbsp;<span class="op" id="8051966">&lt;-</span><span class="ident" id="8051968">done</span><span class="op" id="8051972">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8051976">//&nbsp;restart&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8051999">_</span><span class="op" id="8052000">,</span>&nbsp;<span class="ident" id="8052002">sock2</span><span class="op" id="8052007">,</span>&nbsp;<span class="ident" id="8052009">srvWG2</span>&nbsp;<span class="op" id="8052016">:=</span>&nbsp;<span class="ident" id="8052019">startServer</span><span class="op" id="8052030">(</span><span class="ident" id="8052031">net</span><span class="op" id="8052034">,</span>&nbsp;<span class="ident" id="8052036">addr</span><span class="op" id="8052040">,</span>&nbsp;<span class="ident" id="8052042">done</span><span class="op" id="8052046">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8052049">defer</span>&nbsp;<span class="ident" id="8052055">srvWG2</span><span class="op" id="8052061">.</span><span class="ident" id="8052062">Wait</span><span class="op" id="8052066">(</span><span class="op" id="8052067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8052070">defer</span>&nbsp;<span class="ident" id="8052076">sock2</span><span class="op" id="8052081">.</span><span class="ident" id="8052082">Close</span><span class="op" id="8052087">(</span><span class="op" id="8052088">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8052092">//&nbsp;and&nbsp;try&nbsp;retransmitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052119">msg</span>&nbsp;<span class="op" id="8052123">=</span>&nbsp;<span class="string" id="8052125">&#34;Moo&nbsp;3&#34;</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052134">err</span>&nbsp;<span class="op" id="8052138">=</span>&nbsp;<span class="ident" id="8052140">s</span><span class="op" id="8052141">.</span><span class="ident" id="8052142">Info</span><span class="op" id="8052146">(</span><span class="ident" id="8052147">msg</span><span class="op" id="8052150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8052153">if</span>&nbsp;<span class="ident" id="8052156">err</span>&nbsp;<span class="op" id="8052160">!=</span>&nbsp;<span class="builtintype" id="8052163">nil</span>&nbsp;<span class="op" id="8052167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052171">t</span><span class="op" id="8052172">.</span><span class="ident" id="8052173">Fatalf</span><span class="op" id="8052179">(</span><span class="string" id="8052180">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8052196">,</span>&nbsp;<span class="ident" id="8052198">err</span><span class="op" id="8052201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8052204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052207">check</span><span class="op" id="8052212">(</span><span class="ident" id="8052213">t</span><span class="op" id="8052214">,</span>&nbsp;<span class="ident" id="8052216">msg</span><span class="op" id="8052219">,</span>&nbsp;<span class="op" id="8052221">&lt;-</span><span class="ident" id="8052223">done</span><span class="op" id="8052227">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052231">s</span><span class="op" id="8052232">.</span><span class="ident" id="8052233">Close</span><span class="op" id="8052238">(</span><span class="op" id="8052239">)</span><br>
<span class="lineno"></span><span class="op" id="8052241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8052244">func</span>&nbsp;<span class="ident" id="8052249">TestNew</span><span class="op" id="8052256">(</span><span class="ident" id="8052257">t</span>&nbsp;<span class="op" id="8052259">*</span><span class="ident" id="8052260">testing</span><span class="op" id="8052267">.</span><span class="ident" id="8052268">T</span><span class="op" id="8052269">)</span>&nbsp;<span class="op" id="8052271">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8052274">if</span>&nbsp;<span class="ident" id="8052277">LOG_LOCAL7</span>&nbsp;<span class="op" id="8052288">!=</span>&nbsp;<span class="num" id="8052291">23</span><span class="op" id="8052293">&lt;&lt;</span><span class="num" id="8052295">3</span>&nbsp;<span class="op" id="8052297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052301">t</span><span class="op" id="8052302">.</span><span class="ident" id="8052303">Fatalf</span><span class="op" id="8052309">(</span><span class="string" id="8052310">&#34;LOG_LOCAL7&nbsp;has&nbsp;wrong&nbsp;value&#34;</span><span class="op" id="8052338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8052341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8052344">if</span>&nbsp;<span class="ident" id="8052347">testing</span><span class="op" id="8052354">.</span><span class="ident" id="8052355">Short</span><span class="op" id="8052360">(</span><span class="op" id="8052361">)</span>&nbsp;<span class="op" id="8052363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8052367">//&nbsp;Depends&nbsp;on&nbsp;syslog&nbsp;daemon&nbsp;running,&nbsp;and&nbsp;sometimes&nbsp;it&#39;s&nbsp;not.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052430">t</span><span class="op" id="8052431">.</span><span class="ident" id="8052432">Skip</span><span class="op" id="8052436">(</span><span class="string" id="8052437">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="8052473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8052476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052480">s</span><span class="op" id="8052481">,</span>&nbsp;<span class="ident" id="8052483">err</span>&nbsp;<span class="op" id="8052487">:=</span>&nbsp;<span class="ident" id="8052490">New</span><span class="op" id="8052493">(</span><span class="ident" id="8052494">LOG_INFO</span><span class="op" id="8052502">|</span><span class="ident" id="8052503">LOG_USER</span><span class="op" id="8052511">,</span>&nbsp;<span class="string" id="8052513">&#34;the_tag&#34;</span><span class="op" id="8052522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8052525">if</span>&nbsp;<span class="ident" id="8052528">err</span>&nbsp;<span class="op" id="8052532">!=</span>&nbsp;<span class="builtintype" id="8052535">nil</span>&nbsp;<span class="op" id="8052539">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052543">t</span><span class="op" id="8052544">.</span><span class="ident" id="8052545">Fatalf</span><span class="op" id="8052551">(</span><span class="string" id="8052552">&#34;New()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8052570">,</span>&nbsp;<span class="ident" id="8052572">err</span><span class="op" id="8052575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8052578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8052581">//&nbsp;Don&#39;t&nbsp;send&nbsp;any&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052610">s</span><span class="op" id="8052611">.</span><span class="ident" id="8052612">Close</span><span class="op" id="8052617">(</span><span class="op" id="8052618">)</span><br>
<span class="lineno"></span><span class="op" id="8052620">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="8052623">func</span>&nbsp;<span class="ident" id="8052628">TestNewLogger</span><span class="op" id="8052641">(</span><span class="ident" id="8052642">t</span>&nbsp;<span class="op" id="8052644">*</span><span class="ident" id="8052645">testing</span><span class="op" id="8052652">.</span><span class="ident" id="8052653">T</span><span class="op" id="8052654">)</span>&nbsp;<span class="op" id="8052656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8052659">if</span>&nbsp;<span class="ident" id="8052662">testing</span><span class="op" id="8052669">.</span><span class="ident" id="8052670">Short</span><span class="op" id="8052675">(</span><span class="op" id="8052676">)</span>&nbsp;<span class="op" id="8052678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052682">t</span><span class="op" id="8052683">.</span><span class="ident" id="8052684">Skip</span><span class="op" id="8052688">(</span><span class="string" id="8052689">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="8052725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8052728">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052731">f</span><span class="op" id="8052732">,</span>&nbsp;<span class="ident" id="8052734">err</span>&nbsp;<span class="op" id="8052738">:=</span>&nbsp;<span class="ident" id="8052741">NewLogger</span><span class="op" id="8052750">(</span><span class="ident" id="8052751">LOG_USER</span><span class="op" id="8052759">|</span><span class="ident" id="8052760">LOG_INFO</span><span class="op" id="8052768">,</span>&nbsp;<span class="num" id="8052770">0</span><span class="op" id="8052771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8052774">if</span>&nbsp;<span class="ident" id="8052777">f</span>&nbsp;<span class="op" id="8052779">==</span>&nbsp;<span class="builtintype" id="8052782">nil</span>&nbsp;<span class="op" id="8052786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052790">t</span><span class="op" id="8052791">.</span><span class="ident" id="8052792">Error</span><span class="op" id="8052797">(</span><span class="ident" id="8052798">err</span><span class="op" id="8052801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8052804">}</span><br>
<span class="lineno"></span><span class="op" id="8052806">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="8052809">func</span>&nbsp;<span class="ident" id="8052814">TestDial</span><span class="op" id="8052822">(</span><span class="ident" id="8052823">t</span>&nbsp;<span class="op" id="8052825">*</span><span class="ident" id="8052826">testing</span><span class="op" id="8052833">.</span><span class="ident" id="8052834">T</span><span class="op" id="8052835">)</span>&nbsp;<span class="op" id="8052837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8052840">if</span>&nbsp;<span class="ident" id="8052843">testing</span><span class="op" id="8052850">.</span><span class="ident" id="8052851">Short</span><span class="op" id="8052856">(</span><span class="op" id="8052857">)</span>&nbsp;<span class="op" id="8052859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052863">t</span><span class="op" id="8052864">.</span><span class="ident" id="8052865">Skip</span><span class="op" id="8052869">(</span><span class="string" id="8052870">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="8052906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8052909">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052912">f</span><span class="op" id="8052913">,</span>&nbsp;<span class="ident" id="8052915">err</span>&nbsp;<span class="op" id="8052919">:=</span>&nbsp;<span class="ident" id="8052922">Dial</span><span class="op" id="8052926">(</span><span class="string" id="8052927">&#34;&#34;</span><span class="op" id="8052929">,</span>&nbsp;<span class="string" id="8052931">&#34;&#34;</span><span class="op" id="8052933">,</span>&nbsp;<span class="op" id="8052935">(</span><span class="ident" id="8052936">LOG_LOCAL7</span><span class="op" id="8052946">|</span><span class="ident" id="8052947">LOG_DEBUG</span><span class="op" id="8052956">)</span><span class="op" id="8052957">+</span><span class="num" id="8052958">1</span><span class="op" id="8052959">,</span>&nbsp;<span class="string" id="8052961">&#34;syslog_test&#34;</span><span class="op" id="8052974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8052977">if</span>&nbsp;<span class="ident" id="8052980">f</span>&nbsp;<span class="op" id="8052982">!=</span>&nbsp;<span class="builtintype" id="8052985">nil</span>&nbsp;<span class="op" id="8052989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8052993">t</span><span class="op" id="8052994">.</span><span class="ident" id="8052995">Fatalf</span><span class="op" id="8053001">(</span><span class="string" id="8053002">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="8053036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8053039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8053042">f</span><span class="op" id="8053043">,</span>&nbsp;<span class="ident" id="8053045">err</span>&nbsp;<span class="op" id="8053049">=</span>&nbsp;<span class="ident" id="8053051">Dial</span><span class="op" id="8053055">(</span><span class="string" id="8053056">&#34;&#34;</span><span class="op" id="8053058">,</span>&nbsp;<span class="string" id="8053060">&#34;&#34;</span><span class="op" id="8053062">,</span>&nbsp;<span class="op" id="8053064">-</span><span class="num" id="8053065">1</span><span class="op" id="8053066">,</span>&nbsp;<span class="string" id="8053068">&#34;syslog_test&#34;</span><span class="op" id="8053081">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8053084">if</span>&nbsp;<span class="ident" id="8053087">f</span>&nbsp;<span class="op" id="8053089">!=</span>&nbsp;<span class="builtintype" id="8053092">nil</span>&nbsp;<span class="op" id="8053096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8053100">t</span><span class="op" id="8053101">.</span><span class="ident" id="8053102">Fatalf</span><span class="op" id="8053108">(</span><span class="string" id="8053109">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="8053143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8053146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8053149">l</span><span class="op" id="8053150">,</span>&nbsp;<span class="ident" id="8053152">err</span>&nbsp;<span class="op" id="8053156">:=</span>&nbsp;<span class="ident" id="8053159">Dial</span><span class="op" id="8053163">(</span><span class="string" id="8053164">&#34;&#34;</span><span class="op" id="8053166">,</span>&nbsp;<span class="string" id="8053168">&#34;&#34;</span><span class="op" id="8053170">,</span>&nbsp;<span class="ident" id="8053172">LOG_USER</span><span class="op" id="8053180">|</span><span class="ident" id="8053181">LOG_ERR</span><span class="op" id="8053188">,</span>&nbsp;<span class="string" id="8053190">&#34;syslog_test&#34;</span><span class="op" id="8053203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8053206">if</span>&nbsp;<span class="ident" id="8053209">err</span>&nbsp;<span class="op" id="8053213">!=</span>&nbsp;<span class="builtintype" id="8053216">nil</span>&nbsp;<span class="op" id="8053220">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8053224">t</span><span class="op" id="8053225">.</span><span class="ident" id="8053226">Fatalf</span><span class="op" id="8053232">(</span><span class="string" id="8053233">&#34;Dial()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8053252">,</span>&nbsp;<span class="ident" id="8053254">err</span><span class="op" id="8053257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8053260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8053263">l</span><span class="op" id="8053264">.</span><span class="ident" id="8053265">Close</span><span class="op" id="8053270">(</span><span class="op" id="8053271">)</span><br>
<span class="lineno"></span><span class="op" id="8053273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="8053276">func</span>&nbsp;<span class="ident" id="8053281">check</span><span class="op" id="8053286">(</span><span class="ident" id="8053287">t</span>&nbsp;<span class="op" id="8053289">*</span><span class="ident" id="8053290">testing</span><span class="op" id="8053297">.</span><span class="ident" id="8053298">T</span><span class="op" id="8053299">,</span>&nbsp;<span class="ident" id="8053301">in</span><span class="op" id="8053303">,</span>&nbsp;<span class="ident" id="8053305">out</span>&nbsp;<span class="builtintype" id="8053309">string</span><span class="op" id="8053315">)</span>&nbsp;<span class="op" id="8053317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8053320">tmpl</span>&nbsp;<span class="op" id="8053325">:=</span>&nbsp;<span class="ident" id="8053328">fmt</span><span class="op" id="8053331">.</span><span class="ident" id="8053332">Sprintf</span><span class="op" id="8053339">(</span><span class="string" id="8053340">&#34;&lt;%d&gt;%%s&nbsp;%%s&nbsp;syslog_test[%%d]:&nbsp;%s\n&#34;</span><span class="op" id="8053376">,</span>&nbsp;<span class="ident" id="8053378">LOG_USER</span><span class="op" id="8053386">+</span><span class="ident" id="8053387">LOG_INFO</span><span class="op" id="8053395">,</span>&nbsp;<span class="ident" id="8053397">in</span><span class="op" id="8053399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8053402">if</span>&nbsp;<span class="ident" id="8053405">hostname</span><span class="op" id="8053413">,</span>&nbsp;<span class="ident" id="8053415">err</span>&nbsp;<span class="op" id="8053419">:=</span>&nbsp;<span class="ident" id="8053422">os</span><span class="op" id="8053424">.</span><span class="ident" id="8053425">Hostname</span><span class="op" id="8053433">(</span><span class="op" id="8053434">)</span><span class="op" id="8053435">;</span>&nbsp;<span class="ident" id="8053437">err</span>&nbsp;<span class="op" id="8053441">!=</span>&nbsp;<span class="builtintype" id="8053444">nil</span>&nbsp;<span class="op" id="8053448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8053452">t</span><span class="op" id="8053453">.</span><span class="ident" id="8053454">Error</span><span class="op" id="8053459">(</span><span class="string" id="8053460">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="8053487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8053490">}</span>&nbsp;<span class="keyword" id="8053492">else</span>&nbsp;<span class="op" id="8053497">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8053501">var</span>&nbsp;<span class="ident" id="8053505">parsedHostname</span><span class="op" id="8053519">,</span>&nbsp;<span class="ident" id="8053521">timestamp</span>&nbsp;<span class="builtintype" id="8053531">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8053540">var</span>&nbsp;<span class="ident" id="8053544">pid</span>&nbsp;<span class="builtintype" id="8053548">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8053554">if</span>&nbsp;<span class="ident" id="8053557">n</span><span class="op" id="8053558">,</span>&nbsp;<span class="ident" id="8053560">err</span>&nbsp;<span class="op" id="8053564">:=</span>&nbsp;<span class="ident" id="8053567">fmt</span><span class="op" id="8053570">.</span><span class="ident" id="8053571">Sscanf</span><span class="op" id="8053577">(</span><span class="ident" id="8053578">out</span><span class="op" id="8053581">,</span>&nbsp;<span class="ident" id="8053583">tmpl</span><span class="op" id="8053587">,</span>&nbsp;<span class="op" id="8053589">&amp;</span><span class="ident" id="8053590">timestamp</span><span class="op" id="8053599">,</span>&nbsp;<span class="op" id="8053601">&amp;</span><span class="ident" id="8053602">parsedHostname</span><span class="op" id="8053616">,</span>&nbsp;<span class="op" id="8053618">&amp;</span><span class="ident" id="8053619">pid</span><span class="op" id="8053622">)</span><span class="op" id="8053623">;</span>&nbsp;<span class="ident" id="8053625">n</span>&nbsp;<span class="op" id="8053627">!=</span>&nbsp;<span class="num" id="8053630">3</span>&nbsp;<span class="op" id="8053632">||</span>&nbsp;<span class="ident" id="8053635">err</span>&nbsp;<span class="op" id="8053639">!=</span>&nbsp;<span class="builtintype" id="8053642">nil</span>&nbsp;<span class="op" id="8053646">||</span>&nbsp;<span class="ident" id="8053649">hostname</span>&nbsp;<span class="op" id="8053658">!=</span>&nbsp;<span class="ident" id="8053661">parsedHostname</span>&nbsp;<span class="op" id="8053676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8053681">t</span><span class="op" id="8053682">.</span><span class="ident" id="8053683">Errorf</span><span class="op" id="8053689">(</span><span class="string" id="8053690">&#34;Got&nbsp;%q,&nbsp;does&nbsp;not&nbsp;match&nbsp;template&nbsp;%q&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="8053734">,</span>&nbsp;<span class="ident" id="8053736">out</span><span class="op" id="8053739">,</span>&nbsp;<span class="ident" id="8053741">tmpl</span><span class="op" id="8053745">,</span>&nbsp;<span class="ident" id="8053747">n</span><span class="op" id="8053748">,</span>&nbsp;<span class="ident" id="8053750">err</span><span class="op" id="8053753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8053757">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8053760">}</span><br>
<span class="lineno"></span><span class="op" id="8053762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8053765">func</span>&nbsp;<span class="ident" id="8053770">TestWrite</span><span class="op" id="8053779">(</span><span class="ident" id="8053780">t</span>&nbsp;<span class="op" id="8053782">*</span><span class="ident" id="8053783">testing</span><span class="op" id="8053790">.</span><span class="ident" id="8053791">T</span><span class="op" id="8053792">)</span>&nbsp;<span class="op" id="8053794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8053797">tests</span>&nbsp;<span class="op" id="8053803">:=</span>&nbsp;<span class="op" id="8053806">[</span><span class="op" id="8053807">]</span><span class="keyword" id="8053808">struct</span>&nbsp;<span class="op" id="8053815">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8053819">pri</span>&nbsp;<span class="ident" id="8053823">Priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8053834">pre</span>&nbsp;<span class="builtintype" id="8053838">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8053847">msg</span>&nbsp;<span class="builtintype" id="8053851">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8053860">exp</span>&nbsp;<span class="builtintype" id="8053864">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8053872">}</span><span class="op" id="8053873">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8053877">{</span><span class="ident" id="8053878">LOG_USER</span>&nbsp;<span class="op" id="8053887">|</span>&nbsp;<span class="ident" id="8053889">LOG_ERR</span><span class="op" id="8053896">,</span>&nbsp;<span class="string" id="8053898">&#34;syslog_test&#34;</span><span class="op" id="8053911">,</span>&nbsp;<span class="string" id="8053913">&#34;&#34;</span><span class="op" id="8053915">,</span>&nbsp;<span class="string" id="8053917">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;\n&#34;</span><span class="op" id="8053944">}</span><span class="op" id="8053945">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8053949">{</span><span class="ident" id="8053950">LOG_USER</span>&nbsp;<span class="op" id="8053959">|</span>&nbsp;<span class="ident" id="8053961">LOG_ERR</span><span class="op" id="8053968">,</span>&nbsp;<span class="string" id="8053970">&#34;syslog_test&#34;</span><span class="op" id="8053983">,</span>&nbsp;<span class="string" id="8053985">&#34;write&nbsp;test&#34;</span><span class="op" id="8053997">,</span>&nbsp;<span class="string" id="8053999">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test\n&#34;</span><span class="op" id="8054036">}</span><span class="op" id="8054037">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8054041">//&nbsp;Write&nbsp;should&nbsp;not&nbsp;add&nbsp;\n&nbsp;if&nbsp;there&nbsp;already&nbsp;is&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8054094">{</span><span class="ident" id="8054095">LOG_USER</span>&nbsp;<span class="op" id="8054104">|</span>&nbsp;<span class="ident" id="8054106">LOG_ERR</span><span class="op" id="8054113">,</span>&nbsp;<span class="string" id="8054115">&#34;syslog_test&#34;</span><span class="op" id="8054128">,</span>&nbsp;<span class="string" id="8054130">&#34;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="8054146">,</span>&nbsp;<span class="string" id="8054148">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="8054187">}</span><span class="op" id="8054188">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8054191">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8054195">if</span>&nbsp;<span class="ident" id="8054198">hostname</span><span class="op" id="8054206">,</span>&nbsp;<span class="ident" id="8054208">err</span>&nbsp;<span class="op" id="8054212">:=</span>&nbsp;<span class="ident" id="8054215">os</span><span class="op" id="8054217">.</span><span class="ident" id="8054218">Hostname</span><span class="op" id="8054226">(</span><span class="op" id="8054227">)</span><span class="op" id="8054228">;</span>&nbsp;<span class="ident" id="8054230">err</span>&nbsp;<span class="op" id="8054234">!=</span>&nbsp;<span class="builtintype" id="8054237">nil</span>&nbsp;<span class="op" id="8054241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8054245">t</span><span class="op" id="8054246">.</span><span class="ident" id="8054247">Fatalf</span><span class="op" id="8054253">(</span><span class="string" id="8054254">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="8054281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8054284">}</span>&nbsp;<span class="keyword" id="8054286">else</span>&nbsp;<span class="op" id="8054291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8054295">for</span>&nbsp;<span class="ident" id="8054299">_</span><span class="op" id="8054300">,</span>&nbsp;<span class="ident" id="8054302">test</span>&nbsp;<span class="op" id="8054307">:=</span>&nbsp;<span class="keyword" id="8054310">range</span>&nbsp;<span class="ident" id="8054316">tests</span>&nbsp;<span class="op" id="8054322">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8054327">done</span>&nbsp;<span class="op" id="8054332">:=</span>&nbsp;<span class="builtinfunc" id="8054335">make</span><span class="op" id="8054339">(</span><span class="keyword" id="8054340">chan</span>&nbsp;<span class="builtintype" id="8054345">string</span><span class="op" id="8054351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8054356">addr</span><span class="op" id="8054360">,</span>&nbsp;<span class="ident" id="8054362">sock</span><span class="op" id="8054366">,</span>&nbsp;<span class="ident" id="8054368">srvWG</span>&nbsp;<span class="op" id="8054374">:=</span>&nbsp;<span class="ident" id="8054377">startServer</span><span class="op" id="8054388">(</span><span class="string" id="8054389">&#34;udp&#34;</span><span class="op" id="8054394">,</span>&nbsp;<span class="string" id="8054396">&#34;&#34;</span><span class="op" id="8054398">,</span>&nbsp;<span class="ident" id="8054400">done</span><span class="op" id="8054404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8054409">defer</span>&nbsp;<span class="ident" id="8054415">srvWG</span><span class="op" id="8054420">.</span><span class="ident" id="8054421">Wait</span><span class="op" id="8054425">(</span><span class="op" id="8054426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8054431">defer</span>&nbsp;<span class="ident" id="8054437">sock</span><span class="op" id="8054441">.</span><span class="ident" id="8054442">Close</span><span class="op" id="8054447">(</span><span class="op" id="8054448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8054453">l</span><span class="op" id="8054454">,</span>&nbsp;<span class="ident" id="8054456">err</span>&nbsp;<span class="op" id="8054460">:=</span>&nbsp;<span class="ident" id="8054463">Dial</span><span class="op" id="8054467">(</span><span class="string" id="8054468">&#34;udp&#34;</span><span class="op" id="8054473">,</span>&nbsp;<span class="ident" id="8054475">addr</span><span class="op" id="8054479">,</span>&nbsp;<span class="ident" id="8054481">test</span><span class="op" id="8054485">.</span><span class="ident" id="8054486">pri</span><span class="op" id="8054489">,</span>&nbsp;<span class="ident" id="8054491">test</span><span class="op" id="8054495">.</span><span class="ident" id="8054496">pre</span><span class="op" id="8054499">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8054504">if</span>&nbsp;<span class="ident" id="8054507">err</span>&nbsp;<span class="op" id="8054511">!=</span>&nbsp;<span class="builtintype" id="8054514">nil</span>&nbsp;<span class="op" id="8054518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8054524">t</span><span class="op" id="8054525">.</span><span class="ident" id="8054526">Fatalf</span><span class="op" id="8054532">(</span><span class="string" id="8054533">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8054559">,</span>&nbsp;<span class="ident" id="8054561">err</span><span class="op" id="8054564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8054569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8054574">defer</span>&nbsp;<span class="ident" id="8054580">l</span><span class="op" id="8054581">.</span><span class="ident" id="8054582">Close</span><span class="op" id="8054587">(</span><span class="op" id="8054588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8054593">_</span><span class="op" id="8054594">,</span>&nbsp;<span class="ident" id="8054596">err</span>&nbsp;<span class="op" id="8054600">=</span>&nbsp;<span class="ident" id="8054602">io</span><span class="op" id="8054604">.</span><span class="ident" id="8054605">WriteString</span><span class="op" id="8054616">(</span><span class="ident" id="8054617">l</span><span class="op" id="8054618">,</span>&nbsp;<span class="ident" id="8054620">test</span><span class="op" id="8054624">.</span><span class="ident" id="8054625">msg</span><span class="op" id="8054628">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8054633">if</span>&nbsp;<span class="ident" id="8054636">err</span>&nbsp;<span class="op" id="8054640">!=</span>&nbsp;<span class="builtintype" id="8054643">nil</span>&nbsp;<span class="op" id="8054647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8054653">t</span><span class="op" id="8054654">.</span><span class="ident" id="8054655">Fatalf</span><span class="op" id="8054661">(</span><span class="string" id="8054662">&#34;WriteString()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8054688">,</span>&nbsp;<span class="ident" id="8054690">err</span><span class="op" id="8054693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8054698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8054703">rcvd</span>&nbsp;<span class="op" id="8054708">:=</span>&nbsp;<span class="op" id="8054711">&lt;-</span><span class="ident" id="8054713">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8054721">test</span><span class="op" id="8054725">.</span><span class="ident" id="8054726">exp</span>&nbsp;<span class="op" id="8054730">=</span>&nbsp;<span class="ident" id="8054732">fmt</span><span class="op" id="8054735">.</span><span class="ident" id="8054736">Sprintf</span><span class="op" id="8054743">(</span><span class="string" id="8054744">&#34;&lt;%d&gt;&#34;</span><span class="op" id="8054750">,</span>&nbsp;<span class="ident" id="8054752">test</span><span class="op" id="8054756">.</span><span class="ident" id="8054757">pri</span><span class="op" id="8054760">)</span>&nbsp;<span class="op" id="8054762">+</span>&nbsp;<span class="ident" id="8054764">test</span><span class="op" id="8054768">.</span><span class="ident" id="8054769">exp</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8054776">var</span>&nbsp;<span class="ident" id="8054780">parsedHostname</span><span class="op" id="8054794">,</span>&nbsp;<span class="ident" id="8054796">timestamp</span>&nbsp;<span class="builtintype" id="8054806">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8054816">var</span>&nbsp;<span class="ident" id="8054820">pid</span>&nbsp;<span class="builtintype" id="8054824">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8054831">if</span>&nbsp;<span class="ident" id="8054834">n</span><span class="op" id="8054835">,</span>&nbsp;<span class="ident" id="8054837">err</span>&nbsp;<span class="op" id="8054841">:=</span>&nbsp;<span class="ident" id="8054844">fmt</span><span class="op" id="8054847">.</span><span class="ident" id="8054848">Sscanf</span><span class="op" id="8054854">(</span><span class="ident" id="8054855">rcvd</span><span class="op" id="8054859">,</span>&nbsp;<span class="ident" id="8054861">test</span><span class="op" id="8054865">.</span><span class="ident" id="8054866">exp</span><span class="op" id="8054869">,</span>&nbsp;<span class="op" id="8054871">&amp;</span><span class="ident" id="8054872">timestamp</span><span class="op" id="8054881">,</span>&nbsp;<span class="op" id="8054883">&amp;</span><span class="ident" id="8054884">parsedHostname</span><span class="op" id="8054898">,</span>&nbsp;<span class="op" id="8054900">&amp;</span><span class="ident" id="8054901">pid</span><span class="op" id="8054904">)</span><span class="op" id="8054905">;</span>&nbsp;<span class="ident" id="8054907">n</span>&nbsp;<span class="op" id="8054909">!=</span>&nbsp;<span class="num" id="8054912">3</span>&nbsp;<span class="op" id="8054914">||</span>&nbsp;<span class="ident" id="8054917">err</span>&nbsp;<span class="op" id="8054921">!=</span>&nbsp;<span class="builtintype" id="8054924">nil</span>&nbsp;<span class="op" id="8054928">||</span>&nbsp;<span class="ident" id="8054931">hostname</span>&nbsp;<span class="op" id="8054940">!=</span>&nbsp;<span class="ident" id="8054943">parsedHostname</span>&nbsp;<span class="op" id="8054958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8054964">t</span><span class="op" id="8054965">.</span><span class="ident" id="8054966">Errorf</span><span class="op" id="8054972">(</span><span class="string" id="8054973">&#34;s.Info()&nbsp;=&nbsp;&#39;%q&#39;,&nbsp;didn&#39;t&nbsp;match&nbsp;&#39;%q&#39;&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="8055017">,</span>&nbsp;<span class="ident" id="8055019">rcvd</span><span class="op" id="8055023">,</span>&nbsp;<span class="ident" id="8055025">test</span><span class="op" id="8055029">.</span><span class="ident" id="8055030">exp</span><span class="op" id="8055033">,</span>&nbsp;<span class="ident" id="8055035">n</span><span class="op" id="8055036">,</span>&nbsp;<span class="ident" id="8055038">err</span><span class="op" id="8055041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8055046">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8055050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8055053">}</span><br>
<span class="lineno"></span><span class="op" id="8055055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8055058">func</span>&nbsp;<span class="ident" id="8055063">TestConcurrentWrite</span><span class="op" id="8055082">(</span><span class="ident" id="8055083">t</span>&nbsp;<span class="op" id="8055085">*</span><span class="ident" id="8055086">testing</span><span class="op" id="8055093">.</span><span class="ident" id="8055094">T</span><span class="op" id="8055095">)</span>&nbsp;<span class="op" id="8055097">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8055100">addr</span><span class="op" id="8055104">,</span>&nbsp;<span class="ident" id="8055106">sock</span><span class="op" id="8055110">,</span>&nbsp;<span class="ident" id="8055112">srvWG</span>&nbsp;<span class="op" id="8055118">:=</span>&nbsp;<span class="ident" id="8055121">startServer</span><span class="op" id="8055132">(</span><span class="string" id="8055133">&#34;udp&#34;</span><span class="op" id="8055138">,</span>&nbsp;<span class="string" id="8055140">&#34;&#34;</span><span class="op" id="8055142">,</span>&nbsp;<span class="builtinfunc" id="8055144">make</span><span class="op" id="8055148">(</span><span class="keyword" id="8055149">chan</span>&nbsp;<span class="builtintype" id="8055154">string</span><span class="op" id="8055160">,</span>&nbsp;<span class="num" id="8055162">1</span><span class="op" id="8055163">)</span><span class="op" id="8055164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8055167">defer</span>&nbsp;<span class="ident" id="8055173">srvWG</span><span class="op" id="8055178">.</span><span class="ident" id="8055179">Wait</span><span class="op" id="8055183">(</span><span class="op" id="8055184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8055187">defer</span>&nbsp;<span class="ident" id="8055193">sock</span><span class="op" id="8055197">.</span><span class="ident" id="8055198">Close</span><span class="op" id="8055203">(</span><span class="op" id="8055204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8055207">w</span><span class="op" id="8055208">,</span>&nbsp;<span class="ident" id="8055210">err</span>&nbsp;<span class="op" id="8055214">:=</span>&nbsp;<span class="ident" id="8055217">Dial</span><span class="op" id="8055221">(</span><span class="string" id="8055222">&#34;udp&#34;</span><span class="op" id="8055227">,</span>&nbsp;<span class="ident" id="8055229">addr</span><span class="op" id="8055233">,</span>&nbsp;<span class="ident" id="8055235">LOG_USER</span><span class="op" id="8055243">|</span><span class="ident" id="8055244">LOG_ERR</span><span class="op" id="8055251">,</span>&nbsp;<span class="string" id="8055253">&#34;how&#39;s&nbsp;it&nbsp;going?&#34;</span><span class="op" id="8055270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8055273">if</span>&nbsp;<span class="ident" id="8055276">err</span>&nbsp;<span class="op" id="8055280">!=</span>&nbsp;<span class="builtintype" id="8055283">nil</span>&nbsp;<span class="op" id="8055287">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8055291">t</span><span class="op" id="8055292">.</span><span class="ident" id="8055293">Fatalf</span><span class="op" id="8055299">(</span><span class="string" id="8055300">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8055326">,</span>&nbsp;<span class="ident" id="8055328">err</span><span class="op" id="8055331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8055334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8055337">var</span>&nbsp;<span class="ident" id="8055341">wg</span>&nbsp;<span class="ident" id="8055344">sync</span><span class="op" id="8055348">.</span><span class="ident" id="8055349">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8055360">for</span>&nbsp;<span class="ident" id="8055364">i</span>&nbsp;<span class="op" id="8055366">:=</span>&nbsp;<span class="num" id="8055369">0</span><span class="op" id="8055370">;</span>&nbsp;<span class="ident" id="8055372">i</span>&nbsp;<span class="op" id="8055374">&lt;</span>&nbsp;<span class="num" id="8055376">10</span><span class="op" id="8055378">;</span>&nbsp;<span class="ident" id="8055380">i</span><span class="op" id="8055381">++</span>&nbsp;<span class="op" id="8055384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8055388">wg</span><span class="op" id="8055390">.</span><span class="ident" id="8055391">Add</span><span class="op" id="8055394">(</span><span class="num" id="8055395">1</span><span class="op" id="8055396">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8055400">go</span>&nbsp;<span class="keyword" id="8055403">func</span><span class="op" id="8055407">(</span><span class="op" id="8055408">)</span>&nbsp;<span class="op" id="8055410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8055415">defer</span>&nbsp;<span class="ident" id="8055421">wg</span><span class="op" id="8055423">.</span><span class="ident" id="8055424">Done</span><span class="op" id="8055428">(</span><span class="op" id="8055429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8055434">err</span>&nbsp;<span class="op" id="8055438">:=</span>&nbsp;<span class="ident" id="8055441">w</span><span class="op" id="8055442">.</span><span class="ident" id="8055443">Info</span><span class="op" id="8055447">(</span><span class="string" id="8055448">&#34;test&#34;</span><span class="op" id="8055454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8055459">if</span>&nbsp;<span class="ident" id="8055462">err</span>&nbsp;<span class="op" id="8055466">!=</span>&nbsp;<span class="builtintype" id="8055469">nil</span>&nbsp;<span class="op" id="8055473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8055479">t</span><span class="op" id="8055480">.</span><span class="ident" id="8055481">Errorf</span><span class="op" id="8055487">(</span><span class="string" id="8055488">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8055507">,</span>&nbsp;<span class="ident" id="8055509">err</span><span class="op" id="8055512">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8055518">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8055528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8055532">}</span><span class="op" id="8055533">(</span><span class="op" id="8055534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8055537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8055540">wg</span><span class="op" id="8055542">.</span><span class="ident" id="8055543">Wait</span><span class="op" id="8055547">(</span><span class="op" id="8055548">)</span><br>
<span class="lineno">300</span><span class="op" id="8055550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8055553">func</span>&nbsp;<span class="ident" id="8055558">TestConcurrentReconnect</span><span class="op" id="8055581">(</span><span class="ident" id="8055582">t</span>&nbsp;<span class="op" id="8055584">*</span><span class="ident" id="8055585">testing</span><span class="op" id="8055592">.</span><span class="ident" id="8055593">T</span><span class="op" id="8055594">)</span>&nbsp;<span class="op" id="8055596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8055599">crashy</span>&nbsp;<span class="op" id="8055606">=</span>&nbsp;<span class="builtintype" id="8055608">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8055614">defer</span>&nbsp;<span class="keyword" id="8055620">func</span><span class="op" id="8055624">(</span><span class="op" id="8055625">)</span>&nbsp;<span class="op" id="8055627">{</span>&nbsp;<span class="ident" id="8055629">crashy</span>&nbsp;<span class="op" id="8055636">=</span>&nbsp;<span class="builtintype" id="8055638">false</span>&nbsp;<span class="op" id="8055644">}</span><span class="op" id="8055645">(</span><span class="op" id="8055646">)</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8055650">const</span>&nbsp;<span class="ident" id="8055656">N</span>&nbsp;<span class="op" id="8055658">=</span>&nbsp;<span class="num" id="8055660">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8055664">const</span>&nbsp;<span class="ident" id="8055670">M</span>&nbsp;<span class="op" id="8055672">=</span>&nbsp;<span class="num" id="8055674">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8055679">net</span>&nbsp;<span class="op" id="8055683">:=</span>&nbsp;<span class="string" id="8055686">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8055694">done</span>&nbsp;<span class="op" id="8055699">:=</span>&nbsp;<span class="builtinfunc" id="8055702">make</span><span class="op" id="8055706">(</span><span class="keyword" id="8055707">chan</span>&nbsp;<span class="builtintype" id="8055712">string</span><span class="op" id="8055718">,</span>&nbsp;<span class="ident" id="8055720">N</span><span class="op" id="8055721">*</span><span class="ident" id="8055722">M</span><span class="op" id="8055723">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8055726">addr</span><span class="op" id="8055730">,</span>&nbsp;<span class="ident" id="8055732">sock</span><span class="op" id="8055736">,</span>&nbsp;<span class="ident" id="8055738">srvWG</span>&nbsp;<span class="op" id="8055744">:=</span>&nbsp;<span class="ident" id="8055747">startServer</span><span class="op" id="8055758">(</span><span class="ident" id="8055759">net</span><span class="op" id="8055762">,</span>&nbsp;<span class="string" id="8055764">&#34;&#34;</span><span class="op" id="8055766">,</span>&nbsp;<span class="ident" id="8055768">done</span><span class="op" id="8055772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8055775">defer</span>&nbsp;<span class="ident" id="8055781">os</span><span class="op" id="8055783">.</span><span class="ident" id="8055784">Remove</span><span class="op" id="8055790">(</span><span class="ident" id="8055791">addr</span><span class="op" id="8055795">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8055799">//&nbsp;count&nbsp;all&nbsp;the&nbsp;messages&nbsp;arriving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8055835">count</span>&nbsp;<span class="op" id="8055841">:=</span>&nbsp;<span class="builtinfunc" id="8055844">make</span><span class="op" id="8055848">(</span><span class="keyword" id="8055849">chan</span>&nbsp;<span class="builtintype" id="8055854">int</span><span class="op" id="8055857">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8055860">go</span>&nbsp;<span class="keyword" id="8055863">func</span><span class="op" id="8055867">(</span><span class="op" id="8055868">)</span>&nbsp;<span class="op" id="8055870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8055874">ct</span>&nbsp;<span class="op" id="8055877">:=</span>&nbsp;<span class="num" id="8055880">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8055884">for</span>&nbsp;<span class="keyword" id="8055888">range</span>&nbsp;<span class="ident" id="8055894">done</span>&nbsp;<span class="op" id="8055899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8055904">ct</span><span class="op" id="8055906">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8055912">//&nbsp;we&nbsp;are&nbsp;looking&nbsp;for&nbsp;500&nbsp;out&nbsp;of&nbsp;1000&nbsp;events</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8055960">//&nbsp;here&nbsp;because&nbsp;lots&nbsp;of&nbsp;log&nbsp;messages&nbsp;are&nbsp;lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8056009">//&nbsp;in&nbsp;buffers&nbsp;(kernel&nbsp;and/or&nbsp;bufio)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8056048">if</span>&nbsp;<span class="ident" id="8056051">ct</span>&nbsp;<span class="op" id="8056054">&gt;</span>&nbsp;<span class="ident" id="8056056">N</span><span class="op" id="8056057">*</span><span class="ident" id="8056058">M</span><span class="op" id="8056059">/</span><span class="num" id="8056060">2</span>&nbsp;<span class="op" id="8056062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8056068">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8056077">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8056081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8056085">count</span>&nbsp;<span class="op" id="8056091">&lt;-</span>&nbsp;<span class="ident" id="8056094">ct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8056098">}</span><span class="op" id="8056099">(</span><span class="op" id="8056100">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8056104">var</span>&nbsp;<span class="ident" id="8056108">wg</span>&nbsp;<span class="ident" id="8056111">sync</span><span class="op" id="8056115">.</span><span class="ident" id="8056116">WaitGroup</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8056127">wg</span><span class="op" id="8056129">.</span><span class="ident" id="8056130">Add</span><span class="op" id="8056133">(</span><span class="ident" id="8056134">N</span><span class="op" id="8056135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8056138">for</span>&nbsp;<span class="ident" id="8056142">i</span>&nbsp;<span class="op" id="8056144">:=</span>&nbsp;<span class="num" id="8056147">0</span><span class="op" id="8056148">;</span>&nbsp;<span class="ident" id="8056150">i</span>&nbsp;<span class="op" id="8056152">&lt;</span>&nbsp;<span class="ident" id="8056154">N</span><span class="op" id="8056155">;</span>&nbsp;<span class="ident" id="8056157">i</span><span class="op" id="8056158">++</span>&nbsp;<span class="op" id="8056161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8056165">go</span>&nbsp;<span class="keyword" id="8056168">func</span><span class="op" id="8056172">(</span><span class="op" id="8056173">)</span>&nbsp;<span class="op" id="8056175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8056180">defer</span>&nbsp;<span class="ident" id="8056186">wg</span><span class="op" id="8056188">.</span><span class="ident" id="8056189">Done</span><span class="op" id="8056193">(</span><span class="op" id="8056194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8056199">w</span><span class="op" id="8056200">,</span>&nbsp;<span class="ident" id="8056202">err</span>&nbsp;<span class="op" id="8056206">:=</span>&nbsp;<span class="ident" id="8056209">Dial</span><span class="op" id="8056213">(</span><span class="ident" id="8056214">net</span><span class="op" id="8056217">,</span>&nbsp;<span class="ident" id="8056219">addr</span><span class="op" id="8056223">,</span>&nbsp;<span class="ident" id="8056225">LOG_USER</span><span class="op" id="8056233">|</span><span class="ident" id="8056234">LOG_ERR</span><span class="op" id="8056241">,</span>&nbsp;<span class="string" id="8056243">&#34;tag&#34;</span><span class="op" id="8056248">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8056253">if</span>&nbsp;<span class="ident" id="8056256">err</span>&nbsp;<span class="op" id="8056260">!=</span>&nbsp;<span class="builtintype" id="8056263">nil</span>&nbsp;<span class="op" id="8056267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8056273">t</span><span class="op" id="8056274">.</span><span class="ident" id="8056275">Fatalf</span><span class="op" id="8056281">(</span><span class="string" id="8056282">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8056308">,</span>&nbsp;<span class="ident" id="8056310">err</span><span class="op" id="8056313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8056318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8056323">defer</span>&nbsp;<span class="ident" id="8056329">w</span><span class="op" id="8056330">.</span><span class="ident" id="8056331">Close</span><span class="op" id="8056336">(</span><span class="op" id="8056337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8056342">for</span>&nbsp;<span class="ident" id="8056346">i</span>&nbsp;<span class="op" id="8056348">:=</span>&nbsp;<span class="num" id="8056351">0</span><span class="op" id="8056352">;</span>&nbsp;<span class="ident" id="8056354">i</span>&nbsp;<span class="op" id="8056356">&lt;</span>&nbsp;<span class="ident" id="8056358">M</span><span class="op" id="8056359">;</span>&nbsp;<span class="ident" id="8056361">i</span><span class="op" id="8056362">++</span>&nbsp;<span class="op" id="8056365">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8056371">err</span>&nbsp;<span class="op" id="8056375">:=</span>&nbsp;<span class="ident" id="8056378">w</span><span class="op" id="8056379">.</span><span class="ident" id="8056380">Info</span><span class="op" id="8056384">(</span><span class="string" id="8056385">&#34;test&#34;</span><span class="op" id="8056391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8056397">if</span>&nbsp;<span class="ident" id="8056400">err</span>&nbsp;<span class="op" id="8056404">!=</span>&nbsp;<span class="builtintype" id="8056407">nil</span>&nbsp;<span class="op" id="8056411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8056418">t</span><span class="op" id="8056419">.</span><span class="ident" id="8056420">Errorf</span><span class="op" id="8056426">(</span><span class="string" id="8056427">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8056446">,</span>&nbsp;<span class="ident" id="8056448">err</span><span class="op" id="8056451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8056458">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8056469">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8056474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8056478">}</span><span class="op" id="8056479">(</span><span class="op" id="8056480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8056483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8056486">wg</span><span class="op" id="8056488">.</span><span class="ident" id="8056489">Wait</span><span class="op" id="8056493">(</span><span class="op" id="8056494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8056497">sock</span><span class="op" id="8056501">.</span><span class="ident" id="8056502">Close</span><span class="op" id="8056507">(</span><span class="op" id="8056508">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8056511">srvWG</span><span class="op" id="8056516">.</span><span class="ident" id="8056517">Wait</span><span class="op" id="8056521">(</span><span class="op" id="8056522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8056525">close</span><span class="op" id="8056530">(</span><span class="ident" id="8056531">done</span><span class="op" id="8056535">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8056539">select</span>&nbsp;<span class="op" id="8056546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8056549">case</span>&nbsp;<span class="op" id="8056554">&lt;-</span><span class="ident" id="8056556">count</span><span class="op" id="8056561">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8056564">case</span>&nbsp;<span class="op" id="8056569">&lt;-</span><span class="ident" id="8056571">time</span><span class="op" id="8056575">.</span><span class="ident" id="8056576">After</span><span class="op" id="8056581">(</span><span class="num" id="8056582">100</span>&nbsp;<span class="op" id="8056586">*</span>&nbsp;<span class="ident" id="8056588">time</span><span class="op" id="8056592">.</span><span class="ident" id="8056593">Millisecond</span><span class="op" id="8056604">)</span><span class="op" id="8056605">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8056609">t</span><span class="op" id="8056610">.</span><span class="ident" id="8056611">Error</span><span class="op" id="8056616">(</span><span class="string" id="8056617">&#34;timeout&nbsp;in&nbsp;concurrent&nbsp;reconnect&#34;</span><span class="op" id="8056650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8056653">}</span><br>
<span class="lineno"></span><span class="op" id="8056655">}</span>
</div>
</body>
</html>
