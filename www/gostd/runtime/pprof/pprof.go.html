<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/pprof</h2>
<ul>
<li><a href="/gostd/runtime/pprof/mprof_test.go.html">mprof_test.go</a></li>
<li><a href="/gostd/runtime/pprof/pprof.go.html" class="current">pprof.go</a></li>
<li><a href="/gostd/runtime/pprof/pprof_test.go.html">pprof_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5060434">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5060490">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5060544">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5060595">//&nbsp;Package&nbsp;pprof&nbsp;writes&nbsp;runtime&nbsp;profiling&nbsp;data&nbsp;in&nbsp;the&nbsp;format&nbsp;expected</span><br>
<span class="lineno"></span><span class="comment" id="5060665">//&nbsp;by&nbsp;the&nbsp;pprof&nbsp;visualization&nbsp;tool.</span><br>
<span class="lineno"></span><span class="comment" id="5060701">//&nbsp;For&nbsp;more&nbsp;information&nbsp;about&nbsp;pprof,&nbsp;see</span><br>
<span class="lineno"></span><span class="comment" id="5060742">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="keyword" id="5060789">package</span>&nbsp;<span class="ident" id="5060797">pprof</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5060804">import</span>&nbsp;<span class="op" id="5060811">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5060814">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5060823">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5060832">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5060839">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5060845">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5060856">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5060864">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5060875">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5060883">&#34;text/tabwriter&#34;</span><br>
<span class="lineno"></span><span class="op" id="5060900">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5060903">//&nbsp;BUG(rsc):&nbsp;Profiles&nbsp;are&nbsp;incomplete&nbsp;and&nbsp;inaccurate&nbsp;on&nbsp;NetBSD&nbsp;and&nbsp;OS&nbsp;X.</span><br>
<span class="lineno"></span><span class="comment" id="5060975">//&nbsp;See&nbsp;http://golang.org/issue/6047&nbsp;for&nbsp;details.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="5061025">//&nbsp;A&nbsp;Profile&nbsp;is&nbsp;a&nbsp;collection&nbsp;of&nbsp;stack&nbsp;traces&nbsp;showing&nbsp;the&nbsp;call&nbsp;sequences</span><br>
<span class="lineno"></span><span class="comment" id="5061097">//&nbsp;that&nbsp;led&nbsp;to&nbsp;instances&nbsp;of&nbsp;a&nbsp;particular&nbsp;event,&nbsp;such&nbsp;as&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="comment" id="5061165">//&nbsp;Packages&nbsp;can&nbsp;create&nbsp;and&nbsp;maintain&nbsp;their&nbsp;own&nbsp;profiles;&nbsp;the&nbsp;most&nbsp;common</span><br>
<span class="lineno"></span><span class="comment" id="5061237">//&nbsp;use&nbsp;is&nbsp;for&nbsp;tracking&nbsp;resources&nbsp;that&nbsp;must&nbsp;be&nbsp;explicitly&nbsp;closed,&nbsp;such&nbsp;as&nbsp;files</span><br>
<span class="lineno">30</span><span class="comment" id="5061316">//&nbsp;or&nbsp;network&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="5061343">//</span><br>
<span class="lineno"></span><span class="comment" id="5061346">//&nbsp;A&nbsp;Profile&#39;s&nbsp;methods&nbsp;can&nbsp;be&nbsp;called&nbsp;from&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="5061424">//</span><br>
<span class="lineno"></span><span class="comment" id="5061427">//&nbsp;Each&nbsp;Profile&nbsp;has&nbsp;a&nbsp;unique&nbsp;name.&nbsp;&nbsp;A&nbsp;few&nbsp;profiles&nbsp;are&nbsp;predefined:</span><br>
<span class="lineno">35</span><span class="comment" id="5061494">//</span><br>
<span class="lineno"></span><span class="comment" id="5061497">//&nbsp;&nbsp;&nbsp;&nbspgoroutine&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;current&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="5061554">//&nbsp;&nbsp;&nbsp;&nbspheap&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;a&nbsp;sampling&nbsp;of&nbsp;all&nbsp;heap&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="5061607">//&nbsp;&nbsp;&nbsp;&nbspthreadcreate&nbsp;-&nbsp;stack&nbsp;traces&nbsp;that&nbsp;led&nbsp;to&nbsp;the&nbsp;creation&nbsp;of&nbsp;new&nbsp;OS&nbsp;threads</span><br>
<span class="lineno"></span><span class="comment" id="5061681">//&nbsp;&nbsp;&nbsp;&nbspblock&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;stack&nbsp;traces&nbsp;that&nbsp;led&nbsp;to&nbsp;blocking&nbsp;on&nbsp;synchronization&nbsp;primitives</span><br>
<span class="lineno">40</span><span class="comment" id="5061763">//</span><br>
<span class="lineno"></span><span class="comment" id="5061766">//&nbsp;These&nbsp;predefined&nbsp;profiles&nbsp;maintain&nbsp;themselves&nbsp;and&nbsp;panic&nbsp;on&nbsp;an&nbsp;explicit</span><br>
<span class="lineno"></span><span class="comment" id="5061840">//&nbsp;Add&nbsp;or&nbsp;Remove&nbsp;method&nbsp;call.</span><br>
<span class="lineno"></span><span class="comment" id="5061870">//</span><br>
<span class="lineno"></span><span class="comment" id="5061873">//&nbsp;The&nbsp;CPU&nbsp;profile&nbsp;is&nbsp;not&nbsp;available&nbsp;as&nbsp;a&nbsp;Profile.&nbsp;&nbsp;It&nbsp;has&nbsp;a&nbsp;special&nbsp;API,</span><br>
<span class="lineno">45</span><span class="comment" id="5061946">//&nbsp;the&nbsp;StartCPUProfile&nbsp;and&nbsp;StopCPUProfile&nbsp;functions,&nbsp;because&nbsp;it&nbsp;streams</span><br>
<span class="lineno"></span><span class="comment" id="5062018">//&nbsp;output&nbsp;to&nbsp;a&nbsp;writer&nbsp;during&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="5062058">//</span><br>
<span class="lineno"></span><span class="keyword" id="5062061">type</span>&nbsp;<span class="ident" id="5062066">Profile</span>&nbsp;<span class="keyword" id="5062074">struct</span>&nbsp;<span class="op" id="5062081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062084">name</span>&nbsp;&nbsp;<span class="builtintype" id="5062090">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062098">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5062104">sync</span><span class="op" id="5062108">.</span><span class="ident" id="5062109">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062116">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5062122">map</span><span class="op" id="5062125">[</span><span class="keyword" id="5062126">interface</span><span class="op" id="5062135">{</span><span class="op" id="5062136">}</span><span class="op" id="5062137">]</span><span class="op" id="5062138">[</span><span class="op" id="5062139">]</span><span class="builtintype" id="5062140">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062149">count</span>&nbsp;<span class="keyword" id="5062155">func</span><span class="op" id="5062159">(</span><span class="op" id="5062160">)</span>&nbsp;<span class="builtintype" id="5062162">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062167">write</span>&nbsp;<span class="keyword" id="5062173">func</span><span class="op" id="5062177">(</span><span class="ident" id="5062178">io</span><span class="op" id="5062180">.</span><span class="ident" id="5062181">Writer</span><span class="op" id="5062187">,</span>&nbsp;<span class="builtintype" id="5062189">int</span><span class="op" id="5062192">)</span>&nbsp;<span class="builtintype" id="5062194">error</span><br>
<span class="lineno"></span><span class="op" id="5062200">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="5062203">//&nbsp;profiles&nbsp;records&nbsp;all&nbsp;registered&nbsp;profiles.</span><br>
<span class="lineno"></span><span class="keyword" id="5062248">var</span>&nbsp;<span class="ident" id="5062252">profiles</span>&nbsp;<span class="keyword" id="5062261">struct</span>&nbsp;<span class="op" id="5062268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062271">mu</span>&nbsp;<span class="ident" id="5062274">sync</span><span class="op" id="5062278">.</span><span class="ident" id="5062279">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062286">m</span>&nbsp;&nbsp;<span class="keyword" id="5062289">map</span><span class="op" id="5062292">[</span><span class="builtintype" id="5062293">string</span><span class="op" id="5062299">]</span><span class="op" id="5062300">*</span><span class="ident" id="5062301">Profile</span><br>
<span class="lineno">60</span><span class="op" id="5062309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5062312">var</span>&nbsp;<span class="ident" id="5062316">goroutineProfile</span>&nbsp;<span class="op" id="5062333">=</span>&nbsp;<span class="op" id="5062335">&amp;</span><span class="ident" id="5062336">Profile</span><span class="op" id="5062343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062346">name</span><span class="op" id="5062350">:</span>&nbsp;&nbsp;<span class="string" id="5062353">&#34;goroutine&#34;</span><span class="op" id="5062364">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062367">count</span><span class="op" id="5062372">:</span>&nbsp;<span class="ident" id="5062374">countGoroutine</span><span class="op" id="5062388">,</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062391">write</span><span class="op" id="5062396">:</span>&nbsp;<span class="ident" id="5062398">writeGoroutine</span><span class="op" id="5062412">,</span><br>
<span class="lineno"></span><span class="op" id="5062414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5062417">var</span>&nbsp;<span class="ident" id="5062421">threadcreateProfile</span>&nbsp;<span class="op" id="5062441">=</span>&nbsp;<span class="op" id="5062443">&amp;</span><span class="ident" id="5062444">Profile</span><span class="op" id="5062451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062454">name</span><span class="op" id="5062458">:</span>&nbsp;&nbsp;<span class="string" id="5062461">&#34;threadcreate&#34;</span><span class="op" id="5062475">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062478">count</span><span class="op" id="5062483">:</span>&nbsp;<span class="ident" id="5062485">countThreadCreate</span><span class="op" id="5062502">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062505">write</span><span class="op" id="5062510">:</span>&nbsp;<span class="ident" id="5062512">writeThreadCreate</span><span class="op" id="5062529">,</span><br>
<span class="lineno"></span><span class="op" id="5062531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5062534">var</span>&nbsp;<span class="ident" id="5062538">heapProfile</span>&nbsp;<span class="op" id="5062550">=</span>&nbsp;<span class="op" id="5062552">&amp;</span><span class="ident" id="5062553">Profile</span><span class="op" id="5062560">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062563">name</span><span class="op" id="5062567">:</span>&nbsp;&nbsp;<span class="string" id="5062570">&#34;heap&#34;</span><span class="op" id="5062576">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062579">count</span><span class="op" id="5062584">:</span>&nbsp;<span class="ident" id="5062586">countHeap</span><span class="op" id="5062595">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062598">write</span><span class="op" id="5062603">:</span>&nbsp;<span class="ident" id="5062605">writeHeap</span><span class="op" id="5062614">,</span><br>
<span class="lineno"></span><span class="op" id="5062616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="5062619">var</span>&nbsp;<span class="ident" id="5062623">blockProfile</span>&nbsp;<span class="op" id="5062636">=</span>&nbsp;<span class="op" id="5062638">&amp;</span><span class="ident" id="5062639">Profile</span><span class="op" id="5062646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062649">name</span><span class="op" id="5062653">:</span>&nbsp;&nbsp;<span class="string" id="5062656">&#34;block&#34;</span><span class="op" id="5062663">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062666">count</span><span class="op" id="5062671">:</span>&nbsp;<span class="ident" id="5062673">countBlock</span><span class="op" id="5062683">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062686">write</span><span class="op" id="5062691">:</span>&nbsp;<span class="ident" id="5062693">writeBlock</span><span class="op" id="5062703">,</span><br>
<span class="lineno"></span><span class="op" id="5062705">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="5062708">func</span>&nbsp;<span class="ident" id="5062713">lockProfiles</span><span class="op" id="5062725">(</span><span class="op" id="5062726">)</span>&nbsp;<span class="op" id="5062728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062731">profiles</span><span class="op" id="5062739">.</span><span class="ident" id="5062740">mu</span><span class="op" id="5062742">.</span><span class="ident" id="5062743">Lock</span><span class="op" id="5062747">(</span><span class="op" id="5062748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5062751">if</span>&nbsp;<span class="ident" id="5062754">profiles</span><span class="op" id="5062762">.</span><span class="ident" id="5062763">m</span>&nbsp;<span class="op" id="5062765">==</span>&nbsp;<span class="ident" id="5062768">nil</span>&nbsp;<span class="op" id="5062772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5062776">//&nbsp;Initial&nbsp;built-in&nbsp;profiles.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062808">profiles</span><span class="op" id="5062816">.</span><span class="ident" id="5062817">m</span>&nbsp;<span class="op" id="5062819">=</span>&nbsp;<span class="keyword" id="5062821">map</span><span class="op" id="5062824">[</span><span class="builtintype" id="5062825">string</span><span class="op" id="5062831">]</span><span class="op" id="5062832">*</span><span class="ident" id="5062833">Profile</span><span class="op" id="5062840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5062845">&#34;goroutine&#34;</span><span class="op" id="5062856">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5062861">goroutineProfile</span><span class="op" id="5062877">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5062882">&#34;threadcreate&#34;</span><span class="op" id="5062896">:</span>&nbsp;<span class="ident" id="5062898">threadcreateProfile</span><span class="op" id="5062917">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5062922">&#34;heap&#34;</span><span class="op" id="5062928">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5062938">heapProfile</span><span class="op" id="5062949">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5062954">&#34;block&#34;</span><span class="op" id="5062961">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5062970">blockProfile</span><span class="op" id="5062982">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5062986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5062989">}</span><br>
<span class="lineno"></span><span class="op" id="5062991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5062994">func</span>&nbsp;<span class="ident" id="5062999">unlockProfiles</span><span class="op" id="5063013">(</span><span class="op" id="5063014">)</span>&nbsp;<span class="op" id="5063016">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063019">profiles</span><span class="op" id="5063027">.</span><span class="ident" id="5063028">mu</span><span class="op" id="5063030">.</span><span class="ident" id="5063031">Unlock</span><span class="op" id="5063037">(</span><span class="op" id="5063038">)</span><br>
<span class="lineno"></span><span class="op" id="5063040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5063043">//&nbsp;NewProfile&nbsp;creates&nbsp;a&nbsp;new&nbsp;profile&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="5063100">//&nbsp;If&nbsp;a&nbsp;profile&nbsp;with&nbsp;that&nbsp;name&nbsp;already&nbsp;exists,&nbsp;NewProfile&nbsp;panics.</span><br>
<span class="lineno">105</span><span class="comment" id="5063166">//&nbsp;The&nbsp;convention&nbsp;is&nbsp;to&nbsp;use&nbsp;a&nbsp;&#39;import/path.&#39;&nbsp;prefix&nbsp;to&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="5063228">//&nbsp;separate&nbsp;name&nbsp;spaces&nbsp;for&nbsp;each&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5063270">func</span>&nbsp;<span class="ident" id="5063275">NewProfile</span><span class="op" id="5063285">(</span><span class="ident" id="5063286">name</span>&nbsp;<span class="builtintype" id="5063291">string</span><span class="op" id="5063297">)</span>&nbsp;<span class="op" id="5063299">*</span><span class="ident" id="5063300">Profile</span>&nbsp;<span class="op" id="5063308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063311">lockProfiles</span><span class="op" id="5063323">(</span><span class="op" id="5063324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063327">defer</span>&nbsp;<span class="ident" id="5063333">unlockProfiles</span><span class="op" id="5063347">(</span><span class="op" id="5063348">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063351">if</span>&nbsp;<span class="ident" id="5063354">name</span>&nbsp;<span class="op" id="5063359">==</span>&nbsp;<span class="string" id="5063362">&#34;&#34;</span>&nbsp;<span class="op" id="5063365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5063369">panic</span><span class="op" id="5063374">(</span><span class="string" id="5063375">&#34;pprof:&nbsp;NewProfile&nbsp;with&nbsp;empty&nbsp;name&#34;</span><span class="op" id="5063410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5063413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063416">if</span>&nbsp;<span class="ident" id="5063419">profiles</span><span class="op" id="5063427">.</span><span class="ident" id="5063428">m</span><span class="op" id="5063429">[</span><span class="ident" id="5063430">name</span><span class="op" id="5063434">]</span>&nbsp;<span class="op" id="5063436">!=</span>&nbsp;<span class="ident" id="5063439">nil</span>&nbsp;<span class="op" id="5063443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5063447">panic</span><span class="op" id="5063452">(</span><span class="string" id="5063453">&#34;pprof:&nbsp;NewProfile&nbsp;name&nbsp;already&nbsp;in&nbsp;use:&nbsp;&#34;</span>&nbsp;<span class="op" id="5063495">+</span>&nbsp;<span class="ident" id="5063497">name</span><span class="op" id="5063501">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5063504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063507">p</span>&nbsp;<span class="op" id="5063509">:=</span>&nbsp;<span class="op" id="5063512">&amp;</span><span class="ident" id="5063513">Profile</span><span class="op" id="5063520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063524">name</span><span class="op" id="5063528">:</span>&nbsp;<span class="ident" id="5063530">name</span><span class="op" id="5063534">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063538">m</span><span class="op" id="5063539">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5063544">map</span><span class="op" id="5063547">[</span><span class="keyword" id="5063548">interface</span><span class="op" id="5063557">{</span><span class="op" id="5063558">}</span><span class="op" id="5063559">]</span><span class="op" id="5063560">[</span><span class="op" id="5063561">]</span><span class="builtintype" id="5063562">uintptr</span><span class="op" id="5063569">{</span><span class="op" id="5063570">}</span><span class="op" id="5063571">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5063574">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063577">profiles</span><span class="op" id="5063585">.</span><span class="ident" id="5063586">m</span><span class="op" id="5063587">[</span><span class="ident" id="5063588">name</span><span class="op" id="5063592">]</span>&nbsp;<span class="op" id="5063594">=</span>&nbsp;<span class="ident" id="5063596">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063599">return</span>&nbsp;<span class="ident" id="5063606">p</span><br>
<span class="lineno"></span><span class="op" id="5063608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5063611">//&nbsp;Lookup&nbsp;returns&nbsp;the&nbsp;profile&nbsp;with&nbsp;the&nbsp;given&nbsp;name,&nbsp;or&nbsp;nil&nbsp;if&nbsp;no&nbsp;such&nbsp;profile&nbsp;exists.</span><br>
<span class="lineno">125</span><span class="keyword" id="5063696">func</span>&nbsp;<span class="ident" id="5063701">Lookup</span><span class="op" id="5063707">(</span><span class="ident" id="5063708">name</span>&nbsp;<span class="builtintype" id="5063713">string</span><span class="op" id="5063719">)</span>&nbsp;<span class="op" id="5063721">*</span><span class="ident" id="5063722">Profile</span>&nbsp;<span class="op" id="5063730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063733">lockProfiles</span><span class="op" id="5063745">(</span><span class="op" id="5063746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063749">defer</span>&nbsp;<span class="ident" id="5063755">unlockProfiles</span><span class="op" id="5063769">(</span><span class="op" id="5063770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063773">return</span>&nbsp;<span class="ident" id="5063780">profiles</span><span class="op" id="5063788">.</span><span class="ident" id="5063789">m</span><span class="op" id="5063790">[</span><span class="ident" id="5063791">name</span><span class="op" id="5063795">]</span><br>
<span class="lineno"></span><span class="op" id="5063797">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="5063800">//&nbsp;Profiles&nbsp;returns&nbsp;a&nbsp;slice&nbsp;of&nbsp;all&nbsp;the&nbsp;known&nbsp;profiles,&nbsp;sorted&nbsp;by&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="5063871">func</span>&nbsp;<span class="ident" id="5063876">Profiles</span><span class="op" id="5063884">(</span><span class="op" id="5063885">)</span>&nbsp;<span class="op" id="5063887">[</span><span class="op" id="5063888">]</span><span class="op" id="5063889">*</span><span class="ident" id="5063890">Profile</span>&nbsp;<span class="op" id="5063898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063901">lockProfiles</span><span class="op" id="5063913">(</span><span class="op" id="5063914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063917">defer</span>&nbsp;<span class="ident" id="5063923">unlockProfiles</span><span class="op" id="5063937">(</span><span class="op" id="5063938">)</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063942">var</span>&nbsp;<span class="ident" id="5063946">all</span>&nbsp;<span class="op" id="5063950">[</span><span class="op" id="5063951">]</span><span class="op" id="5063952">*</span><span class="ident" id="5063953">Profile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063962">for</span>&nbsp;<span class="ident" id="5063966">_</span><span class="op" id="5063967">,</span>&nbsp;<span class="ident" id="5063969">p</span>&nbsp;<span class="op" id="5063971">:=</span>&nbsp;<span class="keyword" id="5063974">range</span>&nbsp;<span class="ident" id="5063980">profiles</span><span class="op" id="5063988">.</span><span class="ident" id="5063989">m</span>&nbsp;<span class="op" id="5063991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063995">all</span>&nbsp;<span class="op" id="5063999">=</span>&nbsp;<span class="builtinfunc" id="5064001">append</span><span class="op" id="5064007">(</span><span class="ident" id="5064008">all</span><span class="op" id="5064011">,</span>&nbsp;<span class="ident" id="5064013">p</span><span class="op" id="5064014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5064017">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064021">sort</span><span class="op" id="5064025">.</span><span class="ident" id="5064026">Sort</span><span class="op" id="5064030">(</span><span class="ident" id="5064031">byName</span><span class="op" id="5064037">(</span><span class="ident" id="5064038">all</span><span class="op" id="5064041">)</span><span class="op" id="5064042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5064045">return</span>&nbsp;<span class="ident" id="5064052">all</span><br>
<span class="lineno"></span><span class="op" id="5064056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5064059">type</span>&nbsp;<span class="ident" id="5064064">byName</span>&nbsp;<span class="op" id="5064071">[</span><span class="op" id="5064072">]</span><span class="op" id="5064073">*</span><span class="ident" id="5064074">Profile</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5064083">func</span>&nbsp;<span class="op" id="5064088">(</span><span class="ident" id="5064089">x</span>&nbsp;<span class="ident" id="5064091">byName</span><span class="op" id="5064097">)</span>&nbsp;<span class="ident" id="5064099">Len</span><span class="op" id="5064102">(</span><span class="op" id="5064103">)</span>&nbsp;<span class="builtintype" id="5064105">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5064119">{</span>&nbsp;<span class="keyword" id="5064121">return</span>&nbsp;<span class="builtinfunc" id="5064128">len</span><span class="op" id="5064131">(</span><span class="ident" id="5064132">x</span><span class="op" id="5064133">)</span>&nbsp;<span class="op" id="5064135">}</span><br>
<span class="lineno"></span><span class="keyword" id="5064137">func</span>&nbsp;<span class="op" id="5064142">(</span><span class="ident" id="5064143">x</span>&nbsp;<span class="ident" id="5064145">byName</span><span class="op" id="5064151">)</span>&nbsp;<span class="ident" id="5064153">Swap</span><span class="op" id="5064157">(</span><span class="ident" id="5064158">i</span><span class="op" id="5064159">,</span>&nbsp;<span class="ident" id="5064161">j</span>&nbsp;<span class="builtintype" id="5064163">int</span><span class="op" id="5064166">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5064173">{</span>&nbsp;<span class="ident" id="5064175">x</span><span class="op" id="5064176">[</span><span class="ident" id="5064177">i</span><span class="op" id="5064178">]</span><span class="op" id="5064179">,</span>&nbsp;<span class="ident" id="5064181">x</span><span class="op" id="5064182">[</span><span class="ident" id="5064183">j</span><span class="op" id="5064184">]</span>&nbsp;<span class="op" id="5064186">=</span>&nbsp;<span class="ident" id="5064188">x</span><span class="op" id="5064189">[</span><span class="ident" id="5064190">j</span><span class="op" id="5064191">]</span><span class="op" id="5064192">,</span>&nbsp;<span class="ident" id="5064194">x</span><span class="op" id="5064195">[</span><span class="ident" id="5064196">i</span><span class="op" id="5064197">]</span>&nbsp;<span class="op" id="5064199">}</span><br>
<span class="lineno"></span><span class="keyword" id="5064201">func</span>&nbsp;<span class="op" id="5064206">(</span><span class="ident" id="5064207">x</span>&nbsp;<span class="ident" id="5064209">byName</span><span class="op" id="5064215">)</span>&nbsp;<span class="ident" id="5064217">Less</span><span class="op" id="5064221">(</span><span class="ident" id="5064222">i</span><span class="op" id="5064223">,</span>&nbsp;<span class="ident" id="5064225">j</span>&nbsp;<span class="builtintype" id="5064227">int</span><span class="op" id="5064230">)</span>&nbsp;<span class="builtintype" id="5064232">bool</span>&nbsp;<span class="op" id="5064237">{</span>&nbsp;<span class="keyword" id="5064239">return</span>&nbsp;<span class="ident" id="5064246">x</span><span class="op" id="5064247">[</span><span class="ident" id="5064248">i</span><span class="op" id="5064249">]</span><span class="op" id="5064250">.</span><span class="ident" id="5064251">name</span>&nbsp;<span class="op" id="5064256">&lt;</span>&nbsp;<span class="ident" id="5064258">x</span><span class="op" id="5064259">[</span><span class="ident" id="5064260">j</span><span class="op" id="5064261">]</span><span class="op" id="5064262">.</span><span class="ident" id="5064263">name</span>&nbsp;<span class="op" id="5064268">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="comment" id="5064271">//&nbsp;Name&nbsp;returns&nbsp;this&nbsp;profile&#39;s&nbsp;name,&nbsp;which&nbsp;can&nbsp;be&nbsp;passed&nbsp;to&nbsp;Lookup&nbsp;to&nbsp;reobtain&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5064363">func</span>&nbsp;<span class="op" id="5064368">(</span><span class="ident" id="5064369">p</span>&nbsp;<span class="op" id="5064371">*</span><span class="ident" id="5064372">Profile</span><span class="op" id="5064379">)</span>&nbsp;<span class="ident" id="5064381">Name</span><span class="op" id="5064385">(</span><span class="op" id="5064386">)</span>&nbsp;<span class="builtintype" id="5064388">string</span>&nbsp;<span class="op" id="5064395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5064398">return</span>&nbsp;<span class="ident" id="5064405">p</span><span class="op" id="5064406">.</span><span class="ident" id="5064407">name</span><br>
<span class="lineno"></span><span class="op" id="5064412">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5064415">//&nbsp;Count&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;execution&nbsp;stacks&nbsp;currently&nbsp;in&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5064489">func</span>&nbsp;<span class="op" id="5064494">(</span><span class="ident" id="5064495">p</span>&nbsp;<span class="op" id="5064497">*</span><span class="ident" id="5064498">Profile</span><span class="op" id="5064505">)</span>&nbsp;<span class="ident" id="5064507">Count</span><span class="op" id="5064512">(</span><span class="op" id="5064513">)</span>&nbsp;<span class="builtintype" id="5064515">int</span>&nbsp;<span class="op" id="5064519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064522">p</span><span class="op" id="5064523">.</span><span class="ident" id="5064524">mu</span><span class="op" id="5064526">.</span><span class="ident" id="5064527">Lock</span><span class="op" id="5064531">(</span><span class="op" id="5064532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5064535">defer</span>&nbsp;<span class="ident" id="5064541">p</span><span class="op" id="5064542">.</span><span class="ident" id="5064543">mu</span><span class="op" id="5064545">.</span><span class="ident" id="5064546">Unlock</span><span class="op" id="5064552">(</span><span class="op" id="5064553">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5064556">if</span>&nbsp;<span class="ident" id="5064559">p</span><span class="op" id="5064560">.</span><span class="ident" id="5064561">count</span>&nbsp;<span class="op" id="5064567">!=</span>&nbsp;<span class="ident" id="5064570">nil</span>&nbsp;<span class="op" id="5064574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5064578">return</span>&nbsp;<span class="ident" id="5064585">p</span><span class="op" id="5064586">.</span><span class="ident" id="5064587">count</span><span class="op" id="5064592">(</span><span class="op" id="5064593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5064596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5064599">return</span>&nbsp;<span class="builtinfunc" id="5064606">len</span><span class="op" id="5064609">(</span><span class="ident" id="5064610">p</span><span class="op" id="5064611">.</span><span class="ident" id="5064612">m</span><span class="op" id="5064613">)</span><br>
<span class="lineno"></span><span class="op" id="5064615">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="5064618">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;current&nbsp;execution&nbsp;stack&nbsp;to&nbsp;the&nbsp;profile,&nbsp;associated&nbsp;with&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment" id="5064697">//&nbsp;Add&nbsp;stores&nbsp;value&nbsp;in&nbsp;an&nbsp;internal&nbsp;map,&nbsp;so&nbsp;value&nbsp;must&nbsp;be&nbsp;suitable&nbsp;for&nbsp;use&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="5064774">//&nbsp;a&nbsp;map&nbsp;key&nbsp;and&nbsp;will&nbsp;not&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;until&nbsp;the&nbsp;corresponding</span><br>
<span class="lineno"></span><span class="comment" id="5064845">//&nbsp;call&nbsp;to&nbsp;Remove.&nbsp;&nbsp;Add&nbsp;panics&nbsp;if&nbsp;the&nbsp;profile&nbsp;already&nbsp;contains&nbsp;a&nbsp;stack&nbsp;for&nbsp;value.</span><br>
<span class="lineno">170</span><span class="comment" id="5064927">//</span><br>
<span class="lineno"></span><span class="comment" id="5064930">//&nbsp;The&nbsp;skip&nbsp;parameter&nbsp;has&nbsp;the&nbsp;same&nbsp;meaning&nbsp;as&nbsp;runtime.Caller&#39;s&nbsp;skip</span><br>
<span class="lineno"></span><span class="comment" id="5064998">//&nbsp;and&nbsp;controls&nbsp;where&nbsp;the&nbsp;stack&nbsp;trace&nbsp;begins.&nbsp;&nbsp;Passing&nbsp;skip=0&nbsp;begins&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5065071">//&nbsp;trace&nbsp;in&nbsp;the&nbsp;function&nbsp;calling&nbsp;Add.&nbsp;&nbsp;For&nbsp;example,&nbsp;given&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="5065134">//&nbsp;execution&nbsp;stack:</span><br>
<span class="lineno">175</span><span class="comment" id="5065154">//</span><br>
<span class="lineno"></span><span class="comment" id="5065157">//&nbsp;&nbsp;&nbsp;&nbspAdd</span><br>
<span class="lineno"></span><span class="comment" id="5065164">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;rpc.NewClient</span><br>
<span class="lineno"></span><span class="comment" id="5065193">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;mypkg.Run</span><br>
<span class="lineno"></span><span class="comment" id="5065218">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;main.main</span><br>
<span class="lineno">180</span><span class="comment" id="5065243">//</span><br>
<span class="lineno"></span><span class="comment" id="5065246">//&nbsp;Passing&nbsp;skip=0&nbsp;begins&nbsp;the&nbsp;stack&nbsp;trace&nbsp;at&nbsp;the&nbsp;call&nbsp;to&nbsp;Add&nbsp;inside&nbsp;rpc.NewClient.</span><br>
<span class="lineno"></span><span class="comment" id="5065328">//&nbsp;Passing&nbsp;skip=1&nbsp;begins&nbsp;the&nbsp;stack&nbsp;trace&nbsp;at&nbsp;the&nbsp;call&nbsp;to&nbsp;NewClient&nbsp;inside&nbsp;mypkg.Run.</span><br>
<span class="lineno"></span><span class="comment" id="5065412">//</span><br>
<span class="lineno"></span><span class="keyword" id="5065415">func</span>&nbsp;<span class="op" id="5065420">(</span><span class="ident" id="5065421">p</span>&nbsp;<span class="op" id="5065423">*</span><span class="ident" id="5065424">Profile</span><span class="op" id="5065431">)</span>&nbsp;<span class="ident" id="5065433">Add</span><span class="op" id="5065436">(</span><span class="ident" id="5065437">value</span>&nbsp;<span class="keyword" id="5065443">interface</span><span class="op" id="5065452">{</span><span class="op" id="5065453">}</span><span class="op" id="5065454">,</span>&nbsp;<span class="ident" id="5065456">skip</span>&nbsp;<span class="builtintype" id="5065461">int</span><span class="op" id="5065464">)</span>&nbsp;<span class="op" id="5065466">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065469">if</span>&nbsp;<span class="ident" id="5065472">p</span><span class="op" id="5065473">.</span><span class="ident" id="5065474">name</span>&nbsp;<span class="op" id="5065479">==</span>&nbsp;<span class="string" id="5065482">&#34;&#34;</span>&nbsp;<span class="op" id="5065485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5065489">panic</span><span class="op" id="5065494">(</span><span class="string" id="5065495">&#34;pprof:&nbsp;use&nbsp;of&nbsp;uninitialized&nbsp;Profile&#34;</span><span class="op" id="5065532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5065535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065538">if</span>&nbsp;<span class="ident" id="5065541">p</span><span class="op" id="5065542">.</span><span class="ident" id="5065543">write</span>&nbsp;<span class="op" id="5065549">!=</span>&nbsp;<span class="ident" id="5065552">nil</span>&nbsp;<span class="op" id="5065556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5065560">panic</span><span class="op" id="5065565">(</span><span class="string" id="5065566">&#34;pprof:&nbsp;Add&nbsp;called&nbsp;on&nbsp;built-in&nbsp;Profile&nbsp;&#34;</span>&nbsp;<span class="op" id="5065607">+</span>&nbsp;<span class="ident" id="5065609">p</span><span class="op" id="5065610">.</span><span class="ident" id="5065611">name</span><span class="op" id="5065615">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5065618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065622">stk</span>&nbsp;<span class="op" id="5065626">:=</span>&nbsp;<span class="builtinfunc" id="5065629">make</span><span class="op" id="5065633">(</span><span class="op" id="5065634">[</span><span class="op" id="5065635">]</span><span class="builtintype" id="5065636">uintptr</span><span class="op" id="5065643">,</span>&nbsp;<span class="num" id="5065645">32</span><span class="op" id="5065647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065650">n</span>&nbsp;<span class="op" id="5065652">:=</span>&nbsp;<span class="ident" id="5065655">runtime</span><span class="op" id="5065662">.</span><span class="ident" id="5065663">Callers</span><span class="op" id="5065670">(</span><span class="ident" id="5065671">skip</span><span class="op" id="5065675">+</span><span class="num" id="5065676">1</span><span class="op" id="5065677">,</span>&nbsp;<span class="ident" id="5065679">stk</span><span class="op" id="5065682">[</span><span class="op" id="5065683">:</span><span class="op" id="5065684">]</span><span class="op" id="5065685">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065689">p</span><span class="op" id="5065690">.</span><span class="ident" id="5065691">mu</span><span class="op" id="5065693">.</span><span class="ident" id="5065694">Lock</span><span class="op" id="5065698">(</span><span class="op" id="5065699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065702">defer</span>&nbsp;<span class="ident" id="5065708">p</span><span class="op" id="5065709">.</span><span class="ident" id="5065710">mu</span><span class="op" id="5065712">.</span><span class="ident" id="5065713">Unlock</span><span class="op" id="5065719">(</span><span class="op" id="5065720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065723">if</span>&nbsp;<span class="ident" id="5065726">p</span><span class="op" id="5065727">.</span><span class="ident" id="5065728">m</span><span class="op" id="5065729">[</span><span class="ident" id="5065730">value</span><span class="op" id="5065735">]</span>&nbsp;<span class="op" id="5065737">!=</span>&nbsp;<span class="ident" id="5065740">nil</span>&nbsp;<span class="op" id="5065744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5065748">panic</span><span class="op" id="5065753">(</span><span class="string" id="5065754">&#34;pprof:&nbsp;Profile.Add&nbsp;of&nbsp;duplicate&nbsp;value&#34;</span><span class="op" id="5065793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5065796">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065799">p</span><span class="op" id="5065800">.</span><span class="ident" id="5065801">m</span><span class="op" id="5065802">[</span><span class="ident" id="5065803">value</span><span class="op" id="5065808">]</span>&nbsp;<span class="op" id="5065810">=</span>&nbsp;<span class="ident" id="5065812">stk</span><span class="op" id="5065815">[</span><span class="op" id="5065816">:</span><span class="ident" id="5065817">n</span><span class="op" id="5065818">]</span><br>
<span class="lineno"></span><span class="op" id="5065820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5065823">//&nbsp;Remove&nbsp;removes&nbsp;the&nbsp;execution&nbsp;stack&nbsp;associated&nbsp;with&nbsp;value&nbsp;from&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="5065901">//&nbsp;It&nbsp;is&nbsp;a&nbsp;no-op&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;profile.</span><br>
<span class="lineno">205</span><span class="keyword" id="5065954">func</span>&nbsp;<span class="op" id="5065959">(</span><span class="ident" id="5065960">p</span>&nbsp;<span class="op" id="5065962">*</span><span class="ident" id="5065963">Profile</span><span class="op" id="5065970">)</span>&nbsp;<span class="ident" id="5065972">Remove</span><span class="op" id="5065978">(</span><span class="ident" id="5065979">value</span>&nbsp;<span class="keyword" id="5065985">interface</span><span class="op" id="5065994">{</span><span class="op" id="5065995">}</span><span class="op" id="5065996">)</span>&nbsp;<span class="op" id="5065998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066001">p</span><span class="op" id="5066002">.</span><span class="ident" id="5066003">mu</span><span class="op" id="5066005">.</span><span class="ident" id="5066006">Lock</span><span class="op" id="5066010">(</span><span class="op" id="5066011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066014">defer</span>&nbsp;<span class="ident" id="5066020">p</span><span class="op" id="5066021">.</span><span class="ident" id="5066022">mu</span><span class="op" id="5066024">.</span><span class="ident" id="5066025">Unlock</span><span class="op" id="5066031">(</span><span class="op" id="5066032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5066035">delete</span><span class="op" id="5066041">(</span><span class="ident" id="5066042">p</span><span class="op" id="5066043">.</span><span class="ident" id="5066044">m</span><span class="op" id="5066045">,</span>&nbsp;<span class="ident" id="5066047">value</span><span class="op" id="5066052">)</span><br>
<span class="lineno"></span><span class="op" id="5066054">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="comment" id="5066057">//&nbsp;WriteTo&nbsp;writes&nbsp;a&nbsp;pprof-formatted&nbsp;snapshot&nbsp;of&nbsp;the&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="5066123">//&nbsp;If&nbsp;a&nbsp;write&nbsp;to&nbsp;w&nbsp;returns&nbsp;an&nbsp;error,&nbsp;WriteTo&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="5066188">//&nbsp;Otherwise,&nbsp;WriteTo&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="5066223">//</span><br>
<span class="lineno">215</span><span class="comment" id="5066226">//&nbsp;The&nbsp;debug&nbsp;parameter&nbsp;enables&nbsp;additional&nbsp;output.</span><br>
<span class="lineno"></span><span class="comment" id="5066276">//&nbsp;Passing&nbsp;debug=0&nbsp;prints&nbsp;only&nbsp;the&nbsp;hexadecimal&nbsp;addresses&nbsp;that&nbsp;pprof&nbsp;needs.</span><br>
<span class="lineno"></span><span class="comment" id="5066351">//&nbsp;Passing&nbsp;debug=1&nbsp;adds&nbsp;comments&nbsp;translating&nbsp;addresses&nbsp;to&nbsp;function&nbsp;names</span><br>
<span class="lineno"></span><span class="comment" id="5066424">//&nbsp;and&nbsp;line&nbsp;numbers,&nbsp;so&nbsp;that&nbsp;a&nbsp;programmer&nbsp;can&nbsp;read&nbsp;the&nbsp;profile&nbsp;without&nbsp;tools.</span><br>
<span class="lineno"></span><span class="comment" id="5066502">//</span><br>
<span class="lineno">220</span><span class="comment" id="5066505">//&nbsp;The&nbsp;predefined&nbsp;profiles&nbsp;may&nbsp;assign&nbsp;meaning&nbsp;to&nbsp;other&nbsp;debug&nbsp;values;</span><br>
<span class="lineno"></span><span class="comment" id="5066574">//&nbsp;for&nbsp;example,&nbsp;when&nbsp;printing&nbsp;the&nbsp;&#34;goroutine&#34;&nbsp;profile,&nbsp;debug=2&nbsp;means&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5066646">//&nbsp;print&nbsp;the&nbsp;goroutine&nbsp;stacks&nbsp;in&nbsp;the&nbsp;same&nbsp;form&nbsp;that&nbsp;a&nbsp;Go&nbsp;program&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="5066716">//&nbsp;when&nbsp;dying&nbsp;due&nbsp;to&nbsp;an&nbsp;unrecovered&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword" id="5066759">func</span>&nbsp;<span class="op" id="5066764">(</span><span class="ident" id="5066765">p</span>&nbsp;<span class="op" id="5066767">*</span><span class="ident" id="5066768">Profile</span><span class="op" id="5066775">)</span>&nbsp;<span class="ident" id="5066777">WriteTo</span><span class="op" id="5066784">(</span><span class="ident" id="5066785">w</span>&nbsp;<span class="ident" id="5066787">io</span><span class="op" id="5066789">.</span><span class="ident" id="5066790">Writer</span><span class="op" id="5066796">,</span>&nbsp;<span class="ident" id="5066798">debug</span>&nbsp;<span class="builtintype" id="5066804">int</span><span class="op" id="5066807">)</span>&nbsp;<span class="builtintype" id="5066809">error</span>&nbsp;<span class="op" id="5066815">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066818">if</span>&nbsp;<span class="ident" id="5066821">p</span><span class="op" id="5066822">.</span><span class="ident" id="5066823">name</span>&nbsp;<span class="op" id="5066828">==</span>&nbsp;<span class="string" id="5066831">&#34;&#34;</span>&nbsp;<span class="op" id="5066834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5066838">panic</span><span class="op" id="5066843">(</span><span class="string" id="5066844">&#34;pprof:&nbsp;use&nbsp;of&nbsp;zero&nbsp;Profile&#34;</span><span class="op" id="5066872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5066875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066878">if</span>&nbsp;<span class="ident" id="5066881">p</span><span class="op" id="5066882">.</span><span class="ident" id="5066883">write</span>&nbsp;<span class="op" id="5066889">!=</span>&nbsp;<span class="ident" id="5066892">nil</span>&nbsp;<span class="op" id="5066896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066900">return</span>&nbsp;<span class="ident" id="5066907">p</span><span class="op" id="5066908">.</span><span class="ident" id="5066909">write</span><span class="op" id="5066914">(</span><span class="ident" id="5066915">w</span><span class="op" id="5066916">,</span>&nbsp;<span class="ident" id="5066918">debug</span><span class="op" id="5066923">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5066926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5066930">//&nbsp;Obtain&nbsp;consistent&nbsp;snapshot&nbsp;under&nbsp;lock;&nbsp;then&nbsp;process&nbsp;without&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067000">var</span>&nbsp;<span class="ident" id="5067004">all</span>&nbsp;<span class="op" id="5067008">[</span><span class="op" id="5067009">]</span><span class="op" id="5067010">[</span><span class="op" id="5067011">]</span><span class="builtintype" id="5067012">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067021">p</span><span class="op" id="5067022">.</span><span class="ident" id="5067023">mu</span><span class="op" id="5067025">.</span><span class="ident" id="5067026">Lock</span><span class="op" id="5067030">(</span><span class="op" id="5067031">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067034">for</span>&nbsp;<span class="ident" id="5067038">_</span><span class="op" id="5067039">,</span>&nbsp;<span class="ident" id="5067041">stk</span>&nbsp;<span class="op" id="5067045">:=</span>&nbsp;<span class="keyword" id="5067048">range</span>&nbsp;<span class="ident" id="5067054">p</span><span class="op" id="5067055">.</span><span class="ident" id="5067056">m</span>&nbsp;<span class="op" id="5067058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067062">all</span>&nbsp;<span class="op" id="5067066">=</span>&nbsp;<span class="builtinfunc" id="5067068">append</span><span class="op" id="5067074">(</span><span class="ident" id="5067075">all</span><span class="op" id="5067078">,</span>&nbsp;<span class="ident" id="5067080">stk</span><span class="op" id="5067083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5067086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067089">p</span><span class="op" id="5067090">.</span><span class="ident" id="5067091">mu</span><span class="op" id="5067093">.</span><span class="ident" id="5067094">Unlock</span><span class="op" id="5067100">(</span><span class="op" id="5067101">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067105">//&nbsp;Map&nbsp;order&nbsp;is&nbsp;non-deterministic;&nbsp;make&nbsp;output&nbsp;deterministic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067168">sort</span><span class="op" id="5067172">.</span><span class="ident" id="5067173">Sort</span><span class="op" id="5067177">(</span><span class="ident" id="5067178">stackProfile</span><span class="op" id="5067190">(</span><span class="ident" id="5067191">all</span><span class="op" id="5067194">)</span><span class="op" id="5067195">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067199">return</span>&nbsp;<span class="ident" id="5067206">printCountProfile</span><span class="op" id="5067223">(</span><span class="ident" id="5067224">w</span><span class="op" id="5067225">,</span>&nbsp;<span class="ident" id="5067227">debug</span><span class="op" id="5067232">,</span>&nbsp;<span class="ident" id="5067234">p</span><span class="op" id="5067235">.</span><span class="ident" id="5067236">name</span><span class="op" id="5067240">,</span>&nbsp;<span class="ident" id="5067242">stackProfile</span><span class="op" id="5067254">(</span><span class="ident" id="5067255">all</span><span class="op" id="5067258">)</span><span class="op" id="5067259">)</span><br>
<span class="lineno"></span><span class="op" id="5067261">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="5067264">type</span>&nbsp;<span class="ident" id="5067269">stackProfile</span>&nbsp;<span class="op" id="5067282">[</span><span class="op" id="5067283">]</span><span class="op" id="5067284">[</span><span class="op" id="5067285">]</span><span class="builtintype" id="5067286">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5067295">func</span>&nbsp;<span class="op" id="5067300">(</span><span class="ident" id="5067301">x</span>&nbsp;<span class="ident" id="5067303">stackProfile</span><span class="op" id="5067315">)</span>&nbsp;<span class="ident" id="5067317">Len</span><span class="op" id="5067320">(</span><span class="op" id="5067321">)</span>&nbsp;<span class="builtintype" id="5067323">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5067340">{</span>&nbsp;<span class="keyword" id="5067342">return</span>&nbsp;<span class="builtinfunc" id="5067349">len</span><span class="op" id="5067352">(</span><span class="ident" id="5067353">x</span><span class="op" id="5067354">)</span>&nbsp;<span class="op" id="5067356">}</span><br>
<span class="lineno"></span><span class="keyword" id="5067358">func</span>&nbsp;<span class="op" id="5067363">(</span><span class="ident" id="5067364">x</span>&nbsp;<span class="ident" id="5067366">stackProfile</span><span class="op" id="5067378">)</span>&nbsp;<span class="ident" id="5067380">Stack</span><span class="op" id="5067385">(</span><span class="ident" id="5067386">i</span>&nbsp;<span class="builtintype" id="5067388">int</span><span class="op" id="5067391">)</span>&nbsp;<span class="op" id="5067393">[</span><span class="op" id="5067394">]</span><span class="builtintype" id="5067395">uintptr</span>&nbsp;<span class="op" id="5067403">{</span>&nbsp;<span class="keyword" id="5067405">return</span>&nbsp;<span class="ident" id="5067412">x</span><span class="op" id="5067413">[</span><span class="ident" id="5067414">i</span><span class="op" id="5067415">]</span>&nbsp;<span class="op" id="5067417">}</span><br>
<span class="lineno">250</span><span class="keyword" id="5067419">func</span>&nbsp;<span class="op" id="5067424">(</span><span class="ident" id="5067425">x</span>&nbsp;<span class="ident" id="5067427">stackProfile</span><span class="op" id="5067439">)</span>&nbsp;<span class="ident" id="5067441">Swap</span><span class="op" id="5067445">(</span><span class="ident" id="5067446">i</span><span class="op" id="5067447">,</span>&nbsp;<span class="ident" id="5067449">j</span>&nbsp;<span class="builtintype" id="5067451">int</span><span class="op" id="5067454">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5067464">{</span>&nbsp;<span class="ident" id="5067466">x</span><span class="op" id="5067467">[</span><span class="ident" id="5067468">i</span><span class="op" id="5067469">]</span><span class="op" id="5067470">,</span>&nbsp;<span class="ident" id="5067472">x</span><span class="op" id="5067473">[</span><span class="ident" id="5067474">j</span><span class="op" id="5067475">]</span>&nbsp;<span class="op" id="5067477">=</span>&nbsp;<span class="ident" id="5067479">x</span><span class="op" id="5067480">[</span><span class="ident" id="5067481">j</span><span class="op" id="5067482">]</span><span class="op" id="5067483">,</span>&nbsp;<span class="ident" id="5067485">x</span><span class="op" id="5067486">[</span><span class="ident" id="5067487">i</span><span class="op" id="5067488">]</span>&nbsp;<span class="op" id="5067490">}</span><br>
<span class="lineno"></span><span class="keyword" id="5067492">func</span>&nbsp;<span class="op" id="5067497">(</span><span class="ident" id="5067498">x</span>&nbsp;<span class="ident" id="5067500">stackProfile</span><span class="op" id="5067512">)</span>&nbsp;<span class="ident" id="5067514">Less</span><span class="op" id="5067518">(</span><span class="ident" id="5067519">i</span><span class="op" id="5067520">,</span>&nbsp;<span class="ident" id="5067522">j</span>&nbsp;<span class="builtintype" id="5067524">int</span><span class="op" id="5067527">)</span>&nbsp;<span class="builtintype" id="5067529">bool</span>&nbsp;<span class="op" id="5067534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067537">t</span><span class="op" id="5067538">,</span>&nbsp;<span class="ident" id="5067540">u</span>&nbsp;<span class="op" id="5067542">:=</span>&nbsp;<span class="ident" id="5067545">x</span><span class="op" id="5067546">[</span><span class="ident" id="5067547">i</span><span class="op" id="5067548">]</span><span class="op" id="5067549">,</span>&nbsp;<span class="ident" id="5067551">x</span><span class="op" id="5067552">[</span><span class="ident" id="5067553">j</span><span class="op" id="5067554">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067557">for</span>&nbsp;<span class="ident" id="5067561">k</span>&nbsp;<span class="op" id="5067563">:=</span>&nbsp;<span class="num" id="5067566">0</span><span class="op" id="5067567">;</span>&nbsp;<span class="ident" id="5067569">k</span>&nbsp;<span class="op" id="5067571">&lt;</span>&nbsp;<span class="builtinfunc" id="5067573">len</span><span class="op" id="5067576">(</span><span class="ident" id="5067577">t</span><span class="op" id="5067578">)</span>&nbsp;<span class="op" id="5067580">&amp;&amp;</span>&nbsp;<span class="ident" id="5067583">k</span>&nbsp;<span class="op" id="5067585">&lt;</span>&nbsp;<span class="builtinfunc" id="5067587">len</span><span class="op" id="5067590">(</span><span class="ident" id="5067591">u</span><span class="op" id="5067592">)</span><span class="op" id="5067593">;</span>&nbsp;<span class="ident" id="5067595">k</span><span class="op" id="5067596">++</span>&nbsp;<span class="op" id="5067599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067603">if</span>&nbsp;<span class="ident" id="5067606">t</span><span class="op" id="5067607">[</span><span class="ident" id="5067608">k</span><span class="op" id="5067609">]</span>&nbsp;<span class="op" id="5067611">!=</span>&nbsp;<span class="ident" id="5067614">u</span><span class="op" id="5067615">[</span><span class="ident" id="5067616">k</span><span class="op" id="5067617">]</span>&nbsp;<span class="op" id="5067619">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067624">return</span>&nbsp;<span class="ident" id="5067631">t</span><span class="op" id="5067632">[</span><span class="ident" id="5067633">k</span><span class="op" id="5067634">]</span>&nbsp;<span class="op" id="5067636">&lt;</span>&nbsp;<span class="ident" id="5067638">u</span><span class="op" id="5067639">[</span><span class="ident" id="5067640">k</span><span class="op" id="5067641">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5067645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5067648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067651">return</span>&nbsp;<span class="builtinfunc" id="5067658">len</span><span class="op" id="5067661">(</span><span class="ident" id="5067662">t</span><span class="op" id="5067663">)</span>&nbsp;<span class="op" id="5067665">&lt;</span>&nbsp;<span class="builtinfunc" id="5067667">len</span><span class="op" id="5067670">(</span><span class="ident" id="5067671">u</span><span class="op" id="5067672">)</span><br>
<span class="lineno"></span><span class="op" id="5067674">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="5067677">//&nbsp;A&nbsp;countProfile&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;stack&nbsp;traces&nbsp;to&nbsp;be&nbsp;printed&nbsp;as&nbsp;counts</span><br>
<span class="lineno"></span><span class="comment" id="5067744">//&nbsp;grouped&nbsp;by&nbsp;stack&nbsp;trace.&nbsp;&nbsp;There&nbsp;are&nbsp;multiple&nbsp;implementations:</span><br>
<span class="lineno"></span><span class="comment" id="5067808">//&nbsp;all&nbsp;that&nbsp;matters&nbsp;is&nbsp;that&nbsp;we&nbsp;can&nbsp;find&nbsp;out&nbsp;how&nbsp;many&nbsp;traces&nbsp;there&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5067878">//&nbsp;and&nbsp;obtain&nbsp;each&nbsp;trace&nbsp;in&nbsp;turn.</span><br>
<span class="lineno">265</span><span class="keyword" id="5067912">type</span>&nbsp;<span class="ident" id="5067917">countProfile</span>&nbsp;<span class="keyword" id="5067930">interface</span>&nbsp;<span class="op" id="5067940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067943">Len</span><span class="op" id="5067946">(</span><span class="op" id="5067947">)</span>&nbsp;<span class="builtintype" id="5067949">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067954">Stack</span><span class="op" id="5067959">(</span><span class="ident" id="5067960">i</span>&nbsp;<span class="builtintype" id="5067962">int</span><span class="op" id="5067965">)</span>&nbsp;<span class="op" id="5067967">[</span><span class="op" id="5067968">]</span><span class="builtintype" id="5067969">uintptr</span><br>
<span class="lineno"></span><span class="op" id="5067977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="5067980">//&nbsp;printCountProfile&nbsp;prints&nbsp;a&nbsp;countProfile&nbsp;at&nbsp;the&nbsp;specified&nbsp;debug&nbsp;level.</span><br>
<span class="lineno"></span><span class="keyword" id="5068053">func</span>&nbsp;<span class="ident" id="5068058">printCountProfile</span><span class="op" id="5068075">(</span><span class="ident" id="5068076">w</span>&nbsp;<span class="ident" id="5068078">io</span><span class="op" id="5068080">.</span><span class="ident" id="5068081">Writer</span><span class="op" id="5068087">,</span>&nbsp;<span class="ident" id="5068089">debug</span>&nbsp;<span class="builtintype" id="5068095">int</span><span class="op" id="5068098">,</span>&nbsp;<span class="ident" id="5068100">name</span>&nbsp;<span class="builtintype" id="5068105">string</span><span class="op" id="5068111">,</span>&nbsp;<span class="ident" id="5068113">p</span>&nbsp;<span class="ident" id="5068115">countProfile</span><span class="op" id="5068127">)</span>&nbsp;<span class="builtintype" id="5068129">error</span>&nbsp;<span class="op" id="5068135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068138">b</span>&nbsp;<span class="op" id="5068140">:=</span>&nbsp;<span class="ident" id="5068143">bufio</span><span class="op" id="5068148">.</span><span class="ident" id="5068149">NewWriter</span><span class="op" id="5068158">(</span><span class="ident" id="5068159">w</span><span class="op" id="5068160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068163">var</span>&nbsp;<span class="ident" id="5068167">tw</span>&nbsp;<span class="op" id="5068170">*</span><span class="ident" id="5068171">tabwriter</span><span class="op" id="5068180">.</span><span class="ident" id="5068181">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068189">w</span>&nbsp;<span class="op" id="5068191">=</span>&nbsp;<span class="ident" id="5068193">b</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068196">if</span>&nbsp;<span class="ident" id="5068199">debug</span>&nbsp;<span class="op" id="5068205">&gt;</span>&nbsp;<span class="num" id="5068207">0</span>&nbsp;<span class="op" id="5068209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068213">tw</span>&nbsp;<span class="op" id="5068216">=</span>&nbsp;<span class="ident" id="5068218">tabwriter</span><span class="op" id="5068227">.</span><span class="ident" id="5068228">NewWriter</span><span class="op" id="5068237">(</span><span class="ident" id="5068238">w</span><span class="op" id="5068239">,</span>&nbsp;<span class="num" id="5068241">1</span><span class="op" id="5068242">,</span>&nbsp;<span class="num" id="5068244">8</span><span class="op" id="5068245">,</span>&nbsp;<span class="num" id="5068247">1</span><span class="op" id="5068248">,</span>&nbsp;<span class="string" id="5068250">&#39;\t&#39;</span><span class="op" id="5068254">,</span>&nbsp;<span class="num" id="5068256">0</span><span class="op" id="5068257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068261">w</span>&nbsp;<span class="op" id="5068263">=</span>&nbsp;<span class="ident" id="5068265">tw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068273">fmt</span><span class="op" id="5068276">.</span><span class="ident" id="5068277">Fprintf</span><span class="op" id="5068284">(</span><span class="ident" id="5068285">w</span><span class="op" id="5068286">,</span>&nbsp;<span class="string" id="5068288">&#34;%s&nbsp;profile:&nbsp;total&nbsp;%d\n&#34;</span><span class="op" id="5068312">,</span>&nbsp;<span class="ident" id="5068314">name</span><span class="op" id="5068318">,</span>&nbsp;<span class="ident" id="5068320">p</span><span class="op" id="5068321">.</span><span class="ident" id="5068322">Len</span><span class="op" id="5068325">(</span><span class="op" id="5068326">)</span><span class="op" id="5068327">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068331">//&nbsp;Build&nbsp;count&nbsp;of&nbsp;each&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068362">var</span>&nbsp;<span class="ident" id="5068366">buf</span>&nbsp;<span class="ident" id="5068370">bytes</span><span class="op" id="5068375">.</span><span class="ident" id="5068376">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068384">key</span>&nbsp;<span class="op" id="5068388">:=</span>&nbsp;<span class="keyword" id="5068391">func</span><span class="op" id="5068395">(</span><span class="ident" id="5068396">stk</span>&nbsp;<span class="op" id="5068400">[</span><span class="op" id="5068401">]</span><span class="builtintype" id="5068402">uintptr</span><span class="op" id="5068409">)</span>&nbsp;<span class="builtintype" id="5068411">string</span>&nbsp;<span class="op" id="5068418">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068422">buf</span><span class="op" id="5068425">.</span><span class="ident" id="5068426">Reset</span><span class="op" id="5068431">(</span><span class="op" id="5068432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068436">fmt</span><span class="op" id="5068439">.</span><span class="ident" id="5068440">Fprintf</span><span class="op" id="5068447">(</span><span class="op" id="5068448">&amp;</span><span class="ident" id="5068449">buf</span><span class="op" id="5068452">,</span>&nbsp;<span class="string" id="5068454">&#34;@&#34;</span><span class="op" id="5068457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068461">for</span>&nbsp;<span class="ident" id="5068465">_</span><span class="op" id="5068466">,</span>&nbsp;<span class="ident" id="5068468">pc</span>&nbsp;<span class="op" id="5068471">:=</span>&nbsp;<span class="keyword" id="5068474">range</span>&nbsp;<span class="ident" id="5068480">stk</span>&nbsp;<span class="op" id="5068484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068489">fmt</span><span class="op" id="5068492">.</span><span class="ident" id="5068493">Fprintf</span><span class="op" id="5068500">(</span><span class="op" id="5068501">&amp;</span><span class="ident" id="5068502">buf</span><span class="op" id="5068505">,</span>&nbsp;<span class="string" id="5068507">&#34;&nbsp;%#x&#34;</span><span class="op" id="5068513">,</span>&nbsp;<span class="ident" id="5068515">pc</span><span class="op" id="5068517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068521">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068525">return</span>&nbsp;<span class="ident" id="5068532">buf</span><span class="op" id="5068535">.</span><span class="ident" id="5068536">String</span><span class="op" id="5068542">(</span><span class="op" id="5068543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068549">m</span>&nbsp;<span class="op" id="5068551">:=</span>&nbsp;<span class="keyword" id="5068554">map</span><span class="op" id="5068557">[</span><span class="builtintype" id="5068558">string</span><span class="op" id="5068564">]</span><span class="builtintype" id="5068565">int</span><span class="op" id="5068568">{</span><span class="op" id="5068569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068572">n</span>&nbsp;<span class="op" id="5068574">:=</span>&nbsp;<span class="ident" id="5068577">p</span><span class="op" id="5068578">.</span><span class="ident" id="5068579">Len</span><span class="op" id="5068582">(</span><span class="op" id="5068583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068586">for</span>&nbsp;<span class="ident" id="5068590">i</span>&nbsp;<span class="op" id="5068592">:=</span>&nbsp;<span class="num" id="5068595">0</span><span class="op" id="5068596">;</span>&nbsp;<span class="ident" id="5068598">i</span>&nbsp;<span class="op" id="5068600">&lt;</span>&nbsp;<span class="ident" id="5068602">n</span><span class="op" id="5068603">;</span>&nbsp;<span class="ident" id="5068605">i</span><span class="op" id="5068606">++</span>&nbsp;<span class="op" id="5068609">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068613">m</span><span class="op" id="5068614">[</span><span class="ident" id="5068615">key</span><span class="op" id="5068618">(</span><span class="ident" id="5068619">p</span><span class="op" id="5068620">.</span><span class="ident" id="5068621">Stack</span><span class="op" id="5068626">(</span><span class="ident" id="5068627">i</span><span class="op" id="5068628">)</span><span class="op" id="5068629">)</span><span class="op" id="5068630">]</span><span class="op" id="5068631">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068639">//&nbsp;Print&nbsp;stacks,&nbsp;listing&nbsp;count&nbsp;on&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;a&nbsp;unique&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068710">for</span>&nbsp;<span class="ident" id="5068714">i</span>&nbsp;<span class="op" id="5068716">:=</span>&nbsp;<span class="num" id="5068719">0</span><span class="op" id="5068720">;</span>&nbsp;<span class="ident" id="5068722">i</span>&nbsp;<span class="op" id="5068724">&lt;</span>&nbsp;<span class="ident" id="5068726">n</span><span class="op" id="5068727">;</span>&nbsp;<span class="ident" id="5068729">i</span><span class="op" id="5068730">++</span>&nbsp;<span class="op" id="5068733">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068737">stk</span>&nbsp;<span class="op" id="5068741">:=</span>&nbsp;<span class="ident" id="5068744">p</span><span class="op" id="5068745">.</span><span class="ident" id="5068746">Stack</span><span class="op" id="5068751">(</span><span class="ident" id="5068752">i</span><span class="op" id="5068753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068757">s</span>&nbsp;<span class="op" id="5068759">:=</span>&nbsp;<span class="ident" id="5068762">key</span><span class="op" id="5068765">(</span><span class="ident" id="5068766">stk</span><span class="op" id="5068769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068773">if</span>&nbsp;<span class="ident" id="5068776">count</span>&nbsp;<span class="op" id="5068782">:=</span>&nbsp;<span class="ident" id="5068785">m</span><span class="op" id="5068786">[</span><span class="ident" id="5068787">s</span><span class="op" id="5068788">]</span><span class="op" id="5068789">;</span>&nbsp;<span class="ident" id="5068791">count</span>&nbsp;<span class="op" id="5068797">!=</span>&nbsp;<span class="num" id="5068800">0</span>&nbsp;<span class="op" id="5068802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068807">fmt</span><span class="op" id="5068810">.</span><span class="ident" id="5068811">Fprintf</span><span class="op" id="5068818">(</span><span class="ident" id="5068819">w</span><span class="op" id="5068820">,</span>&nbsp;<span class="string" id="5068822">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="5068831">,</span>&nbsp;<span class="ident" id="5068833">count</span><span class="op" id="5068838">,</span>&nbsp;<span class="ident" id="5068840">s</span><span class="op" id="5068841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068846">if</span>&nbsp;<span class="ident" id="5068849">debug</span>&nbsp;<span class="op" id="5068855">&gt;</span>&nbsp;<span class="num" id="5068857">0</span>&nbsp;<span class="op" id="5068859">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068865">printStackRecord</span><span class="op" id="5068881">(</span><span class="ident" id="5068882">w</span><span class="op" id="5068883">,</span>&nbsp;<span class="ident" id="5068885">stk</span><span class="op" id="5068888">,</span>&nbsp;<span class="builtintype" id="5068890">false</span><span class="op" id="5068895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5068905">delete</span><span class="op" id="5068911">(</span><span class="ident" id="5068912">m</span><span class="op" id="5068913">,</span>&nbsp;<span class="ident" id="5068915">s</span><span class="op" id="5068916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068923">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068927">if</span>&nbsp;<span class="ident" id="5068930">tw</span>&nbsp;<span class="op" id="5068933">!=</span>&nbsp;<span class="ident" id="5068936">nil</span>&nbsp;<span class="op" id="5068940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068944">tw</span><span class="op" id="5068946">.</span><span class="ident" id="5068947">Flush</span><span class="op" id="5068952">(</span><span class="op" id="5068953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068959">return</span>&nbsp;<span class="ident" id="5068966">b</span><span class="op" id="5068967">.</span><span class="ident" id="5068968">Flush</span><span class="op" id="5068973">(</span><span class="op" id="5068974">)</span><br>
<span class="lineno">315</span><span class="op" id="5068976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5068979">//&nbsp;printStackRecord&nbsp;prints&nbsp;the&nbsp;function&nbsp;+&nbsp;source&nbsp;line&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="5069045">//&nbsp;for&nbsp;a&nbsp;single&nbsp;stack&nbsp;trace.</span><br>
<span class="lineno"></span><span class="keyword" id="5069074">func</span>&nbsp;<span class="ident" id="5069079">printStackRecord</span><span class="op" id="5069095">(</span><span class="ident" id="5069096">w</span>&nbsp;<span class="ident" id="5069098">io</span><span class="op" id="5069100">.</span><span class="ident" id="5069101">Writer</span><span class="op" id="5069107">,</span>&nbsp;<span class="ident" id="5069109">stk</span>&nbsp;<span class="op" id="5069113">[</span><span class="op" id="5069114">]</span><span class="builtintype" id="5069115">uintptr</span><span class="op" id="5069122">,</span>&nbsp;<span class="ident" id="5069124">allFrames</span>&nbsp;<span class="builtintype" id="5069134">bool</span><span class="op" id="5069138">)</span>&nbsp;<span class="op" id="5069140">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069143">show</span>&nbsp;<span class="op" id="5069148">:=</span>&nbsp;<span class="ident" id="5069151">allFrames</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069162">wasPanic</span>&nbsp;<span class="op" id="5069171">:=</span>&nbsp;<span class="builtintype" id="5069174">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069181">for</span>&nbsp;<span class="ident" id="5069185">i</span><span class="op" id="5069186">,</span>&nbsp;<span class="ident" id="5069188">pc</span>&nbsp;<span class="op" id="5069191">:=</span>&nbsp;<span class="keyword" id="5069194">range</span>&nbsp;<span class="ident" id="5069200">stk</span>&nbsp;<span class="op" id="5069204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069208">f</span>&nbsp;<span class="op" id="5069210">:=</span>&nbsp;<span class="ident" id="5069213">runtime</span><span class="op" id="5069220">.</span><span class="ident" id="5069221">FuncForPC</span><span class="op" id="5069230">(</span><span class="ident" id="5069231">pc</span><span class="op" id="5069233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069237">if</span>&nbsp;<span class="ident" id="5069240">f</span>&nbsp;<span class="op" id="5069242">==</span>&nbsp;<span class="ident" id="5069245">nil</span>&nbsp;<span class="op" id="5069249">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069254">show</span>&nbsp;<span class="op" id="5069259">=</span>&nbsp;<span class="builtintype" id="5069261">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069269">fmt</span><span class="op" id="5069272">.</span><span class="ident" id="5069273">Fprintf</span><span class="op" id="5069280">(</span><span class="ident" id="5069281">w</span><span class="op" id="5069282">,</span>&nbsp;<span class="string" id="5069284">&#34;#\t%#x\n&#34;</span><span class="op" id="5069294">,</span>&nbsp;<span class="ident" id="5069296">pc</span><span class="op" id="5069298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069303">wasPanic</span>&nbsp;<span class="op" id="5069312">=</span>&nbsp;<span class="builtintype" id="5069314">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069322">}</span>&nbsp;<span class="keyword" id="5069324">else</span>&nbsp;<span class="op" id="5069329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069334">tracepc</span>&nbsp;<span class="op" id="5069342">:=</span>&nbsp;<span class="ident" id="5069345">pc</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5069351">//&nbsp;Back&nbsp;up&nbsp;to&nbsp;call&nbsp;instruction.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069386">if</span>&nbsp;<span class="ident" id="5069389">i</span>&nbsp;<span class="op" id="5069391">&gt;</span>&nbsp;<span class="num" id="5069393">0</span>&nbsp;<span class="op" id="5069395">&amp;&amp;</span>&nbsp;<span class="ident" id="5069398">pc</span>&nbsp;<span class="op" id="5069401">&gt;</span>&nbsp;<span class="ident" id="5069403">f</span><span class="op" id="5069404">.</span><span class="ident" id="5069405">Entry</span><span class="op" id="5069410">(</span><span class="op" id="5069411">)</span>&nbsp;<span class="op" id="5069413">&amp;&amp;</span>&nbsp;<span class="op" id="5069416">!</span><span class="ident" id="5069417">wasPanic</span>&nbsp;<span class="op" id="5069426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069432">if</span>&nbsp;<span class="ident" id="5069435">runtime</span><span class="op" id="5069442">.</span><span class="ident" id="5069443">GOARCH</span>&nbsp;<span class="op" id="5069450">==</span>&nbsp;<span class="string" id="5069453">&#34;386&#34;</span>&nbsp;<span class="op" id="5069459">||</span>&nbsp;<span class="ident" id="5069462">runtime</span><span class="op" id="5069469">.</span><span class="ident" id="5069470">GOARCH</span>&nbsp;<span class="op" id="5069477">==</span>&nbsp;<span class="string" id="5069480">&#34;amd64&#34;</span>&nbsp;<span class="op" id="5069488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069495">tracepc</span><span class="op" id="5069502">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069509">}</span>&nbsp;<span class="keyword" id="5069511">else</span>&nbsp;<span class="op" id="5069516">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069523">tracepc</span>&nbsp;<span class="op" id="5069531">-=</span>&nbsp;<span class="num" id="5069534">4</span>&nbsp;<span class="comment" id="5069536">//&nbsp;arm,&nbsp;etc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069562">file</span><span class="op" id="5069566">,</span>&nbsp;<span class="ident" id="5069568">line</span>&nbsp;<span class="op" id="5069573">:=</span>&nbsp;<span class="ident" id="5069576">f</span><span class="op" id="5069577">.</span><span class="ident" id="5069578">FileLine</span><span class="op" id="5069586">(</span><span class="ident" id="5069587">tracepc</span><span class="op" id="5069594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069599">name</span>&nbsp;<span class="op" id="5069604">:=</span>&nbsp;<span class="ident" id="5069607">f</span><span class="op" id="5069608">.</span><span class="ident" id="5069609">Name</span><span class="op" id="5069613">(</span><span class="op" id="5069614">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5069619">//&nbsp;Hide&nbsp;runtime.goexit&nbsp;and&nbsp;any&nbsp;runtime&nbsp;functions&nbsp;at&nbsp;the&nbsp;beginning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5069689">//&nbsp;This&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;for&nbsp;allocation&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069740">wasPanic</span>&nbsp;<span class="op" id="5069749">=</span>&nbsp;<span class="ident" id="5069751">name</span>&nbsp;<span class="op" id="5069756">==</span>&nbsp;<span class="string" id="5069759">&#34;runtime.panic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069778">if</span>&nbsp;<span class="ident" id="5069781">name</span>&nbsp;<span class="op" id="5069786">==</span>&nbsp;<span class="string" id="5069789">&#34;runtime.goexit&#34;</span>&nbsp;<span class="op" id="5069806">||</span>&nbsp;<span class="op" id="5069809">!</span><span class="ident" id="5069810">show</span>&nbsp;<span class="op" id="5069815">&amp;&amp;</span>&nbsp;<span class="ident" id="5069818">strings</span><span class="op" id="5069825">.</span><span class="ident" id="5069826">HasPrefix</span><span class="op" id="5069835">(</span><span class="ident" id="5069836">name</span><span class="op" id="5069840">,</span>&nbsp;<span class="string" id="5069842">&#34;runtime.&#34;</span><span class="op" id="5069852">)</span>&nbsp;<span class="op" id="5069854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069860">continue</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069877">show</span>&nbsp;<span class="op" id="5069882">=</span>&nbsp;<span class="builtintype" id="5069884">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069892">fmt</span><span class="op" id="5069895">.</span><span class="ident" id="5069896">Fprintf</span><span class="op" id="5069903">(</span><span class="ident" id="5069904">w</span><span class="op" id="5069905">,</span>&nbsp;<span class="string" id="5069907">&#34;#\t%#x\t%s+%#x\t%s:%d\n&#34;</span><span class="op" id="5069932">,</span>&nbsp;<span class="ident" id="5069934">pc</span><span class="op" id="5069936">,</span>&nbsp;<span class="ident" id="5069938">name</span><span class="op" id="5069942">,</span>&nbsp;<span class="ident" id="5069944">pc</span><span class="op" id="5069946">-</span><span class="ident" id="5069947">f</span><span class="op" id="5069948">.</span><span class="ident" id="5069949">Entry</span><span class="op" id="5069954">(</span><span class="op" id="5069955">)</span><span class="op" id="5069956">,</span>&nbsp;<span class="ident" id="5069958">file</span><span class="op" id="5069962">,</span>&nbsp;<span class="ident" id="5069964">line</span><span class="op" id="5069968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069975">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069978">if</span>&nbsp;<span class="op" id="5069981">!</span><span class="ident" id="5069982">show</span>&nbsp;<span class="op" id="5069987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5069991">//&nbsp;We&nbsp;didn&#39;t&nbsp;print&nbsp;anything;&nbsp;do&nbsp;it&nbsp;again,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070035">//&nbsp;and&nbsp;this&nbsp;time&nbsp;include&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070081">printStackRecord</span><span class="op" id="5070097">(</span><span class="ident" id="5070098">w</span><span class="op" id="5070099">,</span>&nbsp;<span class="ident" id="5070101">stk</span><span class="op" id="5070104">,</span>&nbsp;<span class="builtintype" id="5070106">true</span><span class="op" id="5070110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070114">return</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070125">fmt</span><span class="op" id="5070128">.</span><span class="ident" id="5070129">Fprintf</span><span class="op" id="5070136">(</span><span class="ident" id="5070137">w</span><span class="op" id="5070138">,</span>&nbsp;<span class="string" id="5070140">&#34;\n&#34;</span><span class="op" id="5070144">)</span><br>
<span class="lineno"></span><span class="op" id="5070146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5070149">//&nbsp;Interface&nbsp;to&nbsp;system&nbsp;profiles.</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="5070183">type</span>&nbsp;<span class="ident" id="5070188">byInUseBytes</span>&nbsp;<span class="op" id="5070201">[</span><span class="op" id="5070202">]</span><span class="ident" id="5070203">runtime</span><span class="op" id="5070210">.</span><span class="ident" id="5070211">MemProfileRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5070229">func</span>&nbsp;<span class="op" id="5070234">(</span><span class="ident" id="5070235">x</span>&nbsp;<span class="ident" id="5070237">byInUseBytes</span><span class="op" id="5070249">)</span>&nbsp;<span class="ident" id="5070251">Len</span><span class="op" id="5070254">(</span><span class="op" id="5070255">)</span>&nbsp;<span class="builtintype" id="5070257">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5070271">{</span>&nbsp;<span class="keyword" id="5070273">return</span>&nbsp;<span class="builtinfunc" id="5070280">len</span><span class="op" id="5070283">(</span><span class="ident" id="5070284">x</span><span class="op" id="5070285">)</span>&nbsp;<span class="op" id="5070287">}</span><br>
<span class="lineno"></span><span class="keyword" id="5070289">func</span>&nbsp;<span class="op" id="5070294">(</span><span class="ident" id="5070295">x</span>&nbsp;<span class="ident" id="5070297">byInUseBytes</span><span class="op" id="5070309">)</span>&nbsp;<span class="ident" id="5070311">Swap</span><span class="op" id="5070315">(</span><span class="ident" id="5070316">i</span><span class="op" id="5070317">,</span>&nbsp;<span class="ident" id="5070319">j</span>&nbsp;<span class="builtintype" id="5070321">int</span><span class="op" id="5070324">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5070331">{</span>&nbsp;<span class="ident" id="5070333">x</span><span class="op" id="5070334">[</span><span class="ident" id="5070335">i</span><span class="op" id="5070336">]</span><span class="op" id="5070337">,</span>&nbsp;<span class="ident" id="5070339">x</span><span class="op" id="5070340">[</span><span class="ident" id="5070341">j</span><span class="op" id="5070342">]</span>&nbsp;<span class="op" id="5070344">=</span>&nbsp;<span class="ident" id="5070346">x</span><span class="op" id="5070347">[</span><span class="ident" id="5070348">j</span><span class="op" id="5070349">]</span><span class="op" id="5070350">,</span>&nbsp;<span class="ident" id="5070352">x</span><span class="op" id="5070353">[</span><span class="ident" id="5070354">i</span><span class="op" id="5070355">]</span>&nbsp;<span class="op" id="5070357">}</span><br>
<span class="lineno">365</span><span class="keyword" id="5070359">func</span>&nbsp;<span class="op" id="5070364">(</span><span class="ident" id="5070365">x</span>&nbsp;<span class="ident" id="5070367">byInUseBytes</span><span class="op" id="5070379">)</span>&nbsp;<span class="ident" id="5070381">Less</span><span class="op" id="5070385">(</span><span class="ident" id="5070386">i</span><span class="op" id="5070387">,</span>&nbsp;<span class="ident" id="5070389">j</span>&nbsp;<span class="builtintype" id="5070391">int</span><span class="op" id="5070394">)</span>&nbsp;<span class="builtintype" id="5070396">bool</span>&nbsp;<span class="op" id="5070401">{</span>&nbsp;<span class="keyword" id="5070403">return</span>&nbsp;<span class="ident" id="5070410">x</span><span class="op" id="5070411">[</span><span class="ident" id="5070412">i</span><span class="op" id="5070413">]</span><span class="op" id="5070414">.</span><span class="ident" id="5070415">InUseBytes</span><span class="op" id="5070425">(</span><span class="op" id="5070426">)</span>&nbsp;<span class="op" id="5070428">&gt;</span>&nbsp;<span class="ident" id="5070430">x</span><span class="op" id="5070431">[</span><span class="ident" id="5070432">j</span><span class="op" id="5070433">]</span><span class="op" id="5070434">.</span><span class="ident" id="5070435">InUseBytes</span><span class="op" id="5070445">(</span><span class="op" id="5070446">)</span>&nbsp;<span class="op" id="5070448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5070451">//&nbsp;WriteHeapProfile&nbsp;is&nbsp;shorthand&nbsp;for&nbsp;Lookup(&#34;heap&#34;).WriteTo(w,&nbsp;0).</span><br>
<span class="lineno"></span><span class="comment" id="5070518">//&nbsp;It&nbsp;is&nbsp;preserved&nbsp;for&nbsp;backwards&nbsp;compatibility.</span><br>
<span class="lineno"></span><span class="keyword" id="5070566">func</span>&nbsp;<span class="ident" id="5070571">WriteHeapProfile</span><span class="op" id="5070587">(</span><span class="ident" id="5070588">w</span>&nbsp;<span class="ident" id="5070590">io</span><span class="op" id="5070592">.</span><span class="ident" id="5070593">Writer</span><span class="op" id="5070599">)</span>&nbsp;<span class="builtintype" id="5070601">error</span>&nbsp;<span class="op" id="5070607">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070610">return</span>&nbsp;<span class="ident" id="5070617">writeHeap</span><span class="op" id="5070626">(</span><span class="ident" id="5070627">w</span><span class="op" id="5070628">,</span>&nbsp;<span class="num" id="5070630">0</span><span class="op" id="5070631">)</span><br>
<span class="lineno"></span><span class="op" id="5070633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5070636">//&nbsp;countHeap&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;heap&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5070700">func</span>&nbsp;<span class="ident" id="5070705">countHeap</span><span class="op" id="5070714">(</span><span class="op" id="5070715">)</span>&nbsp;<span class="builtintype" id="5070717">int</span>&nbsp;<span class="op" id="5070721">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070724">n</span><span class="op" id="5070725">,</span>&nbsp;<span class="ident" id="5070727">_</span>&nbsp;<span class="op" id="5070729">:=</span>&nbsp;<span class="ident" id="5070732">runtime</span><span class="op" id="5070739">.</span><span class="ident" id="5070740">MemProfile</span><span class="op" id="5070750">(</span><span class="ident" id="5070751">nil</span><span class="op" id="5070754">,</span>&nbsp;<span class="builtintype" id="5070756">true</span><span class="op" id="5070760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070763">return</span>&nbsp;<span class="ident" id="5070770">n</span><br>
<span class="lineno"></span><span class="op" id="5070772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5070775">//&nbsp;writeHeap&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;heap&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno">380</span><span class="keyword" id="5070834">func</span>&nbsp;<span class="ident" id="5070839">writeHeap</span><span class="op" id="5070848">(</span><span class="ident" id="5070849">w</span>&nbsp;<span class="ident" id="5070851">io</span><span class="op" id="5070853">.</span><span class="ident" id="5070854">Writer</span><span class="op" id="5070860">,</span>&nbsp;<span class="ident" id="5070862">debug</span>&nbsp;<span class="builtintype" id="5070868">int</span><span class="op" id="5070871">)</span>&nbsp;<span class="builtintype" id="5070873">error</span>&nbsp;<span class="op" id="5070879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070882">//&nbsp;Find&nbsp;out&nbsp;how&nbsp;many&nbsp;records&nbsp;there&nbsp;are&nbsp;(MemProfile(nil,&nbsp;true)),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070947">//&nbsp;allocate&nbsp;that&nbsp;many&nbsp;records,&nbsp;and&nbsp;get&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070997">//&nbsp;There&#39;s&nbsp;a&nbsp;race—more&nbsp;records&nbsp;might&nbsp;be&nbsp;added&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071054">//&nbsp;the&nbsp;two&nbsp;calls—so&nbsp;allocate&nbsp;a&nbsp;few&nbsp;extra&nbsp;records&nbsp;for&nbsp;safety</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071117">//&nbsp;and&nbsp;also&nbsp;try&nbsp;again&nbsp;if&nbsp;we&#39;re&nbsp;very&nbsp;unlucky.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071163">//&nbsp;The&nbsp;loop&nbsp;should&nbsp;only&nbsp;execute&nbsp;one&nbsp;iteration&nbsp;in&nbsp;the&nbsp;common&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071230">var</span>&nbsp;<span class="ident" id="5071234">p</span>&nbsp;<span class="op" id="5071236">[</span><span class="op" id="5071237">]</span><span class="ident" id="5071238">runtime</span><span class="op" id="5071245">.</span><span class="ident" id="5071246">MemProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071264">n</span><span class="op" id="5071265">,</span>&nbsp;<span class="ident" id="5071267">ok</span>&nbsp;<span class="op" id="5071270">:=</span>&nbsp;<span class="ident" id="5071273">runtime</span><span class="op" id="5071280">.</span><span class="ident" id="5071281">MemProfile</span><span class="op" id="5071291">(</span><span class="ident" id="5071292">nil</span><span class="op" id="5071295">,</span>&nbsp;<span class="builtintype" id="5071297">true</span><span class="op" id="5071301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071304">for</span>&nbsp;<span class="op" id="5071308">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071312">//&nbsp;Allocate&nbsp;room&nbsp;for&nbsp;a&nbsp;slightly&nbsp;bigger&nbsp;profile,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071362">//&nbsp;in&nbsp;case&nbsp;a&nbsp;few&nbsp;more&nbsp;entries&nbsp;have&nbsp;been&nbsp;added</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071410">//&nbsp;since&nbsp;the&nbsp;call&nbsp;to&nbsp;MemProfile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071445">p</span>&nbsp;<span class="op" id="5071447">=</span>&nbsp;<span class="builtinfunc" id="5071449">make</span><span class="op" id="5071453">(</span><span class="op" id="5071454">[</span><span class="op" id="5071455">]</span><span class="ident" id="5071456">runtime</span><span class="op" id="5071463">.</span><span class="ident" id="5071464">MemProfileRecord</span><span class="op" id="5071480">,</span>&nbsp;<span class="ident" id="5071482">n</span><span class="op" id="5071483">+</span><span class="num" id="5071484">50</span><span class="op" id="5071486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071490">n</span><span class="op" id="5071491">,</span>&nbsp;<span class="ident" id="5071493">ok</span>&nbsp;<span class="op" id="5071496">=</span>&nbsp;<span class="ident" id="5071498">runtime</span><span class="op" id="5071505">.</span><span class="ident" id="5071506">MemProfile</span><span class="op" id="5071516">(</span><span class="ident" id="5071517">p</span><span class="op" id="5071518">,</span>&nbsp;<span class="builtintype" id="5071520">true</span><span class="op" id="5071524">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071528">if</span>&nbsp;<span class="ident" id="5071531">ok</span>&nbsp;<span class="op" id="5071534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071539">p</span>&nbsp;<span class="op" id="5071541">=</span>&nbsp;<span class="ident" id="5071543">p</span><span class="op" id="5071544">[</span><span class="num" id="5071545">0</span><span class="op" id="5071546">:</span><span class="ident" id="5071547">n</span><span class="op" id="5071548">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071553">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071565">//&nbsp;Profile&nbsp;grew;&nbsp;try&nbsp;again.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071598">sort</span><span class="op" id="5071602">.</span><span class="ident" id="5071603">Sort</span><span class="op" id="5071607">(</span><span class="ident" id="5071608">byInUseBytes</span><span class="op" id="5071620">(</span><span class="ident" id="5071621">p</span><span class="op" id="5071622">)</span><span class="op" id="5071623">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071627">b</span>&nbsp;<span class="op" id="5071629">:=</span>&nbsp;<span class="ident" id="5071632">bufio</span><span class="op" id="5071637">.</span><span class="ident" id="5071638">NewWriter</span><span class="op" id="5071647">(</span><span class="ident" id="5071648">w</span><span class="op" id="5071649">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071652">var</span>&nbsp;<span class="ident" id="5071656">tw</span>&nbsp;<span class="op" id="5071659">*</span><span class="ident" id="5071660">tabwriter</span><span class="op" id="5071669">.</span><span class="ident" id="5071670">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071678">w</span>&nbsp;<span class="op" id="5071680">=</span>&nbsp;<span class="ident" id="5071682">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071685">if</span>&nbsp;<span class="ident" id="5071688">debug</span>&nbsp;<span class="op" id="5071694">&gt;</span>&nbsp;<span class="num" id="5071696">0</span>&nbsp;<span class="op" id="5071698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071702">tw</span>&nbsp;<span class="op" id="5071705">=</span>&nbsp;<span class="ident" id="5071707">tabwriter</span><span class="op" id="5071716">.</span><span class="ident" id="5071717">NewWriter</span><span class="op" id="5071726">(</span><span class="ident" id="5071727">w</span><span class="op" id="5071728">,</span>&nbsp;<span class="num" id="5071730">1</span><span class="op" id="5071731">,</span>&nbsp;<span class="num" id="5071733">8</span><span class="op" id="5071734">,</span>&nbsp;<span class="num" id="5071736">1</span><span class="op" id="5071737">,</span>&nbsp;<span class="string" id="5071739">&#39;\t&#39;</span><span class="op" id="5071743">,</span>&nbsp;<span class="num" id="5071745">0</span><span class="op" id="5071746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071750">w</span>&nbsp;<span class="op" id="5071752">=</span>&nbsp;<span class="ident" id="5071754">tw</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071762">var</span>&nbsp;<span class="ident" id="5071766">total</span>&nbsp;<span class="ident" id="5071772">runtime</span><span class="op" id="5071779">.</span><span class="ident" id="5071780">MemProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071798">for</span>&nbsp;<span class="ident" id="5071802">i</span>&nbsp;<span class="op" id="5071804">:=</span>&nbsp;<span class="keyword" id="5071807">range</span>&nbsp;<span class="ident" id="5071813">p</span>&nbsp;<span class="op" id="5071815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071819">r</span>&nbsp;<span class="op" id="5071821">:=</span>&nbsp;<span class="op" id="5071824">&amp;</span><span class="ident" id="5071825">p</span><span class="op" id="5071826">[</span><span class="ident" id="5071827">i</span><span class="op" id="5071828">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071832">total</span><span class="op" id="5071837">.</span><span class="ident" id="5071838">AllocBytes</span>&nbsp;<span class="op" id="5071849">+=</span>&nbsp;<span class="ident" id="5071852">r</span><span class="op" id="5071853">.</span><span class="ident" id="5071854">AllocBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071867">total</span><span class="op" id="5071872">.</span><span class="ident" id="5071873">AllocObjects</span>&nbsp;<span class="op" id="5071886">+=</span>&nbsp;<span class="ident" id="5071889">r</span><span class="op" id="5071890">.</span><span class="ident" id="5071891">AllocObjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071906">total</span><span class="op" id="5071911">.</span><span class="ident" id="5071912">FreeBytes</span>&nbsp;<span class="op" id="5071922">+=</span>&nbsp;<span class="ident" id="5071925">r</span><span class="op" id="5071926">.</span><span class="ident" id="5071927">FreeBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071939">total</span><span class="op" id="5071944">.</span><span class="ident" id="5071945">FreeObjects</span>&nbsp;<span class="op" id="5071957">+=</span>&nbsp;<span class="ident" id="5071960">r</span><span class="op" id="5071961">.</span><span class="ident" id="5071962">FreeObjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071975">}</span><br>
<span class="lineno">420</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071979">//&nbsp;Technically&nbsp;the&nbsp;rate&nbsp;is&nbsp;MemProfileRate&nbsp;not&nbsp;2*MemProfileRate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5072044">//&nbsp;but&nbsp;early&nbsp;versions&nbsp;of&nbsp;the&nbsp;C++&nbsp;heap&nbsp;profiler&nbsp;reported&nbsp;2*MemProfileRate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5072119">//&nbsp;so&nbsp;that&#39;s&nbsp;what&nbsp;pprof&nbsp;has&nbsp;come&nbsp;to&nbsp;expect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072164">fmt</span><span class="op" id="5072167">.</span><span class="ident" id="5072168">Fprintf</span><span class="op" id="5072175">(</span><span class="ident" id="5072176">w</span><span class="op" id="5072177">,</span>&nbsp;<span class="string" id="5072179">&#34;heap&nbsp;profile:&nbsp;%d:&nbsp;%d&nbsp;[%d:&nbsp;%d]&nbsp;@&nbsp;heap/%d\n&#34;</span><span class="op" id="5072222">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072226">total</span><span class="op" id="5072231">.</span><span class="ident" id="5072232">InUseObjects</span><span class="op" id="5072244">(</span><span class="op" id="5072245">)</span><span class="op" id="5072246">,</span>&nbsp;<span class="ident" id="5072248">total</span><span class="op" id="5072253">.</span><span class="ident" id="5072254">InUseBytes</span><span class="op" id="5072264">(</span><span class="op" id="5072265">)</span><span class="op" id="5072266">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072270">total</span><span class="op" id="5072275">.</span><span class="ident" id="5072276">AllocObjects</span><span class="op" id="5072288">,</span>&nbsp;<span class="ident" id="5072290">total</span><span class="op" id="5072295">.</span><span class="ident" id="5072296">AllocBytes</span><span class="op" id="5072306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5072310">2</span><span class="op" id="5072311">*</span><span class="ident" id="5072312">runtime</span><span class="op" id="5072319">.</span><span class="ident" id="5072320">MemProfileRate</span><span class="op" id="5072334">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072338">for</span>&nbsp;<span class="ident" id="5072342">i</span>&nbsp;<span class="op" id="5072344">:=</span>&nbsp;<span class="keyword" id="5072347">range</span>&nbsp;<span class="ident" id="5072353">p</span>&nbsp;<span class="op" id="5072355">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072359">r</span>&nbsp;<span class="op" id="5072361">:=</span>&nbsp;<span class="op" id="5072364">&amp;</span><span class="ident" id="5072365">p</span><span class="op" id="5072366">[</span><span class="ident" id="5072367">i</span><span class="op" id="5072368">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072372">fmt</span><span class="op" id="5072375">.</span><span class="ident" id="5072376">Fprintf</span><span class="op" id="5072383">(</span><span class="ident" id="5072384">w</span><span class="op" id="5072385">,</span>&nbsp;<span class="string" id="5072387">&#34;%d:&nbsp;%d&nbsp;[%d:&nbsp;%d]&nbsp;@&#34;</span><span class="op" id="5072406">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072411">r</span><span class="op" id="5072412">.</span><span class="ident" id="5072413">InUseObjects</span><span class="op" id="5072425">(</span><span class="op" id="5072426">)</span><span class="op" id="5072427">,</span>&nbsp;<span class="ident" id="5072429">r</span><span class="op" id="5072430">.</span><span class="ident" id="5072431">InUseBytes</span><span class="op" id="5072441">(</span><span class="op" id="5072442">)</span><span class="op" id="5072443">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072448">r</span><span class="op" id="5072449">.</span><span class="ident" id="5072450">AllocObjects</span><span class="op" id="5072462">,</span>&nbsp;<span class="ident" id="5072464">r</span><span class="op" id="5072465">.</span><span class="ident" id="5072466">AllocBytes</span><span class="op" id="5072476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072480">for</span>&nbsp;<span class="ident" id="5072484">_</span><span class="op" id="5072485">,</span>&nbsp;<span class="ident" id="5072487">pc</span>&nbsp;<span class="op" id="5072490">:=</span>&nbsp;<span class="keyword" id="5072493">range</span>&nbsp;<span class="ident" id="5072499">r</span><span class="op" id="5072500">.</span><span class="ident" id="5072501">Stack</span><span class="op" id="5072506">(</span><span class="op" id="5072507">)</span>&nbsp;<span class="op" id="5072509">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072514">fmt</span><span class="op" id="5072517">.</span><span class="ident" id="5072518">Fprintf</span><span class="op" id="5072525">(</span><span class="ident" id="5072526">w</span><span class="op" id="5072527">,</span>&nbsp;<span class="string" id="5072529">&#34;&nbsp;%#x&#34;</span><span class="op" id="5072535">,</span>&nbsp;<span class="ident" id="5072537">pc</span><span class="op" id="5072539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5072543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072547">fmt</span><span class="op" id="5072550">.</span><span class="ident" id="5072551">Fprintf</span><span class="op" id="5072558">(</span><span class="ident" id="5072559">w</span><span class="op" id="5072560">,</span>&nbsp;<span class="string" id="5072562">&#34;\n&#34;</span><span class="op" id="5072566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072570">if</span>&nbsp;<span class="ident" id="5072573">debug</span>&nbsp;<span class="op" id="5072579">&gt;</span>&nbsp;<span class="num" id="5072581">0</span>&nbsp;<span class="op" id="5072583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072588">printStackRecord</span><span class="op" id="5072604">(</span><span class="ident" id="5072605">w</span><span class="op" id="5072606">,</span>&nbsp;<span class="ident" id="5072608">r</span><span class="op" id="5072609">.</span><span class="ident" id="5072610">Stack</span><span class="op" id="5072615">(</span><span class="op" id="5072616">)</span><span class="op" id="5072617">,</span>&nbsp;<span class="builtintype" id="5072619">false</span><span class="op" id="5072624">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5072628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5072631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5072635">//&nbsp;Print&nbsp;memstats&nbsp;information&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5072671">//&nbsp;Pprof&nbsp;will&nbsp;ignore,&nbsp;but&nbsp;useful&nbsp;for&nbsp;people</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072716">if</span>&nbsp;<span class="ident" id="5072719">debug</span>&nbsp;<span class="op" id="5072725">&gt;</span>&nbsp;<span class="num" id="5072727">0</span>&nbsp;<span class="op" id="5072729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072733">s</span>&nbsp;<span class="op" id="5072735">:=</span>&nbsp;<span class="builtinfunc" id="5072738">new</span><span class="op" id="5072741">(</span><span class="ident" id="5072742">runtime</span><span class="op" id="5072749">.</span><span class="ident" id="5072750">MemStats</span><span class="op" id="5072758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072762">runtime</span><span class="op" id="5072769">.</span><span class="ident" id="5072770">ReadMemStats</span><span class="op" id="5072782">(</span><span class="ident" id="5072783">s</span><span class="op" id="5072784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072788">fmt</span><span class="op" id="5072791">.</span><span class="ident" id="5072792">Fprintf</span><span class="op" id="5072799">(</span><span class="ident" id="5072800">w</span><span class="op" id="5072801">,</span>&nbsp;<span class="string" id="5072803">&#34;\n#&nbsp;runtime.MemStats\n&#34;</span><span class="op" id="5072827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072831">fmt</span><span class="op" id="5072834">.</span><span class="ident" id="5072835">Fprintf</span><span class="op" id="5072842">(</span><span class="ident" id="5072843">w</span><span class="op" id="5072844">,</span>&nbsp;<span class="string" id="5072846">&#34;#&nbsp;Alloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5072862">,</span>&nbsp;<span class="ident" id="5072864">s</span><span class="op" id="5072865">.</span><span class="ident" id="5072866">Alloc</span><span class="op" id="5072871">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072875">fmt</span><span class="op" id="5072878">.</span><span class="ident" id="5072879">Fprintf</span><span class="op" id="5072886">(</span><span class="ident" id="5072887">w</span><span class="op" id="5072888">,</span>&nbsp;<span class="string" id="5072890">&#34;#&nbsp;TotalAlloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5072911">,</span>&nbsp;<span class="ident" id="5072913">s</span><span class="op" id="5072914">.</span><span class="ident" id="5072915">TotalAlloc</span><span class="op" id="5072925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072929">fmt</span><span class="op" id="5072932">.</span><span class="ident" id="5072933">Fprintf</span><span class="op" id="5072940">(</span><span class="ident" id="5072941">w</span><span class="op" id="5072942">,</span>&nbsp;<span class="string" id="5072944">&#34;#&nbsp;Sys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5072958">,</span>&nbsp;<span class="ident" id="5072960">s</span><span class="op" id="5072961">.</span><span class="ident" id="5072962">Sys</span><span class="op" id="5072965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072969">fmt</span><span class="op" id="5072972">.</span><span class="ident" id="5072973">Fprintf</span><span class="op" id="5072980">(</span><span class="ident" id="5072981">w</span><span class="op" id="5072982">,</span>&nbsp;<span class="string" id="5072984">&#34;#&nbsp;Lookups&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5073002">,</span>&nbsp;<span class="ident" id="5073004">s</span><span class="op" id="5073005">.</span><span class="ident" id="5073006">Lookups</span><span class="op" id="5073013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073017">fmt</span><span class="op" id="5073020">.</span><span class="ident" id="5073021">Fprintf</span><span class="op" id="5073028">(</span><span class="ident" id="5073029">w</span><span class="op" id="5073030">,</span>&nbsp;<span class="string" id="5073032">&#34;#&nbsp;Mallocs&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5073050">,</span>&nbsp;<span class="ident" id="5073052">s</span><span class="op" id="5073053">.</span><span class="ident" id="5073054">Mallocs</span><span class="op" id="5073061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073065">fmt</span><span class="op" id="5073068">.</span><span class="ident" id="5073069">Fprintf</span><span class="op" id="5073076">(</span><span class="ident" id="5073077">w</span><span class="op" id="5073078">,</span>&nbsp;<span class="string" id="5073080">&#34;#&nbsp;Frees&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5073096">,</span>&nbsp;<span class="ident" id="5073098">s</span><span class="op" id="5073099">.</span><span class="ident" id="5073100">Frees</span><span class="op" id="5073105">)</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073110">fmt</span><span class="op" id="5073113">.</span><span class="ident" id="5073114">Fprintf</span><span class="op" id="5073121">(</span><span class="ident" id="5073122">w</span><span class="op" id="5073123">,</span>&nbsp;<span class="string" id="5073125">&#34;#&nbsp;HeapAlloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5073145">,</span>&nbsp;<span class="ident" id="5073147">s</span><span class="op" id="5073148">.</span><span class="ident" id="5073149">HeapAlloc</span><span class="op" id="5073158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073162">fmt</span><span class="op" id="5073165">.</span><span class="ident" id="5073166">Fprintf</span><span class="op" id="5073173">(</span><span class="ident" id="5073174">w</span><span class="op" id="5073175">,</span>&nbsp;<span class="string" id="5073177">&#34;#&nbsp;HeapSys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5073195">,</span>&nbsp;<span class="ident" id="5073197">s</span><span class="op" id="5073198">.</span><span class="ident" id="5073199">HeapSys</span><span class="op" id="5073206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073210">fmt</span><span class="op" id="5073213">.</span><span class="ident" id="5073214">Fprintf</span><span class="op" id="5073221">(</span><span class="ident" id="5073222">w</span><span class="op" id="5073223">,</span>&nbsp;<span class="string" id="5073225">&#34;#&nbsp;HeapIdle&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5073244">,</span>&nbsp;<span class="ident" id="5073246">s</span><span class="op" id="5073247">.</span><span class="ident" id="5073248">HeapIdle</span><span class="op" id="5073256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073260">fmt</span><span class="op" id="5073263">.</span><span class="ident" id="5073264">Fprintf</span><span class="op" id="5073271">(</span><span class="ident" id="5073272">w</span><span class="op" id="5073273">,</span>&nbsp;<span class="string" id="5073275">&#34;#&nbsp;HeapInuse&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5073295">,</span>&nbsp;<span class="ident" id="5073297">s</span><span class="op" id="5073298">.</span><span class="ident" id="5073299">HeapInuse</span><span class="op" id="5073308">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073312">fmt</span><span class="op" id="5073315">.</span><span class="ident" id="5073316">Fprintf</span><span class="op" id="5073323">(</span><span class="ident" id="5073324">w</span><span class="op" id="5073325">,</span>&nbsp;<span class="string" id="5073327">&#34;#&nbsp;HeapReleased&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5073350">,</span>&nbsp;<span class="ident" id="5073352">s</span><span class="op" id="5073353">.</span><span class="ident" id="5073354">HeapReleased</span><span class="op" id="5073366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073370">fmt</span><span class="op" id="5073373">.</span><span class="ident" id="5073374">Fprintf</span><span class="op" id="5073381">(</span><span class="ident" id="5073382">w</span><span class="op" id="5073383">,</span>&nbsp;<span class="string" id="5073385">&#34;#&nbsp;HeapObjects&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5073407">,</span>&nbsp;<span class="ident" id="5073409">s</span><span class="op" id="5073410">.</span><span class="ident" id="5073411">HeapObjects</span><span class="op" id="5073422">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073427">fmt</span><span class="op" id="5073430">.</span><span class="ident" id="5073431">Fprintf</span><span class="op" id="5073438">(</span><span class="ident" id="5073439">w</span><span class="op" id="5073440">,</span>&nbsp;<span class="string" id="5073442">&#34;#&nbsp;Stack&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="5073463">,</span>&nbsp;<span class="ident" id="5073465">s</span><span class="op" id="5073466">.</span><span class="ident" id="5073467">StackInuse</span><span class="op" id="5073477">,</span>&nbsp;<span class="ident" id="5073479">s</span><span class="op" id="5073480">.</span><span class="ident" id="5073481">StackSys</span><span class="op" id="5073489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073493">fmt</span><span class="op" id="5073496">.</span><span class="ident" id="5073497">Fprintf</span><span class="op" id="5073504">(</span><span class="ident" id="5073505">w</span><span class="op" id="5073506">,</span>&nbsp;<span class="string" id="5073508">&#34;#&nbsp;MSpan&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="5073529">,</span>&nbsp;<span class="ident" id="5073531">s</span><span class="op" id="5073532">.</span><span class="ident" id="5073533">MSpanInuse</span><span class="op" id="5073543">,</span>&nbsp;<span class="ident" id="5073545">s</span><span class="op" id="5073546">.</span><span class="ident" id="5073547">MSpanSys</span><span class="op" id="5073555">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073559">fmt</span><span class="op" id="5073562">.</span><span class="ident" id="5073563">Fprintf</span><span class="op" id="5073570">(</span><span class="ident" id="5073571">w</span><span class="op" id="5073572">,</span>&nbsp;<span class="string" id="5073574">&#34;#&nbsp;MCache&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="5073596">,</span>&nbsp;<span class="ident" id="5073598">s</span><span class="op" id="5073599">.</span><span class="ident" id="5073600">MCacheInuse</span><span class="op" id="5073611">,</span>&nbsp;<span class="ident" id="5073613">s</span><span class="op" id="5073614">.</span><span class="ident" id="5073615">MCacheSys</span><span class="op" id="5073624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073628">fmt</span><span class="op" id="5073631">.</span><span class="ident" id="5073632">Fprintf</span><span class="op" id="5073639">(</span><span class="ident" id="5073640">w</span><span class="op" id="5073641">,</span>&nbsp;<span class="string" id="5073643">&#34;#&nbsp;BuckHashSys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5073665">,</span>&nbsp;<span class="ident" id="5073667">s</span><span class="op" id="5073668">.</span><span class="ident" id="5073669">BuckHashSys</span><span class="op" id="5073680">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073685">fmt</span><span class="op" id="5073688">.</span><span class="ident" id="5073689">Fprintf</span><span class="op" id="5073696">(</span><span class="ident" id="5073697">w</span><span class="op" id="5073698">,</span>&nbsp;<span class="string" id="5073700">&#34;#&nbsp;NextGC&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5073717">,</span>&nbsp;<span class="ident" id="5073719">s</span><span class="op" id="5073720">.</span><span class="ident" id="5073721">NextGC</span><span class="op" id="5073727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073731">fmt</span><span class="op" id="5073734">.</span><span class="ident" id="5073735">Fprintf</span><span class="op" id="5073742">(</span><span class="ident" id="5073743">w</span><span class="op" id="5073744">,</span>&nbsp;<span class="string" id="5073746">&#34;#&nbsp;PauseNs&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5073764">,</span>&nbsp;<span class="ident" id="5073766">s</span><span class="op" id="5073767">.</span><span class="ident" id="5073768">PauseNs</span><span class="op" id="5073775">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073779">fmt</span><span class="op" id="5073782">.</span><span class="ident" id="5073783">Fprintf</span><span class="op" id="5073790">(</span><span class="ident" id="5073791">w</span><span class="op" id="5073792">,</span>&nbsp;<span class="string" id="5073794">&#34;#&nbsp;NumGC&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5073810">,</span>&nbsp;<span class="ident" id="5073812">s</span><span class="op" id="5073813">.</span><span class="ident" id="5073814">NumGC</span><span class="op" id="5073819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073823">fmt</span><span class="op" id="5073826">.</span><span class="ident" id="5073827">Fprintf</span><span class="op" id="5073834">(</span><span class="ident" id="5073835">w</span><span class="op" id="5073836">,</span>&nbsp;<span class="string" id="5073838">&#34;#&nbsp;EnableGC&nbsp;=&nbsp;%v\n&#34;</span><span class="op" id="5073857">,</span>&nbsp;<span class="ident" id="5073859">s</span><span class="op" id="5073860">.</span><span class="ident" id="5073861">EnableGC</span><span class="op" id="5073869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073873">fmt</span><span class="op" id="5073876">.</span><span class="ident" id="5073877">Fprintf</span><span class="op" id="5073884">(</span><span class="ident" id="5073885">w</span><span class="op" id="5073886">,</span>&nbsp;<span class="string" id="5073888">&#34;#&nbsp;DebugGC&nbsp;=&nbsp;%v\n&#34;</span><span class="op" id="5073906">,</span>&nbsp;<span class="ident" id="5073908">s</span><span class="op" id="5073909">.</span><span class="ident" id="5073910">DebugGC</span><span class="op" id="5073917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5073920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073924">if</span>&nbsp;<span class="ident" id="5073927">tw</span>&nbsp;<span class="op" id="5073930">!=</span>&nbsp;<span class="ident" id="5073933">nil</span>&nbsp;<span class="op" id="5073937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073941">tw</span><span class="op" id="5073943">.</span><span class="ident" id="5073944">Flush</span><span class="op" id="5073949">(</span><span class="op" id="5073950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5073953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073956">return</span>&nbsp;<span class="ident" id="5073963">b</span><span class="op" id="5073964">.</span><span class="ident" id="5073965">Flush</span><span class="op" id="5073970">(</span><span class="op" id="5073971">)</span><br>
<span class="lineno"></span><span class="op" id="5073973">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5073976">//&nbsp;countThreadCreate&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;current&nbsp;ThreadCreateProfile.</span><br>
<span class="lineno"></span><span class="keyword" id="5074050">func</span>&nbsp;<span class="ident" id="5074055">countThreadCreate</span><span class="op" id="5074072">(</span><span class="op" id="5074073">)</span>&nbsp;<span class="builtintype" id="5074075">int</span>&nbsp;<span class="op" id="5074079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5074082">n</span><span class="op" id="5074083">,</span>&nbsp;<span class="ident" id="5074085">_</span>&nbsp;<span class="op" id="5074087">:=</span>&nbsp;<span class="ident" id="5074090">runtime</span><span class="op" id="5074097">.</span><span class="ident" id="5074098">ThreadCreateProfile</span><span class="op" id="5074117">(</span><span class="ident" id="5074118">nil</span><span class="op" id="5074121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5074124">return</span>&nbsp;<span class="ident" id="5074131">n</span><br>
<span class="lineno">485</span><span class="op" id="5074133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5074136">//&nbsp;writeThreadCreate&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;ThreadCreateProfile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5074210">func</span>&nbsp;<span class="ident" id="5074215">writeThreadCreate</span><span class="op" id="5074232">(</span><span class="ident" id="5074233">w</span>&nbsp;<span class="ident" id="5074235">io</span><span class="op" id="5074237">.</span><span class="ident" id="5074238">Writer</span><span class="op" id="5074244">,</span>&nbsp;<span class="ident" id="5074246">debug</span>&nbsp;<span class="builtintype" id="5074252">int</span><span class="op" id="5074255">)</span>&nbsp;<span class="builtintype" id="5074257">error</span>&nbsp;<span class="op" id="5074263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5074266">return</span>&nbsp;<span class="ident" id="5074273">writeRuntimeProfile</span><span class="op" id="5074292">(</span><span class="ident" id="5074293">w</span><span class="op" id="5074294">,</span>&nbsp;<span class="ident" id="5074296">debug</span><span class="op" id="5074301">,</span>&nbsp;<span class="string" id="5074303">&#34;threadcreate&#34;</span><span class="op" id="5074317">,</span>&nbsp;<span class="ident" id="5074319">runtime</span><span class="op" id="5074326">.</span><span class="ident" id="5074327">ThreadCreateProfile</span><span class="op" id="5074346">)</span><br>
<span class="lineno">490</span><span class="op" id="5074348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5074351">//&nbsp;countGoroutine&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5074403">func</span>&nbsp;<span class="ident" id="5074408">countGoroutine</span><span class="op" id="5074422">(</span><span class="op" id="5074423">)</span>&nbsp;<span class="builtintype" id="5074425">int</span>&nbsp;<span class="op" id="5074429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5074432">return</span>&nbsp;<span class="ident" id="5074439">runtime</span><span class="op" id="5074446">.</span><span class="ident" id="5074447">NumGoroutine</span><span class="op" id="5074459">(</span><span class="op" id="5074460">)</span><br>
<span class="lineno">495</span><span class="op" id="5074462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5074465">//&nbsp;writeGoroutine&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;GoroutineProfile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5074533">func</span>&nbsp;<span class="ident" id="5074538">writeGoroutine</span><span class="op" id="5074552">(</span><span class="ident" id="5074553">w</span>&nbsp;<span class="ident" id="5074555">io</span><span class="op" id="5074557">.</span><span class="ident" id="5074558">Writer</span><span class="op" id="5074564">,</span>&nbsp;<span class="ident" id="5074566">debug</span>&nbsp;<span class="builtintype" id="5074572">int</span><span class="op" id="5074575">)</span>&nbsp;<span class="builtintype" id="5074577">error</span>&nbsp;<span class="op" id="5074583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5074586">if</span>&nbsp;<span class="ident" id="5074589">debug</span>&nbsp;<span class="op" id="5074595">&gt;=</span>&nbsp;<span class="num" id="5074598">2</span>&nbsp;<span class="op" id="5074600">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5074604">return</span>&nbsp;<span class="ident" id="5074611">writeGoroutineStacks</span><span class="op" id="5074631">(</span><span class="ident" id="5074632">w</span><span class="op" id="5074633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5074636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5074639">return</span>&nbsp;<span class="ident" id="5074646">writeRuntimeProfile</span><span class="op" id="5074665">(</span><span class="ident" id="5074666">w</span><span class="op" id="5074667">,</span>&nbsp;<span class="ident" id="5074669">debug</span><span class="op" id="5074674">,</span>&nbsp;<span class="string" id="5074676">&#34;goroutine&#34;</span><span class="op" id="5074687">,</span>&nbsp;<span class="ident" id="5074689">runtime</span><span class="op" id="5074696">.</span><span class="ident" id="5074697">GoroutineProfile</span><span class="op" id="5074713">)</span><br>
<span class="lineno"></span><span class="op" id="5074715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="keyword" id="5074718">func</span>&nbsp;<span class="ident" id="5074723">writeGoroutineStacks</span><span class="op" id="5074743">(</span><span class="ident" id="5074744">w</span>&nbsp;<span class="ident" id="5074746">io</span><span class="op" id="5074748">.</span><span class="ident" id="5074749">Writer</span><span class="op" id="5074755">)</span>&nbsp;<span class="builtintype" id="5074757">error</span>&nbsp;<span class="op" id="5074763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5074766">//&nbsp;We&nbsp;don&#39;t&nbsp;know&nbsp;how&nbsp;big&nbsp;the&nbsp;buffer&nbsp;needs&nbsp;to&nbsp;be&nbsp;to&nbsp;collect</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5074826">//&nbsp;all&nbsp;the&nbsp;goroutines.&nbsp;&nbsp;Start&nbsp;with&nbsp;1&nbsp;MB&nbsp;and&nbsp;try&nbsp;a&nbsp;few&nbsp;times,&nbsp;doubling&nbsp;each&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5074908">//&nbsp;Give&nbsp;up&nbsp;and&nbsp;use&nbsp;a&nbsp;truncated&nbsp;trace&nbsp;if&nbsp;64&nbsp;MB&nbsp;is&nbsp;not&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5074970">buf</span>&nbsp;<span class="op" id="5074974">:=</span>&nbsp;<span class="builtinfunc" id="5074977">make</span><span class="op" id="5074981">(</span><span class="op" id="5074982">[</span><span class="op" id="5074983">]</span><span class="builtintype" id="5074984">byte</span><span class="op" id="5074988">,</span>&nbsp;<span class="num" id="5074990">1</span><span class="op" id="5074991">&lt;&lt;</span><span class="num" id="5074993">20</span><span class="op" id="5074995">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5074998">for</span>&nbsp;<span class="ident" id="5075002">i</span>&nbsp;<span class="op" id="5075004">:=</span>&nbsp;<span class="num" id="5075007">0</span><span class="op" id="5075008">;</span>&nbsp;<span class="op" id="5075010">;</span>&nbsp;<span class="ident" id="5075012">i</span><span class="op" id="5075013">++</span>&nbsp;<span class="op" id="5075016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075020">n</span>&nbsp;<span class="op" id="5075022">:=</span>&nbsp;<span class="ident" id="5075025">runtime</span><span class="op" id="5075032">.</span><span class="ident" id="5075033">Stack</span><span class="op" id="5075038">(</span><span class="ident" id="5075039">buf</span><span class="op" id="5075042">,</span>&nbsp;<span class="builtintype" id="5075044">true</span><span class="op" id="5075048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5075052">if</span>&nbsp;<span class="ident" id="5075055">n</span>&nbsp;<span class="op" id="5075057">&lt;</span>&nbsp;<span class="builtinfunc" id="5075059">len</span><span class="op" id="5075062">(</span><span class="ident" id="5075063">buf</span><span class="op" id="5075066">)</span>&nbsp;<span class="op" id="5075068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075073">buf</span>&nbsp;<span class="op" id="5075077">=</span>&nbsp;<span class="ident" id="5075079">buf</span><span class="op" id="5075082">[</span><span class="op" id="5075083">:</span><span class="ident" id="5075084">n</span><span class="op" id="5075085">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5075090">break</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5075098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5075102">if</span>&nbsp;<span class="builtinfunc" id="5075105">len</span><span class="op" id="5075108">(</span><span class="ident" id="5075109">buf</span><span class="op" id="5075112">)</span>&nbsp;<span class="op" id="5075114">&gt;=</span>&nbsp;<span class="num" id="5075117">64</span><span class="op" id="5075119">&lt;&lt;</span><span class="num" id="5075121">20</span>&nbsp;<span class="op" id="5075124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5075129">//&nbsp;Filled&nbsp;64&nbsp;MB&nbsp;-&nbsp;stop&nbsp;there.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5075162">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5075170">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075174">buf</span>&nbsp;<span class="op" id="5075178">=</span>&nbsp;<span class="builtinfunc" id="5075180">make</span><span class="op" id="5075184">(</span><span class="op" id="5075185">[</span><span class="op" id="5075186">]</span><span class="builtintype" id="5075187">byte</span><span class="op" id="5075191">,</span>&nbsp;<span class="num" id="5075193">2</span><span class="op" id="5075194">*</span><span class="builtinfunc" id="5075195">len</span><span class="op" id="5075198">(</span><span class="ident" id="5075199">buf</span><span class="op" id="5075202">)</span><span class="op" id="5075203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5075206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075209">_</span><span class="op" id="5075210">,</span>&nbsp;<span class="ident" id="5075212">err</span>&nbsp;<span class="op" id="5075216">:=</span>&nbsp;<span class="ident" id="5075219">w</span><span class="op" id="5075220">.</span><span class="ident" id="5075221">Write</span><span class="op" id="5075226">(</span><span class="ident" id="5075227">buf</span><span class="op" id="5075230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5075233">return</span>&nbsp;<span class="ident" id="5075240">err</span><br>
<span class="lineno"></span><span class="op" id="5075244">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="keyword" id="5075247">func</span>&nbsp;<span class="ident" id="5075252">writeRuntimeProfile</span><span class="op" id="5075271">(</span><span class="ident" id="5075272">w</span>&nbsp;<span class="ident" id="5075274">io</span><span class="op" id="5075276">.</span><span class="ident" id="5075277">Writer</span><span class="op" id="5075283">,</span>&nbsp;<span class="ident" id="5075285">debug</span>&nbsp;<span class="builtintype" id="5075291">int</span><span class="op" id="5075294">,</span>&nbsp;<span class="ident" id="5075296">name</span>&nbsp;<span class="builtintype" id="5075301">string</span><span class="op" id="5075307">,</span>&nbsp;<span class="ident" id="5075309">fetch</span>&nbsp;<span class="keyword" id="5075315">func</span><span class="op" id="5075319">(</span><span class="op" id="5075320">[</span><span class="op" id="5075321">]</span><span class="ident" id="5075322">runtime</span><span class="op" id="5075329">.</span><span class="ident" id="5075330">StackRecord</span><span class="op" id="5075341">)</span>&nbsp;<span class="op" id="5075343">(</span><span class="builtintype" id="5075344">int</span><span class="op" id="5075347">,</span>&nbsp;<span class="builtintype" id="5075349">bool</span><span class="op" id="5075353">)</span><span class="op" id="5075354">)</span>&nbsp;<span class="builtintype" id="5075356">error</span>&nbsp;<span class="op" id="5075362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5075365">//&nbsp;Find&nbsp;out&nbsp;how&nbsp;many&nbsp;records&nbsp;there&nbsp;are&nbsp;(fetch(nil)),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5075419">//&nbsp;allocate&nbsp;that&nbsp;many&nbsp;records,&nbsp;and&nbsp;get&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5075469">//&nbsp;There&#39;s&nbsp;a&nbsp;race—more&nbsp;records&nbsp;might&nbsp;be&nbsp;added&nbsp;between</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5075526">//&nbsp;the&nbsp;two&nbsp;calls—so&nbsp;allocate&nbsp;a&nbsp;few&nbsp;extra&nbsp;records&nbsp;for&nbsp;safety</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5075589">//&nbsp;and&nbsp;also&nbsp;try&nbsp;again&nbsp;if&nbsp;we&#39;re&nbsp;very&nbsp;unlucky.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5075635">//&nbsp;The&nbsp;loop&nbsp;should&nbsp;only&nbsp;execute&nbsp;one&nbsp;iteration&nbsp;in&nbsp;the&nbsp;common&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5075702">var</span>&nbsp;<span class="ident" id="5075706">p</span>&nbsp;<span class="op" id="5075708">[</span><span class="op" id="5075709">]</span><span class="ident" id="5075710">runtime</span><span class="op" id="5075717">.</span><span class="ident" id="5075718">StackRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075731">n</span><span class="op" id="5075732">,</span>&nbsp;<span class="ident" id="5075734">ok</span>&nbsp;<span class="op" id="5075737">:=</span>&nbsp;<span class="ident" id="5075740">fetch</span><span class="op" id="5075745">(</span><span class="ident" id="5075746">nil</span><span class="op" id="5075749">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5075752">for</span>&nbsp;<span class="op" id="5075756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5075760">//&nbsp;Allocate&nbsp;room&nbsp;for&nbsp;a&nbsp;slightly&nbsp;bigger&nbsp;profile,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5075810">//&nbsp;in&nbsp;case&nbsp;a&nbsp;few&nbsp;more&nbsp;entries&nbsp;have&nbsp;been&nbsp;added</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5075858">//&nbsp;since&nbsp;the&nbsp;call&nbsp;to&nbsp;ThreadProfile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075896">p</span>&nbsp;<span class="op" id="5075898">=</span>&nbsp;<span class="builtinfunc" id="5075900">make</span><span class="op" id="5075904">(</span><span class="op" id="5075905">[</span><span class="op" id="5075906">]</span><span class="ident" id="5075907">runtime</span><span class="op" id="5075914">.</span><span class="ident" id="5075915">StackRecord</span><span class="op" id="5075926">,</span>&nbsp;<span class="ident" id="5075928">n</span><span class="op" id="5075929">+</span><span class="num" id="5075930">10</span><span class="op" id="5075932">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075936">n</span><span class="op" id="5075937">,</span>&nbsp;<span class="ident" id="5075939">ok</span>&nbsp;<span class="op" id="5075942">=</span>&nbsp;<span class="ident" id="5075944">fetch</span><span class="op" id="5075949">(</span><span class="ident" id="5075950">p</span><span class="op" id="5075951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5075955">if</span>&nbsp;<span class="ident" id="5075958">ok</span>&nbsp;<span class="op" id="5075961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075966">p</span>&nbsp;<span class="op" id="5075968">=</span>&nbsp;<span class="ident" id="5075970">p</span><span class="op" id="5075971">[</span><span class="num" id="5075972">0</span><span class="op" id="5075973">:</span><span class="ident" id="5075974">n</span><span class="op" id="5075975">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5075980">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5075988">}</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5075992">//&nbsp;Profile&nbsp;grew;&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5076021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5076025">return</span>&nbsp;<span class="ident" id="5076032">printCountProfile</span><span class="op" id="5076049">(</span><span class="ident" id="5076050">w</span><span class="op" id="5076051">,</span>&nbsp;<span class="ident" id="5076053">debug</span><span class="op" id="5076058">,</span>&nbsp;<span class="ident" id="5076060">name</span><span class="op" id="5076064">,</span>&nbsp;<span class="ident" id="5076066">runtimeProfile</span><span class="op" id="5076080">(</span><span class="ident" id="5076081">p</span><span class="op" id="5076082">)</span><span class="op" id="5076083">)</span><br>
<span class="lineno"></span><span class="op" id="5076085">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="5076088">type</span>&nbsp;<span class="ident" id="5076093">runtimeProfile</span>&nbsp;<span class="op" id="5076108">[</span><span class="op" id="5076109">]</span><span class="ident" id="5076110">runtime</span><span class="op" id="5076117">.</span><span class="ident" id="5076118">StackRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5076131">func</span>&nbsp;<span class="op" id="5076136">(</span><span class="ident" id="5076137">p</span>&nbsp;<span class="ident" id="5076139">runtimeProfile</span><span class="op" id="5076153">)</span>&nbsp;<span class="ident" id="5076155">Len</span><span class="op" id="5076158">(</span><span class="op" id="5076159">)</span>&nbsp;<span class="builtintype" id="5076161">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5076178">{</span>&nbsp;<span class="keyword" id="5076180">return</span>&nbsp;<span class="builtinfunc" id="5076187">len</span><span class="op" id="5076190">(</span><span class="ident" id="5076191">p</span><span class="op" id="5076192">)</span>&nbsp;<span class="op" id="5076194">}</span><br>
<span class="lineno"></span><span class="keyword" id="5076196">func</span>&nbsp;<span class="op" id="5076201">(</span><span class="ident" id="5076202">p</span>&nbsp;<span class="ident" id="5076204">runtimeProfile</span><span class="op" id="5076218">)</span>&nbsp;<span class="ident" id="5076220">Stack</span><span class="op" id="5076225">(</span><span class="ident" id="5076226">i</span>&nbsp;<span class="builtintype" id="5076228">int</span><span class="op" id="5076231">)</span>&nbsp;<span class="op" id="5076233">[</span><span class="op" id="5076234">]</span><span class="builtintype" id="5076235">uintptr</span>&nbsp;<span class="op" id="5076243">{</span>&nbsp;<span class="keyword" id="5076245">return</span>&nbsp;<span class="ident" id="5076252">p</span><span class="op" id="5076253">[</span><span class="ident" id="5076254">i</span><span class="op" id="5076255">]</span><span class="op" id="5076256">.</span><span class="ident" id="5076257">Stack</span><span class="op" id="5076262">(</span><span class="op" id="5076263">)</span>&nbsp;<span class="op" id="5076265">}</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span><span class="keyword" id="5076268">var</span>&nbsp;<span class="ident" id="5076272">cpu</span>&nbsp;<span class="keyword" id="5076276">struct</span>&nbsp;<span class="op" id="5076283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5076286">sync</span><span class="op" id="5076290">.</span><span class="ident" id="5076291">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5076298">profiling</span>&nbsp;<span class="builtintype" id="5076308">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5076314">done</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5076324">chan</span>&nbsp;<span class="builtintype" id="5076329">bool</span><br>
<span class="lineno">560</span><span class="op" id="5076334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5076337">//&nbsp;StartCPUProfile&nbsp;enables&nbsp;CPU&nbsp;profiling&nbsp;for&nbsp;the&nbsp;current&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="5076403">//&nbsp;While&nbsp;profiling,&nbsp;the&nbsp;profile&nbsp;will&nbsp;be&nbsp;buffered&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="5076470">//&nbsp;StartCPUProfile&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;profiling&nbsp;is&nbsp;already&nbsp;enabled.</span><br>
<span class="lineno">565</span><span class="keyword" id="5076539">func</span>&nbsp;<span class="ident" id="5076544">StartCPUProfile</span><span class="op" id="5076559">(</span><span class="ident" id="5076560">w</span>&nbsp;<span class="ident" id="5076562">io</span><span class="op" id="5076564">.</span><span class="ident" id="5076565">Writer</span><span class="op" id="5076571">)</span>&nbsp;<span class="builtintype" id="5076573">error</span>&nbsp;<span class="op" id="5076579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5076582">//&nbsp;The&nbsp;runtime&nbsp;routines&nbsp;allow&nbsp;a&nbsp;variable&nbsp;profiling&nbsp;rate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5076640">//&nbsp;but&nbsp;in&nbsp;practice&nbsp;operating&nbsp;systems&nbsp;cannot&nbsp;trigger&nbsp;signals</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5076701">//&nbsp;at&nbsp;more&nbsp;than&nbsp;about&nbsp;500&nbsp;Hz,&nbsp;and&nbsp;our&nbsp;processing&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5076758">//&nbsp;signal&nbsp;is&nbsp;not&nbsp;cheap&nbsp;(mostly&nbsp;getting&nbsp;the&nbsp;stack&nbsp;trace).</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5076816">//&nbsp;100&nbsp;Hz&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;choice:&nbsp;it&nbsp;is&nbsp;frequent&nbsp;enough&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5076876">//&nbsp;produce&nbsp;useful&nbsp;data,&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bog&nbsp;down&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5076933">//&nbsp;system,&nbsp;and&nbsp;a&nbsp;nice&nbsp;round&nbsp;number&nbsp;to&nbsp;make&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5076988">//&nbsp;convert&nbsp;sample&nbsp;counts&nbsp;to&nbsp;seconds.&nbsp;&nbsp;Instead&nbsp;of&nbsp;requiring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5077048">//&nbsp;each&nbsp;client&nbsp;to&nbsp;specify&nbsp;the&nbsp;frequency,&nbsp;we&nbsp;hard&nbsp;code&nbsp;it.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077107">const</span>&nbsp;<span class="ident" id="5077113">hz</span>&nbsp;<span class="op" id="5077116">=</span>&nbsp;<span class="num" id="5077118">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077124">cpu</span><span class="op" id="5077127">.</span><span class="ident" id="5077128">Lock</span><span class="op" id="5077132">(</span><span class="op" id="5077133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077136">defer</span>&nbsp;<span class="ident" id="5077142">cpu</span><span class="op" id="5077145">.</span><span class="ident" id="5077146">Unlock</span><span class="op" id="5077152">(</span><span class="op" id="5077153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077156">if</span>&nbsp;<span class="ident" id="5077159">cpu</span><span class="op" id="5077162">.</span><span class="ident" id="5077163">done</span>&nbsp;<span class="op" id="5077168">==</span>&nbsp;<span class="ident" id="5077171">nil</span>&nbsp;<span class="op" id="5077175">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077179">cpu</span><span class="op" id="5077182">.</span><span class="ident" id="5077183">done</span>&nbsp;<span class="op" id="5077188">=</span>&nbsp;<span class="builtinfunc" id="5077190">make</span><span class="op" id="5077194">(</span><span class="keyword" id="5077195">chan</span>&nbsp;<span class="builtintype" id="5077200">bool</span><span class="op" id="5077204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5077210">//&nbsp;Double-check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077228">if</span>&nbsp;<span class="ident" id="5077231">cpu</span><span class="op" id="5077234">.</span><span class="ident" id="5077235">profiling</span>&nbsp;<span class="op" id="5077245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077249">return</span>&nbsp;<span class="ident" id="5077256">fmt</span><span class="op" id="5077259">.</span><span class="ident" id="5077260">Errorf</span><span class="op" id="5077266">(</span><span class="string" id="5077267">&#34;cpu&nbsp;profiling&nbsp;already&nbsp;in&nbsp;use&#34;</span><span class="op" id="5077297">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077303">cpu</span><span class="op" id="5077306">.</span><span class="ident" id="5077307">profiling</span>&nbsp;<span class="op" id="5077317">=</span>&nbsp;<span class="builtintype" id="5077319">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077325">runtime</span><span class="op" id="5077332">.</span><span class="ident" id="5077333">SetCPUProfileRate</span><span class="op" id="5077350">(</span><span class="ident" id="5077351">hz</span><span class="op" id="5077353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077356">go</span>&nbsp;<span class="ident" id="5077359">profileWriter</span><span class="op" id="5077372">(</span><span class="ident" id="5077373">w</span><span class="op" id="5077374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077377">return</span>&nbsp;<span class="ident" id="5077384">nil</span><br>
<span class="lineno">590</span><span class="op" id="5077388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5077391">func</span>&nbsp;<span class="ident" id="5077396">profileWriter</span><span class="op" id="5077409">(</span><span class="ident" id="5077410">w</span>&nbsp;<span class="ident" id="5077412">io</span><span class="op" id="5077414">.</span><span class="ident" id="5077415">Writer</span><span class="op" id="5077421">)</span>&nbsp;<span class="op" id="5077423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077426">for</span>&nbsp;<span class="op" id="5077430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077434">data</span>&nbsp;<span class="op" id="5077439">:=</span>&nbsp;<span class="ident" id="5077442">runtime</span><span class="op" id="5077449">.</span><span class="ident" id="5077450">CPUProfile</span><span class="op" id="5077460">(</span><span class="op" id="5077461">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077465">if</span>&nbsp;<span class="ident" id="5077468">data</span>&nbsp;<span class="op" id="5077473">==</span>&nbsp;<span class="ident" id="5077476">nil</span>&nbsp;<span class="op" id="5077480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077485">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077497">w</span><span class="op" id="5077498">.</span><span class="ident" id="5077499">Write</span><span class="op" id="5077504">(</span><span class="ident" id="5077505">data</span><span class="op" id="5077509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077512">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077515">cpu</span><span class="op" id="5077518">.</span><span class="ident" id="5077519">done</span>&nbsp;<span class="op" id="5077524">&lt;-</span>&nbsp;<span class="builtintype" id="5077527">true</span><br>
<span class="lineno"></span><span class="op" id="5077532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5077535">//&nbsp;StopCPUProfile&nbsp;stops&nbsp;the&nbsp;current&nbsp;CPU&nbsp;profile,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span><span class="comment" id="5077592">//&nbsp;StopCPUProfile&nbsp;only&nbsp;returns&nbsp;after&nbsp;all&nbsp;the&nbsp;writes&nbsp;for&nbsp;the</span><br>
<span class="lineno">605</span><span class="comment" id="5077652">//&nbsp;profile&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="5077679">func</span>&nbsp;<span class="ident" id="5077684">StopCPUProfile</span><span class="op" id="5077698">(</span><span class="op" id="5077699">)</span>&nbsp;<span class="op" id="5077701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077704">cpu</span><span class="op" id="5077707">.</span><span class="ident" id="5077708">Lock</span><span class="op" id="5077712">(</span><span class="op" id="5077713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077716">defer</span>&nbsp;<span class="ident" id="5077722">cpu</span><span class="op" id="5077725">.</span><span class="ident" id="5077726">Unlock</span><span class="op" id="5077732">(</span><span class="op" id="5077733">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077737">if</span>&nbsp;<span class="op" id="5077740">!</span><span class="ident" id="5077741">cpu</span><span class="op" id="5077744">.</span><span class="ident" id="5077745">profiling</span>&nbsp;<span class="op" id="5077755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077759">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077770">cpu</span><span class="op" id="5077773">.</span><span class="ident" id="5077774">profiling</span>&nbsp;<span class="op" id="5077784">=</span>&nbsp;<span class="builtintype" id="5077786">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077793">runtime</span><span class="op" id="5077800">.</span><span class="ident" id="5077801">SetCPUProfileRate</span><span class="op" id="5077818">(</span><span class="num" id="5077819">0</span><span class="op" id="5077820">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077823">&lt;-</span><span class="ident" id="5077825">cpu</span><span class="op" id="5077828">.</span><span class="ident" id="5077829">done</span><br>
<span class="lineno"></span><span class="op" id="5077834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5077837">type</span>&nbsp;<span class="ident" id="5077842">byCycles</span>&nbsp;<span class="op" id="5077851">[</span><span class="op" id="5077852">]</span><span class="ident" id="5077853">runtime</span><span class="op" id="5077860">.</span><span class="ident" id="5077861">BlockProfileRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="5077881">func</span>&nbsp;<span class="op" id="5077886">(</span><span class="ident" id="5077887">x</span>&nbsp;<span class="ident" id="5077889">byCycles</span><span class="op" id="5077897">)</span>&nbsp;<span class="ident" id="5077899">Len</span><span class="op" id="5077902">(</span><span class="op" id="5077903">)</span>&nbsp;<span class="builtintype" id="5077905">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5077919">{</span>&nbsp;<span class="keyword" id="5077921">return</span>&nbsp;<span class="builtinfunc" id="5077928">len</span><span class="op" id="5077931">(</span><span class="ident" id="5077932">x</span><span class="op" id="5077933">)</span>&nbsp;<span class="op" id="5077935">}</span><br>
<span class="lineno"></span><span class="keyword" id="5077937">func</span>&nbsp;<span class="op" id="5077942">(</span><span class="ident" id="5077943">x</span>&nbsp;<span class="ident" id="5077945">byCycles</span><span class="op" id="5077953">)</span>&nbsp;<span class="ident" id="5077955">Swap</span><span class="op" id="5077959">(</span><span class="ident" id="5077960">i</span><span class="op" id="5077961">,</span>&nbsp;<span class="ident" id="5077963">j</span>&nbsp;<span class="builtintype" id="5077965">int</span><span class="op" id="5077968">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5077975">{</span>&nbsp;<span class="ident" id="5077977">x</span><span class="op" id="5077978">[</span><span class="ident" id="5077979">i</span><span class="op" id="5077980">]</span><span class="op" id="5077981">,</span>&nbsp;<span class="ident" id="5077983">x</span><span class="op" id="5077984">[</span><span class="ident" id="5077985">j</span><span class="op" id="5077986">]</span>&nbsp;<span class="op" id="5077988">=</span>&nbsp;<span class="ident" id="5077990">x</span><span class="op" id="5077991">[</span><span class="ident" id="5077992">j</span><span class="op" id="5077993">]</span><span class="op" id="5077994">,</span>&nbsp;<span class="ident" id="5077996">x</span><span class="op" id="5077997">[</span><span class="ident" id="5077998">i</span><span class="op" id="5077999">]</span>&nbsp;<span class="op" id="5078001">}</span><br>
<span class="lineno"></span><span class="keyword" id="5078003">func</span>&nbsp;<span class="op" id="5078008">(</span><span class="ident" id="5078009">x</span>&nbsp;<span class="ident" id="5078011">byCycles</span><span class="op" id="5078019">)</span>&nbsp;<span class="ident" id="5078021">Less</span><span class="op" id="5078025">(</span><span class="ident" id="5078026">i</span><span class="op" id="5078027">,</span>&nbsp;<span class="ident" id="5078029">j</span>&nbsp;<span class="builtintype" id="5078031">int</span><span class="op" id="5078034">)</span>&nbsp;<span class="builtintype" id="5078036">bool</span>&nbsp;<span class="op" id="5078041">{</span>&nbsp;<span class="keyword" id="5078043">return</span>&nbsp;<span class="ident" id="5078050">x</span><span class="op" id="5078051">[</span><span class="ident" id="5078052">i</span><span class="op" id="5078053">]</span><span class="op" id="5078054">.</span><span class="ident" id="5078055">Cycles</span>&nbsp;<span class="op" id="5078062">&gt;</span>&nbsp;<span class="ident" id="5078064">x</span><span class="op" id="5078065">[</span><span class="ident" id="5078066">j</span><span class="op" id="5078067">]</span><span class="op" id="5078068">.</span><span class="ident" id="5078069">Cycles</span>&nbsp;<span class="op" id="5078076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5078079">//&nbsp;countBlock&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno">625</span><span class="keyword" id="5078148">func</span>&nbsp;<span class="ident" id="5078153">countBlock</span><span class="op" id="5078163">(</span><span class="op" id="5078164">)</span>&nbsp;<span class="builtintype" id="5078166">int</span>&nbsp;<span class="op" id="5078170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078173">n</span><span class="op" id="5078174">,</span>&nbsp;<span class="ident" id="5078176">_</span>&nbsp;<span class="op" id="5078178">:=</span>&nbsp;<span class="ident" id="5078181">runtime</span><span class="op" id="5078188">.</span><span class="ident" id="5078189">BlockProfile</span><span class="op" id="5078201">(</span><span class="ident" id="5078202">nil</span><span class="op" id="5078205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078208">return</span>&nbsp;<span class="ident" id="5078215">n</span><br>
<span class="lineno"></span><span class="op" id="5078217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="comment" id="5078220">//&nbsp;writeBlock&nbsp;writes&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5078276">func</span>&nbsp;<span class="ident" id="5078281">writeBlock</span><span class="op" id="5078291">(</span><span class="ident" id="5078292">w</span>&nbsp;<span class="ident" id="5078294">io</span><span class="op" id="5078296">.</span><span class="ident" id="5078297">Writer</span><span class="op" id="5078303">,</span>&nbsp;<span class="ident" id="5078305">debug</span>&nbsp;<span class="builtintype" id="5078311">int</span><span class="op" id="5078314">)</span>&nbsp;<span class="builtintype" id="5078316">error</span>&nbsp;<span class="op" id="5078322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078325">var</span>&nbsp;<span class="ident" id="5078329">p</span>&nbsp;<span class="op" id="5078331">[</span><span class="op" id="5078332">]</span><span class="ident" id="5078333">runtime</span><span class="op" id="5078340">.</span><span class="ident" id="5078341">BlockProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078361">n</span><span class="op" id="5078362">,</span>&nbsp;<span class="ident" id="5078364">ok</span>&nbsp;<span class="op" id="5078367">:=</span>&nbsp;<span class="ident" id="5078370">runtime</span><span class="op" id="5078377">.</span><span class="ident" id="5078378">BlockProfile</span><span class="op" id="5078390">(</span><span class="ident" id="5078391">nil</span><span class="op" id="5078394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078397">for</span>&nbsp;<span class="op" id="5078401">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078405">p</span>&nbsp;<span class="op" id="5078407">=</span>&nbsp;<span class="builtinfunc" id="5078409">make</span><span class="op" id="5078413">(</span><span class="op" id="5078414">[</span><span class="op" id="5078415">]</span><span class="ident" id="5078416">runtime</span><span class="op" id="5078423">.</span><span class="ident" id="5078424">BlockProfileRecord</span><span class="op" id="5078442">,</span>&nbsp;<span class="ident" id="5078444">n</span><span class="op" id="5078445">+</span><span class="num" id="5078446">50</span><span class="op" id="5078448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078452">n</span><span class="op" id="5078453">,</span>&nbsp;<span class="ident" id="5078455">ok</span>&nbsp;<span class="op" id="5078458">=</span>&nbsp;<span class="ident" id="5078460">runtime</span><span class="op" id="5078467">.</span><span class="ident" id="5078468">BlockProfile</span><span class="op" id="5078480">(</span><span class="ident" id="5078481">p</span><span class="op" id="5078482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078486">if</span>&nbsp;<span class="ident" id="5078489">ok</span>&nbsp;<span class="op" id="5078492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078497">p</span>&nbsp;<span class="op" id="5078499">=</span>&nbsp;<span class="ident" id="5078501">p</span><span class="op" id="5078502">[</span><span class="op" id="5078503">:</span><span class="ident" id="5078504">n</span><span class="op" id="5078505">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078510">break</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5078518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5078521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078525">sort</span><span class="op" id="5078529">.</span><span class="ident" id="5078530">Sort</span><span class="op" id="5078534">(</span><span class="ident" id="5078535">byCycles</span><span class="op" id="5078543">(</span><span class="ident" id="5078544">p</span><span class="op" id="5078545">)</span><span class="op" id="5078546">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078550">b</span>&nbsp;<span class="op" id="5078552">:=</span>&nbsp;<span class="ident" id="5078555">bufio</span><span class="op" id="5078560">.</span><span class="ident" id="5078561">NewWriter</span><span class="op" id="5078570">(</span><span class="ident" id="5078571">w</span><span class="op" id="5078572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078575">var</span>&nbsp;<span class="ident" id="5078579">tw</span>&nbsp;<span class="op" id="5078582">*</span><span class="ident" id="5078583">tabwriter</span><span class="op" id="5078592">.</span><span class="ident" id="5078593">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078601">w</span>&nbsp;<span class="op" id="5078603">=</span>&nbsp;<span class="ident" id="5078605">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078608">if</span>&nbsp;<span class="ident" id="5078611">debug</span>&nbsp;<span class="op" id="5078617">&gt;</span>&nbsp;<span class="num" id="5078619">0</span>&nbsp;<span class="op" id="5078621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078625">tw</span>&nbsp;<span class="op" id="5078628">=</span>&nbsp;<span class="ident" id="5078630">tabwriter</span><span class="op" id="5078639">.</span><span class="ident" id="5078640">NewWriter</span><span class="op" id="5078649">(</span><span class="ident" id="5078650">w</span><span class="op" id="5078651">,</span>&nbsp;<span class="num" id="5078653">1</span><span class="op" id="5078654">,</span>&nbsp;<span class="num" id="5078656">8</span><span class="op" id="5078657">,</span>&nbsp;<span class="num" id="5078659">1</span><span class="op" id="5078660">,</span>&nbsp;<span class="string" id="5078662">&#39;\t&#39;</span><span class="op" id="5078666">,</span>&nbsp;<span class="num" id="5078668">0</span><span class="op" id="5078669">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078673">w</span>&nbsp;<span class="op" id="5078675">=</span>&nbsp;<span class="ident" id="5078677">tw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5078681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078685">fmt</span><span class="op" id="5078688">.</span><span class="ident" id="5078689">Fprintf</span><span class="op" id="5078696">(</span><span class="ident" id="5078697">w</span><span class="op" id="5078698">,</span>&nbsp;<span class="string" id="5078700">&#34;---&nbsp;contention:\n&#34;</span><span class="op" id="5078719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078722">fmt</span><span class="op" id="5078725">.</span><span class="ident" id="5078726">Fprintf</span><span class="op" id="5078733">(</span><span class="ident" id="5078734">w</span><span class="op" id="5078735">,</span>&nbsp;<span class="string" id="5078737">&#34;cycles/second=%v\n&#34;</span><span class="op" id="5078757">,</span>&nbsp;<span class="ident" id="5078759">runtime_cyclesPerSecond</span><span class="op" id="5078782">(</span><span class="op" id="5078783">)</span><span class="op" id="5078784">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078787">for</span>&nbsp;<span class="ident" id="5078791">i</span>&nbsp;<span class="op" id="5078793">:=</span>&nbsp;<span class="keyword" id="5078796">range</span>&nbsp;<span class="ident" id="5078802">p</span>&nbsp;<span class="op" id="5078804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078808">r</span>&nbsp;<span class="op" id="5078810">:=</span>&nbsp;<span class="op" id="5078813">&amp;</span><span class="ident" id="5078814">p</span><span class="op" id="5078815">[</span><span class="ident" id="5078816">i</span><span class="op" id="5078817">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078821">fmt</span><span class="op" id="5078824">.</span><span class="ident" id="5078825">Fprintf</span><span class="op" id="5078832">(</span><span class="ident" id="5078833">w</span><span class="op" id="5078834">,</span>&nbsp;<span class="string" id="5078836">&#34;%v&nbsp;%v&nbsp;@&#34;</span><span class="op" id="5078845">,</span>&nbsp;<span class="ident" id="5078847">r</span><span class="op" id="5078848">.</span><span class="ident" id="5078849">Cycles</span><span class="op" id="5078855">,</span>&nbsp;<span class="ident" id="5078857">r</span><span class="op" id="5078858">.</span><span class="ident" id="5078859">Count</span><span class="op" id="5078864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078868">for</span>&nbsp;<span class="ident" id="5078872">_</span><span class="op" id="5078873">,</span>&nbsp;<span class="ident" id="5078875">pc</span>&nbsp;<span class="op" id="5078878">:=</span>&nbsp;<span class="keyword" id="5078881">range</span>&nbsp;<span class="ident" id="5078887">r</span><span class="op" id="5078888">.</span><span class="ident" id="5078889">Stack</span><span class="op" id="5078894">(</span><span class="op" id="5078895">)</span>&nbsp;<span class="op" id="5078897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078902">fmt</span><span class="op" id="5078905">.</span><span class="ident" id="5078906">Fprintf</span><span class="op" id="5078913">(</span><span class="ident" id="5078914">w</span><span class="op" id="5078915">,</span>&nbsp;<span class="string" id="5078917">&#34;&nbsp;%#x&#34;</span><span class="op" id="5078923">,</span>&nbsp;<span class="ident" id="5078925">pc</span><span class="op" id="5078927">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5078931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078935">fmt</span><span class="op" id="5078938">.</span><span class="ident" id="5078939">Fprint</span><span class="op" id="5078945">(</span><span class="ident" id="5078946">w</span><span class="op" id="5078947">,</span>&nbsp;<span class="string" id="5078949">&#34;\n&#34;</span><span class="op" id="5078953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078957">if</span>&nbsp;<span class="ident" id="5078960">debug</span>&nbsp;<span class="op" id="5078966">&gt;</span>&nbsp;<span class="num" id="5078968">0</span>&nbsp;<span class="op" id="5078970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078975">printStackRecord</span><span class="op" id="5078991">(</span><span class="ident" id="5078992">w</span><span class="op" id="5078993">,</span>&nbsp;<span class="ident" id="5078995">r</span><span class="op" id="5078996">.</span><span class="ident" id="5078997">Stack</span><span class="op" id="5079002">(</span><span class="op" id="5079003">)</span><span class="op" id="5079004">,</span>&nbsp;<span class="builtintype" id="5079006">true</span><span class="op" id="5079010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5079014">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5079017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5079021">if</span>&nbsp;<span class="ident" id="5079024">tw</span>&nbsp;<span class="op" id="5079027">!=</span>&nbsp;<span class="ident" id="5079030">nil</span>&nbsp;<span class="op" id="5079034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5079038">tw</span><span class="op" id="5079040">.</span><span class="ident" id="5079041">Flush</span><span class="op" id="5079046">(</span><span class="op" id="5079047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5079050">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5079053">return</span>&nbsp;<span class="ident" id="5079060">b</span><span class="op" id="5079061">.</span><span class="ident" id="5079062">Flush</span><span class="op" id="5079067">(</span><span class="op" id="5079068">)</span><br>
<span class="lineno"></span><span class="op" id="5079070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5079073">func</span>&nbsp;<span class="ident" id="5079078">runtime_cyclesPerSecond</span><span class="op" id="5079101">(</span><span class="op" id="5079102">)</span>&nbsp;<span class="ident" id="5079104">int64</span>
</div>
</body>
</html>
