<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1610424">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1610479">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1610533">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1610584">package</span>&nbsp;<span class="ident" id="1610592">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1610598">import</span>&nbsp;<span class="op" id="1610605">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1610608">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1610623">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1610632">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1610635">//&nbsp;Cond&nbsp;implements&nbsp;a&nbsp;condition&nbsp;variable,&nbsp;a&nbsp;rendezvous&nbsp;point</span><br>
<span class="lineno"></span><span class="comment" id="1610695">//&nbsp;for&nbsp;goroutines&nbsp;waiting&nbsp;for&nbsp;or&nbsp;announcing&nbsp;the&nbsp;occurrence</span><br>
<span class="lineno"></span><span class="comment" id="1610754">//&nbsp;of&nbsp;an&nbsp;event.</span><br>
<span class="lineno">15</span><span class="comment" id="1610770">//</span><br>
<span class="lineno"></span><span class="comment" id="1610773">//&nbsp;Each&nbsp;Cond&nbsp;has&nbsp;an&nbsp;associated&nbsp;Locker&nbsp;L&nbsp;(often&nbsp;a&nbsp;*Mutex&nbsp;or&nbsp;*RWMutex),</span><br>
<span class="lineno"></span><span class="comment" id="1610843">//&nbsp;which&nbsp;must&nbsp;be&nbsp;held&nbsp;when&nbsp;changing&nbsp;the&nbsp;condition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1610897">//&nbsp;when&nbsp;calling&nbsp;the&nbsp;Wait&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="1610930">//</span><br>
<span class="lineno">20</span><span class="comment" id="1610933">//&nbsp;A&nbsp;Cond&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures.</span><br>
<span class="lineno"></span><span class="comment" id="1610987">//&nbsp;A&nbsp;Cond&nbsp;must&nbsp;not&nbsp;be&nbsp;copied&nbsp;after&nbsp;first&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="1611033">type</span>&nbsp;<span class="ident" id="1611038">Cond</span>&nbsp;<span class="keyword" id="1611043">struct</span>&nbsp;<span class="op" id="1611050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1611053">//&nbsp;L&nbsp;is&nbsp;held&nbsp;while&nbsp;observing&nbsp;or&nbsp;changing&nbsp;the&nbsp;condition</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611109">L</span>&nbsp;<span class="ident" id="1611111">Locker</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611120">sema</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611128">syncSema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611138">waiters</span>&nbsp;<span class="builtintype" id="1611146">uint32</span>&nbsp;<span class="comment" id="1611153">//&nbsp;number&nbsp;of&nbsp;waiters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611175">checker</span>&nbsp;<span class="ident" id="1611183">copyChecker</span><br>
<span class="lineno"></span><span class="op" id="1611195">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="1611198">//&nbsp;NewCond&nbsp;returns&nbsp;a&nbsp;new&nbsp;Cond&nbsp;with&nbsp;Locker&nbsp;l.</span><br>
<span class="lineno"></span><span class="keyword" id="1611243">func</span>&nbsp;<span class="ident" id="1611248">NewCond</span><span class="op" id="1611255">(</span><span class="ident" id="1611256">l</span>&nbsp;<span class="ident" id="1611258">Locker</span><span class="op" id="1611264">)</span>&nbsp;<span class="op" id="1611266">*</span><span class="ident" id="1611267">Cond</span>&nbsp;<span class="op" id="1611272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611275">return</span>&nbsp;<span class="op" id="1611282">&amp;</span><span class="ident" id="1611283">Cond</span><span class="op" id="1611287">{</span><span class="ident" id="1611288">L</span><span class="op" id="1611289">:</span>&nbsp;<span class="ident" id="1611291">l</span><span class="op" id="1611292">}</span><br>
<span class="lineno"></span><span class="op" id="1611294">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1611297">//&nbsp;Wait&nbsp;atomically&nbsp;unlocks&nbsp;c.L&nbsp;and&nbsp;suspends&nbsp;execution</span><br>
<span class="lineno"></span><span class="comment" id="1611351">//&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine.&nbsp;&nbsp;After&nbsp;later&nbsp;resuming&nbsp;execution,</span><br>
<span class="lineno"></span><span class="comment" id="1611413">//&nbsp;Wait&nbsp;locks&nbsp;c.L&nbsp;before&nbsp;returning.&nbsp;&nbsp;Unlike&nbsp;in&nbsp;other&nbsp;systems,</span><br>
<span class="lineno"></span><span class="comment" id="1611475">//&nbsp;Wait&nbsp;cannot&nbsp;return&nbsp;unless&nbsp;awoken&nbsp;by&nbsp;Broadcast&nbsp;or&nbsp;Signal.</span><br>
<span class="lineno">40</span><span class="comment" id="1611535">//</span><br>
<span class="lineno"></span><span class="comment" id="1611538">//&nbsp;Because&nbsp;c.L&nbsp;is&nbsp;not&nbsp;locked&nbsp;when&nbsp;Wait&nbsp;first&nbsp;resumes,&nbsp;the&nbsp;caller</span><br>
<span class="lineno"></span><span class="comment" id="1611603">//&nbsp;typically&nbsp;cannot&nbsp;assume&nbsp;that&nbsp;the&nbsp;condition&nbsp;is&nbsp;true&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="1611662">//&nbsp;Wait&nbsp;returns.&nbsp;&nbsp;Instead,&nbsp;the&nbsp;caller&nbsp;should&nbsp;Wait&nbsp;in&nbsp;a&nbsp;loop:</span><br>
<span class="lineno"></span><span class="comment" id="1611723">//</span><br>
<span class="lineno">45</span><span class="comment" id="1611726">//&nbsp;&nbsp;&nbsp;&nbsp;c.L.Lock()</span><br>
<span class="lineno"></span><span class="comment" id="1611743">//&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;!condition()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1611768">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c.Wait()</span><br>
<span class="lineno"></span><span class="comment" id="1611787">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1611795">//&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;make&nbsp;use&nbsp;of&nbsp;condition&nbsp;...</span><br>
<span class="lineno">50</span><span class="comment" id="1611831">//&nbsp;&nbsp;&nbsp;&nbsp;c.L.Unlock()</span><br>
<span class="lineno"></span><span class="comment" id="1611850">//</span><br>
<span class="lineno"></span><span class="keyword" id="1611853">func</span>&nbsp;<span class="op" id="1611858">(</span><span class="ident" id="1611859">c</span>&nbsp;<span class="op" id="1611861">*</span><span class="ident" id="1611862">Cond</span><span class="op" id="1611866">)</span>&nbsp;<span class="ident" id="1611868">Wait</span><span class="op" id="1611872">(</span><span class="op" id="1611873">)</span>&nbsp;<span class="op" id="1611875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611878">c</span><span class="op" id="1611879">.</span><span class="ident" id="1611880">checker</span><span class="op" id="1611887">.</span><span class="ident" id="1611888">check</span><span class="op" id="1611893">(</span><span class="op" id="1611894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611897">if</span>&nbsp;<span class="ident" id="1611900">raceenabled</span>&nbsp;<span class="op" id="1611912">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611916">raceDisable</span><span class="op" id="1611927">(</span><span class="op" id="1611928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611934">atomic</span><span class="op" id="1611940">.</span><span class="ident" id="1611941">AddUint32</span><span class="op" id="1611950">(</span><span class="op" id="1611951">&amp;</span><span class="ident" id="1611952">c</span><span class="op" id="1611953">.</span><span class="ident" id="1611954">waiters</span><span class="op" id="1611961">,</span>&nbsp;<span class="num" id="1611963">1</span><span class="op" id="1611964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611967">if</span>&nbsp;<span class="ident" id="1611970">raceenabled</span>&nbsp;<span class="op" id="1611982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611986">raceEnable</span><span class="op" id="1611996">(</span><span class="op" id="1611997">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612003">c</span><span class="op" id="1612004">.</span><span class="ident" id="1612005">L</span><span class="op" id="1612006">.</span><span class="ident" id="1612007">Unlock</span><span class="op" id="1612013">(</span><span class="op" id="1612014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612017">runtime_Syncsemacquire</span><span class="op" id="1612039">(</span><span class="op" id="1612040">&amp;</span><span class="ident" id="1612041">c</span><span class="op" id="1612042">.</span><span class="ident" id="1612043">sema</span><span class="op" id="1612047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612050">c</span><span class="op" id="1612051">.</span><span class="ident" id="1612052">L</span><span class="op" id="1612053">.</span><span class="ident" id="1612054">Lock</span><span class="op" id="1612058">(</span><span class="op" id="1612059">)</span><br>
<span class="lineno"></span><span class="op" id="1612061">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="1612064">//&nbsp;Signal&nbsp;wakes&nbsp;one&nbsp;goroutine&nbsp;waiting&nbsp;on&nbsp;c,&nbsp;if&nbsp;there&nbsp;is&nbsp;any.</span><br>
<span class="lineno"></span><span class="comment" id="1612125">//</span><br>
<span class="lineno"></span><span class="comment" id="1612128">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;but&nbsp;not&nbsp;required&nbsp;for&nbsp;the&nbsp;caller&nbsp;to&nbsp;hold&nbsp;c.L</span><br>
<span class="lineno"></span><span class="comment" id="1612189">//&nbsp;during&nbsp;the&nbsp;call.</span><br>
<span class="lineno">70</span><span class="keyword" id="1612209">func</span>&nbsp;<span class="op" id="1612214">(</span><span class="ident" id="1612215">c</span>&nbsp;<span class="op" id="1612217">*</span><span class="ident" id="1612218">Cond</span><span class="op" id="1612222">)</span>&nbsp;<span class="ident" id="1612224">Signal</span><span class="op" id="1612230">(</span><span class="op" id="1612231">)</span>&nbsp;<span class="op" id="1612233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612236">c</span><span class="op" id="1612237">.</span><span class="ident" id="1612238">signalImpl</span><span class="op" id="1612248">(</span><span class="builtintype" id="1612249">false</span><span class="op" id="1612254">)</span><br>
<span class="lineno"></span><span class="op" id="1612256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1612259">//&nbsp;Broadcast&nbsp;wakes&nbsp;all&nbsp;goroutines&nbsp;waiting&nbsp;on&nbsp;c.</span><br>
<span class="lineno">75</span><span class="comment" id="1612307">//</span><br>
<span class="lineno"></span><span class="comment" id="1612310">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;but&nbsp;not&nbsp;required&nbsp;for&nbsp;the&nbsp;caller&nbsp;to&nbsp;hold&nbsp;c.L</span><br>
<span class="lineno"></span><span class="comment" id="1612371">//&nbsp;during&nbsp;the&nbsp;call.</span><br>
<span class="lineno"></span><span class="keyword" id="1612391">func</span>&nbsp;<span class="op" id="1612396">(</span><span class="ident" id="1612397">c</span>&nbsp;<span class="op" id="1612399">*</span><span class="ident" id="1612400">Cond</span><span class="op" id="1612404">)</span>&nbsp;<span class="ident" id="1612406">Broadcast</span><span class="op" id="1612415">(</span><span class="op" id="1612416">)</span>&nbsp;<span class="op" id="1612418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612421">c</span><span class="op" id="1612422">.</span><span class="ident" id="1612423">signalImpl</span><span class="op" id="1612433">(</span><span class="builtintype" id="1612434">true</span><span class="op" id="1612438">)</span><br>
<span class="lineno">80</span><span class="op" id="1612440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1612443">func</span>&nbsp;<span class="op" id="1612448">(</span><span class="ident" id="1612449">c</span>&nbsp;<span class="op" id="1612451">*</span><span class="ident" id="1612452">Cond</span><span class="op" id="1612456">)</span>&nbsp;<span class="ident" id="1612458">signalImpl</span><span class="op" id="1612468">(</span><span class="ident" id="1612469">all</span>&nbsp;<span class="builtintype" id="1612473">bool</span><span class="op" id="1612477">)</span>&nbsp;<span class="op" id="1612479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612482">c</span><span class="op" id="1612483">.</span><span class="ident" id="1612484">checker</span><span class="op" id="1612491">.</span><span class="ident" id="1612492">check</span><span class="op" id="1612497">(</span><span class="op" id="1612498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612501">if</span>&nbsp;<span class="ident" id="1612504">raceenabled</span>&nbsp;<span class="op" id="1612516">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612520">raceDisable</span><span class="op" id="1612531">(</span><span class="op" id="1612532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612538">for</span>&nbsp;<span class="op" id="1612542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612546">old</span>&nbsp;<span class="op" id="1612550">:=</span>&nbsp;<span class="ident" id="1612553">atomic</span><span class="op" id="1612559">.</span><span class="ident" id="1612560">LoadUint32</span><span class="op" id="1612570">(</span><span class="op" id="1612571">&amp;</span><span class="ident" id="1612572">c</span><span class="op" id="1612573">.</span><span class="ident" id="1612574">waiters</span><span class="op" id="1612581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612585">if</span>&nbsp;<span class="ident" id="1612588">old</span>&nbsp;<span class="op" id="1612592">==</span>&nbsp;<span class="num" id="1612595">0</span>&nbsp;<span class="op" id="1612597">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612602">if</span>&nbsp;<span class="ident" id="1612605">raceenabled</span>&nbsp;<span class="op" id="1612617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612623">raceEnable</span><span class="op" id="1612633">(</span><span class="op" id="1612634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612644">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612653">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1612657">new</span>&nbsp;<span class="op" id="1612661">:=</span>&nbsp;<span class="ident" id="1612664">old</span>&nbsp;<span class="op" id="1612668">-</span>&nbsp;<span class="num" id="1612670">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612674">if</span>&nbsp;<span class="ident" id="1612677">all</span>&nbsp;<span class="op" id="1612681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1612686">new</span>&nbsp;<span class="op" id="1612690">=</span>&nbsp;<span class="num" id="1612692">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612700">if</span>&nbsp;<span class="ident" id="1612703">atomic</span><span class="op" id="1612709">.</span><span class="ident" id="1612710">CompareAndSwapUint32</span><span class="op" id="1612730">(</span><span class="op" id="1612731">&amp;</span><span class="ident" id="1612732">c</span><span class="op" id="1612733">.</span><span class="ident" id="1612734">waiters</span><span class="op" id="1612741">,</span>&nbsp;<span class="ident" id="1612743">old</span><span class="op" id="1612746">,</span>&nbsp;<span class="builtinfunc" id="1612748">new</span><span class="op" id="1612751">)</span>&nbsp;<span class="op" id="1612753">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612758">if</span>&nbsp;<span class="ident" id="1612761">raceenabled</span>&nbsp;<span class="op" id="1612773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612779">raceEnable</span><span class="op" id="1612789">(</span><span class="op" id="1612790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612800">runtime_Syncsemrelease</span><span class="op" id="1612822">(</span><span class="op" id="1612823">&amp;</span><span class="ident" id="1612824">c</span><span class="op" id="1612825">.</span><span class="ident" id="1612826">sema</span><span class="op" id="1612830">,</span>&nbsp;<span class="ident" id="1612832">old</span><span class="op" id="1612835">-</span><span class="builtinfunc" id="1612836">new</span><span class="op" id="1612839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612844">return</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612856">}</span><br>
<span class="lineno"></span><span class="op" id="1612858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1612861">//&nbsp;copyChecker&nbsp;holds&nbsp;back&nbsp;pointer&nbsp;to&nbsp;itself&nbsp;to&nbsp;detect&nbsp;object&nbsp;copying.</span><br>
<span class="lineno">110</span><span class="keyword" id="1612931">type</span>&nbsp;<span class="ident" id="1612936">copyChecker</span>&nbsp;<span class="builtintype" id="1612948">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1612957">func</span>&nbsp;<span class="op" id="1612962">(</span><span class="ident" id="1612963">c</span>&nbsp;<span class="op" id="1612965">*</span><span class="ident" id="1612966">copyChecker</span><span class="op" id="1612977">)</span>&nbsp;<span class="ident" id="1612979">check</span><span class="op" id="1612984">(</span><span class="op" id="1612985">)</span>&nbsp;<span class="op" id="1612987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612990">if</span>&nbsp;<span class="builtintype" id="1612993">uintptr</span><span class="op" id="1613000">(</span><span class="op" id="1613001">*</span><span class="ident" id="1613002">c</span><span class="op" id="1613003">)</span>&nbsp;<span class="op" id="1613005">!=</span>&nbsp;<span class="builtintype" id="1613008">uintptr</span><span class="op" id="1613015">(</span><span class="ident" id="1613016">unsafe</span><span class="op" id="1613022">.</span><span class="ident" id="1613023">Pointer</span><span class="op" id="1613030">(</span><span class="ident" id="1613031">c</span><span class="op" id="1613032">)</span><span class="op" id="1613033">)</span>&nbsp;<span class="op" id="1613035">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613040">!</span><span class="ident" id="1613041">atomic</span><span class="op" id="1613047">.</span><span class="ident" id="1613048">CompareAndSwapUintptr</span><span class="op" id="1613069">(</span><span class="op" id="1613070">(</span><span class="op" id="1613071">*</span><span class="builtintype" id="1613072">uintptr</span><span class="op" id="1613079">)</span><span class="op" id="1613080">(</span><span class="ident" id="1613081">c</span><span class="op" id="1613082">)</span><span class="op" id="1613083">,</span>&nbsp;<span class="num" id="1613085">0</span><span class="op" id="1613086">,</span>&nbsp;<span class="builtintype" id="1613088">uintptr</span><span class="op" id="1613095">(</span><span class="ident" id="1613096">unsafe</span><span class="op" id="1613102">.</span><span class="ident" id="1613103">Pointer</span><span class="op" id="1613110">(</span><span class="ident" id="1613111">c</span><span class="op" id="1613112">)</span><span class="op" id="1613113">)</span><span class="op" id="1613114">)</span>&nbsp;<span class="op" id="1613116">&amp;&amp;</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1613121">uintptr</span><span class="op" id="1613128">(</span><span class="op" id="1613129">*</span><span class="ident" id="1613130">c</span><span class="op" id="1613131">)</span>&nbsp;<span class="op" id="1613133">!=</span>&nbsp;<span class="builtintype" id="1613136">uintptr</span><span class="op" id="1613143">(</span><span class="ident" id="1613144">unsafe</span><span class="op" id="1613150">.</span><span class="ident" id="1613151">Pointer</span><span class="op" id="1613158">(</span><span class="ident" id="1613159">c</span><span class="op" id="1613160">)</span><span class="op" id="1613161">)</span>&nbsp;<span class="op" id="1613163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1613167">panic</span><span class="op" id="1613172">(</span><span class="string" id="1613173">&#34;sync.Cond&nbsp;is&nbsp;copied&#34;</span><span class="op" id="1613194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613197">}</span><br>
<span class="lineno"></span><span class="op" id="1613199">}</span>
</div>
</body>
</html>
