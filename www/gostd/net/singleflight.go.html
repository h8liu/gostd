<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html" class="current">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3989561">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3989617">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3989671">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3989722">package</span>&nbsp;<span class="ident" id="3989730">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3989735">import</span>&nbsp;<span class="string" id="3989742">&#34;sync&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3989750">//&nbsp;call&nbsp;is&nbsp;an&nbsp;in-flight&nbsp;or&nbsp;completed&nbsp;singleflight.Do&nbsp;call</span><br>
<span class="lineno">10</span><span class="keyword" id="3989808">type</span>&nbsp;<span class="ident" id="3989813">call</span>&nbsp;<span class="keyword" id="3989818">struct</span>&nbsp;<span class="op" id="3989825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3989828">wg</span>&nbsp;<span class="ident" id="3989831">sync</span><span class="op" id="3989835">.</span><span class="ident" id="3989836">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3989848">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;written&nbsp;once&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3989911">//&nbsp;and&nbsp;are&nbsp;only&nbsp;read&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3989962">val</span>&nbsp;<span class="keyword" id="3989966">interface</span><span class="op" id="3989975">{</span><span class="op" id="3989976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3989979">err</span>&nbsp;<span class="builtintype" id="3989983">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3989991">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;read&nbsp;and&nbsp;written&nbsp;with&nbsp;the&nbsp;singleflight</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3990051">//&nbsp;mutex&nbsp;held&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done,&nbsp;and&nbsp;are&nbsp;read&nbsp;but</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3990113">//&nbsp;not&nbsp;written&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3990158">dups</span>&nbsp;&nbsp;<span class="builtintype" id="3990164">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3990169">chans</span>&nbsp;<span class="op" id="3990175">[</span><span class="op" id="3990176">]</span><span class="keyword" id="3990177">chan</span><span class="op" id="3990181">&lt;-</span>&nbsp;<span class="ident" id="3990184">singleflightResult</span><br>
<span class="lineno"></span><span class="op" id="3990203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3990206">//&nbsp;singleflight&nbsp;represents&nbsp;a&nbsp;class&nbsp;of&nbsp;work&nbsp;and&nbsp;forms&nbsp;a&nbsp;namespace&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3990274">//&nbsp;which&nbsp;units&nbsp;of&nbsp;work&nbsp;can&nbsp;be&nbsp;executed&nbsp;with&nbsp;duplicate&nbsp;suppression.</span><br>
<span class="lineno"></span><span class="keyword" id="3990341">type</span>&nbsp;<span class="ident" id="3990346">singleflight</span>&nbsp;<span class="keyword" id="3990359">struct</span>&nbsp;<span class="op" id="3990366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3990369">mu</span>&nbsp;<span class="ident" id="3990372">sync</span><span class="op" id="3990376">.</span><span class="ident" id="3990377">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3990389">//&nbsp;protects&nbsp;m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3990404">m</span>&nbsp;&nbsp;<span class="keyword" id="3990407">map</span><span class="op" id="3990410">[</span><span class="builtintype" id="3990411">string</span><span class="op" id="3990417">]</span><span class="op" id="3990418">*</span><span class="ident" id="3990419">call</span>&nbsp;<span class="comment" id="3990424">//&nbsp;lazily&nbsp;initialized</span><br>
<span class="lineno">30</span><span class="op" id="3990446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3990449">//&nbsp;singleflightResult&nbsp;holds&nbsp;the&nbsp;results&nbsp;of&nbsp;Do,&nbsp;so&nbsp;they&nbsp;can&nbsp;be&nbsp;passed</span><br>
<span class="lineno"></span><span class="comment" id="3990518">//&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="3990535">type</span>&nbsp;<span class="ident" id="3990540">singleflightResult</span>&nbsp;<span class="keyword" id="3990559">struct</span>&nbsp;<span class="op" id="3990566">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3990569">v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3990576">interface</span><span class="op" id="3990585">{</span><span class="op" id="3990586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3990589">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3990596">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3990603">shared</span>&nbsp;<span class="builtintype" id="3990610">bool</span><br>
<span class="lineno"></span><span class="op" id="3990615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="3990618">//&nbsp;Do&nbsp;executes&nbsp;and&nbsp;returns&nbsp;the&nbsp;results&nbsp;of&nbsp;the&nbsp;given&nbsp;function,&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3990687">//&nbsp;sure&nbsp;that&nbsp;only&nbsp;one&nbsp;execution&nbsp;is&nbsp;in-flight&nbsp;for&nbsp;a&nbsp;given&nbsp;key&nbsp;at&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3990753">//&nbsp;time.&nbsp;If&nbsp;a&nbsp;duplicate&nbsp;comes&nbsp;in,&nbsp;the&nbsp;duplicate&nbsp;caller&nbsp;waits&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3990822">//&nbsp;original&nbsp;to&nbsp;complete&nbsp;and&nbsp;receives&nbsp;the&nbsp;same&nbsp;results.</span><br>
<span class="lineno"></span><span class="comment" id="3990877">//&nbsp;The&nbsp;return&nbsp;value&nbsp;shared&nbsp;indicates&nbsp;whether&nbsp;v&nbsp;was&nbsp;given&nbsp;to&nbsp;multiple&nbsp;callers.</span><br>
<span class="lineno">45</span><span class="keyword" id="3990955">func</span>&nbsp;<span class="op" id="3990960">(</span><span class="ident" id="3990961">g</span>&nbsp;<span class="op" id="3990963">*</span><span class="ident" id="3990964">singleflight</span><span class="op" id="3990976">)</span>&nbsp;<span class="ident" id="3990978">Do</span><span class="op" id="3990980">(</span><span class="ident" id="3990981">key</span>&nbsp;<span class="builtintype" id="3990985">string</span><span class="op" id="3990991">,</span>&nbsp;<span class="ident" id="3990993">fn</span>&nbsp;<span class="keyword" id="3990996">func</span><span class="op" id="3991000">(</span><span class="op" id="3991001">)</span>&nbsp;<span class="op" id="3991003">(</span><span class="keyword" id="3991004">interface</span><span class="op" id="3991013">{</span><span class="op" id="3991014">}</span><span class="op" id="3991015">,</span>&nbsp;<span class="builtintype" id="3991017">error</span><span class="op" id="3991022">)</span><span class="op" id="3991023">)</span>&nbsp;<span class="op" id="3991025">(</span><span class="ident" id="3991026">v</span>&nbsp;<span class="keyword" id="3991028">interface</span><span class="op" id="3991037">{</span><span class="op" id="3991038">}</span><span class="op" id="3991039">,</span>&nbsp;<span class="ident" id="3991041">err</span>&nbsp;<span class="builtintype" id="3991045">error</span><span class="op" id="3991050">,</span>&nbsp;<span class="ident" id="3991052">shared</span>&nbsp;<span class="builtintype" id="3991059">bool</span><span class="op" id="3991063">)</span>&nbsp;<span class="op" id="3991065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991068">g</span><span class="op" id="3991069">.</span><span class="ident" id="3991070">mu</span><span class="op" id="3991072">.</span><span class="ident" id="3991073">Lock</span><span class="op" id="3991077">(</span><span class="op" id="3991078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3991081">if</span>&nbsp;<span class="ident" id="3991084">g</span><span class="op" id="3991085">.</span><span class="ident" id="3991086">m</span>&nbsp;<span class="op" id="3991088">==</span>&nbsp;<span class="builtintype" id="3991091">nil</span>&nbsp;<span class="op" id="3991095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991099">g</span><span class="op" id="3991100">.</span><span class="ident" id="3991101">m</span>&nbsp;<span class="op" id="3991103">=</span>&nbsp;<span class="builtinfunc" id="3991105">make</span><span class="op" id="3991109">(</span><span class="keyword" id="3991110">map</span><span class="op" id="3991113">[</span><span class="builtintype" id="3991114">string</span><span class="op" id="3991120">]</span><span class="op" id="3991121">*</span><span class="ident" id="3991122">call</span><span class="op" id="3991126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3991129">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3991132">if</span>&nbsp;<span class="ident" id="3991135">c</span><span class="op" id="3991136">,</span>&nbsp;<span class="ident" id="3991138">ok</span>&nbsp;<span class="op" id="3991141">:=</span>&nbsp;<span class="ident" id="3991144">g</span><span class="op" id="3991145">.</span><span class="ident" id="3991146">m</span><span class="op" id="3991147">[</span><span class="ident" id="3991148">key</span><span class="op" id="3991151">]</span><span class="op" id="3991152">;</span>&nbsp;<span class="ident" id="3991154">ok</span>&nbsp;<span class="op" id="3991157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991161">c</span><span class="op" id="3991162">.</span><span class="ident" id="3991163">dups</span><span class="op" id="3991167">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991172">g</span><span class="op" id="3991173">.</span><span class="ident" id="3991174">mu</span><span class="op" id="3991176">.</span><span class="ident" id="3991177">Unlock</span><span class="op" id="3991183">(</span><span class="op" id="3991184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991188">c</span><span class="op" id="3991189">.</span><span class="ident" id="3991190">wg</span><span class="op" id="3991192">.</span><span class="ident" id="3991193">Wait</span><span class="op" id="3991197">(</span><span class="op" id="3991198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3991202">return</span>&nbsp;<span class="ident" id="3991209">c</span><span class="op" id="3991210">.</span><span class="ident" id="3991211">val</span><span class="op" id="3991214">,</span>&nbsp;<span class="ident" id="3991216">c</span><span class="op" id="3991217">.</span><span class="ident" id="3991218">err</span><span class="op" id="3991221">,</span>&nbsp;<span class="builtintype" id="3991223">true</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3991229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991232">c</span>&nbsp;<span class="op" id="3991234">:=</span>&nbsp;<span class="builtinfunc" id="3991237">new</span><span class="op" id="3991240">(</span><span class="ident" id="3991241">call</span><span class="op" id="3991245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991248">c</span><span class="op" id="3991249">.</span><span class="ident" id="3991250">wg</span><span class="op" id="3991252">.</span><span class="ident" id="3991253">Add</span><span class="op" id="3991256">(</span><span class="num" id="3991257">1</span><span class="op" id="3991258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991261">g</span><span class="op" id="3991262">.</span><span class="ident" id="3991263">m</span><span class="op" id="3991264">[</span><span class="ident" id="3991265">key</span><span class="op" id="3991268">]</span>&nbsp;<span class="op" id="3991270">=</span>&nbsp;<span class="ident" id="3991272">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991275">g</span><span class="op" id="3991276">.</span><span class="ident" id="3991277">mu</span><span class="op" id="3991279">.</span><span class="ident" id="3991280">Unlock</span><span class="op" id="3991286">(</span><span class="op" id="3991287">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991291">g</span><span class="op" id="3991292">.</span><span class="ident" id="3991293">doCall</span><span class="op" id="3991299">(</span><span class="ident" id="3991300">c</span><span class="op" id="3991301">,</span>&nbsp;<span class="ident" id="3991303">key</span><span class="op" id="3991306">,</span>&nbsp;<span class="ident" id="3991308">fn</span><span class="op" id="3991310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3991313">return</span>&nbsp;<span class="ident" id="3991320">c</span><span class="op" id="3991321">.</span><span class="ident" id="3991322">val</span><span class="op" id="3991325">,</span>&nbsp;<span class="ident" id="3991327">c</span><span class="op" id="3991328">.</span><span class="ident" id="3991329">err</span><span class="op" id="3991332">,</span>&nbsp;<span class="ident" id="3991334">c</span><span class="op" id="3991335">.</span><span class="ident" id="3991336">dups</span>&nbsp;<span class="op" id="3991341">&gt;</span>&nbsp;<span class="num" id="3991343">0</span><br>
<span class="lineno"></span><span class="op" id="3991345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3991348">//&nbsp;DoChan&nbsp;is&nbsp;like&nbsp;Do&nbsp;but&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;will&nbsp;receive&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3991413">//&nbsp;results&nbsp;when&nbsp;they&nbsp;are&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3991445">func</span>&nbsp;<span class="op" id="3991450">(</span><span class="ident" id="3991451">g</span>&nbsp;<span class="op" id="3991453">*</span><span class="ident" id="3991454">singleflight</span><span class="op" id="3991466">)</span>&nbsp;<span class="ident" id="3991468">DoChan</span><span class="op" id="3991474">(</span><span class="ident" id="3991475">key</span>&nbsp;<span class="builtintype" id="3991479">string</span><span class="op" id="3991485">,</span>&nbsp;<span class="ident" id="3991487">fn</span>&nbsp;<span class="keyword" id="3991490">func</span><span class="op" id="3991494">(</span><span class="op" id="3991495">)</span>&nbsp;<span class="op" id="3991497">(</span><span class="keyword" id="3991498">interface</span><span class="op" id="3991507">{</span><span class="op" id="3991508">}</span><span class="op" id="3991509">,</span>&nbsp;<span class="builtintype" id="3991511">error</span><span class="op" id="3991516">)</span><span class="op" id="3991517">)</span>&nbsp;<span class="op" id="3991519">&lt;-</span><span class="keyword" id="3991521">chan</span>&nbsp;<span class="ident" id="3991526">singleflightResult</span>&nbsp;<span class="op" id="3991545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991548">ch</span>&nbsp;<span class="op" id="3991551">:=</span>&nbsp;<span class="builtinfunc" id="3991554">make</span><span class="op" id="3991558">(</span><span class="keyword" id="3991559">chan</span>&nbsp;<span class="ident" id="3991564">singleflightResult</span><span class="op" id="3991582">,</span>&nbsp;<span class="num" id="3991584">1</span><span class="op" id="3991585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991588">g</span><span class="op" id="3991589">.</span><span class="ident" id="3991590">mu</span><span class="op" id="3991592">.</span><span class="ident" id="3991593">Lock</span><span class="op" id="3991597">(</span><span class="op" id="3991598">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3991601">if</span>&nbsp;<span class="ident" id="3991604">g</span><span class="op" id="3991605">.</span><span class="ident" id="3991606">m</span>&nbsp;<span class="op" id="3991608">==</span>&nbsp;<span class="builtintype" id="3991611">nil</span>&nbsp;<span class="op" id="3991615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991619">g</span><span class="op" id="3991620">.</span><span class="ident" id="3991621">m</span>&nbsp;<span class="op" id="3991623">=</span>&nbsp;<span class="builtinfunc" id="3991625">make</span><span class="op" id="3991629">(</span><span class="keyword" id="3991630">map</span><span class="op" id="3991633">[</span><span class="builtintype" id="3991634">string</span><span class="op" id="3991640">]</span><span class="op" id="3991641">*</span><span class="ident" id="3991642">call</span><span class="op" id="3991646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3991649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3991652">if</span>&nbsp;<span class="ident" id="3991655">c</span><span class="op" id="3991656">,</span>&nbsp;<span class="ident" id="3991658">ok</span>&nbsp;<span class="op" id="3991661">:=</span>&nbsp;<span class="ident" id="3991664">g</span><span class="op" id="3991665">.</span><span class="ident" id="3991666">m</span><span class="op" id="3991667">[</span><span class="ident" id="3991668">key</span><span class="op" id="3991671">]</span><span class="op" id="3991672">;</span>&nbsp;<span class="ident" id="3991674">ok</span>&nbsp;<span class="op" id="3991677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991681">c</span><span class="op" id="3991682">.</span><span class="ident" id="3991683">dups</span><span class="op" id="3991687">++</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991692">c</span><span class="op" id="3991693">.</span><span class="ident" id="3991694">chans</span>&nbsp;<span class="op" id="3991700">=</span>&nbsp;<span class="builtinfunc" id="3991702">append</span><span class="op" id="3991708">(</span><span class="ident" id="3991709">c</span><span class="op" id="3991710">.</span><span class="ident" id="3991711">chans</span><span class="op" id="3991716">,</span>&nbsp;<span class="ident" id="3991718">ch</span><span class="op" id="3991720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991724">g</span><span class="op" id="3991725">.</span><span class="ident" id="3991726">mu</span><span class="op" id="3991728">.</span><span class="ident" id="3991729">Unlock</span><span class="op" id="3991735">(</span><span class="op" id="3991736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3991740">return</span>&nbsp;<span class="ident" id="3991747">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3991751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991754">c</span>&nbsp;<span class="op" id="3991756">:=</span>&nbsp;<span class="op" id="3991759">&amp;</span><span class="ident" id="3991760">call</span><span class="op" id="3991764">{</span><span class="ident" id="3991765">chans</span><span class="op" id="3991770">:</span>&nbsp;<span class="op" id="3991772">[</span><span class="op" id="3991773">]</span><span class="keyword" id="3991774">chan</span><span class="op" id="3991778">&lt;-</span>&nbsp;<span class="ident" id="3991781">singleflightResult</span><span class="op" id="3991799">{</span><span class="ident" id="3991800">ch</span><span class="op" id="3991802">}</span><span class="op" id="3991803">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991806">c</span><span class="op" id="3991807">.</span><span class="ident" id="3991808">wg</span><span class="op" id="3991810">.</span><span class="ident" id="3991811">Add</span><span class="op" id="3991814">(</span><span class="num" id="3991815">1</span><span class="op" id="3991816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991819">g</span><span class="op" id="3991820">.</span><span class="ident" id="3991821">m</span><span class="op" id="3991822">[</span><span class="ident" id="3991823">key</span><span class="op" id="3991826">]</span>&nbsp;<span class="op" id="3991828">=</span>&nbsp;<span class="ident" id="3991830">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3991833">g</span><span class="op" id="3991834">.</span><span class="ident" id="3991835">mu</span><span class="op" id="3991837">.</span><span class="ident" id="3991838">Unlock</span><span class="op" id="3991844">(</span><span class="op" id="3991845">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3991849">go</span>&nbsp;<span class="ident" id="3991852">g</span><span class="op" id="3991853">.</span><span class="ident" id="3991854">doCall</span><span class="op" id="3991860">(</span><span class="ident" id="3991861">c</span><span class="op" id="3991862">,</span>&nbsp;<span class="ident" id="3991864">key</span><span class="op" id="3991867">,</span>&nbsp;<span class="ident" id="3991869">fn</span><span class="op" id="3991871">)</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3991875">return</span>&nbsp;<span class="ident" id="3991882">ch</span><br>
<span class="lineno"></span><span class="op" id="3991885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3991888">//&nbsp;doCall&nbsp;handles&nbsp;the&nbsp;single&nbsp;call&nbsp;for&nbsp;a&nbsp;key.</span><br>
<span class="lineno">90</span><span class="keyword" id="3991933">func</span>&nbsp;<span class="op" id="3991938">(</span><span class="ident" id="3991939">g</span>&nbsp;<span class="op" id="3991941">*</span><span class="ident" id="3991942">singleflight</span><span class="op" id="3991954">)</span>&nbsp;<span class="ident" id="3991956">doCall</span><span class="op" id="3991962">(</span><span class="ident" id="3991963">c</span>&nbsp;<span class="op" id="3991965">*</span><span class="ident" id="3991966">call</span><span class="op" id="3991970">,</span>&nbsp;<span class="ident" id="3991972">key</span>&nbsp;<span class="builtintype" id="3991976">string</span><span class="op" id="3991982">,</span>&nbsp;<span class="ident" id="3991984">fn</span>&nbsp;<span class="keyword" id="3991987">func</span><span class="op" id="3991991">(</span><span class="op" id="3991992">)</span>&nbsp;<span class="op" id="3991994">(</span><span class="keyword" id="3991995">interface</span><span class="op" id="3992004">{</span><span class="op" id="3992005">}</span><span class="op" id="3992006">,</span>&nbsp;<span class="builtintype" id="3992008">error</span><span class="op" id="3992013">)</span><span class="op" id="3992014">)</span>&nbsp;<span class="op" id="3992016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3992019">c</span><span class="op" id="3992020">.</span><span class="ident" id="3992021">val</span><span class="op" id="3992024">,</span>&nbsp;<span class="ident" id="3992026">c</span><span class="op" id="3992027">.</span><span class="ident" id="3992028">err</span>&nbsp;<span class="op" id="3992032">=</span>&nbsp;<span class="ident" id="3992034">fn</span><span class="op" id="3992036">(</span><span class="op" id="3992037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3992040">c</span><span class="op" id="3992041">.</span><span class="ident" id="3992042">wg</span><span class="op" id="3992044">.</span><span class="ident" id="3992045">Done</span><span class="op" id="3992049">(</span><span class="op" id="3992050">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3992054">g</span><span class="op" id="3992055">.</span><span class="ident" id="3992056">mu</span><span class="op" id="3992058">.</span><span class="ident" id="3992059">Lock</span><span class="op" id="3992063">(</span><span class="op" id="3992064">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3992067">delete</span><span class="op" id="3992073">(</span><span class="ident" id="3992074">g</span><span class="op" id="3992075">.</span><span class="ident" id="3992076">m</span><span class="op" id="3992077">,</span>&nbsp;<span class="ident" id="3992079">key</span><span class="op" id="3992082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3992085">for</span>&nbsp;<span class="ident" id="3992089">_</span><span class="op" id="3992090">,</span>&nbsp;<span class="ident" id="3992092">ch</span>&nbsp;<span class="op" id="3992095">:=</span>&nbsp;<span class="keyword" id="3992098">range</span>&nbsp;<span class="ident" id="3992104">c</span><span class="op" id="3992105">.</span><span class="ident" id="3992106">chans</span>&nbsp;<span class="op" id="3992112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3992116">ch</span>&nbsp;<span class="op" id="3992119">&lt;-</span>&nbsp;<span class="ident" id="3992122">singleflightResult</span><span class="op" id="3992140">{</span><span class="ident" id="3992141">c</span><span class="op" id="3992142">.</span><span class="ident" id="3992143">val</span><span class="op" id="3992146">,</span>&nbsp;<span class="ident" id="3992148">c</span><span class="op" id="3992149">.</span><span class="ident" id="3992150">err</span><span class="op" id="3992153">,</span>&nbsp;<span class="ident" id="3992155">c</span><span class="op" id="3992156">.</span><span class="ident" id="3992157">dups</span>&nbsp;<span class="op" id="3992162">&gt;</span>&nbsp;<span class="num" id="3992164">0</span><span class="op" id="3992165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3992168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3992171">g</span><span class="op" id="3992172">.</span><span class="ident" id="3992173">mu</span><span class="op" id="3992175">.</span><span class="ident" id="3992176">Unlock</span><span class="op" id="3992182">(</span><span class="op" id="3992183">)</span><br>
<span class="lineno">100</span><span class="op" id="3992185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3992188">//&nbsp;Forget&nbsp;tells&nbsp;the&nbsp;singleflight&nbsp;to&nbsp;forget&nbsp;about&nbsp;a&nbsp;key.&nbsp;&nbsp;Future&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3992258">//&nbsp;to&nbsp;Do&nbsp;for&nbsp;this&nbsp;key&nbsp;will&nbsp;call&nbsp;the&nbsp;function&nbsp;rather&nbsp;than&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3992327">//&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;complete.</span><br>
<span class="lineno">105</span><span class="keyword" id="3992359">func</span>&nbsp;<span class="op" id="3992364">(</span><span class="ident" id="3992365">g</span>&nbsp;<span class="op" id="3992367">*</span><span class="ident" id="3992368">singleflight</span><span class="op" id="3992380">)</span>&nbsp;<span class="ident" id="3992382">Forget</span><span class="op" id="3992388">(</span><span class="ident" id="3992389">key</span>&nbsp;<span class="builtintype" id="3992393">string</span><span class="op" id="3992399">)</span>&nbsp;<span class="op" id="3992401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3992404">g</span><span class="op" id="3992405">.</span><span class="ident" id="3992406">mu</span><span class="op" id="3992408">.</span><span class="ident" id="3992409">Lock</span><span class="op" id="3992413">(</span><span class="op" id="3992414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3992417">delete</span><span class="op" id="3992423">(</span><span class="ident" id="3992424">g</span><span class="op" id="3992425">.</span><span class="ident" id="3992426">m</span><span class="op" id="3992427">,</span>&nbsp;<span class="ident" id="3992429">key</span><span class="op" id="3992432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3992435">g</span><span class="op" id="3992436">.</span><span class="ident" id="3992437">mu</span><span class="op" id="3992439">.</span><span class="ident" id="3992440">Unlock</span><span class="op" id="3992446">(</span><span class="op" id="3992447">)</span><br>
<span class="lineno"></span><span class="op" id="3992449">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
