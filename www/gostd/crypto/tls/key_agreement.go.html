<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4248525">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4248580">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4248634">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4248685">package</span>&nbsp;<span class="ident" id="4248693">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4248698">import</span>&nbsp;<span class="op" id="4248705">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4248708">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4248718">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4248734">&#34;crypto/elliptic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4248753">&#34;crypto/md5&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4248767">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4248781">&#34;crypto/sha1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4248796">&#34;crypto/sha256&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4248813">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4248828">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4248845">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4248855">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4248861">&#34;math/big&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4248872">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4248875">var</span>&nbsp;<span class="ident" id="4248879">errClientKeyExchange</span>&nbsp;<span class="op" id="4248900">=</span>&nbsp;<span class="ident" id="4248902">errors</span><span class="op" id="4248908">.</span><span class="ident" id="4248909">New</span><span class="op" id="4248912">(</span><span class="string" id="4248913">&#34;tls:&nbsp;invalid&nbsp;ClientKeyExchange&nbsp;message&#34;</span><span class="op" id="4248953">)</span><br>
<span class="lineno"></span><span class="keyword" id="4248955">var</span>&nbsp;<span class="ident" id="4248959">errServerKeyExchange</span>&nbsp;<span class="op" id="4248980">=</span>&nbsp;<span class="ident" id="4248982">errors</span><span class="op" id="4248988">.</span><span class="ident" id="4248989">New</span><span class="op" id="4248992">(</span><span class="string" id="4248993">&#34;tls:&nbsp;invalid&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="4249033">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4249036">//&nbsp;rsaKeyAgreement&nbsp;implements&nbsp;the&nbsp;standard&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="4249114">//&nbsp;encrypts&nbsp;the&nbsp;pre-master&nbsp;secret&nbsp;to&nbsp;the&nbsp;server&#39;s&nbsp;public&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="4249176">type</span>&nbsp;<span class="ident" id="4249181">rsaKeyAgreement</span>&nbsp;<span class="keyword" id="4249197">struct</span><span class="op" id="4249203">{</span><span class="op" id="4249204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4249207">func</span>&nbsp;<span class="op" id="4249212">(</span><span class="ident" id="4249213">ka</span>&nbsp;<span class="ident" id="4249216">rsaKeyAgreement</span><span class="op" id="4249231">)</span>&nbsp;<span class="ident" id="4249233">generateServerKeyExchange</span><span class="op" id="4249258">(</span><span class="ident" id="4249259">config</span>&nbsp;<span class="op" id="4249266">*</span><span class="ident" id="4249267">Config</span><span class="op" id="4249273">,</span>&nbsp;<span class="ident" id="4249275">cert</span>&nbsp;<span class="op" id="4249280">*</span><span class="ident" id="4249281">Certificate</span><span class="op" id="4249292">,</span>&nbsp;<span class="ident" id="4249294">clientHello</span>&nbsp;<span class="op" id="4249306">*</span><span class="ident" id="4249307">clientHelloMsg</span><span class="op" id="4249321">,</span>&nbsp;<span class="ident" id="4249323">hello</span>&nbsp;<span class="op" id="4249329">*</span><span class="ident" id="4249330">serverHelloMsg</span><span class="op" id="4249344">)</span>&nbsp;<span class="op" id="4249346">(</span><span class="op" id="4249347">*</span><span class="ident" id="4249348">serverKeyExchangeMsg</span><span class="op" id="4249368">,</span>&nbsp;<span class="builtintype" id="4249370">error</span><span class="op" id="4249375">)</span>&nbsp;<span class="op" id="4249377">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249380">return</span>&nbsp;<span class="ident" id="4249387">nil</span><span class="op" id="4249390">,</span>&nbsp;<span class="ident" id="4249392">nil</span><br>
<span class="lineno"></span><span class="op" id="4249396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4249399">func</span>&nbsp;<span class="op" id="4249404">(</span><span class="ident" id="4249405">ka</span>&nbsp;<span class="ident" id="4249408">rsaKeyAgreement</span><span class="op" id="4249423">)</span>&nbsp;<span class="ident" id="4249425">processClientKeyExchange</span><span class="op" id="4249449">(</span><span class="ident" id="4249450">config</span>&nbsp;<span class="op" id="4249457">*</span><span class="ident" id="4249458">Config</span><span class="op" id="4249464">,</span>&nbsp;<span class="ident" id="4249466">cert</span>&nbsp;<span class="op" id="4249471">*</span><span class="ident" id="4249472">Certificate</span><span class="op" id="4249483">,</span>&nbsp;<span class="ident" id="4249485">ckx</span>&nbsp;<span class="op" id="4249489">*</span><span class="ident" id="4249490">clientKeyExchangeMsg</span><span class="op" id="4249510">,</span>&nbsp;<span class="ident" id="4249512">version</span>&nbsp;<span class="builtintype" id="4249520">uint16</span><span class="op" id="4249526">)</span>&nbsp;<span class="op" id="4249528">(</span><span class="op" id="4249529">[</span><span class="op" id="4249530">]</span><span class="builtintype" id="4249531">byte</span><span class="op" id="4249535">,</span>&nbsp;<span class="builtintype" id="4249537">error</span><span class="op" id="4249542">)</span>&nbsp;<span class="op" id="4249544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249547">preMasterSecret</span>&nbsp;<span class="op" id="4249563">:=</span>&nbsp;<span class="builtinfunc" id="4249566">make</span><span class="op" id="4249570">(</span><span class="op" id="4249571">[</span><span class="op" id="4249572">]</span><span class="builtintype" id="4249573">byte</span><span class="op" id="4249577">,</span>&nbsp;<span class="num" id="4249579">48</span><span class="op" id="4249581">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249584">_</span><span class="op" id="4249585">,</span>&nbsp;<span class="ident" id="4249587">err</span>&nbsp;<span class="op" id="4249591">:=</span>&nbsp;<span class="ident" id="4249594">io</span><span class="op" id="4249596">.</span><span class="ident" id="4249597">ReadFull</span><span class="op" id="4249605">(</span><span class="ident" id="4249606">config</span><span class="op" id="4249612">.</span><span class="ident" id="4249613">rand</span><span class="op" id="4249617">(</span><span class="op" id="4249618">)</span><span class="op" id="4249619">,</span>&nbsp;<span class="ident" id="4249621">preMasterSecret</span><span class="op" id="4249636">[</span><span class="num" id="4249637">2</span><span class="op" id="4249638">:</span><span class="op" id="4249639">]</span><span class="op" id="4249640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249643">if</span>&nbsp;<span class="ident" id="4249646">err</span>&nbsp;<span class="op" id="4249650">!=</span>&nbsp;<span class="ident" id="4249653">nil</span>&nbsp;<span class="op" id="4249657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249661">return</span>&nbsp;<span class="ident" id="4249668">nil</span><span class="op" id="4249671">,</span>&nbsp;<span class="ident" id="4249673">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4249678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249682">if</span>&nbsp;<span class="builtinfunc" id="4249685">len</span><span class="op" id="4249688">(</span><span class="ident" id="4249689">ckx</span><span class="op" id="4249692">.</span><span class="ident" id="4249693">ciphertext</span><span class="op" id="4249703">)</span>&nbsp;<span class="op" id="4249705">&lt;</span>&nbsp;<span class="num" id="4249707">2</span>&nbsp;<span class="op" id="4249709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249713">return</span>&nbsp;<span class="ident" id="4249720">nil</span><span class="op" id="4249723">,</span>&nbsp;<span class="ident" id="4249725">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4249747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249751">ciphertext</span>&nbsp;<span class="op" id="4249762">:=</span>&nbsp;<span class="ident" id="4249765">ckx</span><span class="op" id="4249768">.</span><span class="ident" id="4249769">ciphertext</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249781">if</span>&nbsp;<span class="ident" id="4249784">version</span>&nbsp;<span class="op" id="4249792">!=</span>&nbsp;<span class="ident" id="4249795">VersionSSL30</span>&nbsp;<span class="op" id="4249808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249812">ciphertextLen</span>&nbsp;<span class="op" id="4249826">:=</span>&nbsp;<span class="builtintype" id="4249829">int</span><span class="op" id="4249832">(</span><span class="ident" id="4249833">ckx</span><span class="op" id="4249836">.</span><span class="ident" id="4249837">ciphertext</span><span class="op" id="4249847">[</span><span class="num" id="4249848">0</span><span class="op" id="4249849">]</span><span class="op" id="4249850">)</span><span class="op" id="4249851">&lt;&lt;</span><span class="num" id="4249853">8</span>&nbsp;<span class="op" id="4249855">|</span>&nbsp;<span class="builtintype" id="4249857">int</span><span class="op" id="4249860">(</span><span class="ident" id="4249861">ckx</span><span class="op" id="4249864">.</span><span class="ident" id="4249865">ciphertext</span><span class="op" id="4249875">[</span><span class="num" id="4249876">1</span><span class="op" id="4249877">]</span><span class="op" id="4249878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249882">if</span>&nbsp;<span class="ident" id="4249885">ciphertextLen</span>&nbsp;<span class="op" id="4249899">!=</span>&nbsp;<span class="builtinfunc" id="4249902">len</span><span class="op" id="4249905">(</span><span class="ident" id="4249906">ckx</span><span class="op" id="4249909">.</span><span class="ident" id="4249910">ciphertext</span><span class="op" id="4249920">)</span><span class="op" id="4249921">-</span><span class="num" id="4249922">2</span>&nbsp;<span class="op" id="4249924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4249929">return</span>&nbsp;<span class="ident" id="4249936">nil</span><span class="op" id="4249939">,</span>&nbsp;<span class="ident" id="4249941">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4249964">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4249968">ciphertext</span>&nbsp;<span class="op" id="4249979">=</span>&nbsp;<span class="ident" id="4249981">ckx</span><span class="op" id="4249984">.</span><span class="ident" id="4249985">ciphertext</span><span class="op" id="4249995">[</span><span class="num" id="4249996">2</span><span class="op" id="4249997">:</span><span class="op" id="4249998">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4250001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4250005">err</span>&nbsp;<span class="op" id="4250009">=</span>&nbsp;<span class="ident" id="4250011">rsa</span><span class="op" id="4250014">.</span><span class="ident" id="4250015">DecryptPKCS1v15SessionKey</span><span class="op" id="4250040">(</span><span class="ident" id="4250041">config</span><span class="op" id="4250047">.</span><span class="ident" id="4250048">rand</span><span class="op" id="4250052">(</span><span class="op" id="4250053">)</span><span class="op" id="4250054">,</span>&nbsp;<span class="ident" id="4250056">cert</span><span class="op" id="4250060">.</span><span class="ident" id="4250061">PrivateKey</span><span class="op" id="4250071">.</span><span class="op" id="4250072">(</span><span class="op" id="4250073">*</span><span class="ident" id="4250074">rsa</span><span class="op" id="4250077">.</span><span class="ident" id="4250078">PrivateKey</span><span class="op" id="4250088">)</span><span class="op" id="4250089">,</span>&nbsp;<span class="ident" id="4250091">ciphertext</span><span class="op" id="4250101">,</span>&nbsp;<span class="ident" id="4250103">preMasterSecret</span><span class="op" id="4250118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250121">if</span>&nbsp;<span class="ident" id="4250124">err</span>&nbsp;<span class="op" id="4250128">!=</span>&nbsp;<span class="ident" id="4250131">nil</span>&nbsp;<span class="op" id="4250135">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250139">return</span>&nbsp;<span class="ident" id="4250146">nil</span><span class="op" id="4250149">,</span>&nbsp;<span class="ident" id="4250151">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4250156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4250159">//&nbsp;We&nbsp;don&#39;t&nbsp;check&nbsp;the&nbsp;version&nbsp;number&nbsp;in&nbsp;the&nbsp;premaster&nbsp;secret.&nbsp;&nbsp;For&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4250232">//&nbsp;by&nbsp;checking&nbsp;it,&nbsp;we&nbsp;would&nbsp;leak&nbsp;information&nbsp;about&nbsp;the&nbsp;validity&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4250304">//&nbsp;encrypted&nbsp;pre-master&nbsp;secret.&nbsp;Secondly,&nbsp;it&nbsp;provides&nbsp;only&nbsp;a&nbsp;small</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4250372">//&nbsp;benefit&nbsp;against&nbsp;a&nbsp;downgrade&nbsp;attack&nbsp;and&nbsp;some&nbsp;implementations&nbsp;send&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4250445">//&nbsp;wrong&nbsp;version&nbsp;anyway.&nbsp;See&nbsp;the&nbsp;discussion&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;section</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4250512">//&nbsp;7.4.7.1&nbsp;of&nbsp;RFC&nbsp;4346.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250537">return</span>&nbsp;<span class="ident" id="4250544">preMasterSecret</span><span class="op" id="4250559">,</span>&nbsp;<span class="ident" id="4250561">nil</span><br>
<span class="lineno"></span><span class="op" id="4250565">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="4250568">func</span>&nbsp;<span class="op" id="4250573">(</span><span class="ident" id="4250574">ka</span>&nbsp;<span class="ident" id="4250577">rsaKeyAgreement</span><span class="op" id="4250592">)</span>&nbsp;<span class="ident" id="4250594">processServerKeyExchange</span><span class="op" id="4250618">(</span><span class="ident" id="4250619">config</span>&nbsp;<span class="op" id="4250626">*</span><span class="ident" id="4250627">Config</span><span class="op" id="4250633">,</span>&nbsp;<span class="ident" id="4250635">clientHello</span>&nbsp;<span class="op" id="4250647">*</span><span class="ident" id="4250648">clientHelloMsg</span><span class="op" id="4250662">,</span>&nbsp;<span class="ident" id="4250664">serverHello</span>&nbsp;<span class="op" id="4250676">*</span><span class="ident" id="4250677">serverHelloMsg</span><span class="op" id="4250691">,</span>&nbsp;<span class="ident" id="4250693">cert</span>&nbsp;<span class="op" id="4250698">*</span><span class="ident" id="4250699">x509</span><span class="op" id="4250703">.</span><span class="ident" id="4250704">Certificate</span><span class="op" id="4250715">,</span>&nbsp;<span class="ident" id="4250717">skx</span>&nbsp;<span class="op" id="4250721">*</span><span class="ident" id="4250722">serverKeyExchangeMsg</span><span class="op" id="4250742">)</span>&nbsp;<span class="builtintype" id="4250744">error</span>&nbsp;<span class="op" id="4250750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4250753">return</span>&nbsp;<span class="ident" id="4250760">errors</span><span class="op" id="4250766">.</span><span class="ident" id="4250767">New</span><span class="op" id="4250770">(</span><span class="string" id="4250771">&#34;tls:&nbsp;unexpected&nbsp;ServerKeyExchange&#34;</span><span class="op" id="4250806">)</span><br>
<span class="lineno"></span><span class="op" id="4250808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="4250811">func</span>&nbsp;<span class="op" id="4250816">(</span><span class="ident" id="4250817">ka</span>&nbsp;<span class="ident" id="4250820">rsaKeyAgreement</span><span class="op" id="4250835">)</span>&nbsp;<span class="ident" id="4250837">generateClientKeyExchange</span><span class="op" id="4250862">(</span><span class="ident" id="4250863">config</span>&nbsp;<span class="op" id="4250870">*</span><span class="ident" id="4250871">Config</span><span class="op" id="4250877">,</span>&nbsp;<span class="ident" id="4250879">clientHello</span>&nbsp;<span class="op" id="4250891">*</span><span class="ident" id="4250892">clientHelloMsg</span><span class="op" id="4250906">,</span>&nbsp;<span class="ident" id="4250908">cert</span>&nbsp;<span class="op" id="4250913">*</span><span class="ident" id="4250914">x509</span><span class="op" id="4250918">.</span><span class="ident" id="4250919">Certificate</span><span class="op" id="4250930">)</span>&nbsp;<span class="op" id="4250932">(</span><span class="op" id="4250933">[</span><span class="op" id="4250934">]</span><span class="builtintype" id="4250935">byte</span><span class="op" id="4250939">,</span>&nbsp;<span class="op" id="4250941">*</span><span class="ident" id="4250942">clientKeyExchangeMsg</span><span class="op" id="4250962">,</span>&nbsp;<span class="builtintype" id="4250964">error</span><span class="op" id="4250969">)</span>&nbsp;<span class="op" id="4250971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4250974">preMasterSecret</span>&nbsp;<span class="op" id="4250990">:=</span>&nbsp;<span class="builtinfunc" id="4250993">make</span><span class="op" id="4250997">(</span><span class="op" id="4250998">[</span><span class="op" id="4250999">]</span><span class="builtintype" id="4251000">byte</span><span class="op" id="4251004">,</span>&nbsp;<span class="num" id="4251006">48</span><span class="op" id="4251008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251011">preMasterSecret</span><span class="op" id="4251026">[</span><span class="num" id="4251027">0</span><span class="op" id="4251028">]</span>&nbsp;<span class="op" id="4251030">=</span>&nbsp;<span class="builtintype" id="4251032">byte</span><span class="op" id="4251036">(</span><span class="ident" id="4251037">clientHello</span><span class="op" id="4251048">.</span><span class="ident" id="4251049">vers</span>&nbsp;<span class="op" id="4251054">&gt;&gt;</span>&nbsp;<span class="num" id="4251057">8</span><span class="op" id="4251058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251061">preMasterSecret</span><span class="op" id="4251076">[</span><span class="num" id="4251077">1</span><span class="op" id="4251078">]</span>&nbsp;<span class="op" id="4251080">=</span>&nbsp;<span class="builtintype" id="4251082">byte</span><span class="op" id="4251086">(</span><span class="ident" id="4251087">clientHello</span><span class="op" id="4251098">.</span><span class="ident" id="4251099">vers</span><span class="op" id="4251103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251106">_</span><span class="op" id="4251107">,</span>&nbsp;<span class="ident" id="4251109">err</span>&nbsp;<span class="op" id="4251113">:=</span>&nbsp;<span class="ident" id="4251116">io</span><span class="op" id="4251118">.</span><span class="ident" id="4251119">ReadFull</span><span class="op" id="4251127">(</span><span class="ident" id="4251128">config</span><span class="op" id="4251134">.</span><span class="ident" id="4251135">rand</span><span class="op" id="4251139">(</span><span class="op" id="4251140">)</span><span class="op" id="4251141">,</span>&nbsp;<span class="ident" id="4251143">preMasterSecret</span><span class="op" id="4251158">[</span><span class="num" id="4251159">2</span><span class="op" id="4251160">:</span><span class="op" id="4251161">]</span><span class="op" id="4251162">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251165">if</span>&nbsp;<span class="ident" id="4251168">err</span>&nbsp;<span class="op" id="4251172">!=</span>&nbsp;<span class="ident" id="4251175">nil</span>&nbsp;<span class="op" id="4251179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251183">return</span>&nbsp;<span class="ident" id="4251190">nil</span><span class="op" id="4251193">,</span>&nbsp;<span class="ident" id="4251195">nil</span><span class="op" id="4251198">,</span>&nbsp;<span class="ident" id="4251200">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4251205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251209">encrypted</span><span class="op" id="4251218">,</span>&nbsp;<span class="ident" id="4251220">err</span>&nbsp;<span class="op" id="4251224">:=</span>&nbsp;<span class="ident" id="4251227">rsa</span><span class="op" id="4251230">.</span><span class="ident" id="4251231">EncryptPKCS1v15</span><span class="op" id="4251246">(</span><span class="ident" id="4251247">config</span><span class="op" id="4251253">.</span><span class="ident" id="4251254">rand</span><span class="op" id="4251258">(</span><span class="op" id="4251259">)</span><span class="op" id="4251260">,</span>&nbsp;<span class="ident" id="4251262">cert</span><span class="op" id="4251266">.</span><span class="ident" id="4251267">PublicKey</span><span class="op" id="4251276">.</span><span class="op" id="4251277">(</span><span class="op" id="4251278">*</span><span class="ident" id="4251279">rsa</span><span class="op" id="4251282">.</span><span class="ident" id="4251283">PublicKey</span><span class="op" id="4251292">)</span><span class="op" id="4251293">,</span>&nbsp;<span class="ident" id="4251295">preMasterSecret</span><span class="op" id="4251310">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251313">if</span>&nbsp;<span class="ident" id="4251316">err</span>&nbsp;<span class="op" id="4251320">!=</span>&nbsp;<span class="ident" id="4251323">nil</span>&nbsp;<span class="op" id="4251327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251331">return</span>&nbsp;<span class="ident" id="4251338">nil</span><span class="op" id="4251341">,</span>&nbsp;<span class="ident" id="4251343">nil</span><span class="op" id="4251346">,</span>&nbsp;<span class="ident" id="4251348">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4251353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251356">ckx</span>&nbsp;<span class="op" id="4251360">:=</span>&nbsp;<span class="builtinfunc" id="4251363">new</span><span class="op" id="4251366">(</span><span class="ident" id="4251367">clientKeyExchangeMsg</span><span class="op" id="4251387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251390">ckx</span><span class="op" id="4251393">.</span><span class="ident" id="4251394">ciphertext</span>&nbsp;<span class="op" id="4251405">=</span>&nbsp;<span class="builtinfunc" id="4251407">make</span><span class="op" id="4251411">(</span><span class="op" id="4251412">[</span><span class="op" id="4251413">]</span><span class="builtintype" id="4251414">byte</span><span class="op" id="4251418">,</span>&nbsp;<span class="builtinfunc" id="4251420">len</span><span class="op" id="4251423">(</span><span class="ident" id="4251424">encrypted</span><span class="op" id="4251433">)</span><span class="op" id="4251434">+</span><span class="num" id="4251435">2</span><span class="op" id="4251436">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251439">ckx</span><span class="op" id="4251442">.</span><span class="ident" id="4251443">ciphertext</span><span class="op" id="4251453">[</span><span class="num" id="4251454">0</span><span class="op" id="4251455">]</span>&nbsp;<span class="op" id="4251457">=</span>&nbsp;<span class="builtintype" id="4251459">byte</span><span class="op" id="4251463">(</span><span class="builtinfunc" id="4251464">len</span><span class="op" id="4251467">(</span><span class="ident" id="4251468">encrypted</span><span class="op" id="4251477">)</span>&nbsp;<span class="op" id="4251479">&gt;&gt;</span>&nbsp;<span class="num" id="4251482">8</span><span class="op" id="4251483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251486">ckx</span><span class="op" id="4251489">.</span><span class="ident" id="4251490">ciphertext</span><span class="op" id="4251500">[</span><span class="num" id="4251501">1</span><span class="op" id="4251502">]</span>&nbsp;<span class="op" id="4251504">=</span>&nbsp;<span class="builtintype" id="4251506">byte</span><span class="op" id="4251510">(</span><span class="builtinfunc" id="4251511">len</span><span class="op" id="4251514">(</span><span class="ident" id="4251515">encrypted</span><span class="op" id="4251524">)</span><span class="op" id="4251525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4251528">copy</span><span class="op" id="4251532">(</span><span class="ident" id="4251533">ckx</span><span class="op" id="4251536">.</span><span class="ident" id="4251537">ciphertext</span><span class="op" id="4251547">[</span><span class="num" id="4251548">2</span><span class="op" id="4251549">:</span><span class="op" id="4251550">]</span><span class="op" id="4251551">,</span>&nbsp;<span class="ident" id="4251553">encrypted</span><span class="op" id="4251562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251565">return</span>&nbsp;<span class="ident" id="4251572">preMasterSecret</span><span class="op" id="4251587">,</span>&nbsp;<span class="ident" id="4251589">ckx</span><span class="op" id="4251592">,</span>&nbsp;<span class="ident" id="4251594">nil</span><br>
<span class="lineno"></span><span class="op" id="4251598">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4251601">//&nbsp;sha1Hash&nbsp;calculates&nbsp;a&nbsp;SHA1&nbsp;hash&nbsp;over&nbsp;the&nbsp;given&nbsp;byte&nbsp;slices.</span><br>
<span class="lineno"></span><span class="keyword" id="4251664">func</span>&nbsp;<span class="ident" id="4251669">sha1Hash</span><span class="op" id="4251677">(</span><span class="ident" id="4251678">slices</span>&nbsp;<span class="op" id="4251685">[</span><span class="op" id="4251686">]</span><span class="op" id="4251687">[</span><span class="op" id="4251688">]</span><span class="builtintype" id="4251689">byte</span><span class="op" id="4251693">)</span>&nbsp;<span class="op" id="4251695">[</span><span class="op" id="4251696">]</span><span class="builtintype" id="4251697">byte</span>&nbsp;<span class="op" id="4251702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251705">hsha1</span>&nbsp;<span class="op" id="4251711">:=</span>&nbsp;<span class="ident" id="4251714">sha1</span><span class="op" id="4251718">.</span><span class="ident" id="4251719">New</span><span class="op" id="4251722">(</span><span class="op" id="4251723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251726">for</span>&nbsp;<span class="ident" id="4251730">_</span><span class="op" id="4251731">,</span>&nbsp;<span class="ident" id="4251733">slice</span>&nbsp;<span class="op" id="4251739">:=</span>&nbsp;<span class="keyword" id="4251742">range</span>&nbsp;<span class="ident" id="4251748">slices</span>&nbsp;<span class="op" id="4251755">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251759">hsha1</span><span class="op" id="4251764">.</span><span class="ident" id="4251765">Write</span><span class="op" id="4251770">(</span><span class="ident" id="4251771">slice</span><span class="op" id="4251776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4251779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4251782">return</span>&nbsp;<span class="ident" id="4251789">hsha1</span><span class="op" id="4251794">.</span><span class="ident" id="4251795">Sum</span><span class="op" id="4251798">(</span><span class="ident" id="4251799">nil</span><span class="op" id="4251802">)</span><br>
<span class="lineno"></span><span class="op" id="4251804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="4251807">//&nbsp;md5SHA1Hash&nbsp;implements&nbsp;TLS&nbsp;1.0&#39;s&nbsp;hybrid&nbsp;hash&nbsp;function&nbsp;which&nbsp;consists&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4251886">//&nbsp;concatenation&nbsp;of&nbsp;an&nbsp;MD5&nbsp;and&nbsp;SHA1&nbsp;hash.</span><br>
<span class="lineno"></span><span class="keyword" id="4251928">func</span>&nbsp;<span class="ident" id="4251933">md5SHA1Hash</span><span class="op" id="4251944">(</span><span class="ident" id="4251945">slices</span>&nbsp;<span class="op" id="4251952">[</span><span class="op" id="4251953">]</span><span class="op" id="4251954">[</span><span class="op" id="4251955">]</span><span class="builtintype" id="4251956">byte</span><span class="op" id="4251960">)</span>&nbsp;<span class="op" id="4251962">[</span><span class="op" id="4251963">]</span><span class="builtintype" id="4251964">byte</span>&nbsp;<span class="op" id="4251969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251972">md5sha1</span>&nbsp;<span class="op" id="4251980">:=</span>&nbsp;<span class="builtinfunc" id="4251983">make</span><span class="op" id="4251987">(</span><span class="op" id="4251988">[</span><span class="op" id="4251989">]</span><span class="builtintype" id="4251990">byte</span><span class="op" id="4251994">,</span>&nbsp;<span class="ident" id="4251996">md5</span><span class="op" id="4251999">.</span><span class="ident" id="4252000">Size</span><span class="op" id="4252004">+</span><span class="ident" id="4252005">sha1</span><span class="op" id="4252009">.</span><span class="ident" id="4252010">Size</span><span class="op" id="4252014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252017">hmd5</span>&nbsp;<span class="op" id="4252022">:=</span>&nbsp;<span class="ident" id="4252025">md5</span><span class="op" id="4252028">.</span><span class="ident" id="4252029">New</span><span class="op" id="4252032">(</span><span class="op" id="4252033">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252036">for</span>&nbsp;<span class="ident" id="4252040">_</span><span class="op" id="4252041">,</span>&nbsp;<span class="ident" id="4252043">slice</span>&nbsp;<span class="op" id="4252049">:=</span>&nbsp;<span class="keyword" id="4252052">range</span>&nbsp;<span class="ident" id="4252058">slices</span>&nbsp;<span class="op" id="4252065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252069">hmd5</span><span class="op" id="4252073">.</span><span class="ident" id="4252074">Write</span><span class="op" id="4252079">(</span><span class="ident" id="4252080">slice</span><span class="op" id="4252085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4252091">copy</span><span class="op" id="4252095">(</span><span class="ident" id="4252096">md5sha1</span><span class="op" id="4252103">,</span>&nbsp;<span class="ident" id="4252105">hmd5</span><span class="op" id="4252109">.</span><span class="ident" id="4252110">Sum</span><span class="op" id="4252113">(</span><span class="ident" id="4252114">nil</span><span class="op" id="4252117">)</span><span class="op" id="4252118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4252121">copy</span><span class="op" id="4252125">(</span><span class="ident" id="4252126">md5sha1</span><span class="op" id="4252133">[</span><span class="ident" id="4252134">md5</span><span class="op" id="4252137">.</span><span class="ident" id="4252138">Size</span><span class="op" id="4252142">:</span><span class="op" id="4252143">]</span><span class="op" id="4252144">,</span>&nbsp;<span class="ident" id="4252146">sha1Hash</span><span class="op" id="4252154">(</span><span class="ident" id="4252155">slices</span><span class="op" id="4252161">)</span><span class="op" id="4252162">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252165">return</span>&nbsp;<span class="ident" id="4252172">md5sha1</span><br>
<span class="lineno"></span><span class="op" id="4252180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4252183">//&nbsp;sha256Hash&nbsp;implements&nbsp;TLS&nbsp;1.2&#39;s&nbsp;hash&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="4252233">func</span>&nbsp;<span class="ident" id="4252238">sha256Hash</span><span class="op" id="4252248">(</span><span class="ident" id="4252249">slices</span>&nbsp;<span class="op" id="4252256">[</span><span class="op" id="4252257">]</span><span class="op" id="4252258">[</span><span class="op" id="4252259">]</span><span class="builtintype" id="4252260">byte</span><span class="op" id="4252264">)</span>&nbsp;<span class="op" id="4252266">[</span><span class="op" id="4252267">]</span><span class="builtintype" id="4252268">byte</span>&nbsp;<span class="op" id="4252273">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252276">h</span>&nbsp;<span class="op" id="4252278">:=</span>&nbsp;<span class="ident" id="4252281">sha256</span><span class="op" id="4252287">.</span><span class="ident" id="4252288">New</span><span class="op" id="4252291">(</span><span class="op" id="4252292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252295">for</span>&nbsp;<span class="ident" id="4252299">_</span><span class="op" id="4252300">,</span>&nbsp;<span class="ident" id="4252302">slice</span>&nbsp;<span class="op" id="4252308">:=</span>&nbsp;<span class="keyword" id="4252311">range</span>&nbsp;<span class="ident" id="4252317">slices</span>&nbsp;<span class="op" id="4252324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252328">h</span><span class="op" id="4252329">.</span><span class="ident" id="4252330">Write</span><span class="op" id="4252335">(</span><span class="ident" id="4252336">slice</span><span class="op" id="4252341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252347">return</span>&nbsp;<span class="ident" id="4252354">h</span><span class="op" id="4252355">.</span><span class="ident" id="4252356">Sum</span><span class="op" id="4252359">(</span><span class="ident" id="4252360">nil</span><span class="op" id="4252363">)</span><br>
<span class="lineno">120</span><span class="op" id="4252365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4252368">//&nbsp;hashForServerKeyExchange&nbsp;hashes&nbsp;the&nbsp;given&nbsp;slices&nbsp;and&nbsp;returns&nbsp;their&nbsp;digest</span><br>
<span class="lineno"></span><span class="comment" id="4252445">//&nbsp;and&nbsp;the&nbsp;identifier&nbsp;of&nbsp;the&nbsp;hash&nbsp;function&nbsp;used.&nbsp;The&nbsp;hashFunc&nbsp;argument&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="4252524">//&nbsp;used&nbsp;for&nbsp;&gt;=&nbsp;TLS&nbsp;1.2&nbsp;and&nbsp;precisely&nbsp;identifies&nbsp;the&nbsp;hash&nbsp;function&nbsp;to&nbsp;use.</span><br>
<span class="lineno">125</span><span class="keyword" id="4252598">func</span>&nbsp;<span class="ident" id="4252603">hashForServerKeyExchange</span><span class="op" id="4252627">(</span><span class="ident" id="4252628">sigType</span><span class="op" id="4252635">,</span>&nbsp;<span class="ident" id="4252637">hashFunc</span>&nbsp;<span class="builtintype" id="4252646">uint8</span><span class="op" id="4252651">,</span>&nbsp;<span class="ident" id="4252653">version</span>&nbsp;<span class="builtintype" id="4252661">uint16</span><span class="op" id="4252667">,</span>&nbsp;<span class="ident" id="4252669">slices</span>&nbsp;<span class="op" id="4252676">...</span><span class="op" id="4252679">[</span><span class="op" id="4252680">]</span><span class="builtintype" id="4252681">byte</span><span class="op" id="4252685">)</span>&nbsp;<span class="op" id="4252687">(</span><span class="op" id="4252688">[</span><span class="op" id="4252689">]</span><span class="builtintype" id="4252690">byte</span><span class="op" id="4252694">,</span>&nbsp;<span class="ident" id="4252696">crypto</span><span class="op" id="4252702">.</span><span class="ident" id="4252703">Hash</span><span class="op" id="4252707">,</span>&nbsp;<span class="builtintype" id="4252709">error</span><span class="op" id="4252714">)</span>&nbsp;<span class="op" id="4252716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252719">if</span>&nbsp;<span class="ident" id="4252722">version</span>&nbsp;<span class="op" id="4252730">&gt;=</span>&nbsp;<span class="ident" id="4252733">VersionTLS12</span>&nbsp;<span class="op" id="4252746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252750">switch</span>&nbsp;<span class="ident" id="4252757">hashFunc</span>&nbsp;<span class="op" id="4252766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252770">case</span>&nbsp;<span class="ident" id="4252775">hashSHA256</span><span class="op" id="4252785">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252790">return</span>&nbsp;<span class="ident" id="4252797">sha256Hash</span><span class="op" id="4252807">(</span><span class="ident" id="4252808">slices</span><span class="op" id="4252814">)</span><span class="op" id="4252815">,</span>&nbsp;<span class="ident" id="4252817">crypto</span><span class="op" id="4252823">.</span><span class="ident" id="4252824">SHA256</span><span class="op" id="4252830">,</span>&nbsp;<span class="ident" id="4252832">nil</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252838">case</span>&nbsp;<span class="ident" id="4252843">hashSHA1</span><span class="op" id="4252851">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252856">return</span>&nbsp;<span class="ident" id="4252863">sha1Hash</span><span class="op" id="4252871">(</span><span class="ident" id="4252872">slices</span><span class="op" id="4252878">)</span><span class="op" id="4252879">,</span>&nbsp;<span class="ident" id="4252881">crypto</span><span class="op" id="4252887">.</span><span class="ident" id="4252888">SHA1</span><span class="op" id="4252892">,</span>&nbsp;<span class="ident" id="4252894">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252900">default</span><span class="op" id="4252907">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4252912">return</span>&nbsp;<span class="ident" id="4252919">nil</span><span class="op" id="4252922">,</span>&nbsp;<span class="ident" id="4252924">crypto</span><span class="op" id="4252930">.</span><span class="ident" id="4252931">Hash</span><span class="op" id="4252935">(</span><span class="num" id="4252936">0</span><span class="op" id="4252937">)</span><span class="op" id="4252938">,</span>&nbsp;<span class="ident" id="4252940">errors</span><span class="op" id="4252946">.</span><span class="ident" id="4252947">New</span><span class="op" id="4252950">(</span><span class="string" id="4252951">&#34;tls:&nbsp;unknown&nbsp;hash&nbsp;function&nbsp;used&nbsp;by&nbsp;peer&#34;</span><span class="op" id="4252992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252996">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253002">if</span>&nbsp;<span class="ident" id="4253005">sigType</span>&nbsp;<span class="op" id="4253013">==</span>&nbsp;<span class="ident" id="4253016">signatureECDSA</span>&nbsp;<span class="op" id="4253031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253035">return</span>&nbsp;<span class="ident" id="4253042">sha1Hash</span><span class="op" id="4253050">(</span><span class="ident" id="4253051">slices</span><span class="op" id="4253057">)</span><span class="op" id="4253058">,</span>&nbsp;<span class="ident" id="4253060">crypto</span><span class="op" id="4253066">.</span><span class="ident" id="4253067">SHA1</span><span class="op" id="4253071">,</span>&nbsp;<span class="ident" id="4253073">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4253078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253081">return</span>&nbsp;<span class="ident" id="4253088">md5SHA1Hash</span><span class="op" id="4253099">(</span><span class="ident" id="4253100">slices</span><span class="op" id="4253106">)</span><span class="op" id="4253107">,</span>&nbsp;<span class="ident" id="4253109">crypto</span><span class="op" id="4253115">.</span><span class="ident" id="4253116">MD5SHA1</span><span class="op" id="4253123">,</span>&nbsp;<span class="ident" id="4253125">nil</span><br>
<span class="lineno">140</span><span class="op" id="4253129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4253132">//&nbsp;pickTLS12HashForSignature&nbsp;returns&nbsp;a&nbsp;TLS&nbsp;1.2&nbsp;hash&nbsp;identifier&nbsp;for&nbsp;signing&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4253209">//&nbsp;ServerKeyExchange&nbsp;given&nbsp;the&nbsp;signature&nbsp;type&nbsp;being&nbsp;used&nbsp;and&nbsp;the&nbsp;client&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4253283">//&nbsp;advertised&nbsp;list&nbsp;of&nbsp;supported&nbsp;signature&nbsp;and&nbsp;hash&nbsp;combinations.</span><br>
<span class="lineno">145</span><span class="keyword" id="4253348">func</span>&nbsp;<span class="ident" id="4253353">pickTLS12HashForSignature</span><span class="op" id="4253378">(</span><span class="ident" id="4253379">sigType</span>&nbsp;<span class="builtintype" id="4253387">uint8</span><span class="op" id="4253392">,</span>&nbsp;<span class="ident" id="4253394">clientSignatureAndHashes</span>&nbsp;<span class="op" id="4253419">[</span><span class="op" id="4253420">]</span><span class="ident" id="4253421">signatureAndHash</span><span class="op" id="4253437">)</span>&nbsp;<span class="op" id="4253439">(</span><span class="builtintype" id="4253440">uint8</span><span class="op" id="4253445">,</span>&nbsp;<span class="builtintype" id="4253447">error</span><span class="op" id="4253452">)</span>&nbsp;<span class="op" id="4253454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253457">if</span>&nbsp;<span class="builtinfunc" id="4253460">len</span><span class="op" id="4253463">(</span><span class="ident" id="4253464">clientSignatureAndHashes</span><span class="op" id="4253488">)</span>&nbsp;<span class="op" id="4253490">==</span>&nbsp;<span class="num" id="4253493">0</span>&nbsp;<span class="op" id="4253495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253499">//&nbsp;If&nbsp;the&nbsp;client&nbsp;didn&#39;t&nbsp;specify&nbsp;any&nbsp;signature_algorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253558">//&nbsp;extension&nbsp;then&nbsp;we&nbsp;can&nbsp;assume&nbsp;that&nbsp;it&nbsp;supports&nbsp;SHA1.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253619">//&nbsp;http://tools.ietf.org/html/rfc5246#section-7.4.1.4.1</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253677">return</span>&nbsp;<span class="ident" id="4253684">hashSHA1</span><span class="op" id="4253692">,</span>&nbsp;<span class="ident" id="4253694">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4253699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253703">for</span>&nbsp;<span class="ident" id="4253707">_</span><span class="op" id="4253708">,</span>&nbsp;<span class="ident" id="4253710">sigAndHash</span>&nbsp;<span class="op" id="4253721">:=</span>&nbsp;<span class="keyword" id="4253724">range</span>&nbsp;<span class="ident" id="4253730">clientSignatureAndHashes</span>&nbsp;<span class="op" id="4253755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253759">if</span>&nbsp;<span class="ident" id="4253762">sigAndHash</span><span class="op" id="4253772">.</span><span class="ident" id="4253773">signature</span>&nbsp;<span class="op" id="4253783">!=</span>&nbsp;<span class="ident" id="4253786">sigType</span>&nbsp;<span class="op" id="4253794">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253799">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4253810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253814">switch</span>&nbsp;<span class="ident" id="4253821">sigAndHash</span><span class="op" id="4253831">.</span><span class="ident" id="4253832">hash</span>&nbsp;<span class="op" id="4253837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253841">case</span>&nbsp;<span class="ident" id="4253846">hashSHA1</span><span class="op" id="4253854">,</span>&nbsp;<span class="ident" id="4253856">hashSHA256</span><span class="op" id="4253866">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253871">return</span>&nbsp;<span class="ident" id="4253878">sigAndHash</span><span class="op" id="4253888">.</span><span class="ident" id="4253889">hash</span><span class="op" id="4253893">,</span>&nbsp;<span class="ident" id="4253895">nil</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4253901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4253904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4253908">return</span>&nbsp;<span class="num" id="4253915">0</span><span class="op" id="4253916">,</span>&nbsp;<span class="ident" id="4253918">errors</span><span class="op" id="4253924">.</span><span class="ident" id="4253925">New</span><span class="op" id="4253928">(</span><span class="string" id="4253929">&#34;tls:&nbsp;client&nbsp;doesn&#39;t&nbsp;support&nbsp;any&nbsp;common&nbsp;hash&nbsp;functions&#34;</span><span class="op" id="4253984">)</span><br>
<span class="lineno"></span><span class="op" id="4253986">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="4253989">func</span>&nbsp;<span class="ident" id="4253994">curveForCurveID</span><span class="op" id="4254009">(</span><span class="ident" id="4254010">id</span>&nbsp;<span class="ident" id="4254013">CurveID</span><span class="op" id="4254020">)</span>&nbsp;<span class="op" id="4254022">(</span><span class="ident" id="4254023">elliptic</span><span class="op" id="4254031">.</span><span class="ident" id="4254032">Curve</span><span class="op" id="4254037">,</span>&nbsp;<span class="builtintype" id="4254039">bool</span><span class="op" id="4254043">)</span>&nbsp;<span class="op" id="4254045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254048">switch</span>&nbsp;<span class="ident" id="4254055">id</span>&nbsp;<span class="op" id="4254058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254061">case</span>&nbsp;<span class="ident" id="4254066">CurveP256</span><span class="op" id="4254075">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254079">return</span>&nbsp;<span class="ident" id="4254086">elliptic</span><span class="op" id="4254094">.</span><span class="ident" id="4254095">P256</span><span class="op" id="4254099">(</span><span class="op" id="4254100">)</span><span class="op" id="4254101">,</span>&nbsp;<span class="builtintype" id="4254103">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254109">case</span>&nbsp;<span class="ident" id="4254114">CurveP384</span><span class="op" id="4254123">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254127">return</span>&nbsp;<span class="ident" id="4254134">elliptic</span><span class="op" id="4254142">.</span><span class="ident" id="4254143">P384</span><span class="op" id="4254147">(</span><span class="op" id="4254148">)</span><span class="op" id="4254149">,</span>&nbsp;<span class="builtintype" id="4254151">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254157">case</span>&nbsp;<span class="ident" id="4254162">CurveP521</span><span class="op" id="4254171">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254175">return</span>&nbsp;<span class="ident" id="4254182">elliptic</span><span class="op" id="4254190">.</span><span class="ident" id="4254191">P521</span><span class="op" id="4254195">(</span><span class="op" id="4254196">)</span><span class="op" id="4254197">,</span>&nbsp;<span class="builtintype" id="4254199">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254205">default</span><span class="op" id="4254212">:</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254216">return</span>&nbsp;<span class="ident" id="4254223">nil</span><span class="op" id="4254226">,</span>&nbsp;<span class="builtintype" id="4254228">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4254235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="4254238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="4254241">//&nbsp;ecdheRSAKeyAgreement&nbsp;implements&nbsp;a&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="4254313">//&nbsp;generates&nbsp;a&nbsp;ephemeral&nbsp;EC&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;and&nbsp;signs&nbsp;it.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="4254383">//&nbsp;pre-master&nbsp;secret&nbsp;is&nbsp;then&nbsp;calculated&nbsp;using&nbsp;ECDH.&nbsp;The&nbsp;signature&nbsp;may</span><br>
<span class="lineno"></span><span class="comment" id="4254453">//&nbsp;either&nbsp;be&nbsp;ECDSA&nbsp;or&nbsp;RSA.</span><br>
<span class="lineno"></span><span class="keyword" id="4254480">type</span>&nbsp;<span class="ident" id="4254485">ecdheKeyAgreement</span>&nbsp;<span class="keyword" id="4254503">struct</span>&nbsp;<span class="op" id="4254510">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254513">version</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4254524">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254532">sigType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4254543">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254550">privateKey</span>&nbsp;<span class="op" id="4254561">[</span><span class="op" id="4254562">]</span><span class="builtintype" id="4254563">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254569">curve</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4254580">elliptic</span><span class="op" id="4254588">.</span><span class="ident" id="4254589">Curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254596">x</span><span class="op" id="4254597">,</span>&nbsp;<span class="ident" id="4254599">y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4254607">*</span><span class="ident" id="4254608">big</span><span class="op" id="4254611">.</span><span class="ident" id="4254612">Int</span><br>
<span class="lineno">190</span><span class="op" id="4254616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4254619">func</span>&nbsp;<span class="op" id="4254624">(</span><span class="ident" id="4254625">ka</span>&nbsp;<span class="op" id="4254628">*</span><span class="ident" id="4254629">ecdheKeyAgreement</span><span class="op" id="4254646">)</span>&nbsp;<span class="ident" id="4254648">generateServerKeyExchange</span><span class="op" id="4254673">(</span><span class="ident" id="4254674">config</span>&nbsp;<span class="op" id="4254681">*</span><span class="ident" id="4254682">Config</span><span class="op" id="4254688">,</span>&nbsp;<span class="ident" id="4254690">cert</span>&nbsp;<span class="op" id="4254695">*</span><span class="ident" id="4254696">Certificate</span><span class="op" id="4254707">,</span>&nbsp;<span class="ident" id="4254709">clientHello</span>&nbsp;<span class="op" id="4254721">*</span><span class="ident" id="4254722">clientHelloMsg</span><span class="op" id="4254736">,</span>&nbsp;<span class="ident" id="4254738">hello</span>&nbsp;<span class="op" id="4254744">*</span><span class="ident" id="4254745">serverHelloMsg</span><span class="op" id="4254759">)</span>&nbsp;<span class="op" id="4254761">(</span><span class="op" id="4254762">*</span><span class="ident" id="4254763">serverKeyExchangeMsg</span><span class="op" id="4254783">,</span>&nbsp;<span class="builtintype" id="4254785">error</span><span class="op" id="4254790">)</span>&nbsp;<span class="op" id="4254792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254795">var</span>&nbsp;<span class="ident" id="4254799">curveid</span>&nbsp;<span class="ident" id="4254807">CurveID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254816">preferredCurves</span>&nbsp;<span class="op" id="4254832">:=</span>&nbsp;<span class="ident" id="4254835">config</span><span class="op" id="4254841">.</span><span class="ident" id="4254842">curvePreferences</span><span class="op" id="4254858">(</span><span class="op" id="4254859">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="ident" id="4254862">NextCandidate</span><span class="op" id="4254875">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254878">for</span>&nbsp;<span class="ident" id="4254882">_</span><span class="op" id="4254883">,</span>&nbsp;<span class="ident" id="4254885">candidate</span>&nbsp;<span class="op" id="4254895">:=</span>&nbsp;<span class="keyword" id="4254898">range</span>&nbsp;<span class="ident" id="4254904">preferredCurves</span>&nbsp;<span class="op" id="4254920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254924">for</span>&nbsp;<span class="ident" id="4254928">_</span><span class="op" id="4254929">,</span>&nbsp;<span class="ident" id="4254931">c</span>&nbsp;<span class="op" id="4254933">:=</span>&nbsp;<span class="keyword" id="4254936">range</span>&nbsp;<span class="ident" id="4254942">clientHello</span><span class="op" id="4254953">.</span><span class="ident" id="4254954">supportedCurves</span>&nbsp;<span class="op" id="4254970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254975">if</span>&nbsp;<span class="ident" id="4254978">candidate</span>&nbsp;<span class="op" id="4254988">==</span>&nbsp;<span class="ident" id="4254991">c</span>&nbsp;<span class="op" id="4254993">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254999">curveid</span>&nbsp;<span class="op" id="4255007">=</span>&nbsp;<span class="ident" id="4255009">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255015">break</span>&nbsp;<span class="ident" id="4255021">NextCandidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255045">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255049">if</span>&nbsp;<span class="ident" id="4255052">curveid</span>&nbsp;<span class="op" id="4255060">==</span>&nbsp;<span class="num" id="4255063">0</span>&nbsp;<span class="op" id="4255065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255069">return</span>&nbsp;<span class="ident" id="4255076">nil</span><span class="op" id="4255079">,</span>&nbsp;<span class="ident" id="4255081">errors</span><span class="op" id="4255087">.</span><span class="ident" id="4255088">New</span><span class="op" id="4255091">(</span><span class="string" id="4255092">&#34;tls:&nbsp;no&nbsp;supported&nbsp;elliptic&nbsp;curves&nbsp;offered&#34;</span><span class="op" id="4255135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255142">var</span>&nbsp;<span class="ident" id="4255146">ok</span>&nbsp;<span class="builtintype" id="4255149">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255155">if</span>&nbsp;<span class="ident" id="4255158">ka</span><span class="op" id="4255160">.</span><span class="ident" id="4255161">curve</span><span class="op" id="4255166">,</span>&nbsp;<span class="ident" id="4255168">ok</span>&nbsp;<span class="op" id="4255171">=</span>&nbsp;<span class="ident" id="4255173">curveForCurveID</span><span class="op" id="4255188">(</span><span class="ident" id="4255189">curveid</span><span class="op" id="4255196">)</span><span class="op" id="4255197">;</span>&nbsp;<span class="op" id="4255199">!</span><span class="ident" id="4255200">ok</span>&nbsp;<span class="op" id="4255203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255207">return</span>&nbsp;<span class="ident" id="4255214">nil</span><span class="op" id="4255217">,</span>&nbsp;<span class="ident" id="4255219">errors</span><span class="op" id="4255225">.</span><span class="ident" id="4255226">New</span><span class="op" id="4255229">(</span><span class="string" id="4255230">&#34;tls:&nbsp;preferredCurves&nbsp;includes&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4255279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255286">var</span>&nbsp;<span class="ident" id="4255290">x</span><span class="op" id="4255291">,</span>&nbsp;<span class="ident" id="4255293">y</span>&nbsp;<span class="op" id="4255295">*</span><span class="ident" id="4255296">big</span><span class="op" id="4255299">.</span><span class="ident" id="4255300">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255305">var</span>&nbsp;<span class="ident" id="4255309">err</span>&nbsp;<span class="builtintype" id="4255313">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255320">ka</span><span class="op" id="4255322">.</span><span class="ident" id="4255323">privateKey</span><span class="op" id="4255333">,</span>&nbsp;<span class="ident" id="4255335">x</span><span class="op" id="4255336">,</span>&nbsp;<span class="ident" id="4255338">y</span><span class="op" id="4255339">,</span>&nbsp;<span class="ident" id="4255341">err</span>&nbsp;<span class="op" id="4255345">=</span>&nbsp;<span class="ident" id="4255347">elliptic</span><span class="op" id="4255355">.</span><span class="ident" id="4255356">GenerateKey</span><span class="op" id="4255367">(</span><span class="ident" id="4255368">ka</span><span class="op" id="4255370">.</span><span class="ident" id="4255371">curve</span><span class="op" id="4255376">,</span>&nbsp;<span class="ident" id="4255378">config</span><span class="op" id="4255384">.</span><span class="ident" id="4255385">rand</span><span class="op" id="4255389">(</span><span class="op" id="4255390">)</span><span class="op" id="4255391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255394">if</span>&nbsp;<span class="ident" id="4255397">err</span>&nbsp;<span class="op" id="4255401">!=</span>&nbsp;<span class="ident" id="4255404">nil</span>&nbsp;<span class="op" id="4255408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255412">return</span>&nbsp;<span class="ident" id="4255419">nil</span><span class="op" id="4255422">,</span>&nbsp;<span class="ident" id="4255424">err</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255432">ecdhePublic</span>&nbsp;<span class="op" id="4255444">:=</span>&nbsp;<span class="ident" id="4255447">elliptic</span><span class="op" id="4255455">.</span><span class="ident" id="4255456">Marshal</span><span class="op" id="4255463">(</span><span class="ident" id="4255464">ka</span><span class="op" id="4255466">.</span><span class="ident" id="4255467">curve</span><span class="op" id="4255472">,</span>&nbsp;<span class="ident" id="4255474">x</span><span class="op" id="4255475">,</span>&nbsp;<span class="ident" id="4255477">y</span><span class="op" id="4255478">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4255482">//&nbsp;http://tools.ietf.org/html/rfc4492#section-5.4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255533">serverECDHParams</span>&nbsp;<span class="op" id="4255550">:=</span>&nbsp;<span class="builtinfunc" id="4255553">make</span><span class="op" id="4255557">(</span><span class="op" id="4255558">[</span><span class="op" id="4255559">]</span><span class="builtintype" id="4255560">byte</span><span class="op" id="4255564">,</span>&nbsp;<span class="num" id="4255566">1</span><span class="op" id="4255567">+</span><span class="num" id="4255568">2</span><span class="op" id="4255569">+</span><span class="num" id="4255570">1</span><span class="op" id="4255571">+</span><span class="builtinfunc" id="4255572">len</span><span class="op" id="4255575">(</span><span class="ident" id="4255576">ecdhePublic</span><span class="op" id="4255587">)</span><span class="op" id="4255588">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255591">serverECDHParams</span><span class="op" id="4255607">[</span><span class="num" id="4255608">0</span><span class="op" id="4255609">]</span>&nbsp;<span class="op" id="4255611">=</span>&nbsp;<span class="num" id="4255613">3</span>&nbsp;<span class="comment" id="4255615">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255631">serverECDHParams</span><span class="op" id="4255647">[</span><span class="num" id="4255648">1</span><span class="op" id="4255649">]</span>&nbsp;<span class="op" id="4255651">=</span>&nbsp;<span class="builtintype" id="4255653">byte</span><span class="op" id="4255657">(</span><span class="ident" id="4255658">curveid</span>&nbsp;<span class="op" id="4255666">&gt;&gt;</span>&nbsp;<span class="num" id="4255669">8</span><span class="op" id="4255670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255673">serverECDHParams</span><span class="op" id="4255689">[</span><span class="num" id="4255690">2</span><span class="op" id="4255691">]</span>&nbsp;<span class="op" id="4255693">=</span>&nbsp;<span class="builtintype" id="4255695">byte</span><span class="op" id="4255699">(</span><span class="ident" id="4255700">curveid</span><span class="op" id="4255707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255710">serverECDHParams</span><span class="op" id="4255726">[</span><span class="num" id="4255727">3</span><span class="op" id="4255728">]</span>&nbsp;<span class="op" id="4255730">=</span>&nbsp;<span class="builtintype" id="4255732">byte</span><span class="op" id="4255736">(</span><span class="builtinfunc" id="4255737">len</span><span class="op" id="4255740">(</span><span class="ident" id="4255741">ecdhePublic</span><span class="op" id="4255752">)</span><span class="op" id="4255753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4255756">copy</span><span class="op" id="4255760">(</span><span class="ident" id="4255761">serverECDHParams</span><span class="op" id="4255777">[</span><span class="num" id="4255778">4</span><span class="op" id="4255779">:</span><span class="op" id="4255780">]</span><span class="op" id="4255781">,</span>&nbsp;<span class="ident" id="4255783">ecdhePublic</span><span class="op" id="4255794">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255798">var</span>&nbsp;<span class="ident" id="4255802">tls12HashId</span>&nbsp;<span class="builtintype" id="4255814">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255821">if</span>&nbsp;<span class="ident" id="4255824">ka</span><span class="op" id="4255826">.</span><span class="ident" id="4255827">version</span>&nbsp;<span class="op" id="4255835">&gt;=</span>&nbsp;<span class="ident" id="4255838">VersionTLS12</span>&nbsp;<span class="op" id="4255851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255855">if</span>&nbsp;<span class="ident" id="4255858">tls12HashId</span><span class="op" id="4255869">,</span>&nbsp;<span class="ident" id="4255871">err</span>&nbsp;<span class="op" id="4255875">=</span>&nbsp;<span class="ident" id="4255877">pickTLS12HashForSignature</span><span class="op" id="4255902">(</span><span class="ident" id="4255903">ka</span><span class="op" id="4255905">.</span><span class="ident" id="4255906">sigType</span><span class="op" id="4255913">,</span>&nbsp;<span class="ident" id="4255915">clientHello</span><span class="op" id="4255926">.</span><span class="ident" id="4255927">signatureAndHashes</span><span class="op" id="4255945">)</span><span class="op" id="4255946">;</span>&nbsp;<span class="ident" id="4255948">err</span>&nbsp;<span class="op" id="4255952">!=</span>&nbsp;<span class="ident" id="4255955">nil</span>&nbsp;<span class="op" id="4255959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255964">return</span>&nbsp;<span class="ident" id="4255971">nil</span><span class="op" id="4255974">,</span>&nbsp;<span class="ident" id="4255976">err</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255989">digest</span><span class="op" id="4255995">,</span>&nbsp;<span class="ident" id="4255997">hashFunc</span><span class="op" id="4256005">,</span>&nbsp;<span class="ident" id="4256007">err</span>&nbsp;<span class="op" id="4256011">:=</span>&nbsp;<span class="ident" id="4256014">hashForServerKeyExchange</span><span class="op" id="4256038">(</span><span class="ident" id="4256039">ka</span><span class="op" id="4256041">.</span><span class="ident" id="4256042">sigType</span><span class="op" id="4256049">,</span>&nbsp;<span class="ident" id="4256051">tls12HashId</span><span class="op" id="4256062">,</span>&nbsp;<span class="ident" id="4256064">ka</span><span class="op" id="4256066">.</span><span class="ident" id="4256067">version</span><span class="op" id="4256074">,</span>&nbsp;<span class="ident" id="4256076">clientHello</span><span class="op" id="4256087">.</span><span class="ident" id="4256088">random</span><span class="op" id="4256094">,</span>&nbsp;<span class="ident" id="4256096">hello</span><span class="op" id="4256101">.</span><span class="ident" id="4256102">random</span><span class="op" id="4256108">,</span>&nbsp;<span class="ident" id="4256110">serverECDHParams</span><span class="op" id="4256126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256129">if</span>&nbsp;<span class="ident" id="4256132">err</span>&nbsp;<span class="op" id="4256136">!=</span>&nbsp;<span class="ident" id="4256139">nil</span>&nbsp;<span class="op" id="4256143">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256147">return</span>&nbsp;<span class="ident" id="4256154">nil</span><span class="op" id="4256157">,</span>&nbsp;<span class="ident" id="4256159">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256167">var</span>&nbsp;<span class="ident" id="4256171">sig</span>&nbsp;<span class="op" id="4256175">[</span><span class="op" id="4256176">]</span><span class="builtintype" id="4256177">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256183">switch</span>&nbsp;<span class="ident" id="4256190">ka</span><span class="op" id="4256192">.</span><span class="ident" id="4256193">sigType</span>&nbsp;<span class="op" id="4256201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256204">case</span>&nbsp;<span class="ident" id="4256209">signatureECDSA</span><span class="op" id="4256223">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256227">privKey</span><span class="op" id="4256234">,</span>&nbsp;<span class="ident" id="4256236">ok</span>&nbsp;<span class="op" id="4256239">:=</span>&nbsp;<span class="ident" id="4256242">cert</span><span class="op" id="4256246">.</span><span class="ident" id="4256247">PrivateKey</span><span class="op" id="4256257">.</span><span class="op" id="4256258">(</span><span class="op" id="4256259">*</span><span class="ident" id="4256260">ecdsa</span><span class="op" id="4256265">.</span><span class="ident" id="4256266">PrivateKey</span><span class="op" id="4256276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256280">if</span>&nbsp;<span class="op" id="4256283">!</span><span class="ident" id="4256284">ok</span>&nbsp;<span class="op" id="4256287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256292">return</span>&nbsp;<span class="ident" id="4256299">nil</span><span class="op" id="4256302">,</span>&nbsp;<span class="ident" id="4256304">errors</span><span class="op" id="4256310">.</span><span class="ident" id="4256311">New</span><span class="op" id="4256314">(</span><span class="string" id="4256315">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;an&nbsp;ECDSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="4256365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256373">r</span><span class="op" id="4256374">,</span>&nbsp;<span class="ident" id="4256376">s</span><span class="op" id="4256377">,</span>&nbsp;<span class="ident" id="4256379">err</span>&nbsp;<span class="op" id="4256383">:=</span>&nbsp;<span class="ident" id="4256386">ecdsa</span><span class="op" id="4256391">.</span><span class="ident" id="4256392">Sign</span><span class="op" id="4256396">(</span><span class="ident" id="4256397">config</span><span class="op" id="4256403">.</span><span class="ident" id="4256404">rand</span><span class="op" id="4256408">(</span><span class="op" id="4256409">)</span><span class="op" id="4256410">,</span>&nbsp;<span class="ident" id="4256412">privKey</span><span class="op" id="4256419">,</span>&nbsp;<span class="ident" id="4256421">digest</span><span class="op" id="4256427">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256431">if</span>&nbsp;<span class="ident" id="4256434">err</span>&nbsp;<span class="op" id="4256438">!=</span>&nbsp;<span class="ident" id="4256441">nil</span>&nbsp;<span class="op" id="4256445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256450">return</span>&nbsp;<span class="ident" id="4256457">nil</span><span class="op" id="4256460">,</span>&nbsp;<span class="ident" id="4256462">errors</span><span class="op" id="4256468">.</span><span class="ident" id="4256469">New</span><span class="op" id="4256472">(</span><span class="string" id="4256473">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="4256509">+</span>&nbsp;<span class="ident" id="4256511">err</span><span class="op" id="4256514">.</span><span class="ident" id="4256515">Error</span><span class="op" id="4256520">(</span><span class="op" id="4256521">)</span><span class="op" id="4256522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256530">sig</span><span class="op" id="4256533">,</span>&nbsp;<span class="ident" id="4256535">err</span>&nbsp;<span class="op" id="4256539">=</span>&nbsp;<span class="ident" id="4256541">asn1</span><span class="op" id="4256545">.</span><span class="ident" id="4256546">Marshal</span><span class="op" id="4256553">(</span><span class="ident" id="4256554">ecdsaSignature</span><span class="op" id="4256568">{</span><span class="ident" id="4256569">r</span><span class="op" id="4256570">,</span>&nbsp;<span class="ident" id="4256572">s</span><span class="op" id="4256573">}</span><span class="op" id="4256574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256577">case</span>&nbsp;<span class="ident" id="4256582">signatureRSA</span><span class="op" id="4256594">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256598">privKey</span><span class="op" id="4256605">,</span>&nbsp;<span class="ident" id="4256607">ok</span>&nbsp;<span class="op" id="4256610">:=</span>&nbsp;<span class="ident" id="4256613">cert</span><span class="op" id="4256617">.</span><span class="ident" id="4256618">PrivateKey</span><span class="op" id="4256628">.</span><span class="op" id="4256629">(</span><span class="op" id="4256630">*</span><span class="ident" id="4256631">rsa</span><span class="op" id="4256634">.</span><span class="ident" id="4256635">PrivateKey</span><span class="op" id="4256645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256649">if</span>&nbsp;<span class="op" id="4256652">!</span><span class="ident" id="4256653">ok</span>&nbsp;<span class="op" id="4256656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256661">return</span>&nbsp;<span class="ident" id="4256668">nil</span><span class="op" id="4256671">,</span>&nbsp;<span class="ident" id="4256673">errors</span><span class="op" id="4256679">.</span><span class="ident" id="4256680">New</span><span class="op" id="4256683">(</span><span class="string" id="4256684">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="4256729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256737">sig</span><span class="op" id="4256740">,</span>&nbsp;<span class="ident" id="4256742">err</span>&nbsp;<span class="op" id="4256746">=</span>&nbsp;<span class="ident" id="4256748">rsa</span><span class="op" id="4256751">.</span><span class="ident" id="4256752">SignPKCS1v15</span><span class="op" id="4256764">(</span><span class="ident" id="4256765">config</span><span class="op" id="4256771">.</span><span class="ident" id="4256772">rand</span><span class="op" id="4256776">(</span><span class="op" id="4256777">)</span><span class="op" id="4256778">,</span>&nbsp;<span class="ident" id="4256780">privKey</span><span class="op" id="4256787">,</span>&nbsp;<span class="ident" id="4256789">hashFunc</span><span class="op" id="4256797">,</span>&nbsp;<span class="ident" id="4256799">digest</span><span class="op" id="4256805">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256809">if</span>&nbsp;<span class="ident" id="4256812">err</span>&nbsp;<span class="op" id="4256816">!=</span>&nbsp;<span class="ident" id="4256819">nil</span>&nbsp;<span class="op" id="4256823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256828">return</span>&nbsp;<span class="ident" id="4256835">nil</span><span class="op" id="4256838">,</span>&nbsp;<span class="ident" id="4256840">errors</span><span class="op" id="4256846">.</span><span class="ident" id="4256847">New</span><span class="op" id="4256850">(</span><span class="string" id="4256851">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="4256887">+</span>&nbsp;<span class="ident" id="4256889">err</span><span class="op" id="4256892">.</span><span class="ident" id="4256893">Error</span><span class="op" id="4256898">(</span><span class="op" id="4256899">)</span><span class="op" id="4256900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256907">default</span><span class="op" id="4256914">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256918">return</span>&nbsp;<span class="ident" id="4256925">nil</span><span class="op" id="4256928">,</span>&nbsp;<span class="ident" id="4256930">errors</span><span class="op" id="4256936">.</span><span class="ident" id="4256937">New</span><span class="op" id="4256940">(</span><span class="string" id="4256941">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="4256976">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256983">skx</span>&nbsp;<span class="op" id="4256987">:=</span>&nbsp;<span class="builtinfunc" id="4256990">new</span><span class="op" id="4256993">(</span><span class="ident" id="4256994">serverKeyExchangeMsg</span><span class="op" id="4257014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257017">sigAndHashLen</span>&nbsp;<span class="op" id="4257031">:=</span>&nbsp;<span class="num" id="4257034">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257037">if</span>&nbsp;<span class="ident" id="4257040">ka</span><span class="op" id="4257042">.</span><span class="ident" id="4257043">version</span>&nbsp;<span class="op" id="4257051">&gt;=</span>&nbsp;<span class="ident" id="4257054">VersionTLS12</span>&nbsp;<span class="op" id="4257067">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257071">sigAndHashLen</span>&nbsp;<span class="op" id="4257085">=</span>&nbsp;<span class="num" id="4257087">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257093">skx</span><span class="op" id="4257096">.</span><span class="ident" id="4257097">key</span>&nbsp;<span class="op" id="4257101">=</span>&nbsp;<span class="builtinfunc" id="4257103">make</span><span class="op" id="4257107">(</span><span class="op" id="4257108">[</span><span class="op" id="4257109">]</span><span class="builtintype" id="4257110">byte</span><span class="op" id="4257114">,</span>&nbsp;<span class="builtinfunc" id="4257116">len</span><span class="op" id="4257119">(</span><span class="ident" id="4257120">serverECDHParams</span><span class="op" id="4257136">)</span><span class="op" id="4257137">+</span><span class="ident" id="4257138">sigAndHashLen</span><span class="op" id="4257151">+</span><span class="num" id="4257152">2</span><span class="op" id="4257153">+</span><span class="builtinfunc" id="4257154">len</span><span class="op" id="4257157">(</span><span class="ident" id="4257158">sig</span><span class="op" id="4257161">)</span><span class="op" id="4257162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4257165">copy</span><span class="op" id="4257169">(</span><span class="ident" id="4257170">skx</span><span class="op" id="4257173">.</span><span class="ident" id="4257174">key</span><span class="op" id="4257177">,</span>&nbsp;<span class="ident" id="4257179">serverECDHParams</span><span class="op" id="4257195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257198">k</span>&nbsp;<span class="op" id="4257200">:=</span>&nbsp;<span class="ident" id="4257203">skx</span><span class="op" id="4257206">.</span><span class="ident" id="4257207">key</span><span class="op" id="4257210">[</span><span class="builtinfunc" id="4257211">len</span><span class="op" id="4257214">(</span><span class="ident" id="4257215">serverECDHParams</span><span class="op" id="4257231">)</span><span class="op" id="4257232">:</span><span class="op" id="4257233">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257236">if</span>&nbsp;<span class="ident" id="4257239">ka</span><span class="op" id="4257241">.</span><span class="ident" id="4257242">version</span>&nbsp;<span class="op" id="4257250">&gt;=</span>&nbsp;<span class="ident" id="4257253">VersionTLS12</span>&nbsp;<span class="op" id="4257266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257270">k</span><span class="op" id="4257271">[</span><span class="num" id="4257272">0</span><span class="op" id="4257273">]</span>&nbsp;<span class="op" id="4257275">=</span>&nbsp;<span class="ident" id="4257277">tls12HashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257291">k</span><span class="op" id="4257292">[</span><span class="num" id="4257293">1</span><span class="op" id="4257294">]</span>&nbsp;<span class="op" id="4257296">=</span>&nbsp;<span class="ident" id="4257298">ka</span><span class="op" id="4257300">.</span><span class="ident" id="4257301">sigType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257311">k</span>&nbsp;<span class="op" id="4257313">=</span>&nbsp;<span class="ident" id="4257315">k</span><span class="op" id="4257316">[</span><span class="num" id="4257317">2</span><span class="op" id="4257318">:</span><span class="op" id="4257319">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257322">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257325">k</span><span class="op" id="4257326">[</span><span class="num" id="4257327">0</span><span class="op" id="4257328">]</span>&nbsp;<span class="op" id="4257330">=</span>&nbsp;<span class="builtintype" id="4257332">byte</span><span class="op" id="4257336">(</span><span class="builtinfunc" id="4257337">len</span><span class="op" id="4257340">(</span><span class="ident" id="4257341">sig</span><span class="op" id="4257344">)</span>&nbsp;<span class="op" id="4257346">&gt;&gt;</span>&nbsp;<span class="num" id="4257349">8</span><span class="op" id="4257350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257353">k</span><span class="op" id="4257354">[</span><span class="num" id="4257355">1</span><span class="op" id="4257356">]</span>&nbsp;<span class="op" id="4257358">=</span>&nbsp;<span class="builtintype" id="4257360">byte</span><span class="op" id="4257364">(</span><span class="builtinfunc" id="4257365">len</span><span class="op" id="4257368">(</span><span class="ident" id="4257369">sig</span><span class="op" id="4257372">)</span><span class="op" id="4257373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4257376">copy</span><span class="op" id="4257380">(</span><span class="ident" id="4257381">k</span><span class="op" id="4257382">[</span><span class="num" id="4257383">2</span><span class="op" id="4257384">:</span><span class="op" id="4257385">]</span><span class="op" id="4257386">,</span>&nbsp;<span class="ident" id="4257388">sig</span><span class="op" id="4257391">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257395">return</span>&nbsp;<span class="ident" id="4257402">skx</span><span class="op" id="4257405">,</span>&nbsp;<span class="ident" id="4257407">nil</span><br>
<span class="lineno">285</span><span class="op" id="4257411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4257414">func</span>&nbsp;<span class="op" id="4257419">(</span><span class="ident" id="4257420">ka</span>&nbsp;<span class="op" id="4257423">*</span><span class="ident" id="4257424">ecdheKeyAgreement</span><span class="op" id="4257441">)</span>&nbsp;<span class="ident" id="4257443">processClientKeyExchange</span><span class="op" id="4257467">(</span><span class="ident" id="4257468">config</span>&nbsp;<span class="op" id="4257475">*</span><span class="ident" id="4257476">Config</span><span class="op" id="4257482">,</span>&nbsp;<span class="ident" id="4257484">cert</span>&nbsp;<span class="op" id="4257489">*</span><span class="ident" id="4257490">Certificate</span><span class="op" id="4257501">,</span>&nbsp;<span class="ident" id="4257503">ckx</span>&nbsp;<span class="op" id="4257507">*</span><span class="ident" id="4257508">clientKeyExchangeMsg</span><span class="op" id="4257528">,</span>&nbsp;<span class="ident" id="4257530">version</span>&nbsp;<span class="builtintype" id="4257538">uint16</span><span class="op" id="4257544">)</span>&nbsp;<span class="op" id="4257546">(</span><span class="op" id="4257547">[</span><span class="op" id="4257548">]</span><span class="builtintype" id="4257549">byte</span><span class="op" id="4257553">,</span>&nbsp;<span class="builtintype" id="4257555">error</span><span class="op" id="4257560">)</span>&nbsp;<span class="op" id="4257562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257565">if</span>&nbsp;<span class="builtinfunc" id="4257568">len</span><span class="op" id="4257571">(</span><span class="ident" id="4257572">ckx</span><span class="op" id="4257575">.</span><span class="ident" id="4257576">ciphertext</span><span class="op" id="4257586">)</span>&nbsp;<span class="op" id="4257588">==</span>&nbsp;<span class="num" id="4257591">0</span>&nbsp;<span class="op" id="4257593">||</span>&nbsp;<span class="builtintype" id="4257596">int</span><span class="op" id="4257599">(</span><span class="ident" id="4257600">ckx</span><span class="op" id="4257603">.</span><span class="ident" id="4257604">ciphertext</span><span class="op" id="4257614">[</span><span class="num" id="4257615">0</span><span class="op" id="4257616">]</span><span class="op" id="4257617">)</span>&nbsp;<span class="op" id="4257619">!=</span>&nbsp;<span class="builtinfunc" id="4257622">len</span><span class="op" id="4257625">(</span><span class="ident" id="4257626">ckx</span><span class="op" id="4257629">.</span><span class="ident" id="4257630">ciphertext</span><span class="op" id="4257640">)</span><span class="op" id="4257641">-</span><span class="num" id="4257642">1</span>&nbsp;<span class="op" id="4257644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257648">return</span>&nbsp;<span class="ident" id="4257655">nil</span><span class="op" id="4257658">,</span>&nbsp;<span class="ident" id="4257660">errClientKeyExchange</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257685">x</span><span class="op" id="4257686">,</span>&nbsp;<span class="ident" id="4257688">y</span>&nbsp;<span class="op" id="4257690">:=</span>&nbsp;<span class="ident" id="4257693">elliptic</span><span class="op" id="4257701">.</span><span class="ident" id="4257702">Unmarshal</span><span class="op" id="4257711">(</span><span class="ident" id="4257712">ka</span><span class="op" id="4257714">.</span><span class="ident" id="4257715">curve</span><span class="op" id="4257720">,</span>&nbsp;<span class="ident" id="4257722">ckx</span><span class="op" id="4257725">.</span><span class="ident" id="4257726">ciphertext</span><span class="op" id="4257736">[</span><span class="num" id="4257737">1</span><span class="op" id="4257738">:</span><span class="op" id="4257739">]</span><span class="op" id="4257740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257743">if</span>&nbsp;<span class="ident" id="4257746">x</span>&nbsp;<span class="op" id="4257748">==</span>&nbsp;<span class="ident" id="4257751">nil</span>&nbsp;<span class="op" id="4257755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257759">return</span>&nbsp;<span class="ident" id="4257766">nil</span><span class="op" id="4257769">,</span>&nbsp;<span class="ident" id="4257771">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257793">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257796">if</span>&nbsp;<span class="op" id="4257799">!</span><span class="ident" id="4257800">ka</span><span class="op" id="4257802">.</span><span class="ident" id="4257803">curve</span><span class="op" id="4257808">.</span><span class="ident" id="4257809">IsOnCurve</span><span class="op" id="4257818">(</span><span class="ident" id="4257819">x</span><span class="op" id="4257820">,</span>&nbsp;<span class="ident" id="4257822">y</span><span class="op" id="4257823">)</span>&nbsp;<span class="op" id="4257825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257829">return</span>&nbsp;<span class="ident" id="4257836">nil</span><span class="op" id="4257839">,</span>&nbsp;<span class="ident" id="4257841">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257866">x</span><span class="op" id="4257867">,</span>&nbsp;<span class="ident" id="4257869">_</span>&nbsp;<span class="op" id="4257871">=</span>&nbsp;<span class="ident" id="4257873">ka</span><span class="op" id="4257875">.</span><span class="ident" id="4257876">curve</span><span class="op" id="4257881">.</span><span class="ident" id="4257882">ScalarMult</span><span class="op" id="4257892">(</span><span class="ident" id="4257893">x</span><span class="op" id="4257894">,</span>&nbsp;<span class="ident" id="4257896">y</span><span class="op" id="4257897">,</span>&nbsp;<span class="ident" id="4257899">ka</span><span class="op" id="4257901">.</span><span class="ident" id="4257902">privateKey</span><span class="op" id="4257912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257915">preMasterSecret</span>&nbsp;<span class="op" id="4257931">:=</span>&nbsp;<span class="builtinfunc" id="4257934">make</span><span class="op" id="4257938">(</span><span class="op" id="4257939">[</span><span class="op" id="4257940">]</span><span class="builtintype" id="4257941">byte</span><span class="op" id="4257945">,</span>&nbsp;<span class="op" id="4257947">(</span><span class="ident" id="4257948">ka</span><span class="op" id="4257950">.</span><span class="ident" id="4257951">curve</span><span class="op" id="4257956">.</span><span class="ident" id="4257957">Params</span><span class="op" id="4257963">(</span><span class="op" id="4257964">)</span><span class="op" id="4257965">.</span><span class="ident" id="4257966">BitSize</span><span class="op" id="4257973">+</span><span class="num" id="4257974">7</span><span class="op" id="4257975">)</span><span class="op" id="4257976">&gt;&gt;</span><span class="num" id="4257978">3</span><span class="op" id="4257979">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257982">xBytes</span>&nbsp;<span class="op" id="4257989">:=</span>&nbsp;<span class="ident" id="4257992">x</span><span class="op" id="4257993">.</span><span class="ident" id="4257994">Bytes</span><span class="op" id="4257999">(</span><span class="op" id="4258000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4258003">copy</span><span class="op" id="4258007">(</span><span class="ident" id="4258008">preMasterSecret</span><span class="op" id="4258023">[</span><span class="builtinfunc" id="4258024">len</span><span class="op" id="4258027">(</span><span class="ident" id="4258028">preMasterSecret</span><span class="op" id="4258043">)</span><span class="op" id="4258044">-</span><span class="builtinfunc" id="4258045">len</span><span class="op" id="4258048">(</span><span class="ident" id="4258049">xBytes</span><span class="op" id="4258055">)</span><span class="op" id="4258056">:</span><span class="op" id="4258057">]</span><span class="op" id="4258058">,</span>&nbsp;<span class="ident" id="4258060">xBytes</span><span class="op" id="4258066">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258070">return</span>&nbsp;<span class="ident" id="4258077">preMasterSecret</span><span class="op" id="4258092">,</span>&nbsp;<span class="ident" id="4258094">nil</span><br>
<span class="lineno"></span><span class="op" id="4258098">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="4258101">func</span>&nbsp;<span class="op" id="4258106">(</span><span class="ident" id="4258107">ka</span>&nbsp;<span class="op" id="4258110">*</span><span class="ident" id="4258111">ecdheKeyAgreement</span><span class="op" id="4258128">)</span>&nbsp;<span class="ident" id="4258130">processServerKeyExchange</span><span class="op" id="4258154">(</span><span class="ident" id="4258155">config</span>&nbsp;<span class="op" id="4258162">*</span><span class="ident" id="4258163">Config</span><span class="op" id="4258169">,</span>&nbsp;<span class="ident" id="4258171">clientHello</span>&nbsp;<span class="op" id="4258183">*</span><span class="ident" id="4258184">clientHelloMsg</span><span class="op" id="4258198">,</span>&nbsp;<span class="ident" id="4258200">serverHello</span>&nbsp;<span class="op" id="4258212">*</span><span class="ident" id="4258213">serverHelloMsg</span><span class="op" id="4258227">,</span>&nbsp;<span class="ident" id="4258229">cert</span>&nbsp;<span class="op" id="4258234">*</span><span class="ident" id="4258235">x509</span><span class="op" id="4258239">.</span><span class="ident" id="4258240">Certificate</span><span class="op" id="4258251">,</span>&nbsp;<span class="ident" id="4258253">skx</span>&nbsp;<span class="op" id="4258257">*</span><span class="ident" id="4258258">serverKeyExchangeMsg</span><span class="op" id="4258278">)</span>&nbsp;<span class="builtintype" id="4258280">error</span>&nbsp;<span class="op" id="4258286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258289">if</span>&nbsp;<span class="builtinfunc" id="4258292">len</span><span class="op" id="4258295">(</span><span class="ident" id="4258296">skx</span><span class="op" id="4258299">.</span><span class="ident" id="4258300">key</span><span class="op" id="4258303">)</span>&nbsp;<span class="op" id="4258305">&lt;</span>&nbsp;<span class="num" id="4258307">4</span>&nbsp;<span class="op" id="4258309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258313">return</span>&nbsp;<span class="ident" id="4258320">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4258342">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258345">if</span>&nbsp;<span class="ident" id="4258348">skx</span><span class="op" id="4258351">.</span><span class="ident" id="4258352">key</span><span class="op" id="4258355">[</span><span class="num" id="4258356">0</span><span class="op" id="4258357">]</span>&nbsp;<span class="op" id="4258359">!=</span>&nbsp;<span class="num" id="4258362">3</span>&nbsp;<span class="op" id="4258364">{</span>&nbsp;<span class="comment" id="4258366">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258383">return</span>&nbsp;<span class="ident" id="4258390">errors</span><span class="op" id="4258396">.</span><span class="ident" id="4258397">New</span><span class="op" id="4258400">(</span><span class="string" id="4258401">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4258441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4258444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258447">curveid</span>&nbsp;<span class="op" id="4258455">:=</span>&nbsp;<span class="ident" id="4258458">CurveID</span><span class="op" id="4258465">(</span><span class="ident" id="4258466">skx</span><span class="op" id="4258469">.</span><span class="ident" id="4258470">key</span><span class="op" id="4258473">[</span><span class="num" id="4258474">1</span><span class="op" id="4258475">]</span><span class="op" id="4258476">)</span><span class="op" id="4258477">&lt;&lt;</span><span class="num" id="4258479">8</span>&nbsp;<span class="op" id="4258481">|</span>&nbsp;<span class="ident" id="4258483">CurveID</span><span class="op" id="4258490">(</span><span class="ident" id="4258491">skx</span><span class="op" id="4258494">.</span><span class="ident" id="4258495">key</span><span class="op" id="4258498">[</span><span class="num" id="4258499">2</span><span class="op" id="4258500">]</span><span class="op" id="4258501">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258505">var</span>&nbsp;<span class="ident" id="4258509">ok</span>&nbsp;<span class="builtintype" id="4258512">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258518">if</span>&nbsp;<span class="ident" id="4258521">ka</span><span class="op" id="4258523">.</span><span class="ident" id="4258524">curve</span><span class="op" id="4258529">,</span>&nbsp;<span class="ident" id="4258531">ok</span>&nbsp;<span class="op" id="4258534">=</span>&nbsp;<span class="ident" id="4258536">curveForCurveID</span><span class="op" id="4258551">(</span><span class="ident" id="4258552">curveid</span><span class="op" id="4258559">)</span><span class="op" id="4258560">;</span>&nbsp;<span class="op" id="4258562">!</span><span class="ident" id="4258563">ok</span>&nbsp;<span class="op" id="4258566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258570">return</span>&nbsp;<span class="ident" id="4258577">errors</span><span class="op" id="4258583">.</span><span class="ident" id="4258584">New</span><span class="op" id="4258587">(</span><span class="string" id="4258588">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4258628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4258631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258635">publicLen</span>&nbsp;<span class="op" id="4258645">:=</span>&nbsp;<span class="builtintype" id="4258648">int</span><span class="op" id="4258651">(</span><span class="ident" id="4258652">skx</span><span class="op" id="4258655">.</span><span class="ident" id="4258656">key</span><span class="op" id="4258659">[</span><span class="num" id="4258660">3</span><span class="op" id="4258661">]</span><span class="op" id="4258662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258665">if</span>&nbsp;<span class="ident" id="4258668">publicLen</span><span class="op" id="4258677">+</span><span class="num" id="4258678">4</span>&nbsp;<span class="op" id="4258680">&gt;</span>&nbsp;<span class="builtinfunc" id="4258682">len</span><span class="op" id="4258685">(</span><span class="ident" id="4258686">skx</span><span class="op" id="4258689">.</span><span class="ident" id="4258690">key</span><span class="op" id="4258693">)</span>&nbsp;<span class="op" id="4258695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258699">return</span>&nbsp;<span class="ident" id="4258706">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4258728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258731">ka</span><span class="op" id="4258733">.</span><span class="ident" id="4258734">x</span><span class="op" id="4258735">,</span>&nbsp;<span class="ident" id="4258737">ka</span><span class="op" id="4258739">.</span><span class="ident" id="4258740">y</span>&nbsp;<span class="op" id="4258742">=</span>&nbsp;<span class="ident" id="4258744">elliptic</span><span class="op" id="4258752">.</span><span class="ident" id="4258753">Unmarshal</span><span class="op" id="4258762">(</span><span class="ident" id="4258763">ka</span><span class="op" id="4258765">.</span><span class="ident" id="4258766">curve</span><span class="op" id="4258771">,</span>&nbsp;<span class="ident" id="4258773">skx</span><span class="op" id="4258776">.</span><span class="ident" id="4258777">key</span><span class="op" id="4258780">[</span><span class="num" id="4258781">4</span><span class="op" id="4258782">:</span><span class="num" id="4258783">4</span><span class="op" id="4258784">+</span><span class="ident" id="4258785">publicLen</span><span class="op" id="4258794">]</span><span class="op" id="4258795">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258798">if</span>&nbsp;<span class="ident" id="4258801">ka</span><span class="op" id="4258803">.</span><span class="ident" id="4258804">x</span>&nbsp;<span class="op" id="4258806">==</span>&nbsp;<span class="ident" id="4258809">nil</span>&nbsp;<span class="op" id="4258813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258817">return</span>&nbsp;<span class="ident" id="4258824">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4258846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258849">if</span>&nbsp;<span class="op" id="4258852">!</span><span class="ident" id="4258853">ka</span><span class="op" id="4258855">.</span><span class="ident" id="4258856">curve</span><span class="op" id="4258861">.</span><span class="ident" id="4258862">IsOnCurve</span><span class="op" id="4258871">(</span><span class="ident" id="4258872">ka</span><span class="op" id="4258874">.</span><span class="ident" id="4258875">x</span><span class="op" id="4258876">,</span>&nbsp;<span class="ident" id="4258878">ka</span><span class="op" id="4258880">.</span><span class="ident" id="4258881">y</span><span class="op" id="4258882">)</span>&nbsp;<span class="op" id="4258884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258888">return</span>&nbsp;<span class="ident" id="4258895">errServerKeyExchange</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4258917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258920">serverECDHParams</span>&nbsp;<span class="op" id="4258937">:=</span>&nbsp;<span class="ident" id="4258940">skx</span><span class="op" id="4258943">.</span><span class="ident" id="4258944">key</span><span class="op" id="4258947">[</span><span class="op" id="4258948">:</span><span class="num" id="4258949">4</span><span class="op" id="4258950">+</span><span class="ident" id="4258951">publicLen</span><span class="op" id="4258960">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258964">sig</span>&nbsp;<span class="op" id="4258968">:=</span>&nbsp;<span class="ident" id="4258971">skx</span><span class="op" id="4258974">.</span><span class="ident" id="4258975">key</span><span class="op" id="4258978">[</span><span class="num" id="4258979">4</span><span class="op" id="4258980">+</span><span class="ident" id="4258981">publicLen</span><span class="op" id="4258990">:</span><span class="op" id="4258991">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258994">if</span>&nbsp;<span class="builtinfunc" id="4258997">len</span><span class="op" id="4259000">(</span><span class="ident" id="4259001">sig</span><span class="op" id="4259004">)</span>&nbsp;<span class="op" id="4259006">&lt;</span>&nbsp;<span class="num" id="4259008">2</span>&nbsp;<span class="op" id="4259010">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259014">return</span>&nbsp;<span class="ident" id="4259021">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4259043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259047">var</span>&nbsp;<span class="ident" id="4259051">tls12HashId</span>&nbsp;<span class="builtintype" id="4259063">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259070">if</span>&nbsp;<span class="ident" id="4259073">ka</span><span class="op" id="4259075">.</span><span class="ident" id="4259076">version</span>&nbsp;<span class="op" id="4259084">&gt;=</span>&nbsp;<span class="ident" id="4259087">VersionTLS12</span>&nbsp;<span class="op" id="4259100">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4259104">//&nbsp;handle&nbsp;SignatureAndHashAlgorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259142">var</span>&nbsp;<span class="ident" id="4259146">sigAndHash</span>&nbsp;<span class="op" id="4259157">[</span><span class="op" id="4259158">]</span><span class="builtintype" id="4259159">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259167">sigAndHash</span><span class="op" id="4259177">,</span>&nbsp;<span class="ident" id="4259179">sig</span>&nbsp;<span class="op" id="4259183">=</span>&nbsp;<span class="ident" id="4259185">sig</span><span class="op" id="4259188">[</span><span class="op" id="4259189">:</span><span class="num" id="4259190">2</span><span class="op" id="4259191">]</span><span class="op" id="4259192">,</span>&nbsp;<span class="ident" id="4259194">sig</span><span class="op" id="4259197">[</span><span class="num" id="4259198">2</span><span class="op" id="4259199">:</span><span class="op" id="4259200">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259204">if</span>&nbsp;<span class="ident" id="4259207">sigAndHash</span><span class="op" id="4259217">[</span><span class="num" id="4259218">1</span><span class="op" id="4259219">]</span>&nbsp;<span class="op" id="4259221">!=</span>&nbsp;<span class="ident" id="4259224">ka</span><span class="op" id="4259226">.</span><span class="ident" id="4259227">sigType</span>&nbsp;<span class="op" id="4259235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259240">return</span>&nbsp;<span class="ident" id="4259247">errServerKeyExchange</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4259270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259274">tls12HashId</span>&nbsp;<span class="op" id="4259286">=</span>&nbsp;<span class="ident" id="4259288">sigAndHash</span><span class="op" id="4259298">[</span><span class="num" id="4259299">0</span><span class="op" id="4259300">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259304">if</span>&nbsp;<span class="builtinfunc" id="4259307">len</span><span class="op" id="4259310">(</span><span class="ident" id="4259311">sig</span><span class="op" id="4259314">)</span>&nbsp;<span class="op" id="4259316">&lt;</span>&nbsp;<span class="num" id="4259318">2</span>&nbsp;<span class="op" id="4259320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259325">return</span>&nbsp;<span class="ident" id="4259332">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4259355">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4259358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259361">sigLen</span>&nbsp;<span class="op" id="4259368">:=</span>&nbsp;<span class="builtintype" id="4259371">int</span><span class="op" id="4259374">(</span><span class="ident" id="4259375">sig</span><span class="op" id="4259378">[</span><span class="num" id="4259379">0</span><span class="op" id="4259380">]</span><span class="op" id="4259381">)</span><span class="op" id="4259382">&lt;&lt;</span><span class="num" id="4259384">8</span>&nbsp;<span class="op" id="4259386">|</span>&nbsp;<span class="builtintype" id="4259388">int</span><span class="op" id="4259391">(</span><span class="ident" id="4259392">sig</span><span class="op" id="4259395">[</span><span class="num" id="4259396">1</span><span class="op" id="4259397">]</span><span class="op" id="4259398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259401">if</span>&nbsp;<span class="ident" id="4259404">sigLen</span><span class="op" id="4259410">+</span><span class="num" id="4259411">2</span>&nbsp;<span class="op" id="4259413">!=</span>&nbsp;<span class="builtinfunc" id="4259416">len</span><span class="op" id="4259419">(</span><span class="ident" id="4259420">sig</span><span class="op" id="4259423">)</span>&nbsp;<span class="op" id="4259425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259429">return</span>&nbsp;<span class="ident" id="4259436">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4259458">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259461">sig</span>&nbsp;<span class="op" id="4259465">=</span>&nbsp;<span class="ident" id="4259467">sig</span><span class="op" id="4259470">[</span><span class="num" id="4259471">2</span><span class="op" id="4259472">:</span><span class="op" id="4259473">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259477">digest</span><span class="op" id="4259483">,</span>&nbsp;<span class="ident" id="4259485">hashFunc</span><span class="op" id="4259493">,</span>&nbsp;<span class="ident" id="4259495">err</span>&nbsp;<span class="op" id="4259499">:=</span>&nbsp;<span class="ident" id="4259502">hashForServerKeyExchange</span><span class="op" id="4259526">(</span><span class="ident" id="4259527">ka</span><span class="op" id="4259529">.</span><span class="ident" id="4259530">sigType</span><span class="op" id="4259537">,</span>&nbsp;<span class="ident" id="4259539">tls12HashId</span><span class="op" id="4259550">,</span>&nbsp;<span class="ident" id="4259552">ka</span><span class="op" id="4259554">.</span><span class="ident" id="4259555">version</span><span class="op" id="4259562">,</span>&nbsp;<span class="ident" id="4259564">clientHello</span><span class="op" id="4259575">.</span><span class="ident" id="4259576">random</span><span class="op" id="4259582">,</span>&nbsp;<span class="ident" id="4259584">serverHello</span><span class="op" id="4259595">.</span><span class="ident" id="4259596">random</span><span class="op" id="4259602">,</span>&nbsp;<span class="ident" id="4259604">serverECDHParams</span><span class="op" id="4259620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259623">if</span>&nbsp;<span class="ident" id="4259626">err</span>&nbsp;<span class="op" id="4259630">!=</span>&nbsp;<span class="ident" id="4259633">nil</span>&nbsp;<span class="op" id="4259637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259641">return</span>&nbsp;<span class="ident" id="4259648">err</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4259653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259656">switch</span>&nbsp;<span class="ident" id="4259663">ka</span><span class="op" id="4259665">.</span><span class="ident" id="4259666">sigType</span>&nbsp;<span class="op" id="4259674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259677">case</span>&nbsp;<span class="ident" id="4259682">signatureECDSA</span><span class="op" id="4259696">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259700">pubKey</span><span class="op" id="4259706">,</span>&nbsp;<span class="ident" id="4259708">ok</span>&nbsp;<span class="op" id="4259711">:=</span>&nbsp;<span class="ident" id="4259714">cert</span><span class="op" id="4259718">.</span><span class="ident" id="4259719">PublicKey</span><span class="op" id="4259728">.</span><span class="op" id="4259729">(</span><span class="op" id="4259730">*</span><span class="ident" id="4259731">ecdsa</span><span class="op" id="4259736">.</span><span class="ident" id="4259737">PublicKey</span><span class="op" id="4259746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259750">if</span>&nbsp;<span class="op" id="4259753">!</span><span class="ident" id="4259754">ok</span>&nbsp;<span class="op" id="4259757">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259762">return</span>&nbsp;<span class="ident" id="4259769">errors</span><span class="op" id="4259775">.</span><span class="ident" id="4259776">New</span><span class="op" id="4259779">(</span><span class="string" id="4259780">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;a&nbsp;ECDSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="4259828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4259832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259836">ecdsaSig</span>&nbsp;<span class="op" id="4259845">:=</span>&nbsp;<span class="builtinfunc" id="4259848">new</span><span class="op" id="4259851">(</span><span class="ident" id="4259852">ecdsaSignature</span><span class="op" id="4259866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259870">if</span>&nbsp;<span class="ident" id="4259873">_</span><span class="op" id="4259874">,</span>&nbsp;<span class="ident" id="4259876">err</span>&nbsp;<span class="op" id="4259880">:=</span>&nbsp;<span class="ident" id="4259883">asn1</span><span class="op" id="4259887">.</span><span class="ident" id="4259888">Unmarshal</span><span class="op" id="4259897">(</span><span class="ident" id="4259898">sig</span><span class="op" id="4259901">,</span>&nbsp;<span class="ident" id="4259903">ecdsaSig</span><span class="op" id="4259911">)</span><span class="op" id="4259912">;</span>&nbsp;<span class="ident" id="4259914">err</span>&nbsp;<span class="op" id="4259918">!=</span>&nbsp;<span class="ident" id="4259921">nil</span>&nbsp;<span class="op" id="4259925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259930">return</span>&nbsp;<span class="ident" id="4259937">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4259943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259947">if</span>&nbsp;<span class="ident" id="4259950">ecdsaSig</span><span class="op" id="4259958">.</span><span class="ident" id="4259959">R</span><span class="op" id="4259960">.</span><span class="ident" id="4259961">Sign</span><span class="op" id="4259965">(</span><span class="op" id="4259966">)</span>&nbsp;<span class="op" id="4259968">&lt;=</span>&nbsp;<span class="num" id="4259971">0</span>&nbsp;<span class="op" id="4259973">||</span>&nbsp;<span class="ident" id="4259976">ecdsaSig</span><span class="op" id="4259984">.</span><span class="ident" id="4259985">S</span><span class="op" id="4259986">.</span><span class="ident" id="4259987">Sign</span><span class="op" id="4259991">(</span><span class="op" id="4259992">)</span>&nbsp;<span class="op" id="4259994">&lt;=</span>&nbsp;<span class="num" id="4259997">0</span>&nbsp;<span class="op" id="4259999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260004">return</span>&nbsp;<span class="ident" id="4260011">errors</span><span class="op" id="4260017">.</span><span class="ident" id="4260018">New</span><span class="op" id="4260021">(</span><span class="string" id="4260022">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="4260073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260081">if</span>&nbsp;<span class="op" id="4260084">!</span><span class="ident" id="4260085">ecdsa</span><span class="op" id="4260090">.</span><span class="ident" id="4260091">Verify</span><span class="op" id="4260097">(</span><span class="ident" id="4260098">pubKey</span><span class="op" id="4260104">,</span>&nbsp;<span class="ident" id="4260106">digest</span><span class="op" id="4260112">,</span>&nbsp;<span class="ident" id="4260114">ecdsaSig</span><span class="op" id="4260122">.</span><span class="ident" id="4260123">R</span><span class="op" id="4260124">,</span>&nbsp;<span class="ident" id="4260126">ecdsaSig</span><span class="op" id="4260134">.</span><span class="ident" id="4260135">S</span><span class="op" id="4260136">)</span>&nbsp;<span class="op" id="4260138">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260143">return</span>&nbsp;<span class="ident" id="4260150">errors</span><span class="op" id="4260156">.</span><span class="ident" id="4260157">New</span><span class="op" id="4260160">(</span><span class="string" id="4260161">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="4260189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260196">case</span>&nbsp;<span class="ident" id="4260201">signatureRSA</span><span class="op" id="4260213">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260217">pubKey</span><span class="op" id="4260223">,</span>&nbsp;<span class="ident" id="4260225">ok</span>&nbsp;<span class="op" id="4260228">:=</span>&nbsp;<span class="ident" id="4260231">cert</span><span class="op" id="4260235">.</span><span class="ident" id="4260236">PublicKey</span><span class="op" id="4260245">.</span><span class="op" id="4260246">(</span><span class="op" id="4260247">*</span><span class="ident" id="4260248">rsa</span><span class="op" id="4260251">.</span><span class="ident" id="4260252">PublicKey</span><span class="op" id="4260261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260265">if</span>&nbsp;<span class="op" id="4260268">!</span><span class="ident" id="4260269">ok</span>&nbsp;<span class="op" id="4260272">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260277">return</span>&nbsp;<span class="ident" id="4260284">errors</span><span class="op" id="4260290">.</span><span class="ident" id="4260291">New</span><span class="op" id="4260294">(</span><span class="string" id="4260295">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="4260339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260347">if</span>&nbsp;<span class="ident" id="4260350">err</span>&nbsp;<span class="op" id="4260354">:=</span>&nbsp;<span class="ident" id="4260357">rsa</span><span class="op" id="4260360">.</span><span class="ident" id="4260361">VerifyPKCS1v15</span><span class="op" id="4260375">(</span><span class="ident" id="4260376">pubKey</span><span class="op" id="4260382">,</span>&nbsp;<span class="ident" id="4260384">hashFunc</span><span class="op" id="4260392">,</span>&nbsp;<span class="ident" id="4260394">digest</span><span class="op" id="4260400">,</span>&nbsp;<span class="ident" id="4260402">sig</span><span class="op" id="4260405">)</span><span class="op" id="4260406">;</span>&nbsp;<span class="ident" id="4260408">err</span>&nbsp;<span class="op" id="4260412">!=</span>&nbsp;<span class="ident" id="4260415">nil</span>&nbsp;<span class="op" id="4260419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260424">return</span>&nbsp;<span class="ident" id="4260431">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260437">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260440">default</span><span class="op" id="4260447">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260451">return</span>&nbsp;<span class="ident" id="4260458">errors</span><span class="op" id="4260464">.</span><span class="ident" id="4260465">New</span><span class="op" id="4260468">(</span><span class="string" id="4260469">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="4260504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260511">return</span>&nbsp;<span class="ident" id="4260518">nil</span><br>
<span class="lineno">390</span><span class="op" id="4260522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4260525">func</span>&nbsp;<span class="op" id="4260530">(</span><span class="ident" id="4260531">ka</span>&nbsp;<span class="op" id="4260534">*</span><span class="ident" id="4260535">ecdheKeyAgreement</span><span class="op" id="4260552">)</span>&nbsp;<span class="ident" id="4260554">generateClientKeyExchange</span><span class="op" id="4260579">(</span><span class="ident" id="4260580">config</span>&nbsp;<span class="op" id="4260587">*</span><span class="ident" id="4260588">Config</span><span class="op" id="4260594">,</span>&nbsp;<span class="ident" id="4260596">clientHello</span>&nbsp;<span class="op" id="4260608">*</span><span class="ident" id="4260609">clientHelloMsg</span><span class="op" id="4260623">,</span>&nbsp;<span class="ident" id="4260625">cert</span>&nbsp;<span class="op" id="4260630">*</span><span class="ident" id="4260631">x509</span><span class="op" id="4260635">.</span><span class="ident" id="4260636">Certificate</span><span class="op" id="4260647">)</span>&nbsp;<span class="op" id="4260649">(</span><span class="op" id="4260650">[</span><span class="op" id="4260651">]</span><span class="builtintype" id="4260652">byte</span><span class="op" id="4260656">,</span>&nbsp;<span class="op" id="4260658">*</span><span class="ident" id="4260659">clientKeyExchangeMsg</span><span class="op" id="4260679">,</span>&nbsp;<span class="builtintype" id="4260681">error</span><span class="op" id="4260686">)</span>&nbsp;<span class="op" id="4260688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260691">if</span>&nbsp;<span class="ident" id="4260694">ka</span><span class="op" id="4260696">.</span><span class="ident" id="4260697">curve</span>&nbsp;<span class="op" id="4260703">==</span>&nbsp;<span class="ident" id="4260706">nil</span>&nbsp;<span class="op" id="4260710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260714">return</span>&nbsp;<span class="ident" id="4260721">nil</span><span class="op" id="4260724">,</span>&nbsp;<span class="ident" id="4260726">nil</span><span class="op" id="4260729">,</span>&nbsp;<span class="ident" id="4260731">errors</span><span class="op" id="4260737">.</span><span class="ident" id="4260738">New</span><span class="op" id="4260741">(</span><span class="string" id="4260742">&#34;missing&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="4260777">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260783">priv</span><span class="op" id="4260787">,</span>&nbsp;<span class="ident" id="4260789">mx</span><span class="op" id="4260791">,</span>&nbsp;<span class="ident" id="4260793">my</span><span class="op" id="4260795">,</span>&nbsp;<span class="ident" id="4260797">err</span>&nbsp;<span class="op" id="4260801">:=</span>&nbsp;<span class="ident" id="4260804">elliptic</span><span class="op" id="4260812">.</span><span class="ident" id="4260813">GenerateKey</span><span class="op" id="4260824">(</span><span class="ident" id="4260825">ka</span><span class="op" id="4260827">.</span><span class="ident" id="4260828">curve</span><span class="op" id="4260833">,</span>&nbsp;<span class="ident" id="4260835">config</span><span class="op" id="4260841">.</span><span class="ident" id="4260842">rand</span><span class="op" id="4260846">(</span><span class="op" id="4260847">)</span><span class="op" id="4260848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260851">if</span>&nbsp;<span class="ident" id="4260854">err</span>&nbsp;<span class="op" id="4260858">!=</span>&nbsp;<span class="ident" id="4260861">nil</span>&nbsp;<span class="op" id="4260865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260869">return</span>&nbsp;<span class="ident" id="4260876">nil</span><span class="op" id="4260879">,</span>&nbsp;<span class="ident" id="4260881">nil</span><span class="op" id="4260884">,</span>&nbsp;<span class="ident" id="4260886">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260891">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260894">x</span><span class="op" id="4260895">,</span>&nbsp;<span class="ident" id="4260897">_</span>&nbsp;<span class="op" id="4260899">:=</span>&nbsp;<span class="ident" id="4260902">ka</span><span class="op" id="4260904">.</span><span class="ident" id="4260905">curve</span><span class="op" id="4260910">.</span><span class="ident" id="4260911">ScalarMult</span><span class="op" id="4260921">(</span><span class="ident" id="4260922">ka</span><span class="op" id="4260924">.</span><span class="ident" id="4260925">x</span><span class="op" id="4260926">,</span>&nbsp;<span class="ident" id="4260928">ka</span><span class="op" id="4260930">.</span><span class="ident" id="4260931">y</span><span class="op" id="4260932">,</span>&nbsp;<span class="ident" id="4260934">priv</span><span class="op" id="4260938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260941">preMasterSecret</span>&nbsp;<span class="op" id="4260957">:=</span>&nbsp;<span class="builtinfunc" id="4260960">make</span><span class="op" id="4260964">(</span><span class="op" id="4260965">[</span><span class="op" id="4260966">]</span><span class="builtintype" id="4260967">byte</span><span class="op" id="4260971">,</span>&nbsp;<span class="op" id="4260973">(</span><span class="ident" id="4260974">ka</span><span class="op" id="4260976">.</span><span class="ident" id="4260977">curve</span><span class="op" id="4260982">.</span><span class="ident" id="4260983">Params</span><span class="op" id="4260989">(</span><span class="op" id="4260990">)</span><span class="op" id="4260991">.</span><span class="ident" id="4260992">BitSize</span><span class="op" id="4260999">+</span><span class="num" id="4261000">7</span><span class="op" id="4261001">)</span><span class="op" id="4261002">&gt;&gt;</span><span class="num" id="4261004">3</span><span class="op" id="4261005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261008">xBytes</span>&nbsp;<span class="op" id="4261015">:=</span>&nbsp;<span class="ident" id="4261018">x</span><span class="op" id="4261019">.</span><span class="ident" id="4261020">Bytes</span><span class="op" id="4261025">(</span><span class="op" id="4261026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4261029">copy</span><span class="op" id="4261033">(</span><span class="ident" id="4261034">preMasterSecret</span><span class="op" id="4261049">[</span><span class="builtinfunc" id="4261050">len</span><span class="op" id="4261053">(</span><span class="ident" id="4261054">preMasterSecret</span><span class="op" id="4261069">)</span><span class="op" id="4261070">-</span><span class="builtinfunc" id="4261071">len</span><span class="op" id="4261074">(</span><span class="ident" id="4261075">xBytes</span><span class="op" id="4261081">)</span><span class="op" id="4261082">:</span><span class="op" id="4261083">]</span><span class="op" id="4261084">,</span>&nbsp;<span class="ident" id="4261086">xBytes</span><span class="op" id="4261092">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261096">serialized</span>&nbsp;<span class="op" id="4261107">:=</span>&nbsp;<span class="ident" id="4261110">elliptic</span><span class="op" id="4261118">.</span><span class="ident" id="4261119">Marshal</span><span class="op" id="4261126">(</span><span class="ident" id="4261127">ka</span><span class="op" id="4261129">.</span><span class="ident" id="4261130">curve</span><span class="op" id="4261135">,</span>&nbsp;<span class="ident" id="4261137">mx</span><span class="op" id="4261139">,</span>&nbsp;<span class="ident" id="4261141">my</span><span class="op" id="4261143">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261147">ckx</span>&nbsp;<span class="op" id="4261151">:=</span>&nbsp;<span class="builtinfunc" id="4261154">new</span><span class="op" id="4261157">(</span><span class="ident" id="4261158">clientKeyExchangeMsg</span><span class="op" id="4261178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261181">ckx</span><span class="op" id="4261184">.</span><span class="ident" id="4261185">ciphertext</span>&nbsp;<span class="op" id="4261196">=</span>&nbsp;<span class="builtinfunc" id="4261198">make</span><span class="op" id="4261202">(</span><span class="op" id="4261203">[</span><span class="op" id="4261204">]</span><span class="builtintype" id="4261205">byte</span><span class="op" id="4261209">,</span>&nbsp;<span class="num" id="4261211">1</span><span class="op" id="4261212">+</span><span class="builtinfunc" id="4261213">len</span><span class="op" id="4261216">(</span><span class="ident" id="4261217">serialized</span><span class="op" id="4261227">)</span><span class="op" id="4261228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261231">ckx</span><span class="op" id="4261234">.</span><span class="ident" id="4261235">ciphertext</span><span class="op" id="4261245">[</span><span class="num" id="4261246">0</span><span class="op" id="4261247">]</span>&nbsp;<span class="op" id="4261249">=</span>&nbsp;<span class="builtintype" id="4261251">byte</span><span class="op" id="4261255">(</span><span class="builtinfunc" id="4261256">len</span><span class="op" id="4261259">(</span><span class="ident" id="4261260">serialized</span><span class="op" id="4261270">)</span><span class="op" id="4261271">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4261274">copy</span><span class="op" id="4261278">(</span><span class="ident" id="4261279">ckx</span><span class="op" id="4261282">.</span><span class="ident" id="4261283">ciphertext</span><span class="op" id="4261293">[</span><span class="num" id="4261294">1</span><span class="op" id="4261295">:</span><span class="op" id="4261296">]</span><span class="op" id="4261297">,</span>&nbsp;<span class="ident" id="4261299">serialized</span><span class="op" id="4261309">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4261313">return</span>&nbsp;<span class="ident" id="4261320">preMasterSecret</span><span class="op" id="4261335">,</span>&nbsp;<span class="ident" id="4261337">ckx</span><span class="op" id="4261340">,</span>&nbsp;<span class="ident" id="4261342">nil</span><br>
<span class="lineno"></span><span class="op" id="4261346">}</span>
</div>
</body>
</html>
