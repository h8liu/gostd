<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html" class="current">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2546327">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2546382">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2546436">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2546487">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2546552">//&nbsp;Fork,&nbsp;exec,&nbsp;wait,&nbsp;etc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2546579">package</span>&nbsp;<span class="ident" id="2546587">syscall</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="2546596">import</span>&nbsp;<span class="op" id="2546603">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2546606">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2546617">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2546625">&#34;unsafe&#34;</span><br>
<span class="lineno">15</span><span class="op" id="2546634">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2546637">//&nbsp;Lock&nbsp;synchronizing&nbsp;creation&nbsp;of&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;with&nbsp;fork.</span><br>
<span class="lineno"></span><span class="comment" id="2546703">//</span><br>
<span class="lineno"></span><span class="comment" id="2546706">//&nbsp;We&nbsp;want&nbsp;the&nbsp;child&nbsp;in&nbsp;a&nbsp;fork/exec&nbsp;sequence&nbsp;to&nbsp;inherit&nbsp;only&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="2546771">//&nbsp;file&nbsp;descriptors&nbsp;we&nbsp;intend.&nbsp;&nbsp;To&nbsp;do&nbsp;that,&nbsp;we&nbsp;mark&nbsp;all&nbsp;file</span><br>
<span class="lineno"></span><span class="comment" id="2546832">//&nbsp;descriptors&nbsp;close-on-exec&nbsp;and&nbsp;then,&nbsp;in&nbsp;the&nbsp;child,&nbsp;explicitly</span><br>
<span class="lineno"></span><span class="comment" id="2546896">//&nbsp;unmark&nbsp;the&nbsp;ones&nbsp;we&nbsp;want&nbsp;the&nbsp;exec&#39;ed&nbsp;program&nbsp;to&nbsp;keep.</span><br>
<span class="lineno"></span><span class="comment" id="2546952">//&nbsp;Unix&nbsp;doesn&#39;t&nbsp;make&nbsp;this&nbsp;easy:&nbsp;there&nbsp;is,&nbsp;in&nbsp;general,&nbsp;no&nbsp;way&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2547016">//&nbsp;allocate&nbsp;a&nbsp;new&nbsp;file&nbsp;descriptor&nbsp;close-on-exec.&nbsp;&nbsp;Instead&nbsp;you</span><br>
<span class="lineno">25</span><span class="comment" id="2547078">//&nbsp;have&nbsp;to&nbsp;allocate&nbsp;the&nbsp;descriptor&nbsp;and&nbsp;then&nbsp;mark&nbsp;it&nbsp;close-on-exec.</span><br>
<span class="lineno"></span><span class="comment" id="2547145">//&nbsp;If&nbsp;a&nbsp;fork&nbsp;happens&nbsp;between&nbsp;those&nbsp;two&nbsp;events,&nbsp;the&nbsp;child&#39;s&nbsp;exec</span><br>
<span class="lineno"></span><span class="comment" id="2547209">//&nbsp;will&nbsp;inherit&nbsp;an&nbsp;unwanted&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="comment" id="2547254">//</span><br>
<span class="lineno"></span><span class="comment" id="2547257">//&nbsp;This&nbsp;lock&nbsp;solves&nbsp;that&nbsp;race:&nbsp;the&nbsp;create&nbsp;new&nbsp;fd/mark&nbsp;close-on-exec</span><br>
<span class="lineno">30</span><span class="comment" id="2547325">//&nbsp;operation&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;reading,&nbsp;and&nbsp;the&nbsp;fork&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2547396">//&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;writing.&nbsp;&nbsp;At&nbsp;least,&nbsp;that&#39;s&nbsp;the&nbsp;idea.</span><br>
<span class="lineno"></span><span class="comment" id="2547465">//&nbsp;There&nbsp;are&nbsp;some&nbsp;complications.</span><br>
<span class="lineno"></span><span class="comment" id="2547498">//</span><br>
<span class="lineno"></span><span class="comment" id="2547501">//&nbsp;Some&nbsp;system&nbsp;calls&nbsp;that&nbsp;create&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;can&nbsp;block</span><br>
<span class="lineno">35</span><span class="comment" id="2547565">//&nbsp;for&nbsp;arbitrarily&nbsp;long&nbsp;times:&nbsp;open&nbsp;on&nbsp;a&nbsp;hung&nbsp;NFS&nbsp;server&nbsp;or&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="2547631">//&nbsp;pipe,&nbsp;accept&nbsp;on&nbsp;a&nbsp;socket,&nbsp;and&nbsp;so&nbsp;on.&nbsp;&nbsp;We&nbsp;can&#39;t&nbsp;reasonably&nbsp;grab</span><br>
<span class="lineno"></span><span class="comment" id="2547697">//&nbsp;the&nbsp;lock&nbsp;across&nbsp;those&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="2547734">//</span><br>
<span class="lineno"></span><span class="comment" id="2547737">//&nbsp;It&nbsp;is&nbsp;worse&nbsp;to&nbsp;inherit&nbsp;some&nbsp;file&nbsp;descriptors&nbsp;than&nbsp;others.</span><br>
<span class="lineno">40</span><span class="comment" id="2547798">//&nbsp;If&nbsp;a&nbsp;non-malicious&nbsp;child&nbsp;accidentally&nbsp;inherits&nbsp;an&nbsp;open&nbsp;ordinary&nbsp;file,</span><br>
<span class="lineno"></span><span class="comment" id="2547871">//&nbsp;that&#39;s&nbsp;not&nbsp;a&nbsp;big&nbsp;deal.&nbsp;&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;if&nbsp;a&nbsp;long-lived&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="2547939">//&nbsp;accidentally&nbsp;inherits&nbsp;the&nbsp;write&nbsp;end&nbsp;of&nbsp;a&nbsp;pipe,&nbsp;then&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span><span class="comment" id="2548005">//&nbsp;of&nbsp;that&nbsp;pipe&nbsp;will&nbsp;not&nbsp;see&nbsp;EOF&nbsp;until&nbsp;that&nbsp;child&nbsp;exits,&nbsp;potentially</span><br>
<span class="lineno"></span><span class="comment" id="2548074">//&nbsp;causing&nbsp;the&nbsp;parent&nbsp;program&nbsp;to&nbsp;hang.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;common&nbsp;problem</span><br>
<span class="lineno">45</span><span class="comment" id="2548139">//&nbsp;in&nbsp;threaded&nbsp;C&nbsp;programs&nbsp;that&nbsp;use&nbsp;popen.</span><br>
<span class="lineno"></span><span class="comment" id="2548181">//</span><br>
<span class="lineno"></span><span class="comment" id="2548184">//&nbsp;Luckily,&nbsp;the&nbsp;file&nbsp;descriptors&nbsp;that&nbsp;are&nbsp;most&nbsp;important&nbsp;not&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2548248">//&nbsp;inherit&nbsp;are&nbsp;not&nbsp;the&nbsp;ones&nbsp;that&nbsp;can&nbsp;take&nbsp;an&nbsp;arbitrarily&nbsp;long&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="2548315">//&nbsp;to&nbsp;create:&nbsp;pipe&nbsp;returns&nbsp;instantly,&nbsp;and&nbsp;the&nbsp;net&nbsp;package&nbsp;uses</span><br>
<span class="lineno">50</span><span class="comment" id="2548378">//&nbsp;non-blocking&nbsp;I/O&nbsp;to&nbsp;accept&nbsp;on&nbsp;a&nbsp;listening&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="2548431">//&nbsp;The&nbsp;rules&nbsp;for&nbsp;which&nbsp;file&nbsp;descriptor-creating&nbsp;operations&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2548498">//&nbsp;ForkLock&nbsp;are&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="2548526">//</span><br>
<span class="lineno"></span><span class="comment" id="2548529">//&nbsp;1)&nbsp;Pipe.&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno">55</span><span class="comment" id="2548579">//&nbsp;2)&nbsp;Socket.&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2548629">//&nbsp;3)&nbsp;Accept.&nbsp;&nbsp;If&nbsp;using&nbsp;non-blocking&nbsp;mode,&nbsp;use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2548690">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno"></span><span class="comment" id="2548736">//&nbsp;4)&nbsp;Open.&nbsp;&nbsp;&nbsp;&nbsp;Can&nbsp;block.&nbsp;&nbsp;Use&nbsp;O_CLOEXEC&nbsp;if&nbsp;available&nbsp;(Linux).</span><br>
<span class="lineno"></span><span class="comment" id="2548799">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno">60</span><span class="comment" id="2548845">//&nbsp;5)&nbsp;Dup.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2548895">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;Linux,&nbsp;could&nbsp;use&nbsp;fcntl&nbsp;F_DUPFD_CLOEXEC</span><br>
<span class="lineno"></span><span class="comment" id="2548952">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instead&nbsp;of&nbsp;the&nbsp;ForkLock,&nbsp;but&nbsp;only&nbsp;for&nbsp;dup(fd,&nbsp;-1).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2549019">var</span>&nbsp;<span class="ident" id="2549023">ForkLock</span>&nbsp;<span class="ident" id="2549032">sync</span><span class="op" id="2549036">.</span><span class="ident" id="2549037">RWMutex</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2549046">//&nbsp;StringSlicePtr&nbsp;is&nbsp;deprecated.&nbsp;Use&nbsp;SlicePtrFromStrings&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="2549112">//&nbsp;If&nbsp;any&nbsp;string&nbsp;contains&nbsp;a&nbsp;NUL&nbsp;byte&nbsp;this&nbsp;function&nbsp;panics&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="2549178">//&nbsp;of&nbsp;returning&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="2549204">func</span>&nbsp;<span class="ident" id="2549209">StringSlicePtr</span><span class="op" id="2549223">(</span><span class="ident" id="2549224">ss</span>&nbsp;<span class="op" id="2549227">[</span><span class="op" id="2549228">]</span><span class="builtintype" id="2549229">string</span><span class="op" id="2549235">)</span>&nbsp;<span class="op" id="2549237">[</span><span class="op" id="2549238">]</span><span class="op" id="2549239">*</span><span class="builtintype" id="2549240">byte</span>&nbsp;<span class="op" id="2549245">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2549248">bb</span>&nbsp;<span class="op" id="2549251">:=</span>&nbsp;<span class="builtinfunc" id="2549254">make</span><span class="op" id="2549258">(</span><span class="op" id="2549259">[</span><span class="op" id="2549260">]</span><span class="op" id="2549261">*</span><span class="builtintype" id="2549262">byte</span><span class="op" id="2549266">,</span>&nbsp;<span class="builtinfunc" id="2549268">len</span><span class="op" id="2549271">(</span><span class="ident" id="2549272">ss</span><span class="op" id="2549274">)</span><span class="op" id="2549275">+</span><span class="num" id="2549276">1</span><span class="op" id="2549277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2549280">for</span>&nbsp;<span class="ident" id="2549284">i</span>&nbsp;<span class="op" id="2549286">:=</span>&nbsp;<span class="num" id="2549289">0</span><span class="op" id="2549290">;</span>&nbsp;<span class="ident" id="2549292">i</span>&nbsp;<span class="op" id="2549294">&lt;</span>&nbsp;<span class="builtinfunc" id="2549296">len</span><span class="op" id="2549299">(</span><span class="ident" id="2549300">ss</span><span class="op" id="2549302">)</span><span class="op" id="2549303">;</span>&nbsp;<span class="ident" id="2549305">i</span><span class="op" id="2549306">++</span>&nbsp;<span class="op" id="2549309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2549313">bb</span><span class="op" id="2549315">[</span><span class="ident" id="2549316">i</span><span class="op" id="2549317">]</span>&nbsp;<span class="op" id="2549319">=</span>&nbsp;<span class="ident" id="2549321">StringBytePtr</span><span class="op" id="2549334">(</span><span class="ident" id="2549335">ss</span><span class="op" id="2549337">[</span><span class="ident" id="2549338">i</span><span class="op" id="2549339">]</span><span class="op" id="2549340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2549343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2549346">bb</span><span class="op" id="2549348">[</span><span class="builtinfunc" id="2549349">len</span><span class="op" id="2549352">(</span><span class="ident" id="2549353">ss</span><span class="op" id="2549355">)</span><span class="op" id="2549356">]</span>&nbsp;<span class="op" id="2549358">=</span>&nbsp;<span class="ident" id="2549360">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2549365">return</span>&nbsp;<span class="ident" id="2549372">bb</span><br>
<span class="lineno"></span><span class="op" id="2549375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2549378">//&nbsp;SlicePtrFromStrings&nbsp;converts&nbsp;a&nbsp;slice&nbsp;of&nbsp;strings&nbsp;to&nbsp;a&nbsp;slice&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2549443">//&nbsp;pointers&nbsp;to&nbsp;NUL-terminated&nbsp;byte&nbsp;slices.&nbsp;If&nbsp;any&nbsp;string&nbsp;contains</span><br>
<span class="lineno">80</span><span class="comment" id="2549509">//&nbsp;a&nbsp;NUL&nbsp;byte,&nbsp;it&nbsp;returns&nbsp;(nil,&nbsp;EINVAL).</span><br>
<span class="lineno"></span><span class="keyword" id="2549550">func</span>&nbsp;<span class="ident" id="2549555">SlicePtrFromStrings</span><span class="op" id="2549574">(</span><span class="ident" id="2549575">ss</span>&nbsp;<span class="op" id="2549578">[</span><span class="op" id="2549579">]</span><span class="builtintype" id="2549580">string</span><span class="op" id="2549586">)</span>&nbsp;<span class="op" id="2549588">(</span><span class="op" id="2549589">[</span><span class="op" id="2549590">]</span><span class="op" id="2549591">*</span><span class="builtintype" id="2549592">byte</span><span class="op" id="2549596">,</span>&nbsp;<span class="builtintype" id="2549598">error</span><span class="op" id="2549603">)</span>&nbsp;<span class="op" id="2549605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2549608">var</span>&nbsp;<span class="ident" id="2549612">err</span>&nbsp;<span class="builtintype" id="2549616">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2549623">bb</span>&nbsp;<span class="op" id="2549626">:=</span>&nbsp;<span class="builtinfunc" id="2549629">make</span><span class="op" id="2549633">(</span><span class="op" id="2549634">[</span><span class="op" id="2549635">]</span><span class="op" id="2549636">*</span><span class="builtintype" id="2549637">byte</span><span class="op" id="2549641">,</span>&nbsp;<span class="builtinfunc" id="2549643">len</span><span class="op" id="2549646">(</span><span class="ident" id="2549647">ss</span><span class="op" id="2549649">)</span><span class="op" id="2549650">+</span><span class="num" id="2549651">1</span><span class="op" id="2549652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2549655">for</span>&nbsp;<span class="ident" id="2549659">i</span>&nbsp;<span class="op" id="2549661">:=</span>&nbsp;<span class="num" id="2549664">0</span><span class="op" id="2549665">;</span>&nbsp;<span class="ident" id="2549667">i</span>&nbsp;<span class="op" id="2549669">&lt;</span>&nbsp;<span class="builtinfunc" id="2549671">len</span><span class="op" id="2549674">(</span><span class="ident" id="2549675">ss</span><span class="op" id="2549677">)</span><span class="op" id="2549678">;</span>&nbsp;<span class="ident" id="2549680">i</span><span class="op" id="2549681">++</span>&nbsp;<span class="op" id="2549684">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2549688">bb</span><span class="op" id="2549690">[</span><span class="ident" id="2549691">i</span><span class="op" id="2549692">]</span><span class="op" id="2549693">,</span>&nbsp;<span class="ident" id="2549695">err</span>&nbsp;<span class="op" id="2549699">=</span>&nbsp;<span class="ident" id="2549701">BytePtrFromString</span><span class="op" id="2549718">(</span><span class="ident" id="2549719">ss</span><span class="op" id="2549721">[</span><span class="ident" id="2549722">i</span><span class="op" id="2549723">]</span><span class="op" id="2549724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2549728">if</span>&nbsp;<span class="ident" id="2549731">err</span>&nbsp;<span class="op" id="2549735">!=</span>&nbsp;<span class="ident" id="2549738">nil</span>&nbsp;<span class="op" id="2549742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2549747">return</span>&nbsp;<span class="ident" id="2549754">nil</span><span class="op" id="2549757">,</span>&nbsp;<span class="ident" id="2549759">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2549765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2549768">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2549771">bb</span><span class="op" id="2549773">[</span><span class="builtinfunc" id="2549774">len</span><span class="op" id="2549777">(</span><span class="ident" id="2549778">ss</span><span class="op" id="2549780">)</span><span class="op" id="2549781">]</span>&nbsp;<span class="op" id="2549783">=</span>&nbsp;<span class="ident" id="2549785">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2549790">return</span>&nbsp;<span class="ident" id="2549797">bb</span><span class="op" id="2549799">,</span>&nbsp;<span class="ident" id="2549801">nil</span><br>
<span class="lineno"></span><span class="op" id="2549805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2549808">func</span>&nbsp;<span class="ident" id="2549813">CloseOnExec</span><span class="op" id="2549824">(</span><span class="ident" id="2549825">fd</span>&nbsp;<span class="builtintype" id="2549828">int</span><span class="op" id="2549831">)</span>&nbsp;<span class="op" id="2549833">{</span>&nbsp;<span class="ident" id="2549835">fcntl</span><span class="op" id="2549840">(</span><span class="ident" id="2549841">fd</span><span class="op" id="2549843">,</span>&nbsp;<span class="ident" id="2549845">F_SETFD</span><span class="op" id="2549852">,</span>&nbsp;<span class="ident" id="2549854">FD_CLOEXEC</span><span class="op" id="2549864">)</span>&nbsp;<span class="op" id="2549866">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="2549869">func</span>&nbsp;<span class="ident" id="2549874">SetNonblock</span><span class="op" id="2549885">(</span><span class="ident" id="2549886">fd</span>&nbsp;<span class="builtintype" id="2549889">int</span><span class="op" id="2549892">,</span>&nbsp;<span class="ident" id="2549894">nonblocking</span>&nbsp;<span class="builtintype" id="2549906">bool</span><span class="op" id="2549910">)</span>&nbsp;<span class="op" id="2549912">(</span><span class="ident" id="2549913">err</span>&nbsp;<span class="builtintype" id="2549917">error</span><span class="op" id="2549922">)</span>&nbsp;<span class="op" id="2549924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2549927">flag</span><span class="op" id="2549931">,</span>&nbsp;<span class="ident" id="2549933">err</span>&nbsp;<span class="op" id="2549937">:=</span>&nbsp;<span class="ident" id="2549940">fcntl</span><span class="op" id="2549945">(</span><span class="ident" id="2549946">fd</span><span class="op" id="2549948">,</span>&nbsp;<span class="ident" id="2549950">F_GETFL</span><span class="op" id="2549957">,</span>&nbsp;<span class="num" id="2549959">0</span><span class="op" id="2549960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2549963">if</span>&nbsp;<span class="ident" id="2549966">err</span>&nbsp;<span class="op" id="2549970">!=</span>&nbsp;<span class="ident" id="2549973">nil</span>&nbsp;<span class="op" id="2549977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2549981">return</span>&nbsp;<span class="ident" id="2549988">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2549993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2549996">if</span>&nbsp;<span class="ident" id="2549999">nonblocking</span>&nbsp;<span class="op" id="2550011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550015">flag</span>&nbsp;<span class="op" id="2550020">|=</span>&nbsp;<span class="ident" id="2550023">O_NONBLOCK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2550035">}</span>&nbsp;<span class="keyword" id="2550037">else</span>&nbsp;<span class="op" id="2550042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550046">flag</span>&nbsp;<span class="op" id="2550051">&amp;=</span>&nbsp;<span class="op" id="2550054">^</span><span class="ident" id="2550055">O_NONBLOCK</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2550067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550070">_</span><span class="op" id="2550071">,</span>&nbsp;<span class="ident" id="2550073">err</span>&nbsp;<span class="op" id="2550077">=</span>&nbsp;<span class="ident" id="2550079">fcntl</span><span class="op" id="2550084">(</span><span class="ident" id="2550085">fd</span><span class="op" id="2550087">,</span>&nbsp;<span class="ident" id="2550089">F_SETFL</span><span class="op" id="2550096">,</span>&nbsp;<span class="ident" id="2550098">flag</span><span class="op" id="2550102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2550105">return</span>&nbsp;<span class="ident" id="2550112">err</span><br>
<span class="lineno"></span><span class="op" id="2550116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="2550119">//&nbsp;Credential&nbsp;holds&nbsp;user&nbsp;and&nbsp;group&nbsp;identities&nbsp;to&nbsp;be&nbsp;assumed</span><br>
<span class="lineno"></span><span class="comment" id="2550179">//&nbsp;by&nbsp;a&nbsp;child&nbsp;process&nbsp;started&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno"></span><span class="keyword" id="2550226">type</span>&nbsp;<span class="ident" id="2550231">Credential</span>&nbsp;<span class="keyword" id="2550242">struct</span>&nbsp;<span class="op" id="2550249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550252">Uid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2550259">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2550268">//&nbsp;User&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550281">Gid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2550288">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2550297">//&nbsp;Group&nbsp;ID.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550311">Groups</span>&nbsp;<span class="op" id="2550318">[</span><span class="op" id="2550319">]</span><span class="builtintype" id="2550320">uint32</span>&nbsp;<span class="comment" id="2550327">//&nbsp;Supplementary&nbsp;group&nbsp;IDs.</span><br>
<span class="lineno"></span><span class="op" id="2550355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2550358">//&nbsp;ProcAttr&nbsp;holds&nbsp;attributes&nbsp;that&nbsp;will&nbsp;be&nbsp;applied&nbsp;to&nbsp;a&nbsp;new&nbsp;process&nbsp;started</span><br>
<span class="lineno"></span><span class="comment" id="2550433">//&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno">120</span><span class="keyword" id="2550453">type</span>&nbsp;<span class="ident" id="2550458">ProcAttr</span>&nbsp;<span class="keyword" id="2550467">struct</span>&nbsp;<span class="op" id="2550474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550477">Dir</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2550483">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2550493">//&nbsp;Current&nbsp;working&nbsp;directory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550524">Env</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2550530">[</span><span class="op" id="2550531">]</span><span class="builtintype" id="2550532">string</span>&nbsp;&nbsp;<span class="comment" id="2550540">//&nbsp;Environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550557">Files</span>&nbsp;<span class="op" id="2550563">[</span><span class="op" id="2550564">]</span><span class="builtintype" id="2550565">uintptr</span>&nbsp;<span class="comment" id="2550573">//&nbsp;File&nbsp;descriptors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550595">Sys</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2550601">*</span><span class="ident" id="2550602">SysProcAttr</span><br>
<span class="lineno">125</span><span class="op" id="2550614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2550617">var</span>&nbsp;<span class="ident" id="2550621">zeroProcAttr</span>&nbsp;<span class="ident" id="2550634">ProcAttr</span><br>
<span class="lineno"></span><span class="keyword" id="2550643">var</span>&nbsp;<span class="ident" id="2550647">zeroSysProcAttr</span>&nbsp;<span class="ident" id="2550663">SysProcAttr</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2550676">func</span>&nbsp;<span class="ident" id="2550681">forkExec</span><span class="op" id="2550689">(</span><span class="ident" id="2550690">argv0</span>&nbsp;<span class="builtintype" id="2550696">string</span><span class="op" id="2550702">,</span>&nbsp;<span class="ident" id="2550704">argv</span>&nbsp;<span class="op" id="2550709">[</span><span class="op" id="2550710">]</span><span class="builtintype" id="2550711">string</span><span class="op" id="2550717">,</span>&nbsp;<span class="ident" id="2550719">attr</span>&nbsp;<span class="op" id="2550724">*</span><span class="ident" id="2550725">ProcAttr</span><span class="op" id="2550733">)</span>&nbsp;<span class="op" id="2550735">(</span><span class="ident" id="2550736">pid</span>&nbsp;<span class="builtintype" id="2550740">int</span><span class="op" id="2550743">,</span>&nbsp;<span class="ident" id="2550745">err</span>&nbsp;<span class="builtintype" id="2550749">error</span><span class="op" id="2550754">)</span>&nbsp;<span class="op" id="2550756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2550759">var</span>&nbsp;<span class="ident" id="2550763">p</span>&nbsp;<span class="op" id="2550765">[</span><span class="num" id="2550766">2</span><span class="op" id="2550767">]</span><span class="builtintype" id="2550768">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2550773">var</span>&nbsp;<span class="ident" id="2550777">n</span>&nbsp;<span class="builtintype" id="2550779">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2550784">var</span>&nbsp;<span class="ident" id="2550788">err1</span>&nbsp;<span class="ident" id="2550793">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2550800">var</span>&nbsp;<span class="ident" id="2550804">wstatus</span>&nbsp;<span class="ident" id="2550812">WaitStatus</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2550825">if</span>&nbsp;<span class="ident" id="2550828">attr</span>&nbsp;<span class="op" id="2550833">==</span>&nbsp;<span class="ident" id="2550836">nil</span>&nbsp;<span class="op" id="2550840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550844">attr</span>&nbsp;<span class="op" id="2550849">=</span>&nbsp;<span class="op" id="2550851">&amp;</span><span class="ident" id="2550852">zeroProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2550866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550869">sys</span>&nbsp;<span class="op" id="2550873">:=</span>&nbsp;<span class="ident" id="2550876">attr</span><span class="op" id="2550880">.</span><span class="ident" id="2550881">Sys</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2550886">if</span>&nbsp;<span class="ident" id="2550889">sys</span>&nbsp;<span class="op" id="2550893">==</span>&nbsp;<span class="ident" id="2550896">nil</span>&nbsp;<span class="op" id="2550900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550904">sys</span>&nbsp;<span class="op" id="2550908">=</span>&nbsp;<span class="op" id="2550910">&amp;</span><span class="ident" id="2550911">zeroSysProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2550928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550932">p</span><span class="op" id="2550933">[</span><span class="num" id="2550934">0</span><span class="op" id="2550935">]</span>&nbsp;<span class="op" id="2550937">=</span>&nbsp;<span class="op" id="2550939">-</span><span class="num" id="2550940">1</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550943">p</span><span class="op" id="2550944">[</span><span class="num" id="2550945">1</span><span class="op" id="2550946">]</span>&nbsp;<span class="op" id="2550948">=</span>&nbsp;<span class="op" id="2550950">-</span><span class="num" id="2550951">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2550955">//&nbsp;Convert&nbsp;args&nbsp;to&nbsp;C&nbsp;form.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2550983">argv0p</span><span class="op" id="2550989">,</span>&nbsp;<span class="ident" id="2550991">err</span>&nbsp;<span class="op" id="2550995">:=</span>&nbsp;<span class="ident" id="2550998">BytePtrFromString</span><span class="op" id="2551015">(</span><span class="ident" id="2551016">argv0</span><span class="op" id="2551021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551024">if</span>&nbsp;<span class="ident" id="2551027">err</span>&nbsp;<span class="op" id="2551031">!=</span>&nbsp;<span class="ident" id="2551034">nil</span>&nbsp;<span class="op" id="2551038">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551042">return</span>&nbsp;<span class="num" id="2551049">0</span><span class="op" id="2551050">,</span>&nbsp;<span class="ident" id="2551052">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2551057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2551060">argvp</span><span class="op" id="2551065">,</span>&nbsp;<span class="ident" id="2551067">err</span>&nbsp;<span class="op" id="2551071">:=</span>&nbsp;<span class="ident" id="2551074">SlicePtrFromStrings</span><span class="op" id="2551093">(</span><span class="ident" id="2551094">argv</span><span class="op" id="2551098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551101">if</span>&nbsp;<span class="ident" id="2551104">err</span>&nbsp;<span class="op" id="2551108">!=</span>&nbsp;<span class="ident" id="2551111">nil</span>&nbsp;<span class="op" id="2551115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551119">return</span>&nbsp;<span class="num" id="2551126">0</span><span class="op" id="2551127">,</span>&nbsp;<span class="ident" id="2551129">err</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2551134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2551137">envvp</span><span class="op" id="2551142">,</span>&nbsp;<span class="ident" id="2551144">err</span>&nbsp;<span class="op" id="2551148">:=</span>&nbsp;<span class="ident" id="2551151">SlicePtrFromStrings</span><span class="op" id="2551170">(</span><span class="ident" id="2551171">attr</span><span class="op" id="2551175">.</span><span class="ident" id="2551176">Env</span><span class="op" id="2551179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551182">if</span>&nbsp;<span class="ident" id="2551185">err</span>&nbsp;<span class="op" id="2551189">!=</span>&nbsp;<span class="ident" id="2551192">nil</span>&nbsp;<span class="op" id="2551196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551200">return</span>&nbsp;<span class="num" id="2551207">0</span><span class="op" id="2551208">,</span>&nbsp;<span class="ident" id="2551210">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2551215">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551219">if</span>&nbsp;<span class="op" id="2551222">(</span><span class="ident" id="2551223">runtime</span><span class="op" id="2551230">.</span><span class="ident" id="2551231">GOOS</span>&nbsp;<span class="op" id="2551236">==</span>&nbsp;<span class="string" id="2551239">&#34;freebsd&#34;</span>&nbsp;<span class="op" id="2551249">||</span>&nbsp;<span class="ident" id="2551252">runtime</span><span class="op" id="2551259">.</span><span class="ident" id="2551260">GOOS</span>&nbsp;<span class="op" id="2551265">==</span>&nbsp;<span class="string" id="2551268">&#34;dragonfly&#34;</span><span class="op" id="2551279">)</span>&nbsp;<span class="op" id="2551281">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2551284">len</span><span class="op" id="2551287">(</span><span class="ident" id="2551288">argv</span><span class="op" id="2551292">[</span><span class="num" id="2551293">0</span><span class="op" id="2551294">]</span><span class="op" id="2551295">)</span>&nbsp;<span class="op" id="2551297">&gt;</span>&nbsp;<span class="builtinfunc" id="2551299">len</span><span class="op" id="2551302">(</span><span class="ident" id="2551303">argv0</span><span class="op" id="2551308">)</span>&nbsp;<span class="op" id="2551310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2551314">argvp</span><span class="op" id="2551319">[</span><span class="num" id="2551320">0</span><span class="op" id="2551321">]</span>&nbsp;<span class="op" id="2551323">=</span>&nbsp;<span class="ident" id="2551325">argv0p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2551333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551337">var</span>&nbsp;<span class="ident" id="2551341">chroot</span>&nbsp;<span class="op" id="2551348">*</span><span class="builtintype" id="2551349">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551355">if</span>&nbsp;<span class="ident" id="2551358">sys</span><span class="op" id="2551361">.</span><span class="ident" id="2551362">Chroot</span>&nbsp;<span class="op" id="2551369">!=</span>&nbsp;<span class="string" id="2551372">&#34;&#34;</span>&nbsp;<span class="op" id="2551375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2551379">chroot</span><span class="op" id="2551385">,</span>&nbsp;<span class="ident" id="2551387">err</span>&nbsp;<span class="op" id="2551391">=</span>&nbsp;<span class="ident" id="2551393">BytePtrFromString</span><span class="op" id="2551410">(</span><span class="ident" id="2551411">sys</span><span class="op" id="2551414">.</span><span class="ident" id="2551415">Chroot</span><span class="op" id="2551421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551425">if</span>&nbsp;<span class="ident" id="2551428">err</span>&nbsp;<span class="op" id="2551432">!=</span>&nbsp;<span class="ident" id="2551435">nil</span>&nbsp;<span class="op" id="2551439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551444">return</span>&nbsp;<span class="num" id="2551451">0</span><span class="op" id="2551452">,</span>&nbsp;<span class="ident" id="2551454">err</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2551460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2551463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551466">var</span>&nbsp;<span class="ident" id="2551470">dir</span>&nbsp;<span class="op" id="2551474">*</span><span class="builtintype" id="2551475">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551481">if</span>&nbsp;<span class="ident" id="2551484">attr</span><span class="op" id="2551488">.</span><span class="ident" id="2551489">Dir</span>&nbsp;<span class="op" id="2551493">!=</span>&nbsp;<span class="string" id="2551496">&#34;&#34;</span>&nbsp;<span class="op" id="2551499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2551503">dir</span><span class="op" id="2551506">,</span>&nbsp;<span class="ident" id="2551508">err</span>&nbsp;<span class="op" id="2551512">=</span>&nbsp;<span class="ident" id="2551514">BytePtrFromString</span><span class="op" id="2551531">(</span><span class="ident" id="2551532">attr</span><span class="op" id="2551536">.</span><span class="ident" id="2551537">Dir</span><span class="op" id="2551540">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551544">if</span>&nbsp;<span class="ident" id="2551547">err</span>&nbsp;<span class="op" id="2551551">!=</span>&nbsp;<span class="ident" id="2551554">nil</span>&nbsp;<span class="op" id="2551558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551563">return</span>&nbsp;<span class="num" id="2551570">0</span><span class="op" id="2551571">,</span>&nbsp;<span class="ident" id="2551573">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2551579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2551582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2551586">//&nbsp;Acquire&nbsp;the&nbsp;fork&nbsp;lock&nbsp;so&nbsp;that&nbsp;no&nbsp;other&nbsp;threads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2551637">//&nbsp;create&nbsp;new&nbsp;fds&nbsp;that&nbsp;are&nbsp;not&nbsp;yet&nbsp;close-on-exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2551687">//&nbsp;before&nbsp;we&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2551707">ForkLock</span><span class="op" id="2551715">.</span><span class="ident" id="2551716">Lock</span><span class="op" id="2551720">(</span><span class="op" id="2551721">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2551725">//&nbsp;Allocate&nbsp;child&nbsp;status&nbsp;pipe&nbsp;close&nbsp;on&nbsp;exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551771">if</span>&nbsp;<span class="ident" id="2551774">err</span>&nbsp;<span class="op" id="2551778">=</span>&nbsp;<span class="ident" id="2551780">forkExecPipe</span><span class="op" id="2551792">(</span><span class="ident" id="2551793">p</span><span class="op" id="2551794">[</span><span class="op" id="2551795">:</span><span class="op" id="2551796">]</span><span class="op" id="2551797">)</span><span class="op" id="2551798">;</span>&nbsp;<span class="ident" id="2551800">err</span>&nbsp;<span class="op" id="2551804">!=</span>&nbsp;<span class="ident" id="2551807">nil</span>&nbsp;<span class="op" id="2551811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551815">goto</span>&nbsp;<span class="builtintype" id="2551820">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2551827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2551831">//&nbsp;Kick&nbsp;off&nbsp;child.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2551851">pid</span><span class="op" id="2551854">,</span>&nbsp;<span class="ident" id="2551856">err1</span>&nbsp;<span class="op" id="2551861">=</span>&nbsp;<span class="ident" id="2551863">forkAndExecInChild</span><span class="op" id="2551881">(</span><span class="ident" id="2551882">argv0p</span><span class="op" id="2551888">,</span>&nbsp;<span class="ident" id="2551890">argvp</span><span class="op" id="2551895">,</span>&nbsp;<span class="ident" id="2551897">envvp</span><span class="op" id="2551902">,</span>&nbsp;<span class="ident" id="2551904">chroot</span><span class="op" id="2551910">,</span>&nbsp;<span class="ident" id="2551912">dir</span><span class="op" id="2551915">,</span>&nbsp;<span class="ident" id="2551917">attr</span><span class="op" id="2551921">,</span>&nbsp;<span class="ident" id="2551923">sys</span><span class="op" id="2551926">,</span>&nbsp;<span class="ident" id="2551928">p</span><span class="op" id="2551929">[</span><span class="num" id="2551930">1</span><span class="op" id="2551931">]</span><span class="op" id="2551932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551935">if</span>&nbsp;<span class="ident" id="2551938">err1</span>&nbsp;<span class="op" id="2551943">!=</span>&nbsp;<span class="num" id="2551946">0</span>&nbsp;<span class="op" id="2551948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2551952">err</span>&nbsp;<span class="op" id="2551956">=</span>&nbsp;<span class="ident" id="2551958">Errno</span><span class="op" id="2551963">(</span><span class="ident" id="2551964">err1</span><span class="op" id="2551968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2551972">goto</span>&nbsp;<span class="builtintype" id="2551977">error</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2551984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2551987">ForkLock</span><span class="op" id="2551995">.</span><span class="ident" id="2551996">Unlock</span><span class="op" id="2552002">(</span><span class="op" id="2552003">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2552007">//&nbsp;Read&nbsp;child&nbsp;error&nbsp;status&nbsp;from&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2552046">Close</span><span class="op" id="2552051">(</span><span class="ident" id="2552052">p</span><span class="op" id="2552053">[</span><span class="num" id="2552054">1</span><span class="op" id="2552055">]</span><span class="op" id="2552056">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2552059">n</span><span class="op" id="2552060">,</span>&nbsp;<span class="ident" id="2552062">err</span>&nbsp;<span class="op" id="2552066">=</span>&nbsp;<span class="ident" id="2552068">readlen</span><span class="op" id="2552075">(</span><span class="ident" id="2552076">p</span><span class="op" id="2552077">[</span><span class="num" id="2552078">0</span><span class="op" id="2552079">]</span><span class="op" id="2552080">,</span>&nbsp;<span class="op" id="2552082">(</span><span class="op" id="2552083">*</span><span class="builtintype" id="2552084">byte</span><span class="op" id="2552088">)</span><span class="op" id="2552089">(</span><span class="ident" id="2552090">unsafe</span><span class="op" id="2552096">.</span><span class="ident" id="2552097">Pointer</span><span class="op" id="2552104">(</span><span class="op" id="2552105">&amp;</span><span class="ident" id="2552106">err1</span><span class="op" id="2552110">)</span><span class="op" id="2552111">)</span><span class="op" id="2552112">,</span>&nbsp;<span class="builtintype" id="2552114">int</span><span class="op" id="2552117">(</span><span class="ident" id="2552118">unsafe</span><span class="op" id="2552124">.</span><span class="ident" id="2552125">Sizeof</span><span class="op" id="2552131">(</span><span class="ident" id="2552132">err1</span><span class="op" id="2552136">)</span><span class="op" id="2552137">)</span><span class="op" id="2552138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2552141">Close</span><span class="op" id="2552146">(</span><span class="ident" id="2552147">p</span><span class="op" id="2552148">[</span><span class="num" id="2552149">0</span><span class="op" id="2552150">]</span><span class="op" id="2552151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2552154">if</span>&nbsp;<span class="ident" id="2552157">err</span>&nbsp;<span class="op" id="2552161">!=</span>&nbsp;<span class="ident" id="2552164">nil</span>&nbsp;<span class="op" id="2552168">||</span>&nbsp;<span class="ident" id="2552171">n</span>&nbsp;<span class="op" id="2552173">!=</span>&nbsp;<span class="num" id="2552176">0</span>&nbsp;<span class="op" id="2552178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2552182">if</span>&nbsp;<span class="ident" id="2552185">n</span>&nbsp;<span class="op" id="2552187">==</span>&nbsp;<span class="builtintype" id="2552190">int</span><span class="op" id="2552193">(</span><span class="ident" id="2552194">unsafe</span><span class="op" id="2552200">.</span><span class="ident" id="2552201">Sizeof</span><span class="op" id="2552207">(</span><span class="ident" id="2552208">err1</span><span class="op" id="2552212">)</span><span class="op" id="2552213">)</span>&nbsp;<span class="op" id="2552215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2552220">err</span>&nbsp;<span class="op" id="2552224">=</span>&nbsp;<span class="ident" id="2552226">Errno</span><span class="op" id="2552231">(</span><span class="ident" id="2552232">err1</span><span class="op" id="2552236">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2552240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2552244">if</span>&nbsp;<span class="ident" id="2552247">err</span>&nbsp;<span class="op" id="2552251">==</span>&nbsp;<span class="ident" id="2552254">nil</span>&nbsp;<span class="op" id="2552258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2552263">err</span>&nbsp;<span class="op" id="2552267">=</span>&nbsp;<span class="ident" id="2552269">EPIPE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2552277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2552282">//&nbsp;Child&nbsp;failed;&nbsp;wait&nbsp;for&nbsp;it&nbsp;to&nbsp;exit,&nbsp;to&nbsp;make&nbsp;sure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2552335">//&nbsp;the&nbsp;zombies&nbsp;don&#39;t&nbsp;accumulate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2552370">_</span><span class="op" id="2552371">,</span>&nbsp;<span class="ident" id="2552373">err1</span>&nbsp;<span class="op" id="2552378">:=</span>&nbsp;<span class="ident" id="2552381">Wait4</span><span class="op" id="2552386">(</span><span class="ident" id="2552387">pid</span><span class="op" id="2552390">,</span>&nbsp;<span class="op" id="2552392">&amp;</span><span class="ident" id="2552393">wstatus</span><span class="op" id="2552400">,</span>&nbsp;<span class="num" id="2552402">0</span><span class="op" id="2552403">,</span>&nbsp;<span class="ident" id="2552405">nil</span><span class="op" id="2552408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2552412">for</span>&nbsp;<span class="ident" id="2552416">err1</span>&nbsp;<span class="op" id="2552421">==</span>&nbsp;<span class="ident" id="2552424">EINTR</span>&nbsp;<span class="op" id="2552430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2552435">_</span><span class="op" id="2552436">,</span>&nbsp;<span class="ident" id="2552438">err1</span>&nbsp;<span class="op" id="2552443">=</span>&nbsp;<span class="ident" id="2552445">Wait4</span><span class="op" id="2552450">(</span><span class="ident" id="2552451">pid</span><span class="op" id="2552454">,</span>&nbsp;<span class="op" id="2552456">&amp;</span><span class="ident" id="2552457">wstatus</span><span class="op" id="2552464">,</span>&nbsp;<span class="num" id="2552466">0</span><span class="op" id="2552467">,</span>&nbsp;<span class="ident" id="2552469">nil</span><span class="op" id="2552472">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2552476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2552480">return</span>&nbsp;<span class="num" id="2552487">0</span><span class="op" id="2552488">,</span>&nbsp;<span class="ident" id="2552490">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2552495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2552499">//&nbsp;Read&nbsp;got&nbsp;EOF,&nbsp;so&nbsp;pipe&nbsp;closed&nbsp;on&nbsp;exec,&nbsp;so&nbsp;exec&nbsp;succeeded.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2552560">return</span>&nbsp;<span class="ident" id="2552567">pid</span><span class="op" id="2552570">,</span>&nbsp;<span class="ident" id="2552572">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="builtintype" id="2552577">error</span><span class="op" id="2552582">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2552585">if</span>&nbsp;<span class="ident" id="2552588">p</span><span class="op" id="2552589">[</span><span class="num" id="2552590">0</span><span class="op" id="2552591">]</span>&nbsp;<span class="op" id="2552593">&gt;=</span>&nbsp;<span class="num" id="2552596">0</span>&nbsp;<span class="op" id="2552598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2552602">Close</span><span class="op" id="2552607">(</span><span class="ident" id="2552608">p</span><span class="op" id="2552609">[</span><span class="num" id="2552610">0</span><span class="op" id="2552611">]</span><span class="op" id="2552612">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2552616">Close</span><span class="op" id="2552621">(</span><span class="ident" id="2552622">p</span><span class="op" id="2552623">[</span><span class="num" id="2552624">1</span><span class="op" id="2552625">]</span><span class="op" id="2552626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2552629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2552632">ForkLock</span><span class="op" id="2552640">.</span><span class="ident" id="2552641">Unlock</span><span class="op" id="2552647">(</span><span class="op" id="2552648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2552651">return</span>&nbsp;<span class="num" id="2552658">0</span><span class="op" id="2552659">,</span>&nbsp;<span class="ident" id="2552661">err</span><br>
<span class="lineno"></span><span class="op" id="2552665">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="2552668">//&nbsp;Combination&nbsp;of&nbsp;fork&nbsp;and&nbsp;exec,&nbsp;careful&nbsp;to&nbsp;be&nbsp;thread&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="2552728">func</span>&nbsp;<span class="ident" id="2552733">ForkExec</span><span class="op" id="2552741">(</span><span class="ident" id="2552742">argv0</span>&nbsp;<span class="builtintype" id="2552748">string</span><span class="op" id="2552754">,</span>&nbsp;<span class="ident" id="2552756">argv</span>&nbsp;<span class="op" id="2552761">[</span><span class="op" id="2552762">]</span><span class="builtintype" id="2552763">string</span><span class="op" id="2552769">,</span>&nbsp;<span class="ident" id="2552771">attr</span>&nbsp;<span class="op" id="2552776">*</span><span class="ident" id="2552777">ProcAttr</span><span class="op" id="2552785">)</span>&nbsp;<span class="op" id="2552787">(</span><span class="ident" id="2552788">pid</span>&nbsp;<span class="builtintype" id="2552792">int</span><span class="op" id="2552795">,</span>&nbsp;<span class="ident" id="2552797">err</span>&nbsp;<span class="builtintype" id="2552801">error</span><span class="op" id="2552806">)</span>&nbsp;<span class="op" id="2552808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2552811">return</span>&nbsp;<span class="ident" id="2552818">forkExec</span><span class="op" id="2552826">(</span><span class="ident" id="2552827">argv0</span><span class="op" id="2552832">,</span>&nbsp;<span class="ident" id="2552834">argv</span><span class="op" id="2552838">,</span>&nbsp;<span class="ident" id="2552840">attr</span><span class="op" id="2552844">)</span><br>
<span class="lineno"></span><span class="op" id="2552846">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="2552849">//&nbsp;StartProcess&nbsp;wraps&nbsp;ForkExec&nbsp;for&nbsp;package&nbsp;os.</span><br>
<span class="lineno"></span><span class="keyword" id="2552896">func</span>&nbsp;<span class="ident" id="2552901">StartProcess</span><span class="op" id="2552913">(</span><span class="ident" id="2552914">argv0</span>&nbsp;<span class="builtintype" id="2552920">string</span><span class="op" id="2552926">,</span>&nbsp;<span class="ident" id="2552928">argv</span>&nbsp;<span class="op" id="2552933">[</span><span class="op" id="2552934">]</span><span class="builtintype" id="2552935">string</span><span class="op" id="2552941">,</span>&nbsp;<span class="ident" id="2552943">attr</span>&nbsp;<span class="op" id="2552948">*</span><span class="ident" id="2552949">ProcAttr</span><span class="op" id="2552957">)</span>&nbsp;<span class="op" id="2552959">(</span><span class="ident" id="2552960">pid</span>&nbsp;<span class="builtintype" id="2552964">int</span><span class="op" id="2552967">,</span>&nbsp;<span class="ident" id="2552969">handle</span>&nbsp;<span class="builtintype" id="2552976">uintptr</span><span class="op" id="2552983">,</span>&nbsp;<span class="ident" id="2552985">err</span>&nbsp;<span class="builtintype" id="2552989">error</span><span class="op" id="2552994">)</span>&nbsp;<span class="op" id="2552996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2552999">pid</span><span class="op" id="2553002">,</span>&nbsp;<span class="ident" id="2553004">err</span>&nbsp;<span class="op" id="2553008">=</span>&nbsp;<span class="ident" id="2553010">forkExec</span><span class="op" id="2553018">(</span><span class="ident" id="2553019">argv0</span><span class="op" id="2553024">,</span>&nbsp;<span class="ident" id="2553026">argv</span><span class="op" id="2553030">,</span>&nbsp;<span class="ident" id="2553032">attr</span><span class="op" id="2553036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2553039">return</span>&nbsp;<span class="ident" id="2553046">pid</span><span class="op" id="2553049">,</span>&nbsp;<span class="num" id="2553051">0</span><span class="op" id="2553052">,</span>&nbsp;<span class="ident" id="2553054">err</span><br>
<span class="lineno">240</span><span class="op" id="2553058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2553061">//&nbsp;Ordinary&nbsp;exec.</span><br>
<span class="lineno"></span><span class="keyword" id="2553079">func</span>&nbsp;<span class="ident" id="2553084">Exec</span><span class="op" id="2553088">(</span><span class="ident" id="2553089">argv0</span>&nbsp;<span class="builtintype" id="2553095">string</span><span class="op" id="2553101">,</span>&nbsp;<span class="ident" id="2553103">argv</span>&nbsp;<span class="op" id="2553108">[</span><span class="op" id="2553109">]</span><span class="builtintype" id="2553110">string</span><span class="op" id="2553116">,</span>&nbsp;<span class="ident" id="2553118">envv</span>&nbsp;<span class="op" id="2553123">[</span><span class="op" id="2553124">]</span><span class="builtintype" id="2553125">string</span><span class="op" id="2553131">)</span>&nbsp;<span class="op" id="2553133">(</span><span class="ident" id="2553134">err</span>&nbsp;<span class="builtintype" id="2553138">error</span><span class="op" id="2553143">)</span>&nbsp;<span class="op" id="2553145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2553148">argv0p</span><span class="op" id="2553154">,</span>&nbsp;<span class="ident" id="2553156">err</span>&nbsp;<span class="op" id="2553160">:=</span>&nbsp;<span class="ident" id="2553163">BytePtrFromString</span><span class="op" id="2553180">(</span><span class="ident" id="2553181">argv0</span><span class="op" id="2553186">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2553189">if</span>&nbsp;<span class="ident" id="2553192">err</span>&nbsp;<span class="op" id="2553196">!=</span>&nbsp;<span class="ident" id="2553199">nil</span>&nbsp;<span class="op" id="2553203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2553207">return</span>&nbsp;<span class="ident" id="2553214">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2553219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2553222">argvp</span><span class="op" id="2553227">,</span>&nbsp;<span class="ident" id="2553229">err</span>&nbsp;<span class="op" id="2553233">:=</span>&nbsp;<span class="ident" id="2553236">SlicePtrFromStrings</span><span class="op" id="2553255">(</span><span class="ident" id="2553256">argv</span><span class="op" id="2553260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2553263">if</span>&nbsp;<span class="ident" id="2553266">err</span>&nbsp;<span class="op" id="2553270">!=</span>&nbsp;<span class="ident" id="2553273">nil</span>&nbsp;<span class="op" id="2553277">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2553281">return</span>&nbsp;<span class="ident" id="2553288">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2553293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2553296">envvp</span><span class="op" id="2553301">,</span>&nbsp;<span class="ident" id="2553303">err</span>&nbsp;<span class="op" id="2553307">:=</span>&nbsp;<span class="ident" id="2553310">SlicePtrFromStrings</span><span class="op" id="2553329">(</span><span class="ident" id="2553330">envv</span><span class="op" id="2553334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2553337">if</span>&nbsp;<span class="ident" id="2553340">err</span>&nbsp;<span class="op" id="2553344">!=</span>&nbsp;<span class="ident" id="2553347">nil</span>&nbsp;<span class="op" id="2553351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2553355">return</span>&nbsp;<span class="ident" id="2553362">err</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2553367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2553370">_</span><span class="op" id="2553371">,</span>&nbsp;<span class="ident" id="2553373">_</span><span class="op" id="2553374">,</span>&nbsp;<span class="ident" id="2553376">err1</span>&nbsp;<span class="op" id="2553381">:=</span>&nbsp;<span class="ident" id="2553384">RawSyscall</span><span class="op" id="2553394">(</span><span class="ident" id="2553395">SYS_EXECVE</span><span class="op" id="2553405">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2553409">uintptr</span><span class="op" id="2553416">(</span><span class="ident" id="2553417">unsafe</span><span class="op" id="2553423">.</span><span class="ident" id="2553424">Pointer</span><span class="op" id="2553431">(</span><span class="ident" id="2553432">argv0p</span><span class="op" id="2553438">)</span><span class="op" id="2553439">)</span><span class="op" id="2553440">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2553444">uintptr</span><span class="op" id="2553451">(</span><span class="ident" id="2553452">unsafe</span><span class="op" id="2553458">.</span><span class="ident" id="2553459">Pointer</span><span class="op" id="2553466">(</span><span class="op" id="2553467">&amp;</span><span class="ident" id="2553468">argvp</span><span class="op" id="2553473">[</span><span class="num" id="2553474">0</span><span class="op" id="2553475">]</span><span class="op" id="2553476">)</span><span class="op" id="2553477">)</span><span class="op" id="2553478">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2553482">uintptr</span><span class="op" id="2553489">(</span><span class="ident" id="2553490">unsafe</span><span class="op" id="2553496">.</span><span class="ident" id="2553497">Pointer</span><span class="op" id="2553504">(</span><span class="op" id="2553505">&amp;</span><span class="ident" id="2553506">envvp</span><span class="op" id="2553511">[</span><span class="num" id="2553512">0</span><span class="op" id="2553513">]</span><span class="op" id="2553514">)</span><span class="op" id="2553515">)</span><span class="op" id="2553516">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2553519">return</span>&nbsp;<span class="ident" id="2553526">Errno</span><span class="op" id="2553531">(</span><span class="ident" id="2553532">err1</span><span class="op" id="2553536">)</span><br>
<span class="lineno"></span><span class="op" id="2553538">}</span>
</div>
</body>
</html>
