<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>archive/tar</h2>
<ul>
<li><a href="/gostd/archive/tar/common.go.html">common.go</a></li>
<li><a href="/gostd/archive/tar/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/archive/tar/reader.go.html">reader.go</a></li>
<li><a href="/gostd/archive/tar/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/archive/tar/stat_atim.go.html">stat_atim.go</a></li>
<li><a href="/gostd/archive/tar/stat_unix.go.html">stat_unix.go</a></li>
<li><a href="/gostd/archive/tar/tar_test.go.html">tar_test.go</a></li>
<li><a href="/gostd/archive/tar/writer.go.html">writer.go</a></li>
<li><a href="/gostd/archive/tar/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1360801">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1360856">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1360910">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1360961">package</span>&nbsp;<span class="ident" id="1360969">tar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1360974">//&nbsp;TODO(dsymonds):</span><br>
<span class="lineno"></span><span class="comment" id="1360993">//&nbsp;-&nbsp;catch&nbsp;more&nbsp;errors&nbsp;(no&nbsp;first&nbsp;header,&nbsp;etc.)</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1361041">import</span>&nbsp;<span class="op" id="1361048">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1361051">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1361060">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1361070">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1361077">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1361083">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1361089">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1361097">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1361108">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1361119">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="1361126">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1361129">var</span>&nbsp;<span class="op" id="1361133">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361136">ErrWriteTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1361155">=</span>&nbsp;<span class="ident" id="1361157">errors</span><span class="op" id="1361163">.</span><span class="ident" id="1361164">New</span><span class="op" id="1361167">(</span><span class="string" id="1361168">&#34;archive/tar:&nbsp;write&nbsp;too&nbsp;long&#34;</span><span class="op" id="1361197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361200">ErrFieldTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1361219">=</span>&nbsp;<span class="ident" id="1361221">errors</span><span class="op" id="1361227">.</span><span class="ident" id="1361228">New</span><span class="op" id="1361231">(</span><span class="string" id="1361232">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&#34;</span><span class="op" id="1361268">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361271">ErrWriteAfterClose</span>&nbsp;<span class="op" id="1361290">=</span>&nbsp;<span class="ident" id="1361292">errors</span><span class="op" id="1361298">.</span><span class="ident" id="1361299">New</span><span class="op" id="1361302">(</span><span class="string" id="1361303">&#34;archive/tar:&nbsp;write&nbsp;after&nbsp;close&#34;</span><span class="op" id="1361335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361338">errNameTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1361357">=</span>&nbsp;<span class="ident" id="1361359">errors</span><span class="op" id="1361365">.</span><span class="ident" id="1361366">New</span><span class="op" id="1361369">(</span><span class="string" id="1361370">&#34;archive/tar:&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="1361398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361401">errInvalidHeader</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1361420">=</span>&nbsp;<span class="ident" id="1361422">errors</span><span class="op" id="1361428">.</span><span class="ident" id="1361429">New</span><span class="op" id="1361432">(</span><span class="string" id="1361433">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&nbsp;or&nbsp;contains&nbsp;invalid&nbsp;values&#34;</span><span class="op" id="1361496">)</span><br>
<span class="lineno"></span><span class="op" id="1361498">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="comment" id="1361501">//&nbsp;A&nbsp;Writer&nbsp;provides&nbsp;sequential&nbsp;writing&nbsp;of&nbsp;a&nbsp;tar&nbsp;archive&nbsp;in&nbsp;POSIX.1&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="1361577">//&nbsp;A&nbsp;tar&nbsp;archive&nbsp;consists&nbsp;of&nbsp;a&nbsp;sequence&nbsp;of&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="1361627">//&nbsp;Call&nbsp;WriteHeader&nbsp;to&nbsp;begin&nbsp;a&nbsp;new&nbsp;file,&nbsp;and&nbsp;then&nbsp;call&nbsp;Write&nbsp;to&nbsp;supply&nbsp;that&nbsp;file&#39;s&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="1361716">//&nbsp;writing&nbsp;at&nbsp;most&nbsp;hdr.Size&nbsp;bytes&nbsp;in&nbsp;total.</span><br>
<span class="lineno"></span><span class="keyword" id="1361760">type</span>&nbsp;<span class="ident" id="1361765">Writer</span>&nbsp;<span class="keyword" id="1361772">struct</span>&nbsp;<span class="op" id="1361779">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361782">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1361793">io</span><span class="op" id="1361795">.</span><span class="ident" id="1361796">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361804">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1361815">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361822">nb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1361833">int64</span>&nbsp;<span class="comment" id="1361839">//&nbsp;number&nbsp;of&nbsp;unwritten&nbsp;bytes&nbsp;for&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361892">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1361903">int64</span>&nbsp;<span class="comment" id="1361909">//&nbsp;amount&nbsp;of&nbsp;padding&nbsp;to&nbsp;write&nbsp;after&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361965">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1361976">bool</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361982">usedBinary</span>&nbsp;<span class="builtintype" id="1361993">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1362009">//&nbsp;whether&nbsp;the&nbsp;binary&nbsp;numeric&nbsp;field&nbsp;extension&nbsp;was&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1362065">preferPax</span>&nbsp;&nbsp;<span class="builtintype" id="1362076">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1362092">//&nbsp;use&nbsp;pax&nbsp;header&nbsp;instead&nbsp;of&nbsp;binary&nbsp;numeric&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1362144">hdrBuff</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1362155">[</span><span class="ident" id="1362156">blockSize</span><span class="op" id="1362165">]</span><span class="builtintype" id="1362166">byte</span>&nbsp;<span class="comment" id="1362171">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;regular&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1362234">paxHdrBuff</span>&nbsp;<span class="op" id="1362245">[</span><span class="ident" id="1362246">blockSize</span><span class="op" id="1362255">]</span><span class="builtintype" id="1362256">byte</span>&nbsp;<span class="comment" id="1362261">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span><span class="op" id="1362319">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="1362322">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;Writer&nbsp;writing&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="1362370">func</span>&nbsp;<span class="ident" id="1362375">NewWriter</span><span class="op" id="1362384">(</span><span class="ident" id="1362385">w</span>&nbsp;<span class="ident" id="1362387">io</span><span class="op" id="1362389">.</span><span class="ident" id="1362390">Writer</span><span class="op" id="1362396">)</span>&nbsp;<span class="op" id="1362398">*</span><span class="ident" id="1362399">Writer</span>&nbsp;<span class="op" id="1362406">{</span>&nbsp;<span class="keyword" id="1362408">return</span>&nbsp;<span class="op" id="1362415">&amp;</span><span class="ident" id="1362416">Writer</span><span class="op" id="1362422">{</span><span class="ident" id="1362423">w</span><span class="op" id="1362424">:</span>&nbsp;<span class="ident" id="1362426">w</span><span class="op" id="1362427">}</span>&nbsp;<span class="op" id="1362429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1362432">//&nbsp;Flush&nbsp;finishes&nbsp;writing&nbsp;the&nbsp;current&nbsp;file&nbsp;(optional).</span><br>
<span class="lineno">50</span><span class="keyword" id="1362487">func</span>&nbsp;<span class="op" id="1362492">(</span><span class="ident" id="1362493">tw</span>&nbsp;<span class="op" id="1362496">*</span><span class="ident" id="1362497">Writer</span><span class="op" id="1362503">)</span>&nbsp;<span class="ident" id="1362505">Flush</span><span class="op" id="1362510">(</span><span class="op" id="1362511">)</span>&nbsp;<span class="builtintype" id="1362513">error</span>&nbsp;<span class="op" id="1362519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1362522">if</span>&nbsp;<span class="ident" id="1362525">tw</span><span class="op" id="1362527">.</span><span class="ident" id="1362528">nb</span>&nbsp;<span class="op" id="1362531">&gt;</span>&nbsp;<span class="num" id="1362533">0</span>&nbsp;<span class="op" id="1362535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1362539">tw</span><span class="op" id="1362541">.</span><span class="ident" id="1362542">err</span>&nbsp;<span class="op" id="1362546">=</span>&nbsp;<span class="ident" id="1362548">fmt</span><span class="op" id="1362551">.</span><span class="ident" id="1362552">Errorf</span><span class="op" id="1362558">(</span><span class="string" id="1362559">&#34;archive/tar:&nbsp;missed&nbsp;writing&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="1362597">,</span>&nbsp;<span class="ident" id="1362599">tw</span><span class="op" id="1362601">.</span><span class="ident" id="1362602">nb</span><span class="op" id="1362604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1362608">return</span>&nbsp;<span class="ident" id="1362615">tw</span><span class="op" id="1362617">.</span><span class="ident" id="1362618">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1362623">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1362627">n</span>&nbsp;<span class="op" id="1362629">:=</span>&nbsp;<span class="ident" id="1362632">tw</span><span class="op" id="1362634">.</span><span class="ident" id="1362635">nb</span>&nbsp;<span class="op" id="1362638">+</span>&nbsp;<span class="ident" id="1362640">tw</span><span class="op" id="1362642">.</span><span class="ident" id="1362643">pad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1362648">for</span>&nbsp;<span class="ident" id="1362652">n</span>&nbsp;<span class="op" id="1362654">&gt;</span>&nbsp;<span class="num" id="1362656">0</span>&nbsp;<span class="op" id="1362658">&amp;&amp;</span>&nbsp;<span class="ident" id="1362661">tw</span><span class="op" id="1362663">.</span><span class="ident" id="1362664">err</span>&nbsp;<span class="op" id="1362668">==</span>&nbsp;<span class="ident" id="1362671">nil</span>&nbsp;<span class="op" id="1362675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1362679">nr</span>&nbsp;<span class="op" id="1362682">:=</span>&nbsp;<span class="ident" id="1362685">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1362689">if</span>&nbsp;<span class="ident" id="1362692">nr</span>&nbsp;<span class="op" id="1362695">&gt;</span>&nbsp;<span class="ident" id="1362697">blockSize</span>&nbsp;<span class="op" id="1362707">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1362712">nr</span>&nbsp;<span class="op" id="1362715">=</span>&nbsp;<span class="ident" id="1362717">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1362729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1362733">var</span>&nbsp;<span class="ident" id="1362737">nw</span>&nbsp;<span class="builtintype" id="1362740">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1362746">nw</span><span class="op" id="1362748">,</span>&nbsp;<span class="ident" id="1362750">tw</span><span class="op" id="1362752">.</span><span class="ident" id="1362753">err</span>&nbsp;<span class="op" id="1362757">=</span>&nbsp;<span class="ident" id="1362759">tw</span><span class="op" id="1362761">.</span><span class="ident" id="1362762">w</span><span class="op" id="1362763">.</span><span class="ident" id="1362764">Write</span><span class="op" id="1362769">(</span><span class="ident" id="1362770">zeroBlock</span><span class="op" id="1362779">[</span><span class="num" id="1362780">0</span><span class="op" id="1362781">:</span><span class="ident" id="1362782">nr</span><span class="op" id="1362784">]</span><span class="op" id="1362785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1362789">n</span>&nbsp;<span class="op" id="1362791">-=</span>&nbsp;<span class="ident" id="1362794">int64</span><span class="op" id="1362799">(</span><span class="ident" id="1362800">nw</span><span class="op" id="1362802">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1362805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1362808">tw</span><span class="op" id="1362810">.</span><span class="ident" id="1362811">nb</span>&nbsp;<span class="op" id="1362814">=</span>&nbsp;<span class="num" id="1362816">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1362819">tw</span><span class="op" id="1362821">.</span><span class="ident" id="1362822">pad</span>&nbsp;<span class="op" id="1362826">=</span>&nbsp;<span class="num" id="1362828">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1362831">return</span>&nbsp;<span class="ident" id="1362838">tw</span><span class="op" id="1362840">.</span><span class="ident" id="1362841">err</span><br>
<span class="lineno"></span><span class="op" id="1362845">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="1362848">//&nbsp;Write&nbsp;s&nbsp;into&nbsp;b,&nbsp;terminating&nbsp;it&nbsp;with&nbsp;a&nbsp;NUL&nbsp;if&nbsp;there&nbsp;is&nbsp;room.</span><br>
<span class="lineno"></span><span class="comment" id="1362911">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;allowPax&nbsp;is&nbsp;true&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="1363005">func</span>&nbsp;<span class="op" id="1363010">(</span><span class="ident" id="1363011">tw</span>&nbsp;<span class="op" id="1363014">*</span><span class="ident" id="1363015">Writer</span><span class="op" id="1363021">)</span>&nbsp;<span class="ident" id="1363023">cString</span><span class="op" id="1363030">(</span><span class="ident" id="1363031">b</span>&nbsp;<span class="op" id="1363033">[</span><span class="op" id="1363034">]</span><span class="builtintype" id="1363035">byte</span><span class="op" id="1363039">,</span>&nbsp;<span class="ident" id="1363041">s</span>&nbsp;<span class="builtintype" id="1363043">string</span><span class="op" id="1363049">,</span>&nbsp;<span class="ident" id="1363051">allowPax</span>&nbsp;<span class="builtintype" id="1363060">bool</span><span class="op" id="1363064">,</span>&nbsp;<span class="ident" id="1363066">paxKeyword</span>&nbsp;<span class="builtintype" id="1363077">string</span><span class="op" id="1363083">,</span>&nbsp;<span class="ident" id="1363085">paxHeaders</span>&nbsp;<span class="keyword" id="1363096">map</span><span class="op" id="1363099">[</span><span class="builtintype" id="1363100">string</span><span class="op" id="1363106">]</span><span class="builtintype" id="1363107">string</span><span class="op" id="1363113">)</span>&nbsp;<span class="op" id="1363115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363118">needsPaxHeader</span>&nbsp;<span class="op" id="1363133">:=</span>&nbsp;<span class="ident" id="1363136">allowPax</span>&nbsp;<span class="op" id="1363145">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="1363148">len</span><span class="op" id="1363151">(</span><span class="ident" id="1363152">s</span><span class="op" id="1363153">)</span>&nbsp;<span class="op" id="1363155">&gt;</span>&nbsp;<span class="builtinfunc" id="1363157">len</span><span class="op" id="1363160">(</span><span class="ident" id="1363161">b</span><span class="op" id="1363162">)</span>&nbsp;<span class="op" id="1363164">||</span>&nbsp;<span class="op" id="1363167">!</span><span class="ident" id="1363168">isASCII</span><span class="op" id="1363175">(</span><span class="ident" id="1363176">s</span><span class="op" id="1363177">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363180">if</span>&nbsp;<span class="ident" id="1363183">needsPaxHeader</span>&nbsp;<span class="op" id="1363198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363202">paxHeaders</span><span class="op" id="1363212">[</span><span class="ident" id="1363213">paxKeyword</span><span class="op" id="1363223">]</span>&nbsp;<span class="op" id="1363225">=</span>&nbsp;<span class="ident" id="1363227">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363231">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1363239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363242">if</span>&nbsp;<span class="builtinfunc" id="1363245">len</span><span class="op" id="1363248">(</span><span class="ident" id="1363249">s</span><span class="op" id="1363250">)</span>&nbsp;<span class="op" id="1363252">&gt;</span>&nbsp;<span class="builtinfunc" id="1363254">len</span><span class="op" id="1363257">(</span><span class="ident" id="1363258">b</span><span class="op" id="1363259">)</span>&nbsp;<span class="op" id="1363261">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363265">if</span>&nbsp;<span class="ident" id="1363268">tw</span><span class="op" id="1363270">.</span><span class="ident" id="1363271">err</span>&nbsp;<span class="op" id="1363275">==</span>&nbsp;<span class="ident" id="1363278">nil</span>&nbsp;<span class="op" id="1363282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363287">tw</span><span class="op" id="1363289">.</span><span class="ident" id="1363290">err</span>&nbsp;<span class="op" id="1363294">=</span>&nbsp;<span class="ident" id="1363296">ErrFieldTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1363314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363318">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1363326">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363329">ascii</span>&nbsp;<span class="op" id="1363335">:=</span>&nbsp;<span class="ident" id="1363338">toASCII</span><span class="op" id="1363345">(</span><span class="ident" id="1363346">s</span><span class="op" id="1363347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1363350">copy</span><span class="op" id="1363354">(</span><span class="ident" id="1363355">b</span><span class="op" id="1363356">,</span>&nbsp;<span class="ident" id="1363358">ascii</span><span class="op" id="1363363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363366">if</span>&nbsp;<span class="builtinfunc" id="1363369">len</span><span class="op" id="1363372">(</span><span class="ident" id="1363373">ascii</span><span class="op" id="1363378">)</span>&nbsp;<span class="op" id="1363380">&lt;</span>&nbsp;<span class="builtinfunc" id="1363382">len</span><span class="op" id="1363385">(</span><span class="ident" id="1363386">b</span><span class="op" id="1363387">)</span>&nbsp;<span class="op" id="1363389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363393">b</span><span class="op" id="1363394">[</span><span class="builtinfunc" id="1363395">len</span><span class="op" id="1363398">(</span><span class="ident" id="1363399">ascii</span><span class="op" id="1363404">)</span><span class="op" id="1363405">]</span>&nbsp;<span class="op" id="1363407">=</span>&nbsp;<span class="num" id="1363409">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1363412">}</span><br>
<span class="lineno">90</span><span class="op" id="1363414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1363417">//&nbsp;Encode&nbsp;x&nbsp;as&nbsp;an&nbsp;octal&nbsp;ASCII&nbsp;string&nbsp;and&nbsp;write&nbsp;it&nbsp;into&nbsp;b&nbsp;with&nbsp;leading&nbsp;zeros.</span><br>
<span class="lineno"></span><span class="keyword" id="1363494">func</span>&nbsp;<span class="op" id="1363499">(</span><span class="ident" id="1363500">tw</span>&nbsp;<span class="op" id="1363503">*</span><span class="ident" id="1363504">Writer</span><span class="op" id="1363510">)</span>&nbsp;<span class="ident" id="1363512">octal</span><span class="op" id="1363517">(</span><span class="ident" id="1363518">b</span>&nbsp;<span class="op" id="1363520">[</span><span class="op" id="1363521">]</span><span class="builtintype" id="1363522">byte</span><span class="op" id="1363526">,</span>&nbsp;<span class="ident" id="1363528">x</span>&nbsp;<span class="ident" id="1363530">int64</span><span class="op" id="1363535">)</span>&nbsp;<span class="op" id="1363537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363540">s</span>&nbsp;<span class="op" id="1363542">:=</span>&nbsp;<span class="ident" id="1363545">strconv</span><span class="op" id="1363552">.</span><span class="ident" id="1363553">FormatInt</span><span class="op" id="1363562">(</span><span class="ident" id="1363563">x</span><span class="op" id="1363564">,</span>&nbsp;<span class="num" id="1363566">8</span><span class="op" id="1363567">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1363570">//&nbsp;leading&nbsp;zeros,&nbsp;but&nbsp;leave&nbsp;room&nbsp;for&nbsp;a&nbsp;NUL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363615">for</span>&nbsp;<span class="builtinfunc" id="1363619">len</span><span class="op" id="1363622">(</span><span class="ident" id="1363623">s</span><span class="op" id="1363624">)</span><span class="op" id="1363625">+</span><span class="num" id="1363626">1</span>&nbsp;<span class="op" id="1363628">&lt;</span>&nbsp;<span class="builtinfunc" id="1363630">len</span><span class="op" id="1363633">(</span><span class="ident" id="1363634">b</span><span class="op" id="1363635">)</span>&nbsp;<span class="op" id="1363637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363641">s</span>&nbsp;<span class="op" id="1363643">=</span>&nbsp;<span class="string" id="1363645">&#34;0&#34;</span>&nbsp;<span class="op" id="1363649">+</span>&nbsp;<span class="ident" id="1363651">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1363654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363657">tw</span><span class="op" id="1363659">.</span><span class="ident" id="1363660">cString</span><span class="op" id="1363667">(</span><span class="ident" id="1363668">b</span><span class="op" id="1363669">,</span>&nbsp;<span class="ident" id="1363671">s</span><span class="op" id="1363672">,</span>&nbsp;<span class="builtintype" id="1363674">false</span><span class="op" id="1363679">,</span>&nbsp;<span class="ident" id="1363681">paxNone</span><span class="op" id="1363688">,</span>&nbsp;<span class="ident" id="1363690">nil</span><span class="op" id="1363693">)</span><br>
<span class="lineno">100</span><span class="op" id="1363695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1363698">//&nbsp;Write&nbsp;x&nbsp;into&nbsp;b,&nbsp;either&nbsp;as&nbsp;octal&nbsp;or&nbsp;as&nbsp;binary&nbsp;(GNUtar/star&nbsp;extension).</span><br>
<span class="lineno"></span><span class="comment" id="1363771">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;writingPax&nbsp;is&nbsp;enabled&nbsp;both&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;the&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="1363897">func</span>&nbsp;<span class="op" id="1363902">(</span><span class="ident" id="1363903">tw</span>&nbsp;<span class="op" id="1363906">*</span><span class="ident" id="1363907">Writer</span><span class="op" id="1363913">)</span>&nbsp;<span class="ident" id="1363915">numeric</span><span class="op" id="1363922">(</span><span class="ident" id="1363923">b</span>&nbsp;<span class="op" id="1363925">[</span><span class="op" id="1363926">]</span><span class="builtintype" id="1363927">byte</span><span class="op" id="1363931">,</span>&nbsp;<span class="ident" id="1363933">x</span>&nbsp;<span class="ident" id="1363935">int64</span><span class="op" id="1363940">,</span>&nbsp;<span class="ident" id="1363942">allowPax</span>&nbsp;<span class="builtintype" id="1363951">bool</span><span class="op" id="1363955">,</span>&nbsp;<span class="ident" id="1363957">paxKeyword</span>&nbsp;<span class="builtintype" id="1363968">string</span><span class="op" id="1363974">,</span>&nbsp;<span class="ident" id="1363976">paxHeaders</span>&nbsp;<span class="keyword" id="1363987">map</span><span class="op" id="1363990">[</span><span class="builtintype" id="1363991">string</span><span class="op" id="1363997">]</span><span class="builtintype" id="1363998">string</span><span class="op" id="1364004">)</span>&nbsp;<span class="op" id="1364006">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1364009">//&nbsp;Try&nbsp;octal&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364030">s</span>&nbsp;<span class="op" id="1364032">:=</span>&nbsp;<span class="ident" id="1364035">strconv</span><span class="op" id="1364042">.</span><span class="ident" id="1364043">FormatInt</span><span class="op" id="1364052">(</span><span class="ident" id="1364053">x</span><span class="op" id="1364054">,</span>&nbsp;<span class="num" id="1364056">8</span><span class="op" id="1364057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364060">if</span>&nbsp;<span class="builtinfunc" id="1364063">len</span><span class="op" id="1364066">(</span><span class="ident" id="1364067">s</span><span class="op" id="1364068">)</span>&nbsp;<span class="op" id="1364070">&lt;</span>&nbsp;<span class="builtinfunc" id="1364072">len</span><span class="op" id="1364075">(</span><span class="ident" id="1364076">b</span><span class="op" id="1364077">)</span>&nbsp;<span class="op" id="1364079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364083">tw</span><span class="op" id="1364085">.</span><span class="ident" id="1364086">octal</span><span class="op" id="1364091">(</span><span class="ident" id="1364092">b</span><span class="op" id="1364093">,</span>&nbsp;<span class="ident" id="1364095">x</span><span class="op" id="1364096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364100">return</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1364108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1364112">//&nbsp;If&nbsp;it&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;octal,&nbsp;and&nbsp;pax&nbsp;is&nbsp;preferred,&nbsp;use&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364184">if</span>&nbsp;<span class="ident" id="1364187">allowPax</span>&nbsp;<span class="op" id="1364196">&amp;&amp;</span>&nbsp;<span class="ident" id="1364199">tw</span><span class="op" id="1364201">.</span><span class="ident" id="1364202">preferPax</span>&nbsp;<span class="op" id="1364212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364216">tw</span><span class="op" id="1364218">.</span><span class="ident" id="1364219">octal</span><span class="op" id="1364224">(</span><span class="ident" id="1364225">b</span><span class="op" id="1364226">,</span>&nbsp;<span class="num" id="1364228">0</span><span class="op" id="1364229">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364233">s</span>&nbsp;<span class="op" id="1364235">:=</span>&nbsp;<span class="ident" id="1364238">strconv</span><span class="op" id="1364245">.</span><span class="ident" id="1364246">FormatInt</span><span class="op" id="1364255">(</span><span class="ident" id="1364256">x</span><span class="op" id="1364257">,</span>&nbsp;<span class="num" id="1364259">10</span><span class="op" id="1364261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364265">paxHeaders</span><span class="op" id="1364275">[</span><span class="ident" id="1364276">paxKeyword</span><span class="op" id="1364286">]</span>&nbsp;<span class="op" id="1364288">=</span>&nbsp;<span class="ident" id="1364290">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364294">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1364302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1364306">//&nbsp;Too&nbsp;big:&nbsp;use&nbsp;binary&nbsp;(big-endian).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364344">tw</span><span class="op" id="1364346">.</span><span class="ident" id="1364347">usedBinary</span>&nbsp;<span class="op" id="1364358">=</span>&nbsp;<span class="builtintype" id="1364360">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364366">for</span>&nbsp;<span class="ident" id="1364370">i</span>&nbsp;<span class="op" id="1364372">:=</span>&nbsp;<span class="builtinfunc" id="1364375">len</span><span class="op" id="1364378">(</span><span class="ident" id="1364379">b</span><span class="op" id="1364380">)</span>&nbsp;<span class="op" id="1364382">-</span>&nbsp;<span class="num" id="1364384">1</span><span class="op" id="1364385">;</span>&nbsp;<span class="ident" id="1364387">x</span>&nbsp;<span class="op" id="1364389">&gt;</span>&nbsp;<span class="num" id="1364391">0</span>&nbsp;<span class="op" id="1364393">&amp;&amp;</span>&nbsp;<span class="ident" id="1364396">i</span>&nbsp;<span class="op" id="1364398">&gt;=</span>&nbsp;<span class="num" id="1364401">0</span><span class="op" id="1364402">;</span>&nbsp;<span class="ident" id="1364404">i</span><span class="op" id="1364405">--</span>&nbsp;<span class="op" id="1364408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364412">b</span><span class="op" id="1364413">[</span><span class="ident" id="1364414">i</span><span class="op" id="1364415">]</span>&nbsp;<span class="op" id="1364417">=</span>&nbsp;<span class="builtintype" id="1364419">byte</span><span class="op" id="1364423">(</span><span class="ident" id="1364424">x</span><span class="op" id="1364425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364429">x</span>&nbsp;<span class="op" id="1364431">&gt;&gt;=</span>&nbsp;<span class="num" id="1364435">8</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1364438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364441">b</span><span class="op" id="1364442">[</span><span class="num" id="1364443">0</span><span class="op" id="1364444">]</span>&nbsp;<span class="op" id="1364446">|=</span>&nbsp;<span class="num" id="1364449">0x80</span>&nbsp;<span class="comment" id="1364454">//&nbsp;highest&nbsp;bit&nbsp;indicates&nbsp;binary&nbsp;format</span><br>
<span class="lineno"></span><span class="op" id="1364493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1364496">var</span>&nbsp;<span class="op" id="1364500">(</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364503">minTime</span>&nbsp;<span class="op" id="1364511">=</span>&nbsp;<span class="ident" id="1364513">time</span><span class="op" id="1364517">.</span><span class="ident" id="1364518">Unix</span><span class="op" id="1364522">(</span><span class="num" id="1364523">0</span><span class="op" id="1364524">,</span>&nbsp;<span class="num" id="1364526">0</span><span class="op" id="1364527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1364530">//&nbsp;There&nbsp;is&nbsp;room&nbsp;for&nbsp;11&nbsp;octal&nbsp;digits&nbsp;(33&nbsp;bits)&nbsp;of&nbsp;mtime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364588">maxTime</span>&nbsp;<span class="op" id="1364596">=</span>&nbsp;<span class="ident" id="1364598">minTime</span><span class="op" id="1364605">.</span><span class="ident" id="1364606">Add</span><span class="op" id="1364609">(</span><span class="op" id="1364610">(</span><span class="num" id="1364611">1</span><span class="op" id="1364612">&lt;&lt;</span><span class="num" id="1364614">33</span>&nbsp;<span class="op" id="1364617">-</span>&nbsp;<span class="num" id="1364619">1</span><span class="op" id="1364620">)</span>&nbsp;<span class="op" id="1364622">*</span>&nbsp;<span class="ident" id="1364624">time</span><span class="op" id="1364628">.</span><span class="ident" id="1364629">Second</span><span class="op" id="1364635">)</span><br>
<span class="lineno"></span><span class="op" id="1364637">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="comment" id="1364640">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="1364710">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="1364768">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno"></span><span class="keyword" id="1364825">func</span>&nbsp;<span class="op" id="1364830">(</span><span class="ident" id="1364831">tw</span>&nbsp;<span class="op" id="1364834">*</span><span class="ident" id="1364835">Writer</span><span class="op" id="1364841">)</span>&nbsp;<span class="ident" id="1364843">WriteHeader</span><span class="op" id="1364854">(</span><span class="ident" id="1364855">hdr</span>&nbsp;<span class="op" id="1364859">*</span><span class="ident" id="1364860">Header</span><span class="op" id="1364866">)</span>&nbsp;<span class="builtintype" id="1364868">error</span>&nbsp;<span class="op" id="1364874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364877">return</span>&nbsp;<span class="ident" id="1364884">tw</span><span class="op" id="1364886">.</span><span class="ident" id="1364887">writeHeader</span><span class="op" id="1364898">(</span><span class="ident" id="1364899">hdr</span><span class="op" id="1364902">,</span>&nbsp;<span class="builtintype" id="1364904">true</span><span class="op" id="1364908">)</span><br>
<span class="lineno">140</span><span class="op" id="1364910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1364913">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="1364983">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="1365041">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno">145</span><span class="comment" id="1365098">//&nbsp;As&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;internally&nbsp;by&nbsp;writePax&nbsp;header&nbsp;to&nbsp;allow&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1365171">//&nbsp;suppress&nbsp;writing&nbsp;the&nbsp;pax&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="1365207">func</span>&nbsp;<span class="op" id="1365212">(</span><span class="ident" id="1365213">tw</span>&nbsp;<span class="op" id="1365216">*</span><span class="ident" id="1365217">Writer</span><span class="op" id="1365223">)</span>&nbsp;<span class="ident" id="1365225">writeHeader</span><span class="op" id="1365236">(</span><span class="ident" id="1365237">hdr</span>&nbsp;<span class="op" id="1365241">*</span><span class="ident" id="1365242">Header</span><span class="op" id="1365248">,</span>&nbsp;<span class="ident" id="1365250">allowPax</span>&nbsp;<span class="builtintype" id="1365259">bool</span><span class="op" id="1365263">)</span>&nbsp;<span class="builtintype" id="1365265">error</span>&nbsp;<span class="op" id="1365271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365274">if</span>&nbsp;<span class="ident" id="1365277">tw</span><span class="op" id="1365279">.</span><span class="ident" id="1365280">closed</span>&nbsp;<span class="op" id="1365287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365291">return</span>&nbsp;<span class="ident" id="1365298">ErrWriteAfterClose</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1365318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365321">if</span>&nbsp;<span class="ident" id="1365324">tw</span><span class="op" id="1365326">.</span><span class="ident" id="1365327">err</span>&nbsp;<span class="op" id="1365331">==</span>&nbsp;<span class="ident" id="1365334">nil</span>&nbsp;<span class="op" id="1365338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365342">tw</span><span class="op" id="1365344">.</span><span class="ident" id="1365345">Flush</span><span class="op" id="1365350">(</span><span class="op" id="1365351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1365354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365357">if</span>&nbsp;<span class="ident" id="1365360">tw</span><span class="op" id="1365362">.</span><span class="ident" id="1365363">err</span>&nbsp;<span class="op" id="1365367">!=</span>&nbsp;<span class="ident" id="1365370">nil</span>&nbsp;<span class="op" id="1365374">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365378">return</span>&nbsp;<span class="ident" id="1365385">tw</span><span class="op" id="1365387">.</span><span class="ident" id="1365388">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1365393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365397">//&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;pax&nbsp;header&nbsp;records,&nbsp;if&nbsp;any&nbsp;are&nbsp;needed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365453">paxHeaders</span>&nbsp;<span class="op" id="1365464">:=</span>&nbsp;<span class="builtinfunc" id="1365467">make</span><span class="op" id="1365471">(</span><span class="keyword" id="1365472">map</span><span class="op" id="1365475">[</span><span class="builtintype" id="1365476">string</span><span class="op" id="1365482">]</span><span class="builtintype" id="1365483">string</span><span class="op" id="1365489">)</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365493">//&nbsp;TODO(shanemhansen):&nbsp;we&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;PAX&nbsp;headers&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365554">//&nbsp;subsecond&nbsp;time&nbsp;resolution,&nbsp;but&nbsp;for&nbsp;now&nbsp;let&#39;s&nbsp;just&nbsp;capture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365616">//&nbsp;too&nbsp;long&nbsp;fields&nbsp;or&nbsp;non&nbsp;ascii&nbsp;characters</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365661">var</span>&nbsp;<span class="ident" id="1365665">header</span>&nbsp;<span class="op" id="1365672">[</span><span class="op" id="1365673">]</span><span class="builtintype" id="1365674">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365681">//&nbsp;We&nbsp;need&nbsp;to&nbsp;select&nbsp;which&nbsp;scratch&nbsp;buffer&nbsp;to&nbsp;use&nbsp;carefully,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365742">//&nbsp;since&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;recursively&nbsp;to&nbsp;write&nbsp;PAX&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365808">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;true,&nbsp;this&nbsp;is&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;and&nbsp;we&nbsp;will&nbsp;use&nbsp;hdrBuff.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365890">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;false,&nbsp;we&nbsp;are&nbsp;being&nbsp;called&nbsp;by&nbsp;writePAXHeader,&nbsp;and&nbsp;hdrBuff&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365970">//&nbsp;already&nbsp;being&nbsp;used&nbsp;by&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;so&nbsp;we&nbsp;must&nbsp;use&nbsp;paxHdrBuff.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366047">header</span>&nbsp;<span class="op" id="1366054">=</span>&nbsp;<span class="ident" id="1366056">tw</span><span class="op" id="1366058">.</span><span class="ident" id="1366059">hdrBuff</span><span class="op" id="1366066">[</span><span class="op" id="1366067">:</span><span class="op" id="1366068">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366071">if</span>&nbsp;<span class="op" id="1366074">!</span><span class="ident" id="1366075">allowPax</span>&nbsp;<span class="op" id="1366084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366088">header</span>&nbsp;<span class="op" id="1366095">=</span>&nbsp;<span class="ident" id="1366097">tw</span><span class="op" id="1366099">.</span><span class="ident" id="1366100">paxHdrBuff</span><span class="op" id="1366110">[</span><span class="op" id="1366111">:</span><span class="op" id="1366112">]</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1366118">copy</span><span class="op" id="1366122">(</span><span class="ident" id="1366123">header</span><span class="op" id="1366129">,</span>&nbsp;<span class="ident" id="1366131">zeroBlock</span><span class="op" id="1366140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366143">s</span>&nbsp;<span class="op" id="1366145">:=</span>&nbsp;<span class="ident" id="1366148">slicer</span><span class="op" id="1366154">(</span><span class="ident" id="1366155">header</span><span class="op" id="1366161">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1366165">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;filename&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366293">pathHeaderBytes</span>&nbsp;<span class="op" id="1366309">:=</span>&nbsp;<span class="ident" id="1366312">s</span><span class="op" id="1366313">.</span><span class="ident" id="1366314">next</span><span class="op" id="1366318">(</span><span class="ident" id="1366319">fileNameSize</span><span class="op" id="1366331">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366335">tw</span><span class="op" id="1366337">.</span><span class="ident" id="1366338">cString</span><span class="op" id="1366345">(</span><span class="ident" id="1366346">pathHeaderBytes</span><span class="op" id="1366361">,</span>&nbsp;<span class="ident" id="1366363">hdr</span><span class="op" id="1366366">.</span><span class="ident" id="1366367">Name</span><span class="op" id="1366371">,</span>&nbsp;<span class="builtintype" id="1366373">true</span><span class="op" id="1366377">,</span>&nbsp;<span class="ident" id="1366379">paxPath</span><span class="op" id="1366386">,</span>&nbsp;<span class="ident" id="1366388">paxHeaders</span><span class="op" id="1366398">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1366402">//&nbsp;Handle&nbsp;out&nbsp;of&nbsp;range&nbsp;ModTime&nbsp;carefully.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366445">var</span>&nbsp;<span class="ident" id="1366449">modTime</span>&nbsp;<span class="ident" id="1366457">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366464">if</span>&nbsp;<span class="op" id="1366467">!</span><span class="ident" id="1366468">hdr</span><span class="op" id="1366471">.</span><span class="ident" id="1366472">ModTime</span><span class="op" id="1366479">.</span><span class="ident" id="1366480">Before</span><span class="op" id="1366486">(</span><span class="ident" id="1366487">minTime</span><span class="op" id="1366494">)</span>&nbsp;<span class="op" id="1366496">&amp;&amp;</span>&nbsp;<span class="op" id="1366499">!</span><span class="ident" id="1366500">hdr</span><span class="op" id="1366503">.</span><span class="ident" id="1366504">ModTime</span><span class="op" id="1366511">.</span><span class="ident" id="1366512">After</span><span class="op" id="1366517">(</span><span class="ident" id="1366518">maxTime</span><span class="op" id="1366525">)</span>&nbsp;<span class="op" id="1366527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366531">modTime</span>&nbsp;<span class="op" id="1366539">=</span>&nbsp;<span class="ident" id="1366541">hdr</span><span class="op" id="1366544">.</span><span class="ident" id="1366545">ModTime</span><span class="op" id="1366552">.</span><span class="ident" id="1366553">Unix</span><span class="op" id="1366557">(</span><span class="op" id="1366558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366565">tw</span><span class="op" id="1366567">.</span><span class="ident" id="1366568">octal</span><span class="op" id="1366573">(</span><span class="ident" id="1366574">s</span><span class="op" id="1366575">.</span><span class="ident" id="1366576">next</span><span class="op" id="1366580">(</span><span class="num" id="1366581">8</span><span class="op" id="1366582">)</span><span class="op" id="1366583">,</span>&nbsp;<span class="ident" id="1366585">hdr</span><span class="op" id="1366588">.</span><span class="ident" id="1366589">Mode</span><span class="op" id="1366593">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1366629">//&nbsp;100:108</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366641">tw</span><span class="op" id="1366643">.</span><span class="ident" id="1366644">numeric</span><span class="op" id="1366651">(</span><span class="ident" id="1366652">s</span><span class="op" id="1366653">.</span><span class="ident" id="1366654">next</span><span class="op" id="1366658">(</span><span class="num" id="1366659">8</span><span class="op" id="1366660">)</span><span class="op" id="1366661">,</span>&nbsp;<span class="ident" id="1366663">int64</span><span class="op" id="1366668">(</span><span class="ident" id="1366669">hdr</span><span class="op" id="1366672">.</span><span class="ident" id="1366673">Uid</span><span class="op" id="1366676">)</span><span class="op" id="1366677">,</span>&nbsp;<span class="builtintype" id="1366679">true</span><span class="op" id="1366683">,</span>&nbsp;<span class="ident" id="1366685">paxUid</span><span class="op" id="1366691">,</span>&nbsp;<span class="ident" id="1366693">paxHeaders</span><span class="op" id="1366703">)</span>&nbsp;<span class="comment" id="1366705">//&nbsp;108:116</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366717">tw</span><span class="op" id="1366719">.</span><span class="ident" id="1366720">numeric</span><span class="op" id="1366727">(</span><span class="ident" id="1366728">s</span><span class="op" id="1366729">.</span><span class="ident" id="1366730">next</span><span class="op" id="1366734">(</span><span class="num" id="1366735">8</span><span class="op" id="1366736">)</span><span class="op" id="1366737">,</span>&nbsp;<span class="ident" id="1366739">int64</span><span class="op" id="1366744">(</span><span class="ident" id="1366745">hdr</span><span class="op" id="1366748">.</span><span class="ident" id="1366749">Gid</span><span class="op" id="1366752">)</span><span class="op" id="1366753">,</span>&nbsp;<span class="builtintype" id="1366755">true</span><span class="op" id="1366759">,</span>&nbsp;<span class="ident" id="1366761">paxGid</span><span class="op" id="1366767">,</span>&nbsp;<span class="ident" id="1366769">paxHeaders</span><span class="op" id="1366779">)</span>&nbsp;<span class="comment" id="1366781">//&nbsp;116:124</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366793">tw</span><span class="op" id="1366795">.</span><span class="ident" id="1366796">numeric</span><span class="op" id="1366803">(</span><span class="ident" id="1366804">s</span><span class="op" id="1366805">.</span><span class="ident" id="1366806">next</span><span class="op" id="1366810">(</span><span class="num" id="1366811">12</span><span class="op" id="1366813">)</span><span class="op" id="1366814">,</span>&nbsp;<span class="ident" id="1366816">hdr</span><span class="op" id="1366819">.</span><span class="ident" id="1366820">Size</span><span class="op" id="1366824">,</span>&nbsp;<span class="builtintype" id="1366826">true</span><span class="op" id="1366830">,</span>&nbsp;<span class="ident" id="1366832">paxSize</span><span class="op" id="1366839">,</span>&nbsp;<span class="ident" id="1366841">paxHeaders</span><span class="op" id="1366851">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1366857">//&nbsp;124:136</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366869">tw</span><span class="op" id="1366871">.</span><span class="ident" id="1366872">numeric</span><span class="op" id="1366879">(</span><span class="ident" id="1366880">s</span><span class="op" id="1366881">.</span><span class="ident" id="1366882">next</span><span class="op" id="1366886">(</span><span class="num" id="1366887">12</span><span class="op" id="1366889">)</span><span class="op" id="1366890">,</span>&nbsp;<span class="ident" id="1366892">modTime</span><span class="op" id="1366899">,</span>&nbsp;<span class="builtintype" id="1366901">false</span><span class="op" id="1366906">,</span>&nbsp;<span class="ident" id="1366908">paxNone</span><span class="op" id="1366915">,</span>&nbsp;<span class="ident" id="1366917">nil</span><span class="op" id="1366920">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1366933">//&nbsp;136:148&nbsp;---&nbsp;consider&nbsp;using&nbsp;pax&nbsp;for&nbsp;finer&nbsp;granularity</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366990">s</span><span class="op" id="1366991">.</span><span class="ident" id="1366992">next</span><span class="op" id="1366996">(</span><span class="num" id="1366997">8</span><span class="op" id="1366998">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1367054">//&nbsp;chksum&nbsp;(148:156)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367075">s</span><span class="op" id="1367076">.</span><span class="ident" id="1367077">next</span><span class="op" id="1367081">(</span><span class="num" id="1367082">1</span><span class="op" id="1367083">)</span><span class="op" id="1367084">[</span><span class="num" id="1367085">0</span><span class="op" id="1367086">]</span>&nbsp;<span class="op" id="1367088">=</span>&nbsp;<span class="ident" id="1367090">hdr</span><span class="op" id="1367093">.</span><span class="ident" id="1367094">Typeflag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1367139">//&nbsp;156:157</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367152">tw</span><span class="op" id="1367154">.</span><span class="ident" id="1367155">cString</span><span class="op" id="1367162">(</span><span class="ident" id="1367163">s</span><span class="op" id="1367164">.</span><span class="ident" id="1367165">next</span><span class="op" id="1367169">(</span><span class="num" id="1367170">100</span><span class="op" id="1367173">)</span><span class="op" id="1367174">,</span>&nbsp;<span class="ident" id="1367176">hdr</span><span class="op" id="1367179">.</span><span class="ident" id="1367180">Linkname</span><span class="op" id="1367188">,</span>&nbsp;<span class="builtintype" id="1367190">true</span><span class="op" id="1367194">,</span>&nbsp;<span class="ident" id="1367196">paxLinkpath</span><span class="op" id="1367207">,</span>&nbsp;<span class="ident" id="1367209">paxHeaders</span><span class="op" id="1367219">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1367223">copy</span><span class="op" id="1367227">(</span><span class="ident" id="1367228">s</span><span class="op" id="1367229">.</span><span class="ident" id="1367230">next</span><span class="op" id="1367234">(</span><span class="num" id="1367235">8</span><span class="op" id="1367236">)</span><span class="op" id="1367237">,</span>&nbsp;<span class="op" id="1367239">[</span><span class="op" id="1367240">]</span><span class="builtintype" id="1367241">byte</span><span class="op" id="1367245">(</span><span class="string" id="1367246">&#34;ustar\x0000&#34;</span><span class="op" id="1367259">)</span><span class="op" id="1367260">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1367285">//&nbsp;257:265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367297">tw</span><span class="op" id="1367299">.</span><span class="ident" id="1367300">cString</span><span class="op" id="1367307">(</span><span class="ident" id="1367308">s</span><span class="op" id="1367309">.</span><span class="ident" id="1367310">next</span><span class="op" id="1367314">(</span><span class="num" id="1367315">32</span><span class="op" id="1367317">)</span><span class="op" id="1367318">,</span>&nbsp;<span class="ident" id="1367320">hdr</span><span class="op" id="1367323">.</span><span class="ident" id="1367324">Uname</span><span class="op" id="1367329">,</span>&nbsp;<span class="builtintype" id="1367331">true</span><span class="op" id="1367335">,</span>&nbsp;<span class="ident" id="1367337">paxUname</span><span class="op" id="1367345">,</span>&nbsp;<span class="ident" id="1367347">paxHeaders</span><span class="op" id="1367357">)</span>&nbsp;<span class="comment" id="1367359">//&nbsp;265:297</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367371">tw</span><span class="op" id="1367373">.</span><span class="ident" id="1367374">cString</span><span class="op" id="1367381">(</span><span class="ident" id="1367382">s</span><span class="op" id="1367383">.</span><span class="ident" id="1367384">next</span><span class="op" id="1367388">(</span><span class="num" id="1367389">32</span><span class="op" id="1367391">)</span><span class="op" id="1367392">,</span>&nbsp;<span class="ident" id="1367394">hdr</span><span class="op" id="1367397">.</span><span class="ident" id="1367398">Gname</span><span class="op" id="1367403">,</span>&nbsp;<span class="builtintype" id="1367405">true</span><span class="op" id="1367409">,</span>&nbsp;<span class="ident" id="1367411">paxGname</span><span class="op" id="1367419">,</span>&nbsp;<span class="ident" id="1367421">paxHeaders</span><span class="op" id="1367431">)</span>&nbsp;<span class="comment" id="1367433">//&nbsp;297:329</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367445">tw</span><span class="op" id="1367447">.</span><span class="ident" id="1367448">numeric</span><span class="op" id="1367455">(</span><span class="ident" id="1367456">s</span><span class="op" id="1367457">.</span><span class="ident" id="1367458">next</span><span class="op" id="1367462">(</span><span class="num" id="1367463">8</span><span class="op" id="1367464">)</span><span class="op" id="1367465">,</span>&nbsp;<span class="ident" id="1367467">hdr</span><span class="op" id="1367470">.</span><span class="ident" id="1367471">Devmajor</span><span class="op" id="1367479">,</span>&nbsp;<span class="builtintype" id="1367481">false</span><span class="op" id="1367486">,</span>&nbsp;<span class="ident" id="1367488">paxNone</span><span class="op" id="1367495">,</span>&nbsp;<span class="ident" id="1367497">nil</span><span class="op" id="1367500">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1367507">//&nbsp;329:337</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367519">tw</span><span class="op" id="1367521">.</span><span class="ident" id="1367522">numeric</span><span class="op" id="1367529">(</span><span class="ident" id="1367530">s</span><span class="op" id="1367531">.</span><span class="ident" id="1367532">next</span><span class="op" id="1367536">(</span><span class="num" id="1367537">8</span><span class="op" id="1367538">)</span><span class="op" id="1367539">,</span>&nbsp;<span class="ident" id="1367541">hdr</span><span class="op" id="1367544">.</span><span class="ident" id="1367545">Devminor</span><span class="op" id="1367553">,</span>&nbsp;<span class="builtintype" id="1367555">false</span><span class="op" id="1367560">,</span>&nbsp;<span class="ident" id="1367562">paxNone</span><span class="op" id="1367569">,</span>&nbsp;<span class="ident" id="1367571">nil</span><span class="op" id="1367574">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1367581">//&nbsp;337:345</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1367594">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;prefix&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367720">prefixHeaderBytes</span>&nbsp;<span class="op" id="1367738">:=</span>&nbsp;<span class="ident" id="1367741">s</span><span class="op" id="1367742">.</span><span class="ident" id="1367743">next</span><span class="op" id="1367747">(</span><span class="num" id="1367748">155</span><span class="op" id="1367751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367754">tw</span><span class="op" id="1367756">.</span><span class="ident" id="1367757">cString</span><span class="op" id="1367764">(</span><span class="ident" id="1367765">prefixHeaderBytes</span><span class="op" id="1367782">,</span>&nbsp;<span class="string" id="1367784">&#34;&#34;</span><span class="op" id="1367786">,</span>&nbsp;<span class="builtintype" id="1367788">false</span><span class="op" id="1367793">,</span>&nbsp;<span class="ident" id="1367795">paxNone</span><span class="op" id="1367802">,</span>&nbsp;<span class="ident" id="1367804">nil</span><span class="op" id="1367807">)</span>&nbsp;<span class="comment" id="1367809">//&nbsp;345:500&nbsp;&nbsp;prefix</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1367830">//&nbsp;Use&nbsp;the&nbsp;GNU&nbsp;magic&nbsp;instead&nbsp;of&nbsp;POSIX&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;any&nbsp;GNU&nbsp;extensions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367906">if</span>&nbsp;<span class="ident" id="1367909">tw</span><span class="op" id="1367911">.</span><span class="ident" id="1367912">usedBinary</span>&nbsp;<span class="op" id="1367923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1367927">copy</span><span class="op" id="1367931">(</span><span class="ident" id="1367932">header</span><span class="op" id="1367938">[</span><span class="num" id="1367939">257</span><span class="op" id="1367942">:</span><span class="num" id="1367943">265</span><span class="op" id="1367946">]</span><span class="op" id="1367947">,</span>&nbsp;<span class="op" id="1367949">[</span><span class="op" id="1367950">]</span><span class="builtintype" id="1367951">byte</span><span class="op" id="1367955">(</span><span class="string" id="1367956">&#34;ustar&nbsp;&nbsp;\x00&#34;</span><span class="op" id="1367969">)</span><span class="op" id="1367970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1367973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367977">_</span><span class="op" id="1367978">,</span>&nbsp;<span class="ident" id="1367980">paxPathUsed</span>&nbsp;<span class="op" id="1367992">:=</span>&nbsp;<span class="ident" id="1367995">paxHeaders</span><span class="op" id="1368005">[</span><span class="ident" id="1368006">paxPath</span><span class="op" id="1368013">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368016">//&nbsp;try&nbsp;to&nbsp;use&nbsp;a&nbsp;ustar&nbsp;header&nbsp;when&nbsp;only&nbsp;the&nbsp;name&nbsp;is&nbsp;too&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1368077">if</span>&nbsp;<span class="op" id="1368080">!</span><span class="ident" id="1368081">tw</span><span class="op" id="1368083">.</span><span class="ident" id="1368084">preferPax</span>&nbsp;<span class="op" id="1368094">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="1368097">len</span><span class="op" id="1368100">(</span><span class="ident" id="1368101">paxHeaders</span><span class="op" id="1368111">)</span>&nbsp;<span class="op" id="1368113">==</span>&nbsp;<span class="num" id="1368116">1</span>&nbsp;<span class="op" id="1368118">&amp;&amp;</span>&nbsp;<span class="ident" id="1368121">paxPathUsed</span>&nbsp;<span class="op" id="1368133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1368137">suffix</span>&nbsp;<span class="op" id="1368144">:=</span>&nbsp;<span class="ident" id="1368147">hdr</span><span class="op" id="1368150">.</span><span class="ident" id="1368151">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1368158">prefix</span>&nbsp;<span class="op" id="1368165">:=</span>&nbsp;<span class="string" id="1368168">&#34;&#34;</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1368173">if</span>&nbsp;<span class="builtinfunc" id="1368176">len</span><span class="op" id="1368179">(</span><span class="ident" id="1368180">hdr</span><span class="op" id="1368183">.</span><span class="ident" id="1368184">Name</span><span class="op" id="1368188">)</span>&nbsp;<span class="op" id="1368190">&gt;</span>&nbsp;<span class="ident" id="1368192">fileNameSize</span>&nbsp;<span class="op" id="1368205">&amp;&amp;</span>&nbsp;<span class="ident" id="1368208">isASCII</span><span class="op" id="1368215">(</span><span class="ident" id="1368216">hdr</span><span class="op" id="1368219">.</span><span class="ident" id="1368220">Name</span><span class="op" id="1368224">)</span>&nbsp;<span class="op" id="1368226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1368231">var</span>&nbsp;<span class="ident" id="1368235">err</span>&nbsp;<span class="builtintype" id="1368239">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1368248">prefix</span><span class="op" id="1368254">,</span>&nbsp;<span class="ident" id="1368256">suffix</span><span class="op" id="1368262">,</span>&nbsp;<span class="ident" id="1368264">err</span>&nbsp;<span class="op" id="1368268">=</span>&nbsp;<span class="ident" id="1368270">tw</span><span class="op" id="1368272">.</span><span class="ident" id="1368273">splitUSTARLongName</span><span class="op" id="1368291">(</span><span class="ident" id="1368292">hdr</span><span class="op" id="1368295">.</span><span class="ident" id="1368296">Name</span><span class="op" id="1368300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1368305">if</span>&nbsp;<span class="ident" id="1368308">err</span>&nbsp;<span class="op" id="1368312">==</span>&nbsp;<span class="ident" id="1368315">nil</span>&nbsp;<span class="op" id="1368319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368325">//&nbsp;ok&nbsp;we&nbsp;can&nbsp;use&nbsp;a&nbsp;ustar&nbsp;long&nbsp;name&nbsp;instead&nbsp;of&nbsp;pax,&nbsp;now&nbsp;correct&nbsp;the&nbsp;fields</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368404">//&nbsp;remove&nbsp;the&nbsp;path&nbsp;field&nbsp;from&nbsp;the&nbsp;pax&nbsp;header.&nbsp;this&nbsp;will&nbsp;suppress&nbsp;the&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1368488">delete</span><span class="op" id="1368494">(</span><span class="ident" id="1368495">paxHeaders</span><span class="op" id="1368505">,</span>&nbsp;<span class="ident" id="1368507">paxPath</span><span class="op" id="1368514">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368521">//&nbsp;update&nbsp;the&nbsp;path&nbsp;fields</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1368551">tw</span><span class="op" id="1368553">.</span><span class="ident" id="1368554">cString</span><span class="op" id="1368561">(</span><span class="ident" id="1368562">pathHeaderBytes</span><span class="op" id="1368577">,</span>&nbsp;<span class="ident" id="1368579">suffix</span><span class="op" id="1368585">,</span>&nbsp;<span class="builtintype" id="1368587">false</span><span class="op" id="1368592">,</span>&nbsp;<span class="ident" id="1368594">paxNone</span><span class="op" id="1368601">,</span>&nbsp;<span class="ident" id="1368603">nil</span><span class="op" id="1368606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1368612">tw</span><span class="op" id="1368614">.</span><span class="ident" id="1368615">cString</span><span class="op" id="1368622">(</span><span class="ident" id="1368623">prefixHeaderBytes</span><span class="op" id="1368640">,</span>&nbsp;<span class="ident" id="1368642">prefix</span><span class="op" id="1368648">,</span>&nbsp;<span class="builtintype" id="1368650">false</span><span class="op" id="1368655">,</span>&nbsp;<span class="ident" id="1368657">paxNone</span><span class="op" id="1368664">,</span>&nbsp;<span class="ident" id="1368666">nil</span><span class="op" id="1368669">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368676">//&nbsp;Use&nbsp;the&nbsp;ustar&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;ustar&nbsp;long&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1368732">if</span>&nbsp;<span class="builtinfunc" id="1368735">len</span><span class="op" id="1368738">(</span><span class="ident" id="1368739">prefix</span><span class="op" id="1368745">)</span>&nbsp;<span class="op" id="1368747">&gt;</span>&nbsp;<span class="num" id="1368749">0</span>&nbsp;<span class="op" id="1368751">&amp;&amp;</span>&nbsp;<span class="op" id="1368754">!</span><span class="ident" id="1368755">tw</span><span class="op" id="1368757">.</span><span class="ident" id="1368758">usedBinary</span>&nbsp;<span class="op" id="1368769">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1368776">copy</span><span class="op" id="1368780">(</span><span class="ident" id="1368781">header</span><span class="op" id="1368787">[</span><span class="num" id="1368788">257</span><span class="op" id="1368791">:</span><span class="num" id="1368792">265</span><span class="op" id="1368795">]</span><span class="op" id="1368796">,</span>&nbsp;<span class="op" id="1368798">[</span><span class="op" id="1368799">]</span><span class="builtintype" id="1368800">byte</span><span class="op" id="1368804">(</span><span class="string" id="1368805">&#34;ustar\x00&#34;</span><span class="op" id="1368816">)</span><span class="op" id="1368817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1368823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1368828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1368832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1368835">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368839">//&nbsp;The&nbsp;chksum&nbsp;field&nbsp;is&nbsp;terminated&nbsp;by&nbsp;a&nbsp;NUL&nbsp;and&nbsp;a&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368896">//&nbsp;This&nbsp;is&nbsp;different&nbsp;from&nbsp;the&nbsp;other&nbsp;octal&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1368947">chksum</span><span class="op" id="1368953">,</span>&nbsp;<span class="ident" id="1368955">_</span>&nbsp;<span class="op" id="1368957">:=</span>&nbsp;<span class="ident" id="1368960">checksum</span><span class="op" id="1368968">(</span><span class="ident" id="1368969">header</span><span class="op" id="1368975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1368978">tw</span><span class="op" id="1368980">.</span><span class="ident" id="1368981">octal</span><span class="op" id="1368986">(</span><span class="ident" id="1368987">header</span><span class="op" id="1368993">[</span><span class="num" id="1368994">148</span><span class="op" id="1368997">:</span><span class="num" id="1368998">155</span><span class="op" id="1369001">]</span><span class="op" id="1369002">,</span>&nbsp;<span class="ident" id="1369004">chksum</span><span class="op" id="1369010">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369013">header</span><span class="op" id="1369019">[</span><span class="num" id="1369020">155</span><span class="op" id="1369023">]</span>&nbsp;<span class="op" id="1369025">=</span>&nbsp;<span class="string" id="1369027">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369033">if</span>&nbsp;<span class="ident" id="1369036">tw</span><span class="op" id="1369038">.</span><span class="ident" id="1369039">err</span>&nbsp;<span class="op" id="1369043">!=</span>&nbsp;<span class="ident" id="1369046">nil</span>&nbsp;<span class="op" id="1369050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1369054">//&nbsp;problem&nbsp;with&nbsp;header;&nbsp;probably&nbsp;integer&nbsp;too&nbsp;big&nbsp;for&nbsp;a&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369118">return</span>&nbsp;<span class="ident" id="1369125">tw</span><span class="op" id="1369127">.</span><span class="ident" id="1369128">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369137">if</span>&nbsp;<span class="ident" id="1369140">allowPax</span>&nbsp;<span class="op" id="1369149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369153">for</span>&nbsp;<span class="ident" id="1369157">k</span><span class="op" id="1369158">,</span>&nbsp;<span class="ident" id="1369160">v</span>&nbsp;<span class="op" id="1369162">:=</span>&nbsp;<span class="keyword" id="1369165">range</span>&nbsp;<span class="ident" id="1369171">hdr</span><span class="op" id="1369174">.</span><span class="ident" id="1369175">Xattrs</span>&nbsp;<span class="op" id="1369182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369187">paxHeaders</span><span class="op" id="1369197">[</span><span class="ident" id="1369198">paxXattr</span><span class="op" id="1369206">+</span><span class="ident" id="1369207">k</span><span class="op" id="1369208">]</span>&nbsp;<span class="op" id="1369210">=</span>&nbsp;<span class="ident" id="1369212">v</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369223">if</span>&nbsp;<span class="builtinfunc" id="1369226">len</span><span class="op" id="1369229">(</span><span class="ident" id="1369230">paxHeaders</span><span class="op" id="1369240">)</span>&nbsp;<span class="op" id="1369242">&gt;</span>&nbsp;<span class="num" id="1369244">0</span>&nbsp;<span class="op" id="1369246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369250">if</span>&nbsp;<span class="op" id="1369253">!</span><span class="ident" id="1369254">allowPax</span>&nbsp;<span class="op" id="1369263">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369268">return</span>&nbsp;<span class="ident" id="1369275">errInvalidHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369298">if</span>&nbsp;<span class="ident" id="1369301">err</span>&nbsp;<span class="op" id="1369305">:=</span>&nbsp;<span class="ident" id="1369308">tw</span><span class="op" id="1369310">.</span><span class="ident" id="1369311">writePAXHeader</span><span class="op" id="1369325">(</span><span class="ident" id="1369326">hdr</span><span class="op" id="1369329">,</span>&nbsp;<span class="ident" id="1369331">paxHeaders</span><span class="op" id="1369341">)</span><span class="op" id="1369342">;</span>&nbsp;<span class="ident" id="1369344">err</span>&nbsp;<span class="op" id="1369348">!=</span>&nbsp;<span class="ident" id="1369351">nil</span>&nbsp;<span class="op" id="1369355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369360">return</span>&nbsp;<span class="ident" id="1369367">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369373">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369379">tw</span><span class="op" id="1369381">.</span><span class="ident" id="1369382">nb</span>&nbsp;<span class="op" id="1369385">=</span>&nbsp;<span class="ident" id="1369387">int64</span><span class="op" id="1369392">(</span><span class="ident" id="1369393">hdr</span><span class="op" id="1369396">.</span><span class="ident" id="1369397">Size</span><span class="op" id="1369401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369404">tw</span><span class="op" id="1369406">.</span><span class="ident" id="1369407">pad</span>&nbsp;<span class="op" id="1369411">=</span>&nbsp;<span class="op" id="1369413">(</span><span class="ident" id="1369414">blockSize</span>&nbsp;<span class="op" id="1369424">-</span>&nbsp;<span class="op" id="1369426">(</span><span class="ident" id="1369427">tw</span><span class="op" id="1369429">.</span><span class="ident" id="1369430">nb</span>&nbsp;<span class="op" id="1369433">%</span>&nbsp;<span class="ident" id="1369435">blockSize</span><span class="op" id="1369444">)</span><span class="op" id="1369445">)</span>&nbsp;<span class="op" id="1369447">%</span>&nbsp;<span class="ident" id="1369449">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369461">_</span><span class="op" id="1369462">,</span>&nbsp;<span class="ident" id="1369464">tw</span><span class="op" id="1369466">.</span><span class="ident" id="1369467">err</span>&nbsp;<span class="op" id="1369471">=</span>&nbsp;<span class="ident" id="1369473">tw</span><span class="op" id="1369475">.</span><span class="ident" id="1369476">w</span><span class="op" id="1369477">.</span><span class="ident" id="1369478">Write</span><span class="op" id="1369483">(</span><span class="ident" id="1369484">header</span><span class="op" id="1369490">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369493">return</span>&nbsp;<span class="ident" id="1369500">tw</span><span class="op" id="1369502">.</span><span class="ident" id="1369503">err</span><br>
<span class="lineno"></span><span class="op" id="1369507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1369510">//&nbsp;writeUSTARLongName&nbsp;splits&nbsp;a&nbsp;USTAR&nbsp;long&nbsp;name&nbsp;hdr.Name.</span><br>
<span class="lineno"></span><span class="comment" id="1369567">//&nbsp;name&nbsp;must&nbsp;be&nbsp;&lt;&nbsp;256&nbsp;characters.&nbsp;errNameTooLong&nbsp;is&nbsp;returned</span><br>
<span class="lineno">275</span><span class="comment" id="1369628">//&nbsp;if&nbsp;hdr.Name&nbsp;can&#39;t&nbsp;be&nbsp;split.&nbsp;The&nbsp;splitting&nbsp;heuristic</span><br>
<span class="lineno"></span><span class="comment" id="1369683">//&nbsp;is&nbsp;compatible&nbsp;with&nbsp;gnu&nbsp;tar.</span><br>
<span class="lineno"></span><span class="keyword" id="1369714">func</span>&nbsp;<span class="op" id="1369719">(</span><span class="ident" id="1369720">tw</span>&nbsp;<span class="op" id="1369723">*</span><span class="ident" id="1369724">Writer</span><span class="op" id="1369730">)</span>&nbsp;<span class="ident" id="1369732">splitUSTARLongName</span><span class="op" id="1369750">(</span><span class="ident" id="1369751">name</span>&nbsp;<span class="builtintype" id="1369756">string</span><span class="op" id="1369762">)</span>&nbsp;<span class="op" id="1369764">(</span><span class="ident" id="1369765">prefix</span><span class="op" id="1369771">,</span>&nbsp;<span class="ident" id="1369773">suffix</span>&nbsp;<span class="builtintype" id="1369780">string</span><span class="op" id="1369786">,</span>&nbsp;<span class="ident" id="1369788">err</span>&nbsp;<span class="builtintype" id="1369792">error</span><span class="op" id="1369797">)</span>&nbsp;<span class="op" id="1369799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369802">length</span>&nbsp;<span class="op" id="1369809">:=</span>&nbsp;<span class="builtinfunc" id="1369812">len</span><span class="op" id="1369815">(</span><span class="ident" id="1369816">name</span><span class="op" id="1369820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369823">if</span>&nbsp;<span class="ident" id="1369826">length</span>&nbsp;<span class="op" id="1369833">&gt;</span>&nbsp;<span class="ident" id="1369835">fileNamePrefixSize</span><span class="op" id="1369853">+</span><span class="num" id="1369854">1</span>&nbsp;<span class="op" id="1369856">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369860">length</span>&nbsp;<span class="op" id="1369867">=</span>&nbsp;<span class="ident" id="1369869">fileNamePrefixSize</span>&nbsp;<span class="op" id="1369888">+</span>&nbsp;<span class="num" id="1369890">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369893">}</span>&nbsp;<span class="keyword" id="1369895">else</span>&nbsp;<span class="keyword" id="1369900">if</span>&nbsp;<span class="ident" id="1369903">name</span><span class="op" id="1369907">[</span><span class="ident" id="1369908">length</span><span class="op" id="1369914">-</span><span class="num" id="1369915">1</span><span class="op" id="1369916">]</span>&nbsp;<span class="op" id="1369918">==</span>&nbsp;<span class="string" id="1369921">&#39;/&#39;</span>&nbsp;<span class="op" id="1369925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369929">length</span><span class="op" id="1369935">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369942">i</span>&nbsp;<span class="op" id="1369944">:=</span>&nbsp;<span class="ident" id="1369947">strings</span><span class="op" id="1369954">.</span><span class="ident" id="1369955">LastIndex</span><span class="op" id="1369964">(</span><span class="ident" id="1369965">name</span><span class="op" id="1369969">[</span><span class="op" id="1369970">:</span><span class="ident" id="1369971">length</span><span class="op" id="1369977">]</span><span class="op" id="1369978">,</span>&nbsp;<span class="string" id="1369980">&#34;/&#34;</span><span class="op" id="1369983">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1369986">//&nbsp;nlen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;name&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370044">//&nbsp;plen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;prefix&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370104">nlen</span>&nbsp;<span class="op" id="1370109">:=</span>&nbsp;<span class="builtinfunc" id="1370112">len</span><span class="op" id="1370115">(</span><span class="ident" id="1370116">name</span><span class="op" id="1370120">)</span>&nbsp;<span class="op" id="1370122">-</span>&nbsp;<span class="ident" id="1370124">i</span>&nbsp;<span class="op" id="1370126">-</span>&nbsp;<span class="num" id="1370128">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370131">plen</span>&nbsp;<span class="op" id="1370136">:=</span>&nbsp;<span class="ident" id="1370139">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370142">if</span>&nbsp;<span class="ident" id="1370145">i</span>&nbsp;<span class="op" id="1370147">&lt;=</span>&nbsp;<span class="num" id="1370150">0</span>&nbsp;<span class="op" id="1370152">||</span>&nbsp;<span class="ident" id="1370155">nlen</span>&nbsp;<span class="op" id="1370160">&gt;</span>&nbsp;<span class="ident" id="1370162">fileNameSize</span>&nbsp;<span class="op" id="1370175">||</span>&nbsp;<span class="ident" id="1370178">nlen</span>&nbsp;<span class="op" id="1370183">==</span>&nbsp;<span class="num" id="1370186">0</span>&nbsp;<span class="op" id="1370188">||</span>&nbsp;<span class="ident" id="1370191">plen</span>&nbsp;<span class="op" id="1370196">&gt;</span>&nbsp;<span class="ident" id="1370198">fileNamePrefixSize</span>&nbsp;<span class="op" id="1370217">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370221">err</span>&nbsp;<span class="op" id="1370225">=</span>&nbsp;<span class="ident" id="1370227">errNameTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370244">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370255">prefix</span><span class="op" id="1370261">,</span>&nbsp;<span class="ident" id="1370263">suffix</span>&nbsp;<span class="op" id="1370270">=</span>&nbsp;<span class="ident" id="1370272">name</span><span class="op" id="1370276">[</span><span class="op" id="1370277">:</span><span class="ident" id="1370278">i</span><span class="op" id="1370279">]</span><span class="op" id="1370280">,</span>&nbsp;<span class="ident" id="1370282">name</span><span class="op" id="1370286">[</span><span class="ident" id="1370287">i</span><span class="op" id="1370288">+</span><span class="num" id="1370289">1</span><span class="op" id="1370290">:</span><span class="op" id="1370291">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370294">return</span><br>
<span class="lineno">295</span><span class="op" id="1370301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1370304">//&nbsp;writePaxHeader&nbsp;writes&nbsp;an&nbsp;extended&nbsp;pax&nbsp;header&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1370359">//&nbsp;archive.</span><br>
<span class="lineno"></span><span class="keyword" id="1370371">func</span>&nbsp;<span class="op" id="1370376">(</span><span class="ident" id="1370377">tw</span>&nbsp;<span class="op" id="1370380">*</span><span class="ident" id="1370381">Writer</span><span class="op" id="1370387">)</span>&nbsp;<span class="ident" id="1370389">writePAXHeader</span><span class="op" id="1370403">(</span><span class="ident" id="1370404">hdr</span>&nbsp;<span class="op" id="1370408">*</span><span class="ident" id="1370409">Header</span><span class="op" id="1370415">,</span>&nbsp;<span class="ident" id="1370417">paxHeaders</span>&nbsp;<span class="keyword" id="1370428">map</span><span class="op" id="1370431">[</span><span class="builtintype" id="1370432">string</span><span class="op" id="1370438">]</span><span class="builtintype" id="1370439">string</span><span class="op" id="1370445">)</span>&nbsp;<span class="builtintype" id="1370447">error</span>&nbsp;<span class="op" id="1370453">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370456">//&nbsp;Prepare&nbsp;extended&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370484">ext</span>&nbsp;<span class="op" id="1370488">:=</span>&nbsp;<span class="builtinfunc" id="1370491">new</span><span class="op" id="1370494">(</span><span class="ident" id="1370495">Header</span><span class="op" id="1370501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370504">ext</span><span class="op" id="1370507">.</span><span class="ident" id="1370508">Typeflag</span>&nbsp;<span class="op" id="1370517">=</span>&nbsp;<span class="ident" id="1370519">TypeXHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370532">//&nbsp;Setting&nbsp;ModTime&nbsp;is&nbsp;required&nbsp;for&nbsp;reader&nbsp;parsing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370586">//&nbsp;succeed,&nbsp;and&nbsp;seems&nbsp;harmless&nbsp;enough.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370626">ext</span><span class="op" id="1370629">.</span><span class="ident" id="1370630">ModTime</span>&nbsp;<span class="op" id="1370638">=</span>&nbsp;<span class="ident" id="1370640">hdr</span><span class="op" id="1370643">.</span><span class="ident" id="1370644">ModTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370653">//&nbsp;The&nbsp;spec&nbsp;asks&nbsp;that&nbsp;we&nbsp;namespace&nbsp;our&nbsp;pseudo&nbsp;files</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370706">//&nbsp;with&nbsp;the&nbsp;current&nbsp;pid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370732">pid</span>&nbsp;<span class="op" id="1370736">:=</span>&nbsp;<span class="ident" id="1370739">os</span><span class="op" id="1370741">.</span><span class="ident" id="1370742">Getpid</span><span class="op" id="1370748">(</span><span class="op" id="1370749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370752">dir</span><span class="op" id="1370755">,</span>&nbsp;<span class="ident" id="1370757">file</span>&nbsp;<span class="op" id="1370762">:=</span>&nbsp;<span class="ident" id="1370765">path</span><span class="op" id="1370769">.</span><span class="ident" id="1370770">Split</span><span class="op" id="1370775">(</span><span class="ident" id="1370776">hdr</span><span class="op" id="1370779">.</span><span class="ident" id="1370780">Name</span><span class="op" id="1370784">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370787">fullName</span>&nbsp;<span class="op" id="1370796">:=</span>&nbsp;<span class="ident" id="1370799">path</span><span class="op" id="1370803">.</span><span class="ident" id="1370804">Join</span><span class="op" id="1370808">(</span><span class="ident" id="1370809">dir</span><span class="op" id="1370812">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370816">fmt</span><span class="op" id="1370819">.</span><span class="ident" id="1370820">Sprintf</span><span class="op" id="1370827">(</span><span class="string" id="1370828">&#34;PaxHeaders.%d&#34;</span><span class="op" id="1370843">,</span>&nbsp;<span class="ident" id="1370845">pid</span><span class="op" id="1370848">)</span><span class="op" id="1370849">,</span>&nbsp;<span class="ident" id="1370851">file</span><span class="op" id="1370855">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370859">ascii</span>&nbsp;<span class="op" id="1370865">:=</span>&nbsp;<span class="ident" id="1370868">toASCII</span><span class="op" id="1370875">(</span><span class="ident" id="1370876">fullName</span><span class="op" id="1370884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370887">if</span>&nbsp;<span class="builtinfunc" id="1370890">len</span><span class="op" id="1370893">(</span><span class="ident" id="1370894">ascii</span><span class="op" id="1370899">)</span>&nbsp;<span class="op" id="1370901">&gt;</span>&nbsp;<span class="num" id="1370903">100</span>&nbsp;<span class="op" id="1370907">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370911">ascii</span>&nbsp;<span class="op" id="1370917">=</span>&nbsp;<span class="ident" id="1370919">ascii</span><span class="op" id="1370924">[</span><span class="op" id="1370925">:</span><span class="num" id="1370926">100</span><span class="op" id="1370929">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370935">ext</span><span class="op" id="1370938">.</span><span class="ident" id="1370939">Name</span>&nbsp;<span class="op" id="1370944">=</span>&nbsp;<span class="ident" id="1370946">ascii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370953">//&nbsp;Construct&nbsp;the&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370976">var</span>&nbsp;<span class="ident" id="1370980">buf</span>&nbsp;<span class="ident" id="1370984">bytes</span><span class="op" id="1370989">.</span><span class="ident" id="1370990">Buffer</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370999">for</span>&nbsp;<span class="ident" id="1371003">k</span><span class="op" id="1371004">,</span>&nbsp;<span class="ident" id="1371006">v</span>&nbsp;<span class="op" id="1371008">:=</span>&nbsp;<span class="keyword" id="1371011">range</span>&nbsp;<span class="ident" id="1371017">paxHeaders</span>&nbsp;<span class="op" id="1371028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371032">fmt</span><span class="op" id="1371035">.</span><span class="ident" id="1371036">Fprint</span><span class="op" id="1371042">(</span><span class="op" id="1371043">&amp;</span><span class="ident" id="1371044">buf</span><span class="op" id="1371047">,</span>&nbsp;<span class="ident" id="1371049">paxHeader</span><span class="op" id="1371058">(</span><span class="ident" id="1371059">k</span><span class="op" id="1371060">+</span><span class="string" id="1371061">&#34;=&#34;</span><span class="op" id="1371064">+</span><span class="ident" id="1371065">v</span><span class="op" id="1371066">)</span><span class="op" id="1371067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371074">ext</span><span class="op" id="1371077">.</span><span class="ident" id="1371078">Size</span>&nbsp;<span class="op" id="1371083">=</span>&nbsp;<span class="ident" id="1371085">int64</span><span class="op" id="1371090">(</span><span class="builtinfunc" id="1371091">len</span><span class="op" id="1371094">(</span><span class="ident" id="1371095">buf</span><span class="op" id="1371098">.</span><span class="ident" id="1371099">Bytes</span><span class="op" id="1371104">(</span><span class="op" id="1371105">)</span><span class="op" id="1371106">)</span><span class="op" id="1371107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371110">if</span>&nbsp;<span class="ident" id="1371113">err</span>&nbsp;<span class="op" id="1371117">:=</span>&nbsp;<span class="ident" id="1371120">tw</span><span class="op" id="1371122">.</span><span class="ident" id="1371123">writeHeader</span><span class="op" id="1371134">(</span><span class="ident" id="1371135">ext</span><span class="op" id="1371138">,</span>&nbsp;<span class="builtintype" id="1371140">false</span><span class="op" id="1371145">)</span><span class="op" id="1371146">;</span>&nbsp;<span class="ident" id="1371148">err</span>&nbsp;<span class="op" id="1371152">!=</span>&nbsp;<span class="ident" id="1371155">nil</span>&nbsp;<span class="op" id="1371159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371163">return</span>&nbsp;<span class="ident" id="1371170">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371178">if</span>&nbsp;<span class="ident" id="1371181">_</span><span class="op" id="1371182">,</span>&nbsp;<span class="ident" id="1371184">err</span>&nbsp;<span class="op" id="1371188">:=</span>&nbsp;<span class="ident" id="1371191">tw</span><span class="op" id="1371193">.</span><span class="ident" id="1371194">Write</span><span class="op" id="1371199">(</span><span class="ident" id="1371200">buf</span><span class="op" id="1371203">.</span><span class="ident" id="1371204">Bytes</span><span class="op" id="1371209">(</span><span class="op" id="1371210">)</span><span class="op" id="1371211">)</span><span class="op" id="1371212">;</span>&nbsp;<span class="ident" id="1371214">err</span>&nbsp;<span class="op" id="1371218">!=</span>&nbsp;<span class="ident" id="1371221">nil</span>&nbsp;<span class="op" id="1371225">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371229">return</span>&nbsp;<span class="ident" id="1371236">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371244">if</span>&nbsp;<span class="ident" id="1371247">err</span>&nbsp;<span class="op" id="1371251">:=</span>&nbsp;<span class="ident" id="1371254">tw</span><span class="op" id="1371256">.</span><span class="ident" id="1371257">Flush</span><span class="op" id="1371262">(</span><span class="op" id="1371263">)</span><span class="op" id="1371264">;</span>&nbsp;<span class="ident" id="1371266">err</span>&nbsp;<span class="op" id="1371270">!=</span>&nbsp;<span class="ident" id="1371273">nil</span>&nbsp;<span class="op" id="1371277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371281">return</span>&nbsp;<span class="ident" id="1371288">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371293">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371296">return</span>&nbsp;<span class="ident" id="1371303">nil</span><br>
<span class="lineno"></span><span class="op" id="1371307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1371310">//&nbsp;paxHeader&nbsp;formats&nbsp;a&nbsp;single&nbsp;pax&nbsp;record,&nbsp;prefixing&nbsp;it&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="1371393">func</span>&nbsp;<span class="ident" id="1371398">paxHeader</span><span class="op" id="1371407">(</span><span class="ident" id="1371408">msg</span>&nbsp;<span class="builtintype" id="1371412">string</span><span class="op" id="1371418">)</span>&nbsp;<span class="builtintype" id="1371420">string</span>&nbsp;<span class="op" id="1371427">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371430">const</span>&nbsp;<span class="ident" id="1371436">padding</span>&nbsp;<span class="op" id="1371444">=</span>&nbsp;<span class="num" id="1371446">2</span>&nbsp;<span class="comment" id="1371448">//&nbsp;Extra&nbsp;padding&nbsp;for&nbsp;space&nbsp;and&nbsp;newline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371488">size</span>&nbsp;<span class="op" id="1371493">:=</span>&nbsp;<span class="builtinfunc" id="1371496">len</span><span class="op" id="1371499">(</span><span class="ident" id="1371500">msg</span><span class="op" id="1371503">)</span>&nbsp;<span class="op" id="1371505">+</span>&nbsp;<span class="ident" id="1371507">padding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371516">size</span>&nbsp;<span class="op" id="1371521">+=</span>&nbsp;<span class="builtinfunc" id="1371524">len</span><span class="op" id="1371527">(</span><span class="ident" id="1371528">strconv</span><span class="op" id="1371535">.</span><span class="ident" id="1371536">Itoa</span><span class="op" id="1371540">(</span><span class="ident" id="1371541">size</span><span class="op" id="1371545">)</span><span class="op" id="1371546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371549">record</span>&nbsp;<span class="op" id="1371556">:=</span>&nbsp;<span class="ident" id="1371559">fmt</span><span class="op" id="1371562">.</span><span class="ident" id="1371563">Sprintf</span><span class="op" id="1371570">(</span><span class="string" id="1371571">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="1371580">,</span>&nbsp;<span class="ident" id="1371582">size</span><span class="op" id="1371586">,</span>&nbsp;<span class="ident" id="1371588">msg</span><span class="op" id="1371591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371594">if</span>&nbsp;<span class="builtinfunc" id="1371597">len</span><span class="op" id="1371600">(</span><span class="ident" id="1371601">record</span><span class="op" id="1371607">)</span>&nbsp;<span class="op" id="1371609">!=</span>&nbsp;<span class="ident" id="1371612">size</span>&nbsp;<span class="op" id="1371617">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1371621">//&nbsp;Final&nbsp;adjustment&nbsp;if&nbsp;adding&nbsp;size&nbsp;increased</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1371668">//&nbsp;the&nbsp;number&nbsp;of&nbsp;digits&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371702">size</span>&nbsp;<span class="op" id="1371707">=</span>&nbsp;<span class="builtinfunc" id="1371709">len</span><span class="op" id="1371712">(</span><span class="ident" id="1371713">record</span><span class="op" id="1371719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371723">record</span>&nbsp;<span class="op" id="1371730">=</span>&nbsp;<span class="ident" id="1371732">fmt</span><span class="op" id="1371735">.</span><span class="ident" id="1371736">Sprintf</span><span class="op" id="1371743">(</span><span class="string" id="1371744">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="1371753">,</span>&nbsp;<span class="ident" id="1371755">size</span><span class="op" id="1371759">,</span>&nbsp;<span class="ident" id="1371761">msg</span><span class="op" id="1371764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371767">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371770">return</span>&nbsp;<span class="ident" id="1371777">record</span><br>
<span class="lineno"></span><span class="op" id="1371784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1371787">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;current&nbsp;entry&nbsp;in&nbsp;the&nbsp;tar&nbsp;archive.</span><br>
<span class="lineno"></span><span class="comment" id="1371844">//&nbsp;Write&nbsp;returns&nbsp;the&nbsp;error&nbsp;ErrWriteTooLong&nbsp;if&nbsp;more&nbsp;than</span><br>
<span class="lineno">355</span><span class="comment" id="1371900">//&nbsp;hdr.Size&nbsp;bytes&nbsp;are&nbsp;written&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span><span class="keyword" id="1371949">func</span>&nbsp;<span class="op" id="1371954">(</span><span class="ident" id="1371955">tw</span>&nbsp;<span class="op" id="1371958">*</span><span class="ident" id="1371959">Writer</span><span class="op" id="1371965">)</span>&nbsp;<span class="ident" id="1371967">Write</span><span class="op" id="1371972">(</span><span class="ident" id="1371973">b</span>&nbsp;<span class="op" id="1371975">[</span><span class="op" id="1371976">]</span><span class="builtintype" id="1371977">byte</span><span class="op" id="1371981">)</span>&nbsp;<span class="op" id="1371983">(</span><span class="ident" id="1371984">n</span>&nbsp;<span class="builtintype" id="1371986">int</span><span class="op" id="1371989">,</span>&nbsp;<span class="ident" id="1371991">err</span>&nbsp;<span class="builtintype" id="1371995">error</span><span class="op" id="1372000">)</span>&nbsp;<span class="op" id="1372002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372005">if</span>&nbsp;<span class="ident" id="1372008">tw</span><span class="op" id="1372010">.</span><span class="ident" id="1372011">closed</span>&nbsp;<span class="op" id="1372018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372022">err</span>&nbsp;<span class="op" id="1372026">=</span>&nbsp;<span class="ident" id="1372028">ErrWriteTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372046">return</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372057">overwrite</span>&nbsp;<span class="op" id="1372067">:=</span>&nbsp;<span class="builtintype" id="1372070">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372077">if</span>&nbsp;<span class="ident" id="1372080">int64</span><span class="op" id="1372085">(</span><span class="builtinfunc" id="1372086">len</span><span class="op" id="1372089">(</span><span class="ident" id="1372090">b</span><span class="op" id="1372091">)</span><span class="op" id="1372092">)</span>&nbsp;<span class="op" id="1372094">&gt;</span>&nbsp;<span class="ident" id="1372096">tw</span><span class="op" id="1372098">.</span><span class="ident" id="1372099">nb</span>&nbsp;<span class="op" id="1372102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372106">b</span>&nbsp;<span class="op" id="1372108">=</span>&nbsp;<span class="ident" id="1372110">b</span><span class="op" id="1372111">[</span><span class="num" id="1372112">0</span><span class="op" id="1372113">:</span><span class="ident" id="1372114">tw</span><span class="op" id="1372116">.</span><span class="ident" id="1372117">nb</span><span class="op" id="1372119">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372123">overwrite</span>&nbsp;<span class="op" id="1372133">=</span>&nbsp;<span class="builtintype" id="1372135">true</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372144">n</span><span class="op" id="1372145">,</span>&nbsp;<span class="ident" id="1372147">err</span>&nbsp;<span class="op" id="1372151">=</span>&nbsp;<span class="ident" id="1372153">tw</span><span class="op" id="1372155">.</span><span class="ident" id="1372156">w</span><span class="op" id="1372157">.</span><span class="ident" id="1372158">Write</span><span class="op" id="1372163">(</span><span class="ident" id="1372164">b</span><span class="op" id="1372165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372168">tw</span><span class="op" id="1372170">.</span><span class="ident" id="1372171">nb</span>&nbsp;<span class="op" id="1372174">-=</span>&nbsp;<span class="ident" id="1372177">int64</span><span class="op" id="1372182">(</span><span class="ident" id="1372183">n</span><span class="op" id="1372184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372187">if</span>&nbsp;<span class="ident" id="1372190">err</span>&nbsp;<span class="op" id="1372194">==</span>&nbsp;<span class="ident" id="1372197">nil</span>&nbsp;<span class="op" id="1372201">&amp;&amp;</span>&nbsp;<span class="ident" id="1372204">overwrite</span>&nbsp;<span class="op" id="1372214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372218">err</span>&nbsp;<span class="op" id="1372222">=</span>&nbsp;<span class="ident" id="1372224">ErrWriteTooLong</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372242">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372253">tw</span><span class="op" id="1372255">.</span><span class="ident" id="1372256">err</span>&nbsp;<span class="op" id="1372260">=</span>&nbsp;<span class="ident" id="1372262">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372267">return</span><br>
<span class="lineno"></span><span class="op" id="1372274">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="comment" id="1372277">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;tar&nbsp;archive,&nbsp;flushing&nbsp;any&nbsp;unwritten</span><br>
<span class="lineno"></span><span class="comment" id="1372333">//&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="1372367">func</span>&nbsp;<span class="op" id="1372372">(</span><span class="ident" id="1372373">tw</span>&nbsp;<span class="op" id="1372376">*</span><span class="ident" id="1372377">Writer</span><span class="op" id="1372383">)</span>&nbsp;<span class="ident" id="1372385">Close</span><span class="op" id="1372390">(</span><span class="op" id="1372391">)</span>&nbsp;<span class="builtintype" id="1372393">error</span>&nbsp;<span class="op" id="1372399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372402">if</span>&nbsp;<span class="ident" id="1372405">tw</span><span class="op" id="1372407">.</span><span class="ident" id="1372408">err</span>&nbsp;<span class="op" id="1372412">!=</span>&nbsp;<span class="ident" id="1372415">nil</span>&nbsp;<span class="op" id="1372419">||</span>&nbsp;<span class="ident" id="1372422">tw</span><span class="op" id="1372424">.</span><span class="ident" id="1372425">closed</span>&nbsp;<span class="op" id="1372432">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372436">return</span>&nbsp;<span class="ident" id="1372443">tw</span><span class="op" id="1372445">.</span><span class="ident" id="1372446">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372454">tw</span><span class="op" id="1372456">.</span><span class="ident" id="1372457">Flush</span><span class="op" id="1372462">(</span><span class="op" id="1372463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372466">tw</span><span class="op" id="1372468">.</span><span class="ident" id="1372469">closed</span>&nbsp;<span class="op" id="1372476">=</span>&nbsp;<span class="builtintype" id="1372478">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372484">if</span>&nbsp;<span class="ident" id="1372487">tw</span><span class="op" id="1372489">.</span><span class="ident" id="1372490">err</span>&nbsp;<span class="op" id="1372494">!=</span>&nbsp;<span class="ident" id="1372497">nil</span>&nbsp;<span class="op" id="1372501">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372505">return</span>&nbsp;<span class="ident" id="1372512">tw</span><span class="op" id="1372514">.</span><span class="ident" id="1372515">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1372524">//&nbsp;trailer:&nbsp;two&nbsp;zero&nbsp;blocks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372553">for</span>&nbsp;<span class="ident" id="1372557">i</span>&nbsp;<span class="op" id="1372559">:=</span>&nbsp;<span class="num" id="1372562">0</span><span class="op" id="1372563">;</span>&nbsp;<span class="ident" id="1372565">i</span>&nbsp;<span class="op" id="1372567">&lt;</span>&nbsp;<span class="num" id="1372569">2</span><span class="op" id="1372570">;</span>&nbsp;<span class="ident" id="1372572">i</span><span class="op" id="1372573">++</span>&nbsp;<span class="op" id="1372576">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372580">_</span><span class="op" id="1372581">,</span>&nbsp;<span class="ident" id="1372583">tw</span><span class="op" id="1372585">.</span><span class="ident" id="1372586">err</span>&nbsp;<span class="op" id="1372590">=</span>&nbsp;<span class="ident" id="1372592">tw</span><span class="op" id="1372594">.</span><span class="ident" id="1372595">w</span><span class="op" id="1372596">.</span><span class="ident" id="1372597">Write</span><span class="op" id="1372602">(</span><span class="ident" id="1372603">zeroBlock</span><span class="op" id="1372612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372616">if</span>&nbsp;<span class="ident" id="1372619">tw</span><span class="op" id="1372621">.</span><span class="ident" id="1372622">err</span>&nbsp;<span class="op" id="1372626">!=</span>&nbsp;<span class="ident" id="1372629">nil</span>&nbsp;<span class="op" id="1372633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372638">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372649">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372652">return</span>&nbsp;<span class="ident" id="1372659">tw</span><span class="op" id="1372661">.</span><span class="ident" id="1372662">err</span><br>
<span class="lineno"></span><span class="op" id="1372666">}</span>
</div>
</body>
</html>
