<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/mail</h2>
<ul>
<li><a href="/gostd/net/mail/message.go.html">message.go</a></li>
<li><a href="/gostd/net/mail/message_test.go.html">message_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5592848">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5592903">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5592957">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5593008">/*<br>
<span class="lineno"></span>Package&nbsp;mail&nbsp;implements&nbsp;parsing&nbsp;of&nbsp;mail&nbsp;messages.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>For&nbsp;the&nbsp;most&nbsp;part,&nbsp;this&nbsp;package&nbsp;follows&nbsp;the&nbsp;syntax&nbsp;as&nbsp;specified&nbsp;by&nbsp;RFC&nbsp;5322.<br>
<span class="lineno"></span>Notable&nbsp;divergences:<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp*&nbsp;Obsolete&nbsp;address&nbsp;formats&nbsp;are&nbsp;not&nbsp;parsed,&nbsp;including&nbsp;addresses&nbsp;with<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;embedded&nbsp;route&nbsp;information.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*&nbsp;Group&nbsp;addresses&nbsp;are&nbsp;not&nbsp;parsed.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*&nbsp;The&nbsp;full&nbsp;range&nbsp;of&nbsp;spacing&nbsp;(the&nbsp;CFWS&nbsp;syntax&nbsp;element)&nbsp;is&nbsp;not&nbsp;supported,<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;such&nbsp;as&nbsp;breaking&nbsp;addresses&nbsp;across&nbsp;lines.<br>
<span class="lineno">15</span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="5593415">package</span>&nbsp;<span class="ident" id="5593423">mail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5593429">import</span>&nbsp;<span class="op" id="5593436">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5593439">&#34;bufio&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5593448">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5593457">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5593476">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5593486">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5593493">&#34;io&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5593499">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5593512">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5593519">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5593536">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5593547">&#34;strings&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5593558">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5593566">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="5593576">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5593579">var</span>&nbsp;<span class="ident" id="5593583">debug</span>&nbsp;<span class="op" id="5593589">=</span>&nbsp;<span class="ident" id="5593591">debugT</span><span class="op" id="5593597">(</span><span class="builtintype" id="5593598">false</span><span class="op" id="5593603">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="5593606">type</span>&nbsp;<span class="ident" id="5593611">debugT</span>&nbsp;<span class="builtintype" id="5593618">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5593624">func</span>&nbsp;<span class="op" id="5593629">(</span><span class="ident" id="5593630">d</span>&nbsp;<span class="ident" id="5593632">debugT</span><span class="op" id="5593638">)</span>&nbsp;<span class="ident" id="5593640">Printf</span><span class="op" id="5593646">(</span><span class="ident" id="5593647">format</span>&nbsp;<span class="builtintype" id="5593654">string</span><span class="op" id="5593660">,</span>&nbsp;<span class="ident" id="5593662">args</span>&nbsp;<span class="op" id="5593667">...</span><span class="keyword" id="5593670">interface</span><span class="op" id="5593679">{</span><span class="op" id="5593680">}</span><span class="op" id="5593681">)</span>&nbsp;<span class="op" id="5593683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5593686">if</span>&nbsp;<span class="ident" id="5593689">d</span>&nbsp;<span class="op" id="5593691">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593695">log</span><span class="op" id="5593698">.</span><span class="ident" id="5593699">Printf</span><span class="op" id="5593705">(</span><span class="ident" id="5593706">format</span><span class="op" id="5593712">,</span>&nbsp;<span class="ident" id="5593714">args</span><span class="op" id="5593718">...</span><span class="op" id="5593721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5593724">}</span><br>
<span class="lineno"></span><span class="op" id="5593726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5593729">//&nbsp;A&nbsp;Message&nbsp;represents&nbsp;a&nbsp;parsed&nbsp;mail&nbsp;message.</span><br>
<span class="lineno">45</span><span class="keyword" id="5593776">type</span>&nbsp;<span class="ident" id="5593781">Message</span>&nbsp;<span class="keyword" id="5593789">struct</span>&nbsp;<span class="op" id="5593796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593799">Header</span>&nbsp;<span class="ident" id="5593806">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593814">Body</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5593821">io</span><span class="op" id="5593823">.</span><span class="ident" id="5593824">Reader</span><br>
<span class="lineno"></span><span class="op" id="5593831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5593834">//&nbsp;ReadMessage&nbsp;reads&nbsp;a&nbsp;message&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="5593873">//&nbsp;The&nbsp;headers&nbsp;are&nbsp;parsed,&nbsp;and&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;message&nbsp;will&nbsp;be&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="5593946">//&nbsp;for&nbsp;reading&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5593969">func</span>&nbsp;<span class="ident" id="5593974">ReadMessage</span><span class="op" id="5593985">(</span><span class="ident" id="5593986">r</span>&nbsp;<span class="ident" id="5593988">io</span><span class="op" id="5593990">.</span><span class="ident" id="5593991">Reader</span><span class="op" id="5593997">)</span>&nbsp;<span class="op" id="5593999">(</span><span class="ident" id="5594000">msg</span>&nbsp;<span class="op" id="5594004">*</span><span class="ident" id="5594005">Message</span><span class="op" id="5594012">,</span>&nbsp;<span class="ident" id="5594014">err</span>&nbsp;<span class="builtintype" id="5594018">error</span><span class="op" id="5594023">)</span>&nbsp;<span class="op" id="5594025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594028">tp</span>&nbsp;<span class="op" id="5594031">:=</span>&nbsp;<span class="ident" id="5594034">textproto</span><span class="op" id="5594043">.</span><span class="ident" id="5594044">NewReader</span><span class="op" id="5594053">(</span><span class="ident" id="5594054">bufio</span><span class="op" id="5594059">.</span><span class="ident" id="5594060">NewReader</span><span class="op" id="5594069">(</span><span class="ident" id="5594070">r</span><span class="op" id="5594071">)</span><span class="op" id="5594072">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594076">hdr</span><span class="op" id="5594079">,</span>&nbsp;<span class="ident" id="5594081">err</span>&nbsp;<span class="op" id="5594085">:=</span>&nbsp;<span class="ident" id="5594088">tp</span><span class="op" id="5594090">.</span><span class="ident" id="5594091">ReadMIMEHeader</span><span class="op" id="5594105">(</span><span class="op" id="5594106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5594109">if</span>&nbsp;<span class="ident" id="5594112">err</span>&nbsp;<span class="op" id="5594116">!=</span>&nbsp;<span class="ident" id="5594119">nil</span>&nbsp;<span class="op" id="5594123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5594127">return</span>&nbsp;<span class="ident" id="5594134">nil</span><span class="op" id="5594137">,</span>&nbsp;<span class="ident" id="5594139">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5594144">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5594148">return</span>&nbsp;<span class="op" id="5594155">&amp;</span><span class="ident" id="5594156">Message</span><span class="op" id="5594163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594167">Header</span><span class="op" id="5594173">:</span>&nbsp;<span class="ident" id="5594175">Header</span><span class="op" id="5594181">(</span><span class="ident" id="5594182">hdr</span><span class="op" id="5594185">)</span><span class="op" id="5594186">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594190">Body</span><span class="op" id="5594194">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5594198">tp</span><span class="op" id="5594200">.</span><span class="ident" id="5594201">R</span><span class="op" id="5594202">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5594205">}</span><span class="op" id="5594206">,</span>&nbsp;<span class="ident" id="5594208">nil</span><br>
<span class="lineno">65</span><span class="op" id="5594212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5594215">//&nbsp;Layouts&nbsp;suitable&nbsp;for&nbsp;passing&nbsp;to&nbsp;time.Parse.</span><br>
<span class="lineno"></span><span class="comment" id="5594262">//&nbsp;These&nbsp;are&nbsp;tried&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="5594291">var</span>&nbsp;<span class="ident" id="5594295">dateLayouts</span>&nbsp;<span class="op" id="5594307">[</span><span class="op" id="5594308">]</span><span class="builtintype" id="5594309">string</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="5594317">func</span>&nbsp;<span class="ident" id="5594322">init</span><span class="op" id="5594326">(</span><span class="op" id="5594327">)</span>&nbsp;<span class="op" id="5594329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5594332">//&nbsp;Generate&nbsp;layouts&nbsp;based&nbsp;on&nbsp;RFC&nbsp;5322,&nbsp;section&nbsp;3.3.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594386">dows</span>&nbsp;<span class="op" id="5594391">:=</span>&nbsp;<span class="op" id="5594394">[</span><span class="op" id="5594395">...</span><span class="op" id="5594398">]</span><span class="builtintype" id="5594399">string</span><span class="op" id="5594405">{</span><span class="string" id="5594406">&#34;&#34;</span><span class="op" id="5594408">,</span>&nbsp;<span class="string" id="5594410">&#34;Mon,&nbsp;&#34;</span><span class="op" id="5594417">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5594421">//&nbsp;day-of-week</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594437">days</span>&nbsp;<span class="op" id="5594442">:=</span>&nbsp;<span class="op" id="5594445">[</span><span class="op" id="5594446">...</span><span class="op" id="5594449">]</span><span class="builtintype" id="5594450">string</span><span class="op" id="5594456">{</span><span class="string" id="5594457">&#34;2&#34;</span><span class="op" id="5594460">,</span>&nbsp;<span class="string" id="5594462">&#34;02&#34;</span><span class="op" id="5594466">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5594472">//&nbsp;day&nbsp;=&nbsp;1*2DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594491">years</span>&nbsp;<span class="op" id="5594497">:=</span>&nbsp;<span class="op" id="5594500">[</span><span class="op" id="5594501">...</span><span class="op" id="5594504">]</span><span class="builtintype" id="5594505">string</span><span class="op" id="5594511">{</span><span class="string" id="5594512">&#34;2006&#34;</span><span class="op" id="5594518">,</span>&nbsp;<span class="string" id="5594520">&#34;06&#34;</span><span class="op" id="5594524">}</span>&nbsp;<span class="comment" id="5594526">//&nbsp;year&nbsp;=&nbsp;4*DIGIT&nbsp;/&nbsp;2*DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594555">seconds</span>&nbsp;<span class="op" id="5594563">:=</span>&nbsp;<span class="op" id="5594566">[</span><span class="op" id="5594567">...</span><span class="op" id="5594570">]</span><span class="builtintype" id="5594571">string</span><span class="op" id="5594577">{</span><span class="string" id="5594578">&#34;:05&#34;</span><span class="op" id="5594583">,</span>&nbsp;<span class="string" id="5594585">&#34;&#34;</span><span class="op" id="5594587">}</span>&nbsp;&nbsp;<span class="comment" id="5594590">//&nbsp;second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5594601">//&nbsp;&#34;-0700&nbsp;(MST)&#34;&nbsp;is&nbsp;not&nbsp;in&nbsp;RFC&nbsp;5322,&nbsp;but&nbsp;is&nbsp;common.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594654">zones</span>&nbsp;<span class="op" id="5594660">:=</span>&nbsp;<span class="op" id="5594663">[</span><span class="op" id="5594664">...</span><span class="op" id="5594667">]</span><span class="builtintype" id="5594668">string</span><span class="op" id="5594674">{</span><span class="string" id="5594675">&#34;-0700&#34;</span><span class="op" id="5594682">,</span>&nbsp;<span class="string" id="5594684">&#34;MST&#34;</span><span class="op" id="5594689">,</span>&nbsp;<span class="string" id="5594691">&#34;-0700&nbsp;(MST)&#34;</span><span class="op" id="5594704">}</span>&nbsp;<span class="comment" id="5594706">//&nbsp;zone&nbsp;=&nbsp;((&#34;+&#34;&nbsp;/&nbsp;&#34;-&#34;)&nbsp;4DIGIT)&nbsp;/&nbsp;&#34;GMT&#34;&nbsp;/&nbsp;...</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5594753">for</span>&nbsp;<span class="ident" id="5594757">_</span><span class="op" id="5594758">,</span>&nbsp;<span class="ident" id="5594760">dow</span>&nbsp;<span class="op" id="5594764">:=</span>&nbsp;<span class="keyword" id="5594767">range</span>&nbsp;<span class="ident" id="5594773">dows</span>&nbsp;<span class="op" id="5594778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5594782">for</span>&nbsp;<span class="ident" id="5594786">_</span><span class="op" id="5594787">,</span>&nbsp;<span class="ident" id="5594789">day</span>&nbsp;<span class="op" id="5594793">:=</span>&nbsp;<span class="keyword" id="5594796">range</span>&nbsp;<span class="ident" id="5594802">days</span>&nbsp;<span class="op" id="5594807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5594812">for</span>&nbsp;<span class="ident" id="5594816">_</span><span class="op" id="5594817">,</span>&nbsp;<span class="ident" id="5594819">year</span>&nbsp;<span class="op" id="5594824">:=</span>&nbsp;<span class="keyword" id="5594827">range</span>&nbsp;<span class="ident" id="5594833">years</span>&nbsp;<span class="op" id="5594839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5594845">for</span>&nbsp;<span class="ident" id="5594849">_</span><span class="op" id="5594850">,</span>&nbsp;<span class="ident" id="5594852">second</span>&nbsp;<span class="op" id="5594859">:=</span>&nbsp;<span class="keyword" id="5594862">range</span>&nbsp;<span class="ident" id="5594868">seconds</span>&nbsp;<span class="op" id="5594876">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5594883">for</span>&nbsp;<span class="ident" id="5594887">_</span><span class="op" id="5594888">,</span>&nbsp;<span class="ident" id="5594890">zone</span>&nbsp;<span class="op" id="5594895">:=</span>&nbsp;<span class="keyword" id="5594898">range</span>&nbsp;<span class="ident" id="5594904">zones</span>&nbsp;<span class="op" id="5594910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594918">s</span>&nbsp;<span class="op" id="5594920">:=</span>&nbsp;<span class="ident" id="5594923">dow</span>&nbsp;<span class="op" id="5594927">+</span>&nbsp;<span class="ident" id="5594929">day</span>&nbsp;<span class="op" id="5594933">+</span>&nbsp;<span class="string" id="5594935">&#34;&nbsp;Jan&nbsp;&#34;</span>&nbsp;<span class="op" id="5594943">+</span>&nbsp;<span class="ident" id="5594945">year</span>&nbsp;<span class="op" id="5594950">+</span>&nbsp;<span class="string" id="5594952">&#34;&nbsp;15:04&#34;</span>&nbsp;<span class="op" id="5594961">+</span>&nbsp;<span class="ident" id="5594963">second</span>&nbsp;<span class="op" id="5594970">+</span>&nbsp;<span class="string" id="5594972">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="5594976">+</span>&nbsp;<span class="ident" id="5594978">zone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594989">dateLayouts</span>&nbsp;<span class="op" id="5595001">=</span>&nbsp;<span class="builtinfunc" id="5595003">append</span><span class="op" id="5595009">(</span><span class="ident" id="5595010">dateLayouts</span><span class="op" id="5595021">,</span>&nbsp;<span class="ident" id="5595023">s</span><span class="op" id="5595024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5595031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5595037">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5595042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5595046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5595049">}</span><br>
<span class="lineno"></span><span class="op" id="5595051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="5595054">func</span>&nbsp;<span class="ident" id="5595059">parseDate</span><span class="op" id="5595068">(</span><span class="ident" id="5595069">date</span>&nbsp;<span class="builtintype" id="5595074">string</span><span class="op" id="5595080">)</span>&nbsp;<span class="op" id="5595082">(</span><span class="ident" id="5595083">time</span><span class="op" id="5595087">.</span><span class="ident" id="5595088">Time</span><span class="op" id="5595092">,</span>&nbsp;<span class="builtintype" id="5595094">error</span><span class="op" id="5595099">)</span>&nbsp;<span class="op" id="5595101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5595104">for</span>&nbsp;<span class="ident" id="5595108">_</span><span class="op" id="5595109">,</span>&nbsp;<span class="ident" id="5595111">layout</span>&nbsp;<span class="op" id="5595118">:=</span>&nbsp;<span class="keyword" id="5595121">range</span>&nbsp;<span class="ident" id="5595127">dateLayouts</span>&nbsp;<span class="op" id="5595139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5595143">t</span><span class="op" id="5595144">,</span>&nbsp;<span class="ident" id="5595146">err</span>&nbsp;<span class="op" id="5595150">:=</span>&nbsp;<span class="ident" id="5595153">time</span><span class="op" id="5595157">.</span><span class="ident" id="5595158">Parse</span><span class="op" id="5595163">(</span><span class="ident" id="5595164">layout</span><span class="op" id="5595170">,</span>&nbsp;<span class="ident" id="5595172">date</span><span class="op" id="5595176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5595180">if</span>&nbsp;<span class="ident" id="5595183">err</span>&nbsp;<span class="op" id="5595187">==</span>&nbsp;<span class="ident" id="5595190">nil</span>&nbsp;<span class="op" id="5595194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5595199">return</span>&nbsp;<span class="ident" id="5595206">t</span><span class="op" id="5595207">,</span>&nbsp;<span class="ident" id="5595209">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5595215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5595218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5595221">return</span>&nbsp;<span class="ident" id="5595228">time</span><span class="op" id="5595232">.</span><span class="ident" id="5595233">Time</span><span class="op" id="5595237">{</span><span class="op" id="5595238">}</span><span class="op" id="5595239">,</span>&nbsp;<span class="ident" id="5595241">errors</span><span class="op" id="5595247">.</span><span class="ident" id="5595248">New</span><span class="op" id="5595251">(</span><span class="string" id="5595252">&#34;mail:&nbsp;header&nbsp;could&nbsp;not&nbsp;be&nbsp;parsed&#34;</span><span class="op" id="5595286">)</span><br>
<span class="lineno"></span><span class="op" id="5595288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="5595291">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;a&nbsp;mail&nbsp;message&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5595360">type</span>&nbsp;<span class="ident" id="5595365">Header</span>&nbsp;<span class="keyword" id="5595372">map</span><span class="op" id="5595375">[</span><span class="builtintype" id="5595376">string</span><span class="op" id="5595382">]</span><span class="op" id="5595383">[</span><span class="op" id="5595384">]</span><span class="builtintype" id="5595385">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5595393">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span><span class="comment" id="5595452">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno">110</span><span class="keyword" id="5595519">func</span>&nbsp;<span class="op" id="5595524">(</span><span class="ident" id="5595525">h</span>&nbsp;<span class="ident" id="5595527">Header</span><span class="op" id="5595533">)</span>&nbsp;<span class="ident" id="5595535">Get</span><span class="op" id="5595538">(</span><span class="ident" id="5595539">key</span>&nbsp;<span class="builtintype" id="5595543">string</span><span class="op" id="5595549">)</span>&nbsp;<span class="builtintype" id="5595551">string</span>&nbsp;<span class="op" id="5595558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5595561">return</span>&nbsp;<span class="ident" id="5595568">textproto</span><span class="op" id="5595577">.</span><span class="ident" id="5595578">MIMEHeader</span><span class="op" id="5595588">(</span><span class="ident" id="5595589">h</span><span class="op" id="5595590">)</span><span class="op" id="5595591">.</span><span class="ident" id="5595592">Get</span><span class="op" id="5595595">(</span><span class="ident" id="5595596">key</span><span class="op" id="5595599">)</span><br>
<span class="lineno"></span><span class="op" id="5595601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5595604">var</span>&nbsp;<span class="ident" id="5595608">ErrHeaderNotPresent</span>&nbsp;<span class="op" id="5595628">=</span>&nbsp;<span class="ident" id="5595630">errors</span><span class="op" id="5595636">.</span><span class="ident" id="5595637">New</span><span class="op" id="5595640">(</span><span class="string" id="5595641">&#34;mail:&nbsp;header&nbsp;not&nbsp;in&nbsp;message&#34;</span><span class="op" id="5595670">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="5595673">//&nbsp;Date&nbsp;parses&nbsp;the&nbsp;Date&nbsp;header&nbsp;field.</span><br>
<span class="lineno"></span><span class="keyword" id="5595711">func</span>&nbsp;<span class="op" id="5595716">(</span><span class="ident" id="5595717">h</span>&nbsp;<span class="ident" id="5595719">Header</span><span class="op" id="5595725">)</span>&nbsp;<span class="ident" id="5595727">Date</span><span class="op" id="5595731">(</span><span class="op" id="5595732">)</span>&nbsp;<span class="op" id="5595734">(</span><span class="ident" id="5595735">time</span><span class="op" id="5595739">.</span><span class="ident" id="5595740">Time</span><span class="op" id="5595744">,</span>&nbsp;<span class="builtintype" id="5595746">error</span><span class="op" id="5595751">)</span>&nbsp;<span class="op" id="5595753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5595756">hdr</span>&nbsp;<span class="op" id="5595760">:=</span>&nbsp;<span class="ident" id="5595763">h</span><span class="op" id="5595764">.</span><span class="ident" id="5595765">Get</span><span class="op" id="5595768">(</span><span class="string" id="5595769">&#34;Date&#34;</span><span class="op" id="5595775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5595778">if</span>&nbsp;<span class="ident" id="5595781">hdr</span>&nbsp;<span class="op" id="5595785">==</span>&nbsp;<span class="string" id="5595788">&#34;&#34;</span>&nbsp;<span class="op" id="5595791">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5595795">return</span>&nbsp;<span class="ident" id="5595802">time</span><span class="op" id="5595806">.</span><span class="ident" id="5595807">Time</span><span class="op" id="5595811">{</span><span class="op" id="5595812">}</span><span class="op" id="5595813">,</span>&nbsp;<span class="ident" id="5595815">ErrHeaderNotPresent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5595836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5595839">return</span>&nbsp;<span class="ident" id="5595846">parseDate</span><span class="op" id="5595855">(</span><span class="ident" id="5595856">hdr</span><span class="op" id="5595859">)</span><br>
<span class="lineno"></span><span class="op" id="5595861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="5595864">//&nbsp;AddressList&nbsp;parses&nbsp;the&nbsp;named&nbsp;header&nbsp;field&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="5595933">func</span>&nbsp;<span class="op" id="5595938">(</span><span class="ident" id="5595939">h</span>&nbsp;<span class="ident" id="5595941">Header</span><span class="op" id="5595947">)</span>&nbsp;<span class="ident" id="5595949">AddressList</span><span class="op" id="5595960">(</span><span class="ident" id="5595961">key</span>&nbsp;<span class="builtintype" id="5595965">string</span><span class="op" id="5595971">)</span>&nbsp;<span class="op" id="5595973">(</span><span class="op" id="5595974">[</span><span class="op" id="5595975">]</span><span class="op" id="5595976">*</span><span class="ident" id="5595977">Address</span><span class="op" id="5595984">,</span>&nbsp;<span class="builtintype" id="5595986">error</span><span class="op" id="5595991">)</span>&nbsp;<span class="op" id="5595993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5595996">hdr</span>&nbsp;<span class="op" id="5596000">:=</span>&nbsp;<span class="ident" id="5596003">h</span><span class="op" id="5596004">.</span><span class="ident" id="5596005">Get</span><span class="op" id="5596008">(</span><span class="ident" id="5596009">key</span><span class="op" id="5596012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5596015">if</span>&nbsp;<span class="ident" id="5596018">hdr</span>&nbsp;<span class="op" id="5596022">==</span>&nbsp;<span class="string" id="5596025">&#34;&#34;</span>&nbsp;<span class="op" id="5596028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5596032">return</span>&nbsp;<span class="ident" id="5596039">nil</span><span class="op" id="5596042">,</span>&nbsp;<span class="ident" id="5596044">ErrHeaderNotPresent</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5596065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5596068">return</span>&nbsp;<span class="ident" id="5596075">ParseAddressList</span><span class="op" id="5596091">(</span><span class="ident" id="5596092">hdr</span><span class="op" id="5596095">)</span><br>
<span class="lineno"></span><span class="op" id="5596097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5596100">//&nbsp;Address&nbsp;represents&nbsp;a&nbsp;single&nbsp;mail&nbsp;address.</span><br>
<span class="lineno">135</span><span class="comment" id="5596145">//&nbsp;An&nbsp;address&nbsp;such&nbsp;as&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;&nbsp;is&nbsp;represented</span><br>
<span class="lineno"></span><span class="comment" id="5596213">//&nbsp;as&nbsp;Address{Name:&nbsp;&#34;Barry&nbsp;Gibbs&#34;,&nbsp;Address:&nbsp;&#34;bg@example.com&#34;}.</span><br>
<span class="lineno"></span><span class="keyword" id="5596276">type</span>&nbsp;<span class="ident" id="5596281">Address</span>&nbsp;<span class="keyword" id="5596289">struct</span>&nbsp;<span class="op" id="5596296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5596299">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5596307">string</span>&nbsp;<span class="comment" id="5596314">//&nbsp;Proper&nbsp;name;&nbsp;may&nbsp;be&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5596345">Address</span>&nbsp;<span class="builtintype" id="5596353">string</span>&nbsp;<span class="comment" id="5596360">//&nbsp;user@domain</span><br>
<span class="lineno">140</span><span class="op" id="5596375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5596378">//&nbsp;Parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address,&nbsp;e.g.&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="5596451">func</span>&nbsp;<span class="ident" id="5596456">ParseAddress</span><span class="op" id="5596468">(</span><span class="ident" id="5596469">address</span>&nbsp;<span class="builtintype" id="5596477">string</span><span class="op" id="5596483">)</span>&nbsp;<span class="op" id="5596485">(</span><span class="op" id="5596486">*</span><span class="ident" id="5596487">Address</span><span class="op" id="5596494">,</span>&nbsp;<span class="builtintype" id="5596496">error</span><span class="op" id="5596501">)</span>&nbsp;<span class="op" id="5596503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5596506">return</span>&nbsp;<span class="ident" id="5596513">newAddrParser</span><span class="op" id="5596526">(</span><span class="ident" id="5596527">address</span><span class="op" id="5596534">)</span><span class="op" id="5596535">.</span><span class="ident" id="5596536">parseAddress</span><span class="op" id="5596548">(</span><span class="op" id="5596549">)</span><br>
<span class="lineno">145</span><span class="op" id="5596551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5596554">//&nbsp;ParseAddressList&nbsp;parses&nbsp;the&nbsp;given&nbsp;string&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="5596622">func</span>&nbsp;<span class="ident" id="5596627">ParseAddressList</span><span class="op" id="5596643">(</span><span class="ident" id="5596644">list</span>&nbsp;<span class="builtintype" id="5596649">string</span><span class="op" id="5596655">)</span>&nbsp;<span class="op" id="5596657">(</span><span class="op" id="5596658">[</span><span class="op" id="5596659">]</span><span class="op" id="5596660">*</span><span class="ident" id="5596661">Address</span><span class="op" id="5596668">,</span>&nbsp;<span class="builtintype" id="5596670">error</span><span class="op" id="5596675">)</span>&nbsp;<span class="op" id="5596677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5596680">return</span>&nbsp;<span class="ident" id="5596687">newAddrParser</span><span class="op" id="5596700">(</span><span class="ident" id="5596701">list</span><span class="op" id="5596705">)</span><span class="op" id="5596706">.</span><span class="ident" id="5596707">parseAddressList</span><span class="op" id="5596723">(</span><span class="op" id="5596724">)</span><br>
<span class="lineno">150</span><span class="op" id="5596726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5596729">//&nbsp;String&nbsp;formats&nbsp;the&nbsp;address&nbsp;as&nbsp;a&nbsp;valid&nbsp;RFC&nbsp;5322&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="5596788">//&nbsp;If&nbsp;the&nbsp;address&#39;s&nbsp;name&nbsp;contains&nbsp;non-ASCII&nbsp;characters</span><br>
<span class="lineno"></span><span class="comment" id="5596843">//&nbsp;the&nbsp;name&nbsp;will&nbsp;be&nbsp;rendered&nbsp;according&nbsp;to&nbsp;RFC&nbsp;2047.</span><br>
<span class="lineno">155</span><span class="keyword" id="5596895">func</span>&nbsp;<span class="op" id="5596900">(</span><span class="ident" id="5596901">a</span>&nbsp;<span class="op" id="5596903">*</span><span class="ident" id="5596904">Address</span><span class="op" id="5596911">)</span>&nbsp;<span class="ident" id="5596913">String</span><span class="op" id="5596919">(</span><span class="op" id="5596920">)</span>&nbsp;<span class="builtintype" id="5596922">string</span>&nbsp;<span class="op" id="5596929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5596932">s</span>&nbsp;<span class="op" id="5596934">:=</span>&nbsp;<span class="string" id="5596937">&#34;&lt;&#34;</span>&nbsp;<span class="op" id="5596941">+</span>&nbsp;<span class="ident" id="5596943">a</span><span class="op" id="5596944">.</span><span class="ident" id="5596945">Address</span>&nbsp;<span class="op" id="5596953">+</span>&nbsp;<span class="string" id="5596955">&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5596960">if</span>&nbsp;<span class="ident" id="5596963">a</span><span class="op" id="5596964">.</span><span class="ident" id="5596965">Name</span>&nbsp;<span class="op" id="5596970">==</span>&nbsp;<span class="string" id="5596973">&#34;&#34;</span>&nbsp;<span class="op" id="5596976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5596980">return</span>&nbsp;<span class="ident" id="5596987">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5596990">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5596993">//&nbsp;If&nbsp;every&nbsp;character&nbsp;is&nbsp;printable&nbsp;ASCII,&nbsp;quoting&nbsp;is&nbsp;simple.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597055">allPrintable</span>&nbsp;<span class="op" id="5597068">:=</span>&nbsp;<span class="builtintype" id="5597071">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597077">for</span>&nbsp;<span class="ident" id="5597081">i</span>&nbsp;<span class="op" id="5597083">:=</span>&nbsp;<span class="num" id="5597086">0</span><span class="op" id="5597087">;</span>&nbsp;<span class="ident" id="5597089">i</span>&nbsp;<span class="op" id="5597091">&lt;</span>&nbsp;<span class="builtinfunc" id="5597093">len</span><span class="op" id="5597096">(</span><span class="ident" id="5597097">a</span><span class="op" id="5597098">.</span><span class="ident" id="5597099">Name</span><span class="op" id="5597103">)</span><span class="op" id="5597104">;</span>&nbsp;<span class="ident" id="5597106">i</span><span class="op" id="5597107">++</span>&nbsp;<span class="op" id="5597110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5597114">//&nbsp;isWSP&nbsp;here&nbsp;should&nbsp;actually&nbsp;be&nbsp;isFWS,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5597156">//&nbsp;but&nbsp;we&nbsp;don&#39;t&nbsp;support&nbsp;folding&nbsp;yet.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597195">if</span>&nbsp;<span class="op" id="5597198">!</span><span class="ident" id="5597199">isVchar</span><span class="op" id="5597206">(</span><span class="ident" id="5597207">a</span><span class="op" id="5597208">.</span><span class="ident" id="5597209">Name</span><span class="op" id="5597213">[</span><span class="ident" id="5597214">i</span><span class="op" id="5597215">]</span><span class="op" id="5597216">)</span>&nbsp;<span class="op" id="5597218">&amp;&amp;</span>&nbsp;<span class="op" id="5597221">!</span><span class="ident" id="5597222">isWSP</span><span class="op" id="5597227">(</span><span class="ident" id="5597228">a</span><span class="op" id="5597229">.</span><span class="ident" id="5597230">Name</span><span class="op" id="5597234">[</span><span class="ident" id="5597235">i</span><span class="op" id="5597236">]</span><span class="op" id="5597237">)</span>&nbsp;<span class="op" id="5597239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597244">allPrintable</span>&nbsp;<span class="op" id="5597257">=</span>&nbsp;<span class="builtintype" id="5597259">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597268">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5597276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5597279">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597282">if</span>&nbsp;<span class="ident" id="5597285">allPrintable</span>&nbsp;<span class="op" id="5597298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597302">b</span>&nbsp;<span class="op" id="5597304">:=</span>&nbsp;<span class="ident" id="5597307">bytes</span><span class="op" id="5597312">.</span><span class="ident" id="5597313">NewBufferString</span><span class="op" id="5597328">(</span><span class="string" id="5597329">`&#34;`</span><span class="op" id="5597332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597336">for</span>&nbsp;<span class="ident" id="5597340">i</span>&nbsp;<span class="op" id="5597342">:=</span>&nbsp;<span class="num" id="5597345">0</span><span class="op" id="5597346">;</span>&nbsp;<span class="ident" id="5597348">i</span>&nbsp;<span class="op" id="5597350">&lt;</span>&nbsp;<span class="builtinfunc" id="5597352">len</span><span class="op" id="5597355">(</span><span class="ident" id="5597356">a</span><span class="op" id="5597357">.</span><span class="ident" id="5597358">Name</span><span class="op" id="5597362">)</span><span class="op" id="5597363">;</span>&nbsp;<span class="ident" id="5597365">i</span><span class="op" id="5597366">++</span>&nbsp;<span class="op" id="5597369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597374">if</span>&nbsp;<span class="op" id="5597377">!</span><span class="ident" id="5597378">isQtext</span><span class="op" id="5597385">(</span><span class="ident" id="5597386">a</span><span class="op" id="5597387">.</span><span class="ident" id="5597388">Name</span><span class="op" id="5597392">[</span><span class="ident" id="5597393">i</span><span class="op" id="5597394">]</span><span class="op" id="5597395">)</span>&nbsp;<span class="op" id="5597397">&amp;&amp;</span>&nbsp;<span class="op" id="5597400">!</span><span class="ident" id="5597401">isWSP</span><span class="op" id="5597406">(</span><span class="ident" id="5597407">a</span><span class="op" id="5597408">.</span><span class="ident" id="5597409">Name</span><span class="op" id="5597413">[</span><span class="ident" id="5597414">i</span><span class="op" id="5597415">]</span><span class="op" id="5597416">)</span>&nbsp;<span class="op" id="5597418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597424">b</span><span class="op" id="5597425">.</span><span class="ident" id="5597426">WriteByte</span><span class="op" id="5597435">(</span><span class="string" id="5597436">&#39;\\&#39;</span><span class="op" id="5597440">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5597445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597450">b</span><span class="op" id="5597451">.</span><span class="ident" id="5597452">WriteByte</span><span class="op" id="5597461">(</span><span class="ident" id="5597462">a</span><span class="op" id="5597463">.</span><span class="ident" id="5597464">Name</span><span class="op" id="5597468">[</span><span class="ident" id="5597469">i</span><span class="op" id="5597470">]</span><span class="op" id="5597471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5597475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597479">b</span><span class="op" id="5597480">.</span><span class="ident" id="5597481">WriteString</span><span class="op" id="5597492">(</span><span class="string" id="5597493">`&#34;&nbsp;`</span><span class="op" id="5597497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597501">b</span><span class="op" id="5597502">.</span><span class="ident" id="5597503">WriteString</span><span class="op" id="5597514">(</span><span class="ident" id="5597515">s</span><span class="op" id="5597516">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597520">return</span>&nbsp;<span class="ident" id="5597527">b</span><span class="op" id="5597528">.</span><span class="ident" id="5597529">String</span><span class="op" id="5597535">(</span><span class="op" id="5597536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5597539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5597543">//&nbsp;UTF-8&nbsp;&#34;Q&#34;&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597566">b</span>&nbsp;<span class="op" id="5597568">:=</span>&nbsp;<span class="ident" id="5597571">bytes</span><span class="op" id="5597576">.</span><span class="ident" id="5597577">NewBufferString</span><span class="op" id="5597592">(</span><span class="string" id="5597593">&#34;=?utf-8?q?&#34;</span><span class="op" id="5597605">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597608">for</span>&nbsp;<span class="ident" id="5597612">i</span>&nbsp;<span class="op" id="5597614">:=</span>&nbsp;<span class="num" id="5597617">0</span><span class="op" id="5597618">;</span>&nbsp;<span class="ident" id="5597620">i</span>&nbsp;<span class="op" id="5597622">&lt;</span>&nbsp;<span class="builtinfunc" id="5597624">len</span><span class="op" id="5597627">(</span><span class="ident" id="5597628">a</span><span class="op" id="5597629">.</span><span class="ident" id="5597630">Name</span><span class="op" id="5597634">)</span><span class="op" id="5597635">;</span>&nbsp;<span class="ident" id="5597637">i</span><span class="op" id="5597638">++</span>&nbsp;<span class="op" id="5597641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597645">switch</span>&nbsp;<span class="ident" id="5597652">c</span>&nbsp;<span class="op" id="5597654">:=</span>&nbsp;<span class="ident" id="5597657">a</span><span class="op" id="5597658">.</span><span class="ident" id="5597659">Name</span><span class="op" id="5597663">[</span><span class="ident" id="5597664">i</span><span class="op" id="5597665">]</span><span class="op" id="5597666">;</span>&nbsp;<span class="op" id="5597668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597672">case</span>&nbsp;<span class="ident" id="5597677">c</span>&nbsp;<span class="op" id="5597679">==</span>&nbsp;<span class="string" id="5597682">&#39;&nbsp;&#39;</span><span class="op" id="5597685">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597690">b</span><span class="op" id="5597691">.</span><span class="ident" id="5597692">WriteByte</span><span class="op" id="5597701">(</span><span class="string" id="5597702">&#39;_&#39;</span><span class="op" id="5597705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597709">case</span>&nbsp;<span class="ident" id="5597714">isVchar</span><span class="op" id="5597721">(</span><span class="ident" id="5597722">c</span><span class="op" id="5597723">)</span>&nbsp;<span class="op" id="5597725">&amp;&amp;</span>&nbsp;<span class="ident" id="5597728">c</span>&nbsp;<span class="op" id="5597730">!=</span>&nbsp;<span class="string" id="5597733">&#39;=&#39;</span>&nbsp;<span class="op" id="5597737">&amp;&amp;</span>&nbsp;<span class="ident" id="5597740">c</span>&nbsp;<span class="op" id="5597742">!=</span>&nbsp;<span class="string" id="5597745">&#39;?&#39;</span>&nbsp;<span class="op" id="5597749">&amp;&amp;</span>&nbsp;<span class="ident" id="5597752">c</span>&nbsp;<span class="op" id="5597754">!=</span>&nbsp;<span class="string" id="5597757">&#39;_&#39;</span><span class="op" id="5597760">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597765">b</span><span class="op" id="5597766">.</span><span class="ident" id="5597767">WriteByte</span><span class="op" id="5597776">(</span><span class="ident" id="5597777">c</span><span class="op" id="5597778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597782">default</span><span class="op" id="5597789">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597794">fmt</span><span class="op" id="5597797">.</span><span class="ident" id="5597798">Fprintf</span><span class="op" id="5597805">(</span><span class="ident" id="5597806">b</span><span class="op" id="5597807">,</span>&nbsp;<span class="string" id="5597809">&#34;=%02X&#34;</span><span class="op" id="5597816">,</span>&nbsp;<span class="ident" id="5597818">c</span><span class="op" id="5597819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5597823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5597826">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597829">b</span><span class="op" id="5597830">.</span><span class="ident" id="5597831">WriteString</span><span class="op" id="5597842">(</span><span class="string" id="5597843">&#34;?=&nbsp;&#34;</span><span class="op" id="5597848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597851">b</span><span class="op" id="5597852">.</span><span class="ident" id="5597853">WriteString</span><span class="op" id="5597864">(</span><span class="ident" id="5597865">s</span><span class="op" id="5597866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597869">return</span>&nbsp;<span class="ident" id="5597876">b</span><span class="op" id="5597877">.</span><span class="ident" id="5597878">String</span><span class="op" id="5597884">(</span><span class="op" id="5597885">)</span><br>
<span class="lineno"></span><span class="op" id="5597887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="5597890">type</span>&nbsp;<span class="ident" id="5597895">addrParser</span>&nbsp;<span class="op" id="5597906">[</span><span class="op" id="5597907">]</span><span class="builtintype" id="5597908">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5597914">func</span>&nbsp;<span class="ident" id="5597919">newAddrParser</span><span class="op" id="5597932">(</span><span class="ident" id="5597933">s</span>&nbsp;<span class="builtintype" id="5597935">string</span><span class="op" id="5597941">)</span>&nbsp;<span class="op" id="5597943">*</span><span class="ident" id="5597944">addrParser</span>&nbsp;<span class="op" id="5597955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597958">p</span>&nbsp;<span class="op" id="5597960">:=</span>&nbsp;<span class="ident" id="5597963">addrParser</span><span class="op" id="5597973">(</span><span class="ident" id="5597974">s</span><span class="op" id="5597975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597978">return</span>&nbsp;<span class="op" id="5597985">&amp;</span><span class="ident" id="5597986">p</span><br>
<span class="lineno">205</span><span class="op" id="5597988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5597991">func</span>&nbsp;<span class="op" id="5597996">(</span><span class="ident" id="5597997">p</span>&nbsp;<span class="op" id="5597999">*</span><span class="ident" id="5598000">addrParser</span><span class="op" id="5598010">)</span>&nbsp;<span class="ident" id="5598012">parseAddressList</span><span class="op" id="5598028">(</span><span class="op" id="5598029">)</span>&nbsp;<span class="op" id="5598031">(</span><span class="op" id="5598032">[</span><span class="op" id="5598033">]</span><span class="op" id="5598034">*</span><span class="ident" id="5598035">Address</span><span class="op" id="5598042">,</span>&nbsp;<span class="builtintype" id="5598044">error</span><span class="op" id="5598049">)</span>&nbsp;<span class="op" id="5598051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598054">var</span>&nbsp;<span class="ident" id="5598058">list</span>&nbsp;<span class="op" id="5598063">[</span><span class="op" id="5598064">]</span><span class="op" id="5598065">*</span><span class="ident" id="5598066">Address</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598075">for</span>&nbsp;<span class="op" id="5598079">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598083">p</span><span class="op" id="5598084">.</span><span class="ident" id="5598085">skipSpace</span><span class="op" id="5598094">(</span><span class="op" id="5598095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598099">addr</span><span class="op" id="5598103">,</span>&nbsp;<span class="ident" id="5598105">err</span>&nbsp;<span class="op" id="5598109">:=</span>&nbsp;<span class="ident" id="5598112">p</span><span class="op" id="5598113">.</span><span class="ident" id="5598114">parseAddress</span><span class="op" id="5598126">(</span><span class="op" id="5598127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598131">if</span>&nbsp;<span class="ident" id="5598134">err</span>&nbsp;<span class="op" id="5598138">!=</span>&nbsp;<span class="ident" id="5598141">nil</span>&nbsp;<span class="op" id="5598145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598150">return</span>&nbsp;<span class="ident" id="5598157">nil</span><span class="op" id="5598160">,</span>&nbsp;<span class="ident" id="5598162">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5598168">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598172">list</span>&nbsp;<span class="op" id="5598177">=</span>&nbsp;<span class="builtinfunc" id="5598179">append</span><span class="op" id="5598185">(</span><span class="ident" id="5598186">list</span><span class="op" id="5598190">,</span>&nbsp;<span class="ident" id="5598192">addr</span><span class="op" id="5598196">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598201">p</span><span class="op" id="5598202">.</span><span class="ident" id="5598203">skipSpace</span><span class="op" id="5598212">(</span><span class="op" id="5598213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598217">if</span>&nbsp;<span class="ident" id="5598220">p</span><span class="op" id="5598221">.</span><span class="ident" id="5598222">empty</span><span class="op" id="5598227">(</span><span class="op" id="5598228">)</span>&nbsp;<span class="op" id="5598230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598235">break</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5598243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598247">if</span>&nbsp;<span class="op" id="5598250">!</span><span class="ident" id="5598251">p</span><span class="op" id="5598252">.</span><span class="ident" id="5598253">consume</span><span class="op" id="5598260">(</span><span class="string" id="5598261">&#39;,&#39;</span><span class="op" id="5598264">)</span>&nbsp;<span class="op" id="5598266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598271">return</span>&nbsp;<span class="ident" id="5598278">nil</span><span class="op" id="5598281">,</span>&nbsp;<span class="ident" id="5598283">errors</span><span class="op" id="5598289">.</span><span class="ident" id="5598290">New</span><span class="op" id="5598293">(</span><span class="string" id="5598294">&#34;mail:&nbsp;expected&nbsp;comma&#34;</span><span class="op" id="5598316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5598320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5598323">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598326">return</span>&nbsp;<span class="ident" id="5598333">list</span><span class="op" id="5598337">,</span>&nbsp;<span class="ident" id="5598339">nil</span><br>
<span class="lineno"></span><span class="op" id="5598343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5598346">//&nbsp;parseAddress&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5598414">func</span>&nbsp;<span class="op" id="5598419">(</span><span class="ident" id="5598420">p</span>&nbsp;<span class="op" id="5598422">*</span><span class="ident" id="5598423">addrParser</span><span class="op" id="5598433">)</span>&nbsp;<span class="ident" id="5598435">parseAddress</span><span class="op" id="5598447">(</span><span class="op" id="5598448">)</span>&nbsp;<span class="op" id="5598450">(</span><span class="ident" id="5598451">addr</span>&nbsp;<span class="op" id="5598456">*</span><span class="ident" id="5598457">Address</span><span class="op" id="5598464">,</span>&nbsp;<span class="ident" id="5598466">err</span>&nbsp;<span class="builtintype" id="5598470">error</span><span class="op" id="5598475">)</span>&nbsp;<span class="op" id="5598477">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598480">debug</span><span class="op" id="5598485">.</span><span class="ident" id="5598486">Printf</span><span class="op" id="5598492">(</span><span class="string" id="5598493">&#34;parseAddress:&nbsp;%q&#34;</span><span class="op" id="5598511">,</span>&nbsp;<span class="op" id="5598513">*</span><span class="ident" id="5598514">p</span><span class="op" id="5598515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598518">p</span><span class="op" id="5598519">.</span><span class="ident" id="5598520">skipSpace</span><span class="op" id="5598529">(</span><span class="op" id="5598530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598533">if</span>&nbsp;<span class="ident" id="5598536">p</span><span class="op" id="5598537">.</span><span class="ident" id="5598538">empty</span><span class="op" id="5598543">(</span><span class="op" id="5598544">)</span>&nbsp;<span class="op" id="5598546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598550">return</span>&nbsp;<span class="ident" id="5598557">nil</span><span class="op" id="5598560">,</span>&nbsp;<span class="ident" id="5598562">errors</span><span class="op" id="5598568">.</span><span class="ident" id="5598569">New</span><span class="op" id="5598572">(</span><span class="string" id="5598573">&#34;mail:&nbsp;no&nbsp;address&#34;</span><span class="op" id="5598591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5598594">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5598598">//&nbsp;address&nbsp;=&nbsp;name-addr&nbsp;/&nbsp;addr-spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5598634">//&nbsp;TODO(dsymonds):&nbsp;Support&nbsp;parsing&nbsp;group&nbsp;address.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5598686">//&nbsp;addr-spec&nbsp;has&nbsp;a&nbsp;more&nbsp;restricted&nbsp;grammar&nbsp;than&nbsp;name-addr,</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5598746">//&nbsp;so&nbsp;try&nbsp;parsing&nbsp;it&nbsp;first,&nbsp;and&nbsp;fallback&nbsp;to&nbsp;name-addr.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5598802">//&nbsp;TODO(dsymonds):&nbsp;Is&nbsp;this&nbsp;really&nbsp;correct?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598846">spec</span><span class="op" id="5598850">,</span>&nbsp;<span class="ident" id="5598852">err</span>&nbsp;<span class="op" id="5598856">:=</span>&nbsp;<span class="ident" id="5598859">p</span><span class="op" id="5598860">.</span><span class="ident" id="5598861">consumeAddrSpec</span><span class="op" id="5598876">(</span><span class="op" id="5598877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598880">if</span>&nbsp;<span class="ident" id="5598883">err</span>&nbsp;<span class="op" id="5598887">==</span>&nbsp;<span class="ident" id="5598890">nil</span>&nbsp;<span class="op" id="5598894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598898">return</span>&nbsp;<span class="op" id="5598905">&amp;</span><span class="ident" id="5598906">Address</span><span class="op" id="5598913">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598918">Address</span><span class="op" id="5598925">:</span>&nbsp;<span class="ident" id="5598927">spec</span><span class="op" id="5598931">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5598935">}</span><span class="op" id="5598936">,</span>&nbsp;<span class="ident" id="5598938">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5598943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598946">debug</span><span class="op" id="5598951">.</span><span class="ident" id="5598952">Printf</span><span class="op" id="5598958">(</span><span class="string" id="5598959">&#34;parseAddress:&nbsp;not&nbsp;an&nbsp;addr-spec:&nbsp;%v&#34;</span><span class="op" id="5598995">,</span>&nbsp;<span class="ident" id="5598997">err</span><span class="op" id="5599000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599003">debug</span><span class="op" id="5599008">.</span><span class="ident" id="5599009">Printf</span><span class="op" id="5599015">(</span><span class="string" id="5599016">&#34;parseAddress:&nbsp;state&nbsp;is&nbsp;now&nbsp;%q&#34;</span><span class="op" id="5599047">,</span>&nbsp;<span class="op" id="5599049">*</span><span class="ident" id="5599050">p</span><span class="op" id="5599051">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5599055">//&nbsp;display-name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599072">var</span>&nbsp;<span class="ident" id="5599076">displayName</span>&nbsp;<span class="builtintype" id="5599088">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599096">if</span>&nbsp;<span class="ident" id="5599099">p</span><span class="op" id="5599100">.</span><span class="ident" id="5599101">peek</span><span class="op" id="5599105">(</span><span class="op" id="5599106">)</span>&nbsp;<span class="op" id="5599108">!=</span>&nbsp;<span class="string" id="5599111">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5599115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599119">displayName</span><span class="op" id="5599130">,</span>&nbsp;<span class="ident" id="5599132">err</span>&nbsp;<span class="op" id="5599136">=</span>&nbsp;<span class="ident" id="5599138">p</span><span class="op" id="5599139">.</span><span class="ident" id="5599140">consumePhrase</span><span class="op" id="5599153">(</span><span class="op" id="5599154">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599158">if</span>&nbsp;<span class="ident" id="5599161">err</span>&nbsp;<span class="op" id="5599165">!=</span>&nbsp;<span class="ident" id="5599168">nil</span>&nbsp;<span class="op" id="5599172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599177">return</span>&nbsp;<span class="ident" id="5599184">nil</span><span class="op" id="5599187">,</span>&nbsp;<span class="ident" id="5599189">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599201">debug</span><span class="op" id="5599206">.</span><span class="ident" id="5599207">Printf</span><span class="op" id="5599213">(</span><span class="string" id="5599214">&#34;parseAddress:&nbsp;displayName=%q&#34;</span><span class="op" id="5599244">,</span>&nbsp;<span class="ident" id="5599246">displayName</span><span class="op" id="5599257">)</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5599261">//&nbsp;angle-addr&nbsp;=&nbsp;&#34;&lt;&#34;&nbsp;addr-spec&nbsp;&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599296">p</span><span class="op" id="5599297">.</span><span class="ident" id="5599298">skipSpace</span><span class="op" id="5599307">(</span><span class="op" id="5599308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599311">if</span>&nbsp;<span class="op" id="5599314">!</span><span class="ident" id="5599315">p</span><span class="op" id="5599316">.</span><span class="ident" id="5599317">consume</span><span class="op" id="5599324">(</span><span class="string" id="5599325">&#39;&lt;&#39;</span><span class="op" id="5599328">)</span>&nbsp;<span class="op" id="5599330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599334">return</span>&nbsp;<span class="ident" id="5599341">nil</span><span class="op" id="5599344">,</span>&nbsp;<span class="ident" id="5599346">errors</span><span class="op" id="5599352">.</span><span class="ident" id="5599353">New</span><span class="op" id="5599356">(</span><span class="string" id="5599357">&#34;mail:&nbsp;no&nbsp;angle-addr&#34;</span><span class="op" id="5599378">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599384">spec</span><span class="op" id="5599388">,</span>&nbsp;<span class="ident" id="5599390">err</span>&nbsp;<span class="op" id="5599394">=</span>&nbsp;<span class="ident" id="5599396">p</span><span class="op" id="5599397">.</span><span class="ident" id="5599398">consumeAddrSpec</span><span class="op" id="5599413">(</span><span class="op" id="5599414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599417">if</span>&nbsp;<span class="ident" id="5599420">err</span>&nbsp;<span class="op" id="5599424">!=</span>&nbsp;<span class="ident" id="5599427">nil</span>&nbsp;<span class="op" id="5599431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599435">return</span>&nbsp;<span class="ident" id="5599442">nil</span><span class="op" id="5599445">,</span>&nbsp;<span class="ident" id="5599447">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599452">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599455">if</span>&nbsp;<span class="op" id="5599458">!</span><span class="ident" id="5599459">p</span><span class="op" id="5599460">.</span><span class="ident" id="5599461">consume</span><span class="op" id="5599468">(</span><span class="string" id="5599469">&#39;&gt;&#39;</span><span class="op" id="5599472">)</span>&nbsp;<span class="op" id="5599474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599478">return</span>&nbsp;<span class="ident" id="5599485">nil</span><span class="op" id="5599488">,</span>&nbsp;<span class="ident" id="5599490">errors</span><span class="op" id="5599496">.</span><span class="ident" id="5599497">New</span><span class="op" id="5599500">(</span><span class="string" id="5599501">&#34;mail:&nbsp;unclosed&nbsp;angle-addr&#34;</span><span class="op" id="5599528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599534">debug</span><span class="op" id="5599539">.</span><span class="ident" id="5599540">Printf</span><span class="op" id="5599546">(</span><span class="string" id="5599547">&#34;parseAddress:&nbsp;spec=%q&#34;</span><span class="op" id="5599570">,</span>&nbsp;<span class="ident" id="5599572">spec</span><span class="op" id="5599576">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599580">return</span>&nbsp;<span class="op" id="5599587">&amp;</span><span class="ident" id="5599588">Address</span><span class="op" id="5599595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599599">Name</span><span class="op" id="5599603">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5599608">displayName</span><span class="op" id="5599619">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599623">Address</span><span class="op" id="5599630">:</span>&nbsp;<span class="ident" id="5599632">spec</span><span class="op" id="5599636">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599639">}</span><span class="op" id="5599640">,</span>&nbsp;<span class="ident" id="5599642">nil</span><br>
<span class="lineno"></span><span class="op" id="5599646">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="5599649">//&nbsp;consumeAddrSpec&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;addr-spec&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5599722">func</span>&nbsp;<span class="op" id="5599727">(</span><span class="ident" id="5599728">p</span>&nbsp;<span class="op" id="5599730">*</span><span class="ident" id="5599731">addrParser</span><span class="op" id="5599741">)</span>&nbsp;<span class="ident" id="5599743">consumeAddrSpec</span><span class="op" id="5599758">(</span><span class="op" id="5599759">)</span>&nbsp;<span class="op" id="5599761">(</span><span class="ident" id="5599762">spec</span>&nbsp;<span class="builtintype" id="5599767">string</span><span class="op" id="5599773">,</span>&nbsp;<span class="ident" id="5599775">err</span>&nbsp;<span class="builtintype" id="5599779">error</span><span class="op" id="5599784">)</span>&nbsp;<span class="op" id="5599786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599789">debug</span><span class="op" id="5599794">.</span><span class="ident" id="5599795">Printf</span><span class="op" id="5599801">(</span><span class="string" id="5599802">&#34;consumeAddrSpec:&nbsp;%q&#34;</span><span class="op" id="5599823">,</span>&nbsp;<span class="op" id="5599825">*</span><span class="ident" id="5599826">p</span><span class="op" id="5599827">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599831">orig</span>&nbsp;<span class="op" id="5599836">:=</span>&nbsp;<span class="op" id="5599839">*</span><span class="ident" id="5599840">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599843">defer</span>&nbsp;<span class="keyword" id="5599849">func</span><span class="op" id="5599853">(</span><span class="op" id="5599854">)</span>&nbsp;<span class="op" id="5599856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599860">if</span>&nbsp;<span class="ident" id="5599863">err</span>&nbsp;<span class="op" id="5599867">!=</span>&nbsp;<span class="ident" id="5599870">nil</span>&nbsp;<span class="op" id="5599874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599879">*</span><span class="ident" id="5599880">p</span>&nbsp;<span class="op" id="5599882">=</span>&nbsp;<span class="ident" id="5599884">orig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599891">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599894">}</span><span class="op" id="5599895">(</span><span class="op" id="5599896">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5599900">//&nbsp;local-part&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599942">var</span>&nbsp;<span class="ident" id="5599946">localPart</span>&nbsp;<span class="builtintype" id="5599956">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599964">p</span><span class="op" id="5599965">.</span><span class="ident" id="5599966">skipSpace</span><span class="op" id="5599975">(</span><span class="op" id="5599976">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599979">if</span>&nbsp;<span class="ident" id="5599982">p</span><span class="op" id="5599983">.</span><span class="ident" id="5599984">empty</span><span class="op" id="5599989">(</span><span class="op" id="5599990">)</span>&nbsp;<span class="op" id="5599992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599996">return</span>&nbsp;<span class="string" id="5600003">&#34;&#34;</span><span class="op" id="5600005">,</span>&nbsp;<span class="ident" id="5600007">errors</span><span class="op" id="5600013">.</span><span class="ident" id="5600014">New</span><span class="op" id="5600017">(</span><span class="string" id="5600018">&#34;mail:&nbsp;no&nbsp;addr-spec&#34;</span><span class="op" id="5600038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5600041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600044">if</span>&nbsp;<span class="ident" id="5600047">p</span><span class="op" id="5600048">.</span><span class="ident" id="5600049">peek</span><span class="op" id="5600053">(</span><span class="op" id="5600054">)</span>&nbsp;<span class="op" id="5600056">==</span>&nbsp;<span class="string" id="5600059">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5600063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5600067">//&nbsp;quoted-string</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600086">debug</span><span class="op" id="5600091">.</span><span class="ident" id="5600092">Printf</span><span class="op" id="5600098">(</span><span class="string" id="5600099">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;quoted-string&#34;</span><span class="op" id="5600139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600143">localPart</span><span class="op" id="5600152">,</span>&nbsp;<span class="ident" id="5600154">err</span>&nbsp;<span class="op" id="5600158">=</span>&nbsp;<span class="ident" id="5600160">p</span><span class="op" id="5600161">.</span><span class="ident" id="5600162">consumeQuotedString</span><span class="op" id="5600181">(</span><span class="op" id="5600182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5600185">}</span>&nbsp;<span class="keyword" id="5600187">else</span>&nbsp;<span class="op" id="5600192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5600196">//&nbsp;dot-atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600210">debug</span><span class="op" id="5600215">.</span><span class="ident" id="5600216">Printf</span><span class="op" id="5600222">(</span><span class="string" id="5600223">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;dot-atom&#34;</span><span class="op" id="5600258">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600262">localPart</span><span class="op" id="5600271">,</span>&nbsp;<span class="ident" id="5600273">err</span>&nbsp;<span class="op" id="5600277">=</span>&nbsp;<span class="ident" id="5600279">p</span><span class="op" id="5600280">.</span><span class="ident" id="5600281">consumeAtom</span><span class="op" id="5600292">(</span><span class="builtintype" id="5600293">true</span><span class="op" id="5600297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5600300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600303">if</span>&nbsp;<span class="ident" id="5600306">err</span>&nbsp;<span class="op" id="5600310">!=</span>&nbsp;<span class="ident" id="5600313">nil</span>&nbsp;<span class="op" id="5600317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600321">debug</span><span class="op" id="5600326">.</span><span class="ident" id="5600327">Printf</span><span class="op" id="5600333">(</span><span class="string" id="5600334">&#34;consumeAddrSpec:&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="5600363">,</span>&nbsp;<span class="ident" id="5600365">err</span><span class="op" id="5600368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600372">return</span>&nbsp;<span class="string" id="5600379">&#34;&#34;</span><span class="op" id="5600381">,</span>&nbsp;<span class="ident" id="5600383">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5600388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600392">if</span>&nbsp;<span class="op" id="5600395">!</span><span class="ident" id="5600396">p</span><span class="op" id="5600397">.</span><span class="ident" id="5600398">consume</span><span class="op" id="5600405">(</span><span class="string" id="5600406">&#39;@&#39;</span><span class="op" id="5600409">)</span>&nbsp;<span class="op" id="5600411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600415">return</span>&nbsp;<span class="string" id="5600422">&#34;&#34;</span><span class="op" id="5600424">,</span>&nbsp;<span class="ident" id="5600426">errors</span><span class="op" id="5600432">.</span><span class="ident" id="5600433">New</span><span class="op" id="5600436">(</span><span class="string" id="5600437">&#34;mail:&nbsp;missing&nbsp;@&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="5600467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5600470">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5600474">//&nbsp;domain&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600513">var</span>&nbsp;<span class="ident" id="5600517">domain</span>&nbsp;<span class="builtintype" id="5600524">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600532">p</span><span class="op" id="5600533">.</span><span class="ident" id="5600534">skipSpace</span><span class="op" id="5600543">(</span><span class="op" id="5600544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600547">if</span>&nbsp;<span class="ident" id="5600550">p</span><span class="op" id="5600551">.</span><span class="ident" id="5600552">empty</span><span class="op" id="5600557">(</span><span class="op" id="5600558">)</span>&nbsp;<span class="op" id="5600560">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600564">return</span>&nbsp;<span class="string" id="5600571">&#34;&#34;</span><span class="op" id="5600573">,</span>&nbsp;<span class="ident" id="5600575">errors</span><span class="op" id="5600581">.</span><span class="ident" id="5600582">New</span><span class="op" id="5600585">(</span><span class="string" id="5600586">&#34;mail:&nbsp;no&nbsp;domain&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="5600616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5600619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5600622">//&nbsp;TODO(dsymonds):&nbsp;Handle&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600664">domain</span><span class="op" id="5600670">,</span>&nbsp;<span class="ident" id="5600672">err</span>&nbsp;<span class="op" id="5600676">=</span>&nbsp;<span class="ident" id="5600678">p</span><span class="op" id="5600679">.</span><span class="ident" id="5600680">consumeAtom</span><span class="op" id="5600691">(</span><span class="builtintype" id="5600692">true</span><span class="op" id="5600696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600699">if</span>&nbsp;<span class="ident" id="5600702">err</span>&nbsp;<span class="op" id="5600706">!=</span>&nbsp;<span class="ident" id="5600709">nil</span>&nbsp;<span class="op" id="5600713">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600717">return</span>&nbsp;<span class="string" id="5600724">&#34;&#34;</span><span class="op" id="5600726">,</span>&nbsp;<span class="ident" id="5600728">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5600733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600737">return</span>&nbsp;<span class="ident" id="5600744">localPart</span>&nbsp;<span class="op" id="5600754">+</span>&nbsp;<span class="string" id="5600756">&#34;@&#34;</span>&nbsp;<span class="op" id="5600760">+</span>&nbsp;<span class="ident" id="5600762">domain</span><span class="op" id="5600768">,</span>&nbsp;<span class="ident" id="5600770">nil</span><br>
<span class="lineno"></span><span class="op" id="5600774">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="comment" id="5600777">//&nbsp;consumePhrase&nbsp;parses&nbsp;the&nbsp;RFC&nbsp;5322&nbsp;phrase&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5600840">func</span>&nbsp;<span class="op" id="5600845">(</span><span class="ident" id="5600846">p</span>&nbsp;<span class="op" id="5600848">*</span><span class="ident" id="5600849">addrParser</span><span class="op" id="5600859">)</span>&nbsp;<span class="ident" id="5600861">consumePhrase</span><span class="op" id="5600874">(</span><span class="op" id="5600875">)</span>&nbsp;<span class="op" id="5600877">(</span><span class="ident" id="5600878">phrase</span>&nbsp;<span class="builtintype" id="5600885">string</span><span class="op" id="5600891">,</span>&nbsp;<span class="ident" id="5600893">err</span>&nbsp;<span class="builtintype" id="5600897">error</span><span class="op" id="5600902">)</span>&nbsp;<span class="op" id="5600904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600907">debug</span><span class="op" id="5600912">.</span><span class="ident" id="5600913">Printf</span><span class="op" id="5600919">(</span><span class="string" id="5600920">&#34;consumePhrase:&nbsp;[%s]&#34;</span><span class="op" id="5600941">,</span>&nbsp;<span class="op" id="5600943">*</span><span class="ident" id="5600944">p</span><span class="op" id="5600945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5600948">//&nbsp;phrase&nbsp;=&nbsp;1*word</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600968">var</span>&nbsp;<span class="ident" id="5600972">words</span>&nbsp;<span class="op" id="5600978">[</span><span class="op" id="5600979">]</span><span class="builtintype" id="5600980">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600988">for</span>&nbsp;<span class="op" id="5600992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5600996">//&nbsp;word&nbsp;=&nbsp;atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5601029">var</span>&nbsp;<span class="ident" id="5601033">word</span>&nbsp;<span class="builtintype" id="5601038">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601047">p</span><span class="op" id="5601048">.</span><span class="ident" id="5601049">skipSpace</span><span class="op" id="5601058">(</span><span class="op" id="5601059">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5601063">if</span>&nbsp;<span class="ident" id="5601066">p</span><span class="op" id="5601067">.</span><span class="ident" id="5601068">empty</span><span class="op" id="5601073">(</span><span class="op" id="5601074">)</span>&nbsp;<span class="op" id="5601076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5601081">return</span>&nbsp;<span class="string" id="5601088">&#34;&#34;</span><span class="op" id="5601090">,</span>&nbsp;<span class="ident" id="5601092">errors</span><span class="op" id="5601098">.</span><span class="ident" id="5601099">New</span><span class="op" id="5601102">(</span><span class="string" id="5601103">&#34;mail:&nbsp;missing&nbsp;phrase&#34;</span><span class="op" id="5601125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5601129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5601133">if</span>&nbsp;<span class="ident" id="5601136">p</span><span class="op" id="5601137">.</span><span class="ident" id="5601138">peek</span><span class="op" id="5601142">(</span><span class="op" id="5601143">)</span>&nbsp;<span class="op" id="5601145">==</span>&nbsp;<span class="string" id="5601148">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5601152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5601157">//&nbsp;quoted-string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601177">word</span><span class="op" id="5601181">,</span>&nbsp;<span class="ident" id="5601183">err</span>&nbsp;<span class="op" id="5601187">=</span>&nbsp;<span class="ident" id="5601189">p</span><span class="op" id="5601190">.</span><span class="ident" id="5601191">consumeQuotedString</span><span class="op" id="5601210">(</span><span class="op" id="5601211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5601215">}</span>&nbsp;<span class="keyword" id="5601217">else</span>&nbsp;<span class="op" id="5601222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5601227">//&nbsp;atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5601238">//&nbsp;We&nbsp;actually&nbsp;parse&nbsp;dot-atom&nbsp;here&nbsp;to&nbsp;be&nbsp;more&nbsp;permissive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5601298">//&nbsp;than&nbsp;what&nbsp;RFC&nbsp;5322&nbsp;specifies.</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601334">word</span><span class="op" id="5601338">,</span>&nbsp;<span class="ident" id="5601340">err</span>&nbsp;<span class="op" id="5601344">=</span>&nbsp;<span class="ident" id="5601346">p</span><span class="op" id="5601347">.</span><span class="ident" id="5601348">consumeAtom</span><span class="op" id="5601359">(</span><span class="builtintype" id="5601360">true</span><span class="op" id="5601364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5601368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5601373">//&nbsp;RFC&nbsp;2047&nbsp;encoded-word&nbsp;starts&nbsp;with&nbsp;=?,&nbsp;ends&nbsp;with&nbsp;?=,&nbsp;and&nbsp;has&nbsp;two&nbsp;other&nbsp;?s.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5601452">if</span>&nbsp;<span class="ident" id="5601455">err</span>&nbsp;<span class="op" id="5601459">==</span>&nbsp;<span class="ident" id="5601462">nil</span>&nbsp;<span class="op" id="5601466">&amp;&amp;</span>&nbsp;<span class="ident" id="5601469">strings</span><span class="op" id="5601476">.</span><span class="ident" id="5601477">HasPrefix</span><span class="op" id="5601486">(</span><span class="ident" id="5601487">word</span><span class="op" id="5601491">,</span>&nbsp;<span class="string" id="5601493">&#34;=?&#34;</span><span class="op" id="5601497">)</span>&nbsp;<span class="op" id="5601499">&amp;&amp;</span>&nbsp;<span class="ident" id="5601502">strings</span><span class="op" id="5601509">.</span><span class="ident" id="5601510">HasSuffix</span><span class="op" id="5601519">(</span><span class="ident" id="5601520">word</span><span class="op" id="5601524">,</span>&nbsp;<span class="string" id="5601526">&#34;?=&#34;</span><span class="op" id="5601530">)</span>&nbsp;<span class="op" id="5601532">&amp;&amp;</span>&nbsp;<span class="ident" id="5601535">strings</span><span class="op" id="5601542">.</span><span class="ident" id="5601543">Count</span><span class="op" id="5601548">(</span><span class="ident" id="5601549">word</span><span class="op" id="5601553">,</span>&nbsp;<span class="string" id="5601555">&#34;?&#34;</span><span class="op" id="5601558">)</span>&nbsp;<span class="op" id="5601560">==</span>&nbsp;<span class="num" id="5601563">4</span>&nbsp;<span class="op" id="5601565">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601570">word</span><span class="op" id="5601574">,</span>&nbsp;<span class="ident" id="5601576">err</span>&nbsp;<span class="op" id="5601580">=</span>&nbsp;<span class="ident" id="5601582">decodeRFC2047Word</span><span class="op" id="5601599">(</span><span class="ident" id="5601600">word</span><span class="op" id="5601604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5601608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5601613">if</span>&nbsp;<span class="ident" id="5601616">err</span>&nbsp;<span class="op" id="5601620">!=</span>&nbsp;<span class="ident" id="5601623">nil</span>&nbsp;<span class="op" id="5601627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5601632">break</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5601640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601644">debug</span><span class="op" id="5601649">.</span><span class="ident" id="5601650">Printf</span><span class="op" id="5601656">(</span><span class="string" id="5601657">&#34;consumePhrase:&nbsp;consumed&nbsp;%q&#34;</span><span class="op" id="5601685">,</span>&nbsp;<span class="ident" id="5601687">word</span><span class="op" id="5601691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601695">words</span>&nbsp;<span class="op" id="5601701">=</span>&nbsp;<span class="builtinfunc" id="5601703">append</span><span class="op" id="5601709">(</span><span class="ident" id="5601710">words</span><span class="op" id="5601715">,</span>&nbsp;<span class="ident" id="5601717">word</span><span class="op" id="5601721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5601724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5601727">//&nbsp;Ignore&nbsp;any&nbsp;error&nbsp;if&nbsp;we&nbsp;got&nbsp;at&nbsp;least&nbsp;one&nbsp;word.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5601777">if</span>&nbsp;<span class="ident" id="5601780">err</span>&nbsp;<span class="op" id="5601784">!=</span>&nbsp;<span class="ident" id="5601787">nil</span>&nbsp;<span class="op" id="5601791">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5601794">len</span><span class="op" id="5601797">(</span><span class="ident" id="5601798">words</span><span class="op" id="5601803">)</span>&nbsp;<span class="op" id="5601805">==</span>&nbsp;<span class="num" id="5601808">0</span>&nbsp;<span class="op" id="5601810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601814">debug</span><span class="op" id="5601819">.</span><span class="ident" id="5601820">Printf</span><span class="op" id="5601826">(</span><span class="string" id="5601827">&#34;consumePhrase:&nbsp;hit&nbsp;err:&nbsp;%v&#34;</span><span class="op" id="5601855">,</span>&nbsp;<span class="ident" id="5601857">err</span><span class="op" id="5601860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5601864">return</span>&nbsp;<span class="string" id="5601871">&#34;&#34;</span><span class="op" id="5601873">,</span>&nbsp;<span class="ident" id="5601875">fmt</span><span class="op" id="5601878">.</span><span class="ident" id="5601879">Errorf</span><span class="op" id="5601885">(</span><span class="string" id="5601886">&#34;mail:&nbsp;missing&nbsp;word&nbsp;in&nbsp;phrase:&nbsp;%v&#34;</span><span class="op" id="5601920">,</span>&nbsp;<span class="ident" id="5601922">err</span><span class="op" id="5601925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5601928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601931">phrase</span>&nbsp;<span class="op" id="5601938">=</span>&nbsp;<span class="ident" id="5601940">strings</span><span class="op" id="5601947">.</span><span class="ident" id="5601948">Join</span><span class="op" id="5601952">(</span><span class="ident" id="5601953">words</span><span class="op" id="5601958">,</span>&nbsp;<span class="string" id="5601960">&#34;&nbsp;&#34;</span><span class="op" id="5601963">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5601966">return</span>&nbsp;<span class="ident" id="5601973">phrase</span><span class="op" id="5601979">,</span>&nbsp;<span class="ident" id="5601981">nil</span><br>
<span class="lineno"></span><span class="op" id="5601985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5601988">//&nbsp;consumeQuotedString&nbsp;parses&nbsp;the&nbsp;quoted&nbsp;string&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5602055">func</span>&nbsp;<span class="op" id="5602060">(</span><span class="ident" id="5602061">p</span>&nbsp;<span class="op" id="5602063">*</span><span class="ident" id="5602064">addrParser</span><span class="op" id="5602074">)</span>&nbsp;<span class="ident" id="5602076">consumeQuotedString</span><span class="op" id="5602095">(</span><span class="op" id="5602096">)</span>&nbsp;<span class="op" id="5602098">(</span><span class="ident" id="5602099">qs</span>&nbsp;<span class="builtintype" id="5602102">string</span><span class="op" id="5602108">,</span>&nbsp;<span class="ident" id="5602110">err</span>&nbsp;<span class="builtintype" id="5602114">error</span><span class="op" id="5602119">)</span>&nbsp;<span class="op" id="5602121">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5602124">//&nbsp;Assume&nbsp;first&nbsp;byte&nbsp;is&nbsp;&#39;&#34;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602154">i</span>&nbsp;<span class="op" id="5602156">:=</span>&nbsp;<span class="num" id="5602159">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602162">qsb</span>&nbsp;<span class="op" id="5602166">:=</span>&nbsp;<span class="builtinfunc" id="5602169">make</span><span class="op" id="5602173">(</span><span class="op" id="5602174">[</span><span class="op" id="5602175">]</span><span class="builtintype" id="5602176">byte</span><span class="op" id="5602180">,</span>&nbsp;<span class="num" id="5602182">0</span><span class="op" id="5602183">,</span>&nbsp;<span class="num" id="5602185">10</span><span class="op" id="5602187">)</span><br>
<span class="lineno"></span><span class="ident" id="5602189">Loop</span><span class="op" id="5602193">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602196">for</span>&nbsp;<span class="op" id="5602200">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602204">if</span>&nbsp;<span class="ident" id="5602207">i</span>&nbsp;<span class="op" id="5602209">&gt;=</span>&nbsp;<span class="ident" id="5602212">p</span><span class="op" id="5602213">.</span><span class="builtinfunc" id="5602214">len</span><span class="op" id="5602217">(</span><span class="op" id="5602218">)</span>&nbsp;<span class="op" id="5602220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602225">return</span>&nbsp;<span class="string" id="5602232">&#34;&#34;</span><span class="op" id="5602234">,</span>&nbsp;<span class="ident" id="5602236">errors</span><span class="op" id="5602242">.</span><span class="ident" id="5602243">New</span><span class="op" id="5602246">(</span><span class="string" id="5602247">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="5602277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5602281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602285">switch</span>&nbsp;<span class="ident" id="5602292">c</span>&nbsp;<span class="op" id="5602294">:=</span>&nbsp;<span class="op" id="5602297">(</span><span class="op" id="5602298">*</span><span class="ident" id="5602299">p</span><span class="op" id="5602300">)</span><span class="op" id="5602301">[</span><span class="ident" id="5602302">i</span><span class="op" id="5602303">]</span><span class="op" id="5602304">;</span>&nbsp;<span class="op" id="5602306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602310">case</span>&nbsp;<span class="ident" id="5602315">c</span>&nbsp;<span class="op" id="5602317">==</span>&nbsp;<span class="string" id="5602320">&#39;&#34;&#39;</span><span class="op" id="5602323">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602328">break</span>&nbsp;<span class="ident" id="5602334">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602341">case</span>&nbsp;<span class="ident" id="5602346">c</span>&nbsp;<span class="op" id="5602348">==</span>&nbsp;<span class="string" id="5602351">&#39;\\&#39;</span><span class="op" id="5602355">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602360">if</span>&nbsp;<span class="ident" id="5602363">i</span><span class="op" id="5602364">+</span><span class="num" id="5602365">1</span>&nbsp;<span class="op" id="5602367">==</span>&nbsp;<span class="ident" id="5602370">p</span><span class="op" id="5602371">.</span><span class="builtinfunc" id="5602372">len</span><span class="op" id="5602375">(</span><span class="op" id="5602376">)</span>&nbsp;<span class="op" id="5602378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602384">return</span>&nbsp;<span class="string" id="5602391">&#34;&#34;</span><span class="op" id="5602393">,</span>&nbsp;<span class="ident" id="5602395">errors</span><span class="op" id="5602401">.</span><span class="ident" id="5602402">New</span><span class="op" id="5602405">(</span><span class="string" id="5602406">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="5602436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5602441">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602446">qsb</span>&nbsp;<span class="op" id="5602450">=</span>&nbsp;<span class="builtinfunc" id="5602452">append</span><span class="op" id="5602458">(</span><span class="ident" id="5602459">qsb</span><span class="op" id="5602462">,</span>&nbsp;<span class="op" id="5602464">(</span><span class="op" id="5602465">*</span><span class="ident" id="5602466">p</span><span class="op" id="5602467">)</span><span class="op" id="5602468">[</span><span class="ident" id="5602469">i</span><span class="op" id="5602470">+</span><span class="num" id="5602471">1</span><span class="op" id="5602472">]</span><span class="op" id="5602473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602478">i</span>&nbsp;<span class="op" id="5602480">+=</span>&nbsp;<span class="num" id="5602483">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602487">case</span>&nbsp;<span class="ident" id="5602492">isQtext</span><span class="op" id="5602499">(</span><span class="ident" id="5602500">c</span><span class="op" id="5602501">)</span><span class="op" id="5602502">,</span>&nbsp;<span class="ident" id="5602504">c</span>&nbsp;<span class="op" id="5602506">==</span>&nbsp;<span class="string" id="5602509">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="5602513">||</span>&nbsp;<span class="ident" id="5602516">c</span>&nbsp;<span class="op" id="5602518">==</span>&nbsp;<span class="string" id="5602521">&#39;\t&#39;</span><span class="op" id="5602525">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5602530">//&nbsp;qtext&nbsp;(printable&nbsp;US-ASCII&nbsp;excluding&nbsp;&#34;&nbsp;and&nbsp;\),&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5602585">//&nbsp;FWS&nbsp;(almost;&nbsp;we&#39;re&nbsp;ignoring&nbsp;CRLF)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602625">qsb</span>&nbsp;<span class="op" id="5602629">=</span>&nbsp;<span class="builtinfunc" id="5602631">append</span><span class="op" id="5602637">(</span><span class="ident" id="5602638">qsb</span><span class="op" id="5602641">,</span>&nbsp;<span class="ident" id="5602643">c</span><span class="op" id="5602644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602649">i</span><span class="op" id="5602650">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602655">default</span><span class="op" id="5602662">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602667">return</span>&nbsp;<span class="string" id="5602674">&#34;&#34;</span><span class="op" id="5602676">,</span>&nbsp;<span class="ident" id="5602678">fmt</span><span class="op" id="5602681">.</span><span class="ident" id="5602682">Errorf</span><span class="op" id="5602688">(</span><span class="string" id="5602689">&#34;mail:&nbsp;bad&nbsp;character&nbsp;in&nbsp;quoted-string:&nbsp;%q&#34;</span><span class="op" id="5602731">,</span>&nbsp;<span class="ident" id="5602733">c</span><span class="op" id="5602734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5602738">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5602741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5602744">*</span><span class="ident" id="5602745">p</span>&nbsp;<span class="op" id="5602747">=</span>&nbsp;<span class="op" id="5602749">(</span><span class="op" id="5602750">*</span><span class="ident" id="5602751">p</span><span class="op" id="5602752">)</span><span class="op" id="5602753">[</span><span class="ident" id="5602754">i</span><span class="op" id="5602755">+</span><span class="num" id="5602756">1</span><span class="op" id="5602757">:</span><span class="op" id="5602758">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602761">return</span>&nbsp;<span class="builtintype" id="5602768">string</span><span class="op" id="5602774">(</span><span class="ident" id="5602775">qsb</span><span class="op" id="5602778">)</span><span class="op" id="5602779">,</span>&nbsp;<span class="ident" id="5602781">nil</span><br>
<span class="lineno"></span><span class="op" id="5602785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="comment" id="5602788">//&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atom&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="5602846">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;dot-atom&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="5602914">func</span>&nbsp;<span class="op" id="5602919">(</span><span class="ident" id="5602920">p</span>&nbsp;<span class="op" id="5602922">*</span><span class="ident" id="5602923">addrParser</span><span class="op" id="5602933">)</span>&nbsp;<span class="ident" id="5602935">consumeAtom</span><span class="op" id="5602946">(</span><span class="ident" id="5602947">dot</span>&nbsp;<span class="builtintype" id="5602951">bool</span><span class="op" id="5602955">)</span>&nbsp;<span class="op" id="5602957">(</span><span class="ident" id="5602958">atom</span>&nbsp;<span class="builtintype" id="5602963">string</span><span class="op" id="5602969">,</span>&nbsp;<span class="ident" id="5602971">err</span>&nbsp;<span class="builtintype" id="5602975">error</span><span class="op" id="5602980">)</span>&nbsp;<span class="op" id="5602982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602985">if</span>&nbsp;<span class="op" id="5602988">!</span><span class="ident" id="5602989">isAtext</span><span class="op" id="5602996">(</span><span class="ident" id="5602997">p</span><span class="op" id="5602998">.</span><span class="ident" id="5602999">peek</span><span class="op" id="5603003">(</span><span class="op" id="5603004">)</span><span class="op" id="5603005">,</span>&nbsp;<span class="builtintype" id="5603007">false</span><span class="op" id="5603012">)</span>&nbsp;<span class="op" id="5603014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603018">return</span>&nbsp;<span class="string" id="5603025">&#34;&#34;</span><span class="op" id="5603027">,</span>&nbsp;<span class="ident" id="5603029">errors</span><span class="op" id="5603035">.</span><span class="ident" id="5603036">New</span><span class="op" id="5603039">(</span><span class="string" id="5603040">&#34;mail:&nbsp;invalid&nbsp;string&#34;</span><span class="op" id="5603062">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603068">i</span>&nbsp;<span class="op" id="5603070">:=</span>&nbsp;<span class="num" id="5603073">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603076">for</span>&nbsp;<span class="op" id="5603080">;</span>&nbsp;<span class="ident" id="5603082">i</span>&nbsp;<span class="op" id="5603084">&lt;</span>&nbsp;<span class="ident" id="5603086">p</span><span class="op" id="5603087">.</span><span class="builtinfunc" id="5603088">len</span><span class="op" id="5603091">(</span><span class="op" id="5603092">)</span>&nbsp;<span class="op" id="5603094">&amp;&amp;</span>&nbsp;<span class="ident" id="5603097">isAtext</span><span class="op" id="5603104">(</span><span class="op" id="5603105">(</span><span class="op" id="5603106">*</span><span class="ident" id="5603107">p</span><span class="op" id="5603108">)</span><span class="op" id="5603109">[</span><span class="ident" id="5603110">i</span><span class="op" id="5603111">]</span><span class="op" id="5603112">,</span>&nbsp;<span class="ident" id="5603114">dot</span><span class="op" id="5603117">)</span><span class="op" id="5603118">;</span>&nbsp;<span class="ident" id="5603120">i</span><span class="op" id="5603121">++</span>&nbsp;<span class="op" id="5603124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603130">atom</span><span class="op" id="5603134">,</span>&nbsp;<span class="op" id="5603136">*</span><span class="ident" id="5603137">p</span>&nbsp;<span class="op" id="5603139">=</span>&nbsp;<span class="builtintype" id="5603141">string</span><span class="op" id="5603147">(</span><span class="op" id="5603148">(</span><span class="op" id="5603149">*</span><span class="ident" id="5603150">p</span><span class="op" id="5603151">)</span><span class="op" id="5603152">[</span><span class="op" id="5603153">:</span><span class="ident" id="5603154">i</span><span class="op" id="5603155">]</span><span class="op" id="5603156">)</span><span class="op" id="5603157">,</span>&nbsp;<span class="op" id="5603159">(</span><span class="op" id="5603160">*</span><span class="ident" id="5603161">p</span><span class="op" id="5603162">)</span><span class="op" id="5603163">[</span><span class="ident" id="5603164">i</span><span class="op" id="5603165">:</span><span class="op" id="5603166">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603169">return</span>&nbsp;<span class="ident" id="5603176">atom</span><span class="op" id="5603180">,</span>&nbsp;<span class="ident" id="5603182">nil</span><br>
<span class="lineno"></span><span class="op" id="5603186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5603189">func</span>&nbsp;<span class="op" id="5603194">(</span><span class="ident" id="5603195">p</span>&nbsp;<span class="op" id="5603197">*</span><span class="ident" id="5603198">addrParser</span><span class="op" id="5603208">)</span>&nbsp;<span class="ident" id="5603210">consume</span><span class="op" id="5603217">(</span><span class="ident" id="5603218">c</span>&nbsp;<span class="builtintype" id="5603220">byte</span><span class="op" id="5603224">)</span>&nbsp;<span class="builtintype" id="5603226">bool</span>&nbsp;<span class="op" id="5603231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603234">if</span>&nbsp;<span class="ident" id="5603237">p</span><span class="op" id="5603238">.</span><span class="ident" id="5603239">empty</span><span class="op" id="5603244">(</span><span class="op" id="5603245">)</span>&nbsp;<span class="op" id="5603247">||</span>&nbsp;<span class="ident" id="5603250">p</span><span class="op" id="5603251">.</span><span class="ident" id="5603252">peek</span><span class="op" id="5603256">(</span><span class="op" id="5603257">)</span>&nbsp;<span class="op" id="5603259">!=</span>&nbsp;<span class="ident" id="5603262">c</span>&nbsp;<span class="op" id="5603264">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603268">return</span>&nbsp;<span class="builtintype" id="5603275">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603285">*</span><span class="ident" id="5603286">p</span>&nbsp;<span class="op" id="5603288">=</span>&nbsp;<span class="op" id="5603290">(</span><span class="op" id="5603291">*</span><span class="ident" id="5603292">p</span><span class="op" id="5603293">)</span><span class="op" id="5603294">[</span><span class="num" id="5603295">1</span><span class="op" id="5603296">:</span><span class="op" id="5603297">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603300">return</span>&nbsp;<span class="builtintype" id="5603307">true</span><br>
<span class="lineno"></span><span class="op" id="5603312">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="5603315">//&nbsp;skipSpace&nbsp;skips&nbsp;the&nbsp;leading&nbsp;space&nbsp;and&nbsp;tab&nbsp;characters.</span><br>
<span class="lineno"></span><span class="keyword" id="5603372">func</span>&nbsp;<span class="op" id="5603377">(</span><span class="ident" id="5603378">p</span>&nbsp;<span class="op" id="5603380">*</span><span class="ident" id="5603381">addrParser</span><span class="op" id="5603391">)</span>&nbsp;<span class="ident" id="5603393">skipSpace</span><span class="op" id="5603402">(</span><span class="op" id="5603403">)</span>&nbsp;<span class="op" id="5603405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603408">*</span><span class="ident" id="5603409">p</span>&nbsp;<span class="op" id="5603411">=</span>&nbsp;<span class="ident" id="5603413">bytes</span><span class="op" id="5603418">.</span><span class="ident" id="5603419">TrimLeft</span><span class="op" id="5603427">(</span><span class="op" id="5603428">*</span><span class="ident" id="5603429">p</span><span class="op" id="5603430">,</span>&nbsp;<span class="string" id="5603432">&#34;&nbsp;\t&#34;</span><span class="op" id="5603437">)</span><br>
<span class="lineno"></span><span class="op" id="5603439">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="5603442">func</span>&nbsp;<span class="op" id="5603447">(</span><span class="ident" id="5603448">p</span>&nbsp;<span class="op" id="5603450">*</span><span class="ident" id="5603451">addrParser</span><span class="op" id="5603461">)</span>&nbsp;<span class="ident" id="5603463">peek</span><span class="op" id="5603467">(</span><span class="op" id="5603468">)</span>&nbsp;<span class="builtintype" id="5603470">byte</span>&nbsp;<span class="op" id="5603475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603478">return</span>&nbsp;<span class="op" id="5603485">(</span><span class="op" id="5603486">*</span><span class="ident" id="5603487">p</span><span class="op" id="5603488">)</span><span class="op" id="5603489">[</span><span class="num" id="5603490">0</span><span class="op" id="5603491">]</span><br>
<span class="lineno"></span><span class="op" id="5603493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="5603496">func</span>&nbsp;<span class="op" id="5603501">(</span><span class="ident" id="5603502">p</span>&nbsp;<span class="op" id="5603504">*</span><span class="ident" id="5603505">addrParser</span><span class="op" id="5603515">)</span>&nbsp;<span class="ident" id="5603517">empty</span><span class="op" id="5603522">(</span><span class="op" id="5603523">)</span>&nbsp;<span class="builtintype" id="5603525">bool</span>&nbsp;<span class="op" id="5603530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603533">return</span>&nbsp;<span class="ident" id="5603540">p</span><span class="op" id="5603541">.</span><span class="builtinfunc" id="5603542">len</span><span class="op" id="5603545">(</span><span class="op" id="5603546">)</span>&nbsp;<span class="op" id="5603548">==</span>&nbsp;<span class="num" id="5603551">0</span><br>
<span class="lineno"></span><span class="op" id="5603553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5603556">func</span>&nbsp;<span class="op" id="5603561">(</span><span class="ident" id="5603562">p</span>&nbsp;<span class="op" id="5603564">*</span><span class="ident" id="5603565">addrParser</span><span class="op" id="5603575">)</span>&nbsp;<span class="builtinfunc" id="5603577">len</span><span class="op" id="5603580">(</span><span class="op" id="5603581">)</span>&nbsp;<span class="builtintype" id="5603583">int</span>&nbsp;<span class="op" id="5603587">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603590">return</span>&nbsp;<span class="builtinfunc" id="5603597">len</span><span class="op" id="5603600">(</span><span class="op" id="5603601">*</span><span class="ident" id="5603602">p</span><span class="op" id="5603603">)</span><br>
<span class="lineno"></span><span class="op" id="5603605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5603608">func</span>&nbsp;<span class="ident" id="5603613">decodeRFC2047Word</span><span class="op" id="5603630">(</span><span class="ident" id="5603631">s</span>&nbsp;<span class="builtintype" id="5603633">string</span><span class="op" id="5603639">)</span>&nbsp;<span class="op" id="5603641">(</span><span class="builtintype" id="5603642">string</span><span class="op" id="5603648">,</span>&nbsp;<span class="builtintype" id="5603650">error</span><span class="op" id="5603655">)</span>&nbsp;<span class="op" id="5603657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603660">fields</span>&nbsp;<span class="op" id="5603667">:=</span>&nbsp;<span class="ident" id="5603670">strings</span><span class="op" id="5603677">.</span><span class="ident" id="5603678">Split</span><span class="op" id="5603683">(</span><span class="ident" id="5603684">s</span><span class="op" id="5603685">,</span>&nbsp;<span class="string" id="5603687">&#34;?&#34;</span><span class="op" id="5603690">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603693">if</span>&nbsp;<span class="builtinfunc" id="5603696">len</span><span class="op" id="5603699">(</span><span class="ident" id="5603700">fields</span><span class="op" id="5603706">)</span>&nbsp;<span class="op" id="5603708">!=</span>&nbsp;<span class="num" id="5603711">5</span>&nbsp;<span class="op" id="5603713">||</span>&nbsp;<span class="ident" id="5603716">fields</span><span class="op" id="5603722">[</span><span class="num" id="5603723">0</span><span class="op" id="5603724">]</span>&nbsp;<span class="op" id="5603726">!=</span>&nbsp;<span class="string" id="5603729">&#34;=&#34;</span>&nbsp;<span class="op" id="5603733">||</span>&nbsp;<span class="ident" id="5603736">fields</span><span class="op" id="5603742">[</span><span class="num" id="5603743">4</span><span class="op" id="5603744">]</span>&nbsp;<span class="op" id="5603746">!=</span>&nbsp;<span class="string" id="5603749">&#34;=&#34;</span>&nbsp;<span class="op" id="5603753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603757">return</span>&nbsp;<span class="string" id="5603764">&#34;&#34;</span><span class="op" id="5603766">,</span>&nbsp;<span class="ident" id="5603768">errors</span><span class="op" id="5603774">.</span><span class="ident" id="5603775">New</span><span class="op" id="5603778">(</span><span class="string" id="5603779">&#34;address&nbsp;not&nbsp;RFC&nbsp;2047&nbsp;encoded&#34;</span><span class="op" id="5603809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603815">charset</span><span class="op" id="5603822">,</span>&nbsp;<span class="ident" id="5603824">enc</span>&nbsp;<span class="op" id="5603828">:=</span>&nbsp;<span class="ident" id="5603831">strings</span><span class="op" id="5603838">.</span><span class="ident" id="5603839">ToLower</span><span class="op" id="5603846">(</span><span class="ident" id="5603847">fields</span><span class="op" id="5603853">[</span><span class="num" id="5603854">1</span><span class="op" id="5603855">]</span><span class="op" id="5603856">)</span><span class="op" id="5603857">,</span>&nbsp;<span class="ident" id="5603859">strings</span><span class="op" id="5603866">.</span><span class="ident" id="5603867">ToLower</span><span class="op" id="5603874">(</span><span class="ident" id="5603875">fields</span><span class="op" id="5603881">[</span><span class="num" id="5603882">2</span><span class="op" id="5603883">]</span><span class="op" id="5603884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603887">if</span>&nbsp;<span class="ident" id="5603890">charset</span>&nbsp;<span class="op" id="5603898">!=</span>&nbsp;<span class="string" id="5603901">&#34;us-ascii&#34;</span>&nbsp;<span class="op" id="5603912">&amp;&amp;</span>&nbsp;<span class="ident" id="5603915">charset</span>&nbsp;<span class="op" id="5603923">!=</span>&nbsp;<span class="string" id="5603926">&#34;iso-8859-1&#34;</span>&nbsp;<span class="op" id="5603939">&amp;&amp;</span>&nbsp;<span class="ident" id="5603942">charset</span>&nbsp;<span class="op" id="5603950">!=</span>&nbsp;<span class="string" id="5603953">&#34;utf-8&#34;</span>&nbsp;<span class="op" id="5603961">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603965">return</span>&nbsp;<span class="string" id="5603972">&#34;&#34;</span><span class="op" id="5603974">,</span>&nbsp;<span class="ident" id="5603976">fmt</span><span class="op" id="5603979">.</span><span class="ident" id="5603980">Errorf</span><span class="op" id="5603986">(</span><span class="string" id="5603987">&#34;charset&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="5604014">,</span>&nbsp;<span class="ident" id="5604016">charset</span><span class="op" id="5604023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5604026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604030">in</span>&nbsp;<span class="op" id="5604033">:=</span>&nbsp;<span class="ident" id="5604036">bytes</span><span class="op" id="5604041">.</span><span class="ident" id="5604042">NewBufferString</span><span class="op" id="5604057">(</span><span class="ident" id="5604058">fields</span><span class="op" id="5604064">[</span><span class="num" id="5604065">3</span><span class="op" id="5604066">]</span><span class="op" id="5604067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604070">var</span>&nbsp;<span class="ident" id="5604074">r</span>&nbsp;<span class="ident" id="5604076">io</span><span class="op" id="5604078">.</span><span class="ident" id="5604079">Reader</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604087">switch</span>&nbsp;<span class="ident" id="5604094">enc</span>&nbsp;<span class="op" id="5604098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604101">case</span>&nbsp;<span class="string" id="5604106">&#34;b&#34;</span><span class="op" id="5604109">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604113">r</span>&nbsp;<span class="op" id="5604115">=</span>&nbsp;<span class="ident" id="5604117">base64</span><span class="op" id="5604123">.</span><span class="ident" id="5604124">NewDecoder</span><span class="op" id="5604134">(</span><span class="ident" id="5604135">base64</span><span class="op" id="5604141">.</span><span class="ident" id="5604142">StdEncoding</span><span class="op" id="5604153">,</span>&nbsp;<span class="ident" id="5604155">in</span><span class="op" id="5604157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604160">case</span>&nbsp;<span class="string" id="5604165">&#34;q&#34;</span><span class="op" id="5604168">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604172">r</span>&nbsp;<span class="op" id="5604174">=</span>&nbsp;<span class="ident" id="5604176">qDecoder</span><span class="op" id="5604184">{</span><span class="ident" id="5604185">r</span><span class="op" id="5604186">:</span>&nbsp;<span class="ident" id="5604188">in</span><span class="op" id="5604190">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604193">default</span><span class="op" id="5604200">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604204">return</span>&nbsp;<span class="string" id="5604211">&#34;&#34;</span><span class="op" id="5604213">,</span>&nbsp;<span class="ident" id="5604215">fmt</span><span class="op" id="5604218">.</span><span class="ident" id="5604219">Errorf</span><span class="op" id="5604225">(</span><span class="string" id="5604226">&#34;RFC&nbsp;2047&nbsp;encoding&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="5604263">,</span>&nbsp;<span class="ident" id="5604265">enc</span><span class="op" id="5604268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5604271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604275">dec</span><span class="op" id="5604278">,</span>&nbsp;<span class="ident" id="5604280">err</span>&nbsp;<span class="op" id="5604284">:=</span>&nbsp;<span class="ident" id="5604287">ioutil</span><span class="op" id="5604293">.</span><span class="ident" id="5604294">ReadAll</span><span class="op" id="5604301">(</span><span class="ident" id="5604302">r</span><span class="op" id="5604303">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604306">if</span>&nbsp;<span class="ident" id="5604309">err</span>&nbsp;<span class="op" id="5604313">!=</span>&nbsp;<span class="ident" id="5604316">nil</span>&nbsp;<span class="op" id="5604320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604324">return</span>&nbsp;<span class="string" id="5604331">&#34;&#34;</span><span class="op" id="5604333">,</span>&nbsp;<span class="ident" id="5604335">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5604340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604344">switch</span>&nbsp;<span class="ident" id="5604351">charset</span>&nbsp;<span class="op" id="5604359">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604362">case</span>&nbsp;<span class="string" id="5604367">&#34;us-ascii&#34;</span><span class="op" id="5604377">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604381">b</span>&nbsp;<span class="op" id="5604383">:=</span>&nbsp;<span class="builtinfunc" id="5604386">new</span><span class="op" id="5604389">(</span><span class="ident" id="5604390">bytes</span><span class="op" id="5604395">.</span><span class="ident" id="5604396">Buffer</span><span class="op" id="5604402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604406">for</span>&nbsp;<span class="ident" id="5604410">_</span><span class="op" id="5604411">,</span>&nbsp;<span class="ident" id="5604413">c</span>&nbsp;<span class="op" id="5604415">:=</span>&nbsp;<span class="keyword" id="5604418">range</span>&nbsp;<span class="ident" id="5604424">dec</span>&nbsp;<span class="op" id="5604428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604433">if</span>&nbsp;<span class="ident" id="5604436">c</span>&nbsp;<span class="op" id="5604438">&gt;=</span>&nbsp;<span class="num" id="5604441">0x80</span>&nbsp;<span class="op" id="5604446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604452">b</span><span class="op" id="5604453">.</span><span class="ident" id="5604454">WriteRune</span><span class="op" id="5604463">(</span><span class="ident" id="5604464">unicode</span><span class="op" id="5604471">.</span><span class="ident" id="5604472">ReplacementChar</span><span class="op" id="5604487">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5604492">}</span>&nbsp;<span class="keyword" id="5604494">else</span>&nbsp;<span class="op" id="5604499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604505">b</span><span class="op" id="5604506">.</span><span class="ident" id="5604507">WriteRune</span><span class="op" id="5604516">(</span><span class="builtintype" id="5604517">rune</span><span class="op" id="5604521">(</span><span class="ident" id="5604522">c</span><span class="op" id="5604523">)</span><span class="op" id="5604524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5604529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5604533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604537">return</span>&nbsp;<span class="ident" id="5604544">b</span><span class="op" id="5604545">.</span><span class="ident" id="5604546">String</span><span class="op" id="5604552">(</span><span class="op" id="5604553">)</span><span class="op" id="5604554">,</span>&nbsp;<span class="ident" id="5604556">nil</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604561">case</span>&nbsp;<span class="string" id="5604566">&#34;iso-8859-1&#34;</span><span class="op" id="5604578">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604582">b</span>&nbsp;<span class="op" id="5604584">:=</span>&nbsp;<span class="builtinfunc" id="5604587">new</span><span class="op" id="5604590">(</span><span class="ident" id="5604591">bytes</span><span class="op" id="5604596">.</span><span class="ident" id="5604597">Buffer</span><span class="op" id="5604603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604607">for</span>&nbsp;<span class="ident" id="5604611">_</span><span class="op" id="5604612">,</span>&nbsp;<span class="ident" id="5604614">c</span>&nbsp;<span class="op" id="5604616">:=</span>&nbsp;<span class="keyword" id="5604619">range</span>&nbsp;<span class="ident" id="5604625">dec</span>&nbsp;<span class="op" id="5604629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604634">b</span><span class="op" id="5604635">.</span><span class="ident" id="5604636">WriteRune</span><span class="op" id="5604645">(</span><span class="builtintype" id="5604646">rune</span><span class="op" id="5604650">(</span><span class="ident" id="5604651">c</span><span class="op" id="5604652">)</span><span class="op" id="5604653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5604657">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604661">return</span>&nbsp;<span class="ident" id="5604668">b</span><span class="op" id="5604669">.</span><span class="ident" id="5604670">String</span><span class="op" id="5604676">(</span><span class="op" id="5604677">)</span><span class="op" id="5604678">,</span>&nbsp;<span class="ident" id="5604680">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604685">case</span>&nbsp;<span class="string" id="5604690">&#34;utf-8&#34;</span><span class="op" id="5604697">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604701">return</span>&nbsp;<span class="builtintype" id="5604708">string</span><span class="op" id="5604714">(</span><span class="ident" id="5604715">dec</span><span class="op" id="5604718">)</span><span class="op" id="5604719">,</span>&nbsp;<span class="ident" id="5604721">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5604726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5604729">panic</span><span class="op" id="5604734">(</span><span class="string" id="5604735">&#34;unreachable&#34;</span><span class="op" id="5604748">)</span><br>
<span class="lineno">490</span><span class="op" id="5604750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5604753">type</span>&nbsp;<span class="ident" id="5604758">qDecoder</span>&nbsp;<span class="keyword" id="5604767">struct</span>&nbsp;<span class="op" id="5604774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604777">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5604785">io</span><span class="op" id="5604787">.</span><span class="ident" id="5604788">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604796">scratch</span>&nbsp;<span class="op" id="5604804">[</span><span class="num" id="5604805">2</span><span class="op" id="5604806">]</span><span class="builtintype" id="5604807">byte</span><br>
<span class="lineno">495</span><span class="op" id="5604812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5604815">func</span>&nbsp;<span class="op" id="5604820">(</span><span class="ident" id="5604821">qd</span>&nbsp;<span class="ident" id="5604824">qDecoder</span><span class="op" id="5604832">)</span>&nbsp;<span class="ident" id="5604834">Read</span><span class="op" id="5604838">(</span><span class="ident" id="5604839">p</span>&nbsp;<span class="op" id="5604841">[</span><span class="op" id="5604842">]</span><span class="builtintype" id="5604843">byte</span><span class="op" id="5604847">)</span>&nbsp;<span class="op" id="5604849">(</span><span class="ident" id="5604850">n</span>&nbsp;<span class="builtintype" id="5604852">int</span><span class="op" id="5604855">,</span>&nbsp;<span class="ident" id="5604857">err</span>&nbsp;<span class="builtintype" id="5604861">error</span><span class="op" id="5604866">)</span>&nbsp;<span class="op" id="5604868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5604871">//&nbsp;This&nbsp;method&nbsp;writes&nbsp;at&nbsp;most&nbsp;one&nbsp;byte&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604919">if</span>&nbsp;<span class="builtinfunc" id="5604922">len</span><span class="op" id="5604925">(</span><span class="ident" id="5604926">p</span><span class="op" id="5604927">)</span>&nbsp;<span class="op" id="5604929">==</span>&nbsp;<span class="num" id="5604932">0</span>&nbsp;<span class="op" id="5604934">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604938">return</span>&nbsp;<span class="num" id="5604945">0</span><span class="op" id="5604946">,</span>&nbsp;<span class="ident" id="5604948">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5604953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604956">if</span>&nbsp;<span class="ident" id="5604959">_</span><span class="op" id="5604960">,</span>&nbsp;<span class="ident" id="5604962">err</span>&nbsp;<span class="op" id="5604966">:=</span>&nbsp;<span class="ident" id="5604969">qd</span><span class="op" id="5604971">.</span><span class="ident" id="5604972">r</span><span class="op" id="5604973">.</span><span class="ident" id="5604974">Read</span><span class="op" id="5604978">(</span><span class="ident" id="5604979">qd</span><span class="op" id="5604981">.</span><span class="ident" id="5604982">scratch</span><span class="op" id="5604989">[</span><span class="op" id="5604990">:</span><span class="num" id="5604991">1</span><span class="op" id="5604992">]</span><span class="op" id="5604993">)</span><span class="op" id="5604994">;</span>&nbsp;<span class="ident" id="5604996">err</span>&nbsp;<span class="op" id="5605000">!=</span>&nbsp;<span class="ident" id="5605003">nil</span>&nbsp;<span class="op" id="5605007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605011">return</span>&nbsp;<span class="num" id="5605018">0</span><span class="op" id="5605019">,</span>&nbsp;<span class="ident" id="5605021">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5605026">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605029">switch</span>&nbsp;<span class="ident" id="5605036">c</span>&nbsp;<span class="op" id="5605038">:=</span>&nbsp;<span class="ident" id="5605041">qd</span><span class="op" id="5605043">.</span><span class="ident" id="5605044">scratch</span><span class="op" id="5605051">[</span><span class="num" id="5605052">0</span><span class="op" id="5605053">]</span><span class="op" id="5605054">;</span>&nbsp;<span class="op" id="5605056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605059">case</span>&nbsp;<span class="ident" id="5605064">c</span>&nbsp;<span class="op" id="5605066">==</span>&nbsp;<span class="string" id="5605069">&#39;=&#39;</span><span class="op" id="5605072">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605076">if</span>&nbsp;<span class="ident" id="5605079">_</span><span class="op" id="5605080">,</span>&nbsp;<span class="ident" id="5605082">err</span>&nbsp;<span class="op" id="5605086">:=</span>&nbsp;<span class="ident" id="5605089">io</span><span class="op" id="5605091">.</span><span class="ident" id="5605092">ReadFull</span><span class="op" id="5605100">(</span><span class="ident" id="5605101">qd</span><span class="op" id="5605103">.</span><span class="ident" id="5605104">r</span><span class="op" id="5605105">,</span>&nbsp;<span class="ident" id="5605107">qd</span><span class="op" id="5605109">.</span><span class="ident" id="5605110">scratch</span><span class="op" id="5605117">[</span><span class="op" id="5605118">:</span><span class="num" id="5605119">2</span><span class="op" id="5605120">]</span><span class="op" id="5605121">)</span><span class="op" id="5605122">;</span>&nbsp;<span class="ident" id="5605124">err</span>&nbsp;<span class="op" id="5605128">!=</span>&nbsp;<span class="ident" id="5605131">nil</span>&nbsp;<span class="op" id="5605135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605140">return</span>&nbsp;<span class="num" id="5605147">0</span><span class="op" id="5605148">,</span>&nbsp;<span class="ident" id="5605150">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5605156">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605160">x</span><span class="op" id="5605161">,</span>&nbsp;<span class="ident" id="5605163">err</span>&nbsp;<span class="op" id="5605167">:=</span>&nbsp;<span class="ident" id="5605170">strconv</span><span class="op" id="5605177">.</span><span class="ident" id="5605178">ParseInt</span><span class="op" id="5605186">(</span><span class="builtintype" id="5605187">string</span><span class="op" id="5605193">(</span><span class="ident" id="5605194">qd</span><span class="op" id="5605196">.</span><span class="ident" id="5605197">scratch</span><span class="op" id="5605204">[</span><span class="op" id="5605205">:</span><span class="num" id="5605206">2</span><span class="op" id="5605207">]</span><span class="op" id="5605208">)</span><span class="op" id="5605209">,</span>&nbsp;<span class="num" id="5605211">16</span><span class="op" id="5605213">,</span>&nbsp;<span class="num" id="5605215">64</span><span class="op" id="5605217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605221">if</span>&nbsp;<span class="ident" id="5605224">err</span>&nbsp;<span class="op" id="5605228">!=</span>&nbsp;<span class="ident" id="5605231">nil</span>&nbsp;<span class="op" id="5605235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605240">return</span>&nbsp;<span class="num" id="5605247">0</span><span class="op" id="5605248">,</span>&nbsp;<span class="ident" id="5605250">fmt</span><span class="op" id="5605253">.</span><span class="ident" id="5605254">Errorf</span><span class="op" id="5605260">(</span><span class="string" id="5605261">&#34;mail:&nbsp;invalid&nbsp;RFC&nbsp;2047&nbsp;encoding:&nbsp;%q&#34;</span><span class="op" id="5605298">,</span>&nbsp;<span class="ident" id="5605300">qd</span><span class="op" id="5605302">.</span><span class="ident" id="5605303">scratch</span><span class="op" id="5605310">[</span><span class="op" id="5605311">:</span><span class="num" id="5605312">2</span><span class="op" id="5605313">]</span><span class="op" id="5605314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5605318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605322">p</span><span class="op" id="5605323">[</span><span class="num" id="5605324">0</span><span class="op" id="5605325">]</span>&nbsp;<span class="op" id="5605327">=</span>&nbsp;<span class="builtintype" id="5605329">byte</span><span class="op" id="5605333">(</span><span class="ident" id="5605334">x</span><span class="op" id="5605335">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605338">case</span>&nbsp;<span class="ident" id="5605343">c</span>&nbsp;<span class="op" id="5605345">==</span>&nbsp;<span class="string" id="5605348">&#39;_&#39;</span><span class="op" id="5605351">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605355">p</span><span class="op" id="5605356">[</span><span class="num" id="5605357">0</span><span class="op" id="5605358">]</span>&nbsp;<span class="op" id="5605360">=</span>&nbsp;<span class="string" id="5605362">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605367">default</span><span class="op" id="5605374">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605378">p</span><span class="op" id="5605379">[</span><span class="num" id="5605380">0</span><span class="op" id="5605381">]</span>&nbsp;<span class="op" id="5605383">=</span>&nbsp;<span class="ident" id="5605385">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5605388">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605391">return</span>&nbsp;<span class="num" id="5605398">1</span><span class="op" id="5605399">,</span>&nbsp;<span class="ident" id="5605401">nil</span><br>
<span class="lineno"></span><span class="op" id="5605405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5605408">var</span>&nbsp;<span class="ident" id="5605412">atextChars</span>&nbsp;<span class="op" id="5605423">=</span>&nbsp;<span class="op" id="5605425">[</span><span class="op" id="5605426">]</span><span class="builtintype" id="5605427">byte</span><span class="op" id="5605431">(</span><span class="string" id="5605432">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span>&nbsp;<span class="op" id="5605461">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5605464">&#34;abcdefghijklmnopqrstuvwxyz&#34;</span>&nbsp;<span class="op" id="5605493">+</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5605496">&#34;0123456789&#34;</span>&nbsp;<span class="op" id="5605509">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5605512">&#34;!#$%&amp;&#39;*+-/=?^_`{|}~&#34;</span><span class="op" id="5605533">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5605536">//&nbsp;isAtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atext&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5605597">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;period&nbsp;is&nbsp;included.</span><br>
<span class="lineno">530</span><span class="keyword" id="5605636">func</span>&nbsp;<span class="ident" id="5605641">isAtext</span><span class="op" id="5605648">(</span><span class="ident" id="5605649">c</span>&nbsp;<span class="builtintype" id="5605651">byte</span><span class="op" id="5605655">,</span>&nbsp;<span class="ident" id="5605657">dot</span>&nbsp;<span class="builtintype" id="5605661">bool</span><span class="op" id="5605665">)</span>&nbsp;<span class="builtintype" id="5605667">bool</span>&nbsp;<span class="op" id="5605672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605675">if</span>&nbsp;<span class="ident" id="5605678">dot</span>&nbsp;<span class="op" id="5605682">&amp;&amp;</span>&nbsp;<span class="ident" id="5605685">c</span>&nbsp;<span class="op" id="5605687">==</span>&nbsp;<span class="string" id="5605690">&#39;.&#39;</span>&nbsp;<span class="op" id="5605694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605698">return</span>&nbsp;<span class="builtintype" id="5605705">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5605711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605714">return</span>&nbsp;<span class="ident" id="5605721">bytes</span><span class="op" id="5605726">.</span><span class="ident" id="5605727">IndexByte</span><span class="op" id="5605736">(</span><span class="ident" id="5605737">atextChars</span><span class="op" id="5605747">,</span>&nbsp;<span class="ident" id="5605749">c</span><span class="op" id="5605750">)</span>&nbsp;<span class="op" id="5605752">&gt;=</span>&nbsp;<span class="num" id="5605755">0</span><br>
<span class="lineno">535</span><span class="op" id="5605757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5605760">//&nbsp;isQtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;qtext&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="5605821">func</span>&nbsp;<span class="ident" id="5605826">isQtext</span><span class="op" id="5605833">(</span><span class="ident" id="5605834">c</span>&nbsp;<span class="builtintype" id="5605836">byte</span><span class="op" id="5605840">)</span>&nbsp;<span class="builtintype" id="5605842">bool</span>&nbsp;<span class="op" id="5605847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5605850">//&nbsp;Printable&nbsp;US-ASCII,&nbsp;excluding&nbsp;backslash&nbsp;or&nbsp;quote.</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605904">if</span>&nbsp;<span class="ident" id="5605907">c</span>&nbsp;<span class="op" id="5605909">==</span>&nbsp;<span class="string" id="5605912">&#39;\\&#39;</span>&nbsp;<span class="op" id="5605917">||</span>&nbsp;<span class="ident" id="5605920">c</span>&nbsp;<span class="op" id="5605922">==</span>&nbsp;<span class="string" id="5605925">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5605929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605933">return</span>&nbsp;<span class="builtintype" id="5605940">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5605947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605950">return</span>&nbsp;<span class="string" id="5605957">&#39;!&#39;</span>&nbsp;<span class="op" id="5605961">&lt;=</span>&nbsp;<span class="ident" id="5605964">c</span>&nbsp;<span class="op" id="5605966">&amp;&amp;</span>&nbsp;<span class="ident" id="5605969">c</span>&nbsp;<span class="op" id="5605971">&lt;=</span>&nbsp;<span class="string" id="5605974">&#39;~&#39;</span><br>
<span class="lineno"></span><span class="op" id="5605978">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="comment" id="5605981">//&nbsp;isVchar&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;VCHAR&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="5606042">func</span>&nbsp;<span class="ident" id="5606047">isVchar</span><span class="op" id="5606054">(</span><span class="ident" id="5606055">c</span>&nbsp;<span class="builtintype" id="5606057">byte</span><span class="op" id="5606061">)</span>&nbsp;<span class="builtintype" id="5606063">bool</span>&nbsp;<span class="op" id="5606068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5606071">//&nbsp;Visible&nbsp;(printing)&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5606106">return</span>&nbsp;<span class="string" id="5606113">&#39;!&#39;</span>&nbsp;<span class="op" id="5606117">&lt;=</span>&nbsp;<span class="ident" id="5606120">c</span>&nbsp;<span class="op" id="5606122">&amp;&amp;</span>&nbsp;<span class="ident" id="5606125">c</span>&nbsp;<span class="op" id="5606127">&lt;=</span>&nbsp;<span class="string" id="5606130">&#39;~&#39;</span><br>
<span class="lineno">550</span><span class="op" id="5606134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5606137">//&nbsp;isWSP&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;WSP&nbsp;(white&nbsp;space).</span><br>
<span class="lineno"></span><span class="comment" id="5606188">//&nbsp;WSP&nbsp;is&nbsp;a&nbsp;space&nbsp;or&nbsp;horizontal&nbsp;tab&nbsp;(RFC5234&nbsp;Appendix&nbsp;B).</span><br>
<span class="lineno"></span><span class="keyword" id="5606246">func</span>&nbsp;<span class="ident" id="5606251">isWSP</span><span class="op" id="5606256">(</span><span class="ident" id="5606257">c</span>&nbsp;<span class="builtintype" id="5606259">byte</span><span class="op" id="5606263">)</span>&nbsp;<span class="builtintype" id="5606265">bool</span>&nbsp;<span class="op" id="5606270">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5606273">return</span>&nbsp;<span class="ident" id="5606280">c</span>&nbsp;<span class="op" id="5606282">==</span>&nbsp;<span class="string" id="5606285">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="5606289">||</span>&nbsp;<span class="ident" id="5606292">c</span>&nbsp;<span class="op" id="5606294">==</span>&nbsp;<span class="string" id="5606297">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="5606302">}</span>
</div>
</body>
</html>
