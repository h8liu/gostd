<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html" class="current">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7672471">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7672526">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7672580">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7672631">package</span>&nbsp;<span class="ident" id="7672639">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7672645">import</span>&nbsp;<span class="op" id="7672652">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7672655">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7672664">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7672671">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7672680">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7672695">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7672701">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7672714">&#34;math/rand&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7672727">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7672733">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7672744">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="7672754">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="7672757">//&nbsp;TestDecodeProgressive&nbsp;tests&nbsp;that&nbsp;decoding&nbsp;the&nbsp;baseline&nbsp;and&nbsp;progressive</span><br>
<span class="lineno"></span><span class="comment" id="7672831">//&nbsp;versions&nbsp;of&nbsp;the&nbsp;same&nbsp;image&nbsp;result&nbsp;in&nbsp;exactly&nbsp;the&nbsp;same&nbsp;pixel&nbsp;data,&nbsp;in&nbsp;YCbCr</span><br>
<span class="lineno"></span><span class="comment" id="7672909">//&nbsp;space&nbsp;for&nbsp;color&nbsp;images,&nbsp;and&nbsp;Y&nbsp;space&nbsp;for&nbsp;grayscale&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="7672970">func</span>&nbsp;<span class="ident" id="7672975">TestDecodeProgressive</span><span class="op" id="7672996">(</span><span class="ident" id="7672997">t</span>&nbsp;<span class="op" id="7672999">*</span><span class="ident" id="7673000">testing</span><span class="op" id="7673007">.</span><span class="ident" id="7673008">T</span><span class="op" id="7673009">)</span>&nbsp;<span class="op" id="7673011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7673014">testCases</span>&nbsp;<span class="op" id="7673024">:=</span>&nbsp;<span class="op" id="7673027">[</span><span class="op" id="7673028">]</span><span class="builtintype" id="7673029">string</span><span class="op" id="7673035">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7673039">&#34;../testdata/video-001&#34;</span><span class="op" id="7673062">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7673066">&#34;../testdata/video-001.q50.420&#34;</span><span class="op" id="7673097">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7673101">&#34;../testdata/video-001.q50.422&#34;</span><span class="op" id="7673132">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7673136">&#34;../testdata/video-001.q50.440&#34;</span><span class="op" id="7673167">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7673171">&#34;../testdata/video-001.q50.444&#34;</span><span class="op" id="7673202">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7673206">&#34;../testdata/video-005.gray.q50&#34;</span><span class="op" id="7673238">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7673242">&#34;../testdata/video-005.gray.q50.2x2&#34;</span><span class="op" id="7673278">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7673282">&#34;../testdata/video-001.separate.dc.progression&#34;</span><span class="op" id="7673329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7673332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7673335">for</span>&nbsp;<span class="ident" id="7673339">_</span><span class="op" id="7673340">,</span>&nbsp;<span class="ident" id="7673342">tc</span>&nbsp;<span class="op" id="7673345">:=</span>&nbsp;<span class="keyword" id="7673348">range</span>&nbsp;<span class="ident" id="7673354">testCases</span>&nbsp;<span class="op" id="7673364">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7673368">m0</span><span class="op" id="7673370">,</span>&nbsp;<span class="ident" id="7673372">err</span>&nbsp;<span class="op" id="7673376">:=</span>&nbsp;<span class="ident" id="7673379">decodeFile</span><span class="op" id="7673389">(</span><span class="ident" id="7673390">tc</span>&nbsp;<span class="op" id="7673393">+</span>&nbsp;<span class="string" id="7673395">&#34;.jpeg&#34;</span><span class="op" id="7673402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7673406">if</span>&nbsp;<span class="ident" id="7673409">err</span>&nbsp;<span class="op" id="7673413">!=</span>&nbsp;<span class="builtintype" id="7673416">nil</span>&nbsp;<span class="op" id="7673420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7673425">t</span><span class="op" id="7673426">.</span><span class="ident" id="7673427">Errorf</span><span class="op" id="7673433">(</span><span class="string" id="7673434">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7673442">,</span>&nbsp;<span class="ident" id="7673444">tc</span><span class="op" id="7673446">+</span><span class="string" id="7673447">&#34;.jpeg&#34;</span><span class="op" id="7673454">,</span>&nbsp;<span class="ident" id="7673456">err</span><span class="op" id="7673459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7673464">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7673475">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7673479">m1</span><span class="op" id="7673481">,</span>&nbsp;<span class="ident" id="7673483">err</span>&nbsp;<span class="op" id="7673487">:=</span>&nbsp;<span class="ident" id="7673490">decodeFile</span><span class="op" id="7673500">(</span><span class="ident" id="7673501">tc</span>&nbsp;<span class="op" id="7673504">+</span>&nbsp;<span class="string" id="7673506">&#34;.progressive.jpeg&#34;</span><span class="op" id="7673525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7673529">if</span>&nbsp;<span class="ident" id="7673532">err</span>&nbsp;<span class="op" id="7673536">!=</span>&nbsp;<span class="builtintype" id="7673539">nil</span>&nbsp;<span class="op" id="7673543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7673548">t</span><span class="op" id="7673549">.</span><span class="ident" id="7673550">Errorf</span><span class="op" id="7673556">(</span><span class="string" id="7673557">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7673565">,</span>&nbsp;<span class="ident" id="7673567">tc</span><span class="op" id="7673569">+</span><span class="string" id="7673570">&#34;.progressive.jpeg&#34;</span><span class="op" id="7673589">,</span>&nbsp;<span class="ident" id="7673591">err</span><span class="op" id="7673594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7673599">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7673610">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7673614">if</span>&nbsp;<span class="ident" id="7673617">m0</span><span class="op" id="7673619">.</span><span class="ident" id="7673620">Bounds</span><span class="op" id="7673626">(</span><span class="op" id="7673627">)</span>&nbsp;<span class="op" id="7673629">!=</span>&nbsp;<span class="ident" id="7673632">m1</span><span class="op" id="7673634">.</span><span class="ident" id="7673635">Bounds</span><span class="op" id="7673641">(</span><span class="op" id="7673642">)</span>&nbsp;<span class="op" id="7673644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7673649">t</span><span class="op" id="7673650">.</span><span class="ident" id="7673651">Errorf</span><span class="op" id="7673657">(</span><span class="string" id="7673658">&#34;%s:&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7673688">,</span>&nbsp;<span class="ident" id="7673690">tc</span><span class="op" id="7673692">,</span>&nbsp;<span class="ident" id="7673694">m0</span><span class="op" id="7673696">.</span><span class="ident" id="7673697">Bounds</span><span class="op" id="7673703">(</span><span class="op" id="7673704">)</span><span class="op" id="7673705">,</span>&nbsp;<span class="ident" id="7673707">m1</span><span class="op" id="7673709">.</span><span class="ident" id="7673710">Bounds</span><span class="op" id="7673716">(</span><span class="op" id="7673717">)</span><span class="op" id="7673718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7673723">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7673734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7673738">//&nbsp;All&nbsp;of&nbsp;the&nbsp;video-*.jpeg&nbsp;files&nbsp;are&nbsp;150x103.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7673786">if</span>&nbsp;<span class="ident" id="7673789">m0</span><span class="op" id="7673791">.</span><span class="ident" id="7673792">Bounds</span><span class="op" id="7673798">(</span><span class="op" id="7673799">)</span>&nbsp;<span class="op" id="7673801">!=</span>&nbsp;<span class="ident" id="7673804">image</span><span class="op" id="7673809">.</span><span class="ident" id="7673810">Rect</span><span class="op" id="7673814">(</span><span class="num" id="7673815">0</span><span class="op" id="7673816">,</span>&nbsp;<span class="num" id="7673818">0</span><span class="op" id="7673819">,</span>&nbsp;<span class="num" id="7673821">150</span><span class="op" id="7673824">,</span>&nbsp;<span class="num" id="7673826">103</span><span class="op" id="7673829">)</span>&nbsp;<span class="op" id="7673831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7673836">t</span><span class="op" id="7673837">.</span><span class="ident" id="7673838">Errorf</span><span class="op" id="7673844">(</span><span class="string" id="7673845">&#34;%s:&nbsp;bad&nbsp;bounds:&nbsp;%v&#34;</span><span class="op" id="7673865">,</span>&nbsp;<span class="ident" id="7673867">tc</span><span class="op" id="7673869">,</span>&nbsp;<span class="ident" id="7673871">m0</span><span class="op" id="7673873">.</span><span class="ident" id="7673874">Bounds</span><span class="op" id="7673880">(</span><span class="op" id="7673881">)</span><span class="op" id="7673882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7673887">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7673898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7673903">switch</span>&nbsp;<span class="ident" id="7673910">m0</span>&nbsp;<span class="op" id="7673913">:=</span>&nbsp;<span class="ident" id="7673916">m0</span><span class="op" id="7673918">.</span><span class="op" id="7673919">(</span><span class="keyword" id="7673920">type</span><span class="op" id="7673924">)</span>&nbsp;<span class="op" id="7673926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7673930">case</span>&nbsp;<span class="op" id="7673935">*</span><span class="ident" id="7673936">image</span><span class="op" id="7673941">.</span><span class="ident" id="7673942">YCbCr</span><span class="op" id="7673947">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7673952">m1</span>&nbsp;<span class="op" id="7673955">:=</span>&nbsp;<span class="ident" id="7673958">m1</span><span class="op" id="7673960">.</span><span class="op" id="7673961">(</span><span class="op" id="7673962">*</span><span class="ident" id="7673963">image</span><span class="op" id="7673968">.</span><span class="ident" id="7673969">YCbCr</span><span class="op" id="7673974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7673979">if</span>&nbsp;<span class="ident" id="7673982">err</span>&nbsp;<span class="op" id="7673986">:=</span>&nbsp;<span class="ident" id="7673989">check</span><span class="op" id="7673994">(</span><span class="ident" id="7673995">m0</span><span class="op" id="7673997">.</span><span class="ident" id="7673998">Bounds</span><span class="op" id="7674004">(</span><span class="op" id="7674005">)</span><span class="op" id="7674006">,</span>&nbsp;<span class="ident" id="7674008">m0</span><span class="op" id="7674010">.</span><span class="ident" id="7674011">Y</span><span class="op" id="7674012">,</span>&nbsp;<span class="ident" id="7674014">m1</span><span class="op" id="7674016">.</span><span class="ident" id="7674017">Y</span><span class="op" id="7674018">,</span>&nbsp;<span class="ident" id="7674020">m0</span><span class="op" id="7674022">.</span><span class="ident" id="7674023">YStride</span><span class="op" id="7674030">,</span>&nbsp;<span class="ident" id="7674032">m1</span><span class="op" id="7674034">.</span><span class="ident" id="7674035">YStride</span><span class="op" id="7674042">)</span><span class="op" id="7674043">;</span>&nbsp;<span class="ident" id="7674045">err</span>&nbsp;<span class="op" id="7674049">!=</span>&nbsp;<span class="builtintype" id="7674052">nil</span>&nbsp;<span class="op" id="7674056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7674062">t</span><span class="op" id="7674063">.</span><span class="ident" id="7674064">Errorf</span><span class="op" id="7674070">(</span><span class="string" id="7674071">&#34;%s&nbsp;(Y):&nbsp;%v&#34;</span><span class="op" id="7674083">,</span>&nbsp;<span class="ident" id="7674085">tc</span><span class="op" id="7674087">,</span>&nbsp;<span class="ident" id="7674089">err</span><span class="op" id="7674092">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7674098">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7674110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7674115">if</span>&nbsp;<span class="ident" id="7674118">err</span>&nbsp;<span class="op" id="7674122">:=</span>&nbsp;<span class="ident" id="7674125">check</span><span class="op" id="7674130">(</span><span class="ident" id="7674131">m0</span><span class="op" id="7674133">.</span><span class="ident" id="7674134">Bounds</span><span class="op" id="7674140">(</span><span class="op" id="7674141">)</span><span class="op" id="7674142">,</span>&nbsp;<span class="ident" id="7674144">m0</span><span class="op" id="7674146">.</span><span class="ident" id="7674147">Cb</span><span class="op" id="7674149">,</span>&nbsp;<span class="ident" id="7674151">m1</span><span class="op" id="7674153">.</span><span class="ident" id="7674154">Cb</span><span class="op" id="7674156">,</span>&nbsp;<span class="ident" id="7674158">m0</span><span class="op" id="7674160">.</span><span class="ident" id="7674161">CStride</span><span class="op" id="7674168">,</span>&nbsp;<span class="ident" id="7674170">m1</span><span class="op" id="7674172">.</span><span class="ident" id="7674173">CStride</span><span class="op" id="7674180">)</span><span class="op" id="7674181">;</span>&nbsp;<span class="ident" id="7674183">err</span>&nbsp;<span class="op" id="7674187">!=</span>&nbsp;<span class="builtintype" id="7674190">nil</span>&nbsp;<span class="op" id="7674194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7674200">t</span><span class="op" id="7674201">.</span><span class="ident" id="7674202">Errorf</span><span class="op" id="7674208">(</span><span class="string" id="7674209">&#34;%s&nbsp;(Cb):&nbsp;%v&#34;</span><span class="op" id="7674222">,</span>&nbsp;<span class="ident" id="7674224">tc</span><span class="op" id="7674226">,</span>&nbsp;<span class="ident" id="7674228">err</span><span class="op" id="7674231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7674237">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7674249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7674254">if</span>&nbsp;<span class="ident" id="7674257">err</span>&nbsp;<span class="op" id="7674261">:=</span>&nbsp;<span class="ident" id="7674264">check</span><span class="op" id="7674269">(</span><span class="ident" id="7674270">m0</span><span class="op" id="7674272">.</span><span class="ident" id="7674273">Bounds</span><span class="op" id="7674279">(</span><span class="op" id="7674280">)</span><span class="op" id="7674281">,</span>&nbsp;<span class="ident" id="7674283">m0</span><span class="op" id="7674285">.</span><span class="ident" id="7674286">Cr</span><span class="op" id="7674288">,</span>&nbsp;<span class="ident" id="7674290">m1</span><span class="op" id="7674292">.</span><span class="ident" id="7674293">Cr</span><span class="op" id="7674295">,</span>&nbsp;<span class="ident" id="7674297">m0</span><span class="op" id="7674299">.</span><span class="ident" id="7674300">CStride</span><span class="op" id="7674307">,</span>&nbsp;<span class="ident" id="7674309">m1</span><span class="op" id="7674311">.</span><span class="ident" id="7674312">CStride</span><span class="op" id="7674319">)</span><span class="op" id="7674320">;</span>&nbsp;<span class="ident" id="7674322">err</span>&nbsp;<span class="op" id="7674326">!=</span>&nbsp;<span class="builtintype" id="7674329">nil</span>&nbsp;<span class="op" id="7674333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7674339">t</span><span class="op" id="7674340">.</span><span class="ident" id="7674341">Errorf</span><span class="op" id="7674347">(</span><span class="string" id="7674348">&#34;%s&nbsp;(Cr):&nbsp;%v&#34;</span><span class="op" id="7674361">,</span>&nbsp;<span class="ident" id="7674363">tc</span><span class="op" id="7674365">,</span>&nbsp;<span class="ident" id="7674367">err</span><span class="op" id="7674370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7674376">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7674388">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7674392">case</span>&nbsp;<span class="op" id="7674397">*</span><span class="ident" id="7674398">image</span><span class="op" id="7674403">.</span><span class="ident" id="7674404">Gray</span><span class="op" id="7674408">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7674413">m1</span>&nbsp;<span class="op" id="7674416">:=</span>&nbsp;<span class="ident" id="7674419">m1</span><span class="op" id="7674421">.</span><span class="op" id="7674422">(</span><span class="op" id="7674423">*</span><span class="ident" id="7674424">image</span><span class="op" id="7674429">.</span><span class="ident" id="7674430">Gray</span><span class="op" id="7674434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7674439">if</span>&nbsp;<span class="ident" id="7674442">err</span>&nbsp;<span class="op" id="7674446">:=</span>&nbsp;<span class="ident" id="7674449">check</span><span class="op" id="7674454">(</span><span class="ident" id="7674455">m0</span><span class="op" id="7674457">.</span><span class="ident" id="7674458">Bounds</span><span class="op" id="7674464">(</span><span class="op" id="7674465">)</span><span class="op" id="7674466">,</span>&nbsp;<span class="ident" id="7674468">m0</span><span class="op" id="7674470">.</span><span class="ident" id="7674471">Pix</span><span class="op" id="7674474">,</span>&nbsp;<span class="ident" id="7674476">m1</span><span class="op" id="7674478">.</span><span class="ident" id="7674479">Pix</span><span class="op" id="7674482">,</span>&nbsp;<span class="ident" id="7674484">m0</span><span class="op" id="7674486">.</span><span class="ident" id="7674487">Stride</span><span class="op" id="7674493">,</span>&nbsp;<span class="ident" id="7674495">m1</span><span class="op" id="7674497">.</span><span class="ident" id="7674498">Stride</span><span class="op" id="7674504">)</span><span class="op" id="7674505">;</span>&nbsp;<span class="ident" id="7674507">err</span>&nbsp;<span class="op" id="7674511">!=</span>&nbsp;<span class="builtintype" id="7674514">nil</span>&nbsp;<span class="op" id="7674518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7674524">t</span><span class="op" id="7674525">.</span><span class="ident" id="7674526">Errorf</span><span class="op" id="7674532">(</span><span class="string" id="7674533">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7674541">,</span>&nbsp;<span class="ident" id="7674543">tc</span><span class="op" id="7674545">,</span>&nbsp;<span class="ident" id="7674547">err</span><span class="op" id="7674550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7674556">continue</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7674568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7674572">default</span><span class="op" id="7674579">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7674584">t</span><span class="op" id="7674585">.</span><span class="ident" id="7674586">Errorf</span><span class="op" id="7674592">(</span><span class="string" id="7674593">&#34;%s:&nbsp;unexpected&nbsp;image&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7674623">,</span>&nbsp;<span class="ident" id="7674625">tc</span><span class="op" id="7674627">,</span>&nbsp;<span class="ident" id="7674629">m0</span><span class="op" id="7674631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7674636">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7674647">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7674650">}</span><br>
<span class="lineno"></span><span class="op" id="7674652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7674655">func</span>&nbsp;<span class="ident" id="7674660">decodeFile</span><span class="op" id="7674670">(</span><span class="ident" id="7674671">filename</span>&nbsp;<span class="builtintype" id="7674680">string</span><span class="op" id="7674686">)</span>&nbsp;<span class="op" id="7674688">(</span><span class="ident" id="7674689">image</span><span class="op" id="7674694">.</span><span class="ident" id="7674695">Image</span><span class="op" id="7674700">,</span>&nbsp;<span class="builtintype" id="7674702">error</span><span class="op" id="7674707">)</span>&nbsp;<span class="op" id="7674709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7674712">f</span><span class="op" id="7674713">,</span>&nbsp;<span class="ident" id="7674715">err</span>&nbsp;<span class="op" id="7674719">:=</span>&nbsp;<span class="ident" id="7674722">os</span><span class="op" id="7674724">.</span><span class="ident" id="7674725">Open</span><span class="op" id="7674729">(</span><span class="ident" id="7674730">filename</span><span class="op" id="7674738">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7674741">if</span>&nbsp;<span class="ident" id="7674744">err</span>&nbsp;<span class="op" id="7674748">!=</span>&nbsp;<span class="builtintype" id="7674751">nil</span>&nbsp;<span class="op" id="7674755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7674759">return</span>&nbsp;<span class="builtintype" id="7674766">nil</span><span class="op" id="7674769">,</span>&nbsp;<span class="ident" id="7674771">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7674776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7674779">defer</span>&nbsp;<span class="ident" id="7674785">f</span><span class="op" id="7674786">.</span><span class="ident" id="7674787">Close</span><span class="op" id="7674792">(</span><span class="op" id="7674793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7674796">return</span>&nbsp;<span class="ident" id="7674803">Decode</span><span class="op" id="7674809">(</span><span class="ident" id="7674810">f</span><span class="op" id="7674811">)</span><br>
<span class="lineno">90</span><span class="op" id="7674813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7674816">type</span>&nbsp;<span class="ident" id="7674821">eofReader</span>&nbsp;<span class="keyword" id="7674831">struct</span>&nbsp;<span class="op" id="7674838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7674841">data</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7674850">[</span><span class="op" id="7674851">]</span><span class="builtintype" id="7674852">byte</span>&nbsp;<span class="comment" id="7674857">//&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;without&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7674891">dataEOF</span>&nbsp;&nbsp;<span class="op" id="7674900">[</span><span class="op" id="7674901">]</span><span class="builtintype" id="7674902">byte</span>&nbsp;<span class="comment" id="7674907">//&nbsp;then&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;with&nbsp;EOF&nbsp;on&nbsp;last&nbsp;chunk</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7674957">lenAtEOF</span>&nbsp;<span class="builtintype" id="7674966">int</span><br>
<span class="lineno"></span><span class="op" id="7674970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7674973">func</span>&nbsp;<span class="op" id="7674978">(</span><span class="ident" id="7674979">r</span>&nbsp;<span class="op" id="7674981">*</span><span class="ident" id="7674982">eofReader</span><span class="op" id="7674991">)</span>&nbsp;<span class="ident" id="7674993">Read</span><span class="op" id="7674997">(</span><span class="ident" id="7674998">b</span>&nbsp;<span class="op" id="7675000">[</span><span class="op" id="7675001">]</span><span class="builtintype" id="7675002">byte</span><span class="op" id="7675006">)</span>&nbsp;<span class="op" id="7675008">(</span><span class="ident" id="7675009">n</span>&nbsp;<span class="builtintype" id="7675011">int</span><span class="op" id="7675014">,</span>&nbsp;<span class="ident" id="7675016">err</span>&nbsp;<span class="builtintype" id="7675020">error</span><span class="op" id="7675025">)</span>&nbsp;<span class="op" id="7675027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7675030">if</span>&nbsp;<span class="builtinfunc" id="7675033">len</span><span class="op" id="7675036">(</span><span class="ident" id="7675037">r</span><span class="op" id="7675038">.</span><span class="ident" id="7675039">data</span><span class="op" id="7675043">)</span>&nbsp;<span class="op" id="7675045">&gt;</span>&nbsp;<span class="num" id="7675047">0</span>&nbsp;<span class="op" id="7675049">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7675053">n</span>&nbsp;<span class="op" id="7675055">=</span>&nbsp;<span class="builtinfunc" id="7675057">copy</span><span class="op" id="7675061">(</span><span class="ident" id="7675062">b</span><span class="op" id="7675063">,</span>&nbsp;<span class="ident" id="7675065">r</span><span class="op" id="7675066">.</span><span class="ident" id="7675067">data</span><span class="op" id="7675071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7675075">r</span><span class="op" id="7675076">.</span><span class="ident" id="7675077">data</span>&nbsp;<span class="op" id="7675082">=</span>&nbsp;<span class="ident" id="7675084">r</span><span class="op" id="7675085">.</span><span class="ident" id="7675086">data</span><span class="op" id="7675090">[</span><span class="ident" id="7675091">n</span><span class="op" id="7675092">:</span><span class="op" id="7675093">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7675096">}</span>&nbsp;<span class="keyword" id="7675098">else</span>&nbsp;<span class="op" id="7675103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7675107">n</span>&nbsp;<span class="op" id="7675109">=</span>&nbsp;<span class="builtinfunc" id="7675111">copy</span><span class="op" id="7675115">(</span><span class="ident" id="7675116">b</span><span class="op" id="7675117">,</span>&nbsp;<span class="ident" id="7675119">r</span><span class="op" id="7675120">.</span><span class="ident" id="7675121">dataEOF</span><span class="op" id="7675128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7675132">r</span><span class="op" id="7675133">.</span><span class="ident" id="7675134">dataEOF</span>&nbsp;<span class="op" id="7675142">=</span>&nbsp;<span class="ident" id="7675144">r</span><span class="op" id="7675145">.</span><span class="ident" id="7675146">dataEOF</span><span class="op" id="7675153">[</span><span class="ident" id="7675154">n</span><span class="op" id="7675155">:</span><span class="op" id="7675156">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7675160">if</span>&nbsp;<span class="builtinfunc" id="7675163">len</span><span class="op" id="7675166">(</span><span class="ident" id="7675167">r</span><span class="op" id="7675168">.</span><span class="ident" id="7675169">dataEOF</span><span class="op" id="7675176">)</span>&nbsp;<span class="op" id="7675178">==</span>&nbsp;<span class="num" id="7675181">0</span>&nbsp;<span class="op" id="7675183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7675188">err</span>&nbsp;<span class="op" id="7675192">=</span>&nbsp;<span class="ident" id="7675194">io</span><span class="op" id="7675196">.</span><span class="ident" id="7675197">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7675204">if</span>&nbsp;<span class="ident" id="7675207">r</span><span class="op" id="7675208">.</span><span class="ident" id="7675209">lenAtEOF</span>&nbsp;<span class="op" id="7675218">==</span>&nbsp;<span class="op" id="7675221">-</span><span class="num" id="7675222">1</span>&nbsp;<span class="op" id="7675224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7675230">r</span><span class="op" id="7675231">.</span><span class="ident" id="7675232">lenAtEOF</span>&nbsp;<span class="op" id="7675241">=</span>&nbsp;<span class="ident" id="7675243">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7675248">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7675252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7675255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7675258">return</span><br>
<span class="lineno"></span><span class="op" id="7675265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="7675268">func</span>&nbsp;<span class="ident" id="7675273">TestDecodeEOF</span><span class="op" id="7675286">(</span><span class="ident" id="7675287">t</span>&nbsp;<span class="op" id="7675289">*</span><span class="ident" id="7675290">testing</span><span class="op" id="7675297">.</span><span class="ident" id="7675298">T</span><span class="op" id="7675299">)</span>&nbsp;<span class="op" id="7675301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7675304">//&nbsp;Check&nbsp;that&nbsp;if&nbsp;reader&nbsp;returns&nbsp;final&nbsp;data&nbsp;and&nbsp;EOF&nbsp;at&nbsp;same&nbsp;time,&nbsp;jpeg&nbsp;handles&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7675387">data</span><span class="op" id="7675391">,</span>&nbsp;<span class="ident" id="7675393">err</span>&nbsp;<span class="op" id="7675397">:=</span>&nbsp;<span class="ident" id="7675400">ioutil</span><span class="op" id="7675406">.</span><span class="ident" id="7675407">ReadFile</span><span class="op" id="7675415">(</span><span class="string" id="7675416">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7675444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7675447">if</span>&nbsp;<span class="ident" id="7675450">err</span>&nbsp;<span class="op" id="7675454">!=</span>&nbsp;<span class="builtintype" id="7675457">nil</span>&nbsp;<span class="op" id="7675461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7675465">t</span><span class="op" id="7675466">.</span><span class="ident" id="7675467">Fatal</span><span class="op" id="7675472">(</span><span class="ident" id="7675473">err</span><span class="op" id="7675476">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7675479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7675483">n</span>&nbsp;<span class="op" id="7675485">:=</span>&nbsp;<span class="builtinfunc" id="7675488">len</span><span class="op" id="7675491">(</span><span class="ident" id="7675492">data</span><span class="op" id="7675496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7675499">for</span>&nbsp;<span class="ident" id="7675503">i</span>&nbsp;<span class="op" id="7675505">:=</span>&nbsp;<span class="num" id="7675508">0</span><span class="op" id="7675509">;</span>&nbsp;<span class="ident" id="7675511">i</span>&nbsp;<span class="op" id="7675513">&lt;</span>&nbsp;<span class="ident" id="7675515">n</span><span class="op" id="7675516">;</span>&nbsp;<span class="op" id="7675518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7675522">r</span>&nbsp;<span class="op" id="7675524">:=</span>&nbsp;<span class="op" id="7675527">&amp;</span><span class="ident" id="7675528">eofReader</span><span class="op" id="7675537">{</span><span class="ident" id="7675538">data</span><span class="op" id="7675542">[</span><span class="op" id="7675543">:</span><span class="ident" id="7675544">n</span><span class="op" id="7675545">-</span><span class="ident" id="7675546">i</span><span class="op" id="7675547">]</span><span class="op" id="7675548">,</span>&nbsp;<span class="ident" id="7675550">data</span><span class="op" id="7675554">[</span><span class="ident" id="7675555">n</span><span class="op" id="7675556">-</span><span class="ident" id="7675557">i</span><span class="op" id="7675558">:</span><span class="op" id="7675559">]</span><span class="op" id="7675560">,</span>&nbsp;<span class="op" id="7675562">-</span><span class="num" id="7675563">1</span><span class="op" id="7675564">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7675568">_</span><span class="op" id="7675569">,</span>&nbsp;<span class="ident" id="7675571">err</span>&nbsp;<span class="op" id="7675575">:=</span>&nbsp;<span class="ident" id="7675578">Decode</span><span class="op" id="7675584">(</span><span class="ident" id="7675585">r</span><span class="op" id="7675586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7675590">if</span>&nbsp;<span class="ident" id="7675593">err</span>&nbsp;<span class="op" id="7675597">!=</span>&nbsp;<span class="builtintype" id="7675600">nil</span>&nbsp;<span class="op" id="7675604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7675609">t</span><span class="op" id="7675610">.</span><span class="ident" id="7675611">Errorf</span><span class="op" id="7675617">(</span><span class="string" id="7675618">&#34;Decode&nbsp;with&nbsp;Read()&nbsp;=&nbsp;%d,&nbsp;EOF:&nbsp;%v&#34;</span><span class="op" id="7675652">,</span>&nbsp;<span class="ident" id="7675654">r</span><span class="op" id="7675655">.</span><span class="ident" id="7675656">lenAtEOF</span><span class="op" id="7675664">,</span>&nbsp;<span class="ident" id="7675666">err</span><span class="op" id="7675669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7675673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7675677">if</span>&nbsp;<span class="ident" id="7675680">i</span>&nbsp;<span class="op" id="7675682">==</span>&nbsp;<span class="num" id="7675685">0</span>&nbsp;<span class="op" id="7675687">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7675692">i</span>&nbsp;<span class="op" id="7675694">=</span>&nbsp;<span class="num" id="7675696">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7675700">}</span>&nbsp;<span class="keyword" id="7675702">else</span>&nbsp;<span class="op" id="7675707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7675712">i</span>&nbsp;<span class="op" id="7675714">*=</span>&nbsp;<span class="num" id="7675717">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7675721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7675724">}</span><br>
<span class="lineno">135</span><span class="op" id="7675726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7675729">//&nbsp;check&nbsp;checks&nbsp;that&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;are&nbsp;equal,&nbsp;within&nbsp;the&nbsp;given&nbsp;bounds.</span><br>
<span class="lineno"></span><span class="keyword" id="7675803">func</span>&nbsp;<span class="ident" id="7675808">check</span><span class="op" id="7675813">(</span><span class="ident" id="7675814">bounds</span>&nbsp;<span class="ident" id="7675821">image</span><span class="op" id="7675826">.</span><span class="ident" id="7675827">Rectangle</span><span class="op" id="7675836">,</span>&nbsp;<span class="ident" id="7675838">pix0</span><span class="op" id="7675842">,</span>&nbsp;<span class="ident" id="7675844">pix1</span>&nbsp;<span class="op" id="7675849">[</span><span class="op" id="7675850">]</span><span class="builtintype" id="7675851">byte</span><span class="op" id="7675855">,</span>&nbsp;<span class="ident" id="7675857">stride0</span><span class="op" id="7675864">,</span>&nbsp;<span class="ident" id="7675866">stride1</span>&nbsp;<span class="builtintype" id="7675874">int</span><span class="op" id="7675877">)</span>&nbsp;<span class="builtintype" id="7675879">error</span>&nbsp;<span class="op" id="7675885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7675888">if</span>&nbsp;<span class="ident" id="7675891">stride0</span>&nbsp;<span class="op" id="7675899">&lt;=</span>&nbsp;<span class="num" id="7675902">0</span>&nbsp;<span class="op" id="7675904">||</span>&nbsp;<span class="ident" id="7675907">stride0</span><span class="op" id="7675914">%</span><span class="num" id="7675915">8</span>&nbsp;<span class="op" id="7675917">!=</span>&nbsp;<span class="num" id="7675920">0</span>&nbsp;<span class="op" id="7675922">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7675926">return</span>&nbsp;<span class="ident" id="7675933">fmt</span><span class="op" id="7675936">.</span><span class="ident" id="7675937">Errorf</span><span class="op" id="7675943">(</span><span class="string" id="7675944">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7675959">,</span>&nbsp;<span class="ident" id="7675961">stride0</span><span class="op" id="7675968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7675971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7675974">if</span>&nbsp;<span class="ident" id="7675977">stride1</span>&nbsp;<span class="op" id="7675985">&lt;=</span>&nbsp;<span class="num" id="7675988">0</span>&nbsp;<span class="op" id="7675990">||</span>&nbsp;<span class="ident" id="7675993">stride1</span><span class="op" id="7676000">%</span><span class="num" id="7676001">8</span>&nbsp;<span class="op" id="7676003">!=</span>&nbsp;<span class="num" id="7676006">0</span>&nbsp;<span class="op" id="7676008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7676012">return</span>&nbsp;<span class="ident" id="7676019">fmt</span><span class="op" id="7676022">.</span><span class="ident" id="7676023">Errorf</span><span class="op" id="7676029">(</span><span class="string" id="7676030">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7676045">,</span>&nbsp;<span class="ident" id="7676047">stride1</span><span class="op" id="7676054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7676057">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7676060">//&nbsp;Compare&nbsp;the&nbsp;two&nbsp;pix&nbsp;data,&nbsp;one&nbsp;8x8&nbsp;block&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7676115">for</span>&nbsp;<span class="ident" id="7676119">y</span>&nbsp;<span class="op" id="7676121">:=</span>&nbsp;<span class="num" id="7676124">0</span><span class="op" id="7676125">;</span>&nbsp;<span class="ident" id="7676127">y</span>&nbsp;<span class="op" id="7676129">&lt;</span>&nbsp;<span class="builtinfunc" id="7676131">len</span><span class="op" id="7676134">(</span><span class="ident" id="7676135">pix0</span><span class="op" id="7676139">)</span><span class="op" id="7676140">/</span><span class="ident" id="7676141">stride0</span>&nbsp;<span class="op" id="7676149">&amp;&amp;</span>&nbsp;<span class="ident" id="7676152">y</span>&nbsp;<span class="op" id="7676154">&lt;</span>&nbsp;<span class="builtinfunc" id="7676156">len</span><span class="op" id="7676159">(</span><span class="ident" id="7676160">pix1</span><span class="op" id="7676164">)</span><span class="op" id="7676165">/</span><span class="ident" id="7676166">stride1</span><span class="op" id="7676173">;</span>&nbsp;<span class="ident" id="7676175">y</span>&nbsp;<span class="op" id="7676177">+=</span>&nbsp;<span class="num" id="7676180">8</span>&nbsp;<span class="op" id="7676182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7676186">for</span>&nbsp;<span class="ident" id="7676190">x</span>&nbsp;<span class="op" id="7676192">:=</span>&nbsp;<span class="num" id="7676195">0</span><span class="op" id="7676196">;</span>&nbsp;<span class="ident" id="7676198">x</span>&nbsp;<span class="op" id="7676200">&lt;</span>&nbsp;<span class="ident" id="7676202">stride0</span>&nbsp;<span class="op" id="7676210">&amp;&amp;</span>&nbsp;<span class="ident" id="7676213">x</span>&nbsp;<span class="op" id="7676215">&lt;</span>&nbsp;<span class="ident" id="7676217">stride1</span><span class="op" id="7676224">;</span>&nbsp;<span class="ident" id="7676226">x</span>&nbsp;<span class="op" id="7676228">+=</span>&nbsp;<span class="num" id="7676231">8</span>&nbsp;<span class="op" id="7676233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7676238">if</span>&nbsp;<span class="ident" id="7676241">x</span>&nbsp;<span class="op" id="7676243">&gt;=</span>&nbsp;<span class="ident" id="7676246">bounds</span><span class="op" id="7676252">.</span><span class="ident" id="7676253">Max</span><span class="op" id="7676256">.</span><span class="ident" id="7676257">X</span>&nbsp;<span class="op" id="7676259">||</span>&nbsp;<span class="ident" id="7676262">y</span>&nbsp;<span class="op" id="7676264">&gt;=</span>&nbsp;<span class="ident" id="7676267">bounds</span><span class="op" id="7676273">.</span><span class="ident" id="7676274">Max</span><span class="op" id="7676277">.</span><span class="ident" id="7676278">Y</span>&nbsp;<span class="op" id="7676280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7676286">//&nbsp;We&nbsp;don&#39;t&nbsp;care&nbsp;if&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;differ&nbsp;if&nbsp;the&nbsp;8x8&nbsp;block&nbsp;is</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7676354">//&nbsp;entirely&nbsp;outside&nbsp;of&nbsp;the&nbsp;image&#39;s&nbsp;bounds.&nbsp;For&nbsp;example,&nbsp;this&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7676423">//&nbsp;occur&nbsp;with&nbsp;a&nbsp;4:2:0&nbsp;chroma&nbsp;subsampling&nbsp;and&nbsp;a&nbsp;1x1&nbsp;image.&nbsp;Baseline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7676494">//&nbsp;decoding&nbsp;works&nbsp;on&nbsp;the&nbsp;one&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole;&nbsp;progressive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7676561">//&nbsp;decoding&#39;s&nbsp;first&nbsp;pass&nbsp;works&nbsp;on&nbsp;that&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7676629">//&nbsp;refinement&nbsp;passes&nbsp;only&nbsp;process&nbsp;one&nbsp;8x8&nbsp;block&nbsp;within&nbsp;the&nbsp;MCU.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7676697">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7676709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7676715">for</span>&nbsp;<span class="ident" id="7676719">j</span>&nbsp;<span class="op" id="7676721">:=</span>&nbsp;<span class="num" id="7676724">0</span><span class="op" id="7676725">;</span>&nbsp;<span class="ident" id="7676727">j</span>&nbsp;<span class="op" id="7676729">&lt;</span>&nbsp;<span class="num" id="7676731">8</span><span class="op" id="7676732">;</span>&nbsp;<span class="ident" id="7676734">j</span><span class="op" id="7676735">++</span>&nbsp;<span class="op" id="7676738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7676744">for</span>&nbsp;<span class="ident" id="7676748">i</span>&nbsp;<span class="op" id="7676750">:=</span>&nbsp;<span class="num" id="7676753">0</span><span class="op" id="7676754">;</span>&nbsp;<span class="ident" id="7676756">i</span>&nbsp;<span class="op" id="7676758">&lt;</span>&nbsp;<span class="num" id="7676760">8</span><span class="op" id="7676761">;</span>&nbsp;<span class="ident" id="7676763">i</span><span class="op" id="7676764">++</span>&nbsp;<span class="op" id="7676767">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7676774">index0</span>&nbsp;<span class="op" id="7676781">:=</span>&nbsp;<span class="op" id="7676784">(</span><span class="ident" id="7676785">y</span><span class="op" id="7676786">+</span><span class="ident" id="7676787">j</span><span class="op" id="7676788">)</span><span class="op" id="7676789">*</span><span class="ident" id="7676790">stride0</span>&nbsp;<span class="op" id="7676798">+</span>&nbsp;<span class="op" id="7676800">(</span><span class="ident" id="7676801">x</span>&nbsp;<span class="op" id="7676803">+</span>&nbsp;<span class="ident" id="7676805">i</span><span class="op" id="7676806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7676813">index1</span>&nbsp;<span class="op" id="7676820">:=</span>&nbsp;<span class="op" id="7676823">(</span><span class="ident" id="7676824">y</span><span class="op" id="7676825">+</span><span class="ident" id="7676826">j</span><span class="op" id="7676827">)</span><span class="op" id="7676828">*</span><span class="ident" id="7676829">stride1</span>&nbsp;<span class="op" id="7676837">+</span>&nbsp;<span class="op" id="7676839">(</span><span class="ident" id="7676840">x</span>&nbsp;<span class="op" id="7676842">+</span>&nbsp;<span class="ident" id="7676844">i</span><span class="op" id="7676845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7676852">if</span>&nbsp;<span class="ident" id="7676855">pix0</span><span class="op" id="7676859">[</span><span class="ident" id="7676860">index0</span><span class="op" id="7676866">]</span>&nbsp;<span class="op" id="7676868">!=</span>&nbsp;<span class="ident" id="7676871">pix1</span><span class="op" id="7676875">[</span><span class="ident" id="7676876">index1</span><span class="op" id="7676882">]</span>&nbsp;<span class="op" id="7676884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7676892">return</span>&nbsp;<span class="ident" id="7676899">fmt</span><span class="op" id="7676902">.</span><span class="ident" id="7676903">Errorf</span><span class="op" id="7676909">(</span><span class="string" id="7676910">&#34;blocks&nbsp;at&nbsp;(%d,&nbsp;%d)&nbsp;differ:\n%sand\n%s&#34;</span><span class="op" id="7676949">,</span>&nbsp;<span class="ident" id="7676951">x</span><span class="op" id="7676952">,</span>&nbsp;<span class="ident" id="7676954">y</span><span class="op" id="7676955">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7676964">pixString</span><span class="op" id="7676973">(</span><span class="ident" id="7676974">pix0</span><span class="op" id="7676978">,</span>&nbsp;<span class="ident" id="7676980">stride0</span><span class="op" id="7676987">,</span>&nbsp;<span class="ident" id="7676989">x</span><span class="op" id="7676990">,</span>&nbsp;<span class="ident" id="7676992">y</span><span class="op" id="7676993">)</span><span class="op" id="7676994">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7677003">pixString</span><span class="op" id="7677012">(</span><span class="ident" id="7677013">pix1</span><span class="op" id="7677017">,</span>&nbsp;<span class="ident" id="7677019">stride1</span><span class="op" id="7677026">,</span>&nbsp;<span class="ident" id="7677028">x</span><span class="op" id="7677029">,</span>&nbsp;<span class="ident" id="7677031">y</span><span class="op" id="7677032">)</span><span class="op" id="7677033">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7677041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7677048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7677054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7677059">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7677063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7677066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7677069">return</span>&nbsp;<span class="builtintype" id="7677076">nil</span><br>
<span class="lineno"></span><span class="op" id="7677080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="7677083">func</span>&nbsp;<span class="ident" id="7677088">pixString</span><span class="op" id="7677097">(</span><span class="ident" id="7677098">pix</span>&nbsp;<span class="op" id="7677102">[</span><span class="op" id="7677103">]</span><span class="builtintype" id="7677104">byte</span><span class="op" id="7677108">,</span>&nbsp;<span class="ident" id="7677110">stride</span><span class="op" id="7677116">,</span>&nbsp;<span class="ident" id="7677118">x</span><span class="op" id="7677119">,</span>&nbsp;<span class="ident" id="7677121">y</span>&nbsp;<span class="builtintype" id="7677123">int</span><span class="op" id="7677126">)</span>&nbsp;<span class="builtintype" id="7677128">string</span>&nbsp;<span class="op" id="7677135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7677138">s</span>&nbsp;<span class="op" id="7677140">:=</span>&nbsp;<span class="ident" id="7677143">bytes</span><span class="op" id="7677148">.</span><span class="ident" id="7677149">NewBuffer</span><span class="op" id="7677158">(</span><span class="builtintype" id="7677159">nil</span><span class="op" id="7677162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7677165">for</span>&nbsp;<span class="ident" id="7677169">j</span>&nbsp;<span class="op" id="7677171">:=</span>&nbsp;<span class="num" id="7677174">0</span><span class="op" id="7677175">;</span>&nbsp;<span class="ident" id="7677177">j</span>&nbsp;<span class="op" id="7677179">&lt;</span>&nbsp;<span class="num" id="7677181">8</span><span class="op" id="7677182">;</span>&nbsp;<span class="ident" id="7677184">j</span><span class="op" id="7677185">++</span>&nbsp;<span class="op" id="7677188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7677192">fmt</span><span class="op" id="7677195">.</span><span class="ident" id="7677196">Fprintf</span><span class="op" id="7677203">(</span><span class="ident" id="7677204">s</span><span class="op" id="7677205">,</span>&nbsp;<span class="string" id="7677207">&#34;\t&#34;</span><span class="op" id="7677211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7677215">for</span>&nbsp;<span class="ident" id="7677219">i</span>&nbsp;<span class="op" id="7677221">:=</span>&nbsp;<span class="num" id="7677224">0</span><span class="op" id="7677225">;</span>&nbsp;<span class="ident" id="7677227">i</span>&nbsp;<span class="op" id="7677229">&lt;</span>&nbsp;<span class="num" id="7677231">8</span><span class="op" id="7677232">;</span>&nbsp;<span class="ident" id="7677234">i</span><span class="op" id="7677235">++</span>&nbsp;<span class="op" id="7677238">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7677243">fmt</span><span class="op" id="7677246">.</span><span class="ident" id="7677247">Fprintf</span><span class="op" id="7677254">(</span><span class="ident" id="7677255">s</span><span class="op" id="7677256">,</span>&nbsp;<span class="string" id="7677258">&#34;%02x&nbsp;&#34;</span><span class="op" id="7677265">,</span>&nbsp;<span class="ident" id="7677267">pix</span><span class="op" id="7677270">[</span><span class="op" id="7677271">(</span><span class="ident" id="7677272">y</span><span class="op" id="7677273">+</span><span class="ident" id="7677274">j</span><span class="op" id="7677275">)</span><span class="op" id="7677276">*</span><span class="ident" id="7677277">stride</span><span class="op" id="7677283">+</span><span class="op" id="7677284">(</span><span class="ident" id="7677285">x</span><span class="op" id="7677286">+</span><span class="ident" id="7677287">i</span><span class="op" id="7677288">)</span><span class="op" id="7677289">]</span><span class="op" id="7677290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7677294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7677298">fmt</span><span class="op" id="7677301">.</span><span class="ident" id="7677302">Fprintf</span><span class="op" id="7677309">(</span><span class="ident" id="7677310">s</span><span class="op" id="7677311">,</span>&nbsp;<span class="string" id="7677313">&#34;\n&#34;</span><span class="op" id="7677317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7677320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7677323">return</span>&nbsp;<span class="ident" id="7677330">s</span><span class="op" id="7677331">.</span><span class="ident" id="7677332">String</span><span class="op" id="7677338">(</span><span class="op" id="7677339">)</span><br>
<span class="lineno">185</span><span class="op" id="7677341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7677344">func</span>&nbsp;<span class="ident" id="7677349">TestExtraneousData</span><span class="op" id="7677367">(</span><span class="ident" id="7677368">t</span>&nbsp;<span class="op" id="7677370">*</span><span class="ident" id="7677371">testing</span><span class="op" id="7677378">.</span><span class="ident" id="7677379">T</span><span class="op" id="7677380">)</span>&nbsp;<span class="op" id="7677382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7677385">//&nbsp;Encode&nbsp;a&nbsp;1x1&nbsp;red&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7677413">src</span>&nbsp;<span class="op" id="7677417">:=</span>&nbsp;<span class="ident" id="7677420">image</span><span class="op" id="7677425">.</span><span class="ident" id="7677426">NewRGBA</span><span class="op" id="7677433">(</span><span class="ident" id="7677434">image</span><span class="op" id="7677439">.</span><span class="ident" id="7677440">Rect</span><span class="op" id="7677444">(</span><span class="num" id="7677445">0</span><span class="op" id="7677446">,</span>&nbsp;<span class="num" id="7677448">0</span><span class="op" id="7677449">,</span>&nbsp;<span class="num" id="7677451">1</span><span class="op" id="7677452">,</span>&nbsp;<span class="num" id="7677454">1</span><span class="op" id="7677455">)</span><span class="op" id="7677456">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7677459">src</span><span class="op" id="7677462">.</span><span class="ident" id="7677463">Set</span><span class="op" id="7677466">(</span><span class="num" id="7677467">0</span><span class="op" id="7677468">,</span>&nbsp;<span class="num" id="7677470">0</span><span class="op" id="7677471">,</span>&nbsp;<span class="ident" id="7677473">color</span><span class="op" id="7677478">.</span><span class="ident" id="7677479">RGBA</span><span class="op" id="7677483">{</span><span class="num" id="7677484">0xff</span><span class="op" id="7677488">,</span>&nbsp;<span class="num" id="7677490">0x00</span><span class="op" id="7677494">,</span>&nbsp;<span class="num" id="7677496">0x00</span><span class="op" id="7677500">,</span>&nbsp;<span class="num" id="7677502">0xff</span><span class="op" id="7677506">}</span><span class="op" id="7677507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7677510">buf</span>&nbsp;<span class="op" id="7677514">:=</span>&nbsp;<span class="builtinfunc" id="7677517">new</span><span class="op" id="7677520">(</span><span class="ident" id="7677521">bytes</span><span class="op" id="7677526">.</span><span class="ident" id="7677527">Buffer</span><span class="op" id="7677533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7677536">if</span>&nbsp;<span class="ident" id="7677539">err</span>&nbsp;<span class="op" id="7677543">:=</span>&nbsp;<span class="ident" id="7677546">Encode</span><span class="op" id="7677552">(</span><span class="ident" id="7677553">buf</span><span class="op" id="7677556">,</span>&nbsp;<span class="ident" id="7677558">src</span><span class="op" id="7677561">,</span>&nbsp;<span class="builtintype" id="7677563">nil</span><span class="op" id="7677566">)</span><span class="op" id="7677567">;</span>&nbsp;<span class="ident" id="7677569">err</span>&nbsp;<span class="op" id="7677573">!=</span>&nbsp;<span class="builtintype" id="7677576">nil</span>&nbsp;<span class="op" id="7677580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7677584">t</span><span class="op" id="7677585">.</span><span class="ident" id="7677586">Fatalf</span><span class="op" id="7677592">(</span><span class="string" id="7677593">&#34;encode:&nbsp;%v&#34;</span><span class="op" id="7677605">,</span>&nbsp;<span class="ident" id="7677607">err</span><span class="op" id="7677610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7677613">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7677616">enc</span>&nbsp;<span class="op" id="7677620">:=</span>&nbsp;<span class="ident" id="7677623">buf</span><span class="op" id="7677626">.</span><span class="ident" id="7677627">String</span><span class="op" id="7677633">(</span><span class="op" id="7677634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7677637">//&nbsp;Sanity&nbsp;check&nbsp;that&nbsp;the&nbsp;encoded&nbsp;JPEG&nbsp;is&nbsp;long&nbsp;enough,&nbsp;that&nbsp;it&nbsp;ends&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7677710">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker,&nbsp;and&nbsp;that&nbsp;it&nbsp;contains&nbsp;a&nbsp;&#34;\xff\xda&#34;&nbsp;SOS&nbsp;marker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7677782">//&nbsp;somewhere&nbsp;in&nbsp;the&nbsp;final&nbsp;64&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7677819">if</span>&nbsp;<span class="builtinfunc" id="7677822">len</span><span class="op" id="7677825">(</span><span class="ident" id="7677826">enc</span><span class="op" id="7677829">)</span>&nbsp;<span class="op" id="7677831">&lt;</span>&nbsp;<span class="num" id="7677833">64</span>&nbsp;<span class="op" id="7677836">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7677840">t</span><span class="op" id="7677841">.</span><span class="ident" id="7677842">Fatalf</span><span class="op" id="7677848">(</span><span class="string" id="7677849">&#34;encoded&nbsp;JPEG&nbsp;is&nbsp;too&nbsp;short:&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="7677886">,</span>&nbsp;<span class="builtinfunc" id="7677888">len</span><span class="op" id="7677891">(</span><span class="ident" id="7677892">enc</span><span class="op" id="7677895">)</span><span class="op" id="7677896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7677899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7677902">if</span>&nbsp;<span class="ident" id="7677905">got</span><span class="op" id="7677908">,</span>&nbsp;<span class="ident" id="7677910">want</span>&nbsp;<span class="op" id="7677915">:=</span>&nbsp;<span class="ident" id="7677918">enc</span><span class="op" id="7677921">[</span><span class="builtinfunc" id="7677922">len</span><span class="op" id="7677925">(</span><span class="ident" id="7677926">enc</span><span class="op" id="7677929">)</span><span class="op" id="7677930">-</span><span class="num" id="7677931">2</span><span class="op" id="7677932">:</span><span class="op" id="7677933">]</span><span class="op" id="7677934">,</span>&nbsp;<span class="string" id="7677936">&#34;\xff\xd9&#34;</span><span class="op" id="7677946">;</span>&nbsp;<span class="ident" id="7677948">got</span>&nbsp;<span class="op" id="7677952">!=</span>&nbsp;<span class="ident" id="7677955">want</span>&nbsp;<span class="op" id="7677960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7677964">t</span><span class="op" id="7677965">.</span><span class="ident" id="7677966">Fatalf</span><span class="op" id="7677972">(</span><span class="string" id="7677973">&#34;encoded&nbsp;JPEG&nbsp;ends&nbsp;with&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7678009">,</span>&nbsp;<span class="ident" id="7678011">got</span><span class="op" id="7678014">,</span>&nbsp;<span class="ident" id="7678016">want</span><span class="op" id="7678020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7678023">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7678026">if</span>&nbsp;<span class="ident" id="7678029">s</span>&nbsp;<span class="op" id="7678031">:=</span>&nbsp;<span class="ident" id="7678034">enc</span><span class="op" id="7678037">[</span><span class="builtinfunc" id="7678038">len</span><span class="op" id="7678041">(</span><span class="ident" id="7678042">enc</span><span class="op" id="7678045">)</span><span class="op" id="7678046">-</span><span class="num" id="7678047">64</span><span class="op" id="7678049">:</span><span class="op" id="7678050">]</span><span class="op" id="7678051">;</span>&nbsp;<span class="op" id="7678053">!</span><span class="ident" id="7678054">strings</span><span class="op" id="7678061">.</span><span class="ident" id="7678062">Contains</span><span class="op" id="7678070">(</span><span class="ident" id="7678071">s</span><span class="op" id="7678072">,</span>&nbsp;<span class="string" id="7678074">&#34;\xff\xda&#34;</span><span class="op" id="7678084">)</span>&nbsp;<span class="op" id="7678086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7678090">t</span><span class="op" id="7678091">.</span><span class="ident" id="7678092">Fatalf</span><span class="op" id="7678098">(</span><span class="string" id="7678099">&#34;encoded&nbsp;JPEG&nbsp;does&nbsp;not&nbsp;contain&nbsp;a&nbsp;SOS&nbsp;marker&nbsp;(ff&nbsp;da)&nbsp;near&nbsp;the&nbsp;end:&nbsp;%&nbsp;x&#34;</span><span class="op" id="7678169">,</span>&nbsp;<span class="ident" id="7678171">s</span><span class="op" id="7678172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7678175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7678178">//&nbsp;Test&nbsp;that&nbsp;adding&nbsp;some&nbsp;random&nbsp;junk&nbsp;between&nbsp;the&nbsp;SOS&nbsp;marker&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7678247">//&nbsp;EOI&nbsp;marker&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;decoding.</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7678292">rnd</span>&nbsp;<span class="op" id="7678296">:=</span>&nbsp;<span class="ident" id="7678299">rand</span><span class="op" id="7678303">.</span><span class="ident" id="7678304">New</span><span class="op" id="7678307">(</span><span class="ident" id="7678308">rand</span><span class="op" id="7678312">.</span><span class="ident" id="7678313">NewSource</span><span class="op" id="7678322">(</span><span class="num" id="7678323">1</span><span class="op" id="7678324">)</span><span class="op" id="7678325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7678328">for</span>&nbsp;<span class="ident" id="7678332">i</span><span class="op" id="7678333">,</span>&nbsp;<span class="ident" id="7678335">nerr</span>&nbsp;<span class="op" id="7678340">:=</span>&nbsp;<span class="num" id="7678343">0</span><span class="op" id="7678344">,</span>&nbsp;<span class="num" id="7678346">0</span><span class="op" id="7678347">;</span>&nbsp;<span class="ident" id="7678349">i</span>&nbsp;<span class="op" id="7678351">&lt;</span>&nbsp;<span class="num" id="7678353">1000</span>&nbsp;<span class="op" id="7678358">&amp;&amp;</span>&nbsp;<span class="ident" id="7678361">nerr</span>&nbsp;<span class="op" id="7678366">&lt;</span>&nbsp;<span class="num" id="7678368">10</span><span class="op" id="7678370">;</span>&nbsp;<span class="ident" id="7678372">i</span><span class="op" id="7678373">++</span>&nbsp;<span class="op" id="7678376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7678380">buf</span><span class="op" id="7678383">.</span><span class="ident" id="7678384">Reset</span><span class="op" id="7678389">(</span><span class="op" id="7678390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7678394">//&nbsp;Write&nbsp;all&nbsp;but&nbsp;the&nbsp;trailing&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7678449">buf</span><span class="op" id="7678452">.</span><span class="ident" id="7678453">WriteString</span><span class="op" id="7678464">(</span><span class="ident" id="7678465">enc</span><span class="op" id="7678468">[</span><span class="op" id="7678469">:</span><span class="builtinfunc" id="7678470">len</span><span class="op" id="7678473">(</span><span class="ident" id="7678474">enc</span><span class="op" id="7678477">)</span><span class="op" id="7678478">-</span><span class="num" id="7678479">2</span><span class="op" id="7678480">]</span><span class="op" id="7678481">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7678485">//&nbsp;Write&nbsp;some&nbsp;random&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7678525">for</span>&nbsp;<span class="ident" id="7678529">n</span>&nbsp;<span class="op" id="7678531">:=</span>&nbsp;<span class="ident" id="7678534">rnd</span><span class="op" id="7678537">.</span><span class="ident" id="7678538">Intn</span><span class="op" id="7678542">(</span><span class="num" id="7678543">10</span><span class="op" id="7678545">)</span><span class="op" id="7678546">;</span>&nbsp;<span class="ident" id="7678548">n</span>&nbsp;<span class="op" id="7678550">&gt;</span>&nbsp;<span class="num" id="7678552">0</span><span class="op" id="7678553">;</span>&nbsp;<span class="ident" id="7678555">n</span><span class="op" id="7678556">--</span>&nbsp;<span class="op" id="7678559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7678564">if</span>&nbsp;<span class="ident" id="7678567">x</span>&nbsp;<span class="op" id="7678569">:=</span>&nbsp;<span class="builtintype" id="7678572">byte</span><span class="op" id="7678576">(</span><span class="ident" id="7678577">rnd</span><span class="op" id="7678580">.</span><span class="ident" id="7678581">Intn</span><span class="op" id="7678585">(</span><span class="num" id="7678586">256</span><span class="op" id="7678589">)</span><span class="op" id="7678590">)</span><span class="op" id="7678591">;</span>&nbsp;<span class="ident" id="7678593">x</span>&nbsp;<span class="op" id="7678595">!=</span>&nbsp;<span class="num" id="7678598">0xff</span>&nbsp;<span class="op" id="7678603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7678609">buf</span><span class="op" id="7678612">.</span><span class="ident" id="7678613">WriteByte</span><span class="op" id="7678622">(</span><span class="ident" id="7678623">x</span><span class="op" id="7678624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7678629">}</span>&nbsp;<span class="keyword" id="7678631">else</span>&nbsp;<span class="op" id="7678636">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7678642">//&nbsp;The&nbsp;JPEG&nbsp;format&nbsp;escapes&nbsp;a&nbsp;SOS&nbsp;0xff&nbsp;data&nbsp;byte&nbsp;as&nbsp;&#34;\xff\x00&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7678709">buf</span><span class="op" id="7678712">.</span><span class="ident" id="7678713">WriteString</span><span class="op" id="7678724">(</span><span class="string" id="7678725">&#34;\xff\x00&#34;</span><span class="op" id="7678735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7678740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7678744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7678748">//&nbsp;Write&nbsp;the&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7678786">buf</span><span class="op" id="7678789">.</span><span class="ident" id="7678790">WriteString</span><span class="op" id="7678801">(</span><span class="string" id="7678802">&#34;\xff\xd9&#34;</span><span class="op" id="7678812">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7678817">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;can&nbsp;still&nbsp;decode&nbsp;the&nbsp;resultant&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7678874">got</span><span class="op" id="7678877">,</span>&nbsp;<span class="ident" id="7678879">err</span>&nbsp;<span class="op" id="7678883">:=</span>&nbsp;<span class="ident" id="7678886">Decode</span><span class="op" id="7678892">(</span><span class="ident" id="7678893">buf</span><span class="op" id="7678896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7678900">if</span>&nbsp;<span class="ident" id="7678903">err</span>&nbsp;<span class="op" id="7678907">!=</span>&nbsp;<span class="builtintype" id="7678910">nil</span>&nbsp;<span class="op" id="7678914">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7678919">t</span><span class="op" id="7678920">.</span><span class="ident" id="7678921">Errorf</span><span class="op" id="7678927">(</span><span class="string" id="7678928">&#34;could&nbsp;not&nbsp;decode&nbsp;image&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="7678960">,</span>&nbsp;<span class="ident" id="7678962">i</span><span class="op" id="7678963">,</span>&nbsp;<span class="ident" id="7678965">err</span><span class="op" id="7678968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7678973">nerr</span><span class="op" id="7678977">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7678983">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7678994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7678998">if</span>&nbsp;<span class="ident" id="7679001">got</span><span class="op" id="7679004">.</span><span class="ident" id="7679005">Bounds</span><span class="op" id="7679011">(</span><span class="op" id="7679012">)</span>&nbsp;<span class="op" id="7679014">!=</span>&nbsp;<span class="ident" id="7679017">src</span><span class="op" id="7679020">.</span><span class="ident" id="7679021">Bounds</span><span class="op" id="7679027">(</span><span class="op" id="7679028">)</span>&nbsp;<span class="op" id="7679030">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7679035">t</span><span class="op" id="7679036">.</span><span class="ident" id="7679037">Errorf</span><span class="op" id="7679043">(</span><span class="string" id="7679044">&#34;image&nbsp;#%d,&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7679081">,</span>&nbsp;<span class="ident" id="7679083">i</span><span class="op" id="7679084">,</span>&nbsp;<span class="ident" id="7679086">got</span><span class="op" id="7679089">.</span><span class="ident" id="7679090">Bounds</span><span class="op" id="7679096">(</span><span class="op" id="7679097">)</span><span class="op" id="7679098">,</span>&nbsp;<span class="ident" id="7679100">src</span><span class="op" id="7679103">.</span><span class="ident" id="7679104">Bounds</span><span class="op" id="7679110">(</span><span class="op" id="7679111">)</span><span class="op" id="7679112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7679117">nerr</span><span class="op" id="7679121">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7679127">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7679138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7679142">if</span>&nbsp;<span class="ident" id="7679145">averageDelta</span><span class="op" id="7679157">(</span><span class="ident" id="7679158">got</span><span class="op" id="7679161">,</span>&nbsp;<span class="ident" id="7679163">src</span><span class="op" id="7679166">)</span>&nbsp;<span class="op" id="7679168">&gt;</span>&nbsp;<span class="num" id="7679170">2</span><span class="op" id="7679171">&lt;&lt;</span><span class="num" id="7679173">8</span>&nbsp;<span class="op" id="7679175">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7679180">t</span><span class="op" id="7679181">.</span><span class="ident" id="7679182">Errorf</span><span class="op" id="7679188">(</span><span class="string" id="7679189">&#34;image&nbsp;#%d&nbsp;changed&nbsp;too&nbsp;much&nbsp;after&nbsp;a&nbsp;round&nbsp;trip&#34;</span><span class="op" id="7679236">,</span>&nbsp;<span class="ident" id="7679238">i</span><span class="op" id="7679239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7679244">nerr</span><span class="op" id="7679248">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7679254">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7679265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7679268">}</span><br>
<span class="lineno">245</span><span class="op" id="7679270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7679273">func</span>&nbsp;<span class="ident" id="7679278">benchmarkDecode</span><span class="op" id="7679293">(</span><span class="ident" id="7679294">b</span>&nbsp;<span class="op" id="7679296">*</span><span class="ident" id="7679297">testing</span><span class="op" id="7679304">.</span><span class="ident" id="7679305">B</span><span class="op" id="7679306">,</span>&nbsp;<span class="ident" id="7679308">filename</span>&nbsp;<span class="builtintype" id="7679317">string</span><span class="op" id="7679323">)</span>&nbsp;<span class="op" id="7679325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7679328">b</span><span class="op" id="7679329">.</span><span class="ident" id="7679330">StopTimer</span><span class="op" id="7679339">(</span><span class="op" id="7679340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7679343">data</span><span class="op" id="7679347">,</span>&nbsp;<span class="ident" id="7679349">err</span>&nbsp;<span class="op" id="7679353">:=</span>&nbsp;<span class="ident" id="7679356">ioutil</span><span class="op" id="7679362">.</span><span class="ident" id="7679363">ReadFile</span><span class="op" id="7679371">(</span><span class="ident" id="7679372">filename</span><span class="op" id="7679380">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7679383">if</span>&nbsp;<span class="ident" id="7679386">err</span>&nbsp;<span class="op" id="7679390">!=</span>&nbsp;<span class="builtintype" id="7679393">nil</span>&nbsp;<span class="op" id="7679397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7679401">b</span><span class="op" id="7679402">.</span><span class="ident" id="7679403">Fatal</span><span class="op" id="7679408">(</span><span class="ident" id="7679409">err</span><span class="op" id="7679412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7679415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7679418">cfg</span><span class="op" id="7679421">,</span>&nbsp;<span class="ident" id="7679423">err</span>&nbsp;<span class="op" id="7679427">:=</span>&nbsp;<span class="ident" id="7679430">DecodeConfig</span><span class="op" id="7679442">(</span><span class="ident" id="7679443">bytes</span><span class="op" id="7679448">.</span><span class="ident" id="7679449">NewReader</span><span class="op" id="7679458">(</span><span class="ident" id="7679459">data</span><span class="op" id="7679463">)</span><span class="op" id="7679464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7679467">if</span>&nbsp;<span class="ident" id="7679470">err</span>&nbsp;<span class="op" id="7679474">!=</span>&nbsp;<span class="builtintype" id="7679477">nil</span>&nbsp;<span class="op" id="7679481">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7679485">b</span><span class="op" id="7679486">.</span><span class="ident" id="7679487">Fatal</span><span class="op" id="7679492">(</span><span class="ident" id="7679493">err</span><span class="op" id="7679496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7679499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7679502">b</span><span class="op" id="7679503">.</span><span class="ident" id="7679504">SetBytes</span><span class="op" id="7679512">(</span><span class="ident" id="7679513">int64</span><span class="op" id="7679518">(</span><span class="ident" id="7679519">cfg</span><span class="op" id="7679522">.</span><span class="ident" id="7679523">Width</span>&nbsp;<span class="op" id="7679529">*</span>&nbsp;<span class="ident" id="7679531">cfg</span><span class="op" id="7679534">.</span><span class="ident" id="7679535">Height</span>&nbsp;<span class="op" id="7679542">*</span>&nbsp;<span class="num" id="7679544">4</span><span class="op" id="7679545">)</span><span class="op" id="7679546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7679549">b</span><span class="op" id="7679550">.</span><span class="ident" id="7679551">StartTimer</span><span class="op" id="7679561">(</span><span class="op" id="7679562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7679565">for</span>&nbsp;<span class="ident" id="7679569">i</span>&nbsp;<span class="op" id="7679571">:=</span>&nbsp;<span class="num" id="7679574">0</span><span class="op" id="7679575">;</span>&nbsp;<span class="ident" id="7679577">i</span>&nbsp;<span class="op" id="7679579">&lt;</span>&nbsp;<span class="ident" id="7679581">b</span><span class="op" id="7679582">.</span><span class="ident" id="7679583">N</span><span class="op" id="7679584">;</span>&nbsp;<span class="ident" id="7679586">i</span><span class="op" id="7679587">++</span>&nbsp;<span class="op" id="7679590">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7679594">Decode</span><span class="op" id="7679600">(</span><span class="ident" id="7679601">bytes</span><span class="op" id="7679606">.</span><span class="ident" id="7679607">NewReader</span><span class="op" id="7679616">(</span><span class="ident" id="7679617">data</span><span class="op" id="7679621">)</span><span class="op" id="7679622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7679625">}</span><br>
<span class="lineno"></span><span class="op" id="7679627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7679630">func</span>&nbsp;<span class="ident" id="7679635">BenchmarkDecodeBaseline</span><span class="op" id="7679658">(</span><span class="ident" id="7679659">b</span>&nbsp;<span class="op" id="7679661">*</span><span class="ident" id="7679662">testing</span><span class="op" id="7679669">.</span><span class="ident" id="7679670">B</span><span class="op" id="7679671">)</span>&nbsp;<span class="op" id="7679673">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7679676">benchmarkDecode</span><span class="op" id="7679691">(</span><span class="ident" id="7679692">b</span><span class="op" id="7679693">,</span>&nbsp;<span class="string" id="7679695">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7679723">)</span><br>
<span class="lineno"></span><span class="op" id="7679725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7679728">func</span>&nbsp;<span class="ident" id="7679733">BenchmarkDecodeProgressive</span><span class="op" id="7679759">(</span><span class="ident" id="7679760">b</span>&nbsp;<span class="op" id="7679762">*</span><span class="ident" id="7679763">testing</span><span class="op" id="7679770">.</span><span class="ident" id="7679771">B</span><span class="op" id="7679772">)</span>&nbsp;<span class="op" id="7679774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7679777">benchmarkDecode</span><span class="op" id="7679792">(</span><span class="ident" id="7679793">b</span><span class="op" id="7679794">,</span>&nbsp;<span class="string" id="7679796">&#34;../testdata/video-001.progressive.jpeg&#34;</span><span class="op" id="7679836">)</span><br>
<span class="lineno">270</span><span class="op" id="7679838">}</span>
</div>
</body>
</html>
