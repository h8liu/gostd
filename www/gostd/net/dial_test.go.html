<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7745413">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7745468">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7745522">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7745573">package</span>&nbsp;<span class="ident" id="7745581">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7745586">import</span>&nbsp;<span class="op" id="7745593">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7745596">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7745605">&#34;flag&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7745613">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7745620">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7745626">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7745632">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7745643">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7745654">&#34;regexp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7745664">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7745675">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7745686">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7745694">&#34;testing&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7745705">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7745712">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7745715">func</span>&nbsp;<span class="ident" id="7745720">newLocalListener</span><span class="op" id="7745736">(</span><span class="ident" id="7745737">t</span>&nbsp;<span class="op" id="7745739">*</span><span class="ident" id="7745740">testing</span><span class="op" id="7745747">.</span><span class="ident" id="7745748">T</span><span class="op" id="7745749">)</span>&nbsp;<span class="ident" id="7745751">Listener</span>&nbsp;<span class="op" id="7745760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7745763">ln</span><span class="op" id="7745765">,</span>&nbsp;<span class="ident" id="7745767">err</span>&nbsp;<span class="op" id="7745771">:=</span>&nbsp;<span class="ident" id="7745774">Listen</span><span class="op" id="7745780">(</span><span class="string" id="7745781">&#34;tcp&#34;</span><span class="op" id="7745786">,</span>&nbsp;<span class="string" id="7745788">&#34;127.0.0.1:0&#34;</span><span class="op" id="7745801">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7745804">if</span>&nbsp;<span class="ident" id="7745807">err</span>&nbsp;<span class="op" id="7745811">!=</span>&nbsp;<span class="ident" id="7745814">nil</span>&nbsp;<span class="op" id="7745818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7745822">ln</span><span class="op" id="7745824">,</span>&nbsp;<span class="ident" id="7745826">err</span>&nbsp;<span class="op" id="7745830">=</span>&nbsp;<span class="ident" id="7745832">Listen</span><span class="op" id="7745838">(</span><span class="string" id="7745839">&#34;tcp6&#34;</span><span class="op" id="7745845">,</span>&nbsp;<span class="string" id="7745847">&#34;[::1]:0&#34;</span><span class="op" id="7745856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7745859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7745862">if</span>&nbsp;<span class="ident" id="7745865">err</span>&nbsp;<span class="op" id="7745869">!=</span>&nbsp;<span class="ident" id="7745872">nil</span>&nbsp;<span class="op" id="7745876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7745880">t</span><span class="op" id="7745881">.</span><span class="ident" id="7745882">Fatal</span><span class="op" id="7745887">(</span><span class="ident" id="7745888">err</span><span class="op" id="7745891">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7745894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7745897">return</span>&nbsp;<span class="ident" id="7745904">ln</span><br>
<span class="lineno"></span><span class="op" id="7745907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7745910">func</span>&nbsp;<span class="ident" id="7745915">TestDialTimeout</span><span class="op" id="7745930">(</span><span class="ident" id="7745931">t</span>&nbsp;<span class="op" id="7745933">*</span><span class="ident" id="7745934">testing</span><span class="op" id="7745941">.</span><span class="ident" id="7745942">T</span><span class="op" id="7745943">)</span>&nbsp;<span class="op" id="7745945">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7745948">origBacklog</span>&nbsp;<span class="op" id="7745960">:=</span>&nbsp;<span class="ident" id="7745963">listenerBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7745980">defer</span>&nbsp;<span class="keyword" id="7745986">func</span><span class="op" id="7745990">(</span><span class="op" id="7745991">)</span>&nbsp;<span class="op" id="7745993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7745997">listenerBacklog</span>&nbsp;<span class="op" id="7746013">=</span>&nbsp;<span class="ident" id="7746015">origBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7746028">}</span><span class="op" id="7746029">(</span><span class="op" id="7746030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7746033">listenerBacklog</span>&nbsp;<span class="op" id="7746049">=</span>&nbsp;<span class="num" id="7746051">1</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7746055">ln</span>&nbsp;<span class="op" id="7746058">:=</span>&nbsp;<span class="ident" id="7746061">newLocalListener</span><span class="op" id="7746077">(</span><span class="ident" id="7746078">t</span><span class="op" id="7746079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7746082">defer</span>&nbsp;<span class="ident" id="7746088">ln</span><span class="op" id="7746090">.</span><span class="ident" id="7746091">Close</span><span class="op" id="7746096">(</span><span class="op" id="7746097">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7746101">errc</span>&nbsp;<span class="op" id="7746106">:=</span>&nbsp;<span class="builtinfunc" id="7746109">make</span><span class="op" id="7746113">(</span><span class="keyword" id="7746114">chan</span>&nbsp;<span class="builtintype" id="7746119">error</span><span class="op" id="7746124">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7746128">numConns</span>&nbsp;<span class="op" id="7746137">:=</span>&nbsp;<span class="ident" id="7746140">listenerBacklog</span>&nbsp;<span class="op" id="7746156">+</span>&nbsp;<span class="num" id="7746158">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7746164">//&nbsp;TODO(bradfitz):&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;test&nbsp;this&nbsp;in&nbsp;a&nbsp;portable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7746221">//&nbsp;way.&nbsp;This&nbsp;is&nbsp;unfortunate,&nbsp;but&nbsp;works&nbsp;for&nbsp;now.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7746270">switch</span>&nbsp;<span class="ident" id="7746277">runtime</span><span class="op" id="7746284">.</span><span class="ident" id="7746285">GOOS</span>&nbsp;<span class="op" id="7746290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7746293">case</span>&nbsp;<span class="string" id="7746298">&#34;linux&#34;</span><span class="op" id="7746305">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7746309">//&nbsp;The&nbsp;kernel&nbsp;will&nbsp;start&nbsp;accepting&nbsp;TCP&nbsp;connections&nbsp;before&nbsp;userspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7746379">//&nbsp;gets&nbsp;a&nbsp;chance&nbsp;to&nbsp;not&nbsp;accept&nbsp;them,&nbsp;so&nbsp;fire&nbsp;off&nbsp;a&nbsp;bunch&nbsp;to&nbsp;fill&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7746449">//&nbsp;the&nbsp;kernel&#39;s&nbsp;backlog.&nbsp;&nbsp;Then&nbsp;we&nbsp;test&nbsp;we&nbsp;get&nbsp;a&nbsp;failure&nbsp;after&nbsp;that.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7746519">for</span>&nbsp;<span class="ident" id="7746523">i</span>&nbsp;<span class="op" id="7746525">:=</span>&nbsp;<span class="num" id="7746528">0</span><span class="op" id="7746529">;</span>&nbsp;<span class="ident" id="7746531">i</span>&nbsp;<span class="op" id="7746533">&lt;</span>&nbsp;<span class="ident" id="7746535">numConns</span><span class="op" id="7746543">;</span>&nbsp;<span class="ident" id="7746545">i</span><span class="op" id="7746546">++</span>&nbsp;<span class="op" id="7746549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7746554">go</span>&nbsp;<span class="keyword" id="7746557">func</span><span class="op" id="7746561">(</span><span class="op" id="7746562">)</span>&nbsp;<span class="op" id="7746564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7746570">_</span><span class="op" id="7746571">,</span>&nbsp;<span class="ident" id="7746573">err</span>&nbsp;<span class="op" id="7746577">:=</span>&nbsp;<span class="ident" id="7746580">DialTimeout</span><span class="op" id="7746591">(</span><span class="string" id="7746592">&#34;tcp&#34;</span><span class="op" id="7746597">,</span>&nbsp;<span class="ident" id="7746599">ln</span><span class="op" id="7746601">.</span><span class="ident" id="7746602">Addr</span><span class="op" id="7746606">(</span><span class="op" id="7746607">)</span><span class="op" id="7746608">.</span><span class="ident" id="7746609">String</span><span class="op" id="7746615">(</span><span class="op" id="7746616">)</span><span class="op" id="7746617">,</span>&nbsp;<span class="num" id="7746619">200</span><span class="op" id="7746622">*</span><span class="ident" id="7746623">time</span><span class="op" id="7746627">.</span><span class="ident" id="7746628">Millisecond</span><span class="op" id="7746639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7746645">errc</span>&nbsp;<span class="op" id="7746650">&lt;-</span>&nbsp;<span class="ident" id="7746653">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7746660">}</span><span class="op" id="7746661">(</span><span class="op" id="7746662">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7746666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7746669">case</span>&nbsp;<span class="string" id="7746674">&#34;darwin&#34;</span><span class="op" id="7746682">,</span>&nbsp;<span class="string" id="7746684">&#34;plan9&#34;</span><span class="op" id="7746691">,</span>&nbsp;<span class="string" id="7746693">&#34;windows&#34;</span><span class="op" id="7746702">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7746706">//&nbsp;At&nbsp;least&nbsp;OS&nbsp;X&nbsp;10.7&nbsp;seems&nbsp;to&nbsp;accept&nbsp;any&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7746760">//&nbsp;connections,&nbsp;ignoring&nbsp;listen&#39;s&nbsp;backlog,&nbsp;so&nbsp;resort</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7746815">//&nbsp;to&nbsp;connecting&nbsp;to&nbsp;a&nbsp;hopefully-dead&nbsp;127/8&nbsp;address.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7746869">//&nbsp;Same&nbsp;for&nbsp;windows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7746892">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7746897">//&nbsp;Use&nbsp;an&nbsp;IANA&nbsp;reserved&nbsp;port&nbsp;(49151)&nbsp;instead&nbsp;of&nbsp;80,&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7746959">//&nbsp;on&nbsp;our&nbsp;386&nbsp;builder,&nbsp;this&nbsp;Dial&nbsp;succeeds,&nbsp;connecting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7747015">//&nbsp;to&nbsp;an&nbsp;IIS&nbsp;web&nbsp;server&nbsp;somewhere.&nbsp;&nbsp;The&nbsp;data&nbsp;center</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7747069">//&nbsp;or&nbsp;VM&nbsp;or&nbsp;firewall&nbsp;must&nbsp;be&nbsp;stealing&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7747129">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7747134">//&nbsp;IANA&nbsp;Service&nbsp;Name&nbsp;and&nbsp;Transport&nbsp;Protocol&nbsp;Port&nbsp;Number&nbsp;Registry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7747201">//&nbsp;&lt;http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xml&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7747298">go</span>&nbsp;<span class="keyword" id="7747301">func</span><span class="op" id="7747305">(</span><span class="op" id="7747306">)</span>&nbsp;<span class="op" id="7747308">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7747313">c</span><span class="op" id="7747314">,</span>&nbsp;<span class="ident" id="7747316">err</span>&nbsp;<span class="op" id="7747320">:=</span>&nbsp;<span class="ident" id="7747323">DialTimeout</span><span class="op" id="7747334">(</span><span class="string" id="7747335">&#34;tcp&#34;</span><span class="op" id="7747340">,</span>&nbsp;<span class="string" id="7747342">&#34;127.0.71.111:49151&#34;</span><span class="op" id="7747362">,</span>&nbsp;<span class="num" id="7747364">200</span><span class="op" id="7747367">*</span><span class="ident" id="7747368">time</span><span class="op" id="7747372">.</span><span class="ident" id="7747373">Millisecond</span><span class="op" id="7747384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7747389">if</span>&nbsp;<span class="ident" id="7747392">err</span>&nbsp;<span class="op" id="7747396">==</span>&nbsp;<span class="ident" id="7747399">nil</span>&nbsp;<span class="op" id="7747403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7747409">err</span>&nbsp;<span class="op" id="7747413">=</span>&nbsp;<span class="ident" id="7747415">fmt</span><span class="op" id="7747418">.</span><span class="ident" id="7747419">Errorf</span><span class="op" id="7747425">(</span><span class="string" id="7747426">&#34;unexpected:&nbsp;connected&nbsp;to&nbsp;%s!&#34;</span><span class="op" id="7747456">,</span>&nbsp;<span class="ident" id="7747458">c</span><span class="op" id="7747459">.</span><span class="ident" id="7747460">RemoteAddr</span><span class="op" id="7747470">(</span><span class="op" id="7747471">)</span><span class="op" id="7747472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7747478">c</span><span class="op" id="7747479">.</span><span class="ident" id="7747480">Close</span><span class="op" id="7747485">(</span><span class="op" id="7747486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7747491">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7747496">errc</span>&nbsp;<span class="op" id="7747501">&lt;-</span>&nbsp;<span class="ident" id="7747504">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7747510">}</span><span class="op" id="7747511">(</span><span class="op" id="7747512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7747515">default</span><span class="op" id="7747522">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7747526">//&nbsp;TODO(bradfitz):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7747547">//&nbsp;OpenBSD&nbsp;may&nbsp;have&nbsp;a&nbsp;reject&nbsp;route&nbsp;to&nbsp;127/8&nbsp;except&nbsp;127.0.0.1/32</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7747613">//&nbsp;by&nbsp;default.&nbsp;FreeBSD&nbsp;likely&nbsp;works,&nbsp;but&nbsp;is&nbsp;untested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7747669">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7747685">//&nbsp;The&nbsp;timeout&nbsp;never&nbsp;happens&nbsp;on&nbsp;Windows.&nbsp;&nbsp;Why?&nbsp;&nbsp;Issue&nbsp;3016.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7747747">t</span><span class="op" id="7747748">.</span><span class="ident" id="7747749">Skipf</span><span class="op" id="7747754">(</span><span class="string" id="7747755">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q;&nbsp;untested.&#34;</span><span class="op" id="7747787">,</span>&nbsp;<span class="ident" id="7747789">runtime</span><span class="op" id="7747796">.</span><span class="ident" id="7747797">GOOS</span><span class="op" id="7747801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7747804">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7747808">connected</span>&nbsp;<span class="op" id="7747818">:=</span>&nbsp;<span class="num" id="7747821">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7747824">for</span>&nbsp;<span class="op" id="7747828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7747832">select</span>&nbsp;<span class="op" id="7747839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7747843">case</span>&nbsp;<span class="op" id="7747848">&lt;-</span><span class="ident" id="7747850">time</span><span class="op" id="7747854">.</span><span class="ident" id="7747855">After</span><span class="op" id="7747860">(</span><span class="num" id="7747861">15</span>&nbsp;<span class="op" id="7747864">*</span>&nbsp;<span class="ident" id="7747866">time</span><span class="op" id="7747870">.</span><span class="ident" id="7747871">Second</span><span class="op" id="7747877">)</span><span class="op" id="7747878">:</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7747883">t</span><span class="op" id="7747884">.</span><span class="ident" id="7747885">Fatal</span><span class="op" id="7747890">(</span><span class="string" id="7747891">&#34;too&nbsp;slow&#34;</span><span class="op" id="7747901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7747905">case</span>&nbsp;<span class="ident" id="7747910">err</span>&nbsp;<span class="op" id="7747914">:=</span>&nbsp;<span class="op" id="7747917">&lt;-</span><span class="ident" id="7747919">errc</span><span class="op" id="7747923">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7747928">if</span>&nbsp;<span class="ident" id="7747931">err</span>&nbsp;<span class="op" id="7747935">==</span>&nbsp;<span class="ident" id="7747938">nil</span>&nbsp;<span class="op" id="7747942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7747948">connected</span><span class="op" id="7747957">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7747964">if</span>&nbsp;<span class="ident" id="7747967">connected</span>&nbsp;<span class="op" id="7747977">==</span>&nbsp;<span class="ident" id="7747980">numConns</span>&nbsp;<span class="op" id="7747989">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7747996">t</span><span class="op" id="7747997">.</span><span class="ident" id="7747998">Fatal</span><span class="op" id="7748003">(</span><span class="string" id="7748004">&#34;all&nbsp;connections&nbsp;connected;&nbsp;expected&nbsp;some&nbsp;to&nbsp;time&nbsp;out&#34;</span><span class="op" id="7748058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7748064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7748069">}</span>&nbsp;<span class="keyword" id="7748071">else</span>&nbsp;<span class="op" id="7748076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7748082">terr</span><span class="op" id="7748086">,</span>&nbsp;<span class="ident" id="7748088">ok</span>&nbsp;<span class="op" id="7748091">:=</span>&nbsp;<span class="ident" id="7748094">err</span><span class="op" id="7748097">.</span><span class="op" id="7748098">(</span><span class="ident" id="7748099">timeout</span><span class="op" id="7748106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7748112">if</span>&nbsp;<span class="op" id="7748115">!</span><span class="ident" id="7748116">ok</span>&nbsp;<span class="op" id="7748119">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7748126">t</span><span class="op" id="7748127">.</span><span class="ident" id="7748128">Fatalf</span><span class="op" id="7748134">(</span><span class="string" id="7748135">&#34;got&nbsp;error&nbsp;%q;&nbsp;want&nbsp;error&nbsp;with&nbsp;timeout&nbsp;interface&#34;</span><span class="op" id="7748184">,</span>&nbsp;<span class="ident" id="7748186">err</span><span class="op" id="7748189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7748195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7748201">if</span>&nbsp;<span class="op" id="7748204">!</span><span class="ident" id="7748205">terr</span><span class="op" id="7748209">.</span><span class="ident" id="7748210">Timeout</span><span class="op" id="7748217">(</span><span class="op" id="7748218">)</span>&nbsp;<span class="op" id="7748220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7748227">t</span><span class="op" id="7748228">.</span><span class="ident" id="7748229">Fatalf</span><span class="op" id="7748235">(</span><span class="string" id="7748236">&#34;got&nbsp;error&nbsp;%q;&nbsp;not&nbsp;a&nbsp;timeout&#34;</span><span class="op" id="7748265">,</span>&nbsp;<span class="ident" id="7748267">err</span><span class="op" id="7748270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7748276">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7748282">//&nbsp;Pass.&nbsp;We&nbsp;saw&nbsp;a&nbsp;timeout&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7748319">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7748329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7748333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7748336">}</span><br>
<span class="lineno">115</span><span class="op" id="7748338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7748341">func</span>&nbsp;<span class="ident" id="7748346">TestSelfConnect</span><span class="op" id="7748361">(</span><span class="ident" id="7748362">t</span>&nbsp;<span class="op" id="7748364">*</span><span class="ident" id="7748365">testing</span><span class="op" id="7748372">.</span><span class="ident" id="7748373">T</span><span class="op" id="7748374">)</span>&nbsp;<span class="op" id="7748376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7748379">if</span>&nbsp;<span class="ident" id="7748382">runtime</span><span class="op" id="7748389">.</span><span class="ident" id="7748390">GOOS</span>&nbsp;<span class="op" id="7748395">==</span>&nbsp;<span class="string" id="7748398">&#34;windows&#34;</span>&nbsp;<span class="op" id="7748408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7748412">//&nbsp;TODO(brainman):&nbsp;do&nbsp;not&nbsp;know&nbsp;why&nbsp;it&nbsp;hangs.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7748459">t</span><span class="op" id="7748460">.</span><span class="ident" id="7748461">Skip</span><span class="op" id="7748465">(</span><span class="string" id="7748466">&#34;skipping&nbsp;known-broken&nbsp;test&nbsp;on&nbsp;windows&#34;</span><span class="op" id="7748505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7748508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7748512">//&nbsp;Test&nbsp;that&nbsp;Dial&nbsp;does&nbsp;not&nbsp;honor&nbsp;self-connects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7748561">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;DialTCP.</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7748594">//&nbsp;Find&nbsp;a&nbsp;port&nbsp;that&nbsp;would&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;local&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7748649">l</span><span class="op" id="7748650">,</span>&nbsp;<span class="ident" id="7748652">err</span>&nbsp;<span class="op" id="7748656">:=</span>&nbsp;<span class="ident" id="7748659">Listen</span><span class="op" id="7748665">(</span><span class="string" id="7748666">&#34;tcp&#34;</span><span class="op" id="7748671">,</span>&nbsp;<span class="string" id="7748673">&#34;127.0.0.1:0&#34;</span><span class="op" id="7748686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7748689">if</span>&nbsp;<span class="ident" id="7748692">err</span>&nbsp;<span class="op" id="7748696">!=</span>&nbsp;<span class="ident" id="7748699">nil</span>&nbsp;<span class="op" id="7748703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7748707">t</span><span class="op" id="7748708">.</span><span class="ident" id="7748709">Fatal</span><span class="op" id="7748714">(</span><span class="ident" id="7748715">err</span><span class="op" id="7748718">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7748721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7748724">c</span><span class="op" id="7748725">,</span>&nbsp;<span class="ident" id="7748727">err</span>&nbsp;<span class="op" id="7748731">:=</span>&nbsp;<span class="ident" id="7748734">Dial</span><span class="op" id="7748738">(</span><span class="string" id="7748739">&#34;tcp&#34;</span><span class="op" id="7748744">,</span>&nbsp;<span class="ident" id="7748746">l</span><span class="op" id="7748747">.</span><span class="ident" id="7748748">Addr</span><span class="op" id="7748752">(</span><span class="op" id="7748753">)</span><span class="op" id="7748754">.</span><span class="ident" id="7748755">String</span><span class="op" id="7748761">(</span><span class="op" id="7748762">)</span><span class="op" id="7748763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7748766">if</span>&nbsp;<span class="ident" id="7748769">err</span>&nbsp;<span class="op" id="7748773">!=</span>&nbsp;<span class="ident" id="7748776">nil</span>&nbsp;<span class="op" id="7748780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7748784">t</span><span class="op" id="7748785">.</span><span class="ident" id="7748786">Fatal</span><span class="op" id="7748791">(</span><span class="ident" id="7748792">err</span><span class="op" id="7748795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7748798">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7748801">addr</span>&nbsp;<span class="op" id="7748806">:=</span>&nbsp;<span class="ident" id="7748809">c</span><span class="op" id="7748810">.</span><span class="ident" id="7748811">LocalAddr</span><span class="op" id="7748820">(</span><span class="op" id="7748821">)</span><span class="op" id="7748822">.</span><span class="ident" id="7748823">String</span><span class="op" id="7748829">(</span><span class="op" id="7748830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7748833">c</span><span class="op" id="7748834">.</span><span class="ident" id="7748835">Close</span><span class="op" id="7748840">(</span><span class="op" id="7748841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7748844">l</span><span class="op" id="7748845">.</span><span class="ident" id="7748846">Close</span><span class="op" id="7748851">(</span><span class="op" id="7748852">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7748856">//&nbsp;Try&nbsp;to&nbsp;connect&nbsp;to&nbsp;that&nbsp;address&nbsp;repeatedly.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7748903">n</span>&nbsp;<span class="op" id="7748905">:=</span>&nbsp;<span class="num" id="7748908">100000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7748916">if</span>&nbsp;<span class="ident" id="7748919">testing</span><span class="op" id="7748926">.</span><span class="ident" id="7748927">Short</span><span class="op" id="7748932">(</span><span class="op" id="7748933">)</span>&nbsp;<span class="op" id="7748935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7748939">n</span>&nbsp;<span class="op" id="7748941">=</span>&nbsp;<span class="num" id="7748943">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7748949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7748952">switch</span>&nbsp;<span class="ident" id="7748959">runtime</span><span class="op" id="7748966">.</span><span class="ident" id="7748967">GOOS</span>&nbsp;<span class="op" id="7748972">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7748975">case</span>&nbsp;<span class="string" id="7748980">&#34;darwin&#34;</span><span class="op" id="7748988">,</span>&nbsp;<span class="string" id="7748990">&#34;dragonfly&#34;</span><span class="op" id="7749001">,</span>&nbsp;<span class="string" id="7749003">&#34;freebsd&#34;</span><span class="op" id="7749012">,</span>&nbsp;<span class="string" id="7749014">&#34;netbsd&#34;</span><span class="op" id="7749022">,</span>&nbsp;<span class="string" id="7749024">&#34;openbsd&#34;</span><span class="op" id="7749033">,</span>&nbsp;<span class="string" id="7749035">&#34;plan9&#34;</span><span class="op" id="7749042">,</span>&nbsp;<span class="string" id="7749044">&#34;solaris&#34;</span><span class="op" id="7749053">,</span>&nbsp;<span class="string" id="7749055">&#34;windows&#34;</span><span class="op" id="7749064">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7749068">//&nbsp;Non-Linux&nbsp;systems&nbsp;take&nbsp;a&nbsp;long&nbsp;time&nbsp;to&nbsp;figure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7749118">//&nbsp;out&nbsp;that&nbsp;there&nbsp;is&nbsp;nothing&nbsp;listening&nbsp;on&nbsp;localhost.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7749173">n</span>&nbsp;<span class="op" id="7749175">=</span>&nbsp;<span class="num" id="7749177">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7749182">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7749185">for</span>&nbsp;<span class="ident" id="7749189">i</span>&nbsp;<span class="op" id="7749191">:=</span>&nbsp;<span class="num" id="7749194">0</span><span class="op" id="7749195">;</span>&nbsp;<span class="ident" id="7749197">i</span>&nbsp;<span class="op" id="7749199">&lt;</span>&nbsp;<span class="ident" id="7749201">n</span><span class="op" id="7749202">;</span>&nbsp;<span class="ident" id="7749204">i</span><span class="op" id="7749205">++</span>&nbsp;<span class="op" id="7749208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7749212">c</span><span class="op" id="7749213">,</span>&nbsp;<span class="ident" id="7749215">err</span>&nbsp;<span class="op" id="7749219">:=</span>&nbsp;<span class="ident" id="7749222">DialTimeout</span><span class="op" id="7749233">(</span><span class="string" id="7749234">&#34;tcp&#34;</span><span class="op" id="7749239">,</span>&nbsp;<span class="ident" id="7749241">addr</span><span class="op" id="7749245">,</span>&nbsp;<span class="ident" id="7749247">time</span><span class="op" id="7749251">.</span><span class="ident" id="7749252">Millisecond</span><span class="op" id="7749263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7749267">if</span>&nbsp;<span class="ident" id="7749270">err</span>&nbsp;<span class="op" id="7749274">==</span>&nbsp;<span class="ident" id="7749277">nil</span>&nbsp;<span class="op" id="7749281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7749286">if</span>&nbsp;<span class="ident" id="7749289">c</span><span class="op" id="7749290">.</span><span class="ident" id="7749291">LocalAddr</span><span class="op" id="7749300">(</span><span class="op" id="7749301">)</span><span class="op" id="7749302">.</span><span class="ident" id="7749303">String</span><span class="op" id="7749309">(</span><span class="op" id="7749310">)</span>&nbsp;<span class="op" id="7749312">==</span>&nbsp;<span class="ident" id="7749315">addr</span>&nbsp;<span class="op" id="7749320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7749326">t</span><span class="op" id="7749327">.</span><span class="ident" id="7749328">Errorf</span><span class="op" id="7749334">(</span><span class="string" id="7749335">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;self-connect&#34;</span><span class="op" id="7749362">,</span>&nbsp;<span class="ident" id="7749364">i</span><span class="op" id="7749365">,</span>&nbsp;<span class="ident" id="7749367">addr</span><span class="op" id="7749371">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7749376">}</span>&nbsp;<span class="keyword" id="7749378">else</span>&nbsp;<span class="op" id="7749383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7749389">t</span><span class="op" id="7749390">.</span><span class="ident" id="7749391">Logf</span><span class="op" id="7749395">(</span><span class="string" id="7749396">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;succeeded&nbsp;-&nbsp;possibly&nbsp;racing&nbsp;with&nbsp;other&nbsp;listener&#34;</span><span class="op" id="7749458">,</span>&nbsp;<span class="ident" id="7749460">i</span><span class="op" id="7749461">,</span>&nbsp;<span class="ident" id="7749463">addr</span><span class="op" id="7749467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7749472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7749477">c</span><span class="op" id="7749478">.</span><span class="ident" id="7749479">Close</span><span class="op" id="7749484">(</span><span class="op" id="7749485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7749489">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7749492">}</span><br>
<span class="lineno"></span><span class="op" id="7749494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7749497">var</span>&nbsp;<span class="ident" id="7749501">runErrorTest</span>&nbsp;<span class="op" id="7749514">=</span>&nbsp;<span class="ident" id="7749516">flag</span><span class="op" id="7749520">.</span><span class="ident" id="7749521">Bool</span><span class="op" id="7749525">(</span><span class="string" id="7749526">&#34;run_error_test&#34;</span><span class="op" id="7749542">,</span>&nbsp;<span class="builtintype" id="7749544">false</span><span class="op" id="7749549">,</span>&nbsp;<span class="string" id="7749551">&#34;let&nbsp;TestDialError&nbsp;check&nbsp;for&nbsp;dns&nbsp;errors&#34;</span><span class="op" id="7749591">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7749594">type</span>&nbsp;<span class="ident" id="7749599">DialErrorTest</span>&nbsp;<span class="keyword" id="7749613">struct</span>&nbsp;<span class="op" id="7749620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7749623">Net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7749631">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7749639">Raddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7749647">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7749655">Pattern</span>&nbsp;<span class="builtintype" id="7749663">string</span><br>
<span class="lineno"></span><span class="op" id="7749670">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="7749673">var</span>&nbsp;<span class="ident" id="7749677">dialErrorTests</span>&nbsp;<span class="op" id="7749692">=</span>&nbsp;<span class="op" id="7749694">[</span><span class="op" id="7749695">]</span><span class="ident" id="7749696">DialErrorTest</span><span class="op" id="7749709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7749712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7749716">&#34;datakit&#34;</span><span class="op" id="7749725">,</span>&nbsp;<span class="string" id="7749727">&#34;mh/astro/r70&#34;</span><span class="op" id="7749741">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7749745">&#34;dial&nbsp;datakit&nbsp;mh/astro/r70:&nbsp;unknown&nbsp;network&nbsp;datakit&#34;</span><span class="op" id="7749797">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7749800">}</span><span class="op" id="7749801">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7749804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7749808">&#34;tcp&#34;</span><span class="op" id="7749813">,</span>&nbsp;<span class="string" id="7749815">&#34;127.0.0.1:☺&#34;</span><span class="op" id="7749830">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7749834">&#34;dial&nbsp;tcp&nbsp;127.0.0.1:☺:&nbsp;unknown&nbsp;port&nbsp;tcp/☺&#34;</span><span class="op" id="7749880">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7749883">}</span><span class="op" id="7749884">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7749887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7749891">&#34;tcp&#34;</span><span class="op" id="7749896">,</span>&nbsp;<span class="string" id="7749898">&#34;no-such-name.google.com.:80&#34;</span><span class="op" id="7749927">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7749931">&#34;dial&nbsp;tcp&nbsp;no-such-name.google.com.:80:&nbsp;lookup&nbsp;no-such-name.google.com.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="7750020">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7750023">}</span><span class="op" id="7750024">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7750027">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7750031">&#34;tcp&#34;</span><span class="op" id="7750036">,</span>&nbsp;<span class="string" id="7750038">&#34;no-such-name.no-such-top-level-domain.:80&#34;</span><span class="op" id="7750081">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7750085">&#34;dial&nbsp;tcp&nbsp;no-such-name.no-such-top-level-domain.:80:&nbsp;lookup&nbsp;no-such-name.no-such-top-level-domain.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="7750202">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7750205">}</span><span class="op" id="7750206">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7750209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7750213">&#34;tcp&#34;</span><span class="op" id="7750218">,</span>&nbsp;<span class="string" id="7750220">&#34;no-such-name:80&#34;</span><span class="op" id="7750237">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7750241">`dial&nbsp;tcp&nbsp;no-such-name:80:&nbsp;lookup&nbsp;no-such-name\.(.*\.)?(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)`</span><span class="op" id="7750315">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7750318">}</span><span class="op" id="7750319">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7750322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7750326">&#34;tcp&#34;</span><span class="op" id="7750331">,</span>&nbsp;<span class="string" id="7750333">&#34;mh/astro/r70:http&#34;</span><span class="op" id="7750352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7750356">&#34;dial&nbsp;tcp&nbsp;mh/astro/r70:http:&nbsp;lookup&nbsp;mh/astro/r70:&nbsp;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="7750426">,</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7750429">}</span><span class="op" id="7750430">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7750433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7750437">&#34;unix&#34;</span><span class="op" id="7750443">,</span>&nbsp;<span class="string" id="7750445">&#34;/etc/file-not-found&#34;</span><span class="op" id="7750466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7750470">&#34;dial&nbsp;unix&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="7750528">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7750531">}</span><span class="op" id="7750532">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7750535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7750539">&#34;unix&#34;</span><span class="op" id="7750545">,</span>&nbsp;<span class="string" id="7750547">&#34;/etc/&#34;</span><span class="op" id="7750554">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7750558">&#34;dial&nbsp;unix&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="7750646">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7750649">}</span><span class="op" id="7750650">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7750653">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7750657">&#34;unixpacket&#34;</span><span class="op" id="7750669">,</span>&nbsp;<span class="string" id="7750671">&#34;/etc/file-not-found&#34;</span><span class="op" id="7750692">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7750696">&#34;dial&nbsp;unixpacket&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="7750760">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7750763">}</span><span class="op" id="7750764">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7750767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7750771">&#34;unixpacket&#34;</span><span class="op" id="7750783">,</span>&nbsp;<span class="string" id="7750785">&#34;/etc/&#34;</span><span class="op" id="7750792">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7750796">&#34;dial&nbsp;unixpacket&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="7750890">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7750893">}</span><span class="op" id="7750894">,</span><br>
<span class="lineno"></span><span class="op" id="7750896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7750899">var</span>&nbsp;<span class="ident" id="7750903">duplicateErrorPattern</span>&nbsp;<span class="op" id="7750925">=</span>&nbsp;<span class="string" id="7750927">`dial&nbsp;(.*)&nbsp;dial&nbsp;(.*)`</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="7750950">func</span>&nbsp;<span class="ident" id="7750955">TestDialError</span><span class="op" id="7750968">(</span><span class="ident" id="7750969">t</span>&nbsp;<span class="op" id="7750971">*</span><span class="ident" id="7750972">testing</span><span class="op" id="7750979">.</span><span class="ident" id="7750980">T</span><span class="op" id="7750981">)</span>&nbsp;<span class="op" id="7750983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7750986">if</span>&nbsp;<span class="op" id="7750989">!</span><span class="op" id="7750990">*</span><span class="ident" id="7750991">runErrorTest</span>&nbsp;<span class="op" id="7751004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7751008">t</span><span class="op" id="7751009">.</span><span class="ident" id="7751010">Logf</span><span class="op" id="7751014">(</span><span class="string" id="7751015">&#34;test&nbsp;disabled;&nbsp;use&nbsp;-run_error_test&nbsp;to&nbsp;enable&#34;</span><span class="op" id="7751061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7751065">return</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7751073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7751076">for</span>&nbsp;<span class="ident" id="7751080">i</span><span class="op" id="7751081">,</span>&nbsp;<span class="ident" id="7751083">tt</span>&nbsp;<span class="op" id="7751086">:=</span>&nbsp;<span class="keyword" id="7751089">range</span>&nbsp;<span class="ident" id="7751095">dialErrorTests</span>&nbsp;<span class="op" id="7751110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7751114">c</span><span class="op" id="7751115">,</span>&nbsp;<span class="ident" id="7751117">err</span>&nbsp;<span class="op" id="7751121">:=</span>&nbsp;<span class="ident" id="7751124">Dial</span><span class="op" id="7751128">(</span><span class="ident" id="7751129">tt</span><span class="op" id="7751131">.</span><span class="ident" id="7751132">Net</span><span class="op" id="7751135">,</span>&nbsp;<span class="ident" id="7751137">tt</span><span class="op" id="7751139">.</span><span class="ident" id="7751140">Raddr</span><span class="op" id="7751145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7751149">if</span>&nbsp;<span class="ident" id="7751152">c</span>&nbsp;<span class="op" id="7751154">!=</span>&nbsp;<span class="ident" id="7751157">nil</span>&nbsp;<span class="op" id="7751161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7751166">c</span><span class="op" id="7751167">.</span><span class="ident" id="7751168">Close</span><span class="op" id="7751173">(</span><span class="op" id="7751174">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7751178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7751182">if</span>&nbsp;<span class="ident" id="7751185">err</span>&nbsp;<span class="op" id="7751189">==</span>&nbsp;<span class="ident" id="7751192">nil</span>&nbsp;<span class="op" id="7751196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7751201">t</span><span class="op" id="7751202">.</span><span class="ident" id="7751203">Errorf</span><span class="op" id="7751209">(</span><span class="string" id="7751210">&#34;#%d:&nbsp;nil&nbsp;error,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="7751246">,</span>&nbsp;<span class="ident" id="7751248">i</span><span class="op" id="7751249">,</span>&nbsp;<span class="ident" id="7751251">tt</span><span class="op" id="7751253">.</span><span class="ident" id="7751254">Pattern</span><span class="op" id="7751261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7751266">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7751277">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7751281">s</span>&nbsp;<span class="op" id="7751283">:=</span>&nbsp;<span class="ident" id="7751286">err</span><span class="op" id="7751289">.</span><span class="ident" id="7751290">Error</span><span class="op" id="7751295">(</span><span class="op" id="7751296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7751300">match</span><span class="op" id="7751305">,</span>&nbsp;<span class="ident" id="7751307">_</span>&nbsp;<span class="op" id="7751309">:=</span>&nbsp;<span class="ident" id="7751312">regexp</span><span class="op" id="7751318">.</span><span class="ident" id="7751319">MatchString</span><span class="op" id="7751330">(</span><span class="ident" id="7751331">tt</span><span class="op" id="7751333">.</span><span class="ident" id="7751334">Pattern</span><span class="op" id="7751341">,</span>&nbsp;<span class="ident" id="7751343">s</span><span class="op" id="7751344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7751348">if</span>&nbsp;<span class="op" id="7751351">!</span><span class="ident" id="7751352">match</span>&nbsp;<span class="op" id="7751358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7751363">t</span><span class="op" id="7751364">.</span><span class="ident" id="7751365">Errorf</span><span class="op" id="7751371">(</span><span class="string" id="7751372">&#34;#%d:&nbsp;%q,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="7751401">,</span>&nbsp;<span class="ident" id="7751403">i</span><span class="op" id="7751404">,</span>&nbsp;<span class="ident" id="7751406">s</span><span class="op" id="7751407">,</span>&nbsp;<span class="ident" id="7751409">tt</span><span class="op" id="7751411">.</span><span class="ident" id="7751412">Pattern</span><span class="op" id="7751419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7751423">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7751427">match</span><span class="op" id="7751432">,</span>&nbsp;<span class="ident" id="7751434">_</span>&nbsp;<span class="op" id="7751436">=</span>&nbsp;<span class="ident" id="7751438">regexp</span><span class="op" id="7751444">.</span><span class="ident" id="7751445">MatchString</span><span class="op" id="7751456">(</span><span class="ident" id="7751457">duplicateErrorPattern</span><span class="op" id="7751478">,</span>&nbsp;<span class="ident" id="7751480">s</span><span class="op" id="7751481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7751485">if</span>&nbsp;<span class="ident" id="7751488">match</span>&nbsp;<span class="op" id="7751494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7751499">t</span><span class="op" id="7751500">.</span><span class="ident" id="7751501">Errorf</span><span class="op" id="7751507">(</span><span class="string" id="7751508">&#34;#%d:&nbsp;%q,&nbsp;duplicate&nbsp;error&nbsp;return&nbsp;from&nbsp;Dial&#34;</span><span class="op" id="7751551">,</span>&nbsp;<span class="ident" id="7751553">i</span><span class="op" id="7751554">,</span>&nbsp;<span class="ident" id="7751556">s</span><span class="op" id="7751557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7751561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7751564">}</span><br>
<span class="lineno">240</span><span class="op" id="7751566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7751569">var</span>&nbsp;<span class="ident" id="7751573">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="7751602">=</span>&nbsp;<span class="op" id="7751604">[</span><span class="op" id="7751605">]</span><span class="keyword" id="7751606">struct</span>&nbsp;<span class="op" id="7751613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7751616">net</span>&nbsp;&nbsp;<span class="builtintype" id="7751621">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7751629">addr</span>&nbsp;<span class="builtintype" id="7751634">string</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7751642">err</span>&nbsp;&nbsp;<span class="builtintype" id="7751647">error</span><br>
<span class="lineno"></span><span class="op" id="7751653">}</span><span class="op" id="7751654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7751657">{</span><span class="string" id="7751658">&#34;foo&#34;</span><span class="op" id="7751663">,</span>&nbsp;<span class="string" id="7751665">&#34;bar&#34;</span><span class="op" id="7751670">,</span>&nbsp;<span class="op" id="7751672">&amp;</span><span class="ident" id="7751673">OpError</span><span class="op" id="7751680">{</span><span class="ident" id="7751681">Op</span><span class="op" id="7751683">:</span>&nbsp;<span class="string" id="7751685">&#34;dial&#34;</span><span class="op" id="7751691">,</span>&nbsp;<span class="ident" id="7751693">Net</span><span class="op" id="7751696">:</span>&nbsp;<span class="string" id="7751698">&#34;foo&#34;</span><span class="op" id="7751703">,</span>&nbsp;<span class="ident" id="7751705">Addr</span><span class="op" id="7751709">:</span>&nbsp;<span class="ident" id="7751711">nil</span><span class="op" id="7751714">,</span>&nbsp;<span class="ident" id="7751716">Err</span><span class="op" id="7751719">:</span>&nbsp;<span class="ident" id="7751721">UnknownNetworkError</span><span class="op" id="7751740">(</span><span class="string" id="7751741">&#34;foo&#34;</span><span class="op" id="7751746">)</span><span class="op" id="7751747">}</span><span class="op" id="7751748">}</span><span class="op" id="7751749">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7751752">{</span><span class="string" id="7751753">&#34;baz&#34;</span><span class="op" id="7751758">,</span>&nbsp;<span class="string" id="7751760">&#34;&#34;</span><span class="op" id="7751762">,</span>&nbsp;<span class="op" id="7751764">&amp;</span><span class="ident" id="7751765">OpError</span><span class="op" id="7751772">{</span><span class="ident" id="7751773">Op</span><span class="op" id="7751775">:</span>&nbsp;<span class="string" id="7751777">&#34;listen&#34;</span><span class="op" id="7751785">,</span>&nbsp;<span class="ident" id="7751787">Net</span><span class="op" id="7751790">:</span>&nbsp;<span class="string" id="7751792">&#34;baz&#34;</span><span class="op" id="7751797">,</span>&nbsp;<span class="ident" id="7751799">Addr</span><span class="op" id="7751803">:</span>&nbsp;<span class="ident" id="7751805">nil</span><span class="op" id="7751808">,</span>&nbsp;<span class="ident" id="7751810">Err</span><span class="op" id="7751813">:</span>&nbsp;<span class="ident" id="7751815">UnknownNetworkError</span><span class="op" id="7751834">(</span><span class="string" id="7751835">&#34;baz&#34;</span><span class="op" id="7751840">)</span><span class="op" id="7751841">}</span><span class="op" id="7751842">}</span><span class="op" id="7751843">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7751846">{</span><span class="string" id="7751847">&#34;tcp&#34;</span><span class="op" id="7751852">,</span>&nbsp;<span class="string" id="7751854">&#34;&#34;</span><span class="op" id="7751856">,</span>&nbsp;<span class="op" id="7751858">&amp;</span><span class="ident" id="7751859">OpError</span><span class="op" id="7751866">{</span><span class="ident" id="7751867">Op</span><span class="op" id="7751869">:</span>&nbsp;<span class="string" id="7751871">&#34;dial&#34;</span><span class="op" id="7751877">,</span>&nbsp;<span class="ident" id="7751879">Net</span><span class="op" id="7751882">:</span>&nbsp;<span class="string" id="7751884">&#34;tcp&#34;</span><span class="op" id="7751889">,</span>&nbsp;<span class="ident" id="7751891">Addr</span><span class="op" id="7751895">:</span>&nbsp;<span class="ident" id="7751897">nil</span><span class="op" id="7751900">,</span>&nbsp;<span class="ident" id="7751902">Err</span><span class="op" id="7751905">:</span>&nbsp;<span class="ident" id="7751907">errMissingAddress</span><span class="op" id="7751924">}</span><span class="op" id="7751925">}</span><span class="op" id="7751926">,</span><br>
<span class="lineno">250</span><span class="op" id="7751928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7751931">func</span>&nbsp;<span class="ident" id="7751936">TestInvalidDialAndListenArgs</span><span class="op" id="7751964">(</span><span class="ident" id="7751965">t</span>&nbsp;<span class="op" id="7751967">*</span><span class="ident" id="7751968">testing</span><span class="op" id="7751975">.</span><span class="ident" id="7751976">T</span><span class="op" id="7751977">)</span>&nbsp;<span class="op" id="7751979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7751982">for</span>&nbsp;<span class="ident" id="7751986">_</span><span class="op" id="7751987">,</span>&nbsp;<span class="ident" id="7751989">tt</span>&nbsp;<span class="op" id="7751992">:=</span>&nbsp;<span class="keyword" id="7751995">range</span>&nbsp;<span class="ident" id="7752001">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="7752030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7752034">var</span>&nbsp;<span class="ident" id="7752038">err</span>&nbsp;<span class="builtintype" id="7752042">error</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7752050">switch</span>&nbsp;<span class="ident" id="7752057">tt</span><span class="op" id="7752059">.</span><span class="ident" id="7752060">err</span><span class="op" id="7752063">.</span><span class="op" id="7752064">(</span><span class="op" id="7752065">*</span><span class="ident" id="7752066">OpError</span><span class="op" id="7752073">)</span><span class="op" id="7752074">.</span><span class="ident" id="7752075">Op</span>&nbsp;<span class="op" id="7752078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7752082">case</span>&nbsp;<span class="string" id="7752087">&#34;dial&#34;</span><span class="op" id="7752093">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7752098">_</span><span class="op" id="7752099">,</span>&nbsp;<span class="ident" id="7752101">err</span>&nbsp;<span class="op" id="7752105">=</span>&nbsp;<span class="ident" id="7752107">Dial</span><span class="op" id="7752111">(</span><span class="ident" id="7752112">tt</span><span class="op" id="7752114">.</span><span class="ident" id="7752115">net</span><span class="op" id="7752118">,</span>&nbsp;<span class="ident" id="7752120">tt</span><span class="op" id="7752122">.</span><span class="ident" id="7752123">addr</span><span class="op" id="7752127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7752131">case</span>&nbsp;<span class="string" id="7752136">&#34;listen&#34;</span><span class="op" id="7752144">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7752149">_</span><span class="op" id="7752150">,</span>&nbsp;<span class="ident" id="7752152">err</span>&nbsp;<span class="op" id="7752156">=</span>&nbsp;<span class="ident" id="7752158">Listen</span><span class="op" id="7752164">(</span><span class="ident" id="7752165">tt</span><span class="op" id="7752167">.</span><span class="ident" id="7752168">net</span><span class="op" id="7752171">,</span>&nbsp;<span class="ident" id="7752173">tt</span><span class="op" id="7752175">.</span><span class="ident" id="7752176">addr</span><span class="op" id="7752180">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7752184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7752188">if</span>&nbsp;<span class="op" id="7752191">!</span><span class="ident" id="7752192">reflect</span><span class="op" id="7752199">.</span><span class="ident" id="7752200">DeepEqual</span><span class="op" id="7752209">(</span><span class="ident" id="7752210">tt</span><span class="op" id="7752212">.</span><span class="ident" id="7752213">err</span><span class="op" id="7752216">,</span>&nbsp;<span class="ident" id="7752218">err</span><span class="op" id="7752221">)</span>&nbsp;<span class="op" id="7752223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7752228">t</span><span class="op" id="7752229">.</span><span class="ident" id="7752230">Fatalf</span><span class="op" id="7752236">(</span><span class="string" id="7752237">&#34;got&nbsp;%#v;&nbsp;expected&nbsp;%#v&#34;</span><span class="op" id="7752260">,</span>&nbsp;<span class="ident" id="7752262">err</span><span class="op" id="7752265">,</span>&nbsp;<span class="ident" id="7752267">tt</span><span class="op" id="7752269">.</span><span class="ident" id="7752270">err</span><span class="op" id="7752273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7752277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7752280">}</span><br>
<span class="lineno">265</span><span class="op" id="7752282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7752285">func</span>&nbsp;<span class="ident" id="7752290">TestDialTimeoutFDLeak</span><span class="op" id="7752311">(</span><span class="ident" id="7752312">t</span>&nbsp;<span class="op" id="7752314">*</span><span class="ident" id="7752315">testing</span><span class="op" id="7752322">.</span><span class="ident" id="7752323">T</span><span class="op" id="7752324">)</span>&nbsp;<span class="op" id="7752326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7752329">if</span>&nbsp;<span class="ident" id="7752332">runtime</span><span class="op" id="7752339">.</span><span class="ident" id="7752340">GOOS</span>&nbsp;<span class="op" id="7752345">!=</span>&nbsp;<span class="string" id="7752348">&#34;linux&#34;</span>&nbsp;<span class="op" id="7752356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7752360">//&nbsp;TODO(bradfitz):&nbsp;test&nbsp;on&nbsp;other&nbsp;platforms</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7752405">t</span><span class="op" id="7752406">.</span><span class="ident" id="7752407">Skipf</span><span class="op" id="7752412">(</span><span class="string" id="7752413">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7752434">,</span>&nbsp;<span class="ident" id="7752436">runtime</span><span class="op" id="7752443">.</span><span class="ident" id="7752444">GOOS</span><span class="op" id="7752448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7752451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7752455">ln</span>&nbsp;<span class="op" id="7752458">:=</span>&nbsp;<span class="ident" id="7752461">newLocalListener</span><span class="op" id="7752477">(</span><span class="ident" id="7752478">t</span><span class="op" id="7752479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7752482">defer</span>&nbsp;<span class="ident" id="7752488">ln</span><span class="op" id="7752490">.</span><span class="ident" id="7752491">Close</span><span class="op" id="7752496">(</span><span class="op" id="7752497">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7752501">type</span>&nbsp;<span class="ident" id="7752506">connErr</span>&nbsp;<span class="keyword" id="7752514">struct</span>&nbsp;<span class="op" id="7752521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7752525">conn</span>&nbsp;<span class="ident" id="7752530">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7752537">err</span>&nbsp;&nbsp;<span class="builtintype" id="7752542">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7752549">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7752552">dials</span>&nbsp;<span class="op" id="7752558">:=</span>&nbsp;<span class="ident" id="7752561">listenerBacklog</span>&nbsp;<span class="op" id="7752577">+</span>&nbsp;<span class="num" id="7752579">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7752584">//&nbsp;used&nbsp;to&nbsp;be&nbsp;listenerBacklog&nbsp;+&nbsp;5,&nbsp;but&nbsp;was&nbsp;found&nbsp;to&nbsp;be&nbsp;unreliable,&nbsp;issue&nbsp;4384.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7752664">maxGoodConnect</span>&nbsp;<span class="op" id="7752679">:=</span>&nbsp;<span class="ident" id="7752682">listenerBacklog</span>&nbsp;<span class="op" id="7752698">+</span>&nbsp;<span class="ident" id="7752700">runtime</span><span class="op" id="7752707">.</span><span class="ident" id="7752708">NumCPU</span><span class="op" id="7752714">(</span><span class="op" id="7752715">)</span><span class="op" id="7752716">*</span><span class="num" id="7752717">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7752721">resc</span>&nbsp;<span class="op" id="7752726">:=</span>&nbsp;<span class="builtinfunc" id="7752729">make</span><span class="op" id="7752733">(</span><span class="keyword" id="7752734">chan</span>&nbsp;<span class="ident" id="7752739">connErr</span><span class="op" id="7752746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7752749">for</span>&nbsp;<span class="ident" id="7752753">i</span>&nbsp;<span class="op" id="7752755">:=</span>&nbsp;<span class="num" id="7752758">0</span><span class="op" id="7752759">;</span>&nbsp;<span class="ident" id="7752761">i</span>&nbsp;<span class="op" id="7752763">&lt;</span>&nbsp;<span class="ident" id="7752765">dials</span><span class="op" id="7752770">;</span>&nbsp;<span class="ident" id="7752772">i</span><span class="op" id="7752773">++</span>&nbsp;<span class="op" id="7752776">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7752780">go</span>&nbsp;<span class="keyword" id="7752783">func</span><span class="op" id="7752787">(</span><span class="op" id="7752788">)</span>&nbsp;<span class="op" id="7752790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7752795">conn</span><span class="op" id="7752799">,</span>&nbsp;<span class="ident" id="7752801">err</span>&nbsp;<span class="op" id="7752805">:=</span>&nbsp;<span class="ident" id="7752808">DialTimeout</span><span class="op" id="7752819">(</span><span class="string" id="7752820">&#34;tcp&#34;</span><span class="op" id="7752825">,</span>&nbsp;<span class="ident" id="7752827">ln</span><span class="op" id="7752829">.</span><span class="ident" id="7752830">Addr</span><span class="op" id="7752834">(</span><span class="op" id="7752835">)</span><span class="op" id="7752836">.</span><span class="ident" id="7752837">String</span><span class="op" id="7752843">(</span><span class="op" id="7752844">)</span><span class="op" id="7752845">,</span>&nbsp;<span class="num" id="7752847">500</span><span class="op" id="7752850">*</span><span class="ident" id="7752851">time</span><span class="op" id="7752855">.</span><span class="ident" id="7752856">Millisecond</span><span class="op" id="7752867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7752872">resc</span>&nbsp;<span class="op" id="7752877">&lt;-</span>&nbsp;<span class="ident" id="7752880">connErr</span><span class="op" id="7752887">{</span><span class="ident" id="7752888">conn</span><span class="op" id="7752892">,</span>&nbsp;<span class="ident" id="7752894">err</span><span class="op" id="7752897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7752901">}</span><span class="op" id="7752902">(</span><span class="op" id="7752903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7752906">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7752910">var</span>&nbsp;<span class="ident" id="7752914">firstErr</span>&nbsp;<span class="builtintype" id="7752923">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7752931">var</span>&nbsp;<span class="ident" id="7752935">ngood</span>&nbsp;<span class="builtintype" id="7752941">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7752946">var</span>&nbsp;<span class="ident" id="7752950">toClose</span>&nbsp;<span class="op" id="7752958">[</span><span class="op" id="7752959">]</span><span class="ident" id="7752960">io</span><span class="op" id="7752962">.</span><span class="ident" id="7752963">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7752971">for</span>&nbsp;<span class="ident" id="7752975">i</span>&nbsp;<span class="op" id="7752977">:=</span>&nbsp;<span class="num" id="7752980">0</span><span class="op" id="7752981">;</span>&nbsp;<span class="ident" id="7752983">i</span>&nbsp;<span class="op" id="7752985">&lt;</span>&nbsp;<span class="ident" id="7752987">dials</span><span class="op" id="7752992">;</span>&nbsp;<span class="ident" id="7752994">i</span><span class="op" id="7752995">++</span>&nbsp;<span class="op" id="7752998">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7753002">ce</span>&nbsp;<span class="op" id="7753005">:=</span>&nbsp;<span class="op" id="7753008">&lt;-</span><span class="ident" id="7753010">resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7753017">if</span>&nbsp;<span class="ident" id="7753020">ce</span><span class="op" id="7753022">.</span><span class="ident" id="7753023">err</span>&nbsp;<span class="op" id="7753027">==</span>&nbsp;<span class="ident" id="7753030">nil</span>&nbsp;<span class="op" id="7753034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7753039">ngood</span><span class="op" id="7753044">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7753050">if</span>&nbsp;<span class="ident" id="7753053">ngood</span>&nbsp;<span class="op" id="7753059">&gt;</span>&nbsp;<span class="ident" id="7753061">maxGoodConnect</span>&nbsp;<span class="op" id="7753076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7753082">t</span><span class="op" id="7753083">.</span><span class="ident" id="7753084">Errorf</span><span class="op" id="7753090">(</span><span class="string" id="7753091">&#34;%d&nbsp;good&nbsp;connects;&nbsp;expected&nbsp;at&nbsp;most&nbsp;%d&#34;</span><span class="op" id="7753130">,</span>&nbsp;<span class="ident" id="7753132">ngood</span><span class="op" id="7753137">,</span>&nbsp;<span class="ident" id="7753139">maxGoodConnect</span><span class="op" id="7753153">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7753158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7753163">toClose</span>&nbsp;<span class="op" id="7753171">=</span>&nbsp;<span class="builtinfunc" id="7753173">append</span><span class="op" id="7753179">(</span><span class="ident" id="7753180">toClose</span><span class="op" id="7753187">,</span>&nbsp;<span class="ident" id="7753189">ce</span><span class="op" id="7753191">.</span><span class="ident" id="7753192">conn</span><span class="op" id="7753196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7753201">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7753212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7753216">err</span>&nbsp;<span class="op" id="7753220">:=</span>&nbsp;<span class="ident" id="7753223">ce</span><span class="op" id="7753225">.</span><span class="ident" id="7753226">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7753232">if</span>&nbsp;<span class="ident" id="7753235">firstErr</span>&nbsp;<span class="op" id="7753244">==</span>&nbsp;<span class="string" id="7753247">&#34;&#34;</span>&nbsp;<span class="op" id="7753250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7753255">firstErr</span>&nbsp;<span class="op" id="7753264">=</span>&nbsp;<span class="ident" id="7753266">err</span><span class="op" id="7753269">.</span><span class="ident" id="7753270">Error</span><span class="op" id="7753275">(</span><span class="op" id="7753276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7753280">}</span>&nbsp;<span class="keyword" id="7753282">else</span>&nbsp;<span class="keyword" id="7753287">if</span>&nbsp;<span class="ident" id="7753290">err</span><span class="op" id="7753293">.</span><span class="ident" id="7753294">Error</span><span class="op" id="7753299">(</span><span class="op" id="7753300">)</span>&nbsp;<span class="op" id="7753302">!=</span>&nbsp;<span class="ident" id="7753305">firstErr</span>&nbsp;<span class="op" id="7753314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7753319">t</span><span class="op" id="7753320">.</span><span class="ident" id="7753321">Fatalf</span><span class="op" id="7753327">(</span><span class="string" id="7753328">&#34;inconsistent&nbsp;error&nbsp;messages:&nbsp;first&nbsp;was&nbsp;%q,&nbsp;then&nbsp;later&nbsp;%q&#34;</span><span class="op" id="7753386">,</span>&nbsp;<span class="ident" id="7753388">firstErr</span><span class="op" id="7753396">,</span>&nbsp;<span class="ident" id="7753398">err</span><span class="op" id="7753401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7753405">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7753408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7753411">for</span>&nbsp;<span class="ident" id="7753415">_</span><span class="op" id="7753416">,</span>&nbsp;<span class="ident" id="7753418">c</span>&nbsp;<span class="op" id="7753420">:=</span>&nbsp;<span class="keyword" id="7753423">range</span>&nbsp;<span class="ident" id="7753429">toClose</span>&nbsp;<span class="op" id="7753437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7753441">c</span><span class="op" id="7753442">.</span><span class="ident" id="7753443">Close</span><span class="op" id="7753448">(</span><span class="op" id="7753449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7753452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7753455">for</span>&nbsp;<span class="ident" id="7753459">i</span>&nbsp;<span class="op" id="7753461">:=</span>&nbsp;<span class="num" id="7753464">0</span><span class="op" id="7753465">;</span>&nbsp;<span class="ident" id="7753467">i</span>&nbsp;<span class="op" id="7753469">&lt;</span>&nbsp;<span class="num" id="7753471">100</span><span class="op" id="7753474">;</span>&nbsp;<span class="ident" id="7753476">i</span><span class="op" id="7753477">++</span>&nbsp;<span class="op" id="7753480">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7753484">if</span>&nbsp;<span class="ident" id="7753487">got</span>&nbsp;<span class="op" id="7753491">:=</span>&nbsp;<span class="ident" id="7753494">numFD</span><span class="op" id="7753499">(</span><span class="op" id="7753500">)</span><span class="op" id="7753501">;</span>&nbsp;<span class="ident" id="7753503">got</span>&nbsp;<span class="op" id="7753507">&lt;</span>&nbsp;<span class="ident" id="7753509">dials</span>&nbsp;<span class="op" id="7753515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7753520">//&nbsp;Test&nbsp;passes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7753539">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7753548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7753552">time</span><span class="op" id="7753556">.</span><span class="ident" id="7753557">Sleep</span><span class="op" id="7753562">(</span><span class="num" id="7753563">10</span>&nbsp;<span class="op" id="7753566">*</span>&nbsp;<span class="ident" id="7753568">time</span><span class="op" id="7753572">.</span><span class="ident" id="7753573">Millisecond</span><span class="op" id="7753584">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7753587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7753590">if</span>&nbsp;<span class="ident" id="7753593">got</span>&nbsp;<span class="op" id="7753597">:=</span>&nbsp;<span class="ident" id="7753600">numFD</span><span class="op" id="7753605">(</span><span class="op" id="7753606">)</span><span class="op" id="7753607">;</span>&nbsp;<span class="ident" id="7753609">got</span>&nbsp;<span class="op" id="7753613">&gt;=</span>&nbsp;<span class="ident" id="7753616">dials</span>&nbsp;<span class="op" id="7753622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7753626">t</span><span class="op" id="7753627">.</span><span class="ident" id="7753628">Errorf</span><span class="op" id="7753634">(</span><span class="string" id="7753635">&#34;num&nbsp;fds&nbsp;after&nbsp;%d&nbsp;timeouts&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;%d&#34;</span><span class="op" id="7753677">,</span>&nbsp;<span class="ident" id="7753679">dials</span><span class="op" id="7753684">,</span>&nbsp;<span class="ident" id="7753686">got</span><span class="op" id="7753689">,</span>&nbsp;<span class="ident" id="7753691">dials</span><span class="op" id="7753696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7753699">}</span><br>
<span class="lineno"></span><span class="op" id="7753701">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="7753704">func</span>&nbsp;<span class="ident" id="7753709">numTCP</span><span class="op" id="7753715">(</span><span class="op" id="7753716">)</span>&nbsp;<span class="op" id="7753718">(</span><span class="ident" id="7753719">ntcp</span><span class="op" id="7753723">,</span>&nbsp;<span class="ident" id="7753725">nopen</span><span class="op" id="7753730">,</span>&nbsp;<span class="ident" id="7753732">nclose</span>&nbsp;<span class="builtintype" id="7753739">int</span><span class="op" id="7753742">,</span>&nbsp;<span class="ident" id="7753744">err</span>&nbsp;<span class="builtintype" id="7753748">error</span><span class="op" id="7753753">)</span>&nbsp;<span class="op" id="7753755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7753758">lsof</span><span class="op" id="7753762">,</span>&nbsp;<span class="ident" id="7753764">err</span>&nbsp;<span class="op" id="7753768">:=</span>&nbsp;<span class="ident" id="7753771">exec</span><span class="op" id="7753775">.</span><span class="ident" id="7753776">Command</span><span class="op" id="7753783">(</span><span class="string" id="7753784">&#34;lsof&#34;</span><span class="op" id="7753790">,</span>&nbsp;<span class="string" id="7753792">&#34;-n&#34;</span><span class="op" id="7753796">,</span>&nbsp;<span class="string" id="7753798">&#34;-p&#34;</span><span class="op" id="7753802">,</span>&nbsp;<span class="ident" id="7753804">strconv</span><span class="op" id="7753811">.</span><span class="ident" id="7753812">Itoa</span><span class="op" id="7753816">(</span><span class="ident" id="7753817">os</span><span class="op" id="7753819">.</span><span class="ident" id="7753820">Getpid</span><span class="op" id="7753826">(</span><span class="op" id="7753827">)</span><span class="op" id="7753828">)</span><span class="op" id="7753829">)</span><span class="op" id="7753830">.</span><span class="ident" id="7753831">Output</span><span class="op" id="7753837">(</span><span class="op" id="7753838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7753841">if</span>&nbsp;<span class="ident" id="7753844">err</span>&nbsp;<span class="op" id="7753848">!=</span>&nbsp;<span class="ident" id="7753851">nil</span>&nbsp;<span class="op" id="7753855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7753859">return</span>&nbsp;<span class="num" id="7753866">0</span><span class="op" id="7753867">,</span>&nbsp;<span class="num" id="7753869">0</span><span class="op" id="7753870">,</span>&nbsp;<span class="num" id="7753872">0</span><span class="op" id="7753873">,</span>&nbsp;<span class="ident" id="7753875">err</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7753880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7753883">ntcp</span>&nbsp;<span class="op" id="7753888">+=</span>&nbsp;<span class="ident" id="7753891">bytes</span><span class="op" id="7753896">.</span><span class="ident" id="7753897">Count</span><span class="op" id="7753902">(</span><span class="ident" id="7753903">lsof</span><span class="op" id="7753907">,</span>&nbsp;<span class="op" id="7753909">[</span><span class="op" id="7753910">]</span><span class="builtintype" id="7753911">byte</span><span class="op" id="7753915">(</span><span class="string" id="7753916">&#34;TCP&#34;</span><span class="op" id="7753921">)</span><span class="op" id="7753922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7753925">for</span>&nbsp;<span class="ident" id="7753929">_</span><span class="op" id="7753930">,</span>&nbsp;<span class="ident" id="7753932">state</span>&nbsp;<span class="op" id="7753938">:=</span>&nbsp;<span class="keyword" id="7753941">range</span>&nbsp;<span class="op" id="7753947">[</span><span class="op" id="7753948">]</span><span class="builtintype" id="7753949">string</span><span class="op" id="7753955">{</span><span class="string" id="7753956">&#34;LISTEN&#34;</span><span class="op" id="7753964">,</span>&nbsp;<span class="string" id="7753966">&#34;SYN_SENT&#34;</span><span class="op" id="7753976">,</span>&nbsp;<span class="string" id="7753978">&#34;SYN_RECEIVED&#34;</span><span class="op" id="7753992">,</span>&nbsp;<span class="string" id="7753994">&#34;ESTABLISHED&#34;</span><span class="op" id="7754007">}</span>&nbsp;<span class="op" id="7754009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7754013">nopen</span>&nbsp;<span class="op" id="7754019">+=</span>&nbsp;<span class="ident" id="7754022">bytes</span><span class="op" id="7754027">.</span><span class="ident" id="7754028">Count</span><span class="op" id="7754033">(</span><span class="ident" id="7754034">lsof</span><span class="op" id="7754038">,</span>&nbsp;<span class="op" id="7754040">[</span><span class="op" id="7754041">]</span><span class="builtintype" id="7754042">byte</span><span class="op" id="7754046">(</span><span class="ident" id="7754047">state</span><span class="op" id="7754052">)</span><span class="op" id="7754053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7754056">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7754059">for</span>&nbsp;<span class="ident" id="7754063">_</span><span class="op" id="7754064">,</span>&nbsp;<span class="ident" id="7754066">state</span>&nbsp;<span class="op" id="7754072">:=</span>&nbsp;<span class="keyword" id="7754075">range</span>&nbsp;<span class="op" id="7754081">[</span><span class="op" id="7754082">]</span><span class="builtintype" id="7754083">string</span><span class="op" id="7754089">{</span><span class="string" id="7754090">&#34;CLOSED&#34;</span><span class="op" id="7754098">,</span>&nbsp;<span class="string" id="7754100">&#34;CLOSE_WAIT&#34;</span><span class="op" id="7754112">,</span>&nbsp;<span class="string" id="7754114">&#34;LAST_ACK&#34;</span><span class="op" id="7754124">,</span>&nbsp;<span class="string" id="7754126">&#34;FIN_WAIT_1&#34;</span><span class="op" id="7754138">,</span>&nbsp;<span class="string" id="7754140">&#34;FIN_WAIT_2&#34;</span><span class="op" id="7754152">,</span>&nbsp;<span class="string" id="7754154">&#34;CLOSING&#34;</span><span class="op" id="7754163">,</span>&nbsp;<span class="string" id="7754165">&#34;TIME_WAIT&#34;</span><span class="op" id="7754176">}</span>&nbsp;<span class="op" id="7754178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7754182">nclose</span>&nbsp;<span class="op" id="7754189">+=</span>&nbsp;<span class="ident" id="7754192">bytes</span><span class="op" id="7754197">.</span><span class="ident" id="7754198">Count</span><span class="op" id="7754203">(</span><span class="ident" id="7754204">lsof</span><span class="op" id="7754208">,</span>&nbsp;<span class="op" id="7754210">[</span><span class="op" id="7754211">]</span><span class="builtintype" id="7754212">byte</span><span class="op" id="7754216">(</span><span class="ident" id="7754217">state</span><span class="op" id="7754222">)</span><span class="op" id="7754223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7754226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7754229">return</span>&nbsp;<span class="ident" id="7754236">ntcp</span><span class="op" id="7754240">,</span>&nbsp;<span class="ident" id="7754242">nopen</span><span class="op" id="7754247">,</span>&nbsp;<span class="ident" id="7754249">nclose</span><span class="op" id="7754255">,</span>&nbsp;<span class="ident" id="7754257">nil</span><br>
<span class="lineno"></span><span class="op" id="7754261">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="keyword" id="7754264">func</span>&nbsp;<span class="ident" id="7754269">TestDialMultiFDLeak</span><span class="op" id="7754288">(</span><span class="ident" id="7754289">t</span>&nbsp;<span class="op" id="7754291">*</span><span class="ident" id="7754292">testing</span><span class="op" id="7754299">.</span><span class="ident" id="7754300">T</span><span class="op" id="7754301">)</span>&nbsp;<span class="op" id="7754303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7754306">t</span><span class="op" id="7754307">.</span><span class="ident" id="7754308">Skip</span><span class="op" id="7754312">(</span><span class="string" id="7754313">&#34;flaky&nbsp;test&nbsp;-&nbsp;golang.org/issue/8764&#34;</span><span class="op" id="7754349">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7754353">if</span>&nbsp;<span class="op" id="7754356">!</span><span class="ident" id="7754357">supportsIPv4</span>&nbsp;<span class="op" id="7754370">||</span>&nbsp;<span class="op" id="7754373">!</span><span class="ident" id="7754374">supportsIPv6</span>&nbsp;<span class="op" id="7754387">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7754391">t</span><span class="op" id="7754392">.</span><span class="ident" id="7754393">Skip</span><span class="op" id="7754397">(</span><span class="string" id="7754398">&#34;neither&nbsp;ipv4&nbsp;nor&nbsp;ipv6&nbsp;is&nbsp;supported&#34;</span><span class="op" id="7754434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7754437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7754441">halfDeadServer</span>&nbsp;<span class="op" id="7754456">:=</span>&nbsp;<span class="keyword" id="7754459">func</span><span class="op" id="7754463">(</span><span class="ident" id="7754464">dss</span>&nbsp;<span class="op" id="7754468">*</span><span class="ident" id="7754469">dualStackServer</span><span class="op" id="7754484">,</span>&nbsp;<span class="ident" id="7754486">ln</span>&nbsp;<span class="ident" id="7754489">Listener</span><span class="op" id="7754497">)</span>&nbsp;<span class="op" id="7754499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7754503">for</span>&nbsp;<span class="op" id="7754507">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7754512">if</span>&nbsp;<span class="ident" id="7754515">c</span><span class="op" id="7754516">,</span>&nbsp;<span class="ident" id="7754518">err</span>&nbsp;<span class="op" id="7754522">:=</span>&nbsp;<span class="ident" id="7754525">ln</span><span class="op" id="7754527">.</span><span class="ident" id="7754528">Accept</span><span class="op" id="7754534">(</span><span class="op" id="7754535">)</span><span class="op" id="7754536">;</span>&nbsp;<span class="ident" id="7754538">err</span>&nbsp;<span class="op" id="7754542">!=</span>&nbsp;<span class="ident" id="7754545">nil</span>&nbsp;<span class="op" id="7754549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7754555">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7754565">}</span>&nbsp;<span class="keyword" id="7754567">else</span>&nbsp;<span class="op" id="7754572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7754578">//&nbsp;It&nbsp;just&nbsp;keeps&nbsp;established</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7754611">//&nbsp;connections&nbsp;like&nbsp;a&nbsp;half-dead&nbsp;server</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7754654">//&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7754667">dss</span><span class="op" id="7754670">.</span><span class="ident" id="7754671">putConn</span><span class="op" id="7754678">(</span><span class="ident" id="7754679">c</span><span class="op" id="7754680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7754685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7754689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7754692">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7754695">dss</span><span class="op" id="7754698">,</span>&nbsp;<span class="ident" id="7754700">err</span>&nbsp;<span class="op" id="7754704">:=</span>&nbsp;<span class="ident" id="7754707">newDualStackServer</span><span class="op" id="7754725">(</span><span class="op" id="7754726">[</span><span class="op" id="7754727">]</span><span class="ident" id="7754728">streamListener</span><span class="op" id="7754742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7754746">{</span><span class="ident" id="7754747">net</span><span class="op" id="7754750">:</span>&nbsp;<span class="string" id="7754752">&#34;tcp4&#34;</span><span class="op" id="7754758">,</span>&nbsp;<span class="ident" id="7754760">addr</span><span class="op" id="7754764">:</span>&nbsp;<span class="string" id="7754766">&#34;127.0.0.1&#34;</span><span class="op" id="7754777">}</span><span class="op" id="7754778">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7754782">{</span><span class="ident" id="7754783">net</span><span class="op" id="7754786">:</span>&nbsp;<span class="string" id="7754788">&#34;tcp6&#34;</span><span class="op" id="7754794">,</span>&nbsp;<span class="ident" id="7754796">addr</span><span class="op" id="7754800">:</span>&nbsp;<span class="string" id="7754802">&#34;[::1]&#34;</span><span class="op" id="7754809">}</span><span class="op" id="7754810">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7754813">}</span><span class="op" id="7754814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7754817">if</span>&nbsp;<span class="ident" id="7754820">err</span>&nbsp;<span class="op" id="7754824">!=</span>&nbsp;<span class="ident" id="7754827">nil</span>&nbsp;<span class="op" id="7754831">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7754835">t</span><span class="op" id="7754836">.</span><span class="ident" id="7754837">Fatalf</span><span class="op" id="7754843">(</span><span class="string" id="7754844">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7754875">,</span>&nbsp;<span class="ident" id="7754877">err</span><span class="op" id="7754880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7754883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7754886">defer</span>&nbsp;<span class="ident" id="7754892">dss</span><span class="op" id="7754895">.</span><span class="ident" id="7754896">teardown</span><span class="op" id="7754904">(</span><span class="op" id="7754905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7754908">if</span>&nbsp;<span class="ident" id="7754911">err</span>&nbsp;<span class="op" id="7754915">:=</span>&nbsp;<span class="ident" id="7754918">dss</span><span class="op" id="7754921">.</span><span class="ident" id="7754922">buildup</span><span class="op" id="7754929">(</span><span class="ident" id="7754930">halfDeadServer</span><span class="op" id="7754944">)</span><span class="op" id="7754945">;</span>&nbsp;<span class="ident" id="7754947">err</span>&nbsp;<span class="op" id="7754951">!=</span>&nbsp;<span class="ident" id="7754954">nil</span>&nbsp;<span class="op" id="7754958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7754962">t</span><span class="op" id="7754963">.</span><span class="ident" id="7754964">Fatalf</span><span class="op" id="7754970">(</span><span class="string" id="7754971">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7755007">,</span>&nbsp;<span class="ident" id="7755009">err</span><span class="op" id="7755012">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7755015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7755019">_</span><span class="op" id="7755020">,</span>&nbsp;<span class="ident" id="7755022">before</span><span class="op" id="7755028">,</span>&nbsp;<span class="ident" id="7755030">_</span><span class="op" id="7755031">,</span>&nbsp;<span class="ident" id="7755033">err</span>&nbsp;<span class="op" id="7755037">:=</span>&nbsp;<span class="ident" id="7755040">numTCP</span><span class="op" id="7755046">(</span><span class="op" id="7755047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7755050">if</span>&nbsp;<span class="ident" id="7755053">err</span>&nbsp;<span class="op" id="7755057">!=</span>&nbsp;<span class="ident" id="7755060">nil</span>&nbsp;<span class="op" id="7755064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7755068">t</span><span class="op" id="7755069">.</span><span class="ident" id="7755070">Skipf</span><span class="op" id="7755075">(</span><span class="string" id="7755076">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="7755126">,</span>&nbsp;<span class="ident" id="7755128">err</span><span class="op" id="7755131">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7755134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7755138">var</span>&nbsp;<span class="ident" id="7755142">wg</span>&nbsp;<span class="ident" id="7755145">sync</span><span class="op" id="7755149">.</span><span class="ident" id="7755150">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7755161">portnum</span><span class="op" id="7755168">,</span>&nbsp;<span class="ident" id="7755170">_</span><span class="op" id="7755171">,</span>&nbsp;<span class="ident" id="7755173">_</span>&nbsp;<span class="op" id="7755175">:=</span>&nbsp;<span class="ident" id="7755178">dtoi</span><span class="op" id="7755182">(</span><span class="ident" id="7755183">dss</span><span class="op" id="7755186">.</span><span class="ident" id="7755187">port</span><span class="op" id="7755191">,</span>&nbsp;<span class="num" id="7755193">0</span><span class="op" id="7755194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7755197">ras</span>&nbsp;<span class="op" id="7755201">:=</span>&nbsp;<span class="ident" id="7755204">addrList</span><span class="op" id="7755212">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7755216">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;fail&nbsp;to&nbsp;connect,&nbsp;see&nbsp;RFC&nbsp;6890.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7755269">&amp;</span><span class="ident" id="7755270">TCPAddr</span><span class="op" id="7755277">{</span><span class="ident" id="7755278">IP</span><span class="op" id="7755280">:</span>&nbsp;<span class="ident" id="7755282">IPv4</span><span class="op" id="7755286">(</span><span class="num" id="7755287">198</span><span class="op" id="7755290">,</span>&nbsp;<span class="num" id="7755292">18</span><span class="op" id="7755294">,</span>&nbsp;<span class="num" id="7755296">0</span><span class="op" id="7755297">,</span>&nbsp;<span class="num" id="7755299">254</span><span class="op" id="7755302">)</span><span class="op" id="7755303">,</span>&nbsp;<span class="ident" id="7755305">Port</span><span class="op" id="7755309">:</span>&nbsp;<span class="ident" id="7755311">portnum</span><span class="op" id="7755318">}</span><span class="op" id="7755319">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7755323">&amp;</span><span class="ident" id="7755324">TCPAddr</span><span class="op" id="7755331">{</span><span class="ident" id="7755332">IP</span><span class="op" id="7755334">:</span>&nbsp;<span class="ident" id="7755336">ParseIP</span><span class="op" id="7755343">(</span><span class="string" id="7755344">&#34;2001:2::254&#34;</span><span class="op" id="7755357">)</span><span class="op" id="7755358">,</span>&nbsp;<span class="ident" id="7755360">Port</span><span class="op" id="7755364">:</span>&nbsp;<span class="ident" id="7755366">portnum</span><span class="op" id="7755373">}</span><span class="op" id="7755374">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7755379">//&nbsp;Winner&nbsp;candidates&nbsp;of&nbsp;this&nbsp;race.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7755416">&amp;</span><span class="ident" id="7755417">TCPAddr</span><span class="op" id="7755424">{</span><span class="ident" id="7755425">IP</span><span class="op" id="7755427">:</span>&nbsp;<span class="ident" id="7755429">IPv4</span><span class="op" id="7755433">(</span><span class="num" id="7755434">127</span><span class="op" id="7755437">,</span>&nbsp;<span class="num" id="7755439">0</span><span class="op" id="7755440">,</span>&nbsp;<span class="num" id="7755442">0</span><span class="op" id="7755443">,</span>&nbsp;<span class="num" id="7755445">1</span><span class="op" id="7755446">)</span><span class="op" id="7755447">,</span>&nbsp;<span class="ident" id="7755449">Port</span><span class="op" id="7755453">:</span>&nbsp;<span class="ident" id="7755455">portnum</span><span class="op" id="7755462">}</span><span class="op" id="7755463">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7755467">&amp;</span><span class="ident" id="7755468">TCPAddr</span><span class="op" id="7755475">{</span><span class="ident" id="7755476">IP</span><span class="op" id="7755478">:</span>&nbsp;<span class="ident" id="7755480">IPv6loopback</span><span class="op" id="7755492">,</span>&nbsp;<span class="ident" id="7755494">Port</span><span class="op" id="7755498">:</span>&nbsp;<span class="ident" id="7755500">portnum</span><span class="op" id="7755507">}</span><span class="op" id="7755508">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7755513">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;have&nbsp;established&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7755565">&amp;</span><span class="ident" id="7755566">TCPAddr</span><span class="op" id="7755573">{</span><span class="ident" id="7755574">IP</span><span class="op" id="7755576">:</span>&nbsp;<span class="ident" id="7755578">IPv4</span><span class="op" id="7755582">(</span><span class="num" id="7755583">127</span><span class="op" id="7755586">,</span>&nbsp;<span class="num" id="7755588">0</span><span class="op" id="7755589">,</span>&nbsp;<span class="num" id="7755591">0</span><span class="op" id="7755592">,</span>&nbsp;<span class="num" id="7755594">1</span><span class="op" id="7755595">)</span><span class="op" id="7755596">,</span>&nbsp;<span class="ident" id="7755598">Port</span><span class="op" id="7755602">:</span>&nbsp;<span class="ident" id="7755604">portnum</span><span class="op" id="7755611">}</span><span class="op" id="7755612">,</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7755616">&amp;</span><span class="ident" id="7755617">TCPAddr</span><span class="op" id="7755624">{</span><span class="ident" id="7755625">IP</span><span class="op" id="7755627">:</span>&nbsp;<span class="ident" id="7755629">IPv6loopback</span><span class="op" id="7755641">,</span>&nbsp;<span class="ident" id="7755643">Port</span><span class="op" id="7755647">:</span>&nbsp;<span class="ident" id="7755649">portnum</span><span class="op" id="7755656">}</span><span class="op" id="7755657">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7755660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7755663">const</span>&nbsp;<span class="ident" id="7755669">T1</span>&nbsp;<span class="op" id="7755672">=</span>&nbsp;<span class="num" id="7755674">10</span>&nbsp;<span class="op" id="7755677">*</span>&nbsp;<span class="ident" id="7755679">time</span><span class="op" id="7755683">.</span><span class="ident" id="7755684">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7755697">const</span>&nbsp;<span class="ident" id="7755703">T2</span>&nbsp;<span class="op" id="7755706">=</span>&nbsp;<span class="num" id="7755708">2</span>&nbsp;<span class="op" id="7755710">*</span>&nbsp;<span class="ident" id="7755712">T1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7755716">const</span>&nbsp;<span class="ident" id="7755722">N</span>&nbsp;<span class="op" id="7755724">=</span>&nbsp;<span class="num" id="7755726">10</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7755730">for</span>&nbsp;<span class="ident" id="7755734">i</span>&nbsp;<span class="op" id="7755736">:=</span>&nbsp;<span class="num" id="7755739">0</span><span class="op" id="7755740">;</span>&nbsp;<span class="ident" id="7755742">i</span>&nbsp;<span class="op" id="7755744">&lt;</span>&nbsp;<span class="ident" id="7755746">N</span><span class="op" id="7755747">;</span>&nbsp;<span class="ident" id="7755749">i</span><span class="op" id="7755750">++</span>&nbsp;<span class="op" id="7755753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7755757">wg</span><span class="op" id="7755759">.</span><span class="ident" id="7755760">Add</span><span class="op" id="7755763">(</span><span class="num" id="7755764">1</span><span class="op" id="7755765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7755769">go</span>&nbsp;<span class="keyword" id="7755772">func</span><span class="op" id="7755776">(</span><span class="op" id="7755777">)</span>&nbsp;<span class="op" id="7755779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7755784">defer</span>&nbsp;<span class="ident" id="7755790">wg</span><span class="op" id="7755792">.</span><span class="ident" id="7755793">Done</span><span class="op" id="7755797">(</span><span class="op" id="7755798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7755803">if</span>&nbsp;<span class="ident" id="7755806">c</span><span class="op" id="7755807">,</span>&nbsp;<span class="ident" id="7755809">err</span>&nbsp;<span class="op" id="7755813">:=</span>&nbsp;<span class="ident" id="7755816">dialMulti</span><span class="op" id="7755825">(</span><span class="string" id="7755826">&#34;tcp&#34;</span><span class="op" id="7755831">,</span>&nbsp;<span class="string" id="7755833">&#34;fast&nbsp;failover&nbsp;test&#34;</span><span class="op" id="7755853">,</span>&nbsp;<span class="ident" id="7755855">nil</span><span class="op" id="7755858">,</span>&nbsp;<span class="ident" id="7755860">ras</span><span class="op" id="7755863">,</span>&nbsp;<span class="ident" id="7755865">time</span><span class="op" id="7755869">.</span><span class="ident" id="7755870">Now</span><span class="op" id="7755873">(</span><span class="op" id="7755874">)</span><span class="op" id="7755875">.</span><span class="ident" id="7755876">Add</span><span class="op" id="7755879">(</span><span class="ident" id="7755880">T1</span><span class="op" id="7755882">)</span><span class="op" id="7755883">)</span><span class="op" id="7755884">;</span>&nbsp;<span class="ident" id="7755886">err</span>&nbsp;<span class="op" id="7755890">==</span>&nbsp;<span class="ident" id="7755893">nil</span>&nbsp;<span class="op" id="7755897">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7755903">c</span><span class="op" id="7755904">.</span><span class="ident" id="7755905">Close</span><span class="op" id="7755910">(</span><span class="op" id="7755911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7755916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7755920">}</span><span class="op" id="7755921">(</span><span class="op" id="7755922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7755925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7755928">wg</span><span class="op" id="7755930">.</span><span class="ident" id="7755931">Wait</span><span class="op" id="7755935">(</span><span class="op" id="7755936">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7755939">time</span><span class="op" id="7755943">.</span><span class="ident" id="7755944">Sleep</span><span class="op" id="7755949">(</span><span class="ident" id="7755950">T2</span><span class="op" id="7755952">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7755956">ntcp</span><span class="op" id="7755960">,</span>&nbsp;<span class="ident" id="7755962">after</span><span class="op" id="7755967">,</span>&nbsp;<span class="ident" id="7755969">nclose</span><span class="op" id="7755975">,</span>&nbsp;<span class="ident" id="7755977">err</span>&nbsp;<span class="op" id="7755981">:=</span>&nbsp;<span class="ident" id="7755984">numTCP</span><span class="op" id="7755990">(</span><span class="op" id="7755991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7755994">if</span>&nbsp;<span class="ident" id="7755997">err</span>&nbsp;<span class="op" id="7756001">!=</span>&nbsp;<span class="ident" id="7756004">nil</span>&nbsp;<span class="op" id="7756008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7756012">t</span><span class="op" id="7756013">.</span><span class="ident" id="7756014">Skipf</span><span class="op" id="7756019">(</span><span class="string" id="7756020">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="7756070">,</span>&nbsp;<span class="ident" id="7756072">err</span><span class="op" id="7756075">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7756078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7756081">t</span><span class="op" id="7756082">.</span><span class="ident" id="7756083">Logf</span><span class="op" id="7756087">(</span><span class="string" id="7756088">&#34;tcp&nbsp;sessions:&nbsp;%v,&nbsp;open&nbsp;sessions:&nbsp;%v,&nbsp;closing&nbsp;sessions:&nbsp;%v&#34;</span><span class="op" id="7756147">,</span>&nbsp;<span class="ident" id="7756149">ntcp</span><span class="op" id="7756153">,</span>&nbsp;<span class="ident" id="7756155">after</span><span class="op" id="7756160">,</span>&nbsp;<span class="ident" id="7756162">nclose</span><span class="op" id="7756168">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7756172">if</span>&nbsp;<span class="ident" id="7756175">after</span>&nbsp;<span class="op" id="7756181">!=</span>&nbsp;<span class="ident" id="7756184">before</span>&nbsp;<span class="op" id="7756191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7756195">t</span><span class="op" id="7756196">.</span><span class="ident" id="7756197">Fatalf</span><span class="op" id="7756203">(</span><span class="string" id="7756204">&#34;got&nbsp;%v&nbsp;open&nbsp;sessions;&nbsp;expected&nbsp;%v&#34;</span><span class="op" id="7756239">,</span>&nbsp;<span class="ident" id="7756241">after</span><span class="op" id="7756246">,</span>&nbsp;<span class="ident" id="7756248">before</span><span class="op" id="7756254">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7756257">}</span><br>
<span class="lineno"></span><span class="op" id="7756259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7756262">func</span>&nbsp;<span class="ident" id="7756267">numFD</span><span class="op" id="7756272">(</span><span class="op" id="7756273">)</span>&nbsp;<span class="builtintype" id="7756275">int</span>&nbsp;<span class="op" id="7756279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7756282">if</span>&nbsp;<span class="ident" id="7756285">runtime</span><span class="op" id="7756292">.</span><span class="ident" id="7756293">GOOS</span>&nbsp;<span class="op" id="7756298">==</span>&nbsp;<span class="string" id="7756301">&#34;linux&#34;</span>&nbsp;<span class="op" id="7756309">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7756313">f</span><span class="op" id="7756314">,</span>&nbsp;<span class="ident" id="7756316">err</span>&nbsp;<span class="op" id="7756320">:=</span>&nbsp;<span class="ident" id="7756323">os</span><span class="op" id="7756325">.</span><span class="ident" id="7756326">Open</span><span class="op" id="7756330">(</span><span class="string" id="7756331">&#34;/proc/self/fd&#34;</span><span class="op" id="7756346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7756350">if</span>&nbsp;<span class="ident" id="7756353">err</span>&nbsp;<span class="op" id="7756357">!=</span>&nbsp;<span class="ident" id="7756360">nil</span>&nbsp;<span class="op" id="7756364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7756369">panic</span><span class="op" id="7756374">(</span><span class="ident" id="7756375">err</span><span class="op" id="7756378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7756382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7756386">defer</span>&nbsp;<span class="ident" id="7756392">f</span><span class="op" id="7756393">.</span><span class="ident" id="7756394">Close</span><span class="op" id="7756399">(</span><span class="op" id="7756400">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7756404">names</span><span class="op" id="7756409">,</span>&nbsp;<span class="ident" id="7756411">err</span>&nbsp;<span class="op" id="7756415">:=</span>&nbsp;<span class="ident" id="7756418">f</span><span class="op" id="7756419">.</span><span class="ident" id="7756420">Readdirnames</span><span class="op" id="7756432">(</span><span class="num" id="7756433">0</span><span class="op" id="7756434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7756438">if</span>&nbsp;<span class="ident" id="7756441">err</span>&nbsp;<span class="op" id="7756445">!=</span>&nbsp;<span class="ident" id="7756448">nil</span>&nbsp;<span class="op" id="7756452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7756457">panic</span><span class="op" id="7756462">(</span><span class="ident" id="7756463">err</span><span class="op" id="7756466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7756470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7756474">return</span>&nbsp;<span class="builtinfunc" id="7756481">len</span><span class="op" id="7756484">(</span><span class="ident" id="7756485">names</span><span class="op" id="7756490">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7756493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7756496">//&nbsp;All&nbsp;tests&nbsp;using&nbsp;this&nbsp;should&nbsp;be&nbsp;skipped&nbsp;anyway,&nbsp;but:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7756552">panic</span><span class="op" id="7756557">(</span><span class="string" id="7756558">&#34;numFDs&nbsp;not&nbsp;implemented&nbsp;on&nbsp;&#34;</span>&nbsp;<span class="op" id="7756587">+</span>&nbsp;<span class="ident" id="7756589">runtime</span><span class="op" id="7756596">.</span><span class="ident" id="7756597">GOOS</span><span class="op" id="7756601">)</span><br>
<span class="lineno"></span><span class="op" id="7756603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="7756606">func</span>&nbsp;<span class="ident" id="7756611">TestDialer</span><span class="op" id="7756621">(</span><span class="ident" id="7756622">t</span>&nbsp;<span class="op" id="7756624">*</span><span class="ident" id="7756625">testing</span><span class="op" id="7756632">.</span><span class="ident" id="7756633">T</span><span class="op" id="7756634">)</span>&nbsp;<span class="op" id="7756636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7756639">ln</span><span class="op" id="7756641">,</span>&nbsp;<span class="ident" id="7756643">err</span>&nbsp;<span class="op" id="7756647">:=</span>&nbsp;<span class="ident" id="7756650">Listen</span><span class="op" id="7756656">(</span><span class="string" id="7756657">&#34;tcp4&#34;</span><span class="op" id="7756663">,</span>&nbsp;<span class="string" id="7756665">&#34;127.0.0.1:0&#34;</span><span class="op" id="7756678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7756681">if</span>&nbsp;<span class="ident" id="7756684">err</span>&nbsp;<span class="op" id="7756688">!=</span>&nbsp;<span class="ident" id="7756691">nil</span>&nbsp;<span class="op" id="7756695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7756699">t</span><span class="op" id="7756700">.</span><span class="ident" id="7756701">Fatalf</span><span class="op" id="7756707">(</span><span class="string" id="7756708">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7756727">,</span>&nbsp;<span class="ident" id="7756729">err</span><span class="op" id="7756732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7756735">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7756738">defer</span>&nbsp;<span class="ident" id="7756744">ln</span><span class="op" id="7756746">.</span><span class="ident" id="7756747">Close</span><span class="op" id="7756752">(</span><span class="op" id="7756753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7756756">ch</span>&nbsp;<span class="op" id="7756759">:=</span>&nbsp;<span class="builtinfunc" id="7756762">make</span><span class="op" id="7756766">(</span><span class="keyword" id="7756767">chan</span>&nbsp;<span class="builtintype" id="7756772">error</span><span class="op" id="7756777">,</span>&nbsp;<span class="num" id="7756779">1</span><span class="op" id="7756780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7756783">go</span>&nbsp;<span class="keyword" id="7756786">func</span><span class="op" id="7756790">(</span><span class="op" id="7756791">)</span>&nbsp;<span class="op" id="7756793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7756797">c</span><span class="op" id="7756798">,</span>&nbsp;<span class="ident" id="7756800">err</span>&nbsp;<span class="op" id="7756804">:=</span>&nbsp;<span class="ident" id="7756807">ln</span><span class="op" id="7756809">.</span><span class="ident" id="7756810">Accept</span><span class="op" id="7756816">(</span><span class="op" id="7756817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7756821">if</span>&nbsp;<span class="ident" id="7756824">err</span>&nbsp;<span class="op" id="7756828">!=</span>&nbsp;<span class="ident" id="7756831">nil</span>&nbsp;<span class="op" id="7756835">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7756840">ch</span>&nbsp;<span class="op" id="7756843">&lt;-</span>&nbsp;<span class="ident" id="7756846">fmt</span><span class="op" id="7756849">.</span><span class="ident" id="7756850">Errorf</span><span class="op" id="7756856">(</span><span class="string" id="7756857">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7756876">,</span>&nbsp;<span class="ident" id="7756878">err</span><span class="op" id="7756881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7756886">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7756895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7756899">defer</span>&nbsp;<span class="ident" id="7756905">c</span><span class="op" id="7756906">.</span><span class="ident" id="7756907">Close</span><span class="op" id="7756912">(</span><span class="op" id="7756913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7756917">ch</span>&nbsp;<span class="op" id="7756920">&lt;-</span>&nbsp;<span class="ident" id="7756923">nil</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7756928">}</span><span class="op" id="7756929">(</span><span class="op" id="7756930">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7756934">laddr</span><span class="op" id="7756939">,</span>&nbsp;<span class="ident" id="7756941">err</span>&nbsp;<span class="op" id="7756945">:=</span>&nbsp;<span class="ident" id="7756948">ResolveTCPAddr</span><span class="op" id="7756962">(</span><span class="string" id="7756963">&#34;tcp4&#34;</span><span class="op" id="7756969">,</span>&nbsp;<span class="string" id="7756971">&#34;127.0.0.1:0&#34;</span><span class="op" id="7756984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7756987">if</span>&nbsp;<span class="ident" id="7756990">err</span>&nbsp;<span class="op" id="7756994">!=</span>&nbsp;<span class="ident" id="7756997">nil</span>&nbsp;<span class="op" id="7757001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7757005">t</span><span class="op" id="7757006">.</span><span class="ident" id="7757007">Fatalf</span><span class="op" id="7757013">(</span><span class="string" id="7757014">&#34;ResolveTCPAddr&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7757041">,</span>&nbsp;<span class="ident" id="7757043">err</span><span class="op" id="7757046">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7757049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7757052">d</span>&nbsp;<span class="op" id="7757054">:=</span>&nbsp;<span class="op" id="7757057">&amp;</span><span class="ident" id="7757058">Dialer</span><span class="op" id="7757064">{</span><span class="ident" id="7757065">LocalAddr</span><span class="op" id="7757074">:</span>&nbsp;<span class="ident" id="7757076">laddr</span><span class="op" id="7757081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7757084">c</span><span class="op" id="7757085">,</span>&nbsp;<span class="ident" id="7757087">err</span>&nbsp;<span class="op" id="7757091">:=</span>&nbsp;<span class="ident" id="7757094">d</span><span class="op" id="7757095">.</span><span class="ident" id="7757096">Dial</span><span class="op" id="7757100">(</span><span class="string" id="7757101">&#34;tcp4&#34;</span><span class="op" id="7757107">,</span>&nbsp;<span class="ident" id="7757109">ln</span><span class="op" id="7757111">.</span><span class="ident" id="7757112">Addr</span><span class="op" id="7757116">(</span><span class="op" id="7757117">)</span><span class="op" id="7757118">.</span><span class="ident" id="7757119">String</span><span class="op" id="7757125">(</span><span class="op" id="7757126">)</span><span class="op" id="7757127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7757130">if</span>&nbsp;<span class="ident" id="7757133">err</span>&nbsp;<span class="op" id="7757137">!=</span>&nbsp;<span class="ident" id="7757140">nil</span>&nbsp;<span class="op" id="7757144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7757148">t</span><span class="op" id="7757149">.</span><span class="ident" id="7757150">Fatalf</span><span class="op" id="7757156">(</span><span class="string" id="7757157">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7757174">,</span>&nbsp;<span class="ident" id="7757176">err</span><span class="op" id="7757179">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7757182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7757185">defer</span>&nbsp;<span class="ident" id="7757191">c</span><span class="op" id="7757192">.</span><span class="ident" id="7757193">Close</span><span class="op" id="7757198">(</span><span class="op" id="7757199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7757202">c</span><span class="op" id="7757203">.</span><span class="ident" id="7757204">Read</span><span class="op" id="7757208">(</span><span class="builtinfunc" id="7757209">make</span><span class="op" id="7757213">(</span><span class="op" id="7757214">[</span><span class="op" id="7757215">]</span><span class="builtintype" id="7757216">byte</span><span class="op" id="7757220">,</span>&nbsp;<span class="num" id="7757222">1</span><span class="op" id="7757223">)</span><span class="op" id="7757224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7757227">err</span>&nbsp;<span class="op" id="7757231">=</span>&nbsp;<span class="op" id="7757233">&lt;-</span><span class="ident" id="7757235">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7757239">if</span>&nbsp;<span class="ident" id="7757242">err</span>&nbsp;<span class="op" id="7757246">!=</span>&nbsp;<span class="ident" id="7757249">nil</span>&nbsp;<span class="op" id="7757253">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7757257">t</span><span class="op" id="7757258">.</span><span class="ident" id="7757259">Error</span><span class="op" id="7757264">(</span><span class="ident" id="7757265">err</span><span class="op" id="7757268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7757271">}</span><br>
<span class="lineno"></span><span class="op" id="7757273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7757276">func</span>&nbsp;<span class="ident" id="7757281">TestDialDualStackLocalhost</span><span class="op" id="7757307">(</span><span class="ident" id="7757308">t</span>&nbsp;<span class="op" id="7757310">*</span><span class="ident" id="7757311">testing</span><span class="op" id="7757318">.</span><span class="ident" id="7757319">T</span><span class="op" id="7757320">)</span>&nbsp;<span class="op" id="7757322">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7757325">switch</span>&nbsp;<span class="ident" id="7757332">runtime</span><span class="op" id="7757339">.</span><span class="ident" id="7757340">GOOS</span>&nbsp;<span class="op" id="7757345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7757348">case</span>&nbsp;<span class="string" id="7757353">&#34;nacl&#34;</span><span class="op" id="7757359">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7757363">t</span><span class="op" id="7757364">.</span><span class="ident" id="7757365">Skipf</span><span class="op" id="7757370">(</span><span class="string" id="7757371">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7757392">,</span>&nbsp;<span class="ident" id="7757394">runtime</span><span class="op" id="7757401">.</span><span class="ident" id="7757402">GOOS</span><span class="op" id="7757406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7757409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7757413">if</span>&nbsp;<span class="ident" id="7757416">ips</span><span class="op" id="7757419">,</span>&nbsp;<span class="ident" id="7757421">err</span>&nbsp;<span class="op" id="7757425">:=</span>&nbsp;<span class="ident" id="7757428">LookupIP</span><span class="op" id="7757436">(</span><span class="string" id="7757437">&#34;localhost&#34;</span><span class="op" id="7757448">)</span><span class="op" id="7757449">;</span>&nbsp;<span class="ident" id="7757451">err</span>&nbsp;<span class="op" id="7757455">!=</span>&nbsp;<span class="ident" id="7757458">nil</span>&nbsp;<span class="op" id="7757462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7757466">t</span><span class="op" id="7757467">.</span><span class="ident" id="7757468">Fatalf</span><span class="op" id="7757474">(</span><span class="string" id="7757475">&#34;LookupIP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7757496">,</span>&nbsp;<span class="ident" id="7757498">err</span><span class="op" id="7757501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7757504">}</span>&nbsp;<span class="keyword" id="7757506">else</span>&nbsp;<span class="keyword" id="7757511">if</span>&nbsp;<span class="builtinfunc" id="7757514">len</span><span class="op" id="7757517">(</span><span class="ident" id="7757518">ips</span><span class="op" id="7757521">)</span>&nbsp;<span class="op" id="7757523">&lt;</span>&nbsp;<span class="num" id="7757525">2</span>&nbsp;<span class="op" id="7757527">||</span>&nbsp;<span class="op" id="7757530">!</span><span class="ident" id="7757531">supportsIPv4</span>&nbsp;<span class="op" id="7757544">||</span>&nbsp;<span class="op" id="7757547">!</span><span class="ident" id="7757548">supportsIPv6</span>&nbsp;<span class="op" id="7757561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7757565">t</span><span class="op" id="7757566">.</span><span class="ident" id="7757567">Skip</span><span class="op" id="7757571">(</span><span class="string" id="7757572">&#34;localhost&nbsp;doesn&#39;t&nbsp;have&nbsp;a&nbsp;pair&nbsp;of&nbsp;different&nbsp;address&nbsp;family&nbsp;IP&nbsp;addresses&#34;</span><span class="op" id="7757644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7757647">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7757651">touchAndByeServer</span>&nbsp;<span class="op" id="7757669">:=</span>&nbsp;<span class="keyword" id="7757672">func</span><span class="op" id="7757676">(</span><span class="ident" id="7757677">dss</span>&nbsp;<span class="op" id="7757681">*</span><span class="ident" id="7757682">dualStackServer</span><span class="op" id="7757697">,</span>&nbsp;<span class="ident" id="7757699">ln</span>&nbsp;<span class="ident" id="7757702">Listener</span><span class="op" id="7757710">)</span>&nbsp;<span class="op" id="7757712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7757716">for</span>&nbsp;<span class="op" id="7757720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7757725">if</span>&nbsp;<span class="ident" id="7757728">c</span><span class="op" id="7757729">,</span>&nbsp;<span class="ident" id="7757731">err</span>&nbsp;<span class="op" id="7757735">:=</span>&nbsp;<span class="ident" id="7757738">ln</span><span class="op" id="7757740">.</span><span class="ident" id="7757741">Accept</span><span class="op" id="7757747">(</span><span class="op" id="7757748">)</span><span class="op" id="7757749">;</span>&nbsp;<span class="ident" id="7757751">err</span>&nbsp;<span class="op" id="7757755">!=</span>&nbsp;<span class="ident" id="7757758">nil</span>&nbsp;<span class="op" id="7757762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7757768">return</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7757778">}</span>&nbsp;<span class="keyword" id="7757780">else</span>&nbsp;<span class="op" id="7757785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7757791">c</span><span class="op" id="7757792">.</span><span class="ident" id="7757793">Close</span><span class="op" id="7757798">(</span><span class="op" id="7757799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7757804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7757808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7757811">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7757814">dss</span><span class="op" id="7757817">,</span>&nbsp;<span class="ident" id="7757819">err</span>&nbsp;<span class="op" id="7757823">:=</span>&nbsp;<span class="ident" id="7757826">newDualStackServer</span><span class="op" id="7757844">(</span><span class="op" id="7757845">[</span><span class="op" id="7757846">]</span><span class="ident" id="7757847">streamListener</span><span class="op" id="7757861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7757865">{</span><span class="ident" id="7757866">net</span><span class="op" id="7757869">:</span>&nbsp;<span class="string" id="7757871">&#34;tcp4&#34;</span><span class="op" id="7757877">,</span>&nbsp;<span class="ident" id="7757879">addr</span><span class="op" id="7757883">:</span>&nbsp;<span class="string" id="7757885">&#34;127.0.0.1&#34;</span><span class="op" id="7757896">}</span><span class="op" id="7757897">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7757901">{</span><span class="ident" id="7757902">net</span><span class="op" id="7757905">:</span>&nbsp;<span class="string" id="7757907">&#34;tcp6&#34;</span><span class="op" id="7757913">,</span>&nbsp;<span class="ident" id="7757915">addr</span><span class="op" id="7757919">:</span>&nbsp;<span class="string" id="7757921">&#34;[::1]&#34;</span><span class="op" id="7757928">}</span><span class="op" id="7757929">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7757932">}</span><span class="op" id="7757933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7757936">if</span>&nbsp;<span class="ident" id="7757939">err</span>&nbsp;<span class="op" id="7757943">!=</span>&nbsp;<span class="ident" id="7757946">nil</span>&nbsp;<span class="op" id="7757950">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7757954">t</span><span class="op" id="7757955">.</span><span class="ident" id="7757956">Fatalf</span><span class="op" id="7757962">(</span><span class="string" id="7757963">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7757994">,</span>&nbsp;<span class="ident" id="7757996">err</span><span class="op" id="7757999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7758002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7758005">defer</span>&nbsp;<span class="ident" id="7758011">dss</span><span class="op" id="7758014">.</span><span class="ident" id="7758015">teardown</span><span class="op" id="7758023">(</span><span class="op" id="7758024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7758027">if</span>&nbsp;<span class="ident" id="7758030">err</span>&nbsp;<span class="op" id="7758034">:=</span>&nbsp;<span class="ident" id="7758037">dss</span><span class="op" id="7758040">.</span><span class="ident" id="7758041">buildup</span><span class="op" id="7758048">(</span><span class="ident" id="7758049">touchAndByeServer</span><span class="op" id="7758066">)</span><span class="op" id="7758067">;</span>&nbsp;<span class="ident" id="7758069">err</span>&nbsp;<span class="op" id="7758073">!=</span>&nbsp;<span class="ident" id="7758076">nil</span>&nbsp;<span class="op" id="7758080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7758084">t</span><span class="op" id="7758085">.</span><span class="ident" id="7758086">Fatalf</span><span class="op" id="7758092">(</span><span class="string" id="7758093">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7758129">,</span>&nbsp;<span class="ident" id="7758131">err</span><span class="op" id="7758134">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7758137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7758141">d</span>&nbsp;<span class="op" id="7758143">:=</span>&nbsp;<span class="op" id="7758146">&amp;</span><span class="ident" id="7758147">Dialer</span><span class="op" id="7758153">{</span><span class="ident" id="7758154">DualStack</span><span class="op" id="7758163">:</span>&nbsp;<span class="builtintype" id="7758165">true</span><span class="op" id="7758169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7758172">for</span>&nbsp;<span class="keyword" id="7758176">range</span>&nbsp;<span class="ident" id="7758182">dss</span><span class="op" id="7758185">.</span><span class="ident" id="7758186">lns</span>&nbsp;<span class="op" id="7758190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7758194">if</span>&nbsp;<span class="ident" id="7758197">c</span><span class="op" id="7758198">,</span>&nbsp;<span class="ident" id="7758200">err</span>&nbsp;<span class="op" id="7758204">:=</span>&nbsp;<span class="ident" id="7758207">d</span><span class="op" id="7758208">.</span><span class="ident" id="7758209">Dial</span><span class="op" id="7758213">(</span><span class="string" id="7758214">&#34;tcp&#34;</span><span class="op" id="7758219">,</span>&nbsp;<span class="string" id="7758221">&#34;localhost:&#34;</span><span class="op" id="7758233">+</span><span class="ident" id="7758234">dss</span><span class="op" id="7758237">.</span><span class="ident" id="7758238">port</span><span class="op" id="7758242">)</span><span class="op" id="7758243">;</span>&nbsp;<span class="ident" id="7758245">err</span>&nbsp;<span class="op" id="7758249">!=</span>&nbsp;<span class="ident" id="7758252">nil</span>&nbsp;<span class="op" id="7758256">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7758261">t</span><span class="op" id="7758262">.</span><span class="ident" id="7758263">Errorf</span><span class="op" id="7758269">(</span><span class="string" id="7758270">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7758287">,</span>&nbsp;<span class="ident" id="7758289">err</span><span class="op" id="7758292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7758296">}</span>&nbsp;<span class="keyword" id="7758298">else</span>&nbsp;<span class="op" id="7758303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7758308">if</span>&nbsp;<span class="ident" id="7758311">addr</span>&nbsp;<span class="op" id="7758316">:=</span>&nbsp;<span class="ident" id="7758319">c</span><span class="op" id="7758320">.</span><span class="ident" id="7758321">LocalAddr</span><span class="op" id="7758330">(</span><span class="op" id="7758331">)</span><span class="op" id="7758332">.</span><span class="op" id="7758333">(</span><span class="op" id="7758334">*</span><span class="ident" id="7758335">TCPAddr</span><span class="op" id="7758342">)</span><span class="op" id="7758343">;</span>&nbsp;<span class="ident" id="7758345">addr</span><span class="op" id="7758349">.</span><span class="ident" id="7758350">IP</span><span class="op" id="7758352">.</span><span class="ident" id="7758353">To4</span><span class="op" id="7758356">(</span><span class="op" id="7758357">)</span>&nbsp;<span class="op" id="7758359">!=</span>&nbsp;<span class="ident" id="7758362">nil</span>&nbsp;<span class="op" id="7758366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7758372">dss</span><span class="op" id="7758375">.</span><span class="ident" id="7758376">teardownNetwork</span><span class="op" id="7758391">(</span><span class="string" id="7758392">&#34;tcp4&#34;</span><span class="op" id="7758398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7758403">}</span>&nbsp;<span class="keyword" id="7758405">else</span>&nbsp;<span class="keyword" id="7758410">if</span>&nbsp;<span class="ident" id="7758413">addr</span><span class="op" id="7758417">.</span><span class="ident" id="7758418">IP</span><span class="op" id="7758420">.</span><span class="ident" id="7758421">To16</span><span class="op" id="7758425">(</span><span class="op" id="7758426">)</span>&nbsp;<span class="op" id="7758428">!=</span>&nbsp;<span class="ident" id="7758431">nil</span>&nbsp;<span class="op" id="7758435">&amp;&amp;</span>&nbsp;<span class="ident" id="7758438">addr</span><span class="op" id="7758442">.</span><span class="ident" id="7758443">IP</span><span class="op" id="7758445">.</span><span class="ident" id="7758446">To4</span><span class="op" id="7758449">(</span><span class="op" id="7758450">)</span>&nbsp;<span class="op" id="7758452">==</span>&nbsp;<span class="ident" id="7758455">nil</span>&nbsp;<span class="op" id="7758459">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7758465">dss</span><span class="op" id="7758468">.</span><span class="ident" id="7758469">teardownNetwork</span><span class="op" id="7758484">(</span><span class="string" id="7758485">&#34;tcp6&#34;</span><span class="op" id="7758491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7758496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7758501">c</span><span class="op" id="7758502">.</span><span class="ident" id="7758503">Close</span><span class="op" id="7758508">(</span><span class="op" id="7758509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7758513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7758516">}</span><br>
<span class="lineno">515</span><span class="op" id="7758518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7758521">func</span>&nbsp;<span class="ident" id="7758526">TestDialerKeepAlive</span><span class="op" id="7758545">(</span><span class="ident" id="7758546">t</span>&nbsp;<span class="op" id="7758548">*</span><span class="ident" id="7758549">testing</span><span class="op" id="7758556">.</span><span class="ident" id="7758557">T</span><span class="op" id="7758558">)</span>&nbsp;<span class="op" id="7758560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7758563">ln</span>&nbsp;<span class="op" id="7758566">:=</span>&nbsp;<span class="ident" id="7758569">newLocalListener</span><span class="op" id="7758585">(</span><span class="ident" id="7758586">t</span><span class="op" id="7758587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7758590">defer</span>&nbsp;<span class="ident" id="7758596">ln</span><span class="op" id="7758598">.</span><span class="ident" id="7758599">Close</span><span class="op" id="7758604">(</span><span class="op" id="7758605">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7758608">defer</span>&nbsp;<span class="keyword" id="7758614">func</span><span class="op" id="7758618">(</span><span class="op" id="7758619">)</span>&nbsp;<span class="op" id="7758621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7758625">testHookSetKeepAlive</span>&nbsp;<span class="op" id="7758646">=</span>&nbsp;<span class="keyword" id="7758648">func</span><span class="op" id="7758652">(</span><span class="op" id="7758653">)</span>&nbsp;<span class="op" id="7758655">{</span><span class="op" id="7758656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7758659">}</span><span class="op" id="7758660">(</span><span class="op" id="7758661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7758664">go</span>&nbsp;<span class="keyword" id="7758667">func</span><span class="op" id="7758671">(</span><span class="op" id="7758672">)</span>&nbsp;<span class="op" id="7758674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7758678">for</span>&nbsp;<span class="op" id="7758682">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7758687">c</span><span class="op" id="7758688">,</span>&nbsp;<span class="ident" id="7758690">err</span>&nbsp;<span class="op" id="7758694">:=</span>&nbsp;<span class="ident" id="7758697">ln</span><span class="op" id="7758699">.</span><span class="ident" id="7758700">Accept</span><span class="op" id="7758706">(</span><span class="op" id="7758707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7758712">if</span>&nbsp;<span class="ident" id="7758715">err</span>&nbsp;<span class="op" id="7758719">!=</span>&nbsp;<span class="ident" id="7758722">nil</span>&nbsp;<span class="op" id="7758726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7758732">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7758742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7758747">c</span><span class="op" id="7758748">.</span><span class="ident" id="7758749">Close</span><span class="op" id="7758754">(</span><span class="op" id="7758755">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7758759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7758762">}</span><span class="op" id="7758763">(</span><span class="op" id="7758764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7758767">for</span>&nbsp;<span class="ident" id="7758771">_</span><span class="op" id="7758772">,</span>&nbsp;<span class="ident" id="7758774">keepAlive</span>&nbsp;<span class="op" id="7758784">:=</span>&nbsp;<span class="keyword" id="7758787">range</span>&nbsp;<span class="op" id="7758793">[</span><span class="op" id="7758794">]</span><span class="builtintype" id="7758795">bool</span><span class="op" id="7758799">{</span><span class="builtintype" id="7758800">false</span><span class="op" id="7758805">,</span>&nbsp;<span class="builtintype" id="7758807">true</span><span class="op" id="7758811">}</span>&nbsp;<span class="op" id="7758813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7758817">got</span>&nbsp;<span class="op" id="7758821">:=</span>&nbsp;<span class="builtintype" id="7758824">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7758832">testHookSetKeepAlive</span>&nbsp;<span class="op" id="7758853">=</span>&nbsp;<span class="keyword" id="7758855">func</span><span class="op" id="7758859">(</span><span class="op" id="7758860">)</span>&nbsp;<span class="op" id="7758862">{</span>&nbsp;<span class="ident" id="7758864">got</span>&nbsp;<span class="op" id="7758868">=</span>&nbsp;<span class="builtintype" id="7758870">true</span>&nbsp;<span class="op" id="7758875">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7758879">var</span>&nbsp;<span class="ident" id="7758883">d</span>&nbsp;<span class="ident" id="7758885">Dialer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7758894">if</span>&nbsp;<span class="ident" id="7758897">keepAlive</span>&nbsp;<span class="op" id="7758907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7758912">d</span><span class="op" id="7758913">.</span><span class="ident" id="7758914">KeepAlive</span>&nbsp;<span class="op" id="7758924">=</span>&nbsp;<span class="num" id="7758926">30</span>&nbsp;<span class="op" id="7758929">*</span>&nbsp;<span class="ident" id="7758931">time</span><span class="op" id="7758935">.</span><span class="ident" id="7758936">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7758945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7758949">c</span><span class="op" id="7758950">,</span>&nbsp;<span class="ident" id="7758952">err</span>&nbsp;<span class="op" id="7758956">:=</span>&nbsp;<span class="ident" id="7758959">d</span><span class="op" id="7758960">.</span><span class="ident" id="7758961">Dial</span><span class="op" id="7758965">(</span><span class="string" id="7758966">&#34;tcp&#34;</span><span class="op" id="7758971">,</span>&nbsp;<span class="ident" id="7758973">ln</span><span class="op" id="7758975">.</span><span class="ident" id="7758976">Addr</span><span class="op" id="7758980">(</span><span class="op" id="7758981">)</span><span class="op" id="7758982">.</span><span class="ident" id="7758983">String</span><span class="op" id="7758989">(</span><span class="op" id="7758990">)</span><span class="op" id="7758991">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7758995">if</span>&nbsp;<span class="ident" id="7758998">err</span>&nbsp;<span class="op" id="7759002">!=</span>&nbsp;<span class="ident" id="7759005">nil</span>&nbsp;<span class="op" id="7759009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7759014">t</span><span class="op" id="7759015">.</span><span class="ident" id="7759016">Fatal</span><span class="op" id="7759021">(</span><span class="ident" id="7759022">err</span><span class="op" id="7759025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7759029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7759033">c</span><span class="op" id="7759034">.</span><span class="ident" id="7759035">Close</span><span class="op" id="7759040">(</span><span class="op" id="7759041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7759045">if</span>&nbsp;<span class="ident" id="7759048">got</span>&nbsp;<span class="op" id="7759052">!=</span>&nbsp;<span class="ident" id="7759055">keepAlive</span>&nbsp;<span class="op" id="7759065">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7759070">t</span><span class="op" id="7759071">.</span><span class="ident" id="7759072">Errorf</span><span class="op" id="7759078">(</span><span class="string" id="7759079">&#34;Dialer.KeepAlive&nbsp;=&nbsp;%v:&nbsp;SetKeepAlive&nbsp;called&nbsp;=&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7759137">,</span>&nbsp;<span class="ident" id="7759139">d</span><span class="op" id="7759140">.</span><span class="ident" id="7759141">KeepAlive</span><span class="op" id="7759150">,</span>&nbsp;<span class="ident" id="7759152">got</span><span class="op" id="7759155">,</span>&nbsp;<span class="op" id="7759157">!</span><span class="ident" id="7759158">got</span><span class="op" id="7759161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7759165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7759168">}</span><br>
<span class="lineno"></span><span class="op" id="7759170">}</span>
</div>
</body>
</html>
