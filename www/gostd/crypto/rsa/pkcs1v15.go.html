<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rsa</h2>
<ul>
<li><a href="/gostd/crypto/rsa/pkcs1v15.go.html">pkcs1v15.go</a></li>
<li><a href="/gostd/crypto/rsa/pkcs1v15_test.go.html">pkcs1v15_test.go</a></li>
<li><a href="/gostd/crypto/rsa/pss.go.html">pss.go</a></li>
<li><a href="/gostd/crypto/rsa/pss_test.go.html">pss_test.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa.go.html">rsa.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa_test.go.html">rsa_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4346812">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4346867">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4346921">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4346972">package</span>&nbsp;<span class="ident" id="4346980">rsa</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4346985">import</span>&nbsp;<span class="op" id="4346992">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4346995">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4347005">&#34;crypto/subtle&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4347022">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4347032">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4347038">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="4347049">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="4347052">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;encryption&nbsp;and&nbsp;decryption&nbsp;using&nbsp;PKCS#1&nbsp;v1.5&nbsp;padding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4347130">//&nbsp;EncryptPKCS1v15&nbsp;encrypts&nbsp;the&nbsp;given&nbsp;message&nbsp;with&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4347226">//&nbsp;The&nbsp;message&nbsp;must&nbsp;be&nbsp;no&nbsp;longer&nbsp;than&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;public&nbsp;modulus&nbsp;minus&nbsp;11&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="4347313">//&nbsp;WARNING:&nbsp;use&nbsp;of&nbsp;this&nbsp;function&nbsp;to&nbsp;encrypt&nbsp;plaintexts&nbsp;other&nbsp;than&nbsp;session&nbsp;keys</span><br>
<span class="lineno">20</span><span class="comment" id="4347392">//&nbsp;is&nbsp;dangerous.&nbsp;Use&nbsp;RSA&nbsp;OAEP&nbsp;in&nbsp;new&nbsp;protocols.</span><br>
<span class="lineno"></span><span class="keyword" id="4347440">func</span>&nbsp;<span class="ident" id="4347445">EncryptPKCS1v15</span><span class="op" id="4347460">(</span><span class="ident" id="4347461">rand</span>&nbsp;<span class="ident" id="4347466">io</span><span class="op" id="4347468">.</span><span class="ident" id="4347469">Reader</span><span class="op" id="4347475">,</span>&nbsp;<span class="ident" id="4347477">pub</span>&nbsp;<span class="op" id="4347481">*</span><span class="ident" id="4347482">PublicKey</span><span class="op" id="4347491">,</span>&nbsp;<span class="ident" id="4347493">msg</span>&nbsp;<span class="op" id="4347497">[</span><span class="op" id="4347498">]</span><span class="builtintype" id="4347499">byte</span><span class="op" id="4347503">)</span>&nbsp;<span class="op" id="4347505">(</span><span class="ident" id="4347506">out</span>&nbsp;<span class="op" id="4347510">[</span><span class="op" id="4347511">]</span><span class="builtintype" id="4347512">byte</span><span class="op" id="4347516">,</span>&nbsp;<span class="ident" id="4347518">err</span>&nbsp;<span class="builtintype" id="4347522">error</span><span class="op" id="4347527">)</span>&nbsp;<span class="op" id="4347529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4347532">if</span>&nbsp;<span class="ident" id="4347535">err</span>&nbsp;<span class="op" id="4347539">:=</span>&nbsp;<span class="ident" id="4347542">checkPub</span><span class="op" id="4347550">(</span><span class="ident" id="4347551">pub</span><span class="op" id="4347554">)</span><span class="op" id="4347555">;</span>&nbsp;<span class="ident" id="4347557">err</span>&nbsp;<span class="op" id="4347561">!=</span>&nbsp;<span class="ident" id="4347564">nil</span>&nbsp;<span class="op" id="4347568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4347572">return</span>&nbsp;<span class="ident" id="4347579">nil</span><span class="op" id="4347582">,</span>&nbsp;<span class="ident" id="4347584">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4347589">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4347592">k</span>&nbsp;<span class="op" id="4347594">:=</span>&nbsp;<span class="op" id="4347597">(</span><span class="ident" id="4347598">pub</span><span class="op" id="4347601">.</span><span class="ident" id="4347602">N</span><span class="op" id="4347603">.</span><span class="ident" id="4347604">BitLen</span><span class="op" id="4347610">(</span><span class="op" id="4347611">)</span>&nbsp;<span class="op" id="4347613">+</span>&nbsp;<span class="num" id="4347615">7</span><span class="op" id="4347616">)</span>&nbsp;<span class="op" id="4347618">/</span>&nbsp;<span class="num" id="4347620">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4347623">if</span>&nbsp;<span class="builtinfunc" id="4347626">len</span><span class="op" id="4347629">(</span><span class="ident" id="4347630">msg</span><span class="op" id="4347633">)</span>&nbsp;<span class="op" id="4347635">&gt;</span>&nbsp;<span class="ident" id="4347637">k</span><span class="op" id="4347638">-</span><span class="num" id="4347639">11</span>&nbsp;<span class="op" id="4347642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4347646">err</span>&nbsp;<span class="op" id="4347650">=</span>&nbsp;<span class="ident" id="4347652">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4347672">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4347680">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4347684">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x02&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;M</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4347725">em</span>&nbsp;<span class="op" id="4347728">:=</span>&nbsp;<span class="builtinfunc" id="4347731">make</span><span class="op" id="4347735">(</span><span class="op" id="4347736">[</span><span class="op" id="4347737">]</span><span class="builtintype" id="4347738">byte</span><span class="op" id="4347742">,</span>&nbsp;<span class="ident" id="4347744">k</span><span class="op" id="4347745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4347748">em</span><span class="op" id="4347750">[</span><span class="num" id="4347751">1</span><span class="op" id="4347752">]</span>&nbsp;<span class="op" id="4347754">=</span>&nbsp;<span class="num" id="4347756">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4347759">ps</span><span class="op" id="4347761">,</span>&nbsp;<span class="ident" id="4347763">mm</span>&nbsp;<span class="op" id="4347766">:=</span>&nbsp;<span class="ident" id="4347769">em</span><span class="op" id="4347771">[</span><span class="num" id="4347772">2</span><span class="op" id="4347773">:</span><span class="builtinfunc" id="4347774">len</span><span class="op" id="4347777">(</span><span class="ident" id="4347778">em</span><span class="op" id="4347780">)</span><span class="op" id="4347781">-</span><span class="builtinfunc" id="4347782">len</span><span class="op" id="4347785">(</span><span class="ident" id="4347786">msg</span><span class="op" id="4347789">)</span><span class="op" id="4347790">-</span><span class="num" id="4347791">1</span><span class="op" id="4347792">]</span><span class="op" id="4347793">,</span>&nbsp;<span class="ident" id="4347795">em</span><span class="op" id="4347797">[</span><span class="builtinfunc" id="4347798">len</span><span class="op" id="4347801">(</span><span class="ident" id="4347802">em</span><span class="op" id="4347804">)</span><span class="op" id="4347805">-</span><span class="builtinfunc" id="4347806">len</span><span class="op" id="4347809">(</span><span class="ident" id="4347810">msg</span><span class="op" id="4347813">)</span><span class="op" id="4347814">:</span><span class="op" id="4347815">]</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4347818">err</span>&nbsp;<span class="op" id="4347822">=</span>&nbsp;<span class="ident" id="4347824">nonZeroRandomBytes</span><span class="op" id="4347842">(</span><span class="ident" id="4347843">ps</span><span class="op" id="4347845">,</span>&nbsp;<span class="ident" id="4347847">rand</span><span class="op" id="4347851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4347854">if</span>&nbsp;<span class="ident" id="4347857">err</span>&nbsp;<span class="op" id="4347861">!=</span>&nbsp;<span class="ident" id="4347864">nil</span>&nbsp;<span class="op" id="4347868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4347872">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4347880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4347883">em</span><span class="op" id="4347885">[</span><span class="builtinfunc" id="4347886">len</span><span class="op" id="4347889">(</span><span class="ident" id="4347890">em</span><span class="op" id="4347892">)</span><span class="op" id="4347893">-</span><span class="builtinfunc" id="4347894">len</span><span class="op" id="4347897">(</span><span class="ident" id="4347898">msg</span><span class="op" id="4347901">)</span><span class="op" id="4347902">-</span><span class="num" id="4347903">1</span><span class="op" id="4347904">]</span>&nbsp;<span class="op" id="4347906">=</span>&nbsp;<span class="num" id="4347908">0</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4347911">copy</span><span class="op" id="4347915">(</span><span class="ident" id="4347916">mm</span><span class="op" id="4347918">,</span>&nbsp;<span class="ident" id="4347920">msg</span><span class="op" id="4347923">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4347927">m</span>&nbsp;<span class="op" id="4347929">:=</span>&nbsp;<span class="builtinfunc" id="4347932">new</span><span class="op" id="4347935">(</span><span class="ident" id="4347936">big</span><span class="op" id="4347939">.</span><span class="ident" id="4347940">Int</span><span class="op" id="4347943">)</span><span class="op" id="4347944">.</span><span class="ident" id="4347945">SetBytes</span><span class="op" id="4347953">(</span><span class="ident" id="4347954">em</span><span class="op" id="4347956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4347959">c</span>&nbsp;<span class="op" id="4347961">:=</span>&nbsp;<span class="ident" id="4347964">encrypt</span><span class="op" id="4347971">(</span><span class="builtinfunc" id="4347972">new</span><span class="op" id="4347975">(</span><span class="ident" id="4347976">big</span><span class="op" id="4347979">.</span><span class="ident" id="4347980">Int</span><span class="op" id="4347983">)</span><span class="op" id="4347984">,</span>&nbsp;<span class="ident" id="4347986">pub</span><span class="op" id="4347989">,</span>&nbsp;<span class="ident" id="4347991">m</span><span class="op" id="4347992">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4347996">copyWithLeftPad</span><span class="op" id="4348011">(</span><span class="ident" id="4348012">em</span><span class="op" id="4348014">,</span>&nbsp;<span class="ident" id="4348016">c</span><span class="op" id="4348017">.</span><span class="ident" id="4348018">Bytes</span><span class="op" id="4348023">(</span><span class="op" id="4348024">)</span><span class="op" id="4348025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4348028">out</span>&nbsp;<span class="op" id="4348032">=</span>&nbsp;<span class="ident" id="4348034">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348038">return</span><br>
<span class="lineno"></span><span class="op" id="4348045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4348048">//&nbsp;DecryptPKCS1v15&nbsp;decrypts&nbsp;a&nbsp;plaintext&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4348139">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="keyword" id="4348217">func</span>&nbsp;<span class="ident" id="4348222">DecryptPKCS1v15</span><span class="op" id="4348237">(</span><span class="ident" id="4348238">rand</span>&nbsp;<span class="ident" id="4348243">io</span><span class="op" id="4348245">.</span><span class="ident" id="4348246">Reader</span><span class="op" id="4348252">,</span>&nbsp;<span class="ident" id="4348254">priv</span>&nbsp;<span class="op" id="4348259">*</span><span class="ident" id="4348260">PrivateKey</span><span class="op" id="4348270">,</span>&nbsp;<span class="ident" id="4348272">ciphertext</span>&nbsp;<span class="op" id="4348283">[</span><span class="op" id="4348284">]</span><span class="builtintype" id="4348285">byte</span><span class="op" id="4348289">)</span>&nbsp;<span class="op" id="4348291">(</span><span class="ident" id="4348292">out</span>&nbsp;<span class="op" id="4348296">[</span><span class="op" id="4348297">]</span><span class="builtintype" id="4348298">byte</span><span class="op" id="4348302">,</span>&nbsp;<span class="ident" id="4348304">err</span>&nbsp;<span class="builtintype" id="4348308">error</span><span class="op" id="4348313">)</span>&nbsp;<span class="op" id="4348315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348318">if</span>&nbsp;<span class="ident" id="4348321">err</span>&nbsp;<span class="op" id="4348325">:=</span>&nbsp;<span class="ident" id="4348328">checkPub</span><span class="op" id="4348336">(</span><span class="op" id="4348337">&amp;</span><span class="ident" id="4348338">priv</span><span class="op" id="4348342">.</span><span class="ident" id="4348343">PublicKey</span><span class="op" id="4348352">)</span><span class="op" id="4348353">;</span>&nbsp;<span class="ident" id="4348355">err</span>&nbsp;<span class="op" id="4348359">!=</span>&nbsp;<span class="ident" id="4348362">nil</span>&nbsp;<span class="op" id="4348366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348370">return</span>&nbsp;<span class="ident" id="4348377">nil</span><span class="op" id="4348380">,</span>&nbsp;<span class="ident" id="4348382">err</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4348387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4348390">valid</span><span class="op" id="4348395">,</span>&nbsp;<span class="ident" id="4348397">out</span><span class="op" id="4348400">,</span>&nbsp;<span class="ident" id="4348402">index</span><span class="op" id="4348407">,</span>&nbsp;<span class="ident" id="4348409">err</span>&nbsp;<span class="op" id="4348413">:=</span>&nbsp;<span class="ident" id="4348416">decryptPKCS1v15</span><span class="op" id="4348431">(</span><span class="ident" id="4348432">rand</span><span class="op" id="4348436">,</span>&nbsp;<span class="ident" id="4348438">priv</span><span class="op" id="4348442">,</span>&nbsp;<span class="ident" id="4348444">ciphertext</span><span class="op" id="4348454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348457">if</span>&nbsp;<span class="ident" id="4348460">err</span>&nbsp;<span class="op" id="4348464">!=</span>&nbsp;<span class="ident" id="4348467">nil</span>&nbsp;<span class="op" id="4348471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348475">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4348483">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348486">if</span>&nbsp;<span class="ident" id="4348489">valid</span>&nbsp;<span class="op" id="4348495">==</span>&nbsp;<span class="num" id="4348498">0</span>&nbsp;<span class="op" id="4348500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348504">return</span>&nbsp;<span class="ident" id="4348511">nil</span><span class="op" id="4348514">,</span>&nbsp;<span class="ident" id="4348516">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4348531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4348534">out</span>&nbsp;<span class="op" id="4348538">=</span>&nbsp;<span class="ident" id="4348540">out</span><span class="op" id="4348543">[</span><span class="ident" id="4348544">index</span><span class="op" id="4348549">:</span><span class="op" id="4348550">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348553">return</span><br>
<span class="lineno">65</span><span class="op" id="4348560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4348563">//&nbsp;DecryptPKCS1v15SessionKey&nbsp;decrypts&nbsp;a&nbsp;session&nbsp;key&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4348666">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="comment" id="4348744">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;ciphertext&nbsp;is&nbsp;the&nbsp;wrong&nbsp;length&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="4348815">//&nbsp;ciphertext&nbsp;is&nbsp;greater&nbsp;than&nbsp;the&nbsp;public&nbsp;modulus.&nbsp;Otherwise,&nbsp;no&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4348888">//&nbsp;returned.&nbsp;If&nbsp;the&nbsp;padding&nbsp;is&nbsp;valid,&nbsp;the&nbsp;resulting&nbsp;plaintext&nbsp;message&nbsp;is&nbsp;copied</span><br>
<span class="lineno"></span><span class="comment" id="4348968">//&nbsp;into&nbsp;key.&nbsp;Otherwise,&nbsp;key&nbsp;is&nbsp;unchanged.&nbsp;These&nbsp;alternatives&nbsp;occur&nbsp;in&nbsp;constant</span><br>
<span class="lineno"></span><span class="comment" id="4349047">//&nbsp;time.&nbsp;It&nbsp;is&nbsp;intended&nbsp;that&nbsp;the&nbsp;user&nbsp;of&nbsp;this&nbsp;function&nbsp;generate&nbsp;a&nbsp;random</span><br>
<span class="lineno"></span><span class="comment" id="4349120">//&nbsp;session&nbsp;key&nbsp;beforehand&nbsp;and&nbsp;continue&nbsp;the&nbsp;protocol&nbsp;with&nbsp;the&nbsp;resulting&nbsp;value.</span><br>
<span class="lineno">75</span><span class="comment" id="4349198">//&nbsp;This&nbsp;will&nbsp;remove&nbsp;any&nbsp;possibility&nbsp;that&nbsp;an&nbsp;attacker&nbsp;can&nbsp;learn&nbsp;any&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="4349277">//&nbsp;about&nbsp;the&nbsp;plaintext.</span><br>
<span class="lineno"></span><span class="comment" id="4349301">//&nbsp;See&nbsp;``Chosen&nbsp;Ciphertext&nbsp;Attacks&nbsp;Against&nbsp;Protocols&nbsp;Based&nbsp;on&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span><span class="comment" id="4349371">//&nbsp;Encryption&nbsp;Standard&nbsp;PKCS&nbsp;#1&#39;&#39;,&nbsp;Daniel&nbsp;Bleichenbacher,&nbsp;Advances&nbsp;in&nbsp;Cryptology</span><br>
<span class="lineno"></span><span class="comment" id="4349451">//&nbsp;(Crypto&nbsp;&#39;98).</span><br>
<span class="lineno">80</span><span class="keyword" id="4349468">func</span>&nbsp;<span class="ident" id="4349473">DecryptPKCS1v15SessionKey</span><span class="op" id="4349498">(</span><span class="ident" id="4349499">rand</span>&nbsp;<span class="ident" id="4349504">io</span><span class="op" id="4349506">.</span><span class="ident" id="4349507">Reader</span><span class="op" id="4349513">,</span>&nbsp;<span class="ident" id="4349515">priv</span>&nbsp;<span class="op" id="4349520">*</span><span class="ident" id="4349521">PrivateKey</span><span class="op" id="4349531">,</span>&nbsp;<span class="ident" id="4349533">ciphertext</span>&nbsp;<span class="op" id="4349544">[</span><span class="op" id="4349545">]</span><span class="builtintype" id="4349546">byte</span><span class="op" id="4349550">,</span>&nbsp;<span class="ident" id="4349552">key</span>&nbsp;<span class="op" id="4349556">[</span><span class="op" id="4349557">]</span><span class="builtintype" id="4349558">byte</span><span class="op" id="4349562">)</span>&nbsp;<span class="op" id="4349564">(</span><span class="ident" id="4349565">err</span>&nbsp;<span class="builtintype" id="4349569">error</span><span class="op" id="4349574">)</span>&nbsp;<span class="op" id="4349576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4349579">if</span>&nbsp;<span class="ident" id="4349582">err</span>&nbsp;<span class="op" id="4349586">:=</span>&nbsp;<span class="ident" id="4349589">checkPub</span><span class="op" id="4349597">(</span><span class="op" id="4349598">&amp;</span><span class="ident" id="4349599">priv</span><span class="op" id="4349603">.</span><span class="ident" id="4349604">PublicKey</span><span class="op" id="4349613">)</span><span class="op" id="4349614">;</span>&nbsp;<span class="ident" id="4349616">err</span>&nbsp;<span class="op" id="4349620">!=</span>&nbsp;<span class="ident" id="4349623">nil</span>&nbsp;<span class="op" id="4349627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4349631">return</span>&nbsp;<span class="ident" id="4349638">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4349643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4349646">k</span>&nbsp;<span class="op" id="4349648">:=</span>&nbsp;<span class="op" id="4349651">(</span><span class="ident" id="4349652">priv</span><span class="op" id="4349656">.</span><span class="ident" id="4349657">N</span><span class="op" id="4349658">.</span><span class="ident" id="4349659">BitLen</span><span class="op" id="4349665">(</span><span class="op" id="4349666">)</span>&nbsp;<span class="op" id="4349668">+</span>&nbsp;<span class="num" id="4349670">7</span><span class="op" id="4349671">)</span>&nbsp;<span class="op" id="4349673">/</span>&nbsp;<span class="num" id="4349675">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4349678">if</span>&nbsp;<span class="ident" id="4349681">k</span><span class="op" id="4349682">-</span><span class="op" id="4349683">(</span><span class="builtinfunc" id="4349684">len</span><span class="op" id="4349687">(</span><span class="ident" id="4349688">key</span><span class="op" id="4349691">)</span><span class="op" id="4349692">+</span><span class="num" id="4349693">3</span><span class="op" id="4349694">+</span><span class="num" id="4349695">8</span><span class="op" id="4349696">)</span>&nbsp;<span class="op" id="4349698">&lt;</span>&nbsp;<span class="num" id="4349700">0</span>&nbsp;<span class="op" id="4349702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4349706">return</span>&nbsp;<span class="ident" id="4349713">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4349728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4349732">valid</span><span class="op" id="4349737">,</span>&nbsp;<span class="ident" id="4349739">em</span><span class="op" id="4349741">,</span>&nbsp;<span class="ident" id="4349743">index</span><span class="op" id="4349748">,</span>&nbsp;<span class="ident" id="4349750">err</span>&nbsp;<span class="op" id="4349754">:=</span>&nbsp;<span class="ident" id="4349757">decryptPKCS1v15</span><span class="op" id="4349772">(</span><span class="ident" id="4349773">rand</span><span class="op" id="4349777">,</span>&nbsp;<span class="ident" id="4349779">priv</span><span class="op" id="4349783">,</span>&nbsp;<span class="ident" id="4349785">ciphertext</span><span class="op" id="4349795">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4349798">if</span>&nbsp;<span class="ident" id="4349801">err</span>&nbsp;<span class="op" id="4349805">!=</span>&nbsp;<span class="ident" id="4349808">nil</span>&nbsp;<span class="op" id="4349812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4349816">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4349824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4349828">if</span>&nbsp;<span class="builtinfunc" id="4349831">len</span><span class="op" id="4349834">(</span><span class="ident" id="4349835">em</span><span class="op" id="4349837">)</span>&nbsp;<span class="op" id="4349839">!=</span>&nbsp;<span class="ident" id="4349842">k</span>&nbsp;<span class="op" id="4349844">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4349848">//&nbsp;This&nbsp;should&nbsp;be&nbsp;impossible&nbsp;because&nbsp;decryptPKCS1v15&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4349910">//&nbsp;returns&nbsp;the&nbsp;full&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4349939">return</span>&nbsp;<span class="ident" id="4349946">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4349961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4349965">valid</span>&nbsp;<span class="op" id="4349971">&amp;=</span>&nbsp;<span class="ident" id="4349974">subtle</span><span class="op" id="4349980">.</span><span class="ident" id="4349981">ConstantTimeEq</span><span class="op" id="4349995">(</span><span class="builtintype" id="4349996">int32</span><span class="op" id="4350001">(</span><span class="builtinfunc" id="4350002">len</span><span class="op" id="4350005">(</span><span class="ident" id="4350006">em</span><span class="op" id="4350008">)</span><span class="op" id="4350009">-</span><span class="ident" id="4350010">index</span><span class="op" id="4350015">)</span><span class="op" id="4350016">,</span>&nbsp;<span class="builtintype" id="4350018">int32</span><span class="op" id="4350023">(</span><span class="builtinfunc" id="4350024">len</span><span class="op" id="4350027">(</span><span class="ident" id="4350028">key</span><span class="op" id="4350031">)</span><span class="op" id="4350032">)</span><span class="op" id="4350033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4350036">subtle</span><span class="op" id="4350042">.</span><span class="ident" id="4350043">ConstantTimeCopy</span><span class="op" id="4350059">(</span><span class="ident" id="4350060">valid</span><span class="op" id="4350065">,</span>&nbsp;<span class="ident" id="4350067">key</span><span class="op" id="4350070">,</span>&nbsp;<span class="ident" id="4350072">em</span><span class="op" id="4350074">[</span><span class="builtinfunc" id="4350075">len</span><span class="op" id="4350078">(</span><span class="ident" id="4350079">em</span><span class="op" id="4350081">)</span><span class="op" id="4350082">-</span><span class="builtinfunc" id="4350083">len</span><span class="op" id="4350086">(</span><span class="ident" id="4350087">key</span><span class="op" id="4350090">)</span><span class="op" id="4350091">:</span><span class="op" id="4350092">]</span><span class="op" id="4350093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4350096">return</span><br>
<span class="lineno"></span><span class="op" id="4350103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4350106">//&nbsp;decryptPKCS1v15&nbsp;decrypts&nbsp;ciphertext&nbsp;using&nbsp;priv&nbsp;and&nbsp;blinds&nbsp;the&nbsp;operation&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4350184">//&nbsp;rand&nbsp;is&nbsp;not&nbsp;nil.&nbsp;It&nbsp;returns&nbsp;one&nbsp;or&nbsp;zero&nbsp;in&nbsp;valid&nbsp;that&nbsp;indicates&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4350263">//&nbsp;plaintext&nbsp;was&nbsp;correctly&nbsp;structured.&nbsp;In&nbsp;either&nbsp;case,&nbsp;the&nbsp;plaintext&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4350335">//&nbsp;returned&nbsp;in&nbsp;em&nbsp;so&nbsp;that&nbsp;it&nbsp;may&nbsp;be&nbsp;read&nbsp;independently&nbsp;of&nbsp;whether&nbsp;it&nbsp;was&nbsp;valid</span><br>
<span class="lineno"></span><span class="comment" id="4350414">//&nbsp;in&nbsp;order&nbsp;to&nbsp;maintain&nbsp;constant&nbsp;memory&nbsp;access&nbsp;patterns.&nbsp;If&nbsp;the&nbsp;plaintext&nbsp;was</span><br>
<span class="lineno">110</span><span class="comment" id="4350492">//&nbsp;valid&nbsp;then&nbsp;index&nbsp;contains&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;original&nbsp;message&nbsp;in&nbsp;em.</span><br>
<span class="lineno"></span><span class="keyword" id="4350562">func</span>&nbsp;<span class="ident" id="4350567">decryptPKCS1v15</span><span class="op" id="4350582">(</span><span class="ident" id="4350583">rand</span>&nbsp;<span class="ident" id="4350588">io</span><span class="op" id="4350590">.</span><span class="ident" id="4350591">Reader</span><span class="op" id="4350597">,</span>&nbsp;<span class="ident" id="4350599">priv</span>&nbsp;<span class="op" id="4350604">*</span><span class="ident" id="4350605">PrivateKey</span><span class="op" id="4350615">,</span>&nbsp;<span class="ident" id="4350617">ciphertext</span>&nbsp;<span class="op" id="4350628">[</span><span class="op" id="4350629">]</span><span class="builtintype" id="4350630">byte</span><span class="op" id="4350634">)</span>&nbsp;<span class="op" id="4350636">(</span><span class="ident" id="4350637">valid</span>&nbsp;<span class="builtintype" id="4350643">int</span><span class="op" id="4350646">,</span>&nbsp;<span class="ident" id="4350648">em</span>&nbsp;<span class="op" id="4350651">[</span><span class="op" id="4350652">]</span><span class="builtintype" id="4350653">byte</span><span class="op" id="4350657">,</span>&nbsp;<span class="ident" id="4350659">index</span>&nbsp;<span class="builtintype" id="4350665">int</span><span class="op" id="4350668">,</span>&nbsp;<span class="ident" id="4350670">err</span>&nbsp;<span class="builtintype" id="4350674">error</span><span class="op" id="4350679">)</span>&nbsp;<span class="op" id="4350681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4350684">k</span>&nbsp;<span class="op" id="4350686">:=</span>&nbsp;<span class="op" id="4350689">(</span><span class="ident" id="4350690">priv</span><span class="op" id="4350694">.</span><span class="ident" id="4350695">N</span><span class="op" id="4350696">.</span><span class="ident" id="4350697">BitLen</span><span class="op" id="4350703">(</span><span class="op" id="4350704">)</span>&nbsp;<span class="op" id="4350706">+</span>&nbsp;<span class="num" id="4350708">7</span><span class="op" id="4350709">)</span>&nbsp;<span class="op" id="4350711">/</span>&nbsp;<span class="num" id="4350713">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4350716">if</span>&nbsp;<span class="ident" id="4350719">k</span>&nbsp;<span class="op" id="4350721">&lt;</span>&nbsp;<span class="num" id="4350723">11</span>&nbsp;<span class="op" id="4350726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4350730">err</span>&nbsp;<span class="op" id="4350734">=</span>&nbsp;<span class="ident" id="4350736">ErrDecryption</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4350752">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4350760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4350764">c</span>&nbsp;<span class="op" id="4350766">:=</span>&nbsp;<span class="builtinfunc" id="4350769">new</span><span class="op" id="4350772">(</span><span class="ident" id="4350773">big</span><span class="op" id="4350776">.</span><span class="ident" id="4350777">Int</span><span class="op" id="4350780">)</span><span class="op" id="4350781">.</span><span class="ident" id="4350782">SetBytes</span><span class="op" id="4350790">(</span><span class="ident" id="4350791">ciphertext</span><span class="op" id="4350801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4350804">m</span><span class="op" id="4350805">,</span>&nbsp;<span class="ident" id="4350807">err</span>&nbsp;<span class="op" id="4350811">:=</span>&nbsp;<span class="ident" id="4350814">decrypt</span><span class="op" id="4350821">(</span><span class="ident" id="4350822">rand</span><span class="op" id="4350826">,</span>&nbsp;<span class="ident" id="4350828">priv</span><span class="op" id="4350832">,</span>&nbsp;<span class="ident" id="4350834">c</span><span class="op" id="4350835">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4350838">if</span>&nbsp;<span class="ident" id="4350841">err</span>&nbsp;<span class="op" id="4350845">!=</span>&nbsp;<span class="ident" id="4350848">nil</span>&nbsp;<span class="op" id="4350852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4350856">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4350864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4350868">em</span>&nbsp;<span class="op" id="4350871">=</span>&nbsp;<span class="ident" id="4350873">leftPad</span><span class="op" id="4350880">(</span><span class="ident" id="4350881">m</span><span class="op" id="4350882">.</span><span class="ident" id="4350883">Bytes</span><span class="op" id="4350888">(</span><span class="op" id="4350889">)</span><span class="op" id="4350890">,</span>&nbsp;<span class="ident" id="4350892">k</span><span class="op" id="4350893">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4350896">firstByteIsZero</span>&nbsp;<span class="op" id="4350912">:=</span>&nbsp;<span class="ident" id="4350915">subtle</span><span class="op" id="4350921">.</span><span class="ident" id="4350922">ConstantTimeByteEq</span><span class="op" id="4350940">(</span><span class="ident" id="4350941">em</span><span class="op" id="4350943">[</span><span class="num" id="4350944">0</span><span class="op" id="4350945">]</span><span class="op" id="4350946">,</span>&nbsp;<span class="num" id="4350948">0</span><span class="op" id="4350949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4350952">secondByteIsTwo</span>&nbsp;<span class="op" id="4350968">:=</span>&nbsp;<span class="ident" id="4350971">subtle</span><span class="op" id="4350977">.</span><span class="ident" id="4350978">ConstantTimeByteEq</span><span class="op" id="4350996">(</span><span class="ident" id="4350997">em</span><span class="op" id="4350999">[</span><span class="num" id="4351000">1</span><span class="op" id="4351001">]</span><span class="op" id="4351002">,</span>&nbsp;<span class="num" id="4351004">2</span><span class="op" id="4351005">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4351009">//&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;plaintext&nbsp;must&nbsp;be&nbsp;a&nbsp;string&nbsp;of&nbsp;non-zero&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4351080">//&nbsp;octets,&nbsp;followed&nbsp;by&nbsp;a&nbsp;0,&nbsp;followed&nbsp;by&nbsp;the&nbsp;message.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4351134">//&nbsp;&nbsp;&nbsp;lookingForIndex:&nbsp;1&nbsp;iff&nbsp;we&nbsp;are&nbsp;still&nbsp;looking&nbsp;for&nbsp;the&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4351198">//&nbsp;&nbsp;&nbsp;index:&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;first&nbsp;zero&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351246">lookingForIndex</span>&nbsp;<span class="op" id="4351262">:=</span>&nbsp;<span class="num" id="4351265">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4351269">for</span>&nbsp;<span class="ident" id="4351273">i</span>&nbsp;<span class="op" id="4351275">:=</span>&nbsp;<span class="num" id="4351278">2</span><span class="op" id="4351279">;</span>&nbsp;<span class="ident" id="4351281">i</span>&nbsp;<span class="op" id="4351283">&lt;</span>&nbsp;<span class="builtinfunc" id="4351285">len</span><span class="op" id="4351288">(</span><span class="ident" id="4351289">em</span><span class="op" id="4351291">)</span><span class="op" id="4351292">;</span>&nbsp;<span class="ident" id="4351294">i</span><span class="op" id="4351295">++</span>&nbsp;<span class="op" id="4351298">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351302">equals0</span>&nbsp;<span class="op" id="4351310">:=</span>&nbsp;<span class="ident" id="4351313">subtle</span><span class="op" id="4351319">.</span><span class="ident" id="4351320">ConstantTimeByteEq</span><span class="op" id="4351338">(</span><span class="ident" id="4351339">em</span><span class="op" id="4351341">[</span><span class="ident" id="4351342">i</span><span class="op" id="4351343">]</span><span class="op" id="4351344">,</span>&nbsp;<span class="num" id="4351346">0</span><span class="op" id="4351347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351351">index</span>&nbsp;<span class="op" id="4351357">=</span>&nbsp;<span class="ident" id="4351359">subtle</span><span class="op" id="4351365">.</span><span class="ident" id="4351366">ConstantTimeSelect</span><span class="op" id="4351384">(</span><span class="ident" id="4351385">lookingForIndex</span><span class="op" id="4351400">&amp;</span><span class="ident" id="4351401">equals0</span><span class="op" id="4351408">,</span>&nbsp;<span class="ident" id="4351410">i</span><span class="op" id="4351411">,</span>&nbsp;<span class="ident" id="4351413">index</span><span class="op" id="4351418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351422">lookingForIndex</span>&nbsp;<span class="op" id="4351438">=</span>&nbsp;<span class="ident" id="4351440">subtle</span><span class="op" id="4351446">.</span><span class="ident" id="4351447">ConstantTimeSelect</span><span class="op" id="4351465">(</span><span class="ident" id="4351466">equals0</span><span class="op" id="4351473">,</span>&nbsp;<span class="num" id="4351475">0</span><span class="op" id="4351476">,</span>&nbsp;<span class="ident" id="4351478">lookingForIndex</span><span class="op" id="4351493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4351496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4351500">//&nbsp;The&nbsp;PS&nbsp;padding&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;8&nbsp;bytes&nbsp;long,&nbsp;and&nbsp;it&nbsp;starts&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4351568">//&nbsp;bytes&nbsp;into&nbsp;em.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351587">validPS</span>&nbsp;<span class="op" id="4351595">:=</span>&nbsp;<span class="ident" id="4351598">subtle</span><span class="op" id="4351604">.</span><span class="ident" id="4351605">ConstantTimeLessOrEq</span><span class="op" id="4351625">(</span><span class="num" id="4351626">2</span><span class="op" id="4351627">+</span><span class="num" id="4351628">8</span><span class="op" id="4351629">,</span>&nbsp;<span class="ident" id="4351631">index</span><span class="op" id="4351636">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351640">valid</span>&nbsp;<span class="op" id="4351646">=</span>&nbsp;<span class="ident" id="4351648">firstByteIsZero</span>&nbsp;<span class="op" id="4351664">&amp;</span>&nbsp;<span class="ident" id="4351666">secondByteIsTwo</span>&nbsp;<span class="op" id="4351682">&amp;</span>&nbsp;<span class="op" id="4351684">(</span><span class="op" id="4351685">^</span><span class="ident" id="4351686">lookingForIndex</span>&nbsp;<span class="op" id="4351702">&amp;</span>&nbsp;<span class="num" id="4351704">1</span><span class="op" id="4351705">)</span>&nbsp;<span class="op" id="4351707">&amp;</span>&nbsp;<span class="ident" id="4351709">validPS</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351718">index</span>&nbsp;<span class="op" id="4351724">=</span>&nbsp;<span class="ident" id="4351726">subtle</span><span class="op" id="4351732">.</span><span class="ident" id="4351733">ConstantTimeSelect</span><span class="op" id="4351751">(</span><span class="ident" id="4351752">valid</span><span class="op" id="4351757">,</span>&nbsp;<span class="ident" id="4351759">index</span><span class="op" id="4351764">+</span><span class="num" id="4351765">1</span><span class="op" id="4351766">,</span>&nbsp;<span class="num" id="4351768">0</span><span class="op" id="4351769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4351772">return</span>&nbsp;<span class="ident" id="4351779">valid</span><span class="op" id="4351784">,</span>&nbsp;<span class="ident" id="4351786">em</span><span class="op" id="4351788">,</span>&nbsp;<span class="ident" id="4351790">index</span><span class="op" id="4351795">,</span>&nbsp;<span class="ident" id="4351797">nil</span><br>
<span class="lineno"></span><span class="op" id="4351801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4351804">//&nbsp;nonZeroRandomBytes&nbsp;fills&nbsp;the&nbsp;given&nbsp;slice&nbsp;with&nbsp;non-zero&nbsp;random&nbsp;octets.</span><br>
<span class="lineno">150</span><span class="keyword" id="4351877">func</span>&nbsp;<span class="ident" id="4351882">nonZeroRandomBytes</span><span class="op" id="4351900">(</span><span class="ident" id="4351901">s</span>&nbsp;<span class="op" id="4351903">[</span><span class="op" id="4351904">]</span><span class="builtintype" id="4351905">byte</span><span class="op" id="4351909">,</span>&nbsp;<span class="ident" id="4351911">rand</span>&nbsp;<span class="ident" id="4351916">io</span><span class="op" id="4351918">.</span><span class="ident" id="4351919">Reader</span><span class="op" id="4351925">)</span>&nbsp;<span class="op" id="4351927">(</span><span class="ident" id="4351928">err</span>&nbsp;<span class="builtintype" id="4351932">error</span><span class="op" id="4351937">)</span>&nbsp;<span class="op" id="4351939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351942">_</span><span class="op" id="4351943">,</span>&nbsp;<span class="ident" id="4351945">err</span>&nbsp;<span class="op" id="4351949">=</span>&nbsp;<span class="ident" id="4351951">io</span><span class="op" id="4351953">.</span><span class="ident" id="4351954">ReadFull</span><span class="op" id="4351962">(</span><span class="ident" id="4351963">rand</span><span class="op" id="4351967">,</span>&nbsp;<span class="ident" id="4351969">s</span><span class="op" id="4351970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4351973">if</span>&nbsp;<span class="ident" id="4351976">err</span>&nbsp;<span class="op" id="4351980">!=</span>&nbsp;<span class="ident" id="4351983">nil</span>&nbsp;<span class="op" id="4351987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4351991">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4351999">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4352003">for</span>&nbsp;<span class="ident" id="4352007">i</span>&nbsp;<span class="op" id="4352009">:=</span>&nbsp;<span class="num" id="4352012">0</span><span class="op" id="4352013">;</span>&nbsp;<span class="ident" id="4352015">i</span>&nbsp;<span class="op" id="4352017">&lt;</span>&nbsp;<span class="builtinfunc" id="4352019">len</span><span class="op" id="4352022">(</span><span class="ident" id="4352023">s</span><span class="op" id="4352024">)</span><span class="op" id="4352025">;</span>&nbsp;<span class="ident" id="4352027">i</span><span class="op" id="4352028">++</span>&nbsp;<span class="op" id="4352031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4352035">for</span>&nbsp;<span class="ident" id="4352039">s</span><span class="op" id="4352040">[</span><span class="ident" id="4352041">i</span><span class="op" id="4352042">]</span>&nbsp;<span class="op" id="4352044">==</span>&nbsp;<span class="num" id="4352047">0</span>&nbsp;<span class="op" id="4352049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352054">_</span><span class="op" id="4352055">,</span>&nbsp;<span class="ident" id="4352057">err</span>&nbsp;<span class="op" id="4352061">=</span>&nbsp;<span class="ident" id="4352063">io</span><span class="op" id="4352065">.</span><span class="ident" id="4352066">ReadFull</span><span class="op" id="4352074">(</span><span class="ident" id="4352075">rand</span><span class="op" id="4352079">,</span>&nbsp;<span class="ident" id="4352081">s</span><span class="op" id="4352082">[</span><span class="ident" id="4352083">i</span><span class="op" id="4352084">:</span><span class="ident" id="4352085">i</span><span class="op" id="4352086">+</span><span class="num" id="4352087">1</span><span class="op" id="4352088">]</span><span class="op" id="4352089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4352094">if</span>&nbsp;<span class="ident" id="4352097">err</span>&nbsp;<span class="op" id="4352101">!=</span>&nbsp;<span class="ident" id="4352104">nil</span>&nbsp;<span class="op" id="4352108">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4352114">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4352124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4352129">//&nbsp;In&nbsp;tests,&nbsp;the&nbsp;PRNG&nbsp;may&nbsp;return&nbsp;all&nbsp;zeros&nbsp;so&nbsp;we&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4352184">//&nbsp;this&nbsp;to&nbsp;break&nbsp;the&nbsp;loop.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352214">s</span><span class="op" id="4352215">[</span><span class="ident" id="4352216">i</span><span class="op" id="4352217">]</span>&nbsp;<span class="op" id="4352219">^=</span>&nbsp;<span class="num" id="4352222">0x42</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4352229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4352232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4352236">return</span><br>
<span class="lineno"></span><span class="op" id="4352243">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="4352246">//&nbsp;These&nbsp;are&nbsp;ASN1&nbsp;DER&nbsp;structures:</span><br>
<span class="lineno"></span><span class="comment" id="4352280">//&nbsp;&nbsp;&nbsp;DigestInfo&nbsp;::=&nbsp;SEQUENCE&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4352311">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digestAlgorithm&nbsp;AlgorithmIdentifier,</span><br>
<span class="lineno"></span><span class="comment" id="4352355">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digest&nbsp;OCTET&nbsp;STRING</span><br>
<span class="lineno">175</span><span class="comment" id="4352382">//&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4352389">//&nbsp;For&nbsp;performance,&nbsp;we&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;generic&nbsp;ASN1&nbsp;encoder.&nbsp;Rather,&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="4352459">//&nbsp;precompute&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;digest&nbsp;value&nbsp;that&nbsp;makes&nbsp;a&nbsp;valid&nbsp;ASN1&nbsp;DER&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4352537">//&nbsp;with&nbsp;the&nbsp;correct&nbsp;contents.</span><br>
<span class="lineno"></span><span class="keyword" id="4352567">var</span>&nbsp;<span class="ident" id="4352571">hashPrefixes</span>&nbsp;<span class="op" id="4352584">=</span>&nbsp;<span class="keyword" id="4352586">map</span><span class="op" id="4352589">[</span><span class="ident" id="4352590">crypto</span><span class="op" id="4352596">.</span><span class="ident" id="4352597">Hash</span><span class="op" id="4352601">]</span><span class="op" id="4352602">[</span><span class="op" id="4352603">]</span><span class="builtintype" id="4352604">byte</span><span class="op" id="4352608">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352611">crypto</span><span class="op" id="4352617">.</span><span class="ident" id="4352618">MD5</span><span class="op" id="4352621">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352629">{</span><span class="num" id="4352630">0x30</span><span class="op" id="4352634">,</span>&nbsp;<span class="num" id="4352636">0x20</span><span class="op" id="4352640">,</span>&nbsp;<span class="num" id="4352642">0x30</span><span class="op" id="4352646">,</span>&nbsp;<span class="num" id="4352648">0x0c</span><span class="op" id="4352652">,</span>&nbsp;<span class="num" id="4352654">0x06</span><span class="op" id="4352658">,</span>&nbsp;<span class="num" id="4352660">0x08</span><span class="op" id="4352664">,</span>&nbsp;<span class="num" id="4352666">0x2a</span><span class="op" id="4352670">,</span>&nbsp;<span class="num" id="4352672">0x86</span><span class="op" id="4352676">,</span>&nbsp;<span class="num" id="4352678">0x48</span><span class="op" id="4352682">,</span>&nbsp;<span class="num" id="4352684">0x86</span><span class="op" id="4352688">,</span>&nbsp;<span class="num" id="4352690">0xf7</span><span class="op" id="4352694">,</span>&nbsp;<span class="num" id="4352696">0x0d</span><span class="op" id="4352700">,</span>&nbsp;<span class="num" id="4352702">0x02</span><span class="op" id="4352706">,</span>&nbsp;<span class="num" id="4352708">0x05</span><span class="op" id="4352712">,</span>&nbsp;<span class="num" id="4352714">0x05</span><span class="op" id="4352718">,</span>&nbsp;<span class="num" id="4352720">0x00</span><span class="op" id="4352724">,</span>&nbsp;<span class="num" id="4352726">0x04</span><span class="op" id="4352730">,</span>&nbsp;<span class="num" id="4352732">0x10</span><span class="op" id="4352736">}</span><span class="op" id="4352737">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352740">crypto</span><span class="op" id="4352746">.</span><span class="ident" id="4352747">SHA1</span><span class="op" id="4352751">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352758">{</span><span class="num" id="4352759">0x30</span><span class="op" id="4352763">,</span>&nbsp;<span class="num" id="4352765">0x21</span><span class="op" id="4352769">,</span>&nbsp;<span class="num" id="4352771">0x30</span><span class="op" id="4352775">,</span>&nbsp;<span class="num" id="4352777">0x09</span><span class="op" id="4352781">,</span>&nbsp;<span class="num" id="4352783">0x06</span><span class="op" id="4352787">,</span>&nbsp;<span class="num" id="4352789">0x05</span><span class="op" id="4352793">,</span>&nbsp;<span class="num" id="4352795">0x2b</span><span class="op" id="4352799">,</span>&nbsp;<span class="num" id="4352801">0x0e</span><span class="op" id="4352805">,</span>&nbsp;<span class="num" id="4352807">0x03</span><span class="op" id="4352811">,</span>&nbsp;<span class="num" id="4352813">0x02</span><span class="op" id="4352817">,</span>&nbsp;<span class="num" id="4352819">0x1a</span><span class="op" id="4352823">,</span>&nbsp;<span class="num" id="4352825">0x05</span><span class="op" id="4352829">,</span>&nbsp;<span class="num" id="4352831">0x00</span><span class="op" id="4352835">,</span>&nbsp;<span class="num" id="4352837">0x04</span><span class="op" id="4352841">,</span>&nbsp;<span class="num" id="4352843">0x14</span><span class="op" id="4352847">}</span><span class="op" id="4352848">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352851">crypto</span><span class="op" id="4352857">.</span><span class="ident" id="4352858">SHA224</span><span class="op" id="4352864">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352869">{</span><span class="num" id="4352870">0x30</span><span class="op" id="4352874">,</span>&nbsp;<span class="num" id="4352876">0x2d</span><span class="op" id="4352880">,</span>&nbsp;<span class="num" id="4352882">0x30</span><span class="op" id="4352886">,</span>&nbsp;<span class="num" id="4352888">0x0d</span><span class="op" id="4352892">,</span>&nbsp;<span class="num" id="4352894">0x06</span><span class="op" id="4352898">,</span>&nbsp;<span class="num" id="4352900">0x09</span><span class="op" id="4352904">,</span>&nbsp;<span class="num" id="4352906">0x60</span><span class="op" id="4352910">,</span>&nbsp;<span class="num" id="4352912">0x86</span><span class="op" id="4352916">,</span>&nbsp;<span class="num" id="4352918">0x48</span><span class="op" id="4352922">,</span>&nbsp;<span class="num" id="4352924">0x01</span><span class="op" id="4352928">,</span>&nbsp;<span class="num" id="4352930">0x65</span><span class="op" id="4352934">,</span>&nbsp;<span class="num" id="4352936">0x03</span><span class="op" id="4352940">,</span>&nbsp;<span class="num" id="4352942">0x04</span><span class="op" id="4352946">,</span>&nbsp;<span class="num" id="4352948">0x02</span><span class="op" id="4352952">,</span>&nbsp;<span class="num" id="4352954">0x04</span><span class="op" id="4352958">,</span>&nbsp;<span class="num" id="4352960">0x05</span><span class="op" id="4352964">,</span>&nbsp;<span class="num" id="4352966">0x00</span><span class="op" id="4352970">,</span>&nbsp;<span class="num" id="4352972">0x04</span><span class="op" id="4352976">,</span>&nbsp;<span class="num" id="4352978">0x1c</span><span class="op" id="4352982">}</span><span class="op" id="4352983">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352986">crypto</span><span class="op" id="4352992">.</span><span class="ident" id="4352993">SHA256</span><span class="op" id="4352999">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4353004">{</span><span class="num" id="4353005">0x30</span><span class="op" id="4353009">,</span>&nbsp;<span class="num" id="4353011">0x31</span><span class="op" id="4353015">,</span>&nbsp;<span class="num" id="4353017">0x30</span><span class="op" id="4353021">,</span>&nbsp;<span class="num" id="4353023">0x0d</span><span class="op" id="4353027">,</span>&nbsp;<span class="num" id="4353029">0x06</span><span class="op" id="4353033">,</span>&nbsp;<span class="num" id="4353035">0x09</span><span class="op" id="4353039">,</span>&nbsp;<span class="num" id="4353041">0x60</span><span class="op" id="4353045">,</span>&nbsp;<span class="num" id="4353047">0x86</span><span class="op" id="4353051">,</span>&nbsp;<span class="num" id="4353053">0x48</span><span class="op" id="4353057">,</span>&nbsp;<span class="num" id="4353059">0x01</span><span class="op" id="4353063">,</span>&nbsp;<span class="num" id="4353065">0x65</span><span class="op" id="4353069">,</span>&nbsp;<span class="num" id="4353071">0x03</span><span class="op" id="4353075">,</span>&nbsp;<span class="num" id="4353077">0x04</span><span class="op" id="4353081">,</span>&nbsp;<span class="num" id="4353083">0x02</span><span class="op" id="4353087">,</span>&nbsp;<span class="num" id="4353089">0x01</span><span class="op" id="4353093">,</span>&nbsp;<span class="num" id="4353095">0x05</span><span class="op" id="4353099">,</span>&nbsp;<span class="num" id="4353101">0x00</span><span class="op" id="4353105">,</span>&nbsp;<span class="num" id="4353107">0x04</span><span class="op" id="4353111">,</span>&nbsp;<span class="num" id="4353113">0x20</span><span class="op" id="4353117">}</span><span class="op" id="4353118">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4353121">crypto</span><span class="op" id="4353127">.</span><span class="ident" id="4353128">SHA384</span><span class="op" id="4353134">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4353139">{</span><span class="num" id="4353140">0x30</span><span class="op" id="4353144">,</span>&nbsp;<span class="num" id="4353146">0x41</span><span class="op" id="4353150">,</span>&nbsp;<span class="num" id="4353152">0x30</span><span class="op" id="4353156">,</span>&nbsp;<span class="num" id="4353158">0x0d</span><span class="op" id="4353162">,</span>&nbsp;<span class="num" id="4353164">0x06</span><span class="op" id="4353168">,</span>&nbsp;<span class="num" id="4353170">0x09</span><span class="op" id="4353174">,</span>&nbsp;<span class="num" id="4353176">0x60</span><span class="op" id="4353180">,</span>&nbsp;<span class="num" id="4353182">0x86</span><span class="op" id="4353186">,</span>&nbsp;<span class="num" id="4353188">0x48</span><span class="op" id="4353192">,</span>&nbsp;<span class="num" id="4353194">0x01</span><span class="op" id="4353198">,</span>&nbsp;<span class="num" id="4353200">0x65</span><span class="op" id="4353204">,</span>&nbsp;<span class="num" id="4353206">0x03</span><span class="op" id="4353210">,</span>&nbsp;<span class="num" id="4353212">0x04</span><span class="op" id="4353216">,</span>&nbsp;<span class="num" id="4353218">0x02</span><span class="op" id="4353222">,</span>&nbsp;<span class="num" id="4353224">0x02</span><span class="op" id="4353228">,</span>&nbsp;<span class="num" id="4353230">0x05</span><span class="op" id="4353234">,</span>&nbsp;<span class="num" id="4353236">0x00</span><span class="op" id="4353240">,</span>&nbsp;<span class="num" id="4353242">0x04</span><span class="op" id="4353246">,</span>&nbsp;<span class="num" id="4353248">0x30</span><span class="op" id="4353252">}</span><span class="op" id="4353253">,</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4353256">crypto</span><span class="op" id="4353262">.</span><span class="ident" id="4353263">SHA512</span><span class="op" id="4353269">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4353274">{</span><span class="num" id="4353275">0x30</span><span class="op" id="4353279">,</span>&nbsp;<span class="num" id="4353281">0x51</span><span class="op" id="4353285">,</span>&nbsp;<span class="num" id="4353287">0x30</span><span class="op" id="4353291">,</span>&nbsp;<span class="num" id="4353293">0x0d</span><span class="op" id="4353297">,</span>&nbsp;<span class="num" id="4353299">0x06</span><span class="op" id="4353303">,</span>&nbsp;<span class="num" id="4353305">0x09</span><span class="op" id="4353309">,</span>&nbsp;<span class="num" id="4353311">0x60</span><span class="op" id="4353315">,</span>&nbsp;<span class="num" id="4353317">0x86</span><span class="op" id="4353321">,</span>&nbsp;<span class="num" id="4353323">0x48</span><span class="op" id="4353327">,</span>&nbsp;<span class="num" id="4353329">0x01</span><span class="op" id="4353333">,</span>&nbsp;<span class="num" id="4353335">0x65</span><span class="op" id="4353339">,</span>&nbsp;<span class="num" id="4353341">0x03</span><span class="op" id="4353345">,</span>&nbsp;<span class="num" id="4353347">0x04</span><span class="op" id="4353351">,</span>&nbsp;<span class="num" id="4353353">0x02</span><span class="op" id="4353357">,</span>&nbsp;<span class="num" id="4353359">0x03</span><span class="op" id="4353363">,</span>&nbsp;<span class="num" id="4353365">0x05</span><span class="op" id="4353369">,</span>&nbsp;<span class="num" id="4353371">0x00</span><span class="op" id="4353375">,</span>&nbsp;<span class="num" id="4353377">0x04</span><span class="op" id="4353381">,</span>&nbsp;<span class="num" id="4353383">0x40</span><span class="op" id="4353387">}</span><span class="op" id="4353388">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4353391">crypto</span><span class="op" id="4353397">.</span><span class="ident" id="4353398">MD5SHA1</span><span class="op" id="4353405">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4353409">{</span><span class="op" id="4353410">}</span><span class="op" id="4353411">,</span>&nbsp;<span class="comment" id="4353413">//&nbsp;A&nbsp;special&nbsp;TLS&nbsp;case&nbsp;which&nbsp;doesn&#39;t&nbsp;use&nbsp;an&nbsp;ASN1&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4353470">crypto</span><span class="op" id="4353476">.</span><span class="ident" id="4353477">RIPEMD160</span><span class="op" id="4353486">:</span>&nbsp;<span class="op" id="4353488">{</span><span class="num" id="4353489">0x30</span><span class="op" id="4353493">,</span>&nbsp;<span class="num" id="4353495">0x20</span><span class="op" id="4353499">,</span>&nbsp;<span class="num" id="4353501">0x30</span><span class="op" id="4353505">,</span>&nbsp;<span class="num" id="4353507">0x08</span><span class="op" id="4353511">,</span>&nbsp;<span class="num" id="4353513">0x06</span><span class="op" id="4353517">,</span>&nbsp;<span class="num" id="4353519">0x06</span><span class="op" id="4353523">,</span>&nbsp;<span class="num" id="4353525">0x28</span><span class="op" id="4353529">,</span>&nbsp;<span class="num" id="4353531">0xcf</span><span class="op" id="4353535">,</span>&nbsp;<span class="num" id="4353537">0x06</span><span class="op" id="4353541">,</span>&nbsp;<span class="num" id="4353543">0x03</span><span class="op" id="4353547">,</span>&nbsp;<span class="num" id="4353549">0x00</span><span class="op" id="4353553">,</span>&nbsp;<span class="num" id="4353555">0x31</span><span class="op" id="4353559">,</span>&nbsp;<span class="num" id="4353561">0x04</span><span class="op" id="4353565">,</span>&nbsp;<span class="num" id="4353567">0x14</span><span class="op" id="4353571">}</span><span class="op" id="4353572">,</span><br>
<span class="lineno"></span><span class="op" id="4353574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="comment" id="4353577">//&nbsp;SignPKCS1v15&nbsp;calculates&nbsp;the&nbsp;signature&nbsp;of&nbsp;hashed&nbsp;using&nbsp;RSASSA-PKCS1-V1_5-SIGN&nbsp;from&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4353679">//&nbsp;Note&nbsp;that&nbsp;hashed&nbsp;must&nbsp;be&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4353757">//&nbsp;given&nbsp;hash&nbsp;function.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero,&nbsp;hashed&nbsp;is&nbsp;signed&nbsp;directly.&nbsp;This&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="4353836">//&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4353878">func</span>&nbsp;<span class="ident" id="4353883">SignPKCS1v15</span><span class="op" id="4353895">(</span><span class="ident" id="4353896">rand</span>&nbsp;<span class="ident" id="4353901">io</span><span class="op" id="4353903">.</span><span class="ident" id="4353904">Reader</span><span class="op" id="4353910">,</span>&nbsp;<span class="ident" id="4353912">priv</span>&nbsp;<span class="op" id="4353917">*</span><span class="ident" id="4353918">PrivateKey</span><span class="op" id="4353928">,</span>&nbsp;<span class="ident" id="4353930">hash</span>&nbsp;<span class="ident" id="4353935">crypto</span><span class="op" id="4353941">.</span><span class="ident" id="4353942">Hash</span><span class="op" id="4353946">,</span>&nbsp;<span class="ident" id="4353948">hashed</span>&nbsp;<span class="op" id="4353955">[</span><span class="op" id="4353956">]</span><span class="builtintype" id="4353957">byte</span><span class="op" id="4353961">)</span>&nbsp;<span class="op" id="4353963">(</span><span class="ident" id="4353964">s</span>&nbsp;<span class="op" id="4353966">[</span><span class="op" id="4353967">]</span><span class="builtintype" id="4353968">byte</span><span class="op" id="4353972">,</span>&nbsp;<span class="ident" id="4353974">err</span>&nbsp;<span class="builtintype" id="4353978">error</span><span class="op" id="4353983">)</span>&nbsp;<span class="op" id="4353985">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4353988">hashLen</span><span class="op" id="4353995">,</span>&nbsp;<span class="ident" id="4353997">prefix</span><span class="op" id="4354003">,</span>&nbsp;<span class="ident" id="4354005">err</span>&nbsp;<span class="op" id="4354009">:=</span>&nbsp;<span class="ident" id="4354012">pkcs1v15HashInfo</span><span class="op" id="4354028">(</span><span class="ident" id="4354029">hash</span><span class="op" id="4354033">,</span>&nbsp;<span class="builtinfunc" id="4354035">len</span><span class="op" id="4354038">(</span><span class="ident" id="4354039">hashed</span><span class="op" id="4354045">)</span><span class="op" id="4354046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4354049">if</span>&nbsp;<span class="ident" id="4354052">err</span>&nbsp;<span class="op" id="4354056">!=</span>&nbsp;<span class="ident" id="4354059">nil</span>&nbsp;<span class="op" id="4354063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4354067">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4354075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4354079">tLen</span>&nbsp;<span class="op" id="4354084">:=</span>&nbsp;<span class="builtinfunc" id="4354087">len</span><span class="op" id="4354090">(</span><span class="ident" id="4354091">prefix</span><span class="op" id="4354097">)</span>&nbsp;<span class="op" id="4354099">+</span>&nbsp;<span class="ident" id="4354101">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4354110">k</span>&nbsp;<span class="op" id="4354112">:=</span>&nbsp;<span class="op" id="4354115">(</span><span class="ident" id="4354116">priv</span><span class="op" id="4354120">.</span><span class="ident" id="4354121">N</span><span class="op" id="4354122">.</span><span class="ident" id="4354123">BitLen</span><span class="op" id="4354129">(</span><span class="op" id="4354130">)</span>&nbsp;<span class="op" id="4354132">+</span>&nbsp;<span class="num" id="4354134">7</span><span class="op" id="4354135">)</span>&nbsp;<span class="op" id="4354137">/</span>&nbsp;<span class="num" id="4354139">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4354142">if</span>&nbsp;<span class="ident" id="4354145">k</span>&nbsp;<span class="op" id="4354147">&lt;</span>&nbsp;<span class="ident" id="4354149">tLen</span><span class="op" id="4354153">+</span><span class="num" id="4354154">11</span>&nbsp;<span class="op" id="4354157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4354161">return</span>&nbsp;<span class="ident" id="4354168">nil</span><span class="op" id="4354171">,</span>&nbsp;<span class="ident" id="4354173">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4354192">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4354196">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4354237">em</span>&nbsp;<span class="op" id="4354240">:=</span>&nbsp;<span class="builtinfunc" id="4354243">make</span><span class="op" id="4354247">(</span><span class="op" id="4354248">[</span><span class="op" id="4354249">]</span><span class="builtintype" id="4354250">byte</span><span class="op" id="4354254">,</span>&nbsp;<span class="ident" id="4354256">k</span><span class="op" id="4354257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4354260">em</span><span class="op" id="4354262">[</span><span class="num" id="4354263">1</span><span class="op" id="4354264">]</span>&nbsp;<span class="op" id="4354266">=</span>&nbsp;<span class="num" id="4354268">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4354271">for</span>&nbsp;<span class="ident" id="4354275">i</span>&nbsp;<span class="op" id="4354277">:=</span>&nbsp;<span class="num" id="4354280">2</span><span class="op" id="4354281">;</span>&nbsp;<span class="ident" id="4354283">i</span>&nbsp;<span class="op" id="4354285">&lt;</span>&nbsp;<span class="ident" id="4354287">k</span><span class="op" id="4354288">-</span><span class="ident" id="4354289">tLen</span><span class="op" id="4354293">-</span><span class="num" id="4354294">1</span><span class="op" id="4354295">;</span>&nbsp;<span class="ident" id="4354297">i</span><span class="op" id="4354298">++</span>&nbsp;<span class="op" id="4354301">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4354305">em</span><span class="op" id="4354307">[</span><span class="ident" id="4354308">i</span><span class="op" id="4354309">]</span>&nbsp;<span class="op" id="4354311">=</span>&nbsp;<span class="num" id="4354313">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4354319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4354322">copy</span><span class="op" id="4354326">(</span><span class="ident" id="4354327">em</span><span class="op" id="4354329">[</span><span class="ident" id="4354330">k</span><span class="op" id="4354331">-</span><span class="ident" id="4354332">tLen</span><span class="op" id="4354336">:</span><span class="ident" id="4354337">k</span><span class="op" id="4354338">-</span><span class="ident" id="4354339">hashLen</span><span class="op" id="4354346">]</span><span class="op" id="4354347">,</span>&nbsp;<span class="ident" id="4354349">prefix</span><span class="op" id="4354355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4354358">copy</span><span class="op" id="4354362">(</span><span class="ident" id="4354363">em</span><span class="op" id="4354365">[</span><span class="ident" id="4354366">k</span><span class="op" id="4354367">-</span><span class="ident" id="4354368">hashLen</span><span class="op" id="4354375">:</span><span class="ident" id="4354376">k</span><span class="op" id="4354377">]</span><span class="op" id="4354378">,</span>&nbsp;<span class="ident" id="4354380">hashed</span><span class="op" id="4354386">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4354390">m</span>&nbsp;<span class="op" id="4354392">:=</span>&nbsp;<span class="builtinfunc" id="4354395">new</span><span class="op" id="4354398">(</span><span class="ident" id="4354399">big</span><span class="op" id="4354402">.</span><span class="ident" id="4354403">Int</span><span class="op" id="4354406">)</span><span class="op" id="4354407">.</span><span class="ident" id="4354408">SetBytes</span><span class="op" id="4354416">(</span><span class="ident" id="4354417">em</span><span class="op" id="4354419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4354422">c</span><span class="op" id="4354423">,</span>&nbsp;<span class="ident" id="4354425">err</span>&nbsp;<span class="op" id="4354429">:=</span>&nbsp;<span class="ident" id="4354432">decrypt</span><span class="op" id="4354439">(</span><span class="ident" id="4354440">rand</span><span class="op" id="4354444">,</span>&nbsp;<span class="ident" id="4354446">priv</span><span class="op" id="4354450">,</span>&nbsp;<span class="ident" id="4354452">m</span><span class="op" id="4354453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4354456">if</span>&nbsp;<span class="ident" id="4354459">err</span>&nbsp;<span class="op" id="4354463">!=</span>&nbsp;<span class="ident" id="4354466">nil</span>&nbsp;<span class="op" id="4354470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4354474">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4354482">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4354486">copyWithLeftPad</span><span class="op" id="4354501">(</span><span class="ident" id="4354502">em</span><span class="op" id="4354504">,</span>&nbsp;<span class="ident" id="4354506">c</span><span class="op" id="4354507">.</span><span class="ident" id="4354508">Bytes</span><span class="op" id="4354513">(</span><span class="op" id="4354514">)</span><span class="op" id="4354515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4354518">s</span>&nbsp;<span class="op" id="4354520">=</span>&nbsp;<span class="ident" id="4354522">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4354526">return</span><br>
<span class="lineno"></span><span class="op" id="4354533">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="4354536">//&nbsp;VerifyPKCS1v15&nbsp;verifies&nbsp;an&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5&nbsp;signature.</span><br>
<span class="lineno"></span><span class="comment" id="4354593">//&nbsp;hashed&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the&nbsp;given&nbsp;hash</span><br>
<span class="lineno"></span><span class="comment" id="4354667">//&nbsp;function&nbsp;and&nbsp;sig&nbsp;is&nbsp;the&nbsp;signature.&nbsp;A&nbsp;valid&nbsp;signature&nbsp;is&nbsp;indicated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4354739">//&nbsp;returning&nbsp;a&nbsp;nil&nbsp;error.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero&nbsp;then&nbsp;hashed&nbsp;is&nbsp;used&nbsp;directly.&nbsp;This</span><br>
<span class="lineno">230</span><span class="comment" id="4354816">//&nbsp;isn&#39;t&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4354864">func</span>&nbsp;<span class="ident" id="4354869">VerifyPKCS1v15</span><span class="op" id="4354883">(</span><span class="ident" id="4354884">pub</span>&nbsp;<span class="op" id="4354888">*</span><span class="ident" id="4354889">PublicKey</span><span class="op" id="4354898">,</span>&nbsp;<span class="ident" id="4354900">hash</span>&nbsp;<span class="ident" id="4354905">crypto</span><span class="op" id="4354911">.</span><span class="ident" id="4354912">Hash</span><span class="op" id="4354916">,</span>&nbsp;<span class="ident" id="4354918">hashed</span>&nbsp;<span class="op" id="4354925">[</span><span class="op" id="4354926">]</span><span class="builtintype" id="4354927">byte</span><span class="op" id="4354931">,</span>&nbsp;<span class="ident" id="4354933">sig</span>&nbsp;<span class="op" id="4354937">[</span><span class="op" id="4354938">]</span><span class="builtintype" id="4354939">byte</span><span class="op" id="4354943">)</span>&nbsp;<span class="op" id="4354945">(</span><span class="ident" id="4354946">err</span>&nbsp;<span class="builtintype" id="4354950">error</span><span class="op" id="4354955">)</span>&nbsp;<span class="op" id="4354957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4354960">hashLen</span><span class="op" id="4354967">,</span>&nbsp;<span class="ident" id="4354969">prefix</span><span class="op" id="4354975">,</span>&nbsp;<span class="ident" id="4354977">err</span>&nbsp;<span class="op" id="4354981">:=</span>&nbsp;<span class="ident" id="4354984">pkcs1v15HashInfo</span><span class="op" id="4355000">(</span><span class="ident" id="4355001">hash</span><span class="op" id="4355005">,</span>&nbsp;<span class="builtinfunc" id="4355007">len</span><span class="op" id="4355010">(</span><span class="ident" id="4355011">hashed</span><span class="op" id="4355017">)</span><span class="op" id="4355018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4355021">if</span>&nbsp;<span class="ident" id="4355024">err</span>&nbsp;<span class="op" id="4355028">!=</span>&nbsp;<span class="ident" id="4355031">nil</span>&nbsp;<span class="op" id="4355035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4355039">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4355047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4355051">tLen</span>&nbsp;<span class="op" id="4355056">:=</span>&nbsp;<span class="builtinfunc" id="4355059">len</span><span class="op" id="4355062">(</span><span class="ident" id="4355063">prefix</span><span class="op" id="4355069">)</span>&nbsp;<span class="op" id="4355071">+</span>&nbsp;<span class="ident" id="4355073">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4355082">k</span>&nbsp;<span class="op" id="4355084">:=</span>&nbsp;<span class="op" id="4355087">(</span><span class="ident" id="4355088">pub</span><span class="op" id="4355091">.</span><span class="ident" id="4355092">N</span><span class="op" id="4355093">.</span><span class="ident" id="4355094">BitLen</span><span class="op" id="4355100">(</span><span class="op" id="4355101">)</span>&nbsp;<span class="op" id="4355103">+</span>&nbsp;<span class="num" id="4355105">7</span><span class="op" id="4355106">)</span>&nbsp;<span class="op" id="4355108">/</span>&nbsp;<span class="num" id="4355110">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4355113">if</span>&nbsp;<span class="ident" id="4355116">k</span>&nbsp;<span class="op" id="4355118">&lt;</span>&nbsp;<span class="ident" id="4355120">tLen</span><span class="op" id="4355124">+</span><span class="num" id="4355125">11</span>&nbsp;<span class="op" id="4355128">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4355132">err</span>&nbsp;<span class="op" id="4355136">=</span>&nbsp;<span class="ident" id="4355138">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4355156">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4355164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4355168">c</span>&nbsp;<span class="op" id="4355170">:=</span>&nbsp;<span class="builtinfunc" id="4355173">new</span><span class="op" id="4355176">(</span><span class="ident" id="4355177">big</span><span class="op" id="4355180">.</span><span class="ident" id="4355181">Int</span><span class="op" id="4355184">)</span><span class="op" id="4355185">.</span><span class="ident" id="4355186">SetBytes</span><span class="op" id="4355194">(</span><span class="ident" id="4355195">sig</span><span class="op" id="4355198">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4355201">m</span>&nbsp;<span class="op" id="4355203">:=</span>&nbsp;<span class="ident" id="4355206">encrypt</span><span class="op" id="4355213">(</span><span class="builtinfunc" id="4355214">new</span><span class="op" id="4355217">(</span><span class="ident" id="4355218">big</span><span class="op" id="4355221">.</span><span class="ident" id="4355222">Int</span><span class="op" id="4355225">)</span><span class="op" id="4355226">,</span>&nbsp;<span class="ident" id="4355228">pub</span><span class="op" id="4355231">,</span>&nbsp;<span class="ident" id="4355233">c</span><span class="op" id="4355234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4355237">em</span>&nbsp;<span class="op" id="4355240">:=</span>&nbsp;<span class="ident" id="4355243">leftPad</span><span class="op" id="4355250">(</span><span class="ident" id="4355251">m</span><span class="op" id="4355252">.</span><span class="ident" id="4355253">Bytes</span><span class="op" id="4355258">(</span><span class="op" id="4355259">)</span><span class="op" id="4355260">,</span>&nbsp;<span class="ident" id="4355262">k</span><span class="op" id="4355263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4355266">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4355308">ok</span>&nbsp;<span class="op" id="4355311">:=</span>&nbsp;<span class="ident" id="4355314">subtle</span><span class="op" id="4355320">.</span><span class="ident" id="4355321">ConstantTimeByteEq</span><span class="op" id="4355339">(</span><span class="ident" id="4355340">em</span><span class="op" id="4355342">[</span><span class="num" id="4355343">0</span><span class="op" id="4355344">]</span><span class="op" id="4355345">,</span>&nbsp;<span class="num" id="4355347">0</span><span class="op" id="4355348">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4355351">ok</span>&nbsp;<span class="op" id="4355354">&amp;=</span>&nbsp;<span class="ident" id="4355357">subtle</span><span class="op" id="4355363">.</span><span class="ident" id="4355364">ConstantTimeByteEq</span><span class="op" id="4355382">(</span><span class="ident" id="4355383">em</span><span class="op" id="4355385">[</span><span class="num" id="4355386">1</span><span class="op" id="4355387">]</span><span class="op" id="4355388">,</span>&nbsp;<span class="num" id="4355390">1</span><span class="op" id="4355391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4355394">ok</span>&nbsp;<span class="op" id="4355397">&amp;=</span>&nbsp;<span class="ident" id="4355400">subtle</span><span class="op" id="4355406">.</span><span class="ident" id="4355407">ConstantTimeCompare</span><span class="op" id="4355426">(</span><span class="ident" id="4355427">em</span><span class="op" id="4355429">[</span><span class="ident" id="4355430">k</span><span class="op" id="4355431">-</span><span class="ident" id="4355432">hashLen</span><span class="op" id="4355439">:</span><span class="ident" id="4355440">k</span><span class="op" id="4355441">]</span><span class="op" id="4355442">,</span>&nbsp;<span class="ident" id="4355444">hashed</span><span class="op" id="4355450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4355453">ok</span>&nbsp;<span class="op" id="4355456">&amp;=</span>&nbsp;<span class="ident" id="4355459">subtle</span><span class="op" id="4355465">.</span><span class="ident" id="4355466">ConstantTimeCompare</span><span class="op" id="4355485">(</span><span class="ident" id="4355486">em</span><span class="op" id="4355488">[</span><span class="ident" id="4355489">k</span><span class="op" id="4355490">-</span><span class="ident" id="4355491">tLen</span><span class="op" id="4355495">:</span><span class="ident" id="4355496">k</span><span class="op" id="4355497">-</span><span class="ident" id="4355498">hashLen</span><span class="op" id="4355505">]</span><span class="op" id="4355506">,</span>&nbsp;<span class="ident" id="4355508">prefix</span><span class="op" id="4355514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4355517">ok</span>&nbsp;<span class="op" id="4355520">&amp;=</span>&nbsp;<span class="ident" id="4355523">subtle</span><span class="op" id="4355529">.</span><span class="ident" id="4355530">ConstantTimeByteEq</span><span class="op" id="4355548">(</span><span class="ident" id="4355549">em</span><span class="op" id="4355551">[</span><span class="ident" id="4355552">k</span><span class="op" id="4355553">-</span><span class="ident" id="4355554">tLen</span><span class="op" id="4355558">-</span><span class="num" id="4355559">1</span><span class="op" id="4355560">]</span><span class="op" id="4355561">,</span>&nbsp;<span class="num" id="4355563">0</span><span class="op" id="4355564">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4355568">for</span>&nbsp;<span class="ident" id="4355572">i</span>&nbsp;<span class="op" id="4355574">:=</span>&nbsp;<span class="num" id="4355577">2</span><span class="op" id="4355578">;</span>&nbsp;<span class="ident" id="4355580">i</span>&nbsp;<span class="op" id="4355582">&lt;</span>&nbsp;<span class="ident" id="4355584">k</span><span class="op" id="4355585">-</span><span class="ident" id="4355586">tLen</span><span class="op" id="4355590">-</span><span class="num" id="4355591">1</span><span class="op" id="4355592">;</span>&nbsp;<span class="ident" id="4355594">i</span><span class="op" id="4355595">++</span>&nbsp;<span class="op" id="4355598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4355602">ok</span>&nbsp;<span class="op" id="4355605">&amp;=</span>&nbsp;<span class="ident" id="4355608">subtle</span><span class="op" id="4355614">.</span><span class="ident" id="4355615">ConstantTimeByteEq</span><span class="op" id="4355633">(</span><span class="ident" id="4355634">em</span><span class="op" id="4355636">[</span><span class="ident" id="4355637">i</span><span class="op" id="4355638">]</span><span class="op" id="4355639">,</span>&nbsp;<span class="num" id="4355641">0xff</span><span class="op" id="4355645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4355648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4355652">if</span>&nbsp;<span class="ident" id="4355655">ok</span>&nbsp;<span class="op" id="4355658">!=</span>&nbsp;<span class="num" id="4355661">1</span>&nbsp;<span class="op" id="4355663">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4355667">return</span>&nbsp;<span class="ident" id="4355674">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4355691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4355695">return</span>&nbsp;<span class="ident" id="4355702">nil</span><br>
<span class="lineno"></span><span class="op" id="4355706">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="4355709">func</span>&nbsp;<span class="ident" id="4355714">pkcs1v15HashInfo</span><span class="op" id="4355730">(</span><span class="ident" id="4355731">hash</span>&nbsp;<span class="ident" id="4355736">crypto</span><span class="op" id="4355742">.</span><span class="ident" id="4355743">Hash</span><span class="op" id="4355747">,</span>&nbsp;<span class="ident" id="4355749">inLen</span>&nbsp;<span class="builtintype" id="4355755">int</span><span class="op" id="4355758">)</span>&nbsp;<span class="op" id="4355760">(</span><span class="ident" id="4355761">hashLen</span>&nbsp;<span class="builtintype" id="4355769">int</span><span class="op" id="4355772">,</span>&nbsp;<span class="ident" id="4355774">prefix</span>&nbsp;<span class="op" id="4355781">[</span><span class="op" id="4355782">]</span><span class="builtintype" id="4355783">byte</span><span class="op" id="4355787">,</span>&nbsp;<span class="ident" id="4355789">err</span>&nbsp;<span class="builtintype" id="4355793">error</span><span class="op" id="4355798">)</span>&nbsp;<span class="op" id="4355800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4355803">//&nbsp;Special&nbsp;case:&nbsp;crypto.Hash(0)&nbsp;is&nbsp;used&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4355873">//&nbsp;signed&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4355894">if</span>&nbsp;<span class="ident" id="4355897">hash</span>&nbsp;<span class="op" id="4355902">==</span>&nbsp;<span class="num" id="4355905">0</span>&nbsp;<span class="op" id="4355907">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4355911">return</span>&nbsp;<span class="ident" id="4355918">inLen</span><span class="op" id="4355923">,</span>&nbsp;<span class="ident" id="4355925">nil</span><span class="op" id="4355928">,</span>&nbsp;<span class="ident" id="4355930">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4355935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4355939">hashLen</span>&nbsp;<span class="op" id="4355947">=</span>&nbsp;<span class="ident" id="4355949">hash</span><span class="op" id="4355953">.</span><span class="ident" id="4355954">Size</span><span class="op" id="4355958">(</span><span class="op" id="4355959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4355962">if</span>&nbsp;<span class="ident" id="4355965">inLen</span>&nbsp;<span class="op" id="4355971">!=</span>&nbsp;<span class="ident" id="4355974">hashLen</span>&nbsp;<span class="op" id="4355982">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4355986">return</span>&nbsp;<span class="num" id="4355993">0</span><span class="op" id="4355994">,</span>&nbsp;<span class="ident" id="4355996">nil</span><span class="op" id="4355999">,</span>&nbsp;<span class="ident" id="4356001">errors</span><span class="op" id="4356007">.</span><span class="ident" id="4356008">New</span><span class="op" id="4356011">(</span><span class="string" id="4356012">&#34;crypto/rsa:&nbsp;input&nbsp;must&nbsp;be&nbsp;hashed&nbsp;message&#34;</span><span class="op" id="4356054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4356057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4356060">prefix</span><span class="op" id="4356066">,</span>&nbsp;<span class="ident" id="4356068">ok</span>&nbsp;<span class="op" id="4356071">:=</span>&nbsp;<span class="ident" id="4356074">hashPrefixes</span><span class="op" id="4356086">[</span><span class="ident" id="4356087">hash</span><span class="op" id="4356091">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4356094">if</span>&nbsp;<span class="op" id="4356097">!</span><span class="ident" id="4356098">ok</span>&nbsp;<span class="op" id="4356101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4356105">return</span>&nbsp;<span class="num" id="4356112">0</span><span class="op" id="4356113">,</span>&nbsp;<span class="ident" id="4356115">nil</span><span class="op" id="4356118">,</span>&nbsp;<span class="ident" id="4356120">errors</span><span class="op" id="4356126">.</span><span class="ident" id="4356127">New</span><span class="op" id="4356130">(</span><span class="string" id="4356131">&#34;crypto/rsa:&nbsp;unsupported&nbsp;hash&nbsp;function&#34;</span><span class="op" id="4356170">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4356173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4356176">return</span><br>
<span class="lineno"></span><span class="op" id="4356183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4356186">//&nbsp;copyWithLeftPad&nbsp;copies&nbsp;src&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;dest,&nbsp;padding&nbsp;with&nbsp;zero&nbsp;bytes&nbsp;as</span><br>
<span class="lineno">285</span><span class="comment" id="4356263">//&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="4356274">func</span>&nbsp;<span class="ident" id="4356279">copyWithLeftPad</span><span class="op" id="4356294">(</span><span class="ident" id="4356295">dest</span><span class="op" id="4356299">,</span>&nbsp;<span class="ident" id="4356301">src</span>&nbsp;<span class="op" id="4356305">[</span><span class="op" id="4356306">]</span><span class="builtintype" id="4356307">byte</span><span class="op" id="4356311">)</span>&nbsp;<span class="op" id="4356313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4356316">numPaddingBytes</span>&nbsp;<span class="op" id="4356332">:=</span>&nbsp;<span class="builtinfunc" id="4356335">len</span><span class="op" id="4356338">(</span><span class="ident" id="4356339">dest</span><span class="op" id="4356343">)</span>&nbsp;<span class="op" id="4356345">-</span>&nbsp;<span class="builtinfunc" id="4356347">len</span><span class="op" id="4356350">(</span><span class="ident" id="4356351">src</span><span class="op" id="4356354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4356357">for</span>&nbsp;<span class="ident" id="4356361">i</span>&nbsp;<span class="op" id="4356363">:=</span>&nbsp;<span class="num" id="4356366">0</span><span class="op" id="4356367">;</span>&nbsp;<span class="ident" id="4356369">i</span>&nbsp;<span class="op" id="4356371">&lt;</span>&nbsp;<span class="ident" id="4356373">numPaddingBytes</span><span class="op" id="4356388">;</span>&nbsp;<span class="ident" id="4356390">i</span><span class="op" id="4356391">++</span>&nbsp;<span class="op" id="4356394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4356398">dest</span><span class="op" id="4356402">[</span><span class="ident" id="4356403">i</span><span class="op" id="4356404">]</span>&nbsp;<span class="op" id="4356406">=</span>&nbsp;<span class="num" id="4356408">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4356411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4356414">copy</span><span class="op" id="4356418">(</span><span class="ident" id="4356419">dest</span><span class="op" id="4356423">[</span><span class="ident" id="4356424">numPaddingBytes</span><span class="op" id="4356439">:</span><span class="op" id="4356440">]</span><span class="op" id="4356441">,</span>&nbsp;<span class="ident" id="4356443">src</span><span class="op" id="4356446">)</span><br>
<span class="lineno"></span><span class="op" id="4356448">}</span>
</div>
</body>
</html>
