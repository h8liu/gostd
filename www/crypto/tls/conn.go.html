<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4127175">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4127230">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4127284">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4127335">//&nbsp;TLS&nbsp;low&nbsp;level&nbsp;connection&nbsp;and&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4127381">package</span>&nbsp;<span class="ident" id="4127389">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4127394">import</span>&nbsp;<span class="op" id="4127401">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4127404">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4127413">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4127430">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4127447">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4127462">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4127472">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4127479">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4127485">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4127492">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4127500">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4127507">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4127510">//&nbsp;A&nbsp;Conn&nbsp;represents&nbsp;a&nbsp;secured&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4127553">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;net.Conn&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="4127594">type</span>&nbsp;<span class="ident" id="4127599">Conn</span>&nbsp;<span class="keyword" id="4127604">struct</span>&nbsp;<span class="op" id="4127611">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4127614">//&nbsp;constant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4127627">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4127636"><a href="/crypto/tls/conn.go.html#4127485">net</a></span><span class="op" id="4127639">.</span><span class="ident" id="4127640">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4127646">isClient</span>&nbsp;<span class="builtintype" id="4127655">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4127662">//&nbsp;constant&nbsp;after&nbsp;handshake;&nbsp;protected&nbsp;by&nbsp;handshakeMutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4127720">handshakeMutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4127738"><a href="/crypto/tls/conn.go.html#4127492">sync</a></span><span class="op" id="4127742">.</span><span class="ident" id="4127743">Mutex</span>&nbsp;<span class="comment" id="4127749">//&nbsp;handshakeMutex&nbsp;&lt;&nbsp;in.Mutex,&nbsp;out.Mutex,&nbsp;errMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4127800">handshakeErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4127818">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4127829">//&nbsp;error&nbsp;resulting&nbsp;from&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4127864">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4127882">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4127893">//&nbsp;TLS&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4127909">haveVers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4127927">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4127938">//&nbsp;version&nbsp;has&nbsp;been&nbsp;negotiated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4127970">config</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4127988">*</span><span class="ident" id="4127989"><a href="/crypto/tls/common.go.html#4116177">Config</a></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4127999">//&nbsp;configuration&nbsp;passed&nbsp;to&nbsp;constructor</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128039">handshakeComplete</span>&nbsp;<span class="builtintype" id="4128057">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128063">didResume</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4128081">bool</span>&nbsp;<span class="comment" id="4128086">//&nbsp;whether&nbsp;this&nbsp;connection&nbsp;was&nbsp;a&nbsp;session&nbsp;resumption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128139">cipherSuite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4128157">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128165">ocspResponse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4128183">[</span><span class="op" id="4128184">]</span><span class="builtintype" id="4128185">byte</span>&nbsp;<span class="comment" id="4128190">//&nbsp;stapled&nbsp;OCSP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128216">peerCertificates</span>&nbsp;&nbsp;<span class="op" id="4128234">[</span><span class="op" id="4128235">]</span><span class="op" id="4128236">*</span><span class="ident" id="4128237"><a href="/crypto/tls/conn.go.html#4127447">x509</a></span><span class="op" id="4128241">.</span><span class="ident" id="4128242">Certificate</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4128255">//&nbsp;verifiedChains&nbsp;contains&nbsp;the&nbsp;certificate&nbsp;chains&nbsp;that&nbsp;we&nbsp;built,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4128324">//&nbsp;opposed&nbsp;to&nbsp;the&nbsp;ones&nbsp;presented&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128373">verifiedChains</span>&nbsp;<span class="op" id="4128388">[</span><span class="op" id="4128389">]</span><span class="op" id="4128390">[</span><span class="op" id="4128391">]</span><span class="op" id="4128392">*</span><span class="ident" id="4128393"><a href="/crypto/tls/conn.go.html#4127447">x509</a></span><span class="op" id="4128397">.</span><span class="ident" id="4128398">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4128411">//&nbsp;serverName&nbsp;contains&nbsp;the&nbsp;server&nbsp;name&nbsp;indicated&nbsp;by&nbsp;the&nbsp;client,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128484">serverName</span>&nbsp;<span class="builtintype" id="4128495">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4128503">//&nbsp;firstFinished&nbsp;contains&nbsp;the&nbsp;first&nbsp;Finished&nbsp;hash&nbsp;sent&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4128570">//&nbsp;handshake.&nbsp;This&nbsp;is&nbsp;the&nbsp;&#34;tls-unique&#34;&nbsp;channel&nbsp;binding&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128633">firstFinished</span>&nbsp;<span class="op" id="4128647">[</span><span class="num" id="4128648">12</span><span class="op" id="4128650">]</span><span class="builtintype" id="4128651">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128658">clientProtocol</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4128681">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128689">clientProtocolFallback</span>&nbsp;<span class="builtintype" id="4128712">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4128719">//&nbsp;input/output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128736">in</span><span class="op" id="4128738">,</span>&nbsp;<span class="ident" id="4128740">out</span>&nbsp;&nbsp;<span class="ident" id="4128745"><a href="/crypto/tls/conn.go.html#4130304">halfConn</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4128758">//&nbsp;in.Mutex&nbsp;&lt;&nbsp;out.Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128783">rawInput</span>&nbsp;<span class="op" id="4128792">*</span><span class="ident" id="4128793"><a href="/crypto/tls/conn.go.html#4139217">block</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4128805">//&nbsp;raw&nbsp;input,&nbsp;right&nbsp;off&nbsp;the&nbsp;wire</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128839">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4128848">*</span><span class="ident" id="4128849"><a href="/crypto/tls/conn.go.html#4139217">block</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4128861">//&nbsp;application&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128901">hand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4128910"><a href="/crypto/tls/conn.go.html#4127404">bytes</a></span><span class="op" id="4128915">.</span><span class="ident" id="4128916">Buffer</span>&nbsp;<span class="comment" id="4128923">//&nbsp;handshake&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128962">tmp</span>&nbsp;<span class="op" id="4128966">[</span><span class="num" id="4128967">16</span><span class="op" id="4128969">]</span><span class="builtintype" id="4128970">byte</span><br>
<span class="lineno"></span><span class="op" id="4128975">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="4128978">//&nbsp;Access&nbsp;to&nbsp;net.Conn&nbsp;methods.</span><br>
<span class="lineno"></span><span class="comment" id="4129009">//&nbsp;Cannot&nbsp;just&nbsp;embed&nbsp;net.Conn&nbsp;because&nbsp;that&nbsp;would</span><br>
<span class="lineno"></span><span class="comment" id="4129058">//&nbsp;export&nbsp;the&nbsp;struct&nbsp;field&nbsp;too.</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4129091">//&nbsp;LocalAddr&nbsp;returns&nbsp;the&nbsp;local&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4129139">func</span>&nbsp;<span class="op" id="4129144">(</span><span class="ident" id="4129145">c</span>&nbsp;<span class="op" id="4129147">*</span><span class="ident" id="4129148"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4129152">)</span>&nbsp;<span class="ident" id="4129154">LocalAddr</span><span class="op" id="4129163">(</span><span class="op" id="4129164">)</span>&nbsp;<span class="ident" id="4129166"><a href="/crypto/tls/conn.go.html#4127485">net</a></span><span class="op" id="4129169">.</span><span class="ident" id="4129170">Addr</span>&nbsp;<span class="op" id="4129175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4129178">return</span>&nbsp;<span class="ident" id="4129185"><a href="/crypto/tls/conn.go.html#4129145">c</a></span><span class="op" id="4129186">.</span><span class="ident" id="4129187">conn</span><span class="op" id="4129191">.</span><span class="ident" id="4129192">LocalAddr</span><span class="op" id="4129201">(</span><span class="op" id="4129202">)</span><br>
<span class="lineno"></span><span class="op" id="4129204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="4129207">//&nbsp;RemoteAddr&nbsp;returns&nbsp;the&nbsp;remote&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4129257">func</span>&nbsp;<span class="op" id="4129262">(</span><span class="ident" id="4129263">c</span>&nbsp;<span class="op" id="4129265">*</span><span class="ident" id="4129266"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4129270">)</span>&nbsp;<span class="ident" id="4129272">RemoteAddr</span><span class="op" id="4129282">(</span><span class="op" id="4129283">)</span>&nbsp;<span class="ident" id="4129285"><a href="/crypto/tls/conn.go.html#4127485">net</a></span><span class="op" id="4129288">.</span><span class="ident" id="4129289">Addr</span>&nbsp;<span class="op" id="4129294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4129297">return</span>&nbsp;<span class="ident" id="4129304"><a href="/crypto/tls/conn.go.html#4129263">c</a></span><span class="op" id="4129305">.</span><span class="ident" id="4129306">conn</span><span class="op" id="4129310">.</span><span class="ident" id="4129311">RemoteAddr</span><span class="op" id="4129321">(</span><span class="op" id="4129322">)</span><br>
<span class="lineno"></span><span class="op" id="4129324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="4129327">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;and&nbsp;write&nbsp;deadlines&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4129408">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;and&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="4129470">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4129577">func</span>&nbsp;<span class="op" id="4129582">(</span><span class="ident" id="4129583">c</span>&nbsp;<span class="op" id="4129585">*</span><span class="ident" id="4129586"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4129590">)</span>&nbsp;<span class="ident" id="4129592">SetDeadline</span><span class="op" id="4129603">(</span><span class="ident" id="4129604">t</span>&nbsp;<span class="ident" id="4129606"><a href="/crypto/tls/conn.go.html#4127500">time</a></span><span class="op" id="4129610">.</span><span class="ident" id="4129611">Time</span><span class="op" id="4129615">)</span>&nbsp;<span class="builtintype" id="4129617">error</span>&nbsp;<span class="op" id="4129623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4129626">return</span>&nbsp;<span class="ident" id="4129633"><a href="/crypto/tls/conn.go.html#4129583">c</a></span><span class="op" id="4129634">.</span><span class="ident" id="4129635">conn</span><span class="op" id="4129639">.</span><span class="ident" id="4129640">SetDeadline</span><span class="op" id="4129651">(</span><span class="ident" id="4129652"><a href="/crypto/tls/conn.go.html#4129604">t</a></span><span class="op" id="4129653">)</span><br>
<span class="lineno">80</span><span class="op" id="4129655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4129658">//&nbsp;SetReadDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4129730">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="4129782">func</span>&nbsp;<span class="op" id="4129787">(</span><span class="ident" id="4129788">c</span>&nbsp;<span class="op" id="4129790">*</span><span class="ident" id="4129791"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4129795">)</span>&nbsp;<span class="ident" id="4129797">SetReadDeadline</span><span class="op" id="4129812">(</span><span class="ident" id="4129813">t</span>&nbsp;<span class="ident" id="4129815"><a href="/crypto/tls/conn.go.html#4127500">time</a></span><span class="op" id="4129819">.</span><span class="ident" id="4129820">Time</span><span class="op" id="4129824">)</span>&nbsp;<span class="builtintype" id="4129826">error</span>&nbsp;<span class="op" id="4129832">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4129835">return</span>&nbsp;<span class="ident" id="4129842"><a href="/crypto/tls/conn.go.html#4129788">c</a></span><span class="op" id="4129843">.</span><span class="ident" id="4129844">conn</span><span class="op" id="4129848">.</span><span class="ident" id="4129849">SetReadDeadline</span><span class="op" id="4129864">(</span><span class="ident" id="4129865"><a href="/crypto/tls/conn.go.html#4129813">t</a></span><span class="op" id="4129866">)</span><br>
<span class="lineno"></span><span class="op" id="4129868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4129871">//&nbsp;SetWriteDeadline&nbsp;sets&nbsp;the&nbsp;write&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4129945">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno">90</span><span class="comment" id="4129998">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4130105">func</span>&nbsp;<span class="op" id="4130110">(</span><span class="ident" id="4130111">c</span>&nbsp;<span class="op" id="4130113">*</span><span class="ident" id="4130114"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4130118">)</span>&nbsp;<span class="ident" id="4130120">SetWriteDeadline</span><span class="op" id="4130136">(</span><span class="ident" id="4130137">t</span>&nbsp;<span class="ident" id="4130139"><a href="/crypto/tls/conn.go.html#4127500">time</a></span><span class="op" id="4130143">.</span><span class="ident" id="4130144">Time</span><span class="op" id="4130148">)</span>&nbsp;<span class="builtintype" id="4130150">error</span>&nbsp;<span class="op" id="4130156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4130159">return</span>&nbsp;<span class="ident" id="4130166"><a href="/crypto/tls/conn.go.html#4130111">c</a></span><span class="op" id="4130167">.</span><span class="ident" id="4130168">conn</span><span class="op" id="4130172">.</span><span class="ident" id="4130173">SetWriteDeadline</span><span class="op" id="4130189">(</span><span class="ident" id="4130190"><a href="/crypto/tls/conn.go.html#4130137">t</a></span><span class="op" id="4130191">)</span><br>
<span class="lineno"></span><span class="op" id="4130193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4130196">//&nbsp;A&nbsp;halfConn&nbsp;represents&nbsp;one&nbsp;direction&nbsp;of&nbsp;the&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><span class="comment" id="4130255">//&nbsp;connection,&nbsp;either&nbsp;sending&nbsp;or&nbsp;receiving.</span><br>
<span class="lineno"></span><span class="keyword" id="4130299">type</span>&nbsp;<span class="ident" id="4130304">halfConn</span>&nbsp;<span class="keyword" id="4130313">struct</span>&nbsp;<span class="op" id="4130320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130323"><a href="/crypto/tls/conn.go.html#4127492">sync</a></span><span class="op" id="4130327">.</span><span class="ident" id="4130328">Mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130336">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4130344">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4130356">//&nbsp;first&nbsp;permanent&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130382">version</span>&nbsp;<span class="builtintype" id="4130390">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4130402">//&nbsp;protocol&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130423">cipher</span>&nbsp;&nbsp;<span class="keyword" id="4130431">interface</span><span class="op" id="4130440">{</span><span class="op" id="4130441">}</span>&nbsp;<span class="comment" id="4130443">//&nbsp;cipher&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130464">mac</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4130472"><a href="/crypto/tls/cipher_suites.go.html#4103068">macFunction</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130485">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4130493">[</span><span class="num" id="4130494">8</span><span class="op" id="4130495">]</span><span class="builtintype" id="4130496">byte</span>&nbsp;<span class="comment" id="4130501">//&nbsp;64-bit&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130528">bfree</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4130536">*</span><span class="ident" id="4130537"><a href="/crypto/tls/conn.go.html#4139217">block</a></span>&nbsp;&nbsp;<span class="comment" id="4130544">//&nbsp;list&nbsp;of&nbsp;free&nbsp;blocks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130569">nextCipher</span>&nbsp;<span class="keyword" id="4130580">interface</span><span class="op" id="4130589">{</span><span class="op" id="4130590">}</span>&nbsp;<span class="comment" id="4130592">//&nbsp;next&nbsp;encryption&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130618">nextMac</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4130629"><a href="/crypto/tls/cipher_suites.go.html#4103068">macFunction</a></span>&nbsp;<span class="comment" id="4130641">//&nbsp;next&nbsp;MAC&nbsp;algorithm</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4130665">//&nbsp;used&nbsp;to&nbsp;save&nbsp;allocating&nbsp;a&nbsp;new&nbsp;buffer&nbsp;for&nbsp;each&nbsp;MAC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130720">inDigestBuf</span><span class="op" id="4130731">,</span>&nbsp;<span class="ident" id="4130733">outDigestBuf</span>&nbsp;<span class="op" id="4130746">[</span><span class="op" id="4130747">]</span><span class="builtintype" id="4130748">byte</span><br>
<span class="lineno"></span><span class="op" id="4130753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4130756">func</span>&nbsp;<span class="op" id="4130761">(</span><span class="ident" id="4130762">hc</span>&nbsp;<span class="op" id="4130765">*</span><span class="ident" id="4130766"><a href="/crypto/tls/conn.go.html#4130304">halfConn</a></span><span class="op" id="4130774">)</span>&nbsp;<span class="ident" id="4130776">setErrorLocked</span><span class="op" id="4130790">(</span><span class="ident" id="4130791">err</span>&nbsp;<span class="builtintype" id="4130795">error</span><span class="op" id="4130800">)</span>&nbsp;<span class="builtintype" id="4130802">error</span>&nbsp;<span class="op" id="4130808">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130811"><a href="/crypto/tls/conn.go.html#4130762">hc</a></span><span class="op" id="4130813">.</span><span class="ident" id="4130814">err</span>&nbsp;<span class="op" id="4130818">=</span>&nbsp;<span class="ident" id="4130820"><a href="/crypto/tls/conn.go.html#4130791">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4130825">return</span>&nbsp;<span class="ident" id="4130832"><a href="/crypto/tls/conn.go.html#4130791">err</a></span><br>
<span class="lineno"></span><span class="op" id="4130836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4130839">func</span>&nbsp;<span class="op" id="4130844">(</span><span class="ident" id="4130845">hc</span>&nbsp;<span class="op" id="4130848">*</span><span class="ident" id="4130849"><a href="/crypto/tls/conn.go.html#4130304">halfConn</a></span><span class="op" id="4130857">)</span>&nbsp;<span class="builtintype" id="4130859">error</span><span class="op" id="4130864">(</span><span class="op" id="4130865">)</span>&nbsp;<span class="builtintype" id="4130867">error</span>&nbsp;<span class="op" id="4130873">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130876"><a href="/crypto/tls/conn.go.html#4130845">hc</a></span><span class="op" id="4130878">.</span><span class="ident" id="4130879">Lock</span><span class="op" id="4130883">(</span><span class="op" id="4130884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130887">err</span>&nbsp;<span class="op" id="4130891">:=</span>&nbsp;<span class="ident" id="4130894"><a href="/crypto/tls/conn.go.html#4130845">hc</a></span><span class="op" id="4130896">.</span><span class="ident" id="4130897">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130902"><a href="/crypto/tls/conn.go.html#4130845">hc</a></span><span class="op" id="4130904">.</span><span class="ident" id="4130905">Unlock</span><span class="op" id="4130911">(</span><span class="op" id="4130912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4130915">return</span>&nbsp;<span class="ident" id="4130922"><a href="/crypto/tls/conn.go.html#4130887">err</a></span><br>
<span class="lineno"></span><span class="op" id="4130926">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="4130929">//&nbsp;prepareCipherSpec&nbsp;sets&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno"></span><span class="comment" id="4130985">//&nbsp;that&nbsp;a&nbsp;subsequent&nbsp;changeCipherSpec&nbsp;will&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="4131033">func</span>&nbsp;<span class="op" id="4131038">(</span><span class="ident" id="4131039">hc</span>&nbsp;<span class="op" id="4131042">*</span><span class="ident" id="4131043"><a href="/crypto/tls/conn.go.html#4130304">halfConn</a></span><span class="op" id="4131051">)</span>&nbsp;<span class="ident" id="4131053">prepareCipherSpec</span><span class="op" id="4131070">(</span><span class="ident" id="4131071">version</span>&nbsp;<span class="builtintype" id="4131079">uint16</span><span class="op" id="4131085">,</span>&nbsp;<span class="ident" id="4131087">cipher</span>&nbsp;<span class="keyword" id="4131094">interface</span><span class="op" id="4131103">{</span><span class="op" id="4131104">}</span><span class="op" id="4131105">,</span>&nbsp;<span class="ident" id="4131107">mac</span>&nbsp;<span class="ident" id="4131111"><a href="/crypto/tls/cipher_suites.go.html#4103068">macFunction</a></span><span class="op" id="4131122">)</span>&nbsp;<span class="op" id="4131124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131127"><a href="/crypto/tls/conn.go.html#4131039">hc</a></span><span class="op" id="4131129">.</span><span class="ident" id="4131130">version</span>&nbsp;<span class="op" id="4131138">=</span>&nbsp;<span class="ident" id="4131140"><a href="/crypto/tls/conn.go.html#4131071">version</a></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131149"><a href="/crypto/tls/conn.go.html#4131039">hc</a></span><span class="op" id="4131151">.</span><span class="ident" id="4131152">nextCipher</span>&nbsp;<span class="op" id="4131163">=</span>&nbsp;<span class="ident" id="4131165"><a href="/crypto/tls/conn.go.html#4131087">cipher</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131173"><a href="/crypto/tls/conn.go.html#4131039">hc</a></span><span class="op" id="4131175">.</span><span class="ident" id="4131176">nextMac</span>&nbsp;<span class="op" id="4131184">=</span>&nbsp;<span class="ident" id="4131186"><a href="/crypto/tls/conn.go.html#4131107">mac</a></span><br>
<span class="lineno"></span><span class="op" id="4131190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4131193">//&nbsp;changeCipherSpec&nbsp;changes&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno">135</span><span class="comment" id="4131251">//&nbsp;to&nbsp;the&nbsp;ones&nbsp;previously&nbsp;passed&nbsp;to&nbsp;prepareCipherSpec.</span><br>
<span class="lineno"></span><span class="keyword" id="4131306">func</span>&nbsp;<span class="op" id="4131311">(</span><span class="ident" id="4131312">hc</span>&nbsp;<span class="op" id="4131315">*</span><span class="ident" id="4131316"><a href="/crypto/tls/conn.go.html#4130304">halfConn</a></span><span class="op" id="4131324">)</span>&nbsp;<span class="ident" id="4131326">changeCipherSpec</span><span class="op" id="4131342">(</span><span class="op" id="4131343">)</span>&nbsp;<span class="builtintype" id="4131345">error</span>&nbsp;<span class="op" id="4131351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4131354">if</span>&nbsp;<span class="ident" id="4131357"><a href="/crypto/tls/conn.go.html#4131312">hc</a></span><span class="op" id="4131359">.</span><span class="ident" id="4131360">nextCipher</span>&nbsp;<span class="op" id="4131371">==</span>&nbsp;<span class="ident" id="4131374">nil</span>&nbsp;<span class="op" id="4131378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4131382">return</span>&nbsp;<span class="ident" id="4131389"><a href="/crypto/tls/alert.go.html#4096712">alertInternalError</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4131409">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131412"><a href="/crypto/tls/conn.go.html#4131312">hc</a></span><span class="op" id="4131414">.</span><span class="ident" id="4131415">cipher</span>&nbsp;<span class="op" id="4131422">=</span>&nbsp;<span class="ident" id="4131424"><a href="/crypto/tls/conn.go.html#4131312">hc</a></span><span class="op" id="4131426">.</span><span class="ident" id="4131427">nextCipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131439"><a href="/crypto/tls/conn.go.html#4131312">hc</a></span><span class="op" id="4131441">.</span><span class="ident" id="4131442">mac</span>&nbsp;<span class="op" id="4131446">=</span>&nbsp;<span class="ident" id="4131448"><a href="/crypto/tls/conn.go.html#4131312">hc</a></span><span class="op" id="4131450">.</span><span class="ident" id="4131451">nextMac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131460"><a href="/crypto/tls/conn.go.html#4131312">hc</a></span><span class="op" id="4131462">.</span><span class="ident" id="4131463">nextCipher</span>&nbsp;<span class="op" id="4131474">=</span>&nbsp;<span class="ident" id="4131476">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131481"><a href="/crypto/tls/conn.go.html#4131312">hc</a></span><span class="op" id="4131483">.</span><span class="ident" id="4131484">nextMac</span>&nbsp;<span class="op" id="4131492">=</span>&nbsp;<span class="ident" id="4131494">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4131499">for</span>&nbsp;<span class="ident" id="4131503">i</span>&nbsp;<span class="op" id="4131505">:=</span>&nbsp;<span class="keyword" id="4131508">range</span>&nbsp;<span class="ident" id="4131514"><a href="/crypto/tls/conn.go.html#4131312">hc</a></span><span class="op" id="4131516">.</span><span class="ident" id="4131517">seq</span>&nbsp;<span class="op" id="4131521">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131525"><a href="/crypto/tls/conn.go.html#4131312">hc</a></span><span class="op" id="4131527">.</span><span class="ident" id="4131528">seq</span><span class="op" id="4131531">[</span><span class="ident" id="4131532"><a href="/crypto/tls/conn.go.html#4131503">i</a></span><span class="op" id="4131533">]</span>&nbsp;<span class="op" id="4131535">=</span>&nbsp;<span class="num" id="4131537">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4131540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4131543">return</span>&nbsp;<span class="ident" id="4131550">nil</span><br>
<span class="lineno"></span><span class="op" id="4131554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4131557">//&nbsp;incSeq&nbsp;increments&nbsp;the&nbsp;sequence&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword" id="4131599">func</span>&nbsp;<span class="op" id="4131604">(</span><span class="ident" id="4131605">hc</span>&nbsp;<span class="op" id="4131608">*</span><span class="ident" id="4131609"><a href="/crypto/tls/conn.go.html#4130304">halfConn</a></span><span class="op" id="4131617">)</span>&nbsp;<span class="ident" id="4131619">incSeq</span><span class="op" id="4131625">(</span><span class="op" id="4131626">)</span>&nbsp;<span class="op" id="4131628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4131631">for</span>&nbsp;<span class="ident" id="4131635">i</span>&nbsp;<span class="op" id="4131637">:=</span>&nbsp;<span class="num" id="4131640">7</span><span class="op" id="4131641">;</span>&nbsp;<span class="ident" id="4131643"><a href="/crypto/tls/conn.go.html#4131635">i</a></span>&nbsp;<span class="op" id="4131645">&gt;=</span>&nbsp;<span class="num" id="4131648">0</span><span class="op" id="4131649">;</span>&nbsp;<span class="ident" id="4131651"><a href="/crypto/tls/conn.go.html#4131635">i</a></span><span class="op" id="4131652">--</span>&nbsp;<span class="op" id="4131655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131659"><a href="/crypto/tls/conn.go.html#4131605">hc</a></span><span class="op" id="4131661">.</span><span class="ident" id="4131662">seq</span><span class="op" id="4131665">[</span><span class="ident" id="4131666"><a href="/crypto/tls/conn.go.html#4131635">i</a></span><span class="op" id="4131667">]</span><span class="op" id="4131668">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4131673">if</span>&nbsp;<span class="ident" id="4131676"><a href="/crypto/tls/conn.go.html#4131605">hc</a></span><span class="op" id="4131678">.</span><span class="ident" id="4131679">seq</span><span class="op" id="4131682">[</span><span class="ident" id="4131683"><a href="/crypto/tls/conn.go.html#4131635">i</a></span><span class="op" id="4131684">]</span>&nbsp;<span class="op" id="4131686">!=</span>&nbsp;<span class="num" id="4131689">0</span>&nbsp;<span class="op" id="4131691">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4131696">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4131705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4131708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4131712">//&nbsp;Not&nbsp;allowed&nbsp;to&nbsp;let&nbsp;sequence&nbsp;number&nbsp;wrap.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4131757">//&nbsp;Instead,&nbsp;must&nbsp;renegotiate&nbsp;before&nbsp;it&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4131803">//&nbsp;Not&nbsp;likely&nbsp;enough&nbsp;to&nbsp;bother.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4131836">panic</span><span class="op" id="4131841">(</span><span class="string" id="4131842">&#34;TLS:&nbsp;sequence&nbsp;number&nbsp;wraparound&#34;</span><span class="op" id="4131875">)</span><br>
<span class="lineno"></span><span class="op" id="4131877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="4131880">//&nbsp;resetSeq&nbsp;resets&nbsp;the&nbsp;sequence&nbsp;number&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="4131928">func</span>&nbsp;<span class="op" id="4131933">(</span><span class="ident" id="4131934">hc</span>&nbsp;<span class="op" id="4131937">*</span><span class="ident" id="4131938"><a href="/crypto/tls/conn.go.html#4130304">halfConn</a></span><span class="op" id="4131946">)</span>&nbsp;<span class="ident" id="4131948">resetSeq</span><span class="op" id="4131956">(</span><span class="op" id="4131957">)</span>&nbsp;<span class="op" id="4131959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4131962">for</span>&nbsp;<span class="ident" id="4131966">i</span>&nbsp;<span class="op" id="4131968">:=</span>&nbsp;<span class="keyword" id="4131971">range</span>&nbsp;<span class="ident" id="4131977"><a href="/crypto/tls/conn.go.html#4131934">hc</a></span><span class="op" id="4131979">.</span><span class="ident" id="4131980">seq</span>&nbsp;<span class="op" id="4131984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131988"><a href="/crypto/tls/conn.go.html#4131934">hc</a></span><span class="op" id="4131990">.</span><span class="ident" id="4131991">seq</span><span class="op" id="4131994">[</span><span class="ident" id="4131995"><a href="/crypto/tls/conn.go.html#4131966">i</a></span><span class="op" id="4131996">]</span>&nbsp;<span class="op" id="4131998">=</span>&nbsp;<span class="num" id="4132000">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4132003">}</span><br>
<span class="lineno">170</span><span class="op" id="4132005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4132008">//&nbsp;removePadding&nbsp;returns&nbsp;an&nbsp;unpadded&nbsp;slice,&nbsp;in&nbsp;constant&nbsp;time,&nbsp;which&nbsp;is&nbsp;a&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="4132088">//&nbsp;of&nbsp;the&nbsp;input.&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;byte&nbsp;which&nbsp;is&nbsp;equal&nbsp;to&nbsp;255&nbsp;if&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4132165">//&nbsp;was&nbsp;valid&nbsp;and&nbsp;0&nbsp;otherwise.&nbsp;See&nbsp;RFC&nbsp;2246,&nbsp;section&nbsp;6.2.3.2</span><br>
<span class="lineno">175</span><span class="keyword" id="4132225">func</span>&nbsp;<span class="ident" id="4132230">removePadding</span><span class="op" id="4132243">(</span><span class="ident" id="4132244">payload</span>&nbsp;<span class="op" id="4132252">[</span><span class="op" id="4132253">]</span><span class="builtintype" id="4132254">byte</span><span class="op" id="4132258">)</span>&nbsp;<span class="op" id="4132260">(</span><span class="op" id="4132261">[</span><span class="op" id="4132262">]</span><span class="builtintype" id="4132263">byte</span><span class="op" id="4132267">,</span>&nbsp;<span class="builtintype" id="4132269">byte</span><span class="op" id="4132273">)</span>&nbsp;<span class="op" id="4132275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132278">if</span>&nbsp;<span class="builtinfunc" id="4132281">len</span><span class="op" id="4132284">(</span><span class="ident" id="4132285"><a href="/crypto/tls/conn.go.html#4132244">payload</a></span><span class="op" id="4132292">)</span>&nbsp;<span class="op" id="4132294">&lt;</span>&nbsp;<span class="num" id="4132296">1</span>&nbsp;<span class="op" id="4132298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132302">return</span>&nbsp;<span class="ident" id="4132309"><a href="/crypto/tls/conn.go.html#4132244">payload</a></span><span class="op" id="4132316">,</span>&nbsp;<span class="num" id="4132318">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4132321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132325">paddingLen</span>&nbsp;<span class="op" id="4132336">:=</span>&nbsp;<span class="ident" id="4132339"><a href="/crypto/tls/conn.go.html#4132244">payload</a></span><span class="op" id="4132346">[</span><span class="builtinfunc" id="4132347">len</span><span class="op" id="4132350">(</span><span class="ident" id="4132351"><a href="/crypto/tls/conn.go.html#4132244">payload</a></span><span class="op" id="4132358">)</span><span class="op" id="4132359">-</span><span class="num" id="4132360">1</span><span class="op" id="4132361">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132364">t</span>&nbsp;<span class="op" id="4132366">:=</span>&nbsp;<span class="builtintype" id="4132369">uint</span><span class="op" id="4132373">(</span><span class="builtinfunc" id="4132374">len</span><span class="op" id="4132377">(</span><span class="ident" id="4132378"><a href="/crypto/tls/conn.go.html#4132244">payload</a></span><span class="op" id="4132385">)</span><span class="op" id="4132386">-</span><span class="num" id="4132387">1</span><span class="op" id="4132388">)</span>&nbsp;<span class="op" id="4132390">-</span>&nbsp;<span class="builtintype" id="4132392">uint</span><span class="op" id="4132396">(</span><span class="ident" id="4132397"><a href="/crypto/tls/conn.go.html#4132325">paddingLen</a></span><span class="op" id="4132407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4132410">//&nbsp;if&nbsp;len(payload)&nbsp;&gt;=&nbsp;(paddingLen&nbsp;-&nbsp;1)&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132476">good</span>&nbsp;<span class="op" id="4132481">:=</span>&nbsp;<span class="builtintype" id="4132484">byte</span><span class="op" id="4132488">(</span><span class="builtintype" id="4132489">int32</span><span class="op" id="4132494">(</span><span class="op" id="4132495">^</span><span class="ident" id="4132496"><a href="/crypto/tls/conn.go.html#4132364">t</a></span><span class="op" id="4132497">)</span>&nbsp;<span class="op" id="4132499">&gt;&gt;</span>&nbsp;<span class="num" id="4132502">31</span><span class="op" id="4132504">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132508">toCheck</span>&nbsp;<span class="op" id="4132516">:=</span>&nbsp;<span class="num" id="4132519">255</span>&nbsp;<span class="comment" id="4132523">//&nbsp;the&nbsp;maximum&nbsp;possible&nbsp;padding&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4132563">//&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;padded&nbsp;data&nbsp;is&nbsp;public,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;an&nbsp;if&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132633">if</span>&nbsp;<span class="ident" id="4132636"><a href="/crypto/tls/conn.go.html#4132508">toCheck</a></span><span class="op" id="4132643">+</span><span class="num" id="4132644">1</span>&nbsp;<span class="op" id="4132646">&gt;</span>&nbsp;<span class="builtinfunc" id="4132648">len</span><span class="op" id="4132651">(</span><span class="ident" id="4132652"><a href="/crypto/tls/conn.go.html#4132244">payload</a></span><span class="op" id="4132659">)</span>&nbsp;<span class="op" id="4132661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132665"><a href="/crypto/tls/conn.go.html#4132508">toCheck</a></span>&nbsp;<span class="op" id="4132673">=</span>&nbsp;<span class="builtinfunc" id="4132675">len</span><span class="op" id="4132678">(</span><span class="ident" id="4132679"><a href="/crypto/tls/conn.go.html#4132244">payload</a></span><span class="op" id="4132686">)</span>&nbsp;<span class="op" id="4132688">-</span>&nbsp;<span class="num" id="4132690">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4132693">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132697">for</span>&nbsp;<span class="ident" id="4132701">i</span>&nbsp;<span class="op" id="4132703">:=</span>&nbsp;<span class="num" id="4132706">0</span><span class="op" id="4132707">;</span>&nbsp;<span class="ident" id="4132709"><a href="/crypto/tls/conn.go.html#4132701">i</a></span>&nbsp;<span class="op" id="4132711">&lt;</span>&nbsp;<span class="ident" id="4132713"><a href="/crypto/tls/conn.go.html#4132508">toCheck</a></span><span class="op" id="4132720">;</span>&nbsp;<span class="ident" id="4132722"><a href="/crypto/tls/conn.go.html#4132701">i</a></span><span class="op" id="4132723">++</span>&nbsp;<span class="op" id="4132726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132730">t</span>&nbsp;<span class="op" id="4132732">:=</span>&nbsp;<span class="builtintype" id="4132735">uint</span><span class="op" id="4132739">(</span><span class="ident" id="4132740"><a href="/crypto/tls/conn.go.html#4132325">paddingLen</a></span><span class="op" id="4132750">)</span>&nbsp;<span class="op" id="4132752">-</span>&nbsp;<span class="builtintype" id="4132754">uint</span><span class="op" id="4132758">(</span><span class="ident" id="4132759"><a href="/crypto/tls/conn.go.html#4132701">i</a></span><span class="op" id="4132760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4132764">//&nbsp;if&nbsp;i&nbsp;&lt;=&nbsp;paddingLen&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132814">mask</span>&nbsp;<span class="op" id="4132819">:=</span>&nbsp;<span class="builtintype" id="4132822">byte</span><span class="op" id="4132826">(</span><span class="builtintype" id="4132827">int32</span><span class="op" id="4132832">(</span><span class="op" id="4132833">^</span><span class="ident" id="4132834"><a href="/crypto/tls/conn.go.html#4132730">t</a></span><span class="op" id="4132835">)</span>&nbsp;<span class="op" id="4132837">&gt;&gt;</span>&nbsp;<span class="num" id="4132840">31</span><span class="op" id="4132842">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132846">b</span>&nbsp;<span class="op" id="4132848">:=</span>&nbsp;<span class="ident" id="4132851"><a href="/crypto/tls/conn.go.html#4132244">payload</a></span><span class="op" id="4132858">[</span><span class="builtinfunc" id="4132859">len</span><span class="op" id="4132862">(</span><span class="ident" id="4132863"><a href="/crypto/tls/conn.go.html#4132244">payload</a></span><span class="op" id="4132870">)</span><span class="op" id="4132871">-</span><span class="num" id="4132872">1</span><span class="op" id="4132873">-</span><span class="ident" id="4132874"><a href="/crypto/tls/conn.go.html#4132701">i</a></span><span class="op" id="4132875">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132879"><a href="/crypto/tls/conn.go.html#4132476">good</a></span>&nbsp;<span class="op" id="4132884">&amp;^=</span>&nbsp;<span class="ident" id="4132888"><a href="/crypto/tls/conn.go.html#4132814">mask</a></span><span class="op" id="4132892">&amp;</span><span class="ident" id="4132893"><a href="/crypto/tls/conn.go.html#4132325">paddingLen</a></span>&nbsp;<span class="op" id="4132904">^</span>&nbsp;<span class="ident" id="4132906"><a href="/crypto/tls/conn.go.html#4132814">mask</a></span><span class="op" id="4132910">&amp;</span><span class="ident" id="4132911"><a href="/crypto/tls/conn.go.html#4132846">b</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4132914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4132918">//&nbsp;We&nbsp;AND&nbsp;together&nbsp;the&nbsp;bits&nbsp;of&nbsp;good&nbsp;and&nbsp;replicate&nbsp;the&nbsp;result&nbsp;across</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4132987">//&nbsp;all&nbsp;the&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133005"><a href="/crypto/tls/conn.go.html#4132476">good</a></span>&nbsp;<span class="op" id="4133010">&amp;=</span>&nbsp;<span class="ident" id="4133013"><a href="/crypto/tls/conn.go.html#4132476">good</a></span>&nbsp;<span class="op" id="4133018">&lt;&lt;</span>&nbsp;<span class="num" id="4133021">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133024"><a href="/crypto/tls/conn.go.html#4132476">good</a></span>&nbsp;<span class="op" id="4133029">&amp;=</span>&nbsp;<span class="ident" id="4133032"><a href="/crypto/tls/conn.go.html#4132476">good</a></span>&nbsp;<span class="op" id="4133037">&lt;&lt;</span>&nbsp;<span class="num" id="4133040">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133043"><a href="/crypto/tls/conn.go.html#4132476">good</a></span>&nbsp;<span class="op" id="4133048">&amp;=</span>&nbsp;<span class="ident" id="4133051"><a href="/crypto/tls/conn.go.html#4132476">good</a></span>&nbsp;<span class="op" id="4133056">&lt;&lt;</span>&nbsp;<span class="num" id="4133059">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133062"><a href="/crypto/tls/conn.go.html#4132476">good</a></span>&nbsp;<span class="op" id="4133067">=</span>&nbsp;<span class="builtintype" id="4133069">uint8</span><span class="op" id="4133074">(</span><span class="builtintype" id="4133075">int8</span><span class="op" id="4133079">(</span><span class="ident" id="4133080"><a href="/crypto/tls/conn.go.html#4132476">good</a></span><span class="op" id="4133084">)</span>&nbsp;<span class="op" id="4133086">&gt;&gt;</span>&nbsp;<span class="num" id="4133089">7</span><span class="op" id="4133090">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133094">toRemove</span>&nbsp;<span class="op" id="4133103">:=</span>&nbsp;<span class="ident" id="4133106"><a href="/crypto/tls/conn.go.html#4132476">good</a></span><span class="op" id="4133110">&amp;</span><span class="ident" id="4133111"><a href="/crypto/tls/conn.go.html#4132325">paddingLen</a></span>&nbsp;<span class="op" id="4133122">+</span>&nbsp;<span class="num" id="4133124">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133127">return</span>&nbsp;<span class="ident" id="4133134"><a href="/crypto/tls/conn.go.html#4132244">payload</a></span><span class="op" id="4133141">[</span><span class="op" id="4133142">:</span><span class="builtinfunc" id="4133143">len</span><span class="op" id="4133146">(</span><span class="ident" id="4133147"><a href="/crypto/tls/conn.go.html#4132244">payload</a></span><span class="op" id="4133154">)</span><span class="op" id="4133155">-</span><span class="builtintype" id="4133156">int</span><span class="op" id="4133159">(</span><span class="ident" id="4133160"><a href="/crypto/tls/conn.go.html#4133094">toRemove</a></span><span class="op" id="4133168">)</span><span class="op" id="4133169">]</span><span class="op" id="4133170">,</span>&nbsp;<span class="ident" id="4133172"><a href="/crypto/tls/conn.go.html#4132476">good</a></span><br>
<span class="lineno"></span><span class="op" id="4133177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment" id="4133180">//&nbsp;removePaddingSSL30&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;removePadding&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4133258">//&nbsp;protocol&nbsp;version&nbsp;is&nbsp;SSLv3.&nbsp;In&nbsp;this&nbsp;version,&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4133333">//&nbsp;are&nbsp;random&nbsp;and&nbsp;cannot&nbsp;be&nbsp;checked.</span><br>
<span class="lineno"></span><span class="keyword" id="4133370">func</span>&nbsp;<span class="ident" id="4133375">removePaddingSSL30</span><span class="op" id="4133393">(</span><span class="ident" id="4133394">payload</span>&nbsp;<span class="op" id="4133402">[</span><span class="op" id="4133403">]</span><span class="builtintype" id="4133404">byte</span><span class="op" id="4133408">)</span>&nbsp;<span class="op" id="4133410">(</span><span class="op" id="4133411">[</span><span class="op" id="4133412">]</span><span class="builtintype" id="4133413">byte</span><span class="op" id="4133417">,</span>&nbsp;<span class="builtintype" id="4133419">byte</span><span class="op" id="4133423">)</span>&nbsp;<span class="op" id="4133425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133428">if</span>&nbsp;<span class="builtinfunc" id="4133431">len</span><span class="op" id="4133434">(</span><span class="ident" id="4133435"><a href="/crypto/tls/conn.go.html#4133394">payload</a></span><span class="op" id="4133442">)</span>&nbsp;<span class="op" id="4133444">&lt;</span>&nbsp;<span class="num" id="4133446">1</span>&nbsp;<span class="op" id="4133448">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133452">return</span>&nbsp;<span class="ident" id="4133459"><a href="/crypto/tls/conn.go.html#4133394">payload</a></span><span class="op" id="4133466">,</span>&nbsp;<span class="num" id="4133468">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4133471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133475">paddingLen</span>&nbsp;<span class="op" id="4133486">:=</span>&nbsp;<span class="builtintype" id="4133489">int</span><span class="op" id="4133492">(</span><span class="ident" id="4133493"><a href="/crypto/tls/conn.go.html#4133394">payload</a></span><span class="op" id="4133500">[</span><span class="builtinfunc" id="4133501">len</span><span class="op" id="4133504">(</span><span class="ident" id="4133505"><a href="/crypto/tls/conn.go.html#4133394">payload</a></span><span class="op" id="4133512">)</span><span class="op" id="4133513">-</span><span class="num" id="4133514">1</span><span class="op" id="4133515">]</span><span class="op" id="4133516">)</span>&nbsp;<span class="op" id="4133518">+</span>&nbsp;<span class="num" id="4133520">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133523">if</span>&nbsp;<span class="ident" id="4133526"><a href="/crypto/tls/conn.go.html#4133475">paddingLen</a></span>&nbsp;<span class="op" id="4133537">&gt;</span>&nbsp;<span class="builtinfunc" id="4133539">len</span><span class="op" id="4133542">(</span><span class="ident" id="4133543"><a href="/crypto/tls/conn.go.html#4133394">payload</a></span><span class="op" id="4133550">)</span>&nbsp;<span class="op" id="4133552">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133556">return</span>&nbsp;<span class="ident" id="4133563"><a href="/crypto/tls/conn.go.html#4133394">payload</a></span><span class="op" id="4133570">,</span>&nbsp;<span class="num" id="4133572">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4133575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133579">return</span>&nbsp;<span class="ident" id="4133586"><a href="/crypto/tls/conn.go.html#4133394">payload</a></span><span class="op" id="4133593">[</span><span class="op" id="4133594">:</span><span class="builtinfunc" id="4133595">len</span><span class="op" id="4133598">(</span><span class="ident" id="4133599"><a href="/crypto/tls/conn.go.html#4133394">payload</a></span><span class="op" id="4133606">)</span><span class="op" id="4133607">-</span><span class="ident" id="4133608"><a href="/crypto/tls/conn.go.html#4133475">paddingLen</a></span><span class="op" id="4133618">]</span><span class="op" id="4133619">,</span>&nbsp;<span class="num" id="4133621">255</span><br>
<span class="lineno"></span><span class="op" id="4133625">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="4133628">func</span>&nbsp;<span class="ident" id="4133633">roundUp</span><span class="op" id="4133640">(</span><span class="ident" id="4133641">a</span><span class="op" id="4133642">,</span>&nbsp;<span class="ident" id="4133644">b</span>&nbsp;<span class="builtintype" id="4133646">int</span><span class="op" id="4133649">)</span>&nbsp;<span class="builtintype" id="4133651">int</span>&nbsp;<span class="op" id="4133655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133658">return</span>&nbsp;<span class="ident" id="4133665"><a href="/crypto/tls/conn.go.html#4133641">a</a></span>&nbsp;<span class="op" id="4133667">+</span>&nbsp;<span class="op" id="4133669">(</span><span class="ident" id="4133670"><a href="/crypto/tls/conn.go.html#4133644">b</a></span><span class="op" id="4133671">-</span><span class="ident" id="4133672"><a href="/crypto/tls/conn.go.html#4133641">a</a></span><span class="op" id="4133673">%</span><span class="ident" id="4133674"><a href="/crypto/tls/conn.go.html#4133644">b</a></span><span class="op" id="4133675">)</span><span class="op" id="4133676">%</span><span class="ident" id="4133677"><a href="/crypto/tls/conn.go.html#4133644">b</a></span><br>
<span class="lineno"></span><span class="op" id="4133679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="comment" id="4133682">//&nbsp;cbcMode&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;block&nbsp;ciphers&nbsp;using&nbsp;cipher&nbsp;block&nbsp;chaining.</span><br>
<span class="lineno"></span><span class="keyword" id="4133756">type</span>&nbsp;<span class="ident" id="4133761">cbcMode</span>&nbsp;<span class="keyword" id="4133769">interface</span>&nbsp;<span class="op" id="4133779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133782"><a href="/crypto/tls/conn.go.html#4127413">cipher</a></span><span class="op" id="4133788">.</span><span class="ident" id="4133789">BlockMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133800">SetIV</span><span class="op" id="4133805">(</span><span class="op" id="4133806">[</span><span class="op" id="4133807">]</span><span class="builtintype" id="4133808">byte</span><span class="op" id="4133812">)</span><br>
<span class="lineno"></span><span class="op" id="4133814">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="4133817">//&nbsp;decrypt&nbsp;checks&nbsp;and&nbsp;strips&nbsp;the&nbsp;mac&nbsp;and&nbsp;decrypts&nbsp;the&nbsp;data&nbsp;in&nbsp;b.&nbsp;Returns&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4133892">//&nbsp;success&nbsp;boolean,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;skip&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;record&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4133972">//&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;application&nbsp;payload,&nbsp;and&nbsp;an&nbsp;optional&nbsp;alert&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4134042">func</span>&nbsp;<span class="op" id="4134047">(</span><span class="ident" id="4134048">hc</span>&nbsp;<span class="op" id="4134051">*</span><span class="ident" id="4134052"><a href="/crypto/tls/conn.go.html#4130304">halfConn</a></span><span class="op" id="4134060">)</span>&nbsp;<span class="ident" id="4134062">decrypt</span><span class="op" id="4134069">(</span><span class="ident" id="4134070">b</span>&nbsp;<span class="op" id="4134072">*</span><span class="ident" id="4134073"><a href="/crypto/tls/conn.go.html#4139217">block</a></span><span class="op" id="4134078">)</span>&nbsp;<span class="op" id="4134080">(</span><span class="ident" id="4134081">ok</span>&nbsp;<span class="builtintype" id="4134084">bool</span><span class="op" id="4134088">,</span>&nbsp;<span class="ident" id="4134090">prefixLen</span>&nbsp;<span class="builtintype" id="4134100">int</span><span class="op" id="4134103">,</span>&nbsp;<span class="ident" id="4134105">alertValue</span>&nbsp;<span class="ident" id="4134116"><a href="/crypto/tls/alert.go.html#4095858">alert</a></span><span class="op" id="4134121">)</span>&nbsp;<span class="op" id="4134123">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4134126">//&nbsp;pull&nbsp;out&nbsp;payload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134147">payload</span>&nbsp;<span class="op" id="4134155">:=</span>&nbsp;<span class="ident" id="4134158"><a href="/crypto/tls/conn.go.html#4134070">b</a></span><span class="op" id="4134159">.</span><span class="ident" id="4134160">data</span><span class="op" id="4134164">[</span><span class="ident" id="4134165"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span><span class="op" id="4134180">:</span><span class="op" id="4134181">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134185">macSize</span>&nbsp;<span class="op" id="4134193">:=</span>&nbsp;<span class="num" id="4134196">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134199">if</span>&nbsp;<span class="ident" id="4134202"><a href="/crypto/tls/conn.go.html#4134048">hc</a></span><span class="op" id="4134204">.</span><span class="ident" id="4134205">mac</span>&nbsp;<span class="op" id="4134209">!=</span>&nbsp;<span class="ident" id="4134212">nil</span>&nbsp;<span class="op" id="4134216">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134220"><a href="/crypto/tls/conn.go.html#4134185">macSize</a></span>&nbsp;<span class="op" id="4134228">=</span>&nbsp;<span class="ident" id="4134230"><a href="/crypto/tls/conn.go.html#4134048">hc</a></span><span class="op" id="4134232">.</span><span class="ident" id="4134233">mac</span><span class="op" id="4134236">.</span><span class="ident" id="4134237">Size</span><span class="op" id="4134241">(</span><span class="op" id="4134242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4134245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134249">paddingGood</span>&nbsp;<span class="op" id="4134261">:=</span>&nbsp;<span class="builtintype" id="4134264">byte</span><span class="op" id="4134268">(</span><span class="num" id="4134269">255</span><span class="op" id="4134272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134275">explicitIVLen</span>&nbsp;<span class="op" id="4134289">:=</span>&nbsp;<span class="num" id="4134292">0</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4134296">//&nbsp;decrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134308">if</span>&nbsp;<span class="ident" id="4134311"><a href="/crypto/tls/conn.go.html#4134048">hc</a></span><span class="op" id="4134313">.</span><span class="ident" id="4134314">cipher</span>&nbsp;<span class="op" id="4134321">!=</span>&nbsp;<span class="ident" id="4134324">nil</span>&nbsp;<span class="op" id="4134328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134332">switch</span>&nbsp;<span class="ident" id="4134339">c</span>&nbsp;<span class="op" id="4134341">:=</span>&nbsp;<span class="ident" id="4134344"><a href="/crypto/tls/conn.go.html#4134048">hc</a></span><span class="op" id="4134346">.</span><span class="ident" id="4134347">cipher</span><span class="op" id="4134353">.</span><span class="op" id="4134354">(</span><span class="keyword" id="4134355">type</span><span class="op" id="4134359">)</span>&nbsp;<span class="op" id="4134361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134365">case</span>&nbsp;<span class="ident" id="4134370"><a href="/crypto/tls/conn.go.html#4127413">cipher</a></span><span class="op" id="4134376">.</span><span class="ident" id="4134377">Stream</span><span class="op" id="4134383">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134388"><a href="/crypto/tls/conn.go.html#4134339">c</a></span><span class="op" id="4134389">.</span><span class="ident" id="4134390">XORKeyStream</span><span class="op" id="4134402">(</span><span class="ident" id="4134403"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4134410">,</span>&nbsp;<span class="ident" id="4134412"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4134419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134423">case</span>&nbsp;<span class="ident" id="4134428"><a href="/crypto/tls/conn.go.html#4127413">cipher</a></span><span class="op" id="4134434">.</span><span class="ident" id="4134435">AEAD</span><span class="op" id="4134439">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134444"><a href="/crypto/tls/conn.go.html#4134275">explicitIVLen</a></span>&nbsp;<span class="op" id="4134458">=</span>&nbsp;<span class="num" id="4134460">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134465">if</span>&nbsp;<span class="builtinfunc" id="4134468">len</span><span class="op" id="4134471">(</span><span class="ident" id="4134472"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4134479">)</span>&nbsp;<span class="op" id="4134481">&lt;</span>&nbsp;<span class="ident" id="4134483"><a href="/crypto/tls/conn.go.html#4134275">explicitIVLen</a></span>&nbsp;<span class="op" id="4134497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134503">return</span>&nbsp;<span class="ident" id="4134510">false</span><span class="op" id="4134515">,</span>&nbsp;<span class="num" id="4134517">0</span><span class="op" id="4134518">,</span>&nbsp;<span class="ident" id="4134520"><a href="/crypto/tls/alert.go.html#4096032">alertBadRecordMAC</a></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4134541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134546">nonce</span>&nbsp;<span class="op" id="4134552">:=</span>&nbsp;<span class="ident" id="4134555"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4134562">[</span><span class="op" id="4134563">:</span><span class="num" id="4134564">8</span><span class="op" id="4134565">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134570"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span>&nbsp;<span class="op" id="4134578">=</span>&nbsp;<span class="ident" id="4134580"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4134587">[</span><span class="num" id="4134588">8</span><span class="op" id="4134589">:</span><span class="op" id="4134590">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134596">var</span>&nbsp;<span class="ident" id="4134600">additionalData</span>&nbsp;<span class="op" id="4134615">[</span><span class="num" id="4134616">13</span><span class="op" id="4134618">]</span><span class="builtintype" id="4134619">byte</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4134627">copy</span><span class="op" id="4134631">(</span><span class="ident" id="4134632"><a href="/crypto/tls/conn.go.html#4134600">additionalData</a></span><span class="op" id="4134646">[</span><span class="op" id="4134647">:</span><span class="op" id="4134648">]</span><span class="op" id="4134649">,</span>&nbsp;<span class="ident" id="4134651"><a href="/crypto/tls/conn.go.html#4134048">hc</a></span><span class="op" id="4134653">.</span><span class="ident" id="4134654">seq</span><span class="op" id="4134657">[</span><span class="op" id="4134658">:</span><span class="op" id="4134659">]</span><span class="op" id="4134660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4134665">copy</span><span class="op" id="4134669">(</span><span class="ident" id="4134670"><a href="/crypto/tls/conn.go.html#4134600">additionalData</a></span><span class="op" id="4134684">[</span><span class="num" id="4134685">8</span><span class="op" id="4134686">:</span><span class="op" id="4134687">]</span><span class="op" id="4134688">,</span>&nbsp;<span class="ident" id="4134690"><a href="/crypto/tls/conn.go.html#4134070">b</a></span><span class="op" id="4134691">.</span><span class="ident" id="4134692">data</span><span class="op" id="4134696">[</span><span class="op" id="4134697">:</span><span class="num" id="4134698">3</span><span class="op" id="4134699">]</span><span class="op" id="4134700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134705">n</span>&nbsp;<span class="op" id="4134707">:=</span>&nbsp;<span class="builtinfunc" id="4134710">len</span><span class="op" id="4134713">(</span><span class="ident" id="4134714"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4134721">)</span>&nbsp;<span class="op" id="4134723">-</span>&nbsp;<span class="ident" id="4134725"><a href="/crypto/tls/conn.go.html#4134339">c</a></span><span class="op" id="4134726">.</span><span class="ident" id="4134727">Overhead</span><span class="op" id="4134735">(</span><span class="op" id="4134736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134741"><a href="/crypto/tls/conn.go.html#4134600">additionalData</a></span><span class="op" id="4134755">[</span><span class="num" id="4134756">11</span><span class="op" id="4134758">]</span>&nbsp;<span class="op" id="4134760">=</span>&nbsp;<span class="builtintype" id="4134762">byte</span><span class="op" id="4134766">(</span><span class="ident" id="4134767"><a href="/crypto/tls/conn.go.html#4134705">n</a></span>&nbsp;<span class="op" id="4134769">&gt;&gt;</span>&nbsp;<span class="num" id="4134772">8</span><span class="op" id="4134773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134778"><a href="/crypto/tls/conn.go.html#4134600">additionalData</a></span><span class="op" id="4134792">[</span><span class="num" id="4134793">12</span><span class="op" id="4134795">]</span>&nbsp;<span class="op" id="4134797">=</span>&nbsp;<span class="builtintype" id="4134799">byte</span><span class="op" id="4134803">(</span><span class="ident" id="4134804"><a href="/crypto/tls/conn.go.html#4134705">n</a></span><span class="op" id="4134805">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134810">var</span>&nbsp;<span class="ident" id="4134814">err</span>&nbsp;<span class="builtintype" id="4134818">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134827"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4134834">,</span>&nbsp;<span class="ident" id="4134836"><a href="/crypto/tls/conn.go.html#4134814">err</a></span>&nbsp;<span class="op" id="4134840">=</span>&nbsp;<span class="ident" id="4134842"><a href="/crypto/tls/conn.go.html#4134339">c</a></span><span class="op" id="4134843">.</span><span class="ident" id="4134844">Open</span><span class="op" id="4134848">(</span><span class="ident" id="4134849"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4134856">[</span><span class="op" id="4134857">:</span><span class="num" id="4134858">0</span><span class="op" id="4134859">]</span><span class="op" id="4134860">,</span>&nbsp;<span class="ident" id="4134862"><a href="/crypto/tls/conn.go.html#4134546">nonce</a></span><span class="op" id="4134867">,</span>&nbsp;<span class="ident" id="4134869"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4134876">,</span>&nbsp;<span class="ident" id="4134878"><a href="/crypto/tls/conn.go.html#4134600">additionalData</a></span><span class="op" id="4134892">[</span><span class="op" id="4134893">:</span><span class="op" id="4134894">]</span><span class="op" id="4134895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134900">if</span>&nbsp;<span class="ident" id="4134903"><a href="/crypto/tls/conn.go.html#4134814">err</a></span>&nbsp;<span class="op" id="4134907">!=</span>&nbsp;<span class="ident" id="4134910">nil</span>&nbsp;<span class="op" id="4134914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134920">return</span>&nbsp;<span class="ident" id="4134927">false</span><span class="op" id="4134932">,</span>&nbsp;<span class="num" id="4134934">0</span><span class="op" id="4134935">,</span>&nbsp;<span class="ident" id="4134937"><a href="/crypto/tls/alert.go.html#4096032">alertBadRecordMAC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4134958">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134963"><a href="/crypto/tls/conn.go.html#4134070">b</a></span><span class="op" id="4134964">.</span><span class="ident" id="4134965">resize</span><span class="op" id="4134971">(</span><span class="ident" id="4134972"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span>&nbsp;<span class="op" id="4134988">+</span>&nbsp;<span class="ident" id="4134990"><a href="/crypto/tls/conn.go.html#4134275">explicitIVLen</a></span>&nbsp;<span class="op" id="4135004">+</span>&nbsp;<span class="builtinfunc" id="4135006">len</span><span class="op" id="4135009">(</span><span class="ident" id="4135010"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4135017">)</span><span class="op" id="4135018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4135022">case</span>&nbsp;<span class="ident" id="4135027"><a href="/crypto/tls/conn.go.html#4133761">cbcMode</a></span><span class="op" id="4135034">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4135039">blockSize</span>&nbsp;<span class="op" id="4135049">:=</span>&nbsp;<span class="ident" id="4135052"><a href="/crypto/tls/conn.go.html#4134339">c</a></span><span class="op" id="4135053">.</span><span class="ident" id="4135054">BlockSize</span><span class="op" id="4135063">(</span><span class="op" id="4135064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4135069">if</span>&nbsp;<span class="ident" id="4135072"><a href="/crypto/tls/conn.go.html#4134048">hc</a></span><span class="op" id="4135074">.</span><span class="ident" id="4135075">version</span>&nbsp;<span class="op" id="4135083">&gt;=</span>&nbsp;<span class="ident" id="4135086"><a href="/crypto/tls/common.go.html#4108182">VersionTLS11</a></span>&nbsp;<span class="op" id="4135099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4135105"><a href="/crypto/tls/conn.go.html#4134275">explicitIVLen</a></span>&nbsp;<span class="op" id="4135119">=</span>&nbsp;<span class="ident" id="4135121"><a href="/crypto/tls/conn.go.html#4135039">blockSize</a></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4135134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4135140">if</span>&nbsp;<span class="builtinfunc" id="4135143">len</span><span class="op" id="4135146">(</span><span class="ident" id="4135147"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4135154">)</span><span class="op" id="4135155">%</span><span class="ident" id="4135156"><a href="/crypto/tls/conn.go.html#4135039">blockSize</a></span>&nbsp;<span class="op" id="4135166">!=</span>&nbsp;<span class="num" id="4135169">0</span>&nbsp;<span class="op" id="4135171">||</span>&nbsp;<span class="builtinfunc" id="4135174">len</span><span class="op" id="4135177">(</span><span class="ident" id="4135178"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4135185">)</span>&nbsp;<span class="op" id="4135187">&lt;</span>&nbsp;<span class="ident" id="4135189"><a href="/crypto/tls/conn.go.html#4133633">roundUp</a></span><span class="op" id="4135196">(</span><span class="ident" id="4135197"><a href="/crypto/tls/conn.go.html#4134275">explicitIVLen</a></span><span class="op" id="4135210">+</span><span class="ident" id="4135211"><a href="/crypto/tls/conn.go.html#4134185">macSize</a></span><span class="op" id="4135218">+</span><span class="num" id="4135219">1</span><span class="op" id="4135220">,</span>&nbsp;<span class="ident" id="4135222"><a href="/crypto/tls/conn.go.html#4135039">blockSize</a></span><span class="op" id="4135231">)</span>&nbsp;<span class="op" id="4135233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4135239">return</span>&nbsp;<span class="ident" id="4135246">false</span><span class="op" id="4135251">,</span>&nbsp;<span class="num" id="4135253">0</span><span class="op" id="4135254">,</span>&nbsp;<span class="ident" id="4135256"><a href="/crypto/tls/alert.go.html#4096032">alertBadRecordMAC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4135277">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4135283">if</span>&nbsp;<span class="ident" id="4135286"><a href="/crypto/tls/conn.go.html#4134275">explicitIVLen</a></span>&nbsp;<span class="op" id="4135300">&gt;</span>&nbsp;<span class="num" id="4135302">0</span>&nbsp;<span class="op" id="4135304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4135310"><a href="/crypto/tls/conn.go.html#4134339">c</a></span><span class="op" id="4135311">.</span><span class="ident" id="4135312">SetIV</span><span class="op" id="4135317">(</span><span class="ident" id="4135318"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4135325">[</span><span class="op" id="4135326">:</span><span class="ident" id="4135327"><a href="/crypto/tls/conn.go.html#4134275">explicitIVLen</a></span><span class="op" id="4135340">]</span><span class="op" id="4135341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4135347"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span>&nbsp;<span class="op" id="4135355">=</span>&nbsp;<span class="ident" id="4135357"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4135364">[</span><span class="ident" id="4135365"><a href="/crypto/tls/conn.go.html#4134275">explicitIVLen</a></span><span class="op" id="4135378">:</span><span class="op" id="4135379">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4135384">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4135389"><a href="/crypto/tls/conn.go.html#4134339">c</a></span><span class="op" id="4135390">.</span><span class="ident" id="4135391">CryptBlocks</span><span class="op" id="4135402">(</span><span class="ident" id="4135403"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4135410">,</span>&nbsp;<span class="ident" id="4135412"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4135419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4135424">if</span>&nbsp;<span class="ident" id="4135427"><a href="/crypto/tls/conn.go.html#4134048">hc</a></span><span class="op" id="4135429">.</span><span class="ident" id="4135430">version</span>&nbsp;<span class="op" id="4135438">==</span>&nbsp;<span class="ident" id="4135441"><a href="/crypto/tls/common.go.html#4108136">VersionSSL30</a></span>&nbsp;<span class="op" id="4135454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4135460"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4135467">,</span>&nbsp;<span class="ident" id="4135469"><a href="/crypto/tls/conn.go.html#4134249">paddingGood</a></span>&nbsp;<span class="op" id="4135481">=</span>&nbsp;<span class="ident" id="4135483"><a href="/crypto/tls/conn.go.html#4133375">removePaddingSSL30</a></span><span class="op" id="4135501">(</span><span class="ident" id="4135502"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4135509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4135514">}</span>&nbsp;<span class="keyword" id="4135516">else</span>&nbsp;<span class="op" id="4135521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4135527"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4135534">,</span>&nbsp;<span class="ident" id="4135536"><a href="/crypto/tls/conn.go.html#4134249">paddingGood</a></span>&nbsp;<span class="op" id="4135548">=</span>&nbsp;<span class="ident" id="4135550"><a href="/crypto/tls/conn.go.html#4132230">removePadding</a></span><span class="op" id="4135563">(</span><span class="ident" id="4135564"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4135571">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4135576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4135581"><a href="/crypto/tls/conn.go.html#4134070">b</a></span><span class="op" id="4135582">.</span><span class="ident" id="4135583">resize</span><span class="op" id="4135589">(</span><span class="ident" id="4135590"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span>&nbsp;<span class="op" id="4135606">+</span>&nbsp;<span class="ident" id="4135608"><a href="/crypto/tls/conn.go.html#4134275">explicitIVLen</a></span>&nbsp;<span class="op" id="4135622">+</span>&nbsp;<span class="builtinfunc" id="4135624">len</span><span class="op" id="4135627">(</span><span class="ident" id="4135628"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4135635">)</span><span class="op" id="4135636">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4135642">//&nbsp;note&nbsp;that&nbsp;we&nbsp;still&nbsp;have&nbsp;a&nbsp;timing&nbsp;side-channel&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4135701">//&nbsp;MAC&nbsp;check,&nbsp;below.&nbsp;An&nbsp;attacker&nbsp;can&nbsp;align&nbsp;the&nbsp;record</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4135758">//&nbsp;so&nbsp;that&nbsp;a&nbsp;correct&nbsp;padding&nbsp;will&nbsp;cause&nbsp;one&nbsp;less&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4135815">//&nbsp;block&nbsp;to&nbsp;be&nbsp;calculated.&nbsp;Then&nbsp;they&nbsp;can&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4135871">//&nbsp;decrypt&nbsp;a&nbsp;record&nbsp;by&nbsp;breaking&nbsp;each&nbsp;byte.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4135921">//&nbsp;&#34;Password&nbsp;Interception&nbsp;in&nbsp;a&nbsp;SSL/TLS&nbsp;Channel&#34;,&nbsp;Brice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4135979">//&nbsp;Canvel&nbsp;et&nbsp;al.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4135999">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4136005">//&nbsp;However,&nbsp;our&nbsp;behavior&nbsp;matches&nbsp;OpenSSL,&nbsp;so&nbsp;we&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4136061">//&nbsp;only&nbsp;as&nbsp;much&nbsp;as&nbsp;they&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4136091">default</span><span class="op" id="4136098">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4136103">panic</span><span class="op" id="4136108">(</span><span class="string" id="4136109">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4136130">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4136134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4136137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4136141">//&nbsp;check,&nbsp;strip&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4136162">if</span>&nbsp;<span class="ident" id="4136165"><a href="/crypto/tls/conn.go.html#4134048">hc</a></span><span class="op" id="4136167">.</span><span class="ident" id="4136168">mac</span>&nbsp;<span class="op" id="4136172">!=</span>&nbsp;<span class="ident" id="4136175">nil</span>&nbsp;<span class="op" id="4136179">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4136183">if</span>&nbsp;<span class="builtinfunc" id="4136186">len</span><span class="op" id="4136189">(</span><span class="ident" id="4136190"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4136197">)</span>&nbsp;<span class="op" id="4136199">&lt;</span>&nbsp;<span class="ident" id="4136201"><a href="/crypto/tls/conn.go.html#4134185">macSize</a></span>&nbsp;<span class="op" id="4136209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4136214">return</span>&nbsp;<span class="ident" id="4136221">false</span><span class="op" id="4136226">,</span>&nbsp;<span class="num" id="4136228">0</span><span class="op" id="4136229">,</span>&nbsp;<span class="ident" id="4136231"><a href="/crypto/tls/alert.go.html#4096032">alertBadRecordMAC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4136251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4136256">//&nbsp;strip&nbsp;mac&nbsp;off&nbsp;payload,&nbsp;b.data</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4136291">n</span>&nbsp;<span class="op" id="4136293">:=</span>&nbsp;<span class="builtinfunc" id="4136296">len</span><span class="op" id="4136299">(</span><span class="ident" id="4136300"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4136307">)</span>&nbsp;<span class="op" id="4136309">-</span>&nbsp;<span class="ident" id="4136311"><a href="/crypto/tls/conn.go.html#4134185">macSize</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4136321"><a href="/crypto/tls/conn.go.html#4134070">b</a></span><span class="op" id="4136322">.</span><span class="ident" id="4136323">data</span><span class="op" id="4136327">[</span><span class="num" id="4136328">3</span><span class="op" id="4136329">]</span>&nbsp;<span class="op" id="4136331">=</span>&nbsp;<span class="builtintype" id="4136333">byte</span><span class="op" id="4136337">(</span><span class="ident" id="4136338"><a href="/crypto/tls/conn.go.html#4136291">n</a></span>&nbsp;<span class="op" id="4136340">&gt;&gt;</span>&nbsp;<span class="num" id="4136343">8</span><span class="op" id="4136344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4136348"><a href="/crypto/tls/conn.go.html#4134070">b</a></span><span class="op" id="4136349">.</span><span class="ident" id="4136350">data</span><span class="op" id="4136354">[</span><span class="num" id="4136355">4</span><span class="op" id="4136356">]</span>&nbsp;<span class="op" id="4136358">=</span>&nbsp;<span class="builtintype" id="4136360">byte</span><span class="op" id="4136364">(</span><span class="ident" id="4136365"><a href="/crypto/tls/conn.go.html#4136291">n</a></span><span class="op" id="4136366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4136370"><a href="/crypto/tls/conn.go.html#4134070">b</a></span><span class="op" id="4136371">.</span><span class="ident" id="4136372">resize</span><span class="op" id="4136378">(</span><span class="ident" id="4136379"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span>&nbsp;<span class="op" id="4136395">+</span>&nbsp;<span class="ident" id="4136397"><a href="/crypto/tls/conn.go.html#4134275">explicitIVLen</a></span>&nbsp;<span class="op" id="4136411">+</span>&nbsp;<span class="ident" id="4136413"><a href="/crypto/tls/conn.go.html#4136291">n</a></span><span class="op" id="4136414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4136418">remoteMAC</span>&nbsp;<span class="op" id="4136428">:=</span>&nbsp;<span class="ident" id="4136431"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4136438">[</span><span class="ident" id="4136439"><a href="/crypto/tls/conn.go.html#4136291">n</a></span><span class="op" id="4136440">:</span><span class="op" id="4136441">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4136445">localMAC</span>&nbsp;<span class="op" id="4136454">:=</span>&nbsp;<span class="ident" id="4136457"><a href="/crypto/tls/conn.go.html#4134048">hc</a></span><span class="op" id="4136459">.</span><span class="ident" id="4136460">mac</span><span class="op" id="4136463">.</span><span class="ident" id="4136464">MAC</span><span class="op" id="4136467">(</span><span class="ident" id="4136468"><a href="/crypto/tls/conn.go.html#4134048">hc</a></span><span class="op" id="4136470">.</span><span class="ident" id="4136471">inDigestBuf</span><span class="op" id="4136482">,</span>&nbsp;<span class="ident" id="4136484"><a href="/crypto/tls/conn.go.html#4134048">hc</a></span><span class="op" id="4136486">.</span><span class="ident" id="4136487">seq</span><span class="op" id="4136490">[</span><span class="num" id="4136491">0</span><span class="op" id="4136492">:</span><span class="op" id="4136493">]</span><span class="op" id="4136494">,</span>&nbsp;<span class="ident" id="4136496"><a href="/crypto/tls/conn.go.html#4134070">b</a></span><span class="op" id="4136497">.</span><span class="ident" id="4136498">data</span><span class="op" id="4136502">[</span><span class="op" id="4136503">:</span><span class="ident" id="4136504"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span><span class="op" id="4136519">]</span><span class="op" id="4136520">,</span>&nbsp;<span class="ident" id="4136522"><a href="/crypto/tls/conn.go.html#4134147">payload</a></span><span class="op" id="4136529">[</span><span class="op" id="4136530">:</span><span class="ident" id="4136531"><a href="/crypto/tls/conn.go.html#4136291">n</a></span><span class="op" id="4136532">]</span><span class="op" id="4136533">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4136538">if</span>&nbsp;<span class="ident" id="4136541"><a href="/crypto/tls/conn.go.html#4127430">subtle</a></span><span class="op" id="4136547">.</span><span class="ident" id="4136548">ConstantTimeCompare</span><span class="op" id="4136567">(</span><span class="ident" id="4136568"><a href="/crypto/tls/conn.go.html#4136445">localMAC</a></span><span class="op" id="4136576">,</span>&nbsp;<span class="ident" id="4136578"><a href="/crypto/tls/conn.go.html#4136418">remoteMAC</a></span><span class="op" id="4136587">)</span>&nbsp;<span class="op" id="4136589">!=</span>&nbsp;<span class="num" id="4136592">1</span>&nbsp;<span class="op" id="4136594">||</span>&nbsp;<span class="ident" id="4136597"><a href="/crypto/tls/conn.go.html#4134249">paddingGood</a></span>&nbsp;<span class="op" id="4136609">!=</span>&nbsp;<span class="num" id="4136612">255</span>&nbsp;<span class="op" id="4136616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4136621">return</span>&nbsp;<span class="ident" id="4136628">false</span><span class="op" id="4136633">,</span>&nbsp;<span class="num" id="4136635">0</span><span class="op" id="4136636">,</span>&nbsp;<span class="ident" id="4136638"><a href="/crypto/tls/alert.go.html#4096032">alertBadRecordMAC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4136658">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4136662"><a href="/crypto/tls/conn.go.html#4134048">hc</a></span><span class="op" id="4136664">.</span><span class="ident" id="4136665">inDigestBuf</span>&nbsp;<span class="op" id="4136677">=</span>&nbsp;<span class="ident" id="4136679"><a href="/crypto/tls/conn.go.html#4136445">localMAC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4136689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4136692"><a href="/crypto/tls/conn.go.html#4134048">hc</a></span><span class="op" id="4136694">.</span><span class="ident" id="4136695">incSeq</span><span class="op" id="4136701">(</span><span class="op" id="4136702">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4136706">return</span>&nbsp;<span class="ident" id="4136713">true</span><span class="op" id="4136717">,</span>&nbsp;<span class="ident" id="4136719"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span>&nbsp;<span class="op" id="4136735">+</span>&nbsp;<span class="ident" id="4136737"><a href="/crypto/tls/conn.go.html#4134275">explicitIVLen</a></span><span class="op" id="4136750">,</span>&nbsp;<span class="num" id="4136752">0</span><br>
<span class="lineno">335</span><span class="op" id="4136754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4136757">//&nbsp;padToBlockSize&nbsp;calculates&nbsp;the&nbsp;needed&nbsp;padding&nbsp;block,&nbsp;if&nbsp;any,&nbsp;for&nbsp;a&nbsp;payload.</span><br>
<span class="lineno"></span><span class="comment" id="4136835">//&nbsp;On&nbsp;exit,&nbsp;prefix&nbsp;aliases&nbsp;payload&nbsp;and&nbsp;extends&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;last&nbsp;full</span><br>
<span class="lineno"></span><span class="comment" id="4136910">//&nbsp;block&nbsp;of&nbsp;payload.&nbsp;finalBlock&nbsp;is&nbsp;a&nbsp;fresh&nbsp;slice&nbsp;which&nbsp;contains&nbsp;the&nbsp;contents&nbsp;of</span><br>
<span class="lineno">340</span><span class="comment" id="4136990">//&nbsp;any&nbsp;suffix&nbsp;of&nbsp;payload&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;needed&nbsp;padding&nbsp;to&nbsp;make&nbsp;finalBlock&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4137066">//&nbsp;full&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="4137081">func</span>&nbsp;<span class="ident" id="4137086">padToBlockSize</span><span class="op" id="4137100">(</span><span class="ident" id="4137101">payload</span>&nbsp;<span class="op" id="4137109">[</span><span class="op" id="4137110">]</span><span class="builtintype" id="4137111">byte</span><span class="op" id="4137115">,</span>&nbsp;<span class="ident" id="4137117">blockSize</span>&nbsp;<span class="builtintype" id="4137127">int</span><span class="op" id="4137130">)</span>&nbsp;<span class="op" id="4137132">(</span><span class="ident" id="4137133">prefix</span><span class="op" id="4137139">,</span>&nbsp;<span class="ident" id="4137141">finalBlock</span>&nbsp;<span class="op" id="4137152">[</span><span class="op" id="4137153">]</span><span class="builtintype" id="4137154">byte</span><span class="op" id="4137158">)</span>&nbsp;<span class="op" id="4137160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4137163">overrun</span>&nbsp;<span class="op" id="4137171">:=</span>&nbsp;<span class="builtinfunc" id="4137174">len</span><span class="op" id="4137177">(</span><span class="ident" id="4137178"><a href="/crypto/tls/conn.go.html#4137101">payload</a></span><span class="op" id="4137185">)</span>&nbsp;<span class="op" id="4137187">%</span>&nbsp;<span class="ident" id="4137189"><a href="/crypto/tls/conn.go.html#4137117">blockSize</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4137200">paddingLen</span>&nbsp;<span class="op" id="4137211">:=</span>&nbsp;<span class="ident" id="4137214"><a href="/crypto/tls/conn.go.html#4137117">blockSize</a></span>&nbsp;<span class="op" id="4137224">-</span>&nbsp;<span class="ident" id="4137226"><a href="/crypto/tls/conn.go.html#4137163">overrun</a></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4137235"><a href="/crypto/tls/conn.go.html#4137133">prefix</a></span>&nbsp;<span class="op" id="4137242">=</span>&nbsp;<span class="ident" id="4137244"><a href="/crypto/tls/conn.go.html#4137101">payload</a></span><span class="op" id="4137251">[</span><span class="op" id="4137252">:</span><span class="builtinfunc" id="4137253">len</span><span class="op" id="4137256">(</span><span class="ident" id="4137257"><a href="/crypto/tls/conn.go.html#4137101">payload</a></span><span class="op" id="4137264">)</span><span class="op" id="4137265">-</span><span class="ident" id="4137266"><a href="/crypto/tls/conn.go.html#4137163">overrun</a></span><span class="op" id="4137273">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4137276"><a href="/crypto/tls/conn.go.html#4137141">finalBlock</a></span>&nbsp;<span class="op" id="4137287">=</span>&nbsp;<span class="builtinfunc" id="4137289">make</span><span class="op" id="4137293">(</span><span class="op" id="4137294">[</span><span class="op" id="4137295">]</span><span class="builtintype" id="4137296">byte</span><span class="op" id="4137300">,</span>&nbsp;<span class="ident" id="4137302"><a href="/crypto/tls/conn.go.html#4137117">blockSize</a></span><span class="op" id="4137311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4137314">copy</span><span class="op" id="4137318">(</span><span class="ident" id="4137319"><a href="/crypto/tls/conn.go.html#4137141">finalBlock</a></span><span class="op" id="4137329">,</span>&nbsp;<span class="ident" id="4137331"><a href="/crypto/tls/conn.go.html#4137101">payload</a></span><span class="op" id="4137338">[</span><span class="builtinfunc" id="4137339">len</span><span class="op" id="4137342">(</span><span class="ident" id="4137343"><a href="/crypto/tls/conn.go.html#4137101">payload</a></span><span class="op" id="4137350">)</span><span class="op" id="4137351">-</span><span class="ident" id="4137352"><a href="/crypto/tls/conn.go.html#4137163">overrun</a></span><span class="op" id="4137359">:</span><span class="op" id="4137360">]</span><span class="op" id="4137361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4137364">for</span>&nbsp;<span class="ident" id="4137368">i</span>&nbsp;<span class="op" id="4137370">:=</span>&nbsp;<span class="ident" id="4137373"><a href="/crypto/tls/conn.go.html#4137163">overrun</a></span><span class="op" id="4137380">;</span>&nbsp;<span class="ident" id="4137382"><a href="/crypto/tls/conn.go.html#4137368">i</a></span>&nbsp;<span class="op" id="4137384">&lt;</span>&nbsp;<span class="ident" id="4137386"><a href="/crypto/tls/conn.go.html#4137117">blockSize</a></span><span class="op" id="4137395">;</span>&nbsp;<span class="ident" id="4137397"><a href="/crypto/tls/conn.go.html#4137368">i</a></span><span class="op" id="4137398">++</span>&nbsp;<span class="op" id="4137401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4137405"><a href="/crypto/tls/conn.go.html#4137141">finalBlock</a></span><span class="op" id="4137415">[</span><span class="ident" id="4137416"><a href="/crypto/tls/conn.go.html#4137368">i</a></span><span class="op" id="4137417">]</span>&nbsp;<span class="op" id="4137419">=</span>&nbsp;<span class="builtintype" id="4137421">byte</span><span class="op" id="4137425">(</span><span class="ident" id="4137426"><a href="/crypto/tls/conn.go.html#4137200">paddingLen</a></span>&nbsp;<span class="op" id="4137437">-</span>&nbsp;<span class="num" id="4137439">1</span><span class="op" id="4137440">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4137443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4137446">return</span><br>
<span class="lineno"></span><span class="op" id="4137453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4137456">//&nbsp;encrypt&nbsp;encrypts&nbsp;and&nbsp;macs&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno">355</span><span class="keyword" id="4137500">func</span>&nbsp;<span class="op" id="4137505">(</span><span class="ident" id="4137506">hc</span>&nbsp;<span class="op" id="4137509">*</span><span class="ident" id="4137510"><a href="/crypto/tls/conn.go.html#4130304">halfConn</a></span><span class="op" id="4137518">)</span>&nbsp;<span class="ident" id="4137520">encrypt</span><span class="op" id="4137527">(</span><span class="ident" id="4137528">b</span>&nbsp;<span class="op" id="4137530">*</span><span class="ident" id="4137531"><a href="/crypto/tls/conn.go.html#4139217">block</a></span><span class="op" id="4137536">,</span>&nbsp;<span class="ident" id="4137538">explicitIVLen</span>&nbsp;<span class="builtintype" id="4137552">int</span><span class="op" id="4137555">)</span>&nbsp;<span class="op" id="4137557">(</span><span class="builtintype" id="4137558">bool</span><span class="op" id="4137562">,</span>&nbsp;<span class="ident" id="4137564"><a href="/crypto/tls/alert.go.html#4095858">alert</a></span><span class="op" id="4137569">)</span>&nbsp;<span class="op" id="4137571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4137574">//&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4137582">if</span>&nbsp;<span class="ident" id="4137585"><a href="/crypto/tls/conn.go.html#4137506">hc</a></span><span class="op" id="4137587">.</span><span class="ident" id="4137588">mac</span>&nbsp;<span class="op" id="4137592">!=</span>&nbsp;<span class="ident" id="4137595">nil</span>&nbsp;<span class="op" id="4137599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4137603">mac</span>&nbsp;<span class="op" id="4137607">:=</span>&nbsp;<span class="ident" id="4137610"><a href="/crypto/tls/conn.go.html#4137506">hc</a></span><span class="op" id="4137612">.</span><span class="ident" id="4137613">mac</span><span class="op" id="4137616">.</span><span class="ident" id="4137617">MAC</span><span class="op" id="4137620">(</span><span class="ident" id="4137621"><a href="/crypto/tls/conn.go.html#4137506">hc</a></span><span class="op" id="4137623">.</span><span class="ident" id="4137624">outDigestBuf</span><span class="op" id="4137636">,</span>&nbsp;<span class="ident" id="4137638"><a href="/crypto/tls/conn.go.html#4137506">hc</a></span><span class="op" id="4137640">.</span><span class="ident" id="4137641">seq</span><span class="op" id="4137644">[</span><span class="num" id="4137645">0</span><span class="op" id="4137646">:</span><span class="op" id="4137647">]</span><span class="op" id="4137648">,</span>&nbsp;<span class="ident" id="4137650"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4137651">.</span><span class="ident" id="4137652">data</span><span class="op" id="4137656">[</span><span class="op" id="4137657">:</span><span class="ident" id="4137658"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span><span class="op" id="4137673">]</span><span class="op" id="4137674">,</span>&nbsp;<span class="ident" id="4137676"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4137677">.</span><span class="ident" id="4137678">data</span><span class="op" id="4137682">[</span><span class="ident" id="4137683"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span><span class="op" id="4137698">+</span><span class="ident" id="4137699"><a href="/crypto/tls/conn.go.html#4137538">explicitIVLen</a></span><span class="op" id="4137712">:</span><span class="op" id="4137713">]</span><span class="op" id="4137714">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4137719">n</span>&nbsp;<span class="op" id="4137721">:=</span>&nbsp;<span class="builtinfunc" id="4137724">len</span><span class="op" id="4137727">(</span><span class="ident" id="4137728"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4137729">.</span><span class="ident" id="4137730">data</span><span class="op" id="4137734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4137738"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4137739">.</span><span class="ident" id="4137740">resize</span><span class="op" id="4137746">(</span><span class="ident" id="4137747"><a href="/crypto/tls/conn.go.html#4137719">n</a></span>&nbsp;<span class="op" id="4137749">+</span>&nbsp;<span class="builtinfunc" id="4137751">len</span><span class="op" id="4137754">(</span><span class="ident" id="4137755"><a href="/crypto/tls/conn.go.html#4137603">mac</a></span><span class="op" id="4137758">)</span><span class="op" id="4137759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4137763">copy</span><span class="op" id="4137767">(</span><span class="ident" id="4137768"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4137769">.</span><span class="ident" id="4137770">data</span><span class="op" id="4137774">[</span><span class="ident" id="4137775"><a href="/crypto/tls/conn.go.html#4137719">n</a></span><span class="op" id="4137776">:</span><span class="op" id="4137777">]</span><span class="op" id="4137778">,</span>&nbsp;<span class="ident" id="4137780"><a href="/crypto/tls/conn.go.html#4137603">mac</a></span><span class="op" id="4137783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4137787"><a href="/crypto/tls/conn.go.html#4137506">hc</a></span><span class="op" id="4137789">.</span><span class="ident" id="4137790">outDigestBuf</span>&nbsp;<span class="op" id="4137803">=</span>&nbsp;<span class="ident" id="4137805"><a href="/crypto/tls/conn.go.html#4137603">mac</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4137810">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4137814">payload</span>&nbsp;<span class="op" id="4137822">:=</span>&nbsp;<span class="ident" id="4137825"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4137826">.</span><span class="ident" id="4137827">data</span><span class="op" id="4137831">[</span><span class="ident" id="4137832"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span><span class="op" id="4137847">:</span><span class="op" id="4137848">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4137852">//&nbsp;encrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4137864">if</span>&nbsp;<span class="ident" id="4137867"><a href="/crypto/tls/conn.go.html#4137506">hc</a></span><span class="op" id="4137869">.</span><span class="ident" id="4137870">cipher</span>&nbsp;<span class="op" id="4137877">!=</span>&nbsp;<span class="ident" id="4137880">nil</span>&nbsp;<span class="op" id="4137884">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4137888">switch</span>&nbsp;<span class="ident" id="4137895">c</span>&nbsp;<span class="op" id="4137897">:=</span>&nbsp;<span class="ident" id="4137900"><a href="/crypto/tls/conn.go.html#4137506">hc</a></span><span class="op" id="4137902">.</span><span class="ident" id="4137903">cipher</span><span class="op" id="4137909">.</span><span class="op" id="4137910">(</span><span class="keyword" id="4137911">type</span><span class="op" id="4137915">)</span>&nbsp;<span class="op" id="4137917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4137921">case</span>&nbsp;<span class="ident" id="4137926"><a href="/crypto/tls/conn.go.html#4127413">cipher</a></span><span class="op" id="4137932">.</span><span class="ident" id="4137933">Stream</span><span class="op" id="4137939">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4137944"><a href="/crypto/tls/conn.go.html#4137895">c</a></span><span class="op" id="4137945">.</span><span class="ident" id="4137946">XORKeyStream</span><span class="op" id="4137958">(</span><span class="ident" id="4137959"><a href="/crypto/tls/conn.go.html#4137814">payload</a></span><span class="op" id="4137966">,</span>&nbsp;<span class="ident" id="4137968"><a href="/crypto/tls/conn.go.html#4137814">payload</a></span><span class="op" id="4137975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4137979">case</span>&nbsp;<span class="ident" id="4137984"><a href="/crypto/tls/conn.go.html#4127413">cipher</a></span><span class="op" id="4137990">.</span><span class="ident" id="4137991">AEAD</span><span class="op" id="4137995">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4138000">payloadLen</span>&nbsp;<span class="op" id="4138011">:=</span>&nbsp;<span class="builtinfunc" id="4138014">len</span><span class="op" id="4138017">(</span><span class="ident" id="4138018"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4138019">.</span><span class="ident" id="4138020">data</span><span class="op" id="4138024">)</span>&nbsp;<span class="op" id="4138026">-</span>&nbsp;<span class="ident" id="4138028"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span>&nbsp;<span class="op" id="4138044">-</span>&nbsp;<span class="ident" id="4138046"><a href="/crypto/tls/conn.go.html#4137538">explicitIVLen</a></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4138063"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4138064">.</span><span class="ident" id="4138065">resize</span><span class="op" id="4138071">(</span><span class="builtinfunc" id="4138072">len</span><span class="op" id="4138075">(</span><span class="ident" id="4138076"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4138077">.</span><span class="ident" id="4138078">data</span><span class="op" id="4138082">)</span>&nbsp;<span class="op" id="4138084">+</span>&nbsp;<span class="ident" id="4138086"><a href="/crypto/tls/conn.go.html#4137895">c</a></span><span class="op" id="4138087">.</span><span class="ident" id="4138088">Overhead</span><span class="op" id="4138096">(</span><span class="op" id="4138097">)</span><span class="op" id="4138098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4138103">nonce</span>&nbsp;<span class="op" id="4138109">:=</span>&nbsp;<span class="ident" id="4138112"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4138113">.</span><span class="ident" id="4138114">data</span><span class="op" id="4138118">[</span><span class="ident" id="4138119"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span>&nbsp;<span class="op" id="4138135">:</span>&nbsp;<span class="ident" id="4138137"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span><span class="op" id="4138152">+</span><span class="ident" id="4138153"><a href="/crypto/tls/conn.go.html#4137538">explicitIVLen</a></span><span class="op" id="4138166">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4138171">payload</span>&nbsp;<span class="op" id="4138179">:=</span>&nbsp;<span class="ident" id="4138182"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4138183">.</span><span class="ident" id="4138184">data</span><span class="op" id="4138188">[</span><span class="ident" id="4138189"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span><span class="op" id="4138204">+</span><span class="ident" id="4138205"><a href="/crypto/tls/conn.go.html#4137538">explicitIVLen</a></span><span class="op" id="4138218">:</span><span class="op" id="4138219">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4138224"><a href="/crypto/tls/conn.go.html#4138171">payload</a></span>&nbsp;<span class="op" id="4138232">=</span>&nbsp;<span class="ident" id="4138234"><a href="/crypto/tls/conn.go.html#4138171">payload</a></span><span class="op" id="4138241">[</span><span class="op" id="4138242">:</span><span class="ident" id="4138243"><a href="/crypto/tls/conn.go.html#4138000">payloadLen</a></span><span class="op" id="4138253">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4138259">var</span>&nbsp;<span class="ident" id="4138263">additionalData</span>&nbsp;<span class="op" id="4138278">[</span><span class="num" id="4138279">13</span><span class="op" id="4138281">]</span><span class="builtintype" id="4138282">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4138290">copy</span><span class="op" id="4138294">(</span><span class="ident" id="4138295"><a href="/crypto/tls/conn.go.html#4138263">additionalData</a></span><span class="op" id="4138309">[</span><span class="op" id="4138310">:</span><span class="op" id="4138311">]</span><span class="op" id="4138312">,</span>&nbsp;<span class="ident" id="4138314"><a href="/crypto/tls/conn.go.html#4137506">hc</a></span><span class="op" id="4138316">.</span><span class="ident" id="4138317">seq</span><span class="op" id="4138320">[</span><span class="op" id="4138321">:</span><span class="op" id="4138322">]</span><span class="op" id="4138323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4138328">copy</span><span class="op" id="4138332">(</span><span class="ident" id="4138333"><a href="/crypto/tls/conn.go.html#4138263">additionalData</a></span><span class="op" id="4138347">[</span><span class="num" id="4138348">8</span><span class="op" id="4138349">:</span><span class="op" id="4138350">]</span><span class="op" id="4138351">,</span>&nbsp;<span class="ident" id="4138353"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4138354">.</span><span class="ident" id="4138355">data</span><span class="op" id="4138359">[</span><span class="op" id="4138360">:</span><span class="num" id="4138361">3</span><span class="op" id="4138362">]</span><span class="op" id="4138363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4138368"><a href="/crypto/tls/conn.go.html#4138263">additionalData</a></span><span class="op" id="4138382">[</span><span class="num" id="4138383">11</span><span class="op" id="4138385">]</span>&nbsp;<span class="op" id="4138387">=</span>&nbsp;<span class="builtintype" id="4138389">byte</span><span class="op" id="4138393">(</span><span class="ident" id="4138394"><a href="/crypto/tls/conn.go.html#4138000">payloadLen</a></span>&nbsp;<span class="op" id="4138405">&gt;&gt;</span>&nbsp;<span class="num" id="4138408">8</span><span class="op" id="4138409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4138414"><a href="/crypto/tls/conn.go.html#4138263">additionalData</a></span><span class="op" id="4138428">[</span><span class="num" id="4138429">12</span><span class="op" id="4138431">]</span>&nbsp;<span class="op" id="4138433">=</span>&nbsp;<span class="builtintype" id="4138435">byte</span><span class="op" id="4138439">(</span><span class="ident" id="4138440"><a href="/crypto/tls/conn.go.html#4138000">payloadLen</a></span><span class="op" id="4138450">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4138456"><a href="/crypto/tls/conn.go.html#4137895">c</a></span><span class="op" id="4138457">.</span><span class="ident" id="4138458">Seal</span><span class="op" id="4138462">(</span><span class="ident" id="4138463"><a href="/crypto/tls/conn.go.html#4138171">payload</a></span><span class="op" id="4138470">[</span><span class="op" id="4138471">:</span><span class="num" id="4138472">0</span><span class="op" id="4138473">]</span><span class="op" id="4138474">,</span>&nbsp;<span class="ident" id="4138476"><a href="/crypto/tls/conn.go.html#4138103">nonce</a></span><span class="op" id="4138481">,</span>&nbsp;<span class="ident" id="4138483"><a href="/crypto/tls/conn.go.html#4138171">payload</a></span><span class="op" id="4138490">,</span>&nbsp;<span class="ident" id="4138492"><a href="/crypto/tls/conn.go.html#4138263">additionalData</a></span><span class="op" id="4138506">[</span><span class="op" id="4138507">:</span><span class="op" id="4138508">]</span><span class="op" id="4138509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4138513">case</span>&nbsp;<span class="ident" id="4138518"><a href="/crypto/tls/conn.go.html#4133761">cbcMode</a></span><span class="op" id="4138525">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4138530">blockSize</span>&nbsp;<span class="op" id="4138540">:=</span>&nbsp;<span class="ident" id="4138543"><a href="/crypto/tls/conn.go.html#4137895">c</a></span><span class="op" id="4138544">.</span><span class="ident" id="4138545">BlockSize</span><span class="op" id="4138554">(</span><span class="op" id="4138555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4138560">if</span>&nbsp;<span class="ident" id="4138563"><a href="/crypto/tls/conn.go.html#4137538">explicitIVLen</a></span>&nbsp;<span class="op" id="4138577">&gt;</span>&nbsp;<span class="num" id="4138579">0</span>&nbsp;<span class="op" id="4138581">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4138587"><a href="/crypto/tls/conn.go.html#4137895">c</a></span><span class="op" id="4138588">.</span><span class="ident" id="4138589">SetIV</span><span class="op" id="4138594">(</span><span class="ident" id="4138595"><a href="/crypto/tls/conn.go.html#4137814">payload</a></span><span class="op" id="4138602">[</span><span class="op" id="4138603">:</span><span class="ident" id="4138604"><a href="/crypto/tls/conn.go.html#4137538">explicitIVLen</a></span><span class="op" id="4138617">]</span><span class="op" id="4138618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4138624"><a href="/crypto/tls/conn.go.html#4137814">payload</a></span>&nbsp;<span class="op" id="4138632">=</span>&nbsp;<span class="ident" id="4138634"><a href="/crypto/tls/conn.go.html#4137814">payload</a></span><span class="op" id="4138641">[</span><span class="ident" id="4138642"><a href="/crypto/tls/conn.go.html#4137538">explicitIVLen</a></span><span class="op" id="4138655">:</span><span class="op" id="4138656">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4138661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4138666">prefix</span><span class="op" id="4138672">,</span>&nbsp;<span class="ident" id="4138674">finalBlock</span>&nbsp;<span class="op" id="4138685">:=</span>&nbsp;<span class="ident" id="4138688"><a href="/crypto/tls/conn.go.html#4137086">padToBlockSize</a></span><span class="op" id="4138702">(</span><span class="ident" id="4138703"><a href="/crypto/tls/conn.go.html#4137814">payload</a></span><span class="op" id="4138710">,</span>&nbsp;<span class="ident" id="4138712"><a href="/crypto/tls/conn.go.html#4138530">blockSize</a></span><span class="op" id="4138721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4138726"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4138727">.</span><span class="ident" id="4138728">resize</span><span class="op" id="4138734">(</span><span class="ident" id="4138735"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span>&nbsp;<span class="op" id="4138751">+</span>&nbsp;<span class="ident" id="4138753"><a href="/crypto/tls/conn.go.html#4137538">explicitIVLen</a></span>&nbsp;<span class="op" id="4138767">+</span>&nbsp;<span class="builtinfunc" id="4138769">len</span><span class="op" id="4138772">(</span><span class="ident" id="4138773"><a href="/crypto/tls/conn.go.html#4138666">prefix</a></span><span class="op" id="4138779">)</span>&nbsp;<span class="op" id="4138781">+</span>&nbsp;<span class="builtinfunc" id="4138783">len</span><span class="op" id="4138786">(</span><span class="ident" id="4138787"><a href="/crypto/tls/conn.go.html#4138674">finalBlock</a></span><span class="op" id="4138797">)</span><span class="op" id="4138798">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4138803"><a href="/crypto/tls/conn.go.html#4137895">c</a></span><span class="op" id="4138804">.</span><span class="ident" id="4138805">CryptBlocks</span><span class="op" id="4138816">(</span><span class="ident" id="4138817"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4138818">.</span><span class="ident" id="4138819">data</span><span class="op" id="4138823">[</span><span class="ident" id="4138824"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span><span class="op" id="4138839">+</span><span class="ident" id="4138840"><a href="/crypto/tls/conn.go.html#4137538">explicitIVLen</a></span><span class="op" id="4138853">:</span><span class="op" id="4138854">]</span><span class="op" id="4138855">,</span>&nbsp;<span class="ident" id="4138857"><a href="/crypto/tls/conn.go.html#4138666">prefix</a></span><span class="op" id="4138863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4138868"><a href="/crypto/tls/conn.go.html#4137895">c</a></span><span class="op" id="4138869">.</span><span class="ident" id="4138870">CryptBlocks</span><span class="op" id="4138881">(</span><span class="ident" id="4138882"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4138883">.</span><span class="ident" id="4138884">data</span><span class="op" id="4138888">[</span><span class="ident" id="4138889"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span><span class="op" id="4138904">+</span><span class="ident" id="4138905"><a href="/crypto/tls/conn.go.html#4137538">explicitIVLen</a></span><span class="op" id="4138918">+</span><span class="builtinfunc" id="4138919">len</span><span class="op" id="4138922">(</span><span class="ident" id="4138923"><a href="/crypto/tls/conn.go.html#4138666">prefix</a></span><span class="op" id="4138929">)</span><span class="op" id="4138930">:</span><span class="op" id="4138931">]</span><span class="op" id="4138932">,</span>&nbsp;<span class="ident" id="4138934"><a href="/crypto/tls/conn.go.html#4138674">finalBlock</a></span><span class="op" id="4138944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4138948">default</span><span class="op" id="4138955">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4138960">panic</span><span class="op" id="4138965">(</span><span class="string" id="4138966">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4138987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4138991">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4138994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4138998">//&nbsp;update&nbsp;length&nbsp;to&nbsp;include&nbsp;MAC&nbsp;and&nbsp;any&nbsp;block&nbsp;padding&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139061">n</span>&nbsp;<span class="op" id="4139063">:=</span>&nbsp;<span class="builtinfunc" id="4139066">len</span><span class="op" id="4139069">(</span><span class="ident" id="4139070"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4139071">.</span><span class="ident" id="4139072">data</span><span class="op" id="4139076">)</span>&nbsp;<span class="op" id="4139078">-</span>&nbsp;<span class="ident" id="4139080"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139097"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4139098">.</span><span class="ident" id="4139099">data</span><span class="op" id="4139103">[</span><span class="num" id="4139104">3</span><span class="op" id="4139105">]</span>&nbsp;<span class="op" id="4139107">=</span>&nbsp;<span class="builtintype" id="4139109">byte</span><span class="op" id="4139113">(</span><span class="ident" id="4139114"><a href="/crypto/tls/conn.go.html#4139061">n</a></span>&nbsp;<span class="op" id="4139116">&gt;&gt;</span>&nbsp;<span class="num" id="4139119">8</span><span class="op" id="4139120">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139123"><a href="/crypto/tls/conn.go.html#4137528">b</a></span><span class="op" id="4139124">.</span><span class="ident" id="4139125">data</span><span class="op" id="4139129">[</span><span class="num" id="4139130">4</span><span class="op" id="4139131">]</span>&nbsp;<span class="op" id="4139133">=</span>&nbsp;<span class="builtintype" id="4139135">byte</span><span class="op" id="4139139">(</span><span class="ident" id="4139140"><a href="/crypto/tls/conn.go.html#4139061">n</a></span><span class="op" id="4139141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139144"><a href="/crypto/tls/conn.go.html#4137506">hc</a></span><span class="op" id="4139146">.</span><span class="ident" id="4139147">incSeq</span><span class="op" id="4139153">(</span><span class="op" id="4139154">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4139158">return</span>&nbsp;<span class="ident" id="4139165">true</span><span class="op" id="4139169">,</span>&nbsp;<span class="num" id="4139171">0</span><br>
<span class="lineno"></span><span class="op" id="4139173">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="4139176">//&nbsp;A&nbsp;block&nbsp;is&nbsp;a&nbsp;simple&nbsp;data&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4139212">type</span>&nbsp;<span class="ident" id="4139217">block</span>&nbsp;<span class="keyword" id="4139223">struct</span>&nbsp;<span class="op" id="4139230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139233">data</span>&nbsp;<span class="op" id="4139238">[</span><span class="op" id="4139239">]</span><span class="builtintype" id="4139240">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139246">off</span>&nbsp;&nbsp;<span class="builtintype" id="4139251">int</span>&nbsp;<span class="comment" id="4139255">//&nbsp;index&nbsp;for&nbsp;Read</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139274">link</span>&nbsp;<span class="op" id="4139279">*</span><span class="ident" id="4139280"><a href="/crypto/tls/conn.go.html#4139217">block</a></span><br>
<span class="lineno"></span><span class="op" id="4139286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4139289">//&nbsp;resize&nbsp;resizes&nbsp;block&nbsp;to&nbsp;be&nbsp;n&nbsp;bytes,&nbsp;growing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4139350">func</span>&nbsp;<span class="op" id="4139355">(</span><span class="ident" id="4139356">b</span>&nbsp;<span class="op" id="4139358">*</span><span class="ident" id="4139359"><a href="/crypto/tls/conn.go.html#4139217">block</a></span><span class="op" id="4139364">)</span>&nbsp;<span class="ident" id="4139366">resize</span><span class="op" id="4139372">(</span><span class="ident" id="4139373">n</span>&nbsp;<span class="builtintype" id="4139375">int</span><span class="op" id="4139378">)</span>&nbsp;<span class="op" id="4139380">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4139383">if</span>&nbsp;<span class="ident" id="4139386"><a href="/crypto/tls/conn.go.html#4139373">n</a></span>&nbsp;<span class="op" id="4139388">&gt;</span>&nbsp;<span class="builtinfunc" id="4139390">cap</span><span class="op" id="4139393">(</span><span class="ident" id="4139394"><a href="/crypto/tls/conn.go.html#4139356">b</a></span><span class="op" id="4139395">.</span><span class="ident" id="4139396">data</span><span class="op" id="4139400">)</span>&nbsp;<span class="op" id="4139402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139406"><a href="/crypto/tls/conn.go.html#4139356">b</a></span><span class="op" id="4139407">.</span><span class="ident" id="4139408">reserve</span><span class="op" id="4139415">(</span><span class="ident" id="4139416"><a href="/crypto/tls/conn.go.html#4139373">n</a></span><span class="op" id="4139417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4139420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139423"><a href="/crypto/tls/conn.go.html#4139356">b</a></span><span class="op" id="4139424">.</span><span class="ident" id="4139425">data</span>&nbsp;<span class="op" id="4139430">=</span>&nbsp;<span class="ident" id="4139432"><a href="/crypto/tls/conn.go.html#4139356">b</a></span><span class="op" id="4139433">.</span><span class="ident" id="4139434">data</span><span class="op" id="4139438">[</span><span class="num" id="4139439">0</span><span class="op" id="4139440">:</span><span class="ident" id="4139441"><a href="/crypto/tls/conn.go.html#4139373">n</a></span><span class="op" id="4139442">]</span><br>
<span class="lineno"></span><span class="op" id="4139444">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="4139447">//&nbsp;reserve&nbsp;makes&nbsp;sure&nbsp;that&nbsp;block&nbsp;contains&nbsp;a&nbsp;capacity&nbsp;of&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4139521">func</span>&nbsp;<span class="op" id="4139526">(</span><span class="ident" id="4139527">b</span>&nbsp;<span class="op" id="4139529">*</span><span class="ident" id="4139530"><a href="/crypto/tls/conn.go.html#4139217">block</a></span><span class="op" id="4139535">)</span>&nbsp;<span class="ident" id="4139537">reserve</span><span class="op" id="4139544">(</span><span class="ident" id="4139545">n</span>&nbsp;<span class="builtintype" id="4139547">int</span><span class="op" id="4139550">)</span>&nbsp;<span class="op" id="4139552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4139555">if</span>&nbsp;<span class="builtinfunc" id="4139558">cap</span><span class="op" id="4139561">(</span><span class="ident" id="4139562"><a href="/crypto/tls/conn.go.html#4139527">b</a></span><span class="op" id="4139563">.</span><span class="ident" id="4139564">data</span><span class="op" id="4139568">)</span>&nbsp;<span class="op" id="4139570">&gt;=</span>&nbsp;<span class="ident" id="4139573"><a href="/crypto/tls/conn.go.html#4139545">n</a></span>&nbsp;<span class="op" id="4139575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4139579">return</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4139587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139590">m</span>&nbsp;<span class="op" id="4139592">:=</span>&nbsp;<span class="builtinfunc" id="4139595">cap</span><span class="op" id="4139598">(</span><span class="ident" id="4139599"><a href="/crypto/tls/conn.go.html#4139527">b</a></span><span class="op" id="4139600">.</span><span class="ident" id="4139601">data</span><span class="op" id="4139605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4139608">if</span>&nbsp;<span class="ident" id="4139611"><a href="/crypto/tls/conn.go.html#4139590">m</a></span>&nbsp;<span class="op" id="4139613">==</span>&nbsp;<span class="num" id="4139616">0</span>&nbsp;<span class="op" id="4139618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139622"><a href="/crypto/tls/conn.go.html#4139590">m</a></span>&nbsp;<span class="op" id="4139624">=</span>&nbsp;<span class="num" id="4139626">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4139632">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4139635">for</span>&nbsp;<span class="ident" id="4139639"><a href="/crypto/tls/conn.go.html#4139590">m</a></span>&nbsp;<span class="op" id="4139641">&lt;</span>&nbsp;<span class="ident" id="4139643"><a href="/crypto/tls/conn.go.html#4139545">n</a></span>&nbsp;<span class="op" id="4139645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139649"><a href="/crypto/tls/conn.go.html#4139590">m</a></span>&nbsp;<span class="op" id="4139651">*=</span>&nbsp;<span class="num" id="4139654">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4139657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139660">data</span>&nbsp;<span class="op" id="4139665">:=</span>&nbsp;<span class="builtinfunc" id="4139668">make</span><span class="op" id="4139672">(</span><span class="op" id="4139673">[</span><span class="op" id="4139674">]</span><span class="builtintype" id="4139675">byte</span><span class="op" id="4139679">,</span>&nbsp;<span class="builtinfunc" id="4139681">len</span><span class="op" id="4139684">(</span><span class="ident" id="4139685"><a href="/crypto/tls/conn.go.html#4139527">b</a></span><span class="op" id="4139686">.</span><span class="ident" id="4139687">data</span><span class="op" id="4139691">)</span><span class="op" id="4139692">,</span>&nbsp;<span class="ident" id="4139694"><a href="/crypto/tls/conn.go.html#4139590">m</a></span><span class="op" id="4139695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4139698">copy</span><span class="op" id="4139702">(</span><span class="ident" id="4139703"><a href="/crypto/tls/conn.go.html#4139660">data</a></span><span class="op" id="4139707">,</span>&nbsp;<span class="ident" id="4139709"><a href="/crypto/tls/conn.go.html#4139527">b</a></span><span class="op" id="4139710">.</span><span class="ident" id="4139711">data</span><span class="op" id="4139715">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139718"><a href="/crypto/tls/conn.go.html#4139527">b</a></span><span class="op" id="4139719">.</span><span class="ident" id="4139720">data</span>&nbsp;<span class="op" id="4139725">=</span>&nbsp;<span class="ident" id="4139727"><a href="/crypto/tls/conn.go.html#4139660">data</a></span><br>
<span class="lineno"></span><span class="op" id="4139732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4139735">//&nbsp;readFromUntil&nbsp;reads&nbsp;from&nbsp;r&nbsp;into&nbsp;b&nbsp;until&nbsp;b&nbsp;contains&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes</span><br>
<span class="lineno"></span><span class="comment" id="4139806">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">445</span><span class="keyword" id="4139835">func</span>&nbsp;<span class="op" id="4139840">(</span><span class="ident" id="4139841">b</span>&nbsp;<span class="op" id="4139843">*</span><span class="ident" id="4139844"><a href="/crypto/tls/conn.go.html#4139217">block</a></span><span class="op" id="4139849">)</span>&nbsp;<span class="ident" id="4139851">readFromUntil</span><span class="op" id="4139864">(</span><span class="ident" id="4139865">r</span>&nbsp;<span class="ident" id="4139867"><a href="/crypto/tls/conn.go.html#4127479">io</a></span><span class="op" id="4139869">.</span><span class="ident" id="4139870">Reader</span><span class="op" id="4139876">,</span>&nbsp;<span class="ident" id="4139878">n</span>&nbsp;<span class="builtintype" id="4139880">int</span><span class="op" id="4139883">)</span>&nbsp;<span class="builtintype" id="4139885">error</span>&nbsp;<span class="op" id="4139891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4139894">//&nbsp;quick&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4139909">if</span>&nbsp;<span class="builtinfunc" id="4139912">len</span><span class="op" id="4139915">(</span><span class="ident" id="4139916"><a href="/crypto/tls/conn.go.html#4139841">b</a></span><span class="op" id="4139917">.</span><span class="ident" id="4139918">data</span><span class="op" id="4139922">)</span>&nbsp;<span class="op" id="4139924">&gt;=</span>&nbsp;<span class="ident" id="4139927"><a href="/crypto/tls/conn.go.html#4139878">n</a></span>&nbsp;<span class="op" id="4139929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4139933">return</span>&nbsp;<span class="ident" id="4139940">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4139945">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4139949">//&nbsp;read&nbsp;until&nbsp;have&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139977"><a href="/crypto/tls/conn.go.html#4139841">b</a></span><span class="op" id="4139978">.</span><span class="ident" id="4139979">reserve</span><span class="op" id="4139986">(</span><span class="ident" id="4139987"><a href="/crypto/tls/conn.go.html#4139878">n</a></span><span class="op" id="4139988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4139991">for</span>&nbsp;<span class="op" id="4139995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4139999">m</span><span class="op" id="4140000">,</span>&nbsp;<span class="ident" id="4140002">err</span>&nbsp;<span class="op" id="4140006">:=</span>&nbsp;<span class="ident" id="4140009"><a href="/crypto/tls/conn.go.html#4139865">r</a></span><span class="op" id="4140010">.</span><span class="ident" id="4140011">Read</span><span class="op" id="4140015">(</span><span class="ident" id="4140016"><a href="/crypto/tls/conn.go.html#4139841">b</a></span><span class="op" id="4140017">.</span><span class="ident" id="4140018">data</span><span class="op" id="4140022">[</span><span class="builtinfunc" id="4140023">len</span><span class="op" id="4140026">(</span><span class="ident" id="4140027"><a href="/crypto/tls/conn.go.html#4139841">b</a></span><span class="op" id="4140028">.</span><span class="ident" id="4140029">data</span><span class="op" id="4140033">)</span><span class="op" id="4140034">:</span><span class="builtinfunc" id="4140035">cap</span><span class="op" id="4140038">(</span><span class="ident" id="4140039"><a href="/crypto/tls/conn.go.html#4139841">b</a></span><span class="op" id="4140040">.</span><span class="ident" id="4140041">data</span><span class="op" id="4140045">)</span><span class="op" id="4140046">]</span><span class="op" id="4140047">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4140051"><a href="/crypto/tls/conn.go.html#4139841">b</a></span><span class="op" id="4140052">.</span><span class="ident" id="4140053">data</span>&nbsp;<span class="op" id="4140058">=</span>&nbsp;<span class="ident" id="4140060"><a href="/crypto/tls/conn.go.html#4139841">b</a></span><span class="op" id="4140061">.</span><span class="ident" id="4140062">data</span><span class="op" id="4140066">[</span><span class="num" id="4140067">0</span>&nbsp;<span class="op" id="4140069">:</span>&nbsp;<span class="builtinfunc" id="4140071">len</span><span class="op" id="4140074">(</span><span class="ident" id="4140075"><a href="/crypto/tls/conn.go.html#4139841">b</a></span><span class="op" id="4140076">.</span><span class="ident" id="4140077">data</span><span class="op" id="4140081">)</span><span class="op" id="4140082">+</span><span class="ident" id="4140083"><a href="/crypto/tls/conn.go.html#4139999">m</a></span><span class="op" id="4140084">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4140088">if</span>&nbsp;<span class="builtinfunc" id="4140091">len</span><span class="op" id="4140094">(</span><span class="ident" id="4140095"><a href="/crypto/tls/conn.go.html#4139841">b</a></span><span class="op" id="4140096">.</span><span class="ident" id="4140097">data</span><span class="op" id="4140101">)</span>&nbsp;<span class="op" id="4140103">&gt;=</span>&nbsp;<span class="ident" id="4140106"><a href="/crypto/tls/conn.go.html#4139878">n</a></span>&nbsp;<span class="op" id="4140108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4140113">//&nbsp;TODO(bradfitz,agl):&nbsp;slightly&nbsp;suspicious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4140159">//&nbsp;that&nbsp;we&#39;re&nbsp;throwing&nbsp;away&nbsp;r.Read&#39;s&nbsp;err&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4140209">break</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4140217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4140221">if</span>&nbsp;<span class="ident" id="4140224"><a href="/crypto/tls/conn.go.html#4140002">err</a></span>&nbsp;<span class="op" id="4140228">!=</span>&nbsp;<span class="ident" id="4140231">nil</span>&nbsp;<span class="op" id="4140235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4140240">return</span>&nbsp;<span class="ident" id="4140247"><a href="/crypto/tls/conn.go.html#4140002">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4140253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4140256">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4140259">return</span>&nbsp;<span class="ident" id="4140266">nil</span><br>
<span class="lineno"></span><span class="op" id="4140270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4140273">func</span>&nbsp;<span class="op" id="4140278">(</span><span class="ident" id="4140279">b</span>&nbsp;<span class="op" id="4140281">*</span><span class="ident" id="4140282"><a href="/crypto/tls/conn.go.html#4139217">block</a></span><span class="op" id="4140287">)</span>&nbsp;<span class="ident" id="4140289">Read</span><span class="op" id="4140293">(</span><span class="ident" id="4140294">p</span>&nbsp;<span class="op" id="4140296">[</span><span class="op" id="4140297">]</span><span class="builtintype" id="4140298">byte</span><span class="op" id="4140302">)</span>&nbsp;<span class="op" id="4140304">(</span><span class="ident" id="4140305">n</span>&nbsp;<span class="builtintype" id="4140307">int</span><span class="op" id="4140310">,</span>&nbsp;<span class="ident" id="4140312">err</span>&nbsp;<span class="builtintype" id="4140316">error</span><span class="op" id="4140321">)</span>&nbsp;<span class="op" id="4140323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4140326"><a href="/crypto/tls/conn.go.html#4140305">n</a></span>&nbsp;<span class="op" id="4140328">=</span>&nbsp;<span class="builtinfunc" id="4140330">copy</span><span class="op" id="4140334">(</span><span class="ident" id="4140335"><a href="/crypto/tls/conn.go.html#4140294">p</a></span><span class="op" id="4140336">,</span>&nbsp;<span class="ident" id="4140338"><a href="/crypto/tls/conn.go.html#4140279">b</a></span><span class="op" id="4140339">.</span><span class="ident" id="4140340">data</span><span class="op" id="4140344">[</span><span class="ident" id="4140345"><a href="/crypto/tls/conn.go.html#4140279">b</a></span><span class="op" id="4140346">.</span><span class="ident" id="4140347">off</span><span class="op" id="4140350">:</span><span class="op" id="4140351">]</span><span class="op" id="4140352">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4140355"><a href="/crypto/tls/conn.go.html#4140279">b</a></span><span class="op" id="4140356">.</span><span class="ident" id="4140357">off</span>&nbsp;<span class="op" id="4140361">+=</span>&nbsp;<span class="ident" id="4140364"><a href="/crypto/tls/conn.go.html#4140305">n</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4140367">return</span><br>
<span class="lineno"></span><span class="op" id="4140374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4140377">//&nbsp;newBlock&nbsp;allocates&nbsp;a&nbsp;new&nbsp;block,&nbsp;from&nbsp;hc&#39;s&nbsp;free&nbsp;list&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">475</span><span class="keyword" id="4140445">func</span>&nbsp;<span class="op" id="4140450">(</span><span class="ident" id="4140451">hc</span>&nbsp;<span class="op" id="4140454">*</span><span class="ident" id="4140455"><a href="/crypto/tls/conn.go.html#4130304">halfConn</a></span><span class="op" id="4140463">)</span>&nbsp;<span class="ident" id="4140465">newBlock</span><span class="op" id="4140473">(</span><span class="op" id="4140474">)</span>&nbsp;<span class="op" id="4140476">*</span><span class="ident" id="4140477"><a href="/crypto/tls/conn.go.html#4139217">block</a></span>&nbsp;<span class="op" id="4140483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4140486">b</span>&nbsp;<span class="op" id="4140488">:=</span>&nbsp;<span class="ident" id="4140491"><a href="/crypto/tls/conn.go.html#4140451">hc</a></span><span class="op" id="4140493">.</span><span class="ident" id="4140494">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4140501">if</span>&nbsp;<span class="ident" id="4140504"><a href="/crypto/tls/conn.go.html#4140486">b</a></span>&nbsp;<span class="op" id="4140506">==</span>&nbsp;<span class="ident" id="4140509">nil</span>&nbsp;<span class="op" id="4140513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4140517">return</span>&nbsp;<span class="builtinfunc" id="4140524">new</span><span class="op" id="4140527">(</span><span class="ident" id="4140528"><a href="/crypto/tls/conn.go.html#4139217">block</a></span><span class="op" id="4140533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4140536">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4140539"><a href="/crypto/tls/conn.go.html#4140451">hc</a></span><span class="op" id="4140541">.</span><span class="ident" id="4140542">bfree</span>&nbsp;<span class="op" id="4140548">=</span>&nbsp;<span class="ident" id="4140550"><a href="/crypto/tls/conn.go.html#4140486">b</a></span><span class="op" id="4140551">.</span><span class="ident" id="4140552">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4140558"><a href="/crypto/tls/conn.go.html#4140486">b</a></span><span class="op" id="4140559">.</span><span class="ident" id="4140560">link</span>&nbsp;<span class="op" id="4140565">=</span>&nbsp;<span class="ident" id="4140567">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4140572"><a href="/crypto/tls/conn.go.html#4140486">b</a></span><span class="op" id="4140573">.</span><span class="ident" id="4140574">resize</span><span class="op" id="4140580">(</span><span class="num" id="4140581">0</span><span class="op" id="4140582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4140585">return</span>&nbsp;<span class="ident" id="4140592"><a href="/crypto/tls/conn.go.html#4140486">b</a></span><br>
<span class="lineno"></span><span class="op" id="4140594">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="4140597">//&nbsp;freeBlock&nbsp;returns&nbsp;a&nbsp;block&nbsp;to&nbsp;hc&#39;s&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="4140645">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;such&nbsp;that&nbsp;each&nbsp;side&nbsp;only&nbsp;has&nbsp;a&nbsp;block&nbsp;or&nbsp;two&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4140711">//&nbsp;its&nbsp;free&nbsp;list&nbsp;at&nbsp;a&nbsp;time,&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;need&nbsp;to&nbsp;worry&nbsp;about</span><br>
<span class="lineno"></span><span class="comment" id="4140773">//&nbsp;trimming&nbsp;the&nbsp;list,&nbsp;etc.</span><br>
<span class="lineno">490</span><span class="keyword" id="4140800">func</span>&nbsp;<span class="op" id="4140805">(</span><span class="ident" id="4140806">hc</span>&nbsp;<span class="op" id="4140809">*</span><span class="ident" id="4140810"><a href="/crypto/tls/conn.go.html#4130304">halfConn</a></span><span class="op" id="4140818">)</span>&nbsp;<span class="ident" id="4140820">freeBlock</span><span class="op" id="4140829">(</span><span class="ident" id="4140830">b</span>&nbsp;<span class="op" id="4140832">*</span><span class="ident" id="4140833"><a href="/crypto/tls/conn.go.html#4139217">block</a></span><span class="op" id="4140838">)</span>&nbsp;<span class="op" id="4140840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4140843"><a href="/crypto/tls/conn.go.html#4140830">b</a></span><span class="op" id="4140844">.</span><span class="ident" id="4140845">link</span>&nbsp;<span class="op" id="4140850">=</span>&nbsp;<span class="ident" id="4140852"><a href="/crypto/tls/conn.go.html#4140806">hc</a></span><span class="op" id="4140854">.</span><span class="ident" id="4140855">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4140862"><a href="/crypto/tls/conn.go.html#4140806">hc</a></span><span class="op" id="4140864">.</span><span class="ident" id="4140865">bfree</span>&nbsp;<span class="op" id="4140871">=</span>&nbsp;<span class="ident" id="4140873"><a href="/crypto/tls/conn.go.html#4140830">b</a></span><br>
<span class="lineno"></span><span class="op" id="4140875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="4140878">//&nbsp;splitBlock&nbsp;splits&nbsp;a&nbsp;block&nbsp;after&nbsp;the&nbsp;first&nbsp;n&nbsp;bytes,</span><br>
<span class="lineno"></span><span class="comment" id="4140932">//&nbsp;returning&nbsp;a&nbsp;block&nbsp;with&nbsp;those&nbsp;n&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4140978">//&nbsp;block&nbsp;with&nbsp;the&nbsp;remainder.&nbsp;&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4141031">func</span>&nbsp;<span class="op" id="4141036">(</span><span class="ident" id="4141037">hc</span>&nbsp;<span class="op" id="4141040">*</span><span class="ident" id="4141041"><a href="/crypto/tls/conn.go.html#4130304">halfConn</a></span><span class="op" id="4141049">)</span>&nbsp;<span class="ident" id="4141051">splitBlock</span><span class="op" id="4141061">(</span><span class="ident" id="4141062">b</span>&nbsp;<span class="op" id="4141064">*</span><span class="ident" id="4141065"><a href="/crypto/tls/conn.go.html#4139217">block</a></span><span class="op" id="4141070">,</span>&nbsp;<span class="ident" id="4141072">n</span>&nbsp;<span class="builtintype" id="4141074">int</span><span class="op" id="4141077">)</span>&nbsp;<span class="op" id="4141079">(</span><span class="op" id="4141080">*</span><span class="ident" id="4141081"><a href="/crypto/tls/conn.go.html#4139217">block</a></span><span class="op" id="4141086">,</span>&nbsp;<span class="op" id="4141088">*</span><span class="ident" id="4141089"><a href="/crypto/tls/conn.go.html#4139217">block</a></span><span class="op" id="4141094">)</span>&nbsp;<span class="op" id="4141096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4141099">if</span>&nbsp;<span class="builtinfunc" id="4141102">len</span><span class="op" id="4141105">(</span><span class="ident" id="4141106"><a href="/crypto/tls/conn.go.html#4141062">b</a></span><span class="op" id="4141107">.</span><span class="ident" id="4141108">data</span><span class="op" id="4141112">)</span>&nbsp;<span class="op" id="4141114">&lt;=</span>&nbsp;<span class="ident" id="4141117"><a href="/crypto/tls/conn.go.html#4141072">n</a></span>&nbsp;<span class="op" id="4141119">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4141123">return</span>&nbsp;<span class="ident" id="4141130"><a href="/crypto/tls/conn.go.html#4141062">b</a></span><span class="op" id="4141131">,</span>&nbsp;<span class="ident" id="4141133">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4141138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4141141">bb</span>&nbsp;<span class="op" id="4141144">:=</span>&nbsp;<span class="ident" id="4141147"><a href="/crypto/tls/conn.go.html#4141037">hc</a></span><span class="op" id="4141149">.</span><span class="ident" id="4141150">newBlock</span><span class="op" id="4141158">(</span><span class="op" id="4141159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4141162"><a href="/crypto/tls/conn.go.html#4141141">bb</a></span><span class="op" id="4141164">.</span><span class="ident" id="4141165">resize</span><span class="op" id="4141171">(</span><span class="builtinfunc" id="4141172">len</span><span class="op" id="4141175">(</span><span class="ident" id="4141176"><a href="/crypto/tls/conn.go.html#4141062">b</a></span><span class="op" id="4141177">.</span><span class="ident" id="4141178">data</span><span class="op" id="4141182">)</span>&nbsp;<span class="op" id="4141184">-</span>&nbsp;<span class="ident" id="4141186"><a href="/crypto/tls/conn.go.html#4141072">n</a></span><span class="op" id="4141187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4141190">copy</span><span class="op" id="4141194">(</span><span class="ident" id="4141195"><a href="/crypto/tls/conn.go.html#4141141">bb</a></span><span class="op" id="4141197">.</span><span class="ident" id="4141198">data</span><span class="op" id="4141202">,</span>&nbsp;<span class="ident" id="4141204"><a href="/crypto/tls/conn.go.html#4141062">b</a></span><span class="op" id="4141205">.</span><span class="ident" id="4141206">data</span><span class="op" id="4141210">[</span><span class="ident" id="4141211"><a href="/crypto/tls/conn.go.html#4141072">n</a></span><span class="op" id="4141212">:</span><span class="op" id="4141213">]</span><span class="op" id="4141214">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4141217"><a href="/crypto/tls/conn.go.html#4141062">b</a></span><span class="op" id="4141218">.</span><span class="ident" id="4141219">data</span>&nbsp;<span class="op" id="4141224">=</span>&nbsp;<span class="ident" id="4141226"><a href="/crypto/tls/conn.go.html#4141062">b</a></span><span class="op" id="4141227">.</span><span class="ident" id="4141228">data</span><span class="op" id="4141232">[</span><span class="num" id="4141233">0</span><span class="op" id="4141234">:</span><span class="ident" id="4141235"><a href="/crypto/tls/conn.go.html#4141072">n</a></span><span class="op" id="4141236">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4141239">return</span>&nbsp;<span class="ident" id="4141246"><a href="/crypto/tls/conn.go.html#4141062">b</a></span><span class="op" id="4141247">,</span>&nbsp;<span class="ident" id="4141249"><a href="/crypto/tls/conn.go.html#4141141">bb</a></span><br>
<span class="lineno"></span><span class="op" id="4141252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4141255">//&nbsp;readRecord&nbsp;reads&nbsp;the&nbsp;next&nbsp;TLS&nbsp;record&nbsp;from&nbsp;the&nbsp;connection</span><br>
<span class="lineno">510</span><span class="comment" id="4141315">//&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4141354">//&nbsp;c.in.Mutex&nbsp;&lt;=&nbsp;L;&nbsp;c.input&nbsp;==&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4141390">func</span>&nbsp;<span class="op" id="4141395">(</span><span class="ident" id="4141396">c</span>&nbsp;<span class="op" id="4141398">*</span><span class="ident" id="4141399"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4141403">)</span>&nbsp;<span class="ident" id="4141405">readRecord</span><span class="op" id="4141415">(</span><span class="ident" id="4141416">want</span>&nbsp;<span class="ident" id="4141421"><a href="/crypto/tls/common.go.html#4108603">recordType</a></span><span class="op" id="4141431">)</span>&nbsp;<span class="builtintype" id="4141433">error</span>&nbsp;<span class="op" id="4141439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4141442">//&nbsp;Caller&nbsp;must&nbsp;be&nbsp;in&nbsp;sync&nbsp;with&nbsp;connection:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4141486">//&nbsp;handshake&nbsp;data&nbsp;if&nbsp;handshake&nbsp;not&nbsp;yet&nbsp;completed,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4141537">//&nbsp;else&nbsp;application&nbsp;data.&nbsp;&nbsp;(We&nbsp;don&#39;t&nbsp;support&nbsp;renegotiation.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4141599">switch</span>&nbsp;<span class="ident" id="4141606"><a href="/crypto/tls/conn.go.html#4141416">want</a></span>&nbsp;<span class="op" id="4141611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4141614">default</span><span class="op" id="4141621">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4141625"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4141626">.</span><span class="ident" id="4141627">sendAlert</span><span class="op" id="4141636">(</span><span class="ident" id="4141637"><a href="/crypto/tls/alert.go.html#4096712">alertInternalError</a></span><span class="op" id="4141655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4141659">return</span>&nbsp;<span class="ident" id="4141666"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4141667">.</span><span class="ident" id="4141668">in</span><span class="op" id="4141670">.</span><span class="ident" id="4141671">setErrorLocked</span><span class="op" id="4141685">(</span><span class="ident" id="4141686"><a href="/crypto/tls/conn.go.html#4127462">errors</a></span><span class="op" id="4141692">.</span><span class="ident" id="4141693">New</span><span class="op" id="4141696">(</span><span class="string" id="4141697">&#34;tls:&nbsp;unknown&nbsp;record&nbsp;type&nbsp;requested&#34;</span><span class="op" id="4141733">)</span><span class="op" id="4141734">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4141737">case</span>&nbsp;<span class="ident" id="4141742"><a href="/crypto/tls/common.go.html#4108718">recordTypeHandshake</a></span><span class="op" id="4141761">,</span>&nbsp;<span class="ident" id="4141763"><a href="/crypto/tls/common.go.html#4108630">recordTypeChangeCipherSpec</a></span><span class="op" id="4141789">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4141793">if</span>&nbsp;<span class="ident" id="4141796"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4141797">.</span><span class="ident" id="4141798">handshakeComplete</span>&nbsp;<span class="op" id="4141816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4141821"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4141822">.</span><span class="ident" id="4141823">sendAlert</span><span class="op" id="4141832">(</span><span class="ident" id="4141833"><a href="/crypto/tls/alert.go.html#4096712">alertInternalError</a></span><span class="op" id="4141851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4141856">return</span>&nbsp;<span class="ident" id="4141863"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4141864">.</span><span class="ident" id="4141865">in</span><span class="op" id="4141867">.</span><span class="ident" id="4141868">setErrorLocked</span><span class="op" id="4141882">(</span><span class="ident" id="4141883"><a href="/crypto/tls/conn.go.html#4127462">errors</a></span><span class="op" id="4141889">.</span><span class="ident" id="4141890">New</span><span class="op" id="4141893">(</span><span class="string" id="4141894">&#34;tls:&nbsp;handshake&nbsp;or&nbsp;ChangeCipherSpec&nbsp;requested&nbsp;after&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4141965">)</span><span class="op" id="4141966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4141970">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4141973">case</span>&nbsp;<span class="ident" id="4141978"><a href="/crypto/tls/common.go.html#4108762">recordTypeApplicationData</a></span><span class="op" id="4142003">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4142007">if</span>&nbsp;<span class="op" id="4142010">!</span><span class="ident" id="4142011"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4142012">.</span><span class="ident" id="4142013">handshakeComplete</span>&nbsp;<span class="op" id="4142031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4142036"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4142037">.</span><span class="ident" id="4142038">sendAlert</span><span class="op" id="4142047">(</span><span class="ident" id="4142048"><a href="/crypto/tls/alert.go.html#4096712">alertInternalError</a></span><span class="op" id="4142066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4142071">return</span>&nbsp;<span class="ident" id="4142078"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4142079">.</span><span class="ident" id="4142080">in</span><span class="op" id="4142082">.</span><span class="ident" id="4142083">setErrorLocked</span><span class="op" id="4142097">(</span><span class="ident" id="4142098"><a href="/crypto/tls/conn.go.html#4127462">errors</a></span><span class="op" id="4142104">.</span><span class="ident" id="4142105">New</span><span class="op" id="4142108">(</span><span class="string" id="4142109">&#34;tls:&nbsp;application&nbsp;data&nbsp;record&nbsp;requested&nbsp;before&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4142175">)</span><span class="op" id="4142176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4142180">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4142183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4142186">Again</span><span class="op" id="4142191">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4142194">if</span>&nbsp;<span class="ident" id="4142197"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4142198">.</span><span class="ident" id="4142199">rawInput</span>&nbsp;<span class="op" id="4142208">==</span>&nbsp;<span class="ident" id="4142211">nil</span>&nbsp;<span class="op" id="4142215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4142219"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4142220">.</span><span class="ident" id="4142221">rawInput</span>&nbsp;<span class="op" id="4142230">=</span>&nbsp;<span class="ident" id="4142232"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4142233">.</span><span class="ident" id="4142234">in</span><span class="op" id="4142236">.</span><span class="ident" id="4142237">newBlock</span><span class="op" id="4142245">(</span><span class="op" id="4142246">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4142249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4142252">b</span>&nbsp;<span class="op" id="4142254">:=</span>&nbsp;<span class="ident" id="4142257"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4142258">.</span><span class="ident" id="4142259">rawInput</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4142270">//&nbsp;Read&nbsp;header,&nbsp;payload.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4142296">if</span>&nbsp;<span class="ident" id="4142299">err</span>&nbsp;<span class="op" id="4142303">:=</span>&nbsp;<span class="ident" id="4142306"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4142307">.</span><span class="ident" id="4142308">readFromUntil</span><span class="op" id="4142321">(</span><span class="ident" id="4142322"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4142323">.</span><span class="ident" id="4142324">conn</span><span class="op" id="4142328">,</span>&nbsp;<span class="ident" id="4142330"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span><span class="op" id="4142345">)</span><span class="op" id="4142346">;</span>&nbsp;<span class="ident" id="4142348"><a href="/crypto/tls/conn.go.html#4142299">err</a></span>&nbsp;<span class="op" id="4142352">!=</span>&nbsp;<span class="ident" id="4142355">nil</span>&nbsp;<span class="op" id="4142359">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4142363">//&nbsp;RFC&nbsp;suggests&nbsp;that&nbsp;EOF&nbsp;without&nbsp;an&nbsp;alertCloseNotify&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4142421">//&nbsp;an&nbsp;error,&nbsp;but&nbsp;popular&nbsp;web&nbsp;sites&nbsp;seem&nbsp;to&nbsp;do&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4142475">//&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;make&nbsp;it&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4142510">//&nbsp;if&nbsp;err&nbsp;==&nbsp;io.EOF&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4142534">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;io.ErrUnexpectedEOF</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4142566">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4142573">if</span>&nbsp;<span class="ident" id="4142576">e</span><span class="op" id="4142577">,</span>&nbsp;<span class="ident" id="4142579">ok</span>&nbsp;<span class="op" id="4142582">:=</span>&nbsp;<span class="ident" id="4142585"><a href="/crypto/tls/conn.go.html#4142299">err</a></span><span class="op" id="4142588">.</span><span class="op" id="4142589">(</span><span class="ident" id="4142590"><a href="/crypto/tls/conn.go.html#4127485">net</a></span><span class="op" id="4142593">.</span><span class="ident" id="4142594">Error</span><span class="op" id="4142599">)</span><span class="op" id="4142600">;</span>&nbsp;<span class="op" id="4142602">!</span><span class="ident" id="4142603"><a href="/crypto/tls/conn.go.html#4142579">ok</a></span>&nbsp;<span class="op" id="4142606">||</span>&nbsp;<span class="op" id="4142609">!</span><span class="ident" id="4142610"><a href="/crypto/tls/conn.go.html#4142576">e</a></span><span class="op" id="4142611">.</span><span class="ident" id="4142612">Temporary</span><span class="op" id="4142621">(</span><span class="op" id="4142622">)</span>&nbsp;<span class="op" id="4142624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4142629"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4142630">.</span><span class="ident" id="4142631">in</span><span class="op" id="4142633">.</span><span class="ident" id="4142634">setErrorLocked</span><span class="op" id="4142648">(</span><span class="ident" id="4142649"><a href="/crypto/tls/conn.go.html#4142299">err</a></span><span class="op" id="4142652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4142656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4142660">return</span>&nbsp;<span class="ident" id="4142667"><a href="/crypto/tls/conn.go.html#4142299">err</a></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4142672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4142675">typ</span>&nbsp;<span class="op" id="4142679">:=</span>&nbsp;<span class="ident" id="4142682"><a href="/crypto/tls/common.go.html#4108603">recordType</a></span><span class="op" id="4142692">(</span><span class="ident" id="4142693"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4142694">.</span><span class="ident" id="4142695">data</span><span class="op" id="4142699">[</span><span class="num" id="4142700">0</span><span class="op" id="4142701">]</span><span class="op" id="4142702">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4142706">//&nbsp;No&nbsp;valid&nbsp;TLS&nbsp;record&nbsp;has&nbsp;a&nbsp;type&nbsp;of&nbsp;0x80,&nbsp;however&nbsp;SSLv2&nbsp;handshakes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4142775">//&nbsp;start&nbsp;with&nbsp;a&nbsp;uint16&nbsp;length&nbsp;where&nbsp;the&nbsp;MSB&nbsp;is&nbsp;set&nbsp;and&nbsp;the&nbsp;first&nbsp;record</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4142848">//&nbsp;is&nbsp;always&nbsp;&lt;&nbsp;256&nbsp;bytes&nbsp;long.&nbsp;Therefore&nbsp;typ&nbsp;==&nbsp;0x80&nbsp;strongly&nbsp;suggests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4142920">//&nbsp;an&nbsp;SSLv2&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4142941">if</span>&nbsp;<span class="ident" id="4142944"><a href="/crypto/tls/conn.go.html#4141416">want</a></span>&nbsp;<span class="op" id="4142949">==</span>&nbsp;<span class="ident" id="4142952"><a href="/crypto/tls/common.go.html#4108718">recordTypeHandshake</a></span>&nbsp;<span class="op" id="4142972">&amp;&amp;</span>&nbsp;<span class="ident" id="4142975"><a href="/crypto/tls/conn.go.html#4142675">typ</a></span>&nbsp;<span class="op" id="4142979">==</span>&nbsp;<span class="num" id="4142982">0x80</span>&nbsp;<span class="op" id="4142987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4142991"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4142992">.</span><span class="ident" id="4142993">sendAlert</span><span class="op" id="4143002">(</span><span class="ident" id="4143003"><a href="/crypto/tls/alert.go.html#4096632">alertProtocolVersion</a></span><span class="op" id="4143023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4143027">return</span>&nbsp;<span class="ident" id="4143034"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4143035">.</span><span class="ident" id="4143036">in</span><span class="op" id="4143038">.</span><span class="ident" id="4143039">setErrorLocked</span><span class="op" id="4143053">(</span><span class="ident" id="4143054"><a href="/crypto/tls/conn.go.html#4127462">errors</a></span><span class="op" id="4143060">.</span><span class="ident" id="4143061">New</span><span class="op" id="4143064">(</span><span class="string" id="4143065">&#34;tls:&nbsp;unsupported&nbsp;SSLv2&nbsp;handshake&nbsp;received&#34;</span><span class="op" id="4143108">)</span><span class="op" id="4143109">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4143112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4143116">vers</span>&nbsp;<span class="op" id="4143121">:=</span>&nbsp;<span class="builtintype" id="4143124">uint16</span><span class="op" id="4143130">(</span><span class="ident" id="4143131"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4143132">.</span><span class="ident" id="4143133">data</span><span class="op" id="4143137">[</span><span class="num" id="4143138">1</span><span class="op" id="4143139">]</span><span class="op" id="4143140">)</span><span class="op" id="4143141">&lt;&lt;</span><span class="num" id="4143143">8</span>&nbsp;<span class="op" id="4143145">|</span>&nbsp;<span class="builtintype" id="4143147">uint16</span><span class="op" id="4143153">(</span><span class="ident" id="4143154"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4143155">.</span><span class="ident" id="4143156">data</span><span class="op" id="4143160">[</span><span class="num" id="4143161">2</span><span class="op" id="4143162">]</span><span class="op" id="4143163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4143166">n</span>&nbsp;<span class="op" id="4143168">:=</span>&nbsp;<span class="builtintype" id="4143171">int</span><span class="op" id="4143174">(</span><span class="ident" id="4143175"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4143176">.</span><span class="ident" id="4143177">data</span><span class="op" id="4143181">[</span><span class="num" id="4143182">3</span><span class="op" id="4143183">]</span><span class="op" id="4143184">)</span><span class="op" id="4143185">&lt;&lt;</span><span class="num" id="4143187">8</span>&nbsp;<span class="op" id="4143189">|</span>&nbsp;<span class="builtintype" id="4143191">int</span><span class="op" id="4143194">(</span><span class="ident" id="4143195"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4143196">.</span><span class="ident" id="4143197">data</span><span class="op" id="4143201">[</span><span class="num" id="4143202">4</span><span class="op" id="4143203">]</span><span class="op" id="4143204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4143207">if</span>&nbsp;<span class="ident" id="4143210"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4143211">.</span><span class="ident" id="4143212">haveVers</span>&nbsp;<span class="op" id="4143221">&amp;&amp;</span>&nbsp;<span class="ident" id="4143224"><a href="/crypto/tls/conn.go.html#4143116">vers</a></span>&nbsp;<span class="op" id="4143229">!=</span>&nbsp;<span class="ident" id="4143232"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4143233">.</span><span class="ident" id="4143234">vers</span>&nbsp;<span class="op" id="4143239">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4143243"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4143244">.</span><span class="ident" id="4143245">sendAlert</span><span class="op" id="4143254">(</span><span class="ident" id="4143255"><a href="/crypto/tls/alert.go.html#4096632">alertProtocolVersion</a></span><span class="op" id="4143275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4143279">return</span>&nbsp;<span class="ident" id="4143286"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4143287">.</span><span class="ident" id="4143288">in</span><span class="op" id="4143290">.</span><span class="ident" id="4143291">setErrorLocked</span><span class="op" id="4143305">(</span><span class="ident" id="4143306"><a href="/crypto/tls/conn.go.html#4127472">fmt</a></span><span class="op" id="4143309">.</span><span class="ident" id="4143310">Errorf</span><span class="op" id="4143316">(</span><span class="string" id="4143317">&#34;tls:&nbsp;received&nbsp;record&nbsp;with&nbsp;version&nbsp;%x&nbsp;when&nbsp;expecting&nbsp;version&nbsp;%x&#34;</span><span class="op" id="4143381">,</span>&nbsp;<span class="ident" id="4143383"><a href="/crypto/tls/conn.go.html#4143116">vers</a></span><span class="op" id="4143387">,</span>&nbsp;<span class="ident" id="4143389"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4143390">.</span><span class="ident" id="4143391">vers</span><span class="op" id="4143395">)</span><span class="op" id="4143396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4143399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4143402">if</span>&nbsp;<span class="ident" id="4143405"><a href="/crypto/tls/conn.go.html#4143166">n</a></span>&nbsp;<span class="op" id="4143407">&gt;</span>&nbsp;<span class="ident" id="4143409"><a href="/crypto/tls/common.go.html#4108307">maxCiphertext</a></span>&nbsp;<span class="op" id="4143423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4143427"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4143428">.</span><span class="ident" id="4143429">sendAlert</span><span class="op" id="4143438">(</span><span class="ident" id="4143439"><a href="/crypto/tls/alert.go.html#4096112">alertRecordOverflow</a></span><span class="op" id="4143458">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4143462">return</span>&nbsp;<span class="ident" id="4143469"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4143470">.</span><span class="ident" id="4143471">in</span><span class="op" id="4143473">.</span><span class="ident" id="4143474">setErrorLocked</span><span class="op" id="4143488">(</span><span class="ident" id="4143489"><a href="/crypto/tls/conn.go.html#4127472">fmt</a></span><span class="op" id="4143492">.</span><span class="ident" id="4143493">Errorf</span><span class="op" id="4143499">(</span><span class="string" id="4143500">&#34;tls:&nbsp;oversized&nbsp;record&nbsp;received&nbsp;with&nbsp;length&nbsp;%d&#34;</span><span class="op" id="4143547">,</span>&nbsp;<span class="ident" id="4143549"><a href="/crypto/tls/conn.go.html#4143166">n</a></span><span class="op" id="4143550">)</span><span class="op" id="4143551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4143554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4143557">if</span>&nbsp;<span class="op" id="4143560">!</span><span class="ident" id="4143561"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4143562">.</span><span class="ident" id="4143563">haveVers</span>&nbsp;<span class="op" id="4143572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4143576">//&nbsp;First&nbsp;message,&nbsp;be&nbsp;extra&nbsp;suspicious:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4143617">//&nbsp;this&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;TLS&nbsp;client.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4143654">//&nbsp;Bail&nbsp;out&nbsp;before&nbsp;reading&nbsp;a&nbsp;full&nbsp;&#39;body&#39;,&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4143711">//&nbsp;The&nbsp;current&nbsp;max&nbsp;version&nbsp;is&nbsp;3.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4143748">//&nbsp;If&nbsp;the&nbsp;version&nbsp;is&nbsp;&gt;=&nbsp;16.0,&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4143804">//&nbsp;Similarly,&nbsp;a&nbsp;clientHello&nbsp;message&nbsp;encodes&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4143853">//&nbsp;well&nbsp;under&nbsp;a&nbsp;kilobyte.&nbsp;&nbsp;If&nbsp;the&nbsp;length&nbsp;is&nbsp;&gt;=&nbsp;12&nbsp;kB,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4143909">//&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4143938">if</span>&nbsp;<span class="op" id="4143941">(</span><span class="ident" id="4143942"><a href="/crypto/tls/conn.go.html#4142675">typ</a></span>&nbsp;<span class="op" id="4143946">!=</span>&nbsp;<span class="ident" id="4143949"><a href="/crypto/tls/common.go.html#4108674">recordTypeAlert</a></span>&nbsp;<span class="op" id="4143965">&amp;&amp;</span>&nbsp;<span class="ident" id="4143968"><a href="/crypto/tls/conn.go.html#4142675">typ</a></span>&nbsp;<span class="op" id="4143972">!=</span>&nbsp;<span class="ident" id="4143975"><a href="/crypto/tls/conn.go.html#4141416">want</a></span><span class="op" id="4143979">)</span>&nbsp;<span class="op" id="4143981">||</span>&nbsp;<span class="ident" id="4143984"><a href="/crypto/tls/conn.go.html#4143116">vers</a></span>&nbsp;<span class="op" id="4143989">&gt;=</span>&nbsp;<span class="num" id="4143992">0x1000</span>&nbsp;<span class="op" id="4143999">||</span>&nbsp;<span class="ident" id="4144002"><a href="/crypto/tls/conn.go.html#4143166">n</a></span>&nbsp;<span class="op" id="4144004">&gt;=</span>&nbsp;<span class="num" id="4144007">0x3000</span>&nbsp;<span class="op" id="4144014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4144019"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144020">.</span><span class="ident" id="4144021">sendAlert</span><span class="op" id="4144030">(</span><span class="ident" id="4144031"><a href="/crypto/tls/alert.go.html#4095992">alertUnexpectedMessage</a></span><span class="op" id="4144053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4144058">return</span>&nbsp;<span class="ident" id="4144065"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144066">.</span><span class="ident" id="4144067">in</span><span class="op" id="4144069">.</span><span class="ident" id="4144070">setErrorLocked</span><span class="op" id="4144084">(</span><span class="ident" id="4144085"><a href="/crypto/tls/conn.go.html#4127472">fmt</a></span><span class="op" id="4144088">.</span><span class="ident" id="4144089">Errorf</span><span class="op" id="4144095">(</span><span class="string" id="4144096">&#34;tls:&nbsp;first&nbsp;record&nbsp;does&nbsp;not&nbsp;look&nbsp;like&nbsp;a&nbsp;TLS&nbsp;handshake&#34;</span><span class="op" id="4144150">)</span><span class="op" id="4144151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4144155">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4144158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4144161">if</span>&nbsp;<span class="ident" id="4144164">err</span>&nbsp;<span class="op" id="4144168">:=</span>&nbsp;<span class="ident" id="4144171"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4144172">.</span><span class="ident" id="4144173">readFromUntil</span><span class="op" id="4144186">(</span><span class="ident" id="4144187"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144188">.</span><span class="ident" id="4144189">conn</span><span class="op" id="4144193">,</span>&nbsp;<span class="ident" id="4144195"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span><span class="op" id="4144210">+</span><span class="ident" id="4144211"><a href="/crypto/tls/conn.go.html#4143166">n</a></span><span class="op" id="4144212">)</span><span class="op" id="4144213">;</span>&nbsp;<span class="ident" id="4144215"><a href="/crypto/tls/conn.go.html#4144164">err</a></span>&nbsp;<span class="op" id="4144219">!=</span>&nbsp;<span class="ident" id="4144222">nil</span>&nbsp;<span class="op" id="4144226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4144230">if</span>&nbsp;<span class="ident" id="4144233"><a href="/crypto/tls/conn.go.html#4144164">err</a></span>&nbsp;<span class="op" id="4144237">==</span>&nbsp;<span class="ident" id="4144240"><a href="/crypto/tls/conn.go.html#4127479">io</a></span><span class="op" id="4144242">.</span><span class="ident" id="4144243">EOF</span>&nbsp;<span class="op" id="4144247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4144252"><a href="/crypto/tls/conn.go.html#4144164">err</a></span>&nbsp;<span class="op" id="4144256">=</span>&nbsp;<span class="ident" id="4144258"><a href="/crypto/tls/conn.go.html#4127479">io</a></span><span class="op" id="4144260">.</span><span class="ident" id="4144261">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4144280">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4144284">if</span>&nbsp;<span class="ident" id="4144287">e</span><span class="op" id="4144288">,</span>&nbsp;<span class="ident" id="4144290">ok</span>&nbsp;<span class="op" id="4144293">:=</span>&nbsp;<span class="ident" id="4144296"><a href="/crypto/tls/conn.go.html#4144164">err</a></span><span class="op" id="4144299">.</span><span class="op" id="4144300">(</span><span class="ident" id="4144301"><a href="/crypto/tls/conn.go.html#4127485">net</a></span><span class="op" id="4144304">.</span><span class="ident" id="4144305">Error</span><span class="op" id="4144310">)</span><span class="op" id="4144311">;</span>&nbsp;<span class="op" id="4144313">!</span><span class="ident" id="4144314"><a href="/crypto/tls/conn.go.html#4144290">ok</a></span>&nbsp;<span class="op" id="4144317">||</span>&nbsp;<span class="op" id="4144320">!</span><span class="ident" id="4144321"><a href="/crypto/tls/conn.go.html#4144287">e</a></span><span class="op" id="4144322">.</span><span class="ident" id="4144323">Temporary</span><span class="op" id="4144332">(</span><span class="op" id="4144333">)</span>&nbsp;<span class="op" id="4144335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4144340"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144341">.</span><span class="ident" id="4144342">in</span><span class="op" id="4144344">.</span><span class="ident" id="4144345">setErrorLocked</span><span class="op" id="4144359">(</span><span class="ident" id="4144360"><a href="/crypto/tls/conn.go.html#4144164">err</a></span><span class="op" id="4144363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4144367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4144371">return</span>&nbsp;<span class="ident" id="4144378"><a href="/crypto/tls/conn.go.html#4144164">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4144383">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4144387">//&nbsp;Process&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4144408"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4144409">,</span>&nbsp;<span class="ident" id="4144411"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144412">.</span><span class="ident" id="4144413">rawInput</span>&nbsp;<span class="op" id="4144422">=</span>&nbsp;<span class="ident" id="4144424"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144425">.</span><span class="ident" id="4144426">in</span><span class="op" id="4144428">.</span><span class="ident" id="4144429">splitBlock</span><span class="op" id="4144439">(</span><span class="ident" id="4144440"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4144441">,</span>&nbsp;<span class="ident" id="4144443"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span><span class="op" id="4144458">+</span><span class="ident" id="4144459"><a href="/crypto/tls/conn.go.html#4143166">n</a></span><span class="op" id="4144460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4144463">ok</span><span class="op" id="4144465">,</span>&nbsp;<span class="ident" id="4144467">off</span><span class="op" id="4144470">,</span>&nbsp;<span class="ident" id="4144472">err</span>&nbsp;<span class="op" id="4144476">:=</span>&nbsp;<span class="ident" id="4144479"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144480">.</span><span class="ident" id="4144481">in</span><span class="op" id="4144483">.</span><span class="ident" id="4144484">decrypt</span><span class="op" id="4144491">(</span><span class="ident" id="4144492"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4144493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4144496">if</span>&nbsp;<span class="op" id="4144499">!</span><span class="ident" id="4144500"><a href="/crypto/tls/conn.go.html#4144463">ok</a></span>&nbsp;<span class="op" id="4144503">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4144507"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144508">.</span><span class="ident" id="4144509">in</span><span class="op" id="4144511">.</span><span class="ident" id="4144512">setErrorLocked</span><span class="op" id="4144526">(</span><span class="ident" id="4144527"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144528">.</span><span class="ident" id="4144529">sendAlert</span><span class="op" id="4144538">(</span><span class="ident" id="4144539"><a href="/crypto/tls/conn.go.html#4144472">err</a></span><span class="op" id="4144542">)</span><span class="op" id="4144543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4144546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4144549"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4144550">.</span><span class="ident" id="4144551">off</span>&nbsp;<span class="op" id="4144555">=</span>&nbsp;<span class="ident" id="4144557"><a href="/crypto/tls/conn.go.html#4144467">off</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4144562">data</span>&nbsp;<span class="op" id="4144567">:=</span>&nbsp;<span class="ident" id="4144570"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4144571">.</span><span class="ident" id="4144572">data</span><span class="op" id="4144576">[</span><span class="ident" id="4144577"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4144578">.</span><span class="ident" id="4144579">off</span><span class="op" id="4144582">:</span><span class="op" id="4144583">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4144586">if</span>&nbsp;<span class="builtinfunc" id="4144589">len</span><span class="op" id="4144592">(</span><span class="ident" id="4144593"><a href="/crypto/tls/conn.go.html#4144562">data</a></span><span class="op" id="4144597">)</span>&nbsp;<span class="op" id="4144599">&gt;</span>&nbsp;<span class="ident" id="4144601"><a href="/crypto/tls/common.go.html#4108239">maxPlaintext</a></span>&nbsp;<span class="op" id="4144614">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4144618">err</span>&nbsp;<span class="op" id="4144622">:=</span>&nbsp;<span class="ident" id="4144625"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144626">.</span><span class="ident" id="4144627">sendAlert</span><span class="op" id="4144636">(</span><span class="ident" id="4144637"><a href="/crypto/tls/alert.go.html#4096112">alertRecordOverflow</a></span><span class="op" id="4144656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4144660"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144661">.</span><span class="ident" id="4144662">in</span><span class="op" id="4144664">.</span><span class="ident" id="4144665">freeBlock</span><span class="op" id="4144674">(</span><span class="ident" id="4144675"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4144676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4144680">return</span>&nbsp;<span class="ident" id="4144687"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144688">.</span><span class="ident" id="4144689">in</span><span class="op" id="4144691">.</span><span class="ident" id="4144692">setErrorLocked</span><span class="op" id="4144706">(</span><span class="ident" id="4144707"><a href="/crypto/tls/conn.go.html#4144618">err</a></span><span class="op" id="4144710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4144713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4144717">switch</span>&nbsp;<span class="ident" id="4144724"><a href="/crypto/tls/conn.go.html#4142675">typ</a></span>&nbsp;<span class="op" id="4144728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4144731">default</span><span class="op" id="4144738">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4144742"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144743">.</span><span class="ident" id="4144744">in</span><span class="op" id="4144746">.</span><span class="ident" id="4144747">setErrorLocked</span><span class="op" id="4144761">(</span><span class="ident" id="4144762"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144763">.</span><span class="ident" id="4144764">sendAlert</span><span class="op" id="4144773">(</span><span class="ident" id="4144774"><a href="/crypto/tls/alert.go.html#4095992">alertUnexpectedMessage</a></span><span class="op" id="4144796">)</span><span class="op" id="4144797">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4144801">case</span>&nbsp;<span class="ident" id="4144806"><a href="/crypto/tls/common.go.html#4108674">recordTypeAlert</a></span><span class="op" id="4144821">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4144825">if</span>&nbsp;<span class="builtinfunc" id="4144828">len</span><span class="op" id="4144831">(</span><span class="ident" id="4144832"><a href="/crypto/tls/conn.go.html#4144562">data</a></span><span class="op" id="4144836">)</span>&nbsp;<span class="op" id="4144838">!=</span>&nbsp;<span class="num" id="4144841">2</span>&nbsp;<span class="op" id="4144843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4144848"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144849">.</span><span class="ident" id="4144850">in</span><span class="op" id="4144852">.</span><span class="ident" id="4144853">setErrorLocked</span><span class="op" id="4144867">(</span><span class="ident" id="4144868"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144869">.</span><span class="ident" id="4144870">sendAlert</span><span class="op" id="4144879">(</span><span class="ident" id="4144880"><a href="/crypto/tls/alert.go.html#4095992">alertUnexpectedMessage</a></span><span class="op" id="4144902">)</span><span class="op" id="4144903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4144908">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4144916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4144920">if</span>&nbsp;<span class="ident" id="4144923"><a href="/crypto/tls/alert.go.html#4095858">alert</a></span><span class="op" id="4144928">(</span><span class="ident" id="4144929"><a href="/crypto/tls/conn.go.html#4144562">data</a></span><span class="op" id="4144933">[</span><span class="num" id="4144934">1</span><span class="op" id="4144935">]</span><span class="op" id="4144936">)</span>&nbsp;<span class="op" id="4144938">==</span>&nbsp;<span class="ident" id="4144941"><a href="/crypto/tls/alert.go.html#4095953">alertCloseNotify</a></span>&nbsp;<span class="op" id="4144958">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4144963"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4144964">.</span><span class="ident" id="4144965">in</span><span class="op" id="4144967">.</span><span class="ident" id="4144968">setErrorLocked</span><span class="op" id="4144982">(</span><span class="ident" id="4144983"><a href="/crypto/tls/conn.go.html#4127479">io</a></span><span class="op" id="4144985">.</span><span class="ident" id="4144986">EOF</span><span class="op" id="4144989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4144994">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4145002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145006">switch</span>&nbsp;<span class="ident" id="4145013"><a href="/crypto/tls/conn.go.html#4144562">data</a></span><span class="op" id="4145017">[</span><span class="num" id="4145018">0</span><span class="op" id="4145019">]</span>&nbsp;<span class="op" id="4145021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145025">case</span>&nbsp;<span class="ident" id="4145030"><a href="/crypto/tls/alert.go.html#4095896">alertLevelWarning</a></span><span class="op" id="4145047">:</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4145052">//&nbsp;drop&nbsp;on&nbsp;the&nbsp;floor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4145076"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145077">.</span><span class="ident" id="4145078">in</span><span class="op" id="4145080">.</span><span class="ident" id="4145081">freeBlock</span><span class="op" id="4145090">(</span><span class="ident" id="4145091"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4145092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145097">goto</span>&nbsp;<span class="ident" id="4145102">Again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145110">case</span>&nbsp;<span class="ident" id="4145115"><a href="/crypto/tls/alert.go.html#4095919">alertLevelError</a></span><span class="op" id="4145130">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4145135"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145136">.</span><span class="ident" id="4145137">in</span><span class="op" id="4145139">.</span><span class="ident" id="4145140">setErrorLocked</span><span class="op" id="4145154">(</span><span class="op" id="4145155">&amp;</span><span class="ident" id="4145156"><a href="/crypto/tls/conn.go.html#4127485">net</a></span><span class="op" id="4145159">.</span><span class="ident" id="4145160">OpError</span><span class="op" id="4145167">{</span><span class="ident" id="4145168">Op</span><span class="op" id="4145170">:</span>&nbsp;<span class="string" id="4145172">&#34;remote&nbsp;error&#34;</span><span class="op" id="4145186">,</span>&nbsp;<span class="ident" id="4145188">Err</span><span class="op" id="4145191">:</span>&nbsp;<span class="ident" id="4145193"><a href="/crypto/tls/alert.go.html#4095858">alert</a></span><span class="op" id="4145198">(</span><span class="ident" id="4145199"><a href="/crypto/tls/conn.go.html#4144562">data</a></span><span class="op" id="4145203">[</span><span class="num" id="4145204">1</span><span class="op" id="4145205">]</span><span class="op" id="4145206">)</span><span class="op" id="4145207">}</span><span class="op" id="4145208">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145212">default</span><span class="op" id="4145219">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4145224"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145225">.</span><span class="ident" id="4145226">in</span><span class="op" id="4145228">.</span><span class="ident" id="4145229">setErrorLocked</span><span class="op" id="4145243">(</span><span class="ident" id="4145244"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145245">.</span><span class="ident" id="4145246">sendAlert</span><span class="op" id="4145255">(</span><span class="ident" id="4145256"><a href="/crypto/tls/alert.go.html#4095992">alertUnexpectedMessage</a></span><span class="op" id="4145278">)</span><span class="op" id="4145279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4145283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145287">case</span>&nbsp;<span class="ident" id="4145292"><a href="/crypto/tls/common.go.html#4108630">recordTypeChangeCipherSpec</a></span><span class="op" id="4145318">:</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145322">if</span>&nbsp;<span class="ident" id="4145325"><a href="/crypto/tls/conn.go.html#4142675">typ</a></span>&nbsp;<span class="op" id="4145329">!=</span>&nbsp;<span class="ident" id="4145332"><a href="/crypto/tls/conn.go.html#4141416">want</a></span>&nbsp;<span class="op" id="4145337">||</span>&nbsp;<span class="builtinfunc" id="4145340">len</span><span class="op" id="4145343">(</span><span class="ident" id="4145344"><a href="/crypto/tls/conn.go.html#4144562">data</a></span><span class="op" id="4145348">)</span>&nbsp;<span class="op" id="4145350">!=</span>&nbsp;<span class="num" id="4145353">1</span>&nbsp;<span class="op" id="4145355">||</span>&nbsp;<span class="ident" id="4145358"><a href="/crypto/tls/conn.go.html#4144562">data</a></span><span class="op" id="4145362">[</span><span class="num" id="4145363">0</span><span class="op" id="4145364">]</span>&nbsp;<span class="op" id="4145366">!=</span>&nbsp;<span class="num" id="4145369">1</span>&nbsp;<span class="op" id="4145371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4145376"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145377">.</span><span class="ident" id="4145378">in</span><span class="op" id="4145380">.</span><span class="ident" id="4145381">setErrorLocked</span><span class="op" id="4145395">(</span><span class="ident" id="4145396"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145397">.</span><span class="ident" id="4145398">sendAlert</span><span class="op" id="4145407">(</span><span class="ident" id="4145408"><a href="/crypto/tls/alert.go.html#4095992">alertUnexpectedMessage</a></span><span class="op" id="4145430">)</span><span class="op" id="4145431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145436">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4145444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4145448">err</span>&nbsp;<span class="op" id="4145452">:=</span>&nbsp;<span class="ident" id="4145455"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145456">.</span><span class="ident" id="4145457">in</span><span class="op" id="4145459">.</span><span class="ident" id="4145460">changeCipherSpec</span><span class="op" id="4145476">(</span><span class="op" id="4145477">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145481">if</span>&nbsp;<span class="ident" id="4145484"><a href="/crypto/tls/conn.go.html#4145448">err</a></span>&nbsp;<span class="op" id="4145488">!=</span>&nbsp;<span class="ident" id="4145491">nil</span>&nbsp;<span class="op" id="4145495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4145500"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145501">.</span><span class="ident" id="4145502">in</span><span class="op" id="4145504">.</span><span class="ident" id="4145505">setErrorLocked</span><span class="op" id="4145519">(</span><span class="ident" id="4145520"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145521">.</span><span class="ident" id="4145522">sendAlert</span><span class="op" id="4145531">(</span><span class="ident" id="4145532"><a href="/crypto/tls/conn.go.html#4145448">err</a></span><span class="op" id="4145535">.</span><span class="op" id="4145536">(</span><span class="ident" id="4145537"><a href="/crypto/tls/alert.go.html#4095858">alert</a></span><span class="op" id="4145542">)</span><span class="op" id="4145543">)</span><span class="op" id="4145544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4145548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145552">case</span>&nbsp;<span class="ident" id="4145557"><a href="/crypto/tls/common.go.html#4108762">recordTypeApplicationData</a></span><span class="op" id="4145582">:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145586">if</span>&nbsp;<span class="ident" id="4145589"><a href="/crypto/tls/conn.go.html#4142675">typ</a></span>&nbsp;<span class="op" id="4145593">!=</span>&nbsp;<span class="ident" id="4145596"><a href="/crypto/tls/conn.go.html#4141416">want</a></span>&nbsp;<span class="op" id="4145601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4145606"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145607">.</span><span class="ident" id="4145608">in</span><span class="op" id="4145610">.</span><span class="ident" id="4145611">setErrorLocked</span><span class="op" id="4145625">(</span><span class="ident" id="4145626"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145627">.</span><span class="ident" id="4145628">sendAlert</span><span class="op" id="4145637">(</span><span class="ident" id="4145638"><a href="/crypto/tls/alert.go.html#4095992">alertUnexpectedMessage</a></span><span class="op" id="4145660">)</span><span class="op" id="4145661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145666">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4145674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4145678"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145679">.</span><span class="ident" id="4145680">input</span>&nbsp;<span class="op" id="4145686">=</span>&nbsp;<span class="ident" id="4145688"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4145692"><a href="/crypto/tls/conn.go.html#4142252">b</a></span>&nbsp;<span class="op" id="4145694">=</span>&nbsp;<span class="ident" id="4145696">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145702">case</span>&nbsp;<span class="ident" id="4145707"><a href="/crypto/tls/common.go.html#4108718">recordTypeHandshake</a></span><span class="op" id="4145726">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4145730">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;at&nbsp;least&nbsp;pick&nbsp;off&nbsp;connection&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145789">if</span>&nbsp;<span class="ident" id="4145792"><a href="/crypto/tls/conn.go.html#4142675">typ</a></span>&nbsp;<span class="op" id="4145796">!=</span>&nbsp;<span class="ident" id="4145799"><a href="/crypto/tls/conn.go.html#4141416">want</a></span>&nbsp;<span class="op" id="4145804">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145809">return</span>&nbsp;<span class="ident" id="4145816"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145817">.</span><span class="ident" id="4145818">in</span><span class="op" id="4145820">.</span><span class="ident" id="4145821">setErrorLocked</span><span class="op" id="4145835">(</span><span class="ident" id="4145836"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145837">.</span><span class="ident" id="4145838">sendAlert</span><span class="op" id="4145847">(</span><span class="ident" id="4145848"><a href="/crypto/tls/alert.go.html#4096832">alertNoRenegotiation</a></span><span class="op" id="4145868">)</span><span class="op" id="4145869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4145873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4145877"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145878">.</span><span class="ident" id="4145879">hand</span><span class="op" id="4145883">.</span><span class="ident" id="4145884">Write</span><span class="op" id="4145889">(</span><span class="ident" id="4145890"><a href="/crypto/tls/conn.go.html#4144562">data</a></span><span class="op" id="4145894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4145897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145901">if</span>&nbsp;<span class="ident" id="4145904"><a href="/crypto/tls/conn.go.html#4142252">b</a></span>&nbsp;<span class="op" id="4145906">!=</span>&nbsp;<span class="ident" id="4145909">nil</span>&nbsp;<span class="op" id="4145913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4145917"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145918">.</span><span class="ident" id="4145919">in</span><span class="op" id="4145921">.</span><span class="ident" id="4145922">freeBlock</span><span class="op" id="4145931">(</span><span class="ident" id="4145932"><a href="/crypto/tls/conn.go.html#4142252">b</a></span><span class="op" id="4145933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4145936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4145939">return</span>&nbsp;<span class="ident" id="4145946"><a href="/crypto/tls/conn.go.html#4141396">c</a></span><span class="op" id="4145947">.</span><span class="ident" id="4145948">in</span><span class="op" id="4145950">.</span><span class="ident" id="4145951">err</span><br>
<span class="lineno"></span><span class="op" id="4145955">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="4145958">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment" id="4145998">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4146019">func</span>&nbsp;<span class="op" id="4146024">(</span><span class="ident" id="4146025">c</span>&nbsp;<span class="op" id="4146027">*</span><span class="ident" id="4146028"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4146032">)</span>&nbsp;<span class="ident" id="4146034">sendAlertLocked</span><span class="op" id="4146049">(</span><span class="ident" id="4146050">err</span>&nbsp;<span class="ident" id="4146054"><a href="/crypto/tls/alert.go.html#4095858">alert</a></span><span class="op" id="4146059">)</span>&nbsp;<span class="builtintype" id="4146061">error</span>&nbsp;<span class="op" id="4146067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4146070">switch</span>&nbsp;<span class="ident" id="4146077"><a href="/crypto/tls/conn.go.html#4146050">err</a></span>&nbsp;<span class="op" id="4146081">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4146084">case</span>&nbsp;<span class="ident" id="4146089"><a href="/crypto/tls/alert.go.html#4096832">alertNoRenegotiation</a></span><span class="op" id="4146109">,</span>&nbsp;<span class="ident" id="4146111"><a href="/crypto/tls/alert.go.html#4095953">alertCloseNotify</a></span><span class="op" id="4146127">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146131"><a href="/crypto/tls/conn.go.html#4146025">c</a></span><span class="op" id="4146132">.</span><span class="ident" id="4146133">tmp</span><span class="op" id="4146136">[</span><span class="num" id="4146137">0</span><span class="op" id="4146138">]</span>&nbsp;<span class="op" id="4146140">=</span>&nbsp;<span class="ident" id="4146142"><a href="/crypto/tls/alert.go.html#4095896">alertLevelWarning</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4146161">default</span><span class="op" id="4146168">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146172"><a href="/crypto/tls/conn.go.html#4146025">c</a></span><span class="op" id="4146173">.</span><span class="ident" id="4146174">tmp</span><span class="op" id="4146177">[</span><span class="num" id="4146178">0</span><span class="op" id="4146179">]</span>&nbsp;<span class="op" id="4146181">=</span>&nbsp;<span class="ident" id="4146183"><a href="/crypto/tls/alert.go.html#4095919">alertLevelError</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4146200">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146203"><a href="/crypto/tls/conn.go.html#4146025">c</a></span><span class="op" id="4146204">.</span><span class="ident" id="4146205">tmp</span><span class="op" id="4146208">[</span><span class="num" id="4146209">1</span><span class="op" id="4146210">]</span>&nbsp;<span class="op" id="4146212">=</span>&nbsp;<span class="builtintype" id="4146214">byte</span><span class="op" id="4146218">(</span><span class="ident" id="4146219"><a href="/crypto/tls/conn.go.html#4146050">err</a></span><span class="op" id="4146222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146225"><a href="/crypto/tls/conn.go.html#4146025">c</a></span><span class="op" id="4146226">.</span><span class="ident" id="4146227">writeRecord</span><span class="op" id="4146238">(</span><span class="ident" id="4146239"><a href="/crypto/tls/common.go.html#4108674">recordTypeAlert</a></span><span class="op" id="4146254">,</span>&nbsp;<span class="ident" id="4146256"><a href="/crypto/tls/conn.go.html#4146025">c</a></span><span class="op" id="4146257">.</span><span class="ident" id="4146258">tmp</span><span class="op" id="4146261">[</span><span class="num" id="4146262">0</span><span class="op" id="4146263">:</span><span class="num" id="4146264">2</span><span class="op" id="4146265">]</span><span class="op" id="4146266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4146269">//&nbsp;closeNotify&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;in&nbsp;that&nbsp;it&nbsp;isn&#39;t&nbsp;an&nbsp;error:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4146330">if</span>&nbsp;<span class="ident" id="4146333"><a href="/crypto/tls/conn.go.html#4146050">err</a></span>&nbsp;<span class="op" id="4146337">!=</span>&nbsp;<span class="ident" id="4146340"><a href="/crypto/tls/alert.go.html#4095953">alertCloseNotify</a></span>&nbsp;<span class="op" id="4146357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4146361">return</span>&nbsp;<span class="ident" id="4146368"><a href="/crypto/tls/conn.go.html#4146025">c</a></span><span class="op" id="4146369">.</span><span class="ident" id="4146370">out</span><span class="op" id="4146373">.</span><span class="ident" id="4146374">setErrorLocked</span><span class="op" id="4146388">(</span><span class="op" id="4146389">&amp;</span><span class="ident" id="4146390"><a href="/crypto/tls/conn.go.html#4127485">net</a></span><span class="op" id="4146393">.</span><span class="ident" id="4146394">OpError</span><span class="op" id="4146401">{</span><span class="ident" id="4146402">Op</span><span class="op" id="4146404">:</span>&nbsp;<span class="string" id="4146406">&#34;local&nbsp;error&#34;</span><span class="op" id="4146419">,</span>&nbsp;<span class="ident" id="4146421">Err</span><span class="op" id="4146424">:</span>&nbsp;<span class="ident" id="4146426"><a href="/crypto/tls/conn.go.html#4146050">err</a></span><span class="op" id="4146429">}</span><span class="op" id="4146430">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4146433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4146436">return</span>&nbsp;<span class="ident" id="4146443">nil</span><br>
<span class="lineno"></span><span class="op" id="4146447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4146450">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno">685</span><span class="comment" id="4146490">//&nbsp;L&nbsp;&lt;&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="4146510">func</span>&nbsp;<span class="op" id="4146515">(</span><span class="ident" id="4146516">c</span>&nbsp;<span class="op" id="4146518">*</span><span class="ident" id="4146519"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4146523">)</span>&nbsp;<span class="ident" id="4146525">sendAlert</span><span class="op" id="4146534">(</span><span class="ident" id="4146535">err</span>&nbsp;<span class="ident" id="4146539"><a href="/crypto/tls/alert.go.html#4095858">alert</a></span><span class="op" id="4146544">)</span>&nbsp;<span class="builtintype" id="4146546">error</span>&nbsp;<span class="op" id="4146552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146555"><a href="/crypto/tls/conn.go.html#4146516">c</a></span><span class="op" id="4146556">.</span><span class="ident" id="4146557">out</span><span class="op" id="4146560">.</span><span class="ident" id="4146561">Lock</span><span class="op" id="4146565">(</span><span class="op" id="4146566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4146569">defer</span>&nbsp;<span class="ident" id="4146575"><a href="/crypto/tls/conn.go.html#4146516">c</a></span><span class="op" id="4146576">.</span><span class="ident" id="4146577">out</span><span class="op" id="4146580">.</span><span class="ident" id="4146581">Unlock</span><span class="op" id="4146587">(</span><span class="op" id="4146588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4146591">return</span>&nbsp;<span class="ident" id="4146598"><a href="/crypto/tls/conn.go.html#4146516">c</a></span><span class="op" id="4146599">.</span><span class="ident" id="4146600">sendAlertLocked</span><span class="op" id="4146615">(</span><span class="ident" id="4146616"><a href="/crypto/tls/conn.go.html#4146535">err</a></span><span class="op" id="4146619">)</span><br>
<span class="lineno">690</span><span class="op" id="4146621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4146624">//&nbsp;writeRecord&nbsp;writes&nbsp;a&nbsp;TLS&nbsp;record&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="4146691">//&nbsp;to&nbsp;the&nbsp;connection&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4146748">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno">695</span><span class="keyword" id="4146769">func</span>&nbsp;<span class="op" id="4146774">(</span><span class="ident" id="4146775">c</span>&nbsp;<span class="op" id="4146777">*</span><span class="ident" id="4146778"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4146782">)</span>&nbsp;<span class="ident" id="4146784">writeRecord</span><span class="op" id="4146795">(</span><span class="ident" id="4146796">typ</span>&nbsp;<span class="ident" id="4146800"><a href="/crypto/tls/common.go.html#4108603">recordType</a></span><span class="op" id="4146810">,</span>&nbsp;<span class="ident" id="4146812">data</span>&nbsp;<span class="op" id="4146817">[</span><span class="op" id="4146818">]</span><span class="builtintype" id="4146819">byte</span><span class="op" id="4146823">)</span>&nbsp;<span class="op" id="4146825">(</span><span class="ident" id="4146826">n</span>&nbsp;<span class="builtintype" id="4146828">int</span><span class="op" id="4146831">,</span>&nbsp;<span class="ident" id="4146833">err</span>&nbsp;<span class="builtintype" id="4146837">error</span><span class="op" id="4146842">)</span>&nbsp;<span class="op" id="4146844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146847">b</span>&nbsp;<span class="op" id="4146849">:=</span>&nbsp;<span class="ident" id="4146852"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4146853">.</span><span class="ident" id="4146854">out</span><span class="op" id="4146857">.</span><span class="ident" id="4146858">newBlock</span><span class="op" id="4146866">(</span><span class="op" id="4146867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4146870">for</span>&nbsp;<span class="builtinfunc" id="4146874">len</span><span class="op" id="4146877">(</span><span class="ident" id="4146878"><a href="/crypto/tls/conn.go.html#4146812">data</a></span><span class="op" id="4146882">)</span>&nbsp;<span class="op" id="4146884">&gt;</span>&nbsp;<span class="num" id="4146886">0</span>&nbsp;<span class="op" id="4146888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146892">m</span>&nbsp;<span class="op" id="4146894">:=</span>&nbsp;<span class="builtinfunc" id="4146897">len</span><span class="op" id="4146900">(</span><span class="ident" id="4146901"><a href="/crypto/tls/conn.go.html#4146812">data</a></span><span class="op" id="4146905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4146909">if</span>&nbsp;<span class="ident" id="4146912"><a href="/crypto/tls/conn.go.html#4146892">m</a></span>&nbsp;<span class="op" id="4146914">&gt;</span>&nbsp;<span class="ident" id="4146916"><a href="/crypto/tls/common.go.html#4108239">maxPlaintext</a></span>&nbsp;<span class="op" id="4146929">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146934"><a href="/crypto/tls/conn.go.html#4146892">m</a></span>&nbsp;<span class="op" id="4146936">=</span>&nbsp;<span class="ident" id="4146938"><a href="/crypto/tls/common.go.html#4108239">maxPlaintext</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4146953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146957">explicitIVLen</span>&nbsp;<span class="op" id="4146971">:=</span>&nbsp;<span class="num" id="4146974">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146978">explicitIVIsSeq</span>&nbsp;<span class="op" id="4146994">:=</span>&nbsp;<span class="ident" id="4146997">false</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4147006">var</span>&nbsp;<span class="ident" id="4147010">cbc</span>&nbsp;<span class="ident" id="4147014"><a href="/crypto/tls/conn.go.html#4133761">cbcMode</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4147024">if</span>&nbsp;<span class="ident" id="4147027"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4147028">.</span><span class="ident" id="4147029">out</span><span class="op" id="4147032">.</span><span class="ident" id="4147033">version</span>&nbsp;<span class="op" id="4147041">&gt;=</span>&nbsp;<span class="ident" id="4147044"><a href="/crypto/tls/common.go.html#4108182">VersionTLS11</a></span>&nbsp;<span class="op" id="4147057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4147062">var</span>&nbsp;<span class="ident" id="4147066">ok</span>&nbsp;<span class="builtintype" id="4147069">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4147077">if</span>&nbsp;<span class="ident" id="4147080"><a href="/crypto/tls/conn.go.html#4147010">cbc</a></span><span class="op" id="4147083">,</span>&nbsp;<span class="ident" id="4147085"><a href="/crypto/tls/conn.go.html#4147066">ok</a></span>&nbsp;<span class="op" id="4147088">=</span>&nbsp;<span class="ident" id="4147090"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4147091">.</span><span class="ident" id="4147092">out</span><span class="op" id="4147095">.</span><span class="ident" id="4147096">cipher</span><span class="op" id="4147102">.</span><span class="op" id="4147103">(</span><span class="ident" id="4147104"><a href="/crypto/tls/conn.go.html#4133761">cbcMode</a></span><span class="op" id="4147111">)</span><span class="op" id="4147112">;</span>&nbsp;<span class="ident" id="4147114"><a href="/crypto/tls/conn.go.html#4147066">ok</a></span>&nbsp;<span class="op" id="4147117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147123"><a href="/crypto/tls/conn.go.html#4146957">explicitIVLen</a></span>&nbsp;<span class="op" id="4147137">=</span>&nbsp;<span class="ident" id="4147139"><a href="/crypto/tls/conn.go.html#4147010">cbc</a></span><span class="op" id="4147142">.</span><span class="ident" id="4147143">BlockSize</span><span class="op" id="4147152">(</span><span class="op" id="4147153">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4147158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4147162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4147166">if</span>&nbsp;<span class="ident" id="4147169"><a href="/crypto/tls/conn.go.html#4146957">explicitIVLen</a></span>&nbsp;<span class="op" id="4147183">==</span>&nbsp;<span class="num" id="4147186">0</span>&nbsp;<span class="op" id="4147188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4147193">if</span>&nbsp;<span class="ident" id="4147196">_</span><span class="op" id="4147197">,</span>&nbsp;<span class="ident" id="4147199">ok</span>&nbsp;<span class="op" id="4147202">:=</span>&nbsp;<span class="ident" id="4147205"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4147206">.</span><span class="ident" id="4147207">out</span><span class="op" id="4147210">.</span><span class="ident" id="4147211">cipher</span><span class="op" id="4147217">.</span><span class="op" id="4147218">(</span><span class="ident" id="4147219"><a href="/crypto/tls/conn.go.html#4127413">cipher</a></span><span class="op" id="4147225">.</span><span class="ident" id="4147226">AEAD</span><span class="op" id="4147230">)</span><span class="op" id="4147231">;</span>&nbsp;<span class="ident" id="4147233"><a href="/crypto/tls/conn.go.html#4147199">ok</a></span>&nbsp;<span class="op" id="4147236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147242"><a href="/crypto/tls/conn.go.html#4146957">explicitIVLen</a></span>&nbsp;<span class="op" id="4147256">=</span>&nbsp;<span class="num" id="4147258">8</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4147264">//&nbsp;The&nbsp;AES-GCM&nbsp;construction&nbsp;in&nbsp;TLS&nbsp;has&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4147310">//&nbsp;explicit&nbsp;nonce&nbsp;so&nbsp;that&nbsp;the&nbsp;nonce&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4147357">//&nbsp;random.&nbsp;However,&nbsp;the&nbsp;nonce&nbsp;is&nbsp;only&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4147407">//&nbsp;which&nbsp;is&nbsp;too&nbsp;small&nbsp;for&nbsp;a&nbsp;secure,&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4147454">//&nbsp;nonce.&nbsp;Therefore&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4147505">//&nbsp;as&nbsp;the&nbsp;nonce.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147526"><a href="/crypto/tls/conn.go.html#4146978">explicitIVIsSeq</a></span>&nbsp;<span class="op" id="4147542">=</span>&nbsp;<span class="ident" id="4147544">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4147552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4147556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147560"><a href="/crypto/tls/conn.go.html#4146847">b</a></span><span class="op" id="4147561">.</span><span class="ident" id="4147562">resize</span><span class="op" id="4147568">(</span><span class="ident" id="4147569"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span>&nbsp;<span class="op" id="4147585">+</span>&nbsp;<span class="ident" id="4147587"><a href="/crypto/tls/conn.go.html#4146957">explicitIVLen</a></span>&nbsp;<span class="op" id="4147601">+</span>&nbsp;<span class="ident" id="4147603"><a href="/crypto/tls/conn.go.html#4146892">m</a></span><span class="op" id="4147604">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147608"><a href="/crypto/tls/conn.go.html#4146847">b</a></span><span class="op" id="4147609">.</span><span class="ident" id="4147610">data</span><span class="op" id="4147614">[</span><span class="num" id="4147615">0</span><span class="op" id="4147616">]</span>&nbsp;<span class="op" id="4147618">=</span>&nbsp;<span class="builtintype" id="4147620">byte</span><span class="op" id="4147624">(</span><span class="ident" id="4147625"><a href="/crypto/tls/conn.go.html#4146796">typ</a></span><span class="op" id="4147628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147632">vers</span>&nbsp;<span class="op" id="4147637">:=</span>&nbsp;<span class="ident" id="4147640"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4147641">.</span><span class="ident" id="4147642">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4147649">if</span>&nbsp;<span class="ident" id="4147652"><a href="/crypto/tls/conn.go.html#4147632">vers</a></span>&nbsp;<span class="op" id="4147657">==</span>&nbsp;<span class="num" id="4147660">0</span>&nbsp;<span class="op" id="4147662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4147667">//&nbsp;Some&nbsp;TLS&nbsp;servers&nbsp;fail&nbsp;if&nbsp;the&nbsp;record&nbsp;version&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4147720">//&nbsp;greater&nbsp;than&nbsp;TLS&nbsp;1.0&nbsp;for&nbsp;the&nbsp;initial&nbsp;ClientHello.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147776"><a href="/crypto/tls/conn.go.html#4147632">vers</a></span>&nbsp;<span class="op" id="4147781">=</span>&nbsp;<span class="ident" id="4147783"><a href="/crypto/tls/common.go.html#4108159">VersionTLS10</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4147798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147802"><a href="/crypto/tls/conn.go.html#4146847">b</a></span><span class="op" id="4147803">.</span><span class="ident" id="4147804">data</span><span class="op" id="4147808">[</span><span class="num" id="4147809">1</span><span class="op" id="4147810">]</span>&nbsp;<span class="op" id="4147812">=</span>&nbsp;<span class="builtintype" id="4147814">byte</span><span class="op" id="4147818">(</span><span class="ident" id="4147819"><a href="/crypto/tls/conn.go.html#4147632">vers</a></span>&nbsp;<span class="op" id="4147824">&gt;&gt;</span>&nbsp;<span class="num" id="4147827">8</span><span class="op" id="4147828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147832"><a href="/crypto/tls/conn.go.html#4146847">b</a></span><span class="op" id="4147833">.</span><span class="ident" id="4147834">data</span><span class="op" id="4147838">[</span><span class="num" id="4147839">2</span><span class="op" id="4147840">]</span>&nbsp;<span class="op" id="4147842">=</span>&nbsp;<span class="builtintype" id="4147844">byte</span><span class="op" id="4147848">(</span><span class="ident" id="4147849"><a href="/crypto/tls/conn.go.html#4147632">vers</a></span><span class="op" id="4147853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147857"><a href="/crypto/tls/conn.go.html#4146847">b</a></span><span class="op" id="4147858">.</span><span class="ident" id="4147859">data</span><span class="op" id="4147863">[</span><span class="num" id="4147864">3</span><span class="op" id="4147865">]</span>&nbsp;<span class="op" id="4147867">=</span>&nbsp;<span class="builtintype" id="4147869">byte</span><span class="op" id="4147873">(</span><span class="ident" id="4147874"><a href="/crypto/tls/conn.go.html#4146892">m</a></span>&nbsp;<span class="op" id="4147876">&gt;&gt;</span>&nbsp;<span class="num" id="4147879">8</span><span class="op" id="4147880">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147884"><a href="/crypto/tls/conn.go.html#4146847">b</a></span><span class="op" id="4147885">.</span><span class="ident" id="4147886">data</span><span class="op" id="4147890">[</span><span class="num" id="4147891">4</span><span class="op" id="4147892">]</span>&nbsp;<span class="op" id="4147894">=</span>&nbsp;<span class="builtintype" id="4147896">byte</span><span class="op" id="4147900">(</span><span class="ident" id="4147901"><a href="/crypto/tls/conn.go.html#4146892">m</a></span><span class="op" id="4147902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4147906">if</span>&nbsp;<span class="ident" id="4147909"><a href="/crypto/tls/conn.go.html#4146957">explicitIVLen</a></span>&nbsp;<span class="op" id="4147923">&gt;</span>&nbsp;<span class="num" id="4147925">0</span>&nbsp;<span class="op" id="4147927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147932">explicitIV</span>&nbsp;<span class="op" id="4147943">:=</span>&nbsp;<span class="ident" id="4147946"><a href="/crypto/tls/conn.go.html#4146847">b</a></span><span class="op" id="4147947">.</span><span class="ident" id="4147948">data</span><span class="op" id="4147952">[</span><span class="ident" id="4147953"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span>&nbsp;<span class="op" id="4147969">:</span>&nbsp;<span class="ident" id="4147971"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span><span class="op" id="4147986">+</span><span class="ident" id="4147987"><a href="/crypto/tls/conn.go.html#4146957">explicitIVLen</a></span><span class="op" id="4148000">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148005">if</span>&nbsp;<span class="ident" id="4148008"><a href="/crypto/tls/conn.go.html#4146978">explicitIVIsSeq</a></span>&nbsp;<span class="op" id="4148024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4148030">copy</span><span class="op" id="4148034">(</span><span class="ident" id="4148035"><a href="/crypto/tls/conn.go.html#4147932">explicitIV</a></span><span class="op" id="4148045">,</span>&nbsp;<span class="ident" id="4148047"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4148048">.</span><span class="ident" id="4148049">out</span><span class="op" id="4148052">.</span><span class="ident" id="4148053">seq</span><span class="op" id="4148056">[</span><span class="op" id="4148057">:</span><span class="op" id="4148058">]</span><span class="op" id="4148059">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4148064">}</span>&nbsp;<span class="keyword" id="4148066">else</span>&nbsp;<span class="op" id="4148071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148077">if</span>&nbsp;<span class="ident" id="4148080">_</span><span class="op" id="4148081">,</span>&nbsp;<span class="ident" id="4148083"><a href="/crypto/tls/conn.go.html#4146833">err</a></span>&nbsp;<span class="op" id="4148087">=</span>&nbsp;<span class="ident" id="4148089"><a href="/crypto/tls/conn.go.html#4127479">io</a></span><span class="op" id="4148091">.</span><span class="ident" id="4148092">ReadFull</span><span class="op" id="4148100">(</span><span class="ident" id="4148101"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4148102">.</span><span class="ident" id="4148103">config</span><span class="op" id="4148109">.</span><span class="ident" id="4148110">rand</span><span class="op" id="4148114">(</span><span class="op" id="4148115">)</span><span class="op" id="4148116">,</span>&nbsp;<span class="ident" id="4148118"><a href="/crypto/tls/conn.go.html#4147932">explicitIV</a></span><span class="op" id="4148128">)</span><span class="op" id="4148129">;</span>&nbsp;<span class="ident" id="4148131"><a href="/crypto/tls/conn.go.html#4146833">err</a></span>&nbsp;<span class="op" id="4148135">!=</span>&nbsp;<span class="ident" id="4148138">nil</span>&nbsp;<span class="op" id="4148142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148149">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4148159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4148164">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4148168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4148172">copy</span><span class="op" id="4148176">(</span><span class="ident" id="4148177"><a href="/crypto/tls/conn.go.html#4146847">b</a></span><span class="op" id="4148178">.</span><span class="ident" id="4148179">data</span><span class="op" id="4148183">[</span><span class="ident" id="4148184"><a href="/crypto/tls/common.go.html#4108376">recordHeaderLen</a></span><span class="op" id="4148199">+</span><span class="ident" id="4148200"><a href="/crypto/tls/conn.go.html#4146957">explicitIVLen</a></span><span class="op" id="4148213">:</span><span class="op" id="4148214">]</span><span class="op" id="4148215">,</span>&nbsp;<span class="ident" id="4148217"><a href="/crypto/tls/conn.go.html#4146812">data</a></span><span class="op" id="4148221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148225"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4148226">.</span><span class="ident" id="4148227">out</span><span class="op" id="4148230">.</span><span class="ident" id="4148231">encrypt</span><span class="op" id="4148238">(</span><span class="ident" id="4148239"><a href="/crypto/tls/conn.go.html#4146847">b</a></span><span class="op" id="4148240">,</span>&nbsp;<span class="ident" id="4148242"><a href="/crypto/tls/conn.go.html#4146957">explicitIVLen</a></span><span class="op" id="4148255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148259">_</span><span class="op" id="4148260">,</span>&nbsp;<span class="ident" id="4148262"><a href="/crypto/tls/conn.go.html#4146833">err</a></span>&nbsp;<span class="op" id="4148266">=</span>&nbsp;<span class="ident" id="4148268"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4148269">.</span><span class="ident" id="4148270">conn</span><span class="op" id="4148274">.</span><span class="ident" id="4148275">Write</span><span class="op" id="4148280">(</span><span class="ident" id="4148281"><a href="/crypto/tls/conn.go.html#4146847">b</a></span><span class="op" id="4148282">.</span><span class="ident" id="4148283">data</span><span class="op" id="4148287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148291">if</span>&nbsp;<span class="ident" id="4148294"><a href="/crypto/tls/conn.go.html#4146833">err</a></span>&nbsp;<span class="op" id="4148298">!=</span>&nbsp;<span class="ident" id="4148301">nil</span>&nbsp;<span class="op" id="4148305">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148310">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4148318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148322"><a href="/crypto/tls/conn.go.html#4146826">n</a></span>&nbsp;<span class="op" id="4148324">+=</span>&nbsp;<span class="ident" id="4148327"><a href="/crypto/tls/conn.go.html#4146892">m</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148331"><a href="/crypto/tls/conn.go.html#4146812">data</a></span>&nbsp;<span class="op" id="4148336">=</span>&nbsp;<span class="ident" id="4148338"><a href="/crypto/tls/conn.go.html#4146812">data</a></span><span class="op" id="4148342">[</span><span class="ident" id="4148343"><a href="/crypto/tls/conn.go.html#4146892">m</a></span><span class="op" id="4148344">:</span><span class="op" id="4148345">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4148348">}</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148351"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4148352">.</span><span class="ident" id="4148353">out</span><span class="op" id="4148356">.</span><span class="ident" id="4148357">freeBlock</span><span class="op" id="4148366">(</span><span class="ident" id="4148367"><a href="/crypto/tls/conn.go.html#4146847">b</a></span><span class="op" id="4148368">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148372">if</span>&nbsp;<span class="ident" id="4148375"><a href="/crypto/tls/conn.go.html#4146796">typ</a></span>&nbsp;<span class="op" id="4148379">==</span>&nbsp;<span class="ident" id="4148382"><a href="/crypto/tls/common.go.html#4108630">recordTypeChangeCipherSpec</a></span>&nbsp;<span class="op" id="4148409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148413"><a href="/crypto/tls/conn.go.html#4146833">err</a></span>&nbsp;<span class="op" id="4148417">=</span>&nbsp;<span class="ident" id="4148419"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4148420">.</span><span class="ident" id="4148421">out</span><span class="op" id="4148424">.</span><span class="ident" id="4148425">changeCipherSpec</span><span class="op" id="4148441">(</span><span class="op" id="4148442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148446">if</span>&nbsp;<span class="ident" id="4148449"><a href="/crypto/tls/conn.go.html#4146833">err</a></span>&nbsp;<span class="op" id="4148453">!=</span>&nbsp;<span class="ident" id="4148456">nil</span>&nbsp;<span class="op" id="4148460">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4148465">//&nbsp;Cannot&nbsp;call&nbsp;sendAlert&nbsp;directly,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4148503">//&nbsp;because&nbsp;we&nbsp;already&nbsp;hold&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148546"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4148547">.</span><span class="ident" id="4148548">tmp</span><span class="op" id="4148551">[</span><span class="num" id="4148552">0</span><span class="op" id="4148553">]</span>&nbsp;<span class="op" id="4148555">=</span>&nbsp;<span class="ident" id="4148557"><a href="/crypto/tls/alert.go.html#4095919">alertLevelError</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148576"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4148577">.</span><span class="ident" id="4148578">tmp</span><span class="op" id="4148581">[</span><span class="num" id="4148582">1</span><span class="op" id="4148583">]</span>&nbsp;<span class="op" id="4148585">=</span>&nbsp;<span class="builtintype" id="4148587">byte</span><span class="op" id="4148591">(</span><span class="ident" id="4148592"><a href="/crypto/tls/conn.go.html#4146833">err</a></span><span class="op" id="4148595">.</span><span class="op" id="4148596">(</span><span class="ident" id="4148597"><a href="/crypto/tls/alert.go.html#4095858">alert</a></span><span class="op" id="4148602">)</span><span class="op" id="4148603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148608"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4148609">.</span><span class="ident" id="4148610">writeRecord</span><span class="op" id="4148621">(</span><span class="ident" id="4148622"><a href="/crypto/tls/common.go.html#4108674">recordTypeAlert</a></span><span class="op" id="4148637">,</span>&nbsp;<span class="ident" id="4148639"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4148640">.</span><span class="ident" id="4148641">tmp</span><span class="op" id="4148644">[</span><span class="num" id="4148645">0</span><span class="op" id="4148646">:</span><span class="num" id="4148647">2</span><span class="op" id="4148648">]</span><span class="op" id="4148649">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148654">return</span>&nbsp;<span class="ident" id="4148661"><a href="/crypto/tls/conn.go.html#4146826">n</a></span><span class="op" id="4148662">,</span>&nbsp;<span class="ident" id="4148664"><a href="/crypto/tls/conn.go.html#4146775">c</a></span><span class="op" id="4148665">.</span><span class="ident" id="4148666">out</span><span class="op" id="4148669">.</span><span class="ident" id="4148670">setErrorLocked</span><span class="op" id="4148684">(</span><span class="op" id="4148685">&amp;</span><span class="ident" id="4148686"><a href="/crypto/tls/conn.go.html#4127485">net</a></span><span class="op" id="4148689">.</span><span class="ident" id="4148690">OpError</span><span class="op" id="4148697">{</span><span class="ident" id="4148698">Op</span><span class="op" id="4148700">:</span>&nbsp;<span class="string" id="4148702">&#34;local&nbsp;error&#34;</span><span class="op" id="4148715">,</span>&nbsp;<span class="ident" id="4148717">Err</span><span class="op" id="4148720">:</span>&nbsp;<span class="ident" id="4148722"><a href="/crypto/tls/conn.go.html#4146833">err</a></span><span class="op" id="4148725">}</span><span class="op" id="4148726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4148730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4148733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148736">return</span><br>
<span class="lineno"></span><span class="op" id="4148743">}</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="4148746">//&nbsp;readHandshake&nbsp;reads&nbsp;the&nbsp;next&nbsp;handshake&nbsp;message&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="4148801">//&nbsp;the&nbsp;record&nbsp;layer.</span><br>
<span class="lineno"></span><span class="comment" id="4148822">//&nbsp;c.in.Mutex&nbsp;&lt;&nbsp;L;&nbsp;c.out.Mutex&nbsp;&lt;&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4148858">func</span>&nbsp;<span class="op" id="4148863">(</span><span class="ident" id="4148864">c</span>&nbsp;<span class="op" id="4148866">*</span><span class="ident" id="4148867"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4148871">)</span>&nbsp;<span class="ident" id="4148873">readHandshake</span><span class="op" id="4148886">(</span><span class="op" id="4148887">)</span>&nbsp;<span class="op" id="4148889">(</span><span class="keyword" id="4148890">interface</span><span class="op" id="4148899">{</span><span class="op" id="4148900">}</span><span class="op" id="4148901">,</span>&nbsp;<span class="builtintype" id="4148903">error</span><span class="op" id="4148908">)</span>&nbsp;<span class="op" id="4148910">{</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148913">for</span>&nbsp;<span class="ident" id="4148917"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4148918">.</span><span class="ident" id="4148919">hand</span><span class="op" id="4148923">.</span><span class="ident" id="4148924">Len</span><span class="op" id="4148927">(</span><span class="op" id="4148928">)</span>&nbsp;<span class="op" id="4148930">&lt;</span>&nbsp;<span class="num" id="4148932">4</span>&nbsp;<span class="op" id="4148934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148938">if</span>&nbsp;<span class="ident" id="4148941">err</span>&nbsp;<span class="op" id="4148945">:=</span>&nbsp;<span class="ident" id="4148948"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4148949">.</span><span class="ident" id="4148950">in</span><span class="op" id="4148952">.</span><span class="ident" id="4148953">err</span><span class="op" id="4148956">;</span>&nbsp;<span class="ident" id="4148958"><a href="/crypto/tls/conn.go.html#4148941">err</a></span>&nbsp;<span class="op" id="4148962">!=</span>&nbsp;<span class="ident" id="4148965">nil</span>&nbsp;<span class="op" id="4148969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148974">return</span>&nbsp;<span class="ident" id="4148981">nil</span><span class="op" id="4148984">,</span>&nbsp;<span class="ident" id="4148986"><a href="/crypto/tls/conn.go.html#4148941">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4148992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148996">if</span>&nbsp;<span class="ident" id="4148999">err</span>&nbsp;<span class="op" id="4149003">:=</span>&nbsp;<span class="ident" id="4149006"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4149007">.</span><span class="ident" id="4149008">readRecord</span><span class="op" id="4149018">(</span><span class="ident" id="4149019"><a href="/crypto/tls/common.go.html#4108718">recordTypeHandshake</a></span><span class="op" id="4149038">)</span><span class="op" id="4149039">;</span>&nbsp;<span class="ident" id="4149041"><a href="/crypto/tls/conn.go.html#4148999">err</a></span>&nbsp;<span class="op" id="4149045">!=</span>&nbsp;<span class="ident" id="4149048">nil</span>&nbsp;<span class="op" id="4149052">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149057">return</span>&nbsp;<span class="ident" id="4149064">nil</span><span class="op" id="4149067">,</span>&nbsp;<span class="ident" id="4149069"><a href="/crypto/tls/conn.go.html#4148999">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4149075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4149078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4149082">data</span>&nbsp;<span class="op" id="4149087">:=</span>&nbsp;<span class="ident" id="4149090"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4149091">.</span><span class="ident" id="4149092">hand</span><span class="op" id="4149096">.</span><span class="ident" id="4149097">Bytes</span><span class="op" id="4149102">(</span><span class="op" id="4149103">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4149106">n</span>&nbsp;<span class="op" id="4149108">:=</span>&nbsp;<span class="builtintype" id="4149111">int</span><span class="op" id="4149114">(</span><span class="ident" id="4149115"><a href="/crypto/tls/conn.go.html#4149082">data</a></span><span class="op" id="4149119">[</span><span class="num" id="4149120">1</span><span class="op" id="4149121">]</span><span class="op" id="4149122">)</span><span class="op" id="4149123">&lt;&lt;</span><span class="num" id="4149125">16</span>&nbsp;<span class="op" id="4149128">|</span>&nbsp;<span class="builtintype" id="4149130">int</span><span class="op" id="4149133">(</span><span class="ident" id="4149134"><a href="/crypto/tls/conn.go.html#4149082">data</a></span><span class="op" id="4149138">[</span><span class="num" id="4149139">2</span><span class="op" id="4149140">]</span><span class="op" id="4149141">)</span><span class="op" id="4149142">&lt;&lt;</span><span class="num" id="4149144">8</span>&nbsp;<span class="op" id="4149146">|</span>&nbsp;<span class="builtintype" id="4149148">int</span><span class="op" id="4149151">(</span><span class="ident" id="4149152"><a href="/crypto/tls/conn.go.html#4149082">data</a></span><span class="op" id="4149156">[</span><span class="num" id="4149157">3</span><span class="op" id="4149158">]</span><span class="op" id="4149159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149162">if</span>&nbsp;<span class="ident" id="4149165"><a href="/crypto/tls/conn.go.html#4149106">n</a></span>&nbsp;<span class="op" id="4149167">&gt;</span>&nbsp;<span class="ident" id="4149169"><a href="/crypto/tls/common.go.html#4108432">maxHandshake</a></span>&nbsp;<span class="op" id="4149182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149186">return</span>&nbsp;<span class="ident" id="4149193">nil</span><span class="op" id="4149196">,</span>&nbsp;<span class="ident" id="4149198"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4149199">.</span><span class="ident" id="4149200">in</span><span class="op" id="4149202">.</span><span class="ident" id="4149203">setErrorLocked</span><span class="op" id="4149217">(</span><span class="ident" id="4149218"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4149219">.</span><span class="ident" id="4149220">sendAlert</span><span class="op" id="4149229">(</span><span class="ident" id="4149230"><a href="/crypto/tls/alert.go.html#4096712">alertInternalError</a></span><span class="op" id="4149248">)</span><span class="op" id="4149249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4149252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149255">for</span>&nbsp;<span class="ident" id="4149259"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4149260">.</span><span class="ident" id="4149261">hand</span><span class="op" id="4149265">.</span><span class="ident" id="4149266">Len</span><span class="op" id="4149269">(</span><span class="op" id="4149270">)</span>&nbsp;<span class="op" id="4149272">&lt;</span>&nbsp;<span class="num" id="4149274">4</span><span class="op" id="4149275">+</span><span class="ident" id="4149276"><a href="/crypto/tls/conn.go.html#4149106">n</a></span>&nbsp;<span class="op" id="4149278">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149282">if</span>&nbsp;<span class="ident" id="4149285">err</span>&nbsp;<span class="op" id="4149289">:=</span>&nbsp;<span class="ident" id="4149292"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4149293">.</span><span class="ident" id="4149294">in</span><span class="op" id="4149296">.</span><span class="ident" id="4149297">err</span><span class="op" id="4149300">;</span>&nbsp;<span class="ident" id="4149302"><a href="/crypto/tls/conn.go.html#4149285">err</a></span>&nbsp;<span class="op" id="4149306">!=</span>&nbsp;<span class="ident" id="4149309">nil</span>&nbsp;<span class="op" id="4149313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149318">return</span>&nbsp;<span class="ident" id="4149325">nil</span><span class="op" id="4149328">,</span>&nbsp;<span class="ident" id="4149330"><a href="/crypto/tls/conn.go.html#4149285">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4149336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149340">if</span>&nbsp;<span class="ident" id="4149343">err</span>&nbsp;<span class="op" id="4149347">:=</span>&nbsp;<span class="ident" id="4149350"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4149351">.</span><span class="ident" id="4149352">readRecord</span><span class="op" id="4149362">(</span><span class="ident" id="4149363"><a href="/crypto/tls/common.go.html#4108718">recordTypeHandshake</a></span><span class="op" id="4149382">)</span><span class="op" id="4149383">;</span>&nbsp;<span class="ident" id="4149385"><a href="/crypto/tls/conn.go.html#4149343">err</a></span>&nbsp;<span class="op" id="4149389">!=</span>&nbsp;<span class="ident" id="4149392">nil</span>&nbsp;<span class="op" id="4149396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149401">return</span>&nbsp;<span class="ident" id="4149408">nil</span><span class="op" id="4149411">,</span>&nbsp;<span class="ident" id="4149413"><a href="/crypto/tls/conn.go.html#4149343">err</a></span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4149419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4149422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4149425"><a href="/crypto/tls/conn.go.html#4149082">data</a></span>&nbsp;<span class="op" id="4149430">=</span>&nbsp;<span class="ident" id="4149432"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4149433">.</span><span class="ident" id="4149434">hand</span><span class="op" id="4149438">.</span><span class="ident" id="4149439">Next</span><span class="op" id="4149443">(</span><span class="num" id="4149444">4</span>&nbsp;<span class="op" id="4149446">+</span>&nbsp;<span class="ident" id="4149448"><a href="/crypto/tls/conn.go.html#4149106">n</a></span><span class="op" id="4149449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149452">var</span>&nbsp;<span class="ident" id="4149456">m</span>&nbsp;<span class="ident" id="4149458"><a href="/crypto/tls/common.go.html#4124572">handshakeMessage</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149476">switch</span>&nbsp;<span class="ident" id="4149483"><a href="/crypto/tls/conn.go.html#4149082">data</a></span><span class="op" id="4149487">[</span><span class="num" id="4149488">0</span><span class="op" id="4149489">]</span>&nbsp;<span class="op" id="4149491">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149494">case</span>&nbsp;<span class="ident" id="4149499"><a href="/crypto/tls/common.go.html#4108849">typeClientHello</a></span><span class="op" id="4149514">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4149518"><a href="/crypto/tls/conn.go.html#4149456">m</a></span>&nbsp;<span class="op" id="4149520">=</span>&nbsp;<span class="builtinfunc" id="4149522">new</span><span class="op" id="4149525">(</span><span class="ident" id="4149526"><a href="/crypto/tls/handshake_messages.go.html#4173962">clientHelloMsg</a></span><span class="op" id="4149540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149543">case</span>&nbsp;<span class="ident" id="4149548"><a href="/crypto/tls/common.go.html#4108883">typeServerHello</a></span><span class="op" id="4149563">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4149567"><a href="/crypto/tls/conn.go.html#4149456">m</a></span>&nbsp;<span class="op" id="4149569">=</span>&nbsp;<span class="builtinfunc" id="4149571">new</span><span class="op" id="4149574">(</span><span class="ident" id="4149575"><a href="/crypto/tls/handshake_messages.go.html#4185078">serverHelloMsg</a></span><span class="op" id="4149589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149592">case</span>&nbsp;<span class="ident" id="4149597"><a href="/crypto/tls/common.go.html#4108917">typeNewSessionTicket</a></span><span class="op" id="4149617">:</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4149621"><a href="/crypto/tls/conn.go.html#4149456">m</a></span>&nbsp;<span class="op" id="4149623">=</span>&nbsp;<span class="builtinfunc" id="4149625">new</span><span class="op" id="4149628">(</span><span class="ident" id="4149629"><a href="/crypto/tls/handshake_messages.go.html#4202153">newSessionTicketMsg</a></span><span class="op" id="4149648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149651">case</span>&nbsp;<span class="ident" id="4149656"><a href="/crypto/tls/common.go.html#4108951">typeCertificate</a></span><span class="op" id="4149671">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4149675"><a href="/crypto/tls/conn.go.html#4149456">m</a></span>&nbsp;<span class="op" id="4149677">=</span>&nbsp;<span class="builtinfunc" id="4149679">new</span><span class="op" id="4149682">(</span><span class="ident" id="4149683"><a href="/crypto/tls/handshake_messages.go.html#4190456">certificateMsg</a></span><span class="op" id="4149697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149700">case</span>&nbsp;<span class="ident" id="4149705"><a href="/crypto/tls/common.go.html#4109021">typeCertificateRequest</a></span><span class="op" id="4149727">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4149731"><a href="/crypto/tls/conn.go.html#4149456">m</a></span>&nbsp;<span class="op" id="4149733">=</span>&nbsp;<span class="op" id="4149735">&amp;</span><span class="ident" id="4149736"><a href="/crypto/tls/handshake_messages.go.html#4197001">certificateRequestMsg</a></span><span class="op" id="4149757">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4149762">hasSignatureAndHash</span><span class="op" id="4149781">:</span>&nbsp;<span class="ident" id="4149783"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4149784">.</span><span class="ident" id="4149785">vers</span>&nbsp;<span class="op" id="4149790">&gt;=</span>&nbsp;<span class="ident" id="4149793"><a href="/crypto/tls/common.go.html#4108205">VersionTLS12</a></span><span class="op" id="4149805">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4149809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149812">case</span>&nbsp;<span class="ident" id="4149817"><a href="/crypto/tls/common.go.html#4109196">typeCertificateStatus</a></span><span class="op" id="4149838">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4149842"><a href="/crypto/tls/conn.go.html#4149456">m</a></span>&nbsp;<span class="op" id="4149844">=</span>&nbsp;<span class="builtinfunc" id="4149846">new</span><span class="op" id="4149849">(</span><span class="ident" id="4149850"><a href="/crypto/tls/handshake_messages.go.html#4192853">certificateStatusMsg</a></span><span class="op" id="4149870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149873">case</span>&nbsp;<span class="ident" id="4149878"><a href="/crypto/tls/common.go.html#4108986">typeServerKeyExchange</a></span><span class="op" id="4149899">:</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4149903"><a href="/crypto/tls/conn.go.html#4149456">m</a></span>&nbsp;<span class="op" id="4149905">=</span>&nbsp;<span class="builtinfunc" id="4149907">new</span><span class="op" id="4149910">(</span><span class="ident" id="4149911"><a href="/crypto/tls/handshake_messages.go.html#4192159">serverKeyExchangeMsg</a></span><span class="op" id="4149931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149934">case</span>&nbsp;<span class="ident" id="4149939"><a href="/crypto/tls/common.go.html#4109056">typeServerHelloDone</a></span><span class="op" id="4149958">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4149962"><a href="/crypto/tls/conn.go.html#4149456">m</a></span>&nbsp;<span class="op" id="4149964">=</span>&nbsp;<span class="builtinfunc" id="4149966">new</span><span class="op" id="4149969">(</span><span class="ident" id="4149970"><a href="/crypto/tls/handshake_messages.go.html#4194114">serverHelloDoneMsg</a></span><span class="op" id="4149988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4149991">case</span>&nbsp;<span class="ident" id="4149996"><a href="/crypto/tls/common.go.html#4109126">typeClientKeyExchange</a></span><span class="op" id="4150017">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4150021"><a href="/crypto/tls/conn.go.html#4149456">m</a></span>&nbsp;<span class="op" id="4150023">=</span>&nbsp;<span class="builtinfunc" id="4150025">new</span><span class="op" id="4150028">(</span><span class="ident" id="4150029"><a href="/crypto/tls/handshake_messages.go.html#4194449">clientKeyExchangeMsg</a></span><span class="op" id="4150049">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4150052">case</span>&nbsp;<span class="ident" id="4150057"><a href="/crypto/tls/common.go.html#4109091">typeCertificateVerify</a></span><span class="op" id="4150078">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4150082"><a href="/crypto/tls/conn.go.html#4149456">m</a></span>&nbsp;<span class="op" id="4150084">=</span>&nbsp;<span class="op" id="4150086">&amp;</span><span class="ident" id="4150087"><a href="/crypto/tls/handshake_messages.go.html#4200426">certificateVerifyMsg</a></span><span class="op" id="4150107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4150112">hasSignatureAndHash</span><span class="op" id="4150131">:</span>&nbsp;<span class="ident" id="4150133"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4150134">.</span><span class="ident" id="4150135">vers</span>&nbsp;<span class="op" id="4150140">&gt;=</span>&nbsp;<span class="ident" id="4150143"><a href="/crypto/tls/common.go.html#4108205">VersionTLS12</a></span><span class="op" id="4150155">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4150159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4150162">case</span>&nbsp;<span class="ident" id="4150167"><a href="/crypto/tls/common.go.html#4109231">typeNextProtocol</a></span><span class="op" id="4150183">:</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4150187"><a href="/crypto/tls/conn.go.html#4149456">m</a></span>&nbsp;<span class="op" id="4150189">=</span>&nbsp;<span class="builtinfunc" id="4150191">new</span><span class="op" id="4150194">(</span><span class="ident" id="4150195"><a href="/crypto/tls/handshake_messages.go.html#4195916">nextProtoMsg</a></span><span class="op" id="4150207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4150210">case</span>&nbsp;<span class="ident" id="4150215"><a href="/crypto/tls/common.go.html#4109161">typeFinished</a></span><span class="op" id="4150227">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4150231"><a href="/crypto/tls/conn.go.html#4149456">m</a></span>&nbsp;<span class="op" id="4150233">=</span>&nbsp;<span class="builtinfunc" id="4150235">new</span><span class="op" id="4150238">(</span><span class="ident" id="4150239"><a href="/crypto/tls/handshake_messages.go.html#4195289">finishedMsg</a></span><span class="op" id="4150250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4150253">default</span><span class="op" id="4150260">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4150264">return</span>&nbsp;<span class="ident" id="4150271">nil</span><span class="op" id="4150274">,</span>&nbsp;<span class="ident" id="4150276"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4150277">.</span><span class="ident" id="4150278">in</span><span class="op" id="4150280">.</span><span class="ident" id="4150281">setErrorLocked</span><span class="op" id="4150295">(</span><span class="ident" id="4150296"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4150297">.</span><span class="ident" id="4150298">sendAlert</span><span class="op" id="4150307">(</span><span class="ident" id="4150308"><a href="/crypto/tls/alert.go.html#4095992">alertUnexpectedMessage</a></span><span class="op" id="4150330">)</span><span class="op" id="4150331">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4150334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4150338">//&nbsp;The&nbsp;handshake&nbsp;message&nbsp;unmarshallers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4150378">//&nbsp;expect&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;keep&nbsp;references&nbsp;to&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4150428">//&nbsp;so&nbsp;pass&nbsp;in&nbsp;a&nbsp;fresh&nbsp;copy&nbsp;that&nbsp;won&#39;t&nbsp;be&nbsp;overwritten.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4150483"><a href="/crypto/tls/conn.go.html#4149082">data</a></span>&nbsp;<span class="op" id="4150488">=</span>&nbsp;<span class="builtinfunc" id="4150490">append</span><span class="op" id="4150496">(</span><span class="op" id="4150497">[</span><span class="op" id="4150498">]</span><span class="builtintype" id="4150499">byte</span><span class="op" id="4150503">(</span><span class="ident" id="4150504">nil</span><span class="op" id="4150507">)</span><span class="op" id="4150508">,</span>&nbsp;<span class="ident" id="4150510"><a href="/crypto/tls/conn.go.html#4149082">data</a></span><span class="op" id="4150514">...</span><span class="op" id="4150517">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4150521">if</span>&nbsp;<span class="op" id="4150524">!</span><span class="ident" id="4150525"><a href="/crypto/tls/conn.go.html#4149456">m</a></span><span class="op" id="4150526">.</span><span class="ident" id="4150527">unmarshal</span><span class="op" id="4150536">(</span><span class="ident" id="4150537"><a href="/crypto/tls/conn.go.html#4149082">data</a></span><span class="op" id="4150541">)</span>&nbsp;<span class="op" id="4150543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4150547">return</span>&nbsp;<span class="ident" id="4150554">nil</span><span class="op" id="4150557">,</span>&nbsp;<span class="ident" id="4150559"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4150560">.</span><span class="ident" id="4150561">in</span><span class="op" id="4150563">.</span><span class="ident" id="4150564">setErrorLocked</span><span class="op" id="4150578">(</span><span class="ident" id="4150579"><a href="/crypto/tls/conn.go.html#4148864">c</a></span><span class="op" id="4150580">.</span><span class="ident" id="4150581">sendAlert</span><span class="op" id="4150590">(</span><span class="ident" id="4150591"><a href="/crypto/tls/alert.go.html#4095992">alertUnexpectedMessage</a></span><span class="op" id="4150613">)</span><span class="op" id="4150614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4150617">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4150620">return</span>&nbsp;<span class="ident" id="4150627"><a href="/crypto/tls/conn.go.html#4149456">m</a></span><span class="op" id="4150628">,</span>&nbsp;<span class="ident" id="4150630">nil</span><br>
<span class="lineno"></span><span class="op" id="4150634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4150637">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4150677">func</span>&nbsp;<span class="op" id="4150682">(</span><span class="ident" id="4150683">c</span>&nbsp;<span class="op" id="4150685">*</span><span class="ident" id="4150686"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4150690">)</span>&nbsp;<span class="ident" id="4150692">Write</span><span class="op" id="4150697">(</span><span class="ident" id="4150698">b</span>&nbsp;<span class="op" id="4150700">[</span><span class="op" id="4150701">]</span><span class="builtintype" id="4150702">byte</span><span class="op" id="4150706">)</span>&nbsp;<span class="op" id="4150708">(</span><span class="builtintype" id="4150709">int</span><span class="op" id="4150712">,</span>&nbsp;<span class="builtintype" id="4150714">error</span><span class="op" id="4150719">)</span>&nbsp;<span class="op" id="4150721">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4150724">if</span>&nbsp;<span class="ident" id="4150727">err</span>&nbsp;<span class="op" id="4150731">:=</span>&nbsp;<span class="ident" id="4150734"><a href="/crypto/tls/conn.go.html#4150683">c</a></span><span class="op" id="4150735">.</span><span class="ident" id="4150736">Handshake</span><span class="op" id="4150745">(</span><span class="op" id="4150746">)</span><span class="op" id="4150747">;</span>&nbsp;<span class="ident" id="4150749"><a href="/crypto/tls/conn.go.html#4150727">err</a></span>&nbsp;<span class="op" id="4150753">!=</span>&nbsp;<span class="ident" id="4150756">nil</span>&nbsp;<span class="op" id="4150760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4150764">return</span>&nbsp;<span class="num" id="4150771">0</span><span class="op" id="4150772">,</span>&nbsp;<span class="ident" id="4150774"><a href="/crypto/tls/conn.go.html#4150727">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4150779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4150783"><a href="/crypto/tls/conn.go.html#4150683">c</a></span><span class="op" id="4150784">.</span><span class="ident" id="4150785">out</span><span class="op" id="4150788">.</span><span class="ident" id="4150789">Lock</span><span class="op" id="4150793">(</span><span class="op" id="4150794">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4150797">defer</span>&nbsp;<span class="ident" id="4150803"><a href="/crypto/tls/conn.go.html#4150683">c</a></span><span class="op" id="4150804">.</span><span class="ident" id="4150805">out</span><span class="op" id="4150808">.</span><span class="ident" id="4150809">Unlock</span><span class="op" id="4150815">(</span><span class="op" id="4150816">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4150820">if</span>&nbsp;<span class="ident" id="4150823">err</span>&nbsp;<span class="op" id="4150827">:=</span>&nbsp;<span class="ident" id="4150830"><a href="/crypto/tls/conn.go.html#4150683">c</a></span><span class="op" id="4150831">.</span><span class="ident" id="4150832">out</span><span class="op" id="4150835">.</span><span class="ident" id="4150836">err</span><span class="op" id="4150839">;</span>&nbsp;<span class="ident" id="4150841"><a href="/crypto/tls/conn.go.html#4150823">err</a></span>&nbsp;<span class="op" id="4150845">!=</span>&nbsp;<span class="ident" id="4150848">nil</span>&nbsp;<span class="op" id="4150852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4150856">return</span>&nbsp;<span class="num" id="4150863">0</span><span class="op" id="4150864">,</span>&nbsp;<span class="ident" id="4150866"><a href="/crypto/tls/conn.go.html#4150823">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4150871">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4150875">if</span>&nbsp;<span class="op" id="4150878">!</span><span class="ident" id="4150879"><a href="/crypto/tls/conn.go.html#4150683">c</a></span><span class="op" id="4150880">.</span><span class="ident" id="4150881">handshakeComplete</span>&nbsp;<span class="op" id="4150899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4150903">return</span>&nbsp;<span class="num" id="4150910">0</span><span class="op" id="4150911">,</span>&nbsp;<span class="ident" id="4150913"><a href="/crypto/tls/alert.go.html#4096712">alertInternalError</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4150933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4150937">//&nbsp;SSL&nbsp;3.0&nbsp;and&nbsp;TLS&nbsp;1.0&nbsp;are&nbsp;susceptible&nbsp;to&nbsp;a&nbsp;chosen-plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4150999">//&nbsp;attack&nbsp;when&nbsp;using&nbsp;block&nbsp;mode&nbsp;ciphers&nbsp;due&nbsp;to&nbsp;predictable&nbsp;IVs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4151064">//&nbsp;This&nbsp;can&nbsp;be&nbsp;prevented&nbsp;by&nbsp;splitting&nbsp;each&nbsp;Application&nbsp;Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4151125">//&nbsp;record&nbsp;into&nbsp;two&nbsp;records,&nbsp;effectively&nbsp;randomizing&nbsp;the&nbsp;IV.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4151186">//</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4151190">//&nbsp;http://www.openssl.org/~bodo/tls-cbc.txt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4151235">//&nbsp;https://bugzilla.mozilla.org/show_bug.cgi?id=665814</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4151291">//&nbsp;http://www.imperialviolet.org/2012/01/15/beastfollowup.html</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4151356">var</span>&nbsp;<span class="ident" id="4151360">m</span>&nbsp;<span class="builtintype" id="4151362">int</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4151367">if</span>&nbsp;<span class="builtinfunc" id="4151370">len</span><span class="op" id="4151373">(</span><span class="ident" id="4151374"><a href="/crypto/tls/conn.go.html#4150698">b</a></span><span class="op" id="4151375">)</span>&nbsp;<span class="op" id="4151377">&gt;</span>&nbsp;<span class="num" id="4151379">1</span>&nbsp;<span class="op" id="4151381">&amp;&amp;</span>&nbsp;<span class="ident" id="4151384"><a href="/crypto/tls/conn.go.html#4150683">c</a></span><span class="op" id="4151385">.</span><span class="ident" id="4151386">vers</span>&nbsp;<span class="op" id="4151391">&lt;=</span>&nbsp;<span class="ident" id="4151394"><a href="/crypto/tls/common.go.html#4108159">VersionTLS10</a></span>&nbsp;<span class="op" id="4151407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4151411">if</span>&nbsp;<span class="ident" id="4151414">_</span><span class="op" id="4151415">,</span>&nbsp;<span class="ident" id="4151417">ok</span>&nbsp;<span class="op" id="4151420">:=</span>&nbsp;<span class="ident" id="4151423"><a href="/crypto/tls/conn.go.html#4150683">c</a></span><span class="op" id="4151424">.</span><span class="ident" id="4151425">out</span><span class="op" id="4151428">.</span><span class="ident" id="4151429">cipher</span><span class="op" id="4151435">.</span><span class="op" id="4151436">(</span><span class="ident" id="4151437"><a href="/crypto/tls/conn.go.html#4127413">cipher</a></span><span class="op" id="4151443">.</span><span class="ident" id="4151444">BlockMode</span><span class="op" id="4151453">)</span><span class="op" id="4151454">;</span>&nbsp;<span class="ident" id="4151456"><a href="/crypto/tls/conn.go.html#4151417">ok</a></span>&nbsp;<span class="op" id="4151459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4151464">n</span><span class="op" id="4151465">,</span>&nbsp;<span class="ident" id="4151467">err</span>&nbsp;<span class="op" id="4151471">:=</span>&nbsp;<span class="ident" id="4151474"><a href="/crypto/tls/conn.go.html#4150683">c</a></span><span class="op" id="4151475">.</span><span class="ident" id="4151476">writeRecord</span><span class="op" id="4151487">(</span><span class="ident" id="4151488"><a href="/crypto/tls/common.go.html#4108762">recordTypeApplicationData</a></span><span class="op" id="4151513">,</span>&nbsp;<span class="ident" id="4151515"><a href="/crypto/tls/conn.go.html#4150698">b</a></span><span class="op" id="4151516">[</span><span class="op" id="4151517">:</span><span class="num" id="4151518">1</span><span class="op" id="4151519">]</span><span class="op" id="4151520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4151525">if</span>&nbsp;<span class="ident" id="4151528"><a href="/crypto/tls/conn.go.html#4151467">err</a></span>&nbsp;<span class="op" id="4151532">!=</span>&nbsp;<span class="ident" id="4151535">nil</span>&nbsp;<span class="op" id="4151539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4151545">return</span>&nbsp;<span class="ident" id="4151552"><a href="/crypto/tls/conn.go.html#4151464">n</a></span><span class="op" id="4151553">,</span>&nbsp;<span class="ident" id="4151555"><a href="/crypto/tls/conn.go.html#4150683">c</a></span><span class="op" id="4151556">.</span><span class="ident" id="4151557">out</span><span class="op" id="4151560">.</span><span class="ident" id="4151561">setErrorLocked</span><span class="op" id="4151575">(</span><span class="ident" id="4151576"><a href="/crypto/tls/conn.go.html#4151467">err</a></span><span class="op" id="4151579">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4151584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4151589"><a href="/crypto/tls/conn.go.html#4151360">m</a></span><span class="op" id="4151590">,</span>&nbsp;<span class="ident" id="4151592"><a href="/crypto/tls/conn.go.html#4150698">b</a></span>&nbsp;<span class="op" id="4151594">=</span>&nbsp;<span class="num" id="4151596">1</span><span class="op" id="4151597">,</span>&nbsp;<span class="ident" id="4151599"><a href="/crypto/tls/conn.go.html#4150698">b</a></span><span class="op" id="4151600">[</span><span class="num" id="4151601">1</span><span class="op" id="4151602">:</span><span class="op" id="4151603">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4151607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4151610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4151614">n</span><span class="op" id="4151615">,</span>&nbsp;<span class="ident" id="4151617">err</span>&nbsp;<span class="op" id="4151621">:=</span>&nbsp;<span class="ident" id="4151624"><a href="/crypto/tls/conn.go.html#4150683">c</a></span><span class="op" id="4151625">.</span><span class="ident" id="4151626">writeRecord</span><span class="op" id="4151637">(</span><span class="ident" id="4151638"><a href="/crypto/tls/common.go.html#4108762">recordTypeApplicationData</a></span><span class="op" id="4151663">,</span>&nbsp;<span class="ident" id="4151665"><a href="/crypto/tls/conn.go.html#4150698">b</a></span><span class="op" id="4151666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4151669">return</span>&nbsp;<span class="ident" id="4151676"><a href="/crypto/tls/conn.go.html#4151614">n</a></span>&nbsp;<span class="op" id="4151678">+</span>&nbsp;<span class="ident" id="4151680"><a href="/crypto/tls/conn.go.html#4151360">m</a></span><span class="op" id="4151681">,</span>&nbsp;<span class="ident" id="4151683"><a href="/crypto/tls/conn.go.html#4150683">c</a></span><span class="op" id="4151684">.</span><span class="ident" id="4151685">out</span><span class="op" id="4151688">.</span><span class="ident" id="4151689">setErrorLocked</span><span class="op" id="4151703">(</span><span class="ident" id="4151704"><a href="/crypto/tls/conn.go.html#4151617">err</a></span><span class="op" id="4151707">)</span><br>
<span class="lineno"></span><span class="op" id="4151709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4151712">//&nbsp;Read&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;a&nbsp;net.Error&nbsp;with&nbsp;Timeout()&nbsp;==&nbsp;true</span><br>
<span class="lineno">885</span><span class="comment" id="4151790">//&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and&nbsp;SetReadDeadline.</span><br>
<span class="lineno"></span><span class="keyword" id="4151856">func</span>&nbsp;<span class="op" id="4151861">(</span><span class="ident" id="4151862">c</span>&nbsp;<span class="op" id="4151864">*</span><span class="ident" id="4151865"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4151869">)</span>&nbsp;<span class="ident" id="4151871">Read</span><span class="op" id="4151875">(</span><span class="ident" id="4151876">b</span>&nbsp;<span class="op" id="4151878">[</span><span class="op" id="4151879">]</span><span class="builtintype" id="4151880">byte</span><span class="op" id="4151884">)</span>&nbsp;<span class="op" id="4151886">(</span><span class="ident" id="4151887">n</span>&nbsp;<span class="builtintype" id="4151889">int</span><span class="op" id="4151892">,</span>&nbsp;<span class="ident" id="4151894">err</span>&nbsp;<span class="builtintype" id="4151898">error</span><span class="op" id="4151903">)</span>&nbsp;<span class="op" id="4151905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4151908">if</span>&nbsp;<span class="ident" id="4151911"><a href="/crypto/tls/conn.go.html#4151894">err</a></span>&nbsp;<span class="op" id="4151915">=</span>&nbsp;<span class="ident" id="4151917"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4151918">.</span><span class="ident" id="4151919">Handshake</span><span class="op" id="4151928">(</span><span class="op" id="4151929">)</span><span class="op" id="4151930">;</span>&nbsp;<span class="ident" id="4151932"><a href="/crypto/tls/conn.go.html#4151894">err</a></span>&nbsp;<span class="op" id="4151936">!=</span>&nbsp;<span class="ident" id="4151939">nil</span>&nbsp;<span class="op" id="4151943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4151947">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4151955">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4151958">if</span>&nbsp;<span class="builtinfunc" id="4151961">len</span><span class="op" id="4151964">(</span><span class="ident" id="4151965"><a href="/crypto/tls/conn.go.html#4151876">b</a></span><span class="op" id="4151966">)</span>&nbsp;<span class="op" id="4151968">==</span>&nbsp;<span class="num" id="4151971">0</span>&nbsp;<span class="op" id="4151973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4151977">//&nbsp;Put&nbsp;this&nbsp;after&nbsp;Handshake,&nbsp;in&nbsp;case&nbsp;people&nbsp;were&nbsp;calling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4152036">//&nbsp;Read(nil)&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of&nbsp;the&nbsp;Handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4152089">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4152097">}</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4152101"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4152102">.</span><span class="ident" id="4152103">in</span><span class="op" id="4152105">.</span><span class="ident" id="4152106">Lock</span><span class="op" id="4152110">(</span><span class="op" id="4152111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4152114">defer</span>&nbsp;<span class="ident" id="4152120"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4152121">.</span><span class="ident" id="4152122">in</span><span class="op" id="4152124">.</span><span class="ident" id="4152125">Unlock</span><span class="op" id="4152131">(</span><span class="op" id="4152132">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4152136">//&nbsp;Some&nbsp;OpenSSL&nbsp;servers&nbsp;send&nbsp;empty&nbsp;records&nbsp;in&nbsp;order&nbsp;to&nbsp;randomize&nbsp;the</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4152206">//&nbsp;CBC&nbsp;IV.&nbsp;So&nbsp;this&nbsp;loop&nbsp;ignores&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;empty&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4152274">const</span>&nbsp;<span class="ident" id="4152280">maxConsecutiveEmptyRecords</span>&nbsp;<span class="op" id="4152307">=</span>&nbsp;<span class="num" id="4152309">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4152314">for</span>&nbsp;<span class="ident" id="4152318">emptyRecordCount</span>&nbsp;<span class="op" id="4152335">:=</span>&nbsp;<span class="num" id="4152338">0</span><span class="op" id="4152339">;</span>&nbsp;<span class="ident" id="4152341"><a href="/crypto/tls/conn.go.html#4152318">emptyRecordCount</a></span>&nbsp;<span class="op" id="4152358">&lt;=</span>&nbsp;<span class="ident" id="4152361"><a href="/crypto/tls/conn.go.html#4152280">maxConsecutiveEmptyRecords</a></span><span class="op" id="4152387">;</span>&nbsp;<span class="ident" id="4152389"><a href="/crypto/tls/conn.go.html#4152318">emptyRecordCount</a></span><span class="op" id="4152405">++</span>&nbsp;<span class="op" id="4152408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4152412">for</span>&nbsp;<span class="ident" id="4152416"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4152417">.</span><span class="ident" id="4152418">input</span>&nbsp;<span class="op" id="4152424">==</span>&nbsp;<span class="ident" id="4152427">nil</span>&nbsp;<span class="op" id="4152431">&amp;&amp;</span>&nbsp;<span class="ident" id="4152434"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4152435">.</span><span class="ident" id="4152436">in</span><span class="op" id="4152438">.</span><span class="ident" id="4152439">err</span>&nbsp;<span class="op" id="4152443">==</span>&nbsp;<span class="ident" id="4152446">nil</span>&nbsp;<span class="op" id="4152450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4152455">if</span>&nbsp;<span class="ident" id="4152458">err</span>&nbsp;<span class="op" id="4152462">:=</span>&nbsp;<span class="ident" id="4152465"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4152466">.</span><span class="ident" id="4152467">readRecord</span><span class="op" id="4152477">(</span><span class="ident" id="4152478"><a href="/crypto/tls/common.go.html#4108762">recordTypeApplicationData</a></span><span class="op" id="4152503">)</span><span class="op" id="4152504">;</span>&nbsp;<span class="ident" id="4152506"><a href="/crypto/tls/conn.go.html#4152458">err</a></span>&nbsp;<span class="op" id="4152510">!=</span>&nbsp;<span class="ident" id="4152513">nil</span>&nbsp;<span class="op" id="4152517">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4152523">//&nbsp;Soft&nbsp;error,&nbsp;like&nbsp;EAGAIN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4152554">return</span>&nbsp;<span class="num" id="4152561">0</span><span class="op" id="4152562">,</span>&nbsp;<span class="ident" id="4152564"><a href="/crypto/tls/conn.go.html#4152458">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4152571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4152575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4152579">if</span>&nbsp;<span class="ident" id="4152582">err</span>&nbsp;<span class="op" id="4152586">:=</span>&nbsp;<span class="ident" id="4152589"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4152590">.</span><span class="ident" id="4152591">in</span><span class="op" id="4152593">.</span><span class="ident" id="4152594">err</span><span class="op" id="4152597">;</span>&nbsp;<span class="ident" id="4152599"><a href="/crypto/tls/conn.go.html#4152582">err</a></span>&nbsp;<span class="op" id="4152603">!=</span>&nbsp;<span class="ident" id="4152606">nil</span>&nbsp;<span class="op" id="4152610">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4152615">return</span>&nbsp;<span class="num" id="4152622">0</span><span class="op" id="4152623">,</span>&nbsp;<span class="ident" id="4152625"><a href="/crypto/tls/conn.go.html#4152582">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4152631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4152636"><a href="/crypto/tls/conn.go.html#4151887">n</a></span><span class="op" id="4152637">,</span>&nbsp;<span class="ident" id="4152639"><a href="/crypto/tls/conn.go.html#4151894">err</a></span>&nbsp;<span class="op" id="4152643">=</span>&nbsp;<span class="ident" id="4152645"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4152646">.</span><span class="ident" id="4152647">input</span><span class="op" id="4152652">.</span><span class="ident" id="4152653">Read</span><span class="op" id="4152657">(</span><span class="ident" id="4152658"><a href="/crypto/tls/conn.go.html#4151876">b</a></span><span class="op" id="4152659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4152663">if</span>&nbsp;<span class="ident" id="4152666"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4152667">.</span><span class="ident" id="4152668">input</span><span class="op" id="4152673">.</span><span class="ident" id="4152674">off</span>&nbsp;<span class="op" id="4152678">&gt;=</span>&nbsp;<span class="builtinfunc" id="4152681">len</span><span class="op" id="4152684">(</span><span class="ident" id="4152685"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4152686">.</span><span class="ident" id="4152687">input</span><span class="op" id="4152692">.</span><span class="ident" id="4152693">data</span><span class="op" id="4152697">)</span>&nbsp;<span class="op" id="4152699">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4152704"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4152705">.</span><span class="ident" id="4152706">in</span><span class="op" id="4152708">.</span><span class="ident" id="4152709">freeBlock</span><span class="op" id="4152718">(</span><span class="ident" id="4152719"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4152720">.</span><span class="ident" id="4152721">input</span><span class="op" id="4152726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4152731"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4152732">.</span><span class="ident" id="4152733">input</span>&nbsp;<span class="op" id="4152739">=</span>&nbsp;<span class="ident" id="4152741">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4152747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4152752">//&nbsp;If&nbsp;a&nbsp;close-notify&nbsp;alert&nbsp;is&nbsp;waiting,&nbsp;read&nbsp;it&nbsp;so&nbsp;that</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4152809">//&nbsp;we&nbsp;can&nbsp;return&nbsp;(n,&nbsp;EOF)&nbsp;instead&nbsp;of&nbsp;(n,&nbsp;nil),&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4152868">//&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4152921">//&nbsp;connection&nbsp;is&nbsp;now&nbsp;closed.&nbsp;This&nbsp;eliminates&nbsp;a&nbsp;race</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4152975">//&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4153028">//&nbsp;otherwise&nbsp;not&nbsp;observe&nbsp;the&nbsp;EOF&nbsp;until&nbsp;its&nbsp;next&nbsp;read,</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4153084">//&nbsp;by&nbsp;which&nbsp;time&nbsp;a&nbsp;client&nbsp;goroutine&nbsp;might&nbsp;have&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4153141">//&nbsp;tried&nbsp;to&nbsp;reuse&nbsp;the&nbsp;HTTP&nbsp;connection&nbsp;for&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4153191">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4153205">//&nbsp;See&nbsp;https://codereview.appspot.com/76400046</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4153254">//&nbsp;and&nbsp;http://golang.org/issue/3514</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4153292">if</span>&nbsp;<span class="ident" id="4153295">ri</span>&nbsp;<span class="op" id="4153298">:=</span>&nbsp;<span class="ident" id="4153301"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4153302">.</span><span class="ident" id="4153303">rawInput</span><span class="op" id="4153311">;</span>&nbsp;<span class="ident" id="4153313"><a href="/crypto/tls/conn.go.html#4153295">ri</a></span>&nbsp;<span class="op" id="4153316">!=</span>&nbsp;<span class="ident" id="4153319">nil</span>&nbsp;<span class="op" id="4153323">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153329"><a href="/crypto/tls/conn.go.html#4151887">n</a></span>&nbsp;<span class="op" id="4153331">!=</span>&nbsp;<span class="num" id="4153334">0</span>&nbsp;<span class="op" id="4153336">&amp;&amp;</span>&nbsp;<span class="ident" id="4153339"><a href="/crypto/tls/conn.go.html#4151894">err</a></span>&nbsp;<span class="op" id="4153343">==</span>&nbsp;<span class="ident" id="4153346">nil</span>&nbsp;<span class="op" id="4153350">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153356"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4153357">.</span><span class="ident" id="4153358">input</span>&nbsp;<span class="op" id="4153364">==</span>&nbsp;<span class="ident" id="4153367">nil</span>&nbsp;<span class="op" id="4153371">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4153374">len</span><span class="op" id="4153377">(</span><span class="ident" id="4153378"><a href="/crypto/tls/conn.go.html#4153295">ri</a></span><span class="op" id="4153380">.</span><span class="ident" id="4153381">data</span><span class="op" id="4153385">)</span>&nbsp;<span class="op" id="4153387">&gt;</span>&nbsp;<span class="num" id="4153389">0</span>&nbsp;<span class="op" id="4153391">&amp;&amp;</span>&nbsp;<span class="ident" id="4153394"><a href="/crypto/tls/common.go.html#4108603">recordType</a></span><span class="op" id="4153404">(</span><span class="ident" id="4153405"><a href="/crypto/tls/conn.go.html#4153295">ri</a></span><span class="op" id="4153407">.</span><span class="ident" id="4153408">data</span><span class="op" id="4153412">[</span><span class="num" id="4153413">0</span><span class="op" id="4153414">]</span><span class="op" id="4153415">)</span>&nbsp;<span class="op" id="4153417">==</span>&nbsp;<span class="ident" id="4153420"><a href="/crypto/tls/common.go.html#4108674">recordTypeAlert</a></span>&nbsp;<span class="op" id="4153436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4153441">if</span>&nbsp;<span class="ident" id="4153444">recErr</span>&nbsp;<span class="op" id="4153451">:=</span>&nbsp;<span class="ident" id="4153454"><a href="/crypto/tls/conn.go.html#4151862">c</a></span><span class="op" id="4153455">.</span><span class="ident" id="4153456">readRecord</span><span class="op" id="4153466">(</span><span class="ident" id="4153467"><a href="/crypto/tls/common.go.html#4108762">recordTypeApplicationData</a></span><span class="op" id="4153492">)</span><span class="op" id="4153493">;</span>&nbsp;<span class="ident" id="4153495"><a href="/crypto/tls/conn.go.html#4153444">recErr</a></span>&nbsp;<span class="op" id="4153502">!=</span>&nbsp;<span class="ident" id="4153505">nil</span>&nbsp;<span class="op" id="4153509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153515"><a href="/crypto/tls/conn.go.html#4151894">err</a></span>&nbsp;<span class="op" id="4153519">=</span>&nbsp;<span class="ident" id="4153521"><a href="/crypto/tls/conn.go.html#4153444">recErr</a></span>&nbsp;<span class="comment" id="4153528">//&nbsp;will&nbsp;be&nbsp;io.EOF&nbsp;on&nbsp;closeNotify</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4153564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4153568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4153573">if</span>&nbsp;<span class="ident" id="4153576"><a href="/crypto/tls/conn.go.html#4151887">n</a></span>&nbsp;<span class="op" id="4153578">!=</span>&nbsp;<span class="num" id="4153581">0</span>&nbsp;<span class="op" id="4153583">||</span>&nbsp;<span class="ident" id="4153586"><a href="/crypto/tls/conn.go.html#4151894">err</a></span>&nbsp;<span class="op" id="4153590">!=</span>&nbsp;<span class="ident" id="4153593">nil</span>&nbsp;<span class="op" id="4153597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4153602">return</span>&nbsp;<span class="ident" id="4153609"><a href="/crypto/tls/conn.go.html#4151887">n</a></span><span class="op" id="4153610">,</span>&nbsp;<span class="ident" id="4153612"><a href="/crypto/tls/conn.go.html#4151894">err</a></span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4153618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4153621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4153625">return</span>&nbsp;<span class="num" id="4153632">0</span><span class="op" id="4153633">,</span>&nbsp;<span class="ident" id="4153635"><a href="/crypto/tls/conn.go.html#4127479">io</a></span><span class="op" id="4153637">.</span><span class="ident" id="4153638">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="4153652">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span><span class="comment" id="4153655">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4153687">func</span>&nbsp;<span class="op" id="4153692">(</span><span class="ident" id="4153693">c</span>&nbsp;<span class="op" id="4153695">*</span><span class="ident" id="4153696"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4153700">)</span>&nbsp;<span class="ident" id="4153702">Close</span><span class="op" id="4153707">(</span><span class="op" id="4153708">)</span>&nbsp;<span class="builtintype" id="4153710">error</span>&nbsp;<span class="op" id="4153716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4153719">var</span>&nbsp;<span class="ident" id="4153723">alertErr</span>&nbsp;<span class="builtintype" id="4153732">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153740"><a href="/crypto/tls/conn.go.html#4153693">c</a></span><span class="op" id="4153741">.</span><span class="ident" id="4153742">handshakeMutex</span><span class="op" id="4153756">.</span><span class="ident" id="4153757">Lock</span><span class="op" id="4153761">(</span><span class="op" id="4153762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4153765">defer</span>&nbsp;<span class="ident" id="4153771"><a href="/crypto/tls/conn.go.html#4153693">c</a></span><span class="op" id="4153772">.</span><span class="ident" id="4153773">handshakeMutex</span><span class="op" id="4153787">.</span><span class="ident" id="4153788">Unlock</span><span class="op" id="4153794">(</span><span class="op" id="4153795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4153798">if</span>&nbsp;<span class="ident" id="4153801"><a href="/crypto/tls/conn.go.html#4153693">c</a></span><span class="op" id="4153802">.</span><span class="ident" id="4153803">handshakeComplete</span>&nbsp;<span class="op" id="4153821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153825"><a href="/crypto/tls/conn.go.html#4153723">alertErr</a></span>&nbsp;<span class="op" id="4153834">=</span>&nbsp;<span class="ident" id="4153836"><a href="/crypto/tls/conn.go.html#4153693">c</a></span><span class="op" id="4153837">.</span><span class="ident" id="4153838">sendAlert</span><span class="op" id="4153847">(</span><span class="ident" id="4153848"><a href="/crypto/tls/alert.go.html#4095953">alertCloseNotify</a></span><span class="op" id="4153864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4153867">}</span><br>
<span class="lineno">955</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4153871">if</span>&nbsp;<span class="ident" id="4153874">err</span>&nbsp;<span class="op" id="4153878">:=</span>&nbsp;<span class="ident" id="4153881"><a href="/crypto/tls/conn.go.html#4153693">c</a></span><span class="op" id="4153882">.</span><span class="ident" id="4153883">conn</span><span class="op" id="4153887">.</span><span class="ident" id="4153888">Close</span><span class="op" id="4153893">(</span><span class="op" id="4153894">)</span><span class="op" id="4153895">;</span>&nbsp;<span class="ident" id="4153897"><a href="/crypto/tls/conn.go.html#4153874">err</a></span>&nbsp;<span class="op" id="4153901">!=</span>&nbsp;<span class="ident" id="4153904">nil</span>&nbsp;<span class="op" id="4153908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4153912">return</span>&nbsp;<span class="ident" id="4153919"><a href="/crypto/tls/conn.go.html#4153874">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4153924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4153927">return</span>&nbsp;<span class="ident" id="4153934"><a href="/crypto/tls/conn.go.html#4153723">alertErr</a></span><br>
<span class="lineno">960</span><span class="op" id="4153943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4153946">//&nbsp;Handshake&nbsp;runs&nbsp;the&nbsp;client&nbsp;or&nbsp;server&nbsp;handshake</span><br>
<span class="lineno"></span><span class="comment" id="4153995">//&nbsp;protocol&nbsp;if&nbsp;it&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="4154035">//&nbsp;Most&nbsp;uses&nbsp;of&nbsp;this&nbsp;package&nbsp;need&nbsp;not&nbsp;call&nbsp;Handshake</span><br>
<span class="lineno">965</span><span class="comment" id="4154088">//&nbsp;explicitly:&nbsp;the&nbsp;first&nbsp;Read&nbsp;or&nbsp;Write&nbsp;will&nbsp;call&nbsp;it&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="4154155">func</span>&nbsp;<span class="op" id="4154160">(</span><span class="ident" id="4154161">c</span>&nbsp;<span class="op" id="4154163">*</span><span class="ident" id="4154164"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4154168">)</span>&nbsp;<span class="ident" id="4154170">Handshake</span><span class="op" id="4154179">(</span><span class="op" id="4154180">)</span>&nbsp;<span class="builtintype" id="4154182">error</span>&nbsp;<span class="op" id="4154188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4154191"><a href="/crypto/tls/conn.go.html#4154161">c</a></span><span class="op" id="4154192">.</span><span class="ident" id="4154193">handshakeMutex</span><span class="op" id="4154207">.</span><span class="ident" id="4154208">Lock</span><span class="op" id="4154212">(</span><span class="op" id="4154213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4154216">defer</span>&nbsp;<span class="ident" id="4154222"><a href="/crypto/tls/conn.go.html#4154161">c</a></span><span class="op" id="4154223">.</span><span class="ident" id="4154224">handshakeMutex</span><span class="op" id="4154238">.</span><span class="ident" id="4154239">Unlock</span><span class="op" id="4154245">(</span><span class="op" id="4154246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4154249">if</span>&nbsp;<span class="ident" id="4154252">err</span>&nbsp;<span class="op" id="4154256">:=</span>&nbsp;<span class="ident" id="4154259"><a href="/crypto/tls/conn.go.html#4154161">c</a></span><span class="op" id="4154260">.</span><span class="ident" id="4154261">handshakeErr</span><span class="op" id="4154273">;</span>&nbsp;<span class="ident" id="4154275"><a href="/crypto/tls/conn.go.html#4154252">err</a></span>&nbsp;<span class="op" id="4154279">!=</span>&nbsp;<span class="ident" id="4154282">nil</span>&nbsp;<span class="op" id="4154286">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4154290">return</span>&nbsp;<span class="ident" id="4154297"><a href="/crypto/tls/conn.go.html#4154252">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4154302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4154305">if</span>&nbsp;<span class="ident" id="4154308"><a href="/crypto/tls/conn.go.html#4154161">c</a></span><span class="op" id="4154309">.</span><span class="ident" id="4154310">handshakeComplete</span>&nbsp;<span class="op" id="4154328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4154332">return</span>&nbsp;<span class="ident" id="4154339">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4154344">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4154348">if</span>&nbsp;<span class="ident" id="4154351"><a href="/crypto/tls/conn.go.html#4154161">c</a></span><span class="op" id="4154352">.</span><span class="ident" id="4154353">isClient</span>&nbsp;<span class="op" id="4154362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4154366"><a href="/crypto/tls/conn.go.html#4154161">c</a></span><span class="op" id="4154367">.</span><span class="ident" id="4154368">handshakeErr</span>&nbsp;<span class="op" id="4154381">=</span>&nbsp;<span class="ident" id="4154383"><a href="/crypto/tls/conn.go.html#4154161">c</a></span><span class="op" id="4154384">.</span><span class="ident" id="4154385">clientHandshake</span><span class="op" id="4154400">(</span><span class="op" id="4154401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4154404">}</span>&nbsp;<span class="keyword" id="4154406">else</span>&nbsp;<span class="op" id="4154411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4154415"><a href="/crypto/tls/conn.go.html#4154161">c</a></span><span class="op" id="4154416">.</span><span class="ident" id="4154417">handshakeErr</span>&nbsp;<span class="op" id="4154430">=</span>&nbsp;<span class="ident" id="4154432"><a href="/crypto/tls/conn.go.html#4154161">c</a></span><span class="op" id="4154433">.</span><span class="ident" id="4154434">serverHandshake</span><span class="op" id="4154449">(</span><span class="op" id="4154450">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4154453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4154456">return</span>&nbsp;<span class="ident" id="4154463"><a href="/crypto/tls/conn.go.html#4154161">c</a></span><span class="op" id="4154464">.</span><span class="ident" id="4154465">handshakeErr</span><br>
<span class="lineno"></span><span class="op" id="4154478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4154481">//&nbsp;ConnectionState&nbsp;returns&nbsp;basic&nbsp;TLS&nbsp;details&nbsp;about&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">985</span><span class="keyword" id="4154548">func</span>&nbsp;<span class="op" id="4154553">(</span><span class="ident" id="4154554">c</span>&nbsp;<span class="op" id="4154556">*</span><span class="ident" id="4154557"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4154561">)</span>&nbsp;<span class="ident" id="4154563">ConnectionState</span><span class="op" id="4154578">(</span><span class="op" id="4154579">)</span>&nbsp;<span class="ident" id="4154581"><a href="/crypto/tls/common.go.html#4112190">ConnectionState</a></span>&nbsp;<span class="op" id="4154597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4154600"><a href="/crypto/tls/conn.go.html#4154554">c</a></span><span class="op" id="4154601">.</span><span class="ident" id="4154602">handshakeMutex</span><span class="op" id="4154616">.</span><span class="ident" id="4154617">Lock</span><span class="op" id="4154621">(</span><span class="op" id="4154622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4154625">defer</span>&nbsp;<span class="ident" id="4154631"><a href="/crypto/tls/conn.go.html#4154554">c</a></span><span class="op" id="4154632">.</span><span class="ident" id="4154633">handshakeMutex</span><span class="op" id="4154647">.</span><span class="ident" id="4154648">Unlock</span><span class="op" id="4154654">(</span><span class="op" id="4154655">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4154659">var</span>&nbsp;<span class="ident" id="4154663">state</span>&nbsp;<span class="ident" id="4154669"><a href="/crypto/tls/common.go.html#4112190">ConnectionState</a></span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4154686"><a href="/crypto/tls/conn.go.html#4154663">state</a></span><span class="op" id="4154691">.</span><span class="ident" id="4154692">HandshakeComplete</span>&nbsp;<span class="op" id="4154710">=</span>&nbsp;<span class="ident" id="4154712"><a href="/crypto/tls/conn.go.html#4154554">c</a></span><span class="op" id="4154713">.</span><span class="ident" id="4154714">handshakeComplete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4154733">if</span>&nbsp;<span class="ident" id="4154736"><a href="/crypto/tls/conn.go.html#4154554">c</a></span><span class="op" id="4154737">.</span><span class="ident" id="4154738">handshakeComplete</span>&nbsp;<span class="op" id="4154756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4154760"><a href="/crypto/tls/conn.go.html#4154663">state</a></span><span class="op" id="4154765">.</span><span class="ident" id="4154766">Version</span>&nbsp;<span class="op" id="4154774">=</span>&nbsp;<span class="ident" id="4154776"><a href="/crypto/tls/conn.go.html#4154554">c</a></span><span class="op" id="4154777">.</span><span class="ident" id="4154778">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4154785"><a href="/crypto/tls/conn.go.html#4154663">state</a></span><span class="op" id="4154790">.</span><span class="ident" id="4154791">NegotiatedProtocol</span>&nbsp;<span class="op" id="4154810">=</span>&nbsp;<span class="ident" id="4154812"><a href="/crypto/tls/conn.go.html#4154554">c</a></span><span class="op" id="4154813">.</span><span class="ident" id="4154814">clientProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4154831"><a href="/crypto/tls/conn.go.html#4154663">state</a></span><span class="op" id="4154836">.</span><span class="ident" id="4154837">DidResume</span>&nbsp;<span class="op" id="4154847">=</span>&nbsp;<span class="ident" id="4154849"><a href="/crypto/tls/conn.go.html#4154554">c</a></span><span class="op" id="4154850">.</span><span class="ident" id="4154851">didResume</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4154863"><a href="/crypto/tls/conn.go.html#4154663">state</a></span><span class="op" id="4154868">.</span><span class="ident" id="4154869">NegotiatedProtocolIsMutual</span>&nbsp;<span class="op" id="4154896">=</span>&nbsp;<span class="op" id="4154898">!</span><span class="ident" id="4154899"><a href="/crypto/tls/conn.go.html#4154554">c</a></span><span class="op" id="4154900">.</span><span class="ident" id="4154901">clientProtocolFallback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4154926"><a href="/crypto/tls/conn.go.html#4154663">state</a></span><span class="op" id="4154931">.</span><span class="ident" id="4154932">CipherSuite</span>&nbsp;<span class="op" id="4154944">=</span>&nbsp;<span class="ident" id="4154946"><a href="/crypto/tls/conn.go.html#4154554">c</a></span><span class="op" id="4154947">.</span><span class="ident" id="4154948">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4154962"><a href="/crypto/tls/conn.go.html#4154663">state</a></span><span class="op" id="4154967">.</span><span class="ident" id="4154968">PeerCertificates</span>&nbsp;<span class="op" id="4154985">=</span>&nbsp;<span class="ident" id="4154987"><a href="/crypto/tls/conn.go.html#4154554">c</a></span><span class="op" id="4154988">.</span><span class="ident" id="4154989">peerCertificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155008"><a href="/crypto/tls/conn.go.html#4154663">state</a></span><span class="op" id="4155013">.</span><span class="ident" id="4155014">VerifiedChains</span>&nbsp;<span class="op" id="4155029">=</span>&nbsp;<span class="ident" id="4155031"><a href="/crypto/tls/conn.go.html#4154554">c</a></span><span class="op" id="4155032">.</span><span class="ident" id="4155033">verifiedChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155050"><a href="/crypto/tls/conn.go.html#4154663">state</a></span><span class="op" id="4155055">.</span><span class="ident" id="4155056">ServerName</span>&nbsp;<span class="op" id="4155067">=</span>&nbsp;<span class="ident" id="4155069"><a href="/crypto/tls/conn.go.html#4154554">c</a></span><span class="op" id="4155070">.</span><span class="ident" id="4155071">serverName</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4155084">if</span>&nbsp;<span class="op" id="4155087">!</span><span class="ident" id="4155088"><a href="/crypto/tls/conn.go.html#4154554">c</a></span><span class="op" id="4155089">.</span><span class="ident" id="4155090">didResume</span>&nbsp;<span class="op" id="4155100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155105"><a href="/crypto/tls/conn.go.html#4154663">state</a></span><span class="op" id="4155110">.</span><span class="ident" id="4155111">TLSUnique</span>&nbsp;<span class="op" id="4155121">=</span>&nbsp;<span class="ident" id="4155123"><a href="/crypto/tls/conn.go.html#4154554">c</a></span><span class="op" id="4155124">.</span><span class="ident" id="4155125">firstFinished</span><span class="op" id="4155138">[</span><span class="op" id="4155139">:</span><span class="op" id="4155140">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4155144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4155147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4155151">return</span>&nbsp;<span class="ident" id="4155158"><a href="/crypto/tls/conn.go.html#4154663">state</a></span><br>
<span class="lineno"></span><span class="op" id="4155164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4155167">//&nbsp;OCSPResponse&nbsp;returns&nbsp;the&nbsp;stapled&nbsp;OCSP&nbsp;response&nbsp;from&nbsp;the&nbsp;TLS&nbsp;server,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4155241">//&nbsp;any.&nbsp;(Only&nbsp;valid&nbsp;for&nbsp;client&nbsp;connections.)</span><br>
<span class="lineno">1010</span><span class="keyword" id="4155286">func</span>&nbsp;<span class="op" id="4155291">(</span><span class="ident" id="4155292">c</span>&nbsp;<span class="op" id="4155294">*</span><span class="ident" id="4155295"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4155299">)</span>&nbsp;<span class="ident" id="4155301">OCSPResponse</span><span class="op" id="4155313">(</span><span class="op" id="4155314">)</span>&nbsp;<span class="op" id="4155316">[</span><span class="op" id="4155317">]</span><span class="builtintype" id="4155318">byte</span>&nbsp;<span class="op" id="4155323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155326"><a href="/crypto/tls/conn.go.html#4155292">c</a></span><span class="op" id="4155327">.</span><span class="ident" id="4155328">handshakeMutex</span><span class="op" id="4155342">.</span><span class="ident" id="4155343">Lock</span><span class="op" id="4155347">(</span><span class="op" id="4155348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4155351">defer</span>&nbsp;<span class="ident" id="4155357"><a href="/crypto/tls/conn.go.html#4155292">c</a></span><span class="op" id="4155358">.</span><span class="ident" id="4155359">handshakeMutex</span><span class="op" id="4155373">.</span><span class="ident" id="4155374">Unlock</span><span class="op" id="4155380">(</span><span class="op" id="4155381">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4155385">return</span>&nbsp;<span class="ident" id="4155392"><a href="/crypto/tls/conn.go.html#4155292">c</a></span><span class="op" id="4155393">.</span><span class="ident" id="4155394">ocspResponse</span><br>
<span class="lineno">1015</span><span class="op" id="4155407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4155410">//&nbsp;VerifyHostname&nbsp;checks&nbsp;that&nbsp;the&nbsp;peer&nbsp;certificate&nbsp;chain&nbsp;is&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4155480">//&nbsp;connecting&nbsp;to&nbsp;host.&nbsp;&nbsp;If&nbsp;so,&nbsp;it&nbsp;returns&nbsp;nil;&nbsp;if&nbsp;not,&nbsp;it&nbsp;returns&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4155555">//&nbsp;describing&nbsp;the&nbsp;problem.</span><br>
<span class="lineno">1020</span><span class="keyword" id="4155582">func</span>&nbsp;<span class="op" id="4155587">(</span><span class="ident" id="4155588">c</span>&nbsp;<span class="op" id="4155590">*</span><span class="ident" id="4155591"><a href="/crypto/tls/conn.go.html#4127599">Conn</a></span><span class="op" id="4155595">)</span>&nbsp;<span class="ident" id="4155597">VerifyHostname</span><span class="op" id="4155611">(</span><span class="ident" id="4155612">host</span>&nbsp;<span class="builtintype" id="4155617">string</span><span class="op" id="4155623">)</span>&nbsp;<span class="builtintype" id="4155625">error</span>&nbsp;<span class="op" id="4155631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155634"><a href="/crypto/tls/conn.go.html#4155588">c</a></span><span class="op" id="4155635">.</span><span class="ident" id="4155636">handshakeMutex</span><span class="op" id="4155650">.</span><span class="ident" id="4155651">Lock</span><span class="op" id="4155655">(</span><span class="op" id="4155656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4155659">defer</span>&nbsp;<span class="ident" id="4155665"><a href="/crypto/tls/conn.go.html#4155588">c</a></span><span class="op" id="4155666">.</span><span class="ident" id="4155667">handshakeMutex</span><span class="op" id="4155681">.</span><span class="ident" id="4155682">Unlock</span><span class="op" id="4155688">(</span><span class="op" id="4155689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4155692">if</span>&nbsp;<span class="op" id="4155695">!</span><span class="ident" id="4155696"><a href="/crypto/tls/conn.go.html#4155588">c</a></span><span class="op" id="4155697">.</span><span class="ident" id="4155698">isClient</span>&nbsp;<span class="op" id="4155707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4155711">return</span>&nbsp;<span class="ident" id="4155718"><a href="/crypto/tls/conn.go.html#4127462">errors</a></span><span class="op" id="4155724">.</span><span class="ident" id="4155725">New</span><span class="op" id="4155728">(</span><span class="string" id="4155729">&#34;tls:&nbsp;VerifyHostname&nbsp;called&nbsp;on&nbsp;TLS&nbsp;server&nbsp;connection&#34;</span><span class="op" id="4155782">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4155785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4155788">if</span>&nbsp;<span class="op" id="4155791">!</span><span class="ident" id="4155792"><a href="/crypto/tls/conn.go.html#4155588">c</a></span><span class="op" id="4155793">.</span><span class="ident" id="4155794">handshakeComplete</span>&nbsp;<span class="op" id="4155812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4155816">return</span>&nbsp;<span class="ident" id="4155823"><a href="/crypto/tls/conn.go.html#4127462">errors</a></span><span class="op" id="4155829">.</span><span class="ident" id="4155830">New</span><span class="op" id="4155833">(</span><span class="string" id="4155834">&#34;tls:&nbsp;handshake&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;performed&#34;</span><span class="op" id="4155877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4155880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4155883">return</span>&nbsp;<span class="ident" id="4155890"><a href="/crypto/tls/conn.go.html#4155588">c</a></span><span class="op" id="4155891">.</span><span class="ident" id="4155892">peerCertificates</span><span class="op" id="4155908">[</span><span class="num" id="4155909">0</span><span class="op" id="4155910">]</span><span class="op" id="4155911">.</span><span class="ident" id="4155912">VerifyHostname</span><span class="op" id="4155926">(</span><span class="ident" id="4155927"><a href="/crypto/tls/conn.go.html#4155612">host</a></span><span class="op" id="4155931">)</span><br>
<span class="lineno">1030</span><span class="op" id="4155933">}</span>
</div>
</body>
</html>
