<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html" class="current">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1531884">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1531939">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1531993">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1532044">//&nbsp;Malloc&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1532065">//&nbsp;Patterned&nbsp;after&nbsp;tcmalloc&#39;s&nbsp;algorithms;&nbsp;shorter&nbsp;code.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1532122">package</span>&nbsp;<span class="ident" id="1532130">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1532139">import</span>&nbsp;<span class="op" id="1532146">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1532149">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1532158">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1532161">//&nbsp;NOTE(rsc):&nbsp;Everything&nbsp;here&nbsp;could&nbsp;use&nbsp;cas&nbsp;if&nbsp;contention&nbsp;became&nbsp;an&nbsp;issue.</span><br>
<span class="lineno">15</span><span class="keyword" id="1532236">var</span>&nbsp;<span class="ident" id="1532240">proflock</span>&nbsp;<span class="ident" id="1532249">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1532256">//&nbsp;All&nbsp;memory&nbsp;allocations&nbsp;are&nbsp;local&nbsp;and&nbsp;do&nbsp;not&nbsp;escape&nbsp;outside&nbsp;of&nbsp;the&nbsp;profiler.</span><br>
<span class="lineno"></span><span class="comment" id="1532335">//&nbsp;The&nbsp;profiler&nbsp;is&nbsp;forbidden&nbsp;from&nbsp;referring&nbsp;to&nbsp;garbage-collected&nbsp;memory.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1532409">const</span>&nbsp;<span class="op" id="1532415">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1532418">//&nbsp;profile&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1532436">memProfile</span>&nbsp;<span class="ident" id="1532447">bucketType</span>&nbsp;<span class="op" id="1532458">=</span>&nbsp;<span class="num" id="1532460">1</span>&nbsp;<span class="op" id="1532462">+</span>&nbsp;<span class="ident" id="1532464">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1532470">blockProfile</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1532485">//&nbsp;size&nbsp;of&nbsp;bucket&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1532515">buckHashSize</span>&nbsp;<span class="op" id="1532528">=</span>&nbsp;<span class="num" id="1532530">179999</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1532539">//&nbsp;max&nbsp;depth&nbsp;of&nbsp;stack&nbsp;to&nbsp;record&nbsp;in&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1532582">maxStack</span>&nbsp;<span class="op" id="1532591">=</span>&nbsp;<span class="num" id="1532593">32</span><br>
<span class="lineno">30</span><span class="op" id="1532596">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1532599">type</span>&nbsp;<span class="ident" id="1532604">bucketType</span>&nbsp;<span class="builtintype" id="1532615">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1532620">//&nbsp;A&nbsp;bucket&nbsp;holds&nbsp;per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno">35</span><span class="comment" id="1532676">//&nbsp;The&nbsp;representation&nbsp;is&nbsp;a&nbsp;bit&nbsp;sleazy,&nbsp;inherited&nbsp;from&nbsp;C.</span><br>
<span class="lineno"></span><span class="comment" id="1532733">//&nbsp;This&nbsp;struct&nbsp;defines&nbsp;the&nbsp;bucket&nbsp;header.&nbsp;It&nbsp;is&nbsp;followed&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1532793">//&nbsp;memory&nbsp;by&nbsp;the&nbsp;stack&nbsp;words&nbsp;and&nbsp;then&nbsp;the&nbsp;actual&nbsp;record</span><br>
<span class="lineno"></span><span class="comment" id="1532849">//&nbsp;data,&nbsp;either&nbsp;a&nbsp;memRecord&nbsp;or&nbsp;a&nbsp;blockRecord.</span><br>
<span class="lineno"></span><span class="comment" id="1532895">//</span><br>
<span class="lineno">40</span><span class="comment" id="1532898">//&nbsp;Per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="1532939">//&nbsp;Lookup&nbsp;by&nbsp;hashing&nbsp;call&nbsp;stack&nbsp;into&nbsp;a&nbsp;linked-list&nbsp;hash&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="1533002">type</span>&nbsp;<span class="ident" id="1533007">bucket</span>&nbsp;<span class="keyword" id="1533014">struct</span>&nbsp;<span class="op" id="1533021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533024">next</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1533032">*</span><span class="ident" id="1533033">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533041">allnext</span>&nbsp;<span class="op" id="1533049">*</span><span class="ident" id="1533050">bucket</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533058">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533066">bucketType</span>&nbsp;<span class="comment" id="1533077">//&nbsp;memBucket&nbsp;or&nbsp;blockBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533106">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1533114">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533123">size</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1533131">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533140">nstk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1533148">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1533156">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="1533159">//&nbsp;A&nbsp;memRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;memProfile,</span><br>
<span class="lineno"></span><span class="comment" id="1533226">//&nbsp;part&nbsp;of&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1533257">type</span>&nbsp;<span class="ident" id="1533262">memRecord</span>&nbsp;<span class="keyword" id="1533272">struct</span>&nbsp;<span class="op" id="1533279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1533282">//&nbsp;The&nbsp;following&nbsp;complex&nbsp;3-stage&nbsp;scheme&nbsp;of&nbsp;stats&nbsp;accumulation</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1533345">//&nbsp;is&nbsp;required&nbsp;to&nbsp;obtain&nbsp;a&nbsp;consistent&nbsp;picture&nbsp;of&nbsp;mallocs&nbsp;and&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1533413">//&nbsp;for&nbsp;some&nbsp;point&nbsp;in&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1533441">//&nbsp;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;mallocs&nbsp;come&nbsp;in&nbsp;real&nbsp;time,&nbsp;while&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1533504">//&nbsp;come&nbsp;only&nbsp;after&nbsp;a&nbsp;GC&nbsp;during&nbsp;concurrent&nbsp;sweeping.&nbsp;So&nbsp;if&nbsp;we&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1533572">//&nbsp;naively&nbsp;count&nbsp;them,&nbsp;we&nbsp;would&nbsp;get&nbsp;a&nbsp;skew&nbsp;toward&nbsp;mallocs.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1533632">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1533636">//&nbsp;Mallocs&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1533679">//&nbsp;Explicit&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1533729">//&nbsp;GC&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1533771">//&nbsp;After&nbsp;GC&nbsp;prev&nbsp;stats&nbsp;are&nbsp;added&nbsp;to&nbsp;final&nbsp;stats&nbsp;and</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1533824">//&nbsp;recent&nbsp;stats&nbsp;are&nbsp;moved&nbsp;into&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533868">allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1533880">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533889">frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1533901">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533910">alloc_bytes</span>&nbsp;<span class="builtintype" id="1533922">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1533931">free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1533943">uintptr</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1533953">//&nbsp;changes&nbsp;between&nbsp;next-to-last&nbsp;GC&nbsp;and&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534001">prev_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1534018">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534027">prev_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1534044">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534053">prev_alloc_bytes</span>&nbsp;<span class="builtintype" id="1534070">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534079">prev_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1534096">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1534106">//&nbsp;changes&nbsp;since&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534132">recent_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1534151">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534160">recent_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1534179">uintptr</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534188">recent_alloc_bytes</span>&nbsp;<span class="builtintype" id="1534207">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534216">recent_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1534235">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1534243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1534246">//&nbsp;A&nbsp;blockRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;blockProfile,</span><br>
<span class="lineno">85</span><span class="comment" id="1534317">//&nbsp;part&nbsp;of&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1534350">type</span>&nbsp;<span class="ident" id="1534355">blockRecord</span>&nbsp;<span class="keyword" id="1534367">struct</span>&nbsp;<span class="op" id="1534374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534377">count</span>&nbsp;&nbsp;<span class="builtintype" id="1534384">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534391">cycles</span>&nbsp;<span class="builtintype" id="1534398">int64</span><br>
<span class="lineno"></span><span class="op" id="1534404">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="1534407">var</span>&nbsp;<span class="op" id="1534411">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534414">mbuckets</span>&nbsp;&nbsp;<span class="op" id="1534424">*</span><span class="ident" id="1534425">bucket</span>&nbsp;<span class="comment" id="1534432">//&nbsp;memory&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534459">bbuckets</span>&nbsp;&nbsp;<span class="op" id="1534469">*</span><span class="ident" id="1534470">bucket</span>&nbsp;<span class="comment" id="1534477">//&nbsp;blocking&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534506">buckhash</span>&nbsp;&nbsp;<span class="op" id="1534516">*</span><span class="op" id="1534517">[</span><span class="num" id="1534518">179999</span><span class="op" id="1534524">]</span><span class="op" id="1534525">*</span><span class="ident" id="1534526">bucket</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534534">bucketmem</span>&nbsp;<span class="builtintype" id="1534544">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1534552">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1534555">//&nbsp;newBucket&nbsp;allocates&nbsp;a&nbsp;bucket&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;number&nbsp;of&nbsp;stack&nbsp;entries.</span><br>
<span class="lineno"></span><span class="keyword" id="1534636">func</span>&nbsp;<span class="ident" id="1534641">newBucket</span><span class="op" id="1534650">(</span><span class="ident" id="1534651">typ</span>&nbsp;<span class="ident" id="1534655">bucketType</span><span class="op" id="1534665">,</span>&nbsp;<span class="ident" id="1534667">nstk</span>&nbsp;<span class="builtintype" id="1534672">int</span><span class="op" id="1534675">)</span>&nbsp;<span class="op" id="1534677">*</span><span class="ident" id="1534678">bucket</span>&nbsp;<span class="op" id="1534685">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534688">size</span>&nbsp;<span class="op" id="1534693">:=</span>&nbsp;<span class="ident" id="1534696">unsafe</span><span class="op" id="1534702">.</span><span class="ident" id="1534703">Sizeof</span><span class="op" id="1534709">(</span><span class="ident" id="1534710">bucket</span><span class="op" id="1534716">{</span><span class="op" id="1534717">}</span><span class="op" id="1534718">)</span>&nbsp;<span class="op" id="1534720">+</span>&nbsp;<span class="builtintype" id="1534722">uintptr</span><span class="op" id="1534729">(</span><span class="ident" id="1534730">nstk</span><span class="op" id="1534734">)</span><span class="op" id="1534735">*</span><span class="ident" id="1534736">unsafe</span><span class="op" id="1534742">.</span><span class="ident" id="1534743">Sizeof</span><span class="op" id="1534749">(</span><span class="builtintype" id="1534750">uintptr</span><span class="op" id="1534757">(</span><span class="num" id="1534758">0</span><span class="op" id="1534759">)</span><span class="op" id="1534760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534763">switch</span>&nbsp;<span class="ident" id="1534770">typ</span>&nbsp;<span class="op" id="1534774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534777">default</span><span class="op" id="1534784">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534788">gothrow</span><span class="op" id="1534795">(</span><span class="string" id="1534796">&#34;invalid&nbsp;profile&nbsp;bucket&nbsp;type&#34;</span><span class="op" id="1534825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534828">case</span>&nbsp;<span class="ident" id="1534833">memProfile</span><span class="op" id="1534843">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534847">size</span>&nbsp;<span class="op" id="1534852">+=</span>&nbsp;<span class="ident" id="1534855">unsafe</span><span class="op" id="1534861">.</span><span class="ident" id="1534862">Sizeof</span><span class="op" id="1534868">(</span><span class="ident" id="1534869">memRecord</span><span class="op" id="1534878">{</span><span class="op" id="1534879">}</span><span class="op" id="1534880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1534883">case</span>&nbsp;<span class="ident" id="1534888">blockProfile</span><span class="op" id="1534900">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534904">size</span>&nbsp;<span class="op" id="1534909">+=</span>&nbsp;<span class="ident" id="1534912">unsafe</span><span class="op" id="1534918">.</span><span class="ident" id="1534919">Sizeof</span><span class="op" id="1534925">(</span><span class="ident" id="1534926">blockRecord</span><span class="op" id="1534937">{</span><span class="op" id="1534938">}</span><span class="op" id="1534939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1534942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1534946">b</span>&nbsp;<span class="op" id="1534948">:=</span>&nbsp;<span class="op" id="1534951">(</span><span class="op" id="1534952">*</span><span class="ident" id="1534953">bucket</span><span class="op" id="1534959">)</span><span class="op" id="1534960">(</span><span class="ident" id="1534961">persistentalloc</span><span class="op" id="1534976">(</span><span class="ident" id="1534977">size</span><span class="op" id="1534981">,</span>&nbsp;<span class="num" id="1534983">0</span><span class="op" id="1534984">,</span>&nbsp;<span class="op" id="1534986">&amp;</span><span class="ident" id="1534987">memstats</span><span class="op" id="1534995">.</span><span class="ident" id="1534996">buckhash_sys</span><span class="op" id="1535008">)</span><span class="op" id="1535009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535012">bucketmem</span>&nbsp;<span class="op" id="1535022">+=</span>&nbsp;<span class="ident" id="1535025">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535031">b</span><span class="op" id="1535032">.</span><span class="ident" id="1535033">typ</span>&nbsp;<span class="op" id="1535037">=</span>&nbsp;<span class="ident" id="1535039">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535044">b</span><span class="op" id="1535045">.</span><span class="ident" id="1535046">nstk</span>&nbsp;<span class="op" id="1535051">=</span>&nbsp;<span class="builtintype" id="1535053">uintptr</span><span class="op" id="1535060">(</span><span class="ident" id="1535061">nstk</span><span class="op" id="1535065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1535068">return</span>&nbsp;<span class="ident" id="1535075">b</span><br>
<span class="lineno">115</span><span class="op" id="1535077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1535080">//&nbsp;stk&nbsp;returns&nbsp;the&nbsp;slice&nbsp;in&nbsp;b&nbsp;holding&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1535129">func</span>&nbsp;<span class="op" id="1535134">(</span><span class="ident" id="1535135">b</span>&nbsp;<span class="op" id="1535137">*</span><span class="ident" id="1535138">bucket</span><span class="op" id="1535144">)</span>&nbsp;<span class="ident" id="1535146">stk</span><span class="op" id="1535149">(</span><span class="op" id="1535150">)</span>&nbsp;<span class="op" id="1535152">[</span><span class="op" id="1535153">]</span><span class="builtintype" id="1535154">uintptr</span>&nbsp;<span class="op" id="1535162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535165">stk</span>&nbsp;<span class="op" id="1535169">:=</span>&nbsp;<span class="op" id="1535172">(</span><span class="op" id="1535173">*</span><span class="op" id="1535174">[</span><span class="ident" id="1535175">maxStack</span><span class="op" id="1535183">]</span><span class="builtintype" id="1535184">uintptr</span><span class="op" id="1535191">)</span><span class="op" id="1535192">(</span><span class="ident" id="1535193">add</span><span class="op" id="1535196">(</span><span class="ident" id="1535197">unsafe</span><span class="op" id="1535203">.</span><span class="ident" id="1535204">Pointer</span><span class="op" id="1535211">(</span><span class="ident" id="1535212">b</span><span class="op" id="1535213">)</span><span class="op" id="1535214">,</span>&nbsp;<span class="ident" id="1535216">unsafe</span><span class="op" id="1535222">.</span><span class="ident" id="1535223">Sizeof</span><span class="op" id="1535229">(</span><span class="op" id="1535230">*</span><span class="ident" id="1535231">b</span><span class="op" id="1535232">)</span><span class="op" id="1535233">)</span><span class="op" id="1535234">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1535237">return</span>&nbsp;<span class="ident" id="1535244">stk</span><span class="op" id="1535247">[</span><span class="op" id="1535248">:</span><span class="ident" id="1535249">b</span><span class="op" id="1535250">.</span><span class="ident" id="1535251">nstk</span><span class="op" id="1535255">:</span><span class="ident" id="1535256">b</span><span class="op" id="1535257">.</span><span class="ident" id="1535258">nstk</span><span class="op" id="1535262">]</span><br>
<span class="lineno"></span><span class="op" id="1535264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1535267">//&nbsp;mp&nbsp;returns&nbsp;the&nbsp;memRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;memProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1535336">func</span>&nbsp;<span class="op" id="1535341">(</span><span class="ident" id="1535342">b</span>&nbsp;<span class="op" id="1535344">*</span><span class="ident" id="1535345">bucket</span><span class="op" id="1535351">)</span>&nbsp;<span class="ident" id="1535353">mp</span><span class="op" id="1535355">(</span><span class="op" id="1535356">)</span>&nbsp;<span class="op" id="1535358">*</span><span class="ident" id="1535359">memRecord</span>&nbsp;<span class="op" id="1535369">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1535372">if</span>&nbsp;<span class="ident" id="1535375">b</span><span class="op" id="1535376">.</span><span class="ident" id="1535377">typ</span>&nbsp;<span class="op" id="1535381">!=</span>&nbsp;<span class="ident" id="1535384">memProfile</span>&nbsp;<span class="op" id="1535395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535399">gothrow</span><span class="op" id="1535406">(</span><span class="string" id="1535407">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.mp&#34;</span><span class="op" id="1535429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1535432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535435">data</span>&nbsp;<span class="op" id="1535440">:=</span>&nbsp;<span class="ident" id="1535443">add</span><span class="op" id="1535446">(</span><span class="ident" id="1535447">unsafe</span><span class="op" id="1535453">.</span><span class="ident" id="1535454">Pointer</span><span class="op" id="1535461">(</span><span class="ident" id="1535462">b</span><span class="op" id="1535463">)</span><span class="op" id="1535464">,</span>&nbsp;<span class="ident" id="1535466">unsafe</span><span class="op" id="1535472">.</span><span class="ident" id="1535473">Sizeof</span><span class="op" id="1535479">(</span><span class="op" id="1535480">*</span><span class="ident" id="1535481">b</span><span class="op" id="1535482">)</span><span class="op" id="1535483">+</span><span class="ident" id="1535484">b</span><span class="op" id="1535485">.</span><span class="ident" id="1535486">nstk</span><span class="op" id="1535490">*</span><span class="ident" id="1535491">unsafe</span><span class="op" id="1535497">.</span><span class="ident" id="1535498">Sizeof</span><span class="op" id="1535504">(</span><span class="builtintype" id="1535505">uintptr</span><span class="op" id="1535512">(</span><span class="num" id="1535513">0</span><span class="op" id="1535514">)</span><span class="op" id="1535515">)</span><span class="op" id="1535516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1535519">return</span>&nbsp;<span class="op" id="1535526">(</span><span class="op" id="1535527">*</span><span class="ident" id="1535528">memRecord</span><span class="op" id="1535537">)</span><span class="op" id="1535538">(</span><span class="ident" id="1535539">data</span><span class="op" id="1535543">)</span><br>
<span class="lineno">130</span><span class="op" id="1535545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1535548">//&nbsp;bp&nbsp;returns&nbsp;the&nbsp;blockRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;blockProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1535621">func</span>&nbsp;<span class="op" id="1535626">(</span><span class="ident" id="1535627">b</span>&nbsp;<span class="op" id="1535629">*</span><span class="ident" id="1535630">bucket</span><span class="op" id="1535636">)</span>&nbsp;<span class="ident" id="1535638">bp</span><span class="op" id="1535640">(</span><span class="op" id="1535641">)</span>&nbsp;<span class="op" id="1535643">*</span><span class="ident" id="1535644">blockRecord</span>&nbsp;<span class="op" id="1535656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1535659">if</span>&nbsp;<span class="ident" id="1535662">b</span><span class="op" id="1535663">.</span><span class="ident" id="1535664">typ</span>&nbsp;<span class="op" id="1535668">!=</span>&nbsp;<span class="ident" id="1535671">blockProfile</span>&nbsp;<span class="op" id="1535684">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535688">gothrow</span><span class="op" id="1535695">(</span><span class="string" id="1535696">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.bp&#34;</span><span class="op" id="1535718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1535721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535724">data</span>&nbsp;<span class="op" id="1535729">:=</span>&nbsp;<span class="ident" id="1535732">add</span><span class="op" id="1535735">(</span><span class="ident" id="1535736">unsafe</span><span class="op" id="1535742">.</span><span class="ident" id="1535743">Pointer</span><span class="op" id="1535750">(</span><span class="ident" id="1535751">b</span><span class="op" id="1535752">)</span><span class="op" id="1535753">,</span>&nbsp;<span class="ident" id="1535755">unsafe</span><span class="op" id="1535761">.</span><span class="ident" id="1535762">Sizeof</span><span class="op" id="1535768">(</span><span class="op" id="1535769">*</span><span class="ident" id="1535770">b</span><span class="op" id="1535771">)</span><span class="op" id="1535772">+</span><span class="ident" id="1535773">b</span><span class="op" id="1535774">.</span><span class="ident" id="1535775">nstk</span><span class="op" id="1535779">*</span><span class="ident" id="1535780">unsafe</span><span class="op" id="1535786">.</span><span class="ident" id="1535787">Sizeof</span><span class="op" id="1535793">(</span><span class="builtintype" id="1535794">uintptr</span><span class="op" id="1535801">(</span><span class="num" id="1535802">0</span><span class="op" id="1535803">)</span><span class="op" id="1535804">)</span><span class="op" id="1535805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1535808">return</span>&nbsp;<span class="op" id="1535815">(</span><span class="op" id="1535816">*</span><span class="ident" id="1535817">blockRecord</span><span class="op" id="1535828">)</span><span class="op" id="1535829">(</span><span class="ident" id="1535830">data</span><span class="op" id="1535834">)</span><br>
<span class="lineno"></span><span class="op" id="1535836">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="1535839">//&nbsp;Return&nbsp;the&nbsp;bucket&nbsp;for&nbsp;stk[0:nstk],&nbsp;allocating&nbsp;new&nbsp;bucket&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="1535910">func</span>&nbsp;<span class="ident" id="1535915">stkbucket</span><span class="op" id="1535924">(</span><span class="ident" id="1535925">typ</span>&nbsp;<span class="ident" id="1535929">bucketType</span><span class="op" id="1535939">,</span>&nbsp;<span class="ident" id="1535941">size</span>&nbsp;<span class="builtintype" id="1535946">uintptr</span><span class="op" id="1535953">,</span>&nbsp;<span class="ident" id="1535955">stk</span>&nbsp;<span class="op" id="1535959">[</span><span class="op" id="1535960">]</span><span class="builtintype" id="1535961">uintptr</span><span class="op" id="1535968">,</span>&nbsp;<span class="ident" id="1535970">alloc</span>&nbsp;<span class="builtintype" id="1535976">bool</span><span class="op" id="1535980">)</span>&nbsp;<span class="op" id="1535982">*</span><span class="ident" id="1535983">bucket</span>&nbsp;<span class="op" id="1535990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1535993">if</span>&nbsp;<span class="ident" id="1535996">buckhash</span>&nbsp;<span class="op" id="1536005">==</span>&nbsp;<span class="builtintype" id="1536008">nil</span>&nbsp;<span class="op" id="1536012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536016">buckhash</span>&nbsp;<span class="op" id="1536025">=</span>&nbsp;<span class="op" id="1536027">(</span><span class="op" id="1536028">*</span><span class="op" id="1536029">[</span><span class="ident" id="1536030">buckHashSize</span><span class="op" id="1536042">]</span><span class="op" id="1536043">*</span><span class="ident" id="1536044">bucket</span><span class="op" id="1536050">)</span><span class="op" id="1536051">(</span><span class="ident" id="1536052">sysAlloc</span><span class="op" id="1536060">(</span><span class="ident" id="1536061">unsafe</span><span class="op" id="1536067">.</span><span class="ident" id="1536068">Sizeof</span><span class="op" id="1536074">(</span><span class="op" id="1536075">*</span><span class="ident" id="1536076">buckhash</span><span class="op" id="1536084">)</span><span class="op" id="1536085">,</span>&nbsp;<span class="op" id="1536087">&amp;</span><span class="ident" id="1536088">memstats</span><span class="op" id="1536096">.</span><span class="ident" id="1536097">buckhash_sys</span><span class="op" id="1536109">)</span><span class="op" id="1536110">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536114">if</span>&nbsp;<span class="ident" id="1536117">buckhash</span>&nbsp;<span class="op" id="1536126">==</span>&nbsp;<span class="builtintype" id="1536129">nil</span>&nbsp;<span class="op" id="1536133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536138">gothrow</span><span class="op" id="1536145">(</span><span class="string" id="1536146">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1536179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1536183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1536186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1536190">//&nbsp;Hash&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536206">var</span>&nbsp;<span class="ident" id="1536210">h</span>&nbsp;<span class="builtintype" id="1536212">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536221">for</span>&nbsp;<span class="ident" id="1536225">_</span><span class="op" id="1536226">,</span>&nbsp;<span class="ident" id="1536228">pc</span>&nbsp;<span class="op" id="1536231">:=</span>&nbsp;<span class="keyword" id="1536234">range</span>&nbsp;<span class="ident" id="1536240">stk</span>&nbsp;<span class="op" id="1536244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536248">h</span>&nbsp;<span class="op" id="1536250">+=</span>&nbsp;<span class="ident" id="1536253">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536258">h</span>&nbsp;<span class="op" id="1536260">+=</span>&nbsp;<span class="ident" id="1536263">h</span>&nbsp;<span class="op" id="1536265">&lt;&lt;</span>&nbsp;<span class="num" id="1536268">10</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536273">h</span>&nbsp;<span class="op" id="1536275">^=</span>&nbsp;<span class="ident" id="1536278">h</span>&nbsp;<span class="op" id="1536280">&gt;&gt;</span>&nbsp;<span class="num" id="1536283">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1536286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1536289">//&nbsp;hash&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536306">h</span>&nbsp;<span class="op" id="1536308">+=</span>&nbsp;<span class="ident" id="1536311">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536317">h</span>&nbsp;<span class="op" id="1536319">+=</span>&nbsp;<span class="ident" id="1536322">h</span>&nbsp;<span class="op" id="1536324">&lt;&lt;</span>&nbsp;<span class="num" id="1536327">10</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536331">h</span>&nbsp;<span class="op" id="1536333">^=</span>&nbsp;<span class="ident" id="1536336">h</span>&nbsp;<span class="op" id="1536338">&gt;&gt;</span>&nbsp;<span class="num" id="1536341">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1536344">//&nbsp;finalize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536357">h</span>&nbsp;<span class="op" id="1536359">+=</span>&nbsp;<span class="ident" id="1536362">h</span>&nbsp;<span class="op" id="1536364">&lt;&lt;</span>&nbsp;<span class="num" id="1536367">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536370">h</span>&nbsp;<span class="op" id="1536372">^=</span>&nbsp;<span class="ident" id="1536375">h</span>&nbsp;<span class="op" id="1536377">&gt;&gt;</span>&nbsp;<span class="num" id="1536380">11</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536385">i</span>&nbsp;<span class="op" id="1536387">:=</span>&nbsp;<span class="builtintype" id="1536390">int</span><span class="op" id="1536393">(</span><span class="ident" id="1536394">h</span>&nbsp;<span class="op" id="1536396">%</span>&nbsp;<span class="ident" id="1536398">buckHashSize</span><span class="op" id="1536410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536413">for</span>&nbsp;<span class="ident" id="1536417">b</span>&nbsp;<span class="op" id="1536419">:=</span>&nbsp;<span class="ident" id="1536422">buckhash</span><span class="op" id="1536430">[</span><span class="ident" id="1536431">i</span><span class="op" id="1536432">]</span><span class="op" id="1536433">;</span>&nbsp;<span class="ident" id="1536435">b</span>&nbsp;<span class="op" id="1536437">!=</span>&nbsp;<span class="builtintype" id="1536440">nil</span><span class="op" id="1536443">;</span>&nbsp;<span class="ident" id="1536445">b</span>&nbsp;<span class="op" id="1536447">=</span>&nbsp;<span class="ident" id="1536449">b</span><span class="op" id="1536450">.</span><span class="ident" id="1536451">next</span>&nbsp;<span class="op" id="1536456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536460">if</span>&nbsp;<span class="ident" id="1536463">b</span><span class="op" id="1536464">.</span><span class="ident" id="1536465">typ</span>&nbsp;<span class="op" id="1536469">==</span>&nbsp;<span class="ident" id="1536472">typ</span>&nbsp;<span class="op" id="1536476">&amp;&amp;</span>&nbsp;<span class="ident" id="1536479">b</span><span class="op" id="1536480">.</span><span class="ident" id="1536481">hash</span>&nbsp;<span class="op" id="1536486">==</span>&nbsp;<span class="ident" id="1536489">h</span>&nbsp;<span class="op" id="1536491">&amp;&amp;</span>&nbsp;<span class="ident" id="1536494">b</span><span class="op" id="1536495">.</span><span class="ident" id="1536496">size</span>&nbsp;<span class="op" id="1536501">==</span>&nbsp;<span class="ident" id="1536504">size</span>&nbsp;<span class="op" id="1536509">&amp;&amp;</span>&nbsp;<span class="ident" id="1536512">eqslice</span><span class="op" id="1536519">(</span><span class="ident" id="1536520">b</span><span class="op" id="1536521">.</span><span class="ident" id="1536522">stk</span><span class="op" id="1536525">(</span><span class="op" id="1536526">)</span><span class="op" id="1536527">,</span>&nbsp;<span class="ident" id="1536529">stk</span><span class="op" id="1536532">)</span>&nbsp;<span class="op" id="1536534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536539">return</span>&nbsp;<span class="ident" id="1536546">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1536550">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1536553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536557">if</span>&nbsp;<span class="op" id="1536560">!</span><span class="ident" id="1536561">alloc</span>&nbsp;<span class="op" id="1536567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536571">return</span>&nbsp;<span class="builtintype" id="1536578">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1536583">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1536587">//&nbsp;Create&nbsp;new&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536610">b</span>&nbsp;<span class="op" id="1536612">:=</span>&nbsp;<span class="ident" id="1536615">newBucket</span><span class="op" id="1536624">(</span><span class="ident" id="1536625">typ</span><span class="op" id="1536628">,</span>&nbsp;<span class="builtinfunc" id="1536630">len</span><span class="op" id="1536633">(</span><span class="ident" id="1536634">stk</span><span class="op" id="1536637">)</span><span class="op" id="1536638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1536641">copy</span><span class="op" id="1536645">(</span><span class="ident" id="1536646">b</span><span class="op" id="1536647">.</span><span class="ident" id="1536648">stk</span><span class="op" id="1536651">(</span><span class="op" id="1536652">)</span><span class="op" id="1536653">,</span>&nbsp;<span class="ident" id="1536655">stk</span><span class="op" id="1536658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536661">b</span><span class="op" id="1536662">.</span><span class="ident" id="1536663">hash</span>&nbsp;<span class="op" id="1536668">=</span>&nbsp;<span class="ident" id="1536670">h</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536673">b</span><span class="op" id="1536674">.</span><span class="ident" id="1536675">size</span>&nbsp;<span class="op" id="1536680">=</span>&nbsp;<span class="ident" id="1536682">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536688">b</span><span class="op" id="1536689">.</span><span class="ident" id="1536690">next</span>&nbsp;<span class="op" id="1536695">=</span>&nbsp;<span class="ident" id="1536697">buckhash</span><span class="op" id="1536705">[</span><span class="ident" id="1536706">i</span><span class="op" id="1536707">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536710">buckhash</span><span class="op" id="1536718">[</span><span class="ident" id="1536719">i</span><span class="op" id="1536720">]</span>&nbsp;<span class="op" id="1536722">=</span>&nbsp;<span class="ident" id="1536724">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536727">if</span>&nbsp;<span class="ident" id="1536730">typ</span>&nbsp;<span class="op" id="1536734">==</span>&nbsp;<span class="ident" id="1536737">memProfile</span>&nbsp;<span class="op" id="1536748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536752">b</span><span class="op" id="1536753">.</span><span class="ident" id="1536754">allnext</span>&nbsp;<span class="op" id="1536762">=</span>&nbsp;<span class="ident" id="1536764">mbuckets</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536775">mbuckets</span>&nbsp;<span class="op" id="1536784">=</span>&nbsp;<span class="ident" id="1536786">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1536789">}</span>&nbsp;<span class="keyword" id="1536791">else</span>&nbsp;<span class="op" id="1536796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536800">b</span><span class="op" id="1536801">.</span><span class="ident" id="1536802">allnext</span>&nbsp;<span class="op" id="1536810">=</span>&nbsp;<span class="ident" id="1536812">bbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536823">bbuckets</span>&nbsp;<span class="op" id="1536832">=</span>&nbsp;<span class="ident" id="1536834">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1536837">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536840">return</span>&nbsp;<span class="ident" id="1536847">b</span><br>
<span class="lineno"></span><span class="op" id="1536849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1536852">func</span>&nbsp;<span class="ident" id="1536857">sysAlloc</span><span class="op" id="1536865">(</span><span class="ident" id="1536866">n</span>&nbsp;<span class="builtintype" id="1536868">uintptr</span><span class="op" id="1536875">,</span>&nbsp;<span class="ident" id="1536877">stat</span>&nbsp;<span class="op" id="1536882">*</span><span class="builtintype" id="1536883">uint64</span><span class="op" id="1536889">)</span>&nbsp;<span class="ident" id="1536891">unsafe</span><span class="op" id="1536897">.</span><span class="ident" id="1536898">Pointer</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="1536907">func</span>&nbsp;<span class="ident" id="1536912">eqslice</span><span class="op" id="1536919">(</span><span class="ident" id="1536920">x</span><span class="op" id="1536921">,</span>&nbsp;<span class="ident" id="1536923">y</span>&nbsp;<span class="op" id="1536925">[</span><span class="op" id="1536926">]</span><span class="builtintype" id="1536927">uintptr</span><span class="op" id="1536934">)</span>&nbsp;<span class="builtintype" id="1536936">bool</span>&nbsp;<span class="op" id="1536941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536944">if</span>&nbsp;<span class="builtinfunc" id="1536947">len</span><span class="op" id="1536950">(</span><span class="ident" id="1536951">x</span><span class="op" id="1536952">)</span>&nbsp;<span class="op" id="1536954">!=</span>&nbsp;<span class="builtinfunc" id="1536957">len</span><span class="op" id="1536960">(</span><span class="ident" id="1536961">y</span><span class="op" id="1536962">)</span>&nbsp;<span class="op" id="1536964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536968">return</span>&nbsp;<span class="builtintype" id="1536975">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1536982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536985">for</span>&nbsp;<span class="ident" id="1536989">i</span><span class="op" id="1536990">,</span>&nbsp;<span class="ident" id="1536992">xi</span>&nbsp;<span class="op" id="1536995">:=</span>&nbsp;<span class="keyword" id="1536998">range</span>&nbsp;<span class="ident" id="1537004">x</span>&nbsp;<span class="op" id="1537006">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1537010">if</span>&nbsp;<span class="ident" id="1537013">xi</span>&nbsp;<span class="op" id="1537016">!=</span>&nbsp;<span class="ident" id="1537019">y</span><span class="op" id="1537020">[</span><span class="ident" id="1537021">i</span><span class="op" id="1537022">]</span>&nbsp;<span class="op" id="1537024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1537029">return</span>&nbsp;<span class="builtintype" id="1537036">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1537044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1537047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1537050">return</span>&nbsp;<span class="builtintype" id="1537057">true</span><br>
<span class="lineno">205</span><span class="op" id="1537062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1537065">func</span>&nbsp;<span class="ident" id="1537070">mprof_GC</span><span class="op" id="1537078">(</span><span class="op" id="1537079">)</span>&nbsp;<span class="op" id="1537081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1537084">for</span>&nbsp;<span class="ident" id="1537088">b</span>&nbsp;<span class="op" id="1537090">:=</span>&nbsp;<span class="ident" id="1537093">mbuckets</span><span class="op" id="1537101">;</span>&nbsp;<span class="ident" id="1537103">b</span>&nbsp;<span class="op" id="1537105">!=</span>&nbsp;<span class="builtintype" id="1537108">nil</span><span class="op" id="1537111">;</span>&nbsp;<span class="ident" id="1537113">b</span>&nbsp;<span class="op" id="1537115">=</span>&nbsp;<span class="ident" id="1537117">b</span><span class="op" id="1537118">.</span><span class="ident" id="1537119">allnext</span>&nbsp;<span class="op" id="1537127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537131">mp</span>&nbsp;<span class="op" id="1537134">:=</span>&nbsp;<span class="ident" id="1537137">b</span><span class="op" id="1537138">.</span><span class="ident" id="1537139">mp</span><span class="op" id="1537141">(</span><span class="op" id="1537142">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537146">mp</span><span class="op" id="1537148">.</span><span class="ident" id="1537149">allocs</span>&nbsp;<span class="op" id="1537156">+=</span>&nbsp;<span class="ident" id="1537159">mp</span><span class="op" id="1537161">.</span><span class="ident" id="1537162">prev_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537176">mp</span><span class="op" id="1537178">.</span><span class="ident" id="1537179">frees</span>&nbsp;<span class="op" id="1537185">+=</span>&nbsp;<span class="ident" id="1537188">mp</span><span class="op" id="1537190">.</span><span class="ident" id="1537191">prev_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537204">mp</span><span class="op" id="1537206">.</span><span class="ident" id="1537207">alloc_bytes</span>&nbsp;<span class="op" id="1537219">+=</span>&nbsp;<span class="ident" id="1537222">mp</span><span class="op" id="1537224">.</span><span class="ident" id="1537225">prev_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537244">mp</span><span class="op" id="1537246">.</span><span class="ident" id="1537247">free_bytes</span>&nbsp;<span class="op" id="1537258">+=</span>&nbsp;<span class="ident" id="1537261">mp</span><span class="op" id="1537263">.</span><span class="ident" id="1537264">prev_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537283">mp</span><span class="op" id="1537285">.</span><span class="ident" id="1537286">prev_allocs</span>&nbsp;<span class="op" id="1537298">=</span>&nbsp;<span class="ident" id="1537300">mp</span><span class="op" id="1537302">.</span><span class="ident" id="1537303">recent_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537319">mp</span><span class="op" id="1537321">.</span><span class="ident" id="1537322">prev_frees</span>&nbsp;<span class="op" id="1537333">=</span>&nbsp;<span class="ident" id="1537335">mp</span><span class="op" id="1537337">.</span><span class="ident" id="1537338">recent_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537353">mp</span><span class="op" id="1537355">.</span><span class="ident" id="1537356">prev_alloc_bytes</span>&nbsp;<span class="op" id="1537373">=</span>&nbsp;<span class="ident" id="1537375">mp</span><span class="op" id="1537377">.</span><span class="ident" id="1537378">recent_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537399">mp</span><span class="op" id="1537401">.</span><span class="ident" id="1537402">prev_free_bytes</span>&nbsp;<span class="op" id="1537418">=</span>&nbsp;<span class="ident" id="1537420">mp</span><span class="op" id="1537422">.</span><span class="ident" id="1537423">recent_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537444">mp</span><span class="op" id="1537446">.</span><span class="ident" id="1537447">recent_allocs</span>&nbsp;<span class="op" id="1537461">=</span>&nbsp;<span class="num" id="1537463">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537467">mp</span><span class="op" id="1537469">.</span><span class="ident" id="1537470">recent_frees</span>&nbsp;<span class="op" id="1537483">=</span>&nbsp;<span class="num" id="1537485">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537489">mp</span><span class="op" id="1537491">.</span><span class="ident" id="1537492">recent_alloc_bytes</span>&nbsp;<span class="op" id="1537511">=</span>&nbsp;<span class="num" id="1537513">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537517">mp</span><span class="op" id="1537519">.</span><span class="ident" id="1537520">recent_free_bytes</span>&nbsp;<span class="op" id="1537538">=</span>&nbsp;<span class="num" id="1537540">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1537543">}</span><br>
<span class="lineno">225</span><span class="op" id="1537545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1537548">//&nbsp;Record&nbsp;that&nbsp;a&nbsp;gc&nbsp;just&nbsp;happened:&nbsp;all&nbsp;the&nbsp;&#39;recent&#39;&nbsp;statistics&nbsp;are&nbsp;now&nbsp;real.</span><br>
<span class="lineno"></span><span class="keyword" id="1537625">func</span>&nbsp;<span class="ident" id="1537630">mProf_GC</span><span class="op" id="1537638">(</span><span class="op" id="1537639">)</span>&nbsp;<span class="op" id="1537641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537644">lock</span><span class="op" id="1537648">(</span><span class="op" id="1537649">&amp;</span><span class="ident" id="1537650">proflock</span><span class="op" id="1537658">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537661">mprof_GC</span><span class="op" id="1537669">(</span><span class="op" id="1537670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537673">unlock</span><span class="op" id="1537679">(</span><span class="op" id="1537680">&amp;</span><span class="ident" id="1537681">proflock</span><span class="op" id="1537689">)</span><br>
<span class="lineno"></span><span class="op" id="1537691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1537694">//&nbsp;Called&nbsp;by&nbsp;malloc&nbsp;to&nbsp;record&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno">235</span><span class="keyword" id="1537742">func</span>&nbsp;<span class="ident" id="1537747">mProf_Malloc</span><span class="op" id="1537759">(</span><span class="ident" id="1537760">p</span>&nbsp;<span class="ident" id="1537762">unsafe</span><span class="op" id="1537768">.</span><span class="ident" id="1537769">Pointer</span><span class="op" id="1537776">,</span>&nbsp;<span class="ident" id="1537778">size</span>&nbsp;<span class="builtintype" id="1537783">uintptr</span><span class="op" id="1537790">)</span>&nbsp;<span class="op" id="1537792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1537795">var</span>&nbsp;<span class="ident" id="1537799">stk</span>&nbsp;<span class="op" id="1537803">[</span><span class="ident" id="1537804">maxStack</span><span class="op" id="1537812">]</span><span class="builtintype" id="1537813">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537822">nstk</span>&nbsp;<span class="op" id="1537827">:=</span>&nbsp;<span class="ident" id="1537830">callers</span><span class="op" id="1537837">(</span><span class="num" id="1537838">4</span><span class="op" id="1537839">,</span>&nbsp;<span class="op" id="1537841">&amp;</span><span class="ident" id="1537842">stk</span><span class="op" id="1537845">[</span><span class="num" id="1537846">0</span><span class="op" id="1537847">]</span><span class="op" id="1537848">,</span>&nbsp;<span class="builtinfunc" id="1537850">len</span><span class="op" id="1537853">(</span><span class="ident" id="1537854">stk</span><span class="op" id="1537857">)</span><span class="op" id="1537858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537861">lock</span><span class="op" id="1537865">(</span><span class="op" id="1537866">&amp;</span><span class="ident" id="1537867">proflock</span><span class="op" id="1537875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537878">b</span>&nbsp;<span class="op" id="1537880">:=</span>&nbsp;<span class="ident" id="1537883">stkbucket</span><span class="op" id="1537892">(</span><span class="ident" id="1537893">memProfile</span><span class="op" id="1537903">,</span>&nbsp;<span class="ident" id="1537905">size</span><span class="op" id="1537909">,</span>&nbsp;<span class="ident" id="1537911">stk</span><span class="op" id="1537914">[</span><span class="op" id="1537915">:</span><span class="ident" id="1537916">nstk</span><span class="op" id="1537920">]</span><span class="op" id="1537921">,</span>&nbsp;<span class="builtintype" id="1537923">true</span><span class="op" id="1537927">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537930">mp</span>&nbsp;<span class="op" id="1537933">:=</span>&nbsp;<span class="ident" id="1537936">b</span><span class="op" id="1537937">.</span><span class="ident" id="1537938">mp</span><span class="op" id="1537940">(</span><span class="op" id="1537941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537944">mp</span><span class="op" id="1537946">.</span><span class="ident" id="1537947">recent_allocs</span><span class="op" id="1537960">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537964">mp</span><span class="op" id="1537966">.</span><span class="ident" id="1537967">recent_alloc_bytes</span>&nbsp;<span class="op" id="1537986">+=</span>&nbsp;<span class="ident" id="1537989">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537995">unlock</span><span class="op" id="1538001">(</span><span class="op" id="1538002">&amp;</span><span class="ident" id="1538003">proflock</span><span class="op" id="1538011">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538015">//&nbsp;Setprofilebucket&nbsp;locks&nbsp;a&nbsp;bunch&nbsp;of&nbsp;other&nbsp;mutexes,&nbsp;so&nbsp;we&nbsp;call&nbsp;it&nbsp;outside&nbsp;of&nbsp;proflock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538103">//&nbsp;This&nbsp;reduces&nbsp;potential&nbsp;contention&nbsp;and&nbsp;chances&nbsp;of&nbsp;deadlocks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538167">//&nbsp;Since&nbsp;the&nbsp;object&nbsp;must&nbsp;be&nbsp;alive&nbsp;during&nbsp;call&nbsp;to&nbsp;mProf_Malloc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538231">//&nbsp;it&#39;s&nbsp;fine&nbsp;to&nbsp;do&nbsp;this&nbsp;non-atomically.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538272">setprofilebucket</span><span class="op" id="1538288">(</span><span class="ident" id="1538289">p</span><span class="op" id="1538290">,</span>&nbsp;<span class="ident" id="1538292">b</span><span class="op" id="1538293">)</span><br>
<span class="lineno">250</span><span class="op" id="1538295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1538298">func</span>&nbsp;<span class="ident" id="1538303">setprofilebucket_m</span><span class="op" id="1538321">(</span><span class="op" id="1538322">)</span>&nbsp;<span class="comment" id="1538324">//&nbsp;mheap.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1538336">func</span>&nbsp;<span class="ident" id="1538341">setprofilebucket</span><span class="op" id="1538357">(</span><span class="ident" id="1538358">p</span>&nbsp;<span class="ident" id="1538360">unsafe</span><span class="op" id="1538366">.</span><span class="ident" id="1538367">Pointer</span><span class="op" id="1538374">,</span>&nbsp;<span class="ident" id="1538376">b</span>&nbsp;<span class="op" id="1538378">*</span><span class="ident" id="1538379">bucket</span><span class="op" id="1538385">)</span>&nbsp;<span class="op" id="1538387">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538390">g</span>&nbsp;<span class="op" id="1538392">:=</span>&nbsp;<span class="ident" id="1538395">getg</span><span class="op" id="1538399">(</span><span class="op" id="1538400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538403">g</span><span class="op" id="1538404">.</span><span class="ident" id="1538405">m</span><span class="op" id="1538406">.</span><span class="ident" id="1538407">ptrarg</span><span class="op" id="1538413">[</span><span class="num" id="1538414">0</span><span class="op" id="1538415">]</span>&nbsp;<span class="op" id="1538417">=</span>&nbsp;<span class="ident" id="1538419">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538422">g</span><span class="op" id="1538423">.</span><span class="ident" id="1538424">m</span><span class="op" id="1538425">.</span><span class="ident" id="1538426">ptrarg</span><span class="op" id="1538432">[</span><span class="num" id="1538433">1</span><span class="op" id="1538434">]</span>&nbsp;<span class="op" id="1538436">=</span>&nbsp;<span class="ident" id="1538438">unsafe</span><span class="op" id="1538444">.</span><span class="ident" id="1538445">Pointer</span><span class="op" id="1538452">(</span><span class="ident" id="1538453">b</span><span class="op" id="1538454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538457">onM</span><span class="op" id="1538460">(</span><span class="ident" id="1538461">setprofilebucket_m</span><span class="op" id="1538479">)</span><br>
<span class="lineno"></span><span class="op" id="1538481">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="1538484">//&nbsp;Called&nbsp;when&nbsp;freeing&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="1538525">func</span>&nbsp;<span class="ident" id="1538530">mProf_Free</span><span class="op" id="1538540">(</span><span class="ident" id="1538541">b</span>&nbsp;<span class="op" id="1538543">*</span><span class="ident" id="1538544">bucket</span><span class="op" id="1538550">,</span>&nbsp;<span class="ident" id="1538552">size</span>&nbsp;<span class="builtintype" id="1538557">uintptr</span><span class="op" id="1538564">,</span>&nbsp;<span class="ident" id="1538566">freed</span>&nbsp;<span class="builtintype" id="1538572">bool</span><span class="op" id="1538576">)</span>&nbsp;<span class="op" id="1538578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538581">lock</span><span class="op" id="1538585">(</span><span class="op" id="1538586">&amp;</span><span class="ident" id="1538587">proflock</span><span class="op" id="1538595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538598">mp</span>&nbsp;<span class="op" id="1538601">:=</span>&nbsp;<span class="ident" id="1538604">b</span><span class="op" id="1538605">.</span><span class="ident" id="1538606">mp</span><span class="op" id="1538608">(</span><span class="op" id="1538609">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1538612">if</span>&nbsp;<span class="ident" id="1538615">freed</span>&nbsp;<span class="op" id="1538621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538625">mp</span><span class="op" id="1538627">.</span><span class="ident" id="1538628">recent_frees</span><span class="op" id="1538640">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538645">mp</span><span class="op" id="1538647">.</span><span class="ident" id="1538648">recent_free_bytes</span>&nbsp;<span class="op" id="1538666">+=</span>&nbsp;<span class="ident" id="1538669">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1538675">}</span>&nbsp;<span class="keyword" id="1538677">else</span>&nbsp;<span class="op" id="1538682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538686">mp</span><span class="op" id="1538688">.</span><span class="ident" id="1538689">prev_frees</span><span class="op" id="1538699">++</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538704">mp</span><span class="op" id="1538706">.</span><span class="ident" id="1538707">prev_free_bytes</span>&nbsp;<span class="op" id="1538723">+=</span>&nbsp;<span class="ident" id="1538726">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1538732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538735">unlock</span><span class="op" id="1538741">(</span><span class="op" id="1538742">&amp;</span><span class="ident" id="1538743">proflock</span><span class="op" id="1538751">)</span><br>
<span class="lineno"></span><span class="op" id="1538753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="1538756">var</span>&nbsp;<span class="ident" id="1538760">blockprofilerate</span>&nbsp;<span class="builtintype" id="1538777">uint64</span>&nbsp;<span class="comment" id="1538784">//&nbsp;in&nbsp;CPU&nbsp;ticks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1538801">//&nbsp;SetBlockProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;goroutine&nbsp;blocking&nbsp;events</span><br>
<span class="lineno"></span><span class="comment" id="1538875">//&nbsp;that&nbsp;are&nbsp;reported&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.&nbsp;&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample</span><br>
<span class="lineno"></span><span class="comment" id="1538950">//&nbsp;an&nbsp;average&nbsp;of&nbsp;one&nbsp;blocking&nbsp;event&nbsp;per&nbsp;rate&nbsp;nanoseconds&nbsp;spent&nbsp;blocked.</span><br>
<span class="lineno">280</span><span class="comment" id="1539022">//</span><br>
<span class="lineno"></span><span class="comment" id="1539025">//&nbsp;To&nbsp;include&nbsp;every&nbsp;blocking&nbsp;event&nbsp;in&nbsp;the&nbsp;profile,&nbsp;pass&nbsp;rate&nbsp;=&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1539091">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;pass&nbsp;rate&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="1539142">func</span>&nbsp;<span class="ident" id="1539147">SetBlockProfileRate</span><span class="op" id="1539166">(</span><span class="ident" id="1539167">rate</span>&nbsp;<span class="builtintype" id="1539172">int</span><span class="op" id="1539175">)</span>&nbsp;<span class="op" id="1539177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1539180">var</span>&nbsp;<span class="ident" id="1539184">r</span>&nbsp;<span class="builtintype" id="1539186">int64</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1539193">if</span>&nbsp;<span class="ident" id="1539196">rate</span>&nbsp;<span class="op" id="1539201">&lt;=</span>&nbsp;<span class="num" id="1539204">0</span>&nbsp;<span class="op" id="1539206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539210">r</span>&nbsp;<span class="op" id="1539212">=</span>&nbsp;<span class="num" id="1539214">0</span>&nbsp;<span class="comment" id="1539216">//&nbsp;disable&nbsp;profiling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539238">}</span>&nbsp;<span class="keyword" id="1539240">else</span>&nbsp;<span class="keyword" id="1539245">if</span>&nbsp;<span class="ident" id="1539248">rate</span>&nbsp;<span class="op" id="1539253">==</span>&nbsp;<span class="num" id="1539256">1</span>&nbsp;<span class="op" id="1539258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539262">r</span>&nbsp;<span class="op" id="1539264">=</span>&nbsp;<span class="num" id="1539266">1</span>&nbsp;<span class="comment" id="1539268">//&nbsp;profile&nbsp;everything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539291">}</span>&nbsp;<span class="keyword" id="1539293">else</span>&nbsp;<span class="op" id="1539298">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1539302">//&nbsp;convert&nbsp;ns&nbsp;to&nbsp;cycles,&nbsp;use&nbsp;float64&nbsp;to&nbsp;prevent&nbsp;overflow&nbsp;during&nbsp;multiplication</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539383">r</span>&nbsp;<span class="op" id="1539385">=</span>&nbsp;<span class="builtintype" id="1539387">int64</span><span class="op" id="1539392">(</span><span class="builtintype" id="1539393">float64</span><span class="op" id="1539400">(</span><span class="ident" id="1539401">rate</span><span class="op" id="1539405">)</span>&nbsp;<span class="op" id="1539407">*</span>&nbsp;<span class="builtintype" id="1539409">float64</span><span class="op" id="1539416">(</span><span class="ident" id="1539417">tickspersecond</span><span class="op" id="1539431">(</span><span class="op" id="1539432">)</span><span class="op" id="1539433">)</span>&nbsp;<span class="op" id="1539435">/</span>&nbsp;<span class="op" id="1539437">(</span><span class="num" id="1539438">1000</span>&nbsp;<span class="op" id="1539443">*</span>&nbsp;<span class="num" id="1539445">1000</span>&nbsp;<span class="op" id="1539450">*</span>&nbsp;<span class="num" id="1539452">1000</span><span class="op" id="1539456">)</span><span class="op" id="1539457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1539461">if</span>&nbsp;<span class="ident" id="1539464">r</span>&nbsp;<span class="op" id="1539466">==</span>&nbsp;<span class="num" id="1539469">0</span>&nbsp;<span class="op" id="1539471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539476">r</span>&nbsp;<span class="op" id="1539478">=</span>&nbsp;<span class="num" id="1539480">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539484">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539491">atomicstore64</span><span class="op" id="1539504">(</span><span class="op" id="1539505">&amp;</span><span class="ident" id="1539506">blockprofilerate</span><span class="op" id="1539522">,</span>&nbsp;<span class="builtintype" id="1539524">uint64</span><span class="op" id="1539530">(</span><span class="ident" id="1539531">r</span><span class="op" id="1539532">)</span><span class="op" id="1539533">)</span><br>
<span class="lineno"></span><span class="op" id="1539535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="keyword" id="1539538">func</span>&nbsp;<span class="ident" id="1539543">blockevent</span><span class="op" id="1539553">(</span><span class="ident" id="1539554">cycles</span>&nbsp;<span class="builtintype" id="1539561">int64</span><span class="op" id="1539566">,</span>&nbsp;<span class="ident" id="1539568">skip</span>&nbsp;<span class="builtintype" id="1539573">int</span><span class="op" id="1539576">)</span>&nbsp;<span class="op" id="1539578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1539581">if</span>&nbsp;<span class="ident" id="1539584">cycles</span>&nbsp;<span class="op" id="1539591">&lt;=</span>&nbsp;<span class="num" id="1539594">0</span>&nbsp;<span class="op" id="1539596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539600">cycles</span>&nbsp;<span class="op" id="1539607">=</span>&nbsp;<span class="num" id="1539609">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539615">rate</span>&nbsp;<span class="op" id="1539620">:=</span>&nbsp;<span class="builtintype" id="1539623">int64</span><span class="op" id="1539628">(</span><span class="ident" id="1539629">atomicload64</span><span class="op" id="1539641">(</span><span class="op" id="1539642">&amp;</span><span class="ident" id="1539643">blockprofilerate</span><span class="op" id="1539659">)</span><span class="op" id="1539660">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1539663">if</span>&nbsp;<span class="ident" id="1539666">rate</span>&nbsp;<span class="op" id="1539671">&lt;=</span>&nbsp;<span class="num" id="1539674">0</span>&nbsp;<span class="op" id="1539676">||</span>&nbsp;<span class="op" id="1539679">(</span><span class="ident" id="1539680">rate</span>&nbsp;<span class="op" id="1539685">&gt;</span>&nbsp;<span class="ident" id="1539687">cycles</span>&nbsp;<span class="op" id="1539694">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1539697">int64</span><span class="op" id="1539702">(</span><span class="ident" id="1539703">fastrand1</span><span class="op" id="1539712">(</span><span class="op" id="1539713">)</span><span class="op" id="1539714">)</span><span class="op" id="1539715">%</span><span class="ident" id="1539716">rate</span>&nbsp;<span class="op" id="1539721">&gt;</span>&nbsp;<span class="ident" id="1539723">cycles</span><span class="op" id="1539729">)</span>&nbsp;<span class="op" id="1539731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1539735">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539746">gp</span>&nbsp;<span class="op" id="1539749">:=</span>&nbsp;<span class="ident" id="1539752">getg</span><span class="op" id="1539756">(</span><span class="op" id="1539757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1539760">var</span>&nbsp;<span class="ident" id="1539764">nstk</span>&nbsp;<span class="builtintype" id="1539769">int</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1539774">var</span>&nbsp;<span class="ident" id="1539778">stk</span>&nbsp;<span class="op" id="1539782">[</span><span class="ident" id="1539783">maxStack</span><span class="op" id="1539791">]</span><span class="builtintype" id="1539792">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1539801">if</span>&nbsp;<span class="ident" id="1539804">gp</span><span class="op" id="1539806">.</span><span class="ident" id="1539807">m</span><span class="op" id="1539808">.</span><span class="ident" id="1539809">curg</span>&nbsp;<span class="op" id="1539814">==</span>&nbsp;<span class="builtintype" id="1539817">nil</span>&nbsp;<span class="op" id="1539821">||</span>&nbsp;<span class="ident" id="1539824">gp</span><span class="op" id="1539826">.</span><span class="ident" id="1539827">m</span><span class="op" id="1539828">.</span><span class="ident" id="1539829">curg</span>&nbsp;<span class="op" id="1539834">==</span>&nbsp;<span class="ident" id="1539837">gp</span>&nbsp;<span class="op" id="1539840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539844">nstk</span>&nbsp;<span class="op" id="1539849">=</span>&nbsp;<span class="ident" id="1539851">callers</span><span class="op" id="1539858">(</span><span class="ident" id="1539859">skip</span><span class="op" id="1539863">,</span>&nbsp;<span class="op" id="1539865">&amp;</span><span class="ident" id="1539866">stk</span><span class="op" id="1539869">[</span><span class="num" id="1539870">0</span><span class="op" id="1539871">]</span><span class="op" id="1539872">,</span>&nbsp;<span class="builtinfunc" id="1539874">len</span><span class="op" id="1539877">(</span><span class="ident" id="1539878">stk</span><span class="op" id="1539881">)</span><span class="op" id="1539882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539885">}</span>&nbsp;<span class="keyword" id="1539887">else</span>&nbsp;<span class="op" id="1539892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539896">nstk</span>&nbsp;<span class="op" id="1539901">=</span>&nbsp;<span class="ident" id="1539903">gcallers</span><span class="op" id="1539911">(</span><span class="ident" id="1539912">gp</span><span class="op" id="1539914">.</span><span class="ident" id="1539915">m</span><span class="op" id="1539916">.</span><span class="ident" id="1539917">curg</span><span class="op" id="1539921">,</span>&nbsp;<span class="ident" id="1539923">skip</span><span class="op" id="1539927">,</span>&nbsp;<span class="op" id="1539929">&amp;</span><span class="ident" id="1539930">stk</span><span class="op" id="1539933">[</span><span class="num" id="1539934">0</span><span class="op" id="1539935">]</span><span class="op" id="1539936">,</span>&nbsp;<span class="builtinfunc" id="1539938">len</span><span class="op" id="1539941">(</span><span class="ident" id="1539942">stk</span><span class="op" id="1539945">)</span><span class="op" id="1539946">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539952">lock</span><span class="op" id="1539956">(</span><span class="op" id="1539957">&amp;</span><span class="ident" id="1539958">proflock</span><span class="op" id="1539966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539969">b</span>&nbsp;<span class="op" id="1539971">:=</span>&nbsp;<span class="ident" id="1539974">stkbucket</span><span class="op" id="1539983">(</span><span class="ident" id="1539984">blockProfile</span><span class="op" id="1539996">,</span>&nbsp;<span class="num" id="1539998">0</span><span class="op" id="1539999">,</span>&nbsp;<span class="ident" id="1540001">stk</span><span class="op" id="1540004">[</span><span class="op" id="1540005">:</span><span class="ident" id="1540006">nstk</span><span class="op" id="1540010">]</span><span class="op" id="1540011">,</span>&nbsp;<span class="builtintype" id="1540013">true</span><span class="op" id="1540017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540020">b</span><span class="op" id="1540021">.</span><span class="ident" id="1540022">bp</span><span class="op" id="1540024">(</span><span class="op" id="1540025">)</span><span class="op" id="1540026">.</span><span class="ident" id="1540027">count</span><span class="op" id="1540032">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540036">b</span><span class="op" id="1540037">.</span><span class="ident" id="1540038">bp</span><span class="op" id="1540040">(</span><span class="op" id="1540041">)</span><span class="op" id="1540042">.</span><span class="ident" id="1540043">cycles</span>&nbsp;<span class="op" id="1540050">+=</span>&nbsp;<span class="ident" id="1540053">cycles</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540061">unlock</span><span class="op" id="1540067">(</span><span class="op" id="1540068">&amp;</span><span class="ident" id="1540069">proflock</span><span class="op" id="1540077">)</span><br>
<span class="lineno"></span><span class="op" id="1540079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1540082">//&nbsp;Go&nbsp;interface&nbsp;to&nbsp;profile&nbsp;data.</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="1540116">//&nbsp;A&nbsp;StackRecord&nbsp;describes&nbsp;a&nbsp;single&nbsp;execution&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1540169">type</span>&nbsp;<span class="ident" id="1540174">StackRecord</span>&nbsp;<span class="keyword" id="1540186">struct</span>&nbsp;<span class="op" id="1540193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540196">Stack0</span>&nbsp;<span class="op" id="1540203">[</span><span class="num" id="1540204">32</span><span class="op" id="1540206">]</span><span class="builtintype" id="1540207">uintptr</span>&nbsp;<span class="comment" id="1540215">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1540269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="1540272">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1540333">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno"></span><span class="keyword" id="1540358">func</span>&nbsp;<span class="op" id="1540363">(</span><span class="ident" id="1540364">r</span>&nbsp;<span class="op" id="1540366">*</span><span class="ident" id="1540367">StackRecord</span><span class="op" id="1540378">)</span>&nbsp;<span class="ident" id="1540380">Stack</span><span class="op" id="1540385">(</span><span class="op" id="1540386">)</span>&nbsp;<span class="op" id="1540388">[</span><span class="op" id="1540389">]</span><span class="builtintype" id="1540390">uintptr</span>&nbsp;<span class="op" id="1540398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1540401">for</span>&nbsp;<span class="ident" id="1540405">i</span><span class="op" id="1540406">,</span>&nbsp;<span class="ident" id="1540408">v</span>&nbsp;<span class="op" id="1540410">:=</span>&nbsp;<span class="keyword" id="1540413">range</span>&nbsp;<span class="ident" id="1540419">r</span><span class="op" id="1540420">.</span><span class="ident" id="1540421">Stack0</span>&nbsp;<span class="op" id="1540428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1540432">if</span>&nbsp;<span class="ident" id="1540435">v</span>&nbsp;<span class="op" id="1540437">==</span>&nbsp;<span class="num" id="1540440">0</span>&nbsp;<span class="op" id="1540442">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1540447">return</span>&nbsp;<span class="ident" id="1540454">r</span><span class="op" id="1540455">.</span><span class="ident" id="1540456">Stack0</span><span class="op" id="1540462">[</span><span class="num" id="1540463">0</span><span class="op" id="1540464">:</span><span class="ident" id="1540465">i</span><span class="op" id="1540466">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1540470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1540473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1540476">return</span>&nbsp;<span class="ident" id="1540483">r</span><span class="op" id="1540484">.</span><span class="ident" id="1540485">Stack0</span><span class="op" id="1540491">[</span><span class="num" id="1540492">0</span><span class="op" id="1540493">:</span><span class="op" id="1540494">]</span><br>
<span class="lineno"></span><span class="op" id="1540496">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="comment" id="1540499">//&nbsp;MemProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;memory&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="1540561">//&nbsp;that&nbsp;are&nbsp;recorded&nbsp;and&nbsp;reported&nbsp;in&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1540618">//&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample&nbsp;an&nbsp;average&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1540663">//&nbsp;one&nbsp;allocation&nbsp;per&nbsp;MemProfileRate&nbsp;bytes&nbsp;allocated.</span><br>
<span class="lineno">345</span><span class="comment" id="1540717">//</span><br>
<span class="lineno"></span><span class="comment" id="1540720">//&nbsp;To&nbsp;include&nbsp;every&nbsp;allocated&nbsp;block&nbsp;in&nbsp;the&nbsp;profile,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1540797">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1540857">//</span><br>
<span class="lineno"></span><span class="comment" id="1540860">//&nbsp;The&nbsp;tools&nbsp;that&nbsp;process&nbsp;the&nbsp;memory&nbsp;profiles&nbsp;assume&nbsp;that&nbsp;the</span><br>
<span class="lineno">350</span><span class="comment" id="1540922">//&nbsp;profile&nbsp;rate&nbsp;is&nbsp;constant&nbsp;across&nbsp;the&nbsp;lifetime&nbsp;of&nbsp;the&nbsp;program</span><br>
<span class="lineno"></span><span class="comment" id="1540985">//&nbsp;and&nbsp;equal&nbsp;to&nbsp;the&nbsp;current&nbsp;value.&nbsp;&nbsp;Programs&nbsp;that&nbsp;change&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1541046">//&nbsp;memory&nbsp;profiling&nbsp;rate&nbsp;should&nbsp;do&nbsp;so&nbsp;just&nbsp;once,&nbsp;as&nbsp;early&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1541107">//&nbsp;possible&nbsp;in&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;program&nbsp;(for&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="1541165">//&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;main).</span><br>
<span class="lineno">355</span><span class="keyword" id="1541195">var</span>&nbsp;<span class="ident" id="1541199">MemProfileRate</span>&nbsp;<span class="builtintype" id="1541214">int</span>&nbsp;<span class="op" id="1541218">=</span>&nbsp;<span class="num" id="1541220">512</span>&nbsp;<span class="op" id="1541224">*</span>&nbsp;<span class="num" id="1541226">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1541232">//&nbsp;A&nbsp;MemProfileRecord&nbsp;describes&nbsp;the&nbsp;live&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1541291">//&nbsp;by&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1541339">type</span>&nbsp;<span class="ident" id="1541344">MemProfileRecord</span>&nbsp;<span class="keyword" id="1541361">struct</span>&nbsp;<span class="op" id="1541368">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541371">AllocBytes</span><span class="op" id="1541381">,</span>&nbsp;<span class="ident" id="1541383">FreeBytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1541397">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1541409">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541446">AllocObjects</span><span class="op" id="1541458">,</span>&nbsp;<span class="ident" id="1541460">FreeObjects</span>&nbsp;<span class="builtintype" id="1541472">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1541484">//&nbsp;number&nbsp;of&nbsp;objects&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541523">Stack0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1541549">[</span><span class="num" id="1541550">32</span><span class="op" id="1541552">]</span><span class="builtintype" id="1541553">uintptr</span>&nbsp;<span class="comment" id="1541561">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1541615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="1541618">//&nbsp;InUseBytes&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;use&nbsp;(AllocBytes&nbsp;-&nbsp;FreeBytes).</span><br>
<span class="lineno"></span><span class="keyword" id="1541693">func</span>&nbsp;<span class="op" id="1541698">(</span><span class="ident" id="1541699">r</span>&nbsp;<span class="op" id="1541701">*</span><span class="ident" id="1541702">MemProfileRecord</span><span class="op" id="1541718">)</span>&nbsp;<span class="ident" id="1541720">InUseBytes</span><span class="op" id="1541730">(</span><span class="op" id="1541731">)</span>&nbsp;<span class="builtintype" id="1541733">int64</span>&nbsp;<span class="op" id="1541739">{</span>&nbsp;<span class="keyword" id="1541741">return</span>&nbsp;<span class="ident" id="1541748">r</span><span class="op" id="1541749">.</span><span class="ident" id="1541750">AllocBytes</span>&nbsp;<span class="op" id="1541761">-</span>&nbsp;<span class="ident" id="1541763">r</span><span class="op" id="1541764">.</span><span class="ident" id="1541765">FreeBytes</span>&nbsp;<span class="op" id="1541775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1541778">//&nbsp;InUseObjects&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;objects&nbsp;in&nbsp;use&nbsp;(AllocObjects&nbsp;-&nbsp;FreeObjects).</span><br>
<span class="lineno"></span><span class="keyword" id="1541861">func</span>&nbsp;<span class="op" id="1541866">(</span><span class="ident" id="1541867">r</span>&nbsp;<span class="op" id="1541869">*</span><span class="ident" id="1541870">MemProfileRecord</span><span class="op" id="1541886">)</span>&nbsp;<span class="ident" id="1541888">InUseObjects</span><span class="op" id="1541900">(</span><span class="op" id="1541901">)</span>&nbsp;<span class="builtintype" id="1541903">int64</span>&nbsp;<span class="op" id="1541909">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1541912">return</span>&nbsp;<span class="ident" id="1541919">r</span><span class="op" id="1541920">.</span><span class="ident" id="1541921">AllocObjects</span>&nbsp;<span class="op" id="1541934">-</span>&nbsp;<span class="ident" id="1541936">r</span><span class="op" id="1541937">.</span><span class="ident" id="1541938">FreeObjects</span><br>
<span class="lineno"></span><span class="op" id="1541950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1541953">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1542014">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno">375</span><span class="keyword" id="1542039">func</span>&nbsp;<span class="op" id="1542044">(</span><span class="ident" id="1542045">r</span>&nbsp;<span class="op" id="1542047">*</span><span class="ident" id="1542048">MemProfileRecord</span><span class="op" id="1542064">)</span>&nbsp;<span class="ident" id="1542066">Stack</span><span class="op" id="1542071">(</span><span class="op" id="1542072">)</span>&nbsp;<span class="op" id="1542074">[</span><span class="op" id="1542075">]</span><span class="builtintype" id="1542076">uintptr</span>&nbsp;<span class="op" id="1542084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1542087">for</span>&nbsp;<span class="ident" id="1542091">i</span><span class="op" id="1542092">,</span>&nbsp;<span class="ident" id="1542094">v</span>&nbsp;<span class="op" id="1542096">:=</span>&nbsp;<span class="keyword" id="1542099">range</span>&nbsp;<span class="ident" id="1542105">r</span><span class="op" id="1542106">.</span><span class="ident" id="1542107">Stack0</span>&nbsp;<span class="op" id="1542114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1542118">if</span>&nbsp;<span class="ident" id="1542121">v</span>&nbsp;<span class="op" id="1542123">==</span>&nbsp;<span class="num" id="1542126">0</span>&nbsp;<span class="op" id="1542128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1542133">return</span>&nbsp;<span class="ident" id="1542140">r</span><span class="op" id="1542141">.</span><span class="ident" id="1542142">Stack0</span><span class="op" id="1542148">[</span><span class="num" id="1542149">0</span><span class="op" id="1542150">:</span><span class="ident" id="1542151">i</span><span class="op" id="1542152">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1542156">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1542159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1542162">return</span>&nbsp;<span class="ident" id="1542169">r</span><span class="op" id="1542170">.</span><span class="ident" id="1542171">Stack0</span><span class="op" id="1542177">[</span><span class="num" id="1542178">0</span><span class="op" id="1542179">:</span><span class="op" id="1542180">]</span><br>
<span class="lineno"></span><span class="op" id="1542182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1542185">//&nbsp;MemProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno">385</span><span class="comment" id="1542263">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;MemProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1542340">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;MemProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1542409">//</span><br>
<span class="lineno"></span><span class="comment" id="1542412">//&nbsp;If&nbsp;inuseZero&nbsp;is&nbsp;true,&nbsp;the&nbsp;profile&nbsp;includes&nbsp;allocation&nbsp;records</span><br>
<span class="lineno"></span><span class="comment" id="1542477">//&nbsp;where&nbsp;r.AllocBytes&nbsp;&gt;&nbsp;0&nbsp;but&nbsp;r.AllocBytes&nbsp;==&nbsp;r.FreeBytes.</span><br>
<span class="lineno">390</span><span class="comment" id="1542536">//&nbsp;These&nbsp;are&nbsp;sites&nbsp;where&nbsp;memory&nbsp;was&nbsp;allocated,&nbsp;but&nbsp;it&nbsp;has&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="1542598">//&nbsp;been&nbsp;released&nbsp;back&nbsp;to&nbsp;the&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="1542636">//</span><br>
<span class="lineno"></span><span class="comment" id="1542639">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1542695">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.memprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno">395</span><span class="comment" id="1542750">//&nbsp;of&nbsp;calling&nbsp;MemProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1542785">func</span>&nbsp;<span class="ident" id="1542790">MemProfile</span><span class="op" id="1542800">(</span><span class="ident" id="1542801">p</span>&nbsp;<span class="op" id="1542803">[</span><span class="op" id="1542804">]</span><span class="ident" id="1542805">MemProfileRecord</span><span class="op" id="1542821">,</span>&nbsp;<span class="ident" id="1542823">inuseZero</span>&nbsp;<span class="builtintype" id="1542833">bool</span><span class="op" id="1542837">)</span>&nbsp;<span class="op" id="1542839">(</span><span class="ident" id="1542840">n</span>&nbsp;<span class="builtintype" id="1542842">int</span><span class="op" id="1542845">,</span>&nbsp;<span class="ident" id="1542847">ok</span>&nbsp;<span class="builtintype" id="1542850">bool</span><span class="op" id="1542854">)</span>&nbsp;<span class="op" id="1542856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1542859">lock</span><span class="op" id="1542863">(</span><span class="op" id="1542864">&amp;</span><span class="ident" id="1542865">proflock</span><span class="op" id="1542873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1542876">clear</span>&nbsp;<span class="op" id="1542882">:=</span>&nbsp;<span class="builtintype" id="1542885">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1542891">for</span>&nbsp;<span class="ident" id="1542895">b</span>&nbsp;<span class="op" id="1542897">:=</span>&nbsp;<span class="ident" id="1542900">mbuckets</span><span class="op" id="1542908">;</span>&nbsp;<span class="ident" id="1542910">b</span>&nbsp;<span class="op" id="1542912">!=</span>&nbsp;<span class="builtintype" id="1542915">nil</span><span class="op" id="1542918">;</span>&nbsp;<span class="ident" id="1542920">b</span>&nbsp;<span class="op" id="1542922">=</span>&nbsp;<span class="ident" id="1542924">b</span><span class="op" id="1542925">.</span><span class="ident" id="1542926">allnext</span>&nbsp;<span class="op" id="1542934">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1542938">mp</span>&nbsp;<span class="op" id="1542941">:=</span>&nbsp;<span class="ident" id="1542944">b</span><span class="op" id="1542945">.</span><span class="ident" id="1542946">mp</span><span class="op" id="1542948">(</span><span class="op" id="1542949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1542953">if</span>&nbsp;<span class="ident" id="1542956">inuseZero</span>&nbsp;<span class="op" id="1542966">||</span>&nbsp;<span class="ident" id="1542969">mp</span><span class="op" id="1542971">.</span><span class="ident" id="1542972">alloc_bytes</span>&nbsp;<span class="op" id="1542984">!=</span>&nbsp;<span class="ident" id="1542987">mp</span><span class="op" id="1542989">.</span><span class="ident" id="1542990">free_bytes</span>&nbsp;<span class="op" id="1543001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543006">n</span><span class="op" id="1543007">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1543016">if</span>&nbsp;<span class="ident" id="1543019">mp</span><span class="op" id="1543021">.</span><span class="ident" id="1543022">allocs</span>&nbsp;<span class="op" id="1543029">!=</span>&nbsp;<span class="num" id="1543032">0</span>&nbsp;<span class="op" id="1543034">||</span>&nbsp;<span class="ident" id="1543037">mp</span><span class="op" id="1543039">.</span><span class="ident" id="1543040">frees</span>&nbsp;<span class="op" id="1543046">!=</span>&nbsp;<span class="num" id="1543049">0</span>&nbsp;<span class="op" id="1543051">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543056">clear</span>&nbsp;<span class="op" id="1543062">=</span>&nbsp;<span class="builtintype" id="1543064">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1543078">if</span>&nbsp;<span class="ident" id="1543081">clear</span>&nbsp;<span class="op" id="1543087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1543091">//&nbsp;Absolutely&nbsp;no&nbsp;data,&nbsp;suggesting&nbsp;that&nbsp;a&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1543153">//&nbsp;has&nbsp;not&nbsp;yet&nbsp;happened.&nbsp;In&nbsp;order&nbsp;to&nbsp;allow&nbsp;profiling&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1543213">//&nbsp;garbage&nbsp;collection&nbsp;is&nbsp;disabled&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;execution,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1543282">//&nbsp;accumulate&nbsp;stats&nbsp;as&nbsp;if&nbsp;a&nbsp;GC&nbsp;just&nbsp;happened,&nbsp;and&nbsp;recount&nbsp;buckets.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543351">mprof_GC</span><span class="op" id="1543359">(</span><span class="op" id="1543360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543364">mprof_GC</span><span class="op" id="1543372">(</span><span class="op" id="1543373">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543377">n</span>&nbsp;<span class="op" id="1543379">=</span>&nbsp;<span class="num" id="1543381">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1543385">for</span>&nbsp;<span class="ident" id="1543389">b</span>&nbsp;<span class="op" id="1543391">:=</span>&nbsp;<span class="ident" id="1543394">mbuckets</span><span class="op" id="1543402">;</span>&nbsp;<span class="ident" id="1543404">b</span>&nbsp;<span class="op" id="1543406">!=</span>&nbsp;<span class="builtintype" id="1543409">nil</span><span class="op" id="1543412">;</span>&nbsp;<span class="ident" id="1543414">b</span>&nbsp;<span class="op" id="1543416">=</span>&nbsp;<span class="ident" id="1543418">b</span><span class="op" id="1543419">.</span><span class="ident" id="1543420">allnext</span>&nbsp;<span class="op" id="1543428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543433">mp</span>&nbsp;<span class="op" id="1543436">:=</span>&nbsp;<span class="ident" id="1543439">b</span><span class="op" id="1543440">.</span><span class="ident" id="1543441">mp</span><span class="op" id="1543443">(</span><span class="op" id="1543444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1543449">if</span>&nbsp;<span class="ident" id="1543452">inuseZero</span>&nbsp;<span class="op" id="1543462">||</span>&nbsp;<span class="ident" id="1543465">mp</span><span class="op" id="1543467">.</span><span class="ident" id="1543468">alloc_bytes</span>&nbsp;<span class="op" id="1543480">!=</span>&nbsp;<span class="ident" id="1543483">mp</span><span class="op" id="1543485">.</span><span class="ident" id="1543486">free_bytes</span>&nbsp;<span class="op" id="1543497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543503">n</span><span class="op" id="1543504">++</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1543520">if</span>&nbsp;<span class="ident" id="1543523">n</span>&nbsp;<span class="op" id="1543525">&lt;=</span>&nbsp;<span class="builtinfunc" id="1543528">len</span><span class="op" id="1543531">(</span><span class="ident" id="1543532">p</span><span class="op" id="1543533">)</span>&nbsp;<span class="op" id="1543535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543539">ok</span>&nbsp;<span class="op" id="1543542">=</span>&nbsp;<span class="builtintype" id="1543544">true</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543551">idx</span>&nbsp;<span class="op" id="1543555">:=</span>&nbsp;<span class="num" id="1543558">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1543562">for</span>&nbsp;<span class="ident" id="1543566">b</span>&nbsp;<span class="op" id="1543568">:=</span>&nbsp;<span class="ident" id="1543571">mbuckets</span><span class="op" id="1543579">;</span>&nbsp;<span class="ident" id="1543581">b</span>&nbsp;<span class="op" id="1543583">!=</span>&nbsp;<span class="builtintype" id="1543586">nil</span><span class="op" id="1543589">;</span>&nbsp;<span class="ident" id="1543591">b</span>&nbsp;<span class="op" id="1543593">=</span>&nbsp;<span class="ident" id="1543595">b</span><span class="op" id="1543596">.</span><span class="ident" id="1543597">allnext</span>&nbsp;<span class="op" id="1543605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543610">mp</span>&nbsp;<span class="op" id="1543613">:=</span>&nbsp;<span class="ident" id="1543616">b</span><span class="op" id="1543617">.</span><span class="ident" id="1543618">mp</span><span class="op" id="1543620">(</span><span class="op" id="1543621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1543626">if</span>&nbsp;<span class="ident" id="1543629">inuseZero</span>&nbsp;<span class="op" id="1543639">||</span>&nbsp;<span class="ident" id="1543642">mp</span><span class="op" id="1543644">.</span><span class="ident" id="1543645">alloc_bytes</span>&nbsp;<span class="op" id="1543657">!=</span>&nbsp;<span class="ident" id="1543660">mp</span><span class="op" id="1543662">.</span><span class="ident" id="1543663">free_bytes</span>&nbsp;<span class="op" id="1543674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543680">record</span><span class="op" id="1543686">(</span><span class="op" id="1543687">&amp;</span><span class="ident" id="1543688">p</span><span class="op" id="1543689">[</span><span class="ident" id="1543690">idx</span><span class="op" id="1543693">]</span><span class="op" id="1543694">,</span>&nbsp;<span class="ident" id="1543696">b</span><span class="op" id="1543697">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543703">idx</span><span class="op" id="1543706">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543722">unlock</span><span class="op" id="1543728">(</span><span class="op" id="1543729">&amp;</span><span class="ident" id="1543730">proflock</span><span class="op" id="1543738">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1543741">return</span><br>
<span class="lineno"></span><span class="op" id="1543748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1543751">//&nbsp;Write&nbsp;b&#39;s&nbsp;data&nbsp;to&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="1543775">func</span>&nbsp;<span class="ident" id="1543780">record</span><span class="op" id="1543786">(</span><span class="ident" id="1543787">r</span>&nbsp;<span class="op" id="1543789">*</span><span class="ident" id="1543790">MemProfileRecord</span><span class="op" id="1543806">,</span>&nbsp;<span class="ident" id="1543808">b</span>&nbsp;<span class="op" id="1543810">*</span><span class="ident" id="1543811">bucket</span><span class="op" id="1543817">)</span>&nbsp;<span class="op" id="1543819">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543822">mp</span>&nbsp;<span class="op" id="1543825">:=</span>&nbsp;<span class="ident" id="1543828">b</span><span class="op" id="1543829">.</span><span class="ident" id="1543830">mp</span><span class="op" id="1543832">(</span><span class="op" id="1543833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543836">r</span><span class="op" id="1543837">.</span><span class="ident" id="1543838">AllocBytes</span>&nbsp;<span class="op" id="1543849">=</span>&nbsp;<span class="builtintype" id="1543851">int64</span><span class="op" id="1543856">(</span><span class="ident" id="1543857">mp</span><span class="op" id="1543859">.</span><span class="ident" id="1543860">alloc_bytes</span><span class="op" id="1543871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543874">r</span><span class="op" id="1543875">.</span><span class="ident" id="1543876">FreeBytes</span>&nbsp;<span class="op" id="1543886">=</span>&nbsp;<span class="builtintype" id="1543888">int64</span><span class="op" id="1543893">(</span><span class="ident" id="1543894">mp</span><span class="op" id="1543896">.</span><span class="ident" id="1543897">free_bytes</span><span class="op" id="1543907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543910">r</span><span class="op" id="1543911">.</span><span class="ident" id="1543912">AllocObjects</span>&nbsp;<span class="op" id="1543925">=</span>&nbsp;<span class="builtintype" id="1543927">int64</span><span class="op" id="1543932">(</span><span class="ident" id="1543933">mp</span><span class="op" id="1543935">.</span><span class="ident" id="1543936">allocs</span><span class="op" id="1543942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543945">r</span><span class="op" id="1543946">.</span><span class="ident" id="1543947">FreeObjects</span>&nbsp;<span class="op" id="1543959">=</span>&nbsp;<span class="builtintype" id="1543961">int64</span><span class="op" id="1543966">(</span><span class="ident" id="1543967">mp</span><span class="op" id="1543969">.</span><span class="ident" id="1543970">frees</span><span class="op" id="1543975">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1543978">copy</span><span class="op" id="1543982">(</span><span class="ident" id="1543983">r</span><span class="op" id="1543984">.</span><span class="ident" id="1543985">Stack0</span><span class="op" id="1543991">[</span><span class="op" id="1543992">:</span><span class="op" id="1543993">]</span><span class="op" id="1543994">,</span>&nbsp;<span class="ident" id="1543996">b</span><span class="op" id="1543997">.</span><span class="ident" id="1543998">stk</span><span class="op" id="1544001">(</span><span class="op" id="1544002">)</span><span class="op" id="1544003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544006">for</span>&nbsp;<span class="ident" id="1544010">i</span>&nbsp;<span class="op" id="1544012">:=</span>&nbsp;<span class="builtintype" id="1544015">int</span><span class="op" id="1544018">(</span><span class="ident" id="1544019">b</span><span class="op" id="1544020">.</span><span class="ident" id="1544021">nstk</span><span class="op" id="1544025">)</span><span class="op" id="1544026">;</span>&nbsp;<span class="ident" id="1544028">i</span>&nbsp;<span class="op" id="1544030">&lt;</span>&nbsp;<span class="builtinfunc" id="1544032">len</span><span class="op" id="1544035">(</span><span class="ident" id="1544036">r</span><span class="op" id="1544037">.</span><span class="ident" id="1544038">Stack0</span><span class="op" id="1544044">)</span><span class="op" id="1544045">;</span>&nbsp;<span class="ident" id="1544047">i</span><span class="op" id="1544048">++</span>&nbsp;<span class="op" id="1544051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544055">r</span><span class="op" id="1544056">.</span><span class="ident" id="1544057">Stack0</span><span class="op" id="1544063">[</span><span class="ident" id="1544064">i</span><span class="op" id="1544065">]</span>&nbsp;<span class="op" id="1544067">=</span>&nbsp;<span class="num" id="1544069">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544072">}</span><br>
<span class="lineno"></span><span class="op" id="1544074">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="1544077">func</span>&nbsp;<span class="ident" id="1544082">iterate_memprof</span><span class="op" id="1544097">(</span><span class="ident" id="1544098">fn</span>&nbsp;<span class="keyword" id="1544101">func</span><span class="op" id="1544105">(</span><span class="op" id="1544106">*</span><span class="ident" id="1544107">bucket</span><span class="op" id="1544113">,</span>&nbsp;<span class="builtintype" id="1544115">uintptr</span><span class="op" id="1544122">,</span>&nbsp;<span class="op" id="1544124">*</span><span class="builtintype" id="1544125">uintptr</span><span class="op" id="1544132">,</span>&nbsp;<span class="builtintype" id="1544134">uintptr</span><span class="op" id="1544141">,</span>&nbsp;<span class="builtintype" id="1544143">uintptr</span><span class="op" id="1544150">,</span>&nbsp;<span class="builtintype" id="1544152">uintptr</span><span class="op" id="1544159">)</span><span class="op" id="1544160">)</span>&nbsp;<span class="op" id="1544162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544165">lock</span><span class="op" id="1544169">(</span><span class="op" id="1544170">&amp;</span><span class="ident" id="1544171">proflock</span><span class="op" id="1544179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544182">for</span>&nbsp;<span class="ident" id="1544186">b</span>&nbsp;<span class="op" id="1544188">:=</span>&nbsp;<span class="ident" id="1544191">mbuckets</span><span class="op" id="1544199">;</span>&nbsp;<span class="ident" id="1544201">b</span>&nbsp;<span class="op" id="1544203">!=</span>&nbsp;<span class="builtintype" id="1544206">nil</span><span class="op" id="1544209">;</span>&nbsp;<span class="ident" id="1544211">b</span>&nbsp;<span class="op" id="1544213">=</span>&nbsp;<span class="ident" id="1544215">b</span><span class="op" id="1544216">.</span><span class="ident" id="1544217">allnext</span>&nbsp;<span class="op" id="1544225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544229">mp</span>&nbsp;<span class="op" id="1544232">:=</span>&nbsp;<span class="ident" id="1544235">b</span><span class="op" id="1544236">.</span><span class="ident" id="1544237">mp</span><span class="op" id="1544239">(</span><span class="op" id="1544240">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544244">fn</span><span class="op" id="1544246">(</span><span class="ident" id="1544247">b</span><span class="op" id="1544248">,</span>&nbsp;<span class="builtintype" id="1544250">uintptr</span><span class="op" id="1544257">(</span><span class="ident" id="1544258">b</span><span class="op" id="1544259">.</span><span class="ident" id="1544260">nstk</span><span class="op" id="1544264">)</span><span class="op" id="1544265">,</span>&nbsp;<span class="op" id="1544267">&amp;</span><span class="ident" id="1544268">b</span><span class="op" id="1544269">.</span><span class="ident" id="1544270">stk</span><span class="op" id="1544273">(</span><span class="op" id="1544274">)</span><span class="op" id="1544275">[</span><span class="num" id="1544276">0</span><span class="op" id="1544277">]</span><span class="op" id="1544278">,</span>&nbsp;<span class="ident" id="1544280">b</span><span class="op" id="1544281">.</span><span class="ident" id="1544282">size</span><span class="op" id="1544286">,</span>&nbsp;<span class="ident" id="1544288">mp</span><span class="op" id="1544290">.</span><span class="ident" id="1544291">allocs</span><span class="op" id="1544297">,</span>&nbsp;<span class="ident" id="1544299">mp</span><span class="op" id="1544301">.</span><span class="ident" id="1544302">frees</span><span class="op" id="1544307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544313">unlock</span><span class="op" id="1544319">(</span><span class="op" id="1544320">&amp;</span><span class="ident" id="1544321">proflock</span><span class="op" id="1544329">)</span><br>
<span class="lineno"></span><span class="op" id="1544331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="1544334">//&nbsp;BlockProfileRecord&nbsp;describes&nbsp;blocking&nbsp;events&nbsp;originated</span><br>
<span class="lineno"></span><span class="comment" id="1544393">//&nbsp;at&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1544441">type</span>&nbsp;<span class="ident" id="1544446">BlockProfileRecord</span>&nbsp;<span class="keyword" id="1544465">struct</span>&nbsp;<span class="op" id="1544472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544475">Count</span>&nbsp;&nbsp;<span class="builtintype" id="1544482">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544489">Cycles</span>&nbsp;<span class="builtintype" id="1544496">int64</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544503">StackRecord</span><br>
<span class="lineno"></span><span class="op" id="1544515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1544518">//&nbsp;BlockProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1544600">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;BlockProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">470</span><span class="comment" id="1544679">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;BlockProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1544750">//</span><br>
<span class="lineno"></span><span class="comment" id="1544753">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1544809">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.blockprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1544866">//&nbsp;of&nbsp;calling&nbsp;BlockProfile&nbsp;directly.</span><br>
<span class="lineno">475</span><span class="keyword" id="1544903">func</span>&nbsp;<span class="ident" id="1544908">BlockProfile</span><span class="op" id="1544920">(</span><span class="ident" id="1544921">p</span>&nbsp;<span class="op" id="1544923">[</span><span class="op" id="1544924">]</span><span class="ident" id="1544925">BlockProfileRecord</span><span class="op" id="1544943">)</span>&nbsp;<span class="op" id="1544945">(</span><span class="ident" id="1544946">n</span>&nbsp;<span class="builtintype" id="1544948">int</span><span class="op" id="1544951">,</span>&nbsp;<span class="ident" id="1544953">ok</span>&nbsp;<span class="builtintype" id="1544956">bool</span><span class="op" id="1544960">)</span>&nbsp;<span class="op" id="1544962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544965">lock</span><span class="op" id="1544969">(</span><span class="op" id="1544970">&amp;</span><span class="ident" id="1544971">proflock</span><span class="op" id="1544979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544982">for</span>&nbsp;<span class="ident" id="1544986">b</span>&nbsp;<span class="op" id="1544988">:=</span>&nbsp;<span class="ident" id="1544991">bbuckets</span><span class="op" id="1544999">;</span>&nbsp;<span class="ident" id="1545001">b</span>&nbsp;<span class="op" id="1545003">!=</span>&nbsp;<span class="builtintype" id="1545006">nil</span><span class="op" id="1545009">;</span>&nbsp;<span class="ident" id="1545011">b</span>&nbsp;<span class="op" id="1545013">=</span>&nbsp;<span class="ident" id="1545015">b</span><span class="op" id="1545016">.</span><span class="ident" id="1545017">allnext</span>&nbsp;<span class="op" id="1545025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545029">n</span><span class="op" id="1545030">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545034">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545037">if</span>&nbsp;<span class="ident" id="1545040">n</span>&nbsp;<span class="op" id="1545042">&lt;=</span>&nbsp;<span class="builtinfunc" id="1545045">len</span><span class="op" id="1545048">(</span><span class="ident" id="1545049">p</span><span class="op" id="1545050">)</span>&nbsp;<span class="op" id="1545052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545056">ok</span>&nbsp;<span class="op" id="1545059">=</span>&nbsp;<span class="builtintype" id="1545061">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545068">for</span>&nbsp;<span class="ident" id="1545072">b</span>&nbsp;<span class="op" id="1545074">:=</span>&nbsp;<span class="ident" id="1545077">bbuckets</span><span class="op" id="1545085">;</span>&nbsp;<span class="ident" id="1545087">b</span>&nbsp;<span class="op" id="1545089">!=</span>&nbsp;<span class="builtintype" id="1545092">nil</span><span class="op" id="1545095">;</span>&nbsp;<span class="ident" id="1545097">b</span>&nbsp;<span class="op" id="1545099">=</span>&nbsp;<span class="ident" id="1545101">b</span><span class="op" id="1545102">.</span><span class="ident" id="1545103">allnext</span>&nbsp;<span class="op" id="1545111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545116">bp</span>&nbsp;<span class="op" id="1545119">:=</span>&nbsp;<span class="ident" id="1545122">b</span><span class="op" id="1545123">.</span><span class="ident" id="1545124">bp</span><span class="op" id="1545126">(</span><span class="op" id="1545127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545132">r</span>&nbsp;<span class="op" id="1545134">:=</span>&nbsp;<span class="op" id="1545137">&amp;</span><span class="ident" id="1545138">p</span><span class="op" id="1545139">[</span><span class="num" id="1545140">0</span><span class="op" id="1545141">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545146">r</span><span class="op" id="1545147">.</span><span class="ident" id="1545148">Count</span>&nbsp;<span class="op" id="1545154">=</span>&nbsp;<span class="builtintype" id="1545156">int64</span><span class="op" id="1545161">(</span><span class="ident" id="1545162">bp</span><span class="op" id="1545164">.</span><span class="ident" id="1545165">count</span><span class="op" id="1545170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545175">r</span><span class="op" id="1545176">.</span><span class="ident" id="1545177">Cycles</span>&nbsp;<span class="op" id="1545184">=</span>&nbsp;<span class="builtintype" id="1545186">int64</span><span class="op" id="1545191">(</span><span class="ident" id="1545192">bp</span><span class="op" id="1545194">.</span><span class="ident" id="1545195">cycles</span><span class="op" id="1545201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545206">i</span>&nbsp;<span class="op" id="1545208">:=</span>&nbsp;<span class="builtinfunc" id="1545211">copy</span><span class="op" id="1545215">(</span><span class="ident" id="1545216">r</span><span class="op" id="1545217">.</span><span class="ident" id="1545218">Stack0</span><span class="op" id="1545224">[</span><span class="op" id="1545225">:</span><span class="op" id="1545226">]</span><span class="op" id="1545227">,</span>&nbsp;<span class="ident" id="1545229">b</span><span class="op" id="1545230">.</span><span class="ident" id="1545231">stk</span><span class="op" id="1545234">(</span><span class="op" id="1545235">)</span><span class="op" id="1545236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545241">for</span>&nbsp;<span class="op" id="1545245">;</span>&nbsp;<span class="ident" id="1545247">i</span>&nbsp;<span class="op" id="1545249">&lt;</span>&nbsp;<span class="builtinfunc" id="1545251">len</span><span class="op" id="1545254">(</span><span class="ident" id="1545255">r</span><span class="op" id="1545256">.</span><span class="ident" id="1545257">Stack0</span><span class="op" id="1545263">)</span><span class="op" id="1545264">;</span>&nbsp;<span class="ident" id="1545266">i</span><span class="op" id="1545267">++</span>&nbsp;<span class="op" id="1545270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545276">r</span><span class="op" id="1545277">.</span><span class="ident" id="1545278">Stack0</span><span class="op" id="1545284">[</span><span class="ident" id="1545285">i</span><span class="op" id="1545286">]</span>&nbsp;<span class="op" id="1545288">=</span>&nbsp;<span class="num" id="1545290">0</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545300">p</span>&nbsp;<span class="op" id="1545302">=</span>&nbsp;<span class="ident" id="1545304">p</span><span class="op" id="1545305">[</span><span class="num" id="1545306">1</span><span class="op" id="1545307">:</span><span class="op" id="1545308">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545318">unlock</span><span class="op" id="1545324">(</span><span class="op" id="1545325">&amp;</span><span class="ident" id="1545326">proflock</span><span class="op" id="1545334">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545337">return</span><br>
<span class="lineno"></span><span class="op" id="1545344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1545347">//&nbsp;ThreadCreateProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;thread&nbsp;creation&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1545435">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">500</span><span class="comment" id="1545521">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1545599">//</span><br>
<span class="lineno"></span><span class="comment" id="1545602">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1545663">//&nbsp;of&nbsp;calling&nbsp;ThreadCreateProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1545707">func</span>&nbsp;<span class="ident" id="1545712">ThreadCreateProfile</span><span class="op" id="1545731">(</span><span class="ident" id="1545732">p</span>&nbsp;<span class="op" id="1545734">[</span><span class="op" id="1545735">]</span><span class="ident" id="1545736">StackRecord</span><span class="op" id="1545747">)</span>&nbsp;<span class="op" id="1545749">(</span><span class="ident" id="1545750">n</span>&nbsp;<span class="builtintype" id="1545752">int</span><span class="op" id="1545755">,</span>&nbsp;<span class="ident" id="1545757">ok</span>&nbsp;<span class="builtintype" id="1545760">bool</span><span class="op" id="1545764">)</span>&nbsp;<span class="op" id="1545766">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545769">first</span>&nbsp;<span class="op" id="1545775">:=</span>&nbsp;<span class="op" id="1545778">(</span><span class="op" id="1545779">*</span><span class="ident" id="1545780">m</span><span class="op" id="1545781">)</span><span class="op" id="1545782">(</span><span class="ident" id="1545783">atomicloadp</span><span class="op" id="1545794">(</span><span class="ident" id="1545795">unsafe</span><span class="op" id="1545801">.</span><span class="ident" id="1545802">Pointer</span><span class="op" id="1545809">(</span><span class="op" id="1545810">&amp;</span><span class="ident" id="1545811">allm</span><span class="op" id="1545815">)</span><span class="op" id="1545816">)</span><span class="op" id="1545817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545820">for</span>&nbsp;<span class="ident" id="1545824">mp</span>&nbsp;<span class="op" id="1545827">:=</span>&nbsp;<span class="ident" id="1545830">first</span><span class="op" id="1545835">;</span>&nbsp;<span class="ident" id="1545837">mp</span>&nbsp;<span class="op" id="1545840">!=</span>&nbsp;<span class="builtintype" id="1545843">nil</span><span class="op" id="1545846">;</span>&nbsp;<span class="ident" id="1545848">mp</span>&nbsp;<span class="op" id="1545851">=</span>&nbsp;<span class="ident" id="1545853">mp</span><span class="op" id="1545855">.</span><span class="ident" id="1545856">alllink</span>&nbsp;<span class="op" id="1545864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545868">n</span><span class="op" id="1545869">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545876">if</span>&nbsp;<span class="ident" id="1545879">n</span>&nbsp;<span class="op" id="1545881">&lt;=</span>&nbsp;<span class="builtinfunc" id="1545884">len</span><span class="op" id="1545887">(</span><span class="ident" id="1545888">p</span><span class="op" id="1545889">)</span>&nbsp;<span class="op" id="1545891">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545895">ok</span>&nbsp;<span class="op" id="1545898">=</span>&nbsp;<span class="builtintype" id="1545900">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545907">i</span>&nbsp;<span class="op" id="1545909">:=</span>&nbsp;<span class="num" id="1545912">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545916">for</span>&nbsp;<span class="ident" id="1545920">mp</span>&nbsp;<span class="op" id="1545923">:=</span>&nbsp;<span class="ident" id="1545926">first</span><span class="op" id="1545931">;</span>&nbsp;<span class="ident" id="1545933">mp</span>&nbsp;<span class="op" id="1545936">!=</span>&nbsp;<span class="builtintype" id="1545939">nil</span><span class="op" id="1545942">;</span>&nbsp;<span class="ident" id="1545944">mp</span>&nbsp;<span class="op" id="1545947">=</span>&nbsp;<span class="ident" id="1545949">mp</span><span class="op" id="1545951">.</span><span class="ident" id="1545952">alllink</span>&nbsp;<span class="op" id="1545960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545965">for</span>&nbsp;<span class="ident" id="1545969">s</span>&nbsp;<span class="op" id="1545971">:=</span>&nbsp;<span class="keyword" id="1545974">range</span>&nbsp;<span class="ident" id="1545980">mp</span><span class="op" id="1545982">.</span><span class="ident" id="1545983">createstack</span>&nbsp;<span class="op" id="1545995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546001">p</span><span class="op" id="1546002">[</span><span class="ident" id="1546003">i</span><span class="op" id="1546004">]</span><span class="op" id="1546005">.</span><span class="ident" id="1546006">Stack0</span><span class="op" id="1546012">[</span><span class="ident" id="1546013">s</span><span class="op" id="1546014">]</span>&nbsp;<span class="op" id="1546016">=</span>&nbsp;<span class="builtintype" id="1546018">uintptr</span><span class="op" id="1546025">(</span><span class="ident" id="1546026">mp</span><span class="op" id="1546028">.</span><span class="ident" id="1546029">createstack</span><span class="op" id="1546040">[</span><span class="ident" id="1546041">s</span><span class="op" id="1546042">]</span><span class="op" id="1546043">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546053">i</span><span class="op" id="1546054">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546065">return</span><br>
<span class="lineno">520</span><span class="op" id="1546072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1546075">var</span>&nbsp;<span class="ident" id="1546079">allgs</span>&nbsp;<span class="op" id="1546085">[</span><span class="op" id="1546086">]</span><span class="op" id="1546087">*</span><span class="ident" id="1546088">g</span>&nbsp;<span class="comment" id="1546090">//&nbsp;proc.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1546101">//&nbsp;GoroutineProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;active&nbsp;goroutine&nbsp;stack&nbsp;profile.</span><br>
<span class="lineno">525</span><span class="comment" id="1546193">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;GoroutineProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1546276">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;GoroutineProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1546351">//</span><br>
<span class="lineno"></span><span class="comment" id="1546354">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1546415">//&nbsp;of&nbsp;calling&nbsp;GoroutineProfile&nbsp;directly.</span><br>
<span class="lineno">530</span><span class="keyword" id="1546456">func</span>&nbsp;<span class="ident" id="1546461">GoroutineProfile</span><span class="op" id="1546477">(</span><span class="ident" id="1546478">p</span>&nbsp;<span class="op" id="1546480">[</span><span class="op" id="1546481">]</span><span class="ident" id="1546482">StackRecord</span><span class="op" id="1546493">)</span>&nbsp;<span class="op" id="1546495">(</span><span class="ident" id="1546496">n</span>&nbsp;<span class="builtintype" id="1546498">int</span><span class="op" id="1546501">,</span>&nbsp;<span class="ident" id="1546503">ok</span>&nbsp;<span class="builtintype" id="1546506">bool</span><span class="op" id="1546510">)</span>&nbsp;<span class="op" id="1546512">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546516">n</span>&nbsp;<span class="op" id="1546518">=</span>&nbsp;<span class="ident" id="1546520">NumGoroutine</span><span class="op" id="1546532">(</span><span class="op" id="1546533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546536">if</span>&nbsp;<span class="ident" id="1546539">n</span>&nbsp;<span class="op" id="1546541">&lt;=</span>&nbsp;<span class="builtinfunc" id="1546544">len</span><span class="op" id="1546547">(</span><span class="ident" id="1546548">p</span><span class="op" id="1546549">)</span>&nbsp;<span class="op" id="1546551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546555">gp</span>&nbsp;<span class="op" id="1546558">:=</span>&nbsp;<span class="ident" id="1546561">getg</span><span class="op" id="1546565">(</span><span class="op" id="1546566">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546570">semacquire</span><span class="op" id="1546580">(</span><span class="op" id="1546581">&amp;</span><span class="ident" id="1546582">worldsema</span><span class="op" id="1546591">,</span>&nbsp;<span class="builtintype" id="1546593">false</span><span class="op" id="1546598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546602">gp</span><span class="op" id="1546604">.</span><span class="ident" id="1546605">m</span><span class="op" id="1546606">.</span><span class="ident" id="1546607">gcing</span>&nbsp;<span class="op" id="1546613">=</span>&nbsp;<span class="num" id="1546615">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546619">onM</span><span class="op" id="1546622">(</span><span class="ident" id="1546623">stoptheworld</span><span class="op" id="1546635">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546640">n</span>&nbsp;<span class="op" id="1546642">=</span>&nbsp;<span class="ident" id="1546644">NumGoroutine</span><span class="op" id="1546656">(</span><span class="op" id="1546657">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546661">if</span>&nbsp;<span class="ident" id="1546664">n</span>&nbsp;<span class="op" id="1546666">&lt;=</span>&nbsp;<span class="builtinfunc" id="1546669">len</span><span class="op" id="1546672">(</span><span class="ident" id="1546673">p</span><span class="op" id="1546674">)</span>&nbsp;<span class="op" id="1546676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546681">ok</span>&nbsp;<span class="op" id="1546684">=</span>&nbsp;<span class="builtintype" id="1546686">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546694">r</span>&nbsp;<span class="op" id="1546696">:=</span>&nbsp;<span class="ident" id="1546699">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546704">sp</span>&nbsp;<span class="op" id="1546707">:=</span>&nbsp;<span class="ident" id="1546710">getcallersp</span><span class="op" id="1546721">(</span><span class="ident" id="1546722">unsafe</span><span class="op" id="1546728">.</span><span class="ident" id="1546729">Pointer</span><span class="op" id="1546736">(</span><span class="op" id="1546737">&amp;</span><span class="ident" id="1546738">p</span><span class="op" id="1546739">)</span><span class="op" id="1546740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546745">pc</span>&nbsp;<span class="op" id="1546748">:=</span>&nbsp;<span class="ident" id="1546751">getcallerpc</span><span class="op" id="1546762">(</span><span class="ident" id="1546763">unsafe</span><span class="op" id="1546769">.</span><span class="ident" id="1546770">Pointer</span><span class="op" id="1546777">(</span><span class="op" id="1546778">&amp;</span><span class="ident" id="1546779">p</span><span class="op" id="1546780">)</span><span class="op" id="1546781">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546786">onM</span><span class="op" id="1546789">(</span><span class="keyword" id="1546790">func</span><span class="op" id="1546794">(</span><span class="op" id="1546795">)</span>&nbsp;<span class="op" id="1546797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546803">saveg</span><span class="op" id="1546808">(</span><span class="ident" id="1546809">pc</span><span class="op" id="1546811">,</span>&nbsp;<span class="ident" id="1546813">sp</span><span class="op" id="1546815">,</span>&nbsp;<span class="ident" id="1546817">gp</span><span class="op" id="1546819">,</span>&nbsp;<span class="op" id="1546821">&amp;</span><span class="ident" id="1546822">r</span><span class="op" id="1546823">[</span><span class="num" id="1546824">0</span><span class="op" id="1546825">]</span><span class="op" id="1546826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546831">}</span><span class="op" id="1546832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546837">r</span>&nbsp;<span class="op" id="1546839">=</span>&nbsp;<span class="ident" id="1546841">r</span><span class="op" id="1546842">[</span><span class="num" id="1546843">1</span><span class="op" id="1546844">:</span><span class="op" id="1546845">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546850">for</span>&nbsp;<span class="ident" id="1546854">_</span><span class="op" id="1546855">,</span>&nbsp;<span class="ident" id="1546857">gp1</span>&nbsp;<span class="op" id="1546861">:=</span>&nbsp;<span class="keyword" id="1546864">range</span>&nbsp;<span class="ident" id="1546870">allgs</span>&nbsp;<span class="op" id="1546876">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546882">if</span>&nbsp;<span class="ident" id="1546885">gp1</span>&nbsp;<span class="op" id="1546889">==</span>&nbsp;<span class="ident" id="1546892">gp</span>&nbsp;<span class="op" id="1546895">||</span>&nbsp;<span class="ident" id="1546898">readgstatus</span><span class="op" id="1546909">(</span><span class="ident" id="1546910">gp1</span><span class="op" id="1546913">)</span>&nbsp;<span class="op" id="1546915">==</span>&nbsp;<span class="ident" id="1546918">_Gdead</span>&nbsp;<span class="op" id="1546925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546932">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546951">saveg</span><span class="op" id="1546956">(</span><span class="op" id="1546957">^</span><span class="builtintype" id="1546958">uintptr</span><span class="op" id="1546965">(</span><span class="num" id="1546966">0</span><span class="op" id="1546967">)</span><span class="op" id="1546968">,</span>&nbsp;<span class="op" id="1546970">^</span><span class="builtintype" id="1546971">uintptr</span><span class="op" id="1546978">(</span><span class="num" id="1546979">0</span><span class="op" id="1546980">)</span><span class="op" id="1546981">,</span>&nbsp;<span class="ident" id="1546983">gp1</span><span class="op" id="1546986">,</span>&nbsp;<span class="op" id="1546988">&amp;</span><span class="ident" id="1546989">r</span><span class="op" id="1546990">[</span><span class="num" id="1546991">0</span><span class="op" id="1546992">]</span><span class="op" id="1546993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546999">r</span>&nbsp;<span class="op" id="1547001">=</span>&nbsp;<span class="ident" id="1547003">r</span><span class="op" id="1547004">[</span><span class="num" id="1547005">1</span><span class="op" id="1547006">:</span><span class="op" id="1547007">]</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547021">gp</span><span class="op" id="1547023">.</span><span class="ident" id="1547024">m</span><span class="op" id="1547025">.</span><span class="ident" id="1547026">gcing</span>&nbsp;<span class="op" id="1547032">=</span>&nbsp;<span class="num" id="1547034">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547038">semrelease</span><span class="op" id="1547048">(</span><span class="op" id="1547049">&amp;</span><span class="ident" id="1547050">worldsema</span><span class="op" id="1547059">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547063">onM</span><span class="op" id="1547066">(</span><span class="ident" id="1547067">starttheworld</span><span class="op" id="1547080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547087">return</span>&nbsp;<span class="ident" id="1547094">n</span><span class="op" id="1547095">,</span>&nbsp;<span class="ident" id="1547097">ok</span><br>
<span class="lineno"></span><span class="op" id="1547100">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="1547103">func</span>&nbsp;<span class="ident" id="1547108">saveg</span><span class="op" id="1547113">(</span><span class="ident" id="1547114">pc</span><span class="op" id="1547116">,</span>&nbsp;<span class="ident" id="1547118">sp</span>&nbsp;<span class="builtintype" id="1547121">uintptr</span><span class="op" id="1547128">,</span>&nbsp;<span class="ident" id="1547130">gp</span>&nbsp;<span class="op" id="1547133">*</span><span class="ident" id="1547134">g</span><span class="op" id="1547135">,</span>&nbsp;<span class="ident" id="1547137">r</span>&nbsp;<span class="op" id="1547139">*</span><span class="ident" id="1547140">StackRecord</span><span class="op" id="1547151">)</span>&nbsp;<span class="op" id="1547153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547156">n</span>&nbsp;<span class="op" id="1547158">:=</span>&nbsp;<span class="ident" id="1547161">gentraceback</span><span class="op" id="1547173">(</span><span class="ident" id="1547174">pc</span><span class="op" id="1547176">,</span>&nbsp;<span class="ident" id="1547178">sp</span><span class="op" id="1547180">,</span>&nbsp;<span class="num" id="1547182">0</span><span class="op" id="1547183">,</span>&nbsp;<span class="ident" id="1547185">gp</span><span class="op" id="1547187">,</span>&nbsp;<span class="num" id="1547189">0</span><span class="op" id="1547190">,</span>&nbsp;<span class="op" id="1547192">&amp;</span><span class="ident" id="1547193">r</span><span class="op" id="1547194">.</span><span class="ident" id="1547195">Stack0</span><span class="op" id="1547201">[</span><span class="num" id="1547202">0</span><span class="op" id="1547203">]</span><span class="op" id="1547204">,</span>&nbsp;<span class="builtinfunc" id="1547206">len</span><span class="op" id="1547209">(</span><span class="ident" id="1547210">r</span><span class="op" id="1547211">.</span><span class="ident" id="1547212">Stack0</span><span class="op" id="1547218">)</span><span class="op" id="1547219">,</span>&nbsp;<span class="builtintype" id="1547221">nil</span><span class="op" id="1547224">,</span>&nbsp;<span class="builtintype" id="1547226">nil</span><span class="op" id="1547229">,</span>&nbsp;<span class="num" id="1547231">0</span><span class="op" id="1547232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547235">if</span>&nbsp;<span class="ident" id="1547238">n</span>&nbsp;<span class="op" id="1547240">&lt;</span>&nbsp;<span class="builtinfunc" id="1547242">len</span><span class="op" id="1547245">(</span><span class="ident" id="1547246">r</span><span class="op" id="1547247">.</span><span class="ident" id="1547248">Stack0</span><span class="op" id="1547254">)</span>&nbsp;<span class="op" id="1547256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547260">r</span><span class="op" id="1547261">.</span><span class="ident" id="1547262">Stack0</span><span class="op" id="1547268">[</span><span class="ident" id="1547269">n</span><span class="op" id="1547270">]</span>&nbsp;<span class="op" id="1547272">=</span>&nbsp;<span class="num" id="1547274">0</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547277">}</span><br>
<span class="lineno"></span><span class="op" id="1547279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1547282">//&nbsp;Stack&nbsp;formats&nbsp;a&nbsp;stack&nbsp;trace&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine&nbsp;into&nbsp;buf</span><br>
<span class="lineno"></span><span class="comment" id="1547347">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;to&nbsp;buf.</span><br>
<span class="lineno">575</span><span class="comment" id="1547398">//&nbsp;If&nbsp;all&nbsp;is&nbsp;true,&nbsp;Stack&nbsp;formats&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;other&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="1547468">//&nbsp;into&nbsp;buf&nbsp;after&nbsp;the&nbsp;trace&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1547523">func</span>&nbsp;<span class="ident" id="1547528">Stack</span><span class="op" id="1547533">(</span><span class="ident" id="1547534">buf</span>&nbsp;<span class="op" id="1547538">[</span><span class="op" id="1547539">]</span><span class="builtintype" id="1547540">byte</span><span class="op" id="1547544">,</span>&nbsp;<span class="ident" id="1547546">all</span>&nbsp;<span class="builtintype" id="1547550">bool</span><span class="op" id="1547554">)</span>&nbsp;<span class="builtintype" id="1547556">int</span>&nbsp;<span class="op" id="1547560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547563">mp</span>&nbsp;<span class="op" id="1547566">:=</span>&nbsp;<span class="ident" id="1547569">acquirem</span><span class="op" id="1547577">(</span><span class="op" id="1547578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547581">gp</span>&nbsp;<span class="op" id="1547584">:=</span>&nbsp;<span class="ident" id="1547587">mp</span><span class="op" id="1547589">.</span><span class="ident" id="1547590">curg</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547596">if</span>&nbsp;<span class="ident" id="1547599">all</span>&nbsp;<span class="op" id="1547603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547607">semacquire</span><span class="op" id="1547617">(</span><span class="op" id="1547618">&amp;</span><span class="ident" id="1547619">worldsema</span><span class="op" id="1547628">,</span>&nbsp;<span class="builtintype" id="1547630">false</span><span class="op" id="1547635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547639">mp</span><span class="op" id="1547641">.</span><span class="ident" id="1547642">gcing</span>&nbsp;<span class="op" id="1547648">=</span>&nbsp;<span class="num" id="1547650">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547654">releasem</span><span class="op" id="1547662">(</span><span class="ident" id="1547663">mp</span><span class="op" id="1547665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547669">onM</span><span class="op" id="1547672">(</span><span class="ident" id="1547673">stoptheworld</span><span class="op" id="1547685">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547689">if</span>&nbsp;<span class="ident" id="1547692">mp</span>&nbsp;<span class="op" id="1547695">!=</span>&nbsp;<span class="ident" id="1547698">acquirem</span><span class="op" id="1547706">(</span><span class="op" id="1547707">)</span>&nbsp;<span class="op" id="1547709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547714">gothrow</span><span class="op" id="1547721">(</span><span class="string" id="1547722">&#34;Stack:&nbsp;rescheduled&#34;</span><span class="op" id="1547742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547753">n</span>&nbsp;<span class="op" id="1547755">:=</span>&nbsp;<span class="num" id="1547758">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547761">if</span>&nbsp;<span class="builtinfunc" id="1547764">len</span><span class="op" id="1547767">(</span><span class="ident" id="1547768">buf</span><span class="op" id="1547771">)</span>&nbsp;<span class="op" id="1547773">&gt;</span>&nbsp;<span class="num" id="1547775">0</span>&nbsp;<span class="op" id="1547777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547781">sp</span>&nbsp;<span class="op" id="1547784">:=</span>&nbsp;<span class="ident" id="1547787">getcallersp</span><span class="op" id="1547798">(</span><span class="ident" id="1547799">unsafe</span><span class="op" id="1547805">.</span><span class="ident" id="1547806">Pointer</span><span class="op" id="1547813">(</span><span class="op" id="1547814">&amp;</span><span class="ident" id="1547815">buf</span><span class="op" id="1547818">)</span><span class="op" id="1547819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547823">pc</span>&nbsp;<span class="op" id="1547826">:=</span>&nbsp;<span class="ident" id="1547829">getcallerpc</span><span class="op" id="1547840">(</span><span class="ident" id="1547841">unsafe</span><span class="op" id="1547847">.</span><span class="ident" id="1547848">Pointer</span><span class="op" id="1547855">(</span><span class="op" id="1547856">&amp;</span><span class="ident" id="1547857">buf</span><span class="op" id="1547860">)</span><span class="op" id="1547861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547865">onM</span><span class="op" id="1547868">(</span><span class="keyword" id="1547869">func</span><span class="op" id="1547873">(</span><span class="op" id="1547874">)</span>&nbsp;<span class="op" id="1547876">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547881">g0</span>&nbsp;<span class="op" id="1547884">:=</span>&nbsp;<span class="ident" id="1547887">getg</span><span class="op" id="1547891">(</span><span class="op" id="1547892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547897">g0</span><span class="op" id="1547899">.</span><span class="ident" id="1547900">writebuf</span>&nbsp;<span class="op" id="1547909">=</span>&nbsp;<span class="ident" id="1547911">buf</span><span class="op" id="1547914">[</span><span class="num" id="1547915">0</span><span class="op" id="1547916">:</span><span class="num" id="1547917">0</span><span class="op" id="1547918">:</span><span class="builtinfunc" id="1547919">len</span><span class="op" id="1547922">(</span><span class="ident" id="1547923">buf</span><span class="op" id="1547926">)</span><span class="op" id="1547927">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547932">goroutineheader</span><span class="op" id="1547947">(</span><span class="ident" id="1547948">gp</span><span class="op" id="1547950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547955">traceback</span><span class="op" id="1547964">(</span><span class="ident" id="1547965">pc</span><span class="op" id="1547967">,</span>&nbsp;<span class="ident" id="1547969">sp</span><span class="op" id="1547971">,</span>&nbsp;<span class="num" id="1547973">0</span><span class="op" id="1547974">,</span>&nbsp;<span class="ident" id="1547976">gp</span><span class="op" id="1547978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547983">if</span>&nbsp;<span class="ident" id="1547986">all</span>&nbsp;<span class="op" id="1547990">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547996">tracebackothers</span><span class="op" id="1548011">(</span><span class="ident" id="1548012">gp</span><span class="op" id="1548014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548024">n</span>&nbsp;<span class="op" id="1548026">=</span>&nbsp;<span class="builtinfunc" id="1548028">len</span><span class="op" id="1548031">(</span><span class="ident" id="1548032">g0</span><span class="op" id="1548034">.</span><span class="ident" id="1548035">writebuf</span><span class="op" id="1548043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548048">g0</span><span class="op" id="1548050">.</span><span class="ident" id="1548051">writebuf</span>&nbsp;<span class="op" id="1548060">=</span>&nbsp;<span class="builtintype" id="1548062">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548068">}</span><span class="op" id="1548069">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1548076">if</span>&nbsp;<span class="ident" id="1548079">all</span>&nbsp;<span class="op" id="1548083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548087">mp</span><span class="op" id="1548089">.</span><span class="ident" id="1548090">gcing</span>&nbsp;<span class="op" id="1548096">=</span>&nbsp;<span class="num" id="1548098">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548102">semrelease</span><span class="op" id="1548112">(</span><span class="op" id="1548113">&amp;</span><span class="ident" id="1548114">worldsema</span><span class="op" id="1548123">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548127">onM</span><span class="op" id="1548130">(</span><span class="ident" id="1548131">starttheworld</span><span class="op" id="1548144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548150">releasem</span><span class="op" id="1548158">(</span><span class="ident" id="1548159">mp</span><span class="op" id="1548161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1548164">return</span>&nbsp;<span class="ident" id="1548171">n</span><br>
<span class="lineno"></span><span class="op" id="1548173">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="comment" id="1548176">//&nbsp;Tracing&nbsp;of&nbsp;alloc/free/gc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1548206">var</span>&nbsp;<span class="ident" id="1548210">tracelock</span>&nbsp;<span class="ident" id="1548220">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="1548227">func</span>&nbsp;<span class="ident" id="1548232">tracealloc</span><span class="op" id="1548242">(</span><span class="ident" id="1548243">p</span>&nbsp;<span class="ident" id="1548245">unsafe</span><span class="op" id="1548251">.</span><span class="ident" id="1548252">Pointer</span><span class="op" id="1548259">,</span>&nbsp;<span class="ident" id="1548261">size</span>&nbsp;<span class="builtintype" id="1548266">uintptr</span><span class="op" id="1548273">,</span>&nbsp;<span class="ident" id="1548275">typ</span>&nbsp;<span class="op" id="1548279">*</span><span class="ident" id="1548280">_type</span><span class="op" id="1548285">)</span>&nbsp;<span class="op" id="1548287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548290">lock</span><span class="op" id="1548294">(</span><span class="op" id="1548295">&amp;</span><span class="ident" id="1548296">tracelock</span><span class="op" id="1548305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548308">gp</span>&nbsp;<span class="op" id="1548311">:=</span>&nbsp;<span class="ident" id="1548314">getg</span><span class="op" id="1548318">(</span><span class="op" id="1548319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548322">gp</span><span class="op" id="1548324">.</span><span class="ident" id="1548325">m</span><span class="op" id="1548326">.</span><span class="ident" id="1548327">traceback</span>&nbsp;<span class="op" id="1548337">=</span>&nbsp;<span class="num" id="1548339">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1548342">if</span>&nbsp;<span class="ident" id="1548345">typ</span>&nbsp;<span class="op" id="1548349">==</span>&nbsp;<span class="builtintype" id="1548352">nil</span>&nbsp;<span class="op" id="1548356">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1548360">print</span><span class="op" id="1548365">(</span><span class="string" id="1548366">&#34;tracealloc(&#34;</span><span class="op" id="1548379">,</span>&nbsp;<span class="ident" id="1548381">p</span><span class="op" id="1548382">,</span>&nbsp;<span class="string" id="1548384">&#34;,&nbsp;&#34;</span><span class="op" id="1548388">,</span>&nbsp;<span class="ident" id="1548390">hex</span><span class="op" id="1548393">(</span><span class="ident" id="1548394">size</span><span class="op" id="1548398">)</span><span class="op" id="1548399">,</span>&nbsp;<span class="string" id="1548401">&#34;)\n&#34;</span><span class="op" id="1548406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548409">}</span>&nbsp;<span class="keyword" id="1548411">else</span>&nbsp;<span class="op" id="1548416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1548420">print</span><span class="op" id="1548425">(</span><span class="string" id="1548426">&#34;tracealloc(&#34;</span><span class="op" id="1548439">,</span>&nbsp;<span class="ident" id="1548441">p</span><span class="op" id="1548442">,</span>&nbsp;<span class="string" id="1548444">&#34;,&nbsp;&#34;</span><span class="op" id="1548448">,</span>&nbsp;<span class="ident" id="1548450">hex</span><span class="op" id="1548453">(</span><span class="ident" id="1548454">size</span><span class="op" id="1548458">)</span><span class="op" id="1548459">,</span>&nbsp;<span class="string" id="1548461">&#34;,&nbsp;&#34;</span><span class="op" id="1548465">,</span>&nbsp;<span class="op" id="1548467">*</span><span class="ident" id="1548468">typ</span><span class="op" id="1548471">.</span><span class="ident" id="1548472">_string</span><span class="op" id="1548479">,</span>&nbsp;<span class="string" id="1548481">&#34;)\n&#34;</span><span class="op" id="1548486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1548492">if</span>&nbsp;<span class="ident" id="1548495">gp</span><span class="op" id="1548497">.</span><span class="ident" id="1548498">m</span><span class="op" id="1548499">.</span><span class="ident" id="1548500">curg</span>&nbsp;<span class="op" id="1548505">==</span>&nbsp;<span class="builtintype" id="1548508">nil</span>&nbsp;<span class="op" id="1548512">||</span>&nbsp;<span class="ident" id="1548515">gp</span>&nbsp;<span class="op" id="1548518">==</span>&nbsp;<span class="ident" id="1548521">gp</span><span class="op" id="1548523">.</span><span class="ident" id="1548524">m</span><span class="op" id="1548525">.</span><span class="ident" id="1548526">curg</span>&nbsp;<span class="op" id="1548531">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548535">goroutineheader</span><span class="op" id="1548550">(</span><span class="ident" id="1548551">gp</span><span class="op" id="1548553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548557">pc</span>&nbsp;<span class="op" id="1548560">:=</span>&nbsp;<span class="ident" id="1548563">getcallerpc</span><span class="op" id="1548574">(</span><span class="ident" id="1548575">unsafe</span><span class="op" id="1548581">.</span><span class="ident" id="1548582">Pointer</span><span class="op" id="1548589">(</span><span class="op" id="1548590">&amp;</span><span class="ident" id="1548591">p</span><span class="op" id="1548592">)</span><span class="op" id="1548593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548597">sp</span>&nbsp;<span class="op" id="1548600">:=</span>&nbsp;<span class="ident" id="1548603">getcallersp</span><span class="op" id="1548614">(</span><span class="ident" id="1548615">unsafe</span><span class="op" id="1548621">.</span><span class="ident" id="1548622">Pointer</span><span class="op" id="1548629">(</span><span class="op" id="1548630">&amp;</span><span class="ident" id="1548631">p</span><span class="op" id="1548632">)</span><span class="op" id="1548633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548637">onM</span><span class="op" id="1548640">(</span><span class="keyword" id="1548641">func</span><span class="op" id="1548645">(</span><span class="op" id="1548646">)</span>&nbsp;<span class="op" id="1548648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548653">traceback</span><span class="op" id="1548662">(</span><span class="ident" id="1548663">pc</span><span class="op" id="1548665">,</span>&nbsp;<span class="ident" id="1548667">sp</span><span class="op" id="1548669">,</span>&nbsp;<span class="num" id="1548671">0</span><span class="op" id="1548672">,</span>&nbsp;<span class="ident" id="1548674">gp</span><span class="op" id="1548676">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548680">}</span><span class="op" id="1548681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548684">}</span>&nbsp;<span class="keyword" id="1548686">else</span>&nbsp;<span class="op" id="1548691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548695">goroutineheader</span><span class="op" id="1548710">(</span><span class="ident" id="1548711">gp</span><span class="op" id="1548713">.</span><span class="ident" id="1548714">m</span><span class="op" id="1548715">.</span><span class="ident" id="1548716">curg</span><span class="op" id="1548720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548724">traceback</span><span class="op" id="1548733">(</span><span class="op" id="1548734">^</span><span class="builtintype" id="1548735">uintptr</span><span class="op" id="1548742">(</span><span class="num" id="1548743">0</span><span class="op" id="1548744">)</span><span class="op" id="1548745">,</span>&nbsp;<span class="op" id="1548747">^</span><span class="builtintype" id="1548748">uintptr</span><span class="op" id="1548755">(</span><span class="num" id="1548756">0</span><span class="op" id="1548757">)</span><span class="op" id="1548758">,</span>&nbsp;<span class="num" id="1548760">0</span><span class="op" id="1548761">,</span>&nbsp;<span class="ident" id="1548763">gp</span><span class="op" id="1548765">.</span><span class="ident" id="1548766">m</span><span class="op" id="1548767">.</span><span class="ident" id="1548768">curg</span><span class="op" id="1548772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548775">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1548778">print</span><span class="op" id="1548783">(</span><span class="string" id="1548784">&#34;\n&#34;</span><span class="op" id="1548788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548791">gp</span><span class="op" id="1548793">.</span><span class="ident" id="1548794">m</span><span class="op" id="1548795">.</span><span class="ident" id="1548796">traceback</span>&nbsp;<span class="op" id="1548806">=</span>&nbsp;<span class="num" id="1548808">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548811">unlock</span><span class="op" id="1548817">(</span><span class="op" id="1548818">&amp;</span><span class="ident" id="1548819">tracelock</span><span class="op" id="1548828">)</span><br>
<span class="lineno"></span><span class="op" id="1548830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span><span class="keyword" id="1548833">func</span>&nbsp;<span class="ident" id="1548838">tracefree</span><span class="op" id="1548847">(</span><span class="ident" id="1548848">p</span>&nbsp;<span class="ident" id="1548850">unsafe</span><span class="op" id="1548856">.</span><span class="ident" id="1548857">Pointer</span><span class="op" id="1548864">,</span>&nbsp;<span class="ident" id="1548866">size</span>&nbsp;<span class="builtintype" id="1548871">uintptr</span><span class="op" id="1548878">)</span>&nbsp;<span class="op" id="1548880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548883">lock</span><span class="op" id="1548887">(</span><span class="op" id="1548888">&amp;</span><span class="ident" id="1548889">tracelock</span><span class="op" id="1548898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548901">gp</span>&nbsp;<span class="op" id="1548904">:=</span>&nbsp;<span class="ident" id="1548907">getg</span><span class="op" id="1548911">(</span><span class="op" id="1548912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548915">gp</span><span class="op" id="1548917">.</span><span class="ident" id="1548918">m</span><span class="op" id="1548919">.</span><span class="ident" id="1548920">traceback</span>&nbsp;<span class="op" id="1548930">=</span>&nbsp;<span class="num" id="1548932">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1548935">print</span><span class="op" id="1548940">(</span><span class="string" id="1548941">&#34;tracefree(&#34;</span><span class="op" id="1548953">,</span>&nbsp;<span class="ident" id="1548955">p</span><span class="op" id="1548956">,</span>&nbsp;<span class="string" id="1548958">&#34;,&nbsp;&#34;</span><span class="op" id="1548962">,</span>&nbsp;<span class="ident" id="1548964">hex</span><span class="op" id="1548967">(</span><span class="ident" id="1548968">size</span><span class="op" id="1548972">)</span><span class="op" id="1548973">,</span>&nbsp;<span class="string" id="1548975">&#34;)\n&#34;</span><span class="op" id="1548980">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548983">goroutineheader</span><span class="op" id="1548998">(</span><span class="ident" id="1548999">gp</span><span class="op" id="1549001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549004">pc</span>&nbsp;<span class="op" id="1549007">:=</span>&nbsp;<span class="ident" id="1549010">getcallerpc</span><span class="op" id="1549021">(</span><span class="ident" id="1549022">unsafe</span><span class="op" id="1549028">.</span><span class="ident" id="1549029">Pointer</span><span class="op" id="1549036">(</span><span class="op" id="1549037">&amp;</span><span class="ident" id="1549038">p</span><span class="op" id="1549039">)</span><span class="op" id="1549040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549043">sp</span>&nbsp;<span class="op" id="1549046">:=</span>&nbsp;<span class="ident" id="1549049">getcallersp</span><span class="op" id="1549060">(</span><span class="ident" id="1549061">unsafe</span><span class="op" id="1549067">.</span><span class="ident" id="1549068">Pointer</span><span class="op" id="1549075">(</span><span class="op" id="1549076">&amp;</span><span class="ident" id="1549077">p</span><span class="op" id="1549078">)</span><span class="op" id="1549079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549082">onM</span><span class="op" id="1549085">(</span><span class="keyword" id="1549086">func</span><span class="op" id="1549090">(</span><span class="op" id="1549091">)</span>&nbsp;<span class="op" id="1549093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549097">traceback</span><span class="op" id="1549106">(</span><span class="ident" id="1549107">pc</span><span class="op" id="1549109">,</span>&nbsp;<span class="ident" id="1549111">sp</span><span class="op" id="1549113">,</span>&nbsp;<span class="num" id="1549115">0</span><span class="op" id="1549116">,</span>&nbsp;<span class="ident" id="1549118">gp</span><span class="op" id="1549120">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1549123">}</span><span class="op" id="1549124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1549127">print</span><span class="op" id="1549132">(</span><span class="string" id="1549133">&#34;\n&#34;</span><span class="op" id="1549137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549140">gp</span><span class="op" id="1549142">.</span><span class="ident" id="1549143">m</span><span class="op" id="1549144">.</span><span class="ident" id="1549145">traceback</span>&nbsp;<span class="op" id="1549155">=</span>&nbsp;<span class="num" id="1549157">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549160">unlock</span><span class="op" id="1549166">(</span><span class="op" id="1549167">&amp;</span><span class="ident" id="1549168">tracelock</span><span class="op" id="1549177">)</span><br>
<span class="lineno"></span><span class="op" id="1549179">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="keyword" id="1549182">func</span>&nbsp;<span class="ident" id="1549187">tracegc</span><span class="op" id="1549194">(</span><span class="op" id="1549195">)</span>&nbsp;<span class="op" id="1549197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549200">lock</span><span class="op" id="1549204">(</span><span class="op" id="1549205">&amp;</span><span class="ident" id="1549206">tracelock</span><span class="op" id="1549215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549218">gp</span>&nbsp;<span class="op" id="1549221">:=</span>&nbsp;<span class="ident" id="1549224">getg</span><span class="op" id="1549228">(</span><span class="op" id="1549229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549232">gp</span><span class="op" id="1549234">.</span><span class="ident" id="1549235">m</span><span class="op" id="1549236">.</span><span class="ident" id="1549237">traceback</span>&nbsp;<span class="op" id="1549247">=</span>&nbsp;<span class="num" id="1549249">2</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1549252">print</span><span class="op" id="1549257">(</span><span class="string" id="1549258">&#34;tracegc()\n&#34;</span><span class="op" id="1549271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1549274">//&nbsp;running&nbsp;on&nbsp;m-&gt;g0&nbsp;stack;&nbsp;show&nbsp;all&nbsp;non-g0&nbsp;goroutines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549329">tracebackothers</span><span class="op" id="1549344">(</span><span class="ident" id="1549345">gp</span><span class="op" id="1549347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1549350">print</span><span class="op" id="1549355">(</span><span class="string" id="1549356">&#34;end&nbsp;tracegc\n&#34;</span><span class="op" id="1549371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1549374">print</span><span class="op" id="1549379">(</span><span class="string" id="1549380">&#34;\n&#34;</span><span class="op" id="1549384">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549387">gp</span><span class="op" id="1549389">.</span><span class="ident" id="1549390">m</span><span class="op" id="1549391">.</span><span class="ident" id="1549392">traceback</span>&nbsp;<span class="op" id="1549402">=</span>&nbsp;<span class="num" id="1549404">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549407">unlock</span><span class="op" id="1549413">(</span><span class="op" id="1549414">&amp;</span><span class="ident" id="1549415">tracelock</span><span class="op" id="1549424">)</span><br>
<span class="lineno"></span><span class="op" id="1549426">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
