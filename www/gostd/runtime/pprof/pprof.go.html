<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/pprof</h2>
<ul>
<li><a href="/gostd/runtime/pprof/mprof_test.go.html">mprof_test.go</a></li>
<li><a href="/gostd/runtime/pprof/pprof.go.html">pprof.go</a></li>
<li><a href="/gostd/runtime/pprof/pprof_test.go.html">pprof_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5379980">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5380036">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5380090">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5380141">//&nbsp;Package&nbsp;pprof&nbsp;writes&nbsp;runtime&nbsp;profiling&nbsp;data&nbsp;in&nbsp;the&nbsp;format&nbsp;expected</span><br>
<span class="lineno"></span><span class="comment" id="5380211">//&nbsp;by&nbsp;the&nbsp;pprof&nbsp;visualization&nbsp;tool.</span><br>
<span class="lineno"></span><span class="comment" id="5380247">//&nbsp;For&nbsp;more&nbsp;information&nbsp;about&nbsp;pprof,&nbsp;see</span><br>
<span class="lineno"></span><span class="comment" id="5380288">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="keyword" id="5380335">package</span>&nbsp;<span class="ident" id="5380343">pprof</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5380350">import</span>&nbsp;<span class="op" id="5380357">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5380360">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5380369">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5380378">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5380385">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5380391">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5380402">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5380410">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5380421">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5380429">&#34;text/tabwriter&#34;</span><br>
<span class="lineno"></span><span class="op" id="5380446">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5380449">//&nbsp;BUG(rsc):&nbsp;Profiles&nbsp;are&nbsp;incomplete&nbsp;and&nbsp;inaccurate&nbsp;on&nbsp;NetBSD&nbsp;and&nbsp;OS&nbsp;X.</span><br>
<span class="lineno"></span><span class="comment" id="5380521">//&nbsp;See&nbsp;http://golang.org/issue/6047&nbsp;for&nbsp;details.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="5380571">//&nbsp;A&nbsp;Profile&nbsp;is&nbsp;a&nbsp;collection&nbsp;of&nbsp;stack&nbsp;traces&nbsp;showing&nbsp;the&nbsp;call&nbsp;sequences</span><br>
<span class="lineno"></span><span class="comment" id="5380643">//&nbsp;that&nbsp;led&nbsp;to&nbsp;instances&nbsp;of&nbsp;a&nbsp;particular&nbsp;event,&nbsp;such&nbsp;as&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="comment" id="5380711">//&nbsp;Packages&nbsp;can&nbsp;create&nbsp;and&nbsp;maintain&nbsp;their&nbsp;own&nbsp;profiles;&nbsp;the&nbsp;most&nbsp;common</span><br>
<span class="lineno"></span><span class="comment" id="5380783">//&nbsp;use&nbsp;is&nbsp;for&nbsp;tracking&nbsp;resources&nbsp;that&nbsp;must&nbsp;be&nbsp;explicitly&nbsp;closed,&nbsp;such&nbsp;as&nbsp;files</span><br>
<span class="lineno">30</span><span class="comment" id="5380862">//&nbsp;or&nbsp;network&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="5380889">//</span><br>
<span class="lineno"></span><span class="comment" id="5380892">//&nbsp;A&nbsp;Profile&#39;s&nbsp;methods&nbsp;can&nbsp;be&nbsp;called&nbsp;from&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="5380970">//</span><br>
<span class="lineno"></span><span class="comment" id="5380973">//&nbsp;Each&nbsp;Profile&nbsp;has&nbsp;a&nbsp;unique&nbsp;name.&nbsp;&nbsp;A&nbsp;few&nbsp;profiles&nbsp;are&nbsp;predefined:</span><br>
<span class="lineno">35</span><span class="comment" id="5381040">//</span><br>
<span class="lineno"></span><span class="comment" id="5381043">//&nbsp;&nbsp;&nbsp;&nbspgoroutine&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;current&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="5381100">//&nbsp;&nbsp;&nbsp;&nbspheap&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;a&nbsp;sampling&nbsp;of&nbsp;all&nbsp;heap&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="5381153">//&nbsp;&nbsp;&nbsp;&nbspthreadcreate&nbsp;-&nbsp;stack&nbsp;traces&nbsp;that&nbsp;led&nbsp;to&nbsp;the&nbsp;creation&nbsp;of&nbsp;new&nbsp;OS&nbsp;threads</span><br>
<span class="lineno"></span><span class="comment" id="5381227">//&nbsp;&nbsp;&nbsp;&nbspblock&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;stack&nbsp;traces&nbsp;that&nbsp;led&nbsp;to&nbsp;blocking&nbsp;on&nbsp;synchronization&nbsp;primitives</span><br>
<span class="lineno">40</span><span class="comment" id="5381309">//</span><br>
<span class="lineno"></span><span class="comment" id="5381312">//&nbsp;These&nbsp;predefined&nbsp;profiles&nbsp;maintain&nbsp;themselves&nbsp;and&nbsp;panic&nbsp;on&nbsp;an&nbsp;explicit</span><br>
<span class="lineno"></span><span class="comment" id="5381386">//&nbsp;Add&nbsp;or&nbsp;Remove&nbsp;method&nbsp;call.</span><br>
<span class="lineno"></span><span class="comment" id="5381416">//</span><br>
<span class="lineno"></span><span class="comment" id="5381419">//&nbsp;The&nbsp;CPU&nbsp;profile&nbsp;is&nbsp;not&nbsp;available&nbsp;as&nbsp;a&nbsp;Profile.&nbsp;&nbsp;It&nbsp;has&nbsp;a&nbsp;special&nbsp;API,</span><br>
<span class="lineno">45</span><span class="comment" id="5381492">//&nbsp;the&nbsp;StartCPUProfile&nbsp;and&nbsp;StopCPUProfile&nbsp;functions,&nbsp;because&nbsp;it&nbsp;streams</span><br>
<span class="lineno"></span><span class="comment" id="5381564">//&nbsp;output&nbsp;to&nbsp;a&nbsp;writer&nbsp;during&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="5381604">//</span><br>
<span class="lineno"></span><span class="keyword" id="5381607">type</span>&nbsp;<span class="ident" id="5381612">Profile</span>&nbsp;<span class="keyword" id="5381620">struct</span>&nbsp;<span class="op" id="5381627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381630">name</span>&nbsp;&nbsp;<span class="builtintype" id="5381636">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381644">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5381650">sync</span><span class="op" id="5381654">.</span><span class="ident" id="5381655">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381662">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5381668">map</span><span class="op" id="5381671">[</span><span class="keyword" id="5381672">interface</span><span class="op" id="5381681">{</span><span class="op" id="5381682">}</span><span class="op" id="5381683">]</span><span class="op" id="5381684">[</span><span class="op" id="5381685">]</span><span class="builtintype" id="5381686">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381695">count</span>&nbsp;<span class="keyword" id="5381701">func</span><span class="op" id="5381705">(</span><span class="op" id="5381706">)</span>&nbsp;<span class="builtintype" id="5381708">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381713">write</span>&nbsp;<span class="keyword" id="5381719">func</span><span class="op" id="5381723">(</span><span class="ident" id="5381724">io</span><span class="op" id="5381726">.</span><span class="ident" id="5381727">Writer</span><span class="op" id="5381733">,</span>&nbsp;<span class="builtintype" id="5381735">int</span><span class="op" id="5381738">)</span>&nbsp;<span class="builtintype" id="5381740">error</span><br>
<span class="lineno"></span><span class="op" id="5381746">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="5381749">//&nbsp;profiles&nbsp;records&nbsp;all&nbsp;registered&nbsp;profiles.</span><br>
<span class="lineno"></span><span class="keyword" id="5381794">var</span>&nbsp;<span class="ident" id="5381798">profiles</span>&nbsp;<span class="keyword" id="5381807">struct</span>&nbsp;<span class="op" id="5381814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381817">mu</span>&nbsp;<span class="ident" id="5381820">sync</span><span class="op" id="5381824">.</span><span class="ident" id="5381825">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381832">m</span>&nbsp;&nbsp;<span class="keyword" id="5381835">map</span><span class="op" id="5381838">[</span><span class="builtintype" id="5381839">string</span><span class="op" id="5381845">]</span><span class="op" id="5381846">*</span><span class="ident" id="5381847">Profile</span><br>
<span class="lineno">60</span><span class="op" id="5381855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5381858">var</span>&nbsp;<span class="ident" id="5381862">goroutineProfile</span>&nbsp;<span class="op" id="5381879">=</span>&nbsp;<span class="op" id="5381881">&amp;</span><span class="ident" id="5381882">Profile</span><span class="op" id="5381889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381892">name</span><span class="op" id="5381896">:</span>&nbsp;&nbsp;<span class="string" id="5381899">&#34;goroutine&#34;</span><span class="op" id="5381910">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381913">count</span><span class="op" id="5381918">:</span>&nbsp;<span class="ident" id="5381920">countGoroutine</span><span class="op" id="5381934">,</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381937">write</span><span class="op" id="5381942">:</span>&nbsp;<span class="ident" id="5381944">writeGoroutine</span><span class="op" id="5381958">,</span><br>
<span class="lineno"></span><span class="op" id="5381960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5381963">var</span>&nbsp;<span class="ident" id="5381967">threadcreateProfile</span>&nbsp;<span class="op" id="5381987">=</span>&nbsp;<span class="op" id="5381989">&amp;</span><span class="ident" id="5381990">Profile</span><span class="op" id="5381997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382000">name</span><span class="op" id="5382004">:</span>&nbsp;&nbsp;<span class="string" id="5382007">&#34;threadcreate&#34;</span><span class="op" id="5382021">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382024">count</span><span class="op" id="5382029">:</span>&nbsp;<span class="ident" id="5382031">countThreadCreate</span><span class="op" id="5382048">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382051">write</span><span class="op" id="5382056">:</span>&nbsp;<span class="ident" id="5382058">writeThreadCreate</span><span class="op" id="5382075">,</span><br>
<span class="lineno"></span><span class="op" id="5382077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5382080">var</span>&nbsp;<span class="ident" id="5382084">heapProfile</span>&nbsp;<span class="op" id="5382096">=</span>&nbsp;<span class="op" id="5382098">&amp;</span><span class="ident" id="5382099">Profile</span><span class="op" id="5382106">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382109">name</span><span class="op" id="5382113">:</span>&nbsp;&nbsp;<span class="string" id="5382116">&#34;heap&#34;</span><span class="op" id="5382122">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382125">count</span><span class="op" id="5382130">:</span>&nbsp;<span class="ident" id="5382132">countHeap</span><span class="op" id="5382141">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382144">write</span><span class="op" id="5382149">:</span>&nbsp;<span class="ident" id="5382151">writeHeap</span><span class="op" id="5382160">,</span><br>
<span class="lineno"></span><span class="op" id="5382162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="5382165">var</span>&nbsp;<span class="ident" id="5382169">blockProfile</span>&nbsp;<span class="op" id="5382182">=</span>&nbsp;<span class="op" id="5382184">&amp;</span><span class="ident" id="5382185">Profile</span><span class="op" id="5382192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382195">name</span><span class="op" id="5382199">:</span>&nbsp;&nbsp;<span class="string" id="5382202">&#34;block&#34;</span><span class="op" id="5382209">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382212">count</span><span class="op" id="5382217">:</span>&nbsp;<span class="ident" id="5382219">countBlock</span><span class="op" id="5382229">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382232">write</span><span class="op" id="5382237">:</span>&nbsp;<span class="ident" id="5382239">writeBlock</span><span class="op" id="5382249">,</span><br>
<span class="lineno"></span><span class="op" id="5382251">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="5382254">func</span>&nbsp;<span class="ident" id="5382259">lockProfiles</span><span class="op" id="5382271">(</span><span class="op" id="5382272">)</span>&nbsp;<span class="op" id="5382274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382277">profiles</span><span class="op" id="5382285">.</span><span class="ident" id="5382286">mu</span><span class="op" id="5382288">.</span><span class="ident" id="5382289">Lock</span><span class="op" id="5382293">(</span><span class="op" id="5382294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382297">if</span>&nbsp;<span class="ident" id="5382300">profiles</span><span class="op" id="5382308">.</span><span class="ident" id="5382309">m</span>&nbsp;<span class="op" id="5382311">==</span>&nbsp;<span class="ident" id="5382314">nil</span>&nbsp;<span class="op" id="5382318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382322">//&nbsp;Initial&nbsp;built-in&nbsp;profiles.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382354">profiles</span><span class="op" id="5382362">.</span><span class="ident" id="5382363">m</span>&nbsp;<span class="op" id="5382365">=</span>&nbsp;<span class="keyword" id="5382367">map</span><span class="op" id="5382370">[</span><span class="builtintype" id="5382371">string</span><span class="op" id="5382377">]</span><span class="op" id="5382378">*</span><span class="ident" id="5382379">Profile</span><span class="op" id="5382386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5382391">&#34;goroutine&#34;</span><span class="op" id="5382402">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5382407">goroutineProfile</span><span class="op" id="5382423">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5382428">&#34;threadcreate&#34;</span><span class="op" id="5382442">:</span>&nbsp;<span class="ident" id="5382444">threadcreateProfile</span><span class="op" id="5382463">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5382468">&#34;heap&#34;</span><span class="op" id="5382474">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5382484">heapProfile</span><span class="op" id="5382495">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5382500">&#34;block&#34;</span><span class="op" id="5382507">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5382516">blockProfile</span><span class="op" id="5382528">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382535">}</span><br>
<span class="lineno"></span><span class="op" id="5382537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5382540">func</span>&nbsp;<span class="ident" id="5382545">unlockProfiles</span><span class="op" id="5382559">(</span><span class="op" id="5382560">)</span>&nbsp;<span class="op" id="5382562">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382565">profiles</span><span class="op" id="5382573">.</span><span class="ident" id="5382574">mu</span><span class="op" id="5382576">.</span><span class="ident" id="5382577">Unlock</span><span class="op" id="5382583">(</span><span class="op" id="5382584">)</span><br>
<span class="lineno"></span><span class="op" id="5382586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5382589">//&nbsp;NewProfile&nbsp;creates&nbsp;a&nbsp;new&nbsp;profile&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="5382646">//&nbsp;If&nbsp;a&nbsp;profile&nbsp;with&nbsp;that&nbsp;name&nbsp;already&nbsp;exists,&nbsp;NewProfile&nbsp;panics.</span><br>
<span class="lineno">105</span><span class="comment" id="5382712">//&nbsp;The&nbsp;convention&nbsp;is&nbsp;to&nbsp;use&nbsp;a&nbsp;&#39;import/path.&#39;&nbsp;prefix&nbsp;to&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="5382774">//&nbsp;separate&nbsp;name&nbsp;spaces&nbsp;for&nbsp;each&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5382816">func</span>&nbsp;<span class="ident" id="5382821">NewProfile</span><span class="op" id="5382831">(</span><span class="ident" id="5382832">name</span>&nbsp;<span class="builtintype" id="5382837">string</span><span class="op" id="5382843">)</span>&nbsp;<span class="op" id="5382845">*</span><span class="ident" id="5382846">Profile</span>&nbsp;<span class="op" id="5382854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382857">lockProfiles</span><span class="op" id="5382869">(</span><span class="op" id="5382870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382873">defer</span>&nbsp;<span class="ident" id="5382879">unlockProfiles</span><span class="op" id="5382893">(</span><span class="op" id="5382894">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382897">if</span>&nbsp;<span class="ident" id="5382900">name</span>&nbsp;<span class="op" id="5382905">==</span>&nbsp;<span class="string" id="5382908">&#34;&#34;</span>&nbsp;<span class="op" id="5382911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5382915">panic</span><span class="op" id="5382920">(</span><span class="string" id="5382921">&#34;pprof:&nbsp;NewProfile&nbsp;with&nbsp;empty&nbsp;name&#34;</span><span class="op" id="5382956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382962">if</span>&nbsp;<span class="ident" id="5382965">profiles</span><span class="op" id="5382973">.</span><span class="ident" id="5382974">m</span><span class="op" id="5382975">[</span><span class="ident" id="5382976">name</span><span class="op" id="5382980">]</span>&nbsp;<span class="op" id="5382982">!=</span>&nbsp;<span class="ident" id="5382985">nil</span>&nbsp;<span class="op" id="5382989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5382993">panic</span><span class="op" id="5382998">(</span><span class="string" id="5382999">&#34;pprof:&nbsp;NewProfile&nbsp;name&nbsp;already&nbsp;in&nbsp;use:&nbsp;&#34;</span>&nbsp;<span class="op" id="5383041">+</span>&nbsp;<span class="ident" id="5383043">name</span><span class="op" id="5383047">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383053">p</span>&nbsp;<span class="op" id="5383055">:=</span>&nbsp;<span class="op" id="5383058">&amp;</span><span class="ident" id="5383059">Profile</span><span class="op" id="5383066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383070">name</span><span class="op" id="5383074">:</span>&nbsp;<span class="ident" id="5383076">name</span><span class="op" id="5383080">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383084">m</span><span class="op" id="5383085">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5383090">map</span><span class="op" id="5383093">[</span><span class="keyword" id="5383094">interface</span><span class="op" id="5383103">{</span><span class="op" id="5383104">}</span><span class="op" id="5383105">]</span><span class="op" id="5383106">[</span><span class="op" id="5383107">]</span><span class="builtintype" id="5383108">uintptr</span><span class="op" id="5383115">{</span><span class="op" id="5383116">}</span><span class="op" id="5383117">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383120">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383123">profiles</span><span class="op" id="5383131">.</span><span class="ident" id="5383132">m</span><span class="op" id="5383133">[</span><span class="ident" id="5383134">name</span><span class="op" id="5383138">]</span>&nbsp;<span class="op" id="5383140">=</span>&nbsp;<span class="ident" id="5383142">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383145">return</span>&nbsp;<span class="ident" id="5383152">p</span><br>
<span class="lineno"></span><span class="op" id="5383154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5383157">//&nbsp;Lookup&nbsp;returns&nbsp;the&nbsp;profile&nbsp;with&nbsp;the&nbsp;given&nbsp;name,&nbsp;or&nbsp;nil&nbsp;if&nbsp;no&nbsp;such&nbsp;profile&nbsp;exists.</span><br>
<span class="lineno">125</span><span class="keyword" id="5383242">func</span>&nbsp;<span class="ident" id="5383247">Lookup</span><span class="op" id="5383253">(</span><span class="ident" id="5383254">name</span>&nbsp;<span class="builtintype" id="5383259">string</span><span class="op" id="5383265">)</span>&nbsp;<span class="op" id="5383267">*</span><span class="ident" id="5383268">Profile</span>&nbsp;<span class="op" id="5383276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383279">lockProfiles</span><span class="op" id="5383291">(</span><span class="op" id="5383292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383295">defer</span>&nbsp;<span class="ident" id="5383301">unlockProfiles</span><span class="op" id="5383315">(</span><span class="op" id="5383316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383319">return</span>&nbsp;<span class="ident" id="5383326">profiles</span><span class="op" id="5383334">.</span><span class="ident" id="5383335">m</span><span class="op" id="5383336">[</span><span class="ident" id="5383337">name</span><span class="op" id="5383341">]</span><br>
<span class="lineno"></span><span class="op" id="5383343">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="5383346">//&nbsp;Profiles&nbsp;returns&nbsp;a&nbsp;slice&nbsp;of&nbsp;all&nbsp;the&nbsp;known&nbsp;profiles,&nbsp;sorted&nbsp;by&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="5383417">func</span>&nbsp;<span class="ident" id="5383422">Profiles</span><span class="op" id="5383430">(</span><span class="op" id="5383431">)</span>&nbsp;<span class="op" id="5383433">[</span><span class="op" id="5383434">]</span><span class="op" id="5383435">*</span><span class="ident" id="5383436">Profile</span>&nbsp;<span class="op" id="5383444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383447">lockProfiles</span><span class="op" id="5383459">(</span><span class="op" id="5383460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383463">defer</span>&nbsp;<span class="ident" id="5383469">unlockProfiles</span><span class="op" id="5383483">(</span><span class="op" id="5383484">)</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383488">var</span>&nbsp;<span class="ident" id="5383492">all</span>&nbsp;<span class="op" id="5383496">[</span><span class="op" id="5383497">]</span><span class="op" id="5383498">*</span><span class="ident" id="5383499">Profile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383508">for</span>&nbsp;<span class="ident" id="5383512">_</span><span class="op" id="5383513">,</span>&nbsp;<span class="ident" id="5383515">p</span>&nbsp;<span class="op" id="5383517">:=</span>&nbsp;<span class="keyword" id="5383520">range</span>&nbsp;<span class="ident" id="5383526">profiles</span><span class="op" id="5383534">.</span><span class="ident" id="5383535">m</span>&nbsp;<span class="op" id="5383537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383541">all</span>&nbsp;<span class="op" id="5383545">=</span>&nbsp;<span class="builtinfunc" id="5383547">append</span><span class="op" id="5383553">(</span><span class="ident" id="5383554">all</span><span class="op" id="5383557">,</span>&nbsp;<span class="ident" id="5383559">p</span><span class="op" id="5383560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383563">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383567">sort</span><span class="op" id="5383571">.</span><span class="ident" id="5383572">Sort</span><span class="op" id="5383576">(</span><span class="ident" id="5383577">byName</span><span class="op" id="5383583">(</span><span class="ident" id="5383584">all</span><span class="op" id="5383587">)</span><span class="op" id="5383588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383591">return</span>&nbsp;<span class="ident" id="5383598">all</span><br>
<span class="lineno"></span><span class="op" id="5383602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5383605">type</span>&nbsp;<span class="ident" id="5383610">byName</span>&nbsp;<span class="op" id="5383617">[</span><span class="op" id="5383618">]</span><span class="op" id="5383619">*</span><span class="ident" id="5383620">Profile</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5383629">func</span>&nbsp;<span class="op" id="5383634">(</span><span class="ident" id="5383635">x</span>&nbsp;<span class="ident" id="5383637">byName</span><span class="op" id="5383643">)</span>&nbsp;<span class="ident" id="5383645">Len</span><span class="op" id="5383648">(</span><span class="op" id="5383649">)</span>&nbsp;<span class="builtintype" id="5383651">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5383665">{</span>&nbsp;<span class="keyword" id="5383667">return</span>&nbsp;<span class="builtinfunc" id="5383674">len</span><span class="op" id="5383677">(</span><span class="ident" id="5383678">x</span><span class="op" id="5383679">)</span>&nbsp;<span class="op" id="5383681">}</span><br>
<span class="lineno"></span><span class="keyword" id="5383683">func</span>&nbsp;<span class="op" id="5383688">(</span><span class="ident" id="5383689">x</span>&nbsp;<span class="ident" id="5383691">byName</span><span class="op" id="5383697">)</span>&nbsp;<span class="ident" id="5383699">Swap</span><span class="op" id="5383703">(</span><span class="ident" id="5383704">i</span><span class="op" id="5383705">,</span>&nbsp;<span class="ident" id="5383707">j</span>&nbsp;<span class="builtintype" id="5383709">int</span><span class="op" id="5383712">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5383719">{</span>&nbsp;<span class="ident" id="5383721">x</span><span class="op" id="5383722">[</span><span class="ident" id="5383723">i</span><span class="op" id="5383724">]</span><span class="op" id="5383725">,</span>&nbsp;<span class="ident" id="5383727">x</span><span class="op" id="5383728">[</span><span class="ident" id="5383729">j</span><span class="op" id="5383730">]</span>&nbsp;<span class="op" id="5383732">=</span>&nbsp;<span class="ident" id="5383734">x</span><span class="op" id="5383735">[</span><span class="ident" id="5383736">j</span><span class="op" id="5383737">]</span><span class="op" id="5383738">,</span>&nbsp;<span class="ident" id="5383740">x</span><span class="op" id="5383741">[</span><span class="ident" id="5383742">i</span><span class="op" id="5383743">]</span>&nbsp;<span class="op" id="5383745">}</span><br>
<span class="lineno"></span><span class="keyword" id="5383747">func</span>&nbsp;<span class="op" id="5383752">(</span><span class="ident" id="5383753">x</span>&nbsp;<span class="ident" id="5383755">byName</span><span class="op" id="5383761">)</span>&nbsp;<span class="ident" id="5383763">Less</span><span class="op" id="5383767">(</span><span class="ident" id="5383768">i</span><span class="op" id="5383769">,</span>&nbsp;<span class="ident" id="5383771">j</span>&nbsp;<span class="builtintype" id="5383773">int</span><span class="op" id="5383776">)</span>&nbsp;<span class="builtintype" id="5383778">bool</span>&nbsp;<span class="op" id="5383783">{</span>&nbsp;<span class="keyword" id="5383785">return</span>&nbsp;<span class="ident" id="5383792">x</span><span class="op" id="5383793">[</span><span class="ident" id="5383794">i</span><span class="op" id="5383795">]</span><span class="op" id="5383796">.</span><span class="ident" id="5383797">name</span>&nbsp;<span class="op" id="5383802">&lt;</span>&nbsp;<span class="ident" id="5383804">x</span><span class="op" id="5383805">[</span><span class="ident" id="5383806">j</span><span class="op" id="5383807">]</span><span class="op" id="5383808">.</span><span class="ident" id="5383809">name</span>&nbsp;<span class="op" id="5383814">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="comment" id="5383817">//&nbsp;Name&nbsp;returns&nbsp;this&nbsp;profile&#39;s&nbsp;name,&nbsp;which&nbsp;can&nbsp;be&nbsp;passed&nbsp;to&nbsp;Lookup&nbsp;to&nbsp;reobtain&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5383909">func</span>&nbsp;<span class="op" id="5383914">(</span><span class="ident" id="5383915">p</span>&nbsp;<span class="op" id="5383917">*</span><span class="ident" id="5383918">Profile</span><span class="op" id="5383925">)</span>&nbsp;<span class="ident" id="5383927">Name</span><span class="op" id="5383931">(</span><span class="op" id="5383932">)</span>&nbsp;<span class="builtintype" id="5383934">string</span>&nbsp;<span class="op" id="5383941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383944">return</span>&nbsp;<span class="ident" id="5383951">p</span><span class="op" id="5383952">.</span><span class="ident" id="5383953">name</span><br>
<span class="lineno"></span><span class="op" id="5383958">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5383961">//&nbsp;Count&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;execution&nbsp;stacks&nbsp;currently&nbsp;in&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5384035">func</span>&nbsp;<span class="op" id="5384040">(</span><span class="ident" id="5384041">p</span>&nbsp;<span class="op" id="5384043">*</span><span class="ident" id="5384044">Profile</span><span class="op" id="5384051">)</span>&nbsp;<span class="ident" id="5384053">Count</span><span class="op" id="5384058">(</span><span class="op" id="5384059">)</span>&nbsp;<span class="builtintype" id="5384061">int</span>&nbsp;<span class="op" id="5384065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384068">p</span><span class="op" id="5384069">.</span><span class="ident" id="5384070">mu</span><span class="op" id="5384072">.</span><span class="ident" id="5384073">Lock</span><span class="op" id="5384077">(</span><span class="op" id="5384078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384081">defer</span>&nbsp;<span class="ident" id="5384087">p</span><span class="op" id="5384088">.</span><span class="ident" id="5384089">mu</span><span class="op" id="5384091">.</span><span class="ident" id="5384092">Unlock</span><span class="op" id="5384098">(</span><span class="op" id="5384099">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384102">if</span>&nbsp;<span class="ident" id="5384105">p</span><span class="op" id="5384106">.</span><span class="ident" id="5384107">count</span>&nbsp;<span class="op" id="5384113">!=</span>&nbsp;<span class="ident" id="5384116">nil</span>&nbsp;<span class="op" id="5384120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384124">return</span>&nbsp;<span class="ident" id="5384131">p</span><span class="op" id="5384132">.</span><span class="ident" id="5384133">count</span><span class="op" id="5384138">(</span><span class="op" id="5384139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5384142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384145">return</span>&nbsp;<span class="builtinfunc" id="5384152">len</span><span class="op" id="5384155">(</span><span class="ident" id="5384156">p</span><span class="op" id="5384157">.</span><span class="ident" id="5384158">m</span><span class="op" id="5384159">)</span><br>
<span class="lineno"></span><span class="op" id="5384161">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="5384164">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;current&nbsp;execution&nbsp;stack&nbsp;to&nbsp;the&nbsp;profile,&nbsp;associated&nbsp;with&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment" id="5384243">//&nbsp;Add&nbsp;stores&nbsp;value&nbsp;in&nbsp;an&nbsp;internal&nbsp;map,&nbsp;so&nbsp;value&nbsp;must&nbsp;be&nbsp;suitable&nbsp;for&nbsp;use&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="5384320">//&nbsp;a&nbsp;map&nbsp;key&nbsp;and&nbsp;will&nbsp;not&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;until&nbsp;the&nbsp;corresponding</span><br>
<span class="lineno"></span><span class="comment" id="5384391">//&nbsp;call&nbsp;to&nbsp;Remove.&nbsp;&nbsp;Add&nbsp;panics&nbsp;if&nbsp;the&nbsp;profile&nbsp;already&nbsp;contains&nbsp;a&nbsp;stack&nbsp;for&nbsp;value.</span><br>
<span class="lineno">170</span><span class="comment" id="5384473">//</span><br>
<span class="lineno"></span><span class="comment" id="5384476">//&nbsp;The&nbsp;skip&nbsp;parameter&nbsp;has&nbsp;the&nbsp;same&nbsp;meaning&nbsp;as&nbsp;runtime.Caller&#39;s&nbsp;skip</span><br>
<span class="lineno"></span><span class="comment" id="5384544">//&nbsp;and&nbsp;controls&nbsp;where&nbsp;the&nbsp;stack&nbsp;trace&nbsp;begins.&nbsp;&nbsp;Passing&nbsp;skip=0&nbsp;begins&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5384617">//&nbsp;trace&nbsp;in&nbsp;the&nbsp;function&nbsp;calling&nbsp;Add.&nbsp;&nbsp;For&nbsp;example,&nbsp;given&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="5384680">//&nbsp;execution&nbsp;stack:</span><br>
<span class="lineno">175</span><span class="comment" id="5384700">//</span><br>
<span class="lineno"></span><span class="comment" id="5384703">//&nbsp;&nbsp;&nbsp;&nbspAdd</span><br>
<span class="lineno"></span><span class="comment" id="5384710">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;rpc.NewClient</span><br>
<span class="lineno"></span><span class="comment" id="5384739">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;mypkg.Run</span><br>
<span class="lineno"></span><span class="comment" id="5384764">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;main.main</span><br>
<span class="lineno">180</span><span class="comment" id="5384789">//</span><br>
<span class="lineno"></span><span class="comment" id="5384792">//&nbsp;Passing&nbsp;skip=0&nbsp;begins&nbsp;the&nbsp;stack&nbsp;trace&nbsp;at&nbsp;the&nbsp;call&nbsp;to&nbsp;Add&nbsp;inside&nbsp;rpc.NewClient.</span><br>
<span class="lineno"></span><span class="comment" id="5384874">//&nbsp;Passing&nbsp;skip=1&nbsp;begins&nbsp;the&nbsp;stack&nbsp;trace&nbsp;at&nbsp;the&nbsp;call&nbsp;to&nbsp;NewClient&nbsp;inside&nbsp;mypkg.Run.</span><br>
<span class="lineno"></span><span class="comment" id="5384958">//</span><br>
<span class="lineno"></span><span class="keyword" id="5384961">func</span>&nbsp;<span class="op" id="5384966">(</span><span class="ident" id="5384967">p</span>&nbsp;<span class="op" id="5384969">*</span><span class="ident" id="5384970">Profile</span><span class="op" id="5384977">)</span>&nbsp;<span class="ident" id="5384979">Add</span><span class="op" id="5384982">(</span><span class="ident" id="5384983">value</span>&nbsp;<span class="keyword" id="5384989">interface</span><span class="op" id="5384998">{</span><span class="op" id="5384999">}</span><span class="op" id="5385000">,</span>&nbsp;<span class="ident" id="5385002">skip</span>&nbsp;<span class="builtintype" id="5385007">int</span><span class="op" id="5385010">)</span>&nbsp;<span class="op" id="5385012">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385015">if</span>&nbsp;<span class="ident" id="5385018">p</span><span class="op" id="5385019">.</span><span class="ident" id="5385020">name</span>&nbsp;<span class="op" id="5385025">==</span>&nbsp;<span class="string" id="5385028">&#34;&#34;</span>&nbsp;<span class="op" id="5385031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5385035">panic</span><span class="op" id="5385040">(</span><span class="string" id="5385041">&#34;pprof:&nbsp;use&nbsp;of&nbsp;uninitialized&nbsp;Profile&#34;</span><span class="op" id="5385078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385084">if</span>&nbsp;<span class="ident" id="5385087">p</span><span class="op" id="5385088">.</span><span class="ident" id="5385089">write</span>&nbsp;<span class="op" id="5385095">!=</span>&nbsp;<span class="ident" id="5385098">nil</span>&nbsp;<span class="op" id="5385102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5385106">panic</span><span class="op" id="5385111">(</span><span class="string" id="5385112">&#34;pprof:&nbsp;Add&nbsp;called&nbsp;on&nbsp;built-in&nbsp;Profile&nbsp;&#34;</span>&nbsp;<span class="op" id="5385153">+</span>&nbsp;<span class="ident" id="5385155">p</span><span class="op" id="5385156">.</span><span class="ident" id="5385157">name</span><span class="op" id="5385161">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385168">stk</span>&nbsp;<span class="op" id="5385172">:=</span>&nbsp;<span class="builtinfunc" id="5385175">make</span><span class="op" id="5385179">(</span><span class="op" id="5385180">[</span><span class="op" id="5385181">]</span><span class="builtintype" id="5385182">uintptr</span><span class="op" id="5385189">,</span>&nbsp;<span class="num" id="5385191">32</span><span class="op" id="5385193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385196">n</span>&nbsp;<span class="op" id="5385198">:=</span>&nbsp;<span class="ident" id="5385201">runtime</span><span class="op" id="5385208">.</span><span class="ident" id="5385209">Callers</span><span class="op" id="5385216">(</span><span class="ident" id="5385217">skip</span><span class="op" id="5385221">+</span><span class="num" id="5385222">1</span><span class="op" id="5385223">,</span>&nbsp;<span class="ident" id="5385225">stk</span><span class="op" id="5385228">[</span><span class="op" id="5385229">:</span><span class="op" id="5385230">]</span><span class="op" id="5385231">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385235">p</span><span class="op" id="5385236">.</span><span class="ident" id="5385237">mu</span><span class="op" id="5385239">.</span><span class="ident" id="5385240">Lock</span><span class="op" id="5385244">(</span><span class="op" id="5385245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385248">defer</span>&nbsp;<span class="ident" id="5385254">p</span><span class="op" id="5385255">.</span><span class="ident" id="5385256">mu</span><span class="op" id="5385258">.</span><span class="ident" id="5385259">Unlock</span><span class="op" id="5385265">(</span><span class="op" id="5385266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385269">if</span>&nbsp;<span class="ident" id="5385272">p</span><span class="op" id="5385273">.</span><span class="ident" id="5385274">m</span><span class="op" id="5385275">[</span><span class="ident" id="5385276">value</span><span class="op" id="5385281">]</span>&nbsp;<span class="op" id="5385283">!=</span>&nbsp;<span class="ident" id="5385286">nil</span>&nbsp;<span class="op" id="5385290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5385294">panic</span><span class="op" id="5385299">(</span><span class="string" id="5385300">&#34;pprof:&nbsp;Profile.Add&nbsp;of&nbsp;duplicate&nbsp;value&#34;</span><span class="op" id="5385339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385342">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385345">p</span><span class="op" id="5385346">.</span><span class="ident" id="5385347">m</span><span class="op" id="5385348">[</span><span class="ident" id="5385349">value</span><span class="op" id="5385354">]</span>&nbsp;<span class="op" id="5385356">=</span>&nbsp;<span class="ident" id="5385358">stk</span><span class="op" id="5385361">[</span><span class="op" id="5385362">:</span><span class="ident" id="5385363">n</span><span class="op" id="5385364">]</span><br>
<span class="lineno"></span><span class="op" id="5385366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5385369">//&nbsp;Remove&nbsp;removes&nbsp;the&nbsp;execution&nbsp;stack&nbsp;associated&nbsp;with&nbsp;value&nbsp;from&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="5385447">//&nbsp;It&nbsp;is&nbsp;a&nbsp;no-op&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;profile.</span><br>
<span class="lineno">205</span><span class="keyword" id="5385500">func</span>&nbsp;<span class="op" id="5385505">(</span><span class="ident" id="5385506">p</span>&nbsp;<span class="op" id="5385508">*</span><span class="ident" id="5385509">Profile</span><span class="op" id="5385516">)</span>&nbsp;<span class="ident" id="5385518">Remove</span><span class="op" id="5385524">(</span><span class="ident" id="5385525">value</span>&nbsp;<span class="keyword" id="5385531">interface</span><span class="op" id="5385540">{</span><span class="op" id="5385541">}</span><span class="op" id="5385542">)</span>&nbsp;<span class="op" id="5385544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385547">p</span><span class="op" id="5385548">.</span><span class="ident" id="5385549">mu</span><span class="op" id="5385551">.</span><span class="ident" id="5385552">Lock</span><span class="op" id="5385556">(</span><span class="op" id="5385557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385560">defer</span>&nbsp;<span class="ident" id="5385566">p</span><span class="op" id="5385567">.</span><span class="ident" id="5385568">mu</span><span class="op" id="5385570">.</span><span class="ident" id="5385571">Unlock</span><span class="op" id="5385577">(</span><span class="op" id="5385578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5385581">delete</span><span class="op" id="5385587">(</span><span class="ident" id="5385588">p</span><span class="op" id="5385589">.</span><span class="ident" id="5385590">m</span><span class="op" id="5385591">,</span>&nbsp;<span class="ident" id="5385593">value</span><span class="op" id="5385598">)</span><br>
<span class="lineno"></span><span class="op" id="5385600">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="comment" id="5385603">//&nbsp;WriteTo&nbsp;writes&nbsp;a&nbsp;pprof-formatted&nbsp;snapshot&nbsp;of&nbsp;the&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="5385669">//&nbsp;If&nbsp;a&nbsp;write&nbsp;to&nbsp;w&nbsp;returns&nbsp;an&nbsp;error,&nbsp;WriteTo&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="5385734">//&nbsp;Otherwise,&nbsp;WriteTo&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="5385769">//</span><br>
<span class="lineno">215</span><span class="comment" id="5385772">//&nbsp;The&nbsp;debug&nbsp;parameter&nbsp;enables&nbsp;additional&nbsp;output.</span><br>
<span class="lineno"></span><span class="comment" id="5385822">//&nbsp;Passing&nbsp;debug=0&nbsp;prints&nbsp;only&nbsp;the&nbsp;hexadecimal&nbsp;addresses&nbsp;that&nbsp;pprof&nbsp;needs.</span><br>
<span class="lineno"></span><span class="comment" id="5385897">//&nbsp;Passing&nbsp;debug=1&nbsp;adds&nbsp;comments&nbsp;translating&nbsp;addresses&nbsp;to&nbsp;function&nbsp;names</span><br>
<span class="lineno"></span><span class="comment" id="5385970">//&nbsp;and&nbsp;line&nbsp;numbers,&nbsp;so&nbsp;that&nbsp;a&nbsp;programmer&nbsp;can&nbsp;read&nbsp;the&nbsp;profile&nbsp;without&nbsp;tools.</span><br>
<span class="lineno"></span><span class="comment" id="5386048">//</span><br>
<span class="lineno">220</span><span class="comment" id="5386051">//&nbsp;The&nbsp;predefined&nbsp;profiles&nbsp;may&nbsp;assign&nbsp;meaning&nbsp;to&nbsp;other&nbsp;debug&nbsp;values;</span><br>
<span class="lineno"></span><span class="comment" id="5386120">//&nbsp;for&nbsp;example,&nbsp;when&nbsp;printing&nbsp;the&nbsp;&#34;goroutine&#34;&nbsp;profile,&nbsp;debug=2&nbsp;means&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5386192">//&nbsp;print&nbsp;the&nbsp;goroutine&nbsp;stacks&nbsp;in&nbsp;the&nbsp;same&nbsp;form&nbsp;that&nbsp;a&nbsp;Go&nbsp;program&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="5386262">//&nbsp;when&nbsp;dying&nbsp;due&nbsp;to&nbsp;an&nbsp;unrecovered&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword" id="5386305">func</span>&nbsp;<span class="op" id="5386310">(</span><span class="ident" id="5386311">p</span>&nbsp;<span class="op" id="5386313">*</span><span class="ident" id="5386314">Profile</span><span class="op" id="5386321">)</span>&nbsp;<span class="ident" id="5386323">WriteTo</span><span class="op" id="5386330">(</span><span class="ident" id="5386331">w</span>&nbsp;<span class="ident" id="5386333">io</span><span class="op" id="5386335">.</span><span class="ident" id="5386336">Writer</span><span class="op" id="5386342">,</span>&nbsp;<span class="ident" id="5386344">debug</span>&nbsp;<span class="builtintype" id="5386350">int</span><span class="op" id="5386353">)</span>&nbsp;<span class="builtintype" id="5386355">error</span>&nbsp;<span class="op" id="5386361">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386364">if</span>&nbsp;<span class="ident" id="5386367">p</span><span class="op" id="5386368">.</span><span class="ident" id="5386369">name</span>&nbsp;<span class="op" id="5386374">==</span>&nbsp;<span class="string" id="5386377">&#34;&#34;</span>&nbsp;<span class="op" id="5386380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5386384">panic</span><span class="op" id="5386389">(</span><span class="string" id="5386390">&#34;pprof:&nbsp;use&nbsp;of&nbsp;zero&nbsp;Profile&#34;</span><span class="op" id="5386418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386424">if</span>&nbsp;<span class="ident" id="5386427">p</span><span class="op" id="5386428">.</span><span class="ident" id="5386429">write</span>&nbsp;<span class="op" id="5386435">!=</span>&nbsp;<span class="ident" id="5386438">nil</span>&nbsp;<span class="op" id="5386442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386446">return</span>&nbsp;<span class="ident" id="5386453">p</span><span class="op" id="5386454">.</span><span class="ident" id="5386455">write</span><span class="op" id="5386460">(</span><span class="ident" id="5386461">w</span><span class="op" id="5386462">,</span>&nbsp;<span class="ident" id="5386464">debug</span><span class="op" id="5386469">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5386476">//&nbsp;Obtain&nbsp;consistent&nbsp;snapshot&nbsp;under&nbsp;lock;&nbsp;then&nbsp;process&nbsp;without&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386546">var</span>&nbsp;<span class="ident" id="5386550">all</span>&nbsp;<span class="op" id="5386554">[</span><span class="op" id="5386555">]</span><span class="op" id="5386556">[</span><span class="op" id="5386557">]</span><span class="builtintype" id="5386558">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386567">p</span><span class="op" id="5386568">.</span><span class="ident" id="5386569">mu</span><span class="op" id="5386571">.</span><span class="ident" id="5386572">Lock</span><span class="op" id="5386576">(</span><span class="op" id="5386577">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386580">for</span>&nbsp;<span class="ident" id="5386584">_</span><span class="op" id="5386585">,</span>&nbsp;<span class="ident" id="5386587">stk</span>&nbsp;<span class="op" id="5386591">:=</span>&nbsp;<span class="keyword" id="5386594">range</span>&nbsp;<span class="ident" id="5386600">p</span><span class="op" id="5386601">.</span><span class="ident" id="5386602">m</span>&nbsp;<span class="op" id="5386604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386608">all</span>&nbsp;<span class="op" id="5386612">=</span>&nbsp;<span class="builtinfunc" id="5386614">append</span><span class="op" id="5386620">(</span><span class="ident" id="5386621">all</span><span class="op" id="5386624">,</span>&nbsp;<span class="ident" id="5386626">stk</span><span class="op" id="5386629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386635">p</span><span class="op" id="5386636">.</span><span class="ident" id="5386637">mu</span><span class="op" id="5386639">.</span><span class="ident" id="5386640">Unlock</span><span class="op" id="5386646">(</span><span class="op" id="5386647">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5386651">//&nbsp;Map&nbsp;order&nbsp;is&nbsp;non-deterministic;&nbsp;make&nbsp;output&nbsp;deterministic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386714">sort</span><span class="op" id="5386718">.</span><span class="ident" id="5386719">Sort</span><span class="op" id="5386723">(</span><span class="ident" id="5386724">stackProfile</span><span class="op" id="5386736">(</span><span class="ident" id="5386737">all</span><span class="op" id="5386740">)</span><span class="op" id="5386741">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386745">return</span>&nbsp;<span class="ident" id="5386752">printCountProfile</span><span class="op" id="5386769">(</span><span class="ident" id="5386770">w</span><span class="op" id="5386771">,</span>&nbsp;<span class="ident" id="5386773">debug</span><span class="op" id="5386778">,</span>&nbsp;<span class="ident" id="5386780">p</span><span class="op" id="5386781">.</span><span class="ident" id="5386782">name</span><span class="op" id="5386786">,</span>&nbsp;<span class="ident" id="5386788">stackProfile</span><span class="op" id="5386800">(</span><span class="ident" id="5386801">all</span><span class="op" id="5386804">)</span><span class="op" id="5386805">)</span><br>
<span class="lineno"></span><span class="op" id="5386807">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="5386810">type</span>&nbsp;<span class="ident" id="5386815">stackProfile</span>&nbsp;<span class="op" id="5386828">[</span><span class="op" id="5386829">]</span><span class="op" id="5386830">[</span><span class="op" id="5386831">]</span><span class="builtintype" id="5386832">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5386841">func</span>&nbsp;<span class="op" id="5386846">(</span><span class="ident" id="5386847">x</span>&nbsp;<span class="ident" id="5386849">stackProfile</span><span class="op" id="5386861">)</span>&nbsp;<span class="ident" id="5386863">Len</span><span class="op" id="5386866">(</span><span class="op" id="5386867">)</span>&nbsp;<span class="builtintype" id="5386869">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5386886">{</span>&nbsp;<span class="keyword" id="5386888">return</span>&nbsp;<span class="builtinfunc" id="5386895">len</span><span class="op" id="5386898">(</span><span class="ident" id="5386899">x</span><span class="op" id="5386900">)</span>&nbsp;<span class="op" id="5386902">}</span><br>
<span class="lineno"></span><span class="keyword" id="5386904">func</span>&nbsp;<span class="op" id="5386909">(</span><span class="ident" id="5386910">x</span>&nbsp;<span class="ident" id="5386912">stackProfile</span><span class="op" id="5386924">)</span>&nbsp;<span class="ident" id="5386926">Stack</span><span class="op" id="5386931">(</span><span class="ident" id="5386932">i</span>&nbsp;<span class="builtintype" id="5386934">int</span><span class="op" id="5386937">)</span>&nbsp;<span class="op" id="5386939">[</span><span class="op" id="5386940">]</span><span class="builtintype" id="5386941">uintptr</span>&nbsp;<span class="op" id="5386949">{</span>&nbsp;<span class="keyword" id="5386951">return</span>&nbsp;<span class="ident" id="5386958">x</span><span class="op" id="5386959">[</span><span class="ident" id="5386960">i</span><span class="op" id="5386961">]</span>&nbsp;<span class="op" id="5386963">}</span><br>
<span class="lineno">250</span><span class="keyword" id="5386965">func</span>&nbsp;<span class="op" id="5386970">(</span><span class="ident" id="5386971">x</span>&nbsp;<span class="ident" id="5386973">stackProfile</span><span class="op" id="5386985">)</span>&nbsp;<span class="ident" id="5386987">Swap</span><span class="op" id="5386991">(</span><span class="ident" id="5386992">i</span><span class="op" id="5386993">,</span>&nbsp;<span class="ident" id="5386995">j</span>&nbsp;<span class="builtintype" id="5386997">int</span><span class="op" id="5387000">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5387010">{</span>&nbsp;<span class="ident" id="5387012">x</span><span class="op" id="5387013">[</span><span class="ident" id="5387014">i</span><span class="op" id="5387015">]</span><span class="op" id="5387016">,</span>&nbsp;<span class="ident" id="5387018">x</span><span class="op" id="5387019">[</span><span class="ident" id="5387020">j</span><span class="op" id="5387021">]</span>&nbsp;<span class="op" id="5387023">=</span>&nbsp;<span class="ident" id="5387025">x</span><span class="op" id="5387026">[</span><span class="ident" id="5387027">j</span><span class="op" id="5387028">]</span><span class="op" id="5387029">,</span>&nbsp;<span class="ident" id="5387031">x</span><span class="op" id="5387032">[</span><span class="ident" id="5387033">i</span><span class="op" id="5387034">]</span>&nbsp;<span class="op" id="5387036">}</span><br>
<span class="lineno"></span><span class="keyword" id="5387038">func</span>&nbsp;<span class="op" id="5387043">(</span><span class="ident" id="5387044">x</span>&nbsp;<span class="ident" id="5387046">stackProfile</span><span class="op" id="5387058">)</span>&nbsp;<span class="ident" id="5387060">Less</span><span class="op" id="5387064">(</span><span class="ident" id="5387065">i</span><span class="op" id="5387066">,</span>&nbsp;<span class="ident" id="5387068">j</span>&nbsp;<span class="builtintype" id="5387070">int</span><span class="op" id="5387073">)</span>&nbsp;<span class="builtintype" id="5387075">bool</span>&nbsp;<span class="op" id="5387080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387083">t</span><span class="op" id="5387084">,</span>&nbsp;<span class="ident" id="5387086">u</span>&nbsp;<span class="op" id="5387088">:=</span>&nbsp;<span class="ident" id="5387091">x</span><span class="op" id="5387092">[</span><span class="ident" id="5387093">i</span><span class="op" id="5387094">]</span><span class="op" id="5387095">,</span>&nbsp;<span class="ident" id="5387097">x</span><span class="op" id="5387098">[</span><span class="ident" id="5387099">j</span><span class="op" id="5387100">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387103">for</span>&nbsp;<span class="ident" id="5387107">k</span>&nbsp;<span class="op" id="5387109">:=</span>&nbsp;<span class="num" id="5387112">0</span><span class="op" id="5387113">;</span>&nbsp;<span class="ident" id="5387115">k</span>&nbsp;<span class="op" id="5387117">&lt;</span>&nbsp;<span class="builtinfunc" id="5387119">len</span><span class="op" id="5387122">(</span><span class="ident" id="5387123">t</span><span class="op" id="5387124">)</span>&nbsp;<span class="op" id="5387126">&amp;&amp;</span>&nbsp;<span class="ident" id="5387129">k</span>&nbsp;<span class="op" id="5387131">&lt;</span>&nbsp;<span class="builtinfunc" id="5387133">len</span><span class="op" id="5387136">(</span><span class="ident" id="5387137">u</span><span class="op" id="5387138">)</span><span class="op" id="5387139">;</span>&nbsp;<span class="ident" id="5387141">k</span><span class="op" id="5387142">++</span>&nbsp;<span class="op" id="5387145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387149">if</span>&nbsp;<span class="ident" id="5387152">t</span><span class="op" id="5387153">[</span><span class="ident" id="5387154">k</span><span class="op" id="5387155">]</span>&nbsp;<span class="op" id="5387157">!=</span>&nbsp;<span class="ident" id="5387160">u</span><span class="op" id="5387161">[</span><span class="ident" id="5387162">k</span><span class="op" id="5387163">]</span>&nbsp;<span class="op" id="5387165">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387170">return</span>&nbsp;<span class="ident" id="5387177">t</span><span class="op" id="5387178">[</span><span class="ident" id="5387179">k</span><span class="op" id="5387180">]</span>&nbsp;<span class="op" id="5387182">&lt;</span>&nbsp;<span class="ident" id="5387184">u</span><span class="op" id="5387185">[</span><span class="ident" id="5387186">k</span><span class="op" id="5387187">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387197">return</span>&nbsp;<span class="builtinfunc" id="5387204">len</span><span class="op" id="5387207">(</span><span class="ident" id="5387208">t</span><span class="op" id="5387209">)</span>&nbsp;<span class="op" id="5387211">&lt;</span>&nbsp;<span class="builtinfunc" id="5387213">len</span><span class="op" id="5387216">(</span><span class="ident" id="5387217">u</span><span class="op" id="5387218">)</span><br>
<span class="lineno"></span><span class="op" id="5387220">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="5387223">//&nbsp;A&nbsp;countProfile&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;stack&nbsp;traces&nbsp;to&nbsp;be&nbsp;printed&nbsp;as&nbsp;counts</span><br>
<span class="lineno"></span><span class="comment" id="5387290">//&nbsp;grouped&nbsp;by&nbsp;stack&nbsp;trace.&nbsp;&nbsp;There&nbsp;are&nbsp;multiple&nbsp;implementations:</span><br>
<span class="lineno"></span><span class="comment" id="5387354">//&nbsp;all&nbsp;that&nbsp;matters&nbsp;is&nbsp;that&nbsp;we&nbsp;can&nbsp;find&nbsp;out&nbsp;how&nbsp;many&nbsp;traces&nbsp;there&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5387424">//&nbsp;and&nbsp;obtain&nbsp;each&nbsp;trace&nbsp;in&nbsp;turn.</span><br>
<span class="lineno">265</span><span class="keyword" id="5387458">type</span>&nbsp;<span class="ident" id="5387463">countProfile</span>&nbsp;<span class="keyword" id="5387476">interface</span>&nbsp;<span class="op" id="5387486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387489">Len</span><span class="op" id="5387492">(</span><span class="op" id="5387493">)</span>&nbsp;<span class="builtintype" id="5387495">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387500">Stack</span><span class="op" id="5387505">(</span><span class="ident" id="5387506">i</span>&nbsp;<span class="builtintype" id="5387508">int</span><span class="op" id="5387511">)</span>&nbsp;<span class="op" id="5387513">[</span><span class="op" id="5387514">]</span><span class="builtintype" id="5387515">uintptr</span><br>
<span class="lineno"></span><span class="op" id="5387523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="5387526">//&nbsp;printCountProfile&nbsp;prints&nbsp;a&nbsp;countProfile&nbsp;at&nbsp;the&nbsp;specified&nbsp;debug&nbsp;level.</span><br>
<span class="lineno"></span><span class="keyword" id="5387599">func</span>&nbsp;<span class="ident" id="5387604">printCountProfile</span><span class="op" id="5387621">(</span><span class="ident" id="5387622">w</span>&nbsp;<span class="ident" id="5387624">io</span><span class="op" id="5387626">.</span><span class="ident" id="5387627">Writer</span><span class="op" id="5387633">,</span>&nbsp;<span class="ident" id="5387635">debug</span>&nbsp;<span class="builtintype" id="5387641">int</span><span class="op" id="5387644">,</span>&nbsp;<span class="ident" id="5387646">name</span>&nbsp;<span class="builtintype" id="5387651">string</span><span class="op" id="5387657">,</span>&nbsp;<span class="ident" id="5387659">p</span>&nbsp;<span class="ident" id="5387661">countProfile</span><span class="op" id="5387673">)</span>&nbsp;<span class="builtintype" id="5387675">error</span>&nbsp;<span class="op" id="5387681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387684">b</span>&nbsp;<span class="op" id="5387686">:=</span>&nbsp;<span class="ident" id="5387689">bufio</span><span class="op" id="5387694">.</span><span class="ident" id="5387695">NewWriter</span><span class="op" id="5387704">(</span><span class="ident" id="5387705">w</span><span class="op" id="5387706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387709">var</span>&nbsp;<span class="ident" id="5387713">tw</span>&nbsp;<span class="op" id="5387716">*</span><span class="ident" id="5387717">tabwriter</span><span class="op" id="5387726">.</span><span class="ident" id="5387727">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387735">w</span>&nbsp;<span class="op" id="5387737">=</span>&nbsp;<span class="ident" id="5387739">b</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387742">if</span>&nbsp;<span class="ident" id="5387745">debug</span>&nbsp;<span class="op" id="5387751">&gt;</span>&nbsp;<span class="num" id="5387753">0</span>&nbsp;<span class="op" id="5387755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387759">tw</span>&nbsp;<span class="op" id="5387762">=</span>&nbsp;<span class="ident" id="5387764">tabwriter</span><span class="op" id="5387773">.</span><span class="ident" id="5387774">NewWriter</span><span class="op" id="5387783">(</span><span class="ident" id="5387784">w</span><span class="op" id="5387785">,</span>&nbsp;<span class="num" id="5387787">1</span><span class="op" id="5387788">,</span>&nbsp;<span class="num" id="5387790">8</span><span class="op" id="5387791">,</span>&nbsp;<span class="num" id="5387793">1</span><span class="op" id="5387794">,</span>&nbsp;<span class="string" id="5387796">&#39;\t&#39;</span><span class="op" id="5387800">,</span>&nbsp;<span class="num" id="5387802">0</span><span class="op" id="5387803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387807">w</span>&nbsp;<span class="op" id="5387809">=</span>&nbsp;<span class="ident" id="5387811">tw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387819">fmt</span><span class="op" id="5387822">.</span><span class="ident" id="5387823">Fprintf</span><span class="op" id="5387830">(</span><span class="ident" id="5387831">w</span><span class="op" id="5387832">,</span>&nbsp;<span class="string" id="5387834">&#34;%s&nbsp;profile:&nbsp;total&nbsp;%d\n&#34;</span><span class="op" id="5387858">,</span>&nbsp;<span class="ident" id="5387860">name</span><span class="op" id="5387864">,</span>&nbsp;<span class="ident" id="5387866">p</span><span class="op" id="5387867">.</span><span class="ident" id="5387868">Len</span><span class="op" id="5387871">(</span><span class="op" id="5387872">)</span><span class="op" id="5387873">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5387877">//&nbsp;Build&nbsp;count&nbsp;of&nbsp;each&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387908">var</span>&nbsp;<span class="ident" id="5387912">buf</span>&nbsp;<span class="ident" id="5387916">bytes</span><span class="op" id="5387921">.</span><span class="ident" id="5387922">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387930">key</span>&nbsp;<span class="op" id="5387934">:=</span>&nbsp;<span class="keyword" id="5387937">func</span><span class="op" id="5387941">(</span><span class="ident" id="5387942">stk</span>&nbsp;<span class="op" id="5387946">[</span><span class="op" id="5387947">]</span><span class="builtintype" id="5387948">uintptr</span><span class="op" id="5387955">)</span>&nbsp;<span class="builtintype" id="5387957">string</span>&nbsp;<span class="op" id="5387964">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387968">buf</span><span class="op" id="5387971">.</span><span class="ident" id="5387972">Reset</span><span class="op" id="5387977">(</span><span class="op" id="5387978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387982">fmt</span><span class="op" id="5387985">.</span><span class="ident" id="5387986">Fprintf</span><span class="op" id="5387993">(</span><span class="op" id="5387994">&amp;</span><span class="ident" id="5387995">buf</span><span class="op" id="5387998">,</span>&nbsp;<span class="string" id="5388000">&#34;@&#34;</span><span class="op" id="5388003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388007">for</span>&nbsp;<span class="ident" id="5388011">_</span><span class="op" id="5388012">,</span>&nbsp;<span class="ident" id="5388014">pc</span>&nbsp;<span class="op" id="5388017">:=</span>&nbsp;<span class="keyword" id="5388020">range</span>&nbsp;<span class="ident" id="5388026">stk</span>&nbsp;<span class="op" id="5388030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388035">fmt</span><span class="op" id="5388038">.</span><span class="ident" id="5388039">Fprintf</span><span class="op" id="5388046">(</span><span class="op" id="5388047">&amp;</span><span class="ident" id="5388048">buf</span><span class="op" id="5388051">,</span>&nbsp;<span class="string" id="5388053">&#34;&nbsp;%#x&#34;</span><span class="op" id="5388059">,</span>&nbsp;<span class="ident" id="5388061">pc</span><span class="op" id="5388063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388067">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388071">return</span>&nbsp;<span class="ident" id="5388078">buf</span><span class="op" id="5388081">.</span><span class="ident" id="5388082">String</span><span class="op" id="5388088">(</span><span class="op" id="5388089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388095">m</span>&nbsp;<span class="op" id="5388097">:=</span>&nbsp;<span class="keyword" id="5388100">map</span><span class="op" id="5388103">[</span><span class="builtintype" id="5388104">string</span><span class="op" id="5388110">]</span><span class="builtintype" id="5388111">int</span><span class="op" id="5388114">{</span><span class="op" id="5388115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388118">n</span>&nbsp;<span class="op" id="5388120">:=</span>&nbsp;<span class="ident" id="5388123">p</span><span class="op" id="5388124">.</span><span class="ident" id="5388125">Len</span><span class="op" id="5388128">(</span><span class="op" id="5388129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388132">for</span>&nbsp;<span class="ident" id="5388136">i</span>&nbsp;<span class="op" id="5388138">:=</span>&nbsp;<span class="num" id="5388141">0</span><span class="op" id="5388142">;</span>&nbsp;<span class="ident" id="5388144">i</span>&nbsp;<span class="op" id="5388146">&lt;</span>&nbsp;<span class="ident" id="5388148">n</span><span class="op" id="5388149">;</span>&nbsp;<span class="ident" id="5388151">i</span><span class="op" id="5388152">++</span>&nbsp;<span class="op" id="5388155">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388159">m</span><span class="op" id="5388160">[</span><span class="ident" id="5388161">key</span><span class="op" id="5388164">(</span><span class="ident" id="5388165">p</span><span class="op" id="5388166">.</span><span class="ident" id="5388167">Stack</span><span class="op" id="5388172">(</span><span class="ident" id="5388173">i</span><span class="op" id="5388174">)</span><span class="op" id="5388175">)</span><span class="op" id="5388176">]</span><span class="op" id="5388177">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5388185">//&nbsp;Print&nbsp;stacks,&nbsp;listing&nbsp;count&nbsp;on&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;a&nbsp;unique&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388256">for</span>&nbsp;<span class="ident" id="5388260">i</span>&nbsp;<span class="op" id="5388262">:=</span>&nbsp;<span class="num" id="5388265">0</span><span class="op" id="5388266">;</span>&nbsp;<span class="ident" id="5388268">i</span>&nbsp;<span class="op" id="5388270">&lt;</span>&nbsp;<span class="ident" id="5388272">n</span><span class="op" id="5388273">;</span>&nbsp;<span class="ident" id="5388275">i</span><span class="op" id="5388276">++</span>&nbsp;<span class="op" id="5388279">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388283">stk</span>&nbsp;<span class="op" id="5388287">:=</span>&nbsp;<span class="ident" id="5388290">p</span><span class="op" id="5388291">.</span><span class="ident" id="5388292">Stack</span><span class="op" id="5388297">(</span><span class="ident" id="5388298">i</span><span class="op" id="5388299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388303">s</span>&nbsp;<span class="op" id="5388305">:=</span>&nbsp;<span class="ident" id="5388308">key</span><span class="op" id="5388311">(</span><span class="ident" id="5388312">stk</span><span class="op" id="5388315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388319">if</span>&nbsp;<span class="ident" id="5388322">count</span>&nbsp;<span class="op" id="5388328">:=</span>&nbsp;<span class="ident" id="5388331">m</span><span class="op" id="5388332">[</span><span class="ident" id="5388333">s</span><span class="op" id="5388334">]</span><span class="op" id="5388335">;</span>&nbsp;<span class="ident" id="5388337">count</span>&nbsp;<span class="op" id="5388343">!=</span>&nbsp;<span class="num" id="5388346">0</span>&nbsp;<span class="op" id="5388348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388353">fmt</span><span class="op" id="5388356">.</span><span class="ident" id="5388357">Fprintf</span><span class="op" id="5388364">(</span><span class="ident" id="5388365">w</span><span class="op" id="5388366">,</span>&nbsp;<span class="string" id="5388368">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="5388377">,</span>&nbsp;<span class="ident" id="5388379">count</span><span class="op" id="5388384">,</span>&nbsp;<span class="ident" id="5388386">s</span><span class="op" id="5388387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388392">if</span>&nbsp;<span class="ident" id="5388395">debug</span>&nbsp;<span class="op" id="5388401">&gt;</span>&nbsp;<span class="num" id="5388403">0</span>&nbsp;<span class="op" id="5388405">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388411">printStackRecord</span><span class="op" id="5388427">(</span><span class="ident" id="5388428">w</span><span class="op" id="5388429">,</span>&nbsp;<span class="ident" id="5388431">stk</span><span class="op" id="5388434">,</span>&nbsp;<span class="builtintype" id="5388436">false</span><span class="op" id="5388441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5388451">delete</span><span class="op" id="5388457">(</span><span class="ident" id="5388458">m</span><span class="op" id="5388459">,</span>&nbsp;<span class="ident" id="5388461">s</span><span class="op" id="5388462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388469">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388473">if</span>&nbsp;<span class="ident" id="5388476">tw</span>&nbsp;<span class="op" id="5388479">!=</span>&nbsp;<span class="ident" id="5388482">nil</span>&nbsp;<span class="op" id="5388486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388490">tw</span><span class="op" id="5388492">.</span><span class="ident" id="5388493">Flush</span><span class="op" id="5388498">(</span><span class="op" id="5388499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388505">return</span>&nbsp;<span class="ident" id="5388512">b</span><span class="op" id="5388513">.</span><span class="ident" id="5388514">Flush</span><span class="op" id="5388519">(</span><span class="op" id="5388520">)</span><br>
<span class="lineno">315</span><span class="op" id="5388522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5388525">//&nbsp;printStackRecord&nbsp;prints&nbsp;the&nbsp;function&nbsp;+&nbsp;source&nbsp;line&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="5388591">//&nbsp;for&nbsp;a&nbsp;single&nbsp;stack&nbsp;trace.</span><br>
<span class="lineno"></span><span class="keyword" id="5388620">func</span>&nbsp;<span class="ident" id="5388625">printStackRecord</span><span class="op" id="5388641">(</span><span class="ident" id="5388642">w</span>&nbsp;<span class="ident" id="5388644">io</span><span class="op" id="5388646">.</span><span class="ident" id="5388647">Writer</span><span class="op" id="5388653">,</span>&nbsp;<span class="ident" id="5388655">stk</span>&nbsp;<span class="op" id="5388659">[</span><span class="op" id="5388660">]</span><span class="builtintype" id="5388661">uintptr</span><span class="op" id="5388668">,</span>&nbsp;<span class="ident" id="5388670">allFrames</span>&nbsp;<span class="builtintype" id="5388680">bool</span><span class="op" id="5388684">)</span>&nbsp;<span class="op" id="5388686">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388689">show</span>&nbsp;<span class="op" id="5388694">:=</span>&nbsp;<span class="ident" id="5388697">allFrames</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388708">wasPanic</span>&nbsp;<span class="op" id="5388717">:=</span>&nbsp;<span class="builtintype" id="5388720">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388727">for</span>&nbsp;<span class="ident" id="5388731">i</span><span class="op" id="5388732">,</span>&nbsp;<span class="ident" id="5388734">pc</span>&nbsp;<span class="op" id="5388737">:=</span>&nbsp;<span class="keyword" id="5388740">range</span>&nbsp;<span class="ident" id="5388746">stk</span>&nbsp;<span class="op" id="5388750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388754">f</span>&nbsp;<span class="op" id="5388756">:=</span>&nbsp;<span class="ident" id="5388759">runtime</span><span class="op" id="5388766">.</span><span class="ident" id="5388767">FuncForPC</span><span class="op" id="5388776">(</span><span class="ident" id="5388777">pc</span><span class="op" id="5388779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388783">if</span>&nbsp;<span class="ident" id="5388786">f</span>&nbsp;<span class="op" id="5388788">==</span>&nbsp;<span class="ident" id="5388791">nil</span>&nbsp;<span class="op" id="5388795">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388800">show</span>&nbsp;<span class="op" id="5388805">=</span>&nbsp;<span class="builtintype" id="5388807">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388815">fmt</span><span class="op" id="5388818">.</span><span class="ident" id="5388819">Fprintf</span><span class="op" id="5388826">(</span><span class="ident" id="5388827">w</span><span class="op" id="5388828">,</span>&nbsp;<span class="string" id="5388830">&#34;#\t%#x\n&#34;</span><span class="op" id="5388840">,</span>&nbsp;<span class="ident" id="5388842">pc</span><span class="op" id="5388844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388849">wasPanic</span>&nbsp;<span class="op" id="5388858">=</span>&nbsp;<span class="builtintype" id="5388860">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388868">}</span>&nbsp;<span class="keyword" id="5388870">else</span>&nbsp;<span class="op" id="5388875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388880">tracepc</span>&nbsp;<span class="op" id="5388888">:=</span>&nbsp;<span class="ident" id="5388891">pc</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5388897">//&nbsp;Back&nbsp;up&nbsp;to&nbsp;call&nbsp;instruction.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388932">if</span>&nbsp;<span class="ident" id="5388935">i</span>&nbsp;<span class="op" id="5388937">&gt;</span>&nbsp;<span class="num" id="5388939">0</span>&nbsp;<span class="op" id="5388941">&amp;&amp;</span>&nbsp;<span class="ident" id="5388944">pc</span>&nbsp;<span class="op" id="5388947">&gt;</span>&nbsp;<span class="ident" id="5388949">f</span><span class="op" id="5388950">.</span><span class="ident" id="5388951">Entry</span><span class="op" id="5388956">(</span><span class="op" id="5388957">)</span>&nbsp;<span class="op" id="5388959">&amp;&amp;</span>&nbsp;<span class="op" id="5388962">!</span><span class="ident" id="5388963">wasPanic</span>&nbsp;<span class="op" id="5388972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388978">if</span>&nbsp;<span class="ident" id="5388981">runtime</span><span class="op" id="5388988">.</span><span class="ident" id="5388989">GOARCH</span>&nbsp;<span class="op" id="5388996">==</span>&nbsp;<span class="string" id="5388999">&#34;386&#34;</span>&nbsp;<span class="op" id="5389005">||</span>&nbsp;<span class="ident" id="5389008">runtime</span><span class="op" id="5389015">.</span><span class="ident" id="5389016">GOARCH</span>&nbsp;<span class="op" id="5389023">==</span>&nbsp;<span class="string" id="5389026">&#34;amd64&#34;</span>&nbsp;<span class="op" id="5389034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389041">tracepc</span><span class="op" id="5389048">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5389055">}</span>&nbsp;<span class="keyword" id="5389057">else</span>&nbsp;<span class="op" id="5389062">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389069">tracepc</span>&nbsp;<span class="op" id="5389077">-=</span>&nbsp;<span class="num" id="5389080">4</span>&nbsp;<span class="comment" id="5389082">//&nbsp;arm,&nbsp;etc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5389098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5389103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389108">file</span><span class="op" id="5389112">,</span>&nbsp;<span class="ident" id="5389114">line</span>&nbsp;<span class="op" id="5389119">:=</span>&nbsp;<span class="ident" id="5389122">f</span><span class="op" id="5389123">.</span><span class="ident" id="5389124">FileLine</span><span class="op" id="5389132">(</span><span class="ident" id="5389133">tracepc</span><span class="op" id="5389140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389145">name</span>&nbsp;<span class="op" id="5389150">:=</span>&nbsp;<span class="ident" id="5389153">f</span><span class="op" id="5389154">.</span><span class="ident" id="5389155">Name</span><span class="op" id="5389159">(</span><span class="op" id="5389160">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389165">//&nbsp;Hide&nbsp;runtime.goexit&nbsp;and&nbsp;any&nbsp;runtime&nbsp;functions&nbsp;at&nbsp;the&nbsp;beginning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389235">//&nbsp;This&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;for&nbsp;allocation&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389286">wasPanic</span>&nbsp;<span class="op" id="5389295">=</span>&nbsp;<span class="ident" id="5389297">name</span>&nbsp;<span class="op" id="5389302">==</span>&nbsp;<span class="string" id="5389305">&#34;runtime.panic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389324">if</span>&nbsp;<span class="ident" id="5389327">name</span>&nbsp;<span class="op" id="5389332">==</span>&nbsp;<span class="string" id="5389335">&#34;runtime.goexit&#34;</span>&nbsp;<span class="op" id="5389352">||</span>&nbsp;<span class="op" id="5389355">!</span><span class="ident" id="5389356">show</span>&nbsp;<span class="op" id="5389361">&amp;&amp;</span>&nbsp;<span class="ident" id="5389364">strings</span><span class="op" id="5389371">.</span><span class="ident" id="5389372">HasPrefix</span><span class="op" id="5389381">(</span><span class="ident" id="5389382">name</span><span class="op" id="5389386">,</span>&nbsp;<span class="string" id="5389388">&#34;runtime.&#34;</span><span class="op" id="5389398">)</span>&nbsp;<span class="op" id="5389400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389406">continue</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5389418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389423">show</span>&nbsp;<span class="op" id="5389428">=</span>&nbsp;<span class="builtintype" id="5389430">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389438">fmt</span><span class="op" id="5389441">.</span><span class="ident" id="5389442">Fprintf</span><span class="op" id="5389449">(</span><span class="ident" id="5389450">w</span><span class="op" id="5389451">,</span>&nbsp;<span class="string" id="5389453">&#34;#\t%#x\t%s+%#x\t%s:%d\n&#34;</span><span class="op" id="5389478">,</span>&nbsp;<span class="ident" id="5389480">pc</span><span class="op" id="5389482">,</span>&nbsp;<span class="ident" id="5389484">name</span><span class="op" id="5389488">,</span>&nbsp;<span class="ident" id="5389490">pc</span><span class="op" id="5389492">-</span><span class="ident" id="5389493">f</span><span class="op" id="5389494">.</span><span class="ident" id="5389495">Entry</span><span class="op" id="5389500">(</span><span class="op" id="5389501">)</span><span class="op" id="5389502">,</span>&nbsp;<span class="ident" id="5389504">file</span><span class="op" id="5389508">,</span>&nbsp;<span class="ident" id="5389510">line</span><span class="op" id="5389514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5389518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5389521">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389524">if</span>&nbsp;<span class="op" id="5389527">!</span><span class="ident" id="5389528">show</span>&nbsp;<span class="op" id="5389533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389537">//&nbsp;We&nbsp;didn&#39;t&nbsp;print&nbsp;anything;&nbsp;do&nbsp;it&nbsp;again,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389581">//&nbsp;and&nbsp;this&nbsp;time&nbsp;include&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389627">printStackRecord</span><span class="op" id="5389643">(</span><span class="ident" id="5389644">w</span><span class="op" id="5389645">,</span>&nbsp;<span class="ident" id="5389647">stk</span><span class="op" id="5389650">,</span>&nbsp;<span class="builtintype" id="5389652">true</span><span class="op" id="5389656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389660">return</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5389668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389671">fmt</span><span class="op" id="5389674">.</span><span class="ident" id="5389675">Fprintf</span><span class="op" id="5389682">(</span><span class="ident" id="5389683">w</span><span class="op" id="5389684">,</span>&nbsp;<span class="string" id="5389686">&#34;\n&#34;</span><span class="op" id="5389690">)</span><br>
<span class="lineno"></span><span class="op" id="5389692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5389695">//&nbsp;Interface&nbsp;to&nbsp;system&nbsp;profiles.</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="5389729">type</span>&nbsp;<span class="ident" id="5389734">byInUseBytes</span>&nbsp;<span class="op" id="5389747">[</span><span class="op" id="5389748">]</span><span class="ident" id="5389749">runtime</span><span class="op" id="5389756">.</span><span class="ident" id="5389757">MemProfileRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5389775">func</span>&nbsp;<span class="op" id="5389780">(</span><span class="ident" id="5389781">x</span>&nbsp;<span class="ident" id="5389783">byInUseBytes</span><span class="op" id="5389795">)</span>&nbsp;<span class="ident" id="5389797">Len</span><span class="op" id="5389800">(</span><span class="op" id="5389801">)</span>&nbsp;<span class="builtintype" id="5389803">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5389817">{</span>&nbsp;<span class="keyword" id="5389819">return</span>&nbsp;<span class="builtinfunc" id="5389826">len</span><span class="op" id="5389829">(</span><span class="ident" id="5389830">x</span><span class="op" id="5389831">)</span>&nbsp;<span class="op" id="5389833">}</span><br>
<span class="lineno"></span><span class="keyword" id="5389835">func</span>&nbsp;<span class="op" id="5389840">(</span><span class="ident" id="5389841">x</span>&nbsp;<span class="ident" id="5389843">byInUseBytes</span><span class="op" id="5389855">)</span>&nbsp;<span class="ident" id="5389857">Swap</span><span class="op" id="5389861">(</span><span class="ident" id="5389862">i</span><span class="op" id="5389863">,</span>&nbsp;<span class="ident" id="5389865">j</span>&nbsp;<span class="builtintype" id="5389867">int</span><span class="op" id="5389870">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5389877">{</span>&nbsp;<span class="ident" id="5389879">x</span><span class="op" id="5389880">[</span><span class="ident" id="5389881">i</span><span class="op" id="5389882">]</span><span class="op" id="5389883">,</span>&nbsp;<span class="ident" id="5389885">x</span><span class="op" id="5389886">[</span><span class="ident" id="5389887">j</span><span class="op" id="5389888">]</span>&nbsp;<span class="op" id="5389890">=</span>&nbsp;<span class="ident" id="5389892">x</span><span class="op" id="5389893">[</span><span class="ident" id="5389894">j</span><span class="op" id="5389895">]</span><span class="op" id="5389896">,</span>&nbsp;<span class="ident" id="5389898">x</span><span class="op" id="5389899">[</span><span class="ident" id="5389900">i</span><span class="op" id="5389901">]</span>&nbsp;<span class="op" id="5389903">}</span><br>
<span class="lineno">365</span><span class="keyword" id="5389905">func</span>&nbsp;<span class="op" id="5389910">(</span><span class="ident" id="5389911">x</span>&nbsp;<span class="ident" id="5389913">byInUseBytes</span><span class="op" id="5389925">)</span>&nbsp;<span class="ident" id="5389927">Less</span><span class="op" id="5389931">(</span><span class="ident" id="5389932">i</span><span class="op" id="5389933">,</span>&nbsp;<span class="ident" id="5389935">j</span>&nbsp;<span class="builtintype" id="5389937">int</span><span class="op" id="5389940">)</span>&nbsp;<span class="builtintype" id="5389942">bool</span>&nbsp;<span class="op" id="5389947">{</span>&nbsp;<span class="keyword" id="5389949">return</span>&nbsp;<span class="ident" id="5389956">x</span><span class="op" id="5389957">[</span><span class="ident" id="5389958">i</span><span class="op" id="5389959">]</span><span class="op" id="5389960">.</span><span class="ident" id="5389961">InUseBytes</span><span class="op" id="5389971">(</span><span class="op" id="5389972">)</span>&nbsp;<span class="op" id="5389974">&gt;</span>&nbsp;<span class="ident" id="5389976">x</span><span class="op" id="5389977">[</span><span class="ident" id="5389978">j</span><span class="op" id="5389979">]</span><span class="op" id="5389980">.</span><span class="ident" id="5389981">InUseBytes</span><span class="op" id="5389991">(</span><span class="op" id="5389992">)</span>&nbsp;<span class="op" id="5389994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5389997">//&nbsp;WriteHeapProfile&nbsp;is&nbsp;shorthand&nbsp;for&nbsp;Lookup(&#34;heap&#34;).WriteTo(w,&nbsp;0).</span><br>
<span class="lineno"></span><span class="comment" id="5390064">//&nbsp;It&nbsp;is&nbsp;preserved&nbsp;for&nbsp;backwards&nbsp;compatibility.</span><br>
<span class="lineno"></span><span class="keyword" id="5390112">func</span>&nbsp;<span class="ident" id="5390117">WriteHeapProfile</span><span class="op" id="5390133">(</span><span class="ident" id="5390134">w</span>&nbsp;<span class="ident" id="5390136">io</span><span class="op" id="5390138">.</span><span class="ident" id="5390139">Writer</span><span class="op" id="5390145">)</span>&nbsp;<span class="builtintype" id="5390147">error</span>&nbsp;<span class="op" id="5390153">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5390156">return</span>&nbsp;<span class="ident" id="5390163">writeHeap</span><span class="op" id="5390172">(</span><span class="ident" id="5390173">w</span><span class="op" id="5390174">,</span>&nbsp;<span class="num" id="5390176">0</span><span class="op" id="5390177">)</span><br>
<span class="lineno"></span><span class="op" id="5390179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5390182">//&nbsp;countHeap&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;heap&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5390246">func</span>&nbsp;<span class="ident" id="5390251">countHeap</span><span class="op" id="5390260">(</span><span class="op" id="5390261">)</span>&nbsp;<span class="builtintype" id="5390263">int</span>&nbsp;<span class="op" id="5390267">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390270">n</span><span class="op" id="5390271">,</span>&nbsp;<span class="ident" id="5390273">_</span>&nbsp;<span class="op" id="5390275">:=</span>&nbsp;<span class="ident" id="5390278">runtime</span><span class="op" id="5390285">.</span><span class="ident" id="5390286">MemProfile</span><span class="op" id="5390296">(</span><span class="ident" id="5390297">nil</span><span class="op" id="5390300">,</span>&nbsp;<span class="builtintype" id="5390302">true</span><span class="op" id="5390306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5390309">return</span>&nbsp;<span class="ident" id="5390316">n</span><br>
<span class="lineno"></span><span class="op" id="5390318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5390321">//&nbsp;writeHeap&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;heap&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno">380</span><span class="keyword" id="5390380">func</span>&nbsp;<span class="ident" id="5390385">writeHeap</span><span class="op" id="5390394">(</span><span class="ident" id="5390395">w</span>&nbsp;<span class="ident" id="5390397">io</span><span class="op" id="5390399">.</span><span class="ident" id="5390400">Writer</span><span class="op" id="5390406">,</span>&nbsp;<span class="ident" id="5390408">debug</span>&nbsp;<span class="builtintype" id="5390414">int</span><span class="op" id="5390417">)</span>&nbsp;<span class="builtintype" id="5390419">error</span>&nbsp;<span class="op" id="5390425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5390428">//&nbsp;Find&nbsp;out&nbsp;how&nbsp;many&nbsp;records&nbsp;there&nbsp;are&nbsp;(MemProfile(nil,&nbsp;true)),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5390493">//&nbsp;allocate&nbsp;that&nbsp;many&nbsp;records,&nbsp;and&nbsp;get&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5390543">//&nbsp;There&#39;s&nbsp;a&nbsp;race—more&nbsp;records&nbsp;might&nbsp;be&nbsp;added&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5390600">//&nbsp;the&nbsp;two&nbsp;calls—so&nbsp;allocate&nbsp;a&nbsp;few&nbsp;extra&nbsp;records&nbsp;for&nbsp;safety</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5390663">//&nbsp;and&nbsp;also&nbsp;try&nbsp;again&nbsp;if&nbsp;we&#39;re&nbsp;very&nbsp;unlucky.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5390709">//&nbsp;The&nbsp;loop&nbsp;should&nbsp;only&nbsp;execute&nbsp;one&nbsp;iteration&nbsp;in&nbsp;the&nbsp;common&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5390776">var</span>&nbsp;<span class="ident" id="5390780">p</span>&nbsp;<span class="op" id="5390782">[</span><span class="op" id="5390783">]</span><span class="ident" id="5390784">runtime</span><span class="op" id="5390791">.</span><span class="ident" id="5390792">MemProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390810">n</span><span class="op" id="5390811">,</span>&nbsp;<span class="ident" id="5390813">ok</span>&nbsp;<span class="op" id="5390816">:=</span>&nbsp;<span class="ident" id="5390819">runtime</span><span class="op" id="5390826">.</span><span class="ident" id="5390827">MemProfile</span><span class="op" id="5390837">(</span><span class="ident" id="5390838">nil</span><span class="op" id="5390841">,</span>&nbsp;<span class="builtintype" id="5390843">true</span><span class="op" id="5390847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5390850">for</span>&nbsp;<span class="op" id="5390854">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5390858">//&nbsp;Allocate&nbsp;room&nbsp;for&nbsp;a&nbsp;slightly&nbsp;bigger&nbsp;profile,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5390908">//&nbsp;in&nbsp;case&nbsp;a&nbsp;few&nbsp;more&nbsp;entries&nbsp;have&nbsp;been&nbsp;added</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5390956">//&nbsp;since&nbsp;the&nbsp;call&nbsp;to&nbsp;MemProfile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390991">p</span>&nbsp;<span class="op" id="5390993">=</span>&nbsp;<span class="builtinfunc" id="5390995">make</span><span class="op" id="5390999">(</span><span class="op" id="5391000">[</span><span class="op" id="5391001">]</span><span class="ident" id="5391002">runtime</span><span class="op" id="5391009">.</span><span class="ident" id="5391010">MemProfileRecord</span><span class="op" id="5391026">,</span>&nbsp;<span class="ident" id="5391028">n</span><span class="op" id="5391029">+</span><span class="num" id="5391030">50</span><span class="op" id="5391032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391036">n</span><span class="op" id="5391037">,</span>&nbsp;<span class="ident" id="5391039">ok</span>&nbsp;<span class="op" id="5391042">=</span>&nbsp;<span class="ident" id="5391044">runtime</span><span class="op" id="5391051">.</span><span class="ident" id="5391052">MemProfile</span><span class="op" id="5391062">(</span><span class="ident" id="5391063">p</span><span class="op" id="5391064">,</span>&nbsp;<span class="builtintype" id="5391066">true</span><span class="op" id="5391070">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391074">if</span>&nbsp;<span class="ident" id="5391077">ok</span>&nbsp;<span class="op" id="5391080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391085">p</span>&nbsp;<span class="op" id="5391087">=</span>&nbsp;<span class="ident" id="5391089">p</span><span class="op" id="5391090">[</span><span class="num" id="5391091">0</span><span class="op" id="5391092">:</span><span class="ident" id="5391093">n</span><span class="op" id="5391094">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391099">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5391111">//&nbsp;Profile&nbsp;grew;&nbsp;try&nbsp;again.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391144">sort</span><span class="op" id="5391148">.</span><span class="ident" id="5391149">Sort</span><span class="op" id="5391153">(</span><span class="ident" id="5391154">byInUseBytes</span><span class="op" id="5391166">(</span><span class="ident" id="5391167">p</span><span class="op" id="5391168">)</span><span class="op" id="5391169">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391173">b</span>&nbsp;<span class="op" id="5391175">:=</span>&nbsp;<span class="ident" id="5391178">bufio</span><span class="op" id="5391183">.</span><span class="ident" id="5391184">NewWriter</span><span class="op" id="5391193">(</span><span class="ident" id="5391194">w</span><span class="op" id="5391195">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391198">var</span>&nbsp;<span class="ident" id="5391202">tw</span>&nbsp;<span class="op" id="5391205">*</span><span class="ident" id="5391206">tabwriter</span><span class="op" id="5391215">.</span><span class="ident" id="5391216">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391224">w</span>&nbsp;<span class="op" id="5391226">=</span>&nbsp;<span class="ident" id="5391228">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391231">if</span>&nbsp;<span class="ident" id="5391234">debug</span>&nbsp;<span class="op" id="5391240">&gt;</span>&nbsp;<span class="num" id="5391242">0</span>&nbsp;<span class="op" id="5391244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391248">tw</span>&nbsp;<span class="op" id="5391251">=</span>&nbsp;<span class="ident" id="5391253">tabwriter</span><span class="op" id="5391262">.</span><span class="ident" id="5391263">NewWriter</span><span class="op" id="5391272">(</span><span class="ident" id="5391273">w</span><span class="op" id="5391274">,</span>&nbsp;<span class="num" id="5391276">1</span><span class="op" id="5391277">,</span>&nbsp;<span class="num" id="5391279">8</span><span class="op" id="5391280">,</span>&nbsp;<span class="num" id="5391282">1</span><span class="op" id="5391283">,</span>&nbsp;<span class="string" id="5391285">&#39;\t&#39;</span><span class="op" id="5391289">,</span>&nbsp;<span class="num" id="5391291">0</span><span class="op" id="5391292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391296">w</span>&nbsp;<span class="op" id="5391298">=</span>&nbsp;<span class="ident" id="5391300">tw</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391308">var</span>&nbsp;<span class="ident" id="5391312">total</span>&nbsp;<span class="ident" id="5391318">runtime</span><span class="op" id="5391325">.</span><span class="ident" id="5391326">MemProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391344">for</span>&nbsp;<span class="ident" id="5391348">i</span>&nbsp;<span class="op" id="5391350">:=</span>&nbsp;<span class="keyword" id="5391353">range</span>&nbsp;<span class="ident" id="5391359">p</span>&nbsp;<span class="op" id="5391361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391365">r</span>&nbsp;<span class="op" id="5391367">:=</span>&nbsp;<span class="op" id="5391370">&amp;</span><span class="ident" id="5391371">p</span><span class="op" id="5391372">[</span><span class="ident" id="5391373">i</span><span class="op" id="5391374">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391378">total</span><span class="op" id="5391383">.</span><span class="ident" id="5391384">AllocBytes</span>&nbsp;<span class="op" id="5391395">+=</span>&nbsp;<span class="ident" id="5391398">r</span><span class="op" id="5391399">.</span><span class="ident" id="5391400">AllocBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391413">total</span><span class="op" id="5391418">.</span><span class="ident" id="5391419">AllocObjects</span>&nbsp;<span class="op" id="5391432">+=</span>&nbsp;<span class="ident" id="5391435">r</span><span class="op" id="5391436">.</span><span class="ident" id="5391437">AllocObjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391452">total</span><span class="op" id="5391457">.</span><span class="ident" id="5391458">FreeBytes</span>&nbsp;<span class="op" id="5391468">+=</span>&nbsp;<span class="ident" id="5391471">r</span><span class="op" id="5391472">.</span><span class="ident" id="5391473">FreeBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391485">total</span><span class="op" id="5391490">.</span><span class="ident" id="5391491">FreeObjects</span>&nbsp;<span class="op" id="5391503">+=</span>&nbsp;<span class="ident" id="5391506">r</span><span class="op" id="5391507">.</span><span class="ident" id="5391508">FreeObjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391521">}</span><br>
<span class="lineno">420</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5391525">//&nbsp;Technically&nbsp;the&nbsp;rate&nbsp;is&nbsp;MemProfileRate&nbsp;not&nbsp;2*MemProfileRate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5391590">//&nbsp;but&nbsp;early&nbsp;versions&nbsp;of&nbsp;the&nbsp;C++&nbsp;heap&nbsp;profiler&nbsp;reported&nbsp;2*MemProfileRate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5391665">//&nbsp;so&nbsp;that&#39;s&nbsp;what&nbsp;pprof&nbsp;has&nbsp;come&nbsp;to&nbsp;expect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391710">fmt</span><span class="op" id="5391713">.</span><span class="ident" id="5391714">Fprintf</span><span class="op" id="5391721">(</span><span class="ident" id="5391722">w</span><span class="op" id="5391723">,</span>&nbsp;<span class="string" id="5391725">&#34;heap&nbsp;profile:&nbsp;%d:&nbsp;%d&nbsp;[%d:&nbsp;%d]&nbsp;@&nbsp;heap/%d\n&#34;</span><span class="op" id="5391768">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391772">total</span><span class="op" id="5391777">.</span><span class="ident" id="5391778">InUseObjects</span><span class="op" id="5391790">(</span><span class="op" id="5391791">)</span><span class="op" id="5391792">,</span>&nbsp;<span class="ident" id="5391794">total</span><span class="op" id="5391799">.</span><span class="ident" id="5391800">InUseBytes</span><span class="op" id="5391810">(</span><span class="op" id="5391811">)</span><span class="op" id="5391812">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391816">total</span><span class="op" id="5391821">.</span><span class="ident" id="5391822">AllocObjects</span><span class="op" id="5391834">,</span>&nbsp;<span class="ident" id="5391836">total</span><span class="op" id="5391841">.</span><span class="ident" id="5391842">AllocBytes</span><span class="op" id="5391852">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5391856">2</span><span class="op" id="5391857">*</span><span class="ident" id="5391858">runtime</span><span class="op" id="5391865">.</span><span class="ident" id="5391866">MemProfileRate</span><span class="op" id="5391880">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391884">for</span>&nbsp;<span class="ident" id="5391888">i</span>&nbsp;<span class="op" id="5391890">:=</span>&nbsp;<span class="keyword" id="5391893">range</span>&nbsp;<span class="ident" id="5391899">p</span>&nbsp;<span class="op" id="5391901">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391905">r</span>&nbsp;<span class="op" id="5391907">:=</span>&nbsp;<span class="op" id="5391910">&amp;</span><span class="ident" id="5391911">p</span><span class="op" id="5391912">[</span><span class="ident" id="5391913">i</span><span class="op" id="5391914">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391918">fmt</span><span class="op" id="5391921">.</span><span class="ident" id="5391922">Fprintf</span><span class="op" id="5391929">(</span><span class="ident" id="5391930">w</span><span class="op" id="5391931">,</span>&nbsp;<span class="string" id="5391933">&#34;%d:&nbsp;%d&nbsp;[%d:&nbsp;%d]&nbsp;@&#34;</span><span class="op" id="5391952">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391957">r</span><span class="op" id="5391958">.</span><span class="ident" id="5391959">InUseObjects</span><span class="op" id="5391971">(</span><span class="op" id="5391972">)</span><span class="op" id="5391973">,</span>&nbsp;<span class="ident" id="5391975">r</span><span class="op" id="5391976">.</span><span class="ident" id="5391977">InUseBytes</span><span class="op" id="5391987">(</span><span class="op" id="5391988">)</span><span class="op" id="5391989">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391994">r</span><span class="op" id="5391995">.</span><span class="ident" id="5391996">AllocObjects</span><span class="op" id="5392008">,</span>&nbsp;<span class="ident" id="5392010">r</span><span class="op" id="5392011">.</span><span class="ident" id="5392012">AllocBytes</span><span class="op" id="5392022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5392026">for</span>&nbsp;<span class="ident" id="5392030">_</span><span class="op" id="5392031">,</span>&nbsp;<span class="ident" id="5392033">pc</span>&nbsp;<span class="op" id="5392036">:=</span>&nbsp;<span class="keyword" id="5392039">range</span>&nbsp;<span class="ident" id="5392045">r</span><span class="op" id="5392046">.</span><span class="ident" id="5392047">Stack</span><span class="op" id="5392052">(</span><span class="op" id="5392053">)</span>&nbsp;<span class="op" id="5392055">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392060">fmt</span><span class="op" id="5392063">.</span><span class="ident" id="5392064">Fprintf</span><span class="op" id="5392071">(</span><span class="ident" id="5392072">w</span><span class="op" id="5392073">,</span>&nbsp;<span class="string" id="5392075">&#34;&nbsp;%#x&#34;</span><span class="op" id="5392081">,</span>&nbsp;<span class="ident" id="5392083">pc</span><span class="op" id="5392085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5392089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392093">fmt</span><span class="op" id="5392096">.</span><span class="ident" id="5392097">Fprintf</span><span class="op" id="5392104">(</span><span class="ident" id="5392105">w</span><span class="op" id="5392106">,</span>&nbsp;<span class="string" id="5392108">&#34;\n&#34;</span><span class="op" id="5392112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5392116">if</span>&nbsp;<span class="ident" id="5392119">debug</span>&nbsp;<span class="op" id="5392125">&gt;</span>&nbsp;<span class="num" id="5392127">0</span>&nbsp;<span class="op" id="5392129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392134">printStackRecord</span><span class="op" id="5392150">(</span><span class="ident" id="5392151">w</span><span class="op" id="5392152">,</span>&nbsp;<span class="ident" id="5392154">r</span><span class="op" id="5392155">.</span><span class="ident" id="5392156">Stack</span><span class="op" id="5392161">(</span><span class="op" id="5392162">)</span><span class="op" id="5392163">,</span>&nbsp;<span class="builtintype" id="5392165">false</span><span class="op" id="5392170">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5392174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5392177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5392181">//&nbsp;Print&nbsp;memstats&nbsp;information&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5392217">//&nbsp;Pprof&nbsp;will&nbsp;ignore,&nbsp;but&nbsp;useful&nbsp;for&nbsp;people</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5392262">if</span>&nbsp;<span class="ident" id="5392265">debug</span>&nbsp;<span class="op" id="5392271">&gt;</span>&nbsp;<span class="num" id="5392273">0</span>&nbsp;<span class="op" id="5392275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392279">s</span>&nbsp;<span class="op" id="5392281">:=</span>&nbsp;<span class="builtinfunc" id="5392284">new</span><span class="op" id="5392287">(</span><span class="ident" id="5392288">runtime</span><span class="op" id="5392295">.</span><span class="ident" id="5392296">MemStats</span><span class="op" id="5392304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392308">runtime</span><span class="op" id="5392315">.</span><span class="ident" id="5392316">ReadMemStats</span><span class="op" id="5392328">(</span><span class="ident" id="5392329">s</span><span class="op" id="5392330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392334">fmt</span><span class="op" id="5392337">.</span><span class="ident" id="5392338">Fprintf</span><span class="op" id="5392345">(</span><span class="ident" id="5392346">w</span><span class="op" id="5392347">,</span>&nbsp;<span class="string" id="5392349">&#34;\n#&nbsp;runtime.MemStats\n&#34;</span><span class="op" id="5392373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392377">fmt</span><span class="op" id="5392380">.</span><span class="ident" id="5392381">Fprintf</span><span class="op" id="5392388">(</span><span class="ident" id="5392389">w</span><span class="op" id="5392390">,</span>&nbsp;<span class="string" id="5392392">&#34;#&nbsp;Alloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5392408">,</span>&nbsp;<span class="ident" id="5392410">s</span><span class="op" id="5392411">.</span><span class="ident" id="5392412">Alloc</span><span class="op" id="5392417">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392421">fmt</span><span class="op" id="5392424">.</span><span class="ident" id="5392425">Fprintf</span><span class="op" id="5392432">(</span><span class="ident" id="5392433">w</span><span class="op" id="5392434">,</span>&nbsp;<span class="string" id="5392436">&#34;#&nbsp;TotalAlloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5392457">,</span>&nbsp;<span class="ident" id="5392459">s</span><span class="op" id="5392460">.</span><span class="ident" id="5392461">TotalAlloc</span><span class="op" id="5392471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392475">fmt</span><span class="op" id="5392478">.</span><span class="ident" id="5392479">Fprintf</span><span class="op" id="5392486">(</span><span class="ident" id="5392487">w</span><span class="op" id="5392488">,</span>&nbsp;<span class="string" id="5392490">&#34;#&nbsp;Sys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5392504">,</span>&nbsp;<span class="ident" id="5392506">s</span><span class="op" id="5392507">.</span><span class="ident" id="5392508">Sys</span><span class="op" id="5392511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392515">fmt</span><span class="op" id="5392518">.</span><span class="ident" id="5392519">Fprintf</span><span class="op" id="5392526">(</span><span class="ident" id="5392527">w</span><span class="op" id="5392528">,</span>&nbsp;<span class="string" id="5392530">&#34;#&nbsp;Lookups&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5392548">,</span>&nbsp;<span class="ident" id="5392550">s</span><span class="op" id="5392551">.</span><span class="ident" id="5392552">Lookups</span><span class="op" id="5392559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392563">fmt</span><span class="op" id="5392566">.</span><span class="ident" id="5392567">Fprintf</span><span class="op" id="5392574">(</span><span class="ident" id="5392575">w</span><span class="op" id="5392576">,</span>&nbsp;<span class="string" id="5392578">&#34;#&nbsp;Mallocs&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5392596">,</span>&nbsp;<span class="ident" id="5392598">s</span><span class="op" id="5392599">.</span><span class="ident" id="5392600">Mallocs</span><span class="op" id="5392607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392611">fmt</span><span class="op" id="5392614">.</span><span class="ident" id="5392615">Fprintf</span><span class="op" id="5392622">(</span><span class="ident" id="5392623">w</span><span class="op" id="5392624">,</span>&nbsp;<span class="string" id="5392626">&#34;#&nbsp;Frees&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5392642">,</span>&nbsp;<span class="ident" id="5392644">s</span><span class="op" id="5392645">.</span><span class="ident" id="5392646">Frees</span><span class="op" id="5392651">)</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392656">fmt</span><span class="op" id="5392659">.</span><span class="ident" id="5392660">Fprintf</span><span class="op" id="5392667">(</span><span class="ident" id="5392668">w</span><span class="op" id="5392669">,</span>&nbsp;<span class="string" id="5392671">&#34;#&nbsp;HeapAlloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5392691">,</span>&nbsp;<span class="ident" id="5392693">s</span><span class="op" id="5392694">.</span><span class="ident" id="5392695">HeapAlloc</span><span class="op" id="5392704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392708">fmt</span><span class="op" id="5392711">.</span><span class="ident" id="5392712">Fprintf</span><span class="op" id="5392719">(</span><span class="ident" id="5392720">w</span><span class="op" id="5392721">,</span>&nbsp;<span class="string" id="5392723">&#34;#&nbsp;HeapSys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5392741">,</span>&nbsp;<span class="ident" id="5392743">s</span><span class="op" id="5392744">.</span><span class="ident" id="5392745">HeapSys</span><span class="op" id="5392752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392756">fmt</span><span class="op" id="5392759">.</span><span class="ident" id="5392760">Fprintf</span><span class="op" id="5392767">(</span><span class="ident" id="5392768">w</span><span class="op" id="5392769">,</span>&nbsp;<span class="string" id="5392771">&#34;#&nbsp;HeapIdle&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5392790">,</span>&nbsp;<span class="ident" id="5392792">s</span><span class="op" id="5392793">.</span><span class="ident" id="5392794">HeapIdle</span><span class="op" id="5392802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392806">fmt</span><span class="op" id="5392809">.</span><span class="ident" id="5392810">Fprintf</span><span class="op" id="5392817">(</span><span class="ident" id="5392818">w</span><span class="op" id="5392819">,</span>&nbsp;<span class="string" id="5392821">&#34;#&nbsp;HeapInuse&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5392841">,</span>&nbsp;<span class="ident" id="5392843">s</span><span class="op" id="5392844">.</span><span class="ident" id="5392845">HeapInuse</span><span class="op" id="5392854">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392858">fmt</span><span class="op" id="5392861">.</span><span class="ident" id="5392862">Fprintf</span><span class="op" id="5392869">(</span><span class="ident" id="5392870">w</span><span class="op" id="5392871">,</span>&nbsp;<span class="string" id="5392873">&#34;#&nbsp;HeapReleased&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5392896">,</span>&nbsp;<span class="ident" id="5392898">s</span><span class="op" id="5392899">.</span><span class="ident" id="5392900">HeapReleased</span><span class="op" id="5392912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392916">fmt</span><span class="op" id="5392919">.</span><span class="ident" id="5392920">Fprintf</span><span class="op" id="5392927">(</span><span class="ident" id="5392928">w</span><span class="op" id="5392929">,</span>&nbsp;<span class="string" id="5392931">&#34;#&nbsp;HeapObjects&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5392953">,</span>&nbsp;<span class="ident" id="5392955">s</span><span class="op" id="5392956">.</span><span class="ident" id="5392957">HeapObjects</span><span class="op" id="5392968">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392973">fmt</span><span class="op" id="5392976">.</span><span class="ident" id="5392977">Fprintf</span><span class="op" id="5392984">(</span><span class="ident" id="5392985">w</span><span class="op" id="5392986">,</span>&nbsp;<span class="string" id="5392988">&#34;#&nbsp;Stack&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="5393009">,</span>&nbsp;<span class="ident" id="5393011">s</span><span class="op" id="5393012">.</span><span class="ident" id="5393013">StackInuse</span><span class="op" id="5393023">,</span>&nbsp;<span class="ident" id="5393025">s</span><span class="op" id="5393026">.</span><span class="ident" id="5393027">StackSys</span><span class="op" id="5393035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393039">fmt</span><span class="op" id="5393042">.</span><span class="ident" id="5393043">Fprintf</span><span class="op" id="5393050">(</span><span class="ident" id="5393051">w</span><span class="op" id="5393052">,</span>&nbsp;<span class="string" id="5393054">&#34;#&nbsp;MSpan&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="5393075">,</span>&nbsp;<span class="ident" id="5393077">s</span><span class="op" id="5393078">.</span><span class="ident" id="5393079">MSpanInuse</span><span class="op" id="5393089">,</span>&nbsp;<span class="ident" id="5393091">s</span><span class="op" id="5393092">.</span><span class="ident" id="5393093">MSpanSys</span><span class="op" id="5393101">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393105">fmt</span><span class="op" id="5393108">.</span><span class="ident" id="5393109">Fprintf</span><span class="op" id="5393116">(</span><span class="ident" id="5393117">w</span><span class="op" id="5393118">,</span>&nbsp;<span class="string" id="5393120">&#34;#&nbsp;MCache&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="5393142">,</span>&nbsp;<span class="ident" id="5393144">s</span><span class="op" id="5393145">.</span><span class="ident" id="5393146">MCacheInuse</span><span class="op" id="5393157">,</span>&nbsp;<span class="ident" id="5393159">s</span><span class="op" id="5393160">.</span><span class="ident" id="5393161">MCacheSys</span><span class="op" id="5393170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393174">fmt</span><span class="op" id="5393177">.</span><span class="ident" id="5393178">Fprintf</span><span class="op" id="5393185">(</span><span class="ident" id="5393186">w</span><span class="op" id="5393187">,</span>&nbsp;<span class="string" id="5393189">&#34;#&nbsp;BuckHashSys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5393211">,</span>&nbsp;<span class="ident" id="5393213">s</span><span class="op" id="5393214">.</span><span class="ident" id="5393215">BuckHashSys</span><span class="op" id="5393226">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393231">fmt</span><span class="op" id="5393234">.</span><span class="ident" id="5393235">Fprintf</span><span class="op" id="5393242">(</span><span class="ident" id="5393243">w</span><span class="op" id="5393244">,</span>&nbsp;<span class="string" id="5393246">&#34;#&nbsp;NextGC&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5393263">,</span>&nbsp;<span class="ident" id="5393265">s</span><span class="op" id="5393266">.</span><span class="ident" id="5393267">NextGC</span><span class="op" id="5393273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393277">fmt</span><span class="op" id="5393280">.</span><span class="ident" id="5393281">Fprintf</span><span class="op" id="5393288">(</span><span class="ident" id="5393289">w</span><span class="op" id="5393290">,</span>&nbsp;<span class="string" id="5393292">&#34;#&nbsp;PauseNs&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5393310">,</span>&nbsp;<span class="ident" id="5393312">s</span><span class="op" id="5393313">.</span><span class="ident" id="5393314">PauseNs</span><span class="op" id="5393321">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393325">fmt</span><span class="op" id="5393328">.</span><span class="ident" id="5393329">Fprintf</span><span class="op" id="5393336">(</span><span class="ident" id="5393337">w</span><span class="op" id="5393338">,</span>&nbsp;<span class="string" id="5393340">&#34;#&nbsp;NumGC&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5393356">,</span>&nbsp;<span class="ident" id="5393358">s</span><span class="op" id="5393359">.</span><span class="ident" id="5393360">NumGC</span><span class="op" id="5393365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393369">fmt</span><span class="op" id="5393372">.</span><span class="ident" id="5393373">Fprintf</span><span class="op" id="5393380">(</span><span class="ident" id="5393381">w</span><span class="op" id="5393382">,</span>&nbsp;<span class="string" id="5393384">&#34;#&nbsp;EnableGC&nbsp;=&nbsp;%v\n&#34;</span><span class="op" id="5393403">,</span>&nbsp;<span class="ident" id="5393405">s</span><span class="op" id="5393406">.</span><span class="ident" id="5393407">EnableGC</span><span class="op" id="5393415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393419">fmt</span><span class="op" id="5393422">.</span><span class="ident" id="5393423">Fprintf</span><span class="op" id="5393430">(</span><span class="ident" id="5393431">w</span><span class="op" id="5393432">,</span>&nbsp;<span class="string" id="5393434">&#34;#&nbsp;DebugGC&nbsp;=&nbsp;%v\n&#34;</span><span class="op" id="5393452">,</span>&nbsp;<span class="ident" id="5393454">s</span><span class="op" id="5393455">.</span><span class="ident" id="5393456">DebugGC</span><span class="op" id="5393463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5393466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393470">if</span>&nbsp;<span class="ident" id="5393473">tw</span>&nbsp;<span class="op" id="5393476">!=</span>&nbsp;<span class="ident" id="5393479">nil</span>&nbsp;<span class="op" id="5393483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393487">tw</span><span class="op" id="5393489">.</span><span class="ident" id="5393490">Flush</span><span class="op" id="5393495">(</span><span class="op" id="5393496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5393499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393502">return</span>&nbsp;<span class="ident" id="5393509">b</span><span class="op" id="5393510">.</span><span class="ident" id="5393511">Flush</span><span class="op" id="5393516">(</span><span class="op" id="5393517">)</span><br>
<span class="lineno"></span><span class="op" id="5393519">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5393522">//&nbsp;countThreadCreate&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;current&nbsp;ThreadCreateProfile.</span><br>
<span class="lineno"></span><span class="keyword" id="5393596">func</span>&nbsp;<span class="ident" id="5393601">countThreadCreate</span><span class="op" id="5393618">(</span><span class="op" id="5393619">)</span>&nbsp;<span class="builtintype" id="5393621">int</span>&nbsp;<span class="op" id="5393625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393628">n</span><span class="op" id="5393629">,</span>&nbsp;<span class="ident" id="5393631">_</span>&nbsp;<span class="op" id="5393633">:=</span>&nbsp;<span class="ident" id="5393636">runtime</span><span class="op" id="5393643">.</span><span class="ident" id="5393644">ThreadCreateProfile</span><span class="op" id="5393663">(</span><span class="ident" id="5393664">nil</span><span class="op" id="5393667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393670">return</span>&nbsp;<span class="ident" id="5393677">n</span><br>
<span class="lineno">485</span><span class="op" id="5393679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5393682">//&nbsp;writeThreadCreate&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;ThreadCreateProfile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5393756">func</span>&nbsp;<span class="ident" id="5393761">writeThreadCreate</span><span class="op" id="5393778">(</span><span class="ident" id="5393779">w</span>&nbsp;<span class="ident" id="5393781">io</span><span class="op" id="5393783">.</span><span class="ident" id="5393784">Writer</span><span class="op" id="5393790">,</span>&nbsp;<span class="ident" id="5393792">debug</span>&nbsp;<span class="builtintype" id="5393798">int</span><span class="op" id="5393801">)</span>&nbsp;<span class="builtintype" id="5393803">error</span>&nbsp;<span class="op" id="5393809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393812">return</span>&nbsp;<span class="ident" id="5393819">writeRuntimeProfile</span><span class="op" id="5393838">(</span><span class="ident" id="5393839">w</span><span class="op" id="5393840">,</span>&nbsp;<span class="ident" id="5393842">debug</span><span class="op" id="5393847">,</span>&nbsp;<span class="string" id="5393849">&#34;threadcreate&#34;</span><span class="op" id="5393863">,</span>&nbsp;<span class="ident" id="5393865">runtime</span><span class="op" id="5393872">.</span><span class="ident" id="5393873">ThreadCreateProfile</span><span class="op" id="5393892">)</span><br>
<span class="lineno">490</span><span class="op" id="5393894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5393897">//&nbsp;countGoroutine&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5393949">func</span>&nbsp;<span class="ident" id="5393954">countGoroutine</span><span class="op" id="5393968">(</span><span class="op" id="5393969">)</span>&nbsp;<span class="builtintype" id="5393971">int</span>&nbsp;<span class="op" id="5393975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393978">return</span>&nbsp;<span class="ident" id="5393985">runtime</span><span class="op" id="5393992">.</span><span class="ident" id="5393993">NumGoroutine</span><span class="op" id="5394005">(</span><span class="op" id="5394006">)</span><br>
<span class="lineno">495</span><span class="op" id="5394008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5394011">//&nbsp;writeGoroutine&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;GoroutineProfile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5394079">func</span>&nbsp;<span class="ident" id="5394084">writeGoroutine</span><span class="op" id="5394098">(</span><span class="ident" id="5394099">w</span>&nbsp;<span class="ident" id="5394101">io</span><span class="op" id="5394103">.</span><span class="ident" id="5394104">Writer</span><span class="op" id="5394110">,</span>&nbsp;<span class="ident" id="5394112">debug</span>&nbsp;<span class="builtintype" id="5394118">int</span><span class="op" id="5394121">)</span>&nbsp;<span class="builtintype" id="5394123">error</span>&nbsp;<span class="op" id="5394129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394132">if</span>&nbsp;<span class="ident" id="5394135">debug</span>&nbsp;<span class="op" id="5394141">&gt;=</span>&nbsp;<span class="num" id="5394144">2</span>&nbsp;<span class="op" id="5394146">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394150">return</span>&nbsp;<span class="ident" id="5394157">writeGoroutineStacks</span><span class="op" id="5394177">(</span><span class="ident" id="5394178">w</span><span class="op" id="5394179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5394182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394185">return</span>&nbsp;<span class="ident" id="5394192">writeRuntimeProfile</span><span class="op" id="5394211">(</span><span class="ident" id="5394212">w</span><span class="op" id="5394213">,</span>&nbsp;<span class="ident" id="5394215">debug</span><span class="op" id="5394220">,</span>&nbsp;<span class="string" id="5394222">&#34;goroutine&#34;</span><span class="op" id="5394233">,</span>&nbsp;<span class="ident" id="5394235">runtime</span><span class="op" id="5394242">.</span><span class="ident" id="5394243">GoroutineProfile</span><span class="op" id="5394259">)</span><br>
<span class="lineno"></span><span class="op" id="5394261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="keyword" id="5394264">func</span>&nbsp;<span class="ident" id="5394269">writeGoroutineStacks</span><span class="op" id="5394289">(</span><span class="ident" id="5394290">w</span>&nbsp;<span class="ident" id="5394292">io</span><span class="op" id="5394294">.</span><span class="ident" id="5394295">Writer</span><span class="op" id="5394301">)</span>&nbsp;<span class="builtintype" id="5394303">error</span>&nbsp;<span class="op" id="5394309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5394312">//&nbsp;We&nbsp;don&#39;t&nbsp;know&nbsp;how&nbsp;big&nbsp;the&nbsp;buffer&nbsp;needs&nbsp;to&nbsp;be&nbsp;to&nbsp;collect</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5394372">//&nbsp;all&nbsp;the&nbsp;goroutines.&nbsp;&nbsp;Start&nbsp;with&nbsp;1&nbsp;MB&nbsp;and&nbsp;try&nbsp;a&nbsp;few&nbsp;times,&nbsp;doubling&nbsp;each&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5394454">//&nbsp;Give&nbsp;up&nbsp;and&nbsp;use&nbsp;a&nbsp;truncated&nbsp;trace&nbsp;if&nbsp;64&nbsp;MB&nbsp;is&nbsp;not&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394516">buf</span>&nbsp;<span class="op" id="5394520">:=</span>&nbsp;<span class="builtinfunc" id="5394523">make</span><span class="op" id="5394527">(</span><span class="op" id="5394528">[</span><span class="op" id="5394529">]</span><span class="builtintype" id="5394530">byte</span><span class="op" id="5394534">,</span>&nbsp;<span class="num" id="5394536">1</span><span class="op" id="5394537">&lt;&lt;</span><span class="num" id="5394539">20</span><span class="op" id="5394541">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394544">for</span>&nbsp;<span class="ident" id="5394548">i</span>&nbsp;<span class="op" id="5394550">:=</span>&nbsp;<span class="num" id="5394553">0</span><span class="op" id="5394554">;</span>&nbsp;<span class="op" id="5394556">;</span>&nbsp;<span class="ident" id="5394558">i</span><span class="op" id="5394559">++</span>&nbsp;<span class="op" id="5394562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394566">n</span>&nbsp;<span class="op" id="5394568">:=</span>&nbsp;<span class="ident" id="5394571">runtime</span><span class="op" id="5394578">.</span><span class="ident" id="5394579">Stack</span><span class="op" id="5394584">(</span><span class="ident" id="5394585">buf</span><span class="op" id="5394588">,</span>&nbsp;<span class="builtintype" id="5394590">true</span><span class="op" id="5394594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394598">if</span>&nbsp;<span class="ident" id="5394601">n</span>&nbsp;<span class="op" id="5394603">&lt;</span>&nbsp;<span class="builtinfunc" id="5394605">len</span><span class="op" id="5394608">(</span><span class="ident" id="5394609">buf</span><span class="op" id="5394612">)</span>&nbsp;<span class="op" id="5394614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394619">buf</span>&nbsp;<span class="op" id="5394623">=</span>&nbsp;<span class="ident" id="5394625">buf</span><span class="op" id="5394628">[</span><span class="op" id="5394629">:</span><span class="ident" id="5394630">n</span><span class="op" id="5394631">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394636">break</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5394644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394648">if</span>&nbsp;<span class="builtinfunc" id="5394651">len</span><span class="op" id="5394654">(</span><span class="ident" id="5394655">buf</span><span class="op" id="5394658">)</span>&nbsp;<span class="op" id="5394660">&gt;=</span>&nbsp;<span class="num" id="5394663">64</span><span class="op" id="5394665">&lt;&lt;</span><span class="num" id="5394667">20</span>&nbsp;<span class="op" id="5394670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5394675">//&nbsp;Filled&nbsp;64&nbsp;MB&nbsp;-&nbsp;stop&nbsp;there.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394708">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5394716">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394720">buf</span>&nbsp;<span class="op" id="5394724">=</span>&nbsp;<span class="builtinfunc" id="5394726">make</span><span class="op" id="5394730">(</span><span class="op" id="5394731">[</span><span class="op" id="5394732">]</span><span class="builtintype" id="5394733">byte</span><span class="op" id="5394737">,</span>&nbsp;<span class="num" id="5394739">2</span><span class="op" id="5394740">*</span><span class="builtinfunc" id="5394741">len</span><span class="op" id="5394744">(</span><span class="ident" id="5394745">buf</span><span class="op" id="5394748">)</span><span class="op" id="5394749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5394752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394755">_</span><span class="op" id="5394756">,</span>&nbsp;<span class="ident" id="5394758">err</span>&nbsp;<span class="op" id="5394762">:=</span>&nbsp;<span class="ident" id="5394765">w</span><span class="op" id="5394766">.</span><span class="ident" id="5394767">Write</span><span class="op" id="5394772">(</span><span class="ident" id="5394773">buf</span><span class="op" id="5394776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394779">return</span>&nbsp;<span class="ident" id="5394786">err</span><br>
<span class="lineno"></span><span class="op" id="5394790">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="keyword" id="5394793">func</span>&nbsp;<span class="ident" id="5394798">writeRuntimeProfile</span><span class="op" id="5394817">(</span><span class="ident" id="5394818">w</span>&nbsp;<span class="ident" id="5394820">io</span><span class="op" id="5394822">.</span><span class="ident" id="5394823">Writer</span><span class="op" id="5394829">,</span>&nbsp;<span class="ident" id="5394831">debug</span>&nbsp;<span class="builtintype" id="5394837">int</span><span class="op" id="5394840">,</span>&nbsp;<span class="ident" id="5394842">name</span>&nbsp;<span class="builtintype" id="5394847">string</span><span class="op" id="5394853">,</span>&nbsp;<span class="ident" id="5394855">fetch</span>&nbsp;<span class="keyword" id="5394861">func</span><span class="op" id="5394865">(</span><span class="op" id="5394866">[</span><span class="op" id="5394867">]</span><span class="ident" id="5394868">runtime</span><span class="op" id="5394875">.</span><span class="ident" id="5394876">StackRecord</span><span class="op" id="5394887">)</span>&nbsp;<span class="op" id="5394889">(</span><span class="builtintype" id="5394890">int</span><span class="op" id="5394893">,</span>&nbsp;<span class="builtintype" id="5394895">bool</span><span class="op" id="5394899">)</span><span class="op" id="5394900">)</span>&nbsp;<span class="builtintype" id="5394902">error</span>&nbsp;<span class="op" id="5394908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5394911">//&nbsp;Find&nbsp;out&nbsp;how&nbsp;many&nbsp;records&nbsp;there&nbsp;are&nbsp;(fetch(nil)),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5394965">//&nbsp;allocate&nbsp;that&nbsp;many&nbsp;records,&nbsp;and&nbsp;get&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5395015">//&nbsp;There&#39;s&nbsp;a&nbsp;race—more&nbsp;records&nbsp;might&nbsp;be&nbsp;added&nbsp;between</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5395072">//&nbsp;the&nbsp;two&nbsp;calls—so&nbsp;allocate&nbsp;a&nbsp;few&nbsp;extra&nbsp;records&nbsp;for&nbsp;safety</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5395135">//&nbsp;and&nbsp;also&nbsp;try&nbsp;again&nbsp;if&nbsp;we&#39;re&nbsp;very&nbsp;unlucky.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5395181">//&nbsp;The&nbsp;loop&nbsp;should&nbsp;only&nbsp;execute&nbsp;one&nbsp;iteration&nbsp;in&nbsp;the&nbsp;common&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5395248">var</span>&nbsp;<span class="ident" id="5395252">p</span>&nbsp;<span class="op" id="5395254">[</span><span class="op" id="5395255">]</span><span class="ident" id="5395256">runtime</span><span class="op" id="5395263">.</span><span class="ident" id="5395264">StackRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5395277">n</span><span class="op" id="5395278">,</span>&nbsp;<span class="ident" id="5395280">ok</span>&nbsp;<span class="op" id="5395283">:=</span>&nbsp;<span class="ident" id="5395286">fetch</span><span class="op" id="5395291">(</span><span class="ident" id="5395292">nil</span><span class="op" id="5395295">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5395298">for</span>&nbsp;<span class="op" id="5395302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5395306">//&nbsp;Allocate&nbsp;room&nbsp;for&nbsp;a&nbsp;slightly&nbsp;bigger&nbsp;profile,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5395356">//&nbsp;in&nbsp;case&nbsp;a&nbsp;few&nbsp;more&nbsp;entries&nbsp;have&nbsp;been&nbsp;added</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5395404">//&nbsp;since&nbsp;the&nbsp;call&nbsp;to&nbsp;ThreadProfile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5395442">p</span>&nbsp;<span class="op" id="5395444">=</span>&nbsp;<span class="builtinfunc" id="5395446">make</span><span class="op" id="5395450">(</span><span class="op" id="5395451">[</span><span class="op" id="5395452">]</span><span class="ident" id="5395453">runtime</span><span class="op" id="5395460">.</span><span class="ident" id="5395461">StackRecord</span><span class="op" id="5395472">,</span>&nbsp;<span class="ident" id="5395474">n</span><span class="op" id="5395475">+</span><span class="num" id="5395476">10</span><span class="op" id="5395478">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5395482">n</span><span class="op" id="5395483">,</span>&nbsp;<span class="ident" id="5395485">ok</span>&nbsp;<span class="op" id="5395488">=</span>&nbsp;<span class="ident" id="5395490">fetch</span><span class="op" id="5395495">(</span><span class="ident" id="5395496">p</span><span class="op" id="5395497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5395501">if</span>&nbsp;<span class="ident" id="5395504">ok</span>&nbsp;<span class="op" id="5395507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5395512">p</span>&nbsp;<span class="op" id="5395514">=</span>&nbsp;<span class="ident" id="5395516">p</span><span class="op" id="5395517">[</span><span class="num" id="5395518">0</span><span class="op" id="5395519">:</span><span class="ident" id="5395520">n</span><span class="op" id="5395521">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5395526">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5395534">}</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5395538">//&nbsp;Profile&nbsp;grew;&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5395567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5395571">return</span>&nbsp;<span class="ident" id="5395578">printCountProfile</span><span class="op" id="5395595">(</span><span class="ident" id="5395596">w</span><span class="op" id="5395597">,</span>&nbsp;<span class="ident" id="5395599">debug</span><span class="op" id="5395604">,</span>&nbsp;<span class="ident" id="5395606">name</span><span class="op" id="5395610">,</span>&nbsp;<span class="ident" id="5395612">runtimeProfile</span><span class="op" id="5395626">(</span><span class="ident" id="5395627">p</span><span class="op" id="5395628">)</span><span class="op" id="5395629">)</span><br>
<span class="lineno"></span><span class="op" id="5395631">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="5395634">type</span>&nbsp;<span class="ident" id="5395639">runtimeProfile</span>&nbsp;<span class="op" id="5395654">[</span><span class="op" id="5395655">]</span><span class="ident" id="5395656">runtime</span><span class="op" id="5395663">.</span><span class="ident" id="5395664">StackRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5395677">func</span>&nbsp;<span class="op" id="5395682">(</span><span class="ident" id="5395683">p</span>&nbsp;<span class="ident" id="5395685">runtimeProfile</span><span class="op" id="5395699">)</span>&nbsp;<span class="ident" id="5395701">Len</span><span class="op" id="5395704">(</span><span class="op" id="5395705">)</span>&nbsp;<span class="builtintype" id="5395707">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5395724">{</span>&nbsp;<span class="keyword" id="5395726">return</span>&nbsp;<span class="builtinfunc" id="5395733">len</span><span class="op" id="5395736">(</span><span class="ident" id="5395737">p</span><span class="op" id="5395738">)</span>&nbsp;<span class="op" id="5395740">}</span><br>
<span class="lineno"></span><span class="keyword" id="5395742">func</span>&nbsp;<span class="op" id="5395747">(</span><span class="ident" id="5395748">p</span>&nbsp;<span class="ident" id="5395750">runtimeProfile</span><span class="op" id="5395764">)</span>&nbsp;<span class="ident" id="5395766">Stack</span><span class="op" id="5395771">(</span><span class="ident" id="5395772">i</span>&nbsp;<span class="builtintype" id="5395774">int</span><span class="op" id="5395777">)</span>&nbsp;<span class="op" id="5395779">[</span><span class="op" id="5395780">]</span><span class="builtintype" id="5395781">uintptr</span>&nbsp;<span class="op" id="5395789">{</span>&nbsp;<span class="keyword" id="5395791">return</span>&nbsp;<span class="ident" id="5395798">p</span><span class="op" id="5395799">[</span><span class="ident" id="5395800">i</span><span class="op" id="5395801">]</span><span class="op" id="5395802">.</span><span class="ident" id="5395803">Stack</span><span class="op" id="5395808">(</span><span class="op" id="5395809">)</span>&nbsp;<span class="op" id="5395811">}</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span><span class="keyword" id="5395814">var</span>&nbsp;<span class="ident" id="5395818">cpu</span>&nbsp;<span class="keyword" id="5395822">struct</span>&nbsp;<span class="op" id="5395829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5395832">sync</span><span class="op" id="5395836">.</span><span class="ident" id="5395837">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5395844">profiling</span>&nbsp;<span class="builtintype" id="5395854">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5395860">done</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5395870">chan</span>&nbsp;<span class="builtintype" id="5395875">bool</span><br>
<span class="lineno">560</span><span class="op" id="5395880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5395883">//&nbsp;StartCPUProfile&nbsp;enables&nbsp;CPU&nbsp;profiling&nbsp;for&nbsp;the&nbsp;current&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="5395949">//&nbsp;While&nbsp;profiling,&nbsp;the&nbsp;profile&nbsp;will&nbsp;be&nbsp;buffered&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="5396016">//&nbsp;StartCPUProfile&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;profiling&nbsp;is&nbsp;already&nbsp;enabled.</span><br>
<span class="lineno">565</span><span class="keyword" id="5396085">func</span>&nbsp;<span class="ident" id="5396090">StartCPUProfile</span><span class="op" id="5396105">(</span><span class="ident" id="5396106">w</span>&nbsp;<span class="ident" id="5396108">io</span><span class="op" id="5396110">.</span><span class="ident" id="5396111">Writer</span><span class="op" id="5396117">)</span>&nbsp;<span class="builtintype" id="5396119">error</span>&nbsp;<span class="op" id="5396125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5396128">//&nbsp;The&nbsp;runtime&nbsp;routines&nbsp;allow&nbsp;a&nbsp;variable&nbsp;profiling&nbsp;rate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5396186">//&nbsp;but&nbsp;in&nbsp;practice&nbsp;operating&nbsp;systems&nbsp;cannot&nbsp;trigger&nbsp;signals</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5396247">//&nbsp;at&nbsp;more&nbsp;than&nbsp;about&nbsp;500&nbsp;Hz,&nbsp;and&nbsp;our&nbsp;processing&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5396304">//&nbsp;signal&nbsp;is&nbsp;not&nbsp;cheap&nbsp;(mostly&nbsp;getting&nbsp;the&nbsp;stack&nbsp;trace).</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5396362">//&nbsp;100&nbsp;Hz&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;choice:&nbsp;it&nbsp;is&nbsp;frequent&nbsp;enough&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5396422">//&nbsp;produce&nbsp;useful&nbsp;data,&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bog&nbsp;down&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5396479">//&nbsp;system,&nbsp;and&nbsp;a&nbsp;nice&nbsp;round&nbsp;number&nbsp;to&nbsp;make&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5396534">//&nbsp;convert&nbsp;sample&nbsp;counts&nbsp;to&nbsp;seconds.&nbsp;&nbsp;Instead&nbsp;of&nbsp;requiring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5396594">//&nbsp;each&nbsp;client&nbsp;to&nbsp;specify&nbsp;the&nbsp;frequency,&nbsp;we&nbsp;hard&nbsp;code&nbsp;it.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5396653">const</span>&nbsp;<span class="ident" id="5396659">hz</span>&nbsp;<span class="op" id="5396662">=</span>&nbsp;<span class="num" id="5396664">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5396670">cpu</span><span class="op" id="5396673">.</span><span class="ident" id="5396674">Lock</span><span class="op" id="5396678">(</span><span class="op" id="5396679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5396682">defer</span>&nbsp;<span class="ident" id="5396688">cpu</span><span class="op" id="5396691">.</span><span class="ident" id="5396692">Unlock</span><span class="op" id="5396698">(</span><span class="op" id="5396699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5396702">if</span>&nbsp;<span class="ident" id="5396705">cpu</span><span class="op" id="5396708">.</span><span class="ident" id="5396709">done</span>&nbsp;<span class="op" id="5396714">==</span>&nbsp;<span class="ident" id="5396717">nil</span>&nbsp;<span class="op" id="5396721">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5396725">cpu</span><span class="op" id="5396728">.</span><span class="ident" id="5396729">done</span>&nbsp;<span class="op" id="5396734">=</span>&nbsp;<span class="builtinfunc" id="5396736">make</span><span class="op" id="5396740">(</span><span class="keyword" id="5396741">chan</span>&nbsp;<span class="builtintype" id="5396746">bool</span><span class="op" id="5396750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5396753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5396756">//&nbsp;Double-check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5396774">if</span>&nbsp;<span class="ident" id="5396777">cpu</span><span class="op" id="5396780">.</span><span class="ident" id="5396781">profiling</span>&nbsp;<span class="op" id="5396791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5396795">return</span>&nbsp;<span class="ident" id="5396802">fmt</span><span class="op" id="5396805">.</span><span class="ident" id="5396806">Errorf</span><span class="op" id="5396812">(</span><span class="string" id="5396813">&#34;cpu&nbsp;profiling&nbsp;already&nbsp;in&nbsp;use&#34;</span><span class="op" id="5396843">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5396846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5396849">cpu</span><span class="op" id="5396852">.</span><span class="ident" id="5396853">profiling</span>&nbsp;<span class="op" id="5396863">=</span>&nbsp;<span class="builtintype" id="5396865">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5396871">runtime</span><span class="op" id="5396878">.</span><span class="ident" id="5396879">SetCPUProfileRate</span><span class="op" id="5396896">(</span><span class="ident" id="5396897">hz</span><span class="op" id="5396899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5396902">go</span>&nbsp;<span class="ident" id="5396905">profileWriter</span><span class="op" id="5396918">(</span><span class="ident" id="5396919">w</span><span class="op" id="5396920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5396923">return</span>&nbsp;<span class="ident" id="5396930">nil</span><br>
<span class="lineno">590</span><span class="op" id="5396934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5396937">func</span>&nbsp;<span class="ident" id="5396942">profileWriter</span><span class="op" id="5396955">(</span><span class="ident" id="5396956">w</span>&nbsp;<span class="ident" id="5396958">io</span><span class="op" id="5396960">.</span><span class="ident" id="5396961">Writer</span><span class="op" id="5396967">)</span>&nbsp;<span class="op" id="5396969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5396972">for</span>&nbsp;<span class="op" id="5396976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5396980">data</span>&nbsp;<span class="op" id="5396985">:=</span>&nbsp;<span class="ident" id="5396988">runtime</span><span class="op" id="5396995">.</span><span class="ident" id="5396996">CPUProfile</span><span class="op" id="5397006">(</span><span class="op" id="5397007">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5397011">if</span>&nbsp;<span class="ident" id="5397014">data</span>&nbsp;<span class="op" id="5397019">==</span>&nbsp;<span class="ident" id="5397022">nil</span>&nbsp;<span class="op" id="5397026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5397031">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5397039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397043">w</span><span class="op" id="5397044">.</span><span class="ident" id="5397045">Write</span><span class="op" id="5397050">(</span><span class="ident" id="5397051">data</span><span class="op" id="5397055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5397058">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397061">cpu</span><span class="op" id="5397064">.</span><span class="ident" id="5397065">done</span>&nbsp;<span class="op" id="5397070">&lt;-</span>&nbsp;<span class="builtintype" id="5397073">true</span><br>
<span class="lineno"></span><span class="op" id="5397078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5397081">//&nbsp;StopCPUProfile&nbsp;stops&nbsp;the&nbsp;current&nbsp;CPU&nbsp;profile,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span><span class="comment" id="5397138">//&nbsp;StopCPUProfile&nbsp;only&nbsp;returns&nbsp;after&nbsp;all&nbsp;the&nbsp;writes&nbsp;for&nbsp;the</span><br>
<span class="lineno">605</span><span class="comment" id="5397198">//&nbsp;profile&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="5397225">func</span>&nbsp;<span class="ident" id="5397230">StopCPUProfile</span><span class="op" id="5397244">(</span><span class="op" id="5397245">)</span>&nbsp;<span class="op" id="5397247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397250">cpu</span><span class="op" id="5397253">.</span><span class="ident" id="5397254">Lock</span><span class="op" id="5397258">(</span><span class="op" id="5397259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5397262">defer</span>&nbsp;<span class="ident" id="5397268">cpu</span><span class="op" id="5397271">.</span><span class="ident" id="5397272">Unlock</span><span class="op" id="5397278">(</span><span class="op" id="5397279">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5397283">if</span>&nbsp;<span class="op" id="5397286">!</span><span class="ident" id="5397287">cpu</span><span class="op" id="5397290">.</span><span class="ident" id="5397291">profiling</span>&nbsp;<span class="op" id="5397301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5397305">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5397313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397316">cpu</span><span class="op" id="5397319">.</span><span class="ident" id="5397320">profiling</span>&nbsp;<span class="op" id="5397330">=</span>&nbsp;<span class="builtintype" id="5397332">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397339">runtime</span><span class="op" id="5397346">.</span><span class="ident" id="5397347">SetCPUProfileRate</span><span class="op" id="5397364">(</span><span class="num" id="5397365">0</span><span class="op" id="5397366">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5397369">&lt;-</span><span class="ident" id="5397371">cpu</span><span class="op" id="5397374">.</span><span class="ident" id="5397375">done</span><br>
<span class="lineno"></span><span class="op" id="5397380">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5397383">type</span>&nbsp;<span class="ident" id="5397388">byCycles</span>&nbsp;<span class="op" id="5397397">[</span><span class="op" id="5397398">]</span><span class="ident" id="5397399">runtime</span><span class="op" id="5397406">.</span><span class="ident" id="5397407">BlockProfileRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="5397427">func</span>&nbsp;<span class="op" id="5397432">(</span><span class="ident" id="5397433">x</span>&nbsp;<span class="ident" id="5397435">byCycles</span><span class="op" id="5397443">)</span>&nbsp;<span class="ident" id="5397445">Len</span><span class="op" id="5397448">(</span><span class="op" id="5397449">)</span>&nbsp;<span class="builtintype" id="5397451">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5397465">{</span>&nbsp;<span class="keyword" id="5397467">return</span>&nbsp;<span class="builtinfunc" id="5397474">len</span><span class="op" id="5397477">(</span><span class="ident" id="5397478">x</span><span class="op" id="5397479">)</span>&nbsp;<span class="op" id="5397481">}</span><br>
<span class="lineno"></span><span class="keyword" id="5397483">func</span>&nbsp;<span class="op" id="5397488">(</span><span class="ident" id="5397489">x</span>&nbsp;<span class="ident" id="5397491">byCycles</span><span class="op" id="5397499">)</span>&nbsp;<span class="ident" id="5397501">Swap</span><span class="op" id="5397505">(</span><span class="ident" id="5397506">i</span><span class="op" id="5397507">,</span>&nbsp;<span class="ident" id="5397509">j</span>&nbsp;<span class="builtintype" id="5397511">int</span><span class="op" id="5397514">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5397521">{</span>&nbsp;<span class="ident" id="5397523">x</span><span class="op" id="5397524">[</span><span class="ident" id="5397525">i</span><span class="op" id="5397526">]</span><span class="op" id="5397527">,</span>&nbsp;<span class="ident" id="5397529">x</span><span class="op" id="5397530">[</span><span class="ident" id="5397531">j</span><span class="op" id="5397532">]</span>&nbsp;<span class="op" id="5397534">=</span>&nbsp;<span class="ident" id="5397536">x</span><span class="op" id="5397537">[</span><span class="ident" id="5397538">j</span><span class="op" id="5397539">]</span><span class="op" id="5397540">,</span>&nbsp;<span class="ident" id="5397542">x</span><span class="op" id="5397543">[</span><span class="ident" id="5397544">i</span><span class="op" id="5397545">]</span>&nbsp;<span class="op" id="5397547">}</span><br>
<span class="lineno"></span><span class="keyword" id="5397549">func</span>&nbsp;<span class="op" id="5397554">(</span><span class="ident" id="5397555">x</span>&nbsp;<span class="ident" id="5397557">byCycles</span><span class="op" id="5397565">)</span>&nbsp;<span class="ident" id="5397567">Less</span><span class="op" id="5397571">(</span><span class="ident" id="5397572">i</span><span class="op" id="5397573">,</span>&nbsp;<span class="ident" id="5397575">j</span>&nbsp;<span class="builtintype" id="5397577">int</span><span class="op" id="5397580">)</span>&nbsp;<span class="builtintype" id="5397582">bool</span>&nbsp;<span class="op" id="5397587">{</span>&nbsp;<span class="keyword" id="5397589">return</span>&nbsp;<span class="ident" id="5397596">x</span><span class="op" id="5397597">[</span><span class="ident" id="5397598">i</span><span class="op" id="5397599">]</span><span class="op" id="5397600">.</span><span class="ident" id="5397601">Cycles</span>&nbsp;<span class="op" id="5397608">&gt;</span>&nbsp;<span class="ident" id="5397610">x</span><span class="op" id="5397611">[</span><span class="ident" id="5397612">j</span><span class="op" id="5397613">]</span><span class="op" id="5397614">.</span><span class="ident" id="5397615">Cycles</span>&nbsp;<span class="op" id="5397622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5397625">//&nbsp;countBlock&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno">625</span><span class="keyword" id="5397694">func</span>&nbsp;<span class="ident" id="5397699">countBlock</span><span class="op" id="5397709">(</span><span class="op" id="5397710">)</span>&nbsp;<span class="builtintype" id="5397712">int</span>&nbsp;<span class="op" id="5397716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397719">n</span><span class="op" id="5397720">,</span>&nbsp;<span class="ident" id="5397722">_</span>&nbsp;<span class="op" id="5397724">:=</span>&nbsp;<span class="ident" id="5397727">runtime</span><span class="op" id="5397734">.</span><span class="ident" id="5397735">BlockProfile</span><span class="op" id="5397747">(</span><span class="ident" id="5397748">nil</span><span class="op" id="5397751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5397754">return</span>&nbsp;<span class="ident" id="5397761">n</span><br>
<span class="lineno"></span><span class="op" id="5397763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="comment" id="5397766">//&nbsp;writeBlock&nbsp;writes&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5397822">func</span>&nbsp;<span class="ident" id="5397827">writeBlock</span><span class="op" id="5397837">(</span><span class="ident" id="5397838">w</span>&nbsp;<span class="ident" id="5397840">io</span><span class="op" id="5397842">.</span><span class="ident" id="5397843">Writer</span><span class="op" id="5397849">,</span>&nbsp;<span class="ident" id="5397851">debug</span>&nbsp;<span class="builtintype" id="5397857">int</span><span class="op" id="5397860">)</span>&nbsp;<span class="builtintype" id="5397862">error</span>&nbsp;<span class="op" id="5397868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5397871">var</span>&nbsp;<span class="ident" id="5397875">p</span>&nbsp;<span class="op" id="5397877">[</span><span class="op" id="5397878">]</span><span class="ident" id="5397879">runtime</span><span class="op" id="5397886">.</span><span class="ident" id="5397887">BlockProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397907">n</span><span class="op" id="5397908">,</span>&nbsp;<span class="ident" id="5397910">ok</span>&nbsp;<span class="op" id="5397913">:=</span>&nbsp;<span class="ident" id="5397916">runtime</span><span class="op" id="5397923">.</span><span class="ident" id="5397924">BlockProfile</span><span class="op" id="5397936">(</span><span class="ident" id="5397937">nil</span><span class="op" id="5397940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5397943">for</span>&nbsp;<span class="op" id="5397947">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397951">p</span>&nbsp;<span class="op" id="5397953">=</span>&nbsp;<span class="builtinfunc" id="5397955">make</span><span class="op" id="5397959">(</span><span class="op" id="5397960">[</span><span class="op" id="5397961">]</span><span class="ident" id="5397962">runtime</span><span class="op" id="5397969">.</span><span class="ident" id="5397970">BlockProfileRecord</span><span class="op" id="5397988">,</span>&nbsp;<span class="ident" id="5397990">n</span><span class="op" id="5397991">+</span><span class="num" id="5397992">50</span><span class="op" id="5397994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397998">n</span><span class="op" id="5397999">,</span>&nbsp;<span class="ident" id="5398001">ok</span>&nbsp;<span class="op" id="5398004">=</span>&nbsp;<span class="ident" id="5398006">runtime</span><span class="op" id="5398013">.</span><span class="ident" id="5398014">BlockProfile</span><span class="op" id="5398026">(</span><span class="ident" id="5398027">p</span><span class="op" id="5398028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5398032">if</span>&nbsp;<span class="ident" id="5398035">ok</span>&nbsp;<span class="op" id="5398038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398043">p</span>&nbsp;<span class="op" id="5398045">=</span>&nbsp;<span class="ident" id="5398047">p</span><span class="op" id="5398048">[</span><span class="op" id="5398049">:</span><span class="ident" id="5398050">n</span><span class="op" id="5398051">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5398056">break</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5398064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5398067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398071">sort</span><span class="op" id="5398075">.</span><span class="ident" id="5398076">Sort</span><span class="op" id="5398080">(</span><span class="ident" id="5398081">byCycles</span><span class="op" id="5398089">(</span><span class="ident" id="5398090">p</span><span class="op" id="5398091">)</span><span class="op" id="5398092">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398096">b</span>&nbsp;<span class="op" id="5398098">:=</span>&nbsp;<span class="ident" id="5398101">bufio</span><span class="op" id="5398106">.</span><span class="ident" id="5398107">NewWriter</span><span class="op" id="5398116">(</span><span class="ident" id="5398117">w</span><span class="op" id="5398118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5398121">var</span>&nbsp;<span class="ident" id="5398125">tw</span>&nbsp;<span class="op" id="5398128">*</span><span class="ident" id="5398129">tabwriter</span><span class="op" id="5398138">.</span><span class="ident" id="5398139">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398147">w</span>&nbsp;<span class="op" id="5398149">=</span>&nbsp;<span class="ident" id="5398151">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5398154">if</span>&nbsp;<span class="ident" id="5398157">debug</span>&nbsp;<span class="op" id="5398163">&gt;</span>&nbsp;<span class="num" id="5398165">0</span>&nbsp;<span class="op" id="5398167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398171">tw</span>&nbsp;<span class="op" id="5398174">=</span>&nbsp;<span class="ident" id="5398176">tabwriter</span><span class="op" id="5398185">.</span><span class="ident" id="5398186">NewWriter</span><span class="op" id="5398195">(</span><span class="ident" id="5398196">w</span><span class="op" id="5398197">,</span>&nbsp;<span class="num" id="5398199">1</span><span class="op" id="5398200">,</span>&nbsp;<span class="num" id="5398202">8</span><span class="op" id="5398203">,</span>&nbsp;<span class="num" id="5398205">1</span><span class="op" id="5398206">,</span>&nbsp;<span class="string" id="5398208">&#39;\t&#39;</span><span class="op" id="5398212">,</span>&nbsp;<span class="num" id="5398214">0</span><span class="op" id="5398215">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398219">w</span>&nbsp;<span class="op" id="5398221">=</span>&nbsp;<span class="ident" id="5398223">tw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5398227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398231">fmt</span><span class="op" id="5398234">.</span><span class="ident" id="5398235">Fprintf</span><span class="op" id="5398242">(</span><span class="ident" id="5398243">w</span><span class="op" id="5398244">,</span>&nbsp;<span class="string" id="5398246">&#34;---&nbsp;contention:\n&#34;</span><span class="op" id="5398265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398268">fmt</span><span class="op" id="5398271">.</span><span class="ident" id="5398272">Fprintf</span><span class="op" id="5398279">(</span><span class="ident" id="5398280">w</span><span class="op" id="5398281">,</span>&nbsp;<span class="string" id="5398283">&#34;cycles/second=%v\n&#34;</span><span class="op" id="5398303">,</span>&nbsp;<span class="ident" id="5398305">runtime_cyclesPerSecond</span><span class="op" id="5398328">(</span><span class="op" id="5398329">)</span><span class="op" id="5398330">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5398333">for</span>&nbsp;<span class="ident" id="5398337">i</span>&nbsp;<span class="op" id="5398339">:=</span>&nbsp;<span class="keyword" id="5398342">range</span>&nbsp;<span class="ident" id="5398348">p</span>&nbsp;<span class="op" id="5398350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398354">r</span>&nbsp;<span class="op" id="5398356">:=</span>&nbsp;<span class="op" id="5398359">&amp;</span><span class="ident" id="5398360">p</span><span class="op" id="5398361">[</span><span class="ident" id="5398362">i</span><span class="op" id="5398363">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398367">fmt</span><span class="op" id="5398370">.</span><span class="ident" id="5398371">Fprintf</span><span class="op" id="5398378">(</span><span class="ident" id="5398379">w</span><span class="op" id="5398380">,</span>&nbsp;<span class="string" id="5398382">&#34;%v&nbsp;%v&nbsp;@&#34;</span><span class="op" id="5398391">,</span>&nbsp;<span class="ident" id="5398393">r</span><span class="op" id="5398394">.</span><span class="ident" id="5398395">Cycles</span><span class="op" id="5398401">,</span>&nbsp;<span class="ident" id="5398403">r</span><span class="op" id="5398404">.</span><span class="ident" id="5398405">Count</span><span class="op" id="5398410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5398414">for</span>&nbsp;<span class="ident" id="5398418">_</span><span class="op" id="5398419">,</span>&nbsp;<span class="ident" id="5398421">pc</span>&nbsp;<span class="op" id="5398424">:=</span>&nbsp;<span class="keyword" id="5398427">range</span>&nbsp;<span class="ident" id="5398433">r</span><span class="op" id="5398434">.</span><span class="ident" id="5398435">Stack</span><span class="op" id="5398440">(</span><span class="op" id="5398441">)</span>&nbsp;<span class="op" id="5398443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398448">fmt</span><span class="op" id="5398451">.</span><span class="ident" id="5398452">Fprintf</span><span class="op" id="5398459">(</span><span class="ident" id="5398460">w</span><span class="op" id="5398461">,</span>&nbsp;<span class="string" id="5398463">&#34;&nbsp;%#x&#34;</span><span class="op" id="5398469">,</span>&nbsp;<span class="ident" id="5398471">pc</span><span class="op" id="5398473">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5398477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398481">fmt</span><span class="op" id="5398484">.</span><span class="ident" id="5398485">Fprint</span><span class="op" id="5398491">(</span><span class="ident" id="5398492">w</span><span class="op" id="5398493">,</span>&nbsp;<span class="string" id="5398495">&#34;\n&#34;</span><span class="op" id="5398499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5398503">if</span>&nbsp;<span class="ident" id="5398506">debug</span>&nbsp;<span class="op" id="5398512">&gt;</span>&nbsp;<span class="num" id="5398514">0</span>&nbsp;<span class="op" id="5398516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398521">printStackRecord</span><span class="op" id="5398537">(</span><span class="ident" id="5398538">w</span><span class="op" id="5398539">,</span>&nbsp;<span class="ident" id="5398541">r</span><span class="op" id="5398542">.</span><span class="ident" id="5398543">Stack</span><span class="op" id="5398548">(</span><span class="op" id="5398549">)</span><span class="op" id="5398550">,</span>&nbsp;<span class="builtintype" id="5398552">true</span><span class="op" id="5398556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5398560">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5398563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5398567">if</span>&nbsp;<span class="ident" id="5398570">tw</span>&nbsp;<span class="op" id="5398573">!=</span>&nbsp;<span class="ident" id="5398576">nil</span>&nbsp;<span class="op" id="5398580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398584">tw</span><span class="op" id="5398586">.</span><span class="ident" id="5398587">Flush</span><span class="op" id="5398592">(</span><span class="op" id="5398593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5398596">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5398599">return</span>&nbsp;<span class="ident" id="5398606">b</span><span class="op" id="5398607">.</span><span class="ident" id="5398608">Flush</span><span class="op" id="5398613">(</span><span class="op" id="5398614">)</span><br>
<span class="lineno"></span><span class="op" id="5398616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5398619">func</span>&nbsp;<span class="ident" id="5398624">runtime_cyclesPerSecond</span><span class="op" id="5398647">(</span><span class="op" id="5398648">)</span>&nbsp;<span class="ident" id="5398650">int64</span>
</div>
</body>
</html>
