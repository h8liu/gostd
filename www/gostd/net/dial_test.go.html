<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html" class="current">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6569243">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6569298">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6569352">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6569403">package</span>&nbsp;<span class="ident" id="6569411">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6569416">import</span>&nbsp;<span class="op" id="6569423">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569426">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569435">&#34;flag&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569443">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569450">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569456">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569462">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569473">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569484">&#34;regexp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569494">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569505">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569516">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569524">&#34;testing&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569535">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6569542">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6569545">func</span>&nbsp;<span class="ident" id="6569550">newLocalListener</span><span class="op" id="6569566">(</span><span class="ident" id="6569567">t</span>&nbsp;<span class="op" id="6569569">*</span><span class="ident" id="6569570">testing</span><span class="op" id="6569577">.</span><span class="ident" id="6569578">T</span><span class="op" id="6569579">)</span>&nbsp;<span class="ident" id="6569581">Listener</span>&nbsp;<span class="op" id="6569590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6569593">ln</span><span class="op" id="6569595">,</span>&nbsp;<span class="ident" id="6569597">err</span>&nbsp;<span class="op" id="6569601">:=</span>&nbsp;<span class="ident" id="6569604">Listen</span><span class="op" id="6569610">(</span><span class="string" id="6569611">&#34;tcp&#34;</span><span class="op" id="6569616">,</span>&nbsp;<span class="string" id="6569618">&#34;127.0.0.1:0&#34;</span><span class="op" id="6569631">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6569634">if</span>&nbsp;<span class="ident" id="6569637">err</span>&nbsp;<span class="op" id="6569641">!=</span>&nbsp;<span class="ident" id="6569644">nil</span>&nbsp;<span class="op" id="6569648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6569652">ln</span><span class="op" id="6569654">,</span>&nbsp;<span class="ident" id="6569656">err</span>&nbsp;<span class="op" id="6569660">=</span>&nbsp;<span class="ident" id="6569662">Listen</span><span class="op" id="6569668">(</span><span class="string" id="6569669">&#34;tcp6&#34;</span><span class="op" id="6569675">,</span>&nbsp;<span class="string" id="6569677">&#34;[::1]:0&#34;</span><span class="op" id="6569686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6569689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6569692">if</span>&nbsp;<span class="ident" id="6569695">err</span>&nbsp;<span class="op" id="6569699">!=</span>&nbsp;<span class="ident" id="6569702">nil</span>&nbsp;<span class="op" id="6569706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6569710">t</span><span class="op" id="6569711">.</span><span class="ident" id="6569712">Fatal</span><span class="op" id="6569717">(</span><span class="ident" id="6569718">err</span><span class="op" id="6569721">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6569724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6569727">return</span>&nbsp;<span class="ident" id="6569734">ln</span><br>
<span class="lineno"></span><span class="op" id="6569737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6569740">func</span>&nbsp;<span class="ident" id="6569745">TestDialTimeout</span><span class="op" id="6569760">(</span><span class="ident" id="6569761">t</span>&nbsp;<span class="op" id="6569763">*</span><span class="ident" id="6569764">testing</span><span class="op" id="6569771">.</span><span class="ident" id="6569772">T</span><span class="op" id="6569773">)</span>&nbsp;<span class="op" id="6569775">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6569778">origBacklog</span>&nbsp;<span class="op" id="6569790">:=</span>&nbsp;<span class="ident" id="6569793">listenerBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6569810">defer</span>&nbsp;<span class="keyword" id="6569816">func</span><span class="op" id="6569820">(</span><span class="op" id="6569821">)</span>&nbsp;<span class="op" id="6569823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6569827">listenerBacklog</span>&nbsp;<span class="op" id="6569843">=</span>&nbsp;<span class="ident" id="6569845">origBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6569858">}</span><span class="op" id="6569859">(</span><span class="op" id="6569860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6569863">listenerBacklog</span>&nbsp;<span class="op" id="6569879">=</span>&nbsp;<span class="num" id="6569881">1</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6569885">ln</span>&nbsp;<span class="op" id="6569888">:=</span>&nbsp;<span class="ident" id="6569891">newLocalListener</span><span class="op" id="6569907">(</span><span class="ident" id="6569908">t</span><span class="op" id="6569909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6569912">defer</span>&nbsp;<span class="ident" id="6569918">ln</span><span class="op" id="6569920">.</span><span class="ident" id="6569921">Close</span><span class="op" id="6569926">(</span><span class="op" id="6569927">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6569931">errc</span>&nbsp;<span class="op" id="6569936">:=</span>&nbsp;<span class="builtinfunc" id="6569939">make</span><span class="op" id="6569943">(</span><span class="keyword" id="6569944">chan</span>&nbsp;<span class="builtintype" id="6569949">error</span><span class="op" id="6569954">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6569958">numConns</span>&nbsp;<span class="op" id="6569967">:=</span>&nbsp;<span class="ident" id="6569970">listenerBacklog</span>&nbsp;<span class="op" id="6569986">+</span>&nbsp;<span class="num" id="6569988">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6569994">//&nbsp;TODO(bradfitz):&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;test&nbsp;this&nbsp;in&nbsp;a&nbsp;portable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570051">//&nbsp;way.&nbsp;This&nbsp;is&nbsp;unfortunate,&nbsp;but&nbsp;works&nbsp;for&nbsp;now.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6570100">switch</span>&nbsp;<span class="ident" id="6570107">runtime</span><span class="op" id="6570114">.</span><span class="ident" id="6570115">GOOS</span>&nbsp;<span class="op" id="6570120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6570123">case</span>&nbsp;<span class="string" id="6570128">&#34;linux&#34;</span><span class="op" id="6570135">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570139">//&nbsp;The&nbsp;kernel&nbsp;will&nbsp;start&nbsp;accepting&nbsp;TCP&nbsp;connections&nbsp;before&nbsp;userspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570209">//&nbsp;gets&nbsp;a&nbsp;chance&nbsp;to&nbsp;not&nbsp;accept&nbsp;them,&nbsp;so&nbsp;fire&nbsp;off&nbsp;a&nbsp;bunch&nbsp;to&nbsp;fill&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570279">//&nbsp;the&nbsp;kernel&#39;s&nbsp;backlog.&nbsp;&nbsp;Then&nbsp;we&nbsp;test&nbsp;we&nbsp;get&nbsp;a&nbsp;failure&nbsp;after&nbsp;that.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6570349">for</span>&nbsp;<span class="ident" id="6570353">i</span>&nbsp;<span class="op" id="6570355">:=</span>&nbsp;<span class="num" id="6570358">0</span><span class="op" id="6570359">;</span>&nbsp;<span class="ident" id="6570361">i</span>&nbsp;<span class="op" id="6570363">&lt;</span>&nbsp;<span class="ident" id="6570365">numConns</span><span class="op" id="6570373">;</span>&nbsp;<span class="ident" id="6570375">i</span><span class="op" id="6570376">++</span>&nbsp;<span class="op" id="6570379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6570384">go</span>&nbsp;<span class="keyword" id="6570387">func</span><span class="op" id="6570391">(</span><span class="op" id="6570392">)</span>&nbsp;<span class="op" id="6570394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6570400">_</span><span class="op" id="6570401">,</span>&nbsp;<span class="ident" id="6570403">err</span>&nbsp;<span class="op" id="6570407">:=</span>&nbsp;<span class="ident" id="6570410">DialTimeout</span><span class="op" id="6570421">(</span><span class="string" id="6570422">&#34;tcp&#34;</span><span class="op" id="6570427">,</span>&nbsp;<span class="ident" id="6570429">ln</span><span class="op" id="6570431">.</span><span class="ident" id="6570432">Addr</span><span class="op" id="6570436">(</span><span class="op" id="6570437">)</span><span class="op" id="6570438">.</span><span class="ident" id="6570439">String</span><span class="op" id="6570445">(</span><span class="op" id="6570446">)</span><span class="op" id="6570447">,</span>&nbsp;<span class="num" id="6570449">200</span><span class="op" id="6570452">*</span><span class="ident" id="6570453">time</span><span class="op" id="6570457">.</span><span class="ident" id="6570458">Millisecond</span><span class="op" id="6570469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6570475">errc</span>&nbsp;<span class="op" id="6570480">&lt;-</span>&nbsp;<span class="ident" id="6570483">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6570490">}</span><span class="op" id="6570491">(</span><span class="op" id="6570492">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6570496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6570499">case</span>&nbsp;<span class="string" id="6570504">&#34;darwin&#34;</span><span class="op" id="6570512">,</span>&nbsp;<span class="string" id="6570514">&#34;plan9&#34;</span><span class="op" id="6570521">,</span>&nbsp;<span class="string" id="6570523">&#34;windows&#34;</span><span class="op" id="6570532">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570536">//&nbsp;At&nbsp;least&nbsp;OS&nbsp;X&nbsp;10.7&nbsp;seems&nbsp;to&nbsp;accept&nbsp;any&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570590">//&nbsp;connections,&nbsp;ignoring&nbsp;listen&#39;s&nbsp;backlog,&nbsp;so&nbsp;resort</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570645">//&nbsp;to&nbsp;connecting&nbsp;to&nbsp;a&nbsp;hopefully-dead&nbsp;127/8&nbsp;address.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570699">//&nbsp;Same&nbsp;for&nbsp;windows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570722">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570727">//&nbsp;Use&nbsp;an&nbsp;IANA&nbsp;reserved&nbsp;port&nbsp;(49151)&nbsp;instead&nbsp;of&nbsp;80,&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570789">//&nbsp;on&nbsp;our&nbsp;386&nbsp;builder,&nbsp;this&nbsp;Dial&nbsp;succeeds,&nbsp;connecting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570845">//&nbsp;to&nbsp;an&nbsp;IIS&nbsp;web&nbsp;server&nbsp;somewhere.&nbsp;&nbsp;The&nbsp;data&nbsp;center</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570899">//&nbsp;or&nbsp;VM&nbsp;or&nbsp;firewall&nbsp;must&nbsp;be&nbsp;stealing&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570959">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570964">//&nbsp;IANA&nbsp;Service&nbsp;Name&nbsp;and&nbsp;Transport&nbsp;Protocol&nbsp;Port&nbsp;Number&nbsp;Registry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6571031">//&nbsp;&lt;http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xml&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571128">go</span>&nbsp;<span class="keyword" id="6571131">func</span><span class="op" id="6571135">(</span><span class="op" id="6571136">)</span>&nbsp;<span class="op" id="6571138">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571143">c</span><span class="op" id="6571144">,</span>&nbsp;<span class="ident" id="6571146">err</span>&nbsp;<span class="op" id="6571150">:=</span>&nbsp;<span class="ident" id="6571153">DialTimeout</span><span class="op" id="6571164">(</span><span class="string" id="6571165">&#34;tcp&#34;</span><span class="op" id="6571170">,</span>&nbsp;<span class="string" id="6571172">&#34;127.0.71.111:49151&#34;</span><span class="op" id="6571192">,</span>&nbsp;<span class="num" id="6571194">200</span><span class="op" id="6571197">*</span><span class="ident" id="6571198">time</span><span class="op" id="6571202">.</span><span class="ident" id="6571203">Millisecond</span><span class="op" id="6571214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571219">if</span>&nbsp;<span class="ident" id="6571222">err</span>&nbsp;<span class="op" id="6571226">==</span>&nbsp;<span class="ident" id="6571229">nil</span>&nbsp;<span class="op" id="6571233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571239">err</span>&nbsp;<span class="op" id="6571243">=</span>&nbsp;<span class="ident" id="6571245">fmt</span><span class="op" id="6571248">.</span><span class="ident" id="6571249">Errorf</span><span class="op" id="6571255">(</span><span class="string" id="6571256">&#34;unexpected:&nbsp;connected&nbsp;to&nbsp;%s!&#34;</span><span class="op" id="6571286">,</span>&nbsp;<span class="ident" id="6571288">c</span><span class="op" id="6571289">.</span><span class="ident" id="6571290">RemoteAddr</span><span class="op" id="6571300">(</span><span class="op" id="6571301">)</span><span class="op" id="6571302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571308">c</span><span class="op" id="6571309">.</span><span class="ident" id="6571310">Close</span><span class="op" id="6571315">(</span><span class="op" id="6571316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571321">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571326">errc</span>&nbsp;<span class="op" id="6571331">&lt;-</span>&nbsp;<span class="ident" id="6571334">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571340">}</span><span class="op" id="6571341">(</span><span class="op" id="6571342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571345">default</span><span class="op" id="6571352">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6571356">//&nbsp;TODO(bradfitz):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6571377">//&nbsp;OpenBSD&nbsp;may&nbsp;have&nbsp;a&nbsp;reject&nbsp;route&nbsp;to&nbsp;127/8&nbsp;except&nbsp;127.0.0.1/32</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6571443">//&nbsp;by&nbsp;default.&nbsp;FreeBSD&nbsp;likely&nbsp;works,&nbsp;but&nbsp;is&nbsp;untested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6571499">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6571515">//&nbsp;The&nbsp;timeout&nbsp;never&nbsp;happens&nbsp;on&nbsp;Windows.&nbsp;&nbsp;Why?&nbsp;&nbsp;Issue&nbsp;3016.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571577">t</span><span class="op" id="6571578">.</span><span class="ident" id="6571579">Skipf</span><span class="op" id="6571584">(</span><span class="string" id="6571585">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q;&nbsp;untested.&#34;</span><span class="op" id="6571617">,</span>&nbsp;<span class="ident" id="6571619">runtime</span><span class="op" id="6571626">.</span><span class="ident" id="6571627">GOOS</span><span class="op" id="6571631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571634">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571638">connected</span>&nbsp;<span class="op" id="6571648">:=</span>&nbsp;<span class="num" id="6571651">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571654">for</span>&nbsp;<span class="op" id="6571658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571662">select</span>&nbsp;<span class="op" id="6571669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571673">case</span>&nbsp;<span class="op" id="6571678">&lt;-</span><span class="ident" id="6571680">time</span><span class="op" id="6571684">.</span><span class="ident" id="6571685">After</span><span class="op" id="6571690">(</span><span class="num" id="6571691">15</span>&nbsp;<span class="op" id="6571694">*</span>&nbsp;<span class="ident" id="6571696">time</span><span class="op" id="6571700">.</span><span class="ident" id="6571701">Second</span><span class="op" id="6571707">)</span><span class="op" id="6571708">:</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571713">t</span><span class="op" id="6571714">.</span><span class="ident" id="6571715">Fatal</span><span class="op" id="6571720">(</span><span class="string" id="6571721">&#34;too&nbsp;slow&#34;</span><span class="op" id="6571731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571735">case</span>&nbsp;<span class="ident" id="6571740">err</span>&nbsp;<span class="op" id="6571744">:=</span>&nbsp;<span class="op" id="6571747">&lt;-</span><span class="ident" id="6571749">errc</span><span class="op" id="6571753">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571758">if</span>&nbsp;<span class="ident" id="6571761">err</span>&nbsp;<span class="op" id="6571765">==</span>&nbsp;<span class="ident" id="6571768">nil</span>&nbsp;<span class="op" id="6571772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571778">connected</span><span class="op" id="6571787">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571794">if</span>&nbsp;<span class="ident" id="6571797">connected</span>&nbsp;<span class="op" id="6571807">==</span>&nbsp;<span class="ident" id="6571810">numConns</span>&nbsp;<span class="op" id="6571819">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571826">t</span><span class="op" id="6571827">.</span><span class="ident" id="6571828">Fatal</span><span class="op" id="6571833">(</span><span class="string" id="6571834">&#34;all&nbsp;connections&nbsp;connected;&nbsp;expected&nbsp;some&nbsp;to&nbsp;time&nbsp;out&#34;</span><span class="op" id="6571888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571899">}</span>&nbsp;<span class="keyword" id="6571901">else</span>&nbsp;<span class="op" id="6571906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571912">terr</span><span class="op" id="6571916">,</span>&nbsp;<span class="ident" id="6571918">ok</span>&nbsp;<span class="op" id="6571921">:=</span>&nbsp;<span class="ident" id="6571924">err</span><span class="op" id="6571927">.</span><span class="op" id="6571928">(</span><span class="ident" id="6571929">timeout</span><span class="op" id="6571936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571942">if</span>&nbsp;<span class="op" id="6571945">!</span><span class="ident" id="6571946">ok</span>&nbsp;<span class="op" id="6571949">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571956">t</span><span class="op" id="6571957">.</span><span class="ident" id="6571958">Fatalf</span><span class="op" id="6571964">(</span><span class="string" id="6571965">&#34;got&nbsp;error&nbsp;%q;&nbsp;want&nbsp;error&nbsp;with&nbsp;timeout&nbsp;interface&#34;</span><span class="op" id="6572014">,</span>&nbsp;<span class="ident" id="6572016">err</span><span class="op" id="6572019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572031">if</span>&nbsp;<span class="op" id="6572034">!</span><span class="ident" id="6572035">terr</span><span class="op" id="6572039">.</span><span class="ident" id="6572040">Timeout</span><span class="op" id="6572047">(</span><span class="op" id="6572048">)</span>&nbsp;<span class="op" id="6572050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572057">t</span><span class="op" id="6572058">.</span><span class="ident" id="6572059">Fatalf</span><span class="op" id="6572065">(</span><span class="string" id="6572066">&#34;got&nbsp;error&nbsp;%q;&nbsp;not&nbsp;a&nbsp;timeout&#34;</span><span class="op" id="6572095">,</span>&nbsp;<span class="ident" id="6572097">err</span><span class="op" id="6572100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572106">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6572112">//&nbsp;Pass.&nbsp;We&nbsp;saw&nbsp;a&nbsp;timeout&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572149">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572166">}</span><br>
<span class="lineno">115</span><span class="op" id="6572168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6572171">func</span>&nbsp;<span class="ident" id="6572176">TestSelfConnect</span><span class="op" id="6572191">(</span><span class="ident" id="6572192">t</span>&nbsp;<span class="op" id="6572194">*</span><span class="ident" id="6572195">testing</span><span class="op" id="6572202">.</span><span class="ident" id="6572203">T</span><span class="op" id="6572204">)</span>&nbsp;<span class="op" id="6572206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572209">if</span>&nbsp;<span class="ident" id="6572212">runtime</span><span class="op" id="6572219">.</span><span class="ident" id="6572220">GOOS</span>&nbsp;<span class="op" id="6572225">==</span>&nbsp;<span class="string" id="6572228">&#34;windows&#34;</span>&nbsp;<span class="op" id="6572238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6572242">//&nbsp;TODO(brainman):&nbsp;do&nbsp;not&nbsp;know&nbsp;why&nbsp;it&nbsp;hangs.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572289">t</span><span class="op" id="6572290">.</span><span class="ident" id="6572291">Skip</span><span class="op" id="6572295">(</span><span class="string" id="6572296">&#34;skipping&nbsp;known-broken&nbsp;test&nbsp;on&nbsp;windows&#34;</span><span class="op" id="6572335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6572342">//&nbsp;Test&nbsp;that&nbsp;Dial&nbsp;does&nbsp;not&nbsp;honor&nbsp;self-connects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6572391">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;DialTCP.</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6572424">//&nbsp;Find&nbsp;a&nbsp;port&nbsp;that&nbsp;would&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;local&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572479">l</span><span class="op" id="6572480">,</span>&nbsp;<span class="ident" id="6572482">err</span>&nbsp;<span class="op" id="6572486">:=</span>&nbsp;<span class="ident" id="6572489">Listen</span><span class="op" id="6572495">(</span><span class="string" id="6572496">&#34;tcp&#34;</span><span class="op" id="6572501">,</span>&nbsp;<span class="string" id="6572503">&#34;127.0.0.1:0&#34;</span><span class="op" id="6572516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572519">if</span>&nbsp;<span class="ident" id="6572522">err</span>&nbsp;<span class="op" id="6572526">!=</span>&nbsp;<span class="ident" id="6572529">nil</span>&nbsp;<span class="op" id="6572533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572537">t</span><span class="op" id="6572538">.</span><span class="ident" id="6572539">Fatal</span><span class="op" id="6572544">(</span><span class="ident" id="6572545">err</span><span class="op" id="6572548">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572554">c</span><span class="op" id="6572555">,</span>&nbsp;<span class="ident" id="6572557">err</span>&nbsp;<span class="op" id="6572561">:=</span>&nbsp;<span class="ident" id="6572564">Dial</span><span class="op" id="6572568">(</span><span class="string" id="6572569">&#34;tcp&#34;</span><span class="op" id="6572574">,</span>&nbsp;<span class="ident" id="6572576">l</span><span class="op" id="6572577">.</span><span class="ident" id="6572578">Addr</span><span class="op" id="6572582">(</span><span class="op" id="6572583">)</span><span class="op" id="6572584">.</span><span class="ident" id="6572585">String</span><span class="op" id="6572591">(</span><span class="op" id="6572592">)</span><span class="op" id="6572593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572596">if</span>&nbsp;<span class="ident" id="6572599">err</span>&nbsp;<span class="op" id="6572603">!=</span>&nbsp;<span class="ident" id="6572606">nil</span>&nbsp;<span class="op" id="6572610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572614">t</span><span class="op" id="6572615">.</span><span class="ident" id="6572616">Fatal</span><span class="op" id="6572621">(</span><span class="ident" id="6572622">err</span><span class="op" id="6572625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572628">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572631">addr</span>&nbsp;<span class="op" id="6572636">:=</span>&nbsp;<span class="ident" id="6572639">c</span><span class="op" id="6572640">.</span><span class="ident" id="6572641">LocalAddr</span><span class="op" id="6572650">(</span><span class="op" id="6572651">)</span><span class="op" id="6572652">.</span><span class="ident" id="6572653">String</span><span class="op" id="6572659">(</span><span class="op" id="6572660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572663">c</span><span class="op" id="6572664">.</span><span class="ident" id="6572665">Close</span><span class="op" id="6572670">(</span><span class="op" id="6572671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572674">l</span><span class="op" id="6572675">.</span><span class="ident" id="6572676">Close</span><span class="op" id="6572681">(</span><span class="op" id="6572682">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6572686">//&nbsp;Try&nbsp;to&nbsp;connect&nbsp;to&nbsp;that&nbsp;address&nbsp;repeatedly.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572733">n</span>&nbsp;<span class="op" id="6572735">:=</span>&nbsp;<span class="num" id="6572738">100000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572746">if</span>&nbsp;<span class="ident" id="6572749">testing</span><span class="op" id="6572756">.</span><span class="ident" id="6572757">Short</span><span class="op" id="6572762">(</span><span class="op" id="6572763">)</span>&nbsp;<span class="op" id="6572765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572769">n</span>&nbsp;<span class="op" id="6572771">=</span>&nbsp;<span class="num" id="6572773">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572782">switch</span>&nbsp;<span class="ident" id="6572789">runtime</span><span class="op" id="6572796">.</span><span class="ident" id="6572797">GOOS</span>&nbsp;<span class="op" id="6572802">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572805">case</span>&nbsp;<span class="string" id="6572810">&#34;darwin&#34;</span><span class="op" id="6572818">,</span>&nbsp;<span class="string" id="6572820">&#34;dragonfly&#34;</span><span class="op" id="6572831">,</span>&nbsp;<span class="string" id="6572833">&#34;freebsd&#34;</span><span class="op" id="6572842">,</span>&nbsp;<span class="string" id="6572844">&#34;netbsd&#34;</span><span class="op" id="6572852">,</span>&nbsp;<span class="string" id="6572854">&#34;openbsd&#34;</span><span class="op" id="6572863">,</span>&nbsp;<span class="string" id="6572865">&#34;plan9&#34;</span><span class="op" id="6572872">,</span>&nbsp;<span class="string" id="6572874">&#34;solaris&#34;</span><span class="op" id="6572883">,</span>&nbsp;<span class="string" id="6572885">&#34;windows&#34;</span><span class="op" id="6572894">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6572898">//&nbsp;Non-Linux&nbsp;systems&nbsp;take&nbsp;a&nbsp;long&nbsp;time&nbsp;to&nbsp;figure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6572948">//&nbsp;out&nbsp;that&nbsp;there&nbsp;is&nbsp;nothing&nbsp;listening&nbsp;on&nbsp;localhost.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573003">n</span>&nbsp;<span class="op" id="6573005">=</span>&nbsp;<span class="num" id="6573007">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573012">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6573015">for</span>&nbsp;<span class="ident" id="6573019">i</span>&nbsp;<span class="op" id="6573021">:=</span>&nbsp;<span class="num" id="6573024">0</span><span class="op" id="6573025">;</span>&nbsp;<span class="ident" id="6573027">i</span>&nbsp;<span class="op" id="6573029">&lt;</span>&nbsp;<span class="ident" id="6573031">n</span><span class="op" id="6573032">;</span>&nbsp;<span class="ident" id="6573034">i</span><span class="op" id="6573035">++</span>&nbsp;<span class="op" id="6573038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573042">c</span><span class="op" id="6573043">,</span>&nbsp;<span class="ident" id="6573045">err</span>&nbsp;<span class="op" id="6573049">:=</span>&nbsp;<span class="ident" id="6573052">DialTimeout</span><span class="op" id="6573063">(</span><span class="string" id="6573064">&#34;tcp&#34;</span><span class="op" id="6573069">,</span>&nbsp;<span class="ident" id="6573071">addr</span><span class="op" id="6573075">,</span>&nbsp;<span class="ident" id="6573077">time</span><span class="op" id="6573081">.</span><span class="ident" id="6573082">Millisecond</span><span class="op" id="6573093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6573097">if</span>&nbsp;<span class="ident" id="6573100">err</span>&nbsp;<span class="op" id="6573104">==</span>&nbsp;<span class="ident" id="6573107">nil</span>&nbsp;<span class="op" id="6573111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6573116">if</span>&nbsp;<span class="ident" id="6573119">c</span><span class="op" id="6573120">.</span><span class="ident" id="6573121">LocalAddr</span><span class="op" id="6573130">(</span><span class="op" id="6573131">)</span><span class="op" id="6573132">.</span><span class="ident" id="6573133">String</span><span class="op" id="6573139">(</span><span class="op" id="6573140">)</span>&nbsp;<span class="op" id="6573142">==</span>&nbsp;<span class="ident" id="6573145">addr</span>&nbsp;<span class="op" id="6573150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573156">t</span><span class="op" id="6573157">.</span><span class="ident" id="6573158">Errorf</span><span class="op" id="6573164">(</span><span class="string" id="6573165">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;self-connect&#34;</span><span class="op" id="6573192">,</span>&nbsp;<span class="ident" id="6573194">i</span><span class="op" id="6573195">,</span>&nbsp;<span class="ident" id="6573197">addr</span><span class="op" id="6573201">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573206">}</span>&nbsp;<span class="keyword" id="6573208">else</span>&nbsp;<span class="op" id="6573213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573219">t</span><span class="op" id="6573220">.</span><span class="ident" id="6573221">Logf</span><span class="op" id="6573225">(</span><span class="string" id="6573226">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;succeeded&nbsp;-&nbsp;possibly&nbsp;racing&nbsp;with&nbsp;other&nbsp;listener&#34;</span><span class="op" id="6573288">,</span>&nbsp;<span class="ident" id="6573290">i</span><span class="op" id="6573291">,</span>&nbsp;<span class="ident" id="6573293">addr</span><span class="op" id="6573297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573307">c</span><span class="op" id="6573308">.</span><span class="ident" id="6573309">Close</span><span class="op" id="6573314">(</span><span class="op" id="6573315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573319">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573322">}</span><br>
<span class="lineno"></span><span class="op" id="6573324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6573327">var</span>&nbsp;<span class="ident" id="6573331">runErrorTest</span>&nbsp;<span class="op" id="6573344">=</span>&nbsp;<span class="ident" id="6573346">flag</span><span class="op" id="6573350">.</span><span class="ident" id="6573351">Bool</span><span class="op" id="6573355">(</span><span class="string" id="6573356">&#34;run_error_test&#34;</span><span class="op" id="6573372">,</span>&nbsp;<span class="builtintype" id="6573374">false</span><span class="op" id="6573379">,</span>&nbsp;<span class="string" id="6573381">&#34;let&nbsp;TestDialError&nbsp;check&nbsp;for&nbsp;dns&nbsp;errors&#34;</span><span class="op" id="6573421">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="6573424">type</span>&nbsp;<span class="ident" id="6573429">DialErrorTest</span>&nbsp;<span class="keyword" id="6573443">struct</span>&nbsp;<span class="op" id="6573450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573453">Net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6573461">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573469">Raddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6573477">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573485">Pattern</span>&nbsp;<span class="builtintype" id="6573493">string</span><br>
<span class="lineno"></span><span class="op" id="6573500">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="6573503">var</span>&nbsp;<span class="ident" id="6573507">dialErrorTests</span>&nbsp;<span class="op" id="6573522">=</span>&nbsp;<span class="op" id="6573524">[</span><span class="op" id="6573525">]</span><span class="ident" id="6573526">DialErrorTest</span><span class="op" id="6573539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6573546">&#34;datakit&#34;</span><span class="op" id="6573555">,</span>&nbsp;<span class="string" id="6573557">&#34;mh/astro/r70&#34;</span><span class="op" id="6573571">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6573575">&#34;dial&nbsp;datakit&nbsp;mh/astro/r70:&nbsp;unknown&nbsp;network&nbsp;datakit&#34;</span><span class="op" id="6573627">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573630">}</span><span class="op" id="6573631">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6573638">&#34;tcp&#34;</span><span class="op" id="6573643">,</span>&nbsp;<span class="string" id="6573645">&#34;127.0.0.1:☺&#34;</span><span class="op" id="6573660">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6573664">&#34;dial&nbsp;tcp&nbsp;127.0.0.1:☺:&nbsp;unknown&nbsp;port&nbsp;tcp/☺&#34;</span><span class="op" id="6573710">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573713">}</span><span class="op" id="6573714">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6573721">&#34;tcp&#34;</span><span class="op" id="6573726">,</span>&nbsp;<span class="string" id="6573728">&#34;no-such-name.google.com.:80&#34;</span><span class="op" id="6573757">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6573761">&#34;dial&nbsp;tcp&nbsp;no-such-name.google.com.:80:&nbsp;lookup&nbsp;no-such-name.google.com.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="6573850">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573853">}</span><span class="op" id="6573854">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573857">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6573861">&#34;tcp&#34;</span><span class="op" id="6573866">,</span>&nbsp;<span class="string" id="6573868">&#34;no-such-name.no-such-top-level-domain.:80&#34;</span><span class="op" id="6573911">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6573915">&#34;dial&nbsp;tcp&nbsp;no-such-name.no-such-top-level-domain.:80:&nbsp;lookup&nbsp;no-such-name.no-such-top-level-domain.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="6574032">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574035">}</span><span class="op" id="6574036">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6574043">&#34;tcp&#34;</span><span class="op" id="6574048">,</span>&nbsp;<span class="string" id="6574050">&#34;no-such-name:80&#34;</span><span class="op" id="6574067">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6574071">`dial&nbsp;tcp&nbsp;no-such-name:80:&nbsp;lookup&nbsp;no-such-name\.(.*\.)?(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)`</span><span class="op" id="6574145">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574148">}</span><span class="op" id="6574149">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6574156">&#34;tcp&#34;</span><span class="op" id="6574161">,</span>&nbsp;<span class="string" id="6574163">&#34;mh/astro/r70:http&#34;</span><span class="op" id="6574182">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6574186">&#34;dial&nbsp;tcp&nbsp;mh/astro/r70:http:&nbsp;lookup&nbsp;mh/astro/r70:&nbsp;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="6574256">,</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574259">}</span><span class="op" id="6574260">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6574267">&#34;unix&#34;</span><span class="op" id="6574273">,</span>&nbsp;<span class="string" id="6574275">&#34;/etc/file-not-found&#34;</span><span class="op" id="6574296">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6574300">&#34;dial&nbsp;unix&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="6574358">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574361">}</span><span class="op" id="6574362">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6574369">&#34;unix&#34;</span><span class="op" id="6574375">,</span>&nbsp;<span class="string" id="6574377">&#34;/etc/&#34;</span><span class="op" id="6574384">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6574388">&#34;dial&nbsp;unix&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="6574476">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574479">}</span><span class="op" id="6574480">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574483">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6574487">&#34;unixpacket&#34;</span><span class="op" id="6574499">,</span>&nbsp;<span class="string" id="6574501">&#34;/etc/file-not-found&#34;</span><span class="op" id="6574522">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6574526">&#34;dial&nbsp;unixpacket&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="6574590">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574593">}</span><span class="op" id="6574594">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6574601">&#34;unixpacket&#34;</span><span class="op" id="6574613">,</span>&nbsp;<span class="string" id="6574615">&#34;/etc/&#34;</span><span class="op" id="6574622">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6574626">&#34;dial&nbsp;unixpacket&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="6574720">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574723">}</span><span class="op" id="6574724">,</span><br>
<span class="lineno"></span><span class="op" id="6574726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6574729">var</span>&nbsp;<span class="ident" id="6574733">duplicateErrorPattern</span>&nbsp;<span class="op" id="6574755">=</span>&nbsp;<span class="string" id="6574757">`dial&nbsp;(.*)&nbsp;dial&nbsp;(.*)`</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6574780">func</span>&nbsp;<span class="ident" id="6574785">TestDialError</span><span class="op" id="6574798">(</span><span class="ident" id="6574799">t</span>&nbsp;<span class="op" id="6574801">*</span><span class="ident" id="6574802">testing</span><span class="op" id="6574809">.</span><span class="ident" id="6574810">T</span><span class="op" id="6574811">)</span>&nbsp;<span class="op" id="6574813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6574816">if</span>&nbsp;<span class="op" id="6574819">!</span><span class="op" id="6574820">*</span><span class="ident" id="6574821">runErrorTest</span>&nbsp;<span class="op" id="6574834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6574838">t</span><span class="op" id="6574839">.</span><span class="ident" id="6574840">Logf</span><span class="op" id="6574844">(</span><span class="string" id="6574845">&#34;test&nbsp;disabled;&nbsp;use&nbsp;-run_error_test&nbsp;to&nbsp;enable&#34;</span><span class="op" id="6574891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6574895">return</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6574906">for</span>&nbsp;<span class="ident" id="6574910">i</span><span class="op" id="6574911">,</span>&nbsp;<span class="ident" id="6574913">tt</span>&nbsp;<span class="op" id="6574916">:=</span>&nbsp;<span class="keyword" id="6574919">range</span>&nbsp;<span class="ident" id="6574925">dialErrorTests</span>&nbsp;<span class="op" id="6574940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6574944">c</span><span class="op" id="6574945">,</span>&nbsp;<span class="ident" id="6574947">err</span>&nbsp;<span class="op" id="6574951">:=</span>&nbsp;<span class="ident" id="6574954">Dial</span><span class="op" id="6574958">(</span><span class="ident" id="6574959">tt</span><span class="op" id="6574961">.</span><span class="ident" id="6574962">Net</span><span class="op" id="6574965">,</span>&nbsp;<span class="ident" id="6574967">tt</span><span class="op" id="6574969">.</span><span class="ident" id="6574970">Raddr</span><span class="op" id="6574975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6574979">if</span>&nbsp;<span class="ident" id="6574982">c</span>&nbsp;<span class="op" id="6574984">!=</span>&nbsp;<span class="ident" id="6574987">nil</span>&nbsp;<span class="op" id="6574991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6574996">c</span><span class="op" id="6574997">.</span><span class="ident" id="6574998">Close</span><span class="op" id="6575003">(</span><span class="op" id="6575004">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6575008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6575012">if</span>&nbsp;<span class="ident" id="6575015">err</span>&nbsp;<span class="op" id="6575019">==</span>&nbsp;<span class="ident" id="6575022">nil</span>&nbsp;<span class="op" id="6575026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6575031">t</span><span class="op" id="6575032">.</span><span class="ident" id="6575033">Errorf</span><span class="op" id="6575039">(</span><span class="string" id="6575040">&#34;#%d:&nbsp;nil&nbsp;error,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="6575076">,</span>&nbsp;<span class="ident" id="6575078">i</span><span class="op" id="6575079">,</span>&nbsp;<span class="ident" id="6575081">tt</span><span class="op" id="6575083">.</span><span class="ident" id="6575084">Pattern</span><span class="op" id="6575091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6575096">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6575107">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6575111">s</span>&nbsp;<span class="op" id="6575113">:=</span>&nbsp;<span class="ident" id="6575116">err</span><span class="op" id="6575119">.</span><span class="ident" id="6575120">Error</span><span class="op" id="6575125">(</span><span class="op" id="6575126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6575130">match</span><span class="op" id="6575135">,</span>&nbsp;<span class="ident" id="6575137">_</span>&nbsp;<span class="op" id="6575139">:=</span>&nbsp;<span class="ident" id="6575142">regexp</span><span class="op" id="6575148">.</span><span class="ident" id="6575149">MatchString</span><span class="op" id="6575160">(</span><span class="ident" id="6575161">tt</span><span class="op" id="6575163">.</span><span class="ident" id="6575164">Pattern</span><span class="op" id="6575171">,</span>&nbsp;<span class="ident" id="6575173">s</span><span class="op" id="6575174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6575178">if</span>&nbsp;<span class="op" id="6575181">!</span><span class="ident" id="6575182">match</span>&nbsp;<span class="op" id="6575188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6575193">t</span><span class="op" id="6575194">.</span><span class="ident" id="6575195">Errorf</span><span class="op" id="6575201">(</span><span class="string" id="6575202">&#34;#%d:&nbsp;%q,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="6575231">,</span>&nbsp;<span class="ident" id="6575233">i</span><span class="op" id="6575234">,</span>&nbsp;<span class="ident" id="6575236">s</span><span class="op" id="6575237">,</span>&nbsp;<span class="ident" id="6575239">tt</span><span class="op" id="6575241">.</span><span class="ident" id="6575242">Pattern</span><span class="op" id="6575249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6575253">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6575257">match</span><span class="op" id="6575262">,</span>&nbsp;<span class="ident" id="6575264">_</span>&nbsp;<span class="op" id="6575266">=</span>&nbsp;<span class="ident" id="6575268">regexp</span><span class="op" id="6575274">.</span><span class="ident" id="6575275">MatchString</span><span class="op" id="6575286">(</span><span class="ident" id="6575287">duplicateErrorPattern</span><span class="op" id="6575308">,</span>&nbsp;<span class="ident" id="6575310">s</span><span class="op" id="6575311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6575315">if</span>&nbsp;<span class="ident" id="6575318">match</span>&nbsp;<span class="op" id="6575324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6575329">t</span><span class="op" id="6575330">.</span><span class="ident" id="6575331">Errorf</span><span class="op" id="6575337">(</span><span class="string" id="6575338">&#34;#%d:&nbsp;%q,&nbsp;duplicate&nbsp;error&nbsp;return&nbsp;from&nbsp;Dial&#34;</span><span class="op" id="6575381">,</span>&nbsp;<span class="ident" id="6575383">i</span><span class="op" id="6575384">,</span>&nbsp;<span class="ident" id="6575386">s</span><span class="op" id="6575387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6575391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6575394">}</span><br>
<span class="lineno">240</span><span class="op" id="6575396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6575399">var</span>&nbsp;<span class="ident" id="6575403">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="6575432">=</span>&nbsp;<span class="op" id="6575434">[</span><span class="op" id="6575435">]</span><span class="keyword" id="6575436">struct</span>&nbsp;<span class="op" id="6575443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6575446">net</span>&nbsp;&nbsp;<span class="builtintype" id="6575451">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6575459">addr</span>&nbsp;<span class="builtintype" id="6575464">string</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6575472">err</span>&nbsp;&nbsp;<span class="builtintype" id="6575477">error</span><br>
<span class="lineno"></span><span class="op" id="6575483">}</span><span class="op" id="6575484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6575487">{</span><span class="string" id="6575488">&#34;foo&#34;</span><span class="op" id="6575493">,</span>&nbsp;<span class="string" id="6575495">&#34;bar&#34;</span><span class="op" id="6575500">,</span>&nbsp;<span class="op" id="6575502">&amp;</span><span class="ident" id="6575503">OpError</span><span class="op" id="6575510">{</span><span class="ident" id="6575511">Op</span><span class="op" id="6575513">:</span>&nbsp;<span class="string" id="6575515">&#34;dial&#34;</span><span class="op" id="6575521">,</span>&nbsp;<span class="ident" id="6575523">Net</span><span class="op" id="6575526">:</span>&nbsp;<span class="string" id="6575528">&#34;foo&#34;</span><span class="op" id="6575533">,</span>&nbsp;<span class="ident" id="6575535">Addr</span><span class="op" id="6575539">:</span>&nbsp;<span class="ident" id="6575541">nil</span><span class="op" id="6575544">,</span>&nbsp;<span class="ident" id="6575546">Err</span><span class="op" id="6575549">:</span>&nbsp;<span class="ident" id="6575551">UnknownNetworkError</span><span class="op" id="6575570">(</span><span class="string" id="6575571">&#34;foo&#34;</span><span class="op" id="6575576">)</span><span class="op" id="6575577">}</span><span class="op" id="6575578">}</span><span class="op" id="6575579">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6575582">{</span><span class="string" id="6575583">&#34;baz&#34;</span><span class="op" id="6575588">,</span>&nbsp;<span class="string" id="6575590">&#34;&#34;</span><span class="op" id="6575592">,</span>&nbsp;<span class="op" id="6575594">&amp;</span><span class="ident" id="6575595">OpError</span><span class="op" id="6575602">{</span><span class="ident" id="6575603">Op</span><span class="op" id="6575605">:</span>&nbsp;<span class="string" id="6575607">&#34;listen&#34;</span><span class="op" id="6575615">,</span>&nbsp;<span class="ident" id="6575617">Net</span><span class="op" id="6575620">:</span>&nbsp;<span class="string" id="6575622">&#34;baz&#34;</span><span class="op" id="6575627">,</span>&nbsp;<span class="ident" id="6575629">Addr</span><span class="op" id="6575633">:</span>&nbsp;<span class="ident" id="6575635">nil</span><span class="op" id="6575638">,</span>&nbsp;<span class="ident" id="6575640">Err</span><span class="op" id="6575643">:</span>&nbsp;<span class="ident" id="6575645">UnknownNetworkError</span><span class="op" id="6575664">(</span><span class="string" id="6575665">&#34;baz&#34;</span><span class="op" id="6575670">)</span><span class="op" id="6575671">}</span><span class="op" id="6575672">}</span><span class="op" id="6575673">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6575676">{</span><span class="string" id="6575677">&#34;tcp&#34;</span><span class="op" id="6575682">,</span>&nbsp;<span class="string" id="6575684">&#34;&#34;</span><span class="op" id="6575686">,</span>&nbsp;<span class="op" id="6575688">&amp;</span><span class="ident" id="6575689">OpError</span><span class="op" id="6575696">{</span><span class="ident" id="6575697">Op</span><span class="op" id="6575699">:</span>&nbsp;<span class="string" id="6575701">&#34;dial&#34;</span><span class="op" id="6575707">,</span>&nbsp;<span class="ident" id="6575709">Net</span><span class="op" id="6575712">:</span>&nbsp;<span class="string" id="6575714">&#34;tcp&#34;</span><span class="op" id="6575719">,</span>&nbsp;<span class="ident" id="6575721">Addr</span><span class="op" id="6575725">:</span>&nbsp;<span class="ident" id="6575727">nil</span><span class="op" id="6575730">,</span>&nbsp;<span class="ident" id="6575732">Err</span><span class="op" id="6575735">:</span>&nbsp;<span class="ident" id="6575737">errMissingAddress</span><span class="op" id="6575754">}</span><span class="op" id="6575755">}</span><span class="op" id="6575756">,</span><br>
<span class="lineno">250</span><span class="op" id="6575758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6575761">func</span>&nbsp;<span class="ident" id="6575766">TestInvalidDialAndListenArgs</span><span class="op" id="6575794">(</span><span class="ident" id="6575795">t</span>&nbsp;<span class="op" id="6575797">*</span><span class="ident" id="6575798">testing</span><span class="op" id="6575805">.</span><span class="ident" id="6575806">T</span><span class="op" id="6575807">)</span>&nbsp;<span class="op" id="6575809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6575812">for</span>&nbsp;<span class="ident" id="6575816">_</span><span class="op" id="6575817">,</span>&nbsp;<span class="ident" id="6575819">tt</span>&nbsp;<span class="op" id="6575822">:=</span>&nbsp;<span class="keyword" id="6575825">range</span>&nbsp;<span class="ident" id="6575831">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="6575860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6575864">var</span>&nbsp;<span class="ident" id="6575868">err</span>&nbsp;<span class="builtintype" id="6575872">error</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6575880">switch</span>&nbsp;<span class="ident" id="6575887">tt</span><span class="op" id="6575889">.</span><span class="ident" id="6575890">err</span><span class="op" id="6575893">.</span><span class="op" id="6575894">(</span><span class="op" id="6575895">*</span><span class="ident" id="6575896">OpError</span><span class="op" id="6575903">)</span><span class="op" id="6575904">.</span><span class="ident" id="6575905">Op</span>&nbsp;<span class="op" id="6575908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6575912">case</span>&nbsp;<span class="string" id="6575917">&#34;dial&#34;</span><span class="op" id="6575923">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6575928">_</span><span class="op" id="6575929">,</span>&nbsp;<span class="ident" id="6575931">err</span>&nbsp;<span class="op" id="6575935">=</span>&nbsp;<span class="ident" id="6575937">Dial</span><span class="op" id="6575941">(</span><span class="ident" id="6575942">tt</span><span class="op" id="6575944">.</span><span class="ident" id="6575945">net</span><span class="op" id="6575948">,</span>&nbsp;<span class="ident" id="6575950">tt</span><span class="op" id="6575952">.</span><span class="ident" id="6575953">addr</span><span class="op" id="6575957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6575961">case</span>&nbsp;<span class="string" id="6575966">&#34;listen&#34;</span><span class="op" id="6575974">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6575979">_</span><span class="op" id="6575980">,</span>&nbsp;<span class="ident" id="6575982">err</span>&nbsp;<span class="op" id="6575986">=</span>&nbsp;<span class="ident" id="6575988">Listen</span><span class="op" id="6575994">(</span><span class="ident" id="6575995">tt</span><span class="op" id="6575997">.</span><span class="ident" id="6575998">net</span><span class="op" id="6576001">,</span>&nbsp;<span class="ident" id="6576003">tt</span><span class="op" id="6576005">.</span><span class="ident" id="6576006">addr</span><span class="op" id="6576010">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6576014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6576018">if</span>&nbsp;<span class="op" id="6576021">!</span><span class="ident" id="6576022">reflect</span><span class="op" id="6576029">.</span><span class="ident" id="6576030">DeepEqual</span><span class="op" id="6576039">(</span><span class="ident" id="6576040">tt</span><span class="op" id="6576042">.</span><span class="ident" id="6576043">err</span><span class="op" id="6576046">,</span>&nbsp;<span class="ident" id="6576048">err</span><span class="op" id="6576051">)</span>&nbsp;<span class="op" id="6576053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576058">t</span><span class="op" id="6576059">.</span><span class="ident" id="6576060">Fatalf</span><span class="op" id="6576066">(</span><span class="string" id="6576067">&#34;got&nbsp;%#v;&nbsp;expected&nbsp;%#v&#34;</span><span class="op" id="6576090">,</span>&nbsp;<span class="ident" id="6576092">err</span><span class="op" id="6576095">,</span>&nbsp;<span class="ident" id="6576097">tt</span><span class="op" id="6576099">.</span><span class="ident" id="6576100">err</span><span class="op" id="6576103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6576107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6576110">}</span><br>
<span class="lineno">265</span><span class="op" id="6576112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6576115">func</span>&nbsp;<span class="ident" id="6576120">TestDialTimeoutFDLeak</span><span class="op" id="6576141">(</span><span class="ident" id="6576142">t</span>&nbsp;<span class="op" id="6576144">*</span><span class="ident" id="6576145">testing</span><span class="op" id="6576152">.</span><span class="ident" id="6576153">T</span><span class="op" id="6576154">)</span>&nbsp;<span class="op" id="6576156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6576159">if</span>&nbsp;<span class="ident" id="6576162">runtime</span><span class="op" id="6576169">.</span><span class="ident" id="6576170">GOOS</span>&nbsp;<span class="op" id="6576175">!=</span>&nbsp;<span class="string" id="6576178">&#34;linux&#34;</span>&nbsp;<span class="op" id="6576186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6576190">//&nbsp;TODO(bradfitz):&nbsp;test&nbsp;on&nbsp;other&nbsp;platforms</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576235">t</span><span class="op" id="6576236">.</span><span class="ident" id="6576237">Skipf</span><span class="op" id="6576242">(</span><span class="string" id="6576243">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6576264">,</span>&nbsp;<span class="ident" id="6576266">runtime</span><span class="op" id="6576273">.</span><span class="ident" id="6576274">GOOS</span><span class="op" id="6576278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6576281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576285">ln</span>&nbsp;<span class="op" id="6576288">:=</span>&nbsp;<span class="ident" id="6576291">newLocalListener</span><span class="op" id="6576307">(</span><span class="ident" id="6576308">t</span><span class="op" id="6576309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6576312">defer</span>&nbsp;<span class="ident" id="6576318">ln</span><span class="op" id="6576320">.</span><span class="ident" id="6576321">Close</span><span class="op" id="6576326">(</span><span class="op" id="6576327">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6576331">type</span>&nbsp;<span class="ident" id="6576336">connErr</span>&nbsp;<span class="keyword" id="6576344">struct</span>&nbsp;<span class="op" id="6576351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576355">conn</span>&nbsp;<span class="ident" id="6576360">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576367">err</span>&nbsp;&nbsp;<span class="builtintype" id="6576372">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6576379">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576382">dials</span>&nbsp;<span class="op" id="6576388">:=</span>&nbsp;<span class="ident" id="6576391">listenerBacklog</span>&nbsp;<span class="op" id="6576407">+</span>&nbsp;<span class="num" id="6576409">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6576414">//&nbsp;used&nbsp;to&nbsp;be&nbsp;listenerBacklog&nbsp;+&nbsp;5,&nbsp;but&nbsp;was&nbsp;found&nbsp;to&nbsp;be&nbsp;unreliable,&nbsp;issue&nbsp;4384.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576494">maxGoodConnect</span>&nbsp;<span class="op" id="6576509">:=</span>&nbsp;<span class="ident" id="6576512">listenerBacklog</span>&nbsp;<span class="op" id="6576528">+</span>&nbsp;<span class="ident" id="6576530">runtime</span><span class="op" id="6576537">.</span><span class="ident" id="6576538">NumCPU</span><span class="op" id="6576544">(</span><span class="op" id="6576545">)</span><span class="op" id="6576546">*</span><span class="num" id="6576547">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576551">resc</span>&nbsp;<span class="op" id="6576556">:=</span>&nbsp;<span class="builtinfunc" id="6576559">make</span><span class="op" id="6576563">(</span><span class="keyword" id="6576564">chan</span>&nbsp;<span class="ident" id="6576569">connErr</span><span class="op" id="6576576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6576579">for</span>&nbsp;<span class="ident" id="6576583">i</span>&nbsp;<span class="op" id="6576585">:=</span>&nbsp;<span class="num" id="6576588">0</span><span class="op" id="6576589">;</span>&nbsp;<span class="ident" id="6576591">i</span>&nbsp;<span class="op" id="6576593">&lt;</span>&nbsp;<span class="ident" id="6576595">dials</span><span class="op" id="6576600">;</span>&nbsp;<span class="ident" id="6576602">i</span><span class="op" id="6576603">++</span>&nbsp;<span class="op" id="6576606">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6576610">go</span>&nbsp;<span class="keyword" id="6576613">func</span><span class="op" id="6576617">(</span><span class="op" id="6576618">)</span>&nbsp;<span class="op" id="6576620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576625">conn</span><span class="op" id="6576629">,</span>&nbsp;<span class="ident" id="6576631">err</span>&nbsp;<span class="op" id="6576635">:=</span>&nbsp;<span class="ident" id="6576638">DialTimeout</span><span class="op" id="6576649">(</span><span class="string" id="6576650">&#34;tcp&#34;</span><span class="op" id="6576655">,</span>&nbsp;<span class="ident" id="6576657">ln</span><span class="op" id="6576659">.</span><span class="ident" id="6576660">Addr</span><span class="op" id="6576664">(</span><span class="op" id="6576665">)</span><span class="op" id="6576666">.</span><span class="ident" id="6576667">String</span><span class="op" id="6576673">(</span><span class="op" id="6576674">)</span><span class="op" id="6576675">,</span>&nbsp;<span class="num" id="6576677">500</span><span class="op" id="6576680">*</span><span class="ident" id="6576681">time</span><span class="op" id="6576685">.</span><span class="ident" id="6576686">Millisecond</span><span class="op" id="6576697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576702">resc</span>&nbsp;<span class="op" id="6576707">&lt;-</span>&nbsp;<span class="ident" id="6576710">connErr</span><span class="op" id="6576717">{</span><span class="ident" id="6576718">conn</span><span class="op" id="6576722">,</span>&nbsp;<span class="ident" id="6576724">err</span><span class="op" id="6576727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6576731">}</span><span class="op" id="6576732">(</span><span class="op" id="6576733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6576736">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6576740">var</span>&nbsp;<span class="ident" id="6576744">firstErr</span>&nbsp;<span class="builtintype" id="6576753">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6576761">var</span>&nbsp;<span class="ident" id="6576765">ngood</span>&nbsp;<span class="builtintype" id="6576771">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6576776">var</span>&nbsp;<span class="ident" id="6576780">toClose</span>&nbsp;<span class="op" id="6576788">[</span><span class="op" id="6576789">]</span><span class="ident" id="6576790">io</span><span class="op" id="6576792">.</span><span class="ident" id="6576793">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6576801">for</span>&nbsp;<span class="ident" id="6576805">i</span>&nbsp;<span class="op" id="6576807">:=</span>&nbsp;<span class="num" id="6576810">0</span><span class="op" id="6576811">;</span>&nbsp;<span class="ident" id="6576813">i</span>&nbsp;<span class="op" id="6576815">&lt;</span>&nbsp;<span class="ident" id="6576817">dials</span><span class="op" id="6576822">;</span>&nbsp;<span class="ident" id="6576824">i</span><span class="op" id="6576825">++</span>&nbsp;<span class="op" id="6576828">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576832">ce</span>&nbsp;<span class="op" id="6576835">:=</span>&nbsp;<span class="op" id="6576838">&lt;-</span><span class="ident" id="6576840">resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6576847">if</span>&nbsp;<span class="ident" id="6576850">ce</span><span class="op" id="6576852">.</span><span class="ident" id="6576853">err</span>&nbsp;<span class="op" id="6576857">==</span>&nbsp;<span class="ident" id="6576860">nil</span>&nbsp;<span class="op" id="6576864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576869">ngood</span><span class="op" id="6576874">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6576880">if</span>&nbsp;<span class="ident" id="6576883">ngood</span>&nbsp;<span class="op" id="6576889">&gt;</span>&nbsp;<span class="ident" id="6576891">maxGoodConnect</span>&nbsp;<span class="op" id="6576906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576912">t</span><span class="op" id="6576913">.</span><span class="ident" id="6576914">Errorf</span><span class="op" id="6576920">(</span><span class="string" id="6576921">&#34;%d&nbsp;good&nbsp;connects;&nbsp;expected&nbsp;at&nbsp;most&nbsp;%d&#34;</span><span class="op" id="6576960">,</span>&nbsp;<span class="ident" id="6576962">ngood</span><span class="op" id="6576967">,</span>&nbsp;<span class="ident" id="6576969">maxGoodConnect</span><span class="op" id="6576983">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6576988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6576993">toClose</span>&nbsp;<span class="op" id="6577001">=</span>&nbsp;<span class="builtinfunc" id="6577003">append</span><span class="op" id="6577009">(</span><span class="ident" id="6577010">toClose</span><span class="op" id="6577017">,</span>&nbsp;<span class="ident" id="6577019">ce</span><span class="op" id="6577021">.</span><span class="ident" id="6577022">conn</span><span class="op" id="6577026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577031">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577046">err</span>&nbsp;<span class="op" id="6577050">:=</span>&nbsp;<span class="ident" id="6577053">ce</span><span class="op" id="6577055">.</span><span class="ident" id="6577056">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577062">if</span>&nbsp;<span class="ident" id="6577065">firstErr</span>&nbsp;<span class="op" id="6577074">==</span>&nbsp;<span class="string" id="6577077">&#34;&#34;</span>&nbsp;<span class="op" id="6577080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577085">firstErr</span>&nbsp;<span class="op" id="6577094">=</span>&nbsp;<span class="ident" id="6577096">err</span><span class="op" id="6577099">.</span><span class="ident" id="6577100">Error</span><span class="op" id="6577105">(</span><span class="op" id="6577106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577110">}</span>&nbsp;<span class="keyword" id="6577112">else</span>&nbsp;<span class="keyword" id="6577117">if</span>&nbsp;<span class="ident" id="6577120">err</span><span class="op" id="6577123">.</span><span class="ident" id="6577124">Error</span><span class="op" id="6577129">(</span><span class="op" id="6577130">)</span>&nbsp;<span class="op" id="6577132">!=</span>&nbsp;<span class="ident" id="6577135">firstErr</span>&nbsp;<span class="op" id="6577144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577149">t</span><span class="op" id="6577150">.</span><span class="ident" id="6577151">Fatalf</span><span class="op" id="6577157">(</span><span class="string" id="6577158">&#34;inconsistent&nbsp;error&nbsp;messages:&nbsp;first&nbsp;was&nbsp;%q,&nbsp;then&nbsp;later&nbsp;%q&#34;</span><span class="op" id="6577216">,</span>&nbsp;<span class="ident" id="6577218">firstErr</span><span class="op" id="6577226">,</span>&nbsp;<span class="ident" id="6577228">err</span><span class="op" id="6577231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577235">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577241">for</span>&nbsp;<span class="ident" id="6577245">_</span><span class="op" id="6577246">,</span>&nbsp;<span class="ident" id="6577248">c</span>&nbsp;<span class="op" id="6577250">:=</span>&nbsp;<span class="keyword" id="6577253">range</span>&nbsp;<span class="ident" id="6577259">toClose</span>&nbsp;<span class="op" id="6577267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577271">c</span><span class="op" id="6577272">.</span><span class="ident" id="6577273">Close</span><span class="op" id="6577278">(</span><span class="op" id="6577279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577285">for</span>&nbsp;<span class="ident" id="6577289">i</span>&nbsp;<span class="op" id="6577291">:=</span>&nbsp;<span class="num" id="6577294">0</span><span class="op" id="6577295">;</span>&nbsp;<span class="ident" id="6577297">i</span>&nbsp;<span class="op" id="6577299">&lt;</span>&nbsp;<span class="num" id="6577301">100</span><span class="op" id="6577304">;</span>&nbsp;<span class="ident" id="6577306">i</span><span class="op" id="6577307">++</span>&nbsp;<span class="op" id="6577310">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577314">if</span>&nbsp;<span class="ident" id="6577317">got</span>&nbsp;<span class="op" id="6577321">:=</span>&nbsp;<span class="ident" id="6577324">numFD</span><span class="op" id="6577329">(</span><span class="op" id="6577330">)</span><span class="op" id="6577331">;</span>&nbsp;<span class="ident" id="6577333">got</span>&nbsp;<span class="op" id="6577337">&lt;</span>&nbsp;<span class="ident" id="6577339">dials</span>&nbsp;<span class="op" id="6577345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6577350">//&nbsp;Test&nbsp;passes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577369">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577382">time</span><span class="op" id="6577386">.</span><span class="ident" id="6577387">Sleep</span><span class="op" id="6577392">(</span><span class="num" id="6577393">10</span>&nbsp;<span class="op" id="6577396">*</span>&nbsp;<span class="ident" id="6577398">time</span><span class="op" id="6577402">.</span><span class="ident" id="6577403">Millisecond</span><span class="op" id="6577414">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577420">if</span>&nbsp;<span class="ident" id="6577423">got</span>&nbsp;<span class="op" id="6577427">:=</span>&nbsp;<span class="ident" id="6577430">numFD</span><span class="op" id="6577435">(</span><span class="op" id="6577436">)</span><span class="op" id="6577437">;</span>&nbsp;<span class="ident" id="6577439">got</span>&nbsp;<span class="op" id="6577443">&gt;=</span>&nbsp;<span class="ident" id="6577446">dials</span>&nbsp;<span class="op" id="6577452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577456">t</span><span class="op" id="6577457">.</span><span class="ident" id="6577458">Errorf</span><span class="op" id="6577464">(</span><span class="string" id="6577465">&#34;num&nbsp;fds&nbsp;after&nbsp;%d&nbsp;timeouts&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;%d&#34;</span><span class="op" id="6577507">,</span>&nbsp;<span class="ident" id="6577509">dials</span><span class="op" id="6577514">,</span>&nbsp;<span class="ident" id="6577516">got</span><span class="op" id="6577519">,</span>&nbsp;<span class="ident" id="6577521">dials</span><span class="op" id="6577526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577529">}</span><br>
<span class="lineno"></span><span class="op" id="6577531">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="6577534">func</span>&nbsp;<span class="ident" id="6577539">numTCP</span><span class="op" id="6577545">(</span><span class="op" id="6577546">)</span>&nbsp;<span class="op" id="6577548">(</span><span class="ident" id="6577549">ntcp</span><span class="op" id="6577553">,</span>&nbsp;<span class="ident" id="6577555">nopen</span><span class="op" id="6577560">,</span>&nbsp;<span class="ident" id="6577562">nclose</span>&nbsp;<span class="builtintype" id="6577569">int</span><span class="op" id="6577572">,</span>&nbsp;<span class="ident" id="6577574">err</span>&nbsp;<span class="builtintype" id="6577578">error</span><span class="op" id="6577583">)</span>&nbsp;<span class="op" id="6577585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577588">lsof</span><span class="op" id="6577592">,</span>&nbsp;<span class="ident" id="6577594">err</span>&nbsp;<span class="op" id="6577598">:=</span>&nbsp;<span class="ident" id="6577601">exec</span><span class="op" id="6577605">.</span><span class="ident" id="6577606">Command</span><span class="op" id="6577613">(</span><span class="string" id="6577614">&#34;lsof&#34;</span><span class="op" id="6577620">,</span>&nbsp;<span class="string" id="6577622">&#34;-n&#34;</span><span class="op" id="6577626">,</span>&nbsp;<span class="string" id="6577628">&#34;-p&#34;</span><span class="op" id="6577632">,</span>&nbsp;<span class="ident" id="6577634">strconv</span><span class="op" id="6577641">.</span><span class="ident" id="6577642">Itoa</span><span class="op" id="6577646">(</span><span class="ident" id="6577647">os</span><span class="op" id="6577649">.</span><span class="ident" id="6577650">Getpid</span><span class="op" id="6577656">(</span><span class="op" id="6577657">)</span><span class="op" id="6577658">)</span><span class="op" id="6577659">)</span><span class="op" id="6577660">.</span><span class="ident" id="6577661">Output</span><span class="op" id="6577667">(</span><span class="op" id="6577668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577671">if</span>&nbsp;<span class="ident" id="6577674">err</span>&nbsp;<span class="op" id="6577678">!=</span>&nbsp;<span class="ident" id="6577681">nil</span>&nbsp;<span class="op" id="6577685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577689">return</span>&nbsp;<span class="num" id="6577696">0</span><span class="op" id="6577697">,</span>&nbsp;<span class="num" id="6577699">0</span><span class="op" id="6577700">,</span>&nbsp;<span class="num" id="6577702">0</span><span class="op" id="6577703">,</span>&nbsp;<span class="ident" id="6577705">err</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577713">ntcp</span>&nbsp;<span class="op" id="6577718">+=</span>&nbsp;<span class="ident" id="6577721">bytes</span><span class="op" id="6577726">.</span><span class="ident" id="6577727">Count</span><span class="op" id="6577732">(</span><span class="ident" id="6577733">lsof</span><span class="op" id="6577737">,</span>&nbsp;<span class="op" id="6577739">[</span><span class="op" id="6577740">]</span><span class="builtintype" id="6577741">byte</span><span class="op" id="6577745">(</span><span class="string" id="6577746">&#34;TCP&#34;</span><span class="op" id="6577751">)</span><span class="op" id="6577752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577755">for</span>&nbsp;<span class="ident" id="6577759">_</span><span class="op" id="6577760">,</span>&nbsp;<span class="ident" id="6577762">state</span>&nbsp;<span class="op" id="6577768">:=</span>&nbsp;<span class="keyword" id="6577771">range</span>&nbsp;<span class="op" id="6577777">[</span><span class="op" id="6577778">]</span><span class="builtintype" id="6577779">string</span><span class="op" id="6577785">{</span><span class="string" id="6577786">&#34;LISTEN&#34;</span><span class="op" id="6577794">,</span>&nbsp;<span class="string" id="6577796">&#34;SYN_SENT&#34;</span><span class="op" id="6577806">,</span>&nbsp;<span class="string" id="6577808">&#34;SYN_RECEIVED&#34;</span><span class="op" id="6577822">,</span>&nbsp;<span class="string" id="6577824">&#34;ESTABLISHED&#34;</span><span class="op" id="6577837">}</span>&nbsp;<span class="op" id="6577839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6577843">nopen</span>&nbsp;<span class="op" id="6577849">+=</span>&nbsp;<span class="ident" id="6577852">bytes</span><span class="op" id="6577857">.</span><span class="ident" id="6577858">Count</span><span class="op" id="6577863">(</span><span class="ident" id="6577864">lsof</span><span class="op" id="6577868">,</span>&nbsp;<span class="op" id="6577870">[</span><span class="op" id="6577871">]</span><span class="builtintype" id="6577872">byte</span><span class="op" id="6577876">(</span><span class="ident" id="6577877">state</span><span class="op" id="6577882">)</span><span class="op" id="6577883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6577886">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6577889">for</span>&nbsp;<span class="ident" id="6577893">_</span><span class="op" id="6577894">,</span>&nbsp;<span class="ident" id="6577896">state</span>&nbsp;<span class="op" id="6577902">:=</span>&nbsp;<span class="keyword" id="6577905">range</span>&nbsp;<span class="op" id="6577911">[</span><span class="op" id="6577912">]</span><span class="builtintype" id="6577913">string</span><span class="op" id="6577919">{</span><span class="string" id="6577920">&#34;CLOSED&#34;</span><span class="op" id="6577928">,</span>&nbsp;<span class="string" id="6577930">&#34;CLOSE_WAIT&#34;</span><span class="op" id="6577942">,</span>&nbsp;<span class="string" id="6577944">&#34;LAST_ACK&#34;</span><span class="op" id="6577954">,</span>&nbsp;<span class="string" id="6577956">&#34;FIN_WAIT_1&#34;</span><span class="op" id="6577968">,</span>&nbsp;<span class="string" id="6577970">&#34;FIN_WAIT_2&#34;</span><span class="op" id="6577982">,</span>&nbsp;<span class="string" id="6577984">&#34;CLOSING&#34;</span><span class="op" id="6577993">,</span>&nbsp;<span class="string" id="6577995">&#34;TIME_WAIT&#34;</span><span class="op" id="6578006">}</span>&nbsp;<span class="op" id="6578008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578012">nclose</span>&nbsp;<span class="op" id="6578019">+=</span>&nbsp;<span class="ident" id="6578022">bytes</span><span class="op" id="6578027">.</span><span class="ident" id="6578028">Count</span><span class="op" id="6578033">(</span><span class="ident" id="6578034">lsof</span><span class="op" id="6578038">,</span>&nbsp;<span class="op" id="6578040">[</span><span class="op" id="6578041">]</span><span class="builtintype" id="6578042">byte</span><span class="op" id="6578046">(</span><span class="ident" id="6578047">state</span><span class="op" id="6578052">)</span><span class="op" id="6578053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578059">return</span>&nbsp;<span class="ident" id="6578066">ntcp</span><span class="op" id="6578070">,</span>&nbsp;<span class="ident" id="6578072">nopen</span><span class="op" id="6578077">,</span>&nbsp;<span class="ident" id="6578079">nclose</span><span class="op" id="6578085">,</span>&nbsp;<span class="ident" id="6578087">nil</span><br>
<span class="lineno"></span><span class="op" id="6578091">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="keyword" id="6578094">func</span>&nbsp;<span class="ident" id="6578099">TestDialMultiFDLeak</span><span class="op" id="6578118">(</span><span class="ident" id="6578119">t</span>&nbsp;<span class="op" id="6578121">*</span><span class="ident" id="6578122">testing</span><span class="op" id="6578129">.</span><span class="ident" id="6578130">T</span><span class="op" id="6578131">)</span>&nbsp;<span class="op" id="6578133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578136">t</span><span class="op" id="6578137">.</span><span class="ident" id="6578138">Skip</span><span class="op" id="6578142">(</span><span class="string" id="6578143">&#34;flaky&nbsp;test&nbsp;-&nbsp;golang.org/issue/8764&#34;</span><span class="op" id="6578179">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578183">if</span>&nbsp;<span class="op" id="6578186">!</span><span class="ident" id="6578187">supportsIPv4</span>&nbsp;<span class="op" id="6578200">||</span>&nbsp;<span class="op" id="6578203">!</span><span class="ident" id="6578204">supportsIPv6</span>&nbsp;<span class="op" id="6578217">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578221">t</span><span class="op" id="6578222">.</span><span class="ident" id="6578223">Skip</span><span class="op" id="6578227">(</span><span class="string" id="6578228">&#34;neither&nbsp;ipv4&nbsp;nor&nbsp;ipv6&nbsp;is&nbsp;supported&#34;</span><span class="op" id="6578264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578271">halfDeadServer</span>&nbsp;<span class="op" id="6578286">:=</span>&nbsp;<span class="keyword" id="6578289">func</span><span class="op" id="6578293">(</span><span class="ident" id="6578294">dss</span>&nbsp;<span class="op" id="6578298">*</span><span class="ident" id="6578299">dualStackServer</span><span class="op" id="6578314">,</span>&nbsp;<span class="ident" id="6578316">ln</span>&nbsp;<span class="ident" id="6578319">Listener</span><span class="op" id="6578327">)</span>&nbsp;<span class="op" id="6578329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578333">for</span>&nbsp;<span class="op" id="6578337">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578342">if</span>&nbsp;<span class="ident" id="6578345">c</span><span class="op" id="6578346">,</span>&nbsp;<span class="ident" id="6578348">err</span>&nbsp;<span class="op" id="6578352">:=</span>&nbsp;<span class="ident" id="6578355">ln</span><span class="op" id="6578357">.</span><span class="ident" id="6578358">Accept</span><span class="op" id="6578364">(</span><span class="op" id="6578365">)</span><span class="op" id="6578366">;</span>&nbsp;<span class="ident" id="6578368">err</span>&nbsp;<span class="op" id="6578372">!=</span>&nbsp;<span class="ident" id="6578375">nil</span>&nbsp;<span class="op" id="6578379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578385">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578395">}</span>&nbsp;<span class="keyword" id="6578397">else</span>&nbsp;<span class="op" id="6578402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6578408">//&nbsp;It&nbsp;just&nbsp;keeps&nbsp;established</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6578441">//&nbsp;connections&nbsp;like&nbsp;a&nbsp;half-dead&nbsp;server</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6578484">//&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578497">dss</span><span class="op" id="6578500">.</span><span class="ident" id="6578501">putConn</span><span class="op" id="6578508">(</span><span class="ident" id="6578509">c</span><span class="op" id="6578510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578522">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578525">dss</span><span class="op" id="6578528">,</span>&nbsp;<span class="ident" id="6578530">err</span>&nbsp;<span class="op" id="6578534">:=</span>&nbsp;<span class="ident" id="6578537">newDualStackServer</span><span class="op" id="6578555">(</span><span class="op" id="6578556">[</span><span class="op" id="6578557">]</span><span class="ident" id="6578558">streamListener</span><span class="op" id="6578572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578576">{</span><span class="ident" id="6578577">net</span><span class="op" id="6578580">:</span>&nbsp;<span class="string" id="6578582">&#34;tcp4&#34;</span><span class="op" id="6578588">,</span>&nbsp;<span class="ident" id="6578590">addr</span><span class="op" id="6578594">:</span>&nbsp;<span class="string" id="6578596">&#34;127.0.0.1&#34;</span><span class="op" id="6578607">}</span><span class="op" id="6578608">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578612">{</span><span class="ident" id="6578613">net</span><span class="op" id="6578616">:</span>&nbsp;<span class="string" id="6578618">&#34;tcp6&#34;</span><span class="op" id="6578624">,</span>&nbsp;<span class="ident" id="6578626">addr</span><span class="op" id="6578630">:</span>&nbsp;<span class="string" id="6578632">&#34;[::1]&#34;</span><span class="op" id="6578639">}</span><span class="op" id="6578640">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578643">}</span><span class="op" id="6578644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578647">if</span>&nbsp;<span class="ident" id="6578650">err</span>&nbsp;<span class="op" id="6578654">!=</span>&nbsp;<span class="ident" id="6578657">nil</span>&nbsp;<span class="op" id="6578661">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578665">t</span><span class="op" id="6578666">.</span><span class="ident" id="6578667">Fatalf</span><span class="op" id="6578673">(</span><span class="string" id="6578674">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6578705">,</span>&nbsp;<span class="ident" id="6578707">err</span><span class="op" id="6578710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578716">defer</span>&nbsp;<span class="ident" id="6578722">dss</span><span class="op" id="6578725">.</span><span class="ident" id="6578726">teardown</span><span class="op" id="6578734">(</span><span class="op" id="6578735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578738">if</span>&nbsp;<span class="ident" id="6578741">err</span>&nbsp;<span class="op" id="6578745">:=</span>&nbsp;<span class="ident" id="6578748">dss</span><span class="op" id="6578751">.</span><span class="ident" id="6578752">buildup</span><span class="op" id="6578759">(</span><span class="ident" id="6578760">halfDeadServer</span><span class="op" id="6578774">)</span><span class="op" id="6578775">;</span>&nbsp;<span class="ident" id="6578777">err</span>&nbsp;<span class="op" id="6578781">!=</span>&nbsp;<span class="ident" id="6578784">nil</span>&nbsp;<span class="op" id="6578788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578792">t</span><span class="op" id="6578793">.</span><span class="ident" id="6578794">Fatalf</span><span class="op" id="6578800">(</span><span class="string" id="6578801">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6578837">,</span>&nbsp;<span class="ident" id="6578839">err</span><span class="op" id="6578842">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578849">_</span><span class="op" id="6578850">,</span>&nbsp;<span class="ident" id="6578852">before</span><span class="op" id="6578858">,</span>&nbsp;<span class="ident" id="6578860">_</span><span class="op" id="6578861">,</span>&nbsp;<span class="ident" id="6578863">err</span>&nbsp;<span class="op" id="6578867">:=</span>&nbsp;<span class="ident" id="6578870">numTCP</span><span class="op" id="6578876">(</span><span class="op" id="6578877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578880">if</span>&nbsp;<span class="ident" id="6578883">err</span>&nbsp;<span class="op" id="6578887">!=</span>&nbsp;<span class="ident" id="6578890">nil</span>&nbsp;<span class="op" id="6578894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578898">t</span><span class="op" id="6578899">.</span><span class="ident" id="6578900">Skipf</span><span class="op" id="6578905">(</span><span class="string" id="6578906">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="6578956">,</span>&nbsp;<span class="ident" id="6578958">err</span><span class="op" id="6578961">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6578964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6578968">var</span>&nbsp;<span class="ident" id="6578972">wg</span>&nbsp;<span class="ident" id="6578975">sync</span><span class="op" id="6578979">.</span><span class="ident" id="6578980">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6578991">portnum</span><span class="op" id="6578998">,</span>&nbsp;<span class="ident" id="6579000">_</span><span class="op" id="6579001">,</span>&nbsp;<span class="ident" id="6579003">_</span>&nbsp;<span class="op" id="6579005">:=</span>&nbsp;<span class="ident" id="6579008">dtoi</span><span class="op" id="6579012">(</span><span class="ident" id="6579013">dss</span><span class="op" id="6579016">.</span><span class="ident" id="6579017">port</span><span class="op" id="6579021">,</span>&nbsp;<span class="num" id="6579023">0</span><span class="op" id="6579024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579027">ras</span>&nbsp;<span class="op" id="6579031">:=</span>&nbsp;<span class="ident" id="6579034">addrList</span><span class="op" id="6579042">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6579046">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;fail&nbsp;to&nbsp;connect,&nbsp;see&nbsp;RFC&nbsp;6890.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6579099">&amp;</span><span class="ident" id="6579100">TCPAddr</span><span class="op" id="6579107">{</span><span class="ident" id="6579108">IP</span><span class="op" id="6579110">:</span>&nbsp;<span class="ident" id="6579112">IPv4</span><span class="op" id="6579116">(</span><span class="num" id="6579117">198</span><span class="op" id="6579120">,</span>&nbsp;<span class="num" id="6579122">18</span><span class="op" id="6579124">,</span>&nbsp;<span class="num" id="6579126">0</span><span class="op" id="6579127">,</span>&nbsp;<span class="num" id="6579129">254</span><span class="op" id="6579132">)</span><span class="op" id="6579133">,</span>&nbsp;<span class="ident" id="6579135">Port</span><span class="op" id="6579139">:</span>&nbsp;<span class="ident" id="6579141">portnum</span><span class="op" id="6579148">}</span><span class="op" id="6579149">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6579153">&amp;</span><span class="ident" id="6579154">TCPAddr</span><span class="op" id="6579161">{</span><span class="ident" id="6579162">IP</span><span class="op" id="6579164">:</span>&nbsp;<span class="ident" id="6579166">ParseIP</span><span class="op" id="6579173">(</span><span class="string" id="6579174">&#34;2001:2::254&#34;</span><span class="op" id="6579187">)</span><span class="op" id="6579188">,</span>&nbsp;<span class="ident" id="6579190">Port</span><span class="op" id="6579194">:</span>&nbsp;<span class="ident" id="6579196">portnum</span><span class="op" id="6579203">}</span><span class="op" id="6579204">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6579209">//&nbsp;Winner&nbsp;candidates&nbsp;of&nbsp;this&nbsp;race.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6579246">&amp;</span><span class="ident" id="6579247">TCPAddr</span><span class="op" id="6579254">{</span><span class="ident" id="6579255">IP</span><span class="op" id="6579257">:</span>&nbsp;<span class="ident" id="6579259">IPv4</span><span class="op" id="6579263">(</span><span class="num" id="6579264">127</span><span class="op" id="6579267">,</span>&nbsp;<span class="num" id="6579269">0</span><span class="op" id="6579270">,</span>&nbsp;<span class="num" id="6579272">0</span><span class="op" id="6579273">,</span>&nbsp;<span class="num" id="6579275">1</span><span class="op" id="6579276">)</span><span class="op" id="6579277">,</span>&nbsp;<span class="ident" id="6579279">Port</span><span class="op" id="6579283">:</span>&nbsp;<span class="ident" id="6579285">portnum</span><span class="op" id="6579292">}</span><span class="op" id="6579293">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6579297">&amp;</span><span class="ident" id="6579298">TCPAddr</span><span class="op" id="6579305">{</span><span class="ident" id="6579306">IP</span><span class="op" id="6579308">:</span>&nbsp;<span class="ident" id="6579310">IPv6loopback</span><span class="op" id="6579322">,</span>&nbsp;<span class="ident" id="6579324">Port</span><span class="op" id="6579328">:</span>&nbsp;<span class="ident" id="6579330">portnum</span><span class="op" id="6579337">}</span><span class="op" id="6579338">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6579343">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;have&nbsp;established&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6579395">&amp;</span><span class="ident" id="6579396">TCPAddr</span><span class="op" id="6579403">{</span><span class="ident" id="6579404">IP</span><span class="op" id="6579406">:</span>&nbsp;<span class="ident" id="6579408">IPv4</span><span class="op" id="6579412">(</span><span class="num" id="6579413">127</span><span class="op" id="6579416">,</span>&nbsp;<span class="num" id="6579418">0</span><span class="op" id="6579419">,</span>&nbsp;<span class="num" id="6579421">0</span><span class="op" id="6579422">,</span>&nbsp;<span class="num" id="6579424">1</span><span class="op" id="6579425">)</span><span class="op" id="6579426">,</span>&nbsp;<span class="ident" id="6579428">Port</span><span class="op" id="6579432">:</span>&nbsp;<span class="ident" id="6579434">portnum</span><span class="op" id="6579441">}</span><span class="op" id="6579442">,</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6579446">&amp;</span><span class="ident" id="6579447">TCPAddr</span><span class="op" id="6579454">{</span><span class="ident" id="6579455">IP</span><span class="op" id="6579457">:</span>&nbsp;<span class="ident" id="6579459">IPv6loopback</span><span class="op" id="6579471">,</span>&nbsp;<span class="ident" id="6579473">Port</span><span class="op" id="6579477">:</span>&nbsp;<span class="ident" id="6579479">portnum</span><span class="op" id="6579486">}</span><span class="op" id="6579487">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6579490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6579493">const</span>&nbsp;<span class="ident" id="6579499">T1</span>&nbsp;<span class="op" id="6579502">=</span>&nbsp;<span class="num" id="6579504">10</span>&nbsp;<span class="op" id="6579507">*</span>&nbsp;<span class="ident" id="6579509">time</span><span class="op" id="6579513">.</span><span class="ident" id="6579514">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6579527">const</span>&nbsp;<span class="ident" id="6579533">T2</span>&nbsp;<span class="op" id="6579536">=</span>&nbsp;<span class="num" id="6579538">2</span>&nbsp;<span class="op" id="6579540">*</span>&nbsp;<span class="ident" id="6579542">T1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6579546">const</span>&nbsp;<span class="ident" id="6579552">N</span>&nbsp;<span class="op" id="6579554">=</span>&nbsp;<span class="num" id="6579556">10</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6579560">for</span>&nbsp;<span class="ident" id="6579564">i</span>&nbsp;<span class="op" id="6579566">:=</span>&nbsp;<span class="num" id="6579569">0</span><span class="op" id="6579570">;</span>&nbsp;<span class="ident" id="6579572">i</span>&nbsp;<span class="op" id="6579574">&lt;</span>&nbsp;<span class="ident" id="6579576">N</span><span class="op" id="6579577">;</span>&nbsp;<span class="ident" id="6579579">i</span><span class="op" id="6579580">++</span>&nbsp;<span class="op" id="6579583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579587">wg</span><span class="op" id="6579589">.</span><span class="ident" id="6579590">Add</span><span class="op" id="6579593">(</span><span class="num" id="6579594">1</span><span class="op" id="6579595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6579599">go</span>&nbsp;<span class="keyword" id="6579602">func</span><span class="op" id="6579606">(</span><span class="op" id="6579607">)</span>&nbsp;<span class="op" id="6579609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6579614">defer</span>&nbsp;<span class="ident" id="6579620">wg</span><span class="op" id="6579622">.</span><span class="ident" id="6579623">Done</span><span class="op" id="6579627">(</span><span class="op" id="6579628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6579633">if</span>&nbsp;<span class="ident" id="6579636">c</span><span class="op" id="6579637">,</span>&nbsp;<span class="ident" id="6579639">err</span>&nbsp;<span class="op" id="6579643">:=</span>&nbsp;<span class="ident" id="6579646">dialMulti</span><span class="op" id="6579655">(</span><span class="string" id="6579656">&#34;tcp&#34;</span><span class="op" id="6579661">,</span>&nbsp;<span class="string" id="6579663">&#34;fast&nbsp;failover&nbsp;test&#34;</span><span class="op" id="6579683">,</span>&nbsp;<span class="ident" id="6579685">nil</span><span class="op" id="6579688">,</span>&nbsp;<span class="ident" id="6579690">ras</span><span class="op" id="6579693">,</span>&nbsp;<span class="ident" id="6579695">time</span><span class="op" id="6579699">.</span><span class="ident" id="6579700">Now</span><span class="op" id="6579703">(</span><span class="op" id="6579704">)</span><span class="op" id="6579705">.</span><span class="ident" id="6579706">Add</span><span class="op" id="6579709">(</span><span class="ident" id="6579710">T1</span><span class="op" id="6579712">)</span><span class="op" id="6579713">)</span><span class="op" id="6579714">;</span>&nbsp;<span class="ident" id="6579716">err</span>&nbsp;<span class="op" id="6579720">==</span>&nbsp;<span class="ident" id="6579723">nil</span>&nbsp;<span class="op" id="6579727">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579733">c</span><span class="op" id="6579734">.</span><span class="ident" id="6579735">Close</span><span class="op" id="6579740">(</span><span class="op" id="6579741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6579746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6579750">}</span><span class="op" id="6579751">(</span><span class="op" id="6579752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6579755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579758">wg</span><span class="op" id="6579760">.</span><span class="ident" id="6579761">Wait</span><span class="op" id="6579765">(</span><span class="op" id="6579766">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579769">time</span><span class="op" id="6579773">.</span><span class="ident" id="6579774">Sleep</span><span class="op" id="6579779">(</span><span class="ident" id="6579780">T2</span><span class="op" id="6579782">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579786">ntcp</span><span class="op" id="6579790">,</span>&nbsp;<span class="ident" id="6579792">after</span><span class="op" id="6579797">,</span>&nbsp;<span class="ident" id="6579799">nclose</span><span class="op" id="6579805">,</span>&nbsp;<span class="ident" id="6579807">err</span>&nbsp;<span class="op" id="6579811">:=</span>&nbsp;<span class="ident" id="6579814">numTCP</span><span class="op" id="6579820">(</span><span class="op" id="6579821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6579824">if</span>&nbsp;<span class="ident" id="6579827">err</span>&nbsp;<span class="op" id="6579831">!=</span>&nbsp;<span class="ident" id="6579834">nil</span>&nbsp;<span class="op" id="6579838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579842">t</span><span class="op" id="6579843">.</span><span class="ident" id="6579844">Skipf</span><span class="op" id="6579849">(</span><span class="string" id="6579850">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="6579900">,</span>&nbsp;<span class="ident" id="6579902">err</span><span class="op" id="6579905">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6579908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6579911">t</span><span class="op" id="6579912">.</span><span class="ident" id="6579913">Logf</span><span class="op" id="6579917">(</span><span class="string" id="6579918">&#34;tcp&nbsp;sessions:&nbsp;%v,&nbsp;open&nbsp;sessions:&nbsp;%v,&nbsp;closing&nbsp;sessions:&nbsp;%v&#34;</span><span class="op" id="6579977">,</span>&nbsp;<span class="ident" id="6579979">ntcp</span><span class="op" id="6579983">,</span>&nbsp;<span class="ident" id="6579985">after</span><span class="op" id="6579990">,</span>&nbsp;<span class="ident" id="6579992">nclose</span><span class="op" id="6579998">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580002">if</span>&nbsp;<span class="ident" id="6580005">after</span>&nbsp;<span class="op" id="6580011">!=</span>&nbsp;<span class="ident" id="6580014">before</span>&nbsp;<span class="op" id="6580021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580025">t</span><span class="op" id="6580026">.</span><span class="ident" id="6580027">Fatalf</span><span class="op" id="6580033">(</span><span class="string" id="6580034">&#34;got&nbsp;%v&nbsp;open&nbsp;sessions;&nbsp;expected&nbsp;%v&#34;</span><span class="op" id="6580069">,</span>&nbsp;<span class="ident" id="6580071">after</span><span class="op" id="6580076">,</span>&nbsp;<span class="ident" id="6580078">before</span><span class="op" id="6580084">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6580087">}</span><br>
<span class="lineno"></span><span class="op" id="6580089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6580092">func</span>&nbsp;<span class="ident" id="6580097">numFD</span><span class="op" id="6580102">(</span><span class="op" id="6580103">)</span>&nbsp;<span class="builtintype" id="6580105">int</span>&nbsp;<span class="op" id="6580109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580112">if</span>&nbsp;<span class="ident" id="6580115">runtime</span><span class="op" id="6580122">.</span><span class="ident" id="6580123">GOOS</span>&nbsp;<span class="op" id="6580128">==</span>&nbsp;<span class="string" id="6580131">&#34;linux&#34;</span>&nbsp;<span class="op" id="6580139">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580143">f</span><span class="op" id="6580144">,</span>&nbsp;<span class="ident" id="6580146">err</span>&nbsp;<span class="op" id="6580150">:=</span>&nbsp;<span class="ident" id="6580153">os</span><span class="op" id="6580155">.</span><span class="ident" id="6580156">Open</span><span class="op" id="6580160">(</span><span class="string" id="6580161">&#34;/proc/self/fd&#34;</span><span class="op" id="6580176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580180">if</span>&nbsp;<span class="ident" id="6580183">err</span>&nbsp;<span class="op" id="6580187">!=</span>&nbsp;<span class="ident" id="6580190">nil</span>&nbsp;<span class="op" id="6580194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6580199">panic</span><span class="op" id="6580204">(</span><span class="ident" id="6580205">err</span><span class="op" id="6580208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6580212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580216">defer</span>&nbsp;<span class="ident" id="6580222">f</span><span class="op" id="6580223">.</span><span class="ident" id="6580224">Close</span><span class="op" id="6580229">(</span><span class="op" id="6580230">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580234">names</span><span class="op" id="6580239">,</span>&nbsp;<span class="ident" id="6580241">err</span>&nbsp;<span class="op" id="6580245">:=</span>&nbsp;<span class="ident" id="6580248">f</span><span class="op" id="6580249">.</span><span class="ident" id="6580250">Readdirnames</span><span class="op" id="6580262">(</span><span class="num" id="6580263">0</span><span class="op" id="6580264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580268">if</span>&nbsp;<span class="ident" id="6580271">err</span>&nbsp;<span class="op" id="6580275">!=</span>&nbsp;<span class="ident" id="6580278">nil</span>&nbsp;<span class="op" id="6580282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6580287">panic</span><span class="op" id="6580292">(</span><span class="ident" id="6580293">err</span><span class="op" id="6580296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6580300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580304">return</span>&nbsp;<span class="builtinfunc" id="6580311">len</span><span class="op" id="6580314">(</span><span class="ident" id="6580315">names</span><span class="op" id="6580320">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6580323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6580326">//&nbsp;All&nbsp;tests&nbsp;using&nbsp;this&nbsp;should&nbsp;be&nbsp;skipped&nbsp;anyway,&nbsp;but:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6580382">panic</span><span class="op" id="6580387">(</span><span class="string" id="6580388">&#34;numFDs&nbsp;not&nbsp;implemented&nbsp;on&nbsp;&#34;</span>&nbsp;<span class="op" id="6580417">+</span>&nbsp;<span class="ident" id="6580419">runtime</span><span class="op" id="6580426">.</span><span class="ident" id="6580427">GOOS</span><span class="op" id="6580431">)</span><br>
<span class="lineno"></span><span class="op" id="6580433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="6580436">func</span>&nbsp;<span class="ident" id="6580441">TestDialer</span><span class="op" id="6580451">(</span><span class="ident" id="6580452">t</span>&nbsp;<span class="op" id="6580454">*</span><span class="ident" id="6580455">testing</span><span class="op" id="6580462">.</span><span class="ident" id="6580463">T</span><span class="op" id="6580464">)</span>&nbsp;<span class="op" id="6580466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580469">ln</span><span class="op" id="6580471">,</span>&nbsp;<span class="ident" id="6580473">err</span>&nbsp;<span class="op" id="6580477">:=</span>&nbsp;<span class="ident" id="6580480">Listen</span><span class="op" id="6580486">(</span><span class="string" id="6580487">&#34;tcp4&#34;</span><span class="op" id="6580493">,</span>&nbsp;<span class="string" id="6580495">&#34;127.0.0.1:0&#34;</span><span class="op" id="6580508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580511">if</span>&nbsp;<span class="ident" id="6580514">err</span>&nbsp;<span class="op" id="6580518">!=</span>&nbsp;<span class="ident" id="6580521">nil</span>&nbsp;<span class="op" id="6580525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580529">t</span><span class="op" id="6580530">.</span><span class="ident" id="6580531">Fatalf</span><span class="op" id="6580537">(</span><span class="string" id="6580538">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6580557">,</span>&nbsp;<span class="ident" id="6580559">err</span><span class="op" id="6580562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6580565">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580568">defer</span>&nbsp;<span class="ident" id="6580574">ln</span><span class="op" id="6580576">.</span><span class="ident" id="6580577">Close</span><span class="op" id="6580582">(</span><span class="op" id="6580583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580586">ch</span>&nbsp;<span class="op" id="6580589">:=</span>&nbsp;<span class="builtinfunc" id="6580592">make</span><span class="op" id="6580596">(</span><span class="keyword" id="6580597">chan</span>&nbsp;<span class="builtintype" id="6580602">error</span><span class="op" id="6580607">,</span>&nbsp;<span class="num" id="6580609">1</span><span class="op" id="6580610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580613">go</span>&nbsp;<span class="keyword" id="6580616">func</span><span class="op" id="6580620">(</span><span class="op" id="6580621">)</span>&nbsp;<span class="op" id="6580623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580627">c</span><span class="op" id="6580628">,</span>&nbsp;<span class="ident" id="6580630">err</span>&nbsp;<span class="op" id="6580634">:=</span>&nbsp;<span class="ident" id="6580637">ln</span><span class="op" id="6580639">.</span><span class="ident" id="6580640">Accept</span><span class="op" id="6580646">(</span><span class="op" id="6580647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580651">if</span>&nbsp;<span class="ident" id="6580654">err</span>&nbsp;<span class="op" id="6580658">!=</span>&nbsp;<span class="ident" id="6580661">nil</span>&nbsp;<span class="op" id="6580665">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580670">ch</span>&nbsp;<span class="op" id="6580673">&lt;-</span>&nbsp;<span class="ident" id="6580676">fmt</span><span class="op" id="6580679">.</span><span class="ident" id="6580680">Errorf</span><span class="op" id="6580686">(</span><span class="string" id="6580687">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6580706">,</span>&nbsp;<span class="ident" id="6580708">err</span><span class="op" id="6580711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580716">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6580725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580729">defer</span>&nbsp;<span class="ident" id="6580735">c</span><span class="op" id="6580736">.</span><span class="ident" id="6580737">Close</span><span class="op" id="6580742">(</span><span class="op" id="6580743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580747">ch</span>&nbsp;<span class="op" id="6580750">&lt;-</span>&nbsp;<span class="ident" id="6580753">nil</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6580758">}</span><span class="op" id="6580759">(</span><span class="op" id="6580760">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580764">laddr</span><span class="op" id="6580769">,</span>&nbsp;<span class="ident" id="6580771">err</span>&nbsp;<span class="op" id="6580775">:=</span>&nbsp;<span class="ident" id="6580778">ResolveTCPAddr</span><span class="op" id="6580792">(</span><span class="string" id="6580793">&#34;tcp4&#34;</span><span class="op" id="6580799">,</span>&nbsp;<span class="string" id="6580801">&#34;127.0.0.1:0&#34;</span><span class="op" id="6580814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580817">if</span>&nbsp;<span class="ident" id="6580820">err</span>&nbsp;<span class="op" id="6580824">!=</span>&nbsp;<span class="ident" id="6580827">nil</span>&nbsp;<span class="op" id="6580831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580835">t</span><span class="op" id="6580836">.</span><span class="ident" id="6580837">Fatalf</span><span class="op" id="6580843">(</span><span class="string" id="6580844">&#34;ResolveTCPAddr&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6580871">,</span>&nbsp;<span class="ident" id="6580873">err</span><span class="op" id="6580876">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6580879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580882">d</span>&nbsp;<span class="op" id="6580884">:=</span>&nbsp;<span class="op" id="6580887">&amp;</span><span class="ident" id="6580888">Dialer</span><span class="op" id="6580894">{</span><span class="ident" id="6580895">LocalAddr</span><span class="op" id="6580904">:</span>&nbsp;<span class="ident" id="6580906">laddr</span><span class="op" id="6580911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580914">c</span><span class="op" id="6580915">,</span>&nbsp;<span class="ident" id="6580917">err</span>&nbsp;<span class="op" id="6580921">:=</span>&nbsp;<span class="ident" id="6580924">d</span><span class="op" id="6580925">.</span><span class="ident" id="6580926">Dial</span><span class="op" id="6580930">(</span><span class="string" id="6580931">&#34;tcp4&#34;</span><span class="op" id="6580937">,</span>&nbsp;<span class="ident" id="6580939">ln</span><span class="op" id="6580941">.</span><span class="ident" id="6580942">Addr</span><span class="op" id="6580946">(</span><span class="op" id="6580947">)</span><span class="op" id="6580948">.</span><span class="ident" id="6580949">String</span><span class="op" id="6580955">(</span><span class="op" id="6580956">)</span><span class="op" id="6580957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6580960">if</span>&nbsp;<span class="ident" id="6580963">err</span>&nbsp;<span class="op" id="6580967">!=</span>&nbsp;<span class="ident" id="6580970">nil</span>&nbsp;<span class="op" id="6580974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6580978">t</span><span class="op" id="6580979">.</span><span class="ident" id="6580980">Fatalf</span><span class="op" id="6580986">(</span><span class="string" id="6580987">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6581004">,</span>&nbsp;<span class="ident" id="6581006">err</span><span class="op" id="6581009">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581015">defer</span>&nbsp;<span class="ident" id="6581021">c</span><span class="op" id="6581022">.</span><span class="ident" id="6581023">Close</span><span class="op" id="6581028">(</span><span class="op" id="6581029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581032">c</span><span class="op" id="6581033">.</span><span class="ident" id="6581034">Read</span><span class="op" id="6581038">(</span><span class="builtinfunc" id="6581039">make</span><span class="op" id="6581043">(</span><span class="op" id="6581044">[</span><span class="op" id="6581045">]</span><span class="builtintype" id="6581046">byte</span><span class="op" id="6581050">,</span>&nbsp;<span class="num" id="6581052">1</span><span class="op" id="6581053">)</span><span class="op" id="6581054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581057">err</span>&nbsp;<span class="op" id="6581061">=</span>&nbsp;<span class="op" id="6581063">&lt;-</span><span class="ident" id="6581065">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581069">if</span>&nbsp;<span class="ident" id="6581072">err</span>&nbsp;<span class="op" id="6581076">!=</span>&nbsp;<span class="ident" id="6581079">nil</span>&nbsp;<span class="op" id="6581083">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581087">t</span><span class="op" id="6581088">.</span><span class="ident" id="6581089">Error</span><span class="op" id="6581094">(</span><span class="ident" id="6581095">err</span><span class="op" id="6581098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581101">}</span><br>
<span class="lineno"></span><span class="op" id="6581103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6581106">func</span>&nbsp;<span class="ident" id="6581111">TestDialDualStackLocalhost</span><span class="op" id="6581137">(</span><span class="ident" id="6581138">t</span>&nbsp;<span class="op" id="6581140">*</span><span class="ident" id="6581141">testing</span><span class="op" id="6581148">.</span><span class="ident" id="6581149">T</span><span class="op" id="6581150">)</span>&nbsp;<span class="op" id="6581152">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581155">switch</span>&nbsp;<span class="ident" id="6581162">runtime</span><span class="op" id="6581169">.</span><span class="ident" id="6581170">GOOS</span>&nbsp;<span class="op" id="6581175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581178">case</span>&nbsp;<span class="string" id="6581183">&#34;nacl&#34;</span><span class="op" id="6581189">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581193">t</span><span class="op" id="6581194">.</span><span class="ident" id="6581195">Skipf</span><span class="op" id="6581200">(</span><span class="string" id="6581201">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6581222">,</span>&nbsp;<span class="ident" id="6581224">runtime</span><span class="op" id="6581231">.</span><span class="ident" id="6581232">GOOS</span><span class="op" id="6581236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581243">if</span>&nbsp;<span class="ident" id="6581246">ips</span><span class="op" id="6581249">,</span>&nbsp;<span class="ident" id="6581251">err</span>&nbsp;<span class="op" id="6581255">:=</span>&nbsp;<span class="ident" id="6581258">LookupIP</span><span class="op" id="6581266">(</span><span class="string" id="6581267">&#34;localhost&#34;</span><span class="op" id="6581278">)</span><span class="op" id="6581279">;</span>&nbsp;<span class="ident" id="6581281">err</span>&nbsp;<span class="op" id="6581285">!=</span>&nbsp;<span class="ident" id="6581288">nil</span>&nbsp;<span class="op" id="6581292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581296">t</span><span class="op" id="6581297">.</span><span class="ident" id="6581298">Fatalf</span><span class="op" id="6581304">(</span><span class="string" id="6581305">&#34;LookupIP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6581326">,</span>&nbsp;<span class="ident" id="6581328">err</span><span class="op" id="6581331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581334">}</span>&nbsp;<span class="keyword" id="6581336">else</span>&nbsp;<span class="keyword" id="6581341">if</span>&nbsp;<span class="builtinfunc" id="6581344">len</span><span class="op" id="6581347">(</span><span class="ident" id="6581348">ips</span><span class="op" id="6581351">)</span>&nbsp;<span class="op" id="6581353">&lt;</span>&nbsp;<span class="num" id="6581355">2</span>&nbsp;<span class="op" id="6581357">||</span>&nbsp;<span class="op" id="6581360">!</span><span class="ident" id="6581361">supportsIPv4</span>&nbsp;<span class="op" id="6581374">||</span>&nbsp;<span class="op" id="6581377">!</span><span class="ident" id="6581378">supportsIPv6</span>&nbsp;<span class="op" id="6581391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581395">t</span><span class="op" id="6581396">.</span><span class="ident" id="6581397">Skip</span><span class="op" id="6581401">(</span><span class="string" id="6581402">&#34;localhost&nbsp;doesn&#39;t&nbsp;have&nbsp;a&nbsp;pair&nbsp;of&nbsp;different&nbsp;address&nbsp;family&nbsp;IP&nbsp;addresses&#34;</span><span class="op" id="6581474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581477">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581481">touchAndByeServer</span>&nbsp;<span class="op" id="6581499">:=</span>&nbsp;<span class="keyword" id="6581502">func</span><span class="op" id="6581506">(</span><span class="ident" id="6581507">dss</span>&nbsp;<span class="op" id="6581511">*</span><span class="ident" id="6581512">dualStackServer</span><span class="op" id="6581527">,</span>&nbsp;<span class="ident" id="6581529">ln</span>&nbsp;<span class="ident" id="6581532">Listener</span><span class="op" id="6581540">)</span>&nbsp;<span class="op" id="6581542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581546">for</span>&nbsp;<span class="op" id="6581550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581555">if</span>&nbsp;<span class="ident" id="6581558">c</span><span class="op" id="6581559">,</span>&nbsp;<span class="ident" id="6581561">err</span>&nbsp;<span class="op" id="6581565">:=</span>&nbsp;<span class="ident" id="6581568">ln</span><span class="op" id="6581570">.</span><span class="ident" id="6581571">Accept</span><span class="op" id="6581577">(</span><span class="op" id="6581578">)</span><span class="op" id="6581579">;</span>&nbsp;<span class="ident" id="6581581">err</span>&nbsp;<span class="op" id="6581585">!=</span>&nbsp;<span class="ident" id="6581588">nil</span>&nbsp;<span class="op" id="6581592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581598">return</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581608">}</span>&nbsp;<span class="keyword" id="6581610">else</span>&nbsp;<span class="op" id="6581615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581621">c</span><span class="op" id="6581622">.</span><span class="ident" id="6581623">Close</span><span class="op" id="6581628">(</span><span class="op" id="6581629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581641">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581644">dss</span><span class="op" id="6581647">,</span>&nbsp;<span class="ident" id="6581649">err</span>&nbsp;<span class="op" id="6581653">:=</span>&nbsp;<span class="ident" id="6581656">newDualStackServer</span><span class="op" id="6581674">(</span><span class="op" id="6581675">[</span><span class="op" id="6581676">]</span><span class="ident" id="6581677">streamListener</span><span class="op" id="6581691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581695">{</span><span class="ident" id="6581696">net</span><span class="op" id="6581699">:</span>&nbsp;<span class="string" id="6581701">&#34;tcp4&#34;</span><span class="op" id="6581707">,</span>&nbsp;<span class="ident" id="6581709">addr</span><span class="op" id="6581713">:</span>&nbsp;<span class="string" id="6581715">&#34;127.0.0.1&#34;</span><span class="op" id="6581726">}</span><span class="op" id="6581727">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581731">{</span><span class="ident" id="6581732">net</span><span class="op" id="6581735">:</span>&nbsp;<span class="string" id="6581737">&#34;tcp6&#34;</span><span class="op" id="6581743">,</span>&nbsp;<span class="ident" id="6581745">addr</span><span class="op" id="6581749">:</span>&nbsp;<span class="string" id="6581751">&#34;[::1]&#34;</span><span class="op" id="6581758">}</span><span class="op" id="6581759">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581762">}</span><span class="op" id="6581763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581766">if</span>&nbsp;<span class="ident" id="6581769">err</span>&nbsp;<span class="op" id="6581773">!=</span>&nbsp;<span class="ident" id="6581776">nil</span>&nbsp;<span class="op" id="6581780">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581784">t</span><span class="op" id="6581785">.</span><span class="ident" id="6581786">Fatalf</span><span class="op" id="6581792">(</span><span class="string" id="6581793">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6581824">,</span>&nbsp;<span class="ident" id="6581826">err</span><span class="op" id="6581829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581835">defer</span>&nbsp;<span class="ident" id="6581841">dss</span><span class="op" id="6581844">.</span><span class="ident" id="6581845">teardown</span><span class="op" id="6581853">(</span><span class="op" id="6581854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6581857">if</span>&nbsp;<span class="ident" id="6581860">err</span>&nbsp;<span class="op" id="6581864">:=</span>&nbsp;<span class="ident" id="6581867">dss</span><span class="op" id="6581870">.</span><span class="ident" id="6581871">buildup</span><span class="op" id="6581878">(</span><span class="ident" id="6581879">touchAndByeServer</span><span class="op" id="6581896">)</span><span class="op" id="6581897">;</span>&nbsp;<span class="ident" id="6581899">err</span>&nbsp;<span class="op" id="6581903">!=</span>&nbsp;<span class="ident" id="6581906">nil</span>&nbsp;<span class="op" id="6581910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581914">t</span><span class="op" id="6581915">.</span><span class="ident" id="6581916">Fatalf</span><span class="op" id="6581922">(</span><span class="string" id="6581923">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6581959">,</span>&nbsp;<span class="ident" id="6581961">err</span><span class="op" id="6581964">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6581967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6581971">d</span>&nbsp;<span class="op" id="6581973">:=</span>&nbsp;<span class="op" id="6581976">&amp;</span><span class="ident" id="6581977">Dialer</span><span class="op" id="6581983">{</span><span class="ident" id="6581984">DualStack</span><span class="op" id="6581993">:</span>&nbsp;<span class="builtintype" id="6581995">true</span><span class="op" id="6581999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582002">for</span>&nbsp;<span class="keyword" id="6582006">range</span>&nbsp;<span class="ident" id="6582012">dss</span><span class="op" id="6582015">.</span><span class="ident" id="6582016">lns</span>&nbsp;<span class="op" id="6582020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582024">if</span>&nbsp;<span class="ident" id="6582027">c</span><span class="op" id="6582028">,</span>&nbsp;<span class="ident" id="6582030">err</span>&nbsp;<span class="op" id="6582034">:=</span>&nbsp;<span class="ident" id="6582037">d</span><span class="op" id="6582038">.</span><span class="ident" id="6582039">Dial</span><span class="op" id="6582043">(</span><span class="string" id="6582044">&#34;tcp&#34;</span><span class="op" id="6582049">,</span>&nbsp;<span class="string" id="6582051">&#34;localhost:&#34;</span><span class="op" id="6582063">+</span><span class="ident" id="6582064">dss</span><span class="op" id="6582067">.</span><span class="ident" id="6582068">port</span><span class="op" id="6582072">)</span><span class="op" id="6582073">;</span>&nbsp;<span class="ident" id="6582075">err</span>&nbsp;<span class="op" id="6582079">!=</span>&nbsp;<span class="ident" id="6582082">nil</span>&nbsp;<span class="op" id="6582086">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582091">t</span><span class="op" id="6582092">.</span><span class="ident" id="6582093">Errorf</span><span class="op" id="6582099">(</span><span class="string" id="6582100">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6582117">,</span>&nbsp;<span class="ident" id="6582119">err</span><span class="op" id="6582122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582126">}</span>&nbsp;<span class="keyword" id="6582128">else</span>&nbsp;<span class="op" id="6582133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582138">if</span>&nbsp;<span class="ident" id="6582141">addr</span>&nbsp;<span class="op" id="6582146">:=</span>&nbsp;<span class="ident" id="6582149">c</span><span class="op" id="6582150">.</span><span class="ident" id="6582151">LocalAddr</span><span class="op" id="6582160">(</span><span class="op" id="6582161">)</span><span class="op" id="6582162">.</span><span class="op" id="6582163">(</span><span class="op" id="6582164">*</span><span class="ident" id="6582165">TCPAddr</span><span class="op" id="6582172">)</span><span class="op" id="6582173">;</span>&nbsp;<span class="ident" id="6582175">addr</span><span class="op" id="6582179">.</span><span class="ident" id="6582180">IP</span><span class="op" id="6582182">.</span><span class="ident" id="6582183">To4</span><span class="op" id="6582186">(</span><span class="op" id="6582187">)</span>&nbsp;<span class="op" id="6582189">!=</span>&nbsp;<span class="ident" id="6582192">nil</span>&nbsp;<span class="op" id="6582196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582202">dss</span><span class="op" id="6582205">.</span><span class="ident" id="6582206">teardownNetwork</span><span class="op" id="6582221">(</span><span class="string" id="6582222">&#34;tcp4&#34;</span><span class="op" id="6582228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582233">}</span>&nbsp;<span class="keyword" id="6582235">else</span>&nbsp;<span class="keyword" id="6582240">if</span>&nbsp;<span class="ident" id="6582243">addr</span><span class="op" id="6582247">.</span><span class="ident" id="6582248">IP</span><span class="op" id="6582250">.</span><span class="ident" id="6582251">To16</span><span class="op" id="6582255">(</span><span class="op" id="6582256">)</span>&nbsp;<span class="op" id="6582258">!=</span>&nbsp;<span class="ident" id="6582261">nil</span>&nbsp;<span class="op" id="6582265">&amp;&amp;</span>&nbsp;<span class="ident" id="6582268">addr</span><span class="op" id="6582272">.</span><span class="ident" id="6582273">IP</span><span class="op" id="6582275">.</span><span class="ident" id="6582276">To4</span><span class="op" id="6582279">(</span><span class="op" id="6582280">)</span>&nbsp;<span class="op" id="6582282">==</span>&nbsp;<span class="ident" id="6582285">nil</span>&nbsp;<span class="op" id="6582289">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582295">dss</span><span class="op" id="6582298">.</span><span class="ident" id="6582299">teardownNetwork</span><span class="op" id="6582314">(</span><span class="string" id="6582315">&#34;tcp6&#34;</span><span class="op" id="6582321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582331">c</span><span class="op" id="6582332">.</span><span class="ident" id="6582333">Close</span><span class="op" id="6582338">(</span><span class="op" id="6582339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582346">}</span><br>
<span class="lineno">515</span><span class="op" id="6582348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6582351">func</span>&nbsp;<span class="ident" id="6582356">TestDialerKeepAlive</span><span class="op" id="6582375">(</span><span class="ident" id="6582376">t</span>&nbsp;<span class="op" id="6582378">*</span><span class="ident" id="6582379">testing</span><span class="op" id="6582386">.</span><span class="ident" id="6582387">T</span><span class="op" id="6582388">)</span>&nbsp;<span class="op" id="6582390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582393">ln</span>&nbsp;<span class="op" id="6582396">:=</span>&nbsp;<span class="ident" id="6582399">newLocalListener</span><span class="op" id="6582415">(</span><span class="ident" id="6582416">t</span><span class="op" id="6582417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582420">defer</span>&nbsp;<span class="ident" id="6582426">ln</span><span class="op" id="6582428">.</span><span class="ident" id="6582429">Close</span><span class="op" id="6582434">(</span><span class="op" id="6582435">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582438">defer</span>&nbsp;<span class="keyword" id="6582444">func</span><span class="op" id="6582448">(</span><span class="op" id="6582449">)</span>&nbsp;<span class="op" id="6582451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582455">testHookSetKeepAlive</span>&nbsp;<span class="op" id="6582476">=</span>&nbsp;<span class="keyword" id="6582478">func</span><span class="op" id="6582482">(</span><span class="op" id="6582483">)</span>&nbsp;<span class="op" id="6582485">{</span><span class="op" id="6582486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582489">}</span><span class="op" id="6582490">(</span><span class="op" id="6582491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582494">go</span>&nbsp;<span class="keyword" id="6582497">func</span><span class="op" id="6582501">(</span><span class="op" id="6582502">)</span>&nbsp;<span class="op" id="6582504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582508">for</span>&nbsp;<span class="op" id="6582512">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582517">c</span><span class="op" id="6582518">,</span>&nbsp;<span class="ident" id="6582520">err</span>&nbsp;<span class="op" id="6582524">:=</span>&nbsp;<span class="ident" id="6582527">ln</span><span class="op" id="6582529">.</span><span class="ident" id="6582530">Accept</span><span class="op" id="6582536">(</span><span class="op" id="6582537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582542">if</span>&nbsp;<span class="ident" id="6582545">err</span>&nbsp;<span class="op" id="6582549">!=</span>&nbsp;<span class="ident" id="6582552">nil</span>&nbsp;<span class="op" id="6582556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582562">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582577">c</span><span class="op" id="6582578">.</span><span class="ident" id="6582579">Close</span><span class="op" id="6582584">(</span><span class="op" id="6582585">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582592">}</span><span class="op" id="6582593">(</span><span class="op" id="6582594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582597">for</span>&nbsp;<span class="ident" id="6582601">_</span><span class="op" id="6582602">,</span>&nbsp;<span class="ident" id="6582604">keepAlive</span>&nbsp;<span class="op" id="6582614">:=</span>&nbsp;<span class="keyword" id="6582617">range</span>&nbsp;<span class="op" id="6582623">[</span><span class="op" id="6582624">]</span><span class="builtintype" id="6582625">bool</span><span class="op" id="6582629">{</span><span class="builtintype" id="6582630">false</span><span class="op" id="6582635">,</span>&nbsp;<span class="builtintype" id="6582637">true</span><span class="op" id="6582641">}</span>&nbsp;<span class="op" id="6582643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582647">got</span>&nbsp;<span class="op" id="6582651">:=</span>&nbsp;<span class="builtintype" id="6582654">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582662">testHookSetKeepAlive</span>&nbsp;<span class="op" id="6582683">=</span>&nbsp;<span class="keyword" id="6582685">func</span><span class="op" id="6582689">(</span><span class="op" id="6582690">)</span>&nbsp;<span class="op" id="6582692">{</span>&nbsp;<span class="ident" id="6582694">got</span>&nbsp;<span class="op" id="6582698">=</span>&nbsp;<span class="builtintype" id="6582700">true</span>&nbsp;<span class="op" id="6582705">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582709">var</span>&nbsp;<span class="ident" id="6582713">d</span>&nbsp;<span class="ident" id="6582715">Dialer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582724">if</span>&nbsp;<span class="ident" id="6582727">keepAlive</span>&nbsp;<span class="op" id="6582737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582742">d</span><span class="op" id="6582743">.</span><span class="ident" id="6582744">KeepAlive</span>&nbsp;<span class="op" id="6582754">=</span>&nbsp;<span class="num" id="6582756">30</span>&nbsp;<span class="op" id="6582759">*</span>&nbsp;<span class="ident" id="6582761">time</span><span class="op" id="6582765">.</span><span class="ident" id="6582766">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582779">c</span><span class="op" id="6582780">,</span>&nbsp;<span class="ident" id="6582782">err</span>&nbsp;<span class="op" id="6582786">:=</span>&nbsp;<span class="ident" id="6582789">d</span><span class="op" id="6582790">.</span><span class="ident" id="6582791">Dial</span><span class="op" id="6582795">(</span><span class="string" id="6582796">&#34;tcp&#34;</span><span class="op" id="6582801">,</span>&nbsp;<span class="ident" id="6582803">ln</span><span class="op" id="6582805">.</span><span class="ident" id="6582806">Addr</span><span class="op" id="6582810">(</span><span class="op" id="6582811">)</span><span class="op" id="6582812">.</span><span class="ident" id="6582813">String</span><span class="op" id="6582819">(</span><span class="op" id="6582820">)</span><span class="op" id="6582821">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582825">if</span>&nbsp;<span class="ident" id="6582828">err</span>&nbsp;<span class="op" id="6582832">!=</span>&nbsp;<span class="ident" id="6582835">nil</span>&nbsp;<span class="op" id="6582839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582844">t</span><span class="op" id="6582845">.</span><span class="ident" id="6582846">Fatal</span><span class="op" id="6582851">(</span><span class="ident" id="6582852">err</span><span class="op" id="6582855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582863">c</span><span class="op" id="6582864">.</span><span class="ident" id="6582865">Close</span><span class="op" id="6582870">(</span><span class="op" id="6582871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6582875">if</span>&nbsp;<span class="ident" id="6582878">got</span>&nbsp;<span class="op" id="6582882">!=</span>&nbsp;<span class="ident" id="6582885">keepAlive</span>&nbsp;<span class="op" id="6582895">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6582900">t</span><span class="op" id="6582901">.</span><span class="ident" id="6582902">Errorf</span><span class="op" id="6582908">(</span><span class="string" id="6582909">&#34;Dialer.KeepAlive&nbsp;=&nbsp;%v:&nbsp;SetKeepAlive&nbsp;called&nbsp;=&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6582967">,</span>&nbsp;<span class="ident" id="6582969">d</span><span class="op" id="6582970">.</span><span class="ident" id="6582971">KeepAlive</span><span class="op" id="6582980">,</span>&nbsp;<span class="ident" id="6582982">got</span><span class="op" id="6582985">,</span>&nbsp;<span class="op" id="6582987">!</span><span class="ident" id="6582988">got</span><span class="op" id="6582991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6582998">}</span><br>
<span class="lineno"></span><span class="op" id="6583000">}</span>
</div>
</body>
</html>
