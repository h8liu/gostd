<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc</h2>
<ul>
<li><a href="/gostd/net/rpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/rpc/debug.go.html">debug.go</a></li>
<li><a href="/gostd/net/rpc/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/rpc/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4851258">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4851313">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4851367">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4851418">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Package&nbsp;rpc&nbsp;provides&nbsp;access&nbsp;to&nbsp;the&nbsp;exported&nbsp;methods&nbsp;of&nbsp;an&nbsp;object&nbsp;across&nbsp;a<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;network&nbsp;or&nbsp;other&nbsp;I/O&nbsp;connection.&nbsp;&nbsp;A&nbsp;server&nbsp;registers&nbsp;an&nbsp;object,&nbsp;making&nbsp;it&nbsp;visible<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;as&nbsp;a&nbsp;service&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;After&nbsp;registration,&nbsp;exported<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;methods&nbsp;of&nbsp;the&nbsp;object&nbsp;will&nbsp;be&nbsp;accessible&nbsp;remotely.&nbsp;&nbsp;A&nbsp;server&nbsp;may&nbsp;register&nbsp;multiple<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;objects&nbsp;(services)&nbsp;of&nbsp;different&nbsp;types&nbsp;but&nbsp;it&nbsp;is&nbsp;an&nbsp;error&nbsp;to&nbsp;register&nbsp;multiple<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;objects&nbsp;of&nbsp;the&nbsp;same&nbsp;type.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Only&nbsp;methods&nbsp;that&nbsp;satisfy&nbsp;these&nbsp;criteria&nbsp;will&nbsp;be&nbsp;made&nbsp;available&nbsp;for&nbsp;remote&nbsp;access;<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;other&nbsp;methods&nbsp;will&nbsp;be&nbsp;ignored:<br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&nbsp;is&nbsp;exported.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&nbsp;has&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;exported&nbsp;(or&nbsp;builtin)&nbsp;types.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&#39;s&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&nbsp;has&nbsp;return&nbsp;type&nbsp;error.<br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;In&nbsp;effect,&nbsp;the&nbsp;method&nbsp;must&nbsp;look&nbsp;schematically&nbsp;like<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;(t&nbsp;*T)&nbsp;MethodName(argType&nbsp;T1,&nbsp;replyType&nbsp;*T2)&nbsp;error<br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;T,&nbsp;T1&nbsp;and&nbsp;T2&nbsp;can&nbsp;be&nbsp;marshaled&nbsp;by&nbsp;encoding/gob.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;These&nbsp;requirements&nbsp;apply&nbsp;even&nbsp;if&nbsp;a&nbsp;different&nbsp;codec&nbsp;is&nbsp;used.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;(In&nbsp;the&nbsp;future,&nbsp;these&nbsp;requirements&nbsp;may&nbsp;soften&nbsp;for&nbsp;custom&nbsp;codecs.)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;method&#39;s&nbsp;first&nbsp;argument&nbsp;represents&nbsp;the&nbsp;arguments&nbsp;provided&nbsp;by&nbsp;the&nbsp;caller;&nbsp;the<br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;second&nbsp;argument&nbsp;represents&nbsp;the&nbsp;result&nbsp;parameters&nbsp;to&nbsp;be&nbsp;returned&nbsp;to&nbsp;the&nbsp;caller.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;method&#39;s&nbsp;return&nbsp;value,&nbsp;if&nbsp;non-nil,&nbsp;is&nbsp;passed&nbsp;back&nbsp;as&nbsp;a&nbsp;string&nbsp;that&nbsp;the&nbsp;client<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;sees&nbsp;as&nbsp;if&nbsp;created&nbsp;by&nbsp;errors.New.&nbsp;&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;returned,&nbsp;the&nbsp;reply&nbsp;parameter<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;will&nbsp;not&nbsp;be&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;client.<br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;server&nbsp;may&nbsp;handle&nbsp;requests&nbsp;on&nbsp;a&nbsp;single&nbsp;connection&nbsp;by&nbsp;calling&nbsp;ServeConn.&nbsp;&nbsp;More<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;typically&nbsp;it&nbsp;will&nbsp;create&nbsp;a&nbsp;network&nbsp;listener&nbsp;and&nbsp;call&nbsp;Accept&nbsp;or,&nbsp;for&nbsp;an&nbsp;HTTP<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;listener,&nbsp;HandleHTTP&nbsp;and&nbsp;http.Serve.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;client&nbsp;wishing&nbsp;to&nbsp;use&nbsp;the&nbsp;service&nbsp;establishes&nbsp;a&nbsp;connection&nbsp;and&nbsp;then&nbsp;invokes<br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;NewClient&nbsp;on&nbsp;the&nbsp;connection.&nbsp;&nbsp;The&nbsp;convenience&nbsp;function&nbsp;Dial&nbsp;(DialHTTP)&nbsp;performs<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;both&nbsp;steps&nbsp;for&nbsp;a&nbsp;raw&nbsp;network&nbsp;connection&nbsp;(an&nbsp;HTTP&nbsp;connection).&nbsp;&nbsp;The&nbsp;resulting<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Client&nbsp;object&nbsp;has&nbsp;two&nbsp;methods,&nbsp;Call&nbsp;and&nbsp;Go,&nbsp;that&nbsp;specify&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;call,&nbsp;a&nbsp;pointer&nbsp;containing&nbsp;the&nbsp;arguments,&nbsp;and&nbsp;a&nbsp;pointer&nbsp;to&nbsp;receive&nbsp;the&nbsp;result<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;parameters.<br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;Call&nbsp;method&nbsp;waits&nbsp;for&nbsp;the&nbsp;remote&nbsp;call&nbsp;to&nbsp;complete&nbsp;while&nbsp;the&nbsp;Go&nbsp;method<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;launches&nbsp;the&nbsp;call&nbsp;asynchronously&nbsp;and&nbsp;signals&nbsp;completion&nbsp;using&nbsp;the&nbsp;Call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;structure&#39;s&nbsp;Done&nbsp;channel.<br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;Unless&nbsp;an&nbsp;explicit&nbsp;codec&nbsp;is&nbsp;set&nbsp;up,&nbsp;package&nbsp;encoding/gob&nbsp;is&nbsp;used&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;transport&nbsp;the&nbsp;data.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Here&nbsp;is&nbsp;a&nbsp;simple&nbsp;example.&nbsp;&nbsp;A&nbsp;server&nbsp;wishes&nbsp;to&nbsp;export&nbsp;an&nbsp;object&nbsp;of&nbsp;type&nbsp;Arith:<br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;server<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;Args&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A,&nbsp;B&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;Quotient&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Quo,&nbsp;Rem&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;Arith&nbsp;int<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;(t&nbsp;*Arith)&nbsp;Multiply(args&nbsp;*Args,&nbsp;reply&nbsp;*int)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*reply&nbsp;=&nbsp;args.A&nbsp;*&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;nil<br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;(t&nbsp;*Arith)&nbsp;Divide(args&nbsp;*Args,&nbsp;quo&nbsp;*Quotient)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;args.B&nbsp;==&nbsp;0&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;errors.New(&#34;divide&nbsp;by&nbsp;zero&#34;)<br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quo.Quo&nbsp;=&nbsp;args.A&nbsp;/&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quo.Rem&nbsp;=&nbsp;args.A&nbsp;%&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;nil<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;(for&nbsp;HTTP&nbsp;service):<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arith&nbsp;:=&nbsp;new(Arith)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rpc.Register(arith)<br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rpc.HandleHTTP()<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l,&nbsp;e&nbsp;:=&nbsp;net.Listen(&#34;tcp&#34;,&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;e&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;listen&nbsp;error:&#34;,&nbsp;e)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go&nbsp;http.Serve(l,&nbsp;nil)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;At&nbsp;this&nbsp;point,&nbsp;clients&nbsp;can&nbsp;see&nbsp;a&nbsp;service&nbsp;&#34;Arith&#34;&nbsp;with&nbsp;methods&nbsp;&#34;Arith.Multiply&#34;&nbsp;and<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&#34;Arith.Divide&#34;.&nbsp;&nbsp;To&nbsp;invoke&nbsp;one,&nbsp;a&nbsp;client&nbsp;first&nbsp;dials&nbsp;the&nbsp;server:<br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client,&nbsp;err&nbsp;:=&nbsp;rpc.DialHTTP(&#34;tcp&#34;,&nbsp;serverAddress&nbsp;+&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;dialing:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;Then&nbsp;it&nbsp;can&nbsp;make&nbsp;a&nbsp;remote&nbsp;call:<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Synchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args&nbsp;:=&nbsp;&amp;server.Args{7,8}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;reply&nbsp;int<br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;client.Call(&#34;Arith.Multiply&#34;,&nbsp;args,&nbsp;&amp;reply)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;arith&nbsp;error:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt.Printf(&#34;Arith:&nbsp;%d*%d=%d&#34;,&nbsp;args.A,&nbsp;args.B,&nbsp;reply)<br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;or<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Asynchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotient&nbsp;:=&nbsp;new(Quotient)<br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;divCall&nbsp;:=&nbsp;client.Go(&#34;Arith.Divide&#34;,&nbsp;args,&nbsp;quotient,&nbsp;nil)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replyCall&nbsp;:=&nbsp;&lt;-divCall.Done&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;will&nbsp;be&nbsp;equal&nbsp;to&nbsp;divCall<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;check&nbsp;errors,&nbsp;print,&nbsp;etc.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;server&nbsp;implementation&nbsp;will&nbsp;often&nbsp;provide&nbsp;a&nbsp;simple,&nbsp;type-safe&nbsp;wrapper&nbsp;for&nbsp;the<br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;client.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="4855247">package</span>&nbsp;<span class="ident" id="4855255">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4855260">import</span>&nbsp;<span class="op" id="4855267">(</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4855270">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4855279">&#34;encoding/gob&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4855295">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4855305">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4855311">&#34;log&#34;</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4855318">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4855325">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4855337">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4855348">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4855359">&#34;sync&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4855367">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4855378">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="4855393">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4855396">const</span>&nbsp;<span class="op" id="4855402">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4855405">//&nbsp;Defaults&nbsp;used&nbsp;by&nbsp;HandleHTTP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4855437">DefaultRPCPath</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4855454">=</span>&nbsp;<span class="string" id="4855456">&#34;/_goRPC_&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4855468">DefaultDebugPath</span>&nbsp;<span class="op" id="4855485">=</span>&nbsp;<span class="string" id="4855487">&#34;/debug/rpc&#34;</span><br>
<span class="lineno"></span><span class="op" id="4855500">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="4855503">//&nbsp;Precompute&nbsp;the&nbsp;reflect&nbsp;type&nbsp;for&nbsp;error.&nbsp;&nbsp;Can&#39;t&nbsp;use&nbsp;error&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="4855571">//&nbsp;because&nbsp;Typeof&nbsp;takes&nbsp;an&nbsp;empty&nbsp;interface&nbsp;value.&nbsp;&nbsp;This&nbsp;is&nbsp;annoying.</span><br>
<span class="lineno"></span><span class="keyword" id="4855640">var</span>&nbsp;<span class="ident" id="4855644">typeOfError</span>&nbsp;<span class="op" id="4855656">=</span>&nbsp;<span class="ident" id="4855658">reflect</span><span class="op" id="4855665">.</span><span class="ident" id="4855666">TypeOf</span><span class="op" id="4855672">(</span><span class="op" id="4855673">(</span><span class="op" id="4855674">*</span><span class="builtintype" id="4855675">error</span><span class="op" id="4855680">)</span><span class="op" id="4855681">(</span><span class="ident" id="4855682">nil</span><span class="op" id="4855685">)</span><span class="op" id="4855686">)</span><span class="op" id="4855687">.</span><span class="ident" id="4855688">Elem</span><span class="op" id="4855692">(</span><span class="op" id="4855693">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4855696">type</span>&nbsp;<span class="ident" id="4855701">methodType</span>&nbsp;<span class="keyword" id="4855712">struct</span>&nbsp;<span class="op" id="4855719">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4855722">sync</span><span class="op" id="4855726">.</span><span class="ident" id="4855727">Mutex</span>&nbsp;<span class="comment" id="4855733">//&nbsp;protects&nbsp;counters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4855755">method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4855766">reflect</span><span class="op" id="4855773">.</span><span class="ident" id="4855774">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4855782">ArgType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4855793">reflect</span><span class="op" id="4855800">.</span><span class="ident" id="4855801">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4855807">ReplyType</span>&nbsp;&nbsp;<span class="ident" id="4855818">reflect</span><span class="op" id="4855825">.</span><span class="ident" id="4855826">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4855832">numCalls</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4855843">uint</span><br>
<span class="lineno">155</span><span class="op" id="4855848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4855851">type</span>&nbsp;<span class="ident" id="4855856">service</span>&nbsp;<span class="keyword" id="4855864">struct</span>&nbsp;<span class="op" id="4855871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4855874">name</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4855881">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4855904">//&nbsp;name&nbsp;of&nbsp;service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4855924">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4855931">reflect</span><span class="op" id="4855938">.</span><span class="ident" id="4855939">Value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4855954">//&nbsp;receiver&nbsp;of&nbsp;methods&nbsp;for&nbsp;the&nbsp;service</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4855994">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4856001">reflect</span><span class="op" id="4856008">.</span><span class="ident" id="4856009">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4856024">//&nbsp;type&nbsp;of&nbsp;the&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4856049">method</span>&nbsp;<span class="keyword" id="4856056">map</span><span class="op" id="4856059">[</span><span class="builtintype" id="4856060">string</span><span class="op" id="4856066">]</span><span class="op" id="4856067">*</span><span class="ident" id="4856068">methodType</span>&nbsp;<span class="comment" id="4856079">//&nbsp;registered&nbsp;methods</span><br>
<span class="lineno"></span><span class="op" id="4856101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4856104">//&nbsp;Request&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;call.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno">165</span><span class="comment" id="4856181">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno"></span><span class="comment" id="4856251">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="4856271">type</span>&nbsp;<span class="ident" id="4856276">Request</span>&nbsp;<span class="keyword" id="4856284">struct</span>&nbsp;<span class="op" id="4856291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4856294">ServiceMethod</span>&nbsp;<span class="builtintype" id="4856308">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4856317">//&nbsp;format:&nbsp;&#34;Service.Method&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4856346">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4856360">uint64</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4856369">//&nbsp;sequence&nbsp;number&nbsp;chosen&nbsp;by&nbsp;client</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4856406">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4856420">*</span><span class="ident" id="4856421">Request</span>&nbsp;<span class="comment" id="4856429">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="4856456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4856459">//&nbsp;Response&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;return.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno"></span><span class="comment" id="4856539">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno">175</span><span class="comment" id="4856609">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="4856629">type</span>&nbsp;<span class="ident" id="4856634">Response</span>&nbsp;<span class="keyword" id="4856643">struct</span>&nbsp;<span class="op" id="4856650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4856653">ServiceMethod</span>&nbsp;<span class="builtintype" id="4856667">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4856677">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4856708">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4856722">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4856732">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4856763">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4856777">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4856787">//&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4856806">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4856820">*</span><span class="ident" id="4856821">Response</span>&nbsp;<span class="comment" id="4856830">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="4856857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4856860">//&nbsp;Server&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="4856896">type</span>&nbsp;<span class="ident" id="4856901">Server</span>&nbsp;<span class="keyword" id="4856908">struct</span>&nbsp;<span class="op" id="4856915">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4856918">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4856929">sync</span><span class="op" id="4856933">.</span><span class="ident" id="4856934">RWMutex</span>&nbsp;<span class="comment" id="4856942">//&nbsp;protects&nbsp;the&nbsp;serviceMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4856970">serviceMap</span>&nbsp;<span class="keyword" id="4856981">map</span><span class="op" id="4856984">[</span><span class="builtintype" id="4856985">string</span><span class="op" id="4856991">]</span><span class="op" id="4856992">*</span><span class="ident" id="4856993">service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4857002">reqLock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4857013">sync</span><span class="op" id="4857017">.</span><span class="ident" id="4857018">Mutex</span>&nbsp;<span class="comment" id="4857024">//&nbsp;protects&nbsp;freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4857045">freeReq</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4857056">*</span><span class="ident" id="4857057">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4857066">respLock</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4857077">sync</span><span class="op" id="4857081">.</span><span class="ident" id="4857082">Mutex</span>&nbsp;<span class="comment" id="4857088">//&nbsp;protects&nbsp;freeResp</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4857110">freeResp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4857121">*</span><span class="ident" id="4857122">Response</span><br>
<span class="lineno"></span><span class="op" id="4857131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4857134">//&nbsp;NewServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="4857169">func</span>&nbsp;<span class="ident" id="4857174">NewServer</span><span class="op" id="4857183">(</span><span class="op" id="4857184">)</span>&nbsp;<span class="op" id="4857186">*</span><span class="ident" id="4857187">Server</span>&nbsp;<span class="op" id="4857194">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4857197">return</span>&nbsp;<span class="op" id="4857204">&amp;</span><span class="ident" id="4857205">Server</span><span class="op" id="4857211">{</span><span class="ident" id="4857212">serviceMap</span><span class="op" id="4857222">:</span>&nbsp;<span class="builtinfunc" id="4857224">make</span><span class="op" id="4857228">(</span><span class="keyword" id="4857229">map</span><span class="op" id="4857232">[</span><span class="builtintype" id="4857233">string</span><span class="op" id="4857239">]</span><span class="op" id="4857240">*</span><span class="ident" id="4857241">service</span><span class="op" id="4857248">)</span><span class="op" id="4857249">}</span><br>
<span class="lineno"></span><span class="op" id="4857251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4857254">//&nbsp;DefaultServer&nbsp;is&nbsp;the&nbsp;default&nbsp;instance&nbsp;of&nbsp;*Server.</span><br>
<span class="lineno"></span><span class="keyword" id="4857307">var</span>&nbsp;<span class="ident" id="4857311">DefaultServer</span>&nbsp;<span class="op" id="4857325">=</span>&nbsp;<span class="ident" id="4857327">NewServer</span><span class="op" id="4857336">(</span><span class="op" id="4857337">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="4857340">//&nbsp;Is&nbsp;this&nbsp;an&nbsp;exported&nbsp;-&nbsp;upper&nbsp;case&nbsp;-&nbsp;name?</span><br>
<span class="lineno"></span><span class="keyword" id="4857384">func</span>&nbsp;<span class="ident" id="4857389">isExported</span><span class="op" id="4857399">(</span><span class="ident" id="4857400">name</span>&nbsp;<span class="builtintype" id="4857405">string</span><span class="op" id="4857411">)</span>&nbsp;<span class="builtintype" id="4857413">bool</span>&nbsp;<span class="op" id="4857418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4857421">rune</span><span class="op" id="4857425">,</span>&nbsp;<span class="ident" id="4857427">_</span>&nbsp;<span class="op" id="4857429">:=</span>&nbsp;<span class="ident" id="4857432">utf8</span><span class="op" id="4857436">.</span><span class="ident" id="4857437">DecodeRuneInString</span><span class="op" id="4857455">(</span><span class="ident" id="4857456">name</span><span class="op" id="4857460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4857463">return</span>&nbsp;<span class="ident" id="4857470">unicode</span><span class="op" id="4857477">.</span><span class="ident" id="4857478">IsUpper</span><span class="op" id="4857485">(</span><span class="builtintype" id="4857486">rune</span><span class="op" id="4857490">)</span><br>
<span class="lineno">205</span><span class="op" id="4857492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4857495">//&nbsp;Is&nbsp;this&nbsp;type&nbsp;exported&nbsp;or&nbsp;a&nbsp;builtin?</span><br>
<span class="lineno"></span><span class="keyword" id="4857534">func</span>&nbsp;<span class="ident" id="4857539">isExportedOrBuiltinType</span><span class="op" id="4857562">(</span><span class="ident" id="4857563">t</span>&nbsp;<span class="ident" id="4857565">reflect</span><span class="op" id="4857572">.</span><span class="ident" id="4857573">Type</span><span class="op" id="4857577">)</span>&nbsp;<span class="builtintype" id="4857579">bool</span>&nbsp;<span class="op" id="4857584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4857587">for</span>&nbsp;<span class="ident" id="4857591">t</span><span class="op" id="4857592">.</span><span class="ident" id="4857593">Kind</span><span class="op" id="4857597">(</span><span class="op" id="4857598">)</span>&nbsp;<span class="op" id="4857600">==</span>&nbsp;<span class="ident" id="4857603">reflect</span><span class="op" id="4857610">.</span><span class="ident" id="4857611">Ptr</span>&nbsp;<span class="op" id="4857615">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4857619">t</span>&nbsp;<span class="op" id="4857621">=</span>&nbsp;<span class="ident" id="4857623">t</span><span class="op" id="4857624">.</span><span class="ident" id="4857625">Elem</span><span class="op" id="4857629">(</span><span class="op" id="4857630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4857633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4857636">//&nbsp;PkgPath&nbsp;will&nbsp;be&nbsp;non-empty&nbsp;even&nbsp;for&nbsp;an&nbsp;exported&nbsp;type,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4857693">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;the&nbsp;type&nbsp;name&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4857740">return</span>&nbsp;<span class="ident" id="4857747">isExported</span><span class="op" id="4857757">(</span><span class="ident" id="4857758">t</span><span class="op" id="4857759">.</span><span class="ident" id="4857760">Name</span><span class="op" id="4857764">(</span><span class="op" id="4857765">)</span><span class="op" id="4857766">)</span>&nbsp;<span class="op" id="4857768">||</span>&nbsp;<span class="ident" id="4857771">t</span><span class="op" id="4857772">.</span><span class="ident" id="4857773">PkgPath</span><span class="op" id="4857780">(</span><span class="op" id="4857781">)</span>&nbsp;<span class="op" id="4857783">==</span>&nbsp;<span class="string" id="4857786">&#34;&#34;</span><br>
<span class="lineno">215</span><span class="op" id="4857789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4857792">//&nbsp;Register&nbsp;publishes&nbsp;in&nbsp;the&nbsp;server&nbsp;the&nbsp;set&nbsp;of&nbsp;methods&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4857854">//&nbsp;receiver&nbsp;value&nbsp;that&nbsp;satisfy&nbsp;the&nbsp;following&nbsp;conditions:</span><br>
<span class="lineno"></span><span class="comment" id="4857911">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;exported&nbsp;method</span><br>
<span class="lineno">220</span><span class="comment" id="4857932">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;of&nbsp;exported&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="4857974">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span><span class="comment" id="4858012">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;one&nbsp;return&nbsp;value,&nbsp;of&nbsp;type&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4858049">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;receiver&nbsp;is&nbsp;not&nbsp;an&nbsp;exported&nbsp;type&nbsp;or&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4858119">//&nbsp;no&nbsp;suitable&nbsp;methods.&nbsp;It&nbsp;also&nbsp;logs&nbsp;the&nbsp;error&nbsp;using&nbsp;package&nbsp;log.</span><br>
<span class="lineno">225</span><span class="comment" id="4858185">//&nbsp;The&nbsp;client&nbsp;accesses&nbsp;each&nbsp;method&nbsp;using&nbsp;a&nbsp;string&nbsp;of&nbsp;the&nbsp;form&nbsp;&#34;Type.Method&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="4858262">//&nbsp;where&nbsp;Type&nbsp;is&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4858309">func</span>&nbsp;<span class="op" id="4858314">(</span><span class="ident" id="4858315">server</span>&nbsp;<span class="op" id="4858322">*</span><span class="ident" id="4858323">Server</span><span class="op" id="4858329">)</span>&nbsp;<span class="ident" id="4858331">Register</span><span class="op" id="4858339">(</span><span class="ident" id="4858340">rcvr</span>&nbsp;<span class="keyword" id="4858345">interface</span><span class="op" id="4858354">{</span><span class="op" id="4858355">}</span><span class="op" id="4858356">)</span>&nbsp;<span class="builtintype" id="4858358">error</span>&nbsp;<span class="op" id="4858364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4858367">return</span>&nbsp;<span class="ident" id="4858374">server</span><span class="op" id="4858380">.</span><span class="ident" id="4858381">register</span><span class="op" id="4858389">(</span><span class="ident" id="4858390">rcvr</span><span class="op" id="4858394">,</span>&nbsp;<span class="string" id="4858396">&#34;&#34;</span><span class="op" id="4858398">,</span>&nbsp;<span class="builtintype" id="4858400">false</span><span class="op" id="4858405">)</span><br>
<span class="lineno"></span><span class="op" id="4858407">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="4858410">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="4858483">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4858527">func</span>&nbsp;<span class="op" id="4858532">(</span><span class="ident" id="4858533">server</span>&nbsp;<span class="op" id="4858540">*</span><span class="ident" id="4858541">Server</span><span class="op" id="4858547">)</span>&nbsp;<span class="ident" id="4858549">RegisterName</span><span class="op" id="4858561">(</span><span class="ident" id="4858562">name</span>&nbsp;<span class="builtintype" id="4858567">string</span><span class="op" id="4858573">,</span>&nbsp;<span class="ident" id="4858575">rcvr</span>&nbsp;<span class="keyword" id="4858580">interface</span><span class="op" id="4858589">{</span><span class="op" id="4858590">}</span><span class="op" id="4858591">)</span>&nbsp;<span class="builtintype" id="4858593">error</span>&nbsp;<span class="op" id="4858599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4858602">return</span>&nbsp;<span class="ident" id="4858609">server</span><span class="op" id="4858615">.</span><span class="ident" id="4858616">register</span><span class="op" id="4858624">(</span><span class="ident" id="4858625">rcvr</span><span class="op" id="4858629">,</span>&nbsp;<span class="ident" id="4858631">name</span><span class="op" id="4858635">,</span>&nbsp;<span class="builtintype" id="4858637">true</span><span class="op" id="4858641">)</span><br>
<span class="lineno">235</span><span class="op" id="4858643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4858646">func</span>&nbsp;<span class="op" id="4858651">(</span><span class="ident" id="4858652">server</span>&nbsp;<span class="op" id="4858659">*</span><span class="ident" id="4858660">Server</span><span class="op" id="4858666">)</span>&nbsp;<span class="ident" id="4858668">register</span><span class="op" id="4858676">(</span><span class="ident" id="4858677">rcvr</span>&nbsp;<span class="keyword" id="4858682">interface</span><span class="op" id="4858691">{</span><span class="op" id="4858692">}</span><span class="op" id="4858693">,</span>&nbsp;<span class="ident" id="4858695">name</span>&nbsp;<span class="builtintype" id="4858700">string</span><span class="op" id="4858706">,</span>&nbsp;<span class="ident" id="4858708">useName</span>&nbsp;<span class="builtintype" id="4858716">bool</span><span class="op" id="4858720">)</span>&nbsp;<span class="builtintype" id="4858722">error</span>&nbsp;<span class="op" id="4858728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4858731">server</span><span class="op" id="4858737">.</span><span class="ident" id="4858738">mu</span><span class="op" id="4858740">.</span><span class="ident" id="4858741">Lock</span><span class="op" id="4858745">(</span><span class="op" id="4858746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4858749">defer</span>&nbsp;<span class="ident" id="4858755">server</span><span class="op" id="4858761">.</span><span class="ident" id="4858762">mu</span><span class="op" id="4858764">.</span><span class="ident" id="4858765">Unlock</span><span class="op" id="4858771">(</span><span class="op" id="4858772">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4858775">if</span>&nbsp;<span class="ident" id="4858778">server</span><span class="op" id="4858784">.</span><span class="ident" id="4858785">serviceMap</span>&nbsp;<span class="op" id="4858796">==</span>&nbsp;<span class="ident" id="4858799">nil</span>&nbsp;<span class="op" id="4858803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4858807">server</span><span class="op" id="4858813">.</span><span class="ident" id="4858814">serviceMap</span>&nbsp;<span class="op" id="4858825">=</span>&nbsp;<span class="builtinfunc" id="4858827">make</span><span class="op" id="4858831">(</span><span class="keyword" id="4858832">map</span><span class="op" id="4858835">[</span><span class="builtintype" id="4858836">string</span><span class="op" id="4858842">]</span><span class="op" id="4858843">*</span><span class="ident" id="4858844">service</span><span class="op" id="4858851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4858854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4858857">s</span>&nbsp;<span class="op" id="4858859">:=</span>&nbsp;<span class="builtinfunc" id="4858862">new</span><span class="op" id="4858865">(</span><span class="ident" id="4858866">service</span><span class="op" id="4858873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4858876">s</span><span class="op" id="4858877">.</span><span class="ident" id="4858878">typ</span>&nbsp;<span class="op" id="4858882">=</span>&nbsp;<span class="ident" id="4858884">reflect</span><span class="op" id="4858891">.</span><span class="ident" id="4858892">TypeOf</span><span class="op" id="4858898">(</span><span class="ident" id="4858899">rcvr</span><span class="op" id="4858903">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4858906">s</span><span class="op" id="4858907">.</span><span class="ident" id="4858908">rcvr</span>&nbsp;<span class="op" id="4858913">=</span>&nbsp;<span class="ident" id="4858915">reflect</span><span class="op" id="4858922">.</span><span class="ident" id="4858923">ValueOf</span><span class="op" id="4858930">(</span><span class="ident" id="4858931">rcvr</span><span class="op" id="4858935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4858938">sname</span>&nbsp;<span class="op" id="4858944">:=</span>&nbsp;<span class="ident" id="4858947">reflect</span><span class="op" id="4858954">.</span><span class="ident" id="4858955">Indirect</span><span class="op" id="4858963">(</span><span class="ident" id="4858964">s</span><span class="op" id="4858965">.</span><span class="ident" id="4858966">rcvr</span><span class="op" id="4858970">)</span><span class="op" id="4858971">.</span><span class="ident" id="4858972">Type</span><span class="op" id="4858976">(</span><span class="op" id="4858977">)</span><span class="op" id="4858978">.</span><span class="ident" id="4858979">Name</span><span class="op" id="4858983">(</span><span class="op" id="4858984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4858987">if</span>&nbsp;<span class="ident" id="4858990">useName</span>&nbsp;<span class="op" id="4858998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4859002">sname</span>&nbsp;<span class="op" id="4859008">=</span>&nbsp;<span class="ident" id="4859010">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4859016">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4859019">if</span>&nbsp;<span class="ident" id="4859022">sname</span>&nbsp;<span class="op" id="4859028">==</span>&nbsp;<span class="string" id="4859031">&#34;&#34;</span>&nbsp;<span class="op" id="4859034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4859038">s</span>&nbsp;<span class="op" id="4859040">:=</span>&nbsp;<span class="string" id="4859043">&#34;rpc.Register:&nbsp;no&nbsp;service&nbsp;name&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4859085">+</span>&nbsp;<span class="ident" id="4859087">s</span><span class="op" id="4859088">.</span><span class="ident" id="4859089">typ</span><span class="op" id="4859092">.</span><span class="ident" id="4859093">String</span><span class="op" id="4859099">(</span><span class="op" id="4859100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4859104">log</span><span class="op" id="4859107">.</span><span class="ident" id="4859108">Print</span><span class="op" id="4859113">(</span><span class="ident" id="4859114">s</span><span class="op" id="4859115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4859119">return</span>&nbsp;<span class="ident" id="4859126">errors</span><span class="op" id="4859132">.</span><span class="ident" id="4859133">New</span><span class="op" id="4859136">(</span><span class="ident" id="4859137">s</span><span class="op" id="4859138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4859141">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4859144">if</span>&nbsp;<span class="op" id="4859147">!</span><span class="ident" id="4859148">isExported</span><span class="op" id="4859158">(</span><span class="ident" id="4859159">sname</span><span class="op" id="4859164">)</span>&nbsp;<span class="op" id="4859166">&amp;&amp;</span>&nbsp;<span class="op" id="4859169">!</span><span class="ident" id="4859170">useName</span>&nbsp;<span class="op" id="4859178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4859182">s</span>&nbsp;<span class="op" id="4859184">:=</span>&nbsp;<span class="string" id="4859187">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4859209">+</span>&nbsp;<span class="ident" id="4859211">sname</span>&nbsp;<span class="op" id="4859217">+</span>&nbsp;<span class="string" id="4859219">&#34;&nbsp;is&nbsp;not&nbsp;exported&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4859240">log</span><span class="op" id="4859243">.</span><span class="ident" id="4859244">Print</span><span class="op" id="4859249">(</span><span class="ident" id="4859250">s</span><span class="op" id="4859251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4859255">return</span>&nbsp;<span class="ident" id="4859262">errors</span><span class="op" id="4859268">.</span><span class="ident" id="4859269">New</span><span class="op" id="4859272">(</span><span class="ident" id="4859273">s</span><span class="op" id="4859274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4859277">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4859280">if</span>&nbsp;<span class="ident" id="4859283">_</span><span class="op" id="4859284">,</span>&nbsp;<span class="ident" id="4859286">present</span>&nbsp;<span class="op" id="4859294">:=</span>&nbsp;<span class="ident" id="4859297">server</span><span class="op" id="4859303">.</span><span class="ident" id="4859304">serviceMap</span><span class="op" id="4859314">[</span><span class="ident" id="4859315">sname</span><span class="op" id="4859320">]</span><span class="op" id="4859321">;</span>&nbsp;<span class="ident" id="4859323">present</span>&nbsp;<span class="op" id="4859331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4859335">return</span>&nbsp;<span class="ident" id="4859342">errors</span><span class="op" id="4859348">.</span><span class="ident" id="4859349">New</span><span class="op" id="4859352">(</span><span class="string" id="4859353">&#34;rpc:&nbsp;service&nbsp;already&nbsp;defined:&nbsp;&#34;</span>&nbsp;<span class="op" id="4859386">+</span>&nbsp;<span class="ident" id="4859388">sname</span><span class="op" id="4859393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4859396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4859399">s</span><span class="op" id="4859400">.</span><span class="ident" id="4859401">name</span>&nbsp;<span class="op" id="4859406">=</span>&nbsp;<span class="ident" id="4859408">sname</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4859416">//&nbsp;Install&nbsp;the&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4859440">s</span><span class="op" id="4859441">.</span><span class="ident" id="4859442">method</span>&nbsp;<span class="op" id="4859449">=</span>&nbsp;<span class="ident" id="4859451">suitableMethods</span><span class="op" id="4859466">(</span><span class="ident" id="4859467">s</span><span class="op" id="4859468">.</span><span class="ident" id="4859469">typ</span><span class="op" id="4859472">,</span>&nbsp;<span class="builtintype" id="4859474">true</span><span class="op" id="4859478">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4859482">if</span>&nbsp;<span class="builtinfunc" id="4859485">len</span><span class="op" id="4859488">(</span><span class="ident" id="4859489">s</span><span class="op" id="4859490">.</span><span class="ident" id="4859491">method</span><span class="op" id="4859497">)</span>&nbsp;<span class="op" id="4859499">==</span>&nbsp;<span class="num" id="4859502">0</span>&nbsp;<span class="op" id="4859504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4859508">str</span>&nbsp;<span class="op" id="4859512">:=</span>&nbsp;<span class="string" id="4859515">&#34;&#34;</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4859521">//&nbsp;To&nbsp;help&nbsp;the&nbsp;user,&nbsp;see&nbsp;if&nbsp;a&nbsp;pointer&nbsp;receiver&nbsp;would&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4859582">method</span>&nbsp;<span class="op" id="4859589">:=</span>&nbsp;<span class="ident" id="4859592">suitableMethods</span><span class="op" id="4859607">(</span><span class="ident" id="4859608">reflect</span><span class="op" id="4859615">.</span><span class="ident" id="4859616">PtrTo</span><span class="op" id="4859621">(</span><span class="ident" id="4859622">s</span><span class="op" id="4859623">.</span><span class="ident" id="4859624">typ</span><span class="op" id="4859627">)</span><span class="op" id="4859628">,</span>&nbsp;<span class="builtintype" id="4859630">false</span><span class="op" id="4859635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4859639">if</span>&nbsp;<span class="builtinfunc" id="4859642">len</span><span class="op" id="4859645">(</span><span class="ident" id="4859646">method</span><span class="op" id="4859652">)</span>&nbsp;<span class="op" id="4859654">!=</span>&nbsp;<span class="num" id="4859657">0</span>&nbsp;<span class="op" id="4859659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4859664">str</span>&nbsp;<span class="op" id="4859668">=</span>&nbsp;<span class="string" id="4859670">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4859692">+</span>&nbsp;<span class="ident" id="4859694">sname</span>&nbsp;<span class="op" id="4859700">+</span>&nbsp;<span class="string" id="4859702">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&nbsp;(hint:&nbsp;pass&nbsp;a&nbsp;pointer&nbsp;to&nbsp;value&nbsp;of&nbsp;that&nbsp;type)&#34;</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4859793">}</span>&nbsp;<span class="keyword" id="4859795">else</span>&nbsp;<span class="op" id="4859800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4859805">str</span>&nbsp;<span class="op" id="4859809">=</span>&nbsp;<span class="string" id="4859811">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4859833">+</span>&nbsp;<span class="ident" id="4859835">sname</span>&nbsp;<span class="op" id="4859841">+</span>&nbsp;<span class="string" id="4859843">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4859889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4859893">log</span><span class="op" id="4859896">.</span><span class="ident" id="4859897">Print</span><span class="op" id="4859902">(</span><span class="ident" id="4859903">str</span><span class="op" id="4859906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4859910">return</span>&nbsp;<span class="ident" id="4859917">errors</span><span class="op" id="4859923">.</span><span class="ident" id="4859924">New</span><span class="op" id="4859927">(</span><span class="ident" id="4859928">str</span><span class="op" id="4859931">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4859934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4859937">server</span><span class="op" id="4859943">.</span><span class="ident" id="4859944">serviceMap</span><span class="op" id="4859954">[</span><span class="ident" id="4859955">s</span><span class="op" id="4859956">.</span><span class="ident" id="4859957">name</span><span class="op" id="4859961">]</span>&nbsp;<span class="op" id="4859963">=</span>&nbsp;<span class="ident" id="4859965">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4859968">return</span>&nbsp;<span class="ident" id="4859975">nil</span><br>
<span class="lineno"></span><span class="op" id="4859979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="4859982">//&nbsp;suitableMethods&nbsp;returns&nbsp;suitable&nbsp;Rpc&nbsp;methods&nbsp;of&nbsp;typ,&nbsp;it&nbsp;will&nbsp;report</span><br>
<span class="lineno"></span><span class="comment" id="4860053">//&nbsp;error&nbsp;using&nbsp;log&nbsp;if&nbsp;reportErr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="4860094">func</span>&nbsp;<span class="ident" id="4860099">suitableMethods</span><span class="op" id="4860114">(</span><span class="ident" id="4860115">typ</span>&nbsp;<span class="ident" id="4860119">reflect</span><span class="op" id="4860126">.</span><span class="ident" id="4860127">Type</span><span class="op" id="4860131">,</span>&nbsp;<span class="ident" id="4860133">reportErr</span>&nbsp;<span class="builtintype" id="4860143">bool</span><span class="op" id="4860147">)</span>&nbsp;<span class="keyword" id="4860149">map</span><span class="op" id="4860152">[</span><span class="builtintype" id="4860153">string</span><span class="op" id="4860159">]</span><span class="op" id="4860160">*</span><span class="ident" id="4860161">methodType</span>&nbsp;<span class="op" id="4860172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4860175">methods</span>&nbsp;<span class="op" id="4860183">:=</span>&nbsp;<span class="builtinfunc" id="4860186">make</span><span class="op" id="4860190">(</span><span class="keyword" id="4860191">map</span><span class="op" id="4860194">[</span><span class="builtintype" id="4860195">string</span><span class="op" id="4860201">]</span><span class="op" id="4860202">*</span><span class="ident" id="4860203">methodType</span><span class="op" id="4860213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4860216">for</span>&nbsp;<span class="ident" id="4860220">m</span>&nbsp;<span class="op" id="4860222">:=</span>&nbsp;<span class="num" id="4860225">0</span><span class="op" id="4860226">;</span>&nbsp;<span class="ident" id="4860228">m</span>&nbsp;<span class="op" id="4860230">&lt;</span>&nbsp;<span class="ident" id="4860232">typ</span><span class="op" id="4860235">.</span><span class="ident" id="4860236">NumMethod</span><span class="op" id="4860245">(</span><span class="op" id="4860246">)</span><span class="op" id="4860247">;</span>&nbsp;<span class="ident" id="4860249">m</span><span class="op" id="4860250">++</span>&nbsp;<span class="op" id="4860253">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4860257">method</span>&nbsp;<span class="op" id="4860264">:=</span>&nbsp;<span class="ident" id="4860267">typ</span><span class="op" id="4860270">.</span><span class="ident" id="4860271">Method</span><span class="op" id="4860277">(</span><span class="ident" id="4860278">m</span><span class="op" id="4860279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4860283">mtype</span>&nbsp;<span class="op" id="4860289">:=</span>&nbsp;<span class="ident" id="4860292">method</span><span class="op" id="4860298">.</span><span class="ident" id="4860299">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4860306">mname</span>&nbsp;<span class="op" id="4860312">:=</span>&nbsp;<span class="ident" id="4860315">method</span><span class="op" id="4860321">.</span><span class="ident" id="4860322">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4860329">//&nbsp;Method&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4860359">if</span>&nbsp;<span class="ident" id="4860362">method</span><span class="op" id="4860368">.</span><span class="ident" id="4860369">PkgPath</span>&nbsp;<span class="op" id="4860377">!=</span>&nbsp;<span class="string" id="4860380">&#34;&#34;</span>&nbsp;<span class="op" id="4860383">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4860388">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4860399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4860403">//&nbsp;Method&nbsp;needs&nbsp;three&nbsp;ins:&nbsp;receiver,&nbsp;*args,&nbsp;*reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4860457">if</span>&nbsp;<span class="ident" id="4860460">mtype</span><span class="op" id="4860465">.</span><span class="ident" id="4860466">NumIn</span><span class="op" id="4860471">(</span><span class="op" id="4860472">)</span>&nbsp;<span class="op" id="4860474">!=</span>&nbsp;<span class="num" id="4860477">3</span>&nbsp;<span class="op" id="4860479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4860484">if</span>&nbsp;<span class="ident" id="4860487">reportErr</span>&nbsp;<span class="op" id="4860497">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4860503">log</span><span class="op" id="4860506">.</span><span class="ident" id="4860507">Println</span><span class="op" id="4860514">(</span><span class="string" id="4860515">&#34;method&#34;</span><span class="op" id="4860523">,</span>&nbsp;<span class="ident" id="4860525">mname</span><span class="op" id="4860530">,</span>&nbsp;<span class="string" id="4860532">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;ins:&#34;</span><span class="op" id="4860558">,</span>&nbsp;<span class="ident" id="4860560">mtype</span><span class="op" id="4860565">.</span><span class="ident" id="4860566">NumIn</span><span class="op" id="4860571">(</span><span class="op" id="4860572">)</span><span class="op" id="4860573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4860578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4860583">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4860594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4860598">//&nbsp;First&nbsp;arg&nbsp;need&nbsp;not&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4860636">argType</span>&nbsp;<span class="op" id="4860644">:=</span>&nbsp;<span class="ident" id="4860647">mtype</span><span class="op" id="4860652">.</span><span class="ident" id="4860653">In</span><span class="op" id="4860655">(</span><span class="num" id="4860656">1</span><span class="op" id="4860657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4860661">if</span>&nbsp;<span class="op" id="4860664">!</span><span class="ident" id="4860665">isExportedOrBuiltinType</span><span class="op" id="4860688">(</span><span class="ident" id="4860689">argType</span><span class="op" id="4860696">)</span>&nbsp;<span class="op" id="4860698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4860703">if</span>&nbsp;<span class="ident" id="4860706">reportErr</span>&nbsp;<span class="op" id="4860716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4860722">log</span><span class="op" id="4860725">.</span><span class="ident" id="4860726">Println</span><span class="op" id="4860733">(</span><span class="ident" id="4860734">mname</span><span class="op" id="4860739">,</span>&nbsp;<span class="string" id="4860741">&#34;argument&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="4860770">,</span>&nbsp;<span class="ident" id="4860772">argType</span><span class="op" id="4860779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4860784">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4860789">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4860800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4860804">//&nbsp;Second&nbsp;arg&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4860839">replyType</span>&nbsp;<span class="op" id="4860849">:=</span>&nbsp;<span class="ident" id="4860852">mtype</span><span class="op" id="4860857">.</span><span class="ident" id="4860858">In</span><span class="op" id="4860860">(</span><span class="num" id="4860861">2</span><span class="op" id="4860862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4860866">if</span>&nbsp;<span class="ident" id="4860869">replyType</span><span class="op" id="4860878">.</span><span class="ident" id="4860879">Kind</span><span class="op" id="4860883">(</span><span class="op" id="4860884">)</span>&nbsp;<span class="op" id="4860886">!=</span>&nbsp;<span class="ident" id="4860889">reflect</span><span class="op" id="4860896">.</span><span class="ident" id="4860897">Ptr</span>&nbsp;<span class="op" id="4860901">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4860906">if</span>&nbsp;<span class="ident" id="4860909">reportErr</span>&nbsp;<span class="op" id="4860919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4860925">log</span><span class="op" id="4860928">.</span><span class="ident" id="4860929">Println</span><span class="op" id="4860936">(</span><span class="string" id="4860937">&#34;method&#34;</span><span class="op" id="4860945">,</span>&nbsp;<span class="ident" id="4860947">mname</span><span class="op" id="4860952">,</span>&nbsp;<span class="string" id="4860954">&#34;reply&nbsp;type&nbsp;not&nbsp;a&nbsp;pointer:&#34;</span><span class="op" id="4860981">,</span>&nbsp;<span class="ident" id="4860983">replyType</span><span class="op" id="4860992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4860997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4861002">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4861013">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4861017">//&nbsp;Reply&nbsp;type&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4861051">if</span>&nbsp;<span class="op" id="4861054">!</span><span class="ident" id="4861055">isExportedOrBuiltinType</span><span class="op" id="4861078">(</span><span class="ident" id="4861079">replyType</span><span class="op" id="4861088">)</span>&nbsp;<span class="op" id="4861090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4861095">if</span>&nbsp;<span class="ident" id="4861098">reportErr</span>&nbsp;<span class="op" id="4861108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4861114">log</span><span class="op" id="4861117">.</span><span class="ident" id="4861118">Println</span><span class="op" id="4861125">(</span><span class="string" id="4861126">&#34;method&#34;</span><span class="op" id="4861134">,</span>&nbsp;<span class="ident" id="4861136">mname</span><span class="op" id="4861141">,</span>&nbsp;<span class="string" id="4861143">&#34;reply&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="4861169">,</span>&nbsp;<span class="ident" id="4861171">replyType</span><span class="op" id="4861180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4861185">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4861190">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4861201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4861205">//&nbsp;Method&nbsp;needs&nbsp;one&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4861232">if</span>&nbsp;<span class="ident" id="4861235">mtype</span><span class="op" id="4861240">.</span><span class="ident" id="4861241">NumOut</span><span class="op" id="4861247">(</span><span class="op" id="4861248">)</span>&nbsp;<span class="op" id="4861250">!=</span>&nbsp;<span class="num" id="4861253">1</span>&nbsp;<span class="op" id="4861255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4861260">if</span>&nbsp;<span class="ident" id="4861263">reportErr</span>&nbsp;<span class="op" id="4861273">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4861279">log</span><span class="op" id="4861282">.</span><span class="ident" id="4861283">Println</span><span class="op" id="4861290">(</span><span class="string" id="4861291">&#34;method&#34;</span><span class="op" id="4861299">,</span>&nbsp;<span class="ident" id="4861301">mname</span><span class="op" id="4861306">,</span>&nbsp;<span class="string" id="4861308">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;outs:&#34;</span><span class="op" id="4861335">,</span>&nbsp;<span class="ident" id="4861337">mtype</span><span class="op" id="4861342">.</span><span class="ident" id="4861343">NumOut</span><span class="op" id="4861349">(</span><span class="op" id="4861350">)</span><span class="op" id="4861351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4861356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4861361">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4861372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4861376">//&nbsp;The&nbsp;return&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;must&nbsp;be&nbsp;error.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4861426">if</span>&nbsp;<span class="ident" id="4861429">returnType</span>&nbsp;<span class="op" id="4861440">:=</span>&nbsp;<span class="ident" id="4861443">mtype</span><span class="op" id="4861448">.</span><span class="ident" id="4861449">Out</span><span class="op" id="4861452">(</span><span class="num" id="4861453">0</span><span class="op" id="4861454">)</span><span class="op" id="4861455">;</span>&nbsp;<span class="ident" id="4861457">returnType</span>&nbsp;<span class="op" id="4861468">!=</span>&nbsp;<span class="ident" id="4861471">typeOfError</span>&nbsp;<span class="op" id="4861483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4861488">if</span>&nbsp;<span class="ident" id="4861491">reportErr</span>&nbsp;<span class="op" id="4861501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4861507">log</span><span class="op" id="4861510">.</span><span class="ident" id="4861511">Println</span><span class="op" id="4861518">(</span><span class="string" id="4861519">&#34;method&#34;</span><span class="op" id="4861527">,</span>&nbsp;<span class="ident" id="4861529">mname</span><span class="op" id="4861534">,</span>&nbsp;<span class="string" id="4861536">&#34;returns&#34;</span><span class="op" id="4861545">,</span>&nbsp;<span class="ident" id="4861547">returnType</span><span class="op" id="4861557">.</span><span class="ident" id="4861558">String</span><span class="op" id="4861564">(</span><span class="op" id="4861565">)</span><span class="op" id="4861566">,</span>&nbsp;<span class="string" id="4861568">&#34;not&nbsp;error&#34;</span><span class="op" id="4861579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4861584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4861589">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4861600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4861604">methods</span><span class="op" id="4861611">[</span><span class="ident" id="4861612">mname</span><span class="op" id="4861617">]</span>&nbsp;<span class="op" id="4861619">=</span>&nbsp;<span class="op" id="4861621">&amp;</span><span class="ident" id="4861622">methodType</span><span class="op" id="4861632">{</span><span class="ident" id="4861633">method</span><span class="op" id="4861639">:</span>&nbsp;<span class="ident" id="4861641">method</span><span class="op" id="4861647">,</span>&nbsp;<span class="ident" id="4861649">ArgType</span><span class="op" id="4861656">:</span>&nbsp;<span class="ident" id="4861658">argType</span><span class="op" id="4861665">,</span>&nbsp;<span class="ident" id="4861667">ReplyType</span><span class="op" id="4861676">:</span>&nbsp;<span class="ident" id="4861678">replyType</span><span class="op" id="4861687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4861690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4861693">return</span>&nbsp;<span class="ident" id="4861700">methods</span><br>
<span class="lineno"></span><span class="op" id="4861708">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span><span class="comment" id="4861711">//&nbsp;A&nbsp;value&nbsp;sent&nbsp;as&nbsp;a&nbsp;placeholder&nbsp;for&nbsp;the&nbsp;server&#39;s&nbsp;response&nbsp;value&nbsp;when&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="4861792">//&nbsp;receives&nbsp;an&nbsp;invalid&nbsp;request.&nbsp;It&nbsp;is&nbsp;never&nbsp;decoded&nbsp;by&nbsp;the&nbsp;client&nbsp;since&nbsp;the&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="4861877">//&nbsp;contains&nbsp;an&nbsp;error&nbsp;when&nbsp;it&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4861915">var</span>&nbsp;<span class="ident" id="4861919">invalidRequest</span>&nbsp;<span class="op" id="4861934">=</span>&nbsp;<span class="keyword" id="4861936">struct</span><span class="op" id="4861942">{</span><span class="op" id="4861943">}</span><span class="op" id="4861944">{</span><span class="op" id="4861945">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="4861948">func</span>&nbsp;<span class="op" id="4861953">(</span><span class="ident" id="4861954">server</span>&nbsp;<span class="op" id="4861961">*</span><span class="ident" id="4861962">Server</span><span class="op" id="4861968">)</span>&nbsp;<span class="ident" id="4861970">sendResponse</span><span class="op" id="4861982">(</span><span class="ident" id="4861983">sending</span>&nbsp;<span class="op" id="4861991">*</span><span class="ident" id="4861992">sync</span><span class="op" id="4861996">.</span><span class="ident" id="4861997">Mutex</span><span class="op" id="4862002">,</span>&nbsp;<span class="ident" id="4862004">req</span>&nbsp;<span class="op" id="4862008">*</span><span class="ident" id="4862009">Request</span><span class="op" id="4862016">,</span>&nbsp;<span class="ident" id="4862018">reply</span>&nbsp;<span class="keyword" id="4862024">interface</span><span class="op" id="4862033">{</span><span class="op" id="4862034">}</span><span class="op" id="4862035">,</span>&nbsp;<span class="ident" id="4862037">codec</span>&nbsp;<span class="ident" id="4862043">ServerCodec</span><span class="op" id="4862054">,</span>&nbsp;<span class="ident" id="4862056">errmsg</span>&nbsp;<span class="builtintype" id="4862063">string</span><span class="op" id="4862069">)</span>&nbsp;<span class="op" id="4862071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862074">resp</span>&nbsp;<span class="op" id="4862079">:=</span>&nbsp;<span class="ident" id="4862082">server</span><span class="op" id="4862088">.</span><span class="ident" id="4862089">getResponse</span><span class="op" id="4862100">(</span><span class="op" id="4862101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4862104">//&nbsp;Encode&nbsp;the&nbsp;response&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862135">resp</span><span class="op" id="4862139">.</span><span class="ident" id="4862140">ServiceMethod</span>&nbsp;<span class="op" id="4862154">=</span>&nbsp;<span class="ident" id="4862156">req</span><span class="op" id="4862159">.</span><span class="ident" id="4862160">ServiceMethod</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4862175">if</span>&nbsp;<span class="ident" id="4862178">errmsg</span>&nbsp;<span class="op" id="4862185">!=</span>&nbsp;<span class="string" id="4862188">&#34;&#34;</span>&nbsp;<span class="op" id="4862191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862195">resp</span><span class="op" id="4862199">.</span><span class="ident" id="4862200">Error</span>&nbsp;<span class="op" id="4862206">=</span>&nbsp;<span class="ident" id="4862208">errmsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862217">reply</span>&nbsp;<span class="op" id="4862223">=</span>&nbsp;<span class="ident" id="4862225">invalidRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4862241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862244">resp</span><span class="op" id="4862248">.</span><span class="ident" id="4862249">Seq</span>&nbsp;<span class="op" id="4862253">=</span>&nbsp;<span class="ident" id="4862255">req</span><span class="op" id="4862258">.</span><span class="ident" id="4862259">Seq</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862264">sending</span><span class="op" id="4862271">.</span><span class="ident" id="4862272">Lock</span><span class="op" id="4862276">(</span><span class="op" id="4862277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862280">err</span>&nbsp;<span class="op" id="4862284">:=</span>&nbsp;<span class="ident" id="4862287">codec</span><span class="op" id="4862292">.</span><span class="ident" id="4862293">WriteResponse</span><span class="op" id="4862306">(</span><span class="ident" id="4862307">resp</span><span class="op" id="4862311">,</span>&nbsp;<span class="ident" id="4862313">reply</span><span class="op" id="4862318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4862321">if</span>&nbsp;<span class="ident" id="4862324">debugLog</span>&nbsp;<span class="op" id="4862333">&amp;&amp;</span>&nbsp;<span class="ident" id="4862336">err</span>&nbsp;<span class="op" id="4862340">!=</span>&nbsp;<span class="ident" id="4862343">nil</span>&nbsp;<span class="op" id="4862347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862351">log</span><span class="op" id="4862354">.</span><span class="ident" id="4862355">Println</span><span class="op" id="4862362">(</span><span class="string" id="4862363">&#34;rpc:&nbsp;writing&nbsp;response:&#34;</span><span class="op" id="4862387">,</span>&nbsp;<span class="ident" id="4862389">err</span><span class="op" id="4862392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4862395">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862398">sending</span><span class="op" id="4862405">.</span><span class="ident" id="4862406">Unlock</span><span class="op" id="4862412">(</span><span class="op" id="4862413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862416">server</span><span class="op" id="4862422">.</span><span class="ident" id="4862423">freeResponse</span><span class="op" id="4862435">(</span><span class="ident" id="4862436">resp</span><span class="op" id="4862440">)</span><br>
<span class="lineno"></span><span class="op" id="4862442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4862445">func</span>&nbsp;<span class="op" id="4862450">(</span><span class="ident" id="4862451">m</span>&nbsp;<span class="op" id="4862453">*</span><span class="ident" id="4862454">methodType</span><span class="op" id="4862464">)</span>&nbsp;<span class="ident" id="4862466">NumCalls</span><span class="op" id="4862474">(</span><span class="op" id="4862475">)</span>&nbsp;<span class="op" id="4862477">(</span><span class="ident" id="4862478">n</span>&nbsp;<span class="builtintype" id="4862480">uint</span><span class="op" id="4862484">)</span>&nbsp;<span class="op" id="4862486">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862489">m</span><span class="op" id="4862490">.</span><span class="ident" id="4862491">Lock</span><span class="op" id="4862495">(</span><span class="op" id="4862496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862499">n</span>&nbsp;<span class="op" id="4862501">=</span>&nbsp;<span class="ident" id="4862503">m</span><span class="op" id="4862504">.</span><span class="ident" id="4862505">numCalls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862515">m</span><span class="op" id="4862516">.</span><span class="ident" id="4862517">Unlock</span><span class="op" id="4862523">(</span><span class="op" id="4862524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4862527">return</span>&nbsp;<span class="ident" id="4862534">n</span><br>
<span class="lineno"></span><span class="op" id="4862536">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="4862539">func</span>&nbsp;<span class="op" id="4862544">(</span><span class="ident" id="4862545">s</span>&nbsp;<span class="op" id="4862547">*</span><span class="ident" id="4862548">service</span><span class="op" id="4862555">)</span>&nbsp;<span class="ident" id="4862557">call</span><span class="op" id="4862561">(</span><span class="ident" id="4862562">server</span>&nbsp;<span class="op" id="4862569">*</span><span class="ident" id="4862570">Server</span><span class="op" id="4862576">,</span>&nbsp;<span class="ident" id="4862578">sending</span>&nbsp;<span class="op" id="4862586">*</span><span class="ident" id="4862587">sync</span><span class="op" id="4862591">.</span><span class="ident" id="4862592">Mutex</span><span class="op" id="4862597">,</span>&nbsp;<span class="ident" id="4862599">mtype</span>&nbsp;<span class="op" id="4862605">*</span><span class="ident" id="4862606">methodType</span><span class="op" id="4862616">,</span>&nbsp;<span class="ident" id="4862618">req</span>&nbsp;<span class="op" id="4862622">*</span><span class="ident" id="4862623">Request</span><span class="op" id="4862630">,</span>&nbsp;<span class="ident" id="4862632">argv</span><span class="op" id="4862636">,</span>&nbsp;<span class="ident" id="4862638">replyv</span>&nbsp;<span class="ident" id="4862645">reflect</span><span class="op" id="4862652">.</span><span class="ident" id="4862653">Value</span><span class="op" id="4862658">,</span>&nbsp;<span class="ident" id="4862660">codec</span>&nbsp;<span class="ident" id="4862666">ServerCodec</span><span class="op" id="4862677">)</span>&nbsp;<span class="op" id="4862679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862682">mtype</span><span class="op" id="4862687">.</span><span class="ident" id="4862688">Lock</span><span class="op" id="4862692">(</span><span class="op" id="4862693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862696">mtype</span><span class="op" id="4862701">.</span><span class="ident" id="4862702">numCalls</span><span class="op" id="4862710">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862714">mtype</span><span class="op" id="4862719">.</span><span class="ident" id="4862720">Unlock</span><span class="op" id="4862726">(</span><span class="op" id="4862727">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862730">function</span>&nbsp;<span class="op" id="4862739">:=</span>&nbsp;<span class="ident" id="4862742">mtype</span><span class="op" id="4862747">.</span><span class="ident" id="4862748">method</span><span class="op" id="4862754">.</span><span class="ident" id="4862755">Func</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4862761">//&nbsp;Invoke&nbsp;the&nbsp;method,&nbsp;providing&nbsp;a&nbsp;new&nbsp;value&nbsp;for&nbsp;the&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862821">returnValues</span>&nbsp;<span class="op" id="4862834">:=</span>&nbsp;<span class="ident" id="4862837">function</span><span class="op" id="4862845">.</span><span class="ident" id="4862846">Call</span><span class="op" id="4862850">(</span><span class="op" id="4862851">[</span><span class="op" id="4862852">]</span><span class="ident" id="4862853">reflect</span><span class="op" id="4862860">.</span><span class="ident" id="4862861">Value</span><span class="op" id="4862866">{</span><span class="ident" id="4862867">s</span><span class="op" id="4862868">.</span><span class="ident" id="4862869">rcvr</span><span class="op" id="4862873">,</span>&nbsp;<span class="ident" id="4862875">argv</span><span class="op" id="4862879">,</span>&nbsp;<span class="ident" id="4862881">replyv</span><span class="op" id="4862887">}</span><span class="op" id="4862888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4862891">//&nbsp;The&nbsp;return&nbsp;value&nbsp;for&nbsp;the&nbsp;method&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862940">errInter</span>&nbsp;<span class="op" id="4862949">:=</span>&nbsp;<span class="ident" id="4862952">returnValues</span><span class="op" id="4862964">[</span><span class="num" id="4862965">0</span><span class="op" id="4862966">]</span><span class="op" id="4862967">.</span><span class="ident" id="4862968">Interface</span><span class="op" id="4862977">(</span><span class="op" id="4862978">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4862981">errmsg</span>&nbsp;<span class="op" id="4862988">:=</span>&nbsp;<span class="string" id="4862991">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4862995">if</span>&nbsp;<span class="ident" id="4862998">errInter</span>&nbsp;<span class="op" id="4863007">!=</span>&nbsp;<span class="ident" id="4863010">nil</span>&nbsp;<span class="op" id="4863014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4863018">errmsg</span>&nbsp;<span class="op" id="4863025">=</span>&nbsp;<span class="ident" id="4863027">errInter</span><span class="op" id="4863035">.</span><span class="op" id="4863036">(</span><span class="builtintype" id="4863037">error</span><span class="op" id="4863042">)</span><span class="op" id="4863043">.</span><span class="ident" id="4863044">Error</span><span class="op" id="4863049">(</span><span class="op" id="4863050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4863053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4863056">server</span><span class="op" id="4863062">.</span><span class="ident" id="4863063">sendResponse</span><span class="op" id="4863075">(</span><span class="ident" id="4863076">sending</span><span class="op" id="4863083">,</span>&nbsp;<span class="ident" id="4863085">req</span><span class="op" id="4863088">,</span>&nbsp;<span class="ident" id="4863090">replyv</span><span class="op" id="4863096">.</span><span class="ident" id="4863097">Interface</span><span class="op" id="4863106">(</span><span class="op" id="4863107">)</span><span class="op" id="4863108">,</span>&nbsp;<span class="ident" id="4863110">codec</span><span class="op" id="4863115">,</span>&nbsp;<span class="ident" id="4863117">errmsg</span><span class="op" id="4863123">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4863126">server</span><span class="op" id="4863132">.</span><span class="ident" id="4863133">freeRequest</span><span class="op" id="4863144">(</span><span class="ident" id="4863145">req</span><span class="op" id="4863148">)</span><br>
<span class="lineno"></span><span class="op" id="4863150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4863153">type</span>&nbsp;<span class="ident" id="4863158">gobServerCodec</span>&nbsp;<span class="keyword" id="4863173">struct</span>&nbsp;<span class="op" id="4863180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4863183">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4863190">io</span><span class="op" id="4863192">.</span><span class="ident" id="4863193">ReadWriteCloser</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4863210">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4863217">*</span><span class="ident" id="4863218">gob</span><span class="op" id="4863221">.</span><span class="ident" id="4863222">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4863231">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4863238">*</span><span class="ident" id="4863239">gob</span><span class="op" id="4863242">.</span><span class="ident" id="4863243">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4863252">encBuf</span>&nbsp;<span class="op" id="4863259">*</span><span class="ident" id="4863260">bufio</span><span class="op" id="4863265">.</span><span class="ident" id="4863266">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4863274">closed</span>&nbsp;<span class="builtintype" id="4863281">bool</span><br>
<span class="lineno"></span><span class="op" id="4863286">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="4863289">func</span>&nbsp;<span class="op" id="4863294">(</span><span class="ident" id="4863295">c</span>&nbsp;<span class="op" id="4863297">*</span><span class="ident" id="4863298">gobServerCodec</span><span class="op" id="4863312">)</span>&nbsp;<span class="ident" id="4863314">ReadRequestHeader</span><span class="op" id="4863331">(</span><span class="ident" id="4863332">r</span>&nbsp;<span class="op" id="4863334">*</span><span class="ident" id="4863335">Request</span><span class="op" id="4863342">)</span>&nbsp;<span class="builtintype" id="4863344">error</span>&nbsp;<span class="op" id="4863350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863353">return</span>&nbsp;<span class="ident" id="4863360">c</span><span class="op" id="4863361">.</span><span class="ident" id="4863362">dec</span><span class="op" id="4863365">.</span><span class="ident" id="4863366">Decode</span><span class="op" id="4863372">(</span><span class="ident" id="4863373">r</span><span class="op" id="4863374">)</span><br>
<span class="lineno"></span><span class="op" id="4863376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="4863379">func</span>&nbsp;<span class="op" id="4863384">(</span><span class="ident" id="4863385">c</span>&nbsp;<span class="op" id="4863387">*</span><span class="ident" id="4863388">gobServerCodec</span><span class="op" id="4863402">)</span>&nbsp;<span class="ident" id="4863404">ReadRequestBody</span><span class="op" id="4863419">(</span><span class="ident" id="4863420">body</span>&nbsp;<span class="keyword" id="4863425">interface</span><span class="op" id="4863434">{</span><span class="op" id="4863435">}</span><span class="op" id="4863436">)</span>&nbsp;<span class="builtintype" id="4863438">error</span>&nbsp;<span class="op" id="4863444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863447">return</span>&nbsp;<span class="ident" id="4863454">c</span><span class="op" id="4863455">.</span><span class="ident" id="4863456">dec</span><span class="op" id="4863459">.</span><span class="ident" id="4863460">Decode</span><span class="op" id="4863466">(</span><span class="ident" id="4863467">body</span><span class="op" id="4863471">)</span><br>
<span class="lineno"></span><span class="op" id="4863473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4863476">func</span>&nbsp;<span class="op" id="4863481">(</span><span class="ident" id="4863482">c</span>&nbsp;<span class="op" id="4863484">*</span><span class="ident" id="4863485">gobServerCodec</span><span class="op" id="4863499">)</span>&nbsp;<span class="ident" id="4863501">WriteResponse</span><span class="op" id="4863514">(</span><span class="ident" id="4863515">r</span>&nbsp;<span class="op" id="4863517">*</span><span class="ident" id="4863518">Response</span><span class="op" id="4863526">,</span>&nbsp;<span class="ident" id="4863528">body</span>&nbsp;<span class="keyword" id="4863533">interface</span><span class="op" id="4863542">{</span><span class="op" id="4863543">}</span><span class="op" id="4863544">)</span>&nbsp;<span class="op" id="4863546">(</span><span class="ident" id="4863547">err</span>&nbsp;<span class="builtintype" id="4863551">error</span><span class="op" id="4863556">)</span>&nbsp;<span class="op" id="4863558">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863561">if</span>&nbsp;<span class="ident" id="4863564">err</span>&nbsp;<span class="op" id="4863568">=</span>&nbsp;<span class="ident" id="4863570">c</span><span class="op" id="4863571">.</span><span class="ident" id="4863572">enc</span><span class="op" id="4863575">.</span><span class="ident" id="4863576">Encode</span><span class="op" id="4863582">(</span><span class="ident" id="4863583">r</span><span class="op" id="4863584">)</span><span class="op" id="4863585">;</span>&nbsp;<span class="ident" id="4863587">err</span>&nbsp;<span class="op" id="4863591">!=</span>&nbsp;<span class="ident" id="4863594">nil</span>&nbsp;<span class="op" id="4863598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863602">if</span>&nbsp;<span class="ident" id="4863605">c</span><span class="op" id="4863606">.</span><span class="ident" id="4863607">encBuf</span><span class="op" id="4863613">.</span><span class="ident" id="4863614">Flush</span><span class="op" id="4863619">(</span><span class="op" id="4863620">)</span>&nbsp;<span class="op" id="4863622">==</span>&nbsp;<span class="ident" id="4863625">nil</span>&nbsp;<span class="op" id="4863629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4863634">//&nbsp;Gob&nbsp;couldn&#39;t&nbsp;encode&nbsp;the&nbsp;header.&nbsp;Should&nbsp;not&nbsp;happen,&nbsp;so&nbsp;if&nbsp;it&nbsp;does,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4863706">//&nbsp;shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4863778">log</span><span class="op" id="4863781">.</span><span class="ident" id="4863782">Println</span><span class="op" id="4863789">(</span><span class="string" id="4863790">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;response:&#34;</span><span class="op" id="4863825">,</span>&nbsp;<span class="ident" id="4863827">err</span><span class="op" id="4863830">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4863835">c</span><span class="op" id="4863836">.</span><span class="ident" id="4863837">Close</span><span class="op" id="4863842">(</span><span class="op" id="4863843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4863847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863851">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4863859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863862">if</span>&nbsp;<span class="ident" id="4863865">err</span>&nbsp;<span class="op" id="4863869">=</span>&nbsp;<span class="ident" id="4863871">c</span><span class="op" id="4863872">.</span><span class="ident" id="4863873">enc</span><span class="op" id="4863876">.</span><span class="ident" id="4863877">Encode</span><span class="op" id="4863883">(</span><span class="ident" id="4863884">body</span><span class="op" id="4863888">)</span><span class="op" id="4863889">;</span>&nbsp;<span class="ident" id="4863891">err</span>&nbsp;<span class="op" id="4863895">!=</span>&nbsp;<span class="ident" id="4863898">nil</span>&nbsp;<span class="op" id="4863902">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4863906">if</span>&nbsp;<span class="ident" id="4863909">c</span><span class="op" id="4863910">.</span><span class="ident" id="4863911">encBuf</span><span class="op" id="4863917">.</span><span class="ident" id="4863918">Flush</span><span class="op" id="4863923">(</span><span class="op" id="4863924">)</span>&nbsp;<span class="op" id="4863926">==</span>&nbsp;<span class="ident" id="4863929">nil</span>&nbsp;<span class="op" id="4863933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4863938">//&nbsp;Was&nbsp;a&nbsp;gob&nbsp;problem&nbsp;encoding&nbsp;the&nbsp;body&nbsp;but&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4864013">//&nbsp;Shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864085">log</span><span class="op" id="4864088">.</span><span class="ident" id="4864089">Println</span><span class="op" id="4864096">(</span><span class="string" id="4864097">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;body:&#34;</span><span class="op" id="4864128">,</span>&nbsp;<span class="ident" id="4864130">err</span><span class="op" id="4864133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864138">c</span><span class="op" id="4864139">.</span><span class="ident" id="4864140">Close</span><span class="op" id="4864145">(</span><span class="op" id="4864146">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4864150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4864154">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4864162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4864165">return</span>&nbsp;<span class="ident" id="4864172">c</span><span class="op" id="4864173">.</span><span class="ident" id="4864174">encBuf</span><span class="op" id="4864180">.</span><span class="ident" id="4864181">Flush</span><span class="op" id="4864186">(</span><span class="op" id="4864187">)</span><br>
<span class="lineno"></span><span class="op" id="4864189">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="4864192">func</span>&nbsp;<span class="op" id="4864197">(</span><span class="ident" id="4864198">c</span>&nbsp;<span class="op" id="4864200">*</span><span class="ident" id="4864201">gobServerCodec</span><span class="op" id="4864215">)</span>&nbsp;<span class="ident" id="4864217">Close</span><span class="op" id="4864222">(</span><span class="op" id="4864223">)</span>&nbsp;<span class="builtintype" id="4864225">error</span>&nbsp;<span class="op" id="4864231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4864234">if</span>&nbsp;<span class="ident" id="4864237">c</span><span class="op" id="4864238">.</span><span class="ident" id="4864239">closed</span>&nbsp;<span class="op" id="4864246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4864250">//&nbsp;Only&nbsp;call&nbsp;c.rwc.Close&nbsp;once;&nbsp;otherwise&nbsp;the&nbsp;semantics&nbsp;are&nbsp;undefined.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4864322">return</span>&nbsp;<span class="ident" id="4864329">nil</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4864334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864337">c</span><span class="op" id="4864338">.</span><span class="ident" id="4864339">closed</span>&nbsp;<span class="op" id="4864346">=</span>&nbsp;<span class="builtintype" id="4864348">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4864354">return</span>&nbsp;<span class="ident" id="4864361">c</span><span class="op" id="4864362">.</span><span class="ident" id="4864363">rwc</span><span class="op" id="4864366">.</span><span class="ident" id="4864367">Close</span><span class="op" id="4864372">(</span><span class="op" id="4864373">)</span><br>
<span class="lineno"></span><span class="op" id="4864375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span><span class="comment" id="4864378">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4864431">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="4864502">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="4864563">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4864626">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">445</span><span class="keyword" id="4864685">func</span>&nbsp;<span class="op" id="4864690">(</span><span class="ident" id="4864691">server</span>&nbsp;<span class="op" id="4864698">*</span><span class="ident" id="4864699">Server</span><span class="op" id="4864705">)</span>&nbsp;<span class="ident" id="4864707">ServeConn</span><span class="op" id="4864716">(</span><span class="ident" id="4864717">conn</span>&nbsp;<span class="ident" id="4864722">io</span><span class="op" id="4864724">.</span><span class="ident" id="4864725">ReadWriteCloser</span><span class="op" id="4864740">)</span>&nbsp;<span class="op" id="4864742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864745">buf</span>&nbsp;<span class="op" id="4864749">:=</span>&nbsp;<span class="ident" id="4864752">bufio</span><span class="op" id="4864757">.</span><span class="ident" id="4864758">NewWriter</span><span class="op" id="4864767">(</span><span class="ident" id="4864768">conn</span><span class="op" id="4864772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864775">srv</span>&nbsp;<span class="op" id="4864779">:=</span>&nbsp;<span class="op" id="4864782">&amp;</span><span class="ident" id="4864783">gobServerCodec</span><span class="op" id="4864797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864801">rwc</span><span class="op" id="4864804">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864809">conn</span><span class="op" id="4864813">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864817">dec</span><span class="op" id="4864820">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864825">gob</span><span class="op" id="4864828">.</span><span class="ident" id="4864829">NewDecoder</span><span class="op" id="4864839">(</span><span class="ident" id="4864840">conn</span><span class="op" id="4864844">)</span><span class="op" id="4864845">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864849">enc</span><span class="op" id="4864852">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864857">gob</span><span class="op" id="4864860">.</span><span class="ident" id="4864861">NewEncoder</span><span class="op" id="4864871">(</span><span class="ident" id="4864872">buf</span><span class="op" id="4864875">)</span><span class="op" id="4864876">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864880">encBuf</span><span class="op" id="4864886">:</span>&nbsp;<span class="ident" id="4864888">buf</span><span class="op" id="4864891">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4864894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4864897">server</span><span class="op" id="4864903">.</span><span class="ident" id="4864904">ServeCodec</span><span class="op" id="4864914">(</span><span class="ident" id="4864915">srv</span><span class="op" id="4864918">)</span><br>
<span class="lineno"></span><span class="op" id="4864920">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="4864923">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4864987">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="4865028">func</span>&nbsp;<span class="op" id="4865033">(</span><span class="ident" id="4865034">server</span>&nbsp;<span class="op" id="4865041">*</span><span class="ident" id="4865042">Server</span><span class="op" id="4865048">)</span>&nbsp;<span class="ident" id="4865050">ServeCodec</span><span class="op" id="4865060">(</span><span class="ident" id="4865061">codec</span>&nbsp;<span class="ident" id="4865067">ServerCodec</span><span class="op" id="4865078">)</span>&nbsp;<span class="op" id="4865080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865083">sending</span>&nbsp;<span class="op" id="4865091">:=</span>&nbsp;<span class="builtinfunc" id="4865094">new</span><span class="op" id="4865097">(</span><span class="ident" id="4865098">sync</span><span class="op" id="4865102">.</span><span class="ident" id="4865103">Mutex</span><span class="op" id="4865108">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865111">for</span>&nbsp;<span class="op" id="4865115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865119">service</span><span class="op" id="4865126">,</span>&nbsp;<span class="ident" id="4865128">mtype</span><span class="op" id="4865133">,</span>&nbsp;<span class="ident" id="4865135">req</span><span class="op" id="4865138">,</span>&nbsp;<span class="ident" id="4865140">argv</span><span class="op" id="4865144">,</span>&nbsp;<span class="ident" id="4865146">replyv</span><span class="op" id="4865152">,</span>&nbsp;<span class="ident" id="4865154">keepReading</span><span class="op" id="4865165">,</span>&nbsp;<span class="ident" id="4865167">err</span>&nbsp;<span class="op" id="4865171">:=</span>&nbsp;<span class="ident" id="4865174">server</span><span class="op" id="4865180">.</span><span class="ident" id="4865181">readRequest</span><span class="op" id="4865192">(</span><span class="ident" id="4865193">codec</span><span class="op" id="4865198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865202">if</span>&nbsp;<span class="ident" id="4865205">err</span>&nbsp;<span class="op" id="4865209">!=</span>&nbsp;<span class="ident" id="4865212">nil</span>&nbsp;<span class="op" id="4865216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865221">if</span>&nbsp;<span class="ident" id="4865224">debugLog</span>&nbsp;<span class="op" id="4865233">&amp;&amp;</span>&nbsp;<span class="ident" id="4865236">err</span>&nbsp;<span class="op" id="4865240">!=</span>&nbsp;<span class="ident" id="4865243">io</span><span class="op" id="4865245">.</span><span class="ident" id="4865246">EOF</span>&nbsp;<span class="op" id="4865250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865256">log</span><span class="op" id="4865259">.</span><span class="ident" id="4865260">Println</span><span class="op" id="4865267">(</span><span class="string" id="4865268">&#34;rpc:&#34;</span><span class="op" id="4865274">,</span>&nbsp;<span class="ident" id="4865276">err</span><span class="op" id="4865279">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4865284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865289">if</span>&nbsp;<span class="op" id="4865292">!</span><span class="ident" id="4865293">keepReading</span>&nbsp;<span class="op" id="4865305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865311">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4865320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4865325">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865388">if</span>&nbsp;<span class="ident" id="4865391">req</span>&nbsp;<span class="op" id="4865395">!=</span>&nbsp;<span class="ident" id="4865398">nil</span>&nbsp;<span class="op" id="4865402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865408">server</span><span class="op" id="4865414">.</span><span class="ident" id="4865415">sendResponse</span><span class="op" id="4865427">(</span><span class="ident" id="4865428">sending</span><span class="op" id="4865435">,</span>&nbsp;<span class="ident" id="4865437">req</span><span class="op" id="4865440">,</span>&nbsp;<span class="ident" id="4865442">invalidRequest</span><span class="op" id="4865456">,</span>&nbsp;<span class="ident" id="4865458">codec</span><span class="op" id="4865463">,</span>&nbsp;<span class="ident" id="4865465">err</span><span class="op" id="4865468">.</span><span class="ident" id="4865469">Error</span><span class="op" id="4865474">(</span><span class="op" id="4865475">)</span><span class="op" id="4865476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865482">server</span><span class="op" id="4865488">.</span><span class="ident" id="4865489">freeRequest</span><span class="op" id="4865500">(</span><span class="ident" id="4865501">req</span><span class="op" id="4865504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4865509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865514">continue</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4865525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865529">go</span>&nbsp;<span class="ident" id="4865532">service</span><span class="op" id="4865539">.</span><span class="ident" id="4865540">call</span><span class="op" id="4865544">(</span><span class="ident" id="4865545">server</span><span class="op" id="4865551">,</span>&nbsp;<span class="ident" id="4865553">sending</span><span class="op" id="4865560">,</span>&nbsp;<span class="ident" id="4865562">mtype</span><span class="op" id="4865567">,</span>&nbsp;<span class="ident" id="4865569">req</span><span class="op" id="4865572">,</span>&nbsp;<span class="ident" id="4865574">argv</span><span class="op" id="4865578">,</span>&nbsp;<span class="ident" id="4865580">replyv</span><span class="op" id="4865586">,</span>&nbsp;<span class="ident" id="4865588">codec</span><span class="op" id="4865593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4865596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865599">codec</span><span class="op" id="4865604">.</span><span class="ident" id="4865605">Close</span><span class="op" id="4865610">(</span><span class="op" id="4865611">)</span><br>
<span class="lineno"></span><span class="op" id="4865613">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="4865616">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="4865694">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="4865742">func</span>&nbsp;<span class="op" id="4865747">(</span><span class="ident" id="4865748">server</span>&nbsp;<span class="op" id="4865755">*</span><span class="ident" id="4865756">Server</span><span class="op" id="4865762">)</span>&nbsp;<span class="ident" id="4865764">ServeRequest</span><span class="op" id="4865776">(</span><span class="ident" id="4865777">codec</span>&nbsp;<span class="ident" id="4865783">ServerCodec</span><span class="op" id="4865794">)</span>&nbsp;<span class="builtintype" id="4865796">error</span>&nbsp;<span class="op" id="4865802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865805">sending</span>&nbsp;<span class="op" id="4865813">:=</span>&nbsp;<span class="builtinfunc" id="4865816">new</span><span class="op" id="4865819">(</span><span class="ident" id="4865820">sync</span><span class="op" id="4865824">.</span><span class="ident" id="4865825">Mutex</span><span class="op" id="4865830">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4865833">service</span><span class="op" id="4865840">,</span>&nbsp;<span class="ident" id="4865842">mtype</span><span class="op" id="4865847">,</span>&nbsp;<span class="ident" id="4865849">req</span><span class="op" id="4865852">,</span>&nbsp;<span class="ident" id="4865854">argv</span><span class="op" id="4865858">,</span>&nbsp;<span class="ident" id="4865860">replyv</span><span class="op" id="4865866">,</span>&nbsp;<span class="ident" id="4865868">keepReading</span><span class="op" id="4865879">,</span>&nbsp;<span class="ident" id="4865881">err</span>&nbsp;<span class="op" id="4865885">:=</span>&nbsp;<span class="ident" id="4865888">server</span><span class="op" id="4865894">.</span><span class="ident" id="4865895">readRequest</span><span class="op" id="4865906">(</span><span class="ident" id="4865907">codec</span><span class="op" id="4865912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865915">if</span>&nbsp;<span class="ident" id="4865918">err</span>&nbsp;<span class="op" id="4865922">!=</span>&nbsp;<span class="ident" id="4865925">nil</span>&nbsp;<span class="op" id="4865929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865933">if</span>&nbsp;<span class="op" id="4865936">!</span><span class="ident" id="4865937">keepReading</span>&nbsp;<span class="op" id="4865949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4865954">return</span>&nbsp;<span class="ident" id="4865961">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4865967">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4865971">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866033">if</span>&nbsp;<span class="ident" id="4866036">req</span>&nbsp;<span class="op" id="4866040">!=</span>&nbsp;<span class="ident" id="4866043">nil</span>&nbsp;<span class="op" id="4866047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866052">server</span><span class="op" id="4866058">.</span><span class="ident" id="4866059">sendResponse</span><span class="op" id="4866071">(</span><span class="ident" id="4866072">sending</span><span class="op" id="4866079">,</span>&nbsp;<span class="ident" id="4866081">req</span><span class="op" id="4866084">,</span>&nbsp;<span class="ident" id="4866086">invalidRequest</span><span class="op" id="4866100">,</span>&nbsp;<span class="ident" id="4866102">codec</span><span class="op" id="4866107">,</span>&nbsp;<span class="ident" id="4866109">err</span><span class="op" id="4866112">.</span><span class="ident" id="4866113">Error</span><span class="op" id="4866118">(</span><span class="op" id="4866119">)</span><span class="op" id="4866120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866125">server</span><span class="op" id="4866131">.</span><span class="ident" id="4866132">freeRequest</span><span class="op" id="4866143">(</span><span class="ident" id="4866144">req</span><span class="op" id="4866147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4866151">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866155">return</span>&nbsp;<span class="ident" id="4866162">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4866167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866170">service</span><span class="op" id="4866177">.</span><span class="ident" id="4866178">call</span><span class="op" id="4866182">(</span><span class="ident" id="4866183">server</span><span class="op" id="4866189">,</span>&nbsp;<span class="ident" id="4866191">sending</span><span class="op" id="4866198">,</span>&nbsp;<span class="ident" id="4866200">mtype</span><span class="op" id="4866205">,</span>&nbsp;<span class="ident" id="4866207">req</span><span class="op" id="4866210">,</span>&nbsp;<span class="ident" id="4866212">argv</span><span class="op" id="4866216">,</span>&nbsp;<span class="ident" id="4866218">replyv</span><span class="op" id="4866224">,</span>&nbsp;<span class="ident" id="4866226">codec</span><span class="op" id="4866231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866234">return</span>&nbsp;<span class="ident" id="4866241">nil</span><br>
<span class="lineno"></span><span class="op" id="4866245">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="4866248">func</span>&nbsp;<span class="op" id="4866253">(</span><span class="ident" id="4866254">server</span>&nbsp;<span class="op" id="4866261">*</span><span class="ident" id="4866262">Server</span><span class="op" id="4866268">)</span>&nbsp;<span class="ident" id="4866270">getRequest</span><span class="op" id="4866280">(</span><span class="op" id="4866281">)</span>&nbsp;<span class="op" id="4866283">*</span><span class="ident" id="4866284">Request</span>&nbsp;<span class="op" id="4866292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866295">server</span><span class="op" id="4866301">.</span><span class="ident" id="4866302">reqLock</span><span class="op" id="4866309">.</span><span class="ident" id="4866310">Lock</span><span class="op" id="4866314">(</span><span class="op" id="4866315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866318">req</span>&nbsp;<span class="op" id="4866322">:=</span>&nbsp;<span class="ident" id="4866325">server</span><span class="op" id="4866331">.</span><span class="ident" id="4866332">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866341">if</span>&nbsp;<span class="ident" id="4866344">req</span>&nbsp;<span class="op" id="4866348">==</span>&nbsp;<span class="ident" id="4866351">nil</span>&nbsp;<span class="op" id="4866355">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866359">req</span>&nbsp;<span class="op" id="4866363">=</span>&nbsp;<span class="builtinfunc" id="4866365">new</span><span class="op" id="4866368">(</span><span class="ident" id="4866369">Request</span><span class="op" id="4866376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4866379">}</span>&nbsp;<span class="keyword" id="4866381">else</span>&nbsp;<span class="op" id="4866386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866390">server</span><span class="op" id="4866396">.</span><span class="ident" id="4866397">freeReq</span>&nbsp;<span class="op" id="4866405">=</span>&nbsp;<span class="ident" id="4866407">req</span><span class="op" id="4866410">.</span><span class="ident" id="4866411">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4866418">*</span><span class="ident" id="4866419">req</span>&nbsp;<span class="op" id="4866423">=</span>&nbsp;<span class="ident" id="4866425">Request</span><span class="op" id="4866432">{</span><span class="op" id="4866433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4866436">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866439">server</span><span class="op" id="4866445">.</span><span class="ident" id="4866446">reqLock</span><span class="op" id="4866453">.</span><span class="ident" id="4866454">Unlock</span><span class="op" id="4866460">(</span><span class="op" id="4866461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866464">return</span>&nbsp;<span class="ident" id="4866471">req</span><br>
<span class="lineno"></span><span class="op" id="4866475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4866478">func</span>&nbsp;<span class="op" id="4866483">(</span><span class="ident" id="4866484">server</span>&nbsp;<span class="op" id="4866491">*</span><span class="ident" id="4866492">Server</span><span class="op" id="4866498">)</span>&nbsp;<span class="ident" id="4866500">freeRequest</span><span class="op" id="4866511">(</span><span class="ident" id="4866512">req</span>&nbsp;<span class="op" id="4866516">*</span><span class="ident" id="4866517">Request</span><span class="op" id="4866524">)</span>&nbsp;<span class="op" id="4866526">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866529">server</span><span class="op" id="4866535">.</span><span class="ident" id="4866536">reqLock</span><span class="op" id="4866543">.</span><span class="ident" id="4866544">Lock</span><span class="op" id="4866548">(</span><span class="op" id="4866549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866552">req</span><span class="op" id="4866555">.</span><span class="ident" id="4866556">next</span>&nbsp;<span class="op" id="4866561">=</span>&nbsp;<span class="ident" id="4866563">server</span><span class="op" id="4866569">.</span><span class="ident" id="4866570">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866579">server</span><span class="op" id="4866585">.</span><span class="ident" id="4866586">freeReq</span>&nbsp;<span class="op" id="4866594">=</span>&nbsp;<span class="ident" id="4866596">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866601">server</span><span class="op" id="4866607">.</span><span class="ident" id="4866608">reqLock</span><span class="op" id="4866615">.</span><span class="ident" id="4866616">Unlock</span><span class="op" id="4866622">(</span><span class="op" id="4866623">)</span><br>
<span class="lineno"></span><span class="op" id="4866625">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span><span class="keyword" id="4866628">func</span>&nbsp;<span class="op" id="4866633">(</span><span class="ident" id="4866634">server</span>&nbsp;<span class="op" id="4866641">*</span><span class="ident" id="4866642">Server</span><span class="op" id="4866648">)</span>&nbsp;<span class="ident" id="4866650">getResponse</span><span class="op" id="4866661">(</span><span class="op" id="4866662">)</span>&nbsp;<span class="op" id="4866664">*</span><span class="ident" id="4866665">Response</span>&nbsp;<span class="op" id="4866674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866677">server</span><span class="op" id="4866683">.</span><span class="ident" id="4866684">respLock</span><span class="op" id="4866692">.</span><span class="ident" id="4866693">Lock</span><span class="op" id="4866697">(</span><span class="op" id="4866698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866701">resp</span>&nbsp;<span class="op" id="4866706">:=</span>&nbsp;<span class="ident" id="4866709">server</span><span class="op" id="4866715">.</span><span class="ident" id="4866716">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866726">if</span>&nbsp;<span class="ident" id="4866729">resp</span>&nbsp;<span class="op" id="4866734">==</span>&nbsp;<span class="ident" id="4866737">nil</span>&nbsp;<span class="op" id="4866741">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866745">resp</span>&nbsp;<span class="op" id="4866750">=</span>&nbsp;<span class="builtinfunc" id="4866752">new</span><span class="op" id="4866755">(</span><span class="ident" id="4866756">Response</span><span class="op" id="4866764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4866767">}</span>&nbsp;<span class="keyword" id="4866769">else</span>&nbsp;<span class="op" id="4866774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866778">server</span><span class="op" id="4866784">.</span><span class="ident" id="4866785">freeResp</span>&nbsp;<span class="op" id="4866794">=</span>&nbsp;<span class="ident" id="4866796">resp</span><span class="op" id="4866800">.</span><span class="ident" id="4866801">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4866808">*</span><span class="ident" id="4866809">resp</span>&nbsp;<span class="op" id="4866814">=</span>&nbsp;<span class="ident" id="4866816">Response</span><span class="op" id="4866824">{</span><span class="op" id="4866825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4866828">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866831">server</span><span class="op" id="4866837">.</span><span class="ident" id="4866838">respLock</span><span class="op" id="4866846">.</span><span class="ident" id="4866847">Unlock</span><span class="op" id="4866853">(</span><span class="op" id="4866854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4866857">return</span>&nbsp;<span class="ident" id="4866864">resp</span><br>
<span class="lineno"></span><span class="op" id="4866869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4866872">func</span>&nbsp;<span class="op" id="4866877">(</span><span class="ident" id="4866878">server</span>&nbsp;<span class="op" id="4866885">*</span><span class="ident" id="4866886">Server</span><span class="op" id="4866892">)</span>&nbsp;<span class="ident" id="4866894">freeResponse</span><span class="op" id="4866906">(</span><span class="ident" id="4866907">resp</span>&nbsp;<span class="op" id="4866912">*</span><span class="ident" id="4866913">Response</span><span class="op" id="4866921">)</span>&nbsp;<span class="op" id="4866923">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866926">server</span><span class="op" id="4866932">.</span><span class="ident" id="4866933">respLock</span><span class="op" id="4866941">.</span><span class="ident" id="4866942">Lock</span><span class="op" id="4866946">(</span><span class="op" id="4866947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866950">resp</span><span class="op" id="4866954">.</span><span class="ident" id="4866955">next</span>&nbsp;<span class="op" id="4866960">=</span>&nbsp;<span class="ident" id="4866962">server</span><span class="op" id="4866968">.</span><span class="ident" id="4866969">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4866979">server</span><span class="op" id="4866985">.</span><span class="ident" id="4866986">freeResp</span>&nbsp;<span class="op" id="4866995">=</span>&nbsp;<span class="ident" id="4866997">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867003">server</span><span class="op" id="4867009">.</span><span class="ident" id="4867010">respLock</span><span class="op" id="4867018">.</span><span class="ident" id="4867019">Unlock</span><span class="op" id="4867025">(</span><span class="op" id="4867026">)</span><br>
<span class="lineno"></span><span class="op" id="4867028">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="4867031">func</span>&nbsp;<span class="op" id="4867036">(</span><span class="ident" id="4867037">server</span>&nbsp;<span class="op" id="4867044">*</span><span class="ident" id="4867045">Server</span><span class="op" id="4867051">)</span>&nbsp;<span class="ident" id="4867053">readRequest</span><span class="op" id="4867064">(</span><span class="ident" id="4867065">codec</span>&nbsp;<span class="ident" id="4867071">ServerCodec</span><span class="op" id="4867082">)</span>&nbsp;<span class="op" id="4867084">(</span><span class="ident" id="4867085">service</span>&nbsp;<span class="op" id="4867093">*</span><span class="ident" id="4867094">service</span><span class="op" id="4867101">,</span>&nbsp;<span class="ident" id="4867103">mtype</span>&nbsp;<span class="op" id="4867109">*</span><span class="ident" id="4867110">methodType</span><span class="op" id="4867120">,</span>&nbsp;<span class="ident" id="4867122">req</span>&nbsp;<span class="op" id="4867126">*</span><span class="ident" id="4867127">Request</span><span class="op" id="4867134">,</span>&nbsp;<span class="ident" id="4867136">argv</span><span class="op" id="4867140">,</span>&nbsp;<span class="ident" id="4867142">replyv</span>&nbsp;<span class="ident" id="4867149">reflect</span><span class="op" id="4867156">.</span><span class="ident" id="4867157">Value</span><span class="op" id="4867162">,</span>&nbsp;<span class="ident" id="4867164">keepReading</span>&nbsp;<span class="builtintype" id="4867176">bool</span><span class="op" id="4867180">,</span>&nbsp;<span class="ident" id="4867182">err</span>&nbsp;<span class="builtintype" id="4867186">error</span><span class="op" id="4867191">)</span>&nbsp;<span class="op" id="4867193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867196">service</span><span class="op" id="4867203">,</span>&nbsp;<span class="ident" id="4867205">mtype</span><span class="op" id="4867210">,</span>&nbsp;<span class="ident" id="4867212">req</span><span class="op" id="4867215">,</span>&nbsp;<span class="ident" id="4867217">keepReading</span><span class="op" id="4867228">,</span>&nbsp;<span class="ident" id="4867230">err</span>&nbsp;<span class="op" id="4867234">=</span>&nbsp;<span class="ident" id="4867236">server</span><span class="op" id="4867242">.</span><span class="ident" id="4867243">readRequestHeader</span><span class="op" id="4867260">(</span><span class="ident" id="4867261">codec</span><span class="op" id="4867266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867269">if</span>&nbsp;<span class="ident" id="4867272">err</span>&nbsp;<span class="op" id="4867276">!=</span>&nbsp;<span class="ident" id="4867279">nil</span>&nbsp;<span class="op" id="4867283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867287">if</span>&nbsp;<span class="op" id="4867290">!</span><span class="ident" id="4867291">keepReading</span>&nbsp;<span class="op" id="4867303">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867308">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4867317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4867321">//&nbsp;discard&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867339">codec</span><span class="op" id="4867344">.</span><span class="ident" id="4867345">ReadRequestBody</span><span class="op" id="4867360">(</span><span class="ident" id="4867361">nil</span><span class="op" id="4867364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867368">return</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4867376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4867380">//&nbsp;Decode&nbsp;the&nbsp;argument&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867411">argIsValue</span>&nbsp;<span class="op" id="4867422">:=</span>&nbsp;<span class="builtintype" id="4867425">false</span>&nbsp;<span class="comment" id="4867431">//&nbsp;if&nbsp;true,&nbsp;need&nbsp;to&nbsp;indirect&nbsp;before&nbsp;calling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867477">if</span>&nbsp;<span class="ident" id="4867480">mtype</span><span class="op" id="4867485">.</span><span class="ident" id="4867486">ArgType</span><span class="op" id="4867493">.</span><span class="ident" id="4867494">Kind</span><span class="op" id="4867498">(</span><span class="op" id="4867499">)</span>&nbsp;<span class="op" id="4867501">==</span>&nbsp;<span class="ident" id="4867504">reflect</span><span class="op" id="4867511">.</span><span class="ident" id="4867512">Ptr</span>&nbsp;<span class="op" id="4867516">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867520">argv</span>&nbsp;<span class="op" id="4867525">=</span>&nbsp;<span class="ident" id="4867527">reflect</span><span class="op" id="4867534">.</span><span class="ident" id="4867535">New</span><span class="op" id="4867538">(</span><span class="ident" id="4867539">mtype</span><span class="op" id="4867544">.</span><span class="ident" id="4867545">ArgType</span><span class="op" id="4867552">.</span><span class="ident" id="4867553">Elem</span><span class="op" id="4867557">(</span><span class="op" id="4867558">)</span><span class="op" id="4867559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4867562">}</span>&nbsp;<span class="keyword" id="4867564">else</span>&nbsp;<span class="op" id="4867569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867573">argv</span>&nbsp;<span class="op" id="4867578">=</span>&nbsp;<span class="ident" id="4867580">reflect</span><span class="op" id="4867587">.</span><span class="ident" id="4867588">New</span><span class="op" id="4867591">(</span><span class="ident" id="4867592">mtype</span><span class="op" id="4867597">.</span><span class="ident" id="4867598">ArgType</span><span class="op" id="4867605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867609">argIsValue</span>&nbsp;<span class="op" id="4867620">=</span>&nbsp;<span class="builtintype" id="4867622">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4867628">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4867631">//&nbsp;argv&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;a&nbsp;pointer&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867672">if</span>&nbsp;<span class="ident" id="4867675">err</span>&nbsp;<span class="op" id="4867679">=</span>&nbsp;<span class="ident" id="4867681">codec</span><span class="op" id="4867686">.</span><span class="ident" id="4867687">ReadRequestBody</span><span class="op" id="4867702">(</span><span class="ident" id="4867703">argv</span><span class="op" id="4867707">.</span><span class="ident" id="4867708">Interface</span><span class="op" id="4867717">(</span><span class="op" id="4867718">)</span><span class="op" id="4867719">)</span><span class="op" id="4867720">;</span>&nbsp;<span class="ident" id="4867722">err</span>&nbsp;<span class="op" id="4867726">!=</span>&nbsp;<span class="ident" id="4867729">nil</span>&nbsp;<span class="op" id="4867733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867737">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4867745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867748">if</span>&nbsp;<span class="ident" id="4867751">argIsValue</span>&nbsp;<span class="op" id="4867762">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867766">argv</span>&nbsp;<span class="op" id="4867771">=</span>&nbsp;<span class="ident" id="4867773">argv</span><span class="op" id="4867777">.</span><span class="ident" id="4867778">Elem</span><span class="op" id="4867782">(</span><span class="op" id="4867783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4867786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867790">replyv</span>&nbsp;<span class="op" id="4867797">=</span>&nbsp;<span class="ident" id="4867799">reflect</span><span class="op" id="4867806">.</span><span class="ident" id="4867807">New</span><span class="op" id="4867810">(</span><span class="ident" id="4867811">mtype</span><span class="op" id="4867816">.</span><span class="ident" id="4867817">ReplyType</span><span class="op" id="4867826">.</span><span class="ident" id="4867827">Elem</span><span class="op" id="4867831">(</span><span class="op" id="4867832">)</span><span class="op" id="4867833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4867836">return</span><br>
<span class="lineno">570</span><span class="op" id="4867843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4867846">func</span>&nbsp;<span class="op" id="4867851">(</span><span class="ident" id="4867852">server</span>&nbsp;<span class="op" id="4867859">*</span><span class="ident" id="4867860">Server</span><span class="op" id="4867866">)</span>&nbsp;<span class="ident" id="4867868">readRequestHeader</span><span class="op" id="4867885">(</span><span class="ident" id="4867886">codec</span>&nbsp;<span class="ident" id="4867892">ServerCodec</span><span class="op" id="4867903">)</span>&nbsp;<span class="op" id="4867905">(</span><span class="ident" id="4867906">service</span>&nbsp;<span class="op" id="4867914">*</span><span class="ident" id="4867915">service</span><span class="op" id="4867922">,</span>&nbsp;<span class="ident" id="4867924">mtype</span>&nbsp;<span class="op" id="4867930">*</span><span class="ident" id="4867931">methodType</span><span class="op" id="4867941">,</span>&nbsp;<span class="ident" id="4867943">req</span>&nbsp;<span class="op" id="4867947">*</span><span class="ident" id="4867948">Request</span><span class="op" id="4867955">,</span>&nbsp;<span class="ident" id="4867957">keepReading</span>&nbsp;<span class="builtintype" id="4867969">bool</span><span class="op" id="4867973">,</span>&nbsp;<span class="ident" id="4867975">err</span>&nbsp;<span class="builtintype" id="4867979">error</span><span class="op" id="4867984">)</span>&nbsp;<span class="op" id="4867986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4867989">//&nbsp;Grab&nbsp;the&nbsp;request&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868018">req</span>&nbsp;<span class="op" id="4868022">=</span>&nbsp;<span class="ident" id="4868024">server</span><span class="op" id="4868030">.</span><span class="ident" id="4868031">getRequest</span><span class="op" id="4868041">(</span><span class="op" id="4868042">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868045">err</span>&nbsp;<span class="op" id="4868049">=</span>&nbsp;<span class="ident" id="4868051">codec</span><span class="op" id="4868056">.</span><span class="ident" id="4868057">ReadRequestHeader</span><span class="op" id="4868074">(</span><span class="ident" id="4868075">req</span><span class="op" id="4868078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868081">if</span>&nbsp;<span class="ident" id="4868084">err</span>&nbsp;<span class="op" id="4868088">!=</span>&nbsp;<span class="ident" id="4868091">nil</span>&nbsp;<span class="op" id="4868095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868099">req</span>&nbsp;<span class="op" id="4868103">=</span>&nbsp;<span class="ident" id="4868105">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868111">if</span>&nbsp;<span class="ident" id="4868114">err</span>&nbsp;<span class="op" id="4868118">==</span>&nbsp;<span class="ident" id="4868121">io</span><span class="op" id="4868123">.</span><span class="ident" id="4868124">EOF</span>&nbsp;<span class="op" id="4868128">||</span>&nbsp;<span class="ident" id="4868131">err</span>&nbsp;<span class="op" id="4868135">==</span>&nbsp;<span class="ident" id="4868138">io</span><span class="op" id="4868140">.</span><span class="ident" id="4868141">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="4868158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868163">return</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4868172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868176">err</span>&nbsp;<span class="op" id="4868180">=</span>&nbsp;<span class="ident" id="4868182">errors</span><span class="op" id="4868188">.</span><span class="ident" id="4868189">New</span><span class="op" id="4868192">(</span><span class="string" id="4868193">&#34;rpc:&nbsp;server&nbsp;cannot&nbsp;decode&nbsp;request:&nbsp;&#34;</span>&nbsp;<span class="op" id="4868231">+</span>&nbsp;<span class="ident" id="4868233">err</span><span class="op" id="4868236">.</span><span class="ident" id="4868237">Error</span><span class="op" id="4868242">(</span><span class="op" id="4868243">)</span><span class="op" id="4868244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868248">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4868256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4868260">//&nbsp;We&nbsp;read&nbsp;the&nbsp;header&nbsp;successfully.&nbsp;&nbsp;If&nbsp;we&nbsp;see&nbsp;an&nbsp;error&nbsp;now,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4868322">//&nbsp;we&nbsp;can&nbsp;still&nbsp;recover&nbsp;and&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868380">keepReading</span>&nbsp;<span class="op" id="4868392">=</span>&nbsp;<span class="builtintype" id="4868394">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868401">dot</span>&nbsp;<span class="op" id="4868405">:=</span>&nbsp;<span class="ident" id="4868408">strings</span><span class="op" id="4868415">.</span><span class="ident" id="4868416">LastIndex</span><span class="op" id="4868425">(</span><span class="ident" id="4868426">req</span><span class="op" id="4868429">.</span><span class="ident" id="4868430">ServiceMethod</span><span class="op" id="4868443">,</span>&nbsp;<span class="string" id="4868445">&#34;.&#34;</span><span class="op" id="4868448">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868451">if</span>&nbsp;<span class="ident" id="4868454">dot</span>&nbsp;<span class="op" id="4868458">&lt;</span>&nbsp;<span class="num" id="4868460">0</span>&nbsp;<span class="op" id="4868462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868466">err</span>&nbsp;<span class="op" id="4868470">=</span>&nbsp;<span class="ident" id="4868472">errors</span><span class="op" id="4868478">.</span><span class="ident" id="4868479">New</span><span class="op" id="4868482">(</span><span class="string" id="4868483">&#34;rpc:&nbsp;service/method&nbsp;request&nbsp;ill-formed:&nbsp;&#34;</span>&nbsp;<span class="op" id="4868526">+</span>&nbsp;<span class="ident" id="4868528">req</span><span class="op" id="4868531">.</span><span class="ident" id="4868532">ServiceMethod</span><span class="op" id="4868545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868549">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4868557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868560">serviceName</span>&nbsp;<span class="op" id="4868572">:=</span>&nbsp;<span class="ident" id="4868575">req</span><span class="op" id="4868578">.</span><span class="ident" id="4868579">ServiceMethod</span><span class="op" id="4868592">[</span><span class="op" id="4868593">:</span><span class="ident" id="4868594">dot</span><span class="op" id="4868597">]</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868600">methodName</span>&nbsp;<span class="op" id="4868611">:=</span>&nbsp;<span class="ident" id="4868614">req</span><span class="op" id="4868617">.</span><span class="ident" id="4868618">ServiceMethod</span><span class="op" id="4868631">[</span><span class="ident" id="4868632">dot</span><span class="op" id="4868635">+</span><span class="num" id="4868636">1</span><span class="op" id="4868637">:</span><span class="op" id="4868638">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4868642">//&nbsp;Look&nbsp;up&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868667">server</span><span class="op" id="4868673">.</span><span class="ident" id="4868674">mu</span><span class="op" id="4868676">.</span><span class="ident" id="4868677">RLock</span><span class="op" id="4868682">(</span><span class="op" id="4868683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868686">service</span>&nbsp;<span class="op" id="4868694">=</span>&nbsp;<span class="ident" id="4868696">server</span><span class="op" id="4868702">.</span><span class="ident" id="4868703">serviceMap</span><span class="op" id="4868713">[</span><span class="ident" id="4868714">serviceName</span><span class="op" id="4868725">]</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868728">server</span><span class="op" id="4868734">.</span><span class="ident" id="4868735">mu</span><span class="op" id="4868737">.</span><span class="ident" id="4868738">RUnlock</span><span class="op" id="4868745">(</span><span class="op" id="4868746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868749">if</span>&nbsp;<span class="ident" id="4868752">service</span>&nbsp;<span class="op" id="4868760">==</span>&nbsp;<span class="ident" id="4868763">nil</span>&nbsp;<span class="op" id="4868767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868771">err</span>&nbsp;<span class="op" id="4868775">=</span>&nbsp;<span class="ident" id="4868777">errors</span><span class="op" id="4868783">.</span><span class="ident" id="4868784">New</span><span class="op" id="4868787">(</span><span class="string" id="4868788">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;service&nbsp;&#34;</span>&nbsp;<span class="op" id="4868815">+</span>&nbsp;<span class="ident" id="4868817">req</span><span class="op" id="4868820">.</span><span class="ident" id="4868821">ServiceMethod</span><span class="op" id="4868834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868838">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4868846">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868849">mtype</span>&nbsp;<span class="op" id="4868855">=</span>&nbsp;<span class="ident" id="4868857">service</span><span class="op" id="4868864">.</span><span class="ident" id="4868865">method</span><span class="op" id="4868871">[</span><span class="ident" id="4868872">methodName</span><span class="op" id="4868882">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868885">if</span>&nbsp;<span class="ident" id="4868888">mtype</span>&nbsp;<span class="op" id="4868894">==</span>&nbsp;<span class="ident" id="4868897">nil</span>&nbsp;<span class="op" id="4868901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4868905">err</span>&nbsp;<span class="op" id="4868909">=</span>&nbsp;<span class="ident" id="4868911">errors</span><span class="op" id="4868917">.</span><span class="ident" id="4868918">New</span><span class="op" id="4868921">(</span><span class="string" id="4868922">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;method&nbsp;&#34;</span>&nbsp;<span class="op" id="4868948">+</span>&nbsp;<span class="ident" id="4868950">req</span><span class="op" id="4868953">.</span><span class="ident" id="4868954">ServiceMethod</span><span class="op" id="4868967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4868970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4868973">return</span><br>
<span class="lineno">610</span><span class="op" id="4868980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4868983">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4869049">//&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.&nbsp;&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="4869119">//&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno">615</span><span class="keyword" id="4869152">func</span>&nbsp;<span class="op" id="4869157">(</span><span class="ident" id="4869158">server</span>&nbsp;<span class="op" id="4869165">*</span><span class="ident" id="4869166">Server</span><span class="op" id="4869172">)</span>&nbsp;<span class="ident" id="4869174">Accept</span><span class="op" id="4869180">(</span><span class="ident" id="4869181">lis</span>&nbsp;<span class="ident" id="4869185">net</span><span class="op" id="4869188">.</span><span class="ident" id="4869189">Listener</span><span class="op" id="4869197">)</span>&nbsp;<span class="op" id="4869199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4869202">for</span>&nbsp;<span class="op" id="4869206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4869210">conn</span><span class="op" id="4869214">,</span>&nbsp;<span class="ident" id="4869216">err</span>&nbsp;<span class="op" id="4869220">:=</span>&nbsp;<span class="ident" id="4869223">lis</span><span class="op" id="4869226">.</span><span class="ident" id="4869227">Accept</span><span class="op" id="4869233">(</span><span class="op" id="4869234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4869238">if</span>&nbsp;<span class="ident" id="4869241">err</span>&nbsp;<span class="op" id="4869245">!=</span>&nbsp;<span class="ident" id="4869248">nil</span>&nbsp;<span class="op" id="4869252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4869257">log</span><span class="op" id="4869260">.</span><span class="ident" id="4869261">Fatal</span><span class="op" id="4869266">(</span><span class="string" id="4869267">&#34;rpc.Serve:&nbsp;accept:&#34;</span><span class="op" id="4869287">,</span>&nbsp;<span class="ident" id="4869289">err</span><span class="op" id="4869292">.</span><span class="ident" id="4869293">Error</span><span class="op" id="4869298">(</span><span class="op" id="4869299">)</span><span class="op" id="4869300">)</span>&nbsp;<span class="comment" id="4869302">//&nbsp;TODO(r):&nbsp;exit?</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4869322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4869326">go</span>&nbsp;<span class="ident" id="4869329">server</span><span class="op" id="4869335">.</span><span class="ident" id="4869336">ServeConn</span><span class="op" id="4869345">(</span><span class="ident" id="4869346">conn</span><span class="op" id="4869350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4869353">}</span><br>
<span class="lineno"></span><span class="op" id="4869355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span><span class="comment" id="4869358">//&nbsp;Register&nbsp;publishes&nbsp;the&nbsp;receiver&#39;s&nbsp;methods&nbsp;in&nbsp;the&nbsp;DefaultServer.</span><br>
<span class="lineno"></span><span class="keyword" id="4869425">func</span>&nbsp;<span class="ident" id="4869430">Register</span><span class="op" id="4869438">(</span><span class="ident" id="4869439">rcvr</span>&nbsp;<span class="keyword" id="4869444">interface</span><span class="op" id="4869453">{</span><span class="op" id="4869454">}</span><span class="op" id="4869455">)</span>&nbsp;<span class="builtintype" id="4869457">error</span>&nbsp;<span class="op" id="4869463">{</span>&nbsp;<span class="keyword" id="4869465">return</span>&nbsp;<span class="ident" id="4869472">DefaultServer</span><span class="op" id="4869485">.</span><span class="ident" id="4869486">Register</span><span class="op" id="4869494">(</span><span class="ident" id="4869495">rcvr</span><span class="op" id="4869499">)</span>&nbsp;<span class="op" id="4869501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4869504">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="4869577">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno">630</span><span class="keyword" id="4869621">func</span>&nbsp;<span class="ident" id="4869626">RegisterName</span><span class="op" id="4869638">(</span><span class="ident" id="4869639">name</span>&nbsp;<span class="builtintype" id="4869644">string</span><span class="op" id="4869650">,</span>&nbsp;<span class="ident" id="4869652">rcvr</span>&nbsp;<span class="keyword" id="4869657">interface</span><span class="op" id="4869666">{</span><span class="op" id="4869667">}</span><span class="op" id="4869668">)</span>&nbsp;<span class="builtintype" id="4869670">error</span>&nbsp;<span class="op" id="4869676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4869679">return</span>&nbsp;<span class="ident" id="4869686">DefaultServer</span><span class="op" id="4869699">.</span><span class="ident" id="4869700">RegisterName</span><span class="op" id="4869712">(</span><span class="ident" id="4869713">name</span><span class="op" id="4869717">,</span>&nbsp;<span class="ident" id="4869719">rcvr</span><span class="op" id="4869723">)</span><br>
<span class="lineno"></span><span class="op" id="4869725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4869728">//&nbsp;A&nbsp;ServerCodec&nbsp;implements&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and&nbsp;writing&nbsp;of</span><br>
<span class="lineno">635</span><span class="comment" id="4869795">//&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment" id="4869851">//&nbsp;The&nbsp;server&nbsp;calls&nbsp;ReadRequestHeader&nbsp;and&nbsp;ReadRequestBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment" id="4869918">//&nbsp;to&nbsp;read&nbsp;requests&nbsp;from&nbsp;the&nbsp;connection,&nbsp;and&nbsp;it&nbsp;calls&nbsp;WriteResponse&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4869989">//&nbsp;write&nbsp;a&nbsp;response&nbsp;back.&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4870062">//&nbsp;connection.&nbsp;ReadRequestBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">640</span><span class="comment" id="4870118">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;request&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="4870189">type</span>&nbsp;<span class="ident" id="4870194">ServerCodec</span>&nbsp;<span class="keyword" id="4870206">interface</span>&nbsp;<span class="op" id="4870216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4870219">ReadRequestHeader</span><span class="op" id="4870236">(</span><span class="op" id="4870237">*</span><span class="ident" id="4870238">Request</span><span class="op" id="4870245">)</span>&nbsp;<span class="builtintype" id="4870247">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4870254">ReadRequestBody</span><span class="op" id="4870269">(</span><span class="keyword" id="4870270">interface</span><span class="op" id="4870279">{</span><span class="op" id="4870280">}</span><span class="op" id="4870281">)</span>&nbsp;<span class="builtintype" id="4870283">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4870290">//&nbsp;WriteResponse&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4870364">WriteResponse</span><span class="op" id="4870377">(</span><span class="op" id="4870378">*</span><span class="ident" id="4870379">Response</span><span class="op" id="4870387">,</span>&nbsp;<span class="keyword" id="4870389">interface</span><span class="op" id="4870398">{</span><span class="op" id="4870399">}</span><span class="op" id="4870400">)</span>&nbsp;<span class="builtintype" id="4870402">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4870410">Close</span><span class="op" id="4870415">(</span><span class="op" id="4870416">)</span>&nbsp;<span class="builtintype" id="4870418">error</span><br>
<span class="lineno"></span><span class="op" id="4870424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="4870427">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;DefaultServer&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4870487">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="4870558">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="4870619">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4870682">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">655</span><span class="keyword" id="4870741">func</span>&nbsp;<span class="ident" id="4870746">ServeConn</span><span class="op" id="4870755">(</span><span class="ident" id="4870756">conn</span>&nbsp;<span class="ident" id="4870761">io</span><span class="op" id="4870763">.</span><span class="ident" id="4870764">ReadWriteCloser</span><span class="op" id="4870779">)</span>&nbsp;<span class="op" id="4870781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4870784">DefaultServer</span><span class="op" id="4870797">.</span><span class="ident" id="4870798">ServeConn</span><span class="op" id="4870807">(</span><span class="ident" id="4870808">conn</span><span class="op" id="4870812">)</span><br>
<span class="lineno"></span><span class="op" id="4870814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4870817">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno">660</span><span class="comment" id="4870881">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="4870922">func</span>&nbsp;<span class="ident" id="4870927">ServeCodec</span><span class="op" id="4870937">(</span><span class="ident" id="4870938">codec</span>&nbsp;<span class="ident" id="4870944">ServerCodec</span><span class="op" id="4870955">)</span>&nbsp;<span class="op" id="4870957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4870960">DefaultServer</span><span class="op" id="4870973">.</span><span class="ident" id="4870974">ServeCodec</span><span class="op" id="4870984">(</span><span class="ident" id="4870985">codec</span><span class="op" id="4870990">)</span><br>
<span class="lineno"></span><span class="op" id="4870992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="4870995">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="4871073">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="4871121">func</span>&nbsp;<span class="ident" id="4871126">ServeRequest</span><span class="op" id="4871138">(</span><span class="ident" id="4871139">codec</span>&nbsp;<span class="ident" id="4871145">ServerCodec</span><span class="op" id="4871156">)</span>&nbsp;<span class="builtintype" id="4871158">error</span>&nbsp;<span class="op" id="4871164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871167">return</span>&nbsp;<span class="ident" id="4871174">DefaultServer</span><span class="op" id="4871187">.</span><span class="ident" id="4871188">ServeRequest</span><span class="op" id="4871200">(</span><span class="ident" id="4871201">codec</span><span class="op" id="4871206">)</span><br>
<span class="lineno"></span><span class="op" id="4871208">}</span><br>
<span class="lineno">670</span><br>
<span class="lineno"></span><span class="comment" id="4871211">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4871277">//&nbsp;to&nbsp;DefaultServer&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4871327">//&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="4871396">func</span>&nbsp;<span class="ident" id="4871401">Accept</span><span class="op" id="4871407">(</span><span class="ident" id="4871408">lis</span>&nbsp;<span class="ident" id="4871412">net</span><span class="op" id="4871415">.</span><span class="ident" id="4871416">Listener</span><span class="op" id="4871424">)</span>&nbsp;<span class="op" id="4871426">{</span>&nbsp;<span class="ident" id="4871428">DefaultServer</span><span class="op" id="4871441">.</span><span class="ident" id="4871442">Accept</span><span class="op" id="4871448">(</span><span class="ident" id="4871449">lis</span><span class="op" id="4871452">)</span>&nbsp;<span class="op" id="4871454">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="comment" id="4871457">//&nbsp;Can&nbsp;connect&nbsp;to&nbsp;RPC&nbsp;service&nbsp;using&nbsp;HTTP&nbsp;CONNECT&nbsp;to&nbsp;rpcPath.</span><br>
<span class="lineno"></span><span class="keyword" id="4871518">var</span>&nbsp;<span class="ident" id="4871522">connected</span>&nbsp;<span class="op" id="4871532">=</span>&nbsp;<span class="string" id="4871534">&#34;200&nbsp;Connected&nbsp;to&nbsp;Go&nbsp;RPC&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4871561">//&nbsp;ServeHTTP&nbsp;implements&nbsp;an&nbsp;http.Handler&nbsp;that&nbsp;answers&nbsp;RPC&nbsp;requests.</span><br>
<span class="lineno">680</span><span class="keyword" id="4871628">func</span>&nbsp;<span class="op" id="4871633">(</span><span class="ident" id="4871634">server</span>&nbsp;<span class="op" id="4871641">*</span><span class="ident" id="4871642">Server</span><span class="op" id="4871648">)</span>&nbsp;<span class="ident" id="4871650">ServeHTTP</span><span class="op" id="4871659">(</span><span class="ident" id="4871660">w</span>&nbsp;<span class="ident" id="4871662">http</span><span class="op" id="4871666">.</span><span class="ident" id="4871667">ResponseWriter</span><span class="op" id="4871681">,</span>&nbsp;<span class="ident" id="4871683">req</span>&nbsp;<span class="op" id="4871687">*</span><span class="ident" id="4871688">http</span><span class="op" id="4871692">.</span><span class="ident" id="4871693">Request</span><span class="op" id="4871700">)</span>&nbsp;<span class="op" id="4871702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871705">if</span>&nbsp;<span class="ident" id="4871708">req</span><span class="op" id="4871711">.</span><span class="ident" id="4871712">Method</span>&nbsp;<span class="op" id="4871719">!=</span>&nbsp;<span class="string" id="4871722">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="4871732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4871736">w</span><span class="op" id="4871737">.</span><span class="ident" id="4871738">Header</span><span class="op" id="4871744">(</span><span class="op" id="4871745">)</span><span class="op" id="4871746">.</span><span class="ident" id="4871747">Set</span><span class="op" id="4871750">(</span><span class="string" id="4871751">&#34;Content-Type&#34;</span><span class="op" id="4871765">,</span>&nbsp;<span class="string" id="4871767">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="4871794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4871798">w</span><span class="op" id="4871799">.</span><span class="ident" id="4871800">WriteHeader</span><span class="op" id="4871811">(</span><span class="ident" id="4871812">http</span><span class="op" id="4871816">.</span><span class="ident" id="4871817">StatusMethodNotAllowed</span><span class="op" id="4871839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4871843">io</span><span class="op" id="4871845">.</span><span class="ident" id="4871846">WriteString</span><span class="op" id="4871857">(</span><span class="ident" id="4871858">w</span><span class="op" id="4871859">,</span>&nbsp;<span class="string" id="4871861">&#34;405&nbsp;must&nbsp;CONNECT\n&#34;</span><span class="op" id="4871881">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871885">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4871893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4871896">conn</span><span class="op" id="4871900">,</span>&nbsp;<span class="ident" id="4871902">_</span><span class="op" id="4871903">,</span>&nbsp;<span class="ident" id="4871905">err</span>&nbsp;<span class="op" id="4871909">:=</span>&nbsp;<span class="ident" id="4871912">w</span><span class="op" id="4871913">.</span><span class="op" id="4871914">(</span><span class="ident" id="4871915">http</span><span class="op" id="4871919">.</span><span class="ident" id="4871920">Hijacker</span><span class="op" id="4871928">)</span><span class="op" id="4871929">.</span><span class="ident" id="4871930">Hijack</span><span class="op" id="4871936">(</span><span class="op" id="4871937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4871940">if</span>&nbsp;<span class="ident" id="4871943">err</span>&nbsp;<span class="op" id="4871947">!=</span>&nbsp;<span class="ident" id="4871950">nil</span>&nbsp;<span class="op" id="4871954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4871958">log</span><span class="op" id="4871961">.</span><span class="ident" id="4871962">Print</span><span class="op" id="4871967">(</span><span class="string" id="4871968">&#34;rpc&nbsp;hijacking&nbsp;&#34;</span><span class="op" id="4871984">,</span>&nbsp;<span class="ident" id="4871986">req</span><span class="op" id="4871989">.</span><span class="ident" id="4871990">RemoteAddr</span><span class="op" id="4872000">,</span>&nbsp;<span class="string" id="4872002">&#34;:&nbsp;&#34;</span><span class="op" id="4872006">,</span>&nbsp;<span class="ident" id="4872008">err</span><span class="op" id="4872011">.</span><span class="ident" id="4872012">Error</span><span class="op" id="4872017">(</span><span class="op" id="4872018">)</span><span class="op" id="4872019">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4872023">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4872031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872034">io</span><span class="op" id="4872036">.</span><span class="ident" id="4872037">WriteString</span><span class="op" id="4872048">(</span><span class="ident" id="4872049">conn</span><span class="op" id="4872053">,</span>&nbsp;<span class="string" id="4872055">&#34;HTTP/1.0&nbsp;&#34;</span><span class="op" id="4872066">+</span><span class="ident" id="4872067">connected</span><span class="op" id="4872076">+</span><span class="string" id="4872077">&#34;\n\n&#34;</span><span class="op" id="4872083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872086">server</span><span class="op" id="4872092">.</span><span class="ident" id="4872093">ServeConn</span><span class="op" id="4872102">(</span><span class="ident" id="4872103">conn</span><span class="op" id="4872107">)</span><br>
<span class="lineno"></span><span class="op" id="4872109">}</span><br>
<span class="lineno">695</span><br>
<span class="lineno"></span><span class="comment" id="4872112">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;on&nbsp;rpcPath,</span><br>
<span class="lineno"></span><span class="comment" id="4872181">//&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;debugPath.</span><br>
<span class="lineno"></span><span class="comment" id="4872222">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="4872300">func</span>&nbsp;<span class="op" id="4872305">(</span><span class="ident" id="4872306">server</span>&nbsp;<span class="op" id="4872313">*</span><span class="ident" id="4872314">Server</span><span class="op" id="4872320">)</span>&nbsp;<span class="ident" id="4872322">HandleHTTP</span><span class="op" id="4872332">(</span><span class="ident" id="4872333">rpcPath</span><span class="op" id="4872340">,</span>&nbsp;<span class="ident" id="4872342">debugPath</span>&nbsp;<span class="builtintype" id="4872352">string</span><span class="op" id="4872358">)</span>&nbsp;<span class="op" id="4872360">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872363">http</span><span class="op" id="4872367">.</span><span class="ident" id="4872368">Handle</span><span class="op" id="4872374">(</span><span class="ident" id="4872375">rpcPath</span><span class="op" id="4872382">,</span>&nbsp;<span class="ident" id="4872384">server</span><span class="op" id="4872390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872393">http</span><span class="op" id="4872397">.</span><span class="ident" id="4872398">Handle</span><span class="op" id="4872404">(</span><span class="ident" id="4872405">debugPath</span><span class="op" id="4872414">,</span>&nbsp;<span class="ident" id="4872416">debugHTTP</span><span class="op" id="4872425">{</span><span class="ident" id="4872426">server</span><span class="op" id="4872432">}</span><span class="op" id="4872433">)</span><br>
<span class="lineno"></span><span class="op" id="4872435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4872438">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;to&nbsp;DefaultServer</span><br>
<span class="lineno">705</span><span class="comment" id="4872512">//&nbsp;on&nbsp;DefaultRPCPath&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;DefaultDebugPath.</span><br>
<span class="lineno"></span><span class="comment" id="4872578">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="4872656">func</span>&nbsp;<span class="ident" id="4872661">HandleHTTP</span><span class="op" id="4872671">(</span><span class="op" id="4872672">)</span>&nbsp;<span class="op" id="4872674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4872677">DefaultServer</span><span class="op" id="4872690">.</span><span class="ident" id="4872691">HandleHTTP</span><span class="op" id="4872701">(</span><span class="ident" id="4872702">DefaultRPCPath</span><span class="op" id="4872716">,</span>&nbsp;<span class="ident" id="4872718">DefaultDebugPath</span><span class="op" id="4872734">)</span><br>
<span class="lineno"></span><span class="op" id="4872736">}</span>
</div>
</body>
</html>
