<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">regexp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;regexp/syntax&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&#34;One-pass&#34;&nbsp;regexp&nbsp;execution.</span><br>
<span class="lineno">15</span><span class="comment">//&nbsp;Some&nbsp;regexps&nbsp;can&nbsp;be&nbsp;analyzed&nbsp;to&nbsp;determine&nbsp;that&nbsp;they&nbsp;never&nbsp;need</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;backtracking:&nbsp;they&nbsp;are&nbsp;guaranteed&nbsp;to&nbsp;run&nbsp;in&nbsp;one&nbsp;pass&nbsp;over&nbsp;the&nbsp;string</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;without&nbsp;bothering&nbsp;to&nbsp;save&nbsp;all&nbsp;the&nbsp;usual&nbsp;NFA&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Detect&nbsp;those&nbsp;and&nbsp;execute&nbsp;them&nbsp;more&nbsp;quickly.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment">//&nbsp;A&nbsp;onePassProg&nbsp;is&nbsp;a&nbsp;compiled&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Prog&nbsp;except&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;onePassInst.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">onePassProg</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Inst</span>&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">onePassInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Start</span>&nbsp;&nbsp;<span class="builtintype">int</span>&nbsp;<span class="comment">//&nbsp;index&nbsp;of&nbsp;start&nbsp;instruction</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NumCap</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="comment">//&nbsp;number&nbsp;of&nbsp;InstCapture&nbsp;insts&nbsp;in&nbsp;re</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;onePassInst&nbsp;is&nbsp;a&nbsp;single&nbsp;instruction&nbsp;in&nbsp;a&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Inst&nbsp;except&nbsp;for&nbsp;the&nbsp;new&nbsp;&#39;Next&#39;&nbsp;field.</span><br>
<span class="lineno">30</span><span class="keyword">type</span>&nbsp;<span class="ident">onePassInst</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">syntax</span><span class="op">.</span><span class="ident">Inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Next</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment">//&nbsp;OnePassPrefix&nbsp;returns&nbsp;a&nbsp;literal&nbsp;string&nbsp;that&nbsp;all&nbsp;matches&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;regexp&nbsp;must&nbsp;start&nbsp;with.&nbsp;&nbsp;Complete&nbsp;is&nbsp;true&nbsp;if&nbsp;the&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;is&nbsp;the&nbsp;entire&nbsp;match.&nbsp;Pc&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;last&nbsp;rune&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;in&nbsp;the&nbsp;string.&nbsp;The&nbsp;OnePassPrefix&nbsp;skips&nbsp;over&nbsp;the&nbsp;mandatory</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;EmptyBeginText</span><br>
<span class="lineno">40</span><span class="keyword">func</span>&nbsp;<span class="ident">onePassPrefix</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">Prog</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">prefix</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">complete</span>&nbsp;<span class="builtintype">bool</span><span class="op">,</span>&nbsp;<span class="ident">pc</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">p</span><span class="op">.</span><span class="ident">Start</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstEmptyWidth</span>&nbsp;<span class="op">||</span>&nbsp;<span class="op">(</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">EmptyOp</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">Arg</span><span class="op">)</span><span class="op">)</span><span class="op">&amp;</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">EmptyBeginText</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstMatch</span><span class="op">,</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">Start</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pc</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstNop</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pc</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Avoid&nbsp;allocation&nbsp;of&nbsp;buffer&nbsp;if&nbsp;prefix&nbsp;is&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">iop</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRune</span>&nbsp;<span class="op">||</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">Rune</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstMatch</span><span class="op">,</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">Start</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Have&nbsp;prefix;&nbsp;gather&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">buf</span>&nbsp;<span class="ident">bytes</span><span class="op">.</span><span class="ident">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">iop</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRune</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">Rune</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">Flags</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">Arg</span><span class="op">)</span><span class="op">&amp;</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">FoldCase</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span><span class="op">.</span><span class="ident">WriteRune</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">Rune</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pc</span><span class="op">,</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">Out</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">i</span><span class="op">.</span><span class="ident">Out</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">buf</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstEmptyWidth</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">(</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">EmptyOp</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">Arg</span><span class="op">)</span><span class="op">)</span><span class="op">&amp;</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">EmptyBeginText</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">pc</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment">//&nbsp;OnePassNext&nbsp;selects&nbsp;the&nbsp;next&nbsp;actionable&nbsp;state&nbsp;of&nbsp;the&nbsp;prog,&nbsp;based&nbsp;on&nbsp;the&nbsp;input&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;i.Op&nbsp;==&nbsp;InstAlt&nbsp;or&nbsp;InstAltMatch,&nbsp;and&nbsp;from&nbsp;the&nbsp;one-pass&nbsp;machine.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;One&nbsp;of&nbsp;the&nbsp;alternates&nbsp;may&nbsp;ultimately&nbsp;lead&nbsp;without&nbsp;input&nbsp;to&nbsp;end&nbsp;of&nbsp;line.&nbsp;If&nbsp;the&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;is&nbsp;InstAltMatch&nbsp;the&nbsp;path&nbsp;to&nbsp;the&nbsp;InstMatch&nbsp;is&nbsp;in&nbsp;i.Out,&nbsp;the&nbsp;normal&nbsp;node&nbsp;in&nbsp;i.Next.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">onePassNext</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">onePassInst</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="builtintype">rune</span><span class="op">)</span>&nbsp;<span class="builtintype">uint32</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">next</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">MatchRunePos</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">next</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">Next</span><span class="op">[</span><span class="ident">next</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAltMatch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword">func</span>&nbsp;<span class="ident">iop</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">Inst</span><span class="op">)</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstOp</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">i</span><span class="op">.</span><span class="ident">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRune1</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRuneAny</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRuneAnyNotNL</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRune</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">op</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Sparse&nbsp;Array&nbsp;implementation&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;queueOnePass.</span><br>
<span class="lineno">90</span><span class="keyword">type</span>&nbsp;<span class="ident">queueOnePass</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sparse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dense</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span><span class="op">,</span>&nbsp;<span class="ident">nextIndex</span>&nbsp;<span class="builtintype">uint32</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">q</span>&nbsp;<span class="op">*</span><span class="ident">queueOnePass</span><span class="op">)</span>&nbsp;<span class="ident">empty</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">nextIndex</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">size</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">q</span>&nbsp;<span class="op">*</span><span class="ident">queueOnePass</span><span class="op">)</span>&nbsp;<span class="ident">next</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">dense</span><span class="op">[</span><span class="ident">q</span><span class="op">.</span><span class="ident">nextIndex</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">.</span><span class="ident">nextIndex</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">q</span>&nbsp;<span class="op">*</span><span class="ident">queueOnePass</span><span class="op">)</span>&nbsp;<span class="ident">clear</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">.</span><span class="ident">size</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">.</span><span class="ident">nextIndex</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">q</span>&nbsp;<span class="op">*</span><span class="ident">queueOnePass</span><span class="op">)</span>&nbsp;<span class="ident">reset</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">.</span><span class="ident">nextIndex</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">q</span>&nbsp;<span class="op">*</span><span class="ident">queueOnePass</span><span class="op">)</span>&nbsp;<span class="ident">contains</span><span class="op">(</span><span class="ident">u</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">u</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">q</span><span class="op">.</span><span class="ident">sparse</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">sparse</span><span class="op">[</span><span class="ident">u</span><span class="op">]</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">size</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">dense</span><span class="op">[</span><span class="ident">q</span><span class="op">.</span><span class="ident">sparse</span><span class="op">[</span><span class="ident">u</span><span class="op">]</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">u</span><br>
<span class="lineno">120</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">q</span>&nbsp;<span class="op">*</span><span class="ident">queueOnePass</span><span class="op">)</span>&nbsp;<span class="ident">insert</span><span class="op">(</span><span class="ident">u</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">q</span><span class="op">.</span><span class="ident">contains</span><span class="op">(</span><span class="ident">u</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">.</span><span class="ident">insertNew</span><span class="op">(</span><span class="ident">u</span><span class="op">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">q</span>&nbsp;<span class="op">*</span><span class="ident">queueOnePass</span><span class="op">)</span>&nbsp;<span class="ident">insertNew</span><span class="op">(</span><span class="ident">u</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">u</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">q</span><span class="op">.</span><span class="ident">sparse</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">.</span><span class="ident">sparse</span><span class="op">[</span><span class="ident">u</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">.</span><span class="ident">dense</span><span class="op">[</span><span class="ident">q</span><span class="op">.</span><span class="ident">size</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">u</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">.</span><span class="ident">size</span><span class="op">++</span><br>
<span class="lineno">135</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">newQueue</span><span class="op">(</span><span class="ident">size</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">q</span>&nbsp;<span class="op">*</span><span class="ident">queueOnePass</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">queueOnePass</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sparse</span><span class="op">:</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">,</span>&nbsp;<span class="ident">size</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dense</span><span class="op">:</span>&nbsp;&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">,</span>&nbsp;<span class="ident">size</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;mergeRuneSets&nbsp;merges&nbsp;two&nbsp;non-intersecting&nbsp;runesets,&nbsp;and&nbsp;returns&nbsp;the&nbsp;merged&nbsp;result,</span><br>
<span class="lineno">145</span><span class="comment">//&nbsp;and&nbsp;a&nbsp;NextIp&nbsp;array.&nbsp;The&nbsp;idea&nbsp;is&nbsp;that&nbsp;if&nbsp;a&nbsp;rune&nbsp;matches&nbsp;the&nbsp;OnePassRunes&nbsp;at&nbsp;index</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;i,&nbsp;NextIp[i/2]&nbsp;is&nbsp;the&nbsp;target.&nbsp;If&nbsp;the&nbsp;input&nbsp;sets&nbsp;intersect,&nbsp;an&nbsp;empty&nbsp;runeset&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;NextIp&nbsp;array&nbsp;with&nbsp;the&nbsp;single&nbsp;element&nbsp;mergeFailed&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;code&nbsp;assumes&nbsp;that&nbsp;both&nbsp;inputs&nbsp;contain&nbsp;ordered&nbsp;and&nbsp;non-intersecting&nbsp;rune&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="ident">mergeFailed</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="num">0xffffffff</span><span class="op">)</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">noRune</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">noNext</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">{</span><span class="ident">mergeFailed</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">mergeRuneSets</span><span class="op">(</span><span class="ident">leftRunes</span><span class="op">,</span>&nbsp;<span class="ident">rightRunes</span>&nbsp;<span class="op">*</span><span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">,</span>&nbsp;<span class="ident">leftPC</span><span class="op">,</span>&nbsp;<span class="ident">rightPC</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">,</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">leftLen</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="op">*</span><span class="ident">leftRunes</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rightLen</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="op">*</span><span class="ident">rightRunes</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">leftLen</span><span class="op">&amp;</span><span class="num">0x1</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">rightLen</span><span class="op">&amp;</span><span class="num">0x1</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;mergeRuneSets&nbsp;odd&nbsp;length&nbsp;[]rune&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lx</span><span class="op">,</span>&nbsp;<span class="ident">rx</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">merged</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">next</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">merged</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ix</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">-</span><span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">extend</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">newLow</span>&nbsp;<span class="op">*</span><span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">newArray</span>&nbsp;<span class="op">*</span><span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">,</span>&nbsp;<span class="ident">pc</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ix</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">newArray</span><span class="op">)</span><span class="op">[</span><span class="op">*</span><span class="ident">newLow</span><span class="op">]</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">merged</span><span class="op">[</span><span class="ident">ix</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">merged</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">merged</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">newArray</span><span class="op">)</span><span class="op">[</span><span class="op">*</span><span class="ident">newLow</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">newArray</span><span class="op">)</span><span class="op">[</span><span class="op">*</span><span class="ident">newLow</span><span class="op">+</span><span class="num">1</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">newLow</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="num">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ix</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="num">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">next</span><span class="op">,</span>&nbsp;<span class="ident">pc</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">lx</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">leftLen</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">rx</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">rightLen</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">rx</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">rightLen</span><span class="op">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">extend</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">lx</span><span class="op">,</span>&nbsp;<span class="ident">leftRunes</span><span class="op">,</span>&nbsp;<span class="ident">leftPC</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">lx</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">leftLen</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">extend</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">rx</span><span class="op">,</span>&nbsp;<span class="ident">rightRunes</span><span class="op">,</span>&nbsp;<span class="ident">rightPC</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">rightRunes</span><span class="op">)</span><span class="op">[</span><span class="ident">rx</span><span class="op">]</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">leftRunes</span><span class="op">)</span><span class="op">[</span><span class="ident">lx</span><span class="op">]</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">extend</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">rx</span><span class="op">,</span>&nbsp;<span class="ident">rightRunes</span><span class="op">,</span>&nbsp;<span class="ident">rightPC</span><span class="op">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">extend</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">lx</span><span class="op">,</span>&nbsp;<span class="ident">leftRunes</span><span class="op">,</span>&nbsp;<span class="ident">leftPC</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">noRune</span><span class="op">,</span>&nbsp;<span class="ident">noNext</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">merged</span><span class="op">,</span>&nbsp;<span class="ident">next</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="comment">//&nbsp;cleanupOnePass&nbsp;drops&nbsp;working&nbsp;memory,&nbsp;and&nbsp;restores&nbsp;certain&nbsp;shortcut&nbsp;instructions.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">cleanupOnePass</span><span class="op">(</span><span class="ident">prog</span>&nbsp;<span class="op">*</span><span class="ident">onePassProg</span><span class="op">,</span>&nbsp;<span class="ident">original</span>&nbsp;<span class="op">*</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">Prog</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">ix</span><span class="op">,</span>&nbsp;<span class="ident">instOriginal</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">original</span><span class="op">.</span><span class="ident">Inst</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">instOriginal</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAlt</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAltMatch</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRune</span><span class="op">:</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstCapture</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstEmptyWidth</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstNop</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstMatch</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstFail</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prog</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">ix</span><span class="op">]</span><span class="op">.</span><span class="ident">Next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRune1</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRuneAny</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRuneAnyNotNL</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prog</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">ix</span><span class="op">]</span><span class="op">.</span><span class="ident">Next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prog</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">ix</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">onePassInst</span><span class="op">{</span><span class="ident">Inst</span><span class="op">:</span>&nbsp;<span class="ident">instOriginal</span><span class="op">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;onePassCopy&nbsp;creates&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog,&nbsp;as&nbsp;we&#39;ll&nbsp;be&nbsp;modifying&nbsp;it</span><br>
<span class="lineno">220</span><span class="keyword">func</span>&nbsp;<span class="ident">onePassCopy</span><span class="op">(</span><span class="ident">prog</span>&nbsp;<span class="op">*</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">Prog</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">onePassProg</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">onePassProg</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Start</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">prog</span><span class="op">.</span><span class="ident">Start</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NumCap</span><span class="op">:</span>&nbsp;<span class="ident">prog</span><span class="op">.</span><span class="ident">NumCap</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">inst</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">prog</span><span class="op">.</span><span class="ident">Inst</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">,</span>&nbsp;<span class="ident">onePassInst</span><span class="op">{</span><span class="ident">Inst</span><span class="op">:</span>&nbsp;<span class="ident">inst</span><span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;rewrites&nbsp;one&nbsp;or&nbsp;more&nbsp;common&nbsp;Prog&nbsp;constructs&nbsp;that&nbsp;enable&nbsp;some&nbsp;otherwise</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;non-onepass&nbsp;Progs&nbsp;to&nbsp;be&nbsp;onepass.&nbsp;A:BD&nbsp;(for&nbsp;example)&nbsp;means&nbsp;an&nbsp;InstAlt&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;ip&nbsp;A,&nbsp;that&nbsp;points&nbsp;to&nbsp;ips&nbsp;B&nbsp;&amp;&nbsp;C.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:CD</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">pc</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAlt</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAltMatch</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;A:Bx&nbsp;+&nbsp;B:Ay</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p_A_Other</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span><span class="op">.</span><span class="ident">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p_A_Alt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span><span class="op">.</span><span class="ident">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;target&nbsp;is&nbsp;another&nbsp;Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instAlt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="op">*</span><span class="ident">p_A_Alt</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="op">(</span><span class="ident">instAlt</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAlt</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">instAlt</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAltMatch</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p_A_Alt</span><span class="op">,</span>&nbsp;<span class="ident">p_A_Other</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">p_A_Other</span><span class="op">,</span>&nbsp;<span class="ident">p_A_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instAlt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="op">*</span><span class="ident">p_A_Alt</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="op">(</span><span class="ident">instAlt</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAlt</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">instAlt</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAltMatch</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instOther</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="op">*</span><span class="ident">p_A_Other</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Analyzing&nbsp;both&nbsp;legs&nbsp;pointing&nbsp;to&nbsp;Alts&nbsp;is&nbsp;for&nbsp;another&nbsp;day</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">instOther</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAlt</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">instOther</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAltMatch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;too&nbsp;complicated</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;simple&nbsp;empty&nbsp;transition&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p_B_Alt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="op">*</span><span class="ident">p_A_Alt</span><span class="op">]</span><span class="op">.</span><span class="ident">Out</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p_B_Other</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="op">*</span><span class="ident">p_A_Alt</span><span class="op">]</span><span class="op">.</span><span class="ident">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">patch</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">instAlt</span><span class="op">.</span><span class="ident">Out</span>&nbsp;<span class="op">==</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">pc</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">patch</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">instAlt</span><span class="op">.</span><span class="ident">Arg</span>&nbsp;<span class="op">==</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">pc</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">patch</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p_B_Alt</span><span class="op">,</span>&nbsp;<span class="ident">p_B_Other</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">p_B_Other</span><span class="op">,</span>&nbsp;<span class="ident">p_B_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">patch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">p_B_Alt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">*</span><span class="ident">p_A_Other</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;empty&nbsp;transition&nbsp;to&nbsp;common&nbsp;target</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">*</span><span class="ident">p_A_Other</span>&nbsp;<span class="op">==</span>&nbsp;<span class="op">*</span><span class="ident">p_B_Alt</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">p_A_Alt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">*</span><span class="ident">p_B_Other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">p</span><br>
<span class="lineno">280</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;runeSlice&nbsp;exists&nbsp;to&nbsp;permit&nbsp;sorting&nbsp;the&nbsp;case-folded&nbsp;rune&nbsp;sets.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">runeSlice</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="ident">runeSlice</span><span class="op">)</span>&nbsp;<span class="ident">Len</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="ident">runeSlice</span><span class="op">)</span>&nbsp;<span class="ident">Less</span><span class="op">(</span><span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">p</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">p</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="ident">runeSlice</span><span class="op">)</span>&nbsp;<span class="ident">Swap</span><span class="op">(</span><span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">{</span>&nbsp;<span class="ident">p</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">p</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Sort&nbsp;is&nbsp;a&nbsp;convenience&nbsp;method.</span><br>
<span class="lineno">290</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="ident">runeSlice</span><span class="op">)</span>&nbsp;<span class="ident">Sort</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sort</span><span class="op">.</span><span class="ident">Sort</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">anyRuneNotNL</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">{</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="string">&#39;\n&#39;</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="string">&#39;\n&#39;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="ident">unicode</span><span class="op">.</span><span class="ident">MaxRune</span><span class="op">}</span><br>
<span class="lineno">295</span><span class="keyword">var</span>&nbsp;<span class="ident">anyRune</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">{</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">unicode</span><span class="op">.</span><span class="ident">MaxRune</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;makeOnePass&nbsp;creates&nbsp;a&nbsp;onepass&nbsp;Prog,&nbsp;if&nbsp;possible.&nbsp;It&nbsp;is&nbsp;possible&nbsp;if&nbsp;at&nbsp;any&nbsp;alt,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;match&nbsp;engine&nbsp;can&nbsp;always&nbsp;tell&nbsp;which&nbsp;branch&nbsp;to&nbsp;take.&nbsp;The&nbsp;routine&nbsp;may&nbsp;modify</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;p&nbsp;if&nbsp;it&nbsp;is&nbsp;turned&nbsp;into&nbsp;a&nbsp;onepass&nbsp;Prog.&nbsp;If&nbsp;it&nbsp;isn&#39;t&nbsp;possible&nbsp;for&nbsp;this&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno">300</span><span class="comment">//&nbsp;onepass&nbsp;Prog,&nbsp;the&nbsp;Prog&nbsp;notOnePass&nbsp;is&nbsp;returned.&nbsp;makeOnePass&nbsp;is&nbsp;recursive</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;to&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;Prog.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">makeOnePass</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">onePassProg</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">onePassProg</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;the&nbsp;machine&nbsp;is&nbsp;very&nbsp;long,&nbsp;it&#39;s&nbsp;not&nbsp;worth&nbsp;the&nbsp;time&nbsp;to&nbsp;check&nbsp;if&nbsp;we&nbsp;can&nbsp;use&nbsp;one&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">)</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">1000</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instQueue</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">newQueue</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">visitQueue</span>&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">newQueue</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">build</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="builtintype">uint32</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">queueOnePass</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">check</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="builtintype">uint32</span><span class="op">,</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="builtintype">uint32</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onePassRunes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">build</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">pc</span>&nbsp;<span class="builtintype">uint32</span><span class="op">,</span>&nbsp;<span class="ident">q</span>&nbsp;<span class="op">*</span><span class="ident">queueOnePass</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">contains</span><span class="op">(</span><span class="ident">pc</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAlt</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAltMatch</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">.</span><span class="ident">insert</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">build</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">,</span>&nbsp;<span class="ident">q</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">.</span><span class="ident">insert</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Arg</span><span class="op">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstMatch</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstFail</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">.</span><span class="ident">insert</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;check&nbsp;that&nbsp;paths&nbsp;from&nbsp;Alt&nbsp;instructions&nbsp;are&nbsp;unambiguous,&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;program&nbsp;as&nbsp;a&nbsp;onepass&nbsp;program</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">check</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">pc</span>&nbsp;<span class="builtintype">uint32</span><span class="op">,</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="builtintype">uint32</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">ok</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">visitQueue</span><span class="op">.</span><span class="ident">contains</span><span class="op">(</span><span class="ident">pc</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">visitQueue</span><span class="op">.</span><span class="ident">insert</span><span class="op">(</span><span class="ident">pc</span><span class="op">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAlt</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAltMatch</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">check</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">check</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Arg</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;check&nbsp;no-input&nbsp;paths&nbsp;to&nbsp;InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">matchOut</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">[</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">]</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">matchArg</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">[</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Arg</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">matchOut</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">matchArg</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Match&nbsp;on&nbsp;empty&nbsp;goes&nbsp;in&nbsp;inst.Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">matchArg</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Arg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Arg</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">matchOut</span><span class="op">,</span>&nbsp;<span class="ident">matchArg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">matchArg</span><span class="op">,</span>&nbsp;<span class="ident">matchOut</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">matchOut</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAltMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;build&nbsp;a&nbsp;dispatch&nbsp;operator&nbsp;from&nbsp;the&nbsp;two&nbsp;legs&nbsp;of&nbsp;the&nbsp;alt.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mergeRuneSets</span><span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">&amp;</span><span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Arg</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Arg</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">mergeFailed</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstCapture</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstNop</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">check</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">m</span><span class="op">[</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;pass&nbsp;matching&nbsp;runes&nbsp;back&nbsp;through&nbsp;these&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">]</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="num">2</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstEmptyWidth</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">check</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">m</span><span class="op">[</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">]</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="num">2</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstMatch</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstFail</span><span class="op">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRune</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">check</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Rune</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">{</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runes</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Rune</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">Flags</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Arg</span><span class="op">)</span><span class="op">&amp;</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">FoldCase</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r0</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Rune</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">runes</span><span class="op">,</span>&nbsp;<span class="ident">r0</span><span class="op">,</span>&nbsp;<span class="ident">r0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">r1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">unicode</span><span class="op">.</span><span class="ident">SimpleFold</span><span class="op">(</span><span class="ident">r0</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">r1</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">r0</span><span class="op">;</span>&nbsp;<span class="ident">r1</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">unicode</span><span class="op">.</span><span class="ident">SimpleFold</span><span class="op">(</span><span class="ident">r1</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">runes</span><span class="op">,</span>&nbsp;<span class="ident">r1</span><span class="op">,</span>&nbsp;<span class="ident">r1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sort</span><span class="op">.</span><span class="ident">Sort</span><span class="op">(</span><span class="ident">runeSlice</span><span class="op">(</span><span class="ident">runes</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">runes</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Rune</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">runes</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="num">2</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRune</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRune1</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">check</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runes</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;expand&nbsp;case-folded&nbsp;runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">Flags</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Arg</span><span class="op">)</span><span class="op">&amp;</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">FoldCase</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r0</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Rune</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">runes</span><span class="op">,</span>&nbsp;<span class="ident">r0</span><span class="op">,</span>&nbsp;<span class="ident">r0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">r1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">unicode</span><span class="op">.</span><span class="ident">SimpleFold</span><span class="op">(</span><span class="ident">r0</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">r1</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">r0</span><span class="op">;</span>&nbsp;<span class="ident">r1</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">unicode</span><span class="op">.</span><span class="ident">SimpleFold</span><span class="op">(</span><span class="ident">r1</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">runes</span><span class="op">,</span>&nbsp;<span class="ident">r1</span><span class="op">,</span>&nbsp;<span class="ident">r1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sort</span><span class="op">.</span><span class="ident">Sort</span><span class="op">(</span><span class="ident">runeSlice</span><span class="op">(</span><span class="ident">runes</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">runes</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Rune</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Rune</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="num">2</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRuneAny</span><span class="op">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">check</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="ident">anyRune</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">{</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRuneAnyNotNL</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">check</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="ident">anyRuneNotNL</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="num">2</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Next</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instQueue</span><span class="op">.</span><span class="ident">clear</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instQueue</span><span class="op">.</span><span class="ident">insert</span><span class="op">(</span><span class="builtintype">uint32</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">Start</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="builtintype">uint32</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">!</span><span class="ident">instQueue</span><span class="op">.</span><span class="ident">empty</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pc</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">instQueue</span><span class="op">.</span><span class="ident">next</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">pc</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">visitQueue</span><span class="op">.</span><span class="ident">clear</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">check</span><span class="op">(</span><span class="builtintype">uint32</span><span class="op">(</span><span class="ident">pc</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAlt</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAltMatch</span><span class="op">:</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instQueue</span><span class="op">.</span><span class="ident">insert</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instQueue</span><span class="op">.</span><span class="ident">insert</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Arg</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstCapture</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstEmptyWidth</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstNop</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instQueue</span><span class="op">.</span><span class="ident">insert</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstMatch</span><span class="op">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstFail</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRune</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRune1</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRuneAny</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstRuneAnyNotNL</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">p</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">notOnePass</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">Rune</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">onePassRunes</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">p</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;walk&nbsp;visits&nbsp;each&nbsp;Inst&nbsp;in&nbsp;the&nbsp;prog&nbsp;once,&nbsp;and&nbsp;applies&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;function(ip,&nbsp;next),&nbsp;in&nbsp;pre-order.</span><br>
<span class="lineno">495</span><span class="keyword">func</span>&nbsp;<span class="ident">walk</span><span class="op">(</span><span class="ident">prog</span>&nbsp;<span class="op">*</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">Prog</span><span class="op">,</span>&nbsp;<span class="ident">funcs</span>&nbsp;<span class="op">...</span><span class="keyword">func</span><span class="op">(</span><span class="ident">ip</span><span class="op">,</span>&nbsp;<span class="ident">next</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">walk1</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="builtintype">uint32</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">progQueue</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">newQueue</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">prog</span><span class="op">.</span><span class="ident">Inst</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">walk1</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">ip</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">progQueue</span><span class="op">.</span><span class="ident">contains</span><span class="op">(</span><span class="ident">ip</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">progQueue</span><span class="op">.</span><span class="ident">insert</span><span class="op">(</span><span class="ident">ip</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inst</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">prog</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">ip</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAlt</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAltMatch</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">funcs</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">(</span><span class="ident">ip</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">(</span><span class="ident">ip</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Arg</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">walk1</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">walk1</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Arg</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">funcs</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">(</span><span class="ident">ip</span><span class="op">,</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">walk1</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">walk1</span><span class="op">(</span><span class="builtintype">uint32</span><span class="op">(</span><span class="ident">prog</span><span class="op">.</span><span class="ident">Start</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">520</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;find&nbsp;returns&nbsp;the&nbsp;Insts&nbsp;that&nbsp;match&nbsp;the&nbsp;argument&nbsp;predicate&nbsp;function</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">find</span><span class="op">(</span><span class="ident">prog</span>&nbsp;<span class="op">*</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">Prog</span><span class="op">,</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">*</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">Prog</span><span class="op">,</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">matches</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">matches</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">ip</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">prog</span><span class="op">.</span><span class="ident">Inst</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">f</span><span class="op">(</span><span class="ident">prog</span><span class="op">,</span>&nbsp;<span class="ident">ip</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">matches</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">matches</span><span class="op">,</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">ip</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">notOnePass</span>&nbsp;<span class="op">*</span><span class="ident">onePassProg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;compileOnePass&nbsp;returns&nbsp;a&nbsp;new&nbsp;*syntax.Prog&nbsp;suitable&nbsp;for&nbsp;onePass&nbsp;execution&nbsp;if&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;can&nbsp;be&nbsp;recharacterized&nbsp;as&nbsp;a&nbsp;one-pass&nbsp;regexp&nbsp;program,&nbsp;or&nbsp;syntax.notOnePass&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Prog&nbsp;cannot&nbsp;be&nbsp;converted.&nbsp;For&nbsp;a&nbsp;one&nbsp;pass&nbsp;prog,&nbsp;the&nbsp;fundamental&nbsp;condition&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;be&nbsp;true&nbsp;is:&nbsp;at&nbsp;any&nbsp;InstAlt,&nbsp;there&nbsp;must&nbsp;be&nbsp;no&nbsp;ambiguity&nbsp;about&nbsp;what&nbsp;branch&nbsp;to&nbsp;&nbsp;take.</span><br>
<span class="lineno">540</span><span class="keyword">func</span>&nbsp;<span class="ident">compileOnePass</span><span class="op">(</span><span class="ident">prog</span>&nbsp;<span class="op">*</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">Prog</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">onePassProg</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">prog</span><span class="op">.</span><span class="ident">Start</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;onepass&nbsp;regexp&nbsp;is&nbsp;anchored</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">prog</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">prog</span><span class="op">.</span><span class="ident">Start</span><span class="op">]</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstEmptyWidth</span>&nbsp;<span class="op">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">syntax</span><span class="op">.</span><span class="ident">EmptyOp</span><span class="op">(</span><span class="ident">prog</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">prog</span><span class="op">.</span><span class="ident">Start</span><span class="op">]</span><span class="op">.</span><span class="ident">Arg</span><span class="op">)</span><span class="op">&amp;</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">EmptyBeginText</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">EmptyBeginText</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;every&nbsp;instruction&nbsp;leading&nbsp;to&nbsp;InstMatch&nbsp;must&nbsp;be&nbsp;EmptyEndText</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">inst</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">prog</span><span class="op">.</span><span class="ident">Inst</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">opOut</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">prog</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Out</span><span class="op">]</span><span class="op">.</span><span class="ident">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">inst</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">opOut</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstMatch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAlt</span><span class="op">,</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstAltMatch</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">opOut</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstMatch</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">prog</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Arg</span><span class="op">]</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstMatch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">notOnePass</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstEmptyWidth</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">opOut</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">InstMatch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">EmptyOp</span><span class="op">(</span><span class="ident">inst</span><span class="op">.</span><span class="ident">Arg</span><span class="op">)</span><span class="op">&amp;</span><span class="ident">syntax</span><span class="op">.</span><span class="ident">EmptyEndText</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syntax</span><span class="op">.</span><span class="ident">EmptyEndText</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Creates&nbsp;a&nbsp;slightly&nbsp;optimized&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;that&nbsp;cleans&nbsp;up&nbsp;some&nbsp;Prog&nbsp;idioms&nbsp;that&nbsp;block&nbsp;valid&nbsp;onepass&nbsp;programs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">onePassCopy</span><span class="op">(</span><span class="ident">prog</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;checkAmbiguity&nbsp;on&nbsp;InstAlts,&nbsp;build&nbsp;onepass&nbsp;Prog&nbsp;if&nbsp;possible</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">makeOnePass</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">p</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">notOnePass</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cleanupOnePass</span><span class="op">(</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">prog</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">p</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
