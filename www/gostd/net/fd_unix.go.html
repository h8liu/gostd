<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4048457">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4048512">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4048566">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4048617">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4048687">package</span>&nbsp;<span class="ident" id="4048695">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4048700">import</span>&nbsp;<span class="op" id="4048707">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4048710">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4048716">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4048722">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4048733">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4048748">&#34;syscall&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4048759">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4048766">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4048769">//&nbsp;Network&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="4048797">type</span>&nbsp;<span class="ident" id="4048802">netFD</span>&nbsp;<span class="keyword" id="4048808">struct</span>&nbsp;<span class="op" id="4048815">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4048818">//&nbsp;locking/lifetime&nbsp;of&nbsp;sysfd&nbsp;+&nbsp;serialize&nbsp;access&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4048893">fdmu</span>&nbsp;<span class="ident" id="4048898">fdMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4048908">//&nbsp;immutable&nbsp;until&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4048934">sysfd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4048946">int</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4048951">family</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4048963">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4048968">sotype</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4048980">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4048985">isConnected</span>&nbsp;<span class="builtintype" id="4048997">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4049003">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4049015">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4049023">laddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4049035">Addr</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4049041">raddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4049053">Addr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4049060">//&nbsp;wait&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4049076">pd</span>&nbsp;<span class="ident" id="4049079">pollDesc</span><br>
<span class="lineno"></span><span class="op" id="4049088">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="4049091">func</span>&nbsp;<span class="ident" id="4049096">sysInit</span><span class="op" id="4049103">(</span><span class="op" id="4049104">)</span>&nbsp;<span class="op" id="4049106">{</span><br>
<span class="lineno"></span><span class="op" id="4049108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4049111">func</span>&nbsp;<span class="ident" id="4049116">dial</span><span class="op" id="4049120">(</span><span class="ident" id="4049121">network</span>&nbsp;<span class="builtintype" id="4049129">string</span><span class="op" id="4049135">,</span>&nbsp;<span class="ident" id="4049137">ra</span>&nbsp;<span class="ident" id="4049140">Addr</span><span class="op" id="4049144">,</span>&nbsp;<span class="ident" id="4049146">dialer</span>&nbsp;<span class="keyword" id="4049153">func</span><span class="op" id="4049157">(</span><span class="ident" id="4049158">time</span><span class="op" id="4049162">.</span><span class="ident" id="4049163">Time</span><span class="op" id="4049167">)</span>&nbsp;<span class="op" id="4049169">(</span><span class="ident" id="4049170">Conn</span><span class="op" id="4049174">,</span>&nbsp;<span class="builtintype" id="4049176">error</span><span class="op" id="4049181">)</span><span class="op" id="4049182">,</span>&nbsp;<span class="ident" id="4049184">deadline</span>&nbsp;<span class="ident" id="4049193">time</span><span class="op" id="4049197">.</span><span class="ident" id="4049198">Time</span><span class="op" id="4049202">)</span>&nbsp;<span class="op" id="4049204">(</span><span class="ident" id="4049205">Conn</span><span class="op" id="4049209">,</span>&nbsp;<span class="builtintype" id="4049211">error</span><span class="op" id="4049216">)</span>&nbsp;<span class="op" id="4049218">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4049221">return</span>&nbsp;<span class="ident" id="4049228">dialer</span><span class="op" id="4049234">(</span><span class="ident" id="4049235">deadline</span><span class="op" id="4049243">)</span><br>
<span class="lineno"></span><span class="op" id="4049245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4049248">func</span>&nbsp;<span class="ident" id="4049253">newFD</span><span class="op" id="4049258">(</span><span class="ident" id="4049259">sysfd</span><span class="op" id="4049264">,</span>&nbsp;<span class="ident" id="4049266">family</span><span class="op" id="4049272">,</span>&nbsp;<span class="ident" id="4049274">sotype</span>&nbsp;<span class="builtintype" id="4049281">int</span><span class="op" id="4049284">,</span>&nbsp;<span class="ident" id="4049286">net</span>&nbsp;<span class="builtintype" id="4049290">string</span><span class="op" id="4049296">)</span>&nbsp;<span class="op" id="4049298">(</span><span class="op" id="4049299">*</span><span class="ident" id="4049300">netFD</span><span class="op" id="4049305">,</span>&nbsp;<span class="builtintype" id="4049307">error</span><span class="op" id="4049312">)</span>&nbsp;<span class="op" id="4049314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4049317">return</span>&nbsp;<span class="op" id="4049324">&amp;</span><span class="ident" id="4049325">netFD</span><span class="op" id="4049330">{</span><span class="ident" id="4049331">sysfd</span><span class="op" id="4049336">:</span>&nbsp;<span class="ident" id="4049338">sysfd</span><span class="op" id="4049343">,</span>&nbsp;<span class="ident" id="4049345">family</span><span class="op" id="4049351">:</span>&nbsp;<span class="ident" id="4049353">family</span><span class="op" id="4049359">,</span>&nbsp;<span class="ident" id="4049361">sotype</span><span class="op" id="4049367">:</span>&nbsp;<span class="ident" id="4049369">sotype</span><span class="op" id="4049375">,</span>&nbsp;<span class="ident" id="4049377">net</span><span class="op" id="4049380">:</span>&nbsp;<span class="ident" id="4049382">net</span><span class="op" id="4049385">}</span><span class="op" id="4049386">,</span>&nbsp;<span class="ident" id="4049388">nil</span><br>
<span class="lineno">45</span><span class="op" id="4049392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4049395">func</span>&nbsp;<span class="op" id="4049400">(</span><span class="ident" id="4049401">fd</span>&nbsp;<span class="op" id="4049404">*</span><span class="ident" id="4049405">netFD</span><span class="op" id="4049410">)</span>&nbsp;<span class="ident" id="4049412">init</span><span class="op" id="4049416">(</span><span class="op" id="4049417">)</span>&nbsp;<span class="builtintype" id="4049419">error</span>&nbsp;<span class="op" id="4049425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4049428">if</span>&nbsp;<span class="ident" id="4049431">err</span>&nbsp;<span class="op" id="4049435">:=</span>&nbsp;<span class="ident" id="4049438">fd</span><span class="op" id="4049440">.</span><span class="ident" id="4049441">pd</span><span class="op" id="4049443">.</span><span class="ident" id="4049444">Init</span><span class="op" id="4049448">(</span><span class="ident" id="4049449">fd</span><span class="op" id="4049451">)</span><span class="op" id="4049452">;</span>&nbsp;<span class="ident" id="4049454">err</span>&nbsp;<span class="op" id="4049458">!=</span>&nbsp;<span class="ident" id="4049461">nil</span>&nbsp;<span class="op" id="4049465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4049469">return</span>&nbsp;<span class="ident" id="4049476">err</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4049481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4049484">return</span>&nbsp;<span class="ident" id="4049491">nil</span><br>
<span class="lineno"></span><span class="op" id="4049495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4049498">func</span>&nbsp;<span class="op" id="4049503">(</span><span class="ident" id="4049504">fd</span>&nbsp;<span class="op" id="4049507">*</span><span class="ident" id="4049508">netFD</span><span class="op" id="4049513">)</span>&nbsp;<span class="ident" id="4049515">setAddr</span><span class="op" id="4049522">(</span><span class="ident" id="4049523">laddr</span><span class="op" id="4049528">,</span>&nbsp;<span class="ident" id="4049530">raddr</span>&nbsp;<span class="ident" id="4049536">Addr</span><span class="op" id="4049540">)</span>&nbsp;<span class="op" id="4049542">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4049545">fd</span><span class="op" id="4049547">.</span><span class="ident" id="4049548">laddr</span>&nbsp;<span class="op" id="4049554">=</span>&nbsp;<span class="ident" id="4049556">laddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4049563">fd</span><span class="op" id="4049565">.</span><span class="ident" id="4049566">raddr</span>&nbsp;<span class="op" id="4049572">=</span>&nbsp;<span class="ident" id="4049574">raddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4049581">runtime</span><span class="op" id="4049588">.</span><span class="ident" id="4049589">SetFinalizer</span><span class="op" id="4049601">(</span><span class="ident" id="4049602">fd</span><span class="op" id="4049604">,</span>&nbsp;<span class="op" id="4049606">(</span><span class="op" id="4049607">*</span><span class="ident" id="4049608">netFD</span><span class="op" id="4049613">)</span><span class="op" id="4049614">.</span><span class="ident" id="4049615">Close</span><span class="op" id="4049620">)</span><br>
<span class="lineno"></span><span class="op" id="4049622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4049625">func</span>&nbsp;<span class="op" id="4049630">(</span><span class="ident" id="4049631">fd</span>&nbsp;<span class="op" id="4049634">*</span><span class="ident" id="4049635">netFD</span><span class="op" id="4049640">)</span>&nbsp;<span class="ident" id="4049642">name</span><span class="op" id="4049646">(</span><span class="op" id="4049647">)</span>&nbsp;<span class="builtintype" id="4049649">string</span>&nbsp;<span class="op" id="4049656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4049659">var</span>&nbsp;<span class="ident" id="4049663">ls</span><span class="op" id="4049665">,</span>&nbsp;<span class="ident" id="4049667">rs</span>&nbsp;<span class="builtintype" id="4049670">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4049678">if</span>&nbsp;<span class="ident" id="4049681">fd</span><span class="op" id="4049683">.</span><span class="ident" id="4049684">laddr</span>&nbsp;<span class="op" id="4049690">!=</span>&nbsp;<span class="ident" id="4049693">nil</span>&nbsp;<span class="op" id="4049697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4049701">ls</span>&nbsp;<span class="op" id="4049704">=</span>&nbsp;<span class="ident" id="4049706">fd</span><span class="op" id="4049708">.</span><span class="ident" id="4049709">laddr</span><span class="op" id="4049714">.</span><span class="ident" id="4049715">String</span><span class="op" id="4049721">(</span><span class="op" id="4049722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4049725">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4049728">if</span>&nbsp;<span class="ident" id="4049731">fd</span><span class="op" id="4049733">.</span><span class="ident" id="4049734">raddr</span>&nbsp;<span class="op" id="4049740">!=</span>&nbsp;<span class="ident" id="4049743">nil</span>&nbsp;<span class="op" id="4049747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4049751">rs</span>&nbsp;<span class="op" id="4049754">=</span>&nbsp;<span class="ident" id="4049756">fd</span><span class="op" id="4049758">.</span><span class="ident" id="4049759">raddr</span><span class="op" id="4049764">.</span><span class="ident" id="4049765">String</span><span class="op" id="4049771">(</span><span class="op" id="4049772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4049775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4049778">return</span>&nbsp;<span class="ident" id="4049785">fd</span><span class="op" id="4049787">.</span><span class="ident" id="4049788">net</span>&nbsp;<span class="op" id="4049792">+</span>&nbsp;<span class="string" id="4049794">&#34;:&#34;</span>&nbsp;<span class="op" id="4049798">+</span>&nbsp;<span class="ident" id="4049800">ls</span>&nbsp;<span class="op" id="4049803">+</span>&nbsp;<span class="string" id="4049805">&#34;-&gt;&#34;</span>&nbsp;<span class="op" id="4049810">+</span>&nbsp;<span class="ident" id="4049812">rs</span><br>
<span class="lineno"></span><span class="op" id="4049815">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="4049818">func</span>&nbsp;<span class="op" id="4049823">(</span><span class="ident" id="4049824">fd</span>&nbsp;<span class="op" id="4049827">*</span><span class="ident" id="4049828">netFD</span><span class="op" id="4049833">)</span>&nbsp;<span class="ident" id="4049835">connect</span><span class="op" id="4049842">(</span><span class="ident" id="4049843">la</span><span class="op" id="4049845">,</span>&nbsp;<span class="ident" id="4049847">ra</span>&nbsp;<span class="ident" id="4049850">syscall</span><span class="op" id="4049857">.</span><span class="ident" id="4049858">Sockaddr</span><span class="op" id="4049866">,</span>&nbsp;<span class="ident" id="4049868">deadline</span>&nbsp;<span class="ident" id="4049877">time</span><span class="op" id="4049881">.</span><span class="ident" id="4049882">Time</span><span class="op" id="4049886">)</span>&nbsp;<span class="builtintype" id="4049888">error</span>&nbsp;<span class="op" id="4049894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4049897">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;call&nbsp;fd.writeLock&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4049940">//&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;yet&nbsp;accessible&nbsp;to&nbsp;user,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4049986">//&nbsp;so&nbsp;no&nbsp;concurrent&nbsp;operations&nbsp;are&nbsp;possible.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050032">switch</span>&nbsp;<span class="ident" id="4050039">err</span>&nbsp;<span class="op" id="4050043">:=</span>&nbsp;<span class="ident" id="4050046">syscall</span><span class="op" id="4050053">.</span><span class="ident" id="4050054">Connect</span><span class="op" id="4050061">(</span><span class="ident" id="4050062">fd</span><span class="op" id="4050064">.</span><span class="ident" id="4050065">sysfd</span><span class="op" id="4050070">,</span>&nbsp;<span class="ident" id="4050072">ra</span><span class="op" id="4050074">)</span><span class="op" id="4050075">;</span>&nbsp;<span class="ident" id="4050077">err</span>&nbsp;<span class="op" id="4050081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050084">case</span>&nbsp;<span class="ident" id="4050089">syscall</span><span class="op" id="4050096">.</span><span class="ident" id="4050097">EINPROGRESS</span><span class="op" id="4050108">,</span>&nbsp;<span class="ident" id="4050110">syscall</span><span class="op" id="4050117">.</span><span class="ident" id="4050118">EALREADY</span><span class="op" id="4050126">,</span>&nbsp;<span class="ident" id="4050128">syscall</span><span class="op" id="4050135">.</span><span class="ident" id="4050136">EINTR</span><span class="op" id="4050141">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050144">case</span>&nbsp;<span class="ident" id="4050149">nil</span><span class="op" id="4050152">,</span>&nbsp;<span class="ident" id="4050154">syscall</span><span class="op" id="4050161">.</span><span class="ident" id="4050162">EISCONN</span><span class="op" id="4050169">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050173">if</span>&nbsp;<span class="op" id="4050176">!</span><span class="ident" id="4050177">deadline</span><span class="op" id="4050185">.</span><span class="ident" id="4050186">IsZero</span><span class="op" id="4050192">(</span><span class="op" id="4050193">)</span>&nbsp;<span class="op" id="4050195">&amp;&amp;</span>&nbsp;<span class="ident" id="4050198">deadline</span><span class="op" id="4050206">.</span><span class="ident" id="4050207">Before</span><span class="op" id="4050213">(</span><span class="ident" id="4050214">time</span><span class="op" id="4050218">.</span><span class="ident" id="4050219">Now</span><span class="op" id="4050222">(</span><span class="op" id="4050223">)</span><span class="op" id="4050224">)</span>&nbsp;<span class="op" id="4050226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050231">return</span>&nbsp;<span class="ident" id="4050238">errTimeout</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4050251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050255">if</span>&nbsp;<span class="ident" id="4050258">err</span>&nbsp;<span class="op" id="4050262">:=</span>&nbsp;<span class="ident" id="4050265">fd</span><span class="op" id="4050267">.</span><span class="ident" id="4050268">init</span><span class="op" id="4050272">(</span><span class="op" id="4050273">)</span><span class="op" id="4050274">;</span>&nbsp;<span class="ident" id="4050276">err</span>&nbsp;<span class="op" id="4050280">!=</span>&nbsp;<span class="ident" id="4050283">nil</span>&nbsp;<span class="op" id="4050287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050292">return</span>&nbsp;<span class="ident" id="4050299">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4050305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050309">return</span>&nbsp;<span class="ident" id="4050316">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050321">case</span>&nbsp;<span class="ident" id="4050326">syscall</span><span class="op" id="4050333">.</span><span class="ident" id="4050334">EINVAL</span><span class="op" id="4050340">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4050344">//&nbsp;On&nbsp;Solaris&nbsp;we&nbsp;can&nbsp;see&nbsp;EINVAL&nbsp;if&nbsp;the&nbsp;socket&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4050396">//&nbsp;already&nbsp;been&nbsp;accepted&nbsp;and&nbsp;closed&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4050449">//&nbsp;Treat&nbsp;this&nbsp;as&nbsp;a&nbsp;successful&nbsp;connection--writes&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4050503">//&nbsp;the&nbsp;socket&nbsp;will&nbsp;see&nbsp;EOF.&nbsp;&nbsp;For&nbsp;details&nbsp;and&nbsp;a&nbsp;test</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4050557">//&nbsp;case&nbsp;in&nbsp;C&nbsp;see&nbsp;http://golang.org/issue/6828.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050606">if</span>&nbsp;<span class="ident" id="4050609">runtime</span><span class="op" id="4050616">.</span><span class="ident" id="4050617">GOOS</span>&nbsp;<span class="op" id="4050622">==</span>&nbsp;<span class="string" id="4050625">&#34;solaris&#34;</span>&nbsp;<span class="op" id="4050635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050640">return</span>&nbsp;<span class="ident" id="4050647">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4050653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050657">fallthrough</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050670">default</span><span class="op" id="4050677">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050681">return</span>&nbsp;<span class="ident" id="4050688">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4050693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050696">if</span>&nbsp;<span class="ident" id="4050699">err</span>&nbsp;<span class="op" id="4050703">:=</span>&nbsp;<span class="ident" id="4050706">fd</span><span class="op" id="4050708">.</span><span class="ident" id="4050709">init</span><span class="op" id="4050713">(</span><span class="op" id="4050714">)</span><span class="op" id="4050715">;</span>&nbsp;<span class="ident" id="4050717">err</span>&nbsp;<span class="op" id="4050721">!=</span>&nbsp;<span class="ident" id="4050724">nil</span>&nbsp;<span class="op" id="4050728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050732">return</span>&nbsp;<span class="ident" id="4050739">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4050744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050747">if</span>&nbsp;<span class="op" id="4050750">!</span><span class="ident" id="4050751">deadline</span><span class="op" id="4050759">.</span><span class="ident" id="4050760">IsZero</span><span class="op" id="4050766">(</span><span class="op" id="4050767">)</span>&nbsp;<span class="op" id="4050769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4050773">fd</span><span class="op" id="4050775">.</span><span class="ident" id="4050776">setWriteDeadline</span><span class="op" id="4050792">(</span><span class="ident" id="4050793">deadline</span><span class="op" id="4050801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050805">defer</span>&nbsp;<span class="ident" id="4050811">fd</span><span class="op" id="4050813">.</span><span class="ident" id="4050814">setWriteDeadline</span><span class="op" id="4050830">(</span><span class="ident" id="4050831">noDeadline</span><span class="op" id="4050841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4050844">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050847">for</span>&nbsp;<span class="op" id="4050851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4050855">//&nbsp;Performing&nbsp;multiple&nbsp;connect&nbsp;system&nbsp;calls&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4050906">//&nbsp;non-blocking&nbsp;socket&nbsp;under&nbsp;Unix&nbsp;variants&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4050960">//&nbsp;necessarily&nbsp;result&nbsp;in&nbsp;earlier&nbsp;errors&nbsp;being</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4051008">//&nbsp;returned.&nbsp;Instead,&nbsp;once&nbsp;runtime-integrated&nbsp;network</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4051064">//&nbsp;poller&nbsp;tells&nbsp;us&nbsp;that&nbsp;the&nbsp;socket&nbsp;is&nbsp;ready,&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4051119">//&nbsp;SO_ERROR&nbsp;socket&nbsp;option&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4051172">//&nbsp;succeeded&nbsp;or&nbsp;failed.&nbsp;See&nbsp;issue&nbsp;7474&nbsp;for&nbsp;further</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4051225">//&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051239">if</span>&nbsp;<span class="ident" id="4051242">err</span>&nbsp;<span class="op" id="4051246">:=</span>&nbsp;<span class="ident" id="4051249">fd</span><span class="op" id="4051251">.</span><span class="ident" id="4051252">pd</span><span class="op" id="4051254">.</span><span class="ident" id="4051255">WaitWrite</span><span class="op" id="4051264">(</span><span class="op" id="4051265">)</span><span class="op" id="4051266">;</span>&nbsp;<span class="ident" id="4051268">err</span>&nbsp;<span class="op" id="4051272">!=</span>&nbsp;<span class="ident" id="4051275">nil</span>&nbsp;<span class="op" id="4051279">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051284">return</span>&nbsp;<span class="ident" id="4051291">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4051297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051301">nerr</span><span class="op" id="4051305">,</span>&nbsp;<span class="ident" id="4051307">err</span>&nbsp;<span class="op" id="4051311">:=</span>&nbsp;<span class="ident" id="4051314">syscall</span><span class="op" id="4051321">.</span><span class="ident" id="4051322">GetsockoptInt</span><span class="op" id="4051335">(</span><span class="ident" id="4051336">fd</span><span class="op" id="4051338">.</span><span class="ident" id="4051339">sysfd</span><span class="op" id="4051344">,</span>&nbsp;<span class="ident" id="4051346">syscall</span><span class="op" id="4051353">.</span><span class="ident" id="4051354">SOL_SOCKET</span><span class="op" id="4051364">,</span>&nbsp;<span class="ident" id="4051366">syscall</span><span class="op" id="4051373">.</span><span class="ident" id="4051374">SO_ERROR</span><span class="op" id="4051382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051386">if</span>&nbsp;<span class="ident" id="4051389">err</span>&nbsp;<span class="op" id="4051393">!=</span>&nbsp;<span class="ident" id="4051396">nil</span>&nbsp;<span class="op" id="4051400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051405">return</span>&nbsp;<span class="ident" id="4051412">err</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4051418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051422">switch</span>&nbsp;<span class="ident" id="4051429">err</span>&nbsp;<span class="op" id="4051433">:=</span>&nbsp;<span class="ident" id="4051436">syscall</span><span class="op" id="4051443">.</span><span class="ident" id="4051444">Errno</span><span class="op" id="4051449">(</span><span class="ident" id="4051450">nerr</span><span class="op" id="4051454">)</span><span class="op" id="4051455">;</span>&nbsp;<span class="ident" id="4051457">err</span>&nbsp;<span class="op" id="4051461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051465">case</span>&nbsp;<span class="ident" id="4051470">syscall</span><span class="op" id="4051477">.</span><span class="ident" id="4051478">EINPROGRESS</span><span class="op" id="4051489">,</span>&nbsp;<span class="ident" id="4051491">syscall</span><span class="op" id="4051498">.</span><span class="ident" id="4051499">EALREADY</span><span class="op" id="4051507">,</span>&nbsp;<span class="ident" id="4051509">syscall</span><span class="op" id="4051516">.</span><span class="ident" id="4051517">EINTR</span><span class="op" id="4051522">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051526">case</span>&nbsp;<span class="ident" id="4051531">syscall</span><span class="op" id="4051538">.</span><span class="ident" id="4051539">Errno</span><span class="op" id="4051544">(</span><span class="num" id="4051545">0</span><span class="op" id="4051546">)</span><span class="op" id="4051547">,</span>&nbsp;<span class="ident" id="4051549">syscall</span><span class="op" id="4051556">.</span><span class="ident" id="4051557">EISCONN</span><span class="op" id="4051564">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051569">return</span>&nbsp;<span class="ident" id="4051576">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051582">default</span><span class="op" id="4051589">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051594">return</span>&nbsp;<span class="ident" id="4051601">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4051607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4051610">}</span><br>
<span class="lineno"></span><span class="op" id="4051612">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="keyword" id="4051615">func</span>&nbsp;<span class="op" id="4051620">(</span><span class="ident" id="4051621">fd</span>&nbsp;<span class="op" id="4051624">*</span><span class="ident" id="4051625">netFD</span><span class="op" id="4051630">)</span>&nbsp;<span class="ident" id="4051632">destroy</span><span class="op" id="4051639">(</span><span class="op" id="4051640">)</span>&nbsp;<span class="op" id="4051642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4051645">//&nbsp;Poller&nbsp;may&nbsp;want&nbsp;to&nbsp;unregister&nbsp;fd&nbsp;in&nbsp;readiness&nbsp;notification&nbsp;mechanism,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4051719">//&nbsp;so&nbsp;this&nbsp;must&nbsp;be&nbsp;executed&nbsp;before&nbsp;closesocket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051768">fd</span><span class="op" id="4051770">.</span><span class="ident" id="4051771">pd</span><span class="op" id="4051773">.</span><span class="ident" id="4051774">Close</span><span class="op" id="4051779">(</span><span class="op" id="4051780">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051783">closesocket</span><span class="op" id="4051794">(</span><span class="ident" id="4051795">fd</span><span class="op" id="4051797">.</span><span class="ident" id="4051798">sysfd</span><span class="op" id="4051803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051806">fd</span><span class="op" id="4051808">.</span><span class="ident" id="4051809">sysfd</span>&nbsp;<span class="op" id="4051815">=</span>&nbsp;<span class="op" id="4051817">-</span><span class="num" id="4051818">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051821">runtime</span><span class="op" id="4051828">.</span><span class="ident" id="4051829">SetFinalizer</span><span class="op" id="4051841">(</span><span class="ident" id="4051842">fd</span><span class="op" id="4051844">,</span>&nbsp;<span class="ident" id="4051846">nil</span><span class="op" id="4051849">)</span><br>
<span class="lineno"></span><span class="op" id="4051851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="4051854">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd.</span><br>
<span class="lineno"></span><span class="comment" id="4051885">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4051931">func</span>&nbsp;<span class="op" id="4051936">(</span><span class="ident" id="4051937">fd</span>&nbsp;<span class="op" id="4051940">*</span><span class="ident" id="4051941">netFD</span><span class="op" id="4051946">)</span>&nbsp;<span class="ident" id="4051948">incref</span><span class="op" id="4051954">(</span><span class="op" id="4051955">)</span>&nbsp;<span class="builtintype" id="4051957">error</span>&nbsp;<span class="op" id="4051963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051966">if</span>&nbsp;<span class="op" id="4051969">!</span><span class="ident" id="4051970">fd</span><span class="op" id="4051972">.</span><span class="ident" id="4051973">fdmu</span><span class="op" id="4051977">.</span><span class="ident" id="4051978">Incref</span><span class="op" id="4051984">(</span><span class="op" id="4051985">)</span>&nbsp;<span class="op" id="4051987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051991">return</span>&nbsp;<span class="ident" id="4051998">errClosing</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052013">return</span>&nbsp;<span class="ident" id="4052020">nil</span><br>
<span class="lineno"></span><span class="op" id="4052024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4052027">//&nbsp;Remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD&nbsp;and&nbsp;close&nbsp;if&nbsp;we&#39;ve&nbsp;been&nbsp;asked&nbsp;to&nbsp;do&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="4052099">//&nbsp;(and&nbsp;there&nbsp;are&nbsp;no&nbsp;references&nbsp;left).</span><br>
<span class="lineno"></span><span class="keyword" id="4052138">func</span>&nbsp;<span class="op" id="4052143">(</span><span class="ident" id="4052144">fd</span>&nbsp;<span class="op" id="4052147">*</span><span class="ident" id="4052148">netFD</span><span class="op" id="4052153">)</span>&nbsp;<span class="ident" id="4052155">decref</span><span class="op" id="4052161">(</span><span class="op" id="4052162">)</span>&nbsp;<span class="op" id="4052164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052167">if</span>&nbsp;<span class="ident" id="4052170">fd</span><span class="op" id="4052172">.</span><span class="ident" id="4052173">fdmu</span><span class="op" id="4052177">.</span><span class="ident" id="4052178">Decref</span><span class="op" id="4052184">(</span><span class="op" id="4052185">)</span>&nbsp;<span class="op" id="4052187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052191">fd</span><span class="op" id="4052193">.</span><span class="ident" id="4052194">destroy</span><span class="op" id="4052201">(</span><span class="op" id="4052202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052205">}</span><br>
<span class="lineno">155</span><span class="op" id="4052207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4052210">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="4052262">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4052308">func</span>&nbsp;<span class="op" id="4052313">(</span><span class="ident" id="4052314">fd</span>&nbsp;<span class="op" id="4052317">*</span><span class="ident" id="4052318">netFD</span><span class="op" id="4052323">)</span>&nbsp;<span class="ident" id="4052325">readLock</span><span class="op" id="4052333">(</span><span class="op" id="4052334">)</span>&nbsp;<span class="builtintype" id="4052336">error</span>&nbsp;<span class="op" id="4052342">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052345">if</span>&nbsp;<span class="op" id="4052348">!</span><span class="ident" id="4052349">fd</span><span class="op" id="4052351">.</span><span class="ident" id="4052352">fdmu</span><span class="op" id="4052356">.</span><span class="ident" id="4052357">RWLock</span><span class="op" id="4052363">(</span><span class="builtintype" id="4052364">true</span><span class="op" id="4052368">)</span>&nbsp;<span class="op" id="4052370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052374">return</span>&nbsp;<span class="ident" id="4052381">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052396">return</span>&nbsp;<span class="ident" id="4052403">nil</span><br>
<span class="lineno"></span><span class="op" id="4052407">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="4052410">//&nbsp;Unlock&nbsp;for&nbsp;reading&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="4052467">func</span>&nbsp;<span class="op" id="4052472">(</span><span class="ident" id="4052473">fd</span>&nbsp;<span class="op" id="4052476">*</span><span class="ident" id="4052477">netFD</span><span class="op" id="4052482">)</span>&nbsp;<span class="ident" id="4052484">readUnlock</span><span class="op" id="4052494">(</span><span class="op" id="4052495">)</span>&nbsp;<span class="op" id="4052497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052500">if</span>&nbsp;<span class="ident" id="4052503">fd</span><span class="op" id="4052505">.</span><span class="ident" id="4052506">fdmu</span><span class="op" id="4052510">.</span><span class="ident" id="4052511">RWUnlock</span><span class="op" id="4052519">(</span><span class="builtintype" id="4052520">true</span><span class="op" id="4052524">)</span>&nbsp;<span class="op" id="4052526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052530">fd</span><span class="op" id="4052532">.</span><span class="ident" id="4052533">destroy</span><span class="op" id="4052540">(</span><span class="op" id="4052541">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052544">}</span><br>
<span class="lineno"></span><span class="op" id="4052546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4052549">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="4052601">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno">175</span><span class="keyword" id="4052647">func</span>&nbsp;<span class="op" id="4052652">(</span><span class="ident" id="4052653">fd</span>&nbsp;<span class="op" id="4052656">*</span><span class="ident" id="4052657">netFD</span><span class="op" id="4052662">)</span>&nbsp;<span class="ident" id="4052664">writeLock</span><span class="op" id="4052673">(</span><span class="op" id="4052674">)</span>&nbsp;<span class="builtintype" id="4052676">error</span>&nbsp;<span class="op" id="4052682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052685">if</span>&nbsp;<span class="op" id="4052688">!</span><span class="ident" id="4052689">fd</span><span class="op" id="4052691">.</span><span class="ident" id="4052692">fdmu</span><span class="op" id="4052696">.</span><span class="ident" id="4052697">RWLock</span><span class="op" id="4052703">(</span><span class="builtintype" id="4052704">false</span><span class="op" id="4052709">)</span>&nbsp;<span class="op" id="4052711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052715">return</span>&nbsp;<span class="ident" id="4052722">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052737">return</span>&nbsp;<span class="ident" id="4052744">nil</span><br>
<span class="lineno">180</span><span class="op" id="4052748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4052751">//&nbsp;Unlock&nbsp;for&nbsp;writing&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="4052808">func</span>&nbsp;<span class="op" id="4052813">(</span><span class="ident" id="4052814">fd</span>&nbsp;<span class="op" id="4052817">*</span><span class="ident" id="4052818">netFD</span><span class="op" id="4052823">)</span>&nbsp;<span class="ident" id="4052825">writeUnlock</span><span class="op" id="4052836">(</span><span class="op" id="4052837">)</span>&nbsp;<span class="op" id="4052839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052842">if</span>&nbsp;<span class="ident" id="4052845">fd</span><span class="op" id="4052847">.</span><span class="ident" id="4052848">fdmu</span><span class="op" id="4052852">.</span><span class="ident" id="4052853">RWUnlock</span><span class="op" id="4052861">(</span><span class="builtintype" id="4052862">false</span><span class="op" id="4052867">)</span>&nbsp;<span class="op" id="4052869">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052873">fd</span><span class="op" id="4052875">.</span><span class="ident" id="4052876">destroy</span><span class="op" id="4052883">(</span><span class="op" id="4052884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052887">}</span><br>
<span class="lineno"></span><span class="op" id="4052889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4052892">func</span>&nbsp;<span class="op" id="4052897">(</span><span class="ident" id="4052898">fd</span>&nbsp;<span class="op" id="4052901">*</span><span class="ident" id="4052902">netFD</span><span class="op" id="4052907">)</span>&nbsp;<span class="ident" id="4052909">Close</span><span class="op" id="4052914">(</span><span class="op" id="4052915">)</span>&nbsp;<span class="builtintype" id="4052917">error</span>&nbsp;<span class="op" id="4052923">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052926">fd</span><span class="op" id="4052928">.</span><span class="ident" id="4052929">pd</span><span class="op" id="4052931">.</span><span class="ident" id="4052932">Lock</span><span class="op" id="4052936">(</span><span class="op" id="4052937">)</span>&nbsp;<span class="comment" id="4052939">//&nbsp;needed&nbsp;for&nbsp;both&nbsp;fd.incref(true)&nbsp;and&nbsp;pollDesc.Evict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052994">if</span>&nbsp;<span class="op" id="4052997">!</span><span class="ident" id="4052998">fd</span><span class="op" id="4053000">.</span><span class="ident" id="4053001">fdmu</span><span class="op" id="4053005">.</span><span class="ident" id="4053006">IncrefAndClose</span><span class="op" id="4053020">(</span><span class="op" id="4053021">)</span>&nbsp;<span class="op" id="4053023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053027">fd</span><span class="op" id="4053029">.</span><span class="ident" id="4053030">pd</span><span class="op" id="4053032">.</span><span class="ident" id="4053033">Unlock</span><span class="op" id="4053039">(</span><span class="op" id="4053040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053044">return</span>&nbsp;<span class="ident" id="4053051">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4053063">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4053066">//&nbsp;Unblock&nbsp;any&nbsp;I/O.&nbsp;&nbsp;Once&nbsp;it&nbsp;all&nbsp;unblocks&nbsp;and&nbsp;returns,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4053122">//&nbsp;so&nbsp;that&nbsp;it&nbsp;cannot&nbsp;be&nbsp;referring&nbsp;to&nbsp;fd.sysfd&nbsp;anymore,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4053178">//&nbsp;the&nbsp;final&nbsp;decref&nbsp;will&nbsp;close&nbsp;fd.sysfd.&nbsp;&nbsp;This&nbsp;should&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4053240">//&nbsp;fairly&nbsp;quickly,&nbsp;since&nbsp;all&nbsp;the&nbsp;I/O&nbsp;is&nbsp;non-blocking,&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4053303">//&nbsp;attempts&nbsp;to&nbsp;block&nbsp;in&nbsp;the&nbsp;pollDesc&nbsp;will&nbsp;return&nbsp;errClosing.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053365">doWakeup</span>&nbsp;<span class="op" id="4053374">:=</span>&nbsp;<span class="ident" id="4053377">fd</span><span class="op" id="4053379">.</span><span class="ident" id="4053380">pd</span><span class="op" id="4053382">.</span><span class="ident" id="4053383">Evict</span><span class="op" id="4053388">(</span><span class="op" id="4053389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053392">fd</span><span class="op" id="4053394">.</span><span class="ident" id="4053395">pd</span><span class="op" id="4053397">.</span><span class="ident" id="4053398">Unlock</span><span class="op" id="4053404">(</span><span class="op" id="4053405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053408">fd</span><span class="op" id="4053410">.</span><span class="ident" id="4053411">decref</span><span class="op" id="4053417">(</span><span class="op" id="4053418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053421">if</span>&nbsp;<span class="ident" id="4053424">doWakeup</span>&nbsp;<span class="op" id="4053433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053437">fd</span><span class="op" id="4053439">.</span><span class="ident" id="4053440">pd</span><span class="op" id="4053442">.</span><span class="ident" id="4053443">Wakeup</span><span class="op" id="4053449">(</span><span class="op" id="4053450">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4053453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053456">return</span>&nbsp;<span class="ident" id="4053463">nil</span><br>
<span class="lineno"></span><span class="op" id="4053467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4053470">func</span>&nbsp;<span class="op" id="4053475">(</span><span class="ident" id="4053476">fd</span>&nbsp;<span class="op" id="4053479">*</span><span class="ident" id="4053480">netFD</span><span class="op" id="4053485">)</span>&nbsp;<span class="ident" id="4053487">shutdown</span><span class="op" id="4053495">(</span><span class="ident" id="4053496">how</span>&nbsp;<span class="builtintype" id="4053500">int</span><span class="op" id="4053503">)</span>&nbsp;<span class="builtintype" id="4053505">error</span>&nbsp;<span class="op" id="4053511">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053514">if</span>&nbsp;<span class="ident" id="4053517">err</span>&nbsp;<span class="op" id="4053521">:=</span>&nbsp;<span class="ident" id="4053524">fd</span><span class="op" id="4053526">.</span><span class="ident" id="4053527">incref</span><span class="op" id="4053533">(</span><span class="op" id="4053534">)</span><span class="op" id="4053535">;</span>&nbsp;<span class="ident" id="4053537">err</span>&nbsp;<span class="op" id="4053541">!=</span>&nbsp;<span class="ident" id="4053544">nil</span>&nbsp;<span class="op" id="4053548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053552">return</span>&nbsp;<span class="ident" id="4053559">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4053564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053567">defer</span>&nbsp;<span class="ident" id="4053573">fd</span><span class="op" id="4053575">.</span><span class="ident" id="4053576">decref</span><span class="op" id="4053582">(</span><span class="op" id="4053583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053586">err</span>&nbsp;<span class="op" id="4053590">:=</span>&nbsp;<span class="ident" id="4053593">syscall</span><span class="op" id="4053600">.</span><span class="ident" id="4053601">Shutdown</span><span class="op" id="4053609">(</span><span class="ident" id="4053610">fd</span><span class="op" id="4053612">.</span><span class="ident" id="4053613">sysfd</span><span class="op" id="4053618">,</span>&nbsp;<span class="ident" id="4053620">how</span><span class="op" id="4053623">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053626">if</span>&nbsp;<span class="ident" id="4053629">err</span>&nbsp;<span class="op" id="4053633">!=</span>&nbsp;<span class="ident" id="4053636">nil</span>&nbsp;<span class="op" id="4053640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053644">return</span>&nbsp;<span class="op" id="4053651">&amp;</span><span class="ident" id="4053652">OpError</span><span class="op" id="4053659">{</span><span class="string" id="4053660">&#34;shutdown&#34;</span><span class="op" id="4053670">,</span>&nbsp;<span class="ident" id="4053672">fd</span><span class="op" id="4053674">.</span><span class="ident" id="4053675">net</span><span class="op" id="4053678">,</span>&nbsp;<span class="ident" id="4053680">fd</span><span class="op" id="4053682">.</span><span class="ident" id="4053683">laddr</span><span class="op" id="4053688">,</span>&nbsp;<span class="ident" id="4053690">err</span><span class="op" id="4053693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4053696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053699">return</span>&nbsp;<span class="ident" id="4053706">nil</span><br>
<span class="lineno"></span><span class="op" id="4053710">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="4053713">func</span>&nbsp;<span class="op" id="4053718">(</span><span class="ident" id="4053719">fd</span>&nbsp;<span class="op" id="4053722">*</span><span class="ident" id="4053723">netFD</span><span class="op" id="4053728">)</span>&nbsp;<span class="ident" id="4053730">closeRead</span><span class="op" id="4053739">(</span><span class="op" id="4053740">)</span>&nbsp;<span class="builtintype" id="4053742">error</span>&nbsp;<span class="op" id="4053748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053751">return</span>&nbsp;<span class="ident" id="4053758">fd</span><span class="op" id="4053760">.</span><span class="ident" id="4053761">shutdown</span><span class="op" id="4053769">(</span><span class="ident" id="4053770">syscall</span><span class="op" id="4053777">.</span><span class="ident" id="4053778">SHUT_RD</span><span class="op" id="4053785">)</span><br>
<span class="lineno"></span><span class="op" id="4053787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="4053790">func</span>&nbsp;<span class="op" id="4053795">(</span><span class="ident" id="4053796">fd</span>&nbsp;<span class="op" id="4053799">*</span><span class="ident" id="4053800">netFD</span><span class="op" id="4053805">)</span>&nbsp;<span class="ident" id="4053807">closeWrite</span><span class="op" id="4053817">(</span><span class="op" id="4053818">)</span>&nbsp;<span class="builtintype" id="4053820">error</span>&nbsp;<span class="op" id="4053826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053829">return</span>&nbsp;<span class="ident" id="4053836">fd</span><span class="op" id="4053838">.</span><span class="ident" id="4053839">shutdown</span><span class="op" id="4053847">(</span><span class="ident" id="4053848">syscall</span><span class="op" id="4053855">.</span><span class="ident" id="4053856">SHUT_WR</span><span class="op" id="4053863">)</span><br>
<span class="lineno"></span><span class="op" id="4053865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4053868">func</span>&nbsp;<span class="op" id="4053873">(</span><span class="ident" id="4053874">fd</span>&nbsp;<span class="op" id="4053877">*</span><span class="ident" id="4053878">netFD</span><span class="op" id="4053883">)</span>&nbsp;<span class="ident" id="4053885">Read</span><span class="op" id="4053889">(</span><span class="ident" id="4053890">p</span>&nbsp;<span class="op" id="4053892">[</span><span class="op" id="4053893">]</span><span class="builtintype" id="4053894">byte</span><span class="op" id="4053898">)</span>&nbsp;<span class="op" id="4053900">(</span><span class="ident" id="4053901">n</span>&nbsp;<span class="builtintype" id="4053903">int</span><span class="op" id="4053906">,</span>&nbsp;<span class="ident" id="4053908">err</span>&nbsp;<span class="builtintype" id="4053912">error</span><span class="op" id="4053917">)</span>&nbsp;<span class="op" id="4053919">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053922">if</span>&nbsp;<span class="ident" id="4053925">err</span>&nbsp;<span class="op" id="4053929">:=</span>&nbsp;<span class="ident" id="4053932">fd</span><span class="op" id="4053934">.</span><span class="ident" id="4053935">readLock</span><span class="op" id="4053943">(</span><span class="op" id="4053944">)</span><span class="op" id="4053945">;</span>&nbsp;<span class="ident" id="4053947">err</span>&nbsp;<span class="op" id="4053951">!=</span>&nbsp;<span class="ident" id="4053954">nil</span>&nbsp;<span class="op" id="4053958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053962">return</span>&nbsp;<span class="num" id="4053969">0</span><span class="op" id="4053970">,</span>&nbsp;<span class="ident" id="4053972">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4053977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053980">defer</span>&nbsp;<span class="ident" id="4053986">fd</span><span class="op" id="4053988">.</span><span class="ident" id="4053989">readUnlock</span><span class="op" id="4053999">(</span><span class="op" id="4054000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054003">if</span>&nbsp;<span class="ident" id="4054006">err</span>&nbsp;<span class="op" id="4054010">:=</span>&nbsp;<span class="ident" id="4054013">fd</span><span class="op" id="4054015">.</span><span class="ident" id="4054016">pd</span><span class="op" id="4054018">.</span><span class="ident" id="4054019">PrepareRead</span><span class="op" id="4054030">(</span><span class="op" id="4054031">)</span><span class="op" id="4054032">;</span>&nbsp;<span class="ident" id="4054034">err</span>&nbsp;<span class="op" id="4054038">!=</span>&nbsp;<span class="ident" id="4054041">nil</span>&nbsp;<span class="op" id="4054045">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054049">return</span>&nbsp;<span class="num" id="4054056">0</span><span class="op" id="4054057">,</span>&nbsp;<span class="op" id="4054059">&amp;</span><span class="ident" id="4054060">OpError</span><span class="op" id="4054067">{</span><span class="string" id="4054068">&#34;read&#34;</span><span class="op" id="4054074">,</span>&nbsp;<span class="ident" id="4054076">fd</span><span class="op" id="4054078">.</span><span class="ident" id="4054079">net</span><span class="op" id="4054082">,</span>&nbsp;<span class="ident" id="4054084">fd</span><span class="op" id="4054086">.</span><span class="ident" id="4054087">raddr</span><span class="op" id="4054092">,</span>&nbsp;<span class="ident" id="4054094">err</span><span class="op" id="4054097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054103">for</span>&nbsp;<span class="op" id="4054107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054111">n</span><span class="op" id="4054112">,</span>&nbsp;<span class="ident" id="4054114">err</span>&nbsp;<span class="op" id="4054118">=</span>&nbsp;<span class="ident" id="4054120">syscall</span><span class="op" id="4054127">.</span><span class="ident" id="4054128">Read</span><span class="op" id="4054132">(</span><span class="builtintype" id="4054133">int</span><span class="op" id="4054136">(</span><span class="ident" id="4054137">fd</span><span class="op" id="4054139">.</span><span class="ident" id="4054140">sysfd</span><span class="op" id="4054145">)</span><span class="op" id="4054146">,</span>&nbsp;<span class="ident" id="4054148">p</span><span class="op" id="4054149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054153">if</span>&nbsp;<span class="ident" id="4054156">err</span>&nbsp;<span class="op" id="4054160">!=</span>&nbsp;<span class="ident" id="4054163">nil</span>&nbsp;<span class="op" id="4054167">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054172">n</span>&nbsp;<span class="op" id="4054174">=</span>&nbsp;<span class="num" id="4054176">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054181">if</span>&nbsp;<span class="ident" id="4054184">err</span>&nbsp;<span class="op" id="4054188">==</span>&nbsp;<span class="ident" id="4054191">syscall</span><span class="op" id="4054198">.</span><span class="ident" id="4054199">EAGAIN</span>&nbsp;<span class="op" id="4054206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054212">if</span>&nbsp;<span class="ident" id="4054215">err</span>&nbsp;<span class="op" id="4054219">=</span>&nbsp;<span class="ident" id="4054221">fd</span><span class="op" id="4054223">.</span><span class="ident" id="4054224">pd</span><span class="op" id="4054226">.</span><span class="ident" id="4054227">WaitRead</span><span class="op" id="4054235">(</span><span class="op" id="4054236">)</span><span class="op" id="4054237">;</span>&nbsp;<span class="ident" id="4054239">err</span>&nbsp;<span class="op" id="4054243">==</span>&nbsp;<span class="ident" id="4054246">nil</span>&nbsp;<span class="op" id="4054250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054257">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054270">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054283">err</span>&nbsp;<span class="op" id="4054287">=</span>&nbsp;<span class="ident" id="4054289">chkReadErr</span><span class="op" id="4054299">(</span><span class="ident" id="4054300">n</span><span class="op" id="4054301">,</span>&nbsp;<span class="ident" id="4054303">err</span><span class="op" id="4054306">,</span>&nbsp;<span class="ident" id="4054308">fd</span><span class="op" id="4054310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054314">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054321">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054324">if</span>&nbsp;<span class="ident" id="4054327">err</span>&nbsp;<span class="op" id="4054331">!=</span>&nbsp;<span class="ident" id="4054334">nil</span>&nbsp;<span class="op" id="4054338">&amp;&amp;</span>&nbsp;<span class="ident" id="4054341">err</span>&nbsp;<span class="op" id="4054345">!=</span>&nbsp;<span class="ident" id="4054348">io</span><span class="op" id="4054350">.</span><span class="ident" id="4054351">EOF</span>&nbsp;<span class="op" id="4054355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054359">err</span>&nbsp;<span class="op" id="4054363">=</span>&nbsp;<span class="op" id="4054365">&amp;</span><span class="ident" id="4054366">OpError</span><span class="op" id="4054373">{</span><span class="string" id="4054374">&#34;read&#34;</span><span class="op" id="4054380">,</span>&nbsp;<span class="ident" id="4054382">fd</span><span class="op" id="4054384">.</span><span class="ident" id="4054385">net</span><span class="op" id="4054388">,</span>&nbsp;<span class="ident" id="4054390">fd</span><span class="op" id="4054392">.</span><span class="ident" id="4054393">raddr</span><span class="op" id="4054398">,</span>&nbsp;<span class="ident" id="4054400">err</span><span class="op" id="4054403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054409">return</span><br>
<span class="lineno"></span><span class="op" id="4054416">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="4054419">func</span>&nbsp;<span class="op" id="4054424">(</span><span class="ident" id="4054425">fd</span>&nbsp;<span class="op" id="4054428">*</span><span class="ident" id="4054429">netFD</span><span class="op" id="4054434">)</span>&nbsp;<span class="ident" id="4054436">readFrom</span><span class="op" id="4054444">(</span><span class="ident" id="4054445">p</span>&nbsp;<span class="op" id="4054447">[</span><span class="op" id="4054448">]</span><span class="builtintype" id="4054449">byte</span><span class="op" id="4054453">)</span>&nbsp;<span class="op" id="4054455">(</span><span class="ident" id="4054456">n</span>&nbsp;<span class="builtintype" id="4054458">int</span><span class="op" id="4054461">,</span>&nbsp;<span class="ident" id="4054463">sa</span>&nbsp;<span class="ident" id="4054466">syscall</span><span class="op" id="4054473">.</span><span class="ident" id="4054474">Sockaddr</span><span class="op" id="4054482">,</span>&nbsp;<span class="ident" id="4054484">err</span>&nbsp;<span class="builtintype" id="4054488">error</span><span class="op" id="4054493">)</span>&nbsp;<span class="op" id="4054495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054498">if</span>&nbsp;<span class="ident" id="4054501">err</span>&nbsp;<span class="op" id="4054505">:=</span>&nbsp;<span class="ident" id="4054508">fd</span><span class="op" id="4054510">.</span><span class="ident" id="4054511">readLock</span><span class="op" id="4054519">(</span><span class="op" id="4054520">)</span><span class="op" id="4054521">;</span>&nbsp;<span class="ident" id="4054523">err</span>&nbsp;<span class="op" id="4054527">!=</span>&nbsp;<span class="ident" id="4054530">nil</span>&nbsp;<span class="op" id="4054534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054538">return</span>&nbsp;<span class="num" id="4054545">0</span><span class="op" id="4054546">,</span>&nbsp;<span class="ident" id="4054548">nil</span><span class="op" id="4054551">,</span>&nbsp;<span class="ident" id="4054553">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054558">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054561">defer</span>&nbsp;<span class="ident" id="4054567">fd</span><span class="op" id="4054569">.</span><span class="ident" id="4054570">readUnlock</span><span class="op" id="4054580">(</span><span class="op" id="4054581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054584">if</span>&nbsp;<span class="ident" id="4054587">err</span>&nbsp;<span class="op" id="4054591">:=</span>&nbsp;<span class="ident" id="4054594">fd</span><span class="op" id="4054596">.</span><span class="ident" id="4054597">pd</span><span class="op" id="4054599">.</span><span class="ident" id="4054600">PrepareRead</span><span class="op" id="4054611">(</span><span class="op" id="4054612">)</span><span class="op" id="4054613">;</span>&nbsp;<span class="ident" id="4054615">err</span>&nbsp;<span class="op" id="4054619">!=</span>&nbsp;<span class="ident" id="4054622">nil</span>&nbsp;<span class="op" id="4054626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054630">return</span>&nbsp;<span class="num" id="4054637">0</span><span class="op" id="4054638">,</span>&nbsp;<span class="ident" id="4054640">nil</span><span class="op" id="4054643">,</span>&nbsp;<span class="op" id="4054645">&amp;</span><span class="ident" id="4054646">OpError</span><span class="op" id="4054653">{</span><span class="string" id="4054654">&#34;read&#34;</span><span class="op" id="4054660">,</span>&nbsp;<span class="ident" id="4054662">fd</span><span class="op" id="4054664">.</span><span class="ident" id="4054665">net</span><span class="op" id="4054668">,</span>&nbsp;<span class="ident" id="4054670">fd</span><span class="op" id="4054672">.</span><span class="ident" id="4054673">laddr</span><span class="op" id="4054678">,</span>&nbsp;<span class="ident" id="4054680">err</span><span class="op" id="4054683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054689">for</span>&nbsp;<span class="op" id="4054693">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054697">n</span><span class="op" id="4054698">,</span>&nbsp;<span class="ident" id="4054700">sa</span><span class="op" id="4054702">,</span>&nbsp;<span class="ident" id="4054704">err</span>&nbsp;<span class="op" id="4054708">=</span>&nbsp;<span class="ident" id="4054710">syscall</span><span class="op" id="4054717">.</span><span class="ident" id="4054718">Recvfrom</span><span class="op" id="4054726">(</span><span class="ident" id="4054727">fd</span><span class="op" id="4054729">.</span><span class="ident" id="4054730">sysfd</span><span class="op" id="4054735">,</span>&nbsp;<span class="ident" id="4054737">p</span><span class="op" id="4054738">,</span>&nbsp;<span class="num" id="4054740">0</span><span class="op" id="4054741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054745">if</span>&nbsp;<span class="ident" id="4054748">err</span>&nbsp;<span class="op" id="4054752">!=</span>&nbsp;<span class="ident" id="4054755">nil</span>&nbsp;<span class="op" id="4054759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054764">n</span>&nbsp;<span class="op" id="4054766">=</span>&nbsp;<span class="num" id="4054768">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054773">if</span>&nbsp;<span class="ident" id="4054776">err</span>&nbsp;<span class="op" id="4054780">==</span>&nbsp;<span class="ident" id="4054783">syscall</span><span class="op" id="4054790">.</span><span class="ident" id="4054791">EAGAIN</span>&nbsp;<span class="op" id="4054798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054804">if</span>&nbsp;<span class="ident" id="4054807">err</span>&nbsp;<span class="op" id="4054811">=</span>&nbsp;<span class="ident" id="4054813">fd</span><span class="op" id="4054815">.</span><span class="ident" id="4054816">pd</span><span class="op" id="4054818">.</span><span class="ident" id="4054819">WaitRead</span><span class="op" id="4054827">(</span><span class="op" id="4054828">)</span><span class="op" id="4054829">;</span>&nbsp;<span class="ident" id="4054831">err</span>&nbsp;<span class="op" id="4054835">==</span>&nbsp;<span class="ident" id="4054838">nil</span>&nbsp;<span class="op" id="4054842">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054849">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054875">err</span>&nbsp;<span class="op" id="4054879">=</span>&nbsp;<span class="ident" id="4054881">chkReadErr</span><span class="op" id="4054891">(</span><span class="ident" id="4054892">n</span><span class="op" id="4054893">,</span>&nbsp;<span class="ident" id="4054895">err</span><span class="op" id="4054898">,</span>&nbsp;<span class="ident" id="4054900">fd</span><span class="op" id="4054902">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054906">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054916">if</span>&nbsp;<span class="ident" id="4054919">err</span>&nbsp;<span class="op" id="4054923">!=</span>&nbsp;<span class="ident" id="4054926">nil</span>&nbsp;<span class="op" id="4054930">&amp;&amp;</span>&nbsp;<span class="ident" id="4054933">err</span>&nbsp;<span class="op" id="4054937">!=</span>&nbsp;<span class="ident" id="4054940">io</span><span class="op" id="4054942">.</span><span class="ident" id="4054943">EOF</span>&nbsp;<span class="op" id="4054947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054951">err</span>&nbsp;<span class="op" id="4054955">=</span>&nbsp;<span class="op" id="4054957">&amp;</span><span class="ident" id="4054958">OpError</span><span class="op" id="4054965">{</span><span class="string" id="4054966">&#34;read&#34;</span><span class="op" id="4054972">,</span>&nbsp;<span class="ident" id="4054974">fd</span><span class="op" id="4054976">.</span><span class="ident" id="4054977">net</span><span class="op" id="4054980">,</span>&nbsp;<span class="ident" id="4054982">fd</span><span class="op" id="4054984">.</span><span class="ident" id="4054985">laddr</span><span class="op" id="4054990">,</span>&nbsp;<span class="ident" id="4054992">err</span><span class="op" id="4054995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054998">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055001">return</span><br>
<span class="lineno"></span><span class="op" id="4055008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4055011">func</span>&nbsp;<span class="op" id="4055016">(</span><span class="ident" id="4055017">fd</span>&nbsp;<span class="op" id="4055020">*</span><span class="ident" id="4055021">netFD</span><span class="op" id="4055026">)</span>&nbsp;<span class="ident" id="4055028">readMsg</span><span class="op" id="4055035">(</span><span class="ident" id="4055036">p</span>&nbsp;<span class="op" id="4055038">[</span><span class="op" id="4055039">]</span><span class="builtintype" id="4055040">byte</span><span class="op" id="4055044">,</span>&nbsp;<span class="ident" id="4055046">oob</span>&nbsp;<span class="op" id="4055050">[</span><span class="op" id="4055051">]</span><span class="builtintype" id="4055052">byte</span><span class="op" id="4055056">)</span>&nbsp;<span class="op" id="4055058">(</span><span class="ident" id="4055059">n</span><span class="op" id="4055060">,</span>&nbsp;<span class="ident" id="4055062">oobn</span><span class="op" id="4055066">,</span>&nbsp;<span class="ident" id="4055068">flags</span>&nbsp;<span class="builtintype" id="4055074">int</span><span class="op" id="4055077">,</span>&nbsp;<span class="ident" id="4055079">sa</span>&nbsp;<span class="ident" id="4055082">syscall</span><span class="op" id="4055089">.</span><span class="ident" id="4055090">Sockaddr</span><span class="op" id="4055098">,</span>&nbsp;<span class="ident" id="4055100">err</span>&nbsp;<span class="builtintype" id="4055104">error</span><span class="op" id="4055109">)</span>&nbsp;<span class="op" id="4055111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055114">if</span>&nbsp;<span class="ident" id="4055117">err</span>&nbsp;<span class="op" id="4055121">:=</span>&nbsp;<span class="ident" id="4055124">fd</span><span class="op" id="4055126">.</span><span class="ident" id="4055127">readLock</span><span class="op" id="4055135">(</span><span class="op" id="4055136">)</span><span class="op" id="4055137">;</span>&nbsp;<span class="ident" id="4055139">err</span>&nbsp;<span class="op" id="4055143">!=</span>&nbsp;<span class="ident" id="4055146">nil</span>&nbsp;<span class="op" id="4055150">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055154">return</span>&nbsp;<span class="num" id="4055161">0</span><span class="op" id="4055162">,</span>&nbsp;<span class="num" id="4055164">0</span><span class="op" id="4055165">,</span>&nbsp;<span class="num" id="4055167">0</span><span class="op" id="4055168">,</span>&nbsp;<span class="ident" id="4055170">nil</span><span class="op" id="4055173">,</span>&nbsp;<span class="ident" id="4055175">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055183">defer</span>&nbsp;<span class="ident" id="4055189">fd</span><span class="op" id="4055191">.</span><span class="ident" id="4055192">readUnlock</span><span class="op" id="4055202">(</span><span class="op" id="4055203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055206">if</span>&nbsp;<span class="ident" id="4055209">err</span>&nbsp;<span class="op" id="4055213">:=</span>&nbsp;<span class="ident" id="4055216">fd</span><span class="op" id="4055218">.</span><span class="ident" id="4055219">pd</span><span class="op" id="4055221">.</span><span class="ident" id="4055222">PrepareRead</span><span class="op" id="4055233">(</span><span class="op" id="4055234">)</span><span class="op" id="4055235">;</span>&nbsp;<span class="ident" id="4055237">err</span>&nbsp;<span class="op" id="4055241">!=</span>&nbsp;<span class="ident" id="4055244">nil</span>&nbsp;<span class="op" id="4055248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055252">return</span>&nbsp;<span class="num" id="4055259">0</span><span class="op" id="4055260">,</span>&nbsp;<span class="num" id="4055262">0</span><span class="op" id="4055263">,</span>&nbsp;<span class="num" id="4055265">0</span><span class="op" id="4055266">,</span>&nbsp;<span class="ident" id="4055268">nil</span><span class="op" id="4055271">,</span>&nbsp;<span class="op" id="4055273">&amp;</span><span class="ident" id="4055274">OpError</span><span class="op" id="4055281">{</span><span class="string" id="4055282">&#34;read&#34;</span><span class="op" id="4055288">,</span>&nbsp;<span class="ident" id="4055290">fd</span><span class="op" id="4055292">.</span><span class="ident" id="4055293">net</span><span class="op" id="4055296">,</span>&nbsp;<span class="ident" id="4055298">fd</span><span class="op" id="4055300">.</span><span class="ident" id="4055301">laddr</span><span class="op" id="4055306">,</span>&nbsp;<span class="ident" id="4055308">err</span><span class="op" id="4055311">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055317">for</span>&nbsp;<span class="op" id="4055321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055325">n</span><span class="op" id="4055326">,</span>&nbsp;<span class="ident" id="4055328">oobn</span><span class="op" id="4055332">,</span>&nbsp;<span class="ident" id="4055334">flags</span><span class="op" id="4055339">,</span>&nbsp;<span class="ident" id="4055341">sa</span><span class="op" id="4055343">,</span>&nbsp;<span class="ident" id="4055345">err</span>&nbsp;<span class="op" id="4055349">=</span>&nbsp;<span class="ident" id="4055351">syscall</span><span class="op" id="4055358">.</span><span class="ident" id="4055359">Recvmsg</span><span class="op" id="4055366">(</span><span class="ident" id="4055367">fd</span><span class="op" id="4055369">.</span><span class="ident" id="4055370">sysfd</span><span class="op" id="4055375">,</span>&nbsp;<span class="ident" id="4055377">p</span><span class="op" id="4055378">,</span>&nbsp;<span class="ident" id="4055380">oob</span><span class="op" id="4055383">,</span>&nbsp;<span class="num" id="4055385">0</span><span class="op" id="4055386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055390">if</span>&nbsp;<span class="ident" id="4055393">err</span>&nbsp;<span class="op" id="4055397">!=</span>&nbsp;<span class="ident" id="4055400">nil</span>&nbsp;<span class="op" id="4055404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4055409">//&nbsp;TODO(dfc)&nbsp;should&nbsp;n&nbsp;and&nbsp;oobn&nbsp;be&nbsp;set&nbsp;to&nbsp;0</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055455">if</span>&nbsp;<span class="ident" id="4055458">err</span>&nbsp;<span class="op" id="4055462">==</span>&nbsp;<span class="ident" id="4055465">syscall</span><span class="op" id="4055472">.</span><span class="ident" id="4055473">EAGAIN</span>&nbsp;<span class="op" id="4055480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055486">if</span>&nbsp;<span class="ident" id="4055489">err</span>&nbsp;<span class="op" id="4055493">=</span>&nbsp;<span class="ident" id="4055495">fd</span><span class="op" id="4055497">.</span><span class="ident" id="4055498">pd</span><span class="op" id="4055500">.</span><span class="ident" id="4055501">WaitRead</span><span class="op" id="4055509">(</span><span class="op" id="4055510">)</span><span class="op" id="4055511">;</span>&nbsp;<span class="ident" id="4055513">err</span>&nbsp;<span class="op" id="4055517">==</span>&nbsp;<span class="ident" id="4055520">nil</span>&nbsp;<span class="op" id="4055524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055531">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055549">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055557">err</span>&nbsp;<span class="op" id="4055561">=</span>&nbsp;<span class="ident" id="4055563">chkReadErr</span><span class="op" id="4055573">(</span><span class="ident" id="4055574">n</span><span class="op" id="4055575">,</span>&nbsp;<span class="ident" id="4055577">err</span><span class="op" id="4055580">,</span>&nbsp;<span class="ident" id="4055582">fd</span><span class="op" id="4055584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055588">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055598">if</span>&nbsp;<span class="ident" id="4055601">err</span>&nbsp;<span class="op" id="4055605">!=</span>&nbsp;<span class="ident" id="4055608">nil</span>&nbsp;<span class="op" id="4055612">&amp;&amp;</span>&nbsp;<span class="ident" id="4055615">err</span>&nbsp;<span class="op" id="4055619">!=</span>&nbsp;<span class="ident" id="4055622">io</span><span class="op" id="4055624">.</span><span class="ident" id="4055625">EOF</span>&nbsp;<span class="op" id="4055629">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055633">err</span>&nbsp;<span class="op" id="4055637">=</span>&nbsp;<span class="op" id="4055639">&amp;</span><span class="ident" id="4055640">OpError</span><span class="op" id="4055647">{</span><span class="string" id="4055648">&#34;read&#34;</span><span class="op" id="4055654">,</span>&nbsp;<span class="ident" id="4055656">fd</span><span class="op" id="4055658">.</span><span class="ident" id="4055659">net</span><span class="op" id="4055662">,</span>&nbsp;<span class="ident" id="4055664">fd</span><span class="op" id="4055666">.</span><span class="ident" id="4055667">laddr</span><span class="op" id="4055672">,</span>&nbsp;<span class="ident" id="4055674">err</span><span class="op" id="4055677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055683">return</span><br>
<span class="lineno"></span><span class="op" id="4055690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="keyword" id="4055693">func</span>&nbsp;<span class="ident" id="4055698">chkReadErr</span><span class="op" id="4055708">(</span><span class="ident" id="4055709">n</span>&nbsp;<span class="builtintype" id="4055711">int</span><span class="op" id="4055714">,</span>&nbsp;<span class="ident" id="4055716">err</span>&nbsp;<span class="builtintype" id="4055720">error</span><span class="op" id="4055725">,</span>&nbsp;<span class="ident" id="4055727">fd</span>&nbsp;<span class="op" id="4055730">*</span><span class="ident" id="4055731">netFD</span><span class="op" id="4055736">)</span>&nbsp;<span class="builtintype" id="4055738">error</span>&nbsp;<span class="op" id="4055744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055747">if</span>&nbsp;<span class="ident" id="4055750">n</span>&nbsp;<span class="op" id="4055752">==</span>&nbsp;<span class="num" id="4055755">0</span>&nbsp;<span class="op" id="4055757">&amp;&amp;</span>&nbsp;<span class="ident" id="4055760">err</span>&nbsp;<span class="op" id="4055764">==</span>&nbsp;<span class="ident" id="4055767">nil</span>&nbsp;<span class="op" id="4055771">&amp;&amp;</span>&nbsp;<span class="ident" id="4055774">fd</span><span class="op" id="4055776">.</span><span class="ident" id="4055777">sotype</span>&nbsp;<span class="op" id="4055784">!=</span>&nbsp;<span class="ident" id="4055787">syscall</span><span class="op" id="4055794">.</span><span class="ident" id="4055795">SOCK_DGRAM</span>&nbsp;<span class="op" id="4055806">&amp;&amp;</span>&nbsp;<span class="ident" id="4055809">fd</span><span class="op" id="4055811">.</span><span class="ident" id="4055812">sotype</span>&nbsp;<span class="op" id="4055819">!=</span>&nbsp;<span class="ident" id="4055822">syscall</span><span class="op" id="4055829">.</span><span class="ident" id="4055830">SOCK_RAW</span>&nbsp;<span class="op" id="4055839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055843">return</span>&nbsp;<span class="ident" id="4055850">io</span><span class="op" id="4055852">.</span><span class="ident" id="4055853">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055861">return</span>&nbsp;<span class="ident" id="4055868">err</span><br>
<span class="lineno">315</span><span class="op" id="4055872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4055875">func</span>&nbsp;<span class="op" id="4055880">(</span><span class="ident" id="4055881">fd</span>&nbsp;<span class="op" id="4055884">*</span><span class="ident" id="4055885">netFD</span><span class="op" id="4055890">)</span>&nbsp;<span class="ident" id="4055892">Write</span><span class="op" id="4055897">(</span><span class="ident" id="4055898">p</span>&nbsp;<span class="op" id="4055900">[</span><span class="op" id="4055901">]</span><span class="builtintype" id="4055902">byte</span><span class="op" id="4055906">)</span>&nbsp;<span class="op" id="4055908">(</span><span class="ident" id="4055909">nn</span>&nbsp;<span class="builtintype" id="4055912">int</span><span class="op" id="4055915">,</span>&nbsp;<span class="ident" id="4055917">err</span>&nbsp;<span class="builtintype" id="4055921">error</span><span class="op" id="4055926">)</span>&nbsp;<span class="op" id="4055928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055931">if</span>&nbsp;<span class="ident" id="4055934">err</span>&nbsp;<span class="op" id="4055938">:=</span>&nbsp;<span class="ident" id="4055941">fd</span><span class="op" id="4055943">.</span><span class="ident" id="4055944">writeLock</span><span class="op" id="4055953">(</span><span class="op" id="4055954">)</span><span class="op" id="4055955">;</span>&nbsp;<span class="ident" id="4055957">err</span>&nbsp;<span class="op" id="4055961">!=</span>&nbsp;<span class="ident" id="4055964">nil</span>&nbsp;<span class="op" id="4055968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055972">return</span>&nbsp;<span class="num" id="4055979">0</span><span class="op" id="4055980">,</span>&nbsp;<span class="ident" id="4055982">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055990">defer</span>&nbsp;<span class="ident" id="4055996">fd</span><span class="op" id="4055998">.</span><span class="ident" id="4055999">writeUnlock</span><span class="op" id="4056010">(</span><span class="op" id="4056011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056014">if</span>&nbsp;<span class="ident" id="4056017">err</span>&nbsp;<span class="op" id="4056021">:=</span>&nbsp;<span class="ident" id="4056024">fd</span><span class="op" id="4056026">.</span><span class="ident" id="4056027">pd</span><span class="op" id="4056029">.</span><span class="ident" id="4056030">PrepareWrite</span><span class="op" id="4056042">(</span><span class="op" id="4056043">)</span><span class="op" id="4056044">;</span>&nbsp;<span class="ident" id="4056046">err</span>&nbsp;<span class="op" id="4056050">!=</span>&nbsp;<span class="ident" id="4056053">nil</span>&nbsp;<span class="op" id="4056057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056061">return</span>&nbsp;<span class="num" id="4056068">0</span><span class="op" id="4056069">,</span>&nbsp;<span class="op" id="4056071">&amp;</span><span class="ident" id="4056072">OpError</span><span class="op" id="4056079">{</span><span class="string" id="4056080">&#34;write&#34;</span><span class="op" id="4056087">,</span>&nbsp;<span class="ident" id="4056089">fd</span><span class="op" id="4056091">.</span><span class="ident" id="4056092">net</span><span class="op" id="4056095">,</span>&nbsp;<span class="ident" id="4056097">fd</span><span class="op" id="4056099">.</span><span class="ident" id="4056100">raddr</span><span class="op" id="4056105">,</span>&nbsp;<span class="ident" id="4056107">err</span><span class="op" id="4056110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056113">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056116">for</span>&nbsp;<span class="op" id="4056120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056124">var</span>&nbsp;<span class="ident" id="4056128">n</span>&nbsp;<span class="builtintype" id="4056130">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056136">n</span><span class="op" id="4056137">,</span>&nbsp;<span class="ident" id="4056139">err</span>&nbsp;<span class="op" id="4056143">=</span>&nbsp;<span class="ident" id="4056145">syscall</span><span class="op" id="4056152">.</span><span class="ident" id="4056153">Write</span><span class="op" id="4056158">(</span><span class="builtintype" id="4056159">int</span><span class="op" id="4056162">(</span><span class="ident" id="4056163">fd</span><span class="op" id="4056165">.</span><span class="ident" id="4056166">sysfd</span><span class="op" id="4056171">)</span><span class="op" id="4056172">,</span>&nbsp;<span class="ident" id="4056174">p</span><span class="op" id="4056175">[</span><span class="ident" id="4056176">nn</span><span class="op" id="4056178">:</span><span class="op" id="4056179">]</span><span class="op" id="4056180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056184">if</span>&nbsp;<span class="ident" id="4056187">n</span>&nbsp;<span class="op" id="4056189">&gt;</span>&nbsp;<span class="num" id="4056191">0</span>&nbsp;<span class="op" id="4056193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056198">nn</span>&nbsp;<span class="op" id="4056201">+=</span>&nbsp;<span class="ident" id="4056204">n</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056212">if</span>&nbsp;<span class="ident" id="4056215">nn</span>&nbsp;<span class="op" id="4056218">==</span>&nbsp;<span class="builtinfunc" id="4056221">len</span><span class="op" id="4056224">(</span><span class="ident" id="4056225">p</span><span class="op" id="4056226">)</span>&nbsp;<span class="op" id="4056228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056233">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056245">if</span>&nbsp;<span class="ident" id="4056248">err</span>&nbsp;<span class="op" id="4056252">==</span>&nbsp;<span class="ident" id="4056255">syscall</span><span class="op" id="4056262">.</span><span class="ident" id="4056263">EAGAIN</span>&nbsp;<span class="op" id="4056270">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056275">if</span>&nbsp;<span class="ident" id="4056278">err</span>&nbsp;<span class="op" id="4056282">=</span>&nbsp;<span class="ident" id="4056284">fd</span><span class="op" id="4056286">.</span><span class="ident" id="4056287">pd</span><span class="op" id="4056289">.</span><span class="ident" id="4056290">WaitWrite</span><span class="op" id="4056299">(</span><span class="op" id="4056300">)</span><span class="op" id="4056301">;</span>&nbsp;<span class="ident" id="4056303">err</span>&nbsp;<span class="op" id="4056307">==</span>&nbsp;<span class="ident" id="4056310">nil</span>&nbsp;<span class="op" id="4056314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056320">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056340">if</span>&nbsp;<span class="ident" id="4056343">err</span>&nbsp;<span class="op" id="4056347">!=</span>&nbsp;<span class="ident" id="4056350">nil</span>&nbsp;<span class="op" id="4056354">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056359">n</span>&nbsp;<span class="op" id="4056361">=</span>&nbsp;<span class="num" id="4056363">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056368">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056380">if</span>&nbsp;<span class="ident" id="4056383">n</span>&nbsp;<span class="op" id="4056385">==</span>&nbsp;<span class="num" id="4056388">0</span>&nbsp;<span class="op" id="4056390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056395">err</span>&nbsp;<span class="op" id="4056399">=</span>&nbsp;<span class="ident" id="4056401">io</span><span class="op" id="4056403">.</span><span class="ident" id="4056404">ErrUnexpectedEOF</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056424">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056438">if</span>&nbsp;<span class="ident" id="4056441">err</span>&nbsp;<span class="op" id="4056445">!=</span>&nbsp;<span class="ident" id="4056448">nil</span>&nbsp;<span class="op" id="4056452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056456">err</span>&nbsp;<span class="op" id="4056460">=</span>&nbsp;<span class="op" id="4056462">&amp;</span><span class="ident" id="4056463">OpError</span><span class="op" id="4056470">{</span><span class="string" id="4056471">&#34;write&#34;</span><span class="op" id="4056478">,</span>&nbsp;<span class="ident" id="4056480">fd</span><span class="op" id="4056482">.</span><span class="ident" id="4056483">net</span><span class="op" id="4056486">,</span>&nbsp;<span class="ident" id="4056488">fd</span><span class="op" id="4056490">.</span><span class="ident" id="4056491">raddr</span><span class="op" id="4056496">,</span>&nbsp;<span class="ident" id="4056498">err</span><span class="op" id="4056501">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056507">return</span>&nbsp;<span class="ident" id="4056514">nn</span><span class="op" id="4056516">,</span>&nbsp;<span class="ident" id="4056518">err</span><br>
<span class="lineno"></span><span class="op" id="4056522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4056525">func</span>&nbsp;<span class="op" id="4056530">(</span><span class="ident" id="4056531">fd</span>&nbsp;<span class="op" id="4056534">*</span><span class="ident" id="4056535">netFD</span><span class="op" id="4056540">)</span>&nbsp;<span class="ident" id="4056542">writeTo</span><span class="op" id="4056549">(</span><span class="ident" id="4056550">p</span>&nbsp;<span class="op" id="4056552">[</span><span class="op" id="4056553">]</span><span class="builtintype" id="4056554">byte</span><span class="op" id="4056558">,</span>&nbsp;<span class="ident" id="4056560">sa</span>&nbsp;<span class="ident" id="4056563">syscall</span><span class="op" id="4056570">.</span><span class="ident" id="4056571">Sockaddr</span><span class="op" id="4056579">)</span>&nbsp;<span class="op" id="4056581">(</span><span class="ident" id="4056582">n</span>&nbsp;<span class="builtintype" id="4056584">int</span><span class="op" id="4056587">,</span>&nbsp;<span class="ident" id="4056589">err</span>&nbsp;<span class="builtintype" id="4056593">error</span><span class="op" id="4056598">)</span>&nbsp;<span class="op" id="4056600">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056603">if</span>&nbsp;<span class="ident" id="4056606">err</span>&nbsp;<span class="op" id="4056610">:=</span>&nbsp;<span class="ident" id="4056613">fd</span><span class="op" id="4056615">.</span><span class="ident" id="4056616">writeLock</span><span class="op" id="4056625">(</span><span class="op" id="4056626">)</span><span class="op" id="4056627">;</span>&nbsp;<span class="ident" id="4056629">err</span>&nbsp;<span class="op" id="4056633">!=</span>&nbsp;<span class="ident" id="4056636">nil</span>&nbsp;<span class="op" id="4056640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056644">return</span>&nbsp;<span class="num" id="4056651">0</span><span class="op" id="4056652">,</span>&nbsp;<span class="ident" id="4056654">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056662">defer</span>&nbsp;<span class="ident" id="4056668">fd</span><span class="op" id="4056670">.</span><span class="ident" id="4056671">writeUnlock</span><span class="op" id="4056682">(</span><span class="op" id="4056683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056686">if</span>&nbsp;<span class="ident" id="4056689">err</span>&nbsp;<span class="op" id="4056693">:=</span>&nbsp;<span class="ident" id="4056696">fd</span><span class="op" id="4056698">.</span><span class="ident" id="4056699">pd</span><span class="op" id="4056701">.</span><span class="ident" id="4056702">PrepareWrite</span><span class="op" id="4056714">(</span><span class="op" id="4056715">)</span><span class="op" id="4056716">;</span>&nbsp;<span class="ident" id="4056718">err</span>&nbsp;<span class="op" id="4056722">!=</span>&nbsp;<span class="ident" id="4056725">nil</span>&nbsp;<span class="op" id="4056729">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056733">return</span>&nbsp;<span class="num" id="4056740">0</span><span class="op" id="4056741">,</span>&nbsp;<span class="op" id="4056743">&amp;</span><span class="ident" id="4056744">OpError</span><span class="op" id="4056751">{</span><span class="string" id="4056752">&#34;write&#34;</span><span class="op" id="4056759">,</span>&nbsp;<span class="ident" id="4056761">fd</span><span class="op" id="4056763">.</span><span class="ident" id="4056764">net</span><span class="op" id="4056767">,</span>&nbsp;<span class="ident" id="4056769">fd</span><span class="op" id="4056771">.</span><span class="ident" id="4056772">raddr</span><span class="op" id="4056777">,</span>&nbsp;<span class="ident" id="4056779">err</span><span class="op" id="4056782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056788">for</span>&nbsp;<span class="op" id="4056792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056796">err</span>&nbsp;<span class="op" id="4056800">=</span>&nbsp;<span class="ident" id="4056802">syscall</span><span class="op" id="4056809">.</span><span class="ident" id="4056810">Sendto</span><span class="op" id="4056816">(</span><span class="ident" id="4056817">fd</span><span class="op" id="4056819">.</span><span class="ident" id="4056820">sysfd</span><span class="op" id="4056825">,</span>&nbsp;<span class="ident" id="4056827">p</span><span class="op" id="4056828">,</span>&nbsp;<span class="num" id="4056830">0</span><span class="op" id="4056831">,</span>&nbsp;<span class="ident" id="4056833">sa</span><span class="op" id="4056835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056839">if</span>&nbsp;<span class="ident" id="4056842">err</span>&nbsp;<span class="op" id="4056846">==</span>&nbsp;<span class="ident" id="4056849">syscall</span><span class="op" id="4056856">.</span><span class="ident" id="4056857">EAGAIN</span>&nbsp;<span class="op" id="4056864">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056869">if</span>&nbsp;<span class="ident" id="4056872">err</span>&nbsp;<span class="op" id="4056876">=</span>&nbsp;<span class="ident" id="4056878">fd</span><span class="op" id="4056880">.</span><span class="ident" id="4056881">pd</span><span class="op" id="4056883">.</span><span class="ident" id="4056884">WaitWrite</span><span class="op" id="4056893">(</span><span class="op" id="4056894">)</span><span class="op" id="4056895">;</span>&nbsp;<span class="ident" id="4056897">err</span>&nbsp;<span class="op" id="4056901">==</span>&nbsp;<span class="ident" id="4056904">nil</span>&nbsp;<span class="op" id="4056908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056914">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056934">break</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056944">if</span>&nbsp;<span class="ident" id="4056947">err</span>&nbsp;<span class="op" id="4056951">==</span>&nbsp;<span class="ident" id="4056954">nil</span>&nbsp;<span class="op" id="4056958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056962">n</span>&nbsp;<span class="op" id="4056964">=</span>&nbsp;<span class="builtinfunc" id="4056966">len</span><span class="op" id="4056969">(</span><span class="ident" id="4056970">p</span><span class="op" id="4056971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056974">}</span>&nbsp;<span class="keyword" id="4056976">else</span>&nbsp;<span class="op" id="4056981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056985">err</span>&nbsp;<span class="op" id="4056989">=</span>&nbsp;<span class="op" id="4056991">&amp;</span><span class="ident" id="4056992">OpError</span><span class="op" id="4056999">{</span><span class="string" id="4057000">&#34;write&#34;</span><span class="op" id="4057007">,</span>&nbsp;<span class="ident" id="4057009">fd</span><span class="op" id="4057011">.</span><span class="ident" id="4057012">net</span><span class="op" id="4057015">,</span>&nbsp;<span class="ident" id="4057017">fd</span><span class="op" id="4057019">.</span><span class="ident" id="4057020">raddr</span><span class="op" id="4057025">,</span>&nbsp;<span class="ident" id="4057027">err</span><span class="op" id="4057030">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4057033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057036">return</span><br>
<span class="lineno"></span><span class="op" id="4057043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4057046">func</span>&nbsp;<span class="op" id="4057051">(</span><span class="ident" id="4057052">fd</span>&nbsp;<span class="op" id="4057055">*</span><span class="ident" id="4057056">netFD</span><span class="op" id="4057061">)</span>&nbsp;<span class="ident" id="4057063">writeMsg</span><span class="op" id="4057071">(</span><span class="ident" id="4057072">p</span>&nbsp;<span class="op" id="4057074">[</span><span class="op" id="4057075">]</span><span class="builtintype" id="4057076">byte</span><span class="op" id="4057080">,</span>&nbsp;<span class="ident" id="4057082">oob</span>&nbsp;<span class="op" id="4057086">[</span><span class="op" id="4057087">]</span><span class="builtintype" id="4057088">byte</span><span class="op" id="4057092">,</span>&nbsp;<span class="ident" id="4057094">sa</span>&nbsp;<span class="ident" id="4057097">syscall</span><span class="op" id="4057104">.</span><span class="ident" id="4057105">Sockaddr</span><span class="op" id="4057113">)</span>&nbsp;<span class="op" id="4057115">(</span><span class="ident" id="4057116">n</span>&nbsp;<span class="builtintype" id="4057118">int</span><span class="op" id="4057121">,</span>&nbsp;<span class="ident" id="4057123">oobn</span>&nbsp;<span class="builtintype" id="4057128">int</span><span class="op" id="4057131">,</span>&nbsp;<span class="ident" id="4057133">err</span>&nbsp;<span class="builtintype" id="4057137">error</span><span class="op" id="4057142">)</span>&nbsp;<span class="op" id="4057144">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057147">if</span>&nbsp;<span class="ident" id="4057150">err</span>&nbsp;<span class="op" id="4057154">:=</span>&nbsp;<span class="ident" id="4057157">fd</span><span class="op" id="4057159">.</span><span class="ident" id="4057160">writeLock</span><span class="op" id="4057169">(</span><span class="op" id="4057170">)</span><span class="op" id="4057171">;</span>&nbsp;<span class="ident" id="4057173">err</span>&nbsp;<span class="op" id="4057177">!=</span>&nbsp;<span class="ident" id="4057180">nil</span>&nbsp;<span class="op" id="4057184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057188">return</span>&nbsp;<span class="num" id="4057195">0</span><span class="op" id="4057196">,</span>&nbsp;<span class="num" id="4057198">0</span><span class="op" id="4057199">,</span>&nbsp;<span class="ident" id="4057201">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4057206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057209">defer</span>&nbsp;<span class="ident" id="4057215">fd</span><span class="op" id="4057217">.</span><span class="ident" id="4057218">writeUnlock</span><span class="op" id="4057229">(</span><span class="op" id="4057230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057233">if</span>&nbsp;<span class="ident" id="4057236">err</span>&nbsp;<span class="op" id="4057240">:=</span>&nbsp;<span class="ident" id="4057243">fd</span><span class="op" id="4057245">.</span><span class="ident" id="4057246">pd</span><span class="op" id="4057248">.</span><span class="ident" id="4057249">PrepareWrite</span><span class="op" id="4057261">(</span><span class="op" id="4057262">)</span><span class="op" id="4057263">;</span>&nbsp;<span class="ident" id="4057265">err</span>&nbsp;<span class="op" id="4057269">!=</span>&nbsp;<span class="ident" id="4057272">nil</span>&nbsp;<span class="op" id="4057276">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057280">return</span>&nbsp;<span class="num" id="4057287">0</span><span class="op" id="4057288">,</span>&nbsp;<span class="num" id="4057290">0</span><span class="op" id="4057291">,</span>&nbsp;<span class="op" id="4057293">&amp;</span><span class="ident" id="4057294">OpError</span><span class="op" id="4057301">{</span><span class="string" id="4057302">&#34;write&#34;</span><span class="op" id="4057309">,</span>&nbsp;<span class="ident" id="4057311">fd</span><span class="op" id="4057313">.</span><span class="ident" id="4057314">net</span><span class="op" id="4057317">,</span>&nbsp;<span class="ident" id="4057319">fd</span><span class="op" id="4057321">.</span><span class="ident" id="4057322">raddr</span><span class="op" id="4057327">,</span>&nbsp;<span class="ident" id="4057329">err</span><span class="op" id="4057332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4057335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057338">for</span>&nbsp;<span class="op" id="4057342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057346">n</span><span class="op" id="4057347">,</span>&nbsp;<span class="ident" id="4057349">err</span>&nbsp;<span class="op" id="4057353">=</span>&nbsp;<span class="ident" id="4057355">syscall</span><span class="op" id="4057362">.</span><span class="ident" id="4057363">SendmsgN</span><span class="op" id="4057371">(</span><span class="ident" id="4057372">fd</span><span class="op" id="4057374">.</span><span class="ident" id="4057375">sysfd</span><span class="op" id="4057380">,</span>&nbsp;<span class="ident" id="4057382">p</span><span class="op" id="4057383">,</span>&nbsp;<span class="ident" id="4057385">oob</span><span class="op" id="4057388">,</span>&nbsp;<span class="ident" id="4057390">sa</span><span class="op" id="4057392">,</span>&nbsp;<span class="num" id="4057394">0</span><span class="op" id="4057395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057399">if</span>&nbsp;<span class="ident" id="4057402">err</span>&nbsp;<span class="op" id="4057406">==</span>&nbsp;<span class="ident" id="4057409">syscall</span><span class="op" id="4057416">.</span><span class="ident" id="4057417">EAGAIN</span>&nbsp;<span class="op" id="4057424">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057429">if</span>&nbsp;<span class="ident" id="4057432">err</span>&nbsp;<span class="op" id="4057436">=</span>&nbsp;<span class="ident" id="4057438">fd</span><span class="op" id="4057440">.</span><span class="ident" id="4057441">pd</span><span class="op" id="4057443">.</span><span class="ident" id="4057444">WaitWrite</span><span class="op" id="4057453">(</span><span class="op" id="4057454">)</span><span class="op" id="4057455">;</span>&nbsp;<span class="ident" id="4057457">err</span>&nbsp;<span class="op" id="4057461">==</span>&nbsp;<span class="ident" id="4057464">nil</span>&nbsp;<span class="op" id="4057468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057474">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4057486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4057490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057494">break</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4057501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057504">if</span>&nbsp;<span class="ident" id="4057507">err</span>&nbsp;<span class="op" id="4057511">==</span>&nbsp;<span class="ident" id="4057514">nil</span>&nbsp;<span class="op" id="4057518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057522">oobn</span>&nbsp;<span class="op" id="4057527">=</span>&nbsp;<span class="builtinfunc" id="4057529">len</span><span class="op" id="4057532">(</span><span class="ident" id="4057533">oob</span><span class="op" id="4057536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4057539">}</span>&nbsp;<span class="keyword" id="4057541">else</span>&nbsp;<span class="op" id="4057546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057550">err</span>&nbsp;<span class="op" id="4057554">=</span>&nbsp;<span class="op" id="4057556">&amp;</span><span class="ident" id="4057557">OpError</span><span class="op" id="4057564">{</span><span class="string" id="4057565">&#34;write&#34;</span><span class="op" id="4057572">,</span>&nbsp;<span class="ident" id="4057574">fd</span><span class="op" id="4057576">.</span><span class="ident" id="4057577">net</span><span class="op" id="4057580">,</span>&nbsp;<span class="ident" id="4057582">fd</span><span class="op" id="4057584">.</span><span class="ident" id="4057585">raddr</span><span class="op" id="4057590">,</span>&nbsp;<span class="ident" id="4057592">err</span><span class="op" id="4057595">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4057598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057601">return</span><br>
<span class="lineno"></span><span class="op" id="4057608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4057611">func</span>&nbsp;<span class="op" id="4057616">(</span><span class="ident" id="4057617">fd</span>&nbsp;<span class="op" id="4057620">*</span><span class="ident" id="4057621">netFD</span><span class="op" id="4057626">)</span>&nbsp;<span class="ident" id="4057628">accept</span><span class="op" id="4057634">(</span><span class="op" id="4057635">)</span>&nbsp;<span class="op" id="4057637">(</span><span class="ident" id="4057638">netfd</span>&nbsp;<span class="op" id="4057644">*</span><span class="ident" id="4057645">netFD</span><span class="op" id="4057650">,</span>&nbsp;<span class="ident" id="4057652">err</span>&nbsp;<span class="builtintype" id="4057656">error</span><span class="op" id="4057661">)</span>&nbsp;<span class="op" id="4057663">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057666">if</span>&nbsp;<span class="ident" id="4057669">err</span>&nbsp;<span class="op" id="4057673">:=</span>&nbsp;<span class="ident" id="4057676">fd</span><span class="op" id="4057678">.</span><span class="ident" id="4057679">readLock</span><span class="op" id="4057687">(</span><span class="op" id="4057688">)</span><span class="op" id="4057689">;</span>&nbsp;<span class="ident" id="4057691">err</span>&nbsp;<span class="op" id="4057695">!=</span>&nbsp;<span class="ident" id="4057698">nil</span>&nbsp;<span class="op" id="4057702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057706">return</span>&nbsp;<span class="ident" id="4057713">nil</span><span class="op" id="4057716">,</span>&nbsp;<span class="ident" id="4057718">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4057723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057726">defer</span>&nbsp;<span class="ident" id="4057732">fd</span><span class="op" id="4057734">.</span><span class="ident" id="4057735">readUnlock</span><span class="op" id="4057745">(</span><span class="op" id="4057746">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057750">var</span>&nbsp;<span class="ident" id="4057754">s</span>&nbsp;<span class="builtintype" id="4057756">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057761">var</span>&nbsp;<span class="ident" id="4057765">rsa</span>&nbsp;<span class="ident" id="4057769">syscall</span><span class="op" id="4057776">.</span><span class="ident" id="4057777">Sockaddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057787">if</span>&nbsp;<span class="ident" id="4057790">err</span>&nbsp;<span class="op" id="4057794">=</span>&nbsp;<span class="ident" id="4057796">fd</span><span class="op" id="4057798">.</span><span class="ident" id="4057799">pd</span><span class="op" id="4057801">.</span><span class="ident" id="4057802">PrepareRead</span><span class="op" id="4057813">(</span><span class="op" id="4057814">)</span><span class="op" id="4057815">;</span>&nbsp;<span class="ident" id="4057817">err</span>&nbsp;<span class="op" id="4057821">!=</span>&nbsp;<span class="ident" id="4057824">nil</span>&nbsp;<span class="op" id="4057828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057832">return</span>&nbsp;<span class="ident" id="4057839">nil</span><span class="op" id="4057842">,</span>&nbsp;<span class="op" id="4057844">&amp;</span><span class="ident" id="4057845">OpError</span><span class="op" id="4057852">{</span><span class="string" id="4057853">&#34;accept&#34;</span><span class="op" id="4057861">,</span>&nbsp;<span class="ident" id="4057863">fd</span><span class="op" id="4057865">.</span><span class="ident" id="4057866">net</span><span class="op" id="4057869">,</span>&nbsp;<span class="ident" id="4057871">fd</span><span class="op" id="4057873">.</span><span class="ident" id="4057874">laddr</span><span class="op" id="4057879">,</span>&nbsp;<span class="ident" id="4057881">err</span><span class="op" id="4057884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4057887">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057890">for</span>&nbsp;<span class="op" id="4057894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057898">s</span><span class="op" id="4057899">,</span>&nbsp;<span class="ident" id="4057901">rsa</span><span class="op" id="4057904">,</span>&nbsp;<span class="ident" id="4057906">err</span>&nbsp;<span class="op" id="4057910">=</span>&nbsp;<span class="ident" id="4057912">accept</span><span class="op" id="4057918">(</span><span class="ident" id="4057919">fd</span><span class="op" id="4057921">.</span><span class="ident" id="4057922">sysfd</span><span class="op" id="4057927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057931">if</span>&nbsp;<span class="ident" id="4057934">err</span>&nbsp;<span class="op" id="4057938">!=</span>&nbsp;<span class="ident" id="4057941">nil</span>&nbsp;<span class="op" id="4057945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057950">if</span>&nbsp;<span class="ident" id="4057953">err</span>&nbsp;<span class="op" id="4057957">==</span>&nbsp;<span class="ident" id="4057960">syscall</span><span class="op" id="4057967">.</span><span class="ident" id="4057968">EAGAIN</span>&nbsp;<span class="op" id="4057975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057981">if</span>&nbsp;<span class="ident" id="4057984">err</span>&nbsp;<span class="op" id="4057988">=</span>&nbsp;<span class="ident" id="4057990">fd</span><span class="op" id="4057992">.</span><span class="ident" id="4057993">pd</span><span class="op" id="4057995">.</span><span class="ident" id="4057996">WaitRead</span><span class="op" id="4058004">(</span><span class="op" id="4058005">)</span><span class="op" id="4058006">;</span>&nbsp;<span class="ident" id="4058008">err</span>&nbsp;<span class="op" id="4058012">==</span>&nbsp;<span class="ident" id="4058015">nil</span>&nbsp;<span class="op" id="4058019">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058026">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4058039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4058044">}</span>&nbsp;<span class="keyword" id="4058046">else</span>&nbsp;<span class="keyword" id="4058051">if</span>&nbsp;<span class="ident" id="4058054">err</span>&nbsp;<span class="op" id="4058058">==</span>&nbsp;<span class="ident" id="4058061">syscall</span><span class="op" id="4058068">.</span><span class="ident" id="4058069">ECONNABORTED</span>&nbsp;<span class="op" id="4058082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4058088">//&nbsp;This&nbsp;means&nbsp;that&nbsp;a&nbsp;socket&nbsp;on&nbsp;the&nbsp;listen&nbsp;queue&nbsp;was&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4058151">//&nbsp;before&nbsp;we&nbsp;Accept()ed&nbsp;it;&nbsp;it&#39;s&nbsp;a&nbsp;silly&nbsp;error,&nbsp;so&nbsp;try&nbsp;again.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058217">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4058229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058234">return</span>&nbsp;<span class="ident" id="4058241">nil</span><span class="op" id="4058244">,</span>&nbsp;<span class="op" id="4058246">&amp;</span><span class="ident" id="4058247">OpError</span><span class="op" id="4058254">{</span><span class="string" id="4058255">&#34;accept&#34;</span><span class="op" id="4058263">,</span>&nbsp;<span class="ident" id="4058265">fd</span><span class="op" id="4058267">.</span><span class="ident" id="4058268">net</span><span class="op" id="4058271">,</span>&nbsp;<span class="ident" id="4058273">fd</span><span class="op" id="4058275">.</span><span class="ident" id="4058276">laddr</span><span class="op" id="4058281">,</span>&nbsp;<span class="ident" id="4058283">err</span><span class="op" id="4058286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4058290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058294">break</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4058301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058305">if</span>&nbsp;<span class="ident" id="4058308">netfd</span><span class="op" id="4058313">,</span>&nbsp;<span class="ident" id="4058315">err</span>&nbsp;<span class="op" id="4058319">=</span>&nbsp;<span class="ident" id="4058321">newFD</span><span class="op" id="4058326">(</span><span class="ident" id="4058327">s</span><span class="op" id="4058328">,</span>&nbsp;<span class="ident" id="4058330">fd</span><span class="op" id="4058332">.</span><span class="ident" id="4058333">family</span><span class="op" id="4058339">,</span>&nbsp;<span class="ident" id="4058341">fd</span><span class="op" id="4058343">.</span><span class="ident" id="4058344">sotype</span><span class="op" id="4058350">,</span>&nbsp;<span class="ident" id="4058352">fd</span><span class="op" id="4058354">.</span><span class="ident" id="4058355">net</span><span class="op" id="4058358">)</span><span class="op" id="4058359">;</span>&nbsp;<span class="ident" id="4058361">err</span>&nbsp;<span class="op" id="4058365">!=</span>&nbsp;<span class="ident" id="4058368">nil</span>&nbsp;<span class="op" id="4058372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058376">closesocket</span><span class="op" id="4058387">(</span><span class="ident" id="4058388">s</span><span class="op" id="4058389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058393">return</span>&nbsp;<span class="ident" id="4058400">nil</span><span class="op" id="4058403">,</span>&nbsp;<span class="ident" id="4058405">err</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4058410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058413">if</span>&nbsp;<span class="ident" id="4058416">err</span>&nbsp;<span class="op" id="4058420">=</span>&nbsp;<span class="ident" id="4058422">netfd</span><span class="op" id="4058427">.</span><span class="ident" id="4058428">init</span><span class="op" id="4058432">(</span><span class="op" id="4058433">)</span><span class="op" id="4058434">;</span>&nbsp;<span class="ident" id="4058436">err</span>&nbsp;<span class="op" id="4058440">!=</span>&nbsp;<span class="ident" id="4058443">nil</span>&nbsp;<span class="op" id="4058447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058451">fd</span><span class="op" id="4058453">.</span><span class="ident" id="4058454">Close</span><span class="op" id="4058459">(</span><span class="op" id="4058460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058464">return</span>&nbsp;<span class="ident" id="4058471">nil</span><span class="op" id="4058474">,</span>&nbsp;<span class="ident" id="4058476">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4058481">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058484">lsa</span><span class="op" id="4058487">,</span>&nbsp;<span class="ident" id="4058489">_</span>&nbsp;<span class="op" id="4058491">:=</span>&nbsp;<span class="ident" id="4058494">syscall</span><span class="op" id="4058501">.</span><span class="ident" id="4058502">Getsockname</span><span class="op" id="4058513">(</span><span class="ident" id="4058514">netfd</span><span class="op" id="4058519">.</span><span class="ident" id="4058520">sysfd</span><span class="op" id="4058525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058528">netfd</span><span class="op" id="4058533">.</span><span class="ident" id="4058534">setAddr</span><span class="op" id="4058541">(</span><span class="ident" id="4058542">netfd</span><span class="op" id="4058547">.</span><span class="ident" id="4058548">addrFunc</span><span class="op" id="4058556">(</span><span class="op" id="4058557">)</span><span class="op" id="4058558">(</span><span class="ident" id="4058559">lsa</span><span class="op" id="4058562">)</span><span class="op" id="4058563">,</span>&nbsp;<span class="ident" id="4058565">netfd</span><span class="op" id="4058570">.</span><span class="ident" id="4058571">addrFunc</span><span class="op" id="4058579">(</span><span class="op" id="4058580">)</span><span class="op" id="4058581">(</span><span class="ident" id="4058582">rsa</span><span class="op" id="4058585">)</span><span class="op" id="4058586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058589">return</span>&nbsp;<span class="ident" id="4058596">netfd</span><span class="op" id="4058601">,</span>&nbsp;<span class="ident" id="4058603">nil</span><br>
<span class="lineno"></span><span class="op" id="4058607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="4058610">//&nbsp;tryDupCloexec&nbsp;indicates&nbsp;whether&nbsp;F_DUPFD_CLOEXEC&nbsp;should&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="4058677">//&nbsp;If&nbsp;the&nbsp;kernel&nbsp;doesn&#39;t&nbsp;support&nbsp;it,&nbsp;this&nbsp;is&nbsp;set&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="4058732">var</span>&nbsp;<span class="ident" id="4058736">tryDupCloexec</span>&nbsp;<span class="op" id="4058750">=</span>&nbsp;<span class="builtintype" id="4058752">int32</span><span class="op" id="4058757">(</span><span class="num" id="4058758">1</span><span class="op" id="4058759">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4058762">func</span>&nbsp;<span class="ident" id="4058767">dupCloseOnExec</span><span class="op" id="4058781">(</span><span class="ident" id="4058782">fd</span>&nbsp;<span class="builtintype" id="4058785">int</span><span class="op" id="4058788">)</span>&nbsp;<span class="op" id="4058790">(</span><span class="ident" id="4058791">newfd</span>&nbsp;<span class="builtintype" id="4058797">int</span><span class="op" id="4058800">,</span>&nbsp;<span class="ident" id="4058802">err</span>&nbsp;<span class="builtintype" id="4058806">error</span><span class="op" id="4058811">)</span>&nbsp;<span class="op" id="4058813">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058816">if</span>&nbsp;<span class="ident" id="4058819">atomic</span><span class="op" id="4058825">.</span><span class="ident" id="4058826">LoadInt32</span><span class="op" id="4058835">(</span><span class="op" id="4058836">&amp;</span><span class="ident" id="4058837">tryDupCloexec</span><span class="op" id="4058850">)</span>&nbsp;<span class="op" id="4058852">==</span>&nbsp;<span class="num" id="4058855">1</span>&nbsp;<span class="op" id="4058857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058861">r0</span><span class="op" id="4058863">,</span>&nbsp;<span class="ident" id="4058865">_</span><span class="op" id="4058866">,</span>&nbsp;<span class="ident" id="4058868">e1</span>&nbsp;<span class="op" id="4058871">:=</span>&nbsp;<span class="ident" id="4058874">syscall</span><span class="op" id="4058881">.</span><span class="ident" id="4058882">Syscall</span><span class="op" id="4058889">(</span><span class="ident" id="4058890">syscall</span><span class="op" id="4058897">.</span><span class="ident" id="4058898">SYS_FCNTL</span><span class="op" id="4058907">,</span>&nbsp;<span class="builtintype" id="4058909">uintptr</span><span class="op" id="4058916">(</span><span class="ident" id="4058917">fd</span><span class="op" id="4058919">)</span><span class="op" id="4058920">,</span>&nbsp;<span class="ident" id="4058922">syscall</span><span class="op" id="4058929">.</span><span class="ident" id="4058930">F_DUPFD_CLOEXEC</span><span class="op" id="4058945">,</span>&nbsp;<span class="num" id="4058947">0</span><span class="op" id="4058948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058952">if</span>&nbsp;<span class="ident" id="4058955">runtime</span><span class="op" id="4058962">.</span><span class="ident" id="4058963">GOOS</span>&nbsp;<span class="op" id="4058968">==</span>&nbsp;<span class="string" id="4058971">&#34;darwin&#34;</span>&nbsp;<span class="op" id="4058980">&amp;&amp;</span>&nbsp;<span class="ident" id="4058983">e1</span>&nbsp;<span class="op" id="4058986">==</span>&nbsp;<span class="ident" id="4058989">syscall</span><span class="op" id="4058996">.</span><span class="ident" id="4058997">EBADF</span>&nbsp;<span class="op" id="4059003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059008">//&nbsp;On&nbsp;OS&nbsp;X&nbsp;10.6&nbsp;and&nbsp;below&nbsp;(but&nbsp;we&nbsp;only&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059058">//&nbsp;&gt;=&nbsp;10.6),&nbsp;F_DUPFD_CLOEXEC&nbsp;is&nbsp;unsupported</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059105">//&nbsp;and&nbsp;fcntl&nbsp;there&nbsp;falls&nbsp;back&nbsp;(undocumented)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059153">//&nbsp;to&nbsp;doing&nbsp;an&nbsp;ioctl&nbsp;instead,&nbsp;returning&nbsp;EBADF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059202">//&nbsp;in&nbsp;this&nbsp;case&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059246">//&nbsp;expected&nbsp;device&nbsp;fd&nbsp;type.&nbsp;&nbsp;Treat&nbsp;it&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059290">//&nbsp;EINVAL&nbsp;instead,&nbsp;so&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059335">//&nbsp;normal&nbsp;dup&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059358">//&nbsp;TODO:&nbsp;only&nbsp;do&nbsp;this&nbsp;on&nbsp;10.6&nbsp;if&nbsp;we&nbsp;can&nbsp;detect&nbsp;10.6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059413">//&nbsp;cheaply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059428">e1</span>&nbsp;<span class="op" id="4059431">=</span>&nbsp;<span class="ident" id="4059433">syscall</span><span class="op" id="4059440">.</span><span class="ident" id="4059441">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4059450">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059454">switch</span>&nbsp;<span class="ident" id="4059461">e1</span>&nbsp;<span class="op" id="4059464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059468">case</span>&nbsp;<span class="num" id="4059473">0</span><span class="op" id="4059474">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059479">return</span>&nbsp;<span class="builtintype" id="4059486">int</span><span class="op" id="4059489">(</span><span class="ident" id="4059490">r0</span><span class="op" id="4059492">)</span><span class="op" id="4059493">,</span>&nbsp;<span class="ident" id="4059495">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059501">case</span>&nbsp;<span class="ident" id="4059506">syscall</span><span class="op" id="4059513">.</span><span class="ident" id="4059514">EINVAL</span><span class="op" id="4059520">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059525">//&nbsp;Old&nbsp;kernel.&nbsp;Fall&nbsp;back&nbsp;to&nbsp;the&nbsp;portable&nbsp;way</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059573">//&nbsp;from&nbsp;now&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059592">atomic</span><span class="op" id="4059598">.</span><span class="ident" id="4059599">StoreInt32</span><span class="op" id="4059609">(</span><span class="op" id="4059610">&amp;</span><span class="ident" id="4059611">tryDupCloexec</span><span class="op" id="4059624">,</span>&nbsp;<span class="num" id="4059626">0</span><span class="op" id="4059627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059631">default</span><span class="op" id="4059638">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059643">return</span>&nbsp;<span class="op" id="4059650">-</span><span class="num" id="4059651">1</span><span class="op" id="4059652">,</span>&nbsp;<span class="ident" id="4059654">e1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4059659">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4059662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059665">return</span>&nbsp;<span class="ident" id="4059672">dupCloseOnExecOld</span><span class="op" id="4059689">(</span><span class="ident" id="4059690">fd</span><span class="op" id="4059692">)</span><br>
<span class="lineno"></span><span class="op" id="4059694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4059697">//&nbsp;dupCloseOnExecUnixOld&nbsp;is&nbsp;the&nbsp;traditional&nbsp;way&nbsp;to&nbsp;dup&nbsp;an&nbsp;fd&nbsp;and</span><br>
<span class="lineno">480</span><span class="comment" id="4059762">//&nbsp;set&nbsp;its&nbsp;O_CLOEXEC&nbsp;bit,&nbsp;using&nbsp;two&nbsp;system&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="4059812">func</span>&nbsp;<span class="ident" id="4059817">dupCloseOnExecOld</span><span class="op" id="4059834">(</span><span class="ident" id="4059835">fd</span>&nbsp;<span class="builtintype" id="4059838">int</span><span class="op" id="4059841">)</span>&nbsp;<span class="op" id="4059843">(</span><span class="ident" id="4059844">newfd</span>&nbsp;<span class="builtintype" id="4059850">int</span><span class="op" id="4059853">,</span>&nbsp;<span class="ident" id="4059855">err</span>&nbsp;<span class="builtintype" id="4059859">error</span><span class="op" id="4059864">)</span>&nbsp;<span class="op" id="4059866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059869">syscall</span><span class="op" id="4059876">.</span><span class="ident" id="4059877">ForkLock</span><span class="op" id="4059885">.</span><span class="ident" id="4059886">RLock</span><span class="op" id="4059891">(</span><span class="op" id="4059892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059895">defer</span>&nbsp;<span class="ident" id="4059901">syscall</span><span class="op" id="4059908">.</span><span class="ident" id="4059909">ForkLock</span><span class="op" id="4059917">.</span><span class="ident" id="4059918">RUnlock</span><span class="op" id="4059925">(</span><span class="op" id="4059926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059929">newfd</span><span class="op" id="4059934">,</span>&nbsp;<span class="ident" id="4059936">err</span>&nbsp;<span class="op" id="4059940">=</span>&nbsp;<span class="ident" id="4059942">syscall</span><span class="op" id="4059949">.</span><span class="ident" id="4059950">Dup</span><span class="op" id="4059953">(</span><span class="ident" id="4059954">fd</span><span class="op" id="4059956">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059959">if</span>&nbsp;<span class="ident" id="4059962">err</span>&nbsp;<span class="op" id="4059966">!=</span>&nbsp;<span class="ident" id="4059969">nil</span>&nbsp;<span class="op" id="4059973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059977">return</span>&nbsp;<span class="op" id="4059984">-</span><span class="num" id="4059985">1</span><span class="op" id="4059986">,</span>&nbsp;<span class="ident" id="4059988">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4059993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059996">syscall</span><span class="op" id="4060003">.</span><span class="ident" id="4060004">CloseOnExec</span><span class="op" id="4060015">(</span><span class="ident" id="4060016">newfd</span><span class="op" id="4060021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060024">return</span><br>
<span class="lineno">490</span><span class="op" id="4060031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4060034">func</span>&nbsp;<span class="op" id="4060039">(</span><span class="ident" id="4060040">fd</span>&nbsp;<span class="op" id="4060043">*</span><span class="ident" id="4060044">netFD</span><span class="op" id="4060049">)</span>&nbsp;<span class="ident" id="4060051">dup</span><span class="op" id="4060054">(</span><span class="op" id="4060055">)</span>&nbsp;<span class="op" id="4060057">(</span><span class="ident" id="4060058">f</span>&nbsp;<span class="op" id="4060060">*</span><span class="ident" id="4060061">os</span><span class="op" id="4060063">.</span><span class="ident" id="4060064">File</span><span class="op" id="4060068">,</span>&nbsp;<span class="ident" id="4060070">err</span>&nbsp;<span class="builtintype" id="4060074">error</span><span class="op" id="4060079">)</span>&nbsp;<span class="op" id="4060081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060084">ns</span><span class="op" id="4060086">,</span>&nbsp;<span class="ident" id="4060088">err</span>&nbsp;<span class="op" id="4060092">:=</span>&nbsp;<span class="ident" id="4060095">dupCloseOnExec</span><span class="op" id="4060109">(</span><span class="ident" id="4060110">fd</span><span class="op" id="4060112">.</span><span class="ident" id="4060113">sysfd</span><span class="op" id="4060118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060121">if</span>&nbsp;<span class="ident" id="4060124">err</span>&nbsp;<span class="op" id="4060128">!=</span>&nbsp;<span class="ident" id="4060131">nil</span>&nbsp;<span class="op" id="4060135">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060139">return</span>&nbsp;<span class="ident" id="4060146">nil</span><span class="op" id="4060149">,</span>&nbsp;<span class="op" id="4060151">&amp;</span><span class="ident" id="4060152">OpError</span><span class="op" id="4060159">{</span><span class="string" id="4060160">&#34;dup&#34;</span><span class="op" id="4060165">,</span>&nbsp;<span class="ident" id="4060167">fd</span><span class="op" id="4060169">.</span><span class="ident" id="4060170">net</span><span class="op" id="4060173">,</span>&nbsp;<span class="ident" id="4060175">fd</span><span class="op" id="4060177">.</span><span class="ident" id="4060178">laddr</span><span class="op" id="4060183">,</span>&nbsp;<span class="ident" id="4060185">err</span><span class="op" id="4060188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4060191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4060195">//&nbsp;We&nbsp;want&nbsp;blocking&nbsp;mode&nbsp;for&nbsp;the&nbsp;new&nbsp;fd,&nbsp;hence&nbsp;the&nbsp;double&nbsp;negative.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4060264">//&nbsp;This&nbsp;also&nbsp;puts&nbsp;the&nbsp;old&nbsp;fd&nbsp;into&nbsp;blocking&nbsp;mode,&nbsp;meaning&nbsp;that</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4060327">//&nbsp;I/O&nbsp;will&nbsp;block&nbsp;the&nbsp;thread&nbsp;instead&nbsp;of&nbsp;letting&nbsp;us&nbsp;use&nbsp;the&nbsp;epoll&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4060401">//&nbsp;Everything&nbsp;will&nbsp;still&nbsp;work,&nbsp;just&nbsp;with&nbsp;more&nbsp;threads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060457">if</span>&nbsp;<span class="ident" id="4060460">err</span>&nbsp;<span class="op" id="4060464">=</span>&nbsp;<span class="ident" id="4060466">syscall</span><span class="op" id="4060473">.</span><span class="ident" id="4060474">SetNonblock</span><span class="op" id="4060485">(</span><span class="ident" id="4060486">ns</span><span class="op" id="4060488">,</span>&nbsp;<span class="builtintype" id="4060490">false</span><span class="op" id="4060495">)</span><span class="op" id="4060496">;</span>&nbsp;<span class="ident" id="4060498">err</span>&nbsp;<span class="op" id="4060502">!=</span>&nbsp;<span class="ident" id="4060505">nil</span>&nbsp;<span class="op" id="4060509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060513">return</span>&nbsp;<span class="ident" id="4060520">nil</span><span class="op" id="4060523">,</span>&nbsp;<span class="op" id="4060525">&amp;</span><span class="ident" id="4060526">OpError</span><span class="op" id="4060533">{</span><span class="string" id="4060534">&#34;setnonblock&#34;</span><span class="op" id="4060547">,</span>&nbsp;<span class="ident" id="4060549">fd</span><span class="op" id="4060551">.</span><span class="ident" id="4060552">net</span><span class="op" id="4060555">,</span>&nbsp;<span class="ident" id="4060557">fd</span><span class="op" id="4060559">.</span><span class="ident" id="4060560">laddr</span><span class="op" id="4060565">,</span>&nbsp;<span class="ident" id="4060567">err</span><span class="op" id="4060570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4060573">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060577">return</span>&nbsp;<span class="ident" id="4060584">os</span><span class="op" id="4060586">.</span><span class="ident" id="4060587">NewFile</span><span class="op" id="4060594">(</span><span class="builtintype" id="4060595">uintptr</span><span class="op" id="4060602">(</span><span class="ident" id="4060603">ns</span><span class="op" id="4060605">)</span><span class="op" id="4060606">,</span>&nbsp;<span class="ident" id="4060608">fd</span><span class="op" id="4060610">.</span><span class="ident" id="4060611">name</span><span class="op" id="4060615">(</span><span class="op" id="4060616">)</span><span class="op" id="4060617">)</span><span class="op" id="4060618">,</span>&nbsp;<span class="ident" id="4060620">nil</span><br>
<span class="lineno"></span><span class="op" id="4060624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4060627">func</span>&nbsp;<span class="ident" id="4060632">closesocket</span><span class="op" id="4060643">(</span><span class="ident" id="4060644">s</span>&nbsp;<span class="builtintype" id="4060646">int</span><span class="op" id="4060649">)</span>&nbsp;<span class="builtintype" id="4060651">error</span>&nbsp;<span class="op" id="4060657">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060660">return</span>&nbsp;<span class="ident" id="4060667">syscall</span><span class="op" id="4060674">.</span><span class="ident" id="4060675">Close</span><span class="op" id="4060680">(</span><span class="ident" id="4060681">s</span><span class="op" id="4060682">)</span><br>
<span class="lineno"></span><span class="op" id="4060684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4060687">func</span>&nbsp;<span class="ident" id="4060692">skipRawSocketTests</span><span class="op" id="4060710">(</span><span class="op" id="4060711">)</span>&nbsp;<span class="op" id="4060713">(</span><span class="ident" id="4060714">skip</span>&nbsp;<span class="builtintype" id="4060719">bool</span><span class="op" id="4060723">,</span>&nbsp;<span class="ident" id="4060725">skipmsg</span>&nbsp;<span class="builtintype" id="4060733">string</span><span class="op" id="4060739">,</span>&nbsp;<span class="ident" id="4060741">err</span>&nbsp;<span class="builtintype" id="4060745">error</span><span class="op" id="4060750">)</span>&nbsp;<span class="op" id="4060752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060755">if</span>&nbsp;<span class="ident" id="4060758">os</span><span class="op" id="4060760">.</span><span class="ident" id="4060761">Getuid</span><span class="op" id="4060767">(</span><span class="op" id="4060768">)</span>&nbsp;<span class="op" id="4060770">!=</span>&nbsp;<span class="num" id="4060773">0</span>&nbsp;<span class="op" id="4060775">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060779">return</span>&nbsp;<span class="builtintype" id="4060786">true</span><span class="op" id="4060790">,</span>&nbsp;<span class="string" id="4060792">&#34;skipping&nbsp;test;&nbsp;must&nbsp;be&nbsp;root&#34;</span><span class="op" id="4060821">,</span>&nbsp;<span class="ident" id="4060823">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4060828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060831">return</span>&nbsp;<span class="builtintype" id="4060838">false</span><span class="op" id="4060843">,</span>&nbsp;<span class="string" id="4060845">&#34;&#34;</span><span class="op" id="4060847">,</span>&nbsp;<span class="ident" id="4060849">nil</span><br>
<span class="lineno"></span><span class="op" id="4060853">}</span>
</div>
</body>
</html>
