<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1969678">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1969733">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1969787">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1969838">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1969916">package</span>&nbsp;<span class="ident" id="1969924">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1969933">import</span>&nbsp;<span class="string" id="1969940">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1969950">//&nbsp;Integrated&nbsp;network&nbsp;poller&nbsp;(platform-independent&nbsp;part).</span><br>
<span class="lineno"></span><span class="comment" id="1970008">//&nbsp;A&nbsp;particular&nbsp;implementation&nbsp;(epoll/kqueue)&nbsp;must&nbsp;define&nbsp;the&nbsp;following&nbsp;functions:</span><br>
<span class="lineno"></span><span class="comment" id="1970091">//&nbsp;func&nbsp;netpollinit()&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;to&nbsp;initialize&nbsp;the&nbsp;poller</span><br>
<span class="lineno"></span><span class="comment" id="1970143">//&nbsp;func&nbsp;netpollopen(fd&nbsp;uintptr,&nbsp;pd&nbsp;*pollDesc)&nbsp;int32&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;to&nbsp;arm&nbsp;edge-triggered&nbsp;notifications</span><br>
<span class="lineno">15</span><span class="comment" id="1970234">//&nbsp;and&nbsp;associate&nbsp;fd&nbsp;with&nbsp;pd.</span><br>
<span class="lineno"></span><span class="comment" id="1970263">//&nbsp;An&nbsp;implementation&nbsp;must&nbsp;call&nbsp;the&nbsp;following&nbsp;function&nbsp;to&nbsp;denote&nbsp;that&nbsp;the&nbsp;pd&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="comment" id="1970349">//&nbsp;func&nbsp;netpollready(gpp&nbsp;**g,&nbsp;pd&nbsp;*pollDesc,&nbsp;mode&nbsp;int32)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1970406">//&nbsp;pollDesc&nbsp;contains&nbsp;2&nbsp;binary&nbsp;semaphores,&nbsp;rg&nbsp;and&nbsp;wg,&nbsp;to&nbsp;park&nbsp;reader&nbsp;and&nbsp;writer</span><br>
<span class="lineno">20</span><span class="comment" id="1970485">//&nbsp;goroutines&nbsp;respectively.&nbsp;The&nbsp;semaphore&nbsp;can&nbsp;be&nbsp;in&nbsp;the&nbsp;following&nbsp;states:</span><br>
<span class="lineno"></span><span class="comment" id="1970559">//&nbsp;pdReady&nbsp;-&nbsp;io&nbsp;readiness&nbsp;notification&nbsp;is&nbsp;pending;</span><br>
<span class="lineno"></span><span class="comment" id="1970610">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;goroutine&nbsp;consumes&nbsp;the&nbsp;notification&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1970691">//&nbsp;pdWait&nbsp;-&nbsp;a&nbsp;goroutine&nbsp;prepares&nbsp;to&nbsp;park&nbsp;on&nbsp;the&nbsp;semaphore,&nbsp;but&nbsp;not&nbsp;yet&nbsp;parked;</span><br>
<span class="lineno"></span><span class="comment" id="1970770">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;goroutine&nbsp;commits&nbsp;to&nbsp;park&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;G&nbsp;pointer,</span><br>
<span class="lineno">25</span><span class="comment" id="1970848">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;io&nbsp;notification&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY,</span><br>
<span class="lineno"></span><span class="comment" id="1970934">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1971016">//&nbsp;G&nbsp;pointer&nbsp;-&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;blocked&nbsp;on&nbsp;the&nbsp;semaphore;</span><br>
<span class="lineno"></span><span class="comment" id="1971074">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io&nbsp;notification&nbsp;or&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY&nbsp;or&nbsp;nil&nbsp;respectively</span><br>
<span class="lineno"></span><span class="comment" id="1971169">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;unparks&nbsp;the&nbsp;goroutine.</span><br>
<span class="lineno">30</span><span class="comment" id="1971211">//&nbsp;nil&nbsp;-&nbsp;nothing&nbsp;of&nbsp;the&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="1971242">const</span>&nbsp;<span class="op" id="1971248">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1971251">pdReady</span>&nbsp;<span class="builtintype" id="1971259">uintptr</span>&nbsp;<span class="op" id="1971267">=</span>&nbsp;<span class="num" id="1971269">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1971272">pdWait</span>&nbsp;&nbsp;<span class="builtintype" id="1971280">uintptr</span>&nbsp;<span class="op" id="1971288">=</span>&nbsp;<span class="num" id="1971290">2</span><br>
<span class="lineno"></span><span class="op" id="1971292">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1971295">const</span>&nbsp;<span class="ident" id="1971301">pollBlockSize</span>&nbsp;<span class="op" id="1971315">=</span>&nbsp;<span class="num" id="1971317">4</span>&nbsp;<span class="op" id="1971319">*</span>&nbsp;<span class="num" id="1971321">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1971327">//&nbsp;Network&nbsp;poller&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="1971357">type</span>&nbsp;<span class="ident" id="1971362">pollDesc</span>&nbsp;<span class="keyword" id="1971371">struct</span>&nbsp;<span class="op" id="1971378">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1971381">link</span>&nbsp;<span class="op" id="1971386">*</span><span class="ident" id="1971387">pollDesc</span>&nbsp;<span class="comment" id="1971396">//&nbsp;in&nbsp;pollcache,&nbsp;protected&nbsp;by&nbsp;pollcache.lock</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1971443">//&nbsp;The&nbsp;lock&nbsp;protects&nbsp;pollOpen,&nbsp;pollSetDeadline,&nbsp;pollUnblock&nbsp;and&nbsp;deadlineimpl&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1971533">//&nbsp;This&nbsp;fully&nbsp;covers&nbsp;seq,&nbsp;rt&nbsp;and&nbsp;wt&nbsp;variables.&nbsp;fd&nbsp;is&nbsp;constant&nbsp;throughout&nbsp;the&nbsp;PollDesc&nbsp;lifetime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1971630">//&nbsp;pollReset,&nbsp;pollWait,&nbsp;pollWaitCanceled&nbsp;and&nbsp;runtimeÂ·netpollready&nbsp;(IO&nbsp;readiness&nbsp;notification)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1971726">//&nbsp;proceed&nbsp;w/o&nbsp;taking&nbsp;the&nbsp;lock.&nbsp;So&nbsp;closing,&nbsp;rg,&nbsp;rd,&nbsp;wg&nbsp;and&nbsp;wd&nbsp;are&nbsp;manipulated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1971805">//&nbsp;in&nbsp;a&nbsp;lock-free&nbsp;way&nbsp;by&nbsp;all&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1971847">//&nbsp;NOTE(dvyukov):&nbsp;the&nbsp;following&nbsp;code&nbsp;uses&nbsp;uintptr&nbsp;to&nbsp;store&nbsp;*g&nbsp;(rg/wg),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1971919">//&nbsp;that&nbsp;will&nbsp;blow&nbsp;up&nbsp;when&nbsp;GC&nbsp;starts&nbsp;moving&nbsp;objects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1971972">lock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1971980">mutex</span>&nbsp;<span class="comment" id="1971986">//&nbsp;protectes&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1972021">fd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1972029">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1972038">closing</span>&nbsp;<span class="builtintype" id="1972046">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1972052">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1972060">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1972075">//&nbsp;protects&nbsp;from&nbsp;stale&nbsp;timers&nbsp;and&nbsp;ready&nbsp;notifications</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1972130">rg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1972138">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1972153">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;read&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1972200">rt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1972208">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1972223">//&nbsp;read&nbsp;deadline&nbsp;timer&nbsp;(set&nbsp;if&nbsp;rt.f&nbsp;!=&nbsp;nil)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1972268">rd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1972276">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1972291">//&nbsp;read&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1972309">wg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1972317">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1972332">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;write&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1972380">wt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1972388">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1972403">//&nbsp;write&nbsp;deadline&nbsp;timer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1972428">wd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1972436">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1972451">//&nbsp;write&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1972470">user</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1972478">unsafe</span><span class="op" id="1972484">.</span><span class="ident" id="1972485">Pointer</span>&nbsp;<span class="comment" id="1972493">//&nbsp;user&nbsp;settable&nbsp;cookie</span><br>
<span class="lineno">60</span><span class="op" id="1972517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1972520">type</span>&nbsp;<span class="ident" id="1972525">pollCache</span>&nbsp;<span class="keyword" id="1972535">struct</span>&nbsp;<span class="op" id="1972542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1972545">lock</span>&nbsp;&nbsp;<span class="ident" id="1972551">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1972558">first</span>&nbsp;<span class="op" id="1972564">*</span><span class="ident" id="1972565">pollDesc</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1972575">//&nbsp;PollDesc&nbsp;objects&nbsp;must&nbsp;be&nbsp;type-stable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1972617">//&nbsp;because&nbsp;we&nbsp;can&nbsp;get&nbsp;ready&nbsp;notification&nbsp;from&nbsp;epoll/kqueue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1972677">//&nbsp;after&nbsp;the&nbsp;descriptor&nbsp;is&nbsp;closed/reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1972720">//&nbsp;Stale&nbsp;notifications&nbsp;are&nbsp;detected&nbsp;using&nbsp;seq&nbsp;variable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1972777">//&nbsp;seq&nbsp;is&nbsp;incremented&nbsp;when&nbsp;deadlines&nbsp;are&nbsp;changed&nbsp;or&nbsp;descriptor&nbsp;is&nbsp;reused.</span><br>
<span class="lineno">70</span><span class="op" id="1972851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1972854">var</span>&nbsp;<span class="ident" id="1972858">pollcache</span>&nbsp;<span class="ident" id="1972868">pollCache</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1972879">func</span>&nbsp;<span class="ident" id="1972884">netpollServerInit</span><span class="op" id="1972901">(</span><span class="op" id="1972902">)</span>&nbsp;<span class="op" id="1972904">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1972907">onM</span><span class="op" id="1972910">(</span><span class="ident" id="1972911">netpollinit</span><span class="op" id="1972922">)</span><br>
<span class="lineno"></span><span class="op" id="1972924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1972927">func</span>&nbsp;<span class="ident" id="1972932">netpollOpen</span><span class="op" id="1972943">(</span><span class="ident" id="1972944">fd</span>&nbsp;<span class="builtintype" id="1972947">uintptr</span><span class="op" id="1972954">)</span>&nbsp;<span class="op" id="1972956">(</span><span class="op" id="1972957">*</span><span class="ident" id="1972958">pollDesc</span><span class="op" id="1972966">,</span>&nbsp;<span class="builtintype" id="1972968">int</span><span class="op" id="1972971">)</span>&nbsp;<span class="op" id="1972973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1972976">pd</span>&nbsp;<span class="op" id="1972979">:=</span>&nbsp;<span class="ident" id="1972982">pollcache</span><span class="op" id="1972991">.</span><span class="ident" id="1972992">alloc</span><span class="op" id="1972997">(</span><span class="op" id="1972998">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973001">lock</span><span class="op" id="1973005">(</span><span class="op" id="1973006">&amp;</span><span class="ident" id="1973007">pd</span><span class="op" id="1973009">.</span><span class="ident" id="1973010">lock</span><span class="op" id="1973014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1973017">if</span>&nbsp;<span class="ident" id="1973020">pd</span><span class="op" id="1973022">.</span><span class="ident" id="1973023">wg</span>&nbsp;<span class="op" id="1973026">!=</span>&nbsp;<span class="num" id="1973029">0</span>&nbsp;<span class="op" id="1973031">&amp;&amp;</span>&nbsp;<span class="ident" id="1973034">pd</span><span class="op" id="1973036">.</span><span class="ident" id="1973037">wg</span>&nbsp;<span class="op" id="1973040">!=</span>&nbsp;<span class="ident" id="1973043">pdReady</span>&nbsp;<span class="op" id="1973051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973055">gothrow</span><span class="op" id="1973062">(</span><span class="string" id="1973063">&#34;netpollOpen:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1973110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1973113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1973116">if</span>&nbsp;<span class="ident" id="1973119">pd</span><span class="op" id="1973121">.</span><span class="ident" id="1973122">rg</span>&nbsp;<span class="op" id="1973125">!=</span>&nbsp;<span class="num" id="1973128">0</span>&nbsp;<span class="op" id="1973130">&amp;&amp;</span>&nbsp;<span class="ident" id="1973133">pd</span><span class="op" id="1973135">.</span><span class="ident" id="1973136">rg</span>&nbsp;<span class="op" id="1973139">!=</span>&nbsp;<span class="ident" id="1973142">pdReady</span>&nbsp;<span class="op" id="1973150">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973154">gothrow</span><span class="op" id="1973161">(</span><span class="string" id="1973162">&#34;netpollOpen:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1973208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1973211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973214">pd</span><span class="op" id="1973216">.</span><span class="ident" id="1973217">fd</span>&nbsp;<span class="op" id="1973220">=</span>&nbsp;<span class="ident" id="1973222">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973226">pd</span><span class="op" id="1973228">.</span><span class="ident" id="1973229">closing</span>&nbsp;<span class="op" id="1973237">=</span>&nbsp;<span class="builtintype" id="1973239">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973246">pd</span><span class="op" id="1973248">.</span><span class="ident" id="1973249">seq</span><span class="op" id="1973252">++</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973256">pd</span><span class="op" id="1973258">.</span><span class="ident" id="1973259">rg</span>&nbsp;<span class="op" id="1973262">=</span>&nbsp;<span class="num" id="1973264">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973267">pd</span><span class="op" id="1973269">.</span><span class="ident" id="1973270">rd</span>&nbsp;<span class="op" id="1973273">=</span>&nbsp;<span class="num" id="1973275">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973278">pd</span><span class="op" id="1973280">.</span><span class="ident" id="1973281">wg</span>&nbsp;<span class="op" id="1973284">=</span>&nbsp;<span class="num" id="1973286">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973289">pd</span><span class="op" id="1973291">.</span><span class="ident" id="1973292">wd</span>&nbsp;<span class="op" id="1973295">=</span>&nbsp;<span class="num" id="1973297">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973300">unlock</span><span class="op" id="1973306">(</span><span class="op" id="1973307">&amp;</span><span class="ident" id="1973308">pd</span><span class="op" id="1973310">.</span><span class="ident" id="1973311">lock</span><span class="op" id="1973315">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1973319">var</span>&nbsp;<span class="ident" id="1973323">errno</span>&nbsp;<span class="builtintype" id="1973329">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973336">onM</span><span class="op" id="1973339">(</span><span class="keyword" id="1973340">func</span><span class="op" id="1973344">(</span><span class="op" id="1973345">)</span>&nbsp;<span class="op" id="1973347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973351">errno</span>&nbsp;<span class="op" id="1973357">=</span>&nbsp;<span class="ident" id="1973359">netpollopen</span><span class="op" id="1973370">(</span><span class="ident" id="1973371">fd</span><span class="op" id="1973373">,</span>&nbsp;<span class="ident" id="1973375">pd</span><span class="op" id="1973377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1973380">}</span><span class="op" id="1973381">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1973384">return</span>&nbsp;<span class="ident" id="1973391">pd</span><span class="op" id="1973393">,</span>&nbsp;<span class="builtintype" id="1973395">int</span><span class="op" id="1973398">(</span><span class="ident" id="1973399">errno</span><span class="op" id="1973404">)</span><br>
<span class="lineno"></span><span class="op" id="1973406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1973409">func</span>&nbsp;<span class="ident" id="1973414">netpollClose</span><span class="op" id="1973426">(</span><span class="ident" id="1973427">pd</span>&nbsp;<span class="op" id="1973430">*</span><span class="ident" id="1973431">pollDesc</span><span class="op" id="1973439">)</span>&nbsp;<span class="op" id="1973441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1973444">if</span>&nbsp;<span class="op" id="1973447">!</span><span class="ident" id="1973448">pd</span><span class="op" id="1973450">.</span><span class="ident" id="1973451">closing</span>&nbsp;<span class="op" id="1973459">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973463">gothrow</span><span class="op" id="1973470">(</span><span class="string" id="1973471">&#34;netpollClose:&nbsp;close&nbsp;w/o&nbsp;unblock&#34;</span><span class="op" id="1973504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1973507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1973510">if</span>&nbsp;<span class="ident" id="1973513">pd</span><span class="op" id="1973515">.</span><span class="ident" id="1973516">wg</span>&nbsp;<span class="op" id="1973519">!=</span>&nbsp;<span class="num" id="1973522">0</span>&nbsp;<span class="op" id="1973524">&amp;&amp;</span>&nbsp;<span class="ident" id="1973527">pd</span><span class="op" id="1973529">.</span><span class="ident" id="1973530">wg</span>&nbsp;<span class="op" id="1973533">!=</span>&nbsp;<span class="ident" id="1973536">pdReady</span>&nbsp;<span class="op" id="1973544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973548">gothrow</span><span class="op" id="1973555">(</span><span class="string" id="1973556">&#34;netpollClose:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1973607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1973610">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1973613">if</span>&nbsp;<span class="ident" id="1973616">pd</span><span class="op" id="1973618">.</span><span class="ident" id="1973619">rg</span>&nbsp;<span class="op" id="1973622">!=</span>&nbsp;<span class="num" id="1973625">0</span>&nbsp;<span class="op" id="1973627">&amp;&amp;</span>&nbsp;<span class="ident" id="1973630">pd</span><span class="op" id="1973632">.</span><span class="ident" id="1973633">rg</span>&nbsp;<span class="op" id="1973636">!=</span>&nbsp;<span class="ident" id="1973639">pdReady</span>&nbsp;<span class="op" id="1973647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973651">gothrow</span><span class="op" id="1973658">(</span><span class="string" id="1973659">&#34;netpollClose:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1973709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1973712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973715">onM</span><span class="op" id="1973718">(</span><span class="keyword" id="1973719">func</span><span class="op" id="1973723">(</span><span class="op" id="1973724">)</span>&nbsp;<span class="op" id="1973726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973730">netpollclose</span><span class="op" id="1973742">(</span><span class="builtintype" id="1973743">uintptr</span><span class="op" id="1973750">(</span><span class="ident" id="1973751">pd</span><span class="op" id="1973753">.</span><span class="ident" id="1973754">fd</span><span class="op" id="1973756">)</span><span class="op" id="1973757">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1973760">}</span><span class="op" id="1973761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973764">pollcache</span><span class="op" id="1973773">.</span><span class="ident" id="1973774">free</span><span class="op" id="1973778">(</span><span class="ident" id="1973779">pd</span><span class="op" id="1973781">)</span><br>
<span class="lineno"></span><span class="op" id="1973783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1973786">func</span>&nbsp;<span class="op" id="1973791">(</span><span class="ident" id="1973792">c</span>&nbsp;<span class="op" id="1973794">*</span><span class="ident" id="1973795">pollCache</span><span class="op" id="1973804">)</span>&nbsp;<span class="ident" id="1973806">free</span><span class="op" id="1973810">(</span><span class="ident" id="1973811">pd</span>&nbsp;<span class="op" id="1973814">*</span><span class="ident" id="1973815">pollDesc</span><span class="op" id="1973823">)</span>&nbsp;<span class="op" id="1973825">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973828">lock</span><span class="op" id="1973832">(</span><span class="op" id="1973833">&amp;</span><span class="ident" id="1973834">c</span><span class="op" id="1973835">.</span><span class="ident" id="1973836">lock</span><span class="op" id="1973840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973843">pd</span><span class="op" id="1973845">.</span><span class="ident" id="1973846">link</span>&nbsp;<span class="op" id="1973851">=</span>&nbsp;<span class="ident" id="1973853">c</span><span class="op" id="1973854">.</span><span class="ident" id="1973855">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973862">c</span><span class="op" id="1973863">.</span><span class="ident" id="1973864">first</span>&nbsp;<span class="op" id="1973870">=</span>&nbsp;<span class="ident" id="1973872">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973876">unlock</span><span class="op" id="1973882">(</span><span class="op" id="1973883">&amp;</span><span class="ident" id="1973884">c</span><span class="op" id="1973885">.</span><span class="ident" id="1973886">lock</span><span class="op" id="1973890">)</span><br>
<span class="lineno"></span><span class="op" id="1973892">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="1973895">func</span>&nbsp;<span class="ident" id="1973900">netpollReset</span><span class="op" id="1973912">(</span><span class="ident" id="1973913">pd</span>&nbsp;<span class="op" id="1973916">*</span><span class="ident" id="1973917">pollDesc</span><span class="op" id="1973925">,</span>&nbsp;<span class="ident" id="1973927">mode</span>&nbsp;<span class="builtintype" id="1973932">int</span><span class="op" id="1973935">)</span>&nbsp;<span class="builtintype" id="1973937">int</span>&nbsp;<span class="op" id="1973941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1973944">err</span>&nbsp;<span class="op" id="1973948">:=</span>&nbsp;<span class="ident" id="1973951">netpollcheckerr</span><span class="op" id="1973966">(</span><span class="ident" id="1973967">pd</span><span class="op" id="1973969">,</span>&nbsp;<span class="builtintype" id="1973971">int32</span><span class="op" id="1973976">(</span><span class="ident" id="1973977">mode</span><span class="op" id="1973981">)</span><span class="op" id="1973982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1973985">if</span>&nbsp;<span class="ident" id="1973988">err</span>&nbsp;<span class="op" id="1973992">!=</span>&nbsp;<span class="num" id="1973995">0</span>&nbsp;<span class="op" id="1973997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1974001">return</span>&nbsp;<span class="ident" id="1974008">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1974013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1974016">if</span>&nbsp;<span class="ident" id="1974019">mode</span>&nbsp;<span class="op" id="1974024">==</span>&nbsp;<span class="string" id="1974027">&#39;r&#39;</span>&nbsp;<span class="op" id="1974031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1974035">pd</span><span class="op" id="1974037">.</span><span class="ident" id="1974038">rg</span>&nbsp;<span class="op" id="1974041">=</span>&nbsp;<span class="num" id="1974043">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1974046">}</span>&nbsp;<span class="keyword" id="1974048">else</span>&nbsp;<span class="keyword" id="1974053">if</span>&nbsp;<span class="ident" id="1974056">mode</span>&nbsp;<span class="op" id="1974061">==</span>&nbsp;<span class="string" id="1974064">&#39;w&#39;</span>&nbsp;<span class="op" id="1974068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1974072">pd</span><span class="op" id="1974074">.</span><span class="ident" id="1974075">wg</span>&nbsp;<span class="op" id="1974078">=</span>&nbsp;<span class="num" id="1974080">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1974083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1974086">return</span>&nbsp;<span class="num" id="1974093">0</span><br>
<span class="lineno"></span><span class="op" id="1974095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1974098">func</span>&nbsp;<span class="ident" id="1974103">netpollWait</span><span class="op" id="1974114">(</span><span class="ident" id="1974115">pd</span>&nbsp;<span class="op" id="1974118">*</span><span class="ident" id="1974119">pollDesc</span><span class="op" id="1974127">,</span>&nbsp;<span class="ident" id="1974129">mode</span>&nbsp;<span class="builtintype" id="1974134">int</span><span class="op" id="1974137">)</span>&nbsp;<span class="builtintype" id="1974139">int</span>&nbsp;<span class="op" id="1974143">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1974146">err</span>&nbsp;<span class="op" id="1974150">:=</span>&nbsp;<span class="ident" id="1974153">netpollcheckerr</span><span class="op" id="1974168">(</span><span class="ident" id="1974169">pd</span><span class="op" id="1974171">,</span>&nbsp;<span class="builtintype" id="1974173">int32</span><span class="op" id="1974178">(</span><span class="ident" id="1974179">mode</span><span class="op" id="1974183">)</span><span class="op" id="1974184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1974187">if</span>&nbsp;<span class="ident" id="1974190">err</span>&nbsp;<span class="op" id="1974194">!=</span>&nbsp;<span class="num" id="1974197">0</span>&nbsp;<span class="op" id="1974199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1974203">return</span>&nbsp;<span class="ident" id="1974210">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1974215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1974218">//&nbsp;As&nbsp;for&nbsp;now&nbsp;only&nbsp;Solaris&nbsp;uses&nbsp;level-triggered&nbsp;IO.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1974271">if</span>&nbsp;<span class="ident" id="1974274">GOOS</span>&nbsp;<span class="op" id="1974279">==</span>&nbsp;<span class="string" id="1974282">&#34;solaris&#34;</span>&nbsp;<span class="op" id="1974292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1974296">onM</span><span class="op" id="1974299">(</span><span class="keyword" id="1974300">func</span><span class="op" id="1974304">(</span><span class="op" id="1974305">)</span>&nbsp;<span class="op" id="1974307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1974312">netpollarm</span><span class="op" id="1974322">(</span><span class="ident" id="1974323">pd</span><span class="op" id="1974325">,</span>&nbsp;<span class="ident" id="1974327">mode</span><span class="op" id="1974331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1974335">}</span><span class="op" id="1974336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1974339">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1974342">for</span>&nbsp;<span class="op" id="1974346">!</span><span class="ident" id="1974347">netpollblock</span><span class="op" id="1974359">(</span><span class="ident" id="1974360">pd</span><span class="op" id="1974362">,</span>&nbsp;<span class="builtintype" id="1974364">int32</span><span class="op" id="1974369">(</span><span class="ident" id="1974370">mode</span><span class="op" id="1974374">)</span><span class="op" id="1974375">,</span>&nbsp;<span class="builtintype" id="1974377">false</span><span class="op" id="1974382">)</span>&nbsp;<span class="op" id="1974384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1974388">err</span>&nbsp;<span class="op" id="1974392">=</span>&nbsp;<span class="ident" id="1974394">netpollcheckerr</span><span class="op" id="1974409">(</span><span class="ident" id="1974410">pd</span><span class="op" id="1974412">,</span>&nbsp;<span class="builtintype" id="1974414">int32</span><span class="op" id="1974419">(</span><span class="ident" id="1974420">mode</span><span class="op" id="1974424">)</span><span class="op" id="1974425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1974429">if</span>&nbsp;<span class="ident" id="1974432">err</span>&nbsp;<span class="op" id="1974436">!=</span>&nbsp;<span class="num" id="1974439">0</span>&nbsp;<span class="op" id="1974441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1974446">return</span>&nbsp;<span class="ident" id="1974453">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1974459">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1974463">//&nbsp;Can&nbsp;happen&nbsp;if&nbsp;timeout&nbsp;has&nbsp;fired&nbsp;and&nbsp;unblocked&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1974518">//&nbsp;but&nbsp;before&nbsp;we&nbsp;had&nbsp;a&nbsp;chance&nbsp;to&nbsp;run,&nbsp;timeout&nbsp;has&nbsp;been&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1974582">//&nbsp;Pretend&nbsp;it&nbsp;has&nbsp;not&nbsp;happened&nbsp;and&nbsp;retry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1974625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1974628">return</span>&nbsp;<span class="num" id="1974635">0</span><br>
<span class="lineno">160</span><span class="op" id="1974637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1974640">func</span>&nbsp;<span class="ident" id="1974645">netpollWaitCanceled</span><span class="op" id="1974664">(</span><span class="ident" id="1974665">pd</span>&nbsp;<span class="op" id="1974668">*</span><span class="ident" id="1974669">pollDesc</span><span class="op" id="1974677">,</span>&nbsp;<span class="ident" id="1974679">mode</span>&nbsp;<span class="builtintype" id="1974684">int</span><span class="op" id="1974687">)</span>&nbsp;<span class="op" id="1974689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1974692">//&nbsp;This&nbsp;function&nbsp;is&nbsp;used&nbsp;only&nbsp;on&nbsp;windows&nbsp;after&nbsp;a&nbsp;failed&nbsp;attempt&nbsp;to&nbsp;cancel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1974767">//&nbsp;a&nbsp;pending&nbsp;async&nbsp;IO&nbsp;operation.&nbsp;Wait&nbsp;for&nbsp;ioready,&nbsp;ignore&nbsp;closing&nbsp;or&nbsp;timeouts.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1974847">for</span>&nbsp;<span class="op" id="1974851">!</span><span class="ident" id="1974852">netpollblock</span><span class="op" id="1974864">(</span><span class="ident" id="1974865">pd</span><span class="op" id="1974867">,</span>&nbsp;<span class="builtintype" id="1974869">int32</span><span class="op" id="1974874">(</span><span class="ident" id="1974875">mode</span><span class="op" id="1974879">)</span><span class="op" id="1974880">,</span>&nbsp;<span class="builtintype" id="1974882">true</span><span class="op" id="1974886">)</span>&nbsp;<span class="op" id="1974888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1974891">}</span><br>
<span class="lineno"></span><span class="op" id="1974893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1974896">func</span>&nbsp;<span class="ident" id="1974901">netpollSetDeadline</span><span class="op" id="1974919">(</span><span class="ident" id="1974920">pd</span>&nbsp;<span class="op" id="1974923">*</span><span class="ident" id="1974924">pollDesc</span><span class="op" id="1974932">,</span>&nbsp;<span class="ident" id="1974934">d</span>&nbsp;<span class="ident" id="1974936">int64</span><span class="op" id="1974941">,</span>&nbsp;<span class="ident" id="1974943">mode</span>&nbsp;<span class="builtintype" id="1974948">int</span><span class="op" id="1974951">)</span>&nbsp;<span class="op" id="1974953">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1974956">lock</span><span class="op" id="1974960">(</span><span class="op" id="1974961">&amp;</span><span class="ident" id="1974962">pd</span><span class="op" id="1974964">.</span><span class="ident" id="1974965">lock</span><span class="op" id="1974969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1974972">if</span>&nbsp;<span class="ident" id="1974975">pd</span><span class="op" id="1974977">.</span><span class="ident" id="1974978">closing</span>&nbsp;<span class="op" id="1974986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1974990">unlock</span><span class="op" id="1974996">(</span><span class="op" id="1974997">&amp;</span><span class="ident" id="1974998">pd</span><span class="op" id="1975000">.</span><span class="ident" id="1975001">lock</span><span class="op" id="1975005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1975009">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1975017">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975020">pd</span><span class="op" id="1975022">.</span><span class="ident" id="1975023">seq</span><span class="op" id="1975026">++</span>&nbsp;<span class="comment" id="1975029">//&nbsp;invalidate&nbsp;current&nbsp;timers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1975059">//&nbsp;Reset&nbsp;current&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1975085">if</span>&nbsp;<span class="ident" id="1975088">pd</span><span class="op" id="1975090">.</span><span class="ident" id="1975091">rt</span><span class="op" id="1975093">.</span><span class="ident" id="1975094">f</span>&nbsp;<span class="op" id="1975096">!=</span>&nbsp;<span class="ident" id="1975099">nil</span>&nbsp;<span class="op" id="1975103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975107">deltimer</span><span class="op" id="1975115">(</span><span class="op" id="1975116">&amp;</span><span class="ident" id="1975117">pd</span><span class="op" id="1975119">.</span><span class="ident" id="1975120">rt</span><span class="op" id="1975122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975126">pd</span><span class="op" id="1975128">.</span><span class="ident" id="1975129">rt</span><span class="op" id="1975131">.</span><span class="ident" id="1975132">f</span>&nbsp;<span class="op" id="1975134">=</span>&nbsp;<span class="ident" id="1975136">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1975141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1975144">if</span>&nbsp;<span class="ident" id="1975147">pd</span><span class="op" id="1975149">.</span><span class="ident" id="1975150">wt</span><span class="op" id="1975152">.</span><span class="ident" id="1975153">f</span>&nbsp;<span class="op" id="1975155">!=</span>&nbsp;<span class="ident" id="1975158">nil</span>&nbsp;<span class="op" id="1975162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975166">deltimer</span><span class="op" id="1975174">(</span><span class="op" id="1975175">&amp;</span><span class="ident" id="1975176">pd</span><span class="op" id="1975178">.</span><span class="ident" id="1975179">wt</span><span class="op" id="1975181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975185">pd</span><span class="op" id="1975187">.</span><span class="ident" id="1975188">wt</span><span class="op" id="1975190">.</span><span class="ident" id="1975191">f</span>&nbsp;<span class="op" id="1975193">=</span>&nbsp;<span class="ident" id="1975195">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1975200">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1975203">//&nbsp;Setup&nbsp;new&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1975225">if</span>&nbsp;<span class="ident" id="1975228">d</span>&nbsp;<span class="op" id="1975230">!=</span>&nbsp;<span class="num" id="1975233">0</span>&nbsp;<span class="op" id="1975235">&amp;&amp;</span>&nbsp;<span class="ident" id="1975238">d</span>&nbsp;<span class="op" id="1975240">&lt;=</span>&nbsp;<span class="ident" id="1975243">nanotime</span><span class="op" id="1975251">(</span><span class="op" id="1975252">)</span>&nbsp;<span class="op" id="1975254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975258">d</span>&nbsp;<span class="op" id="1975260">=</span>&nbsp;<span class="op" id="1975262">-</span><span class="num" id="1975263">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1975266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1975269">if</span>&nbsp;<span class="ident" id="1975272">mode</span>&nbsp;<span class="op" id="1975277">==</span>&nbsp;<span class="string" id="1975280">&#39;r&#39;</span>&nbsp;<span class="op" id="1975284">||</span>&nbsp;<span class="ident" id="1975287">mode</span>&nbsp;<span class="op" id="1975292">==</span>&nbsp;<span class="string" id="1975295">&#39;r&#39;</span><span class="op" id="1975298">+</span><span class="string" id="1975299">&#39;w&#39;</span>&nbsp;<span class="op" id="1975303">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975307">pd</span><span class="op" id="1975309">.</span><span class="ident" id="1975310">rd</span>&nbsp;<span class="op" id="1975313">=</span>&nbsp;<span class="ident" id="1975315">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1975318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1975321">if</span>&nbsp;<span class="ident" id="1975324">mode</span>&nbsp;<span class="op" id="1975329">==</span>&nbsp;<span class="string" id="1975332">&#39;w&#39;</span>&nbsp;<span class="op" id="1975336">||</span>&nbsp;<span class="ident" id="1975339">mode</span>&nbsp;<span class="op" id="1975344">==</span>&nbsp;<span class="string" id="1975347">&#39;r&#39;</span><span class="op" id="1975350">+</span><span class="string" id="1975351">&#39;w&#39;</span>&nbsp;<span class="op" id="1975355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975359">pd</span><span class="op" id="1975361">.</span><span class="ident" id="1975362">wd</span>&nbsp;<span class="op" id="1975365">=</span>&nbsp;<span class="ident" id="1975367">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1975370">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1975373">if</span>&nbsp;<span class="ident" id="1975376">pd</span><span class="op" id="1975378">.</span><span class="ident" id="1975379">rd</span>&nbsp;<span class="op" id="1975382">&gt;</span>&nbsp;<span class="num" id="1975384">0</span>&nbsp;<span class="op" id="1975386">&amp;&amp;</span>&nbsp;<span class="ident" id="1975389">pd</span><span class="op" id="1975391">.</span><span class="ident" id="1975392">rd</span>&nbsp;<span class="op" id="1975395">==</span>&nbsp;<span class="ident" id="1975398">pd</span><span class="op" id="1975400">.</span><span class="ident" id="1975401">wd</span>&nbsp;<span class="op" id="1975404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975408">pd</span><span class="op" id="1975410">.</span><span class="ident" id="1975411">rt</span><span class="op" id="1975413">.</span><span class="ident" id="1975414">f</span>&nbsp;<span class="op" id="1975416">=</span>&nbsp;<span class="ident" id="1975418">netpollDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975436">pd</span><span class="op" id="1975438">.</span><span class="ident" id="1975439">rt</span><span class="op" id="1975441">.</span><span class="ident" id="1975442">when</span>&nbsp;<span class="op" id="1975447">=</span>&nbsp;<span class="ident" id="1975449">pd</span><span class="op" id="1975451">.</span><span class="ident" id="1975452">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1975457">//&nbsp;Copy&nbsp;current&nbsp;seq&nbsp;into&nbsp;the&nbsp;timer&nbsp;arg.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1975499">//&nbsp;Timer&nbsp;func&nbsp;will&nbsp;check&nbsp;the&nbsp;seq&nbsp;against&nbsp;current&nbsp;descriptor&nbsp;seq,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1975566">//&nbsp;if&nbsp;they&nbsp;differ&nbsp;the&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975634">pd</span><span class="op" id="1975636">.</span><span class="ident" id="1975637">rt</span><span class="op" id="1975639">.</span><span class="ident" id="1975640">arg</span>&nbsp;<span class="op" id="1975644">=</span>&nbsp;<span class="ident" id="1975646">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975651">pd</span><span class="op" id="1975653">.</span><span class="ident" id="1975654">rt</span><span class="op" id="1975656">.</span><span class="ident" id="1975657">seq</span>&nbsp;<span class="op" id="1975661">=</span>&nbsp;<span class="ident" id="1975663">pd</span><span class="op" id="1975665">.</span><span class="ident" id="1975666">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975672">addtimer</span><span class="op" id="1975680">(</span><span class="op" id="1975681">&amp;</span><span class="ident" id="1975682">pd</span><span class="op" id="1975684">.</span><span class="ident" id="1975685">rt</span><span class="op" id="1975687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1975690">}</span>&nbsp;<span class="keyword" id="1975692">else</span>&nbsp;<span class="op" id="1975697">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1975701">if</span>&nbsp;<span class="ident" id="1975704">pd</span><span class="op" id="1975706">.</span><span class="ident" id="1975707">rd</span>&nbsp;<span class="op" id="1975710">&gt;</span>&nbsp;<span class="num" id="1975712">0</span>&nbsp;<span class="op" id="1975714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975719">pd</span><span class="op" id="1975721">.</span><span class="ident" id="1975722">rt</span><span class="op" id="1975724">.</span><span class="ident" id="1975725">f</span>&nbsp;<span class="op" id="1975727">=</span>&nbsp;<span class="ident" id="1975729">netpollReadDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975752">pd</span><span class="op" id="1975754">.</span><span class="ident" id="1975755">rt</span><span class="op" id="1975757">.</span><span class="ident" id="1975758">when</span>&nbsp;<span class="op" id="1975763">=</span>&nbsp;<span class="ident" id="1975765">pd</span><span class="op" id="1975767">.</span><span class="ident" id="1975768">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975774">pd</span><span class="op" id="1975776">.</span><span class="ident" id="1975777">rt</span><span class="op" id="1975779">.</span><span class="ident" id="1975780">arg</span>&nbsp;<span class="op" id="1975784">=</span>&nbsp;<span class="ident" id="1975786">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975792">pd</span><span class="op" id="1975794">.</span><span class="ident" id="1975795">rt</span><span class="op" id="1975797">.</span><span class="ident" id="1975798">seq</span>&nbsp;<span class="op" id="1975802">=</span>&nbsp;<span class="ident" id="1975804">pd</span><span class="op" id="1975806">.</span><span class="ident" id="1975807">seq</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975814">addtimer</span><span class="op" id="1975822">(</span><span class="op" id="1975823">&amp;</span><span class="ident" id="1975824">pd</span><span class="op" id="1975826">.</span><span class="ident" id="1975827">rt</span><span class="op" id="1975829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1975833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1975837">if</span>&nbsp;<span class="ident" id="1975840">pd</span><span class="op" id="1975842">.</span><span class="ident" id="1975843">wd</span>&nbsp;<span class="op" id="1975846">&gt;</span>&nbsp;<span class="num" id="1975848">0</span>&nbsp;<span class="op" id="1975850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975855">pd</span><span class="op" id="1975857">.</span><span class="ident" id="1975858">wt</span><span class="op" id="1975860">.</span><span class="ident" id="1975861">f</span>&nbsp;<span class="op" id="1975863">=</span>&nbsp;<span class="ident" id="1975865">netpollWriteDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975889">pd</span><span class="op" id="1975891">.</span><span class="ident" id="1975892">wt</span><span class="op" id="1975894">.</span><span class="ident" id="1975895">when</span>&nbsp;<span class="op" id="1975900">=</span>&nbsp;<span class="ident" id="1975902">pd</span><span class="op" id="1975904">.</span><span class="ident" id="1975905">wd</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975911">pd</span><span class="op" id="1975913">.</span><span class="ident" id="1975914">wt</span><span class="op" id="1975916">.</span><span class="ident" id="1975917">arg</span>&nbsp;<span class="op" id="1975921">=</span>&nbsp;<span class="ident" id="1975923">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975929">pd</span><span class="op" id="1975931">.</span><span class="ident" id="1975932">wt</span><span class="op" id="1975934">.</span><span class="ident" id="1975935">seq</span>&nbsp;<span class="op" id="1975939">=</span>&nbsp;<span class="ident" id="1975941">pd</span><span class="op" id="1975943">.</span><span class="ident" id="1975944">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1975951">addtimer</span><span class="op" id="1975959">(</span><span class="op" id="1975960">&amp;</span><span class="ident" id="1975961">pd</span><span class="op" id="1975963">.</span><span class="ident" id="1975964">wt</span><span class="op" id="1975966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1975970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1975973">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1975976">//&nbsp;If&nbsp;we&nbsp;set&nbsp;the&nbsp;new&nbsp;deadline&nbsp;in&nbsp;the&nbsp;past,&nbsp;unblock&nbsp;currently&nbsp;pending&nbsp;IO&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1976057">var</span>&nbsp;<span class="ident" id="1976061">rg</span><span class="op" id="1976063">,</span>&nbsp;<span class="ident" id="1976065">wg</span>&nbsp;<span class="op" id="1976068">*</span><span class="ident" id="1976069">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976072">atomicstorep</span><span class="op" id="1976084">(</span><span class="ident" id="1976085">unsafe</span><span class="op" id="1976091">.</span><span class="ident" id="1976092">Pointer</span><span class="op" id="1976099">(</span><span class="op" id="1976100">&amp;</span><span class="ident" id="1976101">wg</span><span class="op" id="1976103">)</span><span class="op" id="1976104">,</span>&nbsp;<span class="ident" id="1976106">nil</span><span class="op" id="1976109">)</span>&nbsp;<span class="comment" id="1976111">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;stores&nbsp;to&nbsp;rd/wd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1976195">if</span>&nbsp;<span class="ident" id="1976198">pd</span><span class="op" id="1976200">.</span><span class="ident" id="1976201">rd</span>&nbsp;<span class="op" id="1976204">&lt;</span>&nbsp;<span class="num" id="1976206">0</span>&nbsp;<span class="op" id="1976208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976212">rg</span>&nbsp;<span class="op" id="1976215">=</span>&nbsp;<span class="ident" id="1976217">netpollunblock</span><span class="op" id="1976231">(</span><span class="ident" id="1976232">pd</span><span class="op" id="1976234">,</span>&nbsp;<span class="string" id="1976236">&#39;r&#39;</span><span class="op" id="1976239">,</span>&nbsp;<span class="builtintype" id="1976241">false</span><span class="op" id="1976246">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1976249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1976252">if</span>&nbsp;<span class="ident" id="1976255">pd</span><span class="op" id="1976257">.</span><span class="ident" id="1976258">wd</span>&nbsp;<span class="op" id="1976261">&lt;</span>&nbsp;<span class="num" id="1976263">0</span>&nbsp;<span class="op" id="1976265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976269">wg</span>&nbsp;<span class="op" id="1976272">=</span>&nbsp;<span class="ident" id="1976274">netpollunblock</span><span class="op" id="1976288">(</span><span class="ident" id="1976289">pd</span><span class="op" id="1976291">,</span>&nbsp;<span class="string" id="1976293">&#39;w&#39;</span><span class="op" id="1976296">,</span>&nbsp;<span class="builtintype" id="1976298">false</span><span class="op" id="1976303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1976306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976309">unlock</span><span class="op" id="1976315">(</span><span class="op" id="1976316">&amp;</span><span class="ident" id="1976317">pd</span><span class="op" id="1976319">.</span><span class="ident" id="1976320">lock</span><span class="op" id="1976324">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1976327">if</span>&nbsp;<span class="ident" id="1976330">rg</span>&nbsp;<span class="op" id="1976333">!=</span>&nbsp;<span class="ident" id="1976336">nil</span>&nbsp;<span class="op" id="1976340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976344">goready</span><span class="op" id="1976351">(</span><span class="ident" id="1976352">rg</span><span class="op" id="1976354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1976357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1976360">if</span>&nbsp;<span class="ident" id="1976363">wg</span>&nbsp;<span class="op" id="1976366">!=</span>&nbsp;<span class="ident" id="1976369">nil</span>&nbsp;<span class="op" id="1976373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976377">goready</span><span class="op" id="1976384">(</span><span class="ident" id="1976385">wg</span><span class="op" id="1976387">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1976390">}</span><br>
<span class="lineno"></span><span class="op" id="1976392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1976395">func</span>&nbsp;<span class="ident" id="1976400">netpollUnblock</span><span class="op" id="1976414">(</span><span class="ident" id="1976415">pd</span>&nbsp;<span class="op" id="1976418">*</span><span class="ident" id="1976419">pollDesc</span><span class="op" id="1976427">)</span>&nbsp;<span class="op" id="1976429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976432">lock</span><span class="op" id="1976436">(</span><span class="op" id="1976437">&amp;</span><span class="ident" id="1976438">pd</span><span class="op" id="1976440">.</span><span class="ident" id="1976441">lock</span><span class="op" id="1976445">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1976448">if</span>&nbsp;<span class="ident" id="1976451">pd</span><span class="op" id="1976453">.</span><span class="ident" id="1976454">closing</span>&nbsp;<span class="op" id="1976462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976466">gothrow</span><span class="op" id="1976473">(</span><span class="string" id="1976474">&#34;netpollUnblock:&nbsp;already&nbsp;closing&#34;</span><span class="op" id="1976507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1976510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976513">pd</span><span class="op" id="1976515">.</span><span class="ident" id="1976516">closing</span>&nbsp;<span class="op" id="1976524">=</span>&nbsp;<span class="builtintype" id="1976526">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976532">pd</span><span class="op" id="1976534">.</span><span class="ident" id="1976535">seq</span><span class="op" id="1976538">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1976542">var</span>&nbsp;<span class="ident" id="1976546">rg</span><span class="op" id="1976548">,</span>&nbsp;<span class="ident" id="1976550">wg</span>&nbsp;<span class="op" id="1976553">*</span><span class="ident" id="1976554">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976557">atomicstorep</span><span class="op" id="1976569">(</span><span class="ident" id="1976570">unsafe</span><span class="op" id="1976576">.</span><span class="ident" id="1976577">Pointer</span><span class="op" id="1976584">(</span><span class="op" id="1976585">&amp;</span><span class="ident" id="1976586">rg</span><span class="op" id="1976588">)</span><span class="op" id="1976589">,</span>&nbsp;<span class="ident" id="1976591">nil</span><span class="op" id="1976594">)</span>&nbsp;<span class="comment" id="1976596">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;closing&nbsp;and&nbsp;read&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976681">rg</span>&nbsp;<span class="op" id="1976684">=</span>&nbsp;<span class="ident" id="1976686">netpollunblock</span><span class="op" id="1976700">(</span><span class="ident" id="1976701">pd</span><span class="op" id="1976703">,</span>&nbsp;<span class="string" id="1976705">&#39;r&#39;</span><span class="op" id="1976708">,</span>&nbsp;<span class="builtintype" id="1976710">false</span><span class="op" id="1976715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976718">wg</span>&nbsp;<span class="op" id="1976721">=</span>&nbsp;<span class="ident" id="1976723">netpollunblock</span><span class="op" id="1976737">(</span><span class="ident" id="1976738">pd</span><span class="op" id="1976740">,</span>&nbsp;<span class="string" id="1976742">&#39;w&#39;</span><span class="op" id="1976745">,</span>&nbsp;<span class="builtintype" id="1976747">false</span><span class="op" id="1976752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1976755">if</span>&nbsp;<span class="ident" id="1976758">pd</span><span class="op" id="1976760">.</span><span class="ident" id="1976761">rt</span><span class="op" id="1976763">.</span><span class="ident" id="1976764">f</span>&nbsp;<span class="op" id="1976766">!=</span>&nbsp;<span class="ident" id="1976769">nil</span>&nbsp;<span class="op" id="1976773">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976777">deltimer</span><span class="op" id="1976785">(</span><span class="op" id="1976786">&amp;</span><span class="ident" id="1976787">pd</span><span class="op" id="1976789">.</span><span class="ident" id="1976790">rt</span><span class="op" id="1976792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976796">pd</span><span class="op" id="1976798">.</span><span class="ident" id="1976799">rt</span><span class="op" id="1976801">.</span><span class="ident" id="1976802">f</span>&nbsp;<span class="op" id="1976804">=</span>&nbsp;<span class="ident" id="1976806">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1976811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1976814">if</span>&nbsp;<span class="ident" id="1976817">pd</span><span class="op" id="1976819">.</span><span class="ident" id="1976820">wt</span><span class="op" id="1976822">.</span><span class="ident" id="1976823">f</span>&nbsp;<span class="op" id="1976825">!=</span>&nbsp;<span class="ident" id="1976828">nil</span>&nbsp;<span class="op" id="1976832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976836">deltimer</span><span class="op" id="1976844">(</span><span class="op" id="1976845">&amp;</span><span class="ident" id="1976846">pd</span><span class="op" id="1976848">.</span><span class="ident" id="1976849">wt</span><span class="op" id="1976851">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976855">pd</span><span class="op" id="1976857">.</span><span class="ident" id="1976858">wt</span><span class="op" id="1976860">.</span><span class="ident" id="1976861">f</span>&nbsp;<span class="op" id="1976863">=</span>&nbsp;<span class="ident" id="1976865">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1976870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976873">unlock</span><span class="op" id="1976879">(</span><span class="op" id="1976880">&amp;</span><span class="ident" id="1976881">pd</span><span class="op" id="1976883">.</span><span class="ident" id="1976884">lock</span><span class="op" id="1976888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1976891">if</span>&nbsp;<span class="ident" id="1976894">rg</span>&nbsp;<span class="op" id="1976897">!=</span>&nbsp;<span class="ident" id="1976900">nil</span>&nbsp;<span class="op" id="1976904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976908">goready</span><span class="op" id="1976915">(</span><span class="ident" id="1976916">rg</span><span class="op" id="1976918">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1976921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1976924">if</span>&nbsp;<span class="ident" id="1976927">wg</span>&nbsp;<span class="op" id="1976930">!=</span>&nbsp;<span class="ident" id="1976933">nil</span>&nbsp;<span class="op" id="1976937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1976941">goready</span><span class="op" id="1976948">(</span><span class="ident" id="1976949">wg</span><span class="op" id="1976951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1976954">}</span><br>
<span class="lineno"></span><span class="op" id="1976956">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="1976959">func</span>&nbsp;<span class="ident" id="1976964">netpollfd</span><span class="op" id="1976973">(</span><span class="ident" id="1976974">pd</span>&nbsp;<span class="op" id="1976977">*</span><span class="ident" id="1976978">pollDesc</span><span class="op" id="1976986">)</span>&nbsp;<span class="builtintype" id="1976988">uintptr</span>&nbsp;<span class="op" id="1976996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1976999">return</span>&nbsp;<span class="ident" id="1977006">pd</span><span class="op" id="1977008">.</span><span class="ident" id="1977009">fd</span><br>
<span class="lineno"></span><span class="op" id="1977012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1977015">func</span>&nbsp;<span class="ident" id="1977020">netpolluser</span><span class="op" id="1977031">(</span><span class="ident" id="1977032">pd</span>&nbsp;<span class="op" id="1977035">*</span><span class="ident" id="1977036">pollDesc</span><span class="op" id="1977044">)</span>&nbsp;<span class="op" id="1977046">*</span><span class="ident" id="1977047">unsafe</span><span class="op" id="1977053">.</span><span class="ident" id="1977054">Pointer</span>&nbsp;<span class="op" id="1977062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1977065">return</span>&nbsp;<span class="op" id="1977072">&amp;</span><span class="ident" id="1977073">pd</span><span class="op" id="1977075">.</span><span class="ident" id="1977076">user</span><br>
<span class="lineno"></span><span class="op" id="1977081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1977084">func</span>&nbsp;<span class="ident" id="1977089">netpollclosing</span><span class="op" id="1977103">(</span><span class="ident" id="1977104">pd</span>&nbsp;<span class="op" id="1977107">*</span><span class="ident" id="1977108">pollDesc</span><span class="op" id="1977116">)</span>&nbsp;<span class="builtintype" id="1977118">bool</span>&nbsp;<span class="op" id="1977123">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1977126">return</span>&nbsp;<span class="ident" id="1977133">pd</span><span class="op" id="1977135">.</span><span class="ident" id="1977136">closing</span><br>
<span class="lineno"></span><span class="op" id="1977144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1977147">func</span>&nbsp;<span class="ident" id="1977152">netpolllock</span><span class="op" id="1977163">(</span><span class="ident" id="1977164">pd</span>&nbsp;<span class="op" id="1977167">*</span><span class="ident" id="1977168">pollDesc</span><span class="op" id="1977176">)</span>&nbsp;<span class="op" id="1977178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1977181">lock</span><span class="op" id="1977185">(</span><span class="op" id="1977186">&amp;</span><span class="ident" id="1977187">pd</span><span class="op" id="1977189">.</span><span class="ident" id="1977190">lock</span><span class="op" id="1977194">)</span><br>
<span class="lineno">280</span><span class="op" id="1977196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1977199">func</span>&nbsp;<span class="ident" id="1977204">netpollunlock</span><span class="op" id="1977217">(</span><span class="ident" id="1977218">pd</span>&nbsp;<span class="op" id="1977221">*</span><span class="ident" id="1977222">pollDesc</span><span class="op" id="1977230">)</span>&nbsp;<span class="op" id="1977232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1977235">unlock</span><span class="op" id="1977241">(</span><span class="op" id="1977242">&amp;</span><span class="ident" id="1977243">pd</span><span class="op" id="1977245">.</span><span class="ident" id="1977246">lock</span><span class="op" id="1977250">)</span><br>
<span class="lineno"></span><span class="op" id="1977252">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="1977255">//&nbsp;make&nbsp;pd&nbsp;ready,&nbsp;newly&nbsp;runnable&nbsp;goroutines&nbsp;(if&nbsp;any)&nbsp;are&nbsp;returned&nbsp;in&nbsp;rg/wg</span><br>
<span class="lineno"></span><span class="keyword" id="1977330">func</span>&nbsp;<span class="ident" id="1977335">netpollready</span><span class="op" id="1977347">(</span><span class="ident" id="1977348">gpp</span>&nbsp;<span class="op" id="1977352">*</span><span class="op" id="1977353">*</span><span class="ident" id="1977354">g</span><span class="op" id="1977355">,</span>&nbsp;<span class="ident" id="1977357">pd</span>&nbsp;<span class="op" id="1977360">*</span><span class="ident" id="1977361">pollDesc</span><span class="op" id="1977369">,</span>&nbsp;<span class="ident" id="1977371">mode</span>&nbsp;<span class="builtintype" id="1977376">int32</span><span class="op" id="1977381">)</span>&nbsp;<span class="op" id="1977383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1977386">var</span>&nbsp;<span class="ident" id="1977390">rg</span><span class="op" id="1977392">,</span>&nbsp;<span class="ident" id="1977394">wg</span>&nbsp;<span class="op" id="1977397">*</span><span class="ident" id="1977398">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1977401">if</span>&nbsp;<span class="ident" id="1977404">mode</span>&nbsp;<span class="op" id="1977409">==</span>&nbsp;<span class="string" id="1977412">&#39;r&#39;</span>&nbsp;<span class="op" id="1977416">||</span>&nbsp;<span class="ident" id="1977419">mode</span>&nbsp;<span class="op" id="1977424">==</span>&nbsp;<span class="string" id="1977427">&#39;r&#39;</span><span class="op" id="1977430">+</span><span class="string" id="1977431">&#39;w&#39;</span>&nbsp;<span class="op" id="1977435">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1977439">rg</span>&nbsp;<span class="op" id="1977442">=</span>&nbsp;<span class="ident" id="1977444">netpollunblock</span><span class="op" id="1977458">(</span><span class="ident" id="1977459">pd</span><span class="op" id="1977461">,</span>&nbsp;<span class="string" id="1977463">&#39;r&#39;</span><span class="op" id="1977466">,</span>&nbsp;<span class="builtintype" id="1977468">true</span><span class="op" id="1977472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1977475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1977478">if</span>&nbsp;<span class="ident" id="1977481">mode</span>&nbsp;<span class="op" id="1977486">==</span>&nbsp;<span class="string" id="1977489">&#39;w&#39;</span>&nbsp;<span class="op" id="1977493">||</span>&nbsp;<span class="ident" id="1977496">mode</span>&nbsp;<span class="op" id="1977501">==</span>&nbsp;<span class="string" id="1977504">&#39;r&#39;</span><span class="op" id="1977507">+</span><span class="string" id="1977508">&#39;w&#39;</span>&nbsp;<span class="op" id="1977512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1977516">wg</span>&nbsp;<span class="op" id="1977519">=</span>&nbsp;<span class="ident" id="1977521">netpollunblock</span><span class="op" id="1977535">(</span><span class="ident" id="1977536">pd</span><span class="op" id="1977538">,</span>&nbsp;<span class="string" id="1977540">&#39;w&#39;</span><span class="op" id="1977543">,</span>&nbsp;<span class="builtintype" id="1977545">true</span><span class="op" id="1977549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1977552">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1977555">if</span>&nbsp;<span class="ident" id="1977558">rg</span>&nbsp;<span class="op" id="1977561">!=</span>&nbsp;<span class="ident" id="1977564">nil</span>&nbsp;<span class="op" id="1977568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1977572">rg</span><span class="op" id="1977574">.</span><span class="ident" id="1977575">schedlink</span>&nbsp;<span class="op" id="1977585">=</span>&nbsp;<span class="op" id="1977587">*</span><span class="ident" id="1977588">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1977594">*</span><span class="ident" id="1977595">gpp</span>&nbsp;<span class="op" id="1977599">=</span>&nbsp;<span class="ident" id="1977601">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1977605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1977608">if</span>&nbsp;<span class="ident" id="1977611">wg</span>&nbsp;<span class="op" id="1977614">!=</span>&nbsp;<span class="ident" id="1977617">nil</span>&nbsp;<span class="op" id="1977621">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1977625">wg</span><span class="op" id="1977627">.</span><span class="ident" id="1977628">schedlink</span>&nbsp;<span class="op" id="1977638">=</span>&nbsp;<span class="op" id="1977640">*</span><span class="ident" id="1977641">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1977647">*</span><span class="ident" id="1977648">gpp</span>&nbsp;<span class="op" id="1977652">=</span>&nbsp;<span class="ident" id="1977654">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1977658">}</span><br>
<span class="lineno"></span><span class="op" id="1977660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="keyword" id="1977663">func</span>&nbsp;<span class="ident" id="1977668">netpollcheckerr</span><span class="op" id="1977683">(</span><span class="ident" id="1977684">pd</span>&nbsp;<span class="op" id="1977687">*</span><span class="ident" id="1977688">pollDesc</span><span class="op" id="1977696">,</span>&nbsp;<span class="ident" id="1977698">mode</span>&nbsp;<span class="builtintype" id="1977703">int32</span><span class="op" id="1977708">)</span>&nbsp;<span class="builtintype" id="1977710">int</span>&nbsp;<span class="op" id="1977714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1977717">if</span>&nbsp;<span class="ident" id="1977720">pd</span><span class="op" id="1977722">.</span><span class="ident" id="1977723">closing</span>&nbsp;<span class="op" id="1977731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1977735">return</span>&nbsp;<span class="num" id="1977742">1</span>&nbsp;<span class="comment" id="1977744">//&nbsp;errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1977759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1977762">if</span>&nbsp;<span class="op" id="1977765">(</span><span class="ident" id="1977766">mode</span>&nbsp;<span class="op" id="1977771">==</span>&nbsp;<span class="string" id="1977774">&#39;r&#39;</span>&nbsp;<span class="op" id="1977778">&amp;&amp;</span>&nbsp;<span class="ident" id="1977781">pd</span><span class="op" id="1977783">.</span><span class="ident" id="1977784">rd</span>&nbsp;<span class="op" id="1977787">&lt;</span>&nbsp;<span class="num" id="1977789">0</span><span class="op" id="1977790">)</span>&nbsp;<span class="op" id="1977792">||</span>&nbsp;<span class="op" id="1977795">(</span><span class="ident" id="1977796">mode</span>&nbsp;<span class="op" id="1977801">==</span>&nbsp;<span class="string" id="1977804">&#39;w&#39;</span>&nbsp;<span class="op" id="1977808">&amp;&amp;</span>&nbsp;<span class="ident" id="1977811">pd</span><span class="op" id="1977813">.</span><span class="ident" id="1977814">wd</span>&nbsp;<span class="op" id="1977817">&lt;</span>&nbsp;<span class="num" id="1977819">0</span><span class="op" id="1977820">)</span>&nbsp;<span class="op" id="1977822">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1977826">return</span>&nbsp;<span class="num" id="1977833">2</span>&nbsp;<span class="comment" id="1977835">//&nbsp;errTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1977850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1977853">return</span>&nbsp;<span class="num" id="1977860">0</span><br>
<span class="lineno"></span><span class="op" id="1977862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="keyword" id="1977865">func</span>&nbsp;<span class="ident" id="1977870">netpollblockcommit</span><span class="op" id="1977888">(</span><span class="ident" id="1977889">gp</span>&nbsp;<span class="op" id="1977892">*</span><span class="ident" id="1977893">g</span><span class="op" id="1977894">,</span>&nbsp;<span class="ident" id="1977896">gpp</span>&nbsp;<span class="ident" id="1977900">unsafe</span><span class="op" id="1977906">.</span><span class="ident" id="1977907">Pointer</span><span class="op" id="1977914">)</span>&nbsp;<span class="builtintype" id="1977916">bool</span>&nbsp;<span class="op" id="1977921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1977924">return</span>&nbsp;<span class="ident" id="1977931">casuintptr</span><span class="op" id="1977941">(</span><span class="op" id="1977942">(</span><span class="op" id="1977943">*</span><span class="builtintype" id="1977944">uintptr</span><span class="op" id="1977951">)</span><span class="op" id="1977952">(</span><span class="ident" id="1977953">gpp</span><span class="op" id="1977956">)</span><span class="op" id="1977957">,</span>&nbsp;<span class="ident" id="1977959">pdWait</span><span class="op" id="1977965">,</span>&nbsp;<span class="builtintype" id="1977967">uintptr</span><span class="op" id="1977974">(</span><span class="ident" id="1977975">unsafe</span><span class="op" id="1977981">.</span><span class="ident" id="1977982">Pointer</span><span class="op" id="1977989">(</span><span class="ident" id="1977990">gp</span><span class="op" id="1977992">)</span><span class="op" id="1977993">)</span><span class="op" id="1977994">)</span><br>
<span class="lineno"></span><span class="op" id="1977996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1977999">//&nbsp;returns&nbsp;true&nbsp;if&nbsp;IO&nbsp;is&nbsp;ready,&nbsp;or&nbsp;false&nbsp;if&nbsp;timedout&nbsp;or&nbsp;closed</span><br>
<span class="lineno">320</span><span class="comment" id="1978062">//&nbsp;waitio&nbsp;-&nbsp;wait&nbsp;only&nbsp;for&nbsp;completed&nbsp;IO,&nbsp;ignore&nbsp;errors</span><br>
<span class="lineno"></span><span class="keyword" id="1978116">func</span>&nbsp;<span class="ident" id="1978121">netpollblock</span><span class="op" id="1978133">(</span><span class="ident" id="1978134">pd</span>&nbsp;<span class="op" id="1978137">*</span><span class="ident" id="1978138">pollDesc</span><span class="op" id="1978146">,</span>&nbsp;<span class="ident" id="1978148">mode</span>&nbsp;<span class="builtintype" id="1978153">int32</span><span class="op" id="1978158">,</span>&nbsp;<span class="ident" id="1978160">waitio</span>&nbsp;<span class="builtintype" id="1978167">bool</span><span class="op" id="1978171">)</span>&nbsp;<span class="builtintype" id="1978173">bool</span>&nbsp;<span class="op" id="1978178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1978181">gpp</span>&nbsp;<span class="op" id="1978185">:=</span>&nbsp;<span class="op" id="1978188">&amp;</span><span class="ident" id="1978189">pd</span><span class="op" id="1978191">.</span><span class="ident" id="1978192">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1978196">if</span>&nbsp;<span class="ident" id="1978199">mode</span>&nbsp;<span class="op" id="1978204">==</span>&nbsp;<span class="string" id="1978207">&#39;w&#39;</span>&nbsp;<span class="op" id="1978211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1978215">gpp</span>&nbsp;<span class="op" id="1978219">=</span>&nbsp;<span class="op" id="1978221">&amp;</span><span class="ident" id="1978222">pd</span><span class="op" id="1978224">.</span><span class="ident" id="1978225">wg</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1978229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1978233">//&nbsp;set&nbsp;the&nbsp;gpp&nbsp;semaphore&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1978267">for</span>&nbsp;<span class="op" id="1978271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1978275">old</span>&nbsp;<span class="op" id="1978279">:=</span>&nbsp;<span class="op" id="1978282">*</span><span class="ident" id="1978283">gpp</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1978289">if</span>&nbsp;<span class="ident" id="1978292">old</span>&nbsp;<span class="op" id="1978296">==</span>&nbsp;<span class="ident" id="1978299">pdReady</span>&nbsp;<span class="op" id="1978307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1978312">*</span><span class="ident" id="1978313">gpp</span>&nbsp;<span class="op" id="1978317">=</span>&nbsp;<span class="num" id="1978319">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1978324">return</span>&nbsp;<span class="builtintype" id="1978331">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1978338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1978342">if</span>&nbsp;<span class="ident" id="1978345">old</span>&nbsp;<span class="op" id="1978349">!=</span>&nbsp;<span class="num" id="1978352">0</span>&nbsp;<span class="op" id="1978354">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1978359">gothrow</span><span class="op" id="1978366">(</span><span class="string" id="1978367">&#34;netpollblock:&nbsp;double&nbsp;wait&#34;</span><span class="op" id="1978394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1978398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1978402">if</span>&nbsp;<span class="ident" id="1978405">casuintptr</span><span class="op" id="1978415">(</span><span class="ident" id="1978416">gpp</span><span class="op" id="1978419">,</span>&nbsp;<span class="num" id="1978421">0</span><span class="op" id="1978422">,</span>&nbsp;<span class="ident" id="1978424">pdWait</span><span class="op" id="1978430">)</span>&nbsp;<span class="op" id="1978432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1978437">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1978445">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1978448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1978452">//&nbsp;need&nbsp;to&nbsp;recheck&nbsp;error&nbsp;states&nbsp;after&nbsp;setting&nbsp;gpp&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1978511">//&nbsp;this&nbsp;is&nbsp;necessary&nbsp;because&nbsp;runtime_pollUnblock/runtime_pollSetDeadline/deadlineimpl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1978598">//&nbsp;do&nbsp;the&nbsp;opposite:&nbsp;store&nbsp;to&nbsp;closing/rd/wd,&nbsp;membarrier,&nbsp;load&nbsp;of&nbsp;rg/wg</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1978669">if</span>&nbsp;<span class="ident" id="1978672">waitio</span>&nbsp;<span class="op" id="1978679">||</span>&nbsp;<span class="ident" id="1978682">netpollcheckerr</span><span class="op" id="1978697">(</span><span class="ident" id="1978698">pd</span><span class="op" id="1978700">,</span>&nbsp;<span class="ident" id="1978702">mode</span><span class="op" id="1978706">)</span>&nbsp;<span class="op" id="1978708">==</span>&nbsp;<span class="num" id="1978711">0</span>&nbsp;<span class="op" id="1978713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1978717">f</span>&nbsp;<span class="op" id="1978719">:=</span>&nbsp;<span class="ident" id="1978722">netpollblockcommit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1978743">gopark</span><span class="op" id="1978749">(</span><span class="op" id="1978750">*</span><span class="op" id="1978751">*</span><span class="op" id="1978752">(</span><span class="op" id="1978753">*</span><span class="op" id="1978754">*</span><span class="ident" id="1978755">unsafe</span><span class="op" id="1978761">.</span><span class="ident" id="1978762">Pointer</span><span class="op" id="1978769">)</span><span class="op" id="1978770">(</span><span class="ident" id="1978771">unsafe</span><span class="op" id="1978777">.</span><span class="ident" id="1978778">Pointer</span><span class="op" id="1978785">(</span><span class="op" id="1978786">&amp;</span><span class="ident" id="1978787">f</span><span class="op" id="1978788">)</span><span class="op" id="1978789">)</span><span class="op" id="1978790">,</span>&nbsp;<span class="ident" id="1978792">unsafe</span><span class="op" id="1978798">.</span><span class="ident" id="1978799">Pointer</span><span class="op" id="1978806">(</span><span class="ident" id="1978807">gpp</span><span class="op" id="1978810">)</span><span class="op" id="1978811">,</span>&nbsp;<span class="string" id="1978813">&#34;IO&nbsp;wait&#34;</span><span class="op" id="1978822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1978825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1978828">//&nbsp;be&nbsp;careful&nbsp;to&nbsp;not&nbsp;lose&nbsp;concurrent&nbsp;READY&nbsp;notification</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1978885">old</span>&nbsp;<span class="op" id="1978889">:=</span>&nbsp;<span class="ident" id="1978892">xchguintptr</span><span class="op" id="1978903">(</span><span class="ident" id="1978904">gpp</span><span class="op" id="1978907">,</span>&nbsp;<span class="num" id="1978909">0</span><span class="op" id="1978910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1978913">if</span>&nbsp;<span class="ident" id="1978916">old</span>&nbsp;<span class="op" id="1978920">&gt;</span>&nbsp;<span class="ident" id="1978922">pdWait</span>&nbsp;<span class="op" id="1978929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1978933">gothrow</span><span class="op" id="1978940">(</span><span class="string" id="1978941">&#34;netpollblock:&nbsp;corrupted&nbsp;state&#34;</span><span class="op" id="1978972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1978975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1978978">return</span>&nbsp;<span class="ident" id="1978985">old</span>&nbsp;<span class="op" id="1978989">==</span>&nbsp;<span class="ident" id="1978992">pdReady</span><br>
<span class="lineno">355</span><span class="op" id="1979000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1979003">func</span>&nbsp;<span class="ident" id="1979008">netpollunblock</span><span class="op" id="1979022">(</span><span class="ident" id="1979023">pd</span>&nbsp;<span class="op" id="1979026">*</span><span class="ident" id="1979027">pollDesc</span><span class="op" id="1979035">,</span>&nbsp;<span class="ident" id="1979037">mode</span>&nbsp;<span class="builtintype" id="1979042">int32</span><span class="op" id="1979047">,</span>&nbsp;<span class="ident" id="1979049">ioready</span>&nbsp;<span class="builtintype" id="1979057">bool</span><span class="op" id="1979061">)</span>&nbsp;<span class="op" id="1979063">*</span><span class="ident" id="1979064">g</span>&nbsp;<span class="op" id="1979066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979069">gpp</span>&nbsp;<span class="op" id="1979073">:=</span>&nbsp;<span class="op" id="1979076">&amp;</span><span class="ident" id="1979077">pd</span><span class="op" id="1979079">.</span><span class="ident" id="1979080">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979084">if</span>&nbsp;<span class="ident" id="1979087">mode</span>&nbsp;<span class="op" id="1979092">==</span>&nbsp;<span class="string" id="1979095">&#39;w&#39;</span>&nbsp;<span class="op" id="1979099">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979103">gpp</span>&nbsp;<span class="op" id="1979107">=</span>&nbsp;<span class="op" id="1979109">&amp;</span><span class="ident" id="1979110">pd</span><span class="op" id="1979112">.</span><span class="ident" id="1979113">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979121">for</span>&nbsp;<span class="op" id="1979125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979129">old</span>&nbsp;<span class="op" id="1979133">:=</span>&nbsp;<span class="op" id="1979136">*</span><span class="ident" id="1979137">gpp</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979143">if</span>&nbsp;<span class="ident" id="1979146">old</span>&nbsp;<span class="op" id="1979150">==</span>&nbsp;<span class="ident" id="1979153">pdReady</span>&nbsp;<span class="op" id="1979161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979166">return</span>&nbsp;<span class="ident" id="1979173">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979183">if</span>&nbsp;<span class="ident" id="1979186">old</span>&nbsp;<span class="op" id="1979190">==</span>&nbsp;<span class="num" id="1979193">0</span>&nbsp;<span class="op" id="1979195">&amp;&amp;</span>&nbsp;<span class="op" id="1979198">!</span><span class="ident" id="1979199">ioready</span>&nbsp;<span class="op" id="1979207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1979212">//&nbsp;Only&nbsp;set&nbsp;READY&nbsp;for&nbsp;ioready.&nbsp;runtime_pollWait</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1979263">//&nbsp;will&nbsp;check&nbsp;for&nbsp;timeout/cancel&nbsp;before&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979315">return</span>&nbsp;<span class="ident" id="1979322">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979332">var</span>&nbsp;<span class="builtinfunc" id="1979336">new</span>&nbsp;<span class="builtintype" id="1979340">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979350">if</span>&nbsp;<span class="ident" id="1979353">ioready</span>&nbsp;<span class="op" id="1979361">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1979366">new</span>&nbsp;<span class="op" id="1979370">=</span>&nbsp;<span class="ident" id="1979372">pdReady</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979386">if</span>&nbsp;<span class="ident" id="1979389">casuintptr</span><span class="op" id="1979399">(</span><span class="ident" id="1979400">gpp</span><span class="op" id="1979403">,</span>&nbsp;<span class="ident" id="1979405">old</span><span class="op" id="1979408">,</span>&nbsp;<span class="builtinfunc" id="1979410">new</span><span class="op" id="1979413">)</span>&nbsp;<span class="op" id="1979415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979420">if</span>&nbsp;<span class="ident" id="1979423">old</span>&nbsp;<span class="op" id="1979427">==</span>&nbsp;<span class="ident" id="1979430">pdReady</span>&nbsp;<span class="op" id="1979438">||</span>&nbsp;<span class="ident" id="1979441">old</span>&nbsp;<span class="op" id="1979445">==</span>&nbsp;<span class="ident" id="1979448">pdWait</span>&nbsp;<span class="op" id="1979455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979461">old</span>&nbsp;<span class="op" id="1979465">=</span>&nbsp;<span class="num" id="1979467">0</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979477">return</span>&nbsp;<span class="op" id="1979484">(</span><span class="op" id="1979485">*</span><span class="ident" id="1979486">g</span><span class="op" id="1979487">)</span><span class="op" id="1979488">(</span><span class="ident" id="1979489">unsafe</span><span class="op" id="1979495">.</span><span class="ident" id="1979496">Pointer</span><span class="op" id="1979503">(</span><span class="ident" id="1979504">old</span><span class="op" id="1979507">)</span><span class="op" id="1979508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979515">}</span><br>
<span class="lineno"></span><span class="op" id="1979517">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span><span class="keyword" id="1979520">func</span>&nbsp;<span class="ident" id="1979525">netpolldeadlineimpl</span><span class="op" id="1979544">(</span><span class="ident" id="1979545">pd</span>&nbsp;<span class="op" id="1979548">*</span><span class="ident" id="1979549">pollDesc</span><span class="op" id="1979557">,</span>&nbsp;<span class="ident" id="1979559">seq</span>&nbsp;<span class="builtintype" id="1979563">uintptr</span><span class="op" id="1979570">,</span>&nbsp;<span class="ident" id="1979572">read</span><span class="op" id="1979576">,</span>&nbsp;<span class="ident" id="1979578">write</span>&nbsp;<span class="builtintype" id="1979584">bool</span><span class="op" id="1979588">)</span>&nbsp;<span class="op" id="1979590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979593">lock</span><span class="op" id="1979597">(</span><span class="op" id="1979598">&amp;</span><span class="ident" id="1979599">pd</span><span class="op" id="1979601">.</span><span class="ident" id="1979602">lock</span><span class="op" id="1979606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1979609">//&nbsp;Seq&nbsp;arg&nbsp;is&nbsp;seq&nbsp;when&nbsp;the&nbsp;timer&nbsp;was&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1979652">//&nbsp;If&nbsp;it&#39;s&nbsp;stale,&nbsp;ignore&nbsp;the&nbsp;timer&nbsp;event.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979695">if</span>&nbsp;<span class="ident" id="1979698">seq</span>&nbsp;<span class="op" id="1979702">!=</span>&nbsp;<span class="ident" id="1979705">pd</span><span class="op" id="1979707">.</span><span class="ident" id="1979708">seq</span>&nbsp;<span class="op" id="1979712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1979716">//&nbsp;The&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979769">unlock</span><span class="op" id="1979775">(</span><span class="op" id="1979776">&amp;</span><span class="ident" id="1979777">pd</span><span class="op" id="1979779">.</span><span class="ident" id="1979780">lock</span><span class="op" id="1979784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979788">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979796">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979799">var</span>&nbsp;<span class="ident" id="1979803">rg</span>&nbsp;<span class="op" id="1979806">*</span><span class="ident" id="1979807">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979810">if</span>&nbsp;<span class="ident" id="1979813">read</span>&nbsp;<span class="op" id="1979818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979822">if</span>&nbsp;<span class="ident" id="1979825">pd</span><span class="op" id="1979827">.</span><span class="ident" id="1979828">rd</span>&nbsp;<span class="op" id="1979831">&lt;=</span>&nbsp;<span class="num" id="1979834">0</span>&nbsp;<span class="op" id="1979836">||</span>&nbsp;<span class="ident" id="1979839">pd</span><span class="op" id="1979841">.</span><span class="ident" id="1979842">rt</span><span class="op" id="1979844">.</span><span class="ident" id="1979845">f</span>&nbsp;<span class="op" id="1979847">==</span>&nbsp;<span class="ident" id="1979850">nil</span>&nbsp;<span class="op" id="1979854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979859">gothrow</span><span class="op" id="1979866">(</span><span class="string" id="1979867">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;read&nbsp;deadline&#34;</span><span class="op" id="1979916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979920">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979924">pd</span><span class="op" id="1979926">.</span><span class="ident" id="1979927">rd</span>&nbsp;<span class="op" id="1979930">=</span>&nbsp;<span class="op" id="1979932">-</span><span class="num" id="1979933">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979937">atomicstorep</span><span class="op" id="1979949">(</span><span class="ident" id="1979950">unsafe</span><span class="op" id="1979956">.</span><span class="ident" id="1979957">Pointer</span><span class="op" id="1979964">(</span><span class="op" id="1979965">&amp;</span><span class="ident" id="1979966">pd</span><span class="op" id="1979968">.</span><span class="ident" id="1979969">rt</span><span class="op" id="1979971">.</span><span class="ident" id="1979972">f</span><span class="op" id="1979973">)</span><span class="op" id="1979974">,</span>&nbsp;<span class="ident" id="1979976">nil</span><span class="op" id="1979979">)</span>&nbsp;<span class="comment" id="1979981">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;rd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980059">rg</span>&nbsp;<span class="op" id="1980062">=</span>&nbsp;<span class="ident" id="1980064">netpollunblock</span><span class="op" id="1980078">(</span><span class="ident" id="1980079">pd</span><span class="op" id="1980081">,</span>&nbsp;<span class="string" id="1980083">&#39;r&#39;</span><span class="op" id="1980086">,</span>&nbsp;<span class="builtintype" id="1980088">false</span><span class="op" id="1980093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1980096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980099">var</span>&nbsp;<span class="ident" id="1980103">wg</span>&nbsp;<span class="op" id="1980106">*</span><span class="ident" id="1980107">g</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980110">if</span>&nbsp;<span class="ident" id="1980113">write</span>&nbsp;<span class="op" id="1980119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980123">if</span>&nbsp;<span class="ident" id="1980126">pd</span><span class="op" id="1980128">.</span><span class="ident" id="1980129">wd</span>&nbsp;<span class="op" id="1980132">&lt;=</span>&nbsp;<span class="num" id="1980135">0</span>&nbsp;<span class="op" id="1980137">||</span>&nbsp;<span class="ident" id="1980140">pd</span><span class="op" id="1980142">.</span><span class="ident" id="1980143">wt</span><span class="op" id="1980145">.</span><span class="ident" id="1980146">f</span>&nbsp;<span class="op" id="1980148">==</span>&nbsp;<span class="ident" id="1980151">nil</span>&nbsp;<span class="op" id="1980155">&amp;&amp;</span>&nbsp;<span class="op" id="1980158">!</span><span class="ident" id="1980159">read</span>&nbsp;<span class="op" id="1980164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980169">gothrow</span><span class="op" id="1980176">(</span><span class="string" id="1980177">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;write&nbsp;deadline&#34;</span><span class="op" id="1980227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1980231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980235">pd</span><span class="op" id="1980237">.</span><span class="ident" id="1980238">wd</span>&nbsp;<span class="op" id="1980241">=</span>&nbsp;<span class="op" id="1980243">-</span><span class="num" id="1980244">1</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980248">atomicstorep</span><span class="op" id="1980260">(</span><span class="ident" id="1980261">unsafe</span><span class="op" id="1980267">.</span><span class="ident" id="1980268">Pointer</span><span class="op" id="1980275">(</span><span class="op" id="1980276">&amp;</span><span class="ident" id="1980277">pd</span><span class="op" id="1980279">.</span><span class="ident" id="1980280">wt</span><span class="op" id="1980282">.</span><span class="ident" id="1980283">f</span><span class="op" id="1980284">)</span><span class="op" id="1980285">,</span>&nbsp;<span class="ident" id="1980287">nil</span><span class="op" id="1980290">)</span>&nbsp;<span class="comment" id="1980292">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;wd&nbsp;and&nbsp;load&nbsp;of&nbsp;wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980370">wg</span>&nbsp;<span class="op" id="1980373">=</span>&nbsp;<span class="ident" id="1980375">netpollunblock</span><span class="op" id="1980389">(</span><span class="ident" id="1980390">pd</span><span class="op" id="1980392">,</span>&nbsp;<span class="string" id="1980394">&#39;w&#39;</span><span class="op" id="1980397">,</span>&nbsp;<span class="builtintype" id="1980399">false</span><span class="op" id="1980404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1980407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980410">unlock</span><span class="op" id="1980416">(</span><span class="op" id="1980417">&amp;</span><span class="ident" id="1980418">pd</span><span class="op" id="1980420">.</span><span class="ident" id="1980421">lock</span><span class="op" id="1980425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980428">if</span>&nbsp;<span class="ident" id="1980431">rg</span>&nbsp;<span class="op" id="1980434">!=</span>&nbsp;<span class="ident" id="1980437">nil</span>&nbsp;<span class="op" id="1980441">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980445">goready</span><span class="op" id="1980452">(</span><span class="ident" id="1980453">rg</span><span class="op" id="1980455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1980458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980461">if</span>&nbsp;<span class="ident" id="1980464">wg</span>&nbsp;<span class="op" id="1980467">!=</span>&nbsp;<span class="ident" id="1980470">nil</span>&nbsp;<span class="op" id="1980474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980478">goready</span><span class="op" id="1980485">(</span><span class="ident" id="1980486">wg</span><span class="op" id="1980488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1980491">}</span><br>
<span class="lineno">420</span><span class="op" id="1980493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1980496">func</span>&nbsp;<span class="ident" id="1980501">netpollDeadline</span><span class="op" id="1980516">(</span><span class="ident" id="1980517">arg</span>&nbsp;<span class="keyword" id="1980521">interface</span><span class="op" id="1980530">{</span><span class="op" id="1980531">}</span><span class="op" id="1980532">,</span>&nbsp;<span class="ident" id="1980534">seq</span>&nbsp;<span class="builtintype" id="1980538">uintptr</span><span class="op" id="1980545">)</span>&nbsp;<span class="op" id="1980547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980550">netpolldeadlineimpl</span><span class="op" id="1980569">(</span><span class="ident" id="1980570">arg</span><span class="op" id="1980573">.</span><span class="op" id="1980574">(</span><span class="op" id="1980575">*</span><span class="ident" id="1980576">pollDesc</span><span class="op" id="1980584">)</span><span class="op" id="1980585">,</span>&nbsp;<span class="ident" id="1980587">seq</span><span class="op" id="1980590">,</span>&nbsp;<span class="builtintype" id="1980592">true</span><span class="op" id="1980596">,</span>&nbsp;<span class="builtintype" id="1980598">true</span><span class="op" id="1980602">)</span><br>
<span class="lineno"></span><span class="op" id="1980604">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="1980607">func</span>&nbsp;<span class="ident" id="1980612">netpollReadDeadline</span><span class="op" id="1980631">(</span><span class="ident" id="1980632">arg</span>&nbsp;<span class="keyword" id="1980636">interface</span><span class="op" id="1980645">{</span><span class="op" id="1980646">}</span><span class="op" id="1980647">,</span>&nbsp;<span class="ident" id="1980649">seq</span>&nbsp;<span class="builtintype" id="1980653">uintptr</span><span class="op" id="1980660">)</span>&nbsp;<span class="op" id="1980662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980665">netpolldeadlineimpl</span><span class="op" id="1980684">(</span><span class="ident" id="1980685">arg</span><span class="op" id="1980688">.</span><span class="op" id="1980689">(</span><span class="op" id="1980690">*</span><span class="ident" id="1980691">pollDesc</span><span class="op" id="1980699">)</span><span class="op" id="1980700">,</span>&nbsp;<span class="ident" id="1980702">seq</span><span class="op" id="1980705">,</span>&nbsp;<span class="builtintype" id="1980707">true</span><span class="op" id="1980711">,</span>&nbsp;<span class="builtintype" id="1980713">false</span><span class="op" id="1980718">)</span><br>
<span class="lineno"></span><span class="op" id="1980720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="keyword" id="1980723">func</span>&nbsp;<span class="ident" id="1980728">netpollWriteDeadline</span><span class="op" id="1980748">(</span><span class="ident" id="1980749">arg</span>&nbsp;<span class="keyword" id="1980753">interface</span><span class="op" id="1980762">{</span><span class="op" id="1980763">}</span><span class="op" id="1980764">,</span>&nbsp;<span class="ident" id="1980766">seq</span>&nbsp;<span class="builtintype" id="1980770">uintptr</span><span class="op" id="1980777">)</span>&nbsp;<span class="op" id="1980779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980782">netpolldeadlineimpl</span><span class="op" id="1980801">(</span><span class="ident" id="1980802">arg</span><span class="op" id="1980805">.</span><span class="op" id="1980806">(</span><span class="op" id="1980807">*</span><span class="ident" id="1980808">pollDesc</span><span class="op" id="1980816">)</span><span class="op" id="1980817">,</span>&nbsp;<span class="ident" id="1980819">seq</span><span class="op" id="1980822">,</span>&nbsp;<span class="builtintype" id="1980824">false</span><span class="op" id="1980829">,</span>&nbsp;<span class="builtintype" id="1980831">true</span><span class="op" id="1980835">)</span><br>
<span class="lineno"></span><span class="op" id="1980837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1980840">func</span>&nbsp;<span class="op" id="1980845">(</span><span class="ident" id="1980846">c</span>&nbsp;<span class="op" id="1980848">*</span><span class="ident" id="1980849">pollCache</span><span class="op" id="1980858">)</span>&nbsp;<span class="ident" id="1980860">alloc</span><span class="op" id="1980865">(</span><span class="op" id="1980866">)</span>&nbsp;<span class="op" id="1980868">*</span><span class="ident" id="1980869">pollDesc</span>&nbsp;<span class="op" id="1980878">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980881">lock</span><span class="op" id="1980885">(</span><span class="op" id="1980886">&amp;</span><span class="ident" id="1980887">c</span><span class="op" id="1980888">.</span><span class="ident" id="1980889">lock</span><span class="op" id="1980893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980896">if</span>&nbsp;<span class="ident" id="1980899">c</span><span class="op" id="1980900">.</span><span class="ident" id="1980901">first</span>&nbsp;<span class="op" id="1980907">==</span>&nbsp;<span class="ident" id="1980910">nil</span>&nbsp;<span class="op" id="1980914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980918">const</span>&nbsp;<span class="ident" id="1980924">pdSize</span>&nbsp;<span class="op" id="1980931">=</span>&nbsp;<span class="ident" id="1980933">unsafe</span><span class="op" id="1980939">.</span><span class="ident" id="1980940">Sizeof</span><span class="op" id="1980946">(</span><span class="ident" id="1980947">pollDesc</span><span class="op" id="1980955">{</span><span class="op" id="1980956">}</span><span class="op" id="1980957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980961">n</span>&nbsp;<span class="op" id="1980963">:=</span>&nbsp;<span class="ident" id="1980966">pollBlockSize</span>&nbsp;<span class="op" id="1980980">/</span>&nbsp;<span class="ident" id="1980982">pdSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980991">if</span>&nbsp;<span class="ident" id="1980994">n</span>&nbsp;<span class="op" id="1980996">==</span>&nbsp;<span class="num" id="1980999">0</span>&nbsp;<span class="op" id="1981001">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981006">n</span>&nbsp;<span class="op" id="1981008">=</span>&nbsp;<span class="num" id="1981010">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1981014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1981018">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;non-GC&nbsp;memory&nbsp;because&nbsp;can&nbsp;be&nbsp;referenced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1981074">//&nbsp;only&nbsp;from&nbsp;epoll/kqueue&nbsp;internals.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981113">mem</span>&nbsp;<span class="op" id="1981117">:=</span>&nbsp;<span class="ident" id="1981120">persistentalloc</span><span class="op" id="1981135">(</span><span class="ident" id="1981136">n</span><span class="op" id="1981137">*</span><span class="ident" id="1981138">pdSize</span><span class="op" id="1981144">,</span>&nbsp;<span class="num" id="1981146">0</span><span class="op" id="1981147">,</span>&nbsp;<span class="op" id="1981149">&amp;</span><span class="ident" id="1981150">memstats</span><span class="op" id="1981158">.</span><span class="ident" id="1981159">other_sys</span><span class="op" id="1981168">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1981172">for</span>&nbsp;<span class="ident" id="1981176">i</span>&nbsp;<span class="op" id="1981178">:=</span>&nbsp;<span class="builtintype" id="1981181">uintptr</span><span class="op" id="1981188">(</span><span class="num" id="1981189">0</span><span class="op" id="1981190">)</span><span class="op" id="1981191">;</span>&nbsp;<span class="ident" id="1981193">i</span>&nbsp;<span class="op" id="1981195">&lt;</span>&nbsp;<span class="ident" id="1981197">n</span><span class="op" id="1981198">;</span>&nbsp;<span class="ident" id="1981200">i</span><span class="op" id="1981201">++</span>&nbsp;<span class="op" id="1981204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981209">pd</span>&nbsp;<span class="op" id="1981212">:=</span>&nbsp;<span class="op" id="1981215">(</span><span class="op" id="1981216">*</span><span class="ident" id="1981217">pollDesc</span><span class="op" id="1981225">)</span><span class="op" id="1981226">(</span><span class="ident" id="1981227">add</span><span class="op" id="1981230">(</span><span class="ident" id="1981231">mem</span><span class="op" id="1981234">,</span>&nbsp;<span class="ident" id="1981236">i</span><span class="op" id="1981237">*</span><span class="ident" id="1981238">pdSize</span><span class="op" id="1981244">)</span><span class="op" id="1981245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981250">pd</span><span class="op" id="1981252">.</span><span class="ident" id="1981253">link</span>&nbsp;<span class="op" id="1981258">=</span>&nbsp;<span class="ident" id="1981260">c</span><span class="op" id="1981261">.</span><span class="ident" id="1981262">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981271">c</span><span class="op" id="1981272">.</span><span class="ident" id="1981273">first</span>&nbsp;<span class="op" id="1981279">=</span>&nbsp;<span class="ident" id="1981281">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1981286">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1981289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981292">pd</span>&nbsp;<span class="op" id="1981295">:=</span>&nbsp;<span class="ident" id="1981298">c</span><span class="op" id="1981299">.</span><span class="ident" id="1981300">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981307">c</span><span class="op" id="1981308">.</span><span class="ident" id="1981309">first</span>&nbsp;<span class="op" id="1981315">=</span>&nbsp;<span class="ident" id="1981317">pd</span><span class="op" id="1981319">.</span><span class="ident" id="1981320">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981326">unlock</span><span class="op" id="1981332">(</span><span class="op" id="1981333">&amp;</span><span class="ident" id="1981334">c</span><span class="op" id="1981335">.</span><span class="ident" id="1981336">lock</span><span class="op" id="1981340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1981343">return</span>&nbsp;<span class="ident" id="1981350">pd</span><br>
<span class="lineno">455</span><span class="op" id="1981353">}</span>
</div>
</body>
</html>
