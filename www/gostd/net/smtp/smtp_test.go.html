<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/smtp</h2>
<ul>
<li><a href="/gostd/net/smtp/auth.go.html">auth.go</a></li>
<li><a href="/gostd/net/smtp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/smtp/smtp.go.html">smtp.go</a></li>
<li><a href="/gostd/net/smtp/smtp_test.go.html" class="current">smtp_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7092350">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7092405">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7092459">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7092510">package</span>&nbsp;<span class="ident" id="7092518">smtp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7092524">import</span>&nbsp;<span class="op" id="7092531">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7092534">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7092543">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7092552">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7092566">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7092581">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7092587">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7092594">&#34;net/textproto&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7092611">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7092622">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7092633">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7092640">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="7092643">type</span>&nbsp;<span class="ident" id="7092648">authTest</span>&nbsp;<span class="keyword" id="7092657">struct</span>&nbsp;<span class="op" id="7092664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7092667">auth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092678">Auth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7092684">challenges</span>&nbsp;<span class="op" id="7092695">[</span><span class="op" id="7092696">]</span><span class="builtintype" id="7092697">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7092705">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7092716">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7092724">responses</span>&nbsp;&nbsp;<span class="op" id="7092735">[</span><span class="op" id="7092736">]</span><span class="builtintype" id="7092737">string</span><br>
<span class="lineno">25</span><span class="op" id="7092744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7092747">var</span>&nbsp;<span class="ident" id="7092751">authTests</span>&nbsp;<span class="op" id="7092761">=</span>&nbsp;<span class="op" id="7092763">[</span><span class="op" id="7092764">]</span><span class="ident" id="7092765">authTest</span><span class="op" id="7092773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7092776">{</span><span class="ident" id="7092777">PlainAuth</span><span class="op" id="7092786">(</span><span class="string" id="7092787">&#34;&#34;</span><span class="op" id="7092789">,</span>&nbsp;<span class="string" id="7092791">&#34;user&#34;</span><span class="op" id="7092797">,</span>&nbsp;<span class="string" id="7092799">&#34;pass&#34;</span><span class="op" id="7092805">,</span>&nbsp;<span class="string" id="7092807">&#34;testserver&#34;</span><span class="op" id="7092819">)</span><span class="op" id="7092820">,</span>&nbsp;<span class="op" id="7092822">[</span><span class="op" id="7092823">]</span><span class="builtintype" id="7092824">string</span><span class="op" id="7092830">{</span><span class="op" id="7092831">}</span><span class="op" id="7092832">,</span>&nbsp;<span class="string" id="7092834">&#34;PLAIN&#34;</span><span class="op" id="7092841">,</span>&nbsp;<span class="op" id="7092843">[</span><span class="op" id="7092844">]</span><span class="builtintype" id="7092845">string</span><span class="op" id="7092851">{</span><span class="string" id="7092852">&#34;\x00user\x00pass&#34;</span><span class="op" id="7092870">}</span><span class="op" id="7092871">}</span><span class="op" id="7092872">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7092875">{</span><span class="ident" id="7092876">PlainAuth</span><span class="op" id="7092885">(</span><span class="string" id="7092886">&#34;foo&#34;</span><span class="op" id="7092891">,</span>&nbsp;<span class="string" id="7092893">&#34;bar&#34;</span><span class="op" id="7092898">,</span>&nbsp;<span class="string" id="7092900">&#34;baz&#34;</span><span class="op" id="7092905">,</span>&nbsp;<span class="string" id="7092907">&#34;testserver&#34;</span><span class="op" id="7092919">)</span><span class="op" id="7092920">,</span>&nbsp;<span class="op" id="7092922">[</span><span class="op" id="7092923">]</span><span class="builtintype" id="7092924">string</span><span class="op" id="7092930">{</span><span class="op" id="7092931">}</span><span class="op" id="7092932">,</span>&nbsp;<span class="string" id="7092934">&#34;PLAIN&#34;</span><span class="op" id="7092941">,</span>&nbsp;<span class="op" id="7092943">[</span><span class="op" id="7092944">]</span><span class="builtintype" id="7092945">string</span><span class="op" id="7092951">{</span><span class="string" id="7092952">&#34;foo\x00bar\x00baz&#34;</span><span class="op" id="7092971">}</span><span class="op" id="7092972">}</span><span class="op" id="7092973">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7092976">{</span><span class="ident" id="7092977">CRAMMD5Auth</span><span class="op" id="7092988">(</span><span class="string" id="7092989">&#34;user&#34;</span><span class="op" id="7092995">,</span>&nbsp;<span class="string" id="7092997">&#34;pass&#34;</span><span class="op" id="7093003">)</span><span class="op" id="7093004">,</span>&nbsp;<span class="op" id="7093006">[</span><span class="op" id="7093007">]</span><span class="builtintype" id="7093008">string</span><span class="op" id="7093014">{</span><span class="string" id="7093015">&#34;&lt;123456.1322876914@testserver&gt;&#34;</span><span class="op" id="7093047">}</span><span class="op" id="7093048">,</span>&nbsp;<span class="string" id="7093050">&#34;CRAM-MD5&#34;</span><span class="op" id="7093060">,</span>&nbsp;<span class="op" id="7093062">[</span><span class="op" id="7093063">]</span><span class="builtintype" id="7093064">string</span><span class="op" id="7093070">{</span><span class="string" id="7093071">&#34;&#34;</span><span class="op" id="7093073">,</span>&nbsp;<span class="string" id="7093075">&#34;user&nbsp;287eb355114cf5c471c26a875f1ca4ae&#34;</span><span class="op" id="7093114">}</span><span class="op" id="7093115">}</span><span class="op" id="7093116">,</span><br>
<span class="lineno"></span><span class="op" id="7093118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7093121">func</span>&nbsp;<span class="ident" id="7093126">TestAuth</span><span class="op" id="7093134">(</span><span class="ident" id="7093135">t</span>&nbsp;<span class="op" id="7093137">*</span><span class="ident" id="7093138">testing</span><span class="op" id="7093145">.</span><span class="ident" id="7093146">T</span><span class="op" id="7093147">)</span>&nbsp;<span class="op" id="7093149">{</span><br>
<span class="lineno"></span><span class="ident" id="7093151">testLoop</span><span class="op" id="7093159">:</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7093162">for</span>&nbsp;<span class="ident" id="7093166">i</span><span class="op" id="7093167">,</span>&nbsp;<span class="ident" id="7093169">test</span>&nbsp;<span class="op" id="7093174">:=</span>&nbsp;<span class="keyword" id="7093177">range</span>&nbsp;<span class="ident" id="7093183">authTests</span>&nbsp;<span class="op" id="7093193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7093197">name</span><span class="op" id="7093201">,</span>&nbsp;<span class="ident" id="7093203">resp</span><span class="op" id="7093207">,</span>&nbsp;<span class="ident" id="7093209">err</span>&nbsp;<span class="op" id="7093213">:=</span>&nbsp;<span class="ident" id="7093216">test</span><span class="op" id="7093220">.</span><span class="ident" id="7093221">auth</span><span class="op" id="7093225">.</span><span class="ident" id="7093226">Start</span><span class="op" id="7093231">(</span><span class="op" id="7093232">&amp;</span><span class="ident" id="7093233">ServerInfo</span><span class="op" id="7093243">{</span><span class="string" id="7093244">&#34;testserver&#34;</span><span class="op" id="7093256">,</span>&nbsp;<span class="builtintype" id="7093258">true</span><span class="op" id="7093262">,</span>&nbsp;<span class="ident" id="7093264">nil</span><span class="op" id="7093267">}</span><span class="op" id="7093268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7093272">if</span>&nbsp;<span class="ident" id="7093275">name</span>&nbsp;<span class="op" id="7093280">!=</span>&nbsp;<span class="ident" id="7093283">test</span><span class="op" id="7093287">.</span><span class="ident" id="7093288">name</span>&nbsp;<span class="op" id="7093293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7093298">t</span><span class="op" id="7093299">.</span><span class="ident" id="7093300">Errorf</span><span class="op" id="7093306">(</span><span class="string" id="7093307">&#34;#%d&nbsp;got&nbsp;name&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="7093337">,</span>&nbsp;<span class="ident" id="7093339">i</span><span class="op" id="7093340">,</span>&nbsp;<span class="ident" id="7093342">name</span><span class="op" id="7093346">,</span>&nbsp;<span class="ident" id="7093348">test</span><span class="op" id="7093352">.</span><span class="ident" id="7093353">name</span><span class="op" id="7093357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7093361">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7093365">if</span>&nbsp;<span class="op" id="7093368">!</span><span class="ident" id="7093369">bytes</span><span class="op" id="7093374">.</span><span class="ident" id="7093375">Equal</span><span class="op" id="7093380">(</span><span class="ident" id="7093381">resp</span><span class="op" id="7093385">,</span>&nbsp;<span class="op" id="7093387">[</span><span class="op" id="7093388">]</span><span class="builtintype" id="7093389">byte</span><span class="op" id="7093393">(</span><span class="ident" id="7093394">test</span><span class="op" id="7093398">.</span><span class="ident" id="7093399">responses</span><span class="op" id="7093408">[</span><span class="num" id="7093409">0</span><span class="op" id="7093410">]</span><span class="op" id="7093411">)</span><span class="op" id="7093412">)</span>&nbsp;<span class="op" id="7093414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7093419">t</span><span class="op" id="7093420">.</span><span class="ident" id="7093421">Errorf</span><span class="op" id="7093427">(</span><span class="string" id="7093428">&#34;#%d&nbsp;got&nbsp;response&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="7093462">,</span>&nbsp;<span class="ident" id="7093464">i</span><span class="op" id="7093465">,</span>&nbsp;<span class="ident" id="7093467">resp</span><span class="op" id="7093471">,</span>&nbsp;<span class="ident" id="7093473">test</span><span class="op" id="7093477">.</span><span class="ident" id="7093478">responses</span><span class="op" id="7093487">[</span><span class="num" id="7093488">0</span><span class="op" id="7093489">]</span><span class="op" id="7093490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7093494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7093498">if</span>&nbsp;<span class="ident" id="7093501">err</span>&nbsp;<span class="op" id="7093505">!=</span>&nbsp;<span class="ident" id="7093508">nil</span>&nbsp;<span class="op" id="7093512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7093517">t</span><span class="op" id="7093518">.</span><span class="ident" id="7093519">Errorf</span><span class="op" id="7093525">(</span><span class="string" id="7093526">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="7093541">,</span>&nbsp;<span class="ident" id="7093543">i</span><span class="op" id="7093544">,</span>&nbsp;<span class="ident" id="7093546">err</span><span class="op" id="7093549">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7093553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7093557">for</span>&nbsp;<span class="ident" id="7093561">j</span>&nbsp;<span class="op" id="7093563">:=</span>&nbsp;<span class="keyword" id="7093566">range</span>&nbsp;<span class="ident" id="7093572">test</span><span class="op" id="7093576">.</span><span class="ident" id="7093577">challenges</span>&nbsp;<span class="op" id="7093588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7093593">challenge</span>&nbsp;<span class="op" id="7093603">:=</span>&nbsp;<span class="op" id="7093606">[</span><span class="op" id="7093607">]</span><span class="builtintype" id="7093608">byte</span><span class="op" id="7093612">(</span><span class="ident" id="7093613">test</span><span class="op" id="7093617">.</span><span class="ident" id="7093618">challenges</span><span class="op" id="7093628">[</span><span class="ident" id="7093629">j</span><span class="op" id="7093630">]</span><span class="op" id="7093631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7093636">expected</span>&nbsp;<span class="op" id="7093645">:=</span>&nbsp;<span class="op" id="7093648">[</span><span class="op" id="7093649">]</span><span class="builtintype" id="7093650">byte</span><span class="op" id="7093654">(</span><span class="ident" id="7093655">test</span><span class="op" id="7093659">.</span><span class="ident" id="7093660">responses</span><span class="op" id="7093669">[</span><span class="ident" id="7093670">j</span><span class="op" id="7093671">+</span><span class="num" id="7093672">1</span><span class="op" id="7093673">]</span><span class="op" id="7093674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7093679">resp</span><span class="op" id="7093683">,</span>&nbsp;<span class="ident" id="7093685">err</span>&nbsp;<span class="op" id="7093689">:=</span>&nbsp;<span class="ident" id="7093692">test</span><span class="op" id="7093696">.</span><span class="ident" id="7093697">auth</span><span class="op" id="7093701">.</span><span class="ident" id="7093702">Next</span><span class="op" id="7093706">(</span><span class="ident" id="7093707">challenge</span><span class="op" id="7093716">,</span>&nbsp;<span class="builtintype" id="7093718">true</span><span class="op" id="7093722">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7093727">if</span>&nbsp;<span class="ident" id="7093730">err</span>&nbsp;<span class="op" id="7093734">!=</span>&nbsp;<span class="ident" id="7093737">nil</span>&nbsp;<span class="op" id="7093741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7093747">t</span><span class="op" id="7093748">.</span><span class="ident" id="7093749">Errorf</span><span class="op" id="7093755">(</span><span class="string" id="7093756">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="7093771">,</span>&nbsp;<span class="ident" id="7093773">i</span><span class="op" id="7093774">,</span>&nbsp;<span class="ident" id="7093776">err</span><span class="op" id="7093779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7093785">continue</span>&nbsp;<span class="ident" id="7093794">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7093806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7093811">if</span>&nbsp;<span class="op" id="7093814">!</span><span class="ident" id="7093815">bytes</span><span class="op" id="7093820">.</span><span class="ident" id="7093821">Equal</span><span class="op" id="7093826">(</span><span class="ident" id="7093827">resp</span><span class="op" id="7093831">,</span>&nbsp;<span class="ident" id="7093833">expected</span><span class="op" id="7093841">)</span>&nbsp;<span class="op" id="7093843">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7093849">t</span><span class="op" id="7093850">.</span><span class="ident" id="7093851">Errorf</span><span class="op" id="7093857">(</span><span class="string" id="7093858">&#34;#%d&nbsp;got&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="7093883">,</span>&nbsp;<span class="ident" id="7093885">i</span><span class="op" id="7093886">,</span>&nbsp;<span class="ident" id="7093888">resp</span><span class="op" id="7093892">,</span>&nbsp;<span class="ident" id="7093894">expected</span><span class="op" id="7093902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7093908">continue</span>&nbsp;<span class="ident" id="7093917">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7093929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7093933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7093936">}</span><br>
<span class="lineno">60</span><span class="op" id="7093938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7093941">func</span>&nbsp;<span class="ident" id="7093946">TestAuthPlain</span><span class="op" id="7093959">(</span><span class="ident" id="7093960">t</span>&nbsp;<span class="op" id="7093962">*</span><span class="ident" id="7093963">testing</span><span class="op" id="7093970">.</span><span class="ident" id="7093971">T</span><span class="op" id="7093972">)</span>&nbsp;<span class="op" id="7093974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7093977">auth</span>&nbsp;<span class="op" id="7093982">:=</span>&nbsp;<span class="ident" id="7093985">PlainAuth</span><span class="op" id="7093994">(</span><span class="string" id="7093995">&#34;foo&#34;</span><span class="op" id="7094000">,</span>&nbsp;<span class="string" id="7094002">&#34;bar&#34;</span><span class="op" id="7094007">,</span>&nbsp;<span class="string" id="7094009">&#34;baz&#34;</span><span class="op" id="7094014">,</span>&nbsp;<span class="string" id="7094016">&#34;servername&#34;</span><span class="op" id="7094028">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7094032">tests</span>&nbsp;<span class="op" id="7094038">:=</span>&nbsp;<span class="op" id="7094041">[</span><span class="op" id="7094042">]</span><span class="keyword" id="7094043">struct</span>&nbsp;<span class="op" id="7094050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7094054">server</span>&nbsp;<span class="op" id="7094061">*</span><span class="ident" id="7094062">ServerInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7094075">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7094082">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7094090">}</span><span class="op" id="7094091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7094095">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7094100">server</span><span class="op" id="7094106">:</span>&nbsp;<span class="op" id="7094108">&amp;</span><span class="ident" id="7094109">ServerInfo</span><span class="op" id="7094119">{</span><span class="ident" id="7094120">Name</span><span class="op" id="7094124">:</span>&nbsp;<span class="string" id="7094126">&#34;servername&#34;</span><span class="op" id="7094138">,</span>&nbsp;<span class="ident" id="7094140">TLS</span><span class="op" id="7094143">:</span>&nbsp;<span class="builtintype" id="7094145">true</span><span class="op" id="7094149">}</span><span class="op" id="7094150">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7094154">}</span><span class="op" id="7094155">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7094159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7094164">//&nbsp;Okay;&nbsp;explicitly&nbsp;advertised&nbsp;by&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7094209">server</span><span class="op" id="7094215">:</span>&nbsp;<span class="op" id="7094217">&amp;</span><span class="ident" id="7094218">ServerInfo</span><span class="op" id="7094228">{</span><span class="ident" id="7094229">Name</span><span class="op" id="7094233">:</span>&nbsp;<span class="string" id="7094235">&#34;servername&#34;</span><span class="op" id="7094247">,</span>&nbsp;<span class="ident" id="7094249">Auth</span><span class="op" id="7094253">:</span>&nbsp;<span class="op" id="7094255">[</span><span class="op" id="7094256">]</span><span class="builtintype" id="7094257">string</span><span class="op" id="7094263">{</span><span class="string" id="7094264">&#34;PLAIN&#34;</span><span class="op" id="7094271">}</span><span class="op" id="7094272">}</span><span class="op" id="7094273">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7094277">}</span><span class="op" id="7094278">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7094282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7094287">server</span><span class="op" id="7094293">:</span>&nbsp;<span class="op" id="7094295">&amp;</span><span class="ident" id="7094296">ServerInfo</span><span class="op" id="7094306">{</span><span class="ident" id="7094307">Name</span><span class="op" id="7094311">:</span>&nbsp;<span class="string" id="7094313">&#34;servername&#34;</span><span class="op" id="7094325">,</span>&nbsp;<span class="ident" id="7094327">Auth</span><span class="op" id="7094331">:</span>&nbsp;<span class="op" id="7094333">[</span><span class="op" id="7094334">]</span><span class="builtintype" id="7094335">string</span><span class="op" id="7094341">{</span><span class="string" id="7094342">&#34;CRAM-MD5&#34;</span><span class="op" id="7094352">}</span><span class="op" id="7094353">}</span><span class="op" id="7094354">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7094359">err</span><span class="op" id="7094362">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7094367">&#34;unencrypted&nbsp;connection&#34;</span><span class="op" id="7094391">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7094395">}</span><span class="op" id="7094396">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7094400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7094405">server</span><span class="op" id="7094411">:</span>&nbsp;<span class="op" id="7094413">&amp;</span><span class="ident" id="7094414">ServerInfo</span><span class="op" id="7094424">{</span><span class="ident" id="7094425">Name</span><span class="op" id="7094429">:</span>&nbsp;<span class="string" id="7094431">&#34;attacker&#34;</span><span class="op" id="7094441">,</span>&nbsp;<span class="ident" id="7094443">TLS</span><span class="op" id="7094446">:</span>&nbsp;<span class="builtintype" id="7094448">true</span><span class="op" id="7094452">}</span><span class="op" id="7094453">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7094458">err</span><span class="op" id="7094461">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7094466">&#34;wrong&nbsp;host&nbsp;name&#34;</span><span class="op" id="7094483">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7094487">}</span><span class="op" id="7094488">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7094491">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7094494">for</span>&nbsp;<span class="ident" id="7094498">i</span><span class="op" id="7094499">,</span>&nbsp;<span class="ident" id="7094501">tt</span>&nbsp;<span class="op" id="7094504">:=</span>&nbsp;<span class="keyword" id="7094507">range</span>&nbsp;<span class="ident" id="7094513">tests</span>&nbsp;<span class="op" id="7094519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7094523">_</span><span class="op" id="7094524">,</span>&nbsp;<span class="ident" id="7094526">_</span><span class="op" id="7094527">,</span>&nbsp;<span class="ident" id="7094529">err</span>&nbsp;<span class="op" id="7094533">:=</span>&nbsp;<span class="ident" id="7094536">auth</span><span class="op" id="7094540">.</span><span class="ident" id="7094541">Start</span><span class="op" id="7094546">(</span><span class="ident" id="7094547">tt</span><span class="op" id="7094549">.</span><span class="ident" id="7094550">server</span><span class="op" id="7094556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7094560">got</span>&nbsp;<span class="op" id="7094564">:=</span>&nbsp;<span class="string" id="7094567">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7094572">if</span>&nbsp;<span class="ident" id="7094575">err</span>&nbsp;<span class="op" id="7094579">!=</span>&nbsp;<span class="ident" id="7094582">nil</span>&nbsp;<span class="op" id="7094586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7094591">got</span>&nbsp;<span class="op" id="7094595">=</span>&nbsp;<span class="ident" id="7094597">err</span><span class="op" id="7094600">.</span><span class="ident" id="7094601">Error</span><span class="op" id="7094606">(</span><span class="op" id="7094607">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7094611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7094615">if</span>&nbsp;<span class="ident" id="7094618">got</span>&nbsp;<span class="op" id="7094622">!=</span>&nbsp;<span class="ident" id="7094625">tt</span><span class="op" id="7094627">.</span><span class="ident" id="7094628">err</span>&nbsp;<span class="op" id="7094632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7094637">t</span><span class="op" id="7094638">.</span><span class="ident" id="7094639">Errorf</span><span class="op" id="7094645">(</span><span class="string" id="7094646">&#34;%d.&nbsp;got&nbsp;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7094675">,</span>&nbsp;<span class="ident" id="7094677">i</span><span class="op" id="7094678">,</span>&nbsp;<span class="ident" id="7094680">got</span><span class="op" id="7094683">,</span>&nbsp;<span class="ident" id="7094685">tt</span><span class="op" id="7094687">.</span><span class="ident" id="7094688">err</span><span class="op" id="7094691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7094695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7094698">}</span><br>
<span class="lineno">95</span><span class="op" id="7094700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7094703">type</span>&nbsp;<span class="ident" id="7094708">faker</span>&nbsp;<span class="keyword" id="7094714">struct</span>&nbsp;<span class="op" id="7094721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7094724">io</span><span class="op" id="7094726">.</span><span class="ident" id="7094727">ReadWriter</span><br>
<span class="lineno"></span><span class="op" id="7094738">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="7094741">func</span>&nbsp;<span class="op" id="7094746">(</span><span class="ident" id="7094747">f</span>&nbsp;<span class="ident" id="7094749">faker</span><span class="op" id="7094754">)</span>&nbsp;<span class="ident" id="7094756">Close</span><span class="op" id="7094761">(</span><span class="op" id="7094762">)</span>&nbsp;<span class="builtintype" id="7094764">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7094790">{</span>&nbsp;<span class="keyword" id="7094792">return</span>&nbsp;<span class="ident" id="7094799">nil</span>&nbsp;<span class="op" id="7094803">}</span><br>
<span class="lineno"></span><span class="keyword" id="7094805">func</span>&nbsp;<span class="op" id="7094810">(</span><span class="ident" id="7094811">f</span>&nbsp;<span class="ident" id="7094813">faker</span><span class="op" id="7094818">)</span>&nbsp;<span class="ident" id="7094820">LocalAddr</span><span class="op" id="7094829">(</span><span class="op" id="7094830">)</span>&nbsp;<span class="ident" id="7094832">net</span><span class="op" id="7094835">.</span><span class="ident" id="7094836">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7094854">{</span>&nbsp;<span class="keyword" id="7094856">return</span>&nbsp;<span class="ident" id="7094863">nil</span>&nbsp;<span class="op" id="7094867">}</span><br>
<span class="lineno"></span><span class="keyword" id="7094869">func</span>&nbsp;<span class="op" id="7094874">(</span><span class="ident" id="7094875">f</span>&nbsp;<span class="ident" id="7094877">faker</span><span class="op" id="7094882">)</span>&nbsp;<span class="ident" id="7094884">RemoteAddr</span><span class="op" id="7094894">(</span><span class="op" id="7094895">)</span>&nbsp;<span class="ident" id="7094897">net</span><span class="op" id="7094900">.</span><span class="ident" id="7094901">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7094918">{</span>&nbsp;<span class="keyword" id="7094920">return</span>&nbsp;<span class="ident" id="7094927">nil</span>&nbsp;<span class="op" id="7094931">}</span><br>
<span class="lineno"></span><span class="keyword" id="7094933">func</span>&nbsp;<span class="op" id="7094938">(</span><span class="ident" id="7094939">f</span>&nbsp;<span class="ident" id="7094941">faker</span><span class="op" id="7094946">)</span>&nbsp;<span class="ident" id="7094948">SetDeadline</span><span class="op" id="7094959">(</span><span class="ident" id="7094960">time</span><span class="op" id="7094964">.</span><span class="ident" id="7094965">Time</span><span class="op" id="7094969">)</span>&nbsp;<span class="builtintype" id="7094971">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7094982">{</span>&nbsp;<span class="keyword" id="7094984">return</span>&nbsp;<span class="ident" id="7094991">nil</span>&nbsp;<span class="op" id="7094995">}</span><br>
<span class="lineno">105</span><span class="keyword" id="7094997">func</span>&nbsp;<span class="op" id="7095002">(</span><span class="ident" id="7095003">f</span>&nbsp;<span class="ident" id="7095005">faker</span><span class="op" id="7095010">)</span>&nbsp;<span class="ident" id="7095012">SetReadDeadline</span><span class="op" id="7095027">(</span><span class="ident" id="7095028">time</span><span class="op" id="7095032">.</span><span class="ident" id="7095033">Time</span><span class="op" id="7095037">)</span>&nbsp;<span class="builtintype" id="7095039">error</span>&nbsp;&nbsp;<span class="op" id="7095046">{</span>&nbsp;<span class="keyword" id="7095048">return</span>&nbsp;<span class="ident" id="7095055">nil</span>&nbsp;<span class="op" id="7095059">}</span><br>
<span class="lineno"></span><span class="keyword" id="7095061">func</span>&nbsp;<span class="op" id="7095066">(</span><span class="ident" id="7095067">f</span>&nbsp;<span class="ident" id="7095069">faker</span><span class="op" id="7095074">)</span>&nbsp;<span class="ident" id="7095076">SetWriteDeadline</span><span class="op" id="7095092">(</span><span class="ident" id="7095093">time</span><span class="op" id="7095097">.</span><span class="ident" id="7095098">Time</span><span class="op" id="7095102">)</span>&nbsp;<span class="builtintype" id="7095104">error</span>&nbsp;<span class="op" id="7095110">{</span>&nbsp;<span class="keyword" id="7095112">return</span>&nbsp;<span class="ident" id="7095119">nil</span>&nbsp;<span class="op" id="7095123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7095126">func</span>&nbsp;<span class="ident" id="7095131">TestBasic</span><span class="op" id="7095140">(</span><span class="ident" id="7095141">t</span>&nbsp;<span class="op" id="7095143">*</span><span class="ident" id="7095144">testing</span><span class="op" id="7095151">.</span><span class="ident" id="7095152">T</span><span class="op" id="7095153">)</span>&nbsp;<span class="op" id="7095155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7095158">server</span>&nbsp;<span class="op" id="7095165">:=</span>&nbsp;<span class="ident" id="7095168">strings</span><span class="op" id="7095175">.</span><span class="ident" id="7095176">Join</span><span class="op" id="7095180">(</span><span class="ident" id="7095181">strings</span><span class="op" id="7095188">.</span><span class="ident" id="7095189">Split</span><span class="op" id="7095194">(</span><span class="ident" id="7095195">basicServer</span><span class="op" id="7095206">,</span>&nbsp;<span class="string" id="7095208">&#34;\n&#34;</span><span class="op" id="7095212">)</span><span class="op" id="7095213">,</span>&nbsp;<span class="string" id="7095215">&#34;\r\n&#34;</span><span class="op" id="7095221">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7095224">client</span>&nbsp;<span class="op" id="7095231">:=</span>&nbsp;<span class="ident" id="7095234">strings</span><span class="op" id="7095241">.</span><span class="ident" id="7095242">Join</span><span class="op" id="7095246">(</span><span class="ident" id="7095247">strings</span><span class="op" id="7095254">.</span><span class="ident" id="7095255">Split</span><span class="op" id="7095260">(</span><span class="ident" id="7095261">basicClient</span><span class="op" id="7095272">,</span>&nbsp;<span class="string" id="7095274">&#34;\n&#34;</span><span class="op" id="7095278">)</span><span class="op" id="7095279">,</span>&nbsp;<span class="string" id="7095281">&#34;\r\n&#34;</span><span class="op" id="7095287">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7095291">var</span>&nbsp;<span class="ident" id="7095295">cmdbuf</span>&nbsp;<span class="ident" id="7095302">bytes</span><span class="op" id="7095307">.</span><span class="ident" id="7095308">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7095316">bcmdbuf</span>&nbsp;<span class="op" id="7095324">:=</span>&nbsp;<span class="ident" id="7095327">bufio</span><span class="op" id="7095332">.</span><span class="ident" id="7095333">NewWriter</span><span class="op" id="7095342">(</span><span class="op" id="7095343">&amp;</span><span class="ident" id="7095344">cmdbuf</span><span class="op" id="7095350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7095353">var</span>&nbsp;<span class="ident" id="7095357">fake</span>&nbsp;<span class="ident" id="7095362">faker</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7095369">fake</span><span class="op" id="7095373">.</span><span class="ident" id="7095374">ReadWriter</span>&nbsp;<span class="op" id="7095385">=</span>&nbsp;<span class="ident" id="7095387">bufio</span><span class="op" id="7095392">.</span><span class="ident" id="7095393">NewReadWriter</span><span class="op" id="7095406">(</span><span class="ident" id="7095407">bufio</span><span class="op" id="7095412">.</span><span class="ident" id="7095413">NewReader</span><span class="op" id="7095422">(</span><span class="ident" id="7095423">strings</span><span class="op" id="7095430">.</span><span class="ident" id="7095431">NewReader</span><span class="op" id="7095440">(</span><span class="ident" id="7095441">server</span><span class="op" id="7095447">)</span><span class="op" id="7095448">)</span><span class="op" id="7095449">,</span>&nbsp;<span class="ident" id="7095451">bcmdbuf</span><span class="op" id="7095458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7095461">c</span>&nbsp;<span class="op" id="7095463">:=</span>&nbsp;<span class="op" id="7095466">&amp;</span><span class="ident" id="7095467">Client</span><span class="op" id="7095473">{</span><span class="ident" id="7095474">Text</span><span class="op" id="7095478">:</span>&nbsp;<span class="ident" id="7095480">textproto</span><span class="op" id="7095489">.</span><span class="ident" id="7095490">NewConn</span><span class="op" id="7095497">(</span><span class="ident" id="7095498">fake</span><span class="op" id="7095502">)</span><span class="op" id="7095503">,</span>&nbsp;<span class="ident" id="7095505">localName</span><span class="op" id="7095514">:</span>&nbsp;<span class="string" id="7095516">&#34;localhost&#34;</span><span class="op" id="7095527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7095531">if</span>&nbsp;<span class="ident" id="7095534">err</span>&nbsp;<span class="op" id="7095538">:=</span>&nbsp;<span class="ident" id="7095541">c</span><span class="op" id="7095542">.</span><span class="ident" id="7095543">helo</span><span class="op" id="7095547">(</span><span class="op" id="7095548">)</span><span class="op" id="7095549">;</span>&nbsp;<span class="ident" id="7095551">err</span>&nbsp;<span class="op" id="7095555">!=</span>&nbsp;<span class="ident" id="7095558">nil</span>&nbsp;<span class="op" id="7095562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7095566">t</span><span class="op" id="7095567">.</span><span class="ident" id="7095568">Fatalf</span><span class="op" id="7095574">(</span><span class="string" id="7095575">&#34;HELO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7095592">,</span>&nbsp;<span class="ident" id="7095594">err</span><span class="op" id="7095597">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7095600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7095603">if</span>&nbsp;<span class="ident" id="7095606">err</span>&nbsp;<span class="op" id="7095610">:=</span>&nbsp;<span class="ident" id="7095613">c</span><span class="op" id="7095614">.</span><span class="ident" id="7095615">ehlo</span><span class="op" id="7095619">(</span><span class="op" id="7095620">)</span><span class="op" id="7095621">;</span>&nbsp;<span class="ident" id="7095623">err</span>&nbsp;<span class="op" id="7095627">==</span>&nbsp;<span class="ident" id="7095630">nil</span>&nbsp;<span class="op" id="7095634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7095638">t</span><span class="op" id="7095639">.</span><span class="ident" id="7095640">Fatalf</span><span class="op" id="7095646">(</span><span class="string" id="7095647">&#34;Expected&nbsp;first&nbsp;EHLO&nbsp;to&nbsp;fail&#34;</span><span class="op" id="7095676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7095679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7095682">if</span>&nbsp;<span class="ident" id="7095685">err</span>&nbsp;<span class="op" id="7095689">:=</span>&nbsp;<span class="ident" id="7095692">c</span><span class="op" id="7095693">.</span><span class="ident" id="7095694">ehlo</span><span class="op" id="7095698">(</span><span class="op" id="7095699">)</span><span class="op" id="7095700">;</span>&nbsp;<span class="ident" id="7095702">err</span>&nbsp;<span class="op" id="7095706">!=</span>&nbsp;<span class="ident" id="7095709">nil</span>&nbsp;<span class="op" id="7095713">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7095717">t</span><span class="op" id="7095718">.</span><span class="ident" id="7095719">Fatalf</span><span class="op" id="7095725">(</span><span class="string" id="7095726">&#34;Second&nbsp;EHLO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7095750">,</span>&nbsp;<span class="ident" id="7095752">err</span><span class="op" id="7095755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7095758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7095762">c</span><span class="op" id="7095763">.</span><span class="ident" id="7095764">didHello</span>&nbsp;<span class="op" id="7095773">=</span>&nbsp;<span class="builtintype" id="7095775">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7095781">if</span>&nbsp;<span class="ident" id="7095784">ok</span><span class="op" id="7095786">,</span>&nbsp;<span class="ident" id="7095788">args</span>&nbsp;<span class="op" id="7095793">:=</span>&nbsp;<span class="ident" id="7095796">c</span><span class="op" id="7095797">.</span><span class="ident" id="7095798">Extension</span><span class="op" id="7095807">(</span><span class="string" id="7095808">&#34;aUtH&#34;</span><span class="op" id="7095814">)</span><span class="op" id="7095815">;</span>&nbsp;<span class="op" id="7095817">!</span><span class="ident" id="7095818">ok</span>&nbsp;<span class="op" id="7095821">||</span>&nbsp;<span class="ident" id="7095824">args</span>&nbsp;<span class="op" id="7095829">!=</span>&nbsp;<span class="string" id="7095832">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="7095846">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7095850">t</span><span class="op" id="7095851">.</span><span class="ident" id="7095852">Fatalf</span><span class="op" id="7095858">(</span><span class="string" id="7095859">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="7095884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7095887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7095890">if</span>&nbsp;<span class="ident" id="7095893">ok</span><span class="op" id="7095895">,</span>&nbsp;<span class="ident" id="7095897">_</span>&nbsp;<span class="op" id="7095899">:=</span>&nbsp;<span class="ident" id="7095902">c</span><span class="op" id="7095903">.</span><span class="ident" id="7095904">Extension</span><span class="op" id="7095913">(</span><span class="string" id="7095914">&#34;DSN&#34;</span><span class="op" id="7095919">)</span><span class="op" id="7095920">;</span>&nbsp;<span class="ident" id="7095922">ok</span>&nbsp;<span class="op" id="7095925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7095929">t</span><span class="op" id="7095930">.</span><span class="ident" id="7095931">Fatalf</span><span class="op" id="7095937">(</span><span class="string" id="7095938">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="7095961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7095964">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7095968">if</span>&nbsp;<span class="ident" id="7095971">err</span>&nbsp;<span class="op" id="7095975">:=</span>&nbsp;<span class="ident" id="7095978">c</span><span class="op" id="7095979">.</span><span class="ident" id="7095980">Mail</span><span class="op" id="7095984">(</span><span class="string" id="7095985">&#34;user@gmail.com&#34;</span><span class="op" id="7096001">)</span><span class="op" id="7096002">;</span>&nbsp;<span class="ident" id="7096004">err</span>&nbsp;<span class="op" id="7096008">==</span>&nbsp;<span class="ident" id="7096011">nil</span>&nbsp;<span class="op" id="7096015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7096019">t</span><span class="op" id="7096020">.</span><span class="ident" id="7096021">Fatalf</span><span class="op" id="7096027">(</span><span class="string" id="7096028">&#34;MAIL&nbsp;should&nbsp;require&nbsp;authentication&#34;</span><span class="op" id="7096064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7096067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7096071">if</span>&nbsp;<span class="ident" id="7096074">err</span>&nbsp;<span class="op" id="7096078">:=</span>&nbsp;<span class="ident" id="7096081">c</span><span class="op" id="7096082">.</span><span class="ident" id="7096083">Verify</span><span class="op" id="7096089">(</span><span class="string" id="7096090">&#34;user1@gmail.com&#34;</span><span class="op" id="7096107">)</span><span class="op" id="7096108">;</span>&nbsp;<span class="ident" id="7096110">err</span>&nbsp;<span class="op" id="7096114">==</span>&nbsp;<span class="ident" id="7096117">nil</span>&nbsp;<span class="op" id="7096121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7096125">t</span><span class="op" id="7096126">.</span><span class="ident" id="7096127">Fatalf</span><span class="op" id="7096133">(</span><span class="string" id="7096134">&#34;First&nbsp;VRFY:&nbsp;expected&nbsp;no&nbsp;verification&#34;</span><span class="op" id="7096172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7096175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7096178">if</span>&nbsp;<span class="ident" id="7096181">err</span>&nbsp;<span class="op" id="7096185">:=</span>&nbsp;<span class="ident" id="7096188">c</span><span class="op" id="7096189">.</span><span class="ident" id="7096190">Verify</span><span class="op" id="7096196">(</span><span class="string" id="7096197">&#34;user2@gmail.com&#34;</span><span class="op" id="7096214">)</span><span class="op" id="7096215">;</span>&nbsp;<span class="ident" id="7096217">err</span>&nbsp;<span class="op" id="7096221">!=</span>&nbsp;<span class="ident" id="7096224">nil</span>&nbsp;<span class="op" id="7096228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7096232">t</span><span class="op" id="7096233">.</span><span class="ident" id="7096234">Fatalf</span><span class="op" id="7096240">(</span><span class="string" id="7096241">&#34;Second&nbsp;VRFY:&nbsp;expected&nbsp;verification,&nbsp;got&nbsp;%s&#34;</span><span class="op" id="7096285">,</span>&nbsp;<span class="ident" id="7096287">err</span><span class="op" id="7096290">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7096293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7096297">//&nbsp;fake&nbsp;TLS&nbsp;so&nbsp;authentication&nbsp;won&#39;t&nbsp;complain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7096343">c</span><span class="op" id="7096344">.</span><span class="ident" id="7096345">tls</span>&nbsp;<span class="op" id="7096349">=</span>&nbsp;<span class="builtintype" id="7096351">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7096357">c</span><span class="op" id="7096358">.</span><span class="ident" id="7096359">serverName</span>&nbsp;<span class="op" id="7096370">=</span>&nbsp;<span class="string" id="7096372">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7096391">if</span>&nbsp;<span class="ident" id="7096394">err</span>&nbsp;<span class="op" id="7096398">:=</span>&nbsp;<span class="ident" id="7096401">c</span><span class="op" id="7096402">.</span><span class="ident" id="7096403">Auth</span><span class="op" id="7096407">(</span><span class="ident" id="7096408">PlainAuth</span><span class="op" id="7096417">(</span><span class="string" id="7096418">&#34;&#34;</span><span class="op" id="7096420">,</span>&nbsp;<span class="string" id="7096422">&#34;user&#34;</span><span class="op" id="7096428">,</span>&nbsp;<span class="string" id="7096430">&#34;pass&#34;</span><span class="op" id="7096436">,</span>&nbsp;<span class="string" id="7096438">&#34;smtp.google.com&#34;</span><span class="op" id="7096455">)</span><span class="op" id="7096456">)</span><span class="op" id="7096457">;</span>&nbsp;<span class="ident" id="7096459">err</span>&nbsp;<span class="op" id="7096463">!=</span>&nbsp;<span class="ident" id="7096466">nil</span>&nbsp;<span class="op" id="7096470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7096474">t</span><span class="op" id="7096475">.</span><span class="ident" id="7096476">Fatalf</span><span class="op" id="7096482">(</span><span class="string" id="7096483">&#34;AUTH&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7096500">,</span>&nbsp;<span class="ident" id="7096502">err</span><span class="op" id="7096505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7096508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7096512">if</span>&nbsp;<span class="ident" id="7096515">err</span>&nbsp;<span class="op" id="7096519">:=</span>&nbsp;<span class="ident" id="7096522">c</span><span class="op" id="7096523">.</span><span class="ident" id="7096524">Mail</span><span class="op" id="7096528">(</span><span class="string" id="7096529">&#34;user@gmail.com&#34;</span><span class="op" id="7096545">)</span><span class="op" id="7096546">;</span>&nbsp;<span class="ident" id="7096548">err</span>&nbsp;<span class="op" id="7096552">!=</span>&nbsp;<span class="ident" id="7096555">nil</span>&nbsp;<span class="op" id="7096559">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7096563">t</span><span class="op" id="7096564">.</span><span class="ident" id="7096565">Fatalf</span><span class="op" id="7096571">(</span><span class="string" id="7096572">&#34;MAIL&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7096589">,</span>&nbsp;<span class="ident" id="7096591">err</span><span class="op" id="7096594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7096597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7096600">if</span>&nbsp;<span class="ident" id="7096603">err</span>&nbsp;<span class="op" id="7096607">:=</span>&nbsp;<span class="ident" id="7096610">c</span><span class="op" id="7096611">.</span><span class="ident" id="7096612">Rcpt</span><span class="op" id="7096616">(</span><span class="string" id="7096617">&#34;golang-nuts@googlegroups.com&#34;</span><span class="op" id="7096647">)</span><span class="op" id="7096648">;</span>&nbsp;<span class="ident" id="7096650">err</span>&nbsp;<span class="op" id="7096654">!=</span>&nbsp;<span class="ident" id="7096657">nil</span>&nbsp;<span class="op" id="7096661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7096665">t</span><span class="op" id="7096666">.</span><span class="ident" id="7096667">Fatalf</span><span class="op" id="7096673">(</span><span class="string" id="7096674">&#34;RCPT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7096691">,</span>&nbsp;<span class="ident" id="7096693">err</span><span class="op" id="7096696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7096699">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7096702">msg</span>&nbsp;<span class="op" id="7096706">:=</span>&nbsp;<span class="string" id="7096709">`From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno"></span>Line&nbsp;1<br>
<span class="lineno">165</span>.Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7096826">w</span><span class="op" id="7096827">,</span>&nbsp;<span class="ident" id="7096829">err</span>&nbsp;<span class="op" id="7096833">:=</span>&nbsp;<span class="ident" id="7096836">c</span><span class="op" id="7096837">.</span><span class="ident" id="7096838">Data</span><span class="op" id="7096842">(</span><span class="op" id="7096843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7096846">if</span>&nbsp;<span class="ident" id="7096849">err</span>&nbsp;<span class="op" id="7096853">!=</span>&nbsp;<span class="ident" id="7096856">nil</span>&nbsp;<span class="op" id="7096860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7096864">t</span><span class="op" id="7096865">.</span><span class="ident" id="7096866">Fatalf</span><span class="op" id="7096872">(</span><span class="string" id="7096873">&#34;DATA&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7096890">,</span>&nbsp;<span class="ident" id="7096892">err</span><span class="op" id="7096895">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7096898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7096901">if</span>&nbsp;<span class="ident" id="7096904">_</span><span class="op" id="7096905">,</span>&nbsp;<span class="ident" id="7096907">err</span>&nbsp;<span class="op" id="7096911">:=</span>&nbsp;<span class="ident" id="7096914">w</span><span class="op" id="7096915">.</span><span class="ident" id="7096916">Write</span><span class="op" id="7096921">(</span><span class="op" id="7096922">[</span><span class="op" id="7096923">]</span><span class="builtintype" id="7096924">byte</span><span class="op" id="7096928">(</span><span class="ident" id="7096929">msg</span><span class="op" id="7096932">)</span><span class="op" id="7096933">)</span><span class="op" id="7096934">;</span>&nbsp;<span class="ident" id="7096936">err</span>&nbsp;<span class="op" id="7096940">!=</span>&nbsp;<span class="ident" id="7096943">nil</span>&nbsp;<span class="op" id="7096947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7096951">t</span><span class="op" id="7096952">.</span><span class="ident" id="7096953">Fatalf</span><span class="op" id="7096959">(</span><span class="string" id="7096960">&#34;Data&nbsp;write&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7096983">,</span>&nbsp;<span class="ident" id="7096985">err</span><span class="op" id="7096988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7096991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7096994">if</span>&nbsp;<span class="ident" id="7096997">err</span>&nbsp;<span class="op" id="7097001">:=</span>&nbsp;<span class="ident" id="7097004">w</span><span class="op" id="7097005">.</span><span class="ident" id="7097006">Close</span><span class="op" id="7097011">(</span><span class="op" id="7097012">)</span><span class="op" id="7097013">;</span>&nbsp;<span class="ident" id="7097015">err</span>&nbsp;<span class="op" id="7097019">!=</span>&nbsp;<span class="ident" id="7097022">nil</span>&nbsp;<span class="op" id="7097026">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7097030">t</span><span class="op" id="7097031">.</span><span class="ident" id="7097032">Fatalf</span><span class="op" id="7097038">(</span><span class="string" id="7097039">&#34;Bad&nbsp;data&nbsp;response:&nbsp;%s&#34;</span><span class="op" id="7097062">,</span>&nbsp;<span class="ident" id="7097064">err</span><span class="op" id="7097067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7097070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7097074">if</span>&nbsp;<span class="ident" id="7097077">err</span>&nbsp;<span class="op" id="7097081">:=</span>&nbsp;<span class="ident" id="7097084">c</span><span class="op" id="7097085">.</span><span class="ident" id="7097086">Quit</span><span class="op" id="7097090">(</span><span class="op" id="7097091">)</span><span class="op" id="7097092">;</span>&nbsp;<span class="ident" id="7097094">err</span>&nbsp;<span class="op" id="7097098">!=</span>&nbsp;<span class="ident" id="7097101">nil</span>&nbsp;<span class="op" id="7097105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7097109">t</span><span class="op" id="7097110">.</span><span class="ident" id="7097111">Fatalf</span><span class="op" id="7097117">(</span><span class="string" id="7097118">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7097135">,</span>&nbsp;<span class="ident" id="7097137">err</span><span class="op" id="7097140">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7097143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7097147">bcmdbuf</span><span class="op" id="7097154">.</span><span class="ident" id="7097155">Flush</span><span class="op" id="7097160">(</span><span class="op" id="7097161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7097164">actualcmds</span>&nbsp;<span class="op" id="7097175">:=</span>&nbsp;<span class="ident" id="7097178">cmdbuf</span><span class="op" id="7097184">.</span><span class="ident" id="7097185">String</span><span class="op" id="7097191">(</span><span class="op" id="7097192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7097195">if</span>&nbsp;<span class="ident" id="7097198">client</span>&nbsp;<span class="op" id="7097205">!=</span>&nbsp;<span class="ident" id="7097208">actualcmds</span>&nbsp;<span class="op" id="7097219">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7097223">t</span><span class="op" id="7097224">.</span><span class="ident" id="7097225">Fatalf</span><span class="op" id="7097231">(</span><span class="string" id="7097232">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7097257">,</span>&nbsp;<span class="ident" id="7097259">actualcmds</span><span class="op" id="7097269">,</span>&nbsp;<span class="ident" id="7097271">client</span><span class="op" id="7097277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7097280">}</span><br>
<span class="lineno"></span><span class="op" id="7097282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7097285">var</span>&nbsp;<span class="ident" id="7097289">basicServer</span>&nbsp;<span class="op" id="7097301">=</span>&nbsp;<span class="string" id="7097303">`250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno">190</span>502&nbsp;Unrecognized&nbsp;command.<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">195</span>530&nbsp;Authentication&nbsp;required<br>
<span class="lineno"></span>252&nbsp;Send&nbsp;some&nbsp;mail,&nbsp;I&#39;ll&nbsp;try&nbsp;my&nbsp;best<br>
<span class="lineno"></span>250&nbsp;User&nbsp;is&nbsp;valid<br>
<span class="lineno"></span>235&nbsp;Accepted<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;OK<br>
<span class="lineno">200</span>250&nbsp;Receiver&nbsp;OK<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;OK<br>
<span class="lineno"></span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="7097611">var</span>&nbsp;<span class="ident" id="7097615">basicClient</span>&nbsp;<span class="op" id="7097627">=</span>&nbsp;<span class="string" id="7097629">`HELO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno">210</span>VRFY&nbsp;user1@gmail.com<br>
<span class="lineno"></span>VRFY&nbsp;user2@gmail.com<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;golang-nuts@googlegroups.com&gt;<br>
<span class="lineno">215</span>DATA<br>
<span class="lineno"></span>From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno">220</span>Line&nbsp;1<br>
<span class="lineno"></span>..Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">225</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7097996">func</span>&nbsp;<span class="ident" id="7098001">TestNewClient</span><span class="op" id="7098014">(</span><span class="ident" id="7098015">t</span>&nbsp;<span class="op" id="7098017">*</span><span class="ident" id="7098018">testing</span><span class="op" id="7098025">.</span><span class="ident" id="7098026">T</span><span class="op" id="7098027">)</span>&nbsp;<span class="op" id="7098029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7098032">server</span>&nbsp;<span class="op" id="7098039">:=</span>&nbsp;<span class="ident" id="7098042">strings</span><span class="op" id="7098049">.</span><span class="ident" id="7098050">Join</span><span class="op" id="7098054">(</span><span class="ident" id="7098055">strings</span><span class="op" id="7098062">.</span><span class="ident" id="7098063">Split</span><span class="op" id="7098068">(</span><span class="ident" id="7098069">newClientServer</span><span class="op" id="7098084">,</span>&nbsp;<span class="string" id="7098086">&#34;\n&#34;</span><span class="op" id="7098090">)</span><span class="op" id="7098091">,</span>&nbsp;<span class="string" id="7098093">&#34;\r\n&#34;</span><span class="op" id="7098099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7098102">client</span>&nbsp;<span class="op" id="7098109">:=</span>&nbsp;<span class="ident" id="7098112">strings</span><span class="op" id="7098119">.</span><span class="ident" id="7098120">Join</span><span class="op" id="7098124">(</span><span class="ident" id="7098125">strings</span><span class="op" id="7098132">.</span><span class="ident" id="7098133">Split</span><span class="op" id="7098138">(</span><span class="ident" id="7098139">newClientClient</span><span class="op" id="7098154">,</span>&nbsp;<span class="string" id="7098156">&#34;\n&#34;</span><span class="op" id="7098160">)</span><span class="op" id="7098161">,</span>&nbsp;<span class="string" id="7098163">&#34;\r\n&#34;</span><span class="op" id="7098169">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7098173">var</span>&nbsp;<span class="ident" id="7098177">cmdbuf</span>&nbsp;<span class="ident" id="7098184">bytes</span><span class="op" id="7098189">.</span><span class="ident" id="7098190">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7098198">bcmdbuf</span>&nbsp;<span class="op" id="7098206">:=</span>&nbsp;<span class="ident" id="7098209">bufio</span><span class="op" id="7098214">.</span><span class="ident" id="7098215">NewWriter</span><span class="op" id="7098224">(</span><span class="op" id="7098225">&amp;</span><span class="ident" id="7098226">cmdbuf</span><span class="op" id="7098232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7098235">out</span>&nbsp;<span class="op" id="7098239">:=</span>&nbsp;<span class="keyword" id="7098242">func</span><span class="op" id="7098246">(</span><span class="op" id="7098247">)</span>&nbsp;<span class="builtintype" id="7098249">string</span>&nbsp;<span class="op" id="7098256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7098260">bcmdbuf</span><span class="op" id="7098267">.</span><span class="ident" id="7098268">Flush</span><span class="op" id="7098273">(</span><span class="op" id="7098274">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7098278">return</span>&nbsp;<span class="ident" id="7098285">cmdbuf</span><span class="op" id="7098291">.</span><span class="ident" id="7098292">String</span><span class="op" id="7098298">(</span><span class="op" id="7098299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7098302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7098305">var</span>&nbsp;<span class="ident" id="7098309">fake</span>&nbsp;<span class="ident" id="7098314">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7098321">fake</span><span class="op" id="7098325">.</span><span class="ident" id="7098326">ReadWriter</span>&nbsp;<span class="op" id="7098337">=</span>&nbsp;<span class="ident" id="7098339">bufio</span><span class="op" id="7098344">.</span><span class="ident" id="7098345">NewReadWriter</span><span class="op" id="7098358">(</span><span class="ident" id="7098359">bufio</span><span class="op" id="7098364">.</span><span class="ident" id="7098365">NewReader</span><span class="op" id="7098374">(</span><span class="ident" id="7098375">strings</span><span class="op" id="7098382">.</span><span class="ident" id="7098383">NewReader</span><span class="op" id="7098392">(</span><span class="ident" id="7098393">server</span><span class="op" id="7098399">)</span><span class="op" id="7098400">)</span><span class="op" id="7098401">,</span>&nbsp;<span class="ident" id="7098403">bcmdbuf</span><span class="op" id="7098410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7098413">c</span><span class="op" id="7098414">,</span>&nbsp;<span class="ident" id="7098416">err</span>&nbsp;<span class="op" id="7098420">:=</span>&nbsp;<span class="ident" id="7098423">NewClient</span><span class="op" id="7098432">(</span><span class="ident" id="7098433">fake</span><span class="op" id="7098437">,</span>&nbsp;<span class="string" id="7098439">&#34;fake.host&#34;</span><span class="op" id="7098450">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7098453">if</span>&nbsp;<span class="ident" id="7098456">err</span>&nbsp;<span class="op" id="7098460">!=</span>&nbsp;<span class="ident" id="7098463">nil</span>&nbsp;<span class="op" id="7098467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7098471">t</span><span class="op" id="7098472">.</span><span class="ident" id="7098473">Fatalf</span><span class="op" id="7098479">(</span><span class="string" id="7098480">&#34;NewClient:&nbsp;%v\n(after&nbsp;%v)&#34;</span><span class="op" id="7098507">,</span>&nbsp;<span class="ident" id="7098509">err</span><span class="op" id="7098512">,</span>&nbsp;<span class="ident" id="7098514">out</span><span class="op" id="7098517">(</span><span class="op" id="7098518">)</span><span class="op" id="7098519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7098522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7098525">defer</span>&nbsp;<span class="ident" id="7098531">c</span><span class="op" id="7098532">.</span><span class="ident" id="7098533">Close</span><span class="op" id="7098538">(</span><span class="op" id="7098539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7098542">if</span>&nbsp;<span class="ident" id="7098545">ok</span><span class="op" id="7098547">,</span>&nbsp;<span class="ident" id="7098549">args</span>&nbsp;<span class="op" id="7098554">:=</span>&nbsp;<span class="ident" id="7098557">c</span><span class="op" id="7098558">.</span><span class="ident" id="7098559">Extension</span><span class="op" id="7098568">(</span><span class="string" id="7098569">&#34;aUtH&#34;</span><span class="op" id="7098575">)</span><span class="op" id="7098576">;</span>&nbsp;<span class="op" id="7098578">!</span><span class="ident" id="7098579">ok</span>&nbsp;<span class="op" id="7098582">||</span>&nbsp;<span class="ident" id="7098585">args</span>&nbsp;<span class="op" id="7098590">!=</span>&nbsp;<span class="string" id="7098593">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="7098607">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7098611">t</span><span class="op" id="7098612">.</span><span class="ident" id="7098613">Fatalf</span><span class="op" id="7098619">(</span><span class="string" id="7098620">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="7098645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7098648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7098651">if</span>&nbsp;<span class="ident" id="7098654">ok</span><span class="op" id="7098656">,</span>&nbsp;<span class="ident" id="7098658">_</span>&nbsp;<span class="op" id="7098660">:=</span>&nbsp;<span class="ident" id="7098663">c</span><span class="op" id="7098664">.</span><span class="ident" id="7098665">Extension</span><span class="op" id="7098674">(</span><span class="string" id="7098675">&#34;DSN&#34;</span><span class="op" id="7098680">)</span><span class="op" id="7098681">;</span>&nbsp;<span class="ident" id="7098683">ok</span>&nbsp;<span class="op" id="7098686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7098690">t</span><span class="op" id="7098691">.</span><span class="ident" id="7098692">Fatalf</span><span class="op" id="7098698">(</span><span class="string" id="7098699">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="7098722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7098725">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7098728">if</span>&nbsp;<span class="ident" id="7098731">err</span>&nbsp;<span class="op" id="7098735">:=</span>&nbsp;<span class="ident" id="7098738">c</span><span class="op" id="7098739">.</span><span class="ident" id="7098740">Quit</span><span class="op" id="7098744">(</span><span class="op" id="7098745">)</span><span class="op" id="7098746">;</span>&nbsp;<span class="ident" id="7098748">err</span>&nbsp;<span class="op" id="7098752">!=</span>&nbsp;<span class="ident" id="7098755">nil</span>&nbsp;<span class="op" id="7098759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7098763">t</span><span class="op" id="7098764">.</span><span class="ident" id="7098765">Fatalf</span><span class="op" id="7098771">(</span><span class="string" id="7098772">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7098789">,</span>&nbsp;<span class="ident" id="7098791">err</span><span class="op" id="7098794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7098797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7098801">actualcmds</span>&nbsp;<span class="op" id="7098812">:=</span>&nbsp;<span class="ident" id="7098815">out</span><span class="op" id="7098818">(</span><span class="op" id="7098819">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7098822">if</span>&nbsp;<span class="ident" id="7098825">client</span>&nbsp;<span class="op" id="7098832">!=</span>&nbsp;<span class="ident" id="7098835">actualcmds</span>&nbsp;<span class="op" id="7098846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7098850">t</span><span class="op" id="7098851">.</span><span class="ident" id="7098852">Fatalf</span><span class="op" id="7098858">(</span><span class="string" id="7098859">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7098884">,</span>&nbsp;<span class="ident" id="7098886">actualcmds</span><span class="op" id="7098896">,</span>&nbsp;<span class="ident" id="7098898">client</span><span class="op" id="7098904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7098907">}</span><br>
<span class="lineno"></span><span class="op" id="7098909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword" id="7098912">var</span>&nbsp;<span class="ident" id="7098916">newClientServer</span>&nbsp;<span class="op" id="7098932">=</span>&nbsp;<span class="string" id="7098934">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">265</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7099047">var</span>&nbsp;<span class="ident" id="7099051">newClientClient</span>&nbsp;<span class="op" id="7099067">=</span>&nbsp;<span class="string" id="7099069">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">270</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7099093">func</span>&nbsp;<span class="ident" id="7099098">TestNewClient2</span><span class="op" id="7099112">(</span><span class="ident" id="7099113">t</span>&nbsp;<span class="op" id="7099115">*</span><span class="ident" id="7099116">testing</span><span class="op" id="7099123">.</span><span class="ident" id="7099124">T</span><span class="op" id="7099125">)</span>&nbsp;<span class="op" id="7099127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7099130">server</span>&nbsp;<span class="op" id="7099137">:=</span>&nbsp;<span class="ident" id="7099140">strings</span><span class="op" id="7099147">.</span><span class="ident" id="7099148">Join</span><span class="op" id="7099152">(</span><span class="ident" id="7099153">strings</span><span class="op" id="7099160">.</span><span class="ident" id="7099161">Split</span><span class="op" id="7099166">(</span><span class="ident" id="7099167">newClient2Server</span><span class="op" id="7099183">,</span>&nbsp;<span class="string" id="7099185">&#34;\n&#34;</span><span class="op" id="7099189">)</span><span class="op" id="7099190">,</span>&nbsp;<span class="string" id="7099192">&#34;\r\n&#34;</span><span class="op" id="7099198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7099201">client</span>&nbsp;<span class="op" id="7099208">:=</span>&nbsp;<span class="ident" id="7099211">strings</span><span class="op" id="7099218">.</span><span class="ident" id="7099219">Join</span><span class="op" id="7099223">(</span><span class="ident" id="7099224">strings</span><span class="op" id="7099231">.</span><span class="ident" id="7099232">Split</span><span class="op" id="7099237">(</span><span class="ident" id="7099238">newClient2Client</span><span class="op" id="7099254">,</span>&nbsp;<span class="string" id="7099256">&#34;\n&#34;</span><span class="op" id="7099260">)</span><span class="op" id="7099261">,</span>&nbsp;<span class="string" id="7099263">&#34;\r\n&#34;</span><span class="op" id="7099269">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7099273">var</span>&nbsp;<span class="ident" id="7099277">cmdbuf</span>&nbsp;<span class="ident" id="7099284">bytes</span><span class="op" id="7099289">.</span><span class="ident" id="7099290">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7099298">bcmdbuf</span>&nbsp;<span class="op" id="7099306">:=</span>&nbsp;<span class="ident" id="7099309">bufio</span><span class="op" id="7099314">.</span><span class="ident" id="7099315">NewWriter</span><span class="op" id="7099324">(</span><span class="op" id="7099325">&amp;</span><span class="ident" id="7099326">cmdbuf</span><span class="op" id="7099332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7099335">var</span>&nbsp;<span class="ident" id="7099339">fake</span>&nbsp;<span class="ident" id="7099344">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7099351">fake</span><span class="op" id="7099355">.</span><span class="ident" id="7099356">ReadWriter</span>&nbsp;<span class="op" id="7099367">=</span>&nbsp;<span class="ident" id="7099369">bufio</span><span class="op" id="7099374">.</span><span class="ident" id="7099375">NewReadWriter</span><span class="op" id="7099388">(</span><span class="ident" id="7099389">bufio</span><span class="op" id="7099394">.</span><span class="ident" id="7099395">NewReader</span><span class="op" id="7099404">(</span><span class="ident" id="7099405">strings</span><span class="op" id="7099412">.</span><span class="ident" id="7099413">NewReader</span><span class="op" id="7099422">(</span><span class="ident" id="7099423">server</span><span class="op" id="7099429">)</span><span class="op" id="7099430">)</span><span class="op" id="7099431">,</span>&nbsp;<span class="ident" id="7099433">bcmdbuf</span><span class="op" id="7099440">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7099443">c</span><span class="op" id="7099444">,</span>&nbsp;<span class="ident" id="7099446">err</span>&nbsp;<span class="op" id="7099450">:=</span>&nbsp;<span class="ident" id="7099453">NewClient</span><span class="op" id="7099462">(</span><span class="ident" id="7099463">fake</span><span class="op" id="7099467">,</span>&nbsp;<span class="string" id="7099469">&#34;fake.host&#34;</span><span class="op" id="7099480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7099483">if</span>&nbsp;<span class="ident" id="7099486">err</span>&nbsp;<span class="op" id="7099490">!=</span>&nbsp;<span class="ident" id="7099493">nil</span>&nbsp;<span class="op" id="7099497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7099501">t</span><span class="op" id="7099502">.</span><span class="ident" id="7099503">Fatalf</span><span class="op" id="7099509">(</span><span class="string" id="7099510">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="7099525">,</span>&nbsp;<span class="ident" id="7099527">err</span><span class="op" id="7099530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7099533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7099536">defer</span>&nbsp;<span class="ident" id="7099542">c</span><span class="op" id="7099543">.</span><span class="ident" id="7099544">Close</span><span class="op" id="7099549">(</span><span class="op" id="7099550">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7099553">if</span>&nbsp;<span class="ident" id="7099556">ok</span><span class="op" id="7099558">,</span>&nbsp;<span class="ident" id="7099560">_</span>&nbsp;<span class="op" id="7099562">:=</span>&nbsp;<span class="ident" id="7099565">c</span><span class="op" id="7099566">.</span><span class="ident" id="7099567">Extension</span><span class="op" id="7099576">(</span><span class="string" id="7099577">&#34;DSN&#34;</span><span class="op" id="7099582">)</span><span class="op" id="7099583">;</span>&nbsp;<span class="ident" id="7099585">ok</span>&nbsp;<span class="op" id="7099588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7099592">t</span><span class="op" id="7099593">.</span><span class="ident" id="7099594">Fatalf</span><span class="op" id="7099600">(</span><span class="string" id="7099601">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="7099624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7099627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7099630">if</span>&nbsp;<span class="ident" id="7099633">err</span>&nbsp;<span class="op" id="7099637">:=</span>&nbsp;<span class="ident" id="7099640">c</span><span class="op" id="7099641">.</span><span class="ident" id="7099642">Quit</span><span class="op" id="7099646">(</span><span class="op" id="7099647">)</span><span class="op" id="7099648">;</span>&nbsp;<span class="ident" id="7099650">err</span>&nbsp;<span class="op" id="7099654">!=</span>&nbsp;<span class="ident" id="7099657">nil</span>&nbsp;<span class="op" id="7099661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7099665">t</span><span class="op" id="7099666">.</span><span class="ident" id="7099667">Fatalf</span><span class="op" id="7099673">(</span><span class="string" id="7099674">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7099691">,</span>&nbsp;<span class="ident" id="7099693">err</span><span class="op" id="7099696">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7099699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7099703">bcmdbuf</span><span class="op" id="7099710">.</span><span class="ident" id="7099711">Flush</span><span class="op" id="7099716">(</span><span class="op" id="7099717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7099720">actualcmds</span>&nbsp;<span class="op" id="7099731">:=</span>&nbsp;<span class="ident" id="7099734">cmdbuf</span><span class="op" id="7099740">.</span><span class="ident" id="7099741">String</span><span class="op" id="7099747">(</span><span class="op" id="7099748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7099751">if</span>&nbsp;<span class="ident" id="7099754">client</span>&nbsp;<span class="op" id="7099761">!=</span>&nbsp;<span class="ident" id="7099764">actualcmds</span>&nbsp;<span class="op" id="7099775">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7099779">t</span><span class="op" id="7099780">.</span><span class="ident" id="7099781">Fatalf</span><span class="op" id="7099787">(</span><span class="string" id="7099788">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7099813">,</span>&nbsp;<span class="ident" id="7099815">actualcmds</span><span class="op" id="7099825">,</span>&nbsp;<span class="ident" id="7099827">client</span><span class="op" id="7099833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7099836">}</span><br>
<span class="lineno"></span><span class="op" id="7099838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7099841">var</span>&nbsp;<span class="ident" id="7099845">newClient2Server</span>&nbsp;<span class="op" id="7099862">=</span>&nbsp;<span class="string" id="7099864">`220&nbsp;hello&nbsp;world<br>
<span class="lineno">300</span>502&nbsp;EH?<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">305</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7099985">var</span>&nbsp;<span class="ident" id="7099989">newClient2Client</span>&nbsp;<span class="op" id="7100006">=</span>&nbsp;<span class="string" id="7100008">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno">310</span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7100047">func</span>&nbsp;<span class="ident" id="7100052">TestHello</span><span class="op" id="7100061">(</span><span class="ident" id="7100062">t</span>&nbsp;<span class="op" id="7100064">*</span><span class="ident" id="7100065">testing</span><span class="op" id="7100072">.</span><span class="ident" id="7100073">T</span><span class="op" id="7100074">)</span>&nbsp;<span class="op" id="7100076">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7100080">if</span>&nbsp;<span class="builtinfunc" id="7100083">len</span><span class="op" id="7100086">(</span><span class="ident" id="7100087">helloServer</span><span class="op" id="7100098">)</span>&nbsp;<span class="op" id="7100100">!=</span>&nbsp;<span class="builtinfunc" id="7100103">len</span><span class="op" id="7100106">(</span><span class="ident" id="7100107">helloClient</span><span class="op" id="7100118">)</span>&nbsp;<span class="op" id="7100120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100124">t</span><span class="op" id="7100125">.</span><span class="ident" id="7100126">Fatalf</span><span class="op" id="7100132">(</span><span class="string" id="7100133">&#34;Hello&nbsp;server&nbsp;and&nbsp;client&nbsp;size&nbsp;mismatch&#34;</span><span class="op" id="7100172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7100175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7100179">for</span>&nbsp;<span class="ident" id="7100183">i</span>&nbsp;<span class="op" id="7100185">:=</span>&nbsp;<span class="num" id="7100188">0</span><span class="op" id="7100189">;</span>&nbsp;<span class="ident" id="7100191">i</span>&nbsp;<span class="op" id="7100193">&lt;</span>&nbsp;<span class="builtinfunc" id="7100195">len</span><span class="op" id="7100198">(</span><span class="ident" id="7100199">helloServer</span><span class="op" id="7100210">)</span><span class="op" id="7100211">;</span>&nbsp;<span class="ident" id="7100213">i</span><span class="op" id="7100214">++</span>&nbsp;<span class="op" id="7100217">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100221">server</span>&nbsp;<span class="op" id="7100228">:=</span>&nbsp;<span class="ident" id="7100231">strings</span><span class="op" id="7100238">.</span><span class="ident" id="7100239">Join</span><span class="op" id="7100243">(</span><span class="ident" id="7100244">strings</span><span class="op" id="7100251">.</span><span class="ident" id="7100252">Split</span><span class="op" id="7100257">(</span><span class="ident" id="7100258">baseHelloServer</span><span class="op" id="7100273">+</span><span class="ident" id="7100274">helloServer</span><span class="op" id="7100285">[</span><span class="ident" id="7100286">i</span><span class="op" id="7100287">]</span><span class="op" id="7100288">,</span>&nbsp;<span class="string" id="7100290">&#34;\n&#34;</span><span class="op" id="7100294">)</span><span class="op" id="7100295">,</span>&nbsp;<span class="string" id="7100297">&#34;\r\n&#34;</span><span class="op" id="7100303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100307">client</span>&nbsp;<span class="op" id="7100314">:=</span>&nbsp;<span class="ident" id="7100317">strings</span><span class="op" id="7100324">.</span><span class="ident" id="7100325">Join</span><span class="op" id="7100329">(</span><span class="ident" id="7100330">strings</span><span class="op" id="7100337">.</span><span class="ident" id="7100338">Split</span><span class="op" id="7100343">(</span><span class="ident" id="7100344">baseHelloClient</span><span class="op" id="7100359">+</span><span class="ident" id="7100360">helloClient</span><span class="op" id="7100371">[</span><span class="ident" id="7100372">i</span><span class="op" id="7100373">]</span><span class="op" id="7100374">,</span>&nbsp;<span class="string" id="7100376">&#34;\n&#34;</span><span class="op" id="7100380">)</span><span class="op" id="7100381">,</span>&nbsp;<span class="string" id="7100383">&#34;\r\n&#34;</span><span class="op" id="7100389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7100393">var</span>&nbsp;<span class="ident" id="7100397">cmdbuf</span>&nbsp;<span class="ident" id="7100404">bytes</span><span class="op" id="7100409">.</span><span class="ident" id="7100410">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100419">bcmdbuf</span>&nbsp;<span class="op" id="7100427">:=</span>&nbsp;<span class="ident" id="7100430">bufio</span><span class="op" id="7100435">.</span><span class="ident" id="7100436">NewWriter</span><span class="op" id="7100445">(</span><span class="op" id="7100446">&amp;</span><span class="ident" id="7100447">cmdbuf</span><span class="op" id="7100453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7100457">var</span>&nbsp;<span class="ident" id="7100461">fake</span>&nbsp;<span class="ident" id="7100466">faker</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100474">fake</span><span class="op" id="7100478">.</span><span class="ident" id="7100479">ReadWriter</span>&nbsp;<span class="op" id="7100490">=</span>&nbsp;<span class="ident" id="7100492">bufio</span><span class="op" id="7100497">.</span><span class="ident" id="7100498">NewReadWriter</span><span class="op" id="7100511">(</span><span class="ident" id="7100512">bufio</span><span class="op" id="7100517">.</span><span class="ident" id="7100518">NewReader</span><span class="op" id="7100527">(</span><span class="ident" id="7100528">strings</span><span class="op" id="7100535">.</span><span class="ident" id="7100536">NewReader</span><span class="op" id="7100545">(</span><span class="ident" id="7100546">server</span><span class="op" id="7100552">)</span><span class="op" id="7100553">)</span><span class="op" id="7100554">,</span>&nbsp;<span class="ident" id="7100556">bcmdbuf</span><span class="op" id="7100563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100567">c</span><span class="op" id="7100568">,</span>&nbsp;<span class="ident" id="7100570">err</span>&nbsp;<span class="op" id="7100574">:=</span>&nbsp;<span class="ident" id="7100577">NewClient</span><span class="op" id="7100586">(</span><span class="ident" id="7100587">fake</span><span class="op" id="7100591">,</span>&nbsp;<span class="string" id="7100593">&#34;fake.host&#34;</span><span class="op" id="7100604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7100608">if</span>&nbsp;<span class="ident" id="7100611">err</span>&nbsp;<span class="op" id="7100615">!=</span>&nbsp;<span class="ident" id="7100618">nil</span>&nbsp;<span class="op" id="7100622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100627">t</span><span class="op" id="7100628">.</span><span class="ident" id="7100629">Fatalf</span><span class="op" id="7100635">(</span><span class="string" id="7100636">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="7100651">,</span>&nbsp;<span class="ident" id="7100653">err</span><span class="op" id="7100656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7100660">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7100664">defer</span>&nbsp;<span class="ident" id="7100670">c</span><span class="op" id="7100671">.</span><span class="ident" id="7100672">Close</span><span class="op" id="7100677">(</span><span class="op" id="7100678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100682">c</span><span class="op" id="7100683">.</span><span class="ident" id="7100684">localName</span>&nbsp;<span class="op" id="7100694">=</span>&nbsp;<span class="string" id="7100696">&#34;customhost&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100711">err</span>&nbsp;<span class="op" id="7100715">=</span>&nbsp;<span class="ident" id="7100717">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7100724">switch</span>&nbsp;<span class="ident" id="7100731">i</span>&nbsp;<span class="op" id="7100733">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7100737">case</span>&nbsp;<span class="num" id="7100742">0</span><span class="op" id="7100743">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100748">err</span>&nbsp;<span class="op" id="7100752">=</span>&nbsp;<span class="ident" id="7100754">c</span><span class="op" id="7100755">.</span><span class="ident" id="7100756">Hello</span><span class="op" id="7100761">(</span><span class="string" id="7100762">&#34;customhost&#34;</span><span class="op" id="7100774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7100778">case</span>&nbsp;<span class="num" id="7100783">1</span><span class="op" id="7100784">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100789">err</span>&nbsp;<span class="op" id="7100793">=</span>&nbsp;<span class="ident" id="7100795">c</span><span class="op" id="7100796">.</span><span class="ident" id="7100797">StartTLS</span><span class="op" id="7100805">(</span><span class="ident" id="7100806">nil</span><span class="op" id="7100809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7100814">if</span>&nbsp;<span class="ident" id="7100817">err</span><span class="op" id="7100820">.</span><span class="ident" id="7100821">Error</span><span class="op" id="7100826">(</span><span class="op" id="7100827">)</span>&nbsp;<span class="op" id="7100829">==</span>&nbsp;<span class="string" id="7100832">&#34;502&nbsp;Not&nbsp;implemented&#34;</span>&nbsp;<span class="op" id="7100854">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100860">err</span>&nbsp;<span class="op" id="7100864">=</span>&nbsp;<span class="ident" id="7100866">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7100873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7100877">case</span>&nbsp;<span class="num" id="7100882">2</span><span class="op" id="7100883">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100888">err</span>&nbsp;<span class="op" id="7100892">=</span>&nbsp;<span class="ident" id="7100894">c</span><span class="op" id="7100895">.</span><span class="ident" id="7100896">Verify</span><span class="op" id="7100902">(</span><span class="string" id="7100903">&#34;test@example.com&#34;</span><span class="op" id="7100921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7100925">case</span>&nbsp;<span class="num" id="7100930">3</span><span class="op" id="7100931">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100936">c</span><span class="op" id="7100937">.</span><span class="ident" id="7100938">tls</span>&nbsp;<span class="op" id="7100942">=</span>&nbsp;<span class="builtintype" id="7100944">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100952">c</span><span class="op" id="7100953">.</span><span class="ident" id="7100954">serverName</span>&nbsp;<span class="op" id="7100965">=</span>&nbsp;<span class="string" id="7100967">&#34;smtp.google.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7100988">err</span>&nbsp;<span class="op" id="7100992">=</span>&nbsp;<span class="ident" id="7100994">c</span><span class="op" id="7100995">.</span><span class="ident" id="7100996">Auth</span><span class="op" id="7101000">(</span><span class="ident" id="7101001">PlainAuth</span><span class="op" id="7101010">(</span><span class="string" id="7101011">&#34;&#34;</span><span class="op" id="7101013">,</span>&nbsp;<span class="string" id="7101015">&#34;user&#34;</span><span class="op" id="7101021">,</span>&nbsp;<span class="string" id="7101023">&#34;pass&#34;</span><span class="op" id="7101029">,</span>&nbsp;<span class="string" id="7101031">&#34;smtp.google.com&#34;</span><span class="op" id="7101048">)</span><span class="op" id="7101049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7101053">case</span>&nbsp;<span class="num" id="7101058">4</span><span class="op" id="7101059">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7101064">err</span>&nbsp;<span class="op" id="7101068">=</span>&nbsp;<span class="ident" id="7101070">c</span><span class="op" id="7101071">.</span><span class="ident" id="7101072">Mail</span><span class="op" id="7101076">(</span><span class="string" id="7101077">&#34;test@example.com&#34;</span><span class="op" id="7101095">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7101099">case</span>&nbsp;<span class="num" id="7101104">5</span><span class="op" id="7101105">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7101110">ok</span><span class="op" id="7101112">,</span>&nbsp;<span class="ident" id="7101114">_</span>&nbsp;<span class="op" id="7101116">:=</span>&nbsp;<span class="ident" id="7101119">c</span><span class="op" id="7101120">.</span><span class="ident" id="7101121">Extension</span><span class="op" id="7101130">(</span><span class="string" id="7101131">&#34;feature&#34;</span><span class="op" id="7101140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7101145">if</span>&nbsp;<span class="ident" id="7101148">ok</span>&nbsp;<span class="op" id="7101151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7101157">t</span><span class="op" id="7101158">.</span><span class="ident" id="7101159">Errorf</span><span class="op" id="7101165">(</span><span class="string" id="7101166">&#34;Expected&nbsp;FEATURE&nbsp;not&nbsp;to&nbsp;be&nbsp;supported&#34;</span><span class="op" id="7101204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7101209">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7101213">case</span>&nbsp;<span class="num" id="7101218">6</span><span class="op" id="7101219">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7101224">err</span>&nbsp;<span class="op" id="7101228">=</span>&nbsp;<span class="ident" id="7101230">c</span><span class="op" id="7101231">.</span><span class="ident" id="7101232">Reset</span><span class="op" id="7101237">(</span><span class="op" id="7101238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7101242">case</span>&nbsp;<span class="num" id="7101247">7</span><span class="op" id="7101248">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7101253">err</span>&nbsp;<span class="op" id="7101257">=</span>&nbsp;<span class="ident" id="7101259">c</span><span class="op" id="7101260">.</span><span class="ident" id="7101261">Quit</span><span class="op" id="7101265">(</span><span class="op" id="7101266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7101270">case</span>&nbsp;<span class="num" id="7101275">8</span><span class="op" id="7101276">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7101281">err</span>&nbsp;<span class="op" id="7101285">=</span>&nbsp;<span class="ident" id="7101287">c</span><span class="op" id="7101288">.</span><span class="ident" id="7101289">Verify</span><span class="op" id="7101295">(</span><span class="string" id="7101296">&#34;test@example.com&#34;</span><span class="op" id="7101314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7101319">if</span>&nbsp;<span class="ident" id="7101322">err</span>&nbsp;<span class="op" id="7101326">!=</span>&nbsp;<span class="ident" id="7101329">nil</span>&nbsp;<span class="op" id="7101333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7101339">err</span>&nbsp;<span class="op" id="7101343">=</span>&nbsp;<span class="ident" id="7101345">c</span><span class="op" id="7101346">.</span><span class="ident" id="7101347">Hello</span><span class="op" id="7101352">(</span><span class="string" id="7101353">&#34;customhost&#34;</span><span class="op" id="7101365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7101371">if</span>&nbsp;<span class="ident" id="7101374">err</span>&nbsp;<span class="op" id="7101378">!=</span>&nbsp;<span class="ident" id="7101381">nil</span>&nbsp;<span class="op" id="7101385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7101392">t</span><span class="op" id="7101393">.</span><span class="ident" id="7101394">Errorf</span><span class="op" id="7101400">(</span><span class="string" id="7101401">&#34;Want&nbsp;error,&nbsp;got&nbsp;none&#34;</span><span class="op" id="7101423">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7101429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7101434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7101438">default</span><span class="op" id="7101445">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7101450">t</span><span class="op" id="7101451">.</span><span class="ident" id="7101452">Fatalf</span><span class="op" id="7101458">(</span><span class="string" id="7101459">&#34;Unhandled&nbsp;command&#34;</span><span class="op" id="7101478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7101482">}</span><br>
<span class="lineno">370</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7101487">if</span>&nbsp;<span class="ident" id="7101490">err</span>&nbsp;<span class="op" id="7101494">!=</span>&nbsp;<span class="ident" id="7101497">nil</span>&nbsp;<span class="op" id="7101501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7101506">t</span><span class="op" id="7101507">.</span><span class="ident" id="7101508">Errorf</span><span class="op" id="7101514">(</span><span class="string" id="7101515">&#34;Command&nbsp;%d&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7101538">,</span>&nbsp;<span class="ident" id="7101540">i</span><span class="op" id="7101541">,</span>&nbsp;<span class="ident" id="7101543">err</span><span class="op" id="7101546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7101550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7101555">bcmdbuf</span><span class="op" id="7101562">.</span><span class="ident" id="7101563">Flush</span><span class="op" id="7101568">(</span><span class="op" id="7101569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7101573">actualcmds</span>&nbsp;<span class="op" id="7101584">:=</span>&nbsp;<span class="ident" id="7101587">cmdbuf</span><span class="op" id="7101593">.</span><span class="ident" id="7101594">String</span><span class="op" id="7101600">(</span><span class="op" id="7101601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7101605">if</span>&nbsp;<span class="ident" id="7101608">client</span>&nbsp;<span class="op" id="7101615">!=</span>&nbsp;<span class="ident" id="7101618">actualcmds</span>&nbsp;<span class="op" id="7101629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7101634">t</span><span class="op" id="7101635">.</span><span class="ident" id="7101636">Errorf</span><span class="op" id="7101642">(</span><span class="string" id="7101643">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7101668">,</span>&nbsp;<span class="ident" id="7101670">actualcmds</span><span class="op" id="7101680">,</span>&nbsp;<span class="ident" id="7101682">client</span><span class="op" id="7101688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7101692">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7101695">}</span><br>
<span class="lineno"></span><span class="op" id="7101697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7101700">var</span>&nbsp;<span class="ident" id="7101704">baseHelloServer</span>&nbsp;<span class="op" id="7101720">=</span>&nbsp;<span class="string" id="7101722">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno">385</span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;FEATURE<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7101796">var</span>&nbsp;<span class="ident" id="7101800">helloServer</span>&nbsp;<span class="op" id="7101812">=</span>&nbsp;<span class="op" id="7101814">[</span><span class="op" id="7101815">]</span><span class="builtintype" id="7101816">string</span><span class="op" id="7101822">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7101825">&#34;&#34;</span><span class="op" id="7101827">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7101830">&#34;502&nbsp;Not&nbsp;implemented\n&#34;</span><span class="op" id="7101853">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7101856">&#34;250&nbsp;User&nbsp;is&nbsp;valid\n&#34;</span><span class="op" id="7101877">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7101880">&#34;235&nbsp;Accepted\n&#34;</span><span class="op" id="7101896">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7101899">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="7101916">,</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7101919">&#34;&#34;</span><span class="op" id="7101921">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7101924">&#34;250&nbsp;Reset&nbsp;ok\n&#34;</span><span class="op" id="7101940">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7101943">&#34;221&nbsp;Goodbye\n&#34;</span><span class="op" id="7101958">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7101961">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="7101978">,</span><br>
<span class="lineno"></span><span class="op" id="7101980">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="7101983">var</span>&nbsp;<span class="ident" id="7101987">baseHelloClient</span>&nbsp;<span class="op" id="7102003">=</span>&nbsp;<span class="string" id="7102005">`EHLO&nbsp;customhost<br>
<span class="lineno"></span>HELO&nbsp;customhost<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="7102041">var</span>&nbsp;<span class="ident" id="7102045">helloClient</span>&nbsp;<span class="op" id="7102057">=</span>&nbsp;<span class="op" id="7102059">[</span><span class="op" id="7102060">]</span><span class="builtintype" id="7102061">string</span><span class="op" id="7102067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7102070">&#34;&#34;</span><span class="op" id="7102072">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7102075">&#34;STARTTLS\n&#34;</span><span class="op" id="7102087">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7102090">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="7102115">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7102118">&#34;AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==\n&#34;</span><span class="op" id="7102149">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7102152">&#34;MAIL&nbsp;FROM:&lt;test@example.com&gt;\n&#34;</span><span class="op" id="7102184">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7102187">&#34;&#34;</span><span class="op" id="7102189">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7102192">&#34;RSET\n&#34;</span><span class="op" id="7102200">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7102203">&#34;QUIT\n&#34;</span><span class="op" id="7102211">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7102214">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="7102239">,</span><br>
<span class="lineno">415</span><span class="op" id="7102241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7102244">func</span>&nbsp;<span class="ident" id="7102249">TestSendMail</span><span class="op" id="7102261">(</span><span class="ident" id="7102262">t</span>&nbsp;<span class="op" id="7102264">*</span><span class="ident" id="7102265">testing</span><span class="op" id="7102272">.</span><span class="ident" id="7102273">T</span><span class="op" id="7102274">)</span>&nbsp;<span class="op" id="7102276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7102279">server</span>&nbsp;<span class="op" id="7102286">:=</span>&nbsp;<span class="ident" id="7102289">strings</span><span class="op" id="7102296">.</span><span class="ident" id="7102297">Join</span><span class="op" id="7102301">(</span><span class="ident" id="7102302">strings</span><span class="op" id="7102309">.</span><span class="ident" id="7102310">Split</span><span class="op" id="7102315">(</span><span class="ident" id="7102316">sendMailServer</span><span class="op" id="7102330">,</span>&nbsp;<span class="string" id="7102332">&#34;\n&#34;</span><span class="op" id="7102336">)</span><span class="op" id="7102337">,</span>&nbsp;<span class="string" id="7102339">&#34;\r\n&#34;</span><span class="op" id="7102345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7102348">client</span>&nbsp;<span class="op" id="7102355">:=</span>&nbsp;<span class="ident" id="7102358">strings</span><span class="op" id="7102365">.</span><span class="ident" id="7102366">Join</span><span class="op" id="7102370">(</span><span class="ident" id="7102371">strings</span><span class="op" id="7102378">.</span><span class="ident" id="7102379">Split</span><span class="op" id="7102384">(</span><span class="ident" id="7102385">sendMailClient</span><span class="op" id="7102399">,</span>&nbsp;<span class="string" id="7102401">&#34;\n&#34;</span><span class="op" id="7102405">)</span><span class="op" id="7102406">,</span>&nbsp;<span class="string" id="7102408">&#34;\r\n&#34;</span><span class="op" id="7102414">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7102417">var</span>&nbsp;<span class="ident" id="7102421">cmdbuf</span>&nbsp;<span class="ident" id="7102428">bytes</span><span class="op" id="7102433">.</span><span class="ident" id="7102434">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7102442">bcmdbuf</span>&nbsp;<span class="op" id="7102450">:=</span>&nbsp;<span class="ident" id="7102453">bufio</span><span class="op" id="7102458">.</span><span class="ident" id="7102459">NewWriter</span><span class="op" id="7102468">(</span><span class="op" id="7102469">&amp;</span><span class="ident" id="7102470">cmdbuf</span><span class="op" id="7102476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7102479">l</span><span class="op" id="7102480">,</span>&nbsp;<span class="ident" id="7102482">err</span>&nbsp;<span class="op" id="7102486">:=</span>&nbsp;<span class="ident" id="7102489">net</span><span class="op" id="7102492">.</span><span class="ident" id="7102493">Listen</span><span class="op" id="7102499">(</span><span class="string" id="7102500">&#34;tcp&#34;</span><span class="op" id="7102505">,</span>&nbsp;<span class="string" id="7102507">&#34;127.0.0.1:0&#34;</span><span class="op" id="7102520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7102523">if</span>&nbsp;<span class="ident" id="7102526">err</span>&nbsp;<span class="op" id="7102530">!=</span>&nbsp;<span class="ident" id="7102533">nil</span>&nbsp;<span class="op" id="7102537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7102541">t</span><span class="op" id="7102542">.</span><span class="ident" id="7102543">Fatalf</span><span class="op" id="7102549">(</span><span class="string" id="7102550">&#34;Unable&nbsp;to&nbsp;to&nbsp;create&nbsp;listener:&nbsp;%v&#34;</span><span class="op" id="7102584">,</span>&nbsp;<span class="ident" id="7102586">err</span><span class="op" id="7102589">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7102592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7102595">defer</span>&nbsp;<span class="ident" id="7102601">l</span><span class="op" id="7102602">.</span><span class="ident" id="7102603">Close</span><span class="op" id="7102608">(</span><span class="op" id="7102609">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7102613">//&nbsp;prevent&nbsp;data&nbsp;race&nbsp;on&nbsp;bcmdbuf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7102646">var</span>&nbsp;<span class="ident" id="7102650">done</span>&nbsp;<span class="op" id="7102655">=</span>&nbsp;<span class="builtinfunc" id="7102657">make</span><span class="op" id="7102661">(</span><span class="keyword" id="7102662">chan</span>&nbsp;<span class="keyword" id="7102667">struct</span><span class="op" id="7102673">{</span><span class="op" id="7102674">}</span><span class="op" id="7102675">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7102678">go</span>&nbsp;<span class="keyword" id="7102681">func</span><span class="op" id="7102685">(</span><span class="ident" id="7102686">data</span>&nbsp;<span class="op" id="7102691">[</span><span class="op" id="7102692">]</span><span class="builtintype" id="7102693">string</span><span class="op" id="7102699">)</span>&nbsp;<span class="op" id="7102701">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7102706">defer</span>&nbsp;<span class="builtinfunc" id="7102712">close</span><span class="op" id="7102717">(</span><span class="ident" id="7102718">done</span><span class="op" id="7102722">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7102727">conn</span><span class="op" id="7102731">,</span>&nbsp;<span class="ident" id="7102733">err</span>&nbsp;<span class="op" id="7102737">:=</span>&nbsp;<span class="ident" id="7102740">l</span><span class="op" id="7102741">.</span><span class="ident" id="7102742">Accept</span><span class="op" id="7102748">(</span><span class="op" id="7102749">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7102753">if</span>&nbsp;<span class="ident" id="7102756">err</span>&nbsp;<span class="op" id="7102760">!=</span>&nbsp;<span class="ident" id="7102763">nil</span>&nbsp;<span class="op" id="7102767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7102772">t</span><span class="op" id="7102773">.</span><span class="ident" id="7102774">Errorf</span><span class="op" id="7102780">(</span><span class="string" id="7102781">&#34;Accept&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7102799">,</span>&nbsp;<span class="ident" id="7102801">err</span><span class="op" id="7102804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7102809">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7102818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7102822">defer</span>&nbsp;<span class="ident" id="7102828">conn</span><span class="op" id="7102832">.</span><span class="ident" id="7102833">Close</span><span class="op" id="7102838">(</span><span class="op" id="7102839">)</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7102844">tc</span>&nbsp;<span class="op" id="7102847">:=</span>&nbsp;<span class="ident" id="7102850">textproto</span><span class="op" id="7102859">.</span><span class="ident" id="7102860">NewConn</span><span class="op" id="7102867">(</span><span class="ident" id="7102868">conn</span><span class="op" id="7102872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7102876">for</span>&nbsp;<span class="ident" id="7102880">i</span>&nbsp;<span class="op" id="7102882">:=</span>&nbsp;<span class="num" id="7102885">0</span><span class="op" id="7102886">;</span>&nbsp;<span class="ident" id="7102888">i</span>&nbsp;<span class="op" id="7102890">&lt;</span>&nbsp;<span class="builtinfunc" id="7102892">len</span><span class="op" id="7102895">(</span><span class="ident" id="7102896">data</span><span class="op" id="7102900">)</span>&nbsp;<span class="op" id="7102902">&amp;&amp;</span>&nbsp;<span class="ident" id="7102905">data</span><span class="op" id="7102909">[</span><span class="ident" id="7102910">i</span><span class="op" id="7102911">]</span>&nbsp;<span class="op" id="7102913">!=</span>&nbsp;<span class="string" id="7102916">&#34;&#34;</span><span class="op" id="7102918">;</span>&nbsp;<span class="ident" id="7102920">i</span><span class="op" id="7102921">++</span>&nbsp;<span class="op" id="7102924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7102929">tc</span><span class="op" id="7102931">.</span><span class="ident" id="7102932">PrintfLine</span><span class="op" id="7102942">(</span><span class="ident" id="7102943">data</span><span class="op" id="7102947">[</span><span class="ident" id="7102948">i</span><span class="op" id="7102949">]</span><span class="op" id="7102950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7102955">for</span>&nbsp;<span class="builtinfunc" id="7102959">len</span><span class="op" id="7102962">(</span><span class="ident" id="7102963">data</span><span class="op" id="7102967">[</span><span class="ident" id="7102968">i</span><span class="op" id="7102969">]</span><span class="op" id="7102970">)</span>&nbsp;<span class="op" id="7102972">&gt;=</span>&nbsp;<span class="num" id="7102975">4</span>&nbsp;<span class="op" id="7102977">&amp;&amp;</span>&nbsp;<span class="ident" id="7102980">data</span><span class="op" id="7102984">[</span><span class="ident" id="7102985">i</span><span class="op" id="7102986">]</span><span class="op" id="7102987">[</span><span class="num" id="7102988">3</span><span class="op" id="7102989">]</span>&nbsp;<span class="op" id="7102991">==</span>&nbsp;<span class="string" id="7102994">&#39;-&#39;</span>&nbsp;<span class="op" id="7102998">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7103004">i</span><span class="op" id="7103005">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7103012">tc</span><span class="op" id="7103014">.</span><span class="ident" id="7103015">PrintfLine</span><span class="op" id="7103025">(</span><span class="ident" id="7103026">data</span><span class="op" id="7103030">[</span><span class="ident" id="7103031">i</span><span class="op" id="7103032">]</span><span class="op" id="7103033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7103038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7103043">if</span>&nbsp;<span class="ident" id="7103046">data</span><span class="op" id="7103050">[</span><span class="ident" id="7103051">i</span><span class="op" id="7103052">]</span>&nbsp;<span class="op" id="7103054">==</span>&nbsp;<span class="string" id="7103057">&#34;221&nbsp;Goodbye&#34;</span>&nbsp;<span class="op" id="7103071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7103077">return</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7103087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7103092">read</span>&nbsp;<span class="op" id="7103097">:=</span>&nbsp;<span class="builtintype" id="7103100">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7103109">for</span>&nbsp;<span class="op" id="7103113">!</span><span class="ident" id="7103114">read</span>&nbsp;<span class="op" id="7103119">||</span>&nbsp;<span class="ident" id="7103122">data</span><span class="op" id="7103126">[</span><span class="ident" id="7103127">i</span><span class="op" id="7103128">]</span>&nbsp;<span class="op" id="7103130">==</span>&nbsp;<span class="string" id="7103133">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="7103148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7103154">msg</span><span class="op" id="7103157">,</span>&nbsp;<span class="ident" id="7103159">err</span>&nbsp;<span class="op" id="7103163">:=</span>&nbsp;<span class="ident" id="7103166">tc</span><span class="op" id="7103168">.</span><span class="ident" id="7103169">ReadLine</span><span class="op" id="7103177">(</span><span class="op" id="7103178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7103184">bcmdbuf</span><span class="op" id="7103191">.</span><span class="ident" id="7103192">Write</span><span class="op" id="7103197">(</span><span class="op" id="7103198">[</span><span class="op" id="7103199">]</span><span class="builtintype" id="7103200">byte</span><span class="op" id="7103204">(</span><span class="ident" id="7103205">msg</span>&nbsp;<span class="op" id="7103209">+</span>&nbsp;<span class="string" id="7103211">&#34;\r\n&#34;</span><span class="op" id="7103217">)</span><span class="op" id="7103218">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7103224">read</span>&nbsp;<span class="op" id="7103229">=</span>&nbsp;<span class="builtintype" id="7103231">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7103240">if</span>&nbsp;<span class="ident" id="7103243">err</span>&nbsp;<span class="op" id="7103247">!=</span>&nbsp;<span class="ident" id="7103250">nil</span>&nbsp;<span class="op" id="7103254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7103261">t</span><span class="op" id="7103262">.</span><span class="ident" id="7103263">Errorf</span><span class="op" id="7103269">(</span><span class="string" id="7103270">&#34;Read&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7103286">,</span>&nbsp;<span class="ident" id="7103288">err</span><span class="op" id="7103291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7103298">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7103309">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7103315">if</span>&nbsp;<span class="ident" id="7103318">data</span><span class="op" id="7103322">[</span><span class="ident" id="7103323">i</span><span class="op" id="7103324">]</span>&nbsp;<span class="op" id="7103326">==</span>&nbsp;<span class="string" id="7103329">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="7103344">&amp;&amp;</span>&nbsp;<span class="ident" id="7103347">msg</span>&nbsp;<span class="op" id="7103351">==</span>&nbsp;<span class="string" id="7103354">&#34;.&#34;</span>&nbsp;<span class="op" id="7103358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7103365">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7103375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7103380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7103384">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7103387">}</span><span class="op" id="7103388">(</span><span class="ident" id="7103389">strings</span><span class="op" id="7103396">.</span><span class="ident" id="7103397">Split</span><span class="op" id="7103402">(</span><span class="ident" id="7103403">server</span><span class="op" id="7103409">,</span>&nbsp;<span class="string" id="7103411">&#34;\r\n&#34;</span><span class="op" id="7103417">)</span><span class="op" id="7103418">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7103422">err</span>&nbsp;<span class="op" id="7103426">=</span>&nbsp;<span class="ident" id="7103428">SendMail</span><span class="op" id="7103436">(</span><span class="ident" id="7103437">l</span><span class="op" id="7103438">.</span><span class="ident" id="7103439">Addr</span><span class="op" id="7103443">(</span><span class="op" id="7103444">)</span><span class="op" id="7103445">.</span><span class="ident" id="7103446">String</span><span class="op" id="7103452">(</span><span class="op" id="7103453">)</span><span class="op" id="7103454">,</span>&nbsp;<span class="ident" id="7103456">nil</span><span class="op" id="7103459">,</span>&nbsp;<span class="string" id="7103461">&#34;test@example.com&#34;</span><span class="op" id="7103479">,</span>&nbsp;<span class="op" id="7103481">[</span><span class="op" id="7103482">]</span><span class="builtintype" id="7103483">string</span><span class="op" id="7103489">{</span><span class="string" id="7103490">&#34;other@example.com&#34;</span><span class="op" id="7103509">}</span><span class="op" id="7103510">,</span>&nbsp;<span class="op" id="7103512">[</span><span class="op" id="7103513">]</span><span class="builtintype" id="7103514">byte</span><span class="op" id="7103518">(</span><span class="ident" id="7103519">strings</span><span class="op" id="7103526">.</span><span class="ident" id="7103527">Replace</span><span class="op" id="7103534">(</span><span class="string" id="7103535">`From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno">470</span><br>
<span class="lineno"></span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>`</span><span class="op" id="7103634">,</span>&nbsp;<span class="string" id="7103636">&#34;\n&#34;</span><span class="op" id="7103640">,</span>&nbsp;<span class="string" id="7103642">&#34;\r\n&#34;</span><span class="op" id="7103648">,</span>&nbsp;<span class="op" id="7103650">-</span><span class="num" id="7103651">1</span><span class="op" id="7103652">)</span><span class="op" id="7103653">)</span><span class="op" id="7103654">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7103658">if</span>&nbsp;<span class="ident" id="7103661">err</span>&nbsp;<span class="op" id="7103665">!=</span>&nbsp;<span class="ident" id="7103668">nil</span>&nbsp;<span class="op" id="7103672">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7103676">t</span><span class="op" id="7103677">.</span><span class="ident" id="7103678">Errorf</span><span class="op" id="7103684">(</span><span class="string" id="7103685">&#34;%v&#34;</span><span class="op" id="7103689">,</span>&nbsp;<span class="ident" id="7103691">err</span><span class="op" id="7103694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7103697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7103701">&lt;-</span><span class="ident" id="7103703">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7103709">bcmdbuf</span><span class="op" id="7103716">.</span><span class="ident" id="7103717">Flush</span><span class="op" id="7103722">(</span><span class="op" id="7103723">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7103726">actualcmds</span>&nbsp;<span class="op" id="7103737">:=</span>&nbsp;<span class="ident" id="7103740">cmdbuf</span><span class="op" id="7103746">.</span><span class="ident" id="7103747">String</span><span class="op" id="7103753">(</span><span class="op" id="7103754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7103757">if</span>&nbsp;<span class="ident" id="7103760">client</span>&nbsp;<span class="op" id="7103767">!=</span>&nbsp;<span class="ident" id="7103770">actualcmds</span>&nbsp;<span class="op" id="7103781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7103785">t</span><span class="op" id="7103786">.</span><span class="ident" id="7103787">Errorf</span><span class="op" id="7103793">(</span><span class="string" id="7103794">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7103819">,</span>&nbsp;<span class="ident" id="7103821">actualcmds</span><span class="op" id="7103831">,</span>&nbsp;<span class="ident" id="7103833">client</span><span class="op" id="7103839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7103842">}</span><br>
<span class="lineno"></span><span class="op" id="7103844">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="7103847">var</span>&nbsp;<span class="ident" id="7103851">sendMailServer</span>&nbsp;<span class="op" id="7103866">=</span>&nbsp;<span class="string" id="7103868">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno"></span>250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;ok<br>
<span class="lineno">490</span>250&nbsp;Receiver&nbsp;ok<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;ok<br>
<span class="lineno"></span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="keyword" id="7103997">var</span>&nbsp;<span class="ident" id="7104001">sendMailClient</span>&nbsp;<span class="op" id="7104016">=</span>&nbsp;<span class="string" id="7104018">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;test@example.com&gt;<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;other@example.com&gt;<br>
<span class="lineno">500</span>DATA<br>
<span class="lineno"></span>From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno"></span><br>
<span class="lineno">505</span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="7104218">func</span>&nbsp;<span class="ident" id="7104223">TestAuthFailed</span><span class="op" id="7104237">(</span><span class="ident" id="7104238">t</span>&nbsp;<span class="op" id="7104240">*</span><span class="ident" id="7104241">testing</span><span class="op" id="7104248">.</span><span class="ident" id="7104249">T</span><span class="op" id="7104250">)</span>&nbsp;<span class="op" id="7104252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7104255">server</span>&nbsp;<span class="op" id="7104262">:=</span>&nbsp;<span class="ident" id="7104265">strings</span><span class="op" id="7104272">.</span><span class="ident" id="7104273">Join</span><span class="op" id="7104277">(</span><span class="ident" id="7104278">strings</span><span class="op" id="7104285">.</span><span class="ident" id="7104286">Split</span><span class="op" id="7104291">(</span><span class="ident" id="7104292">authFailedServer</span><span class="op" id="7104308">,</span>&nbsp;<span class="string" id="7104310">&#34;\n&#34;</span><span class="op" id="7104314">)</span><span class="op" id="7104315">,</span>&nbsp;<span class="string" id="7104317">&#34;\r\n&#34;</span><span class="op" id="7104323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7104326">client</span>&nbsp;<span class="op" id="7104333">:=</span>&nbsp;<span class="ident" id="7104336">strings</span><span class="op" id="7104343">.</span><span class="ident" id="7104344">Join</span><span class="op" id="7104348">(</span><span class="ident" id="7104349">strings</span><span class="op" id="7104356">.</span><span class="ident" id="7104357">Split</span><span class="op" id="7104362">(</span><span class="ident" id="7104363">authFailedClient</span><span class="op" id="7104379">,</span>&nbsp;<span class="string" id="7104381">&#34;\n&#34;</span><span class="op" id="7104385">)</span><span class="op" id="7104386">,</span>&nbsp;<span class="string" id="7104388">&#34;\r\n&#34;</span><span class="op" id="7104394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7104397">var</span>&nbsp;<span class="ident" id="7104401">cmdbuf</span>&nbsp;<span class="ident" id="7104408">bytes</span><span class="op" id="7104413">.</span><span class="ident" id="7104414">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7104422">bcmdbuf</span>&nbsp;<span class="op" id="7104430">:=</span>&nbsp;<span class="ident" id="7104433">bufio</span><span class="op" id="7104438">.</span><span class="ident" id="7104439">NewWriter</span><span class="op" id="7104448">(</span><span class="op" id="7104449">&amp;</span><span class="ident" id="7104450">cmdbuf</span><span class="op" id="7104456">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7104459">var</span>&nbsp;<span class="ident" id="7104463">fake</span>&nbsp;<span class="ident" id="7104468">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7104475">fake</span><span class="op" id="7104479">.</span><span class="ident" id="7104480">ReadWriter</span>&nbsp;<span class="op" id="7104491">=</span>&nbsp;<span class="ident" id="7104493">bufio</span><span class="op" id="7104498">.</span><span class="ident" id="7104499">NewReadWriter</span><span class="op" id="7104512">(</span><span class="ident" id="7104513">bufio</span><span class="op" id="7104518">.</span><span class="ident" id="7104519">NewReader</span><span class="op" id="7104528">(</span><span class="ident" id="7104529">strings</span><span class="op" id="7104536">.</span><span class="ident" id="7104537">NewReader</span><span class="op" id="7104546">(</span><span class="ident" id="7104547">server</span><span class="op" id="7104553">)</span><span class="op" id="7104554">)</span><span class="op" id="7104555">,</span>&nbsp;<span class="ident" id="7104557">bcmdbuf</span><span class="op" id="7104564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7104567">c</span><span class="op" id="7104568">,</span>&nbsp;<span class="ident" id="7104570">err</span>&nbsp;<span class="op" id="7104574">:=</span>&nbsp;<span class="ident" id="7104577">NewClient</span><span class="op" id="7104586">(</span><span class="ident" id="7104587">fake</span><span class="op" id="7104591">,</span>&nbsp;<span class="string" id="7104593">&#34;fake.host&#34;</span><span class="op" id="7104604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7104607">if</span>&nbsp;<span class="ident" id="7104610">err</span>&nbsp;<span class="op" id="7104614">!=</span>&nbsp;<span class="ident" id="7104617">nil</span>&nbsp;<span class="op" id="7104621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7104625">t</span><span class="op" id="7104626">.</span><span class="ident" id="7104627">Fatalf</span><span class="op" id="7104633">(</span><span class="string" id="7104634">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="7104649">,</span>&nbsp;<span class="ident" id="7104651">err</span><span class="op" id="7104654">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7104657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7104660">defer</span>&nbsp;<span class="ident" id="7104666">c</span><span class="op" id="7104667">.</span><span class="ident" id="7104668">Close</span><span class="op" id="7104673">(</span><span class="op" id="7104674">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7104678">c</span><span class="op" id="7104679">.</span><span class="ident" id="7104680">tls</span>&nbsp;<span class="op" id="7104684">=</span>&nbsp;<span class="builtintype" id="7104686">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7104692">c</span><span class="op" id="7104693">.</span><span class="ident" id="7104694">serverName</span>&nbsp;<span class="op" id="7104705">=</span>&nbsp;<span class="string" id="7104707">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7104726">err</span>&nbsp;<span class="op" id="7104730">=</span>&nbsp;<span class="ident" id="7104732">c</span><span class="op" id="7104733">.</span><span class="ident" id="7104734">Auth</span><span class="op" id="7104738">(</span><span class="ident" id="7104739">PlainAuth</span><span class="op" id="7104748">(</span><span class="string" id="7104749">&#34;&#34;</span><span class="op" id="7104751">,</span>&nbsp;<span class="string" id="7104753">&#34;user&#34;</span><span class="op" id="7104759">,</span>&nbsp;<span class="string" id="7104761">&#34;pass&#34;</span><span class="op" id="7104767">,</span>&nbsp;<span class="string" id="7104769">&#34;smtp.google.com&#34;</span><span class="op" id="7104786">)</span><span class="op" id="7104787">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7104791">if</span>&nbsp;<span class="ident" id="7104794">err</span>&nbsp;<span class="op" id="7104798">==</span>&nbsp;<span class="ident" id="7104801">nil</span>&nbsp;<span class="op" id="7104805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7104809">t</span><span class="op" id="7104810">.</span><span class="ident" id="7104811">Error</span><span class="op" id="7104816">(</span><span class="string" id="7104817">&#34;Auth:&nbsp;expected&nbsp;error;&nbsp;got&nbsp;none&#34;</span><span class="op" id="7104849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7104852">}</span>&nbsp;<span class="keyword" id="7104854">else</span>&nbsp;<span class="keyword" id="7104859">if</span>&nbsp;<span class="ident" id="7104862">err</span><span class="op" id="7104865">.</span><span class="ident" id="7104866">Error</span><span class="op" id="7104871">(</span><span class="op" id="7104872">)</span>&nbsp;<span class="op" id="7104874">!=</span>&nbsp;<span class="string" id="7104877">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span>&nbsp;<span class="op" id="7104931">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7104935">t</span><span class="op" id="7104936">.</span><span class="ident" id="7104937">Errorf</span><span class="op" id="7104943">(</span><span class="string" id="7104944">&#34;Auth:&nbsp;got&nbsp;error:&nbsp;%v,&nbsp;want:&nbsp;%s&#34;</span><span class="op" id="7104975">,</span>&nbsp;<span class="ident" id="7104977">err</span><span class="op" id="7104980">,</span>&nbsp;<span class="string" id="7104982">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span><span class="op" id="7105035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7105038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7105042">bcmdbuf</span><span class="op" id="7105049">.</span><span class="ident" id="7105050">Flush</span><span class="op" id="7105055">(</span><span class="op" id="7105056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7105059">actualcmds</span>&nbsp;<span class="op" id="7105070">:=</span>&nbsp;<span class="ident" id="7105073">cmdbuf</span><span class="op" id="7105079">.</span><span class="ident" id="7105080">String</span><span class="op" id="7105086">(</span><span class="op" id="7105087">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7105090">if</span>&nbsp;<span class="ident" id="7105093">client</span>&nbsp;<span class="op" id="7105100">!=</span>&nbsp;<span class="ident" id="7105103">actualcmds</span>&nbsp;<span class="op" id="7105114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7105118">t</span><span class="op" id="7105119">.</span><span class="ident" id="7105120">Errorf</span><span class="op" id="7105126">(</span><span class="string" id="7105127">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7105152">,</span>&nbsp;<span class="ident" id="7105154">actualcmds</span><span class="op" id="7105164">,</span>&nbsp;<span class="ident" id="7105166">client</span><span class="op" id="7105172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7105175">}</span><br>
<span class="lineno"></span><span class="op" id="7105177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">540</span><span class="keyword" id="7105180">var</span>&nbsp;<span class="ident" id="7105184">authFailedServer</span>&nbsp;<span class="op" id="7105201">=</span>&nbsp;<span class="string" id="7105203">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>535-Invalid&nbsp;credentials<br>
<span class="lineno"></span>535&nbsp;please&nbsp;see&nbsp;www.example.com<br>
<span class="lineno">545</span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7105345">var</span>&nbsp;<span class="ident" id="7105349">authFailedClient</span>&nbsp;<span class="op" id="7105366">=</span>&nbsp;<span class="string" id="7105368">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno">550</span>*<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7105422">func</span>&nbsp;<span class="ident" id="7105427">TestTLSClient</span><span class="op" id="7105440">(</span><span class="ident" id="7105441">t</span>&nbsp;<span class="op" id="7105443">*</span><span class="ident" id="7105444">testing</span><span class="op" id="7105451">.</span><span class="ident" id="7105452">T</span><span class="op" id="7105453">)</span>&nbsp;<span class="op" id="7105455">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7105458">ln</span>&nbsp;<span class="op" id="7105461">:=</span>&nbsp;<span class="ident" id="7105464">newLocalListener</span><span class="op" id="7105480">(</span><span class="ident" id="7105481">t</span><span class="op" id="7105482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7105485">defer</span>&nbsp;<span class="ident" id="7105491">ln</span><span class="op" id="7105493">.</span><span class="ident" id="7105494">Close</span><span class="op" id="7105499">(</span><span class="op" id="7105500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7105503">errc</span>&nbsp;<span class="op" id="7105508">:=</span>&nbsp;<span class="builtinfunc" id="7105511">make</span><span class="op" id="7105515">(</span><span class="keyword" id="7105516">chan</span>&nbsp;<span class="builtintype" id="7105521">error</span><span class="op" id="7105526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7105529">go</span>&nbsp;<span class="keyword" id="7105532">func</span><span class="op" id="7105536">(</span><span class="op" id="7105537">)</span>&nbsp;<span class="op" id="7105539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7105543">errc</span>&nbsp;<span class="op" id="7105548">&lt;-</span>&nbsp;<span class="ident" id="7105551">sendMail</span><span class="op" id="7105559">(</span><span class="ident" id="7105560">ln</span><span class="op" id="7105562">.</span><span class="ident" id="7105563">Addr</span><span class="op" id="7105567">(</span><span class="op" id="7105568">)</span><span class="op" id="7105569">.</span><span class="ident" id="7105570">String</span><span class="op" id="7105576">(</span><span class="op" id="7105577">)</span><span class="op" id="7105578">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7105581">}</span><span class="op" id="7105582">(</span><span class="op" id="7105583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7105586">conn</span><span class="op" id="7105590">,</span>&nbsp;<span class="ident" id="7105592">err</span>&nbsp;<span class="op" id="7105596">:=</span>&nbsp;<span class="ident" id="7105599">ln</span><span class="op" id="7105601">.</span><span class="ident" id="7105602">Accept</span><span class="op" id="7105608">(</span><span class="op" id="7105609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7105612">if</span>&nbsp;<span class="ident" id="7105615">err</span>&nbsp;<span class="op" id="7105619">!=</span>&nbsp;<span class="ident" id="7105622">nil</span>&nbsp;<span class="op" id="7105626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7105630">t</span><span class="op" id="7105631">.</span><span class="ident" id="7105632">Fatalf</span><span class="op" id="7105638">(</span><span class="string" id="7105639">&#34;failed&nbsp;to&nbsp;accept&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="7105672">,</span>&nbsp;<span class="ident" id="7105674">err</span><span class="op" id="7105677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7105680">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7105683">defer</span>&nbsp;<span class="ident" id="7105689">conn</span><span class="op" id="7105693">.</span><span class="ident" id="7105694">Close</span><span class="op" id="7105699">(</span><span class="op" id="7105700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7105703">if</span>&nbsp;<span class="ident" id="7105706">err</span>&nbsp;<span class="op" id="7105710">:=</span>&nbsp;<span class="ident" id="7105713">serverHandle</span><span class="op" id="7105725">(</span><span class="ident" id="7105726">conn</span><span class="op" id="7105730">,</span>&nbsp;<span class="ident" id="7105732">t</span><span class="op" id="7105733">)</span><span class="op" id="7105734">;</span>&nbsp;<span class="ident" id="7105736">err</span>&nbsp;<span class="op" id="7105740">!=</span>&nbsp;<span class="ident" id="7105743">nil</span>&nbsp;<span class="op" id="7105747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7105751">t</span><span class="op" id="7105752">.</span><span class="ident" id="7105753">Fatalf</span><span class="op" id="7105759">(</span><span class="string" id="7105760">&#34;failed&nbsp;to&nbsp;handle&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="7105793">,</span>&nbsp;<span class="ident" id="7105795">err</span><span class="op" id="7105798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7105801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7105804">if</span>&nbsp;<span class="ident" id="7105807">err</span>&nbsp;<span class="op" id="7105811">:=</span>&nbsp;<span class="op" id="7105814">&lt;-</span><span class="ident" id="7105816">errc</span><span class="op" id="7105820">;</span>&nbsp;<span class="ident" id="7105822">err</span>&nbsp;<span class="op" id="7105826">!=</span>&nbsp;<span class="ident" id="7105829">nil</span>&nbsp;<span class="op" id="7105833">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7105837">t</span><span class="op" id="7105838">.</span><span class="ident" id="7105839">Fatalf</span><span class="op" id="7105845">(</span><span class="string" id="7105846">&#34;client&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7105864">,</span>&nbsp;<span class="ident" id="7105866">err</span><span class="op" id="7105869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7105872">}</span><br>
<span class="lineno"></span><span class="op" id="7105874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7105877">func</span>&nbsp;<span class="ident" id="7105882">newLocalListener</span><span class="op" id="7105898">(</span><span class="ident" id="7105899">t</span>&nbsp;<span class="op" id="7105901">*</span><span class="ident" id="7105902">testing</span><span class="op" id="7105909">.</span><span class="ident" id="7105910">T</span><span class="op" id="7105911">)</span>&nbsp;<span class="ident" id="7105913">net</span><span class="op" id="7105916">.</span><span class="ident" id="7105917">Listener</span>&nbsp;<span class="op" id="7105926">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7105929">ln</span><span class="op" id="7105931">,</span>&nbsp;<span class="ident" id="7105933">err</span>&nbsp;<span class="op" id="7105937">:=</span>&nbsp;<span class="ident" id="7105940">net</span><span class="op" id="7105943">.</span><span class="ident" id="7105944">Listen</span><span class="op" id="7105950">(</span><span class="string" id="7105951">&#34;tcp&#34;</span><span class="op" id="7105956">,</span>&nbsp;<span class="string" id="7105958">&#34;127.0.0.1:0&#34;</span><span class="op" id="7105971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7105974">if</span>&nbsp;<span class="ident" id="7105977">err</span>&nbsp;<span class="op" id="7105981">!=</span>&nbsp;<span class="ident" id="7105984">nil</span>&nbsp;<span class="op" id="7105988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7105992">ln</span><span class="op" id="7105994">,</span>&nbsp;<span class="ident" id="7105996">err</span>&nbsp;<span class="op" id="7106000">=</span>&nbsp;<span class="ident" id="7106002">net</span><span class="op" id="7106005">.</span><span class="ident" id="7106006">Listen</span><span class="op" id="7106012">(</span><span class="string" id="7106013">&#34;tcp6&#34;</span><span class="op" id="7106019">,</span>&nbsp;<span class="string" id="7106021">&#34;[::1]:0&#34;</span><span class="op" id="7106030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7106033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7106036">if</span>&nbsp;<span class="ident" id="7106039">err</span>&nbsp;<span class="op" id="7106043">!=</span>&nbsp;<span class="ident" id="7106046">nil</span>&nbsp;<span class="op" id="7106050">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7106054">t</span><span class="op" id="7106055">.</span><span class="ident" id="7106056">Fatal</span><span class="op" id="7106061">(</span><span class="ident" id="7106062">err</span><span class="op" id="7106065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7106068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7106071">return</span>&nbsp;<span class="ident" id="7106078">ln</span><br>
<span class="lineno"></span><span class="op" id="7106081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span><span class="keyword" id="7106084">type</span>&nbsp;<span class="ident" id="7106089">smtpSender</span>&nbsp;<span class="keyword" id="7106100">struct</span>&nbsp;<span class="op" id="7106107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7106110">w</span>&nbsp;<span class="ident" id="7106112">io</span><span class="op" id="7106114">.</span><span class="ident" id="7106115">Writer</span><br>
<span class="lineno"></span><span class="op" id="7106122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7106125">func</span>&nbsp;<span class="op" id="7106130">(</span><span class="ident" id="7106131">s</span>&nbsp;<span class="ident" id="7106133">smtpSender</span><span class="op" id="7106143">)</span>&nbsp;<span class="ident" id="7106145">send</span><span class="op" id="7106149">(</span><span class="ident" id="7106150">f</span>&nbsp;<span class="builtintype" id="7106152">string</span><span class="op" id="7106158">)</span>&nbsp;<span class="op" id="7106160">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7106163">s</span><span class="op" id="7106164">.</span><span class="ident" id="7106165">w</span><span class="op" id="7106166">.</span><span class="ident" id="7106167">Write</span><span class="op" id="7106172">(</span><span class="op" id="7106173">[</span><span class="op" id="7106174">]</span><span class="builtintype" id="7106175">byte</span><span class="op" id="7106179">(</span><span class="ident" id="7106180">f</span>&nbsp;<span class="op" id="7106182">+</span>&nbsp;<span class="string" id="7106184">&#34;\r\n&#34;</span><span class="op" id="7106190">)</span><span class="op" id="7106191">)</span><br>
<span class="lineno"></span><span class="op" id="7106193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7106196">//&nbsp;smtp&nbsp;server,&nbsp;finely&nbsp;tailored&nbsp;to&nbsp;deal&nbsp;with&nbsp;our&nbsp;own&nbsp;client&nbsp;only!</span><br>
<span class="lineno"></span><span class="keyword" id="7106262">func</span>&nbsp;<span class="ident" id="7106267">serverHandle</span><span class="op" id="7106279">(</span><span class="ident" id="7106280">c</span>&nbsp;<span class="ident" id="7106282">net</span><span class="op" id="7106285">.</span><span class="ident" id="7106286">Conn</span><span class="op" id="7106290">,</span>&nbsp;<span class="ident" id="7106292">t</span>&nbsp;<span class="op" id="7106294">*</span><span class="ident" id="7106295">testing</span><span class="op" id="7106302">.</span><span class="ident" id="7106303">T</span><span class="op" id="7106304">)</span>&nbsp;<span class="builtintype" id="7106306">error</span>&nbsp;<span class="op" id="7106312">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7106315">send</span>&nbsp;<span class="op" id="7106320">:=</span>&nbsp;<span class="ident" id="7106323">smtpSender</span><span class="op" id="7106333">{</span><span class="ident" id="7106334">c</span><span class="op" id="7106335">}</span><span class="op" id="7106336">.</span><span class="ident" id="7106337">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7106343">send</span><span class="op" id="7106347">(</span><span class="string" id="7106348">&#34;220&nbsp;127.0.0.1&nbsp;ESMTP&nbsp;service&nbsp;ready&#34;</span><span class="op" id="7106383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7106386">s</span>&nbsp;<span class="op" id="7106388">:=</span>&nbsp;<span class="ident" id="7106391">bufio</span><span class="op" id="7106396">.</span><span class="ident" id="7106397">NewScanner</span><span class="op" id="7106407">(</span><span class="ident" id="7106408">c</span><span class="op" id="7106409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7106412">for</span>&nbsp;<span class="ident" id="7106416">s</span><span class="op" id="7106417">.</span><span class="ident" id="7106418">Scan</span><span class="op" id="7106422">(</span><span class="op" id="7106423">)</span>&nbsp;<span class="op" id="7106425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7106429">switch</span>&nbsp;<span class="ident" id="7106436">s</span><span class="op" id="7106437">.</span><span class="ident" id="7106438">Text</span><span class="op" id="7106442">(</span><span class="op" id="7106443">)</span>&nbsp;<span class="op" id="7106445">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7106449">case</span>&nbsp;<span class="string" id="7106454">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="7106470">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7106475">send</span><span class="op" id="7106479">(</span><span class="string" id="7106480">&#34;250-127.0.0.1&nbsp;ESMTP&nbsp;offers&nbsp;a&nbsp;warm&nbsp;hug&nbsp;of&nbsp;welcome&#34;</span><span class="op" id="7106530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7106535">send</span><span class="op" id="7106539">(</span><span class="string" id="7106540">&#34;250-STARTTLS&#34;</span><span class="op" id="7106554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7106559">send</span><span class="op" id="7106563">(</span><span class="string" id="7106564">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7106572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7106576">case</span>&nbsp;<span class="string" id="7106581">&#34;STARTTLS&#34;</span><span class="op" id="7106591">:</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7106596">send</span><span class="op" id="7106600">(</span><span class="string" id="7106601">&#34;220&nbsp;Go&nbsp;ahead&#34;</span><span class="op" id="7106615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7106620">keypair</span><span class="op" id="7106627">,</span>&nbsp;<span class="ident" id="7106629">err</span>&nbsp;<span class="op" id="7106633">:=</span>&nbsp;<span class="ident" id="7106636">tls</span><span class="op" id="7106639">.</span><span class="ident" id="7106640">X509KeyPair</span><span class="op" id="7106651">(</span><span class="ident" id="7106652">localhostCert</span><span class="op" id="7106665">,</span>&nbsp;<span class="ident" id="7106667">localhostKey</span><span class="op" id="7106679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7106684">if</span>&nbsp;<span class="ident" id="7106687">err</span>&nbsp;<span class="op" id="7106691">!=</span>&nbsp;<span class="ident" id="7106694">nil</span>&nbsp;<span class="op" id="7106698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7106704">return</span>&nbsp;<span class="ident" id="7106711">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7106718">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7106723">config</span>&nbsp;<span class="op" id="7106730">:=</span>&nbsp;<span class="op" id="7106733">&amp;</span><span class="ident" id="7106734">tls</span><span class="op" id="7106737">.</span><span class="ident" id="7106738">Config</span><span class="op" id="7106744">{</span><span class="ident" id="7106745">Certificates</span><span class="op" id="7106757">:</span>&nbsp;<span class="op" id="7106759">[</span><span class="op" id="7106760">]</span><span class="ident" id="7106761">tls</span><span class="op" id="7106764">.</span><span class="ident" id="7106765">Certificate</span><span class="op" id="7106776">{</span><span class="ident" id="7106777">keypair</span><span class="op" id="7106784">}</span><span class="op" id="7106785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7106790">c</span>&nbsp;<span class="op" id="7106792">=</span>&nbsp;<span class="ident" id="7106794">tls</span><span class="op" id="7106797">.</span><span class="ident" id="7106798">Server</span><span class="op" id="7106804">(</span><span class="ident" id="7106805">c</span><span class="op" id="7106806">,</span>&nbsp;<span class="ident" id="7106808">config</span><span class="op" id="7106814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7106819">defer</span>&nbsp;<span class="ident" id="7106825">c</span><span class="op" id="7106826">.</span><span class="ident" id="7106827">Close</span><span class="op" id="7106832">(</span><span class="op" id="7106833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7106838">return</span>&nbsp;<span class="ident" id="7106845">serverHandleTLS</span><span class="op" id="7106860">(</span><span class="ident" id="7106861">c</span><span class="op" id="7106862">,</span>&nbsp;<span class="ident" id="7106864">t</span><span class="op" id="7106865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7106869">default</span><span class="op" id="7106876">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7106881">t</span><span class="op" id="7106882">.</span><span class="ident" id="7106883">Fatalf</span><span class="op" id="7106889">(</span><span class="string" id="7106890">&#34;unrecognized&nbsp;command:&nbsp;%q&#34;</span><span class="op" id="7106916">,</span>&nbsp;<span class="ident" id="7106918">s</span><span class="op" id="7106919">.</span><span class="ident" id="7106920">Text</span><span class="op" id="7106924">(</span><span class="op" id="7106925">)</span><span class="op" id="7106926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7106930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7106933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7106936">return</span>&nbsp;<span class="ident" id="7106943">s</span><span class="op" id="7106944">.</span><span class="ident" id="7106945">Err</span><span class="op" id="7106948">(</span><span class="op" id="7106949">)</span><br>
<span class="lineno"></span><span class="op" id="7106951">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="7106954">func</span>&nbsp;<span class="ident" id="7106959">serverHandleTLS</span><span class="op" id="7106974">(</span><span class="ident" id="7106975">c</span>&nbsp;<span class="ident" id="7106977">net</span><span class="op" id="7106980">.</span><span class="ident" id="7106981">Conn</span><span class="op" id="7106985">,</span>&nbsp;<span class="ident" id="7106987">t</span>&nbsp;<span class="op" id="7106989">*</span><span class="ident" id="7106990">testing</span><span class="op" id="7106997">.</span><span class="ident" id="7106998">T</span><span class="op" id="7106999">)</span>&nbsp;<span class="builtintype" id="7107001">error</span>&nbsp;<span class="op" id="7107007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107010">send</span>&nbsp;<span class="op" id="7107015">:=</span>&nbsp;<span class="ident" id="7107018">smtpSender</span><span class="op" id="7107028">{</span><span class="ident" id="7107029">c</span><span class="op" id="7107030">}</span><span class="op" id="7107031">.</span><span class="ident" id="7107032">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107038">s</span>&nbsp;<span class="op" id="7107040">:=</span>&nbsp;<span class="ident" id="7107043">bufio</span><span class="op" id="7107048">.</span><span class="ident" id="7107049">NewScanner</span><span class="op" id="7107059">(</span><span class="ident" id="7107060">c</span><span class="op" id="7107061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107064">for</span>&nbsp;<span class="ident" id="7107068">s</span><span class="op" id="7107069">.</span><span class="ident" id="7107070">Scan</span><span class="op" id="7107074">(</span><span class="op" id="7107075">)</span>&nbsp;<span class="op" id="7107077">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107081">switch</span>&nbsp;<span class="ident" id="7107088">s</span><span class="op" id="7107089">.</span><span class="ident" id="7107090">Text</span><span class="op" id="7107094">(</span><span class="op" id="7107095">)</span>&nbsp;<span class="op" id="7107097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107101">case</span>&nbsp;<span class="string" id="7107106">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="7107122">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107127">send</span><span class="op" id="7107131">(</span><span class="string" id="7107132">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7107140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107144">case</span>&nbsp;<span class="string" id="7107149">&#34;MAIL&nbsp;FROM:&lt;joe1@example.com&gt;&#34;</span><span class="op" id="7107179">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107184">send</span><span class="op" id="7107188">(</span><span class="string" id="7107189">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7107197">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107201">case</span>&nbsp;<span class="string" id="7107206">&#34;RCPT&nbsp;TO:&lt;joe2@example.com&gt;&#34;</span><span class="op" id="7107234">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107239">send</span><span class="op" id="7107243">(</span><span class="string" id="7107244">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7107252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107256">case</span>&nbsp;<span class="string" id="7107261">&#34;DATA&#34;</span><span class="op" id="7107267">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107272">send</span><span class="op" id="7107276">(</span><span class="string" id="7107277">&#34;354&nbsp;send&nbsp;the&nbsp;mail&nbsp;data,&nbsp;end&nbsp;with&nbsp;.&#34;</span><span class="op" id="7107313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107318">send</span><span class="op" id="7107322">(</span><span class="string" id="7107323">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7107331">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107335">case</span>&nbsp;<span class="string" id="7107340">&#34;Subject:&nbsp;test&#34;</span><span class="op" id="7107355">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107359">case</span>&nbsp;<span class="string" id="7107364">&#34;&#34;</span><span class="op" id="7107366">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107370">case</span>&nbsp;<span class="string" id="7107375">&#34;howdy!&#34;</span><span class="op" id="7107383">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107387">case</span>&nbsp;<span class="string" id="7107392">&#34;.&#34;</span><span class="op" id="7107395">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107399">case</span>&nbsp;<span class="string" id="7107404">&#34;QUIT&#34;</span><span class="op" id="7107410">:</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107415">send</span><span class="op" id="7107419">(</span><span class="string" id="7107420">&#34;221&nbsp;127.0.0.1&nbsp;Service&nbsp;closing&nbsp;transmission&nbsp;channel&#34;</span><span class="op" id="7107472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107477">return</span>&nbsp;<span class="ident" id="7107484">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107490">default</span><span class="op" id="7107497">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107502">t</span><span class="op" id="7107503">.</span><span class="ident" id="7107504">Fatalf</span><span class="op" id="7107510">(</span><span class="string" id="7107511">&#34;unrecognized&nbsp;command&nbsp;during&nbsp;TLS:&nbsp;%q&#34;</span><span class="op" id="7107548">,</span>&nbsp;<span class="ident" id="7107550">s</span><span class="op" id="7107551">.</span><span class="ident" id="7107552">Text</span><span class="op" id="7107556">(</span><span class="op" id="7107557">)</span><span class="op" id="7107558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7107562">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7107565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107568">return</span>&nbsp;<span class="ident" id="7107575">s</span><span class="op" id="7107576">.</span><span class="ident" id="7107577">Err</span><span class="op" id="7107580">(</span><span class="op" id="7107581">)</span><br>
<span class="lineno"></span><span class="op" id="7107583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7107586">func</span>&nbsp;<span class="ident" id="7107591">init</span><span class="op" id="7107595">(</span><span class="op" id="7107596">)</span>&nbsp;<span class="op" id="7107598">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107601">testRootCAs</span>&nbsp;<span class="op" id="7107613">:=</span>&nbsp;<span class="ident" id="7107616">x509</span><span class="op" id="7107620">.</span><span class="ident" id="7107621">NewCertPool</span><span class="op" id="7107632">(</span><span class="op" id="7107633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107636">testRootCAs</span><span class="op" id="7107647">.</span><span class="ident" id="7107648">AppendCertsFromPEM</span><span class="op" id="7107666">(</span><span class="ident" id="7107667">localhostCert</span><span class="op" id="7107680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107683">testHookStartTLS</span>&nbsp;<span class="op" id="7107700">=</span>&nbsp;<span class="keyword" id="7107702">func</span><span class="op" id="7107706">(</span><span class="ident" id="7107707">config</span>&nbsp;<span class="op" id="7107714">*</span><span class="ident" id="7107715">tls</span><span class="op" id="7107718">.</span><span class="ident" id="7107719">Config</span><span class="op" id="7107725">)</span>&nbsp;<span class="op" id="7107727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107731">config</span><span class="op" id="7107737">.</span><span class="ident" id="7107738">RootCAs</span>&nbsp;<span class="op" id="7107746">=</span>&nbsp;<span class="ident" id="7107748">testRootCAs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7107761">}</span><br>
<span class="lineno">655</span><span class="op" id="7107763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7107766">func</span>&nbsp;<span class="ident" id="7107771">sendMail</span><span class="op" id="7107779">(</span><span class="ident" id="7107780">hostPort</span>&nbsp;<span class="builtintype" id="7107789">string</span><span class="op" id="7107795">)</span>&nbsp;<span class="builtintype" id="7107797">error</span>&nbsp;<span class="op" id="7107803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107806">host</span><span class="op" id="7107810">,</span>&nbsp;<span class="ident" id="7107812">_</span><span class="op" id="7107813">,</span>&nbsp;<span class="ident" id="7107815">err</span>&nbsp;<span class="op" id="7107819">:=</span>&nbsp;<span class="ident" id="7107822">net</span><span class="op" id="7107825">.</span><span class="ident" id="7107826">SplitHostPort</span><span class="op" id="7107839">(</span><span class="ident" id="7107840">hostPort</span><span class="op" id="7107848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107851">if</span>&nbsp;<span class="ident" id="7107854">err</span>&nbsp;<span class="op" id="7107858">!=</span>&nbsp;<span class="ident" id="7107861">nil</span>&nbsp;<span class="op" id="7107865">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107869">return</span>&nbsp;<span class="ident" id="7107876">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7107881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107884">auth</span>&nbsp;<span class="op" id="7107889">:=</span>&nbsp;<span class="ident" id="7107892">PlainAuth</span><span class="op" id="7107901">(</span><span class="string" id="7107902">&#34;&#34;</span><span class="op" id="7107904">,</span>&nbsp;<span class="string" id="7107906">&#34;&#34;</span><span class="op" id="7107908">,</span>&nbsp;<span class="string" id="7107910">&#34;&#34;</span><span class="op" id="7107912">,</span>&nbsp;<span class="ident" id="7107914">host</span><span class="op" id="7107918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107921">from</span>&nbsp;<span class="op" id="7107926">:=</span>&nbsp;<span class="string" id="7107929">&#34;joe1@example.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7107949">to</span>&nbsp;<span class="op" id="7107952">:=</span>&nbsp;<span class="op" id="7107955">[</span><span class="op" id="7107956">]</span><span class="builtintype" id="7107957">string</span><span class="op" id="7107963">{</span><span class="string" id="7107964">&#34;joe2@example.com&#34;</span><span class="op" id="7107982">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7107985">return</span>&nbsp;<span class="ident" id="7107992">SendMail</span><span class="op" id="7108000">(</span><span class="ident" id="7108001">hostPort</span><span class="op" id="7108009">,</span>&nbsp;<span class="ident" id="7108011">auth</span><span class="op" id="7108015">,</span>&nbsp;<span class="ident" id="7108017">from</span><span class="op" id="7108021">,</span>&nbsp;<span class="ident" id="7108023">to</span><span class="op" id="7108025">,</span>&nbsp;<span class="op" id="7108027">[</span><span class="op" id="7108028">]</span><span class="builtintype" id="7108029">byte</span><span class="op" id="7108033">(</span><span class="string" id="7108034">&#34;Subject:&nbsp;test\n\nhowdy!&#34;</span><span class="op" id="7108059">)</span><span class="op" id="7108060">)</span><br>
<span class="lineno"></span><span class="op" id="7108062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7108065">//&nbsp;(copied&nbsp;from&nbsp;net/http/httptest)</span><br>
<span class="lineno"></span><span class="comment" id="7108100">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno">670</span><span class="comment" id="7108156">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno"></span><span class="comment" id="7108229">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="7108248">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="7108282">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="7108418">var</span>&nbsp;<span class="ident" id="7108422">localhostCert</span>&nbsp;<span class="op" id="7108436">=</span>&nbsp;<span class="op" id="7108438">[</span><span class="op" id="7108439">]</span><span class="builtintype" id="7108440">byte</span><span class="op" id="7108444">(</span><span class="string" id="7108445">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno">675</span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno"></span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno">680</span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno"></span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="7109016">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span><span class="comment" id="7109019">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno"></span><span class="keyword" id="7109073">var</span>&nbsp;<span class="ident" id="7109077">localhostKey</span>&nbsp;<span class="op" id="7109090">=</span>&nbsp;<span class="op" id="7109092">[</span><span class="op" id="7109093">]</span><span class="builtintype" id="7109094">byte</span><span class="op" id="7109098">(</span><span class="string" id="7109099">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno">690</span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno"></span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="7109597">)</span>
</div>
</body>
</html>
