<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5883027">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5883082">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5883136">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5883187">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5883218">package</span>&nbsp;<span class="ident" id="5883226">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5883236">import</span>&nbsp;<span class="op" id="5883243">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5883246">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5883252">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5883259">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5883266">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5883278">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5883289">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5883300">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5883308">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5883315">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5883318">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5883391">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="5883417">var</span>&nbsp;<span class="ident" id="5883421">onExitFlushLoop</span>&nbsp;<span class="keyword" id="5883437">func</span><span class="op" id="5883441">(</span><span class="op" id="5883442">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5883445">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="5883515">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5883580">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="5883591">type</span>&nbsp;<span class="ident" id="5883596">ReverseProxy</span>&nbsp;<span class="keyword" id="5883609">struct</span>&nbsp;<span class="op" id="5883616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883619">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883666">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883712">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883761">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883805">Director</span>&nbsp;<span class="keyword" id="5883814">func</span><span class="op" id="5883818">(</span><span class="op" id="5883819">*</span><span class="ident" id="5883820">http</span><span class="op" id="5883824">.</span><span class="ident" id="5883825">Request</span><span class="op" id="5883832">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883836">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883886">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883929">Transport</span>&nbsp;<span class="ident" id="5883939">http</span><span class="op" id="5883943">.</span><span class="ident" id="5883944">RoundTripper</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883959">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5884006">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5884051">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5884070">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884113">FlushInterval</span>&nbsp;<span class="ident" id="5884127">time</span><span class="op" id="5884131">.</span><span class="ident" id="5884132">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5884143">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5884196">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5884249">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5884309">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884330">ErrorLog</span>&nbsp;<span class="op" id="5884339">*</span><span class="ident" id="5884340">log</span><span class="op" id="5884343">.</span><span class="ident" id="5884344">Logger</span><br>
<span class="lineno"></span><span class="op" id="5884351">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="5884354">func</span>&nbsp;<span class="ident" id="5884359">singleJoiningSlash</span><span class="op" id="5884377">(</span><span class="ident" id="5884378">a</span><span class="op" id="5884379">,</span>&nbsp;<span class="ident" id="5884381">b</span>&nbsp;<span class="builtintype" id="5884383">string</span><span class="op" id="5884389">)</span>&nbsp;<span class="builtintype" id="5884391">string</span>&nbsp;<span class="op" id="5884398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884401">aslash</span>&nbsp;<span class="op" id="5884408">:=</span>&nbsp;<span class="ident" id="5884411">strings</span><span class="op" id="5884418">.</span><span class="ident" id="5884419">HasSuffix</span><span class="op" id="5884428">(</span><span class="ident" id="5884429">a</span><span class="op" id="5884430">,</span>&nbsp;<span class="string" id="5884432">&#34;/&#34;</span><span class="op" id="5884435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884438">bslash</span>&nbsp;<span class="op" id="5884445">:=</span>&nbsp;<span class="ident" id="5884448">strings</span><span class="op" id="5884455">.</span><span class="ident" id="5884456">HasPrefix</span><span class="op" id="5884465">(</span><span class="ident" id="5884466">b</span><span class="op" id="5884467">,</span>&nbsp;<span class="string" id="5884469">&#34;/&#34;</span><span class="op" id="5884472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884475">switch</span>&nbsp;<span class="op" id="5884482">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884485">case</span>&nbsp;<span class="ident" id="5884490">aslash</span>&nbsp;<span class="op" id="5884497">&amp;&amp;</span>&nbsp;<span class="ident" id="5884500">bslash</span><span class="op" id="5884506">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884510">return</span>&nbsp;<span class="ident" id="5884517">a</span>&nbsp;<span class="op" id="5884519">+</span>&nbsp;<span class="ident" id="5884521">b</span><span class="op" id="5884522">[</span><span class="num" id="5884523">1</span><span class="op" id="5884524">:</span><span class="op" id="5884525">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884528">case</span>&nbsp;<span class="op" id="5884533">!</span><span class="ident" id="5884534">aslash</span>&nbsp;<span class="op" id="5884541">&amp;&amp;</span>&nbsp;<span class="op" id="5884544">!</span><span class="ident" id="5884545">bslash</span><span class="op" id="5884551">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884555">return</span>&nbsp;<span class="ident" id="5884562">a</span>&nbsp;<span class="op" id="5884564">+</span>&nbsp;<span class="string" id="5884566">&#34;/&#34;</span>&nbsp;<span class="op" id="5884570">+</span>&nbsp;<span class="ident" id="5884572">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5884575">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884578">return</span>&nbsp;<span class="ident" id="5884585">a</span>&nbsp;<span class="op" id="5884587">+</span>&nbsp;<span class="ident" id="5884589">b</span><br>
<span class="lineno"></span><span class="op" id="5884591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5884594">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="5884664">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="5884734">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="5884803">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="5884848">func</span>&nbsp;<span class="ident" id="5884853">NewSingleHostReverseProxy</span><span class="op" id="5884878">(</span><span class="ident" id="5884879">target</span>&nbsp;<span class="op" id="5884886">*</span><span class="ident" id="5884887">url</span><span class="op" id="5884890">.</span><span class="ident" id="5884891">URL</span><span class="op" id="5884894">)</span>&nbsp;<span class="op" id="5884896">*</span><span class="ident" id="5884897">ReverseProxy</span>&nbsp;<span class="op" id="5884910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884913">targetQuery</span>&nbsp;<span class="op" id="5884925">:=</span>&nbsp;<span class="ident" id="5884928">target</span><span class="op" id="5884934">.</span><span class="ident" id="5884935">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884945">director</span>&nbsp;<span class="op" id="5884954">:=</span>&nbsp;<span class="keyword" id="5884957">func</span><span class="op" id="5884961">(</span><span class="ident" id="5884962">req</span>&nbsp;<span class="op" id="5884966">*</span><span class="ident" id="5884967">http</span><span class="op" id="5884971">.</span><span class="ident" id="5884972">Request</span><span class="op" id="5884979">)</span>&nbsp;<span class="op" id="5884981">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884985">req</span><span class="op" id="5884988">.</span><span class="ident" id="5884989">URL</span><span class="op" id="5884992">.</span><span class="ident" id="5884993">Scheme</span>&nbsp;<span class="op" id="5885000">=</span>&nbsp;<span class="ident" id="5885002">target</span><span class="op" id="5885008">.</span><span class="ident" id="5885009">Scheme</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885018">req</span><span class="op" id="5885021">.</span><span class="ident" id="5885022">URL</span><span class="op" id="5885025">.</span><span class="ident" id="5885026">Host</span>&nbsp;<span class="op" id="5885031">=</span>&nbsp;<span class="ident" id="5885033">target</span><span class="op" id="5885039">.</span><span class="ident" id="5885040">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885047">req</span><span class="op" id="5885050">.</span><span class="ident" id="5885051">URL</span><span class="op" id="5885054">.</span><span class="ident" id="5885055">Path</span>&nbsp;<span class="op" id="5885060">=</span>&nbsp;<span class="ident" id="5885062">singleJoiningSlash</span><span class="op" id="5885080">(</span><span class="ident" id="5885081">target</span><span class="op" id="5885087">.</span><span class="ident" id="5885088">Path</span><span class="op" id="5885092">,</span>&nbsp;<span class="ident" id="5885094">req</span><span class="op" id="5885097">.</span><span class="ident" id="5885098">URL</span><span class="op" id="5885101">.</span><span class="ident" id="5885102">Path</span><span class="op" id="5885106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885110">if</span>&nbsp;<span class="ident" id="5885113">targetQuery</span>&nbsp;<span class="op" id="5885125">==</span>&nbsp;<span class="string" id="5885128">&#34;&#34;</span>&nbsp;<span class="op" id="5885131">||</span>&nbsp;<span class="ident" id="5885134">req</span><span class="op" id="5885137">.</span><span class="ident" id="5885138">URL</span><span class="op" id="5885141">.</span><span class="ident" id="5885142">RawQuery</span>&nbsp;<span class="op" id="5885151">==</span>&nbsp;<span class="string" id="5885154">&#34;&#34;</span>&nbsp;<span class="op" id="5885157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885162">req</span><span class="op" id="5885165">.</span><span class="ident" id="5885166">URL</span><span class="op" id="5885169">.</span><span class="ident" id="5885170">RawQuery</span>&nbsp;<span class="op" id="5885179">=</span>&nbsp;<span class="ident" id="5885181">targetQuery</span>&nbsp;<span class="op" id="5885193">+</span>&nbsp;<span class="ident" id="5885195">req</span><span class="op" id="5885198">.</span><span class="ident" id="5885199">URL</span><span class="op" id="5885202">.</span><span class="ident" id="5885203">RawQuery</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5885214">}</span>&nbsp;<span class="keyword" id="5885216">else</span>&nbsp;<span class="op" id="5885221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885226">req</span><span class="op" id="5885229">.</span><span class="ident" id="5885230">URL</span><span class="op" id="5885233">.</span><span class="ident" id="5885234">RawQuery</span>&nbsp;<span class="op" id="5885243">=</span>&nbsp;<span class="ident" id="5885245">targetQuery</span>&nbsp;<span class="op" id="5885257">+</span>&nbsp;<span class="string" id="5885259">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="5885263">+</span>&nbsp;<span class="ident" id="5885265">req</span><span class="op" id="5885268">.</span><span class="ident" id="5885269">URL</span><span class="op" id="5885272">.</span><span class="ident" id="5885273">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5885284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5885287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885290">return</span>&nbsp;<span class="op" id="5885297">&amp;</span><span class="ident" id="5885298">ReverseProxy</span><span class="op" id="5885310">{</span><span class="ident" id="5885311">Director</span><span class="op" id="5885319">:</span>&nbsp;<span class="ident" id="5885321">director</span><span class="op" id="5885329">}</span><br>
<span class="lineno">80</span><span class="op" id="5885331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5885334">func</span>&nbsp;<span class="ident" id="5885339">copyHeader</span><span class="op" id="5885349">(</span><span class="ident" id="5885350">dst</span><span class="op" id="5885353">,</span>&nbsp;<span class="ident" id="5885355">src</span>&nbsp;<span class="ident" id="5885359">http</span><span class="op" id="5885363">.</span><span class="ident" id="5885364">Header</span><span class="op" id="5885370">)</span>&nbsp;<span class="op" id="5885372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885375">for</span>&nbsp;<span class="ident" id="5885379">k</span><span class="op" id="5885380">,</span>&nbsp;<span class="ident" id="5885382">vv</span>&nbsp;<span class="op" id="5885385">:=</span>&nbsp;<span class="keyword" id="5885388">range</span>&nbsp;<span class="ident" id="5885394">src</span>&nbsp;<span class="op" id="5885398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885402">for</span>&nbsp;<span class="ident" id="5885406">_</span><span class="op" id="5885407">,</span>&nbsp;<span class="ident" id="5885409">v</span>&nbsp;<span class="op" id="5885411">:=</span>&nbsp;<span class="keyword" id="5885414">range</span>&nbsp;<span class="ident" id="5885420">vv</span>&nbsp;<span class="op" id="5885423">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885428">dst</span><span class="op" id="5885431">.</span><span class="ident" id="5885432">Add</span><span class="op" id="5885435">(</span><span class="ident" id="5885436">k</span><span class="op" id="5885437">,</span>&nbsp;<span class="ident" id="5885439">v</span><span class="op" id="5885440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5885444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5885447">}</span><br>
<span class="lineno"></span><span class="op" id="5885449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="5885452">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="5885519">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="5885577">var</span>&nbsp;<span class="ident" id="5885581">hopHeaders</span>&nbsp;<span class="op" id="5885592">=</span>&nbsp;<span class="op" id="5885594">[</span><span class="op" id="5885595">]</span><span class="builtintype" id="5885596">string</span><span class="op" id="5885602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5885605">&#34;Connection&#34;</span><span class="op" id="5885617">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5885620">&#34;Keep-Alive&#34;</span><span class="op" id="5885632">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5885635">&#34;Proxy-Authenticate&#34;</span><span class="op" id="5885655">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5885658">&#34;Proxy-Authorization&#34;</span><span class="op" id="5885679">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5885682">&#34;Te&#34;</span><span class="op" id="5885686">,</span>&nbsp;<span class="comment" id="5885688">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5885722">&#34;Trailers&#34;</span><span class="op" id="5885732">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5885735">&#34;Transfer-Encoding&#34;</span><span class="op" id="5885754">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5885757">&#34;Upgrade&#34;</span><span class="op" id="5885766">,</span><br>
<span class="lineno"></span><span class="op" id="5885768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5885771">func</span>&nbsp;<span class="op" id="5885776">(</span><span class="ident" id="5885777">p</span>&nbsp;<span class="op" id="5885779">*</span><span class="ident" id="5885780">ReverseProxy</span><span class="op" id="5885792">)</span>&nbsp;<span class="ident" id="5885794">ServeHTTP</span><span class="op" id="5885803">(</span><span class="ident" id="5885804">rw</span>&nbsp;<span class="ident" id="5885807">http</span><span class="op" id="5885811">.</span><span class="ident" id="5885812">ResponseWriter</span><span class="op" id="5885826">,</span>&nbsp;<span class="ident" id="5885828">req</span>&nbsp;<span class="op" id="5885832">*</span><span class="ident" id="5885833">http</span><span class="op" id="5885837">.</span><span class="ident" id="5885838">Request</span><span class="op" id="5885845">)</span>&nbsp;<span class="op" id="5885847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885850">transport</span>&nbsp;<span class="op" id="5885860">:=</span>&nbsp;<span class="ident" id="5885863">p</span><span class="op" id="5885864">.</span><span class="ident" id="5885865">Transport</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885876">if</span>&nbsp;<span class="ident" id="5885879">transport</span>&nbsp;<span class="op" id="5885889">==</span>&nbsp;<span class="ident" id="5885892">nil</span>&nbsp;<span class="op" id="5885896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885900">transport</span>&nbsp;<span class="op" id="5885910">=</span>&nbsp;<span class="ident" id="5885912">http</span><span class="op" id="5885916">.</span><span class="ident" id="5885917">DefaultTransport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5885935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885939">outreq</span>&nbsp;<span class="op" id="5885946">:=</span>&nbsp;<span class="builtinfunc" id="5885949">new</span><span class="op" id="5885952">(</span><span class="ident" id="5885953">http</span><span class="op" id="5885957">.</span><span class="ident" id="5885958">Request</span><span class="op" id="5885965">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5885968">*</span><span class="ident" id="5885969">outreq</span>&nbsp;<span class="op" id="5885976">=</span>&nbsp;<span class="op" id="5885978">*</span><span class="ident" id="5885979">req</span>&nbsp;<span class="comment" id="5885983">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886030">p</span><span class="op" id="5886031">.</span><span class="ident" id="5886032">Director</span><span class="op" id="5886040">(</span><span class="ident" id="5886041">outreq</span><span class="op" id="5886047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886050">outreq</span><span class="op" id="5886056">.</span><span class="ident" id="5886057">Proto</span>&nbsp;<span class="op" id="5886063">=</span>&nbsp;<span class="string" id="5886065">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886077">outreq</span><span class="op" id="5886083">.</span><span class="ident" id="5886084">ProtoMajor</span>&nbsp;<span class="op" id="5886095">=</span>&nbsp;<span class="num" id="5886097">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886100">outreq</span><span class="op" id="5886106">.</span><span class="ident" id="5886107">ProtoMinor</span>&nbsp;<span class="op" id="5886118">=</span>&nbsp;<span class="num" id="5886120">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886123">outreq</span><span class="op" id="5886129">.</span><span class="ident" id="5886130">Close</span>&nbsp;<span class="op" id="5886136">=</span>&nbsp;<span class="builtintype" id="5886138">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5886146">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5886204">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5886263">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5886327">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5886386">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886437">copiedHeaders</span>&nbsp;<span class="op" id="5886451">:=</span>&nbsp;<span class="builtintype" id="5886454">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5886461">for</span>&nbsp;<span class="ident" id="5886465">_</span><span class="op" id="5886466">,</span>&nbsp;<span class="ident" id="5886468">h</span>&nbsp;<span class="op" id="5886470">:=</span>&nbsp;<span class="keyword" id="5886473">range</span>&nbsp;<span class="ident" id="5886479">hopHeaders</span>&nbsp;<span class="op" id="5886490">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5886494">if</span>&nbsp;<span class="ident" id="5886497">outreq</span><span class="op" id="5886503">.</span><span class="ident" id="5886504">Header</span><span class="op" id="5886510">.</span><span class="ident" id="5886511">Get</span><span class="op" id="5886514">(</span><span class="ident" id="5886515">h</span><span class="op" id="5886516">)</span>&nbsp;<span class="op" id="5886518">!=</span>&nbsp;<span class="string" id="5886521">&#34;&#34;</span>&nbsp;<span class="op" id="5886524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5886529">if</span>&nbsp;<span class="op" id="5886532">!</span><span class="ident" id="5886533">copiedHeaders</span>&nbsp;<span class="op" id="5886547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886553">outreq</span><span class="op" id="5886559">.</span><span class="ident" id="5886560">Header</span>&nbsp;<span class="op" id="5886567">=</span>&nbsp;<span class="builtinfunc" id="5886569">make</span><span class="op" id="5886573">(</span><span class="ident" id="5886574">http</span><span class="op" id="5886578">.</span><span class="ident" id="5886579">Header</span><span class="op" id="5886585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886591">copyHeader</span><span class="op" id="5886601">(</span><span class="ident" id="5886602">outreq</span><span class="op" id="5886608">.</span><span class="ident" id="5886609">Header</span><span class="op" id="5886615">,</span>&nbsp;<span class="ident" id="5886617">req</span><span class="op" id="5886620">.</span><span class="ident" id="5886621">Header</span><span class="op" id="5886627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886633">copiedHeaders</span>&nbsp;<span class="op" id="5886647">=</span>&nbsp;<span class="builtintype" id="5886649">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5886657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886662">outreq</span><span class="op" id="5886668">.</span><span class="ident" id="5886669">Header</span><span class="op" id="5886675">.</span><span class="ident" id="5886676">Del</span><span class="op" id="5886679">(</span><span class="ident" id="5886680">h</span><span class="op" id="5886681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5886685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5886688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5886692">if</span>&nbsp;<span class="ident" id="5886695">clientIP</span><span class="op" id="5886703">,</span>&nbsp;<span class="ident" id="5886705">_</span><span class="op" id="5886706">,</span>&nbsp;<span class="ident" id="5886708">err</span>&nbsp;<span class="op" id="5886712">:=</span>&nbsp;<span class="ident" id="5886715">net</span><span class="op" id="5886718">.</span><span class="ident" id="5886719">SplitHostPort</span><span class="op" id="5886732">(</span><span class="ident" id="5886733">req</span><span class="op" id="5886736">.</span><span class="ident" id="5886737">RemoteAddr</span><span class="op" id="5886747">)</span><span class="op" id="5886748">;</span>&nbsp;<span class="ident" id="5886750">err</span>&nbsp;<span class="op" id="5886754">==</span>&nbsp;<span class="ident" id="5886757">nil</span>&nbsp;<span class="op" id="5886761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5886765">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5886812">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5886862">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5886918">if</span>&nbsp;<span class="ident" id="5886921">prior</span><span class="op" id="5886926">,</span>&nbsp;<span class="ident" id="5886928">ok</span>&nbsp;<span class="op" id="5886931">:=</span>&nbsp;<span class="ident" id="5886934">outreq</span><span class="op" id="5886940">.</span><span class="ident" id="5886941">Header</span><span class="op" id="5886947">[</span><span class="string" id="5886948">&#34;X-Forwarded-For&#34;</span><span class="op" id="5886965">]</span><span class="op" id="5886966">;</span>&nbsp;<span class="ident" id="5886968">ok</span>&nbsp;<span class="op" id="5886971">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886976">clientIP</span>&nbsp;<span class="op" id="5886985">=</span>&nbsp;<span class="ident" id="5886987">strings</span><span class="op" id="5886994">.</span><span class="ident" id="5886995">Join</span><span class="op" id="5886999">(</span><span class="ident" id="5887000">prior</span><span class="op" id="5887005">,</span>&nbsp;<span class="string" id="5887007">&#34;,&nbsp;&#34;</span><span class="op" id="5887011">)</span>&nbsp;<span class="op" id="5887013">+</span>&nbsp;<span class="string" id="5887015">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="5887020">+</span>&nbsp;<span class="ident" id="5887022">clientIP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5887033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887037">outreq</span><span class="op" id="5887043">.</span><span class="ident" id="5887044">Header</span><span class="op" id="5887050">.</span><span class="ident" id="5887051">Set</span><span class="op" id="5887054">(</span><span class="string" id="5887055">&#34;X-Forwarded-For&#34;</span><span class="op" id="5887072">,</span>&nbsp;<span class="ident" id="5887074">clientIP</span><span class="op" id="5887082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5887085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887089">res</span><span class="op" id="5887092">,</span>&nbsp;<span class="ident" id="5887094">err</span>&nbsp;<span class="op" id="5887098">:=</span>&nbsp;<span class="ident" id="5887101">transport</span><span class="op" id="5887110">.</span><span class="ident" id="5887111">RoundTrip</span><span class="op" id="5887120">(</span><span class="ident" id="5887121">outreq</span><span class="op" id="5887127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5887130">if</span>&nbsp;<span class="ident" id="5887133">err</span>&nbsp;<span class="op" id="5887137">!=</span>&nbsp;<span class="ident" id="5887140">nil</span>&nbsp;<span class="op" id="5887144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887148">p</span><span class="op" id="5887149">.</span><span class="ident" id="5887150">logf</span><span class="op" id="5887154">(</span><span class="string" id="5887155">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="5887178">,</span>&nbsp;<span class="ident" id="5887180">err</span><span class="op" id="5887183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887187">rw</span><span class="op" id="5887189">.</span><span class="ident" id="5887190">WriteHeader</span><span class="op" id="5887201">(</span><span class="ident" id="5887202">http</span><span class="op" id="5887206">.</span><span class="ident" id="5887207">StatusInternalServerError</span><span class="op" id="5887232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5887236">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5887244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5887247">defer</span>&nbsp;<span class="ident" id="5887253">res</span><span class="op" id="5887256">.</span><span class="ident" id="5887257">Body</span><span class="op" id="5887261">.</span><span class="ident" id="5887262">Close</span><span class="op" id="5887267">(</span><span class="op" id="5887268">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5887272">for</span>&nbsp;<span class="ident" id="5887276">_</span><span class="op" id="5887277">,</span>&nbsp;<span class="ident" id="5887279">h</span>&nbsp;<span class="op" id="5887281">:=</span>&nbsp;<span class="keyword" id="5887284">range</span>&nbsp;<span class="ident" id="5887290">hopHeaders</span>&nbsp;<span class="op" id="5887301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887305">res</span><span class="op" id="5887308">.</span><span class="ident" id="5887309">Header</span><span class="op" id="5887315">.</span><span class="ident" id="5887316">Del</span><span class="op" id="5887319">(</span><span class="ident" id="5887320">h</span><span class="op" id="5887321">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5887324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887328">copyHeader</span><span class="op" id="5887338">(</span><span class="ident" id="5887339">rw</span><span class="op" id="5887341">.</span><span class="ident" id="5887342">Header</span><span class="op" id="5887348">(</span><span class="op" id="5887349">)</span><span class="op" id="5887350">,</span>&nbsp;<span class="ident" id="5887352">res</span><span class="op" id="5887355">.</span><span class="ident" id="5887356">Header</span><span class="op" id="5887362">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887366">rw</span><span class="op" id="5887368">.</span><span class="ident" id="5887369">WriteHeader</span><span class="op" id="5887380">(</span><span class="ident" id="5887381">res</span><span class="op" id="5887384">.</span><span class="ident" id="5887385">StatusCode</span><span class="op" id="5887395">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887398">p</span><span class="op" id="5887399">.</span><span class="ident" id="5887400">copyResponse</span><span class="op" id="5887412">(</span><span class="ident" id="5887413">rw</span><span class="op" id="5887415">,</span>&nbsp;<span class="ident" id="5887417">res</span><span class="op" id="5887420">.</span><span class="ident" id="5887421">Body</span><span class="op" id="5887425">)</span><br>
<span class="lineno"></span><span class="op" id="5887427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5887430">func</span>&nbsp;<span class="op" id="5887435">(</span><span class="ident" id="5887436">p</span>&nbsp;<span class="op" id="5887438">*</span><span class="ident" id="5887439">ReverseProxy</span><span class="op" id="5887451">)</span>&nbsp;<span class="ident" id="5887453">copyResponse</span><span class="op" id="5887465">(</span><span class="ident" id="5887466">dst</span>&nbsp;<span class="ident" id="5887470">io</span><span class="op" id="5887472">.</span><span class="ident" id="5887473">Writer</span><span class="op" id="5887479">,</span>&nbsp;<span class="ident" id="5887481">src</span>&nbsp;<span class="ident" id="5887485">io</span><span class="op" id="5887487">.</span><span class="ident" id="5887488">Reader</span><span class="op" id="5887494">)</span>&nbsp;<span class="op" id="5887496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5887499">if</span>&nbsp;<span class="ident" id="5887502">p</span><span class="op" id="5887503">.</span><span class="ident" id="5887504">FlushInterval</span>&nbsp;<span class="op" id="5887518">!=</span>&nbsp;<span class="num" id="5887521">0</span>&nbsp;<span class="op" id="5887523">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5887527">if</span>&nbsp;<span class="ident" id="5887530">wf</span><span class="op" id="5887532">,</span>&nbsp;<span class="ident" id="5887534">ok</span>&nbsp;<span class="op" id="5887537">:=</span>&nbsp;<span class="ident" id="5887540">dst</span><span class="op" id="5887543">.</span><span class="op" id="5887544">(</span><span class="ident" id="5887545">writeFlusher</span><span class="op" id="5887557">)</span><span class="op" id="5887558">;</span>&nbsp;<span class="ident" id="5887560">ok</span>&nbsp;<span class="op" id="5887563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887568">mlw</span>&nbsp;<span class="op" id="5887572">:=</span>&nbsp;<span class="op" id="5887575">&amp;</span><span class="ident" id="5887576">maxLatencyWriter</span><span class="op" id="5887592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887598">dst</span><span class="op" id="5887601">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5887607">wf</span><span class="op" id="5887609">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887615">latency</span><span class="op" id="5887622">:</span>&nbsp;<span class="ident" id="5887624">p</span><span class="op" id="5887625">.</span><span class="ident" id="5887626">FlushInterval</span><span class="op" id="5887639">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887645">done</span><span class="op" id="5887649">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5887654">make</span><span class="op" id="5887658">(</span><span class="keyword" id="5887659">chan</span>&nbsp;<span class="builtintype" id="5887664">bool</span><span class="op" id="5887668">)</span><span class="op" id="5887669">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5887674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5887679">go</span>&nbsp;<span class="ident" id="5887682">mlw</span><span class="op" id="5887685">.</span><span class="ident" id="5887686">flushLoop</span><span class="op" id="5887695">(</span><span class="op" id="5887696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5887701">defer</span>&nbsp;<span class="ident" id="5887707">mlw</span><span class="op" id="5887710">.</span><span class="ident" id="5887711">stop</span><span class="op" id="5887715">(</span><span class="op" id="5887716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887721">dst</span>&nbsp;<span class="op" id="5887725">=</span>&nbsp;<span class="ident" id="5887727">mlw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5887733">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5887736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887740">io</span><span class="op" id="5887742">.</span><span class="ident" id="5887743">Copy</span><span class="op" id="5887747">(</span><span class="ident" id="5887748">dst</span><span class="op" id="5887751">,</span>&nbsp;<span class="ident" id="5887753">src</span><span class="op" id="5887756">)</span><br>
<span class="lineno"></span><span class="op" id="5887758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="5887761">func</span>&nbsp;<span class="op" id="5887766">(</span><span class="ident" id="5887767">p</span>&nbsp;<span class="op" id="5887769">*</span><span class="ident" id="5887770">ReverseProxy</span><span class="op" id="5887782">)</span>&nbsp;<span class="ident" id="5887784">logf</span><span class="op" id="5887788">(</span><span class="ident" id="5887789">format</span>&nbsp;<span class="builtintype" id="5887796">string</span><span class="op" id="5887802">,</span>&nbsp;<span class="ident" id="5887804">args</span>&nbsp;<span class="op" id="5887809">...</span><span class="keyword" id="5887812">interface</span><span class="op" id="5887821">{</span><span class="op" id="5887822">}</span><span class="op" id="5887823">)</span>&nbsp;<span class="op" id="5887825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5887828">if</span>&nbsp;<span class="ident" id="5887831">p</span><span class="op" id="5887832">.</span><span class="ident" id="5887833">ErrorLog</span>&nbsp;<span class="op" id="5887842">!=</span>&nbsp;<span class="ident" id="5887845">nil</span>&nbsp;<span class="op" id="5887849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887853">p</span><span class="op" id="5887854">.</span><span class="ident" id="5887855">ErrorLog</span><span class="op" id="5887863">.</span><span class="ident" id="5887864">Printf</span><span class="op" id="5887870">(</span><span class="ident" id="5887871">format</span><span class="op" id="5887877">,</span>&nbsp;<span class="ident" id="5887879">args</span><span class="op" id="5887883">...</span><span class="op" id="5887886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5887889">}</span>&nbsp;<span class="keyword" id="5887891">else</span>&nbsp;<span class="op" id="5887896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887900">log</span><span class="op" id="5887903">.</span><span class="ident" id="5887904">Printf</span><span class="op" id="5887910">(</span><span class="ident" id="5887911">format</span><span class="op" id="5887917">,</span>&nbsp;<span class="ident" id="5887919">args</span><span class="op" id="5887923">...</span><span class="op" id="5887926">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5887929">}</span><br>
<span class="lineno"></span><span class="op" id="5887931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5887934">type</span>&nbsp;<span class="ident" id="5887939">writeFlusher</span>&nbsp;<span class="keyword" id="5887952">interface</span>&nbsp;<span class="op" id="5887962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887965">io</span><span class="op" id="5887967">.</span><span class="ident" id="5887968">Writer</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887976">http</span><span class="op" id="5887980">.</span><span class="ident" id="5887981">Flusher</span><br>
<span class="lineno"></span><span class="op" id="5887989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5887992">type</span>&nbsp;<span class="ident" id="5887997">maxLatencyWriter</span>&nbsp;<span class="keyword" id="5888014">struct</span>&nbsp;<span class="op" id="5888021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888024">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5888032">writeFlusher</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888046">latency</span>&nbsp;<span class="ident" id="5888054">time</span><span class="op" id="5888058">.</span><span class="ident" id="5888059">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888070">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5888075">sync</span><span class="op" id="5888079">.</span><span class="ident" id="5888080">Mutex</span>&nbsp;<span class="comment" id="5888086">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888113">done</span>&nbsp;<span class="keyword" id="5888118">chan</span>&nbsp;<span class="builtintype" id="5888123">bool</span><br>
<span class="lineno"></span><span class="op" id="5888128">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="5888131">func</span>&nbsp;<span class="op" id="5888136">(</span><span class="ident" id="5888137">m</span>&nbsp;<span class="op" id="5888139">*</span><span class="ident" id="5888140">maxLatencyWriter</span><span class="op" id="5888156">)</span>&nbsp;<span class="ident" id="5888158">Write</span><span class="op" id="5888163">(</span><span class="ident" id="5888164">p</span>&nbsp;<span class="op" id="5888166">[</span><span class="op" id="5888167">]</span><span class="builtintype" id="5888168">byte</span><span class="op" id="5888172">)</span>&nbsp;<span class="op" id="5888174">(</span><span class="builtintype" id="5888175">int</span><span class="op" id="5888178">,</span>&nbsp;<span class="builtintype" id="5888180">error</span><span class="op" id="5888185">)</span>&nbsp;<span class="op" id="5888187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888190">m</span><span class="op" id="5888191">.</span><span class="ident" id="5888192">lk</span><span class="op" id="5888194">.</span><span class="ident" id="5888195">Lock</span><span class="op" id="5888199">(</span><span class="op" id="5888200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888203">defer</span>&nbsp;<span class="ident" id="5888209">m</span><span class="op" id="5888210">.</span><span class="ident" id="5888211">lk</span><span class="op" id="5888213">.</span><span class="ident" id="5888214">Unlock</span><span class="op" id="5888220">(</span><span class="op" id="5888221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888224">return</span>&nbsp;<span class="ident" id="5888231">m</span><span class="op" id="5888232">.</span><span class="ident" id="5888233">dst</span><span class="op" id="5888236">.</span><span class="ident" id="5888237">Write</span><span class="op" id="5888242">(</span><span class="ident" id="5888243">p</span><span class="op" id="5888244">)</span><br>
<span class="lineno">205</span><span class="op" id="5888246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5888249">func</span>&nbsp;<span class="op" id="5888254">(</span><span class="ident" id="5888255">m</span>&nbsp;<span class="op" id="5888257">*</span><span class="ident" id="5888258">maxLatencyWriter</span><span class="op" id="5888274">)</span>&nbsp;<span class="ident" id="5888276">flushLoop</span><span class="op" id="5888285">(</span><span class="op" id="5888286">)</span>&nbsp;<span class="op" id="5888288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888291">t</span>&nbsp;<span class="op" id="5888293">:=</span>&nbsp;<span class="ident" id="5888296">time</span><span class="op" id="5888300">.</span><span class="ident" id="5888301">NewTicker</span><span class="op" id="5888310">(</span><span class="ident" id="5888311">m</span><span class="op" id="5888312">.</span><span class="ident" id="5888313">latency</span><span class="op" id="5888320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888323">defer</span>&nbsp;<span class="ident" id="5888329">t</span><span class="op" id="5888330">.</span><span class="ident" id="5888331">Stop</span><span class="op" id="5888335">(</span><span class="op" id="5888336">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888339">for</span>&nbsp;<span class="op" id="5888343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888347">select</span>&nbsp;<span class="op" id="5888354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888358">case</span>&nbsp;<span class="op" id="5888363">&lt;-</span><span class="ident" id="5888365">m</span><span class="op" id="5888366">.</span><span class="ident" id="5888367">done</span><span class="op" id="5888371">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888376">if</span>&nbsp;<span class="ident" id="5888379">onExitFlushLoop</span>&nbsp;<span class="op" id="5888395">!=</span>&nbsp;<span class="ident" id="5888398">nil</span>&nbsp;<span class="op" id="5888402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888408">onExitFlushLoop</span><span class="op" id="5888423">(</span><span class="op" id="5888424">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5888429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888434">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888443">case</span>&nbsp;<span class="op" id="5888448">&lt;-</span><span class="ident" id="5888450">t</span><span class="op" id="5888451">.</span><span class="ident" id="5888452">C</span><span class="op" id="5888453">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888458">m</span><span class="op" id="5888459">.</span><span class="ident" id="5888460">lk</span><span class="op" id="5888462">.</span><span class="ident" id="5888463">Lock</span><span class="op" id="5888467">(</span><span class="op" id="5888468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888473">m</span><span class="op" id="5888474">.</span><span class="ident" id="5888475">dst</span><span class="op" id="5888478">.</span><span class="ident" id="5888479">Flush</span><span class="op" id="5888484">(</span><span class="op" id="5888485">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888490">m</span><span class="op" id="5888491">.</span><span class="ident" id="5888492">lk</span><span class="op" id="5888494">.</span><span class="ident" id="5888495">Unlock</span><span class="op" id="5888501">(</span><span class="op" id="5888502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5888506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5888509">}</span><br>
<span class="lineno"></span><span class="op" id="5888511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="5888514">func</span>&nbsp;<span class="op" id="5888519">(</span><span class="ident" id="5888520">m</span>&nbsp;<span class="op" id="5888522">*</span><span class="ident" id="5888523">maxLatencyWriter</span><span class="op" id="5888539">)</span>&nbsp;<span class="ident" id="5888541">stop</span><span class="op" id="5888545">(</span><span class="op" id="5888546">)</span>&nbsp;<span class="op" id="5888548">{</span>&nbsp;<span class="ident" id="5888550">m</span><span class="op" id="5888551">.</span><span class="ident" id="5888552">done</span>&nbsp;<span class="op" id="5888557">&lt;-</span>&nbsp;<span class="builtintype" id="5888560">true</span>&nbsp;<span class="op" id="5888565">}</span>
</div>
</body>
</html>
