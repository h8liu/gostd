<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html" class="current">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3445066">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3445121">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3445175">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3445226">//&nbsp;HTTP&nbsp;file&nbsp;system&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3445263">package</span>&nbsp;<span class="ident" id="3445271">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3445277">import</span>&nbsp;<span class="op" id="3445284">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3445287">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3445297">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3445304">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3445310">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3445318">&#34;mime/multipart&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3445336">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3445353">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3445364">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3445370">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3445378">&#34;path/filepath&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3445395">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3445406">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3445417">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3445424">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3445427">//&nbsp;A&nbsp;Dir&nbsp;implements&nbsp;FileSystem&nbsp;using&nbsp;the&nbsp;native&nbsp;file&nbsp;system&nbsp;restricted&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3445503">//&nbsp;specific&nbsp;directory&nbsp;tree.</span><br>
<span class="lineno"></span><span class="comment" id="3445531">//</span><br>
<span class="lineno"></span><span class="comment" id="3445534">//&nbsp;While&nbsp;the&nbsp;FileSystem.Open&nbsp;method&nbsp;takes&nbsp;&#39;/&#39;-separated&nbsp;paths,&nbsp;a&nbsp;Dir&#39;s&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3445612">//&nbsp;value&nbsp;is&nbsp;a&nbsp;filename&nbsp;on&nbsp;the&nbsp;native&nbsp;file&nbsp;system,&nbsp;not&nbsp;a&nbsp;URL,&nbsp;so&nbsp;it&nbsp;is&nbsp;separated</span><br>
<span class="lineno">30</span><span class="comment" id="3445692">//&nbsp;by&nbsp;filepath.Separator,&nbsp;which&nbsp;isn&#39;t&nbsp;necessarily&nbsp;&#39;/&#39;.</span><br>
<span class="lineno"></span><span class="comment" id="3445747">//</span><br>
<span class="lineno"></span><span class="comment" id="3445750">//&nbsp;An&nbsp;empty&nbsp;Dir&nbsp;is&nbsp;treated&nbsp;as&nbsp;&#34;.&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3445785">type</span>&nbsp;<span class="ident" id="3445790">Dir</span>&nbsp;<span class="builtintype" id="3445794">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="3445802">func</span>&nbsp;<span class="op" id="3445807">(</span><span class="ident" id="3445808">d</span>&nbsp;<span class="ident" id="3445810">Dir</span><span class="op" id="3445813">)</span>&nbsp;<span class="ident" id="3445815">Open</span><span class="op" id="3445819">(</span><span class="ident" id="3445820">name</span>&nbsp;<span class="builtintype" id="3445825">string</span><span class="op" id="3445831">)</span>&nbsp;<span class="op" id="3445833">(</span><span class="ident" id="3445834">File</span><span class="op" id="3445838">,</span>&nbsp;<span class="builtintype" id="3445840">error</span><span class="op" id="3445845">)</span>&nbsp;<span class="op" id="3445847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3445850">if</span>&nbsp;<span class="ident" id="3445853">filepath</span><span class="op" id="3445861">.</span><span class="ident" id="3445862">Separator</span>&nbsp;<span class="op" id="3445872">!=</span>&nbsp;<span class="string" id="3445875">&#39;/&#39;</span>&nbsp;<span class="op" id="3445879">&amp;&amp;</span>&nbsp;<span class="ident" id="3445882">strings</span><span class="op" id="3445889">.</span><span class="ident" id="3445890">IndexRune</span><span class="op" id="3445899">(</span><span class="ident" id="3445900">name</span><span class="op" id="3445904">,</span>&nbsp;<span class="ident" id="3445906">filepath</span><span class="op" id="3445914">.</span><span class="ident" id="3445915">Separator</span><span class="op" id="3445924">)</span>&nbsp;<span class="op" id="3445926">&gt;=</span>&nbsp;<span class="num" id="3445929">0</span>&nbsp;<span class="op" id="3445931">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3445936">strings</span><span class="op" id="3445943">.</span><span class="ident" id="3445944">Contains</span><span class="op" id="3445952">(</span><span class="ident" id="3445953">name</span><span class="op" id="3445957">,</span>&nbsp;<span class="string" id="3445959">&#34;\x00&#34;</span><span class="op" id="3445965">)</span>&nbsp;<span class="op" id="3445967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3445971">return</span>&nbsp;<span class="ident" id="3445978">nil</span><span class="op" id="3445981">,</span>&nbsp;<span class="ident" id="3445983">errors</span><span class="op" id="3445989">.</span><span class="ident" id="3445990">New</span><span class="op" id="3445993">(</span><span class="string" id="3445994">&#34;http:&nbsp;invalid&nbsp;character&nbsp;in&nbsp;file&nbsp;path&#34;</span><span class="op" id="3446032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3446035">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3446038">dir</span>&nbsp;<span class="op" id="3446042">:=</span>&nbsp;<span class="builtintype" id="3446045">string</span><span class="op" id="3446051">(</span><span class="ident" id="3446052">d</span><span class="op" id="3446053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3446056">if</span>&nbsp;<span class="ident" id="3446059">dir</span>&nbsp;<span class="op" id="3446063">==</span>&nbsp;<span class="string" id="3446066">&#34;&#34;</span>&nbsp;<span class="op" id="3446069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3446073">dir</span>&nbsp;<span class="op" id="3446077">=</span>&nbsp;<span class="string" id="3446079">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3446084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3446087">f</span><span class="op" id="3446088">,</span>&nbsp;<span class="ident" id="3446090">err</span>&nbsp;<span class="op" id="3446094">:=</span>&nbsp;<span class="ident" id="3446097">os</span><span class="op" id="3446099">.</span><span class="ident" id="3446100">Open</span><span class="op" id="3446104">(</span><span class="ident" id="3446105">filepath</span><span class="op" id="3446113">.</span><span class="ident" id="3446114">Join</span><span class="op" id="3446118">(</span><span class="ident" id="3446119">dir</span><span class="op" id="3446122">,</span>&nbsp;<span class="ident" id="3446124">filepath</span><span class="op" id="3446132">.</span><span class="ident" id="3446133">FromSlash</span><span class="op" id="3446142">(</span><span class="ident" id="3446143">path</span><span class="op" id="3446147">.</span><span class="ident" id="3446148">Clean</span><span class="op" id="3446153">(</span><span class="string" id="3446154">&#34;/&#34;</span><span class="op" id="3446157">+</span><span class="ident" id="3446158">name</span><span class="op" id="3446162">)</span><span class="op" id="3446163">)</span><span class="op" id="3446164">)</span><span class="op" id="3446165">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3446168">if</span>&nbsp;<span class="ident" id="3446171">err</span>&nbsp;<span class="op" id="3446175">!=</span>&nbsp;<span class="ident" id="3446178">nil</span>&nbsp;<span class="op" id="3446182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3446186">return</span>&nbsp;<span class="ident" id="3446193">nil</span><span class="op" id="3446196">,</span>&nbsp;<span class="ident" id="3446198">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3446203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3446206">return</span>&nbsp;<span class="ident" id="3446213">f</span><span class="op" id="3446214">,</span>&nbsp;<span class="ident" id="3446216">nil</span><br>
<span class="lineno"></span><span class="op" id="3446220">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="3446223">//&nbsp;A&nbsp;FileSystem&nbsp;implements&nbsp;access&nbsp;to&nbsp;a&nbsp;collection&nbsp;of&nbsp;named&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="3446289">//&nbsp;The&nbsp;elements&nbsp;in&nbsp;a&nbsp;file&nbsp;path&nbsp;are&nbsp;separated&nbsp;by&nbsp;slash&nbsp;(&#39;/&#39;,&nbsp;U+002F)</span><br>
<span class="lineno"></span><span class="comment" id="3446357">//&nbsp;characters,&nbsp;regardless&nbsp;of&nbsp;host&nbsp;operating&nbsp;system&nbsp;convention.</span><br>
<span class="lineno"></span><span class="keyword" id="3446420">type</span>&nbsp;<span class="ident" id="3446425">FileSystem</span>&nbsp;<span class="keyword" id="3446436">interface</span>&nbsp;<span class="op" id="3446446">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3446449">Open</span><span class="op" id="3446453">(</span><span class="ident" id="3446454">name</span>&nbsp;<span class="builtintype" id="3446459">string</span><span class="op" id="3446465">)</span>&nbsp;<span class="op" id="3446467">(</span><span class="ident" id="3446468">File</span><span class="op" id="3446472">,</span>&nbsp;<span class="builtintype" id="3446474">error</span><span class="op" id="3446479">)</span><br>
<span class="lineno"></span><span class="op" id="3446481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3446484">//&nbsp;A&nbsp;File&nbsp;is&nbsp;returned&nbsp;by&nbsp;a&nbsp;FileSystem&#39;s&nbsp;Open&nbsp;method&nbsp;and&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3446547">//&nbsp;served&nbsp;by&nbsp;the&nbsp;FileServer&nbsp;implementation.</span><br>
<span class="lineno">60</span><span class="comment" id="3446591">//</span><br>
<span class="lineno"></span><span class="comment" id="3446594">//&nbsp;The&nbsp;methods&nbsp;should&nbsp;behave&nbsp;the&nbsp;same&nbsp;as&nbsp;those&nbsp;on&nbsp;an&nbsp;*os.File.</span><br>
<span class="lineno"></span><span class="keyword" id="3446657">type</span>&nbsp;<span class="ident" id="3446662">File</span>&nbsp;<span class="keyword" id="3446667">interface</span>&nbsp;<span class="op" id="3446677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3446680">io</span><span class="op" id="3446682">.</span><span class="ident" id="3446683">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3446691">io</span><span class="op" id="3446693">.</span><span class="ident" id="3446694">Reader</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3446702">Readdir</span><span class="op" id="3446709">(</span><span class="ident" id="3446710">count</span>&nbsp;<span class="builtintype" id="3446716">int</span><span class="op" id="3446719">)</span>&nbsp;<span class="op" id="3446721">(</span><span class="op" id="3446722">[</span><span class="op" id="3446723">]</span><span class="ident" id="3446724">os</span><span class="op" id="3446726">.</span><span class="ident" id="3446727">FileInfo</span><span class="op" id="3446735">,</span>&nbsp;<span class="builtintype" id="3446737">error</span><span class="op" id="3446742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3446745">Seek</span><span class="op" id="3446749">(</span><span class="ident" id="3446750">offset</span>&nbsp;<span class="ident" id="3446757">int64</span><span class="op" id="3446762">,</span>&nbsp;<span class="ident" id="3446764">whence</span>&nbsp;<span class="builtintype" id="3446771">int</span><span class="op" id="3446774">)</span>&nbsp;<span class="op" id="3446776">(</span><span class="ident" id="3446777">int64</span><span class="op" id="3446782">,</span>&nbsp;<span class="builtintype" id="3446784">error</span><span class="op" id="3446789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3446792">Stat</span><span class="op" id="3446796">(</span><span class="op" id="3446797">)</span>&nbsp;<span class="op" id="3446799">(</span><span class="ident" id="3446800">os</span><span class="op" id="3446802">.</span><span class="ident" id="3446803">FileInfo</span><span class="op" id="3446811">,</span>&nbsp;<span class="builtintype" id="3446813">error</span><span class="op" id="3446818">)</span><br>
<span class="lineno"></span><span class="op" id="3446820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3446823">func</span>&nbsp;<span class="ident" id="3446828">dirList</span><span class="op" id="3446835">(</span><span class="ident" id="3446836">w</span>&nbsp;<span class="ident" id="3446838">ResponseWriter</span><span class="op" id="3446852">,</span>&nbsp;<span class="ident" id="3446854">f</span>&nbsp;<span class="ident" id="3446856">File</span><span class="op" id="3446860">)</span>&nbsp;<span class="op" id="3446862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3446865">w</span><span class="op" id="3446866">.</span><span class="ident" id="3446867">Header</span><span class="op" id="3446873">(</span><span class="op" id="3446874">)</span><span class="op" id="3446875">.</span><span class="ident" id="3446876">Set</span><span class="op" id="3446879">(</span><span class="string" id="3446880">&#34;Content-Type&#34;</span><span class="op" id="3446894">,</span>&nbsp;<span class="string" id="3446896">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="3446922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3446925">fmt</span><span class="op" id="3446928">.</span><span class="ident" id="3446929">Fprintf</span><span class="op" id="3446936">(</span><span class="ident" id="3446937">w</span><span class="op" id="3446938">,</span>&nbsp;<span class="string" id="3446940">&#34;&lt;pre&gt;\n&#34;</span><span class="op" id="3446949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3446952">for</span>&nbsp;<span class="op" id="3446956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3446960">dirs</span><span class="op" id="3446964">,</span>&nbsp;<span class="ident" id="3446966">err</span>&nbsp;<span class="op" id="3446970">:=</span>&nbsp;<span class="ident" id="3446973">f</span><span class="op" id="3446974">.</span><span class="ident" id="3446975">Readdir</span><span class="op" id="3446982">(</span><span class="num" id="3446983">100</span><span class="op" id="3446986">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3446990">if</span>&nbsp;<span class="ident" id="3446993">err</span>&nbsp;<span class="op" id="3446997">!=</span>&nbsp;<span class="ident" id="3447000">nil</span>&nbsp;<span class="op" id="3447004">||</span>&nbsp;<span class="builtinfunc" id="3447007">len</span><span class="op" id="3447010">(</span><span class="ident" id="3447011">dirs</span><span class="op" id="3447015">)</span>&nbsp;<span class="op" id="3447017">==</span>&nbsp;<span class="num" id="3447020">0</span>&nbsp;<span class="op" id="3447022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3447027">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3447035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3447039">for</span>&nbsp;<span class="ident" id="3447043">_</span><span class="op" id="3447044">,</span>&nbsp;<span class="ident" id="3447046">d</span>&nbsp;<span class="op" id="3447048">:=</span>&nbsp;<span class="keyword" id="3447051">range</span>&nbsp;<span class="ident" id="3447057">dirs</span>&nbsp;<span class="op" id="3447062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3447067">name</span>&nbsp;<span class="op" id="3447072">:=</span>&nbsp;<span class="ident" id="3447075">d</span><span class="op" id="3447076">.</span><span class="ident" id="3447077">Name</span><span class="op" id="3447081">(</span><span class="op" id="3447082">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3447087">if</span>&nbsp;<span class="ident" id="3447090">d</span><span class="op" id="3447091">.</span><span class="ident" id="3447092">IsDir</span><span class="op" id="3447097">(</span><span class="op" id="3447098">)</span>&nbsp;<span class="op" id="3447100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3447106">name</span>&nbsp;<span class="op" id="3447111">+=</span>&nbsp;<span class="string" id="3447114">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3447121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3447126">//&nbsp;name&nbsp;may&nbsp;contain&nbsp;&#39;?&#39;&nbsp;or&nbsp;&#39;#&#39;,&nbsp;which&nbsp;must&nbsp;be&nbsp;escaped&nbsp;to&nbsp;remain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3447193">//&nbsp;part&nbsp;of&nbsp;the&nbsp;URL&nbsp;path,&nbsp;and&nbsp;not&nbsp;indicate&nbsp;the&nbsp;start&nbsp;of&nbsp;a&nbsp;query</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3447259">//&nbsp;string&nbsp;or&nbsp;fragment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3447285">url</span>&nbsp;<span class="op" id="3447289">:=</span>&nbsp;<span class="ident" id="3447292">url</span><span class="op" id="3447295">.</span><span class="ident" id="3447296">URL</span><span class="op" id="3447299">{</span><span class="ident" id="3447300">Path</span><span class="op" id="3447304">:</span>&nbsp;<span class="ident" id="3447306">name</span><span class="op" id="3447310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3447315">fmt</span><span class="op" id="3447318">.</span><span class="ident" id="3447319">Fprintf</span><span class="op" id="3447326">(</span><span class="ident" id="3447327">w</span><span class="op" id="3447328">,</span>&nbsp;<span class="string" id="3447330">&#34;&lt;a&nbsp;href=\&#34;%s\&#34;&gt;%s&lt;/a&gt;\n&#34;</span><span class="op" id="3447355">,</span>&nbsp;<span class="ident" id="3447357">url</span><span class="op" id="3447360">.</span><span class="ident" id="3447361">String</span><span class="op" id="3447367">(</span><span class="op" id="3447368">)</span><span class="op" id="3447369">,</span>&nbsp;<span class="ident" id="3447371">htmlReplacer</span><span class="op" id="3447383">.</span><span class="ident" id="3447384">Replace</span><span class="op" id="3447391">(</span><span class="ident" id="3447392">name</span><span class="op" id="3447396">)</span><span class="op" id="3447397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3447401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3447404">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3447407">fmt</span><span class="op" id="3447410">.</span><span class="ident" id="3447411">Fprintf</span><span class="op" id="3447418">(</span><span class="ident" id="3447419">w</span><span class="op" id="3447420">,</span>&nbsp;<span class="string" id="3447422">&#34;&lt;/pre&gt;\n&#34;</span><span class="op" id="3447432">)</span><br>
<span class="lineno"></span><span class="op" id="3447434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3447437">//&nbsp;ServeContent&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;using&nbsp;the&nbsp;content&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3447501">//&nbsp;provided&nbsp;ReadSeeker.&nbsp;&nbsp;The&nbsp;main&nbsp;benefit&nbsp;of&nbsp;ServeContent&nbsp;over&nbsp;io.Copy</span><br>
<span class="lineno">95</span><span class="comment" id="3447572">//&nbsp;is&nbsp;that&nbsp;it&nbsp;handles&nbsp;Range&nbsp;requests&nbsp;properly,&nbsp;sets&nbsp;the&nbsp;MIME&nbsp;type,&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3447643">//&nbsp;handles&nbsp;If-Modified-Since&nbsp;requests.</span><br>
<span class="lineno"></span><span class="comment" id="3447682">//</span><br>
<span class="lineno"></span><span class="comment" id="3447685">//&nbsp;If&nbsp;the&nbsp;response&#39;s&nbsp;Content-Type&nbsp;header&nbsp;is&nbsp;not&nbsp;set,&nbsp;ServeContent</span><br>
<span class="lineno"></span><span class="comment" id="3447751">//&nbsp;first&nbsp;tries&nbsp;to&nbsp;deduce&nbsp;the&nbsp;type&nbsp;from&nbsp;name&#39;s&nbsp;file&nbsp;extension&nbsp;and,</span><br>
<span class="lineno">100</span><span class="comment" id="3447817">//&nbsp;if&nbsp;that&nbsp;fails,&nbsp;falls&nbsp;back&nbsp;to&nbsp;reading&nbsp;the&nbsp;first&nbsp;block&nbsp;of&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="3447888">//&nbsp;and&nbsp;passing&nbsp;it&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span><span class="comment" id="3447928">//&nbsp;The&nbsp;name&nbsp;is&nbsp;otherwise&nbsp;unused;&nbsp;in&nbsp;particular&nbsp;it&nbsp;can&nbsp;be&nbsp;empty&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3447998">//&nbsp;never&nbsp;sent&nbsp;in&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3448029">//</span><br>
<span class="lineno">105</span><span class="comment" id="3448032">//&nbsp;If&nbsp;modtime&nbsp;is&nbsp;not&nbsp;the&nbsp;zero&nbsp;time,&nbsp;ServeContent&nbsp;includes&nbsp;it&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3448098">//&nbsp;Last-Modified&nbsp;header&nbsp;in&nbsp;the&nbsp;response.&nbsp;&nbsp;If&nbsp;the&nbsp;request&nbsp;includes&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3448167">//&nbsp;If-Modified-Since&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;modtime&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span><span class="comment" id="3448232">//&nbsp;whether&nbsp;the&nbsp;content&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span><span class="comment" id="3448280">//</span><br>
<span class="lineno">110</span><span class="comment" id="3448283">//&nbsp;The&nbsp;content&#39;s&nbsp;Seek&nbsp;method&nbsp;must&nbsp;work:&nbsp;ServeContent&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="3448341">//&nbsp;a&nbsp;seek&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;content&nbsp;to&nbsp;determine&nbsp;its&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="3448400">//</span><br>
<span class="lineno"></span><span class="comment" id="3448403">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;has&nbsp;set&nbsp;w&#39;s&nbsp;ETag&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3448469">//&nbsp;handle&nbsp;requests&nbsp;using&nbsp;If-Range&nbsp;and&nbsp;If-None-Match.</span><br>
<span class="lineno">115</span><span class="comment" id="3448522">//</span><br>
<span class="lineno"></span><span class="comment" id="3448525">//&nbsp;Note&nbsp;that&nbsp;*os.File&nbsp;implements&nbsp;the&nbsp;io.ReadSeeker&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3448587">func</span>&nbsp;<span class="ident" id="3448592">ServeContent</span><span class="op" id="3448604">(</span><span class="ident" id="3448605">w</span>&nbsp;<span class="ident" id="3448607">ResponseWriter</span><span class="op" id="3448621">,</span>&nbsp;<span class="ident" id="3448623">req</span>&nbsp;<span class="op" id="3448627">*</span><span class="ident" id="3448628">Request</span><span class="op" id="3448635">,</span>&nbsp;<span class="ident" id="3448637">name</span>&nbsp;<span class="builtintype" id="3448642">string</span><span class="op" id="3448648">,</span>&nbsp;<span class="ident" id="3448650">modtime</span>&nbsp;<span class="ident" id="3448658">time</span><span class="op" id="3448662">.</span><span class="ident" id="3448663">Time</span><span class="op" id="3448667">,</span>&nbsp;<span class="ident" id="3448669">content</span>&nbsp;<span class="ident" id="3448677">io</span><span class="op" id="3448679">.</span><span class="ident" id="3448680">ReadSeeker</span><span class="op" id="3448690">)</span>&nbsp;<span class="op" id="3448692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3448695">sizeFunc</span>&nbsp;<span class="op" id="3448704">:=</span>&nbsp;<span class="keyword" id="3448707">func</span><span class="op" id="3448711">(</span><span class="op" id="3448712">)</span>&nbsp;<span class="op" id="3448714">(</span><span class="ident" id="3448715">int64</span><span class="op" id="3448720">,</span>&nbsp;<span class="builtintype" id="3448722">error</span><span class="op" id="3448727">)</span>&nbsp;<span class="op" id="3448729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3448733">size</span><span class="op" id="3448737">,</span>&nbsp;<span class="ident" id="3448739">err</span>&nbsp;<span class="op" id="3448743">:=</span>&nbsp;<span class="ident" id="3448746">content</span><span class="op" id="3448753">.</span><span class="ident" id="3448754">Seek</span><span class="op" id="3448758">(</span><span class="num" id="3448759">0</span><span class="op" id="3448760">,</span>&nbsp;<span class="ident" id="3448762">os</span><span class="op" id="3448764">.</span><span class="ident" id="3448765">SEEK_END</span><span class="op" id="3448773">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3448777">if</span>&nbsp;<span class="ident" id="3448780">err</span>&nbsp;<span class="op" id="3448784">!=</span>&nbsp;<span class="ident" id="3448787">nil</span>&nbsp;<span class="op" id="3448791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3448796">return</span>&nbsp;<span class="num" id="3448803">0</span><span class="op" id="3448804">,</span>&nbsp;<span class="ident" id="3448806">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3448818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3448822">_</span><span class="op" id="3448823">,</span>&nbsp;<span class="ident" id="3448825">err</span>&nbsp;<span class="op" id="3448829">=</span>&nbsp;<span class="ident" id="3448831">content</span><span class="op" id="3448838">.</span><span class="ident" id="3448839">Seek</span><span class="op" id="3448843">(</span><span class="num" id="3448844">0</span><span class="op" id="3448845">,</span>&nbsp;<span class="ident" id="3448847">os</span><span class="op" id="3448849">.</span><span class="ident" id="3448850">SEEK_SET</span><span class="op" id="3448858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3448862">if</span>&nbsp;<span class="ident" id="3448865">err</span>&nbsp;<span class="op" id="3448869">!=</span>&nbsp;<span class="ident" id="3448872">nil</span>&nbsp;<span class="op" id="3448876">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3448881">return</span>&nbsp;<span class="num" id="3448888">0</span><span class="op" id="3448889">,</span>&nbsp;<span class="ident" id="3448891">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3448903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3448907">return</span>&nbsp;<span class="ident" id="3448914">size</span><span class="op" id="3448918">,</span>&nbsp;<span class="ident" id="3448920">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3448925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3448928">serveContent</span><span class="op" id="3448940">(</span><span class="ident" id="3448941">w</span><span class="op" id="3448942">,</span>&nbsp;<span class="ident" id="3448944">req</span><span class="op" id="3448947">,</span>&nbsp;<span class="ident" id="3448949">name</span><span class="op" id="3448953">,</span>&nbsp;<span class="ident" id="3448955">modtime</span><span class="op" id="3448962">,</span>&nbsp;<span class="ident" id="3448964">sizeFunc</span><span class="op" id="3448972">,</span>&nbsp;<span class="ident" id="3448974">content</span><span class="op" id="3448981">)</span><br>
<span class="lineno">130</span><span class="op" id="3448983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3448986">//&nbsp;errSeeker&nbsp;is&nbsp;returned&nbsp;by&nbsp;ServeContent&#39;s&nbsp;sizeFunc&nbsp;when&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="3449055">//&nbsp;doesn&#39;t&nbsp;seek&nbsp;properly.&nbsp;The&nbsp;underlying&nbsp;Seeker&#39;s&nbsp;error&nbsp;text&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3449122">//&nbsp;included&nbsp;in&nbsp;the&nbsp;sizeFunc&nbsp;reply&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;sent&nbsp;over&nbsp;HTTP&nbsp;to&nbsp;end</span><br>
<span class="lineno">135</span><span class="comment" id="3449190">//&nbsp;users.</span><br>
<span class="lineno"></span><span class="keyword" id="3449200">var</span>&nbsp;<span class="ident" id="3449204">errSeeker</span>&nbsp;<span class="op" id="3449214">=</span>&nbsp;<span class="ident" id="3449216">errors</span><span class="op" id="3449222">.</span><span class="ident" id="3449223">New</span><span class="op" id="3449226">(</span><span class="string" id="3449227">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="3449246">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3449249">//&nbsp;if&nbsp;name&nbsp;is&nbsp;empty,&nbsp;filename&nbsp;is&nbsp;unknown.&nbsp;(used&nbsp;for&nbsp;mime&nbsp;type,&nbsp;before&nbsp;sniffing)</span><br>
<span class="lineno"></span><span class="comment" id="3449329">//&nbsp;if&nbsp;modtime.IsZero(),&nbsp;modtime&nbsp;is&nbsp;unknown.</span><br>
<span class="lineno">140</span><span class="comment" id="3449373">//&nbsp;content&nbsp;must&nbsp;be&nbsp;seeked&nbsp;to&nbsp;the&nbsp;beginning&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="3449429">//&nbsp;The&nbsp;sizeFunc&nbsp;is&nbsp;called&nbsp;at&nbsp;most&nbsp;once.&nbsp;Its&nbsp;error,&nbsp;if&nbsp;any,&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3449518">func</span>&nbsp;<span class="ident" id="3449523">serveContent</span><span class="op" id="3449535">(</span><span class="ident" id="3449536">w</span>&nbsp;<span class="ident" id="3449538">ResponseWriter</span><span class="op" id="3449552">,</span>&nbsp;<span class="ident" id="3449554">r</span>&nbsp;<span class="op" id="3449556">*</span><span class="ident" id="3449557">Request</span><span class="op" id="3449564">,</span>&nbsp;<span class="ident" id="3449566">name</span>&nbsp;<span class="builtintype" id="3449571">string</span><span class="op" id="3449577">,</span>&nbsp;<span class="ident" id="3449579">modtime</span>&nbsp;<span class="ident" id="3449587">time</span><span class="op" id="3449591">.</span><span class="ident" id="3449592">Time</span><span class="op" id="3449596">,</span>&nbsp;<span class="ident" id="3449598">sizeFunc</span>&nbsp;<span class="keyword" id="3449607">func</span><span class="op" id="3449611">(</span><span class="op" id="3449612">)</span>&nbsp;<span class="op" id="3449614">(</span><span class="ident" id="3449615">int64</span><span class="op" id="3449620">,</span>&nbsp;<span class="builtintype" id="3449622">error</span><span class="op" id="3449627">)</span><span class="op" id="3449628">,</span>&nbsp;<span class="ident" id="3449630">content</span>&nbsp;<span class="ident" id="3449638">io</span><span class="op" id="3449640">.</span><span class="ident" id="3449641">ReadSeeker</span><span class="op" id="3449651">)</span>&nbsp;<span class="op" id="3449653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3449656">if</span>&nbsp;<span class="ident" id="3449659">checkLastModified</span><span class="op" id="3449676">(</span><span class="ident" id="3449677">w</span><span class="op" id="3449678">,</span>&nbsp;<span class="ident" id="3449680">r</span><span class="op" id="3449681">,</span>&nbsp;<span class="ident" id="3449683">modtime</span><span class="op" id="3449690">)</span>&nbsp;<span class="op" id="3449692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3449696">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3449704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3449707">rangeReq</span><span class="op" id="3449715">,</span>&nbsp;<span class="ident" id="3449717">done</span>&nbsp;<span class="op" id="3449722">:=</span>&nbsp;<span class="ident" id="3449725">checkETag</span><span class="op" id="3449734">(</span><span class="ident" id="3449735">w</span><span class="op" id="3449736">,</span>&nbsp;<span class="ident" id="3449738">r</span><span class="op" id="3449739">,</span>&nbsp;<span class="ident" id="3449741">modtime</span><span class="op" id="3449748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3449751">if</span>&nbsp;<span class="ident" id="3449754">done</span>&nbsp;<span class="op" id="3449759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3449763">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3449771">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3449775">code</span>&nbsp;<span class="op" id="3449780">:=</span>&nbsp;<span class="ident" id="3449783">StatusOK</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3449794">//&nbsp;If&nbsp;Content-Type&nbsp;isn&#39;t&nbsp;set,&nbsp;use&nbsp;the&nbsp;file&#39;s&nbsp;extension&nbsp;to&nbsp;find&nbsp;it,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3449866">//&nbsp;if&nbsp;the&nbsp;Content-Type&nbsp;is&nbsp;unset&nbsp;explicitly,&nbsp;do&nbsp;not&nbsp;sniff&nbsp;the&nbsp;type.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3449934">ctypes</span><span class="op" id="3449940">,</span>&nbsp;<span class="ident" id="3449942">haveType</span>&nbsp;<span class="op" id="3449951">:=</span>&nbsp;<span class="ident" id="3449954">w</span><span class="op" id="3449955">.</span><span class="ident" id="3449956">Header</span><span class="op" id="3449962">(</span><span class="op" id="3449963">)</span><span class="op" id="3449964">[</span><span class="string" id="3449965">&#34;Content-Type&#34;</span><span class="op" id="3449979">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3449982">var</span>&nbsp;<span class="ident" id="3449986">ctype</span>&nbsp;<span class="builtintype" id="3449992">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3450000">if</span>&nbsp;<span class="op" id="3450003">!</span><span class="ident" id="3450004">haveType</span>&nbsp;<span class="op" id="3450013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3450017">ctype</span>&nbsp;<span class="op" id="3450023">=</span>&nbsp;<span class="ident" id="3450025">mime</span><span class="op" id="3450029">.</span><span class="ident" id="3450030">TypeByExtension</span><span class="op" id="3450045">(</span><span class="ident" id="3450046">filepath</span><span class="op" id="3450054">.</span><span class="ident" id="3450055">Ext</span><span class="op" id="3450058">(</span><span class="ident" id="3450059">name</span><span class="op" id="3450063">)</span><span class="op" id="3450064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3450068">if</span>&nbsp;<span class="ident" id="3450071">ctype</span>&nbsp;<span class="op" id="3450077">==</span>&nbsp;<span class="string" id="3450080">&#34;&#34;</span>&nbsp;<span class="op" id="3450083">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3450088">//&nbsp;read&nbsp;a&nbsp;chunk&nbsp;to&nbsp;decide&nbsp;between&nbsp;utf-8&nbsp;text&nbsp;and&nbsp;binary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3450147">var</span>&nbsp;<span class="ident" id="3450151">buf</span>&nbsp;<span class="op" id="3450155">[</span><span class="ident" id="3450156">sniffLen</span><span class="op" id="3450164">]</span><span class="builtintype" id="3450165">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3450173">n</span><span class="op" id="3450174">,</span>&nbsp;<span class="ident" id="3450176">_</span>&nbsp;<span class="op" id="3450178">:=</span>&nbsp;<span class="ident" id="3450181">io</span><span class="op" id="3450183">.</span><span class="ident" id="3450184">ReadFull</span><span class="op" id="3450192">(</span><span class="ident" id="3450193">content</span><span class="op" id="3450200">,</span>&nbsp;<span class="ident" id="3450202">buf</span><span class="op" id="3450205">[</span><span class="op" id="3450206">:</span><span class="op" id="3450207">]</span><span class="op" id="3450208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3450213">ctype</span>&nbsp;<span class="op" id="3450219">=</span>&nbsp;<span class="ident" id="3450221">DetectContentType</span><span class="op" id="3450238">(</span><span class="ident" id="3450239">buf</span><span class="op" id="3450242">[</span><span class="op" id="3450243">:</span><span class="ident" id="3450244">n</span><span class="op" id="3450245">]</span><span class="op" id="3450246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3450251">_</span><span class="op" id="3450252">,</span>&nbsp;<span class="ident" id="3450254">err</span>&nbsp;<span class="op" id="3450258">:=</span>&nbsp;<span class="ident" id="3450261">content</span><span class="op" id="3450268">.</span><span class="ident" id="3450269">Seek</span><span class="op" id="3450273">(</span><span class="num" id="3450274">0</span><span class="op" id="3450275">,</span>&nbsp;<span class="ident" id="3450277">os</span><span class="op" id="3450279">.</span><span class="ident" id="3450280">SEEK_SET</span><span class="op" id="3450288">)</span>&nbsp;<span class="comment" id="3450290">//&nbsp;rewind&nbsp;to&nbsp;output&nbsp;whole&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3450324">if</span>&nbsp;<span class="ident" id="3450327">err</span>&nbsp;<span class="op" id="3450331">!=</span>&nbsp;<span class="ident" id="3450334">nil</span>&nbsp;<span class="op" id="3450338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3450344">Error</span><span class="op" id="3450349">(</span><span class="ident" id="3450350">w</span><span class="op" id="3450351">,</span>&nbsp;<span class="string" id="3450353">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="3450372">,</span>&nbsp;<span class="ident" id="3450374">StatusInternalServerError</span><span class="op" id="3450399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3450405">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3450415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3450419">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3450423">w</span><span class="op" id="3450424">.</span><span class="ident" id="3450425">Header</span><span class="op" id="3450431">(</span><span class="op" id="3450432">)</span><span class="op" id="3450433">.</span><span class="ident" id="3450434">Set</span><span class="op" id="3450437">(</span><span class="string" id="3450438">&#34;Content-Type&#34;</span><span class="op" id="3450452">,</span>&nbsp;<span class="ident" id="3450454">ctype</span><span class="op" id="3450459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3450462">}</span>&nbsp;<span class="keyword" id="3450464">else</span>&nbsp;<span class="keyword" id="3450469">if</span>&nbsp;<span class="builtinfunc" id="3450472">len</span><span class="op" id="3450475">(</span><span class="ident" id="3450476">ctypes</span><span class="op" id="3450482">)</span>&nbsp;<span class="op" id="3450484">&gt;</span>&nbsp;<span class="num" id="3450486">0</span>&nbsp;<span class="op" id="3450488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3450492">ctype</span>&nbsp;<span class="op" id="3450498">=</span>&nbsp;<span class="ident" id="3450500">ctypes</span><span class="op" id="3450506">[</span><span class="num" id="3450507">0</span><span class="op" id="3450508">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3450511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3450515">size</span><span class="op" id="3450519">,</span>&nbsp;<span class="ident" id="3450521">err</span>&nbsp;<span class="op" id="3450525">:=</span>&nbsp;<span class="ident" id="3450528">sizeFunc</span><span class="op" id="3450536">(</span><span class="op" id="3450537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3450540">if</span>&nbsp;<span class="ident" id="3450543">err</span>&nbsp;<span class="op" id="3450547">!=</span>&nbsp;<span class="ident" id="3450550">nil</span>&nbsp;<span class="op" id="3450554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3450558">Error</span><span class="op" id="3450563">(</span><span class="ident" id="3450564">w</span><span class="op" id="3450565">,</span>&nbsp;<span class="ident" id="3450567">err</span><span class="op" id="3450570">.</span><span class="ident" id="3450571">Error</span><span class="op" id="3450576">(</span><span class="op" id="3450577">)</span><span class="op" id="3450578">,</span>&nbsp;<span class="ident" id="3450580">StatusInternalServerError</span><span class="op" id="3450605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3450609">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3450617">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3450621">//&nbsp;handle&nbsp;Content-Range&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3450654">sendSize</span>&nbsp;<span class="op" id="3450663">:=</span>&nbsp;<span class="ident" id="3450666">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3450672">var</span>&nbsp;<span class="ident" id="3450676">sendContent</span>&nbsp;<span class="ident" id="3450688">io</span><span class="op" id="3450690">.</span><span class="ident" id="3450691">Reader</span>&nbsp;<span class="op" id="3450698">=</span>&nbsp;<span class="ident" id="3450700">content</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3450709">if</span>&nbsp;<span class="ident" id="3450712">size</span>&nbsp;<span class="op" id="3450717">&gt;=</span>&nbsp;<span class="num" id="3450720">0</span>&nbsp;<span class="op" id="3450722">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3450726">ranges</span><span class="op" id="3450732">,</span>&nbsp;<span class="ident" id="3450734">err</span>&nbsp;<span class="op" id="3450738">:=</span>&nbsp;<span class="ident" id="3450741">parseRange</span><span class="op" id="3450751">(</span><span class="ident" id="3450752">rangeReq</span><span class="op" id="3450760">,</span>&nbsp;<span class="ident" id="3450762">size</span><span class="op" id="3450766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3450770">if</span>&nbsp;<span class="ident" id="3450773">err</span>&nbsp;<span class="op" id="3450777">!=</span>&nbsp;<span class="ident" id="3450780">nil</span>&nbsp;<span class="op" id="3450784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3450789">Error</span><span class="op" id="3450794">(</span><span class="ident" id="3450795">w</span><span class="op" id="3450796">,</span>&nbsp;<span class="ident" id="3450798">err</span><span class="op" id="3450801">.</span><span class="ident" id="3450802">Error</span><span class="op" id="3450807">(</span><span class="op" id="3450808">)</span><span class="op" id="3450809">,</span>&nbsp;<span class="ident" id="3450811">StatusRequestedRangeNotSatisfiable</span><span class="op" id="3450845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3450850">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3450859">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3450863">if</span>&nbsp;<span class="ident" id="3450866">sumRangesSize</span><span class="op" id="3450879">(</span><span class="ident" id="3450880">ranges</span><span class="op" id="3450886">)</span>&nbsp;<span class="op" id="3450888">&gt;</span>&nbsp;<span class="ident" id="3450890">size</span>&nbsp;<span class="op" id="3450895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3450900">//&nbsp;The&nbsp;total&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;all&nbsp;the&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3450950">//&nbsp;is&nbsp;larger&nbsp;than&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;file&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3450995">//&nbsp;itself,&nbsp;so&nbsp;this&nbsp;is&nbsp;probably&nbsp;an&nbsp;attack,&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3451045">//&nbsp;dumb&nbsp;client.&nbsp;&nbsp;Ignore&nbsp;the&nbsp;range&nbsp;request.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3451091">ranges</span>&nbsp;<span class="op" id="3451098">=</span>&nbsp;<span class="ident" id="3451100">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3451106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3451110">switch</span>&nbsp;<span class="op" id="3451117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3451121">case</span>&nbsp;<span class="builtinfunc" id="3451126">len</span><span class="op" id="3451129">(</span><span class="ident" id="3451130">ranges</span><span class="op" id="3451136">)</span>&nbsp;<span class="op" id="3451138">==</span>&nbsp;<span class="num" id="3451141">1</span><span class="op" id="3451142">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3451147">//&nbsp;RFC&nbsp;2616,&nbsp;Section&nbsp;14.16:</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3451178">//&nbsp;&#34;When&nbsp;an&nbsp;HTTP&nbsp;message&nbsp;includes&nbsp;the&nbsp;content&nbsp;of&nbsp;a&nbsp;single</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3451239">//&nbsp;range&nbsp;(for&nbsp;example,&nbsp;a&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3451295">//&nbsp;single&nbsp;range,&nbsp;or&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;set&nbsp;of&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3451351">//&nbsp;that&nbsp;overlap&nbsp;without&nbsp;any&nbsp;holes),&nbsp;this&nbsp;content&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3451406">//&nbsp;transmitted&nbsp;with&nbsp;a&nbsp;Content-Range&nbsp;header,&nbsp;and&nbsp;a</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3451459">//&nbsp;Content-Length&nbsp;header&nbsp;showing&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3451515">//&nbsp;actually&nbsp;transferred.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3451543">//&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3451553">//&nbsp;A&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;single&nbsp;range&nbsp;MUST&nbsp;NOT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3451611">//&nbsp;be&nbsp;sent&nbsp;using&nbsp;the&nbsp;multipart/byteranges&nbsp;media&nbsp;type.&#34;</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3451669">ra</span>&nbsp;<span class="op" id="3451672">:=</span>&nbsp;<span class="ident" id="3451675">ranges</span><span class="op" id="3451681">[</span><span class="num" id="3451682">0</span><span class="op" id="3451683">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3451688">if</span>&nbsp;<span class="ident" id="3451691">_</span><span class="op" id="3451692">,</span>&nbsp;<span class="ident" id="3451694">err</span>&nbsp;<span class="op" id="3451698">:=</span>&nbsp;<span class="ident" id="3451701">content</span><span class="op" id="3451708">.</span><span class="ident" id="3451709">Seek</span><span class="op" id="3451713">(</span><span class="ident" id="3451714">ra</span><span class="op" id="3451716">.</span><span class="ident" id="3451717">start</span><span class="op" id="3451722">,</span>&nbsp;<span class="ident" id="3451724">os</span><span class="op" id="3451726">.</span><span class="ident" id="3451727">SEEK_SET</span><span class="op" id="3451735">)</span><span class="op" id="3451736">;</span>&nbsp;<span class="ident" id="3451738">err</span>&nbsp;<span class="op" id="3451742">!=</span>&nbsp;<span class="ident" id="3451745">nil</span>&nbsp;<span class="op" id="3451749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3451755">Error</span><span class="op" id="3451760">(</span><span class="ident" id="3451761">w</span><span class="op" id="3451762">,</span>&nbsp;<span class="ident" id="3451764">err</span><span class="op" id="3451767">.</span><span class="ident" id="3451768">Error</span><span class="op" id="3451773">(</span><span class="op" id="3451774">)</span><span class="op" id="3451775">,</span>&nbsp;<span class="ident" id="3451777">StatusRequestedRangeNotSatisfiable</span><span class="op" id="3451811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3451817">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3451827">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3451832">sendSize</span>&nbsp;<span class="op" id="3451841">=</span>&nbsp;<span class="ident" id="3451843">ra</span><span class="op" id="3451845">.</span><span class="ident" id="3451846">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3451856">code</span>&nbsp;<span class="op" id="3451861">=</span>&nbsp;<span class="ident" id="3451863">StatusPartialContent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3451887">w</span><span class="op" id="3451888">.</span><span class="ident" id="3451889">Header</span><span class="op" id="3451895">(</span><span class="op" id="3451896">)</span><span class="op" id="3451897">.</span><span class="ident" id="3451898">Set</span><span class="op" id="3451901">(</span><span class="string" id="3451902">&#34;Content-Range&#34;</span><span class="op" id="3451917">,</span>&nbsp;<span class="ident" id="3451919">ra</span><span class="op" id="3451921">.</span><span class="ident" id="3451922">contentRange</span><span class="op" id="3451934">(</span><span class="ident" id="3451935">size</span><span class="op" id="3451939">)</span><span class="op" id="3451940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3451944">case</span>&nbsp;<span class="builtinfunc" id="3451949">len</span><span class="op" id="3451952">(</span><span class="ident" id="3451953">ranges</span><span class="op" id="3451959">)</span>&nbsp;<span class="op" id="3451961">&gt;</span>&nbsp;<span class="num" id="3451963">1</span><span class="op" id="3451964">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3451969">sendSize</span>&nbsp;<span class="op" id="3451978">=</span>&nbsp;<span class="ident" id="3451980">rangesMIMESize</span><span class="op" id="3451994">(</span><span class="ident" id="3451995">ranges</span><span class="op" id="3452001">,</span>&nbsp;<span class="ident" id="3452003">ctype</span><span class="op" id="3452008">,</span>&nbsp;<span class="ident" id="3452010">size</span><span class="op" id="3452014">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3452019">code</span>&nbsp;<span class="op" id="3452024">=</span>&nbsp;<span class="ident" id="3452026">StatusPartialContent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3452051">pr</span><span class="op" id="3452053">,</span>&nbsp;<span class="ident" id="3452055">pw</span>&nbsp;<span class="op" id="3452058">:=</span>&nbsp;<span class="ident" id="3452061">io</span><span class="op" id="3452063">.</span><span class="ident" id="3452064">Pipe</span><span class="op" id="3452068">(</span><span class="op" id="3452069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3452074">mw</span>&nbsp;<span class="op" id="3452077">:=</span>&nbsp;<span class="ident" id="3452080">multipart</span><span class="op" id="3452089">.</span><span class="ident" id="3452090">NewWriter</span><span class="op" id="3452099">(</span><span class="ident" id="3452100">pw</span><span class="op" id="3452102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3452107">w</span><span class="op" id="3452108">.</span><span class="ident" id="3452109">Header</span><span class="op" id="3452115">(</span><span class="op" id="3452116">)</span><span class="op" id="3452117">.</span><span class="ident" id="3452118">Set</span><span class="op" id="3452121">(</span><span class="string" id="3452122">&#34;Content-Type&#34;</span><span class="op" id="3452136">,</span>&nbsp;<span class="string" id="3452138">&#34;multipart/byteranges;&nbsp;boundary=&#34;</span><span class="op" id="3452171">+</span><span class="ident" id="3452172">mw</span><span class="op" id="3452174">.</span><span class="ident" id="3452175">Boundary</span><span class="op" id="3452183">(</span><span class="op" id="3452184">)</span><span class="op" id="3452185">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3452190">sendContent</span>&nbsp;<span class="op" id="3452202">=</span>&nbsp;<span class="ident" id="3452204">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3452210">defer</span>&nbsp;<span class="ident" id="3452216">pr</span><span class="op" id="3452218">.</span><span class="ident" id="3452219">Close</span><span class="op" id="3452224">(</span><span class="op" id="3452225">)</span>&nbsp;<span class="comment" id="3452227">//&nbsp;cause&nbsp;writing&nbsp;goroutine&nbsp;to&nbsp;fail&nbsp;and&nbsp;exit&nbsp;if&nbsp;CopyN&nbsp;doesn&#39;t&nbsp;finish.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3452299">go</span>&nbsp;<span class="keyword" id="3452302">func</span><span class="op" id="3452306">(</span><span class="op" id="3452307">)</span>&nbsp;<span class="op" id="3452309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3452315">for</span>&nbsp;<span class="ident" id="3452319">_</span><span class="op" id="3452320">,</span>&nbsp;<span class="ident" id="3452322">ra</span>&nbsp;<span class="op" id="3452325">:=</span>&nbsp;<span class="keyword" id="3452328">range</span>&nbsp;<span class="ident" id="3452334">ranges</span>&nbsp;<span class="op" id="3452341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3452348">part</span><span class="op" id="3452352">,</span>&nbsp;<span class="ident" id="3452354">err</span>&nbsp;<span class="op" id="3452358">:=</span>&nbsp;<span class="ident" id="3452361">mw</span><span class="op" id="3452363">.</span><span class="ident" id="3452364">CreatePart</span><span class="op" id="3452374">(</span><span class="ident" id="3452375">ra</span><span class="op" id="3452377">.</span><span class="ident" id="3452378">mimeHeader</span><span class="op" id="3452388">(</span><span class="ident" id="3452389">ctype</span><span class="op" id="3452394">,</span>&nbsp;<span class="ident" id="3452396">size</span><span class="op" id="3452400">)</span><span class="op" id="3452401">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3452408">if</span>&nbsp;<span class="ident" id="3452411">err</span>&nbsp;<span class="op" id="3452415">!=</span>&nbsp;<span class="ident" id="3452418">nil</span>&nbsp;<span class="op" id="3452422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3452430">pw</span><span class="op" id="3452432">.</span><span class="ident" id="3452433">CloseWithError</span><span class="op" id="3452447">(</span><span class="ident" id="3452448">err</span><span class="op" id="3452451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3452459">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3452471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3452478">if</span>&nbsp;<span class="ident" id="3452481">_</span><span class="op" id="3452482">,</span>&nbsp;<span class="ident" id="3452484">err</span>&nbsp;<span class="op" id="3452488">:=</span>&nbsp;<span class="ident" id="3452491">content</span><span class="op" id="3452498">.</span><span class="ident" id="3452499">Seek</span><span class="op" id="3452503">(</span><span class="ident" id="3452504">ra</span><span class="op" id="3452506">.</span><span class="ident" id="3452507">start</span><span class="op" id="3452512">,</span>&nbsp;<span class="ident" id="3452514">os</span><span class="op" id="3452516">.</span><span class="ident" id="3452517">SEEK_SET</span><span class="op" id="3452525">)</span><span class="op" id="3452526">;</span>&nbsp;<span class="ident" id="3452528">err</span>&nbsp;<span class="op" id="3452532">!=</span>&nbsp;<span class="ident" id="3452535">nil</span>&nbsp;<span class="op" id="3452539">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3452547">pw</span><span class="op" id="3452549">.</span><span class="ident" id="3452550">CloseWithError</span><span class="op" id="3452564">(</span><span class="ident" id="3452565">err</span><span class="op" id="3452568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3452576">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3452588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3452595">if</span>&nbsp;<span class="ident" id="3452598">_</span><span class="op" id="3452599">,</span>&nbsp;<span class="ident" id="3452601">err</span>&nbsp;<span class="op" id="3452605">:=</span>&nbsp;<span class="ident" id="3452608">io</span><span class="op" id="3452610">.</span><span class="ident" id="3452611">CopyN</span><span class="op" id="3452616">(</span><span class="ident" id="3452617">part</span><span class="op" id="3452621">,</span>&nbsp;<span class="ident" id="3452623">content</span><span class="op" id="3452630">,</span>&nbsp;<span class="ident" id="3452632">ra</span><span class="op" id="3452634">.</span><span class="ident" id="3452635">length</span><span class="op" id="3452641">)</span><span class="op" id="3452642">;</span>&nbsp;<span class="ident" id="3452644">err</span>&nbsp;<span class="op" id="3452648">!=</span>&nbsp;<span class="ident" id="3452651">nil</span>&nbsp;<span class="op" id="3452655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3452663">pw</span><span class="op" id="3452665">.</span><span class="ident" id="3452666">CloseWithError</span><span class="op" id="3452680">(</span><span class="ident" id="3452681">err</span><span class="op" id="3452684">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3452692">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3452704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3452710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3452716">mw</span><span class="op" id="3452718">.</span><span class="ident" id="3452719">Close</span><span class="op" id="3452724">(</span><span class="op" id="3452725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3452731">pw</span><span class="op" id="3452733">.</span><span class="ident" id="3452734">Close</span><span class="op" id="3452739">(</span><span class="op" id="3452740">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3452745">}</span><span class="op" id="3452746">(</span><span class="op" id="3452747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3452751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3452756">w</span><span class="op" id="3452757">.</span><span class="ident" id="3452758">Header</span><span class="op" id="3452764">(</span><span class="op" id="3452765">)</span><span class="op" id="3452766">.</span><span class="ident" id="3452767">Set</span><span class="op" id="3452770">(</span><span class="string" id="3452771">&#34;Accept-Ranges&#34;</span><span class="op" id="3452786">,</span>&nbsp;<span class="string" id="3452788">&#34;bytes&#34;</span><span class="op" id="3452795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3452799">if</span>&nbsp;<span class="ident" id="3452802">w</span><span class="op" id="3452803">.</span><span class="ident" id="3452804">Header</span><span class="op" id="3452810">(</span><span class="op" id="3452811">)</span><span class="op" id="3452812">.</span><span class="ident" id="3452813">Get</span><span class="op" id="3452816">(</span><span class="string" id="3452817">&#34;Content-Encoding&#34;</span><span class="op" id="3452835">)</span>&nbsp;<span class="op" id="3452837">==</span>&nbsp;<span class="string" id="3452840">&#34;&#34;</span>&nbsp;<span class="op" id="3452843">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3452848">w</span><span class="op" id="3452849">.</span><span class="ident" id="3452850">Header</span><span class="op" id="3452856">(</span><span class="op" id="3452857">)</span><span class="op" id="3452858">.</span><span class="ident" id="3452859">Set</span><span class="op" id="3452862">(</span><span class="string" id="3452863">&#34;Content-Length&#34;</span><span class="op" id="3452879">,</span>&nbsp;<span class="ident" id="3452881">strconv</span><span class="op" id="3452888">.</span><span class="ident" id="3452889">FormatInt</span><span class="op" id="3452898">(</span><span class="ident" id="3452899">sendSize</span><span class="op" id="3452907">,</span>&nbsp;<span class="num" id="3452909">10</span><span class="op" id="3452911">)</span><span class="op" id="3452912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3452916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3452919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3452923">w</span><span class="op" id="3452924">.</span><span class="ident" id="3452925">WriteHeader</span><span class="op" id="3452936">(</span><span class="ident" id="3452937">code</span><span class="op" id="3452941">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3452945">if</span>&nbsp;<span class="ident" id="3452948">r</span><span class="op" id="3452949">.</span><span class="ident" id="3452950">Method</span>&nbsp;<span class="op" id="3452957">!=</span>&nbsp;<span class="string" id="3452960">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3452967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3452971">io</span><span class="op" id="3452973">.</span><span class="ident" id="3452974">CopyN</span><span class="op" id="3452979">(</span><span class="ident" id="3452980">w</span><span class="op" id="3452981">,</span>&nbsp;<span class="ident" id="3452983">sendContent</span><span class="op" id="3452994">,</span>&nbsp;<span class="ident" id="3452996">sendSize</span><span class="op" id="3453004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3453007">}</span><br>
<span class="lineno"></span><span class="op" id="3453009">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="3453012">//&nbsp;modtime&nbsp;is&nbsp;the&nbsp;modification&nbsp;time&nbsp;of&nbsp;the&nbsp;resource&nbsp;to&nbsp;be&nbsp;served,&nbsp;or&nbsp;IsZero().</span><br>
<span class="lineno"></span><span class="comment" id="3453091">//&nbsp;return&nbsp;value&nbsp;is&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;complete.</span><br>
<span class="lineno"></span><span class="keyword" id="3453148">func</span>&nbsp;<span class="ident" id="3453153">checkLastModified</span><span class="op" id="3453170">(</span><span class="ident" id="3453171">w</span>&nbsp;<span class="ident" id="3453173">ResponseWriter</span><span class="op" id="3453187">,</span>&nbsp;<span class="ident" id="3453189">r</span>&nbsp;<span class="op" id="3453191">*</span><span class="ident" id="3453192">Request</span><span class="op" id="3453199">,</span>&nbsp;<span class="ident" id="3453201">modtime</span>&nbsp;<span class="ident" id="3453209">time</span><span class="op" id="3453213">.</span><span class="ident" id="3453214">Time</span><span class="op" id="3453218">)</span>&nbsp;<span class="builtintype" id="3453220">bool</span>&nbsp;<span class="op" id="3453225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3453228">if</span>&nbsp;<span class="ident" id="3453231">modtime</span><span class="op" id="3453238">.</span><span class="ident" id="3453239">IsZero</span><span class="op" id="3453245">(</span><span class="op" id="3453246">)</span>&nbsp;<span class="op" id="3453248">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3453252">return</span>&nbsp;<span class="builtintype" id="3453259">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3453266">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3453270">//&nbsp;The&nbsp;Date-Modified&nbsp;header&nbsp;truncates&nbsp;sub-second&nbsp;precision,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3453334">//&nbsp;use&nbsp;mtime&nbsp;&lt;&nbsp;t+1s&nbsp;instead&nbsp;of&nbsp;mtime&nbsp;&lt;=&nbsp;t&nbsp;to&nbsp;check&nbsp;for&nbsp;unmodified.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3453402">if</span>&nbsp;<span class="ident" id="3453405">t</span><span class="op" id="3453406">,</span>&nbsp;<span class="ident" id="3453408">err</span>&nbsp;<span class="op" id="3453412">:=</span>&nbsp;<span class="ident" id="3453415">time</span><span class="op" id="3453419">.</span><span class="ident" id="3453420">Parse</span><span class="op" id="3453425">(</span><span class="ident" id="3453426">TimeFormat</span><span class="op" id="3453436">,</span>&nbsp;<span class="ident" id="3453438">r</span><span class="op" id="3453439">.</span><span class="ident" id="3453440">Header</span><span class="op" id="3453446">.</span><span class="ident" id="3453447">Get</span><span class="op" id="3453450">(</span><span class="string" id="3453451">&#34;If-Modified-Since&#34;</span><span class="op" id="3453470">)</span><span class="op" id="3453471">)</span><span class="op" id="3453472">;</span>&nbsp;<span class="ident" id="3453474">err</span>&nbsp;<span class="op" id="3453478">==</span>&nbsp;<span class="ident" id="3453481">nil</span>&nbsp;<span class="op" id="3453485">&amp;&amp;</span>&nbsp;<span class="ident" id="3453488">modtime</span><span class="op" id="3453495">.</span><span class="ident" id="3453496">Before</span><span class="op" id="3453502">(</span><span class="ident" id="3453503">t</span><span class="op" id="3453504">.</span><span class="ident" id="3453505">Add</span><span class="op" id="3453508">(</span><span class="num" id="3453509">1</span><span class="op" id="3453510">*</span><span class="ident" id="3453511">time</span><span class="op" id="3453515">.</span><span class="ident" id="3453516">Second</span><span class="op" id="3453522">)</span><span class="op" id="3453523">)</span>&nbsp;<span class="op" id="3453525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3453529">h</span>&nbsp;<span class="op" id="3453531">:=</span>&nbsp;<span class="ident" id="3453534">w</span><span class="op" id="3453535">.</span><span class="ident" id="3453536">Header</span><span class="op" id="3453542">(</span><span class="op" id="3453543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3453547">delete</span><span class="op" id="3453553">(</span><span class="ident" id="3453554">h</span><span class="op" id="3453555">,</span>&nbsp;<span class="string" id="3453557">&#34;Content-Type&#34;</span><span class="op" id="3453571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3453575">delete</span><span class="op" id="3453581">(</span><span class="ident" id="3453582">h</span><span class="op" id="3453583">,</span>&nbsp;<span class="string" id="3453585">&#34;Content-Length&#34;</span><span class="op" id="3453601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3453605">w</span><span class="op" id="3453606">.</span><span class="ident" id="3453607">WriteHeader</span><span class="op" id="3453618">(</span><span class="ident" id="3453619">StatusNotModified</span><span class="op" id="3453636">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3453640">return</span>&nbsp;<span class="builtintype" id="3453647">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3453653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3453656">w</span><span class="op" id="3453657">.</span><span class="ident" id="3453658">Header</span><span class="op" id="3453664">(</span><span class="op" id="3453665">)</span><span class="op" id="3453666">.</span><span class="ident" id="3453667">Set</span><span class="op" id="3453670">(</span><span class="string" id="3453671">&#34;Last-Modified&#34;</span><span class="op" id="3453686">,</span>&nbsp;<span class="ident" id="3453688">modtime</span><span class="op" id="3453695">.</span><span class="ident" id="3453696">UTC</span><span class="op" id="3453699">(</span><span class="op" id="3453700">)</span><span class="op" id="3453701">.</span><span class="ident" id="3453702">Format</span><span class="op" id="3453708">(</span><span class="ident" id="3453709">TimeFormat</span><span class="op" id="3453719">)</span><span class="op" id="3453720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3453723">return</span>&nbsp;<span class="builtintype" id="3453730">false</span><br>
<span class="lineno"></span><span class="op" id="3453736">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3453739">//&nbsp;checkETag&nbsp;implements&nbsp;If-None-Match&nbsp;and&nbsp;If-Range&nbsp;checks.</span><br>
<span class="lineno"></span><span class="comment" id="3453798">//</span><br>
<span class="lineno"></span><span class="comment" id="3453801">//&nbsp;The&nbsp;ETag&nbsp;or&nbsp;modtime&nbsp;must&nbsp;have&nbsp;been&nbsp;previously&nbsp;set&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3453861">//&nbsp;ResponseWriter&#39;s&nbsp;headers.&nbsp;&nbsp;The&nbsp;modtime&nbsp;is&nbsp;only&nbsp;compared&nbsp;at&nbsp;second</span><br>
<span class="lineno">285</span><span class="comment" id="3453930">//&nbsp;granularity&nbsp;and&nbsp;may&nbsp;be&nbsp;the&nbsp;zero&nbsp;value&nbsp;to&nbsp;mean&nbsp;unknown.</span><br>
<span class="lineno"></span><span class="comment" id="3453988">//</span><br>
<span class="lineno"></span><span class="comment" id="3453991">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;effective&nbsp;request&nbsp;&#34;Range&#34;&nbsp;header&nbsp;to&nbsp;use&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3454062">//&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;considered&nbsp;done.</span><br>
<span class="lineno"></span><span class="keyword" id="3454110">func</span>&nbsp;<span class="ident" id="3454115">checkETag</span><span class="op" id="3454124">(</span><span class="ident" id="3454125">w</span>&nbsp;<span class="ident" id="3454127">ResponseWriter</span><span class="op" id="3454141">,</span>&nbsp;<span class="ident" id="3454143">r</span>&nbsp;<span class="op" id="3454145">*</span><span class="ident" id="3454146">Request</span><span class="op" id="3454153">,</span>&nbsp;<span class="ident" id="3454155">modtime</span>&nbsp;<span class="ident" id="3454163">time</span><span class="op" id="3454167">.</span><span class="ident" id="3454168">Time</span><span class="op" id="3454172">)</span>&nbsp;<span class="op" id="3454174">(</span><span class="ident" id="3454175">rangeReq</span>&nbsp;<span class="builtintype" id="3454184">string</span><span class="op" id="3454190">,</span>&nbsp;<span class="ident" id="3454192">done</span>&nbsp;<span class="builtintype" id="3454197">bool</span><span class="op" id="3454201">)</span>&nbsp;<span class="op" id="3454203">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3454206">etag</span>&nbsp;<span class="op" id="3454211">:=</span>&nbsp;<span class="ident" id="3454214">w</span><span class="op" id="3454215">.</span><span class="ident" id="3454216">Header</span><span class="op" id="3454222">(</span><span class="op" id="3454223">)</span><span class="op" id="3454224">.</span><span class="ident" id="3454225">get</span><span class="op" id="3454228">(</span><span class="string" id="3454229">&#34;Etag&#34;</span><span class="op" id="3454235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3454238">rangeReq</span>&nbsp;<span class="op" id="3454247">=</span>&nbsp;<span class="ident" id="3454249">r</span><span class="op" id="3454250">.</span><span class="ident" id="3454251">Header</span><span class="op" id="3454257">.</span><span class="ident" id="3454258">get</span><span class="op" id="3454261">(</span><span class="string" id="3454262">&#34;Range&#34;</span><span class="op" id="3454269">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3454273">//&nbsp;Invalidate&nbsp;the&nbsp;range&nbsp;request&nbsp;if&nbsp;the&nbsp;entity&nbsp;doesn&#39;t&nbsp;match&nbsp;the&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3454342">//&nbsp;the&nbsp;client&nbsp;was&nbsp;expecting.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3454372">//&nbsp;&#34;If-Range:&nbsp;version&#34;&nbsp;means&nbsp;&#34;ignore&nbsp;the&nbsp;Range:&nbsp;header&nbsp;unless&nbsp;version&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3454455">//&nbsp;current&nbsp;file.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3454474">//&nbsp;We&nbsp;only&nbsp;support&nbsp;ETag&nbsp;versions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3454509">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;have&nbsp;set&nbsp;the&nbsp;ETag&nbsp;on&nbsp;the&nbsp;response&nbsp;already.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3454572">if</span>&nbsp;<span class="ident" id="3454575">ir</span>&nbsp;<span class="op" id="3454578">:=</span>&nbsp;<span class="ident" id="3454581">r</span><span class="op" id="3454582">.</span><span class="ident" id="3454583">Header</span><span class="op" id="3454589">.</span><span class="ident" id="3454590">get</span><span class="op" id="3454593">(</span><span class="string" id="3454594">&#34;If-Range&#34;</span><span class="op" id="3454604">)</span><span class="op" id="3454605">;</span>&nbsp;<span class="ident" id="3454607">ir</span>&nbsp;<span class="op" id="3454610">!=</span>&nbsp;<span class="string" id="3454613">&#34;&#34;</span>&nbsp;<span class="op" id="3454616">&amp;&amp;</span>&nbsp;<span class="ident" id="3454619">ir</span>&nbsp;<span class="op" id="3454622">!=</span>&nbsp;<span class="ident" id="3454625">etag</span>&nbsp;<span class="op" id="3454630">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3454634">//&nbsp;The&nbsp;If-Range&nbsp;value&nbsp;is&nbsp;typically&nbsp;the&nbsp;ETag&nbsp;value,&nbsp;but&nbsp;it&nbsp;may&nbsp;also&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3454706">//&nbsp;the&nbsp;modtime&nbsp;date.&nbsp;See&nbsp;golang.org/issue/8367.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3454756">timeMatches</span>&nbsp;<span class="op" id="3454768">:=</span>&nbsp;<span class="builtintype" id="3454771">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3454779">if</span>&nbsp;<span class="op" id="3454782">!</span><span class="ident" id="3454783">modtime</span><span class="op" id="3454790">.</span><span class="ident" id="3454791">IsZero</span><span class="op" id="3454797">(</span><span class="op" id="3454798">)</span>&nbsp;<span class="op" id="3454800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3454805">if</span>&nbsp;<span class="ident" id="3454808">t</span><span class="op" id="3454809">,</span>&nbsp;<span class="ident" id="3454811">err</span>&nbsp;<span class="op" id="3454815">:=</span>&nbsp;<span class="ident" id="3454818">ParseTime</span><span class="op" id="3454827">(</span><span class="ident" id="3454828">ir</span><span class="op" id="3454830">)</span><span class="op" id="3454831">;</span>&nbsp;<span class="ident" id="3454833">err</span>&nbsp;<span class="op" id="3454837">==</span>&nbsp;<span class="ident" id="3454840">nil</span>&nbsp;<span class="op" id="3454844">&amp;&amp;</span>&nbsp;<span class="ident" id="3454847">t</span><span class="op" id="3454848">.</span><span class="ident" id="3454849">Unix</span><span class="op" id="3454853">(</span><span class="op" id="3454854">)</span>&nbsp;<span class="op" id="3454856">==</span>&nbsp;<span class="ident" id="3454859">modtime</span><span class="op" id="3454866">.</span><span class="ident" id="3454867">Unix</span><span class="op" id="3454871">(</span><span class="op" id="3454872">)</span>&nbsp;<span class="op" id="3454874">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3454880">timeMatches</span>&nbsp;<span class="op" id="3454892">=</span>&nbsp;<span class="builtintype" id="3454894">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3454902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3454906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3454910">if</span>&nbsp;<span class="op" id="3454913">!</span><span class="ident" id="3454914">timeMatches</span>&nbsp;<span class="op" id="3454926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3454931">rangeReq</span>&nbsp;<span class="op" id="3454940">=</span>&nbsp;<span class="string" id="3454942">&#34;&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3454947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3454950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3454954">if</span>&nbsp;<span class="ident" id="3454957">inm</span>&nbsp;<span class="op" id="3454961">:=</span>&nbsp;<span class="ident" id="3454964">r</span><span class="op" id="3454965">.</span><span class="ident" id="3454966">Header</span><span class="op" id="3454972">.</span><span class="ident" id="3454973">get</span><span class="op" id="3454976">(</span><span class="string" id="3454977">&#34;If-None-Match&#34;</span><span class="op" id="3454992">)</span><span class="op" id="3454993">;</span>&nbsp;<span class="ident" id="3454995">inm</span>&nbsp;<span class="op" id="3454999">!=</span>&nbsp;<span class="string" id="3455002">&#34;&#34;</span>&nbsp;<span class="op" id="3455005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3455009">//&nbsp;Must&nbsp;know&nbsp;ETag.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3455030">if</span>&nbsp;<span class="ident" id="3455033">etag</span>&nbsp;<span class="op" id="3455038">==</span>&nbsp;<span class="string" id="3455041">&#34;&#34;</span>&nbsp;<span class="op" id="3455044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3455049">return</span>&nbsp;<span class="ident" id="3455056">rangeReq</span><span class="op" id="3455064">,</span>&nbsp;<span class="builtintype" id="3455066">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3455074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3455079">//&nbsp;TODO(bradfitz):&nbsp;non-GET/HEAD&nbsp;requests&nbsp;require&nbsp;more&nbsp;work:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3455141">//&nbsp;sending&nbsp;a&nbsp;different&nbsp;status&nbsp;code&nbsp;on&nbsp;matches,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3455194">//&nbsp;also&nbsp;can&#39;t&nbsp;use&nbsp;weak&nbsp;cache&nbsp;validators&nbsp;(those&nbsp;with&nbsp;a&nbsp;&#34;W/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3455254">//&nbsp;prefix).&nbsp;&nbsp;But&nbsp;most&nbsp;users&nbsp;of&nbsp;ServeContent&nbsp;will&nbsp;be&nbsp;using</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3455314">//&nbsp;it&nbsp;on&nbsp;GET&nbsp;or&nbsp;HEAD,&nbsp;so&nbsp;only&nbsp;support&nbsp;those&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3455369">if</span>&nbsp;<span class="ident" id="3455372">r</span><span class="op" id="3455373">.</span><span class="ident" id="3455374">Method</span>&nbsp;<span class="op" id="3455381">!=</span>&nbsp;<span class="string" id="3455384">&#34;GET&#34;</span>&nbsp;<span class="op" id="3455390">&amp;&amp;</span>&nbsp;<span class="ident" id="3455393">r</span><span class="op" id="3455394">.</span><span class="ident" id="3455395">Method</span>&nbsp;<span class="op" id="3455402">!=</span>&nbsp;<span class="string" id="3455405">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3455412">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3455417">return</span>&nbsp;<span class="ident" id="3455424">rangeReq</span><span class="op" id="3455432">,</span>&nbsp;<span class="builtintype" id="3455434">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3455442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3455447">//&nbsp;TODO(bradfitz):&nbsp;deal&nbsp;with&nbsp;comma-separated&nbsp;or&nbsp;multiple-valued</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3455513">//&nbsp;list&nbsp;of&nbsp;If-None-match&nbsp;values.&nbsp;&nbsp;For&nbsp;now&nbsp;just&nbsp;handle&nbsp;the&nbsp;common</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3455580">//&nbsp;case&nbsp;of&nbsp;a&nbsp;single&nbsp;item.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3455608">if</span>&nbsp;<span class="ident" id="3455611">inm</span>&nbsp;<span class="op" id="3455615">==</span>&nbsp;<span class="ident" id="3455618">etag</span>&nbsp;<span class="op" id="3455623">||</span>&nbsp;<span class="ident" id="3455626">inm</span>&nbsp;<span class="op" id="3455630">==</span>&nbsp;<span class="string" id="3455633">&#34;*&#34;</span>&nbsp;<span class="op" id="3455637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3455642">h</span>&nbsp;<span class="op" id="3455644">:=</span>&nbsp;<span class="ident" id="3455647">w</span><span class="op" id="3455648">.</span><span class="ident" id="3455649">Header</span><span class="op" id="3455655">(</span><span class="op" id="3455656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3455661">delete</span><span class="op" id="3455667">(</span><span class="ident" id="3455668">h</span><span class="op" id="3455669">,</span>&nbsp;<span class="string" id="3455671">&#34;Content-Type&#34;</span><span class="op" id="3455685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3455690">delete</span><span class="op" id="3455696">(</span><span class="ident" id="3455697">h</span><span class="op" id="3455698">,</span>&nbsp;<span class="string" id="3455700">&#34;Content-Length&#34;</span><span class="op" id="3455716">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3455721">w</span><span class="op" id="3455722">.</span><span class="ident" id="3455723">WriteHeader</span><span class="op" id="3455734">(</span><span class="ident" id="3455735">StatusNotModified</span><span class="op" id="3455752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3455757">return</span>&nbsp;<span class="string" id="3455764">&#34;&#34;</span><span class="op" id="3455766">,</span>&nbsp;<span class="builtintype" id="3455768">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3455775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3455778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3455781">return</span>&nbsp;<span class="ident" id="3455788">rangeReq</span><span class="op" id="3455796">,</span>&nbsp;<span class="builtintype" id="3455798">false</span><br>
<span class="lineno">340</span><span class="op" id="3455804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3455807">//&nbsp;name&nbsp;is&nbsp;&#39;/&#39;-separated,&nbsp;not&nbsp;filepath.Separator.</span><br>
<span class="lineno"></span><span class="keyword" id="3455857">func</span>&nbsp;<span class="ident" id="3455862">serveFile</span><span class="op" id="3455871">(</span><span class="ident" id="3455872">w</span>&nbsp;<span class="ident" id="3455874">ResponseWriter</span><span class="op" id="3455888">,</span>&nbsp;<span class="ident" id="3455890">r</span>&nbsp;<span class="op" id="3455892">*</span><span class="ident" id="3455893">Request</span><span class="op" id="3455900">,</span>&nbsp;<span class="ident" id="3455902">fs</span>&nbsp;<span class="ident" id="3455905">FileSystem</span><span class="op" id="3455915">,</span>&nbsp;<span class="ident" id="3455917">name</span>&nbsp;<span class="builtintype" id="3455922">string</span><span class="op" id="3455928">,</span>&nbsp;<span class="ident" id="3455930">redirect</span>&nbsp;<span class="builtintype" id="3455939">bool</span><span class="op" id="3455943">)</span>&nbsp;<span class="op" id="3455945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3455948">const</span>&nbsp;<span class="ident" id="3455954">indexPage</span>&nbsp;<span class="op" id="3455964">=</span>&nbsp;<span class="string" id="3455966">&#34;/index.html&#34;</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3455982">//&nbsp;redirect&nbsp;.../index.html&nbsp;to&nbsp;.../</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3456018">//&nbsp;can&#39;t&nbsp;use&nbsp;Redirect()&nbsp;because&nbsp;that&nbsp;would&nbsp;make&nbsp;the&nbsp;path&nbsp;absolute,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3456086">//&nbsp;which&nbsp;would&nbsp;be&nbsp;a&nbsp;problem&nbsp;running&nbsp;under&nbsp;StripPrefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456141">if</span>&nbsp;<span class="ident" id="3456144">strings</span><span class="op" id="3456151">.</span><span class="ident" id="3456152">HasSuffix</span><span class="op" id="3456161">(</span><span class="ident" id="3456162">r</span><span class="op" id="3456163">.</span><span class="ident" id="3456164">URL</span><span class="op" id="3456167">.</span><span class="ident" id="3456168">Path</span><span class="op" id="3456172">,</span>&nbsp;<span class="ident" id="3456174">indexPage</span><span class="op" id="3456183">)</span>&nbsp;<span class="op" id="3456185">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3456189">localRedirect</span><span class="op" id="3456202">(</span><span class="ident" id="3456203">w</span><span class="op" id="3456204">,</span>&nbsp;<span class="ident" id="3456206">r</span><span class="op" id="3456207">,</span>&nbsp;<span class="string" id="3456209">&#34;./&#34;</span><span class="op" id="3456213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456217">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3456225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3456229">f</span><span class="op" id="3456230">,</span>&nbsp;<span class="ident" id="3456232">err</span>&nbsp;<span class="op" id="3456236">:=</span>&nbsp;<span class="ident" id="3456239">fs</span><span class="op" id="3456241">.</span><span class="ident" id="3456242">Open</span><span class="op" id="3456246">(</span><span class="ident" id="3456247">name</span><span class="op" id="3456251">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456254">if</span>&nbsp;<span class="ident" id="3456257">err</span>&nbsp;<span class="op" id="3456261">!=</span>&nbsp;<span class="ident" id="3456264">nil</span>&nbsp;<span class="op" id="3456268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3456272">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3456303">NotFound</span><span class="op" id="3456311">(</span><span class="ident" id="3456312">w</span><span class="op" id="3456313">,</span>&nbsp;<span class="ident" id="3456315">r</span><span class="op" id="3456316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456320">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3456328">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456331">defer</span>&nbsp;<span class="ident" id="3456337">f</span><span class="op" id="3456338">.</span><span class="ident" id="3456339">Close</span><span class="op" id="3456344">(</span><span class="op" id="3456345">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3456349">d</span><span class="op" id="3456350">,</span>&nbsp;<span class="ident" id="3456352">err1</span>&nbsp;<span class="op" id="3456357">:=</span>&nbsp;<span class="ident" id="3456360">f</span><span class="op" id="3456361">.</span><span class="ident" id="3456362">Stat</span><span class="op" id="3456366">(</span><span class="op" id="3456367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456370">if</span>&nbsp;<span class="ident" id="3456373">err1</span>&nbsp;<span class="op" id="3456378">!=</span>&nbsp;<span class="ident" id="3456381">nil</span>&nbsp;<span class="op" id="3456385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3456389">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3456420">NotFound</span><span class="op" id="3456428">(</span><span class="ident" id="3456429">w</span><span class="op" id="3456430">,</span>&nbsp;<span class="ident" id="3456432">r</span><span class="op" id="3456433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456437">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3456445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456449">if</span>&nbsp;<span class="ident" id="3456452">redirect</span>&nbsp;<span class="op" id="3456461">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3456465">//&nbsp;redirect&nbsp;to&nbsp;canonical&nbsp;path:&nbsp;/&nbsp;at&nbsp;end&nbsp;of&nbsp;directory&nbsp;url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3456524">//&nbsp;r.URL.Path&nbsp;always&nbsp;begins&nbsp;with&nbsp;/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3456561">url</span>&nbsp;<span class="op" id="3456565">:=</span>&nbsp;<span class="ident" id="3456568">r</span><span class="op" id="3456569">.</span><span class="ident" id="3456570">URL</span><span class="op" id="3456573">.</span><span class="ident" id="3456574">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456581">if</span>&nbsp;<span class="ident" id="3456584">d</span><span class="op" id="3456585">.</span><span class="ident" id="3456586">IsDir</span><span class="op" id="3456591">(</span><span class="op" id="3456592">)</span>&nbsp;<span class="op" id="3456594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456599">if</span>&nbsp;<span class="ident" id="3456602">url</span><span class="op" id="3456605">[</span><span class="builtinfunc" id="3456606">len</span><span class="op" id="3456609">(</span><span class="ident" id="3456610">url</span><span class="op" id="3456613">)</span><span class="op" id="3456614">-</span><span class="num" id="3456615">1</span><span class="op" id="3456616">]</span>&nbsp;<span class="op" id="3456618">!=</span>&nbsp;<span class="string" id="3456621">&#39;/&#39;</span>&nbsp;<span class="op" id="3456625">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3456631">localRedirect</span><span class="op" id="3456644">(</span><span class="ident" id="3456645">w</span><span class="op" id="3456646">,</span>&nbsp;<span class="ident" id="3456648">r</span><span class="op" id="3456649">,</span>&nbsp;<span class="ident" id="3456651">path</span><span class="op" id="3456655">.</span><span class="ident" id="3456656">Base</span><span class="op" id="3456660">(</span><span class="ident" id="3456661">url</span><span class="op" id="3456664">)</span><span class="op" id="3456665">+</span><span class="string" id="3456666">&#34;/&#34;</span><span class="op" id="3456669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456675">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3456685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3456689">}</span>&nbsp;<span class="keyword" id="3456691">else</span>&nbsp;<span class="op" id="3456696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456701">if</span>&nbsp;<span class="ident" id="3456704">url</span><span class="op" id="3456707">[</span><span class="builtinfunc" id="3456708">len</span><span class="op" id="3456711">(</span><span class="ident" id="3456712">url</span><span class="op" id="3456715">)</span><span class="op" id="3456716">-</span><span class="num" id="3456717">1</span><span class="op" id="3456718">]</span>&nbsp;<span class="op" id="3456720">==</span>&nbsp;<span class="string" id="3456723">&#39;/&#39;</span>&nbsp;<span class="op" id="3456727">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3456733">localRedirect</span><span class="op" id="3456746">(</span><span class="ident" id="3456747">w</span><span class="op" id="3456748">,</span>&nbsp;<span class="ident" id="3456750">r</span><span class="op" id="3456751">,</span>&nbsp;<span class="string" id="3456753">&#34;../&#34;</span><span class="op" id="3456758">+</span><span class="ident" id="3456759">path</span><span class="op" id="3456763">.</span><span class="ident" id="3456764">Base</span><span class="op" id="3456768">(</span><span class="ident" id="3456769">url</span><span class="op" id="3456772">)</span><span class="op" id="3456773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456779">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3456789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3456793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3456796">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3456800">//&nbsp;use&nbsp;contents&nbsp;of&nbsp;index.html&nbsp;for&nbsp;directory,&nbsp;if&nbsp;present</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456857">if</span>&nbsp;<span class="ident" id="3456860">d</span><span class="op" id="3456861">.</span><span class="ident" id="3456862">IsDir</span><span class="op" id="3456867">(</span><span class="op" id="3456868">)</span>&nbsp;<span class="op" id="3456870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3456874">index</span>&nbsp;<span class="op" id="3456880">:=</span>&nbsp;<span class="ident" id="3456883">strings</span><span class="op" id="3456890">.</span><span class="ident" id="3456891">TrimSuffix</span><span class="op" id="3456901">(</span><span class="ident" id="3456902">name</span><span class="op" id="3456906">,</span>&nbsp;<span class="string" id="3456908">&#34;/&#34;</span><span class="op" id="3456911">)</span>&nbsp;<span class="op" id="3456913">+</span>&nbsp;<span class="ident" id="3456915">indexPage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3456927">ff</span><span class="op" id="3456929">,</span>&nbsp;<span class="ident" id="3456931">err</span>&nbsp;<span class="op" id="3456935">:=</span>&nbsp;<span class="ident" id="3456938">fs</span><span class="op" id="3456940">.</span><span class="ident" id="3456941">Open</span><span class="op" id="3456945">(</span><span class="ident" id="3456946">index</span><span class="op" id="3456951">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456955">if</span>&nbsp;<span class="ident" id="3456958">err</span>&nbsp;<span class="op" id="3456962">==</span>&nbsp;<span class="ident" id="3456965">nil</span>&nbsp;<span class="op" id="3456969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3456974">defer</span>&nbsp;<span class="ident" id="3456980">ff</span><span class="op" id="3456982">.</span><span class="ident" id="3456983">Close</span><span class="op" id="3456988">(</span><span class="op" id="3456989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3456994">dd</span><span class="op" id="3456996">,</span>&nbsp;<span class="ident" id="3456998">err</span>&nbsp;<span class="op" id="3457002">:=</span>&nbsp;<span class="ident" id="3457005">ff</span><span class="op" id="3457007">.</span><span class="ident" id="3457008">Stat</span><span class="op" id="3457012">(</span><span class="op" id="3457013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3457018">if</span>&nbsp;<span class="ident" id="3457021">err</span>&nbsp;<span class="op" id="3457025">==</span>&nbsp;<span class="ident" id="3457028">nil</span>&nbsp;<span class="op" id="3457032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3457038">name</span>&nbsp;<span class="op" id="3457043">=</span>&nbsp;<span class="ident" id="3457045">index</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3457055">d</span>&nbsp;<span class="op" id="3457057">=</span>&nbsp;<span class="ident" id="3457059">dd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3457066">f</span>&nbsp;<span class="op" id="3457068">=</span>&nbsp;<span class="ident" id="3457070">ff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3457076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3457080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3457083">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3457087">//&nbsp;Still&nbsp;a&nbsp;directory?&nbsp;(we&nbsp;didn&#39;t&nbsp;find&nbsp;an&nbsp;index.html&nbsp;file)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3457146">if</span>&nbsp;<span class="ident" id="3457149">d</span><span class="op" id="3457150">.</span><span class="ident" id="3457151">IsDir</span><span class="op" id="3457156">(</span><span class="op" id="3457157">)</span>&nbsp;<span class="op" id="3457159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3457163">if</span>&nbsp;<span class="ident" id="3457166">checkLastModified</span><span class="op" id="3457183">(</span><span class="ident" id="3457184">w</span><span class="op" id="3457185">,</span>&nbsp;<span class="ident" id="3457187">r</span><span class="op" id="3457188">,</span>&nbsp;<span class="ident" id="3457190">d</span><span class="op" id="3457191">.</span><span class="ident" id="3457192">ModTime</span><span class="op" id="3457199">(</span><span class="op" id="3457200">)</span><span class="op" id="3457201">)</span>&nbsp;<span class="op" id="3457203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3457208">return</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3457217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3457221">dirList</span><span class="op" id="3457228">(</span><span class="ident" id="3457229">w</span><span class="op" id="3457230">,</span>&nbsp;<span class="ident" id="3457232">f</span><span class="op" id="3457233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3457237">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3457245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3457249">//&nbsp;serveContent&nbsp;will&nbsp;check&nbsp;modification&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3457295">sizeFunc</span>&nbsp;<span class="op" id="3457304">:=</span>&nbsp;<span class="keyword" id="3457307">func</span><span class="op" id="3457311">(</span><span class="op" id="3457312">)</span>&nbsp;<span class="op" id="3457314">(</span><span class="ident" id="3457315">int64</span><span class="op" id="3457320">,</span>&nbsp;<span class="builtintype" id="3457322">error</span><span class="op" id="3457327">)</span>&nbsp;<span class="op" id="3457329">{</span>&nbsp;<span class="keyword" id="3457331">return</span>&nbsp;<span class="ident" id="3457338">d</span><span class="op" id="3457339">.</span><span class="ident" id="3457340">Size</span><span class="op" id="3457344">(</span><span class="op" id="3457345">)</span><span class="op" id="3457346">,</span>&nbsp;<span class="ident" id="3457348">nil</span>&nbsp;<span class="op" id="3457352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3457355">serveContent</span><span class="op" id="3457367">(</span><span class="ident" id="3457368">w</span><span class="op" id="3457369">,</span>&nbsp;<span class="ident" id="3457371">r</span><span class="op" id="3457372">,</span>&nbsp;<span class="ident" id="3457374">d</span><span class="op" id="3457375">.</span><span class="ident" id="3457376">Name</span><span class="op" id="3457380">(</span><span class="op" id="3457381">)</span><span class="op" id="3457382">,</span>&nbsp;<span class="ident" id="3457384">d</span><span class="op" id="3457385">.</span><span class="ident" id="3457386">ModTime</span><span class="op" id="3457393">(</span><span class="op" id="3457394">)</span><span class="op" id="3457395">,</span>&nbsp;<span class="ident" id="3457397">sizeFunc</span><span class="op" id="3457405">,</span>&nbsp;<span class="ident" id="3457407">f</span><span class="op" id="3457408">)</span><br>
<span class="lineno"></span><span class="op" id="3457410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3457413">//&nbsp;localRedirect&nbsp;gives&nbsp;a&nbsp;Moved&nbsp;Permanently&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3457466">//&nbsp;It&nbsp;does&nbsp;not&nbsp;convert&nbsp;relative&nbsp;paths&nbsp;to&nbsp;absolute&nbsp;paths&nbsp;like&nbsp;Redirect&nbsp;does.</span><br>
<span class="lineno"></span><span class="keyword" id="3457542">func</span>&nbsp;<span class="ident" id="3457547">localRedirect</span><span class="op" id="3457560">(</span><span class="ident" id="3457561">w</span>&nbsp;<span class="ident" id="3457563">ResponseWriter</span><span class="op" id="3457577">,</span>&nbsp;<span class="ident" id="3457579">r</span>&nbsp;<span class="op" id="3457581">*</span><span class="ident" id="3457582">Request</span><span class="op" id="3457589">,</span>&nbsp;<span class="ident" id="3457591">newPath</span>&nbsp;<span class="builtintype" id="3457599">string</span><span class="op" id="3457605">)</span>&nbsp;<span class="op" id="3457607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3457610">if</span>&nbsp;<span class="ident" id="3457613">q</span>&nbsp;<span class="op" id="3457615">:=</span>&nbsp;<span class="ident" id="3457618">r</span><span class="op" id="3457619">.</span><span class="ident" id="3457620">URL</span><span class="op" id="3457623">.</span><span class="ident" id="3457624">RawQuery</span><span class="op" id="3457632">;</span>&nbsp;<span class="ident" id="3457634">q</span>&nbsp;<span class="op" id="3457636">!=</span>&nbsp;<span class="string" id="3457639">&#34;&#34;</span>&nbsp;<span class="op" id="3457642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3457646">newPath</span>&nbsp;<span class="op" id="3457654">+=</span>&nbsp;<span class="string" id="3457657">&#34;?&#34;</span>&nbsp;<span class="op" id="3457661">+</span>&nbsp;<span class="ident" id="3457663">q</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3457666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3457669">w</span><span class="op" id="3457670">.</span><span class="ident" id="3457671">Header</span><span class="op" id="3457677">(</span><span class="op" id="3457678">)</span><span class="op" id="3457679">.</span><span class="ident" id="3457680">Set</span><span class="op" id="3457683">(</span><span class="string" id="3457684">&#34;Location&#34;</span><span class="op" id="3457694">,</span>&nbsp;<span class="ident" id="3457696">newPath</span><span class="op" id="3457703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3457706">w</span><span class="op" id="3457707">.</span><span class="ident" id="3457708">WriteHeader</span><span class="op" id="3457719">(</span><span class="ident" id="3457720">StatusMovedPermanently</span><span class="op" id="3457742">)</span><br>
<span class="lineno"></span><span class="op" id="3457744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span><span class="comment" id="3457747">//&nbsp;ServeFile&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;named&nbsp;file&nbsp;or&nbsp;directory.</span><br>
<span class="lineno"></span><span class="keyword" id="3457833">func</span>&nbsp;<span class="ident" id="3457838">ServeFile</span><span class="op" id="3457847">(</span><span class="ident" id="3457848">w</span>&nbsp;<span class="ident" id="3457850">ResponseWriter</span><span class="op" id="3457864">,</span>&nbsp;<span class="ident" id="3457866">r</span>&nbsp;<span class="op" id="3457868">*</span><span class="ident" id="3457869">Request</span><span class="op" id="3457876">,</span>&nbsp;<span class="ident" id="3457878">name</span>&nbsp;<span class="builtintype" id="3457883">string</span><span class="op" id="3457889">)</span>&nbsp;<span class="op" id="3457891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3457894">dir</span><span class="op" id="3457897">,</span>&nbsp;<span class="ident" id="3457899">file</span>&nbsp;<span class="op" id="3457904">:=</span>&nbsp;<span class="ident" id="3457907">filepath</span><span class="op" id="3457915">.</span><span class="ident" id="3457916">Split</span><span class="op" id="3457921">(</span><span class="ident" id="3457922">name</span><span class="op" id="3457926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3457929">serveFile</span><span class="op" id="3457938">(</span><span class="ident" id="3457939">w</span><span class="op" id="3457940">,</span>&nbsp;<span class="ident" id="3457942">r</span><span class="op" id="3457943">,</span>&nbsp;<span class="ident" id="3457945">Dir</span><span class="op" id="3457948">(</span><span class="ident" id="3457949">dir</span><span class="op" id="3457952">)</span><span class="op" id="3457953">,</span>&nbsp;<span class="ident" id="3457955">file</span><span class="op" id="3457959">,</span>&nbsp;<span class="builtintype" id="3457961">false</span><span class="op" id="3457966">)</span><br>
<span class="lineno"></span><span class="op" id="3457968">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="3457971">type</span>&nbsp;<span class="ident" id="3457976">fileHandler</span>&nbsp;<span class="keyword" id="3457988">struct</span>&nbsp;<span class="op" id="3457995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3457998">root</span>&nbsp;<span class="ident" id="3458003">FileSystem</span><br>
<span class="lineno"></span><span class="op" id="3458014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="comment" id="3458017">//&nbsp;FileServer&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3458075">//&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;file&nbsp;system&nbsp;rooted&nbsp;at&nbsp;root.</span><br>
<span class="lineno"></span><span class="comment" id="3458131">//</span><br>
<span class="lineno"></span><span class="comment" id="3458134">//&nbsp;To&nbsp;use&nbsp;the&nbsp;operating&nbsp;system&#39;s&nbsp;file&nbsp;system&nbsp;implementation,</span><br>
<span class="lineno"></span><span class="comment" id="3458195">//&nbsp;use&nbsp;http.Dir:</span><br>
<span class="lineno">440</span><span class="comment" id="3458212">//</span><br>
<span class="lineno"></span><span class="comment" id="3458215">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.Handle(&#34;/&#34;,&nbsp;http.FileServer(http.Dir(&#34;/tmp&#34;)))</span><br>
<span class="lineno"></span><span class="keyword" id="3458274">func</span>&nbsp;<span class="ident" id="3458279">FileServer</span><span class="op" id="3458289">(</span><span class="ident" id="3458290">root</span>&nbsp;<span class="ident" id="3458295">FileSystem</span><span class="op" id="3458305">)</span>&nbsp;<span class="ident" id="3458307">Handler</span>&nbsp;<span class="op" id="3458315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3458318">return</span>&nbsp;<span class="op" id="3458325">&amp;</span><span class="ident" id="3458326">fileHandler</span><span class="op" id="3458337">{</span><span class="ident" id="3458338">root</span><span class="op" id="3458342">}</span><br>
<span class="lineno"></span><span class="op" id="3458344">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span><span class="keyword" id="3458347">func</span>&nbsp;<span class="op" id="3458352">(</span><span class="ident" id="3458353">f</span>&nbsp;<span class="op" id="3458355">*</span><span class="ident" id="3458356">fileHandler</span><span class="op" id="3458367">)</span>&nbsp;<span class="ident" id="3458369">ServeHTTP</span><span class="op" id="3458378">(</span><span class="ident" id="3458379">w</span>&nbsp;<span class="ident" id="3458381">ResponseWriter</span><span class="op" id="3458395">,</span>&nbsp;<span class="ident" id="3458397">r</span>&nbsp;<span class="op" id="3458399">*</span><span class="ident" id="3458400">Request</span><span class="op" id="3458407">)</span>&nbsp;<span class="op" id="3458409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3458412">upath</span>&nbsp;<span class="op" id="3458418">:=</span>&nbsp;<span class="ident" id="3458421">r</span><span class="op" id="3458422">.</span><span class="ident" id="3458423">URL</span><span class="op" id="3458426">.</span><span class="ident" id="3458427">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3458433">if</span>&nbsp;<span class="op" id="3458436">!</span><span class="ident" id="3458437">strings</span><span class="op" id="3458444">.</span><span class="ident" id="3458445">HasPrefix</span><span class="op" id="3458454">(</span><span class="ident" id="3458455">upath</span><span class="op" id="3458460">,</span>&nbsp;<span class="string" id="3458462">&#34;/&#34;</span><span class="op" id="3458465">)</span>&nbsp;<span class="op" id="3458467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3458471">upath</span>&nbsp;<span class="op" id="3458477">=</span>&nbsp;<span class="string" id="3458479">&#34;/&#34;</span>&nbsp;<span class="op" id="3458483">+</span>&nbsp;<span class="ident" id="3458485">upath</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3458493">r</span><span class="op" id="3458494">.</span><span class="ident" id="3458495">URL</span><span class="op" id="3458498">.</span><span class="ident" id="3458499">Path</span>&nbsp;<span class="op" id="3458504">=</span>&nbsp;<span class="ident" id="3458506">upath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3458513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3458516">serveFile</span><span class="op" id="3458525">(</span><span class="ident" id="3458526">w</span><span class="op" id="3458527">,</span>&nbsp;<span class="ident" id="3458529">r</span><span class="op" id="3458530">,</span>&nbsp;<span class="ident" id="3458532">f</span><span class="op" id="3458533">.</span><span class="ident" id="3458534">root</span><span class="op" id="3458538">,</span>&nbsp;<span class="ident" id="3458540">path</span><span class="op" id="3458544">.</span><span class="ident" id="3458545">Clean</span><span class="op" id="3458550">(</span><span class="ident" id="3458551">upath</span><span class="op" id="3458556">)</span><span class="op" id="3458557">,</span>&nbsp;<span class="builtintype" id="3458559">true</span><span class="op" id="3458563">)</span><br>
<span class="lineno"></span><span class="op" id="3458565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="3458568">//&nbsp;httpRange&nbsp;specifies&nbsp;the&nbsp;byte&nbsp;range&nbsp;to&nbsp;be&nbsp;sent&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3458632">type</span>&nbsp;<span class="ident" id="3458637">httpRange</span>&nbsp;<span class="keyword" id="3458647">struct</span>&nbsp;<span class="op" id="3458654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3458657">start</span><span class="op" id="3458662">,</span>&nbsp;<span class="ident" id="3458664">length</span>&nbsp;<span class="ident" id="3458671">int64</span><br>
<span class="lineno"></span><span class="op" id="3458677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="keyword" id="3458680">func</span>&nbsp;<span class="op" id="3458685">(</span><span class="ident" id="3458686">r</span>&nbsp;<span class="ident" id="3458688">httpRange</span><span class="op" id="3458697">)</span>&nbsp;<span class="ident" id="3458699">contentRange</span><span class="op" id="3458711">(</span><span class="ident" id="3458712">size</span>&nbsp;<span class="ident" id="3458717">int64</span><span class="op" id="3458722">)</span>&nbsp;<span class="builtintype" id="3458724">string</span>&nbsp;<span class="op" id="3458731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3458734">return</span>&nbsp;<span class="ident" id="3458741">fmt</span><span class="op" id="3458744">.</span><span class="ident" id="3458745">Sprintf</span><span class="op" id="3458752">(</span><span class="string" id="3458753">&#34;bytes&nbsp;%d-%d/%d&#34;</span><span class="op" id="3458769">,</span>&nbsp;<span class="ident" id="3458771">r</span><span class="op" id="3458772">.</span><span class="ident" id="3458773">start</span><span class="op" id="3458778">,</span>&nbsp;<span class="ident" id="3458780">r</span><span class="op" id="3458781">.</span><span class="ident" id="3458782">start</span><span class="op" id="3458787">+</span><span class="ident" id="3458788">r</span><span class="op" id="3458789">.</span><span class="ident" id="3458790">length</span><span class="op" id="3458796">-</span><span class="num" id="3458797">1</span><span class="op" id="3458798">,</span>&nbsp;<span class="ident" id="3458800">size</span><span class="op" id="3458804">)</span><br>
<span class="lineno"></span><span class="op" id="3458806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3458809">func</span>&nbsp;<span class="op" id="3458814">(</span><span class="ident" id="3458815">r</span>&nbsp;<span class="ident" id="3458817">httpRange</span><span class="op" id="3458826">)</span>&nbsp;<span class="ident" id="3458828">mimeHeader</span><span class="op" id="3458838">(</span><span class="ident" id="3458839">contentType</span>&nbsp;<span class="builtintype" id="3458851">string</span><span class="op" id="3458857">,</span>&nbsp;<span class="ident" id="3458859">size</span>&nbsp;<span class="ident" id="3458864">int64</span><span class="op" id="3458869">)</span>&nbsp;<span class="ident" id="3458871">textproto</span><span class="op" id="3458880">.</span><span class="ident" id="3458881">MIMEHeader</span>&nbsp;<span class="op" id="3458892">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3458895">return</span>&nbsp;<span class="ident" id="3458902">textproto</span><span class="op" id="3458911">.</span><span class="ident" id="3458912">MIMEHeader</span><span class="op" id="3458922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3458926">&#34;Content-Range&#34;</span><span class="op" id="3458941">:</span>&nbsp;<span class="op" id="3458943">{</span><span class="ident" id="3458944">r</span><span class="op" id="3458945">.</span><span class="ident" id="3458946">contentRange</span><span class="op" id="3458958">(</span><span class="ident" id="3458959">size</span><span class="op" id="3458963">)</span><span class="op" id="3458964">}</span><span class="op" id="3458965">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3458969">&#34;Content-Type&#34;</span><span class="op" id="3458983">:</span>&nbsp;&nbsp;<span class="op" id="3458986">{</span><span class="ident" id="3458987">contentType</span><span class="op" id="3458998">}</span><span class="op" id="3458999">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3459002">}</span><br>
<span class="lineno"></span><span class="op" id="3459004">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="3459007">//&nbsp;parseRange&nbsp;parses&nbsp;a&nbsp;Range&nbsp;header&nbsp;string&nbsp;as&nbsp;per&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="keyword" id="3459067">func</span>&nbsp;<span class="ident" id="3459072">parseRange</span><span class="op" id="3459082">(</span><span class="ident" id="3459083">s</span>&nbsp;<span class="builtintype" id="3459085">string</span><span class="op" id="3459091">,</span>&nbsp;<span class="ident" id="3459093">size</span>&nbsp;<span class="ident" id="3459098">int64</span><span class="op" id="3459103">)</span>&nbsp;<span class="op" id="3459105">(</span><span class="op" id="3459106">[</span><span class="op" id="3459107">]</span><span class="ident" id="3459108">httpRange</span><span class="op" id="3459117">,</span>&nbsp;<span class="builtintype" id="3459119">error</span><span class="op" id="3459124">)</span>&nbsp;<span class="op" id="3459126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459129">if</span>&nbsp;<span class="ident" id="3459132">s</span>&nbsp;<span class="op" id="3459134">==</span>&nbsp;<span class="string" id="3459137">&#34;&#34;</span>&nbsp;<span class="op" id="3459140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459144">return</span>&nbsp;<span class="ident" id="3459151">nil</span><span class="op" id="3459154">,</span>&nbsp;<span class="ident" id="3459156">nil</span>&nbsp;<span class="comment" id="3459160">//&nbsp;header&nbsp;not&nbsp;present</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3459183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459186">const</span>&nbsp;<span class="ident" id="3459192">b</span>&nbsp;<span class="op" id="3459194">=</span>&nbsp;<span class="string" id="3459196">&#34;bytes=&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459206">if</span>&nbsp;<span class="op" id="3459209">!</span><span class="ident" id="3459210">strings</span><span class="op" id="3459217">.</span><span class="ident" id="3459218">HasPrefix</span><span class="op" id="3459227">(</span><span class="ident" id="3459228">s</span><span class="op" id="3459229">,</span>&nbsp;<span class="ident" id="3459231">b</span><span class="op" id="3459232">)</span>&nbsp;<span class="op" id="3459234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459238">return</span>&nbsp;<span class="ident" id="3459245">nil</span><span class="op" id="3459248">,</span>&nbsp;<span class="ident" id="3459250">errors</span><span class="op" id="3459256">.</span><span class="ident" id="3459257">New</span><span class="op" id="3459260">(</span><span class="string" id="3459261">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3459276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3459279">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459282">var</span>&nbsp;<span class="ident" id="3459286">ranges</span>&nbsp;<span class="op" id="3459293">[</span><span class="op" id="3459294">]</span><span class="ident" id="3459295">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459306">for</span>&nbsp;<span class="ident" id="3459310">_</span><span class="op" id="3459311">,</span>&nbsp;<span class="ident" id="3459313">ra</span>&nbsp;<span class="op" id="3459316">:=</span>&nbsp;<span class="keyword" id="3459319">range</span>&nbsp;<span class="ident" id="3459325">strings</span><span class="op" id="3459332">.</span><span class="ident" id="3459333">Split</span><span class="op" id="3459338">(</span><span class="ident" id="3459339">s</span><span class="op" id="3459340">[</span><span class="builtinfunc" id="3459341">len</span><span class="op" id="3459344">(</span><span class="ident" id="3459345">b</span><span class="op" id="3459346">)</span><span class="op" id="3459347">:</span><span class="op" id="3459348">]</span><span class="op" id="3459349">,</span>&nbsp;<span class="string" id="3459351">&#34;,&#34;</span><span class="op" id="3459354">)</span>&nbsp;<span class="op" id="3459356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3459360">ra</span>&nbsp;<span class="op" id="3459363">=</span>&nbsp;<span class="ident" id="3459365">strings</span><span class="op" id="3459372">.</span><span class="ident" id="3459373">TrimSpace</span><span class="op" id="3459382">(</span><span class="ident" id="3459383">ra</span><span class="op" id="3459385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459389">if</span>&nbsp;<span class="ident" id="3459392">ra</span>&nbsp;<span class="op" id="3459395">==</span>&nbsp;<span class="string" id="3459398">&#34;&#34;</span>&nbsp;<span class="op" id="3459401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459406">continue</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3459417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3459421">i</span>&nbsp;<span class="op" id="3459423">:=</span>&nbsp;<span class="ident" id="3459426">strings</span><span class="op" id="3459433">.</span><span class="ident" id="3459434">Index</span><span class="op" id="3459439">(</span><span class="ident" id="3459440">ra</span><span class="op" id="3459442">,</span>&nbsp;<span class="string" id="3459444">&#34;-&#34;</span><span class="op" id="3459447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459451">if</span>&nbsp;<span class="ident" id="3459454">i</span>&nbsp;<span class="op" id="3459456">&lt;</span>&nbsp;<span class="num" id="3459458">0</span>&nbsp;<span class="op" id="3459460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459465">return</span>&nbsp;<span class="ident" id="3459472">nil</span><span class="op" id="3459475">,</span>&nbsp;<span class="ident" id="3459477">errors</span><span class="op" id="3459483">.</span><span class="ident" id="3459484">New</span><span class="op" id="3459487">(</span><span class="string" id="3459488">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3459503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3459507">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3459511">start</span><span class="op" id="3459516">,</span>&nbsp;<span class="ident" id="3459518">end</span>&nbsp;<span class="op" id="3459522">:=</span>&nbsp;<span class="ident" id="3459525">strings</span><span class="op" id="3459532">.</span><span class="ident" id="3459533">TrimSpace</span><span class="op" id="3459542">(</span><span class="ident" id="3459543">ra</span><span class="op" id="3459545">[</span><span class="op" id="3459546">:</span><span class="ident" id="3459547">i</span><span class="op" id="3459548">]</span><span class="op" id="3459549">)</span><span class="op" id="3459550">,</span>&nbsp;<span class="ident" id="3459552">strings</span><span class="op" id="3459559">.</span><span class="ident" id="3459560">TrimSpace</span><span class="op" id="3459569">(</span><span class="ident" id="3459570">ra</span><span class="op" id="3459572">[</span><span class="ident" id="3459573">i</span><span class="op" id="3459574">+</span><span class="num" id="3459575">1</span><span class="op" id="3459576">:</span><span class="op" id="3459577">]</span><span class="op" id="3459578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459582">var</span>&nbsp;<span class="ident" id="3459586">r</span>&nbsp;<span class="ident" id="3459588">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459600">if</span>&nbsp;<span class="ident" id="3459603">start</span>&nbsp;<span class="op" id="3459609">==</span>&nbsp;<span class="string" id="3459612">&#34;&#34;</span>&nbsp;<span class="op" id="3459615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3459620">//&nbsp;If&nbsp;no&nbsp;start&nbsp;is&nbsp;specified,&nbsp;end&nbsp;specifies&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3459670">//&nbsp;range&nbsp;start&nbsp;relative&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3459721">i</span><span class="op" id="3459722">,</span>&nbsp;<span class="ident" id="3459724">err</span>&nbsp;<span class="op" id="3459728">:=</span>&nbsp;<span class="ident" id="3459731">strconv</span><span class="op" id="3459738">.</span><span class="ident" id="3459739">ParseInt</span><span class="op" id="3459747">(</span><span class="ident" id="3459748">end</span><span class="op" id="3459751">,</span>&nbsp;<span class="num" id="3459753">10</span><span class="op" id="3459755">,</span>&nbsp;<span class="num" id="3459757">64</span><span class="op" id="3459759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459764">if</span>&nbsp;<span class="ident" id="3459767">err</span>&nbsp;<span class="op" id="3459771">!=</span>&nbsp;<span class="ident" id="3459774">nil</span>&nbsp;<span class="op" id="3459778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459784">return</span>&nbsp;<span class="ident" id="3459791">nil</span><span class="op" id="3459794">,</span>&nbsp;<span class="ident" id="3459796">errors</span><span class="op" id="3459802">.</span><span class="ident" id="3459803">New</span><span class="op" id="3459806">(</span><span class="string" id="3459807">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3459822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3459827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459832">if</span>&nbsp;<span class="ident" id="3459835">i</span>&nbsp;<span class="op" id="3459837">&gt;</span>&nbsp;<span class="ident" id="3459839">size</span>&nbsp;<span class="op" id="3459844">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3459850">i</span>&nbsp;<span class="op" id="3459852">=</span>&nbsp;<span class="ident" id="3459854">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3459862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3459867">r</span><span class="op" id="3459868">.</span><span class="ident" id="3459869">start</span>&nbsp;<span class="op" id="3459875">=</span>&nbsp;<span class="ident" id="3459877">size</span>&nbsp;<span class="op" id="3459882">-</span>&nbsp;<span class="ident" id="3459884">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3459889">r</span><span class="op" id="3459890">.</span><span class="ident" id="3459891">length</span>&nbsp;<span class="op" id="3459898">=</span>&nbsp;<span class="ident" id="3459900">size</span>&nbsp;<span class="op" id="3459905">-</span>&nbsp;<span class="ident" id="3459907">r</span><span class="op" id="3459908">.</span><span class="ident" id="3459909">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3459917">}</span>&nbsp;<span class="keyword" id="3459919">else</span>&nbsp;<span class="op" id="3459924">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3459929">i</span><span class="op" id="3459930">,</span>&nbsp;<span class="ident" id="3459932">err</span>&nbsp;<span class="op" id="3459936">:=</span>&nbsp;<span class="ident" id="3459939">strconv</span><span class="op" id="3459946">.</span><span class="ident" id="3459947">ParseInt</span><span class="op" id="3459955">(</span><span class="ident" id="3459956">start</span><span class="op" id="3459961">,</span>&nbsp;<span class="num" id="3459963">10</span><span class="op" id="3459965">,</span>&nbsp;<span class="num" id="3459967">64</span><span class="op" id="3459969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3459974">if</span>&nbsp;<span class="ident" id="3459977">err</span>&nbsp;<span class="op" id="3459981">!=</span>&nbsp;<span class="ident" id="3459984">nil</span>&nbsp;<span class="op" id="3459988">||</span>&nbsp;<span class="ident" id="3459991">i</span>&nbsp;<span class="op" id="3459993">&gt;</span>&nbsp;<span class="ident" id="3459995">size</span>&nbsp;<span class="op" id="3460000">||</span>&nbsp;<span class="ident" id="3460003">i</span>&nbsp;<span class="op" id="3460005">&lt;</span>&nbsp;<span class="num" id="3460007">0</span>&nbsp;<span class="op" id="3460009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3460015">return</span>&nbsp;<span class="ident" id="3460022">nil</span><span class="op" id="3460025">,</span>&nbsp;<span class="ident" id="3460027">errors</span><span class="op" id="3460033">.</span><span class="ident" id="3460034">New</span><span class="op" id="3460037">(</span><span class="string" id="3460038">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3460053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3460058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3460063">r</span><span class="op" id="3460064">.</span><span class="ident" id="3460065">start</span>&nbsp;<span class="op" id="3460071">=</span>&nbsp;<span class="ident" id="3460073">i</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3460078">if</span>&nbsp;<span class="ident" id="3460081">end</span>&nbsp;<span class="op" id="3460085">==</span>&nbsp;<span class="string" id="3460088">&#34;&#34;</span>&nbsp;<span class="op" id="3460091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3460097">//&nbsp;If&nbsp;no&nbsp;end&nbsp;is&nbsp;specified,&nbsp;range&nbsp;extends&nbsp;to&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3460162">r</span><span class="op" id="3460163">.</span><span class="ident" id="3460164">length</span>&nbsp;<span class="op" id="3460171">=</span>&nbsp;<span class="ident" id="3460173">size</span>&nbsp;<span class="op" id="3460178">-</span>&nbsp;<span class="ident" id="3460180">r</span><span class="op" id="3460181">.</span><span class="ident" id="3460182">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3460191">}</span>&nbsp;<span class="keyword" id="3460193">else</span>&nbsp;<span class="op" id="3460198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3460204">i</span><span class="op" id="3460205">,</span>&nbsp;<span class="ident" id="3460207">err</span>&nbsp;<span class="op" id="3460211">:=</span>&nbsp;<span class="ident" id="3460214">strconv</span><span class="op" id="3460221">.</span><span class="ident" id="3460222">ParseInt</span><span class="op" id="3460230">(</span><span class="ident" id="3460231">end</span><span class="op" id="3460234">,</span>&nbsp;<span class="num" id="3460236">10</span><span class="op" id="3460238">,</span>&nbsp;<span class="num" id="3460240">64</span><span class="op" id="3460242">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3460248">if</span>&nbsp;<span class="ident" id="3460251">err</span>&nbsp;<span class="op" id="3460255">!=</span>&nbsp;<span class="ident" id="3460258">nil</span>&nbsp;<span class="op" id="3460262">||</span>&nbsp;<span class="ident" id="3460265">r</span><span class="op" id="3460266">.</span><span class="ident" id="3460267">start</span>&nbsp;<span class="op" id="3460273">&gt;</span>&nbsp;<span class="ident" id="3460275">i</span>&nbsp;<span class="op" id="3460277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3460284">return</span>&nbsp;<span class="ident" id="3460291">nil</span><span class="op" id="3460294">,</span>&nbsp;<span class="ident" id="3460296">errors</span><span class="op" id="3460302">.</span><span class="ident" id="3460303">New</span><span class="op" id="3460306">(</span><span class="string" id="3460307">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3460322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3460328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3460334">if</span>&nbsp;<span class="ident" id="3460337">i</span>&nbsp;<span class="op" id="3460339">&gt;=</span>&nbsp;<span class="ident" id="3460342">size</span>&nbsp;<span class="op" id="3460347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3460354">i</span>&nbsp;<span class="op" id="3460356">=</span>&nbsp;<span class="ident" id="3460358">size</span>&nbsp;<span class="op" id="3460363">-</span>&nbsp;<span class="num" id="3460365">1</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3460371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3460377">r</span><span class="op" id="3460378">.</span><span class="ident" id="3460379">length</span>&nbsp;<span class="op" id="3460386">=</span>&nbsp;<span class="ident" id="3460388">i</span>&nbsp;<span class="op" id="3460390">-</span>&nbsp;<span class="ident" id="3460392">r</span><span class="op" id="3460393">.</span><span class="ident" id="3460394">start</span>&nbsp;<span class="op" id="3460400">+</span>&nbsp;<span class="num" id="3460402">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3460407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3460411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3460415">ranges</span>&nbsp;<span class="op" id="3460422">=</span>&nbsp;<span class="builtinfunc" id="3460424">append</span><span class="op" id="3460430">(</span><span class="ident" id="3460431">ranges</span><span class="op" id="3460437">,</span>&nbsp;<span class="ident" id="3460439">r</span><span class="op" id="3460440">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3460443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3460446">return</span>&nbsp;<span class="ident" id="3460453">ranges</span><span class="op" id="3460459">,</span>&nbsp;<span class="ident" id="3460461">nil</span><br>
<span class="lineno"></span><span class="op" id="3460465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3460468">//&nbsp;countingWriter&nbsp;counts&nbsp;how&nbsp;many&nbsp;bytes&nbsp;have&nbsp;been&nbsp;written&nbsp;to&nbsp;it.</span><br>
<span class="lineno">530</span><span class="keyword" id="3460533">type</span>&nbsp;<span class="ident" id="3460538">countingWriter</span>&nbsp;<span class="ident" id="3460553">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3460560">func</span>&nbsp;<span class="op" id="3460565">(</span><span class="ident" id="3460566">w</span>&nbsp;<span class="op" id="3460568">*</span><span class="ident" id="3460569">countingWriter</span><span class="op" id="3460583">)</span>&nbsp;<span class="ident" id="3460585">Write</span><span class="op" id="3460590">(</span><span class="ident" id="3460591">p</span>&nbsp;<span class="op" id="3460593">[</span><span class="op" id="3460594">]</span><span class="builtintype" id="3460595">byte</span><span class="op" id="3460599">)</span>&nbsp;<span class="op" id="3460601">(</span><span class="ident" id="3460602">n</span>&nbsp;<span class="builtintype" id="3460604">int</span><span class="op" id="3460607">,</span>&nbsp;<span class="ident" id="3460609">err</span>&nbsp;<span class="builtintype" id="3460613">error</span><span class="op" id="3460618">)</span>&nbsp;<span class="op" id="3460620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3460623">*</span><span class="ident" id="3460624">w</span>&nbsp;<span class="op" id="3460626">+=</span>&nbsp;<span class="ident" id="3460629">countingWriter</span><span class="op" id="3460643">(</span><span class="builtinfunc" id="3460644">len</span><span class="op" id="3460647">(</span><span class="ident" id="3460648">p</span><span class="op" id="3460649">)</span><span class="op" id="3460650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3460653">return</span>&nbsp;<span class="builtinfunc" id="3460660">len</span><span class="op" id="3460663">(</span><span class="ident" id="3460664">p</span><span class="op" id="3460665">)</span><span class="op" id="3460666">,</span>&nbsp;<span class="ident" id="3460668">nil</span><br>
<span class="lineno">535</span><span class="op" id="3460672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3460675">//&nbsp;rangesMIMESize&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;it&nbsp;takes&nbsp;to&nbsp;encode&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3460744">//&nbsp;provided&nbsp;ranges&nbsp;as&nbsp;a&nbsp;multipart&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3460788">func</span>&nbsp;<span class="ident" id="3460793">rangesMIMESize</span><span class="op" id="3460807">(</span><span class="ident" id="3460808">ranges</span>&nbsp;<span class="op" id="3460815">[</span><span class="op" id="3460816">]</span><span class="ident" id="3460817">httpRange</span><span class="op" id="3460826">,</span>&nbsp;<span class="ident" id="3460828">contentType</span>&nbsp;<span class="builtintype" id="3460840">string</span><span class="op" id="3460846">,</span>&nbsp;<span class="ident" id="3460848">contentSize</span>&nbsp;<span class="ident" id="3460860">int64</span><span class="op" id="3460865">)</span>&nbsp;<span class="op" id="3460867">(</span><span class="ident" id="3460868">encSize</span>&nbsp;<span class="ident" id="3460876">int64</span><span class="op" id="3460881">)</span>&nbsp;<span class="op" id="3460883">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3460886">var</span>&nbsp;<span class="ident" id="3460890">w</span>&nbsp;<span class="ident" id="3460892">countingWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3460908">mw</span>&nbsp;<span class="op" id="3460911">:=</span>&nbsp;<span class="ident" id="3460914">multipart</span><span class="op" id="3460923">.</span><span class="ident" id="3460924">NewWriter</span><span class="op" id="3460933">(</span><span class="op" id="3460934">&amp;</span><span class="ident" id="3460935">w</span><span class="op" id="3460936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3460939">for</span>&nbsp;<span class="ident" id="3460943">_</span><span class="op" id="3460944">,</span>&nbsp;<span class="ident" id="3460946">ra</span>&nbsp;<span class="op" id="3460949">:=</span>&nbsp;<span class="keyword" id="3460952">range</span>&nbsp;<span class="ident" id="3460958">ranges</span>&nbsp;<span class="op" id="3460965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3460969">mw</span><span class="op" id="3460971">.</span><span class="ident" id="3460972">CreatePart</span><span class="op" id="3460982">(</span><span class="ident" id="3460983">ra</span><span class="op" id="3460985">.</span><span class="ident" id="3460986">mimeHeader</span><span class="op" id="3460996">(</span><span class="ident" id="3460997">contentType</span><span class="op" id="3461008">,</span>&nbsp;<span class="ident" id="3461010">contentSize</span><span class="op" id="3461021">)</span><span class="op" id="3461022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3461026">encSize</span>&nbsp;<span class="op" id="3461034">+=</span>&nbsp;<span class="ident" id="3461037">ra</span><span class="op" id="3461039">.</span><span class="ident" id="3461040">length</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3461048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3461051">mw</span><span class="op" id="3461053">.</span><span class="ident" id="3461054">Close</span><span class="op" id="3461059">(</span><span class="op" id="3461060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3461063">encSize</span>&nbsp;<span class="op" id="3461071">+=</span>&nbsp;<span class="ident" id="3461074">int64</span><span class="op" id="3461079">(</span><span class="ident" id="3461080">w</span><span class="op" id="3461081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3461084">return</span><br>
<span class="lineno"></span><span class="op" id="3461091">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="3461094">func</span>&nbsp;<span class="ident" id="3461099">sumRangesSize</span><span class="op" id="3461112">(</span><span class="ident" id="3461113">ranges</span>&nbsp;<span class="op" id="3461120">[</span><span class="op" id="3461121">]</span><span class="ident" id="3461122">httpRange</span><span class="op" id="3461131">)</span>&nbsp;<span class="op" id="3461133">(</span><span class="ident" id="3461134">size</span>&nbsp;<span class="ident" id="3461139">int64</span><span class="op" id="3461144">)</span>&nbsp;<span class="op" id="3461146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3461149">for</span>&nbsp;<span class="ident" id="3461153">_</span><span class="op" id="3461154">,</span>&nbsp;<span class="ident" id="3461156">ra</span>&nbsp;<span class="op" id="3461159">:=</span>&nbsp;<span class="keyword" id="3461162">range</span>&nbsp;<span class="ident" id="3461168">ranges</span>&nbsp;<span class="op" id="3461175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3461179">size</span>&nbsp;<span class="op" id="3461184">+=</span>&nbsp;<span class="ident" id="3461187">ra</span><span class="op" id="3461189">.</span><span class="ident" id="3461190">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3461198">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3461201">return</span><br>
<span class="lineno"></span><span class="op" id="3461208">}</span>
</div>
</body>
</html>
