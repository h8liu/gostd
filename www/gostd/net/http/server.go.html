<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4912482">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4912537">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4912591">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4912642">//&nbsp;HTTP&nbsp;server.&nbsp;&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4912674">package</span>&nbsp;<span class="ident" id="4912682">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4912688">import</span>&nbsp;<span class="op" id="4912695">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912698">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912707">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912721">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912731">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912738">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912744">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912757">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912764">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912771">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912782">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912788">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912796">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912807">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912818">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912829">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912837">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4912852">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4912859">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4912862">//&nbsp;Errors&nbsp;introduced&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">30</span><span class="keyword" id="4912903">var</span>&nbsp;<span class="op" id="4912907">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912910">ErrWriteAfterFlush</span>&nbsp;<span class="op" id="4912929">=</span>&nbsp;<span class="ident" id="4912931">errors</span><span class="op" id="4912937">.</span><span class="ident" id="4912938">New</span><span class="op" id="4912941">(</span><span class="string" id="4912942">&#34;Conn.Write&nbsp;called&nbsp;after&nbsp;Flush&#34;</span><span class="op" id="4912973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912976">ErrBodyNotAllowed</span>&nbsp;&nbsp;<span class="op" id="4912995">=</span>&nbsp;<span class="ident" id="4912997">errors</span><span class="op" id="4913003">.</span><span class="ident" id="4913004">New</span><span class="op" id="4913007">(</span><span class="string" id="4913008">&#34;http:&nbsp;request&nbsp;method&nbsp;or&nbsp;response&nbsp;status&nbsp;code&nbsp;does&nbsp;not&nbsp;allow&nbsp;body&#34;</span><span class="op" id="4913074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913077">ErrHijacked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4913096">=</span>&nbsp;<span class="ident" id="4913098">errors</span><span class="op" id="4913104">.</span><span class="ident" id="4913105">New</span><span class="op" id="4913108">(</span><span class="string" id="4913109">&#34;Conn&nbsp;has&nbsp;been&nbsp;hijacked&#34;</span><span class="op" id="4913133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913136">ErrContentLength</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4913155">=</span>&nbsp;<span class="ident" id="4913157">errors</span><span class="op" id="4913163">.</span><span class="ident" id="4913164">New</span><span class="op" id="4913167">(</span><span class="string" id="4913168">&#34;Conn.Write&nbsp;wrote&nbsp;more&nbsp;than&nbsp;the&nbsp;declared&nbsp;Content-Length&#34;</span><span class="op" id="4913224">)</span><br>
<span class="lineno">35</span><span class="op" id="4913226">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4913229">//&nbsp;Objects&nbsp;implementing&nbsp;the&nbsp;Handler&nbsp;interface&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4913282">//&nbsp;registered&nbsp;to&nbsp;serve&nbsp;a&nbsp;particular&nbsp;path&nbsp;or&nbsp;subtree</span><br>
<span class="lineno"></span><span class="comment" id="4913334">//&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">40</span><span class="comment" id="4913357">//</span><br>
<span class="lineno"></span><span class="comment" id="4913360">//&nbsp;ServeHTTP&nbsp;should&nbsp;write&nbsp;reply&nbsp;headers&nbsp;and&nbsp;data&nbsp;to&nbsp;the&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="4913431">//&nbsp;and&nbsp;then&nbsp;return.&nbsp;&nbsp;Returning&nbsp;signals&nbsp;that&nbsp;the&nbsp;request&nbsp;is&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="4913499">//&nbsp;and&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;can&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4913562">//&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">45</span><span class="comment" id="4913581">//</span><br>
<span class="lineno"></span><span class="comment" id="4913584">//&nbsp;If&nbsp;ServeHTTP&nbsp;panics,&nbsp;the&nbsp;server&nbsp;(the&nbsp;caller&nbsp;of&nbsp;ServeHTTP)&nbsp;assumes</span><br>
<span class="lineno"></span><span class="comment" id="4913653">//&nbsp;that&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;panic&nbsp;was&nbsp;isolated&nbsp;to&nbsp;the&nbsp;active&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="4913721">//&nbsp;It&nbsp;recovers&nbsp;the&nbsp;panic,&nbsp;logs&nbsp;a&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;server&nbsp;error&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="4913791">//&nbsp;and&nbsp;hangs&nbsp;up&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">50</span><span class="comment" id="4913823">//</span><br>
<span class="lineno"></span><span class="keyword" id="4913826">type</span>&nbsp;<span class="ident" id="4913831">Handler</span>&nbsp;<span class="keyword" id="4913839">interface</span>&nbsp;<span class="op" id="4913849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913852">ServeHTTP</span><span class="op" id="4913861">(</span><span class="ident" id="4913862">ResponseWriter</span><span class="op" id="4913876">,</span>&nbsp;<span class="op" id="4913878">*</span><span class="ident" id="4913879">Request</span><span class="op" id="4913886">)</span><br>
<span class="lineno"></span><span class="op" id="4913888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="4913891">//&nbsp;A&nbsp;ResponseWriter&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4913951">//&nbsp;construct&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4913982">type</span>&nbsp;<span class="ident" id="4913987">ResponseWriter</span>&nbsp;<span class="keyword" id="4914002">interface</span>&nbsp;<span class="op" id="4914012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914015">//&nbsp;Header&nbsp;returns&nbsp;the&nbsp;header&nbsp;map&nbsp;that&nbsp;will&nbsp;be&nbsp;sent&nbsp;by&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914083">//&nbsp;Changing&nbsp;the&nbsp;header&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;WriteHeader&nbsp;(or&nbsp;Write)&nbsp;has</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914150">//&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914165">Header</span><span class="op" id="4914171">(</span><span class="op" id="4914172">)</span>&nbsp;<span class="ident" id="4914174">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914183">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;connection&nbsp;as&nbsp;part&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914253">//&nbsp;If&nbsp;WriteHeader&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;called,&nbsp;Write&nbsp;calls&nbsp;WriteHeader(http.StatusOK)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914336">//&nbsp;before&nbsp;writing&nbsp;the&nbsp;data.&nbsp;&nbsp;If&nbsp;the&nbsp;Header&nbsp;does&nbsp;not&nbsp;contain&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914399">//&nbsp;Content-Type&nbsp;line,&nbsp;Write&nbsp;adds&nbsp;a&nbsp;Content-Type&nbsp;set&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;passing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914477">//&nbsp;the&nbsp;initial&nbsp;512&nbsp;bytes&nbsp;of&nbsp;written&nbsp;data&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914541">Write</span><span class="op" id="4914546">(</span><span class="op" id="4914547">[</span><span class="op" id="4914548">]</span><span class="builtintype" id="4914549">byte</span><span class="op" id="4914553">)</span>&nbsp;<span class="op" id="4914555">(</span><span class="builtintype" id="4914556">int</span><span class="op" id="4914559">,</span>&nbsp;<span class="builtintype" id="4914561">error</span><span class="op" id="4914566">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914570">//&nbsp;WriteHeader&nbsp;sends&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;with&nbsp;status&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914634">//&nbsp;If&nbsp;WriteHeader&nbsp;is&nbsp;not&nbsp;called&nbsp;explicitly,&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914703">//&nbsp;will&nbsp;trigger&nbsp;an&nbsp;implicit&nbsp;WriteHeader(http.StatusOK).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914760">//&nbsp;Thus&nbsp;explicit&nbsp;calls&nbsp;to&nbsp;WriteHeader&nbsp;are&nbsp;mainly&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914818">//&nbsp;send&nbsp;error&nbsp;codes.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914840">WriteHeader</span><span class="op" id="4914851">(</span><span class="builtintype" id="4914852">int</span><span class="op" id="4914855">)</span><br>
<span class="lineno"></span><span class="op" id="4914857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4914860">//&nbsp;The&nbsp;Flusher&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="4914930">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;flush&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno">80</span><span class="comment" id="4914987">//</span><br>
<span class="lineno"></span><span class="comment" id="4914990">//&nbsp;Note&nbsp;that&nbsp;even&nbsp;for&nbsp;ResponseWriters&nbsp;that&nbsp;support&nbsp;Flush,</span><br>
<span class="lineno"></span><span class="comment" id="4915048">//&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;connected&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="4915101">//&nbsp;the&nbsp;buffered&nbsp;data&nbsp;may&nbsp;not&nbsp;reach&nbsp;the&nbsp;client&nbsp;until&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="4915166">//&nbsp;completes.</span><br>
<span class="lineno">85</span><span class="keyword" id="4915180">type</span>&nbsp;<span class="ident" id="4915185">Flusher</span>&nbsp;<span class="keyword" id="4915193">interface</span>&nbsp;<span class="op" id="4915203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4915206">//&nbsp;Flush&nbsp;sends&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4915255">Flush</span><span class="op" id="4915260">(</span><span class="op" id="4915261">)</span><br>
<span class="lineno"></span><span class="op" id="4915263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="4915266">//&nbsp;The&nbsp;Hijacker&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="4915337">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4915385">type</span>&nbsp;<span class="ident" id="4915390">Hijacker</span>&nbsp;<span class="keyword" id="4915399">interface</span>&nbsp;<span class="op" id="4915409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4915412">//&nbsp;Hijack&nbsp;lets&nbsp;the&nbsp;caller&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4915465">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Hijack(),&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;library</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4915519">//&nbsp;will&nbsp;not&nbsp;do&nbsp;anything&nbsp;else&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4915570">//&nbsp;It&nbsp;becomes&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;manage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4915623">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4915653">Hijack</span><span class="op" id="4915659">(</span><span class="op" id="4915660">)</span>&nbsp;<span class="op" id="4915662">(</span><span class="ident" id="4915663">net</span><span class="op" id="4915666">.</span><span class="ident" id="4915667">Conn</span><span class="op" id="4915671">,</span>&nbsp;<span class="op" id="4915673">*</span><span class="ident" id="4915674">bufio</span><span class="op" id="4915679">.</span><span class="ident" id="4915680">ReadWriter</span><span class="op" id="4915690">,</span>&nbsp;<span class="builtintype" id="4915692">error</span><span class="op" id="4915697">)</span><br>
<span class="lineno"></span><span class="op" id="4915699">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="4915702">//&nbsp;The&nbsp;CloseNotifier&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="4915773">//&nbsp;allow&nbsp;detecting&nbsp;when&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span><span class="comment" id="4915838">//</span><br>
<span class="lineno"></span><span class="comment" id="4915841">//&nbsp;This&nbsp;mechanism&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;cancel&nbsp;long&nbsp;operations&nbsp;on&nbsp;the&nbsp;server</span><br>
<span class="lineno">105</span><span class="comment" id="4915911">//&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;before&nbsp;the&nbsp;response&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="4915975">type</span>&nbsp;<span class="ident" id="4915980">CloseNotifier</span>&nbsp;<span class="keyword" id="4915994">interface</span>&nbsp;<span class="op" id="4916004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4916007">//&nbsp;CloseNotify&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;receives&nbsp;a&nbsp;single&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4916070">//&nbsp;when&nbsp;the&nbsp;client&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916116">CloseNotify</span><span class="op" id="4916127">(</span><span class="op" id="4916128">)</span>&nbsp;<span class="op" id="4916130">&lt;-</span><span class="keyword" id="4916132">chan</span>&nbsp;<span class="builtintype" id="4916137">bool</span><br>
<span class="lineno">110</span><span class="op" id="4916142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4916145">//&nbsp;A&nbsp;conn&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4916205">type</span>&nbsp;<span class="ident" id="4916210">conn</span>&nbsp;<span class="keyword" id="4916215">struct</span>&nbsp;<span class="op" id="4916222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916225">remoteAddr</span>&nbsp;<span class="builtintype" id="4916236">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4916257">//&nbsp;network&nbsp;address&nbsp;of&nbsp;remote&nbsp;side</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916292">server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4916303">*</span><span class="ident" id="4916304">Server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4916324">//&nbsp;the&nbsp;Server&nbsp;on&nbsp;which&nbsp;the&nbsp;connection&nbsp;arrived</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916371">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4916382">net</span><span class="op" id="4916385">.</span><span class="ident" id="4916386">Conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4916403">//&nbsp;i/o&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916422">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4916433">io</span><span class="op" id="4916435">.</span><span class="ident" id="4916436">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4916454">//&nbsp;checkConnErrorWriter&#39;s&nbsp;copy&nbsp;of&nbsp;wrc,&nbsp;not&nbsp;zeroed&nbsp;on&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916515">werr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4916526">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4916547">//&nbsp;any&nbsp;errors&nbsp;writing&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916575">sr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4916586">liveSwitchReader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4916607">//&nbsp;where&nbsp;the&nbsp;LimitReader&nbsp;reads&nbsp;from;&nbsp;usually&nbsp;the&nbsp;rwc</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916661">lr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4916672">*</span><span class="ident" id="4916673">io</span><span class="op" id="4916675">.</span><span class="ident" id="4916676">LimitedReader</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4916693">//&nbsp;io.LimitReader(sr)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916716">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4916727">*</span><span class="ident" id="4916728">bufio</span><span class="op" id="4916733">.</span><span class="ident" id="4916734">ReadWriter</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4916748">//&nbsp;buffered(lr,rwc),&nbsp;reading&nbsp;from&nbsp;bufio-&gt;limitReader-&gt;sr-&gt;rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916811">tlsState</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4916822">*</span><span class="ident" id="4916823">tls</span><span class="op" id="4916826">.</span><span class="ident" id="4916827">ConnectionState</span>&nbsp;<span class="comment" id="4916843">//&nbsp;or&nbsp;nil&nbsp;when&nbsp;not&nbsp;using&nbsp;TLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916874">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4916887">sync</span><span class="op" id="4916891">.</span><span class="ident" id="4916892">Mutex</span>&nbsp;<span class="comment" id="4916898">//&nbsp;guards&nbsp;the&nbsp;following</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916923">clientGone</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4916936">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4916947">//&nbsp;if&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;mid-request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916990">closeNotifyc</span>&nbsp;<span class="keyword" id="4917003">chan</span>&nbsp;<span class="builtintype" id="4917008">bool</span>&nbsp;&nbsp;<span class="comment" id="4917014">//&nbsp;made&nbsp;lazily</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917030">hijackedv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4917043">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4917054">//&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked&nbsp;by&nbsp;handler</span><br>
<span class="lineno"></span><span class="op" id="4917097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="4917100">func</span>&nbsp;<span class="op" id="4917105">(</span><span class="ident" id="4917106">c</span>&nbsp;<span class="op" id="4917108">*</span><span class="ident" id="4917109">conn</span><span class="op" id="4917113">)</span>&nbsp;<span class="ident" id="4917115">hijacked</span><span class="op" id="4917123">(</span><span class="op" id="4917124">)</span>&nbsp;<span class="builtintype" id="4917126">bool</span>&nbsp;<span class="op" id="4917131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917134">c</span><span class="op" id="4917135">.</span><span class="ident" id="4917136">mu</span><span class="op" id="4917138">.</span><span class="ident" id="4917139">Lock</span><span class="op" id="4917143">(</span><span class="op" id="4917144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917147">defer</span>&nbsp;<span class="ident" id="4917153">c</span><span class="op" id="4917154">.</span><span class="ident" id="4917155">mu</span><span class="op" id="4917157">.</span><span class="ident" id="4917158">Unlock</span><span class="op" id="4917164">(</span><span class="op" id="4917165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917168">return</span>&nbsp;<span class="ident" id="4917175">c</span><span class="op" id="4917176">.</span><span class="ident" id="4917177">hijackedv</span><br>
<span class="lineno"></span><span class="op" id="4917187">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="4917190">func</span>&nbsp;<span class="op" id="4917195">(</span><span class="ident" id="4917196">c</span>&nbsp;<span class="op" id="4917198">*</span><span class="ident" id="4917199">conn</span><span class="op" id="4917203">)</span>&nbsp;<span class="ident" id="4917205">hijack</span><span class="op" id="4917211">(</span><span class="op" id="4917212">)</span>&nbsp;<span class="op" id="4917214">(</span><span class="ident" id="4917215">rwc</span>&nbsp;<span class="ident" id="4917219">net</span><span class="op" id="4917222">.</span><span class="ident" id="4917223">Conn</span><span class="op" id="4917227">,</span>&nbsp;<span class="ident" id="4917229">buf</span>&nbsp;<span class="op" id="4917233">*</span><span class="ident" id="4917234">bufio</span><span class="op" id="4917239">.</span><span class="ident" id="4917240">ReadWriter</span><span class="op" id="4917250">,</span>&nbsp;<span class="ident" id="4917252">err</span>&nbsp;<span class="builtintype" id="4917256">error</span><span class="op" id="4917261">)</span>&nbsp;<span class="op" id="4917263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917266">c</span><span class="op" id="4917267">.</span><span class="ident" id="4917268">mu</span><span class="op" id="4917270">.</span><span class="ident" id="4917271">Lock</span><span class="op" id="4917275">(</span><span class="op" id="4917276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917279">defer</span>&nbsp;<span class="ident" id="4917285">c</span><span class="op" id="4917286">.</span><span class="ident" id="4917287">mu</span><span class="op" id="4917289">.</span><span class="ident" id="4917290">Unlock</span><span class="op" id="4917296">(</span><span class="op" id="4917297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917300">if</span>&nbsp;<span class="ident" id="4917303">c</span><span class="op" id="4917304">.</span><span class="ident" id="4917305">hijackedv</span>&nbsp;<span class="op" id="4917315">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917319">return</span>&nbsp;<span class="ident" id="4917326">nil</span><span class="op" id="4917329">,</span>&nbsp;<span class="ident" id="4917331">nil</span><span class="op" id="4917334">,</span>&nbsp;<span class="ident" id="4917336">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4917349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917352">if</span>&nbsp;<span class="ident" id="4917355">c</span><span class="op" id="4917356">.</span><span class="ident" id="4917357">closeNotifyc</span>&nbsp;<span class="op" id="4917370">!=</span>&nbsp;<span class="ident" id="4917373">nil</span>&nbsp;<span class="op" id="4917377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917381">return</span>&nbsp;<span class="ident" id="4917388">nil</span><span class="op" id="4917391">,</span>&nbsp;<span class="ident" id="4917393">nil</span><span class="op" id="4917396">,</span>&nbsp;<span class="ident" id="4917398">errors</span><span class="op" id="4917404">.</span><span class="ident" id="4917405">New</span><span class="op" id="4917408">(</span><span class="string" id="4917409">&#34;http:&nbsp;Hijack&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;use&nbsp;of&nbsp;CloseNotifier&#34;</span><span class="op" id="4917465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4917468">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917471">c</span><span class="op" id="4917472">.</span><span class="ident" id="4917473">hijackedv</span>&nbsp;<span class="op" id="4917483">=</span>&nbsp;<span class="builtintype" id="4917485">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917491">rwc</span>&nbsp;<span class="op" id="4917495">=</span>&nbsp;<span class="ident" id="4917497">c</span><span class="op" id="4917498">.</span><span class="ident" id="4917499">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917504">buf</span>&nbsp;<span class="op" id="4917508">=</span>&nbsp;<span class="ident" id="4917510">c</span><span class="op" id="4917511">.</span><span class="ident" id="4917512">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917517">c</span><span class="op" id="4917518">.</span><span class="ident" id="4917519">rwc</span>&nbsp;<span class="op" id="4917523">=</span>&nbsp;<span class="ident" id="4917525">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917530">c</span><span class="op" id="4917531">.</span><span class="ident" id="4917532">buf</span>&nbsp;<span class="op" id="4917536">=</span>&nbsp;<span class="ident" id="4917538">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917543">c</span><span class="op" id="4917544">.</span><span class="ident" id="4917545">setState</span><span class="op" id="4917553">(</span><span class="ident" id="4917554">rwc</span><span class="op" id="4917557">,</span>&nbsp;<span class="ident" id="4917559">StateHijacked</span><span class="op" id="4917572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917575">return</span><br>
<span class="lineno"></span><span class="op" id="4917582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4917585">func</span>&nbsp;<span class="op" id="4917590">(</span><span class="ident" id="4917591">c</span>&nbsp;<span class="op" id="4917593">*</span><span class="ident" id="4917594">conn</span><span class="op" id="4917598">)</span>&nbsp;<span class="ident" id="4917600">closeNotify</span><span class="op" id="4917611">(</span><span class="op" id="4917612">)</span>&nbsp;<span class="op" id="4917614">&lt;-</span><span class="keyword" id="4917616">chan</span>&nbsp;<span class="builtintype" id="4917621">bool</span>&nbsp;<span class="op" id="4917626">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917629">c</span><span class="op" id="4917630">.</span><span class="ident" id="4917631">mu</span><span class="op" id="4917633">.</span><span class="ident" id="4917634">Lock</span><span class="op" id="4917638">(</span><span class="op" id="4917639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917642">defer</span>&nbsp;<span class="ident" id="4917648">c</span><span class="op" id="4917649">.</span><span class="ident" id="4917650">mu</span><span class="op" id="4917652">.</span><span class="ident" id="4917653">Unlock</span><span class="op" id="4917659">(</span><span class="op" id="4917660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917663">if</span>&nbsp;<span class="ident" id="4917666">c</span><span class="op" id="4917667">.</span><span class="ident" id="4917668">closeNotifyc</span>&nbsp;<span class="op" id="4917681">==</span>&nbsp;<span class="ident" id="4917684">nil</span>&nbsp;<span class="op" id="4917688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917692">c</span><span class="op" id="4917693">.</span><span class="ident" id="4917694">closeNotifyc</span>&nbsp;<span class="op" id="4917707">=</span>&nbsp;<span class="builtinfunc" id="4917709">make</span><span class="op" id="4917713">(</span><span class="keyword" id="4917714">chan</span>&nbsp;<span class="builtintype" id="4917719">bool</span><span class="op" id="4917723">,</span>&nbsp;<span class="num" id="4917725">1</span><span class="op" id="4917726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917730">if</span>&nbsp;<span class="ident" id="4917733">c</span><span class="op" id="4917734">.</span><span class="ident" id="4917735">hijackedv</span>&nbsp;<span class="op" id="4917745">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4917750">//&nbsp;to&nbsp;obey&nbsp;the&nbsp;function&nbsp;signature,&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4917800">//&nbsp;it&#39;ll&nbsp;never&nbsp;receive&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917835">return</span>&nbsp;<span class="ident" id="4917842">c</span><span class="op" id="4917843">.</span><span class="ident" id="4917844">closeNotifyc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4917859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917863">pr</span><span class="op" id="4917865">,</span>&nbsp;<span class="ident" id="4917867">pw</span>&nbsp;<span class="op" id="4917870">:=</span>&nbsp;<span class="ident" id="4917873">io</span><span class="op" id="4917875">.</span><span class="ident" id="4917876">Pipe</span><span class="op" id="4917880">(</span><span class="op" id="4917881">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917886">readSource</span>&nbsp;<span class="op" id="4917897">:=</span>&nbsp;<span class="ident" id="4917900">c</span><span class="op" id="4917901">.</span><span class="ident" id="4917902">sr</span><span class="op" id="4917904">.</span><span class="ident" id="4917905">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917909">c</span><span class="op" id="4917910">.</span><span class="ident" id="4917911">sr</span><span class="op" id="4917913">.</span><span class="ident" id="4917914">Lock</span><span class="op" id="4917918">(</span><span class="op" id="4917919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917923">c</span><span class="op" id="4917924">.</span><span class="ident" id="4917925">sr</span><span class="op" id="4917927">.</span><span class="ident" id="4917928">r</span>&nbsp;<span class="op" id="4917930">=</span>&nbsp;<span class="ident" id="4917932">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917937">c</span><span class="op" id="4917938">.</span><span class="ident" id="4917939">sr</span><span class="op" id="4917941">.</span><span class="ident" id="4917942">Unlock</span><span class="op" id="4917948">(</span><span class="op" id="4917949">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917953">go</span>&nbsp;<span class="keyword" id="4917956">func</span><span class="op" id="4917960">(</span><span class="op" id="4917961">)</span>&nbsp;<span class="op" id="4917963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917968">_</span><span class="op" id="4917969">,</span>&nbsp;<span class="ident" id="4917971">err</span>&nbsp;<span class="op" id="4917975">:=</span>&nbsp;<span class="ident" id="4917978">io</span><span class="op" id="4917980">.</span><span class="ident" id="4917981">Copy</span><span class="op" id="4917985">(</span><span class="ident" id="4917986">pw</span><span class="op" id="4917988">,</span>&nbsp;<span class="ident" id="4917990">readSource</span><span class="op" id="4918000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4918005">if</span>&nbsp;<span class="ident" id="4918008">err</span>&nbsp;<span class="op" id="4918012">==</span>&nbsp;<span class="ident" id="4918015">nil</span>&nbsp;<span class="op" id="4918019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918025">err</span>&nbsp;<span class="op" id="4918029">=</span>&nbsp;<span class="ident" id="4918031">io</span><span class="op" id="4918033">.</span><span class="ident" id="4918034">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4918041">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918046">pw</span><span class="op" id="4918048">.</span><span class="ident" id="4918049">CloseWithError</span><span class="op" id="4918063">(</span><span class="ident" id="4918064">err</span><span class="op" id="4918067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918072">c</span><span class="op" id="4918073">.</span><span class="ident" id="4918074">noteClientGone</span><span class="op" id="4918088">(</span><span class="op" id="4918089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4918093">}</span><span class="op" id="4918094">(</span><span class="op" id="4918095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4918098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4918101">return</span>&nbsp;<span class="ident" id="4918108">c</span><span class="op" id="4918109">.</span><span class="ident" id="4918110">closeNotifyc</span><br>
<span class="lineno">180</span><span class="op" id="4918123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4918126">func</span>&nbsp;<span class="op" id="4918131">(</span><span class="ident" id="4918132">c</span>&nbsp;<span class="op" id="4918134">*</span><span class="ident" id="4918135">conn</span><span class="op" id="4918139">)</span>&nbsp;<span class="ident" id="4918141">noteClientGone</span><span class="op" id="4918155">(</span><span class="op" id="4918156">)</span>&nbsp;<span class="op" id="4918158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918161">c</span><span class="op" id="4918162">.</span><span class="ident" id="4918163">mu</span><span class="op" id="4918165">.</span><span class="ident" id="4918166">Lock</span><span class="op" id="4918170">(</span><span class="op" id="4918171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4918174">defer</span>&nbsp;<span class="ident" id="4918180">c</span><span class="op" id="4918181">.</span><span class="ident" id="4918182">mu</span><span class="op" id="4918184">.</span><span class="ident" id="4918185">Unlock</span><span class="op" id="4918191">(</span><span class="op" id="4918192">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4918195">if</span>&nbsp;<span class="ident" id="4918198">c</span><span class="op" id="4918199">.</span><span class="ident" id="4918200">closeNotifyc</span>&nbsp;<span class="op" id="4918213">!=</span>&nbsp;<span class="ident" id="4918216">nil</span>&nbsp;<span class="op" id="4918220">&amp;&amp;</span>&nbsp;<span class="op" id="4918223">!</span><span class="ident" id="4918224">c</span><span class="op" id="4918225">.</span><span class="ident" id="4918226">clientGone</span>&nbsp;<span class="op" id="4918237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918241">c</span><span class="op" id="4918242">.</span><span class="ident" id="4918243">closeNotifyc</span>&nbsp;<span class="op" id="4918256">&lt;-</span>&nbsp;<span class="builtintype" id="4918259">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4918265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918268">c</span><span class="op" id="4918269">.</span><span class="ident" id="4918270">clientGone</span>&nbsp;<span class="op" id="4918281">=</span>&nbsp;<span class="builtintype" id="4918283">true</span><br>
<span class="lineno"></span><span class="op" id="4918288">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="4918291">//&nbsp;A&nbsp;switchReader&nbsp;can&nbsp;have&nbsp;its&nbsp;Reader&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="4918349">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Reads&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="4918401">type</span>&nbsp;<span class="ident" id="4918406">switchReader</span>&nbsp;<span class="keyword" id="4918419">struct</span>&nbsp;<span class="op" id="4918426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918429">io</span><span class="op" id="4918431">.</span><span class="ident" id="4918432">Reader</span><br>
<span class="lineno">195</span><span class="op" id="4918439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4918442">//&nbsp;A&nbsp;switchWriter&nbsp;can&nbsp;have&nbsp;its&nbsp;Writer&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="4918500">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Writes&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="4918553">type</span>&nbsp;<span class="ident" id="4918558">switchWriter</span>&nbsp;<span class="keyword" id="4918571">struct</span>&nbsp;<span class="op" id="4918578">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918581">io</span><span class="op" id="4918583">.</span><span class="ident" id="4918584">Writer</span><br>
<span class="lineno"></span><span class="op" id="4918591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4918594">//&nbsp;A&nbsp;liveSwitchReader&nbsp;is&nbsp;a&nbsp;switchReader&nbsp;that&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent</span><br>
<span class="lineno"></span><span class="comment" id="4918661">//&nbsp;reads&nbsp;and&nbsp;switches,&nbsp;if&nbsp;its&nbsp;mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno">205</span><span class="keyword" id="4918706">type</span>&nbsp;<span class="ident" id="4918711">liveSwitchReader</span>&nbsp;<span class="keyword" id="4918728">struct</span>&nbsp;<span class="op" id="4918735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918738">sync</span><span class="op" id="4918742">.</span><span class="ident" id="4918743">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918750">r</span>&nbsp;<span class="ident" id="4918752">io</span><span class="op" id="4918754">.</span><span class="ident" id="4918755">Reader</span><br>
<span class="lineno"></span><span class="op" id="4918762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword" id="4918765">func</span>&nbsp;<span class="op" id="4918770">(</span><span class="ident" id="4918771">sr</span>&nbsp;<span class="op" id="4918774">*</span><span class="ident" id="4918775">liveSwitchReader</span><span class="op" id="4918791">)</span>&nbsp;<span class="ident" id="4918793">Read</span><span class="op" id="4918797">(</span><span class="ident" id="4918798">p</span>&nbsp;<span class="op" id="4918800">[</span><span class="op" id="4918801">]</span><span class="builtintype" id="4918802">byte</span><span class="op" id="4918806">)</span>&nbsp;<span class="op" id="4918808">(</span><span class="ident" id="4918809">n</span>&nbsp;<span class="builtintype" id="4918811">int</span><span class="op" id="4918814">,</span>&nbsp;<span class="ident" id="4918816">err</span>&nbsp;<span class="builtintype" id="4918820">error</span><span class="op" id="4918825">)</span>&nbsp;<span class="op" id="4918827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918830">sr</span><span class="op" id="4918832">.</span><span class="ident" id="4918833">Lock</span><span class="op" id="4918837">(</span><span class="op" id="4918838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918841">r</span>&nbsp;<span class="op" id="4918843">:=</span>&nbsp;<span class="ident" id="4918846">sr</span><span class="op" id="4918848">.</span><span class="ident" id="4918849">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918852">sr</span><span class="op" id="4918854">.</span><span class="ident" id="4918855">Unlock</span><span class="op" id="4918861">(</span><span class="op" id="4918862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4918865">return</span>&nbsp;<span class="ident" id="4918872">r</span><span class="op" id="4918873">.</span><span class="ident" id="4918874">Read</span><span class="op" id="4918878">(</span><span class="ident" id="4918879">p</span><span class="op" id="4918880">)</span><br>
<span class="lineno">215</span><span class="op" id="4918882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4918885">//&nbsp;This&nbsp;should&nbsp;be&nbsp;&gt;=&nbsp;512&nbsp;bytes&nbsp;for&nbsp;DetectContentType,</span><br>
<span class="lineno"></span><span class="comment" id="4918939">//&nbsp;but&nbsp;otherwise&nbsp;it&#39;s&nbsp;somewhat&nbsp;arbitrary.</span><br>
<span class="lineno"></span><span class="keyword" id="4918981">const</span>&nbsp;<span class="ident" id="4918987">bufferBeforeChunkingSize</span>&nbsp;<span class="op" id="4919012">=</span>&nbsp;<span class="num" id="4919014">2048</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="4919020">//&nbsp;chunkWriter&nbsp;writes&nbsp;to&nbsp;a&nbsp;response&#39;s&nbsp;conn&nbsp;buffer,&nbsp;and&nbsp;is&nbsp;the&nbsp;writer</span><br>
<span class="lineno"></span><span class="comment" id="4919089">//&nbsp;wrapped&nbsp;by&nbsp;the&nbsp;response.bufw&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="4919138">//</span><br>
<span class="lineno"></span><span class="comment" id="4919141">//&nbsp;chunkWriter&nbsp;also&nbsp;is&nbsp;responsible&nbsp;for&nbsp;finalizing&nbsp;the&nbsp;Header,&nbsp;including</span><br>
<span class="lineno">225</span><span class="comment" id="4919213">//&nbsp;conditionally&nbsp;setting&nbsp;the&nbsp;Content-Type&nbsp;and&nbsp;setting&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span><span class="comment" id="4919284">//&nbsp;in&nbsp;cases&nbsp;where&nbsp;the&nbsp;handler&#39;s&nbsp;final&nbsp;output&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="4919356">//&nbsp;size.&nbsp;It&nbsp;also&nbsp;conditionally&nbsp;adds&nbsp;chunk&nbsp;headers,&nbsp;when&nbsp;in&nbsp;chunking&nbsp;mode.</span><br>
<span class="lineno"></span><span class="comment" id="4919430">//</span><br>
<span class="lineno"></span><span class="comment" id="4919433">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;above&nbsp;(*response).Write&nbsp;for&nbsp;the&nbsp;entire&nbsp;write&nbsp;flow.</span><br>
<span class="lineno">230</span><span class="keyword" id="4919503">type</span>&nbsp;<span class="ident" id="4919508">chunkWriter</span>&nbsp;<span class="keyword" id="4919520">struct</span>&nbsp;<span class="op" id="4919527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919530">res</span>&nbsp;<span class="op" id="4919534">*</span><span class="ident" id="4919535">response</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4919546">//&nbsp;header&nbsp;is&nbsp;either&nbsp;nil&nbsp;or&nbsp;a&nbsp;deep&nbsp;clone&nbsp;of&nbsp;res.handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4919608">//&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;res.WriteHeader,&nbsp;if&nbsp;res.WriteHeader&nbsp;is</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4919666">//&nbsp;called&nbsp;and&nbsp;extra&nbsp;buffering&nbsp;is&nbsp;being&nbsp;done&nbsp;to&nbsp;calculate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4919724">//&nbsp;Content-Type&nbsp;and/or&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919764">header</span>&nbsp;<span class="ident" id="4919771">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4919780">//&nbsp;wroteHeader&nbsp;tells&nbsp;whether&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;written&nbsp;to&nbsp;&#34;the</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4919844">//&nbsp;wire&#34;&nbsp;(or&nbsp;rather:&nbsp;w.conn.buf).&nbsp;this&nbsp;is&nbsp;unlike</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4919894">//&nbsp;(*response).wroteHeader,&nbsp;which&nbsp;tells&nbsp;only&nbsp;whether&nbsp;it&nbsp;was</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4919955">//&nbsp;logically&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919978">wroteHeader</span>&nbsp;<span class="builtintype" id="4919990">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4919997">//&nbsp;set&nbsp;by&nbsp;the&nbsp;writeHeader&nbsp;method:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920032">chunking</span>&nbsp;<span class="builtintype" id="4920041">bool</span>&nbsp;<span class="comment" id="4920046">//&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding&nbsp;for&nbsp;reply&nbsp;body</span><br>
<span class="lineno"></span><span class="op" id="4920096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4920099">var</span>&nbsp;<span class="op" id="4920103">(</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920106">crlf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4920117">=</span>&nbsp;<span class="op" id="4920119">[</span><span class="op" id="4920120">]</span><span class="builtintype" id="4920121">byte</span><span class="op" id="4920125">(</span><span class="string" id="4920126">&#34;\r\n&#34;</span><span class="op" id="4920132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920135">colonSpace</span>&nbsp;<span class="op" id="4920146">=</span>&nbsp;<span class="op" id="4920148">[</span><span class="op" id="4920149">]</span><span class="builtintype" id="4920150">byte</span><span class="op" id="4920154">(</span><span class="string" id="4920155">&#34;:&nbsp;&#34;</span><span class="op" id="4920159">)</span><br>
<span class="lineno"></span><span class="op" id="4920161">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4920164">func</span>&nbsp;<span class="op" id="4920169">(</span><span class="ident" id="4920170">cw</span>&nbsp;<span class="op" id="4920173">*</span><span class="ident" id="4920174">chunkWriter</span><span class="op" id="4920185">)</span>&nbsp;<span class="ident" id="4920187">Write</span><span class="op" id="4920192">(</span><span class="ident" id="4920193">p</span>&nbsp;<span class="op" id="4920195">[</span><span class="op" id="4920196">]</span><span class="builtintype" id="4920197">byte</span><span class="op" id="4920201">)</span>&nbsp;<span class="op" id="4920203">(</span><span class="ident" id="4920204">n</span>&nbsp;<span class="builtintype" id="4920206">int</span><span class="op" id="4920209">,</span>&nbsp;<span class="ident" id="4920211">err</span>&nbsp;<span class="builtintype" id="4920215">error</span><span class="op" id="4920220">)</span>&nbsp;<span class="op" id="4920222">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920225">if</span>&nbsp;<span class="op" id="4920228">!</span><span class="ident" id="4920229">cw</span><span class="op" id="4920231">.</span><span class="ident" id="4920232">wroteHeader</span>&nbsp;<span class="op" id="4920244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920248">cw</span><span class="op" id="4920250">.</span><span class="ident" id="4920251">writeHeader</span><span class="op" id="4920262">(</span><span class="ident" id="4920263">p</span><span class="op" id="4920264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920270">if</span>&nbsp;<span class="ident" id="4920273">cw</span><span class="op" id="4920275">.</span><span class="ident" id="4920276">res</span><span class="op" id="4920279">.</span><span class="ident" id="4920280">req</span><span class="op" id="4920283">.</span><span class="ident" id="4920284">Method</span>&nbsp;<span class="op" id="4920291">==</span>&nbsp;<span class="string" id="4920294">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4920301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4920305">//&nbsp;Eat&nbsp;writes.</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920322">return</span>&nbsp;<span class="builtinfunc" id="4920329">len</span><span class="op" id="4920332">(</span><span class="ident" id="4920333">p</span><span class="op" id="4920334">)</span><span class="op" id="4920335">,</span>&nbsp;<span class="ident" id="4920337">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920345">if</span>&nbsp;<span class="ident" id="4920348">cw</span><span class="op" id="4920350">.</span><span class="ident" id="4920351">chunking</span>&nbsp;<span class="op" id="4920360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920364">_</span><span class="op" id="4920365">,</span>&nbsp;<span class="ident" id="4920367">err</span>&nbsp;<span class="op" id="4920371">=</span>&nbsp;<span class="ident" id="4920373">fmt</span><span class="op" id="4920376">.</span><span class="ident" id="4920377">Fprintf</span><span class="op" id="4920384">(</span><span class="ident" id="4920385">cw</span><span class="op" id="4920387">.</span><span class="ident" id="4920388">res</span><span class="op" id="4920391">.</span><span class="ident" id="4920392">conn</span><span class="op" id="4920396">.</span><span class="ident" id="4920397">buf</span><span class="op" id="4920400">,</span>&nbsp;<span class="string" id="4920402">&#34;%x\r\n&#34;</span><span class="op" id="4920410">,</span>&nbsp;<span class="builtinfunc" id="4920412">len</span><span class="op" id="4920415">(</span><span class="ident" id="4920416">p</span><span class="op" id="4920417">)</span><span class="op" id="4920418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920422">if</span>&nbsp;<span class="ident" id="4920425">err</span>&nbsp;<span class="op" id="4920429">!=</span>&nbsp;<span class="ident" id="4920432">nil</span>&nbsp;<span class="op" id="4920436">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920441">cw</span><span class="op" id="4920443">.</span><span class="ident" id="4920444">res</span><span class="op" id="4920447">.</span><span class="ident" id="4920448">conn</span><span class="op" id="4920452">.</span><span class="ident" id="4920453">rwc</span><span class="op" id="4920456">.</span><span class="ident" id="4920457">Close</span><span class="op" id="4920462">(</span><span class="op" id="4920463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920468">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920483">n</span><span class="op" id="4920484">,</span>&nbsp;<span class="ident" id="4920486">err</span>&nbsp;<span class="op" id="4920490">=</span>&nbsp;<span class="ident" id="4920492">cw</span><span class="op" id="4920494">.</span><span class="ident" id="4920495">res</span><span class="op" id="4920498">.</span><span class="ident" id="4920499">conn</span><span class="op" id="4920503">.</span><span class="ident" id="4920504">buf</span><span class="op" id="4920507">.</span><span class="ident" id="4920508">Write</span><span class="op" id="4920513">(</span><span class="ident" id="4920514">p</span><span class="op" id="4920515">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920518">if</span>&nbsp;<span class="ident" id="4920521">cw</span><span class="op" id="4920523">.</span><span class="ident" id="4920524">chunking</span>&nbsp;<span class="op" id="4920533">&amp;&amp;</span>&nbsp;<span class="ident" id="4920536">err</span>&nbsp;<span class="op" id="4920540">==</span>&nbsp;<span class="ident" id="4920543">nil</span>&nbsp;<span class="op" id="4920547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920551">_</span><span class="op" id="4920552">,</span>&nbsp;<span class="ident" id="4920554">err</span>&nbsp;<span class="op" id="4920558">=</span>&nbsp;<span class="ident" id="4920560">cw</span><span class="op" id="4920562">.</span><span class="ident" id="4920563">res</span><span class="op" id="4920566">.</span><span class="ident" id="4920567">conn</span><span class="op" id="4920571">.</span><span class="ident" id="4920572">buf</span><span class="op" id="4920575">.</span><span class="ident" id="4920576">Write</span><span class="op" id="4920581">(</span><span class="ident" id="4920582">crlf</span><span class="op" id="4920586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920592">if</span>&nbsp;<span class="ident" id="4920595">err</span>&nbsp;<span class="op" id="4920599">!=</span>&nbsp;<span class="ident" id="4920602">nil</span>&nbsp;<span class="op" id="4920606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920610">cw</span><span class="op" id="4920612">.</span><span class="ident" id="4920613">res</span><span class="op" id="4920616">.</span><span class="ident" id="4920617">conn</span><span class="op" id="4920621">.</span><span class="ident" id="4920622">rwc</span><span class="op" id="4920625">.</span><span class="ident" id="4920626">Close</span><span class="op" id="4920631">(</span><span class="op" id="4920632">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920638">return</span><br>
<span class="lineno"></span><span class="op" id="4920645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4920648">func</span>&nbsp;<span class="op" id="4920653">(</span><span class="ident" id="4920654">cw</span>&nbsp;<span class="op" id="4920657">*</span><span class="ident" id="4920658">chunkWriter</span><span class="op" id="4920669">)</span>&nbsp;<span class="ident" id="4920671">flush</span><span class="op" id="4920676">(</span><span class="op" id="4920677">)</span>&nbsp;<span class="op" id="4920679">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920682">if</span>&nbsp;<span class="op" id="4920685">!</span><span class="ident" id="4920686">cw</span><span class="op" id="4920688">.</span><span class="ident" id="4920689">wroteHeader</span>&nbsp;<span class="op" id="4920701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920705">cw</span><span class="op" id="4920707">.</span><span class="ident" id="4920708">writeHeader</span><span class="op" id="4920719">(</span><span class="ident" id="4920720">nil</span><span class="op" id="4920723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920729">cw</span><span class="op" id="4920731">.</span><span class="ident" id="4920732">res</span><span class="op" id="4920735">.</span><span class="ident" id="4920736">conn</span><span class="op" id="4920740">.</span><span class="ident" id="4920741">buf</span><span class="op" id="4920744">.</span><span class="ident" id="4920745">Flush</span><span class="op" id="4920750">(</span><span class="op" id="4920751">)</span><br>
<span class="lineno"></span><span class="op" id="4920753">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="4920756">func</span>&nbsp;<span class="op" id="4920761">(</span><span class="ident" id="4920762">cw</span>&nbsp;<span class="op" id="4920765">*</span><span class="ident" id="4920766">chunkWriter</span><span class="op" id="4920777">)</span>&nbsp;<span class="builtinfunc" id="4920779">close</span><span class="op" id="4920784">(</span><span class="op" id="4920785">)</span>&nbsp;<span class="op" id="4920787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920790">if</span>&nbsp;<span class="op" id="4920793">!</span><span class="ident" id="4920794">cw</span><span class="op" id="4920796">.</span><span class="ident" id="4920797">wroteHeader</span>&nbsp;<span class="op" id="4920809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920813">cw</span><span class="op" id="4920815">.</span><span class="ident" id="4920816">writeHeader</span><span class="op" id="4920827">(</span><span class="ident" id="4920828">nil</span><span class="op" id="4920831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920834">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920837">if</span>&nbsp;<span class="ident" id="4920840">cw</span><span class="op" id="4920842">.</span><span class="ident" id="4920843">chunking</span>&nbsp;<span class="op" id="4920852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4920856">//&nbsp;zero&nbsp;EOF&nbsp;chunk,&nbsp;trailer&nbsp;key/value&nbsp;pairs&nbsp;(currently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4920912">//&nbsp;unsupported&nbsp;in&nbsp;Go&#39;s&nbsp;server),&nbsp;followed&nbsp;by&nbsp;a&nbsp;blank</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4920966">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920977">cw</span><span class="op" id="4920979">.</span><span class="ident" id="4920980">res</span><span class="op" id="4920983">.</span><span class="ident" id="4920984">conn</span><span class="op" id="4920988">.</span><span class="ident" id="4920989">buf</span><span class="op" id="4920992">.</span><span class="ident" id="4920993">WriteString</span><span class="op" id="4921004">(</span><span class="string" id="4921005">&#34;0\r\n\r\n&#34;</span><span class="op" id="4921016">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4921019">}</span><br>
<span class="lineno"></span><span class="op" id="4921021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4921024">//&nbsp;A&nbsp;response&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4921086">type</span>&nbsp;<span class="ident" id="4921091">response</span>&nbsp;<span class="keyword" id="4921100">struct</span>&nbsp;<span class="op" id="4921107">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921110">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4921124">*</span><span class="ident" id="4921125">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921131">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4921145">*</span><span class="ident" id="4921146">Request</span>&nbsp;<span class="comment" id="4921154">//&nbsp;request&nbsp;for&nbsp;this&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921184">wroteHeader</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4921198">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4921207">//&nbsp;reply&nbsp;header&nbsp;has&nbsp;been&nbsp;(logically)&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921253">wroteContinue</span>&nbsp;<span class="builtintype" id="4921267">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4921276">//&nbsp;100&nbsp;Continue&nbsp;response&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921315">w</span>&nbsp;&nbsp;<span class="op" id="4921318">*</span><span class="ident" id="4921319">bufio</span><span class="op" id="4921324">.</span><span class="ident" id="4921325">Writer</span>&nbsp;<span class="comment" id="4921332">//&nbsp;buffers&nbsp;output&nbsp;in&nbsp;chunks&nbsp;to&nbsp;chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921376">cw</span>&nbsp;<span class="ident" id="4921379">chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921392">sw</span>&nbsp;<span class="op" id="4921395">*</span><span class="ident" id="4921396">switchWriter</span>&nbsp;<span class="comment" id="4921409">//&nbsp;of&nbsp;the&nbsp;bufio.Writer,&nbsp;for&nbsp;return&nbsp;to&nbsp;putBufioWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4921464">//&nbsp;handlerHeader&nbsp;is&nbsp;the&nbsp;Header&nbsp;that&nbsp;Handlers&nbsp;get&nbsp;access&nbsp;to,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4921525">//&nbsp;which&nbsp;may&nbsp;be&nbsp;retained&nbsp;and&nbsp;mutated&nbsp;even&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4921587">//&nbsp;handlerHeader&nbsp;is&nbsp;copied&nbsp;into&nbsp;cw.header&nbsp;at&nbsp;WriteHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4921645">//&nbsp;time,&nbsp;and&nbsp;privately&nbsp;mutated&nbsp;thereafter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921689">handlerHeader</span>&nbsp;<span class="ident" id="4921703">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921711">calledHeader</span>&nbsp;&nbsp;<span class="builtintype" id="4921725">bool</span>&nbsp;<span class="comment" id="4921730">//&nbsp;handler&nbsp;accessed&nbsp;handlerHeader&nbsp;via&nbsp;Header</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921777">written</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4921791">int64</span>&nbsp;<span class="comment" id="4921797">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;in&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921833">contentLength</span>&nbsp;<span class="ident" id="4921847">int64</span>&nbsp;<span class="comment" id="4921853">//&nbsp;explicitly-declared&nbsp;Content-Length;&nbsp;or&nbsp;-1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921899">status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4921913">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4921919">//&nbsp;status&nbsp;code&nbsp;passed&nbsp;to&nbsp;WriteHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4921958">//&nbsp;close&nbsp;connection&nbsp;after&nbsp;this&nbsp;reply.&nbsp;&nbsp;set&nbsp;on&nbsp;request&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4922017">//&nbsp;updated&nbsp;after&nbsp;response&nbsp;from&nbsp;handler&nbsp;if&nbsp;there&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4922070">//&nbsp;&#34;Connection:&nbsp;keep-alive&#34;&nbsp;response&nbsp;header&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4922121">//&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922141">closeAfterReply</span>&nbsp;<span class="builtintype" id="4922157">bool</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4922164">//&nbsp;requestBodyLimitHit&nbsp;is&nbsp;set&nbsp;by&nbsp;requestTooLarge&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4922219">//&nbsp;maxBytesReader&nbsp;hits&nbsp;its&nbsp;max&nbsp;size.&nbsp;It&nbsp;is&nbsp;checked&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4922274">//&nbsp;WriteHeader,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4922325">//&nbsp;remaining&nbsp;request&nbsp;body&nbsp;to&nbsp;try&nbsp;to&nbsp;advance&nbsp;to&nbsp;the&nbsp;next&nbsp;HTTP</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4922387">//&nbsp;request.&nbsp;Instead,&nbsp;when&nbsp;this&nbsp;is&nbsp;set,&nbsp;we&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4922443">//&nbsp;subsequent&nbsp;requests&nbsp;on&nbsp;this&nbsp;connection&nbsp;and&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4922503">//&nbsp;input&nbsp;from&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922522">requestBodyLimitHit</span>&nbsp;<span class="builtintype" id="4922542">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922549">handlerDone</span>&nbsp;<span class="builtintype" id="4922561">bool</span>&nbsp;<span class="comment" id="4922566">//&nbsp;set&nbsp;true&nbsp;when&nbsp;the&nbsp;handler&nbsp;exits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4922603">//&nbsp;Buffers&nbsp;for&nbsp;Date&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922643">dateBuf</span>&nbsp;<span class="op" id="4922651">[</span><span class="builtinfunc" id="4922652">len</span><span class="op" id="4922655">(</span><span class="ident" id="4922656">TimeFormat</span><span class="op" id="4922666">)</span><span class="op" id="4922667">]</span><span class="builtintype" id="4922668">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922674">clenBuf</span>&nbsp;<span class="op" id="4922682">[</span><span class="num" id="4922683">10</span><span class="op" id="4922685">]</span><span class="builtintype" id="4922686">byte</span><br>
<span class="lineno">340</span><span class="op" id="4922691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4922694">//&nbsp;requestTooLarge&nbsp;is&nbsp;called&nbsp;by&nbsp;maxBytesReader&nbsp;when&nbsp;too&nbsp;much&nbsp;input&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4922765">//&nbsp;been&nbsp;read&nbsp;from&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="4922795">func</span>&nbsp;<span class="op" id="4922800">(</span><span class="ident" id="4922801">w</span>&nbsp;<span class="op" id="4922803">*</span><span class="ident" id="4922804">response</span><span class="op" id="4922812">)</span>&nbsp;<span class="ident" id="4922814">requestTooLarge</span><span class="op" id="4922829">(</span><span class="op" id="4922830">)</span>&nbsp;<span class="op" id="4922832">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922835">w</span><span class="op" id="4922836">.</span><span class="ident" id="4922837">closeAfterReply</span>&nbsp;<span class="op" id="4922853">=</span>&nbsp;<span class="builtintype" id="4922855">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922861">w</span><span class="op" id="4922862">.</span><span class="ident" id="4922863">requestBodyLimitHit</span>&nbsp;<span class="op" id="4922883">=</span>&nbsp;<span class="builtintype" id="4922885">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922891">if</span>&nbsp;<span class="op" id="4922894">!</span><span class="ident" id="4922895">w</span><span class="op" id="4922896">.</span><span class="ident" id="4922897">wroteHeader</span>&nbsp;<span class="op" id="4922909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922913">w</span><span class="op" id="4922914">.</span><span class="ident" id="4922915">Header</span><span class="op" id="4922921">(</span><span class="op" id="4922922">)</span><span class="op" id="4922923">.</span><span class="ident" id="4922924">Set</span><span class="op" id="4922927">(</span><span class="string" id="4922928">&#34;Connection&#34;</span><span class="op" id="4922940">,</span>&nbsp;<span class="string" id="4922942">&#34;close&#34;</span><span class="op" id="4922949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4922952">}</span><br>
<span class="lineno">350</span><span class="op" id="4922954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4922957">//&nbsp;needsSniff&nbsp;reports&nbsp;whether&nbsp;a&nbsp;Content-Type&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="4923029">func</span>&nbsp;<span class="op" id="4923034">(</span><span class="ident" id="4923035">w</span>&nbsp;<span class="op" id="4923037">*</span><span class="ident" id="4923038">response</span><span class="op" id="4923046">)</span>&nbsp;<span class="ident" id="4923048">needsSniff</span><span class="op" id="4923058">(</span><span class="op" id="4923059">)</span>&nbsp;<span class="builtintype" id="4923061">bool</span>&nbsp;<span class="op" id="4923066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923069">_</span><span class="op" id="4923070">,</span>&nbsp;<span class="ident" id="4923072">haveType</span>&nbsp;<span class="op" id="4923081">:=</span>&nbsp;<span class="ident" id="4923084">w</span><span class="op" id="4923085">.</span><span class="ident" id="4923086">handlerHeader</span><span class="op" id="4923099">[</span><span class="string" id="4923100">&#34;Content-Type&#34;</span><span class="op" id="4923114">]</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923117">return</span>&nbsp;<span class="op" id="4923124">!</span><span class="ident" id="4923125">w</span><span class="op" id="4923126">.</span><span class="ident" id="4923127">cw</span><span class="op" id="4923129">.</span><span class="ident" id="4923130">wroteHeader</span>&nbsp;<span class="op" id="4923142">&amp;&amp;</span>&nbsp;<span class="op" id="4923145">!</span><span class="ident" id="4923146">haveType</span>&nbsp;<span class="op" id="4923155">&amp;&amp;</span>&nbsp;<span class="ident" id="4923158">w</span><span class="op" id="4923159">.</span><span class="ident" id="4923160">written</span>&nbsp;<span class="op" id="4923168">&lt;</span>&nbsp;<span class="ident" id="4923170">sniffLen</span><br>
<span class="lineno"></span><span class="op" id="4923179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4923182">//&nbsp;writerOnly&nbsp;hides&nbsp;an&nbsp;io.Writer&nbsp;value&#39;s&nbsp;optional&nbsp;ReadFrom&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="4923248">//&nbsp;from&nbsp;io.Copy.</span><br>
<span class="lineno">360</span><span class="keyword" id="4923265">type</span>&nbsp;<span class="ident" id="4923270">writerOnly</span>&nbsp;<span class="keyword" id="4923281">struct</span>&nbsp;<span class="op" id="4923288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923291">io</span><span class="op" id="4923293">.</span><span class="ident" id="4923294">Writer</span><br>
<span class="lineno"></span><span class="op" id="4923301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4923304">func</span>&nbsp;<span class="ident" id="4923309">srcIsRegularFile</span><span class="op" id="4923325">(</span><span class="ident" id="4923326">src</span>&nbsp;<span class="ident" id="4923330">io</span><span class="op" id="4923332">.</span><span class="ident" id="4923333">Reader</span><span class="op" id="4923339">)</span>&nbsp;<span class="op" id="4923341">(</span><span class="ident" id="4923342">isRegular</span>&nbsp;<span class="builtintype" id="4923352">bool</span><span class="op" id="4923356">,</span>&nbsp;<span class="ident" id="4923358">err</span>&nbsp;<span class="builtintype" id="4923362">error</span><span class="op" id="4923367">)</span>&nbsp;<span class="op" id="4923369">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923372">switch</span>&nbsp;<span class="ident" id="4923379">v</span>&nbsp;<span class="op" id="4923381">:=</span>&nbsp;<span class="ident" id="4923384">src</span><span class="op" id="4923387">.</span><span class="op" id="4923388">(</span><span class="keyword" id="4923389">type</span><span class="op" id="4923393">)</span>&nbsp;<span class="op" id="4923395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923398">case</span>&nbsp;<span class="op" id="4923403">*</span><span class="ident" id="4923404">os</span><span class="op" id="4923406">.</span><span class="ident" id="4923407">File</span><span class="op" id="4923411">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923415">fi</span><span class="op" id="4923417">,</span>&nbsp;<span class="ident" id="4923419">err</span>&nbsp;<span class="op" id="4923423">:=</span>&nbsp;<span class="ident" id="4923426">v</span><span class="op" id="4923427">.</span><span class="ident" id="4923428">Stat</span><span class="op" id="4923432">(</span><span class="op" id="4923433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923437">if</span>&nbsp;<span class="ident" id="4923440">err</span>&nbsp;<span class="op" id="4923444">!=</span>&nbsp;<span class="ident" id="4923447">nil</span>&nbsp;<span class="op" id="4923451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923456">return</span>&nbsp;<span class="builtintype" id="4923463">false</span><span class="op" id="4923468">,</span>&nbsp;<span class="ident" id="4923470">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4923476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923480">return</span>&nbsp;<span class="ident" id="4923487">fi</span><span class="op" id="4923489">.</span><span class="ident" id="4923490">Mode</span><span class="op" id="4923494">(</span><span class="op" id="4923495">)</span><span class="op" id="4923496">.</span><span class="ident" id="4923497">IsRegular</span><span class="op" id="4923506">(</span><span class="op" id="4923507">)</span><span class="op" id="4923508">,</span>&nbsp;<span class="ident" id="4923510">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923515">case</span>&nbsp;<span class="op" id="4923520">*</span><span class="ident" id="4923521">io</span><span class="op" id="4923523">.</span><span class="ident" id="4923524">LimitedReader</span><span class="op" id="4923537">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923541">return</span>&nbsp;<span class="ident" id="4923548">srcIsRegularFile</span><span class="op" id="4923564">(</span><span class="ident" id="4923565">v</span><span class="op" id="4923566">.</span><span class="ident" id="4923567">R</span><span class="op" id="4923568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923571">default</span><span class="op" id="4923578">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923582">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4923590">}</span><br>
<span class="lineno"></span><span class="op" id="4923592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4923595">//&nbsp;ReadFrom&nbsp;is&nbsp;here&nbsp;to&nbsp;optimize&nbsp;copying&nbsp;from&nbsp;an&nbsp;*os.File&nbsp;regular&nbsp;file</span><br>
<span class="lineno">380</span><span class="comment" id="4923665">//&nbsp;to&nbsp;a&nbsp;*net.TCPConn&nbsp;with&nbsp;sendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="4923701">func</span>&nbsp;<span class="op" id="4923706">(</span><span class="ident" id="4923707">w</span>&nbsp;<span class="op" id="4923709">*</span><span class="ident" id="4923710">response</span><span class="op" id="4923718">)</span>&nbsp;<span class="ident" id="4923720">ReadFrom</span><span class="op" id="4923728">(</span><span class="ident" id="4923729">src</span>&nbsp;<span class="ident" id="4923733">io</span><span class="op" id="4923735">.</span><span class="ident" id="4923736">Reader</span><span class="op" id="4923742">)</span>&nbsp;<span class="op" id="4923744">(</span><span class="ident" id="4923745">n</span>&nbsp;<span class="ident" id="4923747">int64</span><span class="op" id="4923752">,</span>&nbsp;<span class="ident" id="4923754">err</span>&nbsp;<span class="builtintype" id="4923758">error</span><span class="op" id="4923763">)</span>&nbsp;<span class="op" id="4923765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4923768">//&nbsp;Our&nbsp;underlying&nbsp;w.conn.rwc&nbsp;is&nbsp;usually&nbsp;a&nbsp;*TCPConn&nbsp;(with&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4923830">//&nbsp;own&nbsp;ReadFrom&nbsp;method).&nbsp;If&nbsp;not,&nbsp;or&nbsp;if&nbsp;our&nbsp;src&nbsp;isn&#39;t&nbsp;a&nbsp;regular</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4923894">//&nbsp;file,&nbsp;just&nbsp;fall&nbsp;back&nbsp;to&nbsp;the&nbsp;normal&nbsp;copy&nbsp;method.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923946">rf</span><span class="op" id="4923948">,</span>&nbsp;<span class="ident" id="4923950">ok</span>&nbsp;<span class="op" id="4923953">:=</span>&nbsp;<span class="ident" id="4923956">w</span><span class="op" id="4923957">.</span><span class="ident" id="4923958">conn</span><span class="op" id="4923962">.</span><span class="ident" id="4923963">rwc</span><span class="op" id="4923966">.</span><span class="op" id="4923967">(</span><span class="ident" id="4923968">io</span><span class="op" id="4923970">.</span><span class="ident" id="4923971">ReaderFrom</span><span class="op" id="4923981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923984">regFile</span><span class="op" id="4923991">,</span>&nbsp;<span class="ident" id="4923993">err</span>&nbsp;<span class="op" id="4923997">:=</span>&nbsp;<span class="ident" id="4924000">srcIsRegularFile</span><span class="op" id="4924016">(</span><span class="ident" id="4924017">src</span><span class="op" id="4924020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924023">if</span>&nbsp;<span class="ident" id="4924026">err</span>&nbsp;<span class="op" id="4924030">!=</span>&nbsp;<span class="ident" id="4924033">nil</span>&nbsp;<span class="op" id="4924037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924041">return</span>&nbsp;<span class="num" id="4924048">0</span><span class="op" id="4924049">,</span>&nbsp;<span class="ident" id="4924051">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924056">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924059">if</span>&nbsp;<span class="op" id="4924062">!</span><span class="ident" id="4924063">ok</span>&nbsp;<span class="op" id="4924066">||</span>&nbsp;<span class="op" id="4924069">!</span><span class="ident" id="4924070">regFile</span>&nbsp;<span class="op" id="4924078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924082">return</span>&nbsp;<span class="ident" id="4924089">io</span><span class="op" id="4924091">.</span><span class="ident" id="4924092">Copy</span><span class="op" id="4924096">(</span><span class="ident" id="4924097">writerOnly</span><span class="op" id="4924107">{</span><span class="ident" id="4924108">w</span><span class="op" id="4924109">}</span><span class="op" id="4924110">,</span>&nbsp;<span class="ident" id="4924112">src</span><span class="op" id="4924115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4924122">//&nbsp;sendfile&nbsp;path:</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924142">if</span>&nbsp;<span class="op" id="4924145">!</span><span class="ident" id="4924146">w</span><span class="op" id="4924147">.</span><span class="ident" id="4924148">wroteHeader</span>&nbsp;<span class="op" id="4924160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924164">w</span><span class="op" id="4924165">.</span><span class="ident" id="4924166">WriteHeader</span><span class="op" id="4924177">(</span><span class="ident" id="4924178">StatusOK</span><span class="op" id="4924186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924193">if</span>&nbsp;<span class="ident" id="4924196">w</span><span class="op" id="4924197">.</span><span class="ident" id="4924198">needsSniff</span><span class="op" id="4924208">(</span><span class="op" id="4924209">)</span>&nbsp;<span class="op" id="4924211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924215">n0</span><span class="op" id="4924217">,</span>&nbsp;<span class="ident" id="4924219">err</span>&nbsp;<span class="op" id="4924223">:=</span>&nbsp;<span class="ident" id="4924226">io</span><span class="op" id="4924228">.</span><span class="ident" id="4924229">Copy</span><span class="op" id="4924233">(</span><span class="ident" id="4924234">writerOnly</span><span class="op" id="4924244">{</span><span class="ident" id="4924245">w</span><span class="op" id="4924246">}</span><span class="op" id="4924247">,</span>&nbsp;<span class="ident" id="4924249">io</span><span class="op" id="4924251">.</span><span class="ident" id="4924252">LimitReader</span><span class="op" id="4924263">(</span><span class="ident" id="4924264">src</span><span class="op" id="4924267">,</span>&nbsp;<span class="ident" id="4924269">sniffLen</span><span class="op" id="4924277">)</span><span class="op" id="4924278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924282">n</span>&nbsp;<span class="op" id="4924284">+=</span>&nbsp;<span class="ident" id="4924287">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924292">if</span>&nbsp;<span class="ident" id="4924295">err</span>&nbsp;<span class="op" id="4924299">!=</span>&nbsp;<span class="ident" id="4924302">nil</span>&nbsp;<span class="op" id="4924306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924311">return</span>&nbsp;<span class="ident" id="4924318">n</span><span class="op" id="4924319">,</span>&nbsp;<span class="ident" id="4924321">err</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924334">w</span><span class="op" id="4924335">.</span><span class="ident" id="4924336">w</span><span class="op" id="4924337">.</span><span class="ident" id="4924338">Flush</span><span class="op" id="4924343">(</span><span class="op" id="4924344">)</span>&nbsp;&nbsp;<span class="comment" id="4924347">//&nbsp;get&nbsp;rid&nbsp;of&nbsp;any&nbsp;previous&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924382">w</span><span class="op" id="4924383">.</span><span class="ident" id="4924384">cw</span><span class="op" id="4924386">.</span><span class="ident" id="4924387">flush</span><span class="op" id="4924392">(</span><span class="op" id="4924393">)</span>&nbsp;<span class="comment" id="4924395">//&nbsp;make&nbsp;sure&nbsp;Header&nbsp;is&nbsp;written;&nbsp;flush&nbsp;data&nbsp;to&nbsp;rwc</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4924447">//&nbsp;Now&nbsp;that&nbsp;cw&nbsp;has&nbsp;been&nbsp;flushed,&nbsp;its&nbsp;chunking&nbsp;field&nbsp;is&nbsp;guaranteed&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924527">if</span>&nbsp;<span class="op" id="4924530">!</span><span class="ident" id="4924531">w</span><span class="op" id="4924532">.</span><span class="ident" id="4924533">cw</span><span class="op" id="4924535">.</span><span class="ident" id="4924536">chunking</span>&nbsp;<span class="op" id="4924545">&amp;&amp;</span>&nbsp;<span class="ident" id="4924548">w</span><span class="op" id="4924549">.</span><span class="ident" id="4924550">bodyAllowed</span><span class="op" id="4924561">(</span><span class="op" id="4924562">)</span>&nbsp;<span class="op" id="4924564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924568">n0</span><span class="op" id="4924570">,</span>&nbsp;<span class="ident" id="4924572">err</span>&nbsp;<span class="op" id="4924576">:=</span>&nbsp;<span class="ident" id="4924579">rf</span><span class="op" id="4924581">.</span><span class="ident" id="4924582">ReadFrom</span><span class="op" id="4924590">(</span><span class="ident" id="4924591">src</span><span class="op" id="4924594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924598">n</span>&nbsp;<span class="op" id="4924600">+=</span>&nbsp;<span class="ident" id="4924603">n0</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924608">w</span><span class="op" id="4924609">.</span><span class="ident" id="4924610">written</span>&nbsp;<span class="op" id="4924618">+=</span>&nbsp;<span class="ident" id="4924621">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924626">return</span>&nbsp;<span class="ident" id="4924633">n</span><span class="op" id="4924634">,</span>&nbsp;<span class="ident" id="4924636">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924645">n0</span><span class="op" id="4924647">,</span>&nbsp;<span class="ident" id="4924649">err</span>&nbsp;<span class="op" id="4924653">:=</span>&nbsp;<span class="ident" id="4924656">io</span><span class="op" id="4924658">.</span><span class="ident" id="4924659">Copy</span><span class="op" id="4924663">(</span><span class="ident" id="4924664">writerOnly</span><span class="op" id="4924674">{</span><span class="ident" id="4924675">w</span><span class="op" id="4924676">}</span><span class="op" id="4924677">,</span>&nbsp;<span class="ident" id="4924679">src</span><span class="op" id="4924682">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924685">n</span>&nbsp;<span class="op" id="4924687">+=</span>&nbsp;<span class="ident" id="4924690">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924694">return</span>&nbsp;<span class="ident" id="4924701">n</span><span class="op" id="4924702">,</span>&nbsp;<span class="ident" id="4924704">err</span><br>
<span class="lineno"></span><span class="op" id="4924708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4924711">//&nbsp;noLimit&nbsp;is&nbsp;an&nbsp;effective&nbsp;infinite&nbsp;upper&nbsp;bound&nbsp;for&nbsp;io.LimitedReader</span><br>
<span class="lineno">425</span><span class="keyword" id="4924780">const</span>&nbsp;<span class="ident" id="4924786">noLimit</span>&nbsp;<span class="ident" id="4924794">int64</span>&nbsp;<span class="op" id="4924800">=</span>&nbsp;<span class="op" id="4924802">(</span><span class="num" id="4924803">1</span>&nbsp;<span class="op" id="4924805">&lt;&lt;</span>&nbsp;<span class="num" id="4924808">63</span><span class="op" id="4924810">)</span>&nbsp;<span class="op" id="4924812">-</span>&nbsp;<span class="num" id="4924814">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4924817">//&nbsp;debugServerConnections&nbsp;controls&nbsp;whether&nbsp;all&nbsp;server&nbsp;connections&nbsp;are&nbsp;wrapped</span><br>
<span class="lineno"></span><span class="comment" id="4924895">//&nbsp;with&nbsp;a&nbsp;verbose&nbsp;logging&nbsp;wrapper.</span><br>
<span class="lineno"></span><span class="keyword" id="4924930">const</span>&nbsp;<span class="ident" id="4924936">debugServerConnections</span>&nbsp;<span class="op" id="4924959">=</span>&nbsp;<span class="builtintype" id="4924961">false</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="comment" id="4924968">//&nbsp;Create&nbsp;new&nbsp;connection&nbsp;from&nbsp;rwc.</span><br>
<span class="lineno"></span><span class="keyword" id="4925003">func</span>&nbsp;<span class="op" id="4925008">(</span><span class="ident" id="4925009">srv</span>&nbsp;<span class="op" id="4925013">*</span><span class="ident" id="4925014">Server</span><span class="op" id="4925020">)</span>&nbsp;<span class="ident" id="4925022">newConn</span><span class="op" id="4925029">(</span><span class="ident" id="4925030">rwc</span>&nbsp;<span class="ident" id="4925034">net</span><span class="op" id="4925037">.</span><span class="ident" id="4925038">Conn</span><span class="op" id="4925042">)</span>&nbsp;<span class="op" id="4925044">(</span><span class="ident" id="4925045">c</span>&nbsp;<span class="op" id="4925047">*</span><span class="ident" id="4925048">conn</span><span class="op" id="4925052">,</span>&nbsp;<span class="ident" id="4925054">err</span>&nbsp;<span class="builtintype" id="4925058">error</span><span class="op" id="4925063">)</span>&nbsp;<span class="op" id="4925065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925068">c</span>&nbsp;<span class="op" id="4925070">=</span>&nbsp;<span class="builtinfunc" id="4925072">new</span><span class="op" id="4925075">(</span><span class="ident" id="4925076">conn</span><span class="op" id="4925080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925083">c</span><span class="op" id="4925084">.</span><span class="ident" id="4925085">remoteAddr</span>&nbsp;<span class="op" id="4925096">=</span>&nbsp;<span class="ident" id="4925098">rwc</span><span class="op" id="4925101">.</span><span class="ident" id="4925102">RemoteAddr</span><span class="op" id="4925112">(</span><span class="op" id="4925113">)</span><span class="op" id="4925114">.</span><span class="ident" id="4925115">String</span><span class="op" id="4925121">(</span><span class="op" id="4925122">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925125">c</span><span class="op" id="4925126">.</span><span class="ident" id="4925127">server</span>&nbsp;<span class="op" id="4925134">=</span>&nbsp;<span class="ident" id="4925136">srv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925141">c</span><span class="op" id="4925142">.</span><span class="ident" id="4925143">rwc</span>&nbsp;<span class="op" id="4925147">=</span>&nbsp;<span class="ident" id="4925149">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925154">c</span><span class="op" id="4925155">.</span><span class="ident" id="4925156">w</span>&nbsp;<span class="op" id="4925158">=</span>&nbsp;<span class="ident" id="4925160">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925165">if</span>&nbsp;<span class="ident" id="4925168">debugServerConnections</span>&nbsp;<span class="op" id="4925191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925195">c</span><span class="op" id="4925196">.</span><span class="ident" id="4925197">rwc</span>&nbsp;<span class="op" id="4925201">=</span>&nbsp;<span class="ident" id="4925203">newLoggingConn</span><span class="op" id="4925217">(</span><span class="string" id="4925218">&#34;server&#34;</span><span class="op" id="4925226">,</span>&nbsp;<span class="ident" id="4925228">c</span><span class="op" id="4925229">.</span><span class="ident" id="4925230">rwc</span><span class="op" id="4925233">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925239">c</span><span class="op" id="4925240">.</span><span class="ident" id="4925241">sr</span>&nbsp;<span class="op" id="4925244">=</span>&nbsp;<span class="ident" id="4925246">liveSwitchReader</span><span class="op" id="4925262">{</span><span class="ident" id="4925263">r</span><span class="op" id="4925264">:</span>&nbsp;<span class="ident" id="4925266">c</span><span class="op" id="4925267">.</span><span class="ident" id="4925268">rwc</span><span class="op" id="4925271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925274">c</span><span class="op" id="4925275">.</span><span class="ident" id="4925276">lr</span>&nbsp;<span class="op" id="4925279">=</span>&nbsp;<span class="ident" id="4925281">io</span><span class="op" id="4925283">.</span><span class="ident" id="4925284">LimitReader</span><span class="op" id="4925295">(</span><span class="op" id="4925296">&amp;</span><span class="ident" id="4925297">c</span><span class="op" id="4925298">.</span><span class="ident" id="4925299">sr</span><span class="op" id="4925301">,</span>&nbsp;<span class="ident" id="4925303">noLimit</span><span class="op" id="4925310">)</span><span class="op" id="4925311">.</span><span class="op" id="4925312">(</span><span class="op" id="4925313">*</span><span class="ident" id="4925314">io</span><span class="op" id="4925316">.</span><span class="ident" id="4925317">LimitedReader</span><span class="op" id="4925330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925333">br</span>&nbsp;<span class="op" id="4925336">:=</span>&nbsp;<span class="ident" id="4925339">newBufioReader</span><span class="op" id="4925353">(</span><span class="ident" id="4925354">c</span><span class="op" id="4925355">.</span><span class="ident" id="4925356">lr</span><span class="op" id="4925358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925361">bw</span>&nbsp;<span class="op" id="4925364">:=</span>&nbsp;<span class="ident" id="4925367">newBufioWriterSize</span><span class="op" id="4925385">(</span><span class="ident" id="4925386">checkConnErrorWriter</span><span class="op" id="4925406">{</span><span class="ident" id="4925407">c</span><span class="op" id="4925408">}</span><span class="op" id="4925409">,</span>&nbsp;<span class="num" id="4925411">4</span><span class="op" id="4925412">&lt;&lt;</span><span class="num" id="4925414">10</span><span class="op" id="4925416">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925419">c</span><span class="op" id="4925420">.</span><span class="ident" id="4925421">buf</span>&nbsp;<span class="op" id="4925425">=</span>&nbsp;<span class="ident" id="4925427">bufio</span><span class="op" id="4925432">.</span><span class="ident" id="4925433">NewReadWriter</span><span class="op" id="4925446">(</span><span class="ident" id="4925447">br</span><span class="op" id="4925449">,</span>&nbsp;<span class="ident" id="4925451">bw</span><span class="op" id="4925453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925456">return</span>&nbsp;<span class="ident" id="4925463">c</span><span class="op" id="4925464">,</span>&nbsp;<span class="ident" id="4925466">nil</span><br>
<span class="lineno"></span><span class="op" id="4925470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4925473">var</span>&nbsp;<span class="op" id="4925477">(</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925480">bufioReaderPool</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4925498">sync</span><span class="op" id="4925502">.</span><span class="ident" id="4925503">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925509">bufioWriter2kPool</span>&nbsp;<span class="ident" id="4925527">sync</span><span class="op" id="4925531">.</span><span class="ident" id="4925532">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925538">bufioWriter4kPool</span>&nbsp;<span class="ident" id="4925556">sync</span><span class="op" id="4925560">.</span><span class="ident" id="4925561">Pool</span><br>
<span class="lineno"></span><span class="op" id="4925566">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="keyword" id="4925569">func</span>&nbsp;<span class="ident" id="4925574">bufioWriterPool</span><span class="op" id="4925589">(</span><span class="ident" id="4925590">size</span>&nbsp;<span class="builtintype" id="4925595">int</span><span class="op" id="4925598">)</span>&nbsp;<span class="op" id="4925600">*</span><span class="ident" id="4925601">sync</span><span class="op" id="4925605">.</span><span class="ident" id="4925606">Pool</span>&nbsp;<span class="op" id="4925611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925614">switch</span>&nbsp;<span class="ident" id="4925621">size</span>&nbsp;<span class="op" id="4925626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925629">case</span>&nbsp;<span class="num" id="4925634">2</span>&nbsp;<span class="op" id="4925636">&lt;&lt;</span>&nbsp;<span class="num" id="4925639">10</span><span class="op" id="4925641">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925645">return</span>&nbsp;<span class="op" id="4925652">&amp;</span><span class="ident" id="4925653">bufioWriter2kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925672">case</span>&nbsp;<span class="num" id="4925677">4</span>&nbsp;<span class="op" id="4925679">&lt;&lt;</span>&nbsp;<span class="num" id="4925682">10</span><span class="op" id="4925684">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925688">return</span>&nbsp;<span class="op" id="4925695">&amp;</span><span class="ident" id="4925696">bufioWriter4kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925718">return</span>&nbsp;<span class="ident" id="4925725">nil</span><br>
<span class="lineno"></span><span class="op" id="4925729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="keyword" id="4925732">func</span>&nbsp;<span class="ident" id="4925737">newBufioReader</span><span class="op" id="4925751">(</span><span class="ident" id="4925752">r</span>&nbsp;<span class="ident" id="4925754">io</span><span class="op" id="4925756">.</span><span class="ident" id="4925757">Reader</span><span class="op" id="4925763">)</span>&nbsp;<span class="op" id="4925765">*</span><span class="ident" id="4925766">bufio</span><span class="op" id="4925771">.</span><span class="ident" id="4925772">Reader</span>&nbsp;<span class="op" id="4925779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925782">if</span>&nbsp;<span class="ident" id="4925785">v</span>&nbsp;<span class="op" id="4925787">:=</span>&nbsp;<span class="ident" id="4925790">bufioReaderPool</span><span class="op" id="4925805">.</span><span class="ident" id="4925806">Get</span><span class="op" id="4925809">(</span><span class="op" id="4925810">)</span><span class="op" id="4925811">;</span>&nbsp;<span class="ident" id="4925813">v</span>&nbsp;<span class="op" id="4925815">!=</span>&nbsp;<span class="ident" id="4925818">nil</span>&nbsp;<span class="op" id="4925822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925826">br</span>&nbsp;<span class="op" id="4925829">:=</span>&nbsp;<span class="ident" id="4925832">v</span><span class="op" id="4925833">.</span><span class="op" id="4925834">(</span><span class="op" id="4925835">*</span><span class="ident" id="4925836">bufio</span><span class="op" id="4925841">.</span><span class="ident" id="4925842">Reader</span><span class="op" id="4925848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925852">br</span><span class="op" id="4925854">.</span><span class="ident" id="4925855">Reset</span><span class="op" id="4925860">(</span><span class="ident" id="4925861">r</span><span class="op" id="4925862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925866">return</span>&nbsp;<span class="ident" id="4925873">br</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925880">return</span>&nbsp;<span class="ident" id="4925887">bufio</span><span class="op" id="4925892">.</span><span class="ident" id="4925893">NewReader</span><span class="op" id="4925902">(</span><span class="ident" id="4925903">r</span><span class="op" id="4925904">)</span><br>
<span class="lineno"></span><span class="op" id="4925906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4925909">func</span>&nbsp;<span class="ident" id="4925914">putBufioReader</span><span class="op" id="4925928">(</span><span class="ident" id="4925929">br</span>&nbsp;<span class="op" id="4925932">*</span><span class="ident" id="4925933">bufio</span><span class="op" id="4925938">.</span><span class="ident" id="4925939">Reader</span><span class="op" id="4925945">)</span>&nbsp;<span class="op" id="4925947">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925950">br</span><span class="op" id="4925952">.</span><span class="ident" id="4925953">Reset</span><span class="op" id="4925958">(</span><span class="ident" id="4925959">nil</span><span class="op" id="4925962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925965">bufioReaderPool</span><span class="op" id="4925980">.</span><span class="ident" id="4925981">Put</span><span class="op" id="4925984">(</span><span class="ident" id="4925985">br</span><span class="op" id="4925987">)</span><br>
<span class="lineno"></span><span class="op" id="4925989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4925992">func</span>&nbsp;<span class="ident" id="4925997">newBufioWriterSize</span><span class="op" id="4926015">(</span><span class="ident" id="4926016">w</span>&nbsp;<span class="ident" id="4926018">io</span><span class="op" id="4926020">.</span><span class="ident" id="4926021">Writer</span><span class="op" id="4926027">,</span>&nbsp;<span class="ident" id="4926029">size</span>&nbsp;<span class="builtintype" id="4926034">int</span><span class="op" id="4926037">)</span>&nbsp;<span class="op" id="4926039">*</span><span class="ident" id="4926040">bufio</span><span class="op" id="4926045">.</span><span class="ident" id="4926046">Writer</span>&nbsp;<span class="op" id="4926053">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926056">pool</span>&nbsp;<span class="op" id="4926061">:=</span>&nbsp;<span class="ident" id="4926064">bufioWriterPool</span><span class="op" id="4926079">(</span><span class="ident" id="4926080">size</span><span class="op" id="4926084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926087">if</span>&nbsp;<span class="ident" id="4926090">pool</span>&nbsp;<span class="op" id="4926095">!=</span>&nbsp;<span class="ident" id="4926098">nil</span>&nbsp;<span class="op" id="4926102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926106">if</span>&nbsp;<span class="ident" id="4926109">v</span>&nbsp;<span class="op" id="4926111">:=</span>&nbsp;<span class="ident" id="4926114">pool</span><span class="op" id="4926118">.</span><span class="ident" id="4926119">Get</span><span class="op" id="4926122">(</span><span class="op" id="4926123">)</span><span class="op" id="4926124">;</span>&nbsp;<span class="ident" id="4926126">v</span>&nbsp;<span class="op" id="4926128">!=</span>&nbsp;<span class="ident" id="4926131">nil</span>&nbsp;<span class="op" id="4926135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926140">bw</span>&nbsp;<span class="op" id="4926143">:=</span>&nbsp;<span class="ident" id="4926146">v</span><span class="op" id="4926147">.</span><span class="op" id="4926148">(</span><span class="op" id="4926149">*</span><span class="ident" id="4926150">bufio</span><span class="op" id="4926155">.</span><span class="ident" id="4926156">Writer</span><span class="op" id="4926162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926167">bw</span><span class="op" id="4926169">.</span><span class="ident" id="4926170">Reset</span><span class="op" id="4926175">(</span><span class="ident" id="4926176">w</span><span class="op" id="4926177">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926182">return</span>&nbsp;<span class="ident" id="4926189">bw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4926194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4926197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926200">return</span>&nbsp;<span class="ident" id="4926207">bufio</span><span class="op" id="4926212">.</span><span class="ident" id="4926213">NewWriterSize</span><span class="op" id="4926226">(</span><span class="ident" id="4926227">w</span><span class="op" id="4926228">,</span>&nbsp;<span class="ident" id="4926230">size</span><span class="op" id="4926234">)</span><br>
<span class="lineno"></span><span class="op" id="4926236">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="keyword" id="4926239">func</span>&nbsp;<span class="ident" id="4926244">putBufioWriter</span><span class="op" id="4926258">(</span><span class="ident" id="4926259">bw</span>&nbsp;<span class="op" id="4926262">*</span><span class="ident" id="4926263">bufio</span><span class="op" id="4926268">.</span><span class="ident" id="4926269">Writer</span><span class="op" id="4926275">)</span>&nbsp;<span class="op" id="4926277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926280">bw</span><span class="op" id="4926282">.</span><span class="ident" id="4926283">Reset</span><span class="op" id="4926288">(</span><span class="ident" id="4926289">nil</span><span class="op" id="4926292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926295">if</span>&nbsp;<span class="ident" id="4926298">pool</span>&nbsp;<span class="op" id="4926303">:=</span>&nbsp;<span class="ident" id="4926306">bufioWriterPool</span><span class="op" id="4926321">(</span><span class="ident" id="4926322">bw</span><span class="op" id="4926324">.</span><span class="ident" id="4926325">Available</span><span class="op" id="4926334">(</span><span class="op" id="4926335">)</span><span class="op" id="4926336">)</span><span class="op" id="4926337">;</span>&nbsp;<span class="ident" id="4926339">pool</span>&nbsp;<span class="op" id="4926344">!=</span>&nbsp;<span class="ident" id="4926347">nil</span>&nbsp;<span class="op" id="4926351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926355">pool</span><span class="op" id="4926359">.</span><span class="ident" id="4926360">Put</span><span class="op" id="4926363">(</span><span class="ident" id="4926364">bw</span><span class="op" id="4926366">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4926369">}</span><br>
<span class="lineno"></span><span class="op" id="4926371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4926374">//&nbsp;DefaultMaxHeaderBytes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;permitted&nbsp;size&nbsp;of&nbsp;the&nbsp;headers</span><br>
<span class="lineno"></span><span class="comment" id="4926444">//&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno">500</span><span class="comment" id="4926467">//&nbsp;This&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;setting&nbsp;Server.MaxHeaderBytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4926527">const</span>&nbsp;<span class="ident" id="4926533">DefaultMaxHeaderBytes</span>&nbsp;<span class="op" id="4926555">=</span>&nbsp;<span class="num" id="4926557">1</span>&nbsp;<span class="op" id="4926559">&lt;&lt;</span>&nbsp;<span class="num" id="4926562">20</span>&nbsp;<span class="comment" id="4926565">//&nbsp;1&nbsp;MB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4926574">func</span>&nbsp;<span class="op" id="4926579">(</span><span class="ident" id="4926580">srv</span>&nbsp;<span class="op" id="4926584">*</span><span class="ident" id="4926585">Server</span><span class="op" id="4926591">)</span>&nbsp;<span class="ident" id="4926593">maxHeaderBytes</span><span class="op" id="4926607">(</span><span class="op" id="4926608">)</span>&nbsp;<span class="builtintype" id="4926610">int</span>&nbsp;<span class="op" id="4926614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926617">if</span>&nbsp;<span class="ident" id="4926620">srv</span><span class="op" id="4926623">.</span><span class="ident" id="4926624">MaxHeaderBytes</span>&nbsp;<span class="op" id="4926639">&gt;</span>&nbsp;<span class="num" id="4926641">0</span>&nbsp;<span class="op" id="4926643">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926647">return</span>&nbsp;<span class="ident" id="4926654">srv</span><span class="op" id="4926657">.</span><span class="ident" id="4926658">MaxHeaderBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4926674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926677">return</span>&nbsp;<span class="ident" id="4926684">DefaultMaxHeaderBytes</span><br>
<span class="lineno"></span><span class="op" id="4926706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="4926709">func</span>&nbsp;<span class="op" id="4926714">(</span><span class="ident" id="4926715">srv</span>&nbsp;<span class="op" id="4926719">*</span><span class="ident" id="4926720">Server</span><span class="op" id="4926726">)</span>&nbsp;<span class="ident" id="4926728">initialLimitedReaderSize</span><span class="op" id="4926752">(</span><span class="op" id="4926753">)</span>&nbsp;<span class="ident" id="4926755">int64</span>&nbsp;<span class="op" id="4926761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926764">return</span>&nbsp;<span class="ident" id="4926771">int64</span><span class="op" id="4926776">(</span><span class="ident" id="4926777">srv</span><span class="op" id="4926780">.</span><span class="ident" id="4926781">maxHeaderBytes</span><span class="op" id="4926795">(</span><span class="op" id="4926796">)</span><span class="op" id="4926797">)</span>&nbsp;<span class="op" id="4926799">+</span>&nbsp;<span class="num" id="4926801">4096</span>&nbsp;<span class="comment" id="4926806">//&nbsp;bufio&nbsp;slop</span><br>
<span class="lineno"></span><span class="op" id="4926820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4926823">//&nbsp;wrapper&nbsp;around&nbsp;io.ReaderCloser&nbsp;which&nbsp;on&nbsp;first&nbsp;read,&nbsp;sends&nbsp;an</span><br>
<span class="lineno">515</span><span class="comment" id="4926887">//&nbsp;HTTP/1.1&nbsp;100&nbsp;Continue&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="4926919">type</span>&nbsp;<span class="ident" id="4926924">expectContinueReader</span>&nbsp;<span class="keyword" id="4926945">struct</span>&nbsp;<span class="op" id="4926952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926955">resp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4926966">*</span><span class="ident" id="4926967">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926977">readCloser</span>&nbsp;<span class="ident" id="4926988">io</span><span class="op" id="4926990">.</span><span class="ident" id="4926991">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927003">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4927014">bool</span><br>
<span class="lineno">520</span><span class="op" id="4927019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4927022">func</span>&nbsp;<span class="op" id="4927027">(</span><span class="ident" id="4927028">ecr</span>&nbsp;<span class="op" id="4927032">*</span><span class="ident" id="4927033">expectContinueReader</span><span class="op" id="4927053">)</span>&nbsp;<span class="ident" id="4927055">Read</span><span class="op" id="4927059">(</span><span class="ident" id="4927060">p</span>&nbsp;<span class="op" id="4927062">[</span><span class="op" id="4927063">]</span><span class="builtintype" id="4927064">byte</span><span class="op" id="4927068">)</span>&nbsp;<span class="op" id="4927070">(</span><span class="ident" id="4927071">n</span>&nbsp;<span class="builtintype" id="4927073">int</span><span class="op" id="4927076">,</span>&nbsp;<span class="ident" id="4927078">err</span>&nbsp;<span class="builtintype" id="4927082">error</span><span class="op" id="4927087">)</span>&nbsp;<span class="op" id="4927089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927092">if</span>&nbsp;<span class="ident" id="4927095">ecr</span><span class="op" id="4927098">.</span><span class="ident" id="4927099">closed</span>&nbsp;<span class="op" id="4927106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927110">return</span>&nbsp;<span class="num" id="4927117">0</span><span class="op" id="4927118">,</span>&nbsp;<span class="ident" id="4927120">ErrBodyReadAfterClose</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927146">if</span>&nbsp;<span class="op" id="4927149">!</span><span class="ident" id="4927150">ecr</span><span class="op" id="4927153">.</span><span class="ident" id="4927154">resp</span><span class="op" id="4927158">.</span><span class="ident" id="4927159">wroteContinue</span>&nbsp;<span class="op" id="4927173">&amp;&amp;</span>&nbsp;<span class="op" id="4927176">!</span><span class="ident" id="4927177">ecr</span><span class="op" id="4927180">.</span><span class="ident" id="4927181">resp</span><span class="op" id="4927185">.</span><span class="ident" id="4927186">conn</span><span class="op" id="4927190">.</span><span class="ident" id="4927191">hijacked</span><span class="op" id="4927199">(</span><span class="op" id="4927200">)</span>&nbsp;<span class="op" id="4927202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927206">ecr</span><span class="op" id="4927209">.</span><span class="ident" id="4927210">resp</span><span class="op" id="4927214">.</span><span class="ident" id="4927215">wroteContinue</span>&nbsp;<span class="op" id="4927229">=</span>&nbsp;<span class="builtintype" id="4927231">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927238">ecr</span><span class="op" id="4927241">.</span><span class="ident" id="4927242">resp</span><span class="op" id="4927246">.</span><span class="ident" id="4927247">conn</span><span class="op" id="4927251">.</span><span class="ident" id="4927252">buf</span><span class="op" id="4927255">.</span><span class="ident" id="4927256">WriteString</span><span class="op" id="4927267">(</span><span class="string" id="4927268">&#34;HTTP/1.1&nbsp;100&nbsp;Continue\r\n\r\n&#34;</span><span class="op" id="4927299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927303">ecr</span><span class="op" id="4927306">.</span><span class="ident" id="4927307">resp</span><span class="op" id="4927311">.</span><span class="ident" id="4927312">conn</span><span class="op" id="4927316">.</span><span class="ident" id="4927317">buf</span><span class="op" id="4927320">.</span><span class="ident" id="4927321">Flush</span><span class="op" id="4927326">(</span><span class="op" id="4927327">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927333">return</span>&nbsp;<span class="ident" id="4927340">ecr</span><span class="op" id="4927343">.</span><span class="ident" id="4927344">readCloser</span><span class="op" id="4927354">.</span><span class="ident" id="4927355">Read</span><span class="op" id="4927359">(</span><span class="ident" id="4927360">p</span><span class="op" id="4927361">)</span><br>
<span class="lineno"></span><span class="op" id="4927363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4927366">func</span>&nbsp;<span class="op" id="4927371">(</span><span class="ident" id="4927372">ecr</span>&nbsp;<span class="op" id="4927376">*</span><span class="ident" id="4927377">expectContinueReader</span><span class="op" id="4927397">)</span>&nbsp;<span class="ident" id="4927399">Close</span><span class="op" id="4927404">(</span><span class="op" id="4927405">)</span>&nbsp;<span class="builtintype" id="4927407">error</span>&nbsp;<span class="op" id="4927413">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927416">ecr</span><span class="op" id="4927419">.</span><span class="ident" id="4927420">closed</span>&nbsp;<span class="op" id="4927427">=</span>&nbsp;<span class="builtintype" id="4927429">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927435">return</span>&nbsp;<span class="ident" id="4927442">ecr</span><span class="op" id="4927445">.</span><span class="ident" id="4927446">readCloser</span><span class="op" id="4927456">.</span><span class="ident" id="4927457">Close</span><span class="op" id="4927462">(</span><span class="op" id="4927463">)</span><br>
<span class="lineno"></span><span class="op" id="4927465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4927468">//&nbsp;TimeFormat&nbsp;is&nbsp;the&nbsp;time&nbsp;format&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno">540</span><span class="comment" id="4927513">//&nbsp;time.Parse&nbsp;and&nbsp;time.Time.Format&nbsp;when&nbsp;parsing</span><br>
<span class="lineno"></span><span class="comment" id="4927561">//&nbsp;or&nbsp;generating&nbsp;times&nbsp;in&nbsp;HTTP&nbsp;headers.</span><br>
<span class="lineno"></span><span class="comment" id="4927601">//&nbsp;It&nbsp;is&nbsp;like&nbsp;time.RFC1123&nbsp;but&nbsp;hard&nbsp;codes&nbsp;GMT&nbsp;as&nbsp;the&nbsp;time&nbsp;zone.</span><br>
<span class="lineno"></span><span class="keyword" id="4927665">const</span>&nbsp;<span class="ident" id="4927671">TimeFormat</span>&nbsp;<span class="op" id="4927682">=</span>&nbsp;<span class="string" id="4927684">&#34;Mon,&nbsp;02&nbsp;Jan&nbsp;2006&nbsp;15:04:05&nbsp;GMT&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span><span class="comment" id="4927717">//&nbsp;appendTime&nbsp;is&nbsp;a&nbsp;non-allocating&nbsp;version&nbsp;of&nbsp;[]byte(t.UTC().Format(TimeFormat))</span><br>
<span class="lineno"></span><span class="keyword" id="4927797">func</span>&nbsp;<span class="ident" id="4927802">appendTime</span><span class="op" id="4927812">(</span><span class="ident" id="4927813">b</span>&nbsp;<span class="op" id="4927815">[</span><span class="op" id="4927816">]</span><span class="builtintype" id="4927817">byte</span><span class="op" id="4927821">,</span>&nbsp;<span class="ident" id="4927823">t</span>&nbsp;<span class="ident" id="4927825">time</span><span class="op" id="4927829">.</span><span class="ident" id="4927830">Time</span><span class="op" id="4927834">)</span>&nbsp;<span class="op" id="4927836">[</span><span class="op" id="4927837">]</span><span class="builtintype" id="4927838">byte</span>&nbsp;<span class="op" id="4927843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927846">const</span>&nbsp;<span class="ident" id="4927852">days</span>&nbsp;<span class="op" id="4927857">=</span>&nbsp;<span class="string" id="4927859">&#34;SunMonTueWedThuFriSat&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927884">const</span>&nbsp;<span class="ident" id="4927890">months</span>&nbsp;<span class="op" id="4927897">=</span>&nbsp;<span class="string" id="4927899">&#34;JanFebMarAprMayJunJulAugSepOctNovDec&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927940">t</span>&nbsp;<span class="op" id="4927942">=</span>&nbsp;<span class="ident" id="4927944">t</span><span class="op" id="4927945">.</span><span class="ident" id="4927946">UTC</span><span class="op" id="4927949">(</span><span class="op" id="4927950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927953">yy</span><span class="op" id="4927955">,</span>&nbsp;<span class="ident" id="4927957">mm</span><span class="op" id="4927959">,</span>&nbsp;<span class="ident" id="4927961">dd</span>&nbsp;<span class="op" id="4927964">:=</span>&nbsp;<span class="ident" id="4927967">t</span><span class="op" id="4927968">.</span><span class="ident" id="4927969">Date</span><span class="op" id="4927973">(</span><span class="op" id="4927974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927977">hh</span><span class="op" id="4927979">,</span>&nbsp;<span class="ident" id="4927981">mn</span><span class="op" id="4927983">,</span>&nbsp;<span class="ident" id="4927985">ss</span>&nbsp;<span class="op" id="4927988">:=</span>&nbsp;<span class="ident" id="4927991">t</span><span class="op" id="4927992">.</span><span class="ident" id="4927993">Clock</span><span class="op" id="4927998">(</span><span class="op" id="4927999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4928002">day</span>&nbsp;<span class="op" id="4928006">:=</span>&nbsp;<span class="ident" id="4928009">days</span><span class="op" id="4928013">[</span><span class="num" id="4928014">3</span><span class="op" id="4928015">*</span><span class="ident" id="4928016">t</span><span class="op" id="4928017">.</span><span class="ident" id="4928018">Weekday</span><span class="op" id="4928025">(</span><span class="op" id="4928026">)</span><span class="op" id="4928027">:</span><span class="op" id="4928028">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4928031">mon</span>&nbsp;<span class="op" id="4928035">:=</span>&nbsp;<span class="ident" id="4928038">months</span><span class="op" id="4928044">[</span><span class="num" id="4928045">3</span><span class="op" id="4928046">*</span><span class="op" id="4928047">(</span><span class="ident" id="4928048">mm</span><span class="op" id="4928050">-</span><span class="num" id="4928051">1</span><span class="op" id="4928052">)</span><span class="op" id="4928053">:</span><span class="op" id="4928054">]</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928058">return</span>&nbsp;<span class="builtinfunc" id="4928065">append</span><span class="op" id="4928071">(</span><span class="ident" id="4928072">b</span><span class="op" id="4928073">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4928077">day</span><span class="op" id="4928080">[</span><span class="num" id="4928081">0</span><span class="op" id="4928082">]</span><span class="op" id="4928083">,</span>&nbsp;<span class="ident" id="4928085">day</span><span class="op" id="4928088">[</span><span class="num" id="4928089">1</span><span class="op" id="4928090">]</span><span class="op" id="4928091">,</span>&nbsp;<span class="ident" id="4928093">day</span><span class="op" id="4928096">[</span><span class="num" id="4928097">2</span><span class="op" id="4928098">]</span><span class="op" id="4928099">,</span>&nbsp;<span class="string" id="4928101">&#39;,&#39;</span><span class="op" id="4928104">,</span>&nbsp;<span class="string" id="4928106">&#39;&nbsp;&#39;</span><span class="op" id="4928109">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4928113">byte</span><span class="op" id="4928117">(</span><span class="string" id="4928118">&#39;0&#39;</span><span class="op" id="4928121">+</span><span class="ident" id="4928122">dd</span><span class="op" id="4928124">/</span><span class="num" id="4928125">10</span><span class="op" id="4928127">)</span><span class="op" id="4928128">,</span>&nbsp;<span class="builtintype" id="4928130">byte</span><span class="op" id="4928134">(</span><span class="string" id="4928135">&#39;0&#39;</span><span class="op" id="4928138">+</span><span class="ident" id="4928139">dd</span><span class="op" id="4928141">%</span><span class="num" id="4928142">10</span><span class="op" id="4928144">)</span><span class="op" id="4928145">,</span>&nbsp;<span class="string" id="4928147">&#39;&nbsp;&#39;</span><span class="op" id="4928150">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4928154">mon</span><span class="op" id="4928157">[</span><span class="num" id="4928158">0</span><span class="op" id="4928159">]</span><span class="op" id="4928160">,</span>&nbsp;<span class="ident" id="4928162">mon</span><span class="op" id="4928165">[</span><span class="num" id="4928166">1</span><span class="op" id="4928167">]</span><span class="op" id="4928168">,</span>&nbsp;<span class="ident" id="4928170">mon</span><span class="op" id="4928173">[</span><span class="num" id="4928174">2</span><span class="op" id="4928175">]</span><span class="op" id="4928176">,</span>&nbsp;<span class="string" id="4928178">&#39;&nbsp;&#39;</span><span class="op" id="4928181">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4928185">byte</span><span class="op" id="4928189">(</span><span class="string" id="4928190">&#39;0&#39;</span><span class="op" id="4928193">+</span><span class="ident" id="4928194">yy</span><span class="op" id="4928196">/</span><span class="num" id="4928197">1000</span><span class="op" id="4928201">)</span><span class="op" id="4928202">,</span>&nbsp;<span class="builtintype" id="4928204">byte</span><span class="op" id="4928208">(</span><span class="string" id="4928209">&#39;0&#39;</span><span class="op" id="4928212">+</span><span class="op" id="4928213">(</span><span class="ident" id="4928214">yy</span><span class="op" id="4928216">/</span><span class="num" id="4928217">100</span><span class="op" id="4928220">)</span><span class="op" id="4928221">%</span><span class="num" id="4928222">10</span><span class="op" id="4928224">)</span><span class="op" id="4928225">,</span>&nbsp;<span class="builtintype" id="4928227">byte</span><span class="op" id="4928231">(</span><span class="string" id="4928232">&#39;0&#39;</span><span class="op" id="4928235">+</span><span class="op" id="4928236">(</span><span class="ident" id="4928237">yy</span><span class="op" id="4928239">/</span><span class="num" id="4928240">10</span><span class="op" id="4928242">)</span><span class="op" id="4928243">%</span><span class="num" id="4928244">10</span><span class="op" id="4928246">)</span><span class="op" id="4928247">,</span>&nbsp;<span class="builtintype" id="4928249">byte</span><span class="op" id="4928253">(</span><span class="string" id="4928254">&#39;0&#39;</span><span class="op" id="4928257">+</span><span class="ident" id="4928258">yy</span><span class="op" id="4928260">%</span><span class="num" id="4928261">10</span><span class="op" id="4928263">)</span><span class="op" id="4928264">,</span>&nbsp;<span class="string" id="4928266">&#39;&nbsp;&#39;</span><span class="op" id="4928269">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4928273">byte</span><span class="op" id="4928277">(</span><span class="string" id="4928278">&#39;0&#39;</span><span class="op" id="4928281">+</span><span class="ident" id="4928282">hh</span><span class="op" id="4928284">/</span><span class="num" id="4928285">10</span><span class="op" id="4928287">)</span><span class="op" id="4928288">,</span>&nbsp;<span class="builtintype" id="4928290">byte</span><span class="op" id="4928294">(</span><span class="string" id="4928295">&#39;0&#39;</span><span class="op" id="4928298">+</span><span class="ident" id="4928299">hh</span><span class="op" id="4928301">%</span><span class="num" id="4928302">10</span><span class="op" id="4928304">)</span><span class="op" id="4928305">,</span>&nbsp;<span class="string" id="4928307">&#39;:&#39;</span><span class="op" id="4928310">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4928314">byte</span><span class="op" id="4928318">(</span><span class="string" id="4928319">&#39;0&#39;</span><span class="op" id="4928322">+</span><span class="ident" id="4928323">mn</span><span class="op" id="4928325">/</span><span class="num" id="4928326">10</span><span class="op" id="4928328">)</span><span class="op" id="4928329">,</span>&nbsp;<span class="builtintype" id="4928331">byte</span><span class="op" id="4928335">(</span><span class="string" id="4928336">&#39;0&#39;</span><span class="op" id="4928339">+</span><span class="ident" id="4928340">mn</span><span class="op" id="4928342">%</span><span class="num" id="4928343">10</span><span class="op" id="4928345">)</span><span class="op" id="4928346">,</span>&nbsp;<span class="string" id="4928348">&#39;:&#39;</span><span class="op" id="4928351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4928355">byte</span><span class="op" id="4928359">(</span><span class="string" id="4928360">&#39;0&#39;</span><span class="op" id="4928363">+</span><span class="ident" id="4928364">ss</span><span class="op" id="4928366">/</span><span class="num" id="4928367">10</span><span class="op" id="4928369">)</span><span class="op" id="4928370">,</span>&nbsp;<span class="builtintype" id="4928372">byte</span><span class="op" id="4928376">(</span><span class="string" id="4928377">&#39;0&#39;</span><span class="op" id="4928380">+</span><span class="ident" id="4928381">ss</span><span class="op" id="4928383">%</span><span class="num" id="4928384">10</span><span class="op" id="4928386">)</span><span class="op" id="4928387">,</span>&nbsp;<span class="string" id="4928389">&#39;&nbsp;&#39;</span><span class="op" id="4928392">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4928396">&#39;G&#39;</span><span class="op" id="4928399">,</span>&nbsp;<span class="string" id="4928401">&#39;M&#39;</span><span class="op" id="4928404">,</span>&nbsp;<span class="string" id="4928406">&#39;T&#39;</span><span class="op" id="4928409">)</span><br>
<span class="lineno">565</span><span class="op" id="4928411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4928414">var</span>&nbsp;<span class="ident" id="4928418">errTooLarge</span>&nbsp;<span class="op" id="4928430">=</span>&nbsp;<span class="ident" id="4928432">errors</span><span class="op" id="4928438">.</span><span class="ident" id="4928439">New</span><span class="op" id="4928442">(</span><span class="string" id="4928443">&#34;http:&nbsp;request&nbsp;too&nbsp;large&#34;</span><span class="op" id="4928468">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4928471">//&nbsp;Read&nbsp;next&nbsp;request&nbsp;from&nbsp;connection.</span><br>
<span class="lineno">570</span><span class="keyword" id="4928509">func</span>&nbsp;<span class="op" id="4928514">(</span><span class="ident" id="4928515">c</span>&nbsp;<span class="op" id="4928517">*</span><span class="ident" id="4928518">conn</span><span class="op" id="4928522">)</span>&nbsp;<span class="ident" id="4928524">readRequest</span><span class="op" id="4928535">(</span><span class="op" id="4928536">)</span>&nbsp;<span class="op" id="4928538">(</span><span class="ident" id="4928539">w</span>&nbsp;<span class="op" id="4928541">*</span><span class="ident" id="4928542">response</span><span class="op" id="4928550">,</span>&nbsp;<span class="ident" id="4928552">err</span>&nbsp;<span class="builtintype" id="4928556">error</span><span class="op" id="4928561">)</span>&nbsp;<span class="op" id="4928563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928566">if</span>&nbsp;<span class="ident" id="4928569">c</span><span class="op" id="4928570">.</span><span class="ident" id="4928571">hijacked</span><span class="op" id="4928579">(</span><span class="op" id="4928580">)</span>&nbsp;<span class="op" id="4928582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928586">return</span>&nbsp;<span class="ident" id="4928593">nil</span><span class="op" id="4928596">,</span>&nbsp;<span class="ident" id="4928598">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928615">if</span>&nbsp;<span class="ident" id="4928618">d</span>&nbsp;<span class="op" id="4928620">:=</span>&nbsp;<span class="ident" id="4928623">c</span><span class="op" id="4928624">.</span><span class="ident" id="4928625">server</span><span class="op" id="4928631">.</span><span class="ident" id="4928632">ReadTimeout</span><span class="op" id="4928643">;</span>&nbsp;<span class="ident" id="4928645">d</span>&nbsp;<span class="op" id="4928647">!=</span>&nbsp;<span class="num" id="4928650">0</span>&nbsp;<span class="op" id="4928652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4928656">c</span><span class="op" id="4928657">.</span><span class="ident" id="4928658">rwc</span><span class="op" id="4928661">.</span><span class="ident" id="4928662">SetReadDeadline</span><span class="op" id="4928677">(</span><span class="ident" id="4928678">time</span><span class="op" id="4928682">.</span><span class="ident" id="4928683">Now</span><span class="op" id="4928686">(</span><span class="op" id="4928687">)</span><span class="op" id="4928688">.</span><span class="ident" id="4928689">Add</span><span class="op" id="4928692">(</span><span class="ident" id="4928693">d</span><span class="op" id="4928694">)</span><span class="op" id="4928695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928701">if</span>&nbsp;<span class="ident" id="4928704">d</span>&nbsp;<span class="op" id="4928706">:=</span>&nbsp;<span class="ident" id="4928709">c</span><span class="op" id="4928710">.</span><span class="ident" id="4928711">server</span><span class="op" id="4928717">.</span><span class="ident" id="4928718">WriteTimeout</span><span class="op" id="4928730">;</span>&nbsp;<span class="ident" id="4928732">d</span>&nbsp;<span class="op" id="4928734">!=</span>&nbsp;<span class="num" id="4928737">0</span>&nbsp;<span class="op" id="4928739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928743">defer</span>&nbsp;<span class="keyword" id="4928749">func</span><span class="op" id="4928753">(</span><span class="op" id="4928754">)</span>&nbsp;<span class="op" id="4928756">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4928761">c</span><span class="op" id="4928762">.</span><span class="ident" id="4928763">rwc</span><span class="op" id="4928766">.</span><span class="ident" id="4928767">SetWriteDeadline</span><span class="op" id="4928783">(</span><span class="ident" id="4928784">time</span><span class="op" id="4928788">.</span><span class="ident" id="4928789">Now</span><span class="op" id="4928792">(</span><span class="op" id="4928793">)</span><span class="op" id="4928794">.</span><span class="ident" id="4928795">Add</span><span class="op" id="4928798">(</span><span class="ident" id="4928799">d</span><span class="op" id="4928800">)</span><span class="op" id="4928801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928805">}</span><span class="op" id="4928806">(</span><span class="op" id="4928807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4928814">c</span><span class="op" id="4928815">.</span><span class="ident" id="4928816">lr</span><span class="op" id="4928818">.</span><span class="ident" id="4928819">N</span>&nbsp;<span class="op" id="4928821">=</span>&nbsp;<span class="ident" id="4928823">c</span><span class="op" id="4928824">.</span><span class="ident" id="4928825">server</span><span class="op" id="4928831">.</span><span class="ident" id="4928832">initialLimitedReaderSize</span><span class="op" id="4928856">(</span><span class="op" id="4928857">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928860">var</span>&nbsp;<span class="ident" id="4928864">req</span>&nbsp;<span class="op" id="4928868">*</span><span class="ident" id="4928869">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928878">if</span>&nbsp;<span class="ident" id="4928881">req</span><span class="op" id="4928884">,</span>&nbsp;<span class="ident" id="4928886">err</span>&nbsp;<span class="op" id="4928890">=</span>&nbsp;<span class="ident" id="4928892">ReadRequest</span><span class="op" id="4928903">(</span><span class="ident" id="4928904">c</span><span class="op" id="4928905">.</span><span class="ident" id="4928906">buf</span><span class="op" id="4928909">.</span><span class="ident" id="4928910">Reader</span><span class="op" id="4928916">)</span><span class="op" id="4928917">;</span>&nbsp;<span class="ident" id="4928919">err</span>&nbsp;<span class="op" id="4928923">!=</span>&nbsp;<span class="ident" id="4928926">nil</span>&nbsp;<span class="op" id="4928930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928934">if</span>&nbsp;<span class="ident" id="4928937">c</span><span class="op" id="4928938">.</span><span class="ident" id="4928939">lr</span><span class="op" id="4928941">.</span><span class="ident" id="4928942">N</span>&nbsp;<span class="op" id="4928944">==</span>&nbsp;<span class="num" id="4928947">0</span>&nbsp;<span class="op" id="4928949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928954">return</span>&nbsp;<span class="ident" id="4928961">nil</span><span class="op" id="4928964">,</span>&nbsp;<span class="ident" id="4928966">errTooLarge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928980">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928984">return</span>&nbsp;<span class="ident" id="4928991">nil</span><span class="op" id="4928994">,</span>&nbsp;<span class="ident" id="4928996">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4929001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929004">c</span><span class="op" id="4929005">.</span><span class="ident" id="4929006">lr</span><span class="op" id="4929008">.</span><span class="ident" id="4929009">N</span>&nbsp;<span class="op" id="4929011">=</span>&nbsp;<span class="ident" id="4929013">noLimit</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929023">req</span><span class="op" id="4929026">.</span><span class="ident" id="4929027">RemoteAddr</span>&nbsp;<span class="op" id="4929038">=</span>&nbsp;<span class="ident" id="4929040">c</span><span class="op" id="4929041">.</span><span class="ident" id="4929042">remoteAddr</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929054">req</span><span class="op" id="4929057">.</span><span class="ident" id="4929058">TLS</span>&nbsp;<span class="op" id="4929062">=</span>&nbsp;<span class="ident" id="4929064">c</span><span class="op" id="4929065">.</span><span class="ident" id="4929066">tlsState</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929077">w</span>&nbsp;<span class="op" id="4929079">=</span>&nbsp;<span class="op" id="4929081">&amp;</span><span class="ident" id="4929082">response</span><span class="op" id="4929090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929094">conn</span><span class="op" id="4929098">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4929109">c</span><span class="op" id="4929110">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929114">req</span><span class="op" id="4929117">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4929129">req</span><span class="op" id="4929132">,</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929136">handlerHeader</span><span class="op" id="4929149">:</span>&nbsp;<span class="builtinfunc" id="4929151">make</span><span class="op" id="4929155">(</span><span class="ident" id="4929156">Header</span><span class="op" id="4929162">)</span><span class="op" id="4929163">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929167">contentLength</span><span class="op" id="4929180">:</span>&nbsp;<span class="op" id="4929182">-</span><span class="num" id="4929183">1</span><span class="op" id="4929184">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4929187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929190">w</span><span class="op" id="4929191">.</span><span class="ident" id="4929192">cw</span><span class="op" id="4929194">.</span><span class="ident" id="4929195">res</span>&nbsp;<span class="op" id="4929199">=</span>&nbsp;<span class="ident" id="4929201">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929204">w</span><span class="op" id="4929205">.</span><span class="ident" id="4929206">w</span>&nbsp;<span class="op" id="4929208">=</span>&nbsp;<span class="ident" id="4929210">newBufioWriterSize</span><span class="op" id="4929228">(</span><span class="op" id="4929229">&amp;</span><span class="ident" id="4929230">w</span><span class="op" id="4929231">.</span><span class="ident" id="4929232">cw</span><span class="op" id="4929234">,</span>&nbsp;<span class="ident" id="4929236">bufferBeforeChunkingSize</span><span class="op" id="4929260">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4929263">return</span>&nbsp;<span class="ident" id="4929270">w</span><span class="op" id="4929271">,</span>&nbsp;<span class="ident" id="4929273">nil</span><br>
<span class="lineno"></span><span class="op" id="4929277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4929280">func</span>&nbsp;<span class="op" id="4929285">(</span><span class="ident" id="4929286">w</span>&nbsp;<span class="op" id="4929288">*</span><span class="ident" id="4929289">response</span><span class="op" id="4929297">)</span>&nbsp;<span class="ident" id="4929299">Header</span><span class="op" id="4929305">(</span><span class="op" id="4929306">)</span>&nbsp;<span class="ident" id="4929308">Header</span>&nbsp;<span class="op" id="4929315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4929318">if</span>&nbsp;<span class="ident" id="4929321">w</span><span class="op" id="4929322">.</span><span class="ident" id="4929323">cw</span><span class="op" id="4929325">.</span><span class="ident" id="4929326">header</span>&nbsp;<span class="op" id="4929333">==</span>&nbsp;<span class="ident" id="4929336">nil</span>&nbsp;<span class="op" id="4929340">&amp;&amp;</span>&nbsp;<span class="ident" id="4929343">w</span><span class="op" id="4929344">.</span><span class="ident" id="4929345">wroteHeader</span>&nbsp;<span class="op" id="4929357">&amp;&amp;</span>&nbsp;<span class="op" id="4929360">!</span><span class="ident" id="4929361">w</span><span class="op" id="4929362">.</span><span class="ident" id="4929363">cw</span><span class="op" id="4929365">.</span><span class="ident" id="4929366">wroteHeader</span>&nbsp;<span class="op" id="4929378">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4929382">//&nbsp;Accessing&nbsp;the&nbsp;header&nbsp;between&nbsp;logically&nbsp;writing&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4929437">//&nbsp;and&nbsp;physically&nbsp;writing&nbsp;it&nbsp;means&nbsp;we&nbsp;need&nbsp;to&nbsp;allocate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4929494">//&nbsp;a&nbsp;clone&nbsp;to&nbsp;snapshot&nbsp;the&nbsp;logically&nbsp;written&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929548">w</span><span class="op" id="4929549">.</span><span class="ident" id="4929550">cw</span><span class="op" id="4929552">.</span><span class="ident" id="4929553">header</span>&nbsp;<span class="op" id="4929560">=</span>&nbsp;<span class="ident" id="4929562">w</span><span class="op" id="4929563">.</span><span class="ident" id="4929564">handlerHeader</span><span class="op" id="4929577">.</span><span class="ident" id="4929578">clone</span><span class="op" id="4929583">(</span><span class="op" id="4929584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4929587">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929590">w</span><span class="op" id="4929591">.</span><span class="ident" id="4929592">calledHeader</span>&nbsp;<span class="op" id="4929605">=</span>&nbsp;<span class="builtintype" id="4929607">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4929613">return</span>&nbsp;<span class="ident" id="4929620">w</span><span class="op" id="4929621">.</span><span class="ident" id="4929622">handlerHeader</span><br>
<span class="lineno"></span><span class="op" id="4929636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4929639">//&nbsp;maxPostHandlerReadBytes&nbsp;is&nbsp;the&nbsp;max&nbsp;number&nbsp;of&nbsp;Request.Body&nbsp;bytes&nbsp;not</span><br>
<span class="lineno">620</span><span class="comment" id="4929710">//&nbsp;consumed&nbsp;by&nbsp;a&nbsp;handler&nbsp;that&nbsp;the&nbsp;server&nbsp;will&nbsp;read&nbsp;from&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="4929777">//&nbsp;in&nbsp;order&nbsp;to&nbsp;keep&nbsp;a&nbsp;connection&nbsp;alive.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;more&nbsp;bytes&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="4929847">//&nbsp;this&nbsp;then&nbsp;the&nbsp;server&nbsp;to&nbsp;be&nbsp;paranoid&nbsp;instead&nbsp;sends&nbsp;a&nbsp;&#34;Connection:</span><br>
<span class="lineno"></span><span class="comment" id="4929915">//&nbsp;close&#34;&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="4929935">//</span><br>
<span class="lineno">625</span><span class="comment" id="4929938">//&nbsp;This&nbsp;number&nbsp;is&nbsp;approximately&nbsp;what&nbsp;a&nbsp;typical&nbsp;machine&#39;s&nbsp;TCP&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="4930006">//&nbsp;size&nbsp;is&nbsp;anyway.&nbsp;&nbsp;(if&nbsp;we&nbsp;have&nbsp;the&nbsp;bytes&nbsp;on&nbsp;the&nbsp;machine,&nbsp;we&nbsp;might&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="4930076">//&nbsp;well&nbsp;read&nbsp;them)</span><br>
<span class="lineno"></span><span class="keyword" id="4930095">const</span>&nbsp;<span class="ident" id="4930101">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="4930125">=</span>&nbsp;<span class="num" id="4930127">256</span>&nbsp;<span class="op" id="4930131">&lt;&lt;</span>&nbsp;<span class="num" id="4930134">10</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="4930138">func</span>&nbsp;<span class="op" id="4930143">(</span><span class="ident" id="4930144">w</span>&nbsp;<span class="op" id="4930146">*</span><span class="ident" id="4930147">response</span><span class="op" id="4930155">)</span>&nbsp;<span class="ident" id="4930157">WriteHeader</span><span class="op" id="4930168">(</span><span class="ident" id="4930169">code</span>&nbsp;<span class="builtintype" id="4930174">int</span><span class="op" id="4930177">)</span>&nbsp;<span class="op" id="4930179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930182">if</span>&nbsp;<span class="ident" id="4930185">w</span><span class="op" id="4930186">.</span><span class="ident" id="4930187">conn</span><span class="op" id="4930191">.</span><span class="ident" id="4930192">hijacked</span><span class="op" id="4930200">(</span><span class="op" id="4930201">)</span>&nbsp;<span class="op" id="4930203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930207">w</span><span class="op" id="4930208">.</span><span class="ident" id="4930209">conn</span><span class="op" id="4930213">.</span><span class="ident" id="4930214">server</span><span class="op" id="4930220">.</span><span class="ident" id="4930221">logf</span><span class="op" id="4930225">(</span><span class="string" id="4930226">&#34;http:&nbsp;response.WriteHeader&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="4930277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930281">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4930289">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930292">if</span>&nbsp;<span class="ident" id="4930295">w</span><span class="op" id="4930296">.</span><span class="ident" id="4930297">wroteHeader</span>&nbsp;<span class="op" id="4930309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930313">w</span><span class="op" id="4930314">.</span><span class="ident" id="4930315">conn</span><span class="op" id="4930319">.</span><span class="ident" id="4930320">server</span><span class="op" id="4930326">.</span><span class="ident" id="4930327">logf</span><span class="op" id="4930331">(</span><span class="string" id="4930332">&#34;http:&nbsp;multiple&nbsp;response.WriteHeader&nbsp;calls&#34;</span><span class="op" id="4930375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930379">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4930387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930390">w</span><span class="op" id="4930391">.</span><span class="ident" id="4930392">wroteHeader</span>&nbsp;<span class="op" id="4930404">=</span>&nbsp;<span class="builtintype" id="4930406">true</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930412">w</span><span class="op" id="4930413">.</span><span class="ident" id="4930414">status</span>&nbsp;<span class="op" id="4930421">=</span>&nbsp;<span class="ident" id="4930423">code</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930430">if</span>&nbsp;<span class="ident" id="4930433">w</span><span class="op" id="4930434">.</span><span class="ident" id="4930435">calledHeader</span>&nbsp;<span class="op" id="4930448">&amp;&amp;</span>&nbsp;<span class="ident" id="4930451">w</span><span class="op" id="4930452">.</span><span class="ident" id="4930453">cw</span><span class="op" id="4930455">.</span><span class="ident" id="4930456">header</span>&nbsp;<span class="op" id="4930463">==</span>&nbsp;<span class="ident" id="4930466">nil</span>&nbsp;<span class="op" id="4930470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930474">w</span><span class="op" id="4930475">.</span><span class="ident" id="4930476">cw</span><span class="op" id="4930478">.</span><span class="ident" id="4930479">header</span>&nbsp;<span class="op" id="4930486">=</span>&nbsp;<span class="ident" id="4930488">w</span><span class="op" id="4930489">.</span><span class="ident" id="4930490">handlerHeader</span><span class="op" id="4930503">.</span><span class="ident" id="4930504">clone</span><span class="op" id="4930509">(</span><span class="op" id="4930510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4930513">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930517">if</span>&nbsp;<span class="ident" id="4930520">cl</span>&nbsp;<span class="op" id="4930523">:=</span>&nbsp;<span class="ident" id="4930526">w</span><span class="op" id="4930527">.</span><span class="ident" id="4930528">handlerHeader</span><span class="op" id="4930541">.</span><span class="ident" id="4930542">get</span><span class="op" id="4930545">(</span><span class="string" id="4930546">&#34;Content-Length&#34;</span><span class="op" id="4930562">)</span><span class="op" id="4930563">;</span>&nbsp;<span class="ident" id="4930565">cl</span>&nbsp;<span class="op" id="4930568">!=</span>&nbsp;<span class="string" id="4930571">&#34;&#34;</span>&nbsp;<span class="op" id="4930574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930578">v</span><span class="op" id="4930579">,</span>&nbsp;<span class="ident" id="4930581">err</span>&nbsp;<span class="op" id="4930585">:=</span>&nbsp;<span class="ident" id="4930588">strconv</span><span class="op" id="4930595">.</span><span class="ident" id="4930596">ParseInt</span><span class="op" id="4930604">(</span><span class="ident" id="4930605">cl</span><span class="op" id="4930607">,</span>&nbsp;<span class="num" id="4930609">10</span><span class="op" id="4930611">,</span>&nbsp;<span class="num" id="4930613">64</span><span class="op" id="4930615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930619">if</span>&nbsp;<span class="ident" id="4930622">err</span>&nbsp;<span class="op" id="4930626">==</span>&nbsp;<span class="ident" id="4930629">nil</span>&nbsp;<span class="op" id="4930633">&amp;&amp;</span>&nbsp;<span class="ident" id="4930636">v</span>&nbsp;<span class="op" id="4930638">&gt;=</span>&nbsp;<span class="num" id="4930641">0</span>&nbsp;<span class="op" id="4930643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930648">w</span><span class="op" id="4930649">.</span><span class="ident" id="4930650">contentLength</span>&nbsp;<span class="op" id="4930664">=</span>&nbsp;<span class="ident" id="4930666">v</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4930670">}</span>&nbsp;<span class="keyword" id="4930672">else</span>&nbsp;<span class="op" id="4930677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930682">w</span><span class="op" id="4930683">.</span><span class="ident" id="4930684">conn</span><span class="op" id="4930688">.</span><span class="ident" id="4930689">server</span><span class="op" id="4930695">.</span><span class="ident" id="4930696">logf</span><span class="op" id="4930700">(</span><span class="string" id="4930701">&#34;http:&nbsp;invalid&nbsp;Content-Length&nbsp;of&nbsp;%q&#34;</span><span class="op" id="4930737">,</span>&nbsp;<span class="ident" id="4930739">cl</span><span class="op" id="4930741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930746">w</span><span class="op" id="4930747">.</span><span class="ident" id="4930748">handlerHeader</span><span class="op" id="4930761">.</span><span class="ident" id="4930762">Del</span><span class="op" id="4930765">(</span><span class="string" id="4930766">&#34;Content-Length&#34;</span><span class="op" id="4930782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4930786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4930789">}</span><br>
<span class="lineno">655</span><span class="op" id="4930791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4930794">//&nbsp;extraHeader&nbsp;is&nbsp;the&nbsp;set&nbsp;of&nbsp;headers&nbsp;sometimes&nbsp;added&nbsp;by&nbsp;chunkWriter.writeHeader.</span><br>
<span class="lineno"></span><span class="comment" id="4930875">//&nbsp;This&nbsp;type&nbsp;is&nbsp;used&nbsp;to&nbsp;avoid&nbsp;extra&nbsp;allocations&nbsp;from&nbsp;cloning&nbsp;and/or&nbsp;populating</span><br>
<span class="lineno"></span><span class="comment" id="4930954">//&nbsp;the&nbsp;response&nbsp;Header&nbsp;map&nbsp;and&nbsp;all&nbsp;its&nbsp;1-element&nbsp;slices.</span><br>
<span class="lineno">660</span><span class="keyword" id="4931011">type</span>&nbsp;<span class="ident" id="4931016">extraHeader</span>&nbsp;<span class="keyword" id="4931028">struct</span>&nbsp;<span class="op" id="4931035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931038">contentType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4931055">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931063">connection</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4931080">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931088">transferEncoding</span>&nbsp;<span class="builtintype" id="4931105">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931113">date</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4931130">[</span><span class="op" id="4931131">]</span><span class="builtintype" id="4931132">byte</span>&nbsp;<span class="comment" id="4931137">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931160">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4931177">[</span><span class="op" id="4931178">]</span><span class="builtintype" id="4931179">byte</span>&nbsp;<span class="comment" id="4931184">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="4931206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4931209">//&nbsp;Sorted&nbsp;the&nbsp;same&nbsp;as&nbsp;extraHeader.Write&#39;s&nbsp;loop.</span><br>
<span class="lineno"></span><span class="keyword" id="4931257">var</span>&nbsp;<span class="ident" id="4931261">extraHeaderKeys</span>&nbsp;<span class="op" id="4931277">=</span>&nbsp;<span class="op" id="4931279">[</span><span class="op" id="4931280">]</span><span class="op" id="4931281">[</span><span class="op" id="4931282">]</span><span class="builtintype" id="4931283">byte</span><span class="op" id="4931287">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4931290">[</span><span class="op" id="4931291">]</span><span class="builtintype" id="4931292">byte</span><span class="op" id="4931296">(</span><span class="string" id="4931297">&#34;Content-Type&#34;</span><span class="op" id="4931311">)</span><span class="op" id="4931312">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4931315">[</span><span class="op" id="4931316">]</span><span class="builtintype" id="4931317">byte</span><span class="op" id="4931321">(</span><span class="string" id="4931322">&#34;Connection&#34;</span><span class="op" id="4931334">)</span><span class="op" id="4931335">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4931338">[</span><span class="op" id="4931339">]</span><span class="builtintype" id="4931340">byte</span><span class="op" id="4931344">(</span><span class="string" id="4931345">&#34;Transfer-Encoding&#34;</span><span class="op" id="4931364">)</span><span class="op" id="4931365">,</span><br>
<span class="lineno"></span><span class="op" id="4931367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span><span class="keyword" id="4931370">var</span>&nbsp;<span class="op" id="4931374">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931377">headerContentLength</span>&nbsp;<span class="op" id="4931397">=</span>&nbsp;<span class="op" id="4931399">[</span><span class="op" id="4931400">]</span><span class="builtintype" id="4931401">byte</span><span class="op" id="4931405">(</span><span class="string" id="4931406">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="4931424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931427">headerDate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4931447">=</span>&nbsp;<span class="op" id="4931449">[</span><span class="op" id="4931450">]</span><span class="builtintype" id="4931451">byte</span><span class="op" id="4931455">(</span><span class="string" id="4931456">&#34;Date:&nbsp;&#34;</span><span class="op" id="4931464">)</span><br>
<span class="lineno"></span><span class="op" id="4931466">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="comment" id="4931469">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;headers&nbsp;described&nbsp;in&nbsp;h&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="4931518">//</span><br>
<span class="lineno"></span><span class="comment" id="4931521">//&nbsp;This&nbsp;method&nbsp;has&nbsp;a&nbsp;value&nbsp;receiver,&nbsp;despite&nbsp;the&nbsp;somewhat&nbsp;large&nbsp;size</span><br>
<span class="lineno"></span><span class="comment" id="4931590">//&nbsp;of&nbsp;h,&nbsp;because&nbsp;it&nbsp;prevents&nbsp;an&nbsp;allocation.&nbsp;The&nbsp;escape&nbsp;analysis&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="4931660">//&nbsp;smart&nbsp;enough&nbsp;to&nbsp;realize&nbsp;this&nbsp;function&nbsp;doesn&#39;t&nbsp;mutate&nbsp;h.</span><br>
<span class="lineno">685</span><span class="keyword" id="4931719">func</span>&nbsp;<span class="op" id="4931724">(</span><span class="ident" id="4931725">h</span>&nbsp;<span class="ident" id="4931727">extraHeader</span><span class="op" id="4931738">)</span>&nbsp;<span class="ident" id="4931740">Write</span><span class="op" id="4931745">(</span><span class="ident" id="4931746">w</span>&nbsp;<span class="op" id="4931748">*</span><span class="ident" id="4931749">bufio</span><span class="op" id="4931754">.</span><span class="ident" id="4931755">Writer</span><span class="op" id="4931761">)</span>&nbsp;<span class="op" id="4931763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4931766">if</span>&nbsp;<span class="ident" id="4931769">h</span><span class="op" id="4931770">.</span><span class="ident" id="4931771">date</span>&nbsp;<span class="op" id="4931776">!=</span>&nbsp;<span class="ident" id="4931779">nil</span>&nbsp;<span class="op" id="4931783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931787">w</span><span class="op" id="4931788">.</span><span class="ident" id="4931789">Write</span><span class="op" id="4931794">(</span><span class="ident" id="4931795">headerDate</span><span class="op" id="4931805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931809">w</span><span class="op" id="4931810">.</span><span class="ident" id="4931811">Write</span><span class="op" id="4931816">(</span><span class="ident" id="4931817">h</span><span class="op" id="4931818">.</span><span class="ident" id="4931819">date</span><span class="op" id="4931823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931827">w</span><span class="op" id="4931828">.</span><span class="ident" id="4931829">Write</span><span class="op" id="4931834">(</span><span class="ident" id="4931835">crlf</span><span class="op" id="4931839">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4931842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4931845">if</span>&nbsp;<span class="ident" id="4931848">h</span><span class="op" id="4931849">.</span><span class="ident" id="4931850">contentLength</span>&nbsp;<span class="op" id="4931864">!=</span>&nbsp;<span class="ident" id="4931867">nil</span>&nbsp;<span class="op" id="4931871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931875">w</span><span class="op" id="4931876">.</span><span class="ident" id="4931877">Write</span><span class="op" id="4931882">(</span><span class="ident" id="4931883">headerContentLength</span><span class="op" id="4931902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931906">w</span><span class="op" id="4931907">.</span><span class="ident" id="4931908">Write</span><span class="op" id="4931913">(</span><span class="ident" id="4931914">h</span><span class="op" id="4931915">.</span><span class="ident" id="4931916">contentLength</span><span class="op" id="4931929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931933">w</span><span class="op" id="4931934">.</span><span class="ident" id="4931935">Write</span><span class="op" id="4931940">(</span><span class="ident" id="4931941">crlf</span><span class="op" id="4931945">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4931948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4931951">for</span>&nbsp;<span class="ident" id="4931955">i</span><span class="op" id="4931956">,</span>&nbsp;<span class="ident" id="4931958">v</span>&nbsp;<span class="op" id="4931960">:=</span>&nbsp;<span class="keyword" id="4931963">range</span>&nbsp;<span class="op" id="4931969">[</span><span class="op" id="4931970">]</span><span class="builtintype" id="4931971">string</span><span class="op" id="4931977">{</span><span class="ident" id="4931978">h</span><span class="op" id="4931979">.</span><span class="ident" id="4931980">contentType</span><span class="op" id="4931991">,</span>&nbsp;<span class="ident" id="4931993">h</span><span class="op" id="4931994">.</span><span class="ident" id="4931995">connection</span><span class="op" id="4932005">,</span>&nbsp;<span class="ident" id="4932007">h</span><span class="op" id="4932008">.</span><span class="ident" id="4932009">transferEncoding</span><span class="op" id="4932025">}</span>&nbsp;<span class="op" id="4932027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932031">if</span>&nbsp;<span class="ident" id="4932034">v</span>&nbsp;<span class="op" id="4932036">!=</span>&nbsp;<span class="string" id="4932039">&#34;&#34;</span>&nbsp;<span class="op" id="4932042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932047">w</span><span class="op" id="4932048">.</span><span class="ident" id="4932049">Write</span><span class="op" id="4932054">(</span><span class="ident" id="4932055">extraHeaderKeys</span><span class="op" id="4932070">[</span><span class="ident" id="4932071">i</span><span class="op" id="4932072">]</span><span class="op" id="4932073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932078">w</span><span class="op" id="4932079">.</span><span class="ident" id="4932080">Write</span><span class="op" id="4932085">(</span><span class="ident" id="4932086">colonSpace</span><span class="op" id="4932096">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932101">w</span><span class="op" id="4932102">.</span><span class="ident" id="4932103">WriteString</span><span class="op" id="4932114">(</span><span class="ident" id="4932115">v</span><span class="op" id="4932116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932121">w</span><span class="op" id="4932122">.</span><span class="ident" id="4932123">Write</span><span class="op" id="4932128">(</span><span class="ident" id="4932129">crlf</span><span class="op" id="4932133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4932137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4932140">}</span><br>
<span class="lineno"></span><span class="op" id="4932142">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="comment" id="4932145">//&nbsp;writeHeader&nbsp;finalizes&nbsp;the&nbsp;header&nbsp;sent&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;writes&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="4932214">//&nbsp;to&nbsp;cw.res.conn.buf.</span><br>
<span class="lineno"></span><span class="comment" id="4932237">//</span><br>
<span class="lineno"></span><span class="comment" id="4932240">//&nbsp;p&nbsp;is&nbsp;not&nbsp;written&nbsp;by&nbsp;writeHeader,&nbsp;but&nbsp;is&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;the&nbsp;body</span><br>
<span class="lineno">710</span><span class="comment" id="4932311">//&nbsp;that&nbsp;will&nbsp;be&nbsp;written.&nbsp;&nbsp;It&nbsp;is&nbsp;sniffed&nbsp;for&nbsp;a&nbsp;Content-Type&nbsp;if&nbsp;none&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4932381">//&nbsp;set&nbsp;explicitly.&nbsp;&nbsp;It&#39;s&nbsp;also&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;Content-Length,&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4932450">//&nbsp;total&nbsp;body&nbsp;size&nbsp;was&nbsp;small&nbsp;and&nbsp;the&nbsp;handler&nbsp;has&nbsp;already&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="4932516">//&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword" id="4932528">func</span>&nbsp;<span class="op" id="4932533">(</span><span class="ident" id="4932534">cw</span>&nbsp;<span class="op" id="4932537">*</span><span class="ident" id="4932538">chunkWriter</span><span class="op" id="4932549">)</span>&nbsp;<span class="ident" id="4932551">writeHeader</span><span class="op" id="4932562">(</span><span class="ident" id="4932563">p</span>&nbsp;<span class="op" id="4932565">[</span><span class="op" id="4932566">]</span><span class="builtintype" id="4932567">byte</span><span class="op" id="4932571">)</span>&nbsp;<span class="op" id="4932573">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932576">if</span>&nbsp;<span class="ident" id="4932579">cw</span><span class="op" id="4932581">.</span><span class="ident" id="4932582">wroteHeader</span>&nbsp;<span class="op" id="4932594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932598">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4932606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932609">cw</span><span class="op" id="4932611">.</span><span class="ident" id="4932612">wroteHeader</span>&nbsp;<span class="op" id="4932624">=</span>&nbsp;<span class="builtintype" id="4932626">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932633">w</span>&nbsp;<span class="op" id="4932635">:=</span>&nbsp;<span class="ident" id="4932638">cw</span><span class="op" id="4932640">.</span><span class="ident" id="4932641">res</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932646">keepAlivesEnabled</span>&nbsp;<span class="op" id="4932664">:=</span>&nbsp;<span class="ident" id="4932667">w</span><span class="op" id="4932668">.</span><span class="ident" id="4932669">conn</span><span class="op" id="4932673">.</span><span class="ident" id="4932674">server</span><span class="op" id="4932680">.</span><span class="ident" id="4932681">doKeepAlives</span><span class="op" id="4932693">(</span><span class="op" id="4932694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932697">isHEAD</span>&nbsp;<span class="op" id="4932704">:=</span>&nbsp;<span class="ident" id="4932707">w</span><span class="op" id="4932708">.</span><span class="ident" id="4932709">req</span><span class="op" id="4932712">.</span><span class="ident" id="4932713">Method</span>&nbsp;<span class="op" id="4932720">==</span>&nbsp;<span class="string" id="4932723">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4932732">//&nbsp;header&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;w.conn.buf&nbsp;below.&nbsp;Depending&nbsp;on&nbsp;the</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4932796">//&nbsp;state&nbsp;of&nbsp;the&nbsp;handler,&nbsp;we&nbsp;either&nbsp;own&nbsp;the&nbsp;map&nbsp;or&nbsp;not.&nbsp;If&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4932858">//&nbsp;don&#39;t&nbsp;own&nbsp;it,&nbsp;the&nbsp;exclude&nbsp;map&nbsp;is&nbsp;created&nbsp;lazily&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4932914">//&nbsp;WriteSubset&nbsp;to&nbsp;remove&nbsp;headers.&nbsp;The&nbsp;setHeader&nbsp;struct&nbsp;holds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4932976">//&nbsp;headers&nbsp;we&nbsp;need&nbsp;to&nbsp;add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933004">header</span>&nbsp;<span class="op" id="4933011">:=</span>&nbsp;<span class="ident" id="4933014">cw</span><span class="op" id="4933016">.</span><span class="ident" id="4933017">header</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933025">owned</span>&nbsp;<span class="op" id="4933031">:=</span>&nbsp;<span class="ident" id="4933034">header</span>&nbsp;<span class="op" id="4933041">!=</span>&nbsp;<span class="ident" id="4933044">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933049">if</span>&nbsp;<span class="op" id="4933052">!</span><span class="ident" id="4933053">owned</span>&nbsp;<span class="op" id="4933059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933063">header</span>&nbsp;<span class="op" id="4933070">=</span>&nbsp;<span class="ident" id="4933072">w</span><span class="op" id="4933073">.</span><span class="ident" id="4933074">handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933092">var</span>&nbsp;<span class="ident" id="4933096">excludeHeader</span>&nbsp;<span class="keyword" id="4933110">map</span><span class="op" id="4933113">[</span><span class="builtintype" id="4933114">string</span><span class="op" id="4933120">]</span><span class="builtintype" id="4933121">bool</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933127">delHeader</span>&nbsp;<span class="op" id="4933137">:=</span>&nbsp;<span class="keyword" id="4933140">func</span><span class="op" id="4933144">(</span><span class="ident" id="4933145">key</span>&nbsp;<span class="builtintype" id="4933149">string</span><span class="op" id="4933155">)</span>&nbsp;<span class="op" id="4933157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933161">if</span>&nbsp;<span class="ident" id="4933164">owned</span>&nbsp;<span class="op" id="4933170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933175">header</span><span class="op" id="4933181">.</span><span class="ident" id="4933182">Del</span><span class="op" id="4933185">(</span><span class="ident" id="4933186">key</span><span class="op" id="4933189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933194">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933203">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933207">if</span>&nbsp;<span class="ident" id="4933210">_</span><span class="op" id="4933211">,</span>&nbsp;<span class="ident" id="4933213">ok</span>&nbsp;<span class="op" id="4933216">:=</span>&nbsp;<span class="ident" id="4933219">header</span><span class="op" id="4933225">[</span><span class="ident" id="4933226">key</span><span class="op" id="4933229">]</span><span class="op" id="4933230">;</span>&nbsp;<span class="op" id="4933232">!</span><span class="ident" id="4933233">ok</span>&nbsp;<span class="op" id="4933236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933241">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933254">if</span>&nbsp;<span class="ident" id="4933257">excludeHeader</span>&nbsp;<span class="op" id="4933271">==</span>&nbsp;<span class="ident" id="4933274">nil</span>&nbsp;<span class="op" id="4933278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933283">excludeHeader</span>&nbsp;<span class="op" id="4933297">=</span>&nbsp;<span class="builtinfunc" id="4933299">make</span><span class="op" id="4933303">(</span><span class="keyword" id="4933304">map</span><span class="op" id="4933307">[</span><span class="builtintype" id="4933308">string</span><span class="op" id="4933314">]</span><span class="builtintype" id="4933315">bool</span><span class="op" id="4933319">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933327">excludeHeader</span><span class="op" id="4933340">[</span><span class="ident" id="4933341">key</span><span class="op" id="4933344">]</span>&nbsp;<span class="op" id="4933346">=</span>&nbsp;<span class="builtintype" id="4933348">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933357">var</span>&nbsp;<span class="ident" id="4933361">setHeader</span>&nbsp;<span class="ident" id="4933371">extraHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933385">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;is&nbsp;done&nbsp;but&nbsp;never&nbsp;sent&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933444">//&nbsp;response&nbsp;header&nbsp;and&nbsp;this&nbsp;is&nbsp;our&nbsp;first&nbsp;(and&nbsp;last)&nbsp;write,&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933508">//&nbsp;it,&nbsp;even&nbsp;to&nbsp;zero.&nbsp;This&nbsp;helps&nbsp;HTTP/1.0&nbsp;clients&nbsp;keep&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933569">//&nbsp;&#34;keep-alive&#34;&nbsp;connections&nbsp;alive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933605">//&nbsp;Exceptions:&nbsp;304/204/1xx&nbsp;responses&nbsp;never&nbsp;get&nbsp;Content-Length,&nbsp;and&nbsp;if</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933676">//&nbsp;it&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;difference&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933740">//&nbsp;0&nbsp;actual&nbsp;bytes&nbsp;and&nbsp;0&nbsp;bytes&nbsp;because&nbsp;the&nbsp;handler&nbsp;noticed&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933802">//&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;and&nbsp;chose&nbsp;not&nbsp;to&nbsp;write&nbsp;anything.&nbsp;&nbsp;So&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933866">//&nbsp;HEAD,&nbsp;the&nbsp;handler&nbsp;should&nbsp;either&nbsp;write&nbsp;the&nbsp;Content-Length&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933930">//&nbsp;write&nbsp;non-zero&nbsp;bytes.&nbsp;&nbsp;If&nbsp;it&#39;s&nbsp;actually&nbsp;0&nbsp;bytes&nbsp;and&nbsp;the</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933990">//&nbsp;handler&nbsp;never&nbsp;looked&nbsp;at&nbsp;the&nbsp;Request.Method,&nbsp;we&nbsp;just&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4934052">//&nbsp;send&nbsp;a&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934086">if</span>&nbsp;<span class="ident" id="4934089">w</span><span class="op" id="4934090">.</span><span class="ident" id="4934091">handlerDone</span>&nbsp;<span class="op" id="4934103">&amp;&amp;</span>&nbsp;<span class="ident" id="4934106">bodyAllowedForStatus</span><span class="op" id="4934126">(</span><span class="ident" id="4934127">w</span><span class="op" id="4934128">.</span><span class="ident" id="4934129">status</span><span class="op" id="4934135">)</span>&nbsp;<span class="op" id="4934137">&amp;&amp;</span>&nbsp;<span class="ident" id="4934140">header</span><span class="op" id="4934146">.</span><span class="ident" id="4934147">get</span><span class="op" id="4934150">(</span><span class="string" id="4934151">&#34;Content-Length&#34;</span><span class="op" id="4934167">)</span>&nbsp;<span class="op" id="4934169">==</span>&nbsp;<span class="string" id="4934172">&#34;&#34;</span>&nbsp;<span class="op" id="4934175">&amp;&amp;</span>&nbsp;<span class="op" id="4934178">(</span><span class="op" id="4934179">!</span><span class="ident" id="4934180">isHEAD</span>&nbsp;<span class="op" id="4934187">||</span>&nbsp;<span class="builtinfunc" id="4934190">len</span><span class="op" id="4934193">(</span><span class="ident" id="4934194">p</span><span class="op" id="4934195">)</span>&nbsp;<span class="op" id="4934197">&gt;</span>&nbsp;<span class="num" id="4934199">0</span><span class="op" id="4934200">)</span>&nbsp;<span class="op" id="4934202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934206">w</span><span class="op" id="4934207">.</span><span class="ident" id="4934208">contentLength</span>&nbsp;<span class="op" id="4934222">=</span>&nbsp;<span class="ident" id="4934224">int64</span><span class="op" id="4934229">(</span><span class="builtinfunc" id="4934230">len</span><span class="op" id="4934233">(</span><span class="ident" id="4934234">p</span><span class="op" id="4934235">)</span><span class="op" id="4934236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934240">setHeader</span><span class="op" id="4934249">.</span><span class="ident" id="4934250">contentLength</span>&nbsp;<span class="op" id="4934264">=</span>&nbsp;<span class="ident" id="4934266">strconv</span><span class="op" id="4934273">.</span><span class="ident" id="4934274">AppendInt</span><span class="op" id="4934283">(</span><span class="ident" id="4934284">cw</span><span class="op" id="4934286">.</span><span class="ident" id="4934287">res</span><span class="op" id="4934290">.</span><span class="ident" id="4934291">clenBuf</span><span class="op" id="4934298">[</span><span class="op" id="4934299">:</span><span class="num" id="4934300">0</span><span class="op" id="4934301">]</span><span class="op" id="4934302">,</span>&nbsp;<span class="ident" id="4934304">int64</span><span class="op" id="4934309">(</span><span class="builtinfunc" id="4934310">len</span><span class="op" id="4934313">(</span><span class="ident" id="4934314">p</span><span class="op" id="4934315">)</span><span class="op" id="4934316">)</span><span class="op" id="4934317">,</span>&nbsp;<span class="num" id="4934319">10</span><span class="op" id="4934321">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4934328">//&nbsp;If&nbsp;this&nbsp;was&nbsp;an&nbsp;HTTP/1.0&nbsp;request&nbsp;with&nbsp;keep-alive&nbsp;and&nbsp;we&nbsp;sent&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4934394">//&nbsp;Content-Length&nbsp;back,&nbsp;we&nbsp;can&nbsp;make&nbsp;this&nbsp;a&nbsp;keep-alive&nbsp;response&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934462">if</span>&nbsp;<span class="ident" id="4934465">w</span><span class="op" id="4934466">.</span><span class="ident" id="4934467">req</span><span class="op" id="4934470">.</span><span class="ident" id="4934471">wantsHttp10KeepAlive</span><span class="op" id="4934491">(</span><span class="op" id="4934492">)</span>&nbsp;<span class="op" id="4934494">&amp;&amp;</span>&nbsp;<span class="ident" id="4934497">keepAlivesEnabled</span>&nbsp;<span class="op" id="4934515">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934519">sentLength</span>&nbsp;<span class="op" id="4934530">:=</span>&nbsp;<span class="ident" id="4934533">header</span><span class="op" id="4934539">.</span><span class="ident" id="4934540">get</span><span class="op" id="4934543">(</span><span class="string" id="4934544">&#34;Content-Length&#34;</span><span class="op" id="4934560">)</span>&nbsp;<span class="op" id="4934562">!=</span>&nbsp;<span class="string" id="4934565">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934570">if</span>&nbsp;<span class="ident" id="4934573">sentLength</span>&nbsp;<span class="op" id="4934584">&amp;&amp;</span>&nbsp;<span class="ident" id="4934587">header</span><span class="op" id="4934593">.</span><span class="ident" id="4934594">get</span><span class="op" id="4934597">(</span><span class="string" id="4934598">&#34;Connection&#34;</span><span class="op" id="4934610">)</span>&nbsp;<span class="op" id="4934612">==</span>&nbsp;<span class="string" id="4934615">&#34;keep-alive&#34;</span>&nbsp;<span class="op" id="4934628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934633">w</span><span class="op" id="4934634">.</span><span class="ident" id="4934635">closeAfterReply</span>&nbsp;<span class="op" id="4934651">=</span>&nbsp;<span class="builtintype" id="4934653">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934664">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4934668">//&nbsp;Check&nbsp;for&nbsp;a&nbsp;explicit&nbsp;(and&nbsp;valid)&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934728">hasCL</span>&nbsp;<span class="op" id="4934734">:=</span>&nbsp;<span class="ident" id="4934737">w</span><span class="op" id="4934738">.</span><span class="ident" id="4934739">contentLength</span>&nbsp;<span class="op" id="4934753">!=</span>&nbsp;<span class="op" id="4934756">-</span><span class="num" id="4934757">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934761">if</span>&nbsp;<span class="ident" id="4934764">w</span><span class="op" id="4934765">.</span><span class="ident" id="4934766">req</span><span class="op" id="4934769">.</span><span class="ident" id="4934770">wantsHttp10KeepAlive</span><span class="op" id="4934790">(</span><span class="op" id="4934791">)</span>&nbsp;<span class="op" id="4934793">&amp;&amp;</span>&nbsp;<span class="op" id="4934796">(</span><span class="ident" id="4934797">isHEAD</span>&nbsp;<span class="op" id="4934804">||</span>&nbsp;<span class="ident" id="4934807">hasCL</span><span class="op" id="4934812">)</span>&nbsp;<span class="op" id="4934814">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934818">_</span><span class="op" id="4934819">,</span>&nbsp;<span class="ident" id="4934821">connectionHeaderSet</span>&nbsp;<span class="op" id="4934841">:=</span>&nbsp;<span class="ident" id="4934844">header</span><span class="op" id="4934850">[</span><span class="string" id="4934851">&#34;Connection&#34;</span><span class="op" id="4934863">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934867">if</span>&nbsp;<span class="op" id="4934870">!</span><span class="ident" id="4934871">connectionHeaderSet</span>&nbsp;<span class="op" id="4934891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934896">setHeader</span><span class="op" id="4934905">.</span><span class="ident" id="4934906">connection</span>&nbsp;<span class="op" id="4934917">=</span>&nbsp;<span class="string" id="4934919">&#34;keep-alive&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934937">}</span>&nbsp;<span class="keyword" id="4934939">else</span>&nbsp;<span class="keyword" id="4934944">if</span>&nbsp;<span class="op" id="4934947">!</span><span class="ident" id="4934948">w</span><span class="op" id="4934949">.</span><span class="ident" id="4934950">req</span><span class="op" id="4934953">.</span><span class="ident" id="4934954">ProtoAtLeast</span><span class="op" id="4934966">(</span><span class="num" id="4934967">1</span><span class="op" id="4934968">,</span>&nbsp;<span class="num" id="4934970">1</span><span class="op" id="4934971">)</span>&nbsp;<span class="op" id="4934973">||</span>&nbsp;<span class="ident" id="4934976">w</span><span class="op" id="4934977">.</span><span class="ident" id="4934978">req</span><span class="op" id="4934981">.</span><span class="ident" id="4934982">wantsClose</span><span class="op" id="4934992">(</span><span class="op" id="4934993">)</span>&nbsp;<span class="op" id="4934995">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934999">w</span><span class="op" id="4935000">.</span><span class="ident" id="4935001">closeAfterReply</span>&nbsp;<span class="op" id="4935017">=</span>&nbsp;<span class="builtintype" id="4935019">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935029">if</span>&nbsp;<span class="ident" id="4935032">header</span><span class="op" id="4935038">.</span><span class="ident" id="4935039">get</span><span class="op" id="4935042">(</span><span class="string" id="4935043">&#34;Connection&#34;</span><span class="op" id="4935055">)</span>&nbsp;<span class="op" id="4935057">==</span>&nbsp;<span class="string" id="4935060">&#34;close&#34;</span>&nbsp;<span class="op" id="4935068">||</span>&nbsp;<span class="op" id="4935071">!</span><span class="ident" id="4935072">keepAlivesEnabled</span>&nbsp;<span class="op" id="4935090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935094">w</span><span class="op" id="4935095">.</span><span class="ident" id="4935096">closeAfterReply</span>&nbsp;<span class="op" id="4935112">=</span>&nbsp;<span class="builtintype" id="4935114">true</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4935124">//&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;we&nbsp;should&nbsp;consume&nbsp;the&nbsp;request&nbsp;body&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4935184">//&nbsp;replying,&nbsp;if&nbsp;the&nbsp;handler&nbsp;hasn&#39;t&nbsp;already&nbsp;done&nbsp;so.&nbsp;&nbsp;But&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4935245">//&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;an&nbsp;unbounded&nbsp;amount&nbsp;of&nbsp;reading&nbsp;here&nbsp;for</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4935306">//&nbsp;DoS&nbsp;reasons,&nbsp;so&nbsp;we&nbsp;only&nbsp;try&nbsp;up&nbsp;to&nbsp;a&nbsp;threshold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935357">if</span>&nbsp;<span class="ident" id="4935360">w</span><span class="op" id="4935361">.</span><span class="ident" id="4935362">req</span><span class="op" id="4935365">.</span><span class="ident" id="4935366">ContentLength</span>&nbsp;<span class="op" id="4935380">!=</span>&nbsp;<span class="num" id="4935383">0</span>&nbsp;<span class="op" id="4935385">&amp;&amp;</span>&nbsp;<span class="op" id="4935388">!</span><span class="ident" id="4935389">w</span><span class="op" id="4935390">.</span><span class="ident" id="4935391">closeAfterReply</span>&nbsp;<span class="op" id="4935407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935411">ecr</span><span class="op" id="4935414">,</span>&nbsp;<span class="ident" id="4935416">isExpecter</span>&nbsp;<span class="op" id="4935427">:=</span>&nbsp;<span class="ident" id="4935430">w</span><span class="op" id="4935431">.</span><span class="ident" id="4935432">req</span><span class="op" id="4935435">.</span><span class="ident" id="4935436">Body</span><span class="op" id="4935440">.</span><span class="op" id="4935441">(</span><span class="op" id="4935442">*</span><span class="ident" id="4935443">expectContinueReader</span><span class="op" id="4935463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935467">if</span>&nbsp;<span class="op" id="4935470">!</span><span class="ident" id="4935471">isExpecter</span>&nbsp;<span class="op" id="4935482">||</span>&nbsp;<span class="ident" id="4935485">ecr</span><span class="op" id="4935488">.</span><span class="ident" id="4935489">resp</span><span class="op" id="4935493">.</span><span class="ident" id="4935494">wroteContinue</span>&nbsp;<span class="op" id="4935508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935513">n</span><span class="op" id="4935514">,</span>&nbsp;<span class="ident" id="4935516">_</span>&nbsp;<span class="op" id="4935518">:=</span>&nbsp;<span class="ident" id="4935521">io</span><span class="op" id="4935523">.</span><span class="ident" id="4935524">CopyN</span><span class="op" id="4935529">(</span><span class="ident" id="4935530">ioutil</span><span class="op" id="4935536">.</span><span class="ident" id="4935537">Discard</span><span class="op" id="4935544">,</span>&nbsp;<span class="ident" id="4935546">w</span><span class="op" id="4935547">.</span><span class="ident" id="4935548">req</span><span class="op" id="4935551">.</span><span class="ident" id="4935552">Body</span><span class="op" id="4935556">,</span>&nbsp;<span class="ident" id="4935558">maxPostHandlerReadBytes</span><span class="op" id="4935581">+</span><span class="num" id="4935582">1</span><span class="op" id="4935583">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935588">if</span>&nbsp;<span class="ident" id="4935591">n</span>&nbsp;<span class="op" id="4935593">&gt;=</span>&nbsp;<span class="ident" id="4935596">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="4935620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935626">w</span><span class="op" id="4935627">.</span><span class="ident" id="4935628">requestTooLarge</span><span class="op" id="4935643">(</span><span class="op" id="4935644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935650">delHeader</span><span class="op" id="4935659">(</span><span class="string" id="4935660">&#34;Connection&#34;</span><span class="op" id="4935672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935678">setHeader</span><span class="op" id="4935687">.</span><span class="ident" id="4935688">connection</span>&nbsp;<span class="op" id="4935699">=</span>&nbsp;<span class="string" id="4935701">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935712">}</span>&nbsp;<span class="keyword" id="4935714">else</span>&nbsp;<span class="op" id="4935719">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935725">w</span><span class="op" id="4935726">.</span><span class="ident" id="4935727">req</span><span class="op" id="4935730">.</span><span class="ident" id="4935731">Body</span><span class="op" id="4935735">.</span><span class="ident" id="4935736">Close</span><span class="op" id="4935741">(</span><span class="op" id="4935742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935758">code</span>&nbsp;<span class="op" id="4935763">:=</span>&nbsp;<span class="ident" id="4935766">w</span><span class="op" id="4935767">.</span><span class="ident" id="4935768">status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935776">if</span>&nbsp;<span class="ident" id="4935779">bodyAllowedForStatus</span><span class="op" id="4935799">(</span><span class="ident" id="4935800">code</span><span class="op" id="4935804">)</span>&nbsp;<span class="op" id="4935806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4935810">//&nbsp;If&nbsp;no&nbsp;content&nbsp;type,&nbsp;apply&nbsp;sniffing&nbsp;algorithm&nbsp;to&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935869">_</span><span class="op" id="4935870">,</span>&nbsp;<span class="ident" id="4935872">haveType</span>&nbsp;<span class="op" id="4935881">:=</span>&nbsp;<span class="ident" id="4935884">header</span><span class="op" id="4935890">[</span><span class="string" id="4935891">&#34;Content-Type&#34;</span><span class="op" id="4935905">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935909">if</span>&nbsp;<span class="op" id="4935912">!</span><span class="ident" id="4935913">haveType</span>&nbsp;<span class="op" id="4935922">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935927">setHeader</span><span class="op" id="4935936">.</span><span class="ident" id="4935937">contentType</span>&nbsp;<span class="op" id="4935949">=</span>&nbsp;<span class="ident" id="4935951">DetectContentType</span><span class="op" id="4935968">(</span><span class="ident" id="4935969">p</span><span class="op" id="4935970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935977">}</span>&nbsp;<span class="keyword" id="4935979">else</span>&nbsp;<span class="op" id="4935984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935988">for</span>&nbsp;<span class="ident" id="4935992">_</span><span class="op" id="4935993">,</span>&nbsp;<span class="ident" id="4935995">k</span>&nbsp;<span class="op" id="4935997">:=</span>&nbsp;<span class="keyword" id="4936000">range</span>&nbsp;<span class="ident" id="4936006">suppressedHeaders</span><span class="op" id="4936023">(</span><span class="ident" id="4936024">code</span><span class="op" id="4936028">)</span>&nbsp;<span class="op" id="4936030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936035">delHeader</span><span class="op" id="4936044">(</span><span class="ident" id="4936045">k</span><span class="op" id="4936046">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4936050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4936053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4936057">if</span>&nbsp;<span class="ident" id="4936060">_</span><span class="op" id="4936061">,</span>&nbsp;<span class="ident" id="4936063">ok</span>&nbsp;<span class="op" id="4936066">:=</span>&nbsp;<span class="ident" id="4936069">header</span><span class="op" id="4936075">[</span><span class="string" id="4936076">&#34;Date&#34;</span><span class="op" id="4936082">]</span><span class="op" id="4936083">;</span>&nbsp;<span class="op" id="4936085">!</span><span class="ident" id="4936086">ok</span>&nbsp;<span class="op" id="4936089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936093">setHeader</span><span class="op" id="4936102">.</span><span class="ident" id="4936103">date</span>&nbsp;<span class="op" id="4936108">=</span>&nbsp;<span class="ident" id="4936110">appendTime</span><span class="op" id="4936120">(</span><span class="ident" id="4936121">cw</span><span class="op" id="4936123">.</span><span class="ident" id="4936124">res</span><span class="op" id="4936127">.</span><span class="ident" id="4936128">dateBuf</span><span class="op" id="4936135">[</span><span class="op" id="4936136">:</span><span class="num" id="4936137">0</span><span class="op" id="4936138">]</span><span class="op" id="4936139">,</span>&nbsp;<span class="ident" id="4936141">time</span><span class="op" id="4936145">.</span><span class="ident" id="4936146">Now</span><span class="op" id="4936149">(</span><span class="op" id="4936150">)</span><span class="op" id="4936151">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4936154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936158">te</span>&nbsp;<span class="op" id="4936161">:=</span>&nbsp;<span class="ident" id="4936164">header</span><span class="op" id="4936170">.</span><span class="ident" id="4936171">get</span><span class="op" id="4936174">(</span><span class="string" id="4936175">&#34;Transfer-Encoding&#34;</span><span class="op" id="4936194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936197">hasTE</span>&nbsp;<span class="op" id="4936203">:=</span>&nbsp;<span class="ident" id="4936206">te</span>&nbsp;<span class="op" id="4936209">!=</span>&nbsp;<span class="string" id="4936212">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4936216">if</span>&nbsp;<span class="ident" id="4936219">hasCL</span>&nbsp;<span class="op" id="4936225">&amp;&amp;</span>&nbsp;<span class="ident" id="4936228">hasTE</span>&nbsp;<span class="op" id="4936234">&amp;&amp;</span>&nbsp;<span class="ident" id="4936237">te</span>&nbsp;<span class="op" id="4936240">!=</span>&nbsp;<span class="string" id="4936243">&#34;identity&#34;</span>&nbsp;<span class="op" id="4936254">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936258">//&nbsp;TODO:&nbsp;return&nbsp;an&nbsp;error&nbsp;if&nbsp;WriteHeader&nbsp;gets&nbsp;a&nbsp;return&nbsp;parameter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936324">//&nbsp;For&nbsp;now&nbsp;just&nbsp;ignore&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936369">w</span><span class="op" id="4936370">.</span><span class="ident" id="4936371">conn</span><span class="op" id="4936375">.</span><span class="ident" id="4936376">server</span><span class="op" id="4936382">.</span><span class="ident" id="4936383">logf</span><span class="op" id="4936387">(</span><span class="string" id="4936388">&#34;http:&nbsp;WriteHeader&nbsp;called&nbsp;with&nbsp;both&nbsp;Transfer-Encoding&nbsp;of&nbsp;%q&nbsp;and&nbsp;a&nbsp;Content-Length&nbsp;of&nbsp;%d&#34;</span><span class="op" id="4936475">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936480">te</span><span class="op" id="4936482">,</span>&nbsp;<span class="ident" id="4936484">w</span><span class="op" id="4936485">.</span><span class="ident" id="4936486">contentLength</span><span class="op" id="4936499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936503">delHeader</span><span class="op" id="4936512">(</span><span class="string" id="4936513">&#34;Content-Length&#34;</span><span class="op" id="4936529">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936533">hasCL</span>&nbsp;<span class="op" id="4936539">=</span>&nbsp;<span class="builtintype" id="4936541">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4936548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4936552">if</span>&nbsp;<span class="ident" id="4936555">w</span><span class="op" id="4936556">.</span><span class="ident" id="4936557">req</span><span class="op" id="4936560">.</span><span class="ident" id="4936561">Method</span>&nbsp;<span class="op" id="4936568">==</span>&nbsp;<span class="string" id="4936571">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4936578">||</span>&nbsp;<span class="op" id="4936581">!</span><span class="ident" id="4936582">bodyAllowedForStatus</span><span class="op" id="4936602">(</span><span class="ident" id="4936603">code</span><span class="op" id="4936607">)</span>&nbsp;<span class="op" id="4936609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936613">//&nbsp;do&nbsp;nothing</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4936628">}</span>&nbsp;<span class="keyword" id="4936630">else</span>&nbsp;<span class="keyword" id="4936635">if</span>&nbsp;<span class="ident" id="4936638">code</span>&nbsp;<span class="op" id="4936643">==</span>&nbsp;<span class="ident" id="4936646">StatusNoContent</span>&nbsp;<span class="op" id="4936662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936666">delHeader</span><span class="op" id="4936675">(</span><span class="string" id="4936676">&#34;Transfer-Encoding&#34;</span><span class="op" id="4936695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4936698">}</span>&nbsp;<span class="keyword" id="4936700">else</span>&nbsp;<span class="keyword" id="4936705">if</span>&nbsp;<span class="ident" id="4936708">hasCL</span>&nbsp;<span class="op" id="4936714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936718">delHeader</span><span class="op" id="4936727">(</span><span class="string" id="4936728">&#34;Transfer-Encoding&#34;</span><span class="op" id="4936747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4936750">}</span>&nbsp;<span class="keyword" id="4936752">else</span>&nbsp;<span class="keyword" id="4936757">if</span>&nbsp;<span class="ident" id="4936760">w</span><span class="op" id="4936761">.</span><span class="ident" id="4936762">req</span><span class="op" id="4936765">.</span><span class="ident" id="4936766">ProtoAtLeast</span><span class="op" id="4936778">(</span><span class="num" id="4936779">1</span><span class="op" id="4936780">,</span>&nbsp;<span class="num" id="4936782">1</span><span class="op" id="4936783">)</span>&nbsp;<span class="op" id="4936785">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936789">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;Transfer-Encoding&nbsp;has&nbsp;been&nbsp;set&nbsp;to&nbsp;identity,&nbsp;&nbsp;and&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936867">//&nbsp;content-length&nbsp;has&nbsp;been&nbsp;provided.&nbsp;The&nbsp;connection&nbsp;must&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936946">//&nbsp;reply&nbsp;is&nbsp;written,&nbsp;and&nbsp;no&nbsp;chunking&nbsp;is&nbsp;to&nbsp;be&nbsp;done.&nbsp;This&nbsp;is&nbsp;the&nbsp;setup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4937018">//&nbsp;recommended&nbsp;in&nbsp;the&nbsp;Server-Sent&nbsp;Events&nbsp;candidate&nbsp;recommendation&nbsp;11,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4937090">//&nbsp;section&nbsp;8.</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4937106">if</span>&nbsp;<span class="ident" id="4937109">hasTE</span>&nbsp;<span class="op" id="4937115">&amp;&amp;</span>&nbsp;<span class="ident" id="4937118">te</span>&nbsp;<span class="op" id="4937121">==</span>&nbsp;<span class="string" id="4937124">&#34;identity&#34;</span>&nbsp;<span class="op" id="4937135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937140">cw</span><span class="op" id="4937142">.</span><span class="ident" id="4937143">chunking</span>&nbsp;<span class="op" id="4937152">=</span>&nbsp;<span class="builtintype" id="4937154">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937163">w</span><span class="op" id="4937164">.</span><span class="ident" id="4937165">closeAfterReply</span>&nbsp;<span class="op" id="4937181">=</span>&nbsp;<span class="builtintype" id="4937183">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4937190">}</span>&nbsp;<span class="keyword" id="4937192">else</span>&nbsp;<span class="op" id="4937197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4937202">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;use&nbsp;chunked&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4937259">//&nbsp;to&nbsp;avoid&nbsp;closing&nbsp;the&nbsp;connection&nbsp;at&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937305">cw</span><span class="op" id="4937307">.</span><span class="ident" id="4937308">chunking</span>&nbsp;<span class="op" id="4937317">=</span>&nbsp;<span class="builtintype" id="4937319">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937327">setHeader</span><span class="op" id="4937336">.</span><span class="ident" id="4937337">transferEncoding</span>&nbsp;<span class="op" id="4937354">=</span>&nbsp;<span class="string" id="4937356">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4937368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4937371">}</span>&nbsp;<span class="keyword" id="4937373">else</span>&nbsp;<span class="op" id="4937378">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4937382">//&nbsp;HTTP&nbsp;version&nbsp;&lt;&nbsp;1.1:&nbsp;cannot&nbsp;do&nbsp;chunked&nbsp;transfer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4937434">//&nbsp;encoding&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;Content-Length&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4937488">//&nbsp;signal&nbsp;EOF&nbsp;by&nbsp;closing&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937527">w</span><span class="op" id="4937528">.</span><span class="ident" id="4937529">closeAfterReply</span>&nbsp;<span class="op" id="4937545">=</span>&nbsp;<span class="builtintype" id="4937547">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937554">delHeader</span><span class="op" id="4937563">(</span><span class="string" id="4937564">&#34;Transfer-Encoding&#34;</span><span class="op" id="4937583">)</span>&nbsp;<span class="comment" id="4937585">//&nbsp;in&nbsp;case&nbsp;already&nbsp;set</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4937609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4937613">//&nbsp;Cannot&nbsp;use&nbsp;Content-Length&nbsp;with&nbsp;non-identity&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4937680">if</span>&nbsp;<span class="ident" id="4937683">cw</span><span class="op" id="4937685">.</span><span class="ident" id="4937686">chunking</span>&nbsp;<span class="op" id="4937695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937699">delHeader</span><span class="op" id="4937708">(</span><span class="string" id="4937709">&#34;Content-Length&#34;</span><span class="op" id="4937725">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4937728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4937731">if</span>&nbsp;<span class="op" id="4937734">!</span><span class="ident" id="4937735">w</span><span class="op" id="4937736">.</span><span class="ident" id="4937737">req</span><span class="op" id="4937740">.</span><span class="ident" id="4937741">ProtoAtLeast</span><span class="op" id="4937753">(</span><span class="num" id="4937754">1</span><span class="op" id="4937755">,</span>&nbsp;<span class="num" id="4937757">0</span><span class="op" id="4937758">)</span>&nbsp;<span class="op" id="4937760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4937764">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4937772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4937776">if</span>&nbsp;<span class="ident" id="4937779">w</span><span class="op" id="4937780">.</span><span class="ident" id="4937781">closeAfterReply</span>&nbsp;<span class="op" id="4937797">&amp;&amp;</span>&nbsp;<span class="op" id="4937800">(</span><span class="op" id="4937801">!</span><span class="ident" id="4937802">keepAlivesEnabled</span>&nbsp;<span class="op" id="4937820">||</span>&nbsp;<span class="op" id="4937823">!</span><span class="ident" id="4937824">hasToken</span><span class="op" id="4937832">(</span><span class="ident" id="4937833">cw</span><span class="op" id="4937835">.</span><span class="ident" id="4937836">header</span><span class="op" id="4937842">.</span><span class="ident" id="4937843">get</span><span class="op" id="4937846">(</span><span class="string" id="4937847">&#34;Connection&#34;</span><span class="op" id="4937859">)</span><span class="op" id="4937860">,</span>&nbsp;<span class="string" id="4937862">&#34;close&#34;</span><span class="op" id="4937869">)</span><span class="op" id="4937870">)</span>&nbsp;<span class="op" id="4937872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937876">delHeader</span><span class="op" id="4937885">(</span><span class="string" id="4937886">&#34;Connection&#34;</span><span class="op" id="4937898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4937902">if</span>&nbsp;<span class="ident" id="4937905">w</span><span class="op" id="4937906">.</span><span class="ident" id="4937907">req</span><span class="op" id="4937910">.</span><span class="ident" id="4937911">ProtoAtLeast</span><span class="op" id="4937923">(</span><span class="num" id="4937924">1</span><span class="op" id="4937925">,</span>&nbsp;<span class="num" id="4937927">1</span><span class="op" id="4937928">)</span>&nbsp;<span class="op" id="4937930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937935">setHeader</span><span class="op" id="4937944">.</span><span class="ident" id="4937945">connection</span>&nbsp;<span class="op" id="4937956">=</span>&nbsp;<span class="string" id="4937958">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4937968">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4937971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937975">w</span><span class="op" id="4937976">.</span><span class="ident" id="4937977">conn</span><span class="op" id="4937981">.</span><span class="ident" id="4937982">buf</span><span class="op" id="4937985">.</span><span class="ident" id="4937986">WriteString</span><span class="op" id="4937997">(</span><span class="ident" id="4937998">statusLine</span><span class="op" id="4938008">(</span><span class="ident" id="4938009">w</span><span class="op" id="4938010">.</span><span class="ident" id="4938011">req</span><span class="op" id="4938014">,</span>&nbsp;<span class="ident" id="4938016">code</span><span class="op" id="4938020">)</span><span class="op" id="4938021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938024">cw</span><span class="op" id="4938026">.</span><span class="ident" id="4938027">header</span><span class="op" id="4938033">.</span><span class="ident" id="4938034">WriteSubset</span><span class="op" id="4938045">(</span><span class="ident" id="4938046">w</span><span class="op" id="4938047">.</span><span class="ident" id="4938048">conn</span><span class="op" id="4938052">.</span><span class="ident" id="4938053">buf</span><span class="op" id="4938056">,</span>&nbsp;<span class="ident" id="4938058">excludeHeader</span><span class="op" id="4938071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938074">setHeader</span><span class="op" id="4938083">.</span><span class="ident" id="4938084">Write</span><span class="op" id="4938089">(</span><span class="ident" id="4938090">w</span><span class="op" id="4938091">.</span><span class="ident" id="4938092">conn</span><span class="op" id="4938096">.</span><span class="ident" id="4938097">buf</span><span class="op" id="4938100">.</span><span class="ident" id="4938101">Writer</span><span class="op" id="4938107">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938110">w</span><span class="op" id="4938111">.</span><span class="ident" id="4938112">conn</span><span class="op" id="4938116">.</span><span class="ident" id="4938117">buf</span><span class="op" id="4938120">.</span><span class="ident" id="4938121">Write</span><span class="op" id="4938126">(</span><span class="ident" id="4938127">crlf</span><span class="op" id="4938131">)</span><br>
<span class="lineno"></span><span class="op" id="4938133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4938136">//&nbsp;statusLines&nbsp;is&nbsp;a&nbsp;cache&nbsp;of&nbsp;Status-Line&nbsp;strings,&nbsp;keyed&nbsp;by&nbsp;code&nbsp;(for</span><br>
<span class="lineno"></span><span class="comment" id="4938205">//&nbsp;HTTP/1.1)&nbsp;or&nbsp;negative&nbsp;code&nbsp;(for&nbsp;HTTP/1.0).&nbsp;This&nbsp;is&nbsp;faster&nbsp;than&nbsp;a</span><br>
<span class="lineno">890</span><span class="comment" id="4938273">//&nbsp;map&nbsp;keyed&nbsp;by&nbsp;struct&nbsp;of&nbsp;two&nbsp;fields.&nbsp;This&nbsp;map&#39;s&nbsp;max&nbsp;size&nbsp;is&nbsp;bounded</span><br>
<span class="lineno"></span><span class="comment" id="4938342">//&nbsp;by&nbsp;2*len(statusText),&nbsp;two&nbsp;protocol&nbsp;types&nbsp;for&nbsp;each&nbsp;known&nbsp;official</span><br>
<span class="lineno"></span><span class="comment" id="4938410">//&nbsp;status&nbsp;code&nbsp;in&nbsp;the&nbsp;statusText&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="4938448">var</span>&nbsp;<span class="op" id="4938452">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938455">statusMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4938467">sync</span><span class="op" id="4938471">.</span><span class="ident" id="4938472">RWMutex</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938481">statusLines</span>&nbsp;<span class="op" id="4938493">=</span>&nbsp;<span class="builtinfunc" id="4938495">make</span><span class="op" id="4938499">(</span><span class="keyword" id="4938500">map</span><span class="op" id="4938503">[</span><span class="builtintype" id="4938504">int</span><span class="op" id="4938507">]</span><span class="builtintype" id="4938508">string</span><span class="op" id="4938514">)</span><br>
<span class="lineno"></span><span class="op" id="4938516">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4938519">//&nbsp;statusLine&nbsp;returns&nbsp;a&nbsp;response&nbsp;Status-Line&nbsp;(RFC&nbsp;2616&nbsp;Section&nbsp;6.1)</span><br>
<span class="lineno"></span><span class="comment" id="4938587">//&nbsp;for&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;status&nbsp;code.</span><br>
<span class="lineno">900</span><span class="keyword" id="4938638">func</span>&nbsp;<span class="ident" id="4938643">statusLine</span><span class="op" id="4938653">(</span><span class="ident" id="4938654">req</span>&nbsp;<span class="op" id="4938658">*</span><span class="ident" id="4938659">Request</span><span class="op" id="4938666">,</span>&nbsp;<span class="ident" id="4938668">code</span>&nbsp;<span class="builtintype" id="4938673">int</span><span class="op" id="4938676">)</span>&nbsp;<span class="builtintype" id="4938678">string</span>&nbsp;<span class="op" id="4938685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938688">//&nbsp;Fast&nbsp;path:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938703">key</span>&nbsp;<span class="op" id="4938707">:=</span>&nbsp;<span class="ident" id="4938710">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938716">proto11</span>&nbsp;<span class="op" id="4938724">:=</span>&nbsp;<span class="ident" id="4938727">req</span><span class="op" id="4938730">.</span><span class="ident" id="4938731">ProtoAtLeast</span><span class="op" id="4938743">(</span><span class="num" id="4938744">1</span><span class="op" id="4938745">,</span>&nbsp;<span class="num" id="4938747">1</span><span class="op" id="4938748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4938751">if</span>&nbsp;<span class="op" id="4938754">!</span><span class="ident" id="4938755">proto11</span>&nbsp;<span class="op" id="4938763">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938767">key</span>&nbsp;<span class="op" id="4938771">=</span>&nbsp;<span class="op" id="4938773">-</span><span class="ident" id="4938774">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4938779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938782">statusMu</span><span class="op" id="4938790">.</span><span class="ident" id="4938791">RLock</span><span class="op" id="4938796">(</span><span class="op" id="4938797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938800">line</span><span class="op" id="4938804">,</span>&nbsp;<span class="ident" id="4938806">ok</span>&nbsp;<span class="op" id="4938809">:=</span>&nbsp;<span class="ident" id="4938812">statusLines</span><span class="op" id="4938823">[</span><span class="ident" id="4938824">key</span><span class="op" id="4938827">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938830">statusMu</span><span class="op" id="4938838">.</span><span class="ident" id="4938839">RUnlock</span><span class="op" id="4938846">(</span><span class="op" id="4938847">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4938850">if</span>&nbsp;<span class="ident" id="4938853">ok</span>&nbsp;<span class="op" id="4938856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4938860">return</span>&nbsp;<span class="ident" id="4938867">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4938873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938877">//&nbsp;Slow&nbsp;path:</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938892">proto</span>&nbsp;<span class="op" id="4938898">:=</span>&nbsp;<span class="string" id="4938901">&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4938913">if</span>&nbsp;<span class="ident" id="4938916">proto11</span>&nbsp;<span class="op" id="4938924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938928">proto</span>&nbsp;<span class="op" id="4938934">=</span>&nbsp;<span class="string" id="4938936">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4938948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938951">codestring</span>&nbsp;<span class="op" id="4938962">:=</span>&nbsp;<span class="ident" id="4938965">strconv</span><span class="op" id="4938972">.</span><span class="ident" id="4938973">Itoa</span><span class="op" id="4938977">(</span><span class="ident" id="4938978">code</span><span class="op" id="4938982">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938985">text</span><span class="op" id="4938989">,</span>&nbsp;<span class="ident" id="4938991">ok</span>&nbsp;<span class="op" id="4938994">:=</span>&nbsp;<span class="ident" id="4938997">statusText</span><span class="op" id="4939007">[</span><span class="ident" id="4939008">code</span><span class="op" id="4939012">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939015">if</span>&nbsp;<span class="op" id="4939018">!</span><span class="ident" id="4939019">ok</span>&nbsp;<span class="op" id="4939022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939026">text</span>&nbsp;<span class="op" id="4939031">=</span>&nbsp;<span class="string" id="4939033">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="4939048">+</span>&nbsp;<span class="ident" id="4939050">codestring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4939062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939065">line</span>&nbsp;<span class="op" id="4939070">=</span>&nbsp;<span class="ident" id="4939072">proto</span>&nbsp;<span class="op" id="4939078">+</span>&nbsp;<span class="string" id="4939080">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="4939084">+</span>&nbsp;<span class="ident" id="4939086">codestring</span>&nbsp;<span class="op" id="4939097">+</span>&nbsp;<span class="string" id="4939099">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="4939103">+</span>&nbsp;<span class="ident" id="4939105">text</span>&nbsp;<span class="op" id="4939110">+</span>&nbsp;<span class="string" id="4939112">&#34;\r\n&#34;</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939120">if</span>&nbsp;<span class="ident" id="4939123">ok</span>&nbsp;<span class="op" id="4939126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939130">statusMu</span><span class="op" id="4939138">.</span><span class="ident" id="4939139">Lock</span><span class="op" id="4939143">(</span><span class="op" id="4939144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939148">defer</span>&nbsp;<span class="ident" id="4939154">statusMu</span><span class="op" id="4939162">.</span><span class="ident" id="4939163">Unlock</span><span class="op" id="4939169">(</span><span class="op" id="4939170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939174">statusLines</span><span class="op" id="4939185">[</span><span class="ident" id="4939186">key</span><span class="op" id="4939189">]</span>&nbsp;<span class="op" id="4939191">=</span>&nbsp;<span class="ident" id="4939193">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4939199">}</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939202">return</span>&nbsp;<span class="ident" id="4939209">line</span><br>
<span class="lineno"></span><span class="op" id="4939214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4939217">//&nbsp;bodyAllowed&nbsp;returns&nbsp;true&nbsp;if&nbsp;a&nbsp;Write&nbsp;is&nbsp;allowed&nbsp;for&nbsp;this&nbsp;response&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="4939291">//&nbsp;It&#39;s&nbsp;illegal&nbsp;to&nbsp;call&nbsp;this&nbsp;before&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;flushed.</span><br>
<span class="lineno">935</span><span class="keyword" id="4939356">func</span>&nbsp;<span class="op" id="4939361">(</span><span class="ident" id="4939362">w</span>&nbsp;<span class="op" id="4939364">*</span><span class="ident" id="4939365">response</span><span class="op" id="4939373">)</span>&nbsp;<span class="ident" id="4939375">bodyAllowed</span><span class="op" id="4939386">(</span><span class="op" id="4939387">)</span>&nbsp;<span class="builtintype" id="4939389">bool</span>&nbsp;<span class="op" id="4939394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939397">if</span>&nbsp;<span class="op" id="4939400">!</span><span class="ident" id="4939401">w</span><span class="op" id="4939402">.</span><span class="ident" id="4939403">wroteHeader</span>&nbsp;<span class="op" id="4939415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4939419">panic</span><span class="op" id="4939424">(</span><span class="string" id="4939425">&#34;&#34;</span><span class="op" id="4939427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4939430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939433">return</span>&nbsp;<span class="ident" id="4939440">bodyAllowedForStatus</span><span class="op" id="4939460">(</span><span class="ident" id="4939461">w</span><span class="op" id="4939462">.</span><span class="ident" id="4939463">status</span><span class="op" id="4939469">)</span><br>
<span class="lineno">940</span><span class="op" id="4939471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4939474">//&nbsp;The&nbsp;Life&nbsp;Of&nbsp;A&nbsp;Write&nbsp;is&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span><span class="comment" id="4939511">//</span><br>
<span class="lineno"></span><span class="comment" id="4939514">//&nbsp;Handler&nbsp;starts.&nbsp;No&nbsp;header&nbsp;has&nbsp;been&nbsp;sent.&nbsp;The&nbsp;handler&nbsp;can&nbsp;either</span><br>
<span class="lineno">945</span><span class="comment" id="4939581">//&nbsp;write&nbsp;a&nbsp;header,&nbsp;or&nbsp;just&nbsp;start&nbsp;writing.&nbsp;&nbsp;Writing&nbsp;before&nbsp;sending&nbsp;a&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="4939656">//&nbsp;sends&nbsp;an&nbsp;implicitly&nbsp;empty&nbsp;200&nbsp;OK&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="4939700">//</span><br>
<span class="lineno"></span><span class="comment" id="4939703">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;declare&nbsp;a&nbsp;Content-Length&nbsp;up&nbsp;front,&nbsp;we&nbsp;either</span><br>
<span class="lineno"></span><span class="comment" id="4939773">//&nbsp;go&nbsp;into&nbsp;chunking&nbsp;mode&nbsp;or,&nbsp;if&nbsp;the&nbsp;handler&nbsp;finishes&nbsp;running&nbsp;before</span><br>
<span class="lineno">950</span><span class="comment" id="4939841">//&nbsp;the&nbsp;chunking&nbsp;buffer&nbsp;size,&nbsp;we&nbsp;compute&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;send&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4939912">//&nbsp;in&nbsp;the&nbsp;header&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="4939938">//</span><br>
<span class="lineno"></span><span class="comment" id="4939941">//&nbsp;Likewise,&nbsp;if&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;set&nbsp;a&nbsp;Content-Type,&nbsp;we&nbsp;sniff&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4940010">//&nbsp;from&nbsp;the&nbsp;initial&nbsp;chunk&nbsp;of&nbsp;output.</span><br>
<span class="lineno">955</span><span class="comment" id="4940047">//</span><br>
<span class="lineno"></span><span class="comment" id="4940050">//&nbsp;The&nbsp;Writers&nbsp;are&nbsp;wired&nbsp;together&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="4940090">//</span><br>
<span class="lineno"></span><span class="comment" id="4940093">//&nbsp;1.&nbsp;*response&nbsp;(the&nbsp;ResponseWriter)&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="4940133">//&nbsp;2.&nbsp;(*response).w,&nbsp;a&nbsp;*bufio.Writer&nbsp;of&nbsp;bufferBeforeChunkingSize&nbsp;bytes</span><br>
<span class="lineno">960</span><span class="comment" id="4940204">//&nbsp;3.&nbsp;chunkWriter.Writer&nbsp;(whose&nbsp;writeHeader&nbsp;finalizes&nbsp;Content-Length/Type)</span><br>
<span class="lineno"></span><span class="comment" id="4940279">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;which&nbsp;writes&nbsp;the&nbsp;chunk&nbsp;headers,&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="comment" id="4940332">//&nbsp;4.&nbsp;conn.buf,&nbsp;a&nbsp;bufio.Writer&nbsp;of&nbsp;default&nbsp;(4kB)&nbsp;bytes,&nbsp;writing&nbsp;to&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="4940401">//&nbsp;5.&nbsp;checkConnErrorWriter{c},&nbsp;which&nbsp;notes&nbsp;any&nbsp;non-nil&nbsp;error&nbsp;on&nbsp;Write</span><br>
<span class="lineno"></span><span class="comment" id="4940471">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;populates&nbsp;c.werr&nbsp;with&nbsp;it&nbsp;if&nbsp;so.&nbsp;but&nbsp;otherwise&nbsp;writes&nbsp;to:</span><br>
<span class="lineno">965</span><span class="comment" id="4940538">//&nbsp;6.&nbsp;the&nbsp;rwc,&nbsp;the&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="4940567">//</span><br>
<span class="lineno"></span><span class="comment" id="4940570">//&nbsp;TODO(bradfitz):&nbsp;short-circuit&nbsp;some&nbsp;of&nbsp;the&nbsp;buffering&nbsp;when&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4940634">//&nbsp;initial&nbsp;header&nbsp;contains&nbsp;both&nbsp;a&nbsp;Content-Type&nbsp;and&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="comment" id="4940701">//&nbsp;Also&nbsp;short-circuit&nbsp;in&nbsp;(1)&nbsp;when&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;sent&nbsp;and&nbsp;not&nbsp;in</span><br>
<span class="lineno">970</span><span class="comment" id="4940769">//&nbsp;chunking&nbsp;mode,&nbsp;writing&nbsp;directly&nbsp;to&nbsp;(4)&nbsp;instead,&nbsp;if&nbsp;(2)&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="4940834">//&nbsp;buffered&nbsp;data.&nbsp;&nbsp;More&nbsp;generally,&nbsp;we&nbsp;could&nbsp;short-circuit&nbsp;from&nbsp;(1)&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4940904">//&nbsp;(3)&nbsp;even&nbsp;in&nbsp;chunking&nbsp;mode&nbsp;if&nbsp;the&nbsp;write&nbsp;size&nbsp;from&nbsp;(1)&nbsp;is&nbsp;over&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="4940973">//&nbsp;threshold&nbsp;and&nbsp;nothing&nbsp;is&nbsp;in&nbsp;(2).&nbsp;&nbsp;The&nbsp;answer&nbsp;might&nbsp;be&nbsp;mostly&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="4941044">//&nbsp;bufferBeforeChunkingSize&nbsp;smaller&nbsp;and&nbsp;having&nbsp;bufio&#39;s&nbsp;fast-paths&nbsp;deal</span><br>
<span class="lineno">975</span><span class="comment" id="4941115">//&nbsp;with&nbsp;this&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="4941137">func</span>&nbsp;<span class="op" id="4941142">(</span><span class="ident" id="4941143">w</span>&nbsp;<span class="op" id="4941145">*</span><span class="ident" id="4941146">response</span><span class="op" id="4941154">)</span>&nbsp;<span class="ident" id="4941156">Write</span><span class="op" id="4941161">(</span><span class="ident" id="4941162">data</span>&nbsp;<span class="op" id="4941167">[</span><span class="op" id="4941168">]</span><span class="builtintype" id="4941169">byte</span><span class="op" id="4941173">)</span>&nbsp;<span class="op" id="4941175">(</span><span class="ident" id="4941176">n</span>&nbsp;<span class="builtintype" id="4941178">int</span><span class="op" id="4941181">,</span>&nbsp;<span class="ident" id="4941183">err</span>&nbsp;<span class="builtintype" id="4941187">error</span><span class="op" id="4941192">)</span>&nbsp;<span class="op" id="4941194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941197">return</span>&nbsp;<span class="ident" id="4941204">w</span><span class="op" id="4941205">.</span><span class="ident" id="4941206">write</span><span class="op" id="4941211">(</span><span class="builtinfunc" id="4941212">len</span><span class="op" id="4941215">(</span><span class="ident" id="4941216">data</span><span class="op" id="4941220">)</span><span class="op" id="4941221">,</span>&nbsp;<span class="ident" id="4941223">data</span><span class="op" id="4941227">,</span>&nbsp;<span class="string" id="4941229">&#34;&#34;</span><span class="op" id="4941231">)</span><br>
<span class="lineno"></span><span class="op" id="4941233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="4941236">func</span>&nbsp;<span class="op" id="4941241">(</span><span class="ident" id="4941242">w</span>&nbsp;<span class="op" id="4941244">*</span><span class="ident" id="4941245">response</span><span class="op" id="4941253">)</span>&nbsp;<span class="ident" id="4941255">WriteString</span><span class="op" id="4941266">(</span><span class="ident" id="4941267">data</span>&nbsp;<span class="builtintype" id="4941272">string</span><span class="op" id="4941278">)</span>&nbsp;<span class="op" id="4941280">(</span><span class="ident" id="4941281">n</span>&nbsp;<span class="builtintype" id="4941283">int</span><span class="op" id="4941286">,</span>&nbsp;<span class="ident" id="4941288">err</span>&nbsp;<span class="builtintype" id="4941292">error</span><span class="op" id="4941297">)</span>&nbsp;<span class="op" id="4941299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941302">return</span>&nbsp;<span class="ident" id="4941309">w</span><span class="op" id="4941310">.</span><span class="ident" id="4941311">write</span><span class="op" id="4941316">(</span><span class="builtinfunc" id="4941317">len</span><span class="op" id="4941320">(</span><span class="ident" id="4941321">data</span><span class="op" id="4941325">)</span><span class="op" id="4941326">,</span>&nbsp;<span class="ident" id="4941328">nil</span><span class="op" id="4941331">,</span>&nbsp;<span class="ident" id="4941333">data</span><span class="op" id="4941337">)</span><br>
<span class="lineno"></span><span class="op" id="4941339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4941342">//&nbsp;either&nbsp;dataB&nbsp;or&nbsp;dataS&nbsp;is&nbsp;non-zero.</span><br>
<span class="lineno">985</span><span class="keyword" id="4941380">func</span>&nbsp;<span class="op" id="4941385">(</span><span class="ident" id="4941386">w</span>&nbsp;<span class="op" id="4941388">*</span><span class="ident" id="4941389">response</span><span class="op" id="4941397">)</span>&nbsp;<span class="ident" id="4941399">write</span><span class="op" id="4941404">(</span><span class="ident" id="4941405">lenData</span>&nbsp;<span class="builtintype" id="4941413">int</span><span class="op" id="4941416">,</span>&nbsp;<span class="ident" id="4941418">dataB</span>&nbsp;<span class="op" id="4941424">[</span><span class="op" id="4941425">]</span><span class="builtintype" id="4941426">byte</span><span class="op" id="4941430">,</span>&nbsp;<span class="ident" id="4941432">dataS</span>&nbsp;<span class="builtintype" id="4941438">string</span><span class="op" id="4941444">)</span>&nbsp;<span class="op" id="4941446">(</span><span class="ident" id="4941447">n</span>&nbsp;<span class="builtintype" id="4941449">int</span><span class="op" id="4941452">,</span>&nbsp;<span class="ident" id="4941454">err</span>&nbsp;<span class="builtintype" id="4941458">error</span><span class="op" id="4941463">)</span>&nbsp;<span class="op" id="4941465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941468">if</span>&nbsp;<span class="ident" id="4941471">w</span><span class="op" id="4941472">.</span><span class="ident" id="4941473">conn</span><span class="op" id="4941477">.</span><span class="ident" id="4941478">hijacked</span><span class="op" id="4941486">(</span><span class="op" id="4941487">)</span>&nbsp;<span class="op" id="4941489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941493">w</span><span class="op" id="4941494">.</span><span class="ident" id="4941495">conn</span><span class="op" id="4941499">.</span><span class="ident" id="4941500">server</span><span class="op" id="4941506">.</span><span class="ident" id="4941507">logf</span><span class="op" id="4941511">(</span><span class="string" id="4941512">&#34;http:&nbsp;response.Write&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="4941557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941561">return</span>&nbsp;<span class="num" id="4941568">0</span><span class="op" id="4941569">,</span>&nbsp;<span class="ident" id="4941571">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4941584">}</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941587">if</span>&nbsp;<span class="op" id="4941590">!</span><span class="ident" id="4941591">w</span><span class="op" id="4941592">.</span><span class="ident" id="4941593">wroteHeader</span>&nbsp;<span class="op" id="4941605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941609">w</span><span class="op" id="4941610">.</span><span class="ident" id="4941611">WriteHeader</span><span class="op" id="4941622">(</span><span class="ident" id="4941623">StatusOK</span><span class="op" id="4941631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4941634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941637">if</span>&nbsp;<span class="ident" id="4941640">lenData</span>&nbsp;<span class="op" id="4941648">==</span>&nbsp;<span class="num" id="4941651">0</span>&nbsp;<span class="op" id="4941653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941657">return</span>&nbsp;<span class="num" id="4941664">0</span><span class="op" id="4941665">,</span>&nbsp;<span class="ident" id="4941667">nil</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4941672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941675">if</span>&nbsp;<span class="op" id="4941678">!</span><span class="ident" id="4941679">w</span><span class="op" id="4941680">.</span><span class="ident" id="4941681">bodyAllowed</span><span class="op" id="4941692">(</span><span class="op" id="4941693">)</span>&nbsp;<span class="op" id="4941695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941699">return</span>&nbsp;<span class="num" id="4941706">0</span><span class="op" id="4941707">,</span>&nbsp;<span class="ident" id="4941709">ErrBodyNotAllowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4941728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941732">w</span><span class="op" id="4941733">.</span><span class="ident" id="4941734">written</span>&nbsp;<span class="op" id="4941742">+=</span>&nbsp;<span class="ident" id="4941745">int64</span><span class="op" id="4941750">(</span><span class="ident" id="4941751">lenData</span><span class="op" id="4941758">)</span>&nbsp;<span class="comment" id="4941760">//&nbsp;ignoring&nbsp;errors,&nbsp;for&nbsp;errorKludge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941797">if</span>&nbsp;<span class="ident" id="4941800">w</span><span class="op" id="4941801">.</span><span class="ident" id="4941802">contentLength</span>&nbsp;<span class="op" id="4941816">!=</span>&nbsp;<span class="op" id="4941819">-</span><span class="num" id="4941820">1</span>&nbsp;<span class="op" id="4941822">&amp;&amp;</span>&nbsp;<span class="ident" id="4941825">w</span><span class="op" id="4941826">.</span><span class="ident" id="4941827">written</span>&nbsp;<span class="op" id="4941835">&gt;</span>&nbsp;<span class="ident" id="4941837">w</span><span class="op" id="4941838">.</span><span class="ident" id="4941839">contentLength</span>&nbsp;<span class="op" id="4941853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941857">return</span>&nbsp;<span class="num" id="4941864">0</span><span class="op" id="4941865">,</span>&nbsp;<span class="ident" id="4941867">ErrContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4941885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941888">if</span>&nbsp;<span class="ident" id="4941891">dataB</span>&nbsp;<span class="op" id="4941897">!=</span>&nbsp;<span class="ident" id="4941900">nil</span>&nbsp;<span class="op" id="4941904">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941908">return</span>&nbsp;<span class="ident" id="4941915">w</span><span class="op" id="4941916">.</span><span class="ident" id="4941917">w</span><span class="op" id="4941918">.</span><span class="ident" id="4941919">Write</span><span class="op" id="4941924">(</span><span class="ident" id="4941925">dataB</span><span class="op" id="4941930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4941933">}</span>&nbsp;<span class="keyword" id="4941935">else</span>&nbsp;<span class="op" id="4941940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941944">return</span>&nbsp;<span class="ident" id="4941951">w</span><span class="op" id="4941952">.</span><span class="ident" id="4941953">w</span><span class="op" id="4941954">.</span><span class="ident" id="4941955">WriteString</span><span class="op" id="4941966">(</span><span class="ident" id="4941967">dataS</span><span class="op" id="4941972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4941975">}</span><br>
<span class="lineno"></span><span class="op" id="4941977">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span><span class="keyword" id="4941980">func</span>&nbsp;<span class="op" id="4941985">(</span><span class="ident" id="4941986">w</span>&nbsp;<span class="op" id="4941988">*</span><span class="ident" id="4941989">response</span><span class="op" id="4941997">)</span>&nbsp;<span class="ident" id="4941999">finishRequest</span><span class="op" id="4942012">(</span><span class="op" id="4942013">)</span>&nbsp;<span class="op" id="4942015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942018">w</span><span class="op" id="4942019">.</span><span class="ident" id="4942020">handlerDone</span>&nbsp;<span class="op" id="4942032">=</span>&nbsp;<span class="builtintype" id="4942034">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942041">if</span>&nbsp;<span class="op" id="4942044">!</span><span class="ident" id="4942045">w</span><span class="op" id="4942046">.</span><span class="ident" id="4942047">wroteHeader</span>&nbsp;<span class="op" id="4942059">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942063">w</span><span class="op" id="4942064">.</span><span class="ident" id="4942065">WriteHeader</span><span class="op" id="4942076">(</span><span class="ident" id="4942077">StatusOK</span><span class="op" id="4942085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4942088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942092">w</span><span class="op" id="4942093">.</span><span class="ident" id="4942094">w</span><span class="op" id="4942095">.</span><span class="ident" id="4942096">Flush</span><span class="op" id="4942101">(</span><span class="op" id="4942102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942105">putBufioWriter</span><span class="op" id="4942119">(</span><span class="ident" id="4942120">w</span><span class="op" id="4942121">.</span><span class="ident" id="4942122">w</span><span class="op" id="4942123">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942126">w</span><span class="op" id="4942127">.</span><span class="ident" id="4942128">cw</span><span class="op" id="4942130">.</span><span class="builtinfunc" id="4942131">close</span><span class="op" id="4942136">(</span><span class="op" id="4942137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942140">w</span><span class="op" id="4942141">.</span><span class="ident" id="4942142">conn</span><span class="op" id="4942146">.</span><span class="ident" id="4942147">buf</span><span class="op" id="4942150">.</span><span class="ident" id="4942151">Flush</span><span class="op" id="4942156">(</span><span class="op" id="4942157">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4942161">//&nbsp;Close&nbsp;the&nbsp;body&nbsp;(regardless&nbsp;of&nbsp;w.closeAfterReply)&nbsp;so&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4942224">//&nbsp;re-use&nbsp;its&nbsp;bufio.Reader&nbsp;later&nbsp;safely.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942266">w</span><span class="op" id="4942267">.</span><span class="ident" id="4942268">req</span><span class="op" id="4942271">.</span><span class="ident" id="4942272">Body</span><span class="op" id="4942276">.</span><span class="ident" id="4942277">Close</span><span class="op" id="4942282">(</span><span class="op" id="4942283">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942287">if</span>&nbsp;<span class="ident" id="4942290">w</span><span class="op" id="4942291">.</span><span class="ident" id="4942292">req</span><span class="op" id="4942295">.</span><span class="ident" id="4942296">MultipartForm</span>&nbsp;<span class="op" id="4942310">!=</span>&nbsp;<span class="ident" id="4942313">nil</span>&nbsp;<span class="op" id="4942317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942321">w</span><span class="op" id="4942322">.</span><span class="ident" id="4942323">req</span><span class="op" id="4942326">.</span><span class="ident" id="4942327">MultipartForm</span><span class="op" id="4942340">.</span><span class="ident" id="4942341">RemoveAll</span><span class="op" id="4942350">(</span><span class="op" id="4942351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4942354">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942358">if</span>&nbsp;<span class="ident" id="4942361">w</span><span class="op" id="4942362">.</span><span class="ident" id="4942363">req</span><span class="op" id="4942366">.</span><span class="ident" id="4942367">Method</span>&nbsp;<span class="op" id="4942374">!=</span>&nbsp;<span class="string" id="4942377">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4942384">&amp;&amp;</span>&nbsp;<span class="ident" id="4942387">w</span><span class="op" id="4942388">.</span><span class="ident" id="4942389">contentLength</span>&nbsp;<span class="op" id="4942403">!=</span>&nbsp;<span class="op" id="4942406">-</span><span class="num" id="4942407">1</span>&nbsp;<span class="op" id="4942409">&amp;&amp;</span>&nbsp;<span class="ident" id="4942412">w</span><span class="op" id="4942413">.</span><span class="ident" id="4942414">bodyAllowed</span><span class="op" id="4942425">(</span><span class="op" id="4942426">)</span>&nbsp;<span class="op" id="4942428">&amp;&amp;</span>&nbsp;<span class="ident" id="4942431">w</span><span class="op" id="4942432">.</span><span class="ident" id="4942433">contentLength</span>&nbsp;<span class="op" id="4942447">!=</span>&nbsp;<span class="ident" id="4942450">w</span><span class="op" id="4942451">.</span><span class="ident" id="4942452">written</span>&nbsp;<span class="op" id="4942460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4942464">//&nbsp;Did&nbsp;not&nbsp;write&nbsp;enough.&nbsp;Avoid&nbsp;getting&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942518">w</span><span class="op" id="4942519">.</span><span class="ident" id="4942520">closeAfterReply</span>&nbsp;<span class="op" id="4942536">=</span>&nbsp;<span class="builtintype" id="4942538">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4942544">}</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4942548">//&nbsp;There&nbsp;was&nbsp;some&nbsp;error&nbsp;writing&nbsp;to&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4942610">//&nbsp;during&nbsp;the&nbsp;request,&nbsp;so&nbsp;don&#39;t&nbsp;re-use&nbsp;this&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942661">if</span>&nbsp;<span class="ident" id="4942664">w</span><span class="op" id="4942665">.</span><span class="ident" id="4942666">conn</span><span class="op" id="4942670">.</span><span class="ident" id="4942671">werr</span>&nbsp;<span class="op" id="4942676">!=</span>&nbsp;<span class="ident" id="4942679">nil</span>&nbsp;<span class="op" id="4942683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942687">w</span><span class="op" id="4942688">.</span><span class="ident" id="4942689">closeAfterReply</span>&nbsp;<span class="op" id="4942705">=</span>&nbsp;<span class="builtintype" id="4942707">true</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4942713">}</span><br>
<span class="lineno"></span><span class="op" id="4942715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4942718">func</span>&nbsp;<span class="op" id="4942723">(</span><span class="ident" id="4942724">w</span>&nbsp;<span class="op" id="4942726">*</span><span class="ident" id="4942727">response</span><span class="op" id="4942735">)</span>&nbsp;<span class="ident" id="4942737">Flush</span><span class="op" id="4942742">(</span><span class="op" id="4942743">)</span>&nbsp;<span class="op" id="4942745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942748">if</span>&nbsp;<span class="op" id="4942751">!</span><span class="ident" id="4942752">w</span><span class="op" id="4942753">.</span><span class="ident" id="4942754">wroteHeader</span>&nbsp;<span class="op" id="4942766">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942770">w</span><span class="op" id="4942771">.</span><span class="ident" id="4942772">WriteHeader</span><span class="op" id="4942783">(</span><span class="ident" id="4942784">StatusOK</span><span class="op" id="4942792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4942795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942798">w</span><span class="op" id="4942799">.</span><span class="ident" id="4942800">w</span><span class="op" id="4942801">.</span><span class="ident" id="4942802">Flush</span><span class="op" id="4942807">(</span><span class="op" id="4942808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942811">w</span><span class="op" id="4942812">.</span><span class="ident" id="4942813">cw</span><span class="op" id="4942815">.</span><span class="ident" id="4942816">flush</span><span class="op" id="4942821">(</span><span class="op" id="4942822">)</span><br>
<span class="lineno"></span><span class="op" id="4942824">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="4942827">func</span>&nbsp;<span class="op" id="4942832">(</span><span class="ident" id="4942833">c</span>&nbsp;<span class="op" id="4942835">*</span><span class="ident" id="4942836">conn</span><span class="op" id="4942840">)</span>&nbsp;<span class="ident" id="4942842">finalFlush</span><span class="op" id="4942852">(</span><span class="op" id="4942853">)</span>&nbsp;<span class="op" id="4942855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942858">if</span>&nbsp;<span class="ident" id="4942861">c</span><span class="op" id="4942862">.</span><span class="ident" id="4942863">buf</span>&nbsp;<span class="op" id="4942867">!=</span>&nbsp;<span class="ident" id="4942870">nil</span>&nbsp;<span class="op" id="4942874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942878">c</span><span class="op" id="4942879">.</span><span class="ident" id="4942880">buf</span><span class="op" id="4942883">.</span><span class="ident" id="4942884">Flush</span><span class="op" id="4942889">(</span><span class="op" id="4942890">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4942895">//&nbsp;Steal&nbsp;the&nbsp;bufio.Reader&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4942965">//&nbsp;reader&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943002">putBufioReader</span><span class="op" id="4943016">(</span><span class="ident" id="4943017">c</span><span class="op" id="4943018">.</span><span class="ident" id="4943019">buf</span><span class="op" id="4943022">.</span><span class="ident" id="4943023">Reader</span><span class="op" id="4943029">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4943034">//&nbsp;Steal&nbsp;the&nbsp;bufio.Writer&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4943104">//&nbsp;writer&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943141">putBufioWriter</span><span class="op" id="4943155">(</span><span class="ident" id="4943156">c</span><span class="op" id="4943157">.</span><span class="ident" id="4943158">buf</span><span class="op" id="4943161">.</span><span class="ident" id="4943162">Writer</span><span class="op" id="4943168">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943173">c</span><span class="op" id="4943174">.</span><span class="ident" id="4943175">buf</span>&nbsp;<span class="op" id="4943179">=</span>&nbsp;<span class="ident" id="4943181">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4943186">}</span><br>
<span class="lineno">1065</span><span class="op" id="4943188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4943191">//&nbsp;Close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4943216">func</span>&nbsp;<span class="op" id="4943221">(</span><span class="ident" id="4943222">c</span>&nbsp;<span class="op" id="4943224">*</span><span class="ident" id="4943225">conn</span><span class="op" id="4943229">)</span>&nbsp;<span class="builtinfunc" id="4943231">close</span><span class="op" id="4943236">(</span><span class="op" id="4943237">)</span>&nbsp;<span class="op" id="4943239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943242">c</span><span class="op" id="4943243">.</span><span class="ident" id="4943244">finalFlush</span><span class="op" id="4943254">(</span><span class="op" id="4943255">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943258">if</span>&nbsp;<span class="ident" id="4943261">c</span><span class="op" id="4943262">.</span><span class="ident" id="4943263">rwc</span>&nbsp;<span class="op" id="4943267">!=</span>&nbsp;<span class="ident" id="4943270">nil</span>&nbsp;<span class="op" id="4943274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943278">c</span><span class="op" id="4943279">.</span><span class="ident" id="4943280">rwc</span><span class="op" id="4943283">.</span><span class="ident" id="4943284">Close</span><span class="op" id="4943289">(</span><span class="op" id="4943290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943294">c</span><span class="op" id="4943295">.</span><span class="ident" id="4943296">rwc</span>&nbsp;<span class="op" id="4943300">=</span>&nbsp;<span class="ident" id="4943302">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4943307">}</span><br>
<span class="lineno"></span><span class="op" id="4943309">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span><span class="comment" id="4943312">//&nbsp;rstAvoidanceDelay&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;we&nbsp;sleep&nbsp;after&nbsp;closing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4943382">//&nbsp;write&nbsp;side&nbsp;of&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;before&nbsp;closing&nbsp;the&nbsp;entire&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="4943450">//&nbsp;By&nbsp;sleeping,&nbsp;we&nbsp;increase&nbsp;the&nbsp;chances&nbsp;that&nbsp;the&nbsp;client&nbsp;sees&nbsp;our&nbsp;FIN</span><br>
<span class="lineno"></span><span class="comment" id="4943519">//&nbsp;and&nbsp;processes&nbsp;its&nbsp;final&nbsp;data&nbsp;before&nbsp;they&nbsp;process&nbsp;the&nbsp;subsequent&nbsp;RST</span><br>
<span class="lineno">1080</span><span class="comment" id="4943590">//&nbsp;from&nbsp;closing&nbsp;a&nbsp;connection&nbsp;with&nbsp;known&nbsp;unread&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="4943643">//&nbsp;This&nbsp;RST&nbsp;seems&nbsp;to&nbsp;occur&nbsp;mostly&nbsp;on&nbsp;BSD&nbsp;systems.&nbsp;(And&nbsp;Windows?)</span><br>
<span class="lineno"></span><span class="comment" id="4943708">//&nbsp;This&nbsp;timeout&nbsp;is&nbsp;somewhat&nbsp;arbitrary&nbsp;(~latency&nbsp;around&nbsp;the&nbsp;planet).</span><br>
<span class="lineno"></span><span class="keyword" id="4943776">const</span>&nbsp;<span class="ident" id="4943782">rstAvoidanceDelay</span>&nbsp;<span class="op" id="4943800">=</span>&nbsp;<span class="num" id="4943802">500</span>&nbsp;<span class="op" id="4943806">*</span>&nbsp;<span class="ident" id="4943808">time</span><span class="op" id="4943812">.</span><span class="ident" id="4943813">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno">1085</span><span class="keyword" id="4943826">type</span>&nbsp;<span class="ident" id="4943831">closeWriter</span>&nbsp;<span class="keyword" id="4943843">interface</span>&nbsp;<span class="op" id="4943853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943856">CloseWrite</span><span class="op" id="4943866">(</span><span class="op" id="4943867">)</span>&nbsp;<span class="builtintype" id="4943869">error</span><br>
<span class="lineno"></span><span class="op" id="4943875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4943878">var</span>&nbsp;<span class="ident" id="4943882">_</span>&nbsp;<span class="ident" id="4943884">closeWriter</span>&nbsp;<span class="op" id="4943896">=</span>&nbsp;<span class="op" id="4943898">(</span><span class="op" id="4943899">*</span><span class="ident" id="4943900">net</span><span class="op" id="4943903">.</span><span class="ident" id="4943904">TCPConn</span><span class="op" id="4943911">)</span><span class="op" id="4943912">(</span><span class="ident" id="4943913">nil</span><span class="op" id="4943916">)</span><br>
<span class="lineno">1090</span><br>
<span class="lineno"></span><span class="comment" id="4943919">//&nbsp;closeWrite&nbsp;flushes&nbsp;any&nbsp;outstanding&nbsp;data&nbsp;and&nbsp;sends&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="4943989">//&nbsp;client&nbsp;is&nbsp;connected&nbsp;via&nbsp;TCP),&nbsp;signalling&nbsp;that&nbsp;we&#39;re&nbsp;done.&nbsp;&nbsp;We&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="4944059">//&nbsp;pause&nbsp;for&nbsp;a&nbsp;bit,&nbsp;hoping&nbsp;the&nbsp;client&nbsp;processes&nbsp;it&nbsp;before&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="4944121">//&nbsp;subsequent&nbsp;RST.</span><br>
<span class="lineno">1095</span><span class="comment" id="4944140">//</span><br>
<span class="lineno"></span><span class="comment" id="4944143">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="4944179">func</span>&nbsp;<span class="op" id="4944184">(</span><span class="ident" id="4944185">c</span>&nbsp;<span class="op" id="4944187">*</span><span class="ident" id="4944188">conn</span><span class="op" id="4944192">)</span>&nbsp;<span class="ident" id="4944194">closeWriteAndWait</span><span class="op" id="4944211">(</span><span class="op" id="4944212">)</span>&nbsp;<span class="op" id="4944214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4944217">c</span><span class="op" id="4944218">.</span><span class="ident" id="4944219">finalFlush</span><span class="op" id="4944229">(</span><span class="op" id="4944230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4944233">if</span>&nbsp;<span class="ident" id="4944236">tcp</span><span class="op" id="4944239">,</span>&nbsp;<span class="ident" id="4944241">ok</span>&nbsp;<span class="op" id="4944244">:=</span>&nbsp;<span class="ident" id="4944247">c</span><span class="op" id="4944248">.</span><span class="ident" id="4944249">rwc</span><span class="op" id="4944252">.</span><span class="op" id="4944253">(</span><span class="ident" id="4944254">closeWriter</span><span class="op" id="4944265">)</span><span class="op" id="4944266">;</span>&nbsp;<span class="ident" id="4944268">ok</span>&nbsp;<span class="op" id="4944271">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4944275">tcp</span><span class="op" id="4944278">.</span><span class="ident" id="4944279">CloseWrite</span><span class="op" id="4944289">(</span><span class="op" id="4944290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4944293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4944296">time</span><span class="op" id="4944300">.</span><span class="ident" id="4944301">Sleep</span><span class="op" id="4944306">(</span><span class="ident" id="4944307">rstAvoidanceDelay</span><span class="op" id="4944324">)</span><br>
<span class="lineno"></span><span class="op" id="4944326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="4944329">//&nbsp;validNPN&nbsp;reports&nbsp;whether&nbsp;the&nbsp;proto&nbsp;is&nbsp;not&nbsp;a&nbsp;blacklisted&nbsp;Next</span><br>
<span class="lineno"></span><span class="comment" id="4944393">//&nbsp;Protocol&nbsp;Negotiation&nbsp;protocol.&nbsp;&nbsp;Empty&nbsp;and&nbsp;built-in&nbsp;protocol&nbsp;types</span><br>
<span class="lineno"></span><span class="comment" id="4944462">//&nbsp;are&nbsp;blacklisted&nbsp;and&nbsp;can&#39;t&nbsp;be&nbsp;overridden&nbsp;with&nbsp;alternate</span><br>
<span class="lineno"></span><span class="comment" id="4944520">//&nbsp;implementations.</span><br>
<span class="lineno"></span><span class="keyword" id="4944540">func</span>&nbsp;<span class="ident" id="4944545">validNPN</span><span class="op" id="4944553">(</span><span class="ident" id="4944554">proto</span>&nbsp;<span class="builtintype" id="4944560">string</span><span class="op" id="4944566">)</span>&nbsp;<span class="builtintype" id="4944568">bool</span>&nbsp;<span class="op" id="4944573">{</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4944576">switch</span>&nbsp;<span class="ident" id="4944583">proto</span>&nbsp;<span class="op" id="4944589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4944592">case</span>&nbsp;<span class="string" id="4944597">&#34;&#34;</span><span class="op" id="4944599">,</span>&nbsp;<span class="string" id="4944601">&#34;http/1.1&#34;</span><span class="op" id="4944611">,</span>&nbsp;<span class="string" id="4944613">&#34;http/1.0&#34;</span><span class="op" id="4944623">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4944627">return</span>&nbsp;<span class="builtintype" id="4944634">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4944641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4944644">return</span>&nbsp;<span class="builtintype" id="4944651">true</span><br>
<span class="lineno">1115</span><span class="op" id="4944656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4944659">func</span>&nbsp;<span class="op" id="4944664">(</span><span class="ident" id="4944665">c</span>&nbsp;<span class="op" id="4944667">*</span><span class="ident" id="4944668">conn</span><span class="op" id="4944672">)</span>&nbsp;<span class="ident" id="4944674">setState</span><span class="op" id="4944682">(</span><span class="ident" id="4944683">nc</span>&nbsp;<span class="ident" id="4944686">net</span><span class="op" id="4944689">.</span><span class="ident" id="4944690">Conn</span><span class="op" id="4944694">,</span>&nbsp;<span class="ident" id="4944696">state</span>&nbsp;<span class="ident" id="4944702">ConnState</span><span class="op" id="4944711">)</span>&nbsp;<span class="op" id="4944713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4944716">if</span>&nbsp;<span class="ident" id="4944719">hook</span>&nbsp;<span class="op" id="4944724">:=</span>&nbsp;<span class="ident" id="4944727">c</span><span class="op" id="4944728">.</span><span class="ident" id="4944729">server</span><span class="op" id="4944735">.</span><span class="ident" id="4944736">ConnState</span><span class="op" id="4944745">;</span>&nbsp;<span class="ident" id="4944747">hook</span>&nbsp;<span class="op" id="4944752">!=</span>&nbsp;<span class="ident" id="4944755">nil</span>&nbsp;<span class="op" id="4944759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4944763">hook</span><span class="op" id="4944767">(</span><span class="ident" id="4944768">nc</span><span class="op" id="4944770">,</span>&nbsp;<span class="ident" id="4944772">state</span><span class="op" id="4944777">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4944780">}</span><br>
<span class="lineno"></span><span class="op" id="4944782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4944785">//&nbsp;Serve&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4944812">func</span>&nbsp;<span class="op" id="4944817">(</span><span class="ident" id="4944818">c</span>&nbsp;<span class="op" id="4944820">*</span><span class="ident" id="4944821">conn</span><span class="op" id="4944825">)</span>&nbsp;<span class="ident" id="4944827">serve</span><span class="op" id="4944832">(</span><span class="op" id="4944833">)</span>&nbsp;<span class="op" id="4944835">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4944838">origConn</span>&nbsp;<span class="op" id="4944847">:=</span>&nbsp;<span class="ident" id="4944850">c</span><span class="op" id="4944851">.</span><span class="ident" id="4944852">rwc</span>&nbsp;<span class="comment" id="4944856">//&nbsp;copy&nbsp;it&nbsp;before&nbsp;it&#39;s&nbsp;set&nbsp;nil&nbsp;on&nbsp;Close&nbsp;or&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4944907">defer</span>&nbsp;<span class="keyword" id="4944913">func</span><span class="op" id="4944917">(</span><span class="op" id="4944918">)</span>&nbsp;<span class="op" id="4944920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4944924">if</span>&nbsp;<span class="ident" id="4944927">err</span>&nbsp;<span class="op" id="4944931">:=</span>&nbsp;<span class="builtinfunc" id="4944934">recover</span><span class="op" id="4944941">(</span><span class="op" id="4944942">)</span><span class="op" id="4944943">;</span>&nbsp;<span class="ident" id="4944945">err</span>&nbsp;<span class="op" id="4944949">!=</span>&nbsp;<span class="ident" id="4944952">nil</span>&nbsp;<span class="op" id="4944956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4944961">const</span>&nbsp;<span class="ident" id="4944967">size</span>&nbsp;<span class="op" id="4944972">=</span>&nbsp;<span class="num" id="4944974">64</span>&nbsp;<span class="op" id="4944977">&lt;&lt;</span>&nbsp;<span class="num" id="4944980">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4944986">buf</span>&nbsp;<span class="op" id="4944990">:=</span>&nbsp;<span class="builtinfunc" id="4944993">make</span><span class="op" id="4944997">(</span><span class="op" id="4944998">[</span><span class="op" id="4944999">]</span><span class="builtintype" id="4945000">byte</span><span class="op" id="4945004">,</span>&nbsp;<span class="ident" id="4945006">size</span><span class="op" id="4945010">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4945015">buf</span>&nbsp;<span class="op" id="4945019">=</span>&nbsp;<span class="ident" id="4945021">buf</span><span class="op" id="4945024">[</span><span class="op" id="4945025">:</span><span class="ident" id="4945026">runtime</span><span class="op" id="4945033">.</span><span class="ident" id="4945034">Stack</span><span class="op" id="4945039">(</span><span class="ident" id="4945040">buf</span><span class="op" id="4945043">,</span>&nbsp;<span class="builtintype" id="4945045">false</span><span class="op" id="4945050">)</span><span class="op" id="4945051">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4945056">c</span><span class="op" id="4945057">.</span><span class="ident" id="4945058">server</span><span class="op" id="4945064">.</span><span class="ident" id="4945065">logf</span><span class="op" id="4945069">(</span><span class="string" id="4945070">&#34;http:&nbsp;panic&nbsp;serving&nbsp;%v:&nbsp;%v\n%s&#34;</span><span class="op" id="4945102">,</span>&nbsp;<span class="ident" id="4945104">c</span><span class="op" id="4945105">.</span><span class="ident" id="4945106">remoteAddr</span><span class="op" id="4945116">,</span>&nbsp;<span class="ident" id="4945118">err</span><span class="op" id="4945121">,</span>&nbsp;<span class="ident" id="4945123">buf</span><span class="op" id="4945126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4945130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4945134">if</span>&nbsp;<span class="op" id="4945137">!</span><span class="ident" id="4945138">c</span><span class="op" id="4945139">.</span><span class="ident" id="4945140">hijacked</span><span class="op" id="4945148">(</span><span class="op" id="4945149">)</span>&nbsp;<span class="op" id="4945151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4945156">c</span><span class="op" id="4945157">.</span><span class="builtinfunc" id="4945158">close</span><span class="op" id="4945163">(</span><span class="op" id="4945164">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4945169">c</span><span class="op" id="4945170">.</span><span class="ident" id="4945171">setState</span><span class="op" id="4945179">(</span><span class="ident" id="4945180">origConn</span><span class="op" id="4945188">,</span>&nbsp;<span class="ident" id="4945190">StateClosed</span><span class="op" id="4945201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4945205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4945208">}</span><span class="op" id="4945209">(</span><span class="op" id="4945210">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4945214">if</span>&nbsp;<span class="ident" id="4945217">tlsConn</span><span class="op" id="4945224">,</span>&nbsp;<span class="ident" id="4945226">ok</span>&nbsp;<span class="op" id="4945229">:=</span>&nbsp;<span class="ident" id="4945232">c</span><span class="op" id="4945233">.</span><span class="ident" id="4945234">rwc</span><span class="op" id="4945237">.</span><span class="op" id="4945238">(</span><span class="op" id="4945239">*</span><span class="ident" id="4945240">tls</span><span class="op" id="4945243">.</span><span class="ident" id="4945244">Conn</span><span class="op" id="4945248">)</span><span class="op" id="4945249">;</span>&nbsp;<span class="ident" id="4945251">ok</span>&nbsp;<span class="op" id="4945254">{</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4945258">if</span>&nbsp;<span class="ident" id="4945261">d</span>&nbsp;<span class="op" id="4945263">:=</span>&nbsp;<span class="ident" id="4945266">c</span><span class="op" id="4945267">.</span><span class="ident" id="4945268">server</span><span class="op" id="4945274">.</span><span class="ident" id="4945275">ReadTimeout</span><span class="op" id="4945286">;</span>&nbsp;<span class="ident" id="4945288">d</span>&nbsp;<span class="op" id="4945290">!=</span>&nbsp;<span class="num" id="4945293">0</span>&nbsp;<span class="op" id="4945295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4945300">c</span><span class="op" id="4945301">.</span><span class="ident" id="4945302">rwc</span><span class="op" id="4945305">.</span><span class="ident" id="4945306">SetReadDeadline</span><span class="op" id="4945321">(</span><span class="ident" id="4945322">time</span><span class="op" id="4945326">.</span><span class="ident" id="4945327">Now</span><span class="op" id="4945330">(</span><span class="op" id="4945331">)</span><span class="op" id="4945332">.</span><span class="ident" id="4945333">Add</span><span class="op" id="4945336">(</span><span class="ident" id="4945337">d</span><span class="op" id="4945338">)</span><span class="op" id="4945339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4945343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4945347">if</span>&nbsp;<span class="ident" id="4945350">d</span>&nbsp;<span class="op" id="4945352">:=</span>&nbsp;<span class="ident" id="4945355">c</span><span class="op" id="4945356">.</span><span class="ident" id="4945357">server</span><span class="op" id="4945363">.</span><span class="ident" id="4945364">WriteTimeout</span><span class="op" id="4945376">;</span>&nbsp;<span class="ident" id="4945378">d</span>&nbsp;<span class="op" id="4945380">!=</span>&nbsp;<span class="num" id="4945383">0</span>&nbsp;<span class="op" id="4945385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4945390">c</span><span class="op" id="4945391">.</span><span class="ident" id="4945392">rwc</span><span class="op" id="4945395">.</span><span class="ident" id="4945396">SetWriteDeadline</span><span class="op" id="4945412">(</span><span class="ident" id="4945413">time</span><span class="op" id="4945417">.</span><span class="ident" id="4945418">Now</span><span class="op" id="4945421">(</span><span class="op" id="4945422">)</span><span class="op" id="4945423">.</span><span class="ident" id="4945424">Add</span><span class="op" id="4945427">(</span><span class="ident" id="4945428">d</span><span class="op" id="4945429">)</span><span class="op" id="4945430">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4945434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4945438">if</span>&nbsp;<span class="ident" id="4945441">err</span>&nbsp;<span class="op" id="4945445">:=</span>&nbsp;<span class="ident" id="4945448">tlsConn</span><span class="op" id="4945455">.</span><span class="ident" id="4945456">Handshake</span><span class="op" id="4945465">(</span><span class="op" id="4945466">)</span><span class="op" id="4945467">;</span>&nbsp;<span class="ident" id="4945469">err</span>&nbsp;<span class="op" id="4945473">!=</span>&nbsp;<span class="ident" id="4945476">nil</span>&nbsp;<span class="op" id="4945480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4945485">c</span><span class="op" id="4945486">.</span><span class="ident" id="4945487">server</span><span class="op" id="4945493">.</span><span class="ident" id="4945494">logf</span><span class="op" id="4945498">(</span><span class="string" id="4945499">&#34;http:&nbsp;TLS&nbsp;handshake&nbsp;error&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="4945538">,</span>&nbsp;<span class="ident" id="4945540">c</span><span class="op" id="4945541">.</span><span class="ident" id="4945542">rwc</span><span class="op" id="4945545">.</span><span class="ident" id="4945546">RemoteAddr</span><span class="op" id="4945556">(</span><span class="op" id="4945557">)</span><span class="op" id="4945558">,</span>&nbsp;<span class="ident" id="4945560">err</span><span class="op" id="4945563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4945568">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4945577">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4945581">c</span><span class="op" id="4945582">.</span><span class="ident" id="4945583">tlsState</span>&nbsp;<span class="op" id="4945592">=</span>&nbsp;<span class="builtinfunc" id="4945594">new</span><span class="op" id="4945597">(</span><span class="ident" id="4945598">tls</span><span class="op" id="4945601">.</span><span class="ident" id="4945602">ConnectionState</span><span class="op" id="4945617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4945621">*</span><span class="ident" id="4945622">c</span><span class="op" id="4945623">.</span><span class="ident" id="4945624">tlsState</span>&nbsp;<span class="op" id="4945633">=</span>&nbsp;<span class="ident" id="4945635">tlsConn</span><span class="op" id="4945642">.</span><span class="ident" id="4945643">ConnectionState</span><span class="op" id="4945658">(</span><span class="op" id="4945659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4945663">if</span>&nbsp;<span class="ident" id="4945666">proto</span>&nbsp;<span class="op" id="4945672">:=</span>&nbsp;<span class="ident" id="4945675">c</span><span class="op" id="4945676">.</span><span class="ident" id="4945677">tlsState</span><span class="op" id="4945685">.</span><span class="ident" id="4945686">NegotiatedProtocol</span><span class="op" id="4945704">;</span>&nbsp;<span class="ident" id="4945706">validNPN</span><span class="op" id="4945714">(</span><span class="ident" id="4945715">proto</span><span class="op" id="4945720">)</span>&nbsp;<span class="op" id="4945722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4945727">if</span>&nbsp;<span class="ident" id="4945730">fn</span>&nbsp;<span class="op" id="4945733">:=</span>&nbsp;<span class="ident" id="4945736">c</span><span class="op" id="4945737">.</span><span class="ident" id="4945738">server</span><span class="op" id="4945744">.</span><span class="ident" id="4945745">TLSNextProto</span><span class="op" id="4945757">[</span><span class="ident" id="4945758">proto</span><span class="op" id="4945763">]</span><span class="op" id="4945764">;</span>&nbsp;<span class="ident" id="4945766">fn</span>&nbsp;<span class="op" id="4945769">!=</span>&nbsp;<span class="ident" id="4945772">nil</span>&nbsp;<span class="op" id="4945776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4945782">h</span>&nbsp;<span class="op" id="4945784">:=</span>&nbsp;<span class="ident" id="4945787">initNPNRequest</span><span class="op" id="4945801">{</span><span class="ident" id="4945802">tlsConn</span><span class="op" id="4945809">,</span>&nbsp;<span class="ident" id="4945811">serverHandler</span><span class="op" id="4945824">{</span><span class="ident" id="4945825">c</span><span class="op" id="4945826">.</span><span class="ident" id="4945827">server</span><span class="op" id="4945833">}</span><span class="op" id="4945834">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4945840">fn</span><span class="op" id="4945842">(</span><span class="ident" id="4945843">c</span><span class="op" id="4945844">.</span><span class="ident" id="4945845">server</span><span class="op" id="4945851">,</span>&nbsp;<span class="ident" id="4945853">tlsConn</span><span class="op" id="4945860">,</span>&nbsp;<span class="ident" id="4945862">h</span><span class="op" id="4945863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4945868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4945873">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4945882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4945885">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4945889">for</span>&nbsp;<span class="op" id="4945893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4945897">w</span><span class="op" id="4945898">,</span>&nbsp;<span class="ident" id="4945900">err</span>&nbsp;<span class="op" id="4945904">:=</span>&nbsp;<span class="ident" id="4945907">c</span><span class="op" id="4945908">.</span><span class="ident" id="4945909">readRequest</span><span class="op" id="4945920">(</span><span class="op" id="4945921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4945925">if</span>&nbsp;<span class="ident" id="4945928">c</span><span class="op" id="4945929">.</span><span class="ident" id="4945930">lr</span><span class="op" id="4945932">.</span><span class="ident" id="4945933">N</span>&nbsp;<span class="op" id="4945935">!=</span>&nbsp;<span class="ident" id="4945938">c</span><span class="op" id="4945939">.</span><span class="ident" id="4945940">server</span><span class="op" id="4945946">.</span><span class="ident" id="4945947">initialLimitedReaderSize</span><span class="op" id="4945971">(</span><span class="op" id="4945972">)</span>&nbsp;<span class="op" id="4945974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4945979">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we&#39;re&nbsp;active.</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4946034">c</span><span class="op" id="4946035">.</span><span class="ident" id="4946036">setState</span><span class="op" id="4946044">(</span><span class="ident" id="4946045">c</span><span class="op" id="4946046">.</span><span class="ident" id="4946047">rwc</span><span class="op" id="4946050">,</span>&nbsp;<span class="ident" id="4946052">StateActive</span><span class="op" id="4946063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4946067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4946071">if</span>&nbsp;<span class="ident" id="4946074">err</span>&nbsp;<span class="op" id="4946078">!=</span>&nbsp;<span class="ident" id="4946081">nil</span>&nbsp;<span class="op" id="4946085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4946090">if</span>&nbsp;<span class="ident" id="4946093">err</span>&nbsp;<span class="op" id="4946097">==</span>&nbsp;<span class="ident" id="4946100">errTooLarge</span>&nbsp;<span class="op" id="4946112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4946118">//&nbsp;Their&nbsp;HTTP&nbsp;client&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4946161">//&nbsp;able&nbsp;to&nbsp;read&nbsp;this&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4946195">//&nbsp;responding&nbsp;to&nbsp;them&nbsp;and&nbsp;hanging&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4946236">//&nbsp;while&nbsp;they&#39;re&nbsp;still&nbsp;writing&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4946277">//&nbsp;request.&nbsp;&nbsp;Undefined&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4946314">io</span><span class="op" id="4946316">.</span><span class="ident" id="4946317">WriteString</span><span class="op" id="4946328">(</span><span class="ident" id="4946329">c</span><span class="op" id="4946330">.</span><span class="ident" id="4946331">rwc</span><span class="op" id="4946334">,</span>&nbsp;<span class="string" id="4946336">&#34;HTTP/1.1&nbsp;413&nbsp;Request&nbsp;Entity&nbsp;Too&nbsp;Large\r\n\r\n&#34;</span><span class="op" id="4946383">)</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4946389">c</span><span class="op" id="4946390">.</span><span class="ident" id="4946391">closeWriteAndWait</span><span class="op" id="4946408">(</span><span class="op" id="4946409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4946415">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4946424">}</span>&nbsp;<span class="keyword" id="4946426">else</span>&nbsp;<span class="keyword" id="4946431">if</span>&nbsp;<span class="ident" id="4946434">err</span>&nbsp;<span class="op" id="4946438">==</span>&nbsp;<span class="ident" id="4946441">io</span><span class="op" id="4946443">.</span><span class="ident" id="4946444">EOF</span>&nbsp;<span class="op" id="4946448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4946454">break</span>&nbsp;<span class="comment" id="4946460">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4946478">}</span>&nbsp;<span class="keyword" id="4946480">else</span>&nbsp;<span class="keyword" id="4946485">if</span>&nbsp;<span class="ident" id="4946488">neterr</span><span class="op" id="4946494">,</span>&nbsp;<span class="ident" id="4946496">ok</span>&nbsp;<span class="op" id="4946499">:=</span>&nbsp;<span class="ident" id="4946502">err</span><span class="op" id="4946505">.</span><span class="op" id="4946506">(</span><span class="ident" id="4946507">net</span><span class="op" id="4946510">.</span><span class="ident" id="4946511">Error</span><span class="op" id="4946516">)</span><span class="op" id="4946517">;</span>&nbsp;<span class="ident" id="4946519">ok</span>&nbsp;<span class="op" id="4946522">&amp;&amp;</span>&nbsp;<span class="ident" id="4946525">neterr</span><span class="op" id="4946531">.</span><span class="ident" id="4946532">Timeout</span><span class="op" id="4946539">(</span><span class="op" id="4946540">)</span>&nbsp;<span class="op" id="4946542">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4946548">break</span>&nbsp;<span class="comment" id="4946554">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4946572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4946577">io</span><span class="op" id="4946579">.</span><span class="ident" id="4946580">WriteString</span><span class="op" id="4946591">(</span><span class="ident" id="4946592">c</span><span class="op" id="4946593">.</span><span class="ident" id="4946594">rwc</span><span class="op" id="4946597">,</span>&nbsp;<span class="string" id="4946599">&#34;HTTP/1.1&nbsp;400&nbsp;Bad&nbsp;Request\r\n\r\n&#34;</span><span class="op" id="4946633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4946638">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4946646">}</span><br>
<span class="lineno">1185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4946651">//&nbsp;Expect&nbsp;100&nbsp;Continue&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4946684">req</span>&nbsp;<span class="op" id="4946688">:=</span>&nbsp;<span class="ident" id="4946691">w</span><span class="op" id="4946692">.</span><span class="ident" id="4946693">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4946699">if</span>&nbsp;<span class="ident" id="4946702">req</span><span class="op" id="4946705">.</span><span class="ident" id="4946706">expectsContinue</span><span class="op" id="4946721">(</span><span class="op" id="4946722">)</span>&nbsp;<span class="op" id="4946724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4946729">if</span>&nbsp;<span class="ident" id="4946732">req</span><span class="op" id="4946735">.</span><span class="ident" id="4946736">ProtoAtLeast</span><span class="op" id="4946748">(</span><span class="num" id="4946749">1</span><span class="op" id="4946750">,</span>&nbsp;<span class="num" id="4946752">1</span><span class="op" id="4946753">)</span>&nbsp;<span class="op" id="4946755">&amp;&amp;</span>&nbsp;<span class="ident" id="4946758">req</span><span class="op" id="4946761">.</span><span class="ident" id="4946762">ContentLength</span>&nbsp;<span class="op" id="4946776">!=</span>&nbsp;<span class="num" id="4946779">0</span>&nbsp;<span class="op" id="4946781">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4946787">//&nbsp;Wrap&nbsp;the&nbsp;Body&nbsp;reader&nbsp;with&nbsp;one&nbsp;that&nbsp;replies&nbsp;on&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4946855">req</span><span class="op" id="4946858">.</span><span class="ident" id="4946859">Body</span>&nbsp;<span class="op" id="4946864">=</span>&nbsp;<span class="op" id="4946866">&amp;</span><span class="ident" id="4946867">expectContinueReader</span><span class="op" id="4946887">{</span><span class="ident" id="4946888">readCloser</span><span class="op" id="4946898">:</span>&nbsp;<span class="ident" id="4946900">req</span><span class="op" id="4946903">.</span><span class="ident" id="4946904">Body</span><span class="op" id="4946908">,</span>&nbsp;<span class="ident" id="4946910">resp</span><span class="op" id="4946914">:</span>&nbsp;<span class="ident" id="4946916">w</span><span class="op" id="4946917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4946922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4946927">req</span><span class="op" id="4946930">.</span><span class="ident" id="4946931">Header</span><span class="op" id="4946937">.</span><span class="ident" id="4946938">Del</span><span class="op" id="4946941">(</span><span class="string" id="4946942">&#34;Expect&#34;</span><span class="op" id="4946950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4946954">}</span>&nbsp;<span class="keyword" id="4946956">else</span>&nbsp;<span class="keyword" id="4946961">if</span>&nbsp;<span class="ident" id="4946964">req</span><span class="op" id="4946967">.</span><span class="ident" id="4946968">Header</span><span class="op" id="4946974">.</span><span class="ident" id="4946975">get</span><span class="op" id="4946978">(</span><span class="string" id="4946979">&#34;Expect&#34;</span><span class="op" id="4946987">)</span>&nbsp;<span class="op" id="4946989">!=</span>&nbsp;<span class="string" id="4946992">&#34;&#34;</span>&nbsp;<span class="op" id="4946995">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4947000">w</span><span class="op" id="4947001">.</span><span class="ident" id="4947002">sendExpectationFailed</span><span class="op" id="4947023">(</span><span class="op" id="4947024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4947029">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4947037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4947042">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[*]</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4947106">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can&#39;t&nbsp;read&nbsp;another,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4947176">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4947236">//&nbsp;[*]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4947312">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4947376">serverHandler</span><span class="op" id="4947389">{</span><span class="ident" id="4947390">c</span><span class="op" id="4947391">.</span><span class="ident" id="4947392">server</span><span class="op" id="4947398">}</span><span class="op" id="4947399">.</span><span class="ident" id="4947400">ServeHTTP</span><span class="op" id="4947409">(</span><span class="ident" id="4947410">w</span><span class="op" id="4947411">,</span>&nbsp;<span class="ident" id="4947413">w</span><span class="op" id="4947414">.</span><span class="ident" id="4947415">req</span><span class="op" id="4947418">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4947422">if</span>&nbsp;<span class="ident" id="4947425">c</span><span class="op" id="4947426">.</span><span class="ident" id="4947427">hijacked</span><span class="op" id="4947435">(</span><span class="op" id="4947436">)</span>&nbsp;<span class="op" id="4947438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4947443">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4947452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4947456">w</span><span class="op" id="4947457">.</span><span class="ident" id="4947458">finishRequest</span><span class="op" id="4947471">(</span><span class="op" id="4947472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4947476">if</span>&nbsp;<span class="ident" id="4947479">w</span><span class="op" id="4947480">.</span><span class="ident" id="4947481">closeAfterReply</span>&nbsp;<span class="op" id="4947497">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4947502">if</span>&nbsp;<span class="ident" id="4947505">w</span><span class="op" id="4947506">.</span><span class="ident" id="4947507">requestBodyLimitHit</span>&nbsp;<span class="op" id="4947527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4947533">c</span><span class="op" id="4947534">.</span><span class="ident" id="4947535">closeWriteAndWait</span><span class="op" id="4947552">(</span><span class="op" id="4947553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4947558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4947563">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4947571">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4947575">c</span><span class="op" id="4947576">.</span><span class="ident" id="4947577">setState</span><span class="op" id="4947585">(</span><span class="ident" id="4947586">c</span><span class="op" id="4947587">.</span><span class="ident" id="4947588">rwc</span><span class="op" id="4947591">,</span>&nbsp;<span class="ident" id="4947593">StateIdle</span><span class="op" id="4947602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4947605">}</span><br>
<span class="lineno"></span><span class="op" id="4947607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4947610">func</span>&nbsp;<span class="op" id="4947615">(</span><span class="ident" id="4947616">w</span>&nbsp;<span class="op" id="4947618">*</span><span class="ident" id="4947619">response</span><span class="op" id="4947627">)</span>&nbsp;<span class="ident" id="4947629">sendExpectationFailed</span><span class="op" id="4947650">(</span><span class="op" id="4947651">)</span>&nbsp;<span class="op" id="4947653">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4947656">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;ServeHTTP&nbsp;handlers&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4947706">//&nbsp;requests&nbsp;with&nbsp;non-standard&nbsp;expectation[s]?&nbsp;Seems</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4947759">//&nbsp;theoretical&nbsp;at&nbsp;best,&nbsp;and&nbsp;doesn&#39;t&nbsp;fit&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4947809">//&nbsp;current&nbsp;ServeHTTP&nbsp;model&nbsp;anyway.&nbsp;&nbsp;We&#39;d&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4947859">//&nbsp;make&nbsp;the&nbsp;ResponseWriter&nbsp;an&nbsp;optional</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4947899">//&nbsp;&#34;ExpectReplier&#34;&nbsp;interface&nbsp;or&nbsp;something.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4947943">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4947947">//&nbsp;For&nbsp;now&nbsp;we&#39;ll&nbsp;just&nbsp;obey&nbsp;RFC&nbsp;2616&nbsp;14.20&nbsp;which&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948001">//&nbsp;&#34;If&nbsp;a&nbsp;server&nbsp;receives&nbsp;a&nbsp;request&nbsp;containing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948051">//&nbsp;Expect&nbsp;field&nbsp;that&nbsp;includes&nbsp;an&nbsp;expectation-</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948098">//&nbsp;extension&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;support,&nbsp;it&nbsp;MUST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948146">//&nbsp;respond&nbsp;with&nbsp;a&nbsp;417&nbsp;(Expectation&nbsp;Failed)&nbsp;status.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4948199">w</span><span class="op" id="4948200">.</span><span class="ident" id="4948201">Header</span><span class="op" id="4948207">(</span><span class="op" id="4948208">)</span><span class="op" id="4948209">.</span><span class="ident" id="4948210">Set</span><span class="op" id="4948213">(</span><span class="string" id="4948214">&#34;Connection&#34;</span><span class="op" id="4948226">,</span>&nbsp;<span class="string" id="4948228">&#34;close&#34;</span><span class="op" id="4948235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4948238">w</span><span class="op" id="4948239">.</span><span class="ident" id="4948240">WriteHeader</span><span class="op" id="4948251">(</span><span class="ident" id="4948252">StatusExpectationFailed</span><span class="op" id="4948275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4948278">w</span><span class="op" id="4948279">.</span><span class="ident" id="4948280">finishRequest</span><span class="op" id="4948293">(</span><span class="op" id="4948294">)</span><br>
<span class="lineno">1235</span><span class="op" id="4948296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4948299">//&nbsp;Hijack&nbsp;implements&nbsp;the&nbsp;Hijacker.Hijack&nbsp;method.&nbsp;Our&nbsp;response&nbsp;is&nbsp;both&nbsp;a&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="4948386">//&nbsp;and&nbsp;a&nbsp;Hijacker.</span><br>
<span class="lineno"></span><span class="keyword" id="4948405">func</span>&nbsp;<span class="op" id="4948410">(</span><span class="ident" id="4948411">w</span>&nbsp;<span class="op" id="4948413">*</span><span class="ident" id="4948414">response</span><span class="op" id="4948422">)</span>&nbsp;<span class="ident" id="4948424">Hijack</span><span class="op" id="4948430">(</span><span class="op" id="4948431">)</span>&nbsp;<span class="op" id="4948433">(</span><span class="ident" id="4948434">rwc</span>&nbsp;<span class="ident" id="4948438">net</span><span class="op" id="4948441">.</span><span class="ident" id="4948442">Conn</span><span class="op" id="4948446">,</span>&nbsp;<span class="ident" id="4948448">buf</span>&nbsp;<span class="op" id="4948452">*</span><span class="ident" id="4948453">bufio</span><span class="op" id="4948458">.</span><span class="ident" id="4948459">ReadWriter</span><span class="op" id="4948469">,</span>&nbsp;<span class="ident" id="4948471">err</span>&nbsp;<span class="builtintype" id="4948475">error</span><span class="op" id="4948480">)</span>&nbsp;<span class="op" id="4948482">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4948485">if</span>&nbsp;<span class="ident" id="4948488">w</span><span class="op" id="4948489">.</span><span class="ident" id="4948490">wroteHeader</span>&nbsp;<span class="op" id="4948502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4948506">w</span><span class="op" id="4948507">.</span><span class="ident" id="4948508">cw</span><span class="op" id="4948510">.</span><span class="ident" id="4948511">flush</span><span class="op" id="4948516">(</span><span class="op" id="4948517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4948520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948523">//&nbsp;Release&nbsp;the&nbsp;bufioWriter&nbsp;that&nbsp;writes&nbsp;to&nbsp;the&nbsp;chunk&nbsp;writer,&nbsp;it&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948594">//&nbsp;used&nbsp;after&nbsp;a&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4948641">rwc</span><span class="op" id="4948644">,</span>&nbsp;<span class="ident" id="4948646">buf</span><span class="op" id="4948649">,</span>&nbsp;<span class="ident" id="4948651">err</span>&nbsp;<span class="op" id="4948655">=</span>&nbsp;<span class="ident" id="4948657">w</span><span class="op" id="4948658">.</span><span class="ident" id="4948659">conn</span><span class="op" id="4948663">.</span><span class="ident" id="4948664">hijack</span><span class="op" id="4948670">(</span><span class="op" id="4948671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4948674">if</span>&nbsp;<span class="ident" id="4948677">err</span>&nbsp;<span class="op" id="4948681">==</span>&nbsp;<span class="ident" id="4948684">nil</span>&nbsp;<span class="op" id="4948688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4948692">putBufioWriter</span><span class="op" id="4948706">(</span><span class="ident" id="4948707">w</span><span class="op" id="4948708">.</span><span class="ident" id="4948709">w</span><span class="op" id="4948710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4948714">w</span><span class="op" id="4948715">.</span><span class="ident" id="4948716">w</span>&nbsp;<span class="op" id="4948718">=</span>&nbsp;<span class="ident" id="4948720">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4948725">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4948728">return</span>&nbsp;<span class="ident" id="4948735">rwc</span><span class="op" id="4948738">,</span>&nbsp;<span class="ident" id="4948740">buf</span><span class="op" id="4948743">,</span>&nbsp;<span class="ident" id="4948745">err</span><br>
<span class="lineno"></span><span class="op" id="4948749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4948752">func</span>&nbsp;<span class="op" id="4948757">(</span><span class="ident" id="4948758">w</span>&nbsp;<span class="op" id="4948760">*</span><span class="ident" id="4948761">response</span><span class="op" id="4948769">)</span>&nbsp;<span class="ident" id="4948771">CloseNotify</span><span class="op" id="4948782">(</span><span class="op" id="4948783">)</span>&nbsp;<span class="op" id="4948785">&lt;-</span><span class="keyword" id="4948787">chan</span>&nbsp;<span class="builtintype" id="4948792">bool</span>&nbsp;<span class="op" id="4948797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4948800">return</span>&nbsp;<span class="ident" id="4948807">w</span><span class="op" id="4948808">.</span><span class="ident" id="4948809">conn</span><span class="op" id="4948813">.</span><span class="ident" id="4948814">closeNotify</span><span class="op" id="4948825">(</span><span class="op" id="4948826">)</span><br>
<span class="lineno">1255</span><span class="op" id="4948828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4948831">//&nbsp;The&nbsp;HandlerFunc&nbsp;type&nbsp;is&nbsp;an&nbsp;adapter&nbsp;to&nbsp;allow&nbsp;the&nbsp;use&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4948889">//&nbsp;ordinary&nbsp;functions&nbsp;as&nbsp;HTTP&nbsp;handlers.&nbsp;&nbsp;If&nbsp;f&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="4948949">//&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;signature,&nbsp;HandlerFunc(f)&nbsp;is&nbsp;a</span><br>
<span class="lineno">1260</span><span class="comment" id="4949004">//&nbsp;Handler&nbsp;object&nbsp;that&nbsp;calls&nbsp;f.</span><br>
<span class="lineno"></span><span class="keyword" id="4949036">type</span>&nbsp;<span class="ident" id="4949041">HandlerFunc</span>&nbsp;<span class="keyword" id="4949053">func</span><span class="op" id="4949057">(</span><span class="ident" id="4949058">ResponseWriter</span><span class="op" id="4949072">,</span>&nbsp;<span class="op" id="4949074">*</span><span class="ident" id="4949075">Request</span><span class="op" id="4949082">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4949085">//&nbsp;ServeHTTP&nbsp;calls&nbsp;f(w,&nbsp;r).</span><br>
<span class="lineno"></span><span class="keyword" id="4949113">func</span>&nbsp;<span class="op" id="4949118">(</span><span class="ident" id="4949119">f</span>&nbsp;<span class="ident" id="4949121">HandlerFunc</span><span class="op" id="4949132">)</span>&nbsp;<span class="ident" id="4949134">ServeHTTP</span><span class="op" id="4949143">(</span><span class="ident" id="4949144">w</span>&nbsp;<span class="ident" id="4949146">ResponseWriter</span><span class="op" id="4949160">,</span>&nbsp;<span class="ident" id="4949162">r</span>&nbsp;<span class="op" id="4949164">*</span><span class="ident" id="4949165">Request</span><span class="op" id="4949172">)</span>&nbsp;<span class="op" id="4949174">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4949177">f</span><span class="op" id="4949178">(</span><span class="ident" id="4949179">w</span><span class="op" id="4949180">,</span>&nbsp;<span class="ident" id="4949182">r</span><span class="op" id="4949183">)</span><br>
<span class="lineno"></span><span class="op" id="4949185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4949188">//&nbsp;Helper&nbsp;handlers</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="4949208">//&nbsp;Error&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;specified&nbsp;error&nbsp;message&nbsp;and&nbsp;HTTP&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="4949288">//&nbsp;The&nbsp;error&nbsp;message&nbsp;should&nbsp;be&nbsp;plain&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword" id="4949331">func</span>&nbsp;<span class="ident" id="4949336">Error</span><span class="op" id="4949341">(</span><span class="ident" id="4949342">w</span>&nbsp;<span class="ident" id="4949344">ResponseWriter</span><span class="op" id="4949358">,</span>&nbsp;<span class="builtintype" id="4949360">error</span>&nbsp;<span class="builtintype" id="4949366">string</span><span class="op" id="4949372">,</span>&nbsp;<span class="ident" id="4949374">code</span>&nbsp;<span class="builtintype" id="4949379">int</span><span class="op" id="4949382">)</span>&nbsp;<span class="op" id="4949384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4949387">w</span><span class="op" id="4949388">.</span><span class="ident" id="4949389">Header</span><span class="op" id="4949395">(</span><span class="op" id="4949396">)</span><span class="op" id="4949397">.</span><span class="ident" id="4949398">Set</span><span class="op" id="4949401">(</span><span class="string" id="4949402">&#34;Content-Type&#34;</span><span class="op" id="4949416">,</span>&nbsp;<span class="string" id="4949418">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="4949445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4949448">w</span><span class="op" id="4949449">.</span><span class="ident" id="4949450">WriteHeader</span><span class="op" id="4949461">(</span><span class="ident" id="4949462">code</span><span class="op" id="4949466">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4949469">fmt</span><span class="op" id="4949472">.</span><span class="ident" id="4949473">Fprintln</span><span class="op" id="4949481">(</span><span class="ident" id="4949482">w</span><span class="op" id="4949483">,</span>&nbsp;<span class="builtintype" id="4949485">error</span><span class="op" id="4949490">)</span><br>
<span class="lineno"></span><span class="op" id="4949492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4949495">//&nbsp;NotFound&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4949564">func</span>&nbsp;<span class="ident" id="4949569">NotFound</span><span class="op" id="4949577">(</span><span class="ident" id="4949578">w</span>&nbsp;<span class="ident" id="4949580">ResponseWriter</span><span class="op" id="4949594">,</span>&nbsp;<span class="ident" id="4949596">r</span>&nbsp;<span class="op" id="4949598">*</span><span class="ident" id="4949599">Request</span><span class="op" id="4949606">)</span>&nbsp;<span class="op" id="4949608">{</span>&nbsp;<span class="ident" id="4949610">Error</span><span class="op" id="4949615">(</span><span class="ident" id="4949616">w</span><span class="op" id="4949617">,</span>&nbsp;<span class="string" id="4949619">&#34;404&nbsp;page&nbsp;not&nbsp;found&#34;</span><span class="op" id="4949639">,</span>&nbsp;<span class="ident" id="4949641">StatusNotFound</span><span class="op" id="4949655">)</span>&nbsp;<span class="op" id="4949657">}</span><br>
<span class="lineno">1280</span><br>
<span class="lineno"></span><span class="comment" id="4949660">//&nbsp;NotFoundHandler&nbsp;returns&nbsp;a&nbsp;simple&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="4949712">//&nbsp;that&nbsp;replies&nbsp;to&nbsp;each&nbsp;request&nbsp;with&nbsp;a&nbsp;``404&nbsp;page&nbsp;not&nbsp;found&#39;&#39;&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="4949781">func</span>&nbsp;<span class="ident" id="4949786">NotFoundHandler</span><span class="op" id="4949801">(</span><span class="op" id="4949802">)</span>&nbsp;<span class="ident" id="4949804">Handler</span>&nbsp;<span class="op" id="4949812">{</span>&nbsp;<span class="keyword" id="4949814">return</span>&nbsp;<span class="ident" id="4949821">HandlerFunc</span><span class="op" id="4949832">(</span><span class="ident" id="4949833">NotFound</span><span class="op" id="4949841">)</span>&nbsp;<span class="op" id="4949843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span><span class="comment" id="4949846">//&nbsp;StripPrefix&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4949905">//&nbsp;by&nbsp;removing&nbsp;the&nbsp;given&nbsp;prefix&nbsp;from&nbsp;the&nbsp;request&nbsp;URL&#39;s&nbsp;Path</span><br>
<span class="lineno"></span><span class="comment" id="4949965">//&nbsp;and&nbsp;invoking&nbsp;the&nbsp;handler&nbsp;h.&nbsp;StripPrefix&nbsp;handles&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4950018">//&nbsp;request&nbsp;for&nbsp;a&nbsp;path&nbsp;that&nbsp;doesn&#39;t&nbsp;begin&nbsp;with&nbsp;prefix&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4950074">//&nbsp;replying&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno">1290</span><span class="keyword" id="4950120">func</span>&nbsp;<span class="ident" id="4950125">StripPrefix</span><span class="op" id="4950136">(</span><span class="ident" id="4950137">prefix</span>&nbsp;<span class="builtintype" id="4950144">string</span><span class="op" id="4950150">,</span>&nbsp;<span class="ident" id="4950152">h</span>&nbsp;<span class="ident" id="4950154">Handler</span><span class="op" id="4950161">)</span>&nbsp;<span class="ident" id="4950163">Handler</span>&nbsp;<span class="op" id="4950171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4950174">if</span>&nbsp;<span class="ident" id="4950177">prefix</span>&nbsp;<span class="op" id="4950184">==</span>&nbsp;<span class="string" id="4950187">&#34;&#34;</span>&nbsp;<span class="op" id="4950190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4950194">return</span>&nbsp;<span class="ident" id="4950201">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4950204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4950207">return</span>&nbsp;<span class="ident" id="4950214">HandlerFunc</span><span class="op" id="4950225">(</span><span class="keyword" id="4950226">func</span><span class="op" id="4950230">(</span><span class="ident" id="4950231">w</span>&nbsp;<span class="ident" id="4950233">ResponseWriter</span><span class="op" id="4950247">,</span>&nbsp;<span class="ident" id="4950249">r</span>&nbsp;<span class="op" id="4950251">*</span><span class="ident" id="4950252">Request</span><span class="op" id="4950259">)</span>&nbsp;<span class="op" id="4950261">{</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4950265">if</span>&nbsp;<span class="ident" id="4950268">p</span>&nbsp;<span class="op" id="4950270">:=</span>&nbsp;<span class="ident" id="4950273">strings</span><span class="op" id="4950280">.</span><span class="ident" id="4950281">TrimPrefix</span><span class="op" id="4950291">(</span><span class="ident" id="4950292">r</span><span class="op" id="4950293">.</span><span class="ident" id="4950294">URL</span><span class="op" id="4950297">.</span><span class="ident" id="4950298">Path</span><span class="op" id="4950302">,</span>&nbsp;<span class="ident" id="4950304">prefix</span><span class="op" id="4950310">)</span><span class="op" id="4950311">;</span>&nbsp;<span class="builtinfunc" id="4950313">len</span><span class="op" id="4950316">(</span><span class="ident" id="4950317">p</span><span class="op" id="4950318">)</span>&nbsp;<span class="op" id="4950320">&lt;</span>&nbsp;<span class="builtinfunc" id="4950322">len</span><span class="op" id="4950325">(</span><span class="ident" id="4950326">r</span><span class="op" id="4950327">.</span><span class="ident" id="4950328">URL</span><span class="op" id="4950331">.</span><span class="ident" id="4950332">Path</span><span class="op" id="4950336">)</span>&nbsp;<span class="op" id="4950338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950343">r</span><span class="op" id="4950344">.</span><span class="ident" id="4950345">URL</span><span class="op" id="4950348">.</span><span class="ident" id="4950349">Path</span>&nbsp;<span class="op" id="4950354">=</span>&nbsp;<span class="ident" id="4950356">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950361">h</span><span class="op" id="4950362">.</span><span class="ident" id="4950363">ServeHTTP</span><span class="op" id="4950372">(</span><span class="ident" id="4950373">w</span><span class="op" id="4950374">,</span>&nbsp;<span class="ident" id="4950376">r</span><span class="op" id="4950377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4950381">}</span>&nbsp;<span class="keyword" id="4950383">else</span>&nbsp;<span class="op" id="4950388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950393">NotFound</span><span class="op" id="4950401">(</span><span class="ident" id="4950402">w</span><span class="op" id="4950403">,</span>&nbsp;<span class="ident" id="4950405">r</span><span class="op" id="4950406">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4950410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4950413">}</span><span class="op" id="4950414">)</span><br>
<span class="lineno"></span><span class="op" id="4950416">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4950419">//&nbsp;Redirect&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;redirect&nbsp;to&nbsp;url,</span><br>
<span class="lineno">1305</span><span class="comment" id="4950478">//&nbsp;which&nbsp;may&nbsp;be&nbsp;a&nbsp;path&nbsp;relative&nbsp;to&nbsp;the&nbsp;request&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="4950531">func</span>&nbsp;<span class="ident" id="4950536">Redirect</span><span class="op" id="4950544">(</span><span class="ident" id="4950545">w</span>&nbsp;<span class="ident" id="4950547">ResponseWriter</span><span class="op" id="4950561">,</span>&nbsp;<span class="ident" id="4950563">r</span>&nbsp;<span class="op" id="4950565">*</span><span class="ident" id="4950566">Request</span><span class="op" id="4950573">,</span>&nbsp;<span class="ident" id="4950575">urlStr</span>&nbsp;<span class="builtintype" id="4950582">string</span><span class="op" id="4950588">,</span>&nbsp;<span class="ident" id="4950590">code</span>&nbsp;<span class="builtintype" id="4950595">int</span><span class="op" id="4950598">)</span>&nbsp;<span class="op" id="4950600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4950603">if</span>&nbsp;<span class="ident" id="4950606">u</span><span class="op" id="4950607">,</span>&nbsp;<span class="ident" id="4950609">err</span>&nbsp;<span class="op" id="4950613">:=</span>&nbsp;<span class="ident" id="4950616">url</span><span class="op" id="4950619">.</span><span class="ident" id="4950620">Parse</span><span class="op" id="4950625">(</span><span class="ident" id="4950626">urlStr</span><span class="op" id="4950632">)</span><span class="op" id="4950633">;</span>&nbsp;<span class="ident" id="4950635">err</span>&nbsp;<span class="op" id="4950639">==</span>&nbsp;<span class="ident" id="4950642">nil</span>&nbsp;<span class="op" id="4950646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4950650">//&nbsp;If&nbsp;url&nbsp;was&nbsp;relative,&nbsp;make&nbsp;absolute&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4950693">//&nbsp;combining&nbsp;with&nbsp;request&nbsp;path.</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4950727">//&nbsp;The&nbsp;browser&nbsp;would&nbsp;probably&nbsp;do&nbsp;this&nbsp;for&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4950775">//&nbsp;but&nbsp;doing&nbsp;it&nbsp;ourselves&nbsp;is&nbsp;more&nbsp;reliable.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4950822">//&nbsp;NOTE(rsc):&nbsp;RFC&nbsp;2616&nbsp;says&nbsp;that&nbsp;the&nbsp;Location</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4950870">//&nbsp;line&nbsp;must&nbsp;be&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;like</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4950910">//&nbsp;&#34;http://www.google.com/redirect/&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4950950">//&nbsp;not&nbsp;a&nbsp;path&nbsp;like&nbsp;&#34;/redirect/&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4950985">//&nbsp;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951027">//&nbsp;put&nbsp;in&nbsp;the&nbsp;host&nbsp;name&nbsp;section&nbsp;to&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951072">//&nbsp;client&nbsp;to&nbsp;connect&nbsp;to&nbsp;us&nbsp;again,&nbsp;so&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951120">//&nbsp;know&nbsp;the&nbsp;right&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;send&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951167">//&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;no&nbsp;one&nbsp;pays&nbsp;attention</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951219">//&nbsp;to&nbsp;the&nbsp;RFC;&nbsp;they&nbsp;all&nbsp;send&nbsp;back&nbsp;just&nbsp;a&nbsp;new&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951272">//&nbsp;So&nbsp;do&nbsp;we.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4951287">oldpath</span>&nbsp;<span class="op" id="4951295">:=</span>&nbsp;<span class="ident" id="4951298">r</span><span class="op" id="4951299">.</span><span class="ident" id="4951300">URL</span><span class="op" id="4951303">.</span><span class="ident" id="4951304">Path</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4951311">if</span>&nbsp;<span class="ident" id="4951314">oldpath</span>&nbsp;<span class="op" id="4951322">==</span>&nbsp;<span class="string" id="4951325">&#34;&#34;</span>&nbsp;<span class="op" id="4951328">{</span>&nbsp;<span class="comment" id="4951330">//&nbsp;should&nbsp;not&nbsp;happen,&nbsp;but&nbsp;avoid&nbsp;a&nbsp;crash&nbsp;if&nbsp;it&nbsp;does</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4951384">oldpath</span>&nbsp;<span class="op" id="4951392">=</span>&nbsp;<span class="string" id="4951394">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4951400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4951404">if</span>&nbsp;<span class="ident" id="4951407">u</span><span class="op" id="4951408">.</span><span class="ident" id="4951409">Scheme</span>&nbsp;<span class="op" id="4951416">==</span>&nbsp;<span class="string" id="4951419">&#34;&#34;</span>&nbsp;<span class="op" id="4951422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951427">//&nbsp;no&nbsp;leading&nbsp;http://server</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4951458">if</span>&nbsp;<span class="ident" id="4951461">urlStr</span>&nbsp;<span class="op" id="4951468">==</span>&nbsp;<span class="string" id="4951471">&#34;&#34;</span>&nbsp;<span class="op" id="4951474">||</span>&nbsp;<span class="ident" id="4951477">urlStr</span><span class="op" id="4951483">[</span><span class="num" id="4951484">0</span><span class="op" id="4951485">]</span>&nbsp;<span class="op" id="4951487">!=</span>&nbsp;<span class="string" id="4951490">&#39;/&#39;</span>&nbsp;<span class="op" id="4951494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951500">//&nbsp;make&nbsp;relative&nbsp;path&nbsp;absolute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4951535">olddir</span><span class="op" id="4951541">,</span>&nbsp;<span class="ident" id="4951543">_</span>&nbsp;<span class="op" id="4951545">:=</span>&nbsp;<span class="ident" id="4951548">path</span><span class="op" id="4951552">.</span><span class="ident" id="4951553">Split</span><span class="op" id="4951558">(</span><span class="ident" id="4951559">oldpath</span><span class="op" id="4951566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4951572">urlStr</span>&nbsp;<span class="op" id="4951579">=</span>&nbsp;<span class="ident" id="4951581">olddir</span>&nbsp;<span class="op" id="4951588">+</span>&nbsp;<span class="ident" id="4951590">urlStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4951600">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4951606">var</span>&nbsp;<span class="ident" id="4951610">query</span>&nbsp;<span class="builtintype" id="4951616">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4951626">if</span>&nbsp;<span class="ident" id="4951629">i</span>&nbsp;<span class="op" id="4951631">:=</span>&nbsp;<span class="ident" id="4951634">strings</span><span class="op" id="4951641">.</span><span class="ident" id="4951642">Index</span><span class="op" id="4951647">(</span><span class="ident" id="4951648">urlStr</span><span class="op" id="4951654">,</span>&nbsp;<span class="string" id="4951656">&#34;?&#34;</span><span class="op" id="4951659">)</span><span class="op" id="4951660">;</span>&nbsp;<span class="ident" id="4951662">i</span>&nbsp;<span class="op" id="4951664">!=</span>&nbsp;<span class="op" id="4951667">-</span><span class="num" id="4951668">1</span>&nbsp;<span class="op" id="4951670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4951676">urlStr</span><span class="op" id="4951682">,</span>&nbsp;<span class="ident" id="4951684">query</span>&nbsp;<span class="op" id="4951690">=</span>&nbsp;<span class="ident" id="4951692">urlStr</span><span class="op" id="4951698">[</span><span class="op" id="4951699">:</span><span class="ident" id="4951700">i</span><span class="op" id="4951701">]</span><span class="op" id="4951702">,</span>&nbsp;<span class="ident" id="4951704">urlStr</span><span class="op" id="4951710">[</span><span class="ident" id="4951711">i</span><span class="op" id="4951712">:</span><span class="op" id="4951713">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4951718">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951724">//&nbsp;clean&nbsp;up&nbsp;but&nbsp;preserve&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4951767">trailing</span>&nbsp;<span class="op" id="4951776">:=</span>&nbsp;<span class="ident" id="4951779">strings</span><span class="op" id="4951786">.</span><span class="ident" id="4951787">HasSuffix</span><span class="op" id="4951796">(</span><span class="ident" id="4951797">urlStr</span><span class="op" id="4951803">,</span>&nbsp;<span class="string" id="4951805">&#34;/&#34;</span><span class="op" id="4951808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4951813">urlStr</span>&nbsp;<span class="op" id="4951820">=</span>&nbsp;<span class="ident" id="4951822">path</span><span class="op" id="4951826">.</span><span class="ident" id="4951827">Clean</span><span class="op" id="4951832">(</span><span class="ident" id="4951833">urlStr</span><span class="op" id="4951839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4951844">if</span>&nbsp;<span class="ident" id="4951847">trailing</span>&nbsp;<span class="op" id="4951856">&amp;&amp;</span>&nbsp;<span class="op" id="4951859">!</span><span class="ident" id="4951860">strings</span><span class="op" id="4951867">.</span><span class="ident" id="4951868">HasSuffix</span><span class="op" id="4951877">(</span><span class="ident" id="4951878">urlStr</span><span class="op" id="4951884">,</span>&nbsp;<span class="string" id="4951886">&#34;/&#34;</span><span class="op" id="4951889">)</span>&nbsp;<span class="op" id="4951891">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4951897">urlStr</span>&nbsp;<span class="op" id="4951904">+=</span>&nbsp;<span class="string" id="4951907">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4951914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4951919">urlStr</span>&nbsp;<span class="op" id="4951926">+=</span>&nbsp;<span class="ident" id="4951929">query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4951937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4951940">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4951944">w</span><span class="op" id="4951945">.</span><span class="ident" id="4951946">Header</span><span class="op" id="4951952">(</span><span class="op" id="4951953">)</span><span class="op" id="4951954">.</span><span class="ident" id="4951955">Set</span><span class="op" id="4951958">(</span><span class="string" id="4951959">&#34;Location&#34;</span><span class="op" id="4951969">,</span>&nbsp;<span class="ident" id="4951971">urlStr</span><span class="op" id="4951977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4951980">w</span><span class="op" id="4951981">.</span><span class="ident" id="4951982">WriteHeader</span><span class="op" id="4951993">(</span><span class="ident" id="4951994">code</span><span class="op" id="4951998">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4952002">//&nbsp;RFC2616&nbsp;recommends&nbsp;that&nbsp;a&nbsp;short&nbsp;note&nbsp;&#34;SHOULD&#34;&nbsp;be&nbsp;included&nbsp;in&nbsp;the</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4952071">//&nbsp;response&nbsp;because&nbsp;older&nbsp;user&nbsp;agents&nbsp;may&nbsp;not&nbsp;understand&nbsp;301/307.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4952138">//&nbsp;Shouldn&#39;t&nbsp;send&nbsp;the&nbsp;response&nbsp;for&nbsp;POST&nbsp;or&nbsp;HEAD;&nbsp;that&nbsp;leaves&nbsp;GET.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4952205">if</span>&nbsp;<span class="ident" id="4952208">r</span><span class="op" id="4952209">.</span><span class="ident" id="4952210">Method</span>&nbsp;<span class="op" id="4952217">==</span>&nbsp;<span class="string" id="4952220">&#34;GET&#34;</span>&nbsp;<span class="op" id="4952226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4952230">note</span>&nbsp;<span class="op" id="4952235">:=</span>&nbsp;<span class="string" id="4952238">&#34;&lt;a&nbsp;href=\&#34;&#34;</span>&nbsp;<span class="op" id="4952251">+</span>&nbsp;<span class="ident" id="4952253">htmlEscape</span><span class="op" id="4952263">(</span><span class="ident" id="4952264">urlStr</span><span class="op" id="4952270">)</span>&nbsp;<span class="op" id="4952272">+</span>&nbsp;<span class="string" id="4952274">&#34;\&#34;&gt;&#34;</span>&nbsp;<span class="op" id="4952280">+</span>&nbsp;<span class="ident" id="4952282">statusText</span><span class="op" id="4952292">[</span><span class="ident" id="4952293">code</span><span class="op" id="4952297">]</span>&nbsp;<span class="op" id="4952299">+</span>&nbsp;<span class="string" id="4952301">&#34;&lt;/a&gt;.\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4952313">fmt</span><span class="op" id="4952316">.</span><span class="ident" id="4952317">Fprintln</span><span class="op" id="4952325">(</span><span class="ident" id="4952326">w</span><span class="op" id="4952327">,</span>&nbsp;<span class="ident" id="4952329">note</span><span class="op" id="4952333">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4952336">}</span><br>
<span class="lineno"></span><span class="op" id="4952338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4952341">var</span>&nbsp;<span class="ident" id="4952345">htmlReplacer</span>&nbsp;<span class="op" id="4952358">=</span>&nbsp;<span class="ident" id="4952360">strings</span><span class="op" id="4952367">.</span><span class="ident" id="4952368">NewReplacer</span><span class="op" id="4952379">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4952382">&#34;&amp;&#34;</span><span class="op" id="4952385">,</span>&nbsp;<span class="string" id="4952387">&#34;&amp;amp;&#34;</span><span class="op" id="4952394">,</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4952397">&#34;&lt;&#34;</span><span class="op" id="4952400">,</span>&nbsp;<span class="string" id="4952402">&#34;&amp;lt;&#34;</span><span class="op" id="4952408">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4952411">&#34;&gt;&#34;</span><span class="op" id="4952414">,</span>&nbsp;<span class="string" id="4952416">&#34;&amp;gt;&#34;</span><span class="op" id="4952422">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4952425">//&nbsp;&#34;&amp;#34;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;quot;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4952463">`&#34;`</span><span class="op" id="4952466">,</span>&nbsp;<span class="string" id="4952468">&#34;&amp;#34;&#34;</span><span class="op" id="4952475">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4952478">//&nbsp;&#34;&amp;#39;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;apos;&#34;&nbsp;and&nbsp;apos&nbsp;was&nbsp;not&nbsp;in&nbsp;HTML&nbsp;until&nbsp;HTML5.</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4952553">&#34;&#39;&#34;</span><span class="op" id="4952556">,</span>&nbsp;<span class="string" id="4952558">&#34;&amp;#39;&#34;</span><span class="op" id="4952565">,</span><br>
<span class="lineno"></span><span class="op" id="4952567">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4952570">func</span>&nbsp;<span class="ident" id="4952575">htmlEscape</span><span class="op" id="4952585">(</span><span class="ident" id="4952586">s</span>&nbsp;<span class="builtintype" id="4952588">string</span><span class="op" id="4952594">)</span>&nbsp;<span class="builtintype" id="4952596">string</span>&nbsp;<span class="op" id="4952603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4952606">return</span>&nbsp;<span class="ident" id="4952613">htmlReplacer</span><span class="op" id="4952625">.</span><span class="ident" id="4952626">Replace</span><span class="op" id="4952633">(</span><span class="ident" id="4952634">s</span><span class="op" id="4952635">)</span><br>
<span class="lineno">1375</span><span class="op" id="4952637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4952640">//&nbsp;Redirect&nbsp;to&nbsp;a&nbsp;fixed&nbsp;URL</span><br>
<span class="lineno"></span><span class="keyword" id="4952667">type</span>&nbsp;<span class="ident" id="4952672">redirectHandler</span>&nbsp;<span class="keyword" id="4952688">struct</span>&nbsp;<span class="op" id="4952695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4952698">url</span>&nbsp;&nbsp;<span class="builtintype" id="4952703">string</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4952711">code</span>&nbsp;<span class="builtintype" id="4952716">int</span><br>
<span class="lineno"></span><span class="op" id="4952720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4952723">func</span>&nbsp;<span class="op" id="4952728">(</span><span class="ident" id="4952729">rh</span>&nbsp;<span class="op" id="4952732">*</span><span class="ident" id="4952733">redirectHandler</span><span class="op" id="4952748">)</span>&nbsp;<span class="ident" id="4952750">ServeHTTP</span><span class="op" id="4952759">(</span><span class="ident" id="4952760">w</span>&nbsp;<span class="ident" id="4952762">ResponseWriter</span><span class="op" id="4952776">,</span>&nbsp;<span class="ident" id="4952778">r</span>&nbsp;<span class="op" id="4952780">*</span><span class="ident" id="4952781">Request</span><span class="op" id="4952788">)</span>&nbsp;<span class="op" id="4952790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4952793">Redirect</span><span class="op" id="4952801">(</span><span class="ident" id="4952802">w</span><span class="op" id="4952803">,</span>&nbsp;<span class="ident" id="4952805">r</span><span class="op" id="4952806">,</span>&nbsp;<span class="ident" id="4952808">rh</span><span class="op" id="4952810">.</span><span class="ident" id="4952811">url</span><span class="op" id="4952814">,</span>&nbsp;<span class="ident" id="4952816">rh</span><span class="op" id="4952818">.</span><span class="ident" id="4952819">code</span><span class="op" id="4952823">)</span><br>
<span class="lineno">1385</span><span class="op" id="4952825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4952828">//&nbsp;RedirectHandler&nbsp;returns&nbsp;a&nbsp;request&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno"></span><span class="comment" id="4952888">//&nbsp;each&nbsp;request&nbsp;it&nbsp;receives&nbsp;to&nbsp;the&nbsp;given&nbsp;url&nbsp;using&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment" id="4952949">//&nbsp;status&nbsp;code.</span><br>
<span class="lineno">1390</span><span class="keyword" id="4952965">func</span>&nbsp;<span class="ident" id="4952970">RedirectHandler</span><span class="op" id="4952985">(</span><span class="ident" id="4952986">url</span>&nbsp;<span class="builtintype" id="4952990">string</span><span class="op" id="4952996">,</span>&nbsp;<span class="ident" id="4952998">code</span>&nbsp;<span class="builtintype" id="4953003">int</span><span class="op" id="4953006">)</span>&nbsp;<span class="ident" id="4953008">Handler</span>&nbsp;<span class="op" id="4953016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4953019">return</span>&nbsp;<span class="op" id="4953026">&amp;</span><span class="ident" id="4953027">redirectHandler</span><span class="op" id="4953042">{</span><span class="ident" id="4953043">url</span><span class="op" id="4953046">,</span>&nbsp;<span class="ident" id="4953048">code</span><span class="op" id="4953052">}</span><br>
<span class="lineno"></span><span class="op" id="4953054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4953057">//&nbsp;ServeMux&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;multiplexer.</span><br>
<span class="lineno">1395</span><span class="comment" id="4953101">//&nbsp;It&nbsp;matches&nbsp;the&nbsp;URL&nbsp;of&nbsp;each&nbsp;incoming&nbsp;request&nbsp;against&nbsp;a&nbsp;list&nbsp;of&nbsp;registered</span><br>
<span class="lineno"></span><span class="comment" id="4953177">//&nbsp;patterns&nbsp;and&nbsp;calls&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;pattern&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4953232">//&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;URL.</span><br>
<span class="lineno"></span><span class="comment" id="4953265">//</span><br>
<span class="lineno"></span><span class="comment" id="4953268">//&nbsp;Patterns&nbsp;name&nbsp;fixed,&nbsp;rooted&nbsp;paths,&nbsp;like&nbsp;&#34;/favicon.ico&#34;,</span><br>
<span class="lineno">1400</span><span class="comment" id="4953327">//&nbsp;or&nbsp;rooted&nbsp;subtrees,&nbsp;like&nbsp;&#34;/images/&#34;&nbsp;(note&nbsp;the&nbsp;trailing&nbsp;slash).</span><br>
<span class="lineno"></span><span class="comment" id="4953393">//&nbsp;Longer&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over&nbsp;shorter&nbsp;ones,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4953455">//&nbsp;if&nbsp;there&nbsp;are&nbsp;handlers&nbsp;registered&nbsp;for&nbsp;both&nbsp;&#34;/images/&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4953511">//&nbsp;and&nbsp;&#34;/images/thumbnails/&#34;,&nbsp;the&nbsp;latter&nbsp;handler&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4953568">//&nbsp;called&nbsp;for&nbsp;paths&nbsp;beginning&nbsp;&#34;/images/thumbnails/&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno">1405</span><span class="comment" id="4953628">//&nbsp;former&nbsp;will&nbsp;receive&nbsp;requests&nbsp;for&nbsp;any&nbsp;other&nbsp;paths&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4953687">//&nbsp;&#34;/images/&#34;&nbsp;subtree.</span><br>
<span class="lineno"></span><span class="comment" id="4953710">//</span><br>
<span class="lineno"></span><span class="comment" id="4953713">//&nbsp;Note&nbsp;that&nbsp;since&nbsp;a&nbsp;pattern&nbsp;ending&nbsp;in&nbsp;a&nbsp;slash&nbsp;names&nbsp;a&nbsp;rooted&nbsp;subtree,</span><br>
<span class="lineno"></span><span class="comment" id="4953784">//&nbsp;the&nbsp;pattern&nbsp;&#34;/&#34;&nbsp;matches&nbsp;all&nbsp;paths&nbsp;not&nbsp;matched&nbsp;by&nbsp;other&nbsp;registered</span><br>
<span class="lineno">1410</span><span class="comment" id="4953853">//&nbsp;patterns,&nbsp;not&nbsp;just&nbsp;the&nbsp;URL&nbsp;with&nbsp;Path&nbsp;==&nbsp;&#34;/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="4953901">//</span><br>
<span class="lineno"></span><span class="comment" id="4953904">//&nbsp;Patterns&nbsp;may&nbsp;optionally&nbsp;begin&nbsp;with&nbsp;a&nbsp;host&nbsp;name,&nbsp;restricting&nbsp;matches&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4953978">//&nbsp;URLs&nbsp;on&nbsp;that&nbsp;host&nbsp;only.&nbsp;&nbsp;Host-specific&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="4954050">//&nbsp;general&nbsp;patterns,&nbsp;so&nbsp;that&nbsp;a&nbsp;handler&nbsp;might&nbsp;register&nbsp;for&nbsp;the&nbsp;two&nbsp;patterns</span><br>
<span class="lineno">1415</span><span class="comment" id="4954125">//&nbsp;&#34;/codesearch&#34;&nbsp;and&nbsp;&#34;codesearch.google.com/&#34;&nbsp;without&nbsp;also&nbsp;taking&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="4954196">//&nbsp;requests&nbsp;for&nbsp;&#34;http://www.google.com/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="4954238">//</span><br>
<span class="lineno"></span><span class="comment" id="4954241">//&nbsp;ServeMux&nbsp;also&nbsp;takes&nbsp;care&nbsp;of&nbsp;sanitizing&nbsp;the&nbsp;URL&nbsp;request&nbsp;path,</span><br>
<span class="lineno"></span><span class="comment" id="4954305">//&nbsp;redirecting&nbsp;any&nbsp;request&nbsp;containing&nbsp;.&nbsp;or&nbsp;..&nbsp;elements&nbsp;to&nbsp;an</span><br>
<span class="lineno">1420</span><span class="comment" id="4954366">//&nbsp;equivalent&nbsp;.-&nbsp;and&nbsp;..-free&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="4954400">type</span>&nbsp;<span class="ident" id="4954405">ServeMux</span>&nbsp;<span class="keyword" id="4954414">struct</span>&nbsp;<span class="op" id="4954421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4954424">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4954430">sync</span><span class="op" id="4954434">.</span><span class="ident" id="4954435">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4954444">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4954450">map</span><span class="op" id="4954453">[</span><span class="builtintype" id="4954454">string</span><span class="op" id="4954460">]</span><span class="ident" id="4954461">muxEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4954471">hosts</span>&nbsp;<span class="builtintype" id="4954477">bool</span>&nbsp;<span class="comment" id="4954482">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span><br>
<span class="lineno">1425</span><span class="op" id="4954524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4954527">type</span>&nbsp;<span class="ident" id="4954532">muxEntry</span>&nbsp;<span class="keyword" id="4954541">struct</span>&nbsp;<span class="op" id="4954548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4954551">explicit</span>&nbsp;<span class="builtintype" id="4954560">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4954566">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4954575">Handler</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4954584">pattern</span>&nbsp;&nbsp;<span class="builtintype" id="4954593">string</span><br>
<span class="lineno"></span><span class="op" id="4954600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4954603">//&nbsp;NewServeMux&nbsp;allocates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="4954656">func</span>&nbsp;<span class="ident" id="4954661">NewServeMux</span><span class="op" id="4954672">(</span><span class="op" id="4954673">)</span>&nbsp;<span class="op" id="4954675">*</span><span class="ident" id="4954676">ServeMux</span>&nbsp;<span class="op" id="4954685">{</span>&nbsp;<span class="keyword" id="4954687">return</span>&nbsp;<span class="op" id="4954694">&amp;</span><span class="ident" id="4954695">ServeMux</span><span class="op" id="4954703">{</span><span class="ident" id="4954704">m</span><span class="op" id="4954705">:</span>&nbsp;<span class="builtinfunc" id="4954707">make</span><span class="op" id="4954711">(</span><span class="keyword" id="4954712">map</span><span class="op" id="4954715">[</span><span class="builtintype" id="4954716">string</span><span class="op" id="4954722">]</span><span class="ident" id="4954723">muxEntry</span><span class="op" id="4954731">)</span><span class="op" id="4954732">}</span>&nbsp;<span class="op" id="4954734">}</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span><span class="comment" id="4954737">//&nbsp;DefaultServeMux&nbsp;is&nbsp;the&nbsp;default&nbsp;ServeMux&nbsp;used&nbsp;by&nbsp;Serve.</span><br>
<span class="lineno"></span><span class="keyword" id="4954795">var</span>&nbsp;<span class="ident" id="4954799">DefaultServeMux</span>&nbsp;<span class="op" id="4954815">=</span>&nbsp;<span class="ident" id="4954817">NewServeMux</span><span class="op" id="4954828">(</span><span class="op" id="4954829">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4954832">//&nbsp;Does&nbsp;path&nbsp;match&nbsp;pattern?</span><br>
<span class="lineno">1440</span><span class="keyword" id="4954860">func</span>&nbsp;<span class="ident" id="4954865">pathMatch</span><span class="op" id="4954874">(</span><span class="ident" id="4954875">pattern</span><span class="op" id="4954882">,</span>&nbsp;<span class="ident" id="4954884">path</span>&nbsp;<span class="builtintype" id="4954889">string</span><span class="op" id="4954895">)</span>&nbsp;<span class="builtintype" id="4954897">bool</span>&nbsp;<span class="op" id="4954902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954905">if</span>&nbsp;<span class="builtinfunc" id="4954908">len</span><span class="op" id="4954911">(</span><span class="ident" id="4954912">pattern</span><span class="op" id="4954919">)</span>&nbsp;<span class="op" id="4954921">==</span>&nbsp;<span class="num" id="4954924">0</span>&nbsp;<span class="op" id="4954926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4954930">//&nbsp;should&nbsp;not&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954953">return</span>&nbsp;<span class="builtintype" id="4954960">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4954967">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4954970">n</span>&nbsp;<span class="op" id="4954972">:=</span>&nbsp;<span class="builtinfunc" id="4954975">len</span><span class="op" id="4954978">(</span><span class="ident" id="4954979">pattern</span><span class="op" id="4954986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954989">if</span>&nbsp;<span class="ident" id="4954992">pattern</span><span class="op" id="4954999">[</span><span class="ident" id="4955000">n</span><span class="op" id="4955001">-</span><span class="num" id="4955002">1</span><span class="op" id="4955003">]</span>&nbsp;<span class="op" id="4955005">!=</span>&nbsp;<span class="string" id="4955008">&#39;/&#39;</span>&nbsp;<span class="op" id="4955012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955016">return</span>&nbsp;<span class="ident" id="4955023">pattern</span>&nbsp;<span class="op" id="4955031">==</span>&nbsp;<span class="ident" id="4955034">path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4955040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955043">return</span>&nbsp;<span class="builtinfunc" id="4955050">len</span><span class="op" id="4955053">(</span><span class="ident" id="4955054">path</span><span class="op" id="4955058">)</span>&nbsp;<span class="op" id="4955060">&gt;=</span>&nbsp;<span class="ident" id="4955063">n</span>&nbsp;<span class="op" id="4955065">&amp;&amp;</span>&nbsp;<span class="ident" id="4955068">path</span><span class="op" id="4955072">[</span><span class="num" id="4955073">0</span><span class="op" id="4955074">:</span><span class="ident" id="4955075">n</span><span class="op" id="4955076">]</span>&nbsp;<span class="op" id="4955078">==</span>&nbsp;<span class="ident" id="4955081">pattern</span><br>
<span class="lineno">1450</span><span class="op" id="4955089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4955092">//&nbsp;Return&nbsp;the&nbsp;canonical&nbsp;path&nbsp;for&nbsp;p,&nbsp;eliminating&nbsp;.&nbsp;and&nbsp;..&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword" id="4955159">func</span>&nbsp;<span class="ident" id="4955164">cleanPath</span><span class="op" id="4955173">(</span><span class="ident" id="4955174">p</span>&nbsp;<span class="builtintype" id="4955176">string</span><span class="op" id="4955182">)</span>&nbsp;<span class="builtintype" id="4955184">string</span>&nbsp;<span class="op" id="4955191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955194">if</span>&nbsp;<span class="ident" id="4955197">p</span>&nbsp;<span class="op" id="4955199">==</span>&nbsp;<span class="string" id="4955202">&#34;&#34;</span>&nbsp;<span class="op" id="4955205">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955209">return</span>&nbsp;<span class="string" id="4955216">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4955221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955224">if</span>&nbsp;<span class="ident" id="4955227">p</span><span class="op" id="4955228">[</span><span class="num" id="4955229">0</span><span class="op" id="4955230">]</span>&nbsp;<span class="op" id="4955232">!=</span>&nbsp;<span class="string" id="4955235">&#39;/&#39;</span>&nbsp;<span class="op" id="4955239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4955243">p</span>&nbsp;<span class="op" id="4955245">=</span>&nbsp;<span class="string" id="4955247">&#34;/&#34;</span>&nbsp;<span class="op" id="4955251">+</span>&nbsp;<span class="ident" id="4955253">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4955256">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4955259">np</span>&nbsp;<span class="op" id="4955262">:=</span>&nbsp;<span class="ident" id="4955265">path</span><span class="op" id="4955269">.</span><span class="ident" id="4955270">Clean</span><span class="op" id="4955275">(</span><span class="ident" id="4955276">p</span><span class="op" id="4955277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4955280">//&nbsp;path.Clean&nbsp;removes&nbsp;trailing&nbsp;slash&nbsp;except&nbsp;for&nbsp;root;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4955335">//&nbsp;put&nbsp;the&nbsp;trailing&nbsp;slash&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955381">if</span>&nbsp;<span class="ident" id="4955384">p</span><span class="op" id="4955385">[</span><span class="builtinfunc" id="4955386">len</span><span class="op" id="4955389">(</span><span class="ident" id="4955390">p</span><span class="op" id="4955391">)</span><span class="op" id="4955392">-</span><span class="num" id="4955393">1</span><span class="op" id="4955394">]</span>&nbsp;<span class="op" id="4955396">==</span>&nbsp;<span class="string" id="4955399">&#39;/&#39;</span>&nbsp;<span class="op" id="4955403">&amp;&amp;</span>&nbsp;<span class="ident" id="4955406">np</span>&nbsp;<span class="op" id="4955409">!=</span>&nbsp;<span class="string" id="4955412">&#34;/&#34;</span>&nbsp;<span class="op" id="4955416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4955420">np</span>&nbsp;<span class="op" id="4955423">+=</span>&nbsp;<span class="string" id="4955426">&#34;/&#34;</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4955431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955434">return</span>&nbsp;<span class="ident" id="4955441">np</span><br>
<span class="lineno"></span><span class="op" id="4955444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4955447">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string</span><br>
<span class="lineno">1470</span><span class="comment" id="4955502">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins</span><br>
<span class="lineno"></span><span class="keyword" id="4955542">func</span>&nbsp;<span class="op" id="4955547">(</span><span class="ident" id="4955548">mux</span>&nbsp;<span class="op" id="4955552">*</span><span class="ident" id="4955553">ServeMux</span><span class="op" id="4955561">)</span>&nbsp;<span class="ident" id="4955563">match</span><span class="op" id="4955568">(</span><span class="ident" id="4955569">path</span>&nbsp;<span class="builtintype" id="4955574">string</span><span class="op" id="4955580">)</span>&nbsp;<span class="op" id="4955582">(</span><span class="ident" id="4955583">h</span>&nbsp;<span class="ident" id="4955585">Handler</span><span class="op" id="4955592">,</span>&nbsp;<span class="ident" id="4955594">pattern</span>&nbsp;<span class="builtintype" id="4955602">string</span><span class="op" id="4955608">)</span>&nbsp;<span class="op" id="4955610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955613">var</span>&nbsp;<span class="ident" id="4955617">n</span>&nbsp;<span class="op" id="4955619">=</span>&nbsp;<span class="num" id="4955621">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955624">for</span>&nbsp;<span class="ident" id="4955628">k</span><span class="op" id="4955629">,</span>&nbsp;<span class="ident" id="4955631">v</span>&nbsp;<span class="op" id="4955633">:=</span>&nbsp;<span class="keyword" id="4955636">range</span>&nbsp;<span class="ident" id="4955642">mux</span><span class="op" id="4955645">.</span><span class="ident" id="4955646">m</span>&nbsp;<span class="op" id="4955648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955652">if</span>&nbsp;<span class="op" id="4955655">!</span><span class="ident" id="4955656">pathMatch</span><span class="op" id="4955665">(</span><span class="ident" id="4955666">k</span><span class="op" id="4955667">,</span>&nbsp;<span class="ident" id="4955669">path</span><span class="op" id="4955673">)</span>&nbsp;<span class="op" id="4955675">{</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955680">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4955691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955695">if</span>&nbsp;<span class="ident" id="4955698">h</span>&nbsp;<span class="op" id="4955700">==</span>&nbsp;<span class="ident" id="4955703">nil</span>&nbsp;<span class="op" id="4955707">||</span>&nbsp;<span class="builtinfunc" id="4955710">len</span><span class="op" id="4955713">(</span><span class="ident" id="4955714">k</span><span class="op" id="4955715">)</span>&nbsp;<span class="op" id="4955717">&gt;</span>&nbsp;<span class="ident" id="4955719">n</span>&nbsp;<span class="op" id="4955721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4955726">n</span>&nbsp;<span class="op" id="4955728">=</span>&nbsp;<span class="builtinfunc" id="4955730">len</span><span class="op" id="4955733">(</span><span class="ident" id="4955734">k</span><span class="op" id="4955735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4955740">h</span>&nbsp;<span class="op" id="4955742">=</span>&nbsp;<span class="ident" id="4955744">v</span><span class="op" id="4955745">.</span><span class="ident" id="4955746">h</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4955751">pattern</span>&nbsp;<span class="op" id="4955759">=</span>&nbsp;<span class="ident" id="4955761">v</span><span class="op" id="4955762">.</span><span class="ident" id="4955763">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4955773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4955776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955779">return</span><br>
<span class="lineno"></span><span class="op" id="4955786">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment" id="4955789">//&nbsp;Handler&nbsp;returns&nbsp;the&nbsp;handler&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="4955850">//&nbsp;consulting&nbsp;r.Method,&nbsp;r.Host,&nbsp;and&nbsp;r.URL.Path.&nbsp;It&nbsp;always&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="4955916">//&nbsp;a&nbsp;non-nil&nbsp;handler.&nbsp;If&nbsp;the&nbsp;path&nbsp;is&nbsp;not&nbsp;in&nbsp;its&nbsp;canonical&nbsp;form,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4955984">//&nbsp;handler&nbsp;will&nbsp;be&nbsp;an&nbsp;internally-generated&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno">1490</span><span class="comment" id="4956050">//&nbsp;to&nbsp;the&nbsp;canonical&nbsp;path.</span><br>
<span class="lineno"></span><span class="comment" id="4956076">//</span><br>
<span class="lineno"></span><span class="comment" id="4956079">//&nbsp;Handler&nbsp;also&nbsp;returns&nbsp;the&nbsp;registered&nbsp;pattern&nbsp;that&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4956143">//&nbsp;request&nbsp;or,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;internally-generated&nbsp;redirects,</span><br>
<span class="lineno"></span><span class="comment" id="4956205">//&nbsp;the&nbsp;pattern&nbsp;that&nbsp;will&nbsp;match&nbsp;after&nbsp;following&nbsp;the&nbsp;redirect.</span><br>
<span class="lineno">1495</span><span class="comment" id="4956266">//</span><br>
<span class="lineno"></span><span class="comment" id="4956269">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;registered&nbsp;handler&nbsp;that&nbsp;applies&nbsp;to&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="4956335">//&nbsp;Handler&nbsp;returns&nbsp;a&nbsp;``page&nbsp;not&nbsp;found&#39;&#39;&nbsp;handler&nbsp;and&nbsp;an&nbsp;empty&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="4956405">func</span>&nbsp;<span class="op" id="4956410">(</span><span class="ident" id="4956411">mux</span>&nbsp;<span class="op" id="4956415">*</span><span class="ident" id="4956416">ServeMux</span><span class="op" id="4956424">)</span>&nbsp;<span class="ident" id="4956426">Handler</span><span class="op" id="4956433">(</span><span class="ident" id="4956434">r</span>&nbsp;<span class="op" id="4956436">*</span><span class="ident" id="4956437">Request</span><span class="op" id="4956444">)</span>&nbsp;<span class="op" id="4956446">(</span><span class="ident" id="4956447">h</span>&nbsp;<span class="ident" id="4956449">Handler</span><span class="op" id="4956456">,</span>&nbsp;<span class="ident" id="4956458">pattern</span>&nbsp;<span class="builtintype" id="4956466">string</span><span class="op" id="4956472">)</span>&nbsp;<span class="op" id="4956474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4956477">if</span>&nbsp;<span class="ident" id="4956480">r</span><span class="op" id="4956481">.</span><span class="ident" id="4956482">Method</span>&nbsp;<span class="op" id="4956489">!=</span>&nbsp;<span class="string" id="4956492">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="4956502">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4956506">if</span>&nbsp;<span class="ident" id="4956509">p</span>&nbsp;<span class="op" id="4956511">:=</span>&nbsp;<span class="ident" id="4956514">cleanPath</span><span class="op" id="4956523">(</span><span class="ident" id="4956524">r</span><span class="op" id="4956525">.</span><span class="ident" id="4956526">URL</span><span class="op" id="4956529">.</span><span class="ident" id="4956530">Path</span><span class="op" id="4956534">)</span><span class="op" id="4956535">;</span>&nbsp;<span class="ident" id="4956537">p</span>&nbsp;<span class="op" id="4956539">!=</span>&nbsp;<span class="ident" id="4956542">r</span><span class="op" id="4956543">.</span><span class="ident" id="4956544">URL</span><span class="op" id="4956547">.</span><span class="ident" id="4956548">Path</span>&nbsp;<span class="op" id="4956553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4956558">_</span><span class="op" id="4956559">,</span>&nbsp;<span class="ident" id="4956561">pattern</span>&nbsp;<span class="op" id="4956569">=</span>&nbsp;<span class="ident" id="4956571">mux</span><span class="op" id="4956574">.</span><span class="ident" id="4956575">handler</span><span class="op" id="4956582">(</span><span class="ident" id="4956583">r</span><span class="op" id="4956584">.</span><span class="ident" id="4956585">Host</span><span class="op" id="4956589">,</span>&nbsp;<span class="ident" id="4956591">p</span><span class="op" id="4956592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4956597">url</span>&nbsp;<span class="op" id="4956601">:=</span>&nbsp;<span class="op" id="4956604">*</span><span class="ident" id="4956605">r</span><span class="op" id="4956606">.</span><span class="ident" id="4956607">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4956614">url</span><span class="op" id="4956617">.</span><span class="ident" id="4956618">Path</span>&nbsp;<span class="op" id="4956623">=</span>&nbsp;<span class="ident" id="4956625">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4956630">return</span>&nbsp;<span class="ident" id="4956637">RedirectHandler</span><span class="op" id="4956652">(</span><span class="ident" id="4956653">url</span><span class="op" id="4956656">.</span><span class="ident" id="4956657">String</span><span class="op" id="4956663">(</span><span class="op" id="4956664">)</span><span class="op" id="4956665">,</span>&nbsp;<span class="ident" id="4956667">StatusMovedPermanently</span><span class="op" id="4956689">)</span><span class="op" id="4956690">,</span>&nbsp;<span class="ident" id="4956692">pattern</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4956702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4956705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4956709">return</span>&nbsp;<span class="ident" id="4956716">mux</span><span class="op" id="4956719">.</span><span class="ident" id="4956720">handler</span><span class="op" id="4956727">(</span><span class="ident" id="4956728">r</span><span class="op" id="4956729">.</span><span class="ident" id="4956730">Host</span><span class="op" id="4956734">,</span>&nbsp;<span class="ident" id="4956736">r</span><span class="op" id="4956737">.</span><span class="ident" id="4956738">URL</span><span class="op" id="4956741">.</span><span class="ident" id="4956742">Path</span><span class="op" id="4956746">)</span><br>
<span class="lineno"></span><span class="op" id="4956748">}</span><br>
<span class="lineno">1510</span><br>
<span class="lineno"></span><span class="comment" id="4956751">//&nbsp;handler&nbsp;is&nbsp;the&nbsp;main&nbsp;implementation&nbsp;of&nbsp;Handler.</span><br>
<span class="lineno"></span><span class="comment" id="4956801">//&nbsp;The&nbsp;path&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;in&nbsp;canonical&nbsp;form,&nbsp;except&nbsp;for&nbsp;CONNECT&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="4956875">func</span>&nbsp;<span class="op" id="4956880">(</span><span class="ident" id="4956881">mux</span>&nbsp;<span class="op" id="4956885">*</span><span class="ident" id="4956886">ServeMux</span><span class="op" id="4956894">)</span>&nbsp;<span class="ident" id="4956896">handler</span><span class="op" id="4956903">(</span><span class="ident" id="4956904">host</span><span class="op" id="4956908">,</span>&nbsp;<span class="ident" id="4956910">path</span>&nbsp;<span class="builtintype" id="4956915">string</span><span class="op" id="4956921">)</span>&nbsp;<span class="op" id="4956923">(</span><span class="ident" id="4956924">h</span>&nbsp;<span class="ident" id="4956926">Handler</span><span class="op" id="4956933">,</span>&nbsp;<span class="ident" id="4956935">pattern</span>&nbsp;<span class="builtintype" id="4956943">string</span><span class="op" id="4956949">)</span>&nbsp;<span class="op" id="4956951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4956954">mux</span><span class="op" id="4956957">.</span><span class="ident" id="4956958">mu</span><span class="op" id="4956960">.</span><span class="ident" id="4956961">RLock</span><span class="op" id="4956966">(</span><span class="op" id="4956967">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4956970">defer</span>&nbsp;<span class="ident" id="4956976">mux</span><span class="op" id="4956979">.</span><span class="ident" id="4956980">mu</span><span class="op" id="4956982">.</span><span class="ident" id="4956983">RUnlock</span><span class="op" id="4956990">(</span><span class="op" id="4956991">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4956995">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957056">if</span>&nbsp;<span class="ident" id="4957059">mux</span><span class="op" id="4957062">.</span><span class="ident" id="4957063">hosts</span>&nbsp;<span class="op" id="4957069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4957073">h</span><span class="op" id="4957074">,</span>&nbsp;<span class="ident" id="4957076">pattern</span>&nbsp;<span class="op" id="4957084">=</span>&nbsp;<span class="ident" id="4957086">mux</span><span class="op" id="4957089">.</span><span class="ident" id="4957090">match</span><span class="op" id="4957095">(</span><span class="ident" id="4957096">host</span>&nbsp;<span class="op" id="4957101">+</span>&nbsp;<span class="ident" id="4957103">path</span><span class="op" id="4957107">)</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4957110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957113">if</span>&nbsp;<span class="ident" id="4957116">h</span>&nbsp;<span class="op" id="4957118">==</span>&nbsp;<span class="ident" id="4957121">nil</span>&nbsp;<span class="op" id="4957125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4957129">h</span><span class="op" id="4957130">,</span>&nbsp;<span class="ident" id="4957132">pattern</span>&nbsp;<span class="op" id="4957140">=</span>&nbsp;<span class="ident" id="4957142">mux</span><span class="op" id="4957145">.</span><span class="ident" id="4957146">match</span><span class="op" id="4957151">(</span><span class="ident" id="4957152">path</span><span class="op" id="4957156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4957159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957162">if</span>&nbsp;<span class="ident" id="4957165">h</span>&nbsp;<span class="op" id="4957167">==</span>&nbsp;<span class="ident" id="4957170">nil</span>&nbsp;<span class="op" id="4957174">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4957178">h</span><span class="op" id="4957179">,</span>&nbsp;<span class="ident" id="4957181">pattern</span>&nbsp;<span class="op" id="4957189">=</span>&nbsp;<span class="ident" id="4957191">NotFoundHandler</span><span class="op" id="4957206">(</span><span class="op" id="4957207">)</span><span class="op" id="4957208">,</span>&nbsp;<span class="string" id="4957210">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4957214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957217">return</span><br>
<span class="lineno"></span><span class="op" id="4957224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="comment" id="4957227">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><br>
<span class="lineno"></span><span class="comment" id="4957284">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="4957333">func</span>&nbsp;<span class="op" id="4957338">(</span><span class="ident" id="4957339">mux</span>&nbsp;<span class="op" id="4957343">*</span><span class="ident" id="4957344">ServeMux</span><span class="op" id="4957352">)</span>&nbsp;<span class="ident" id="4957354">ServeHTTP</span><span class="op" id="4957363">(</span><span class="ident" id="4957364">w</span>&nbsp;<span class="ident" id="4957366">ResponseWriter</span><span class="op" id="4957380">,</span>&nbsp;<span class="ident" id="4957382">r</span>&nbsp;<span class="op" id="4957384">*</span><span class="ident" id="4957385">Request</span><span class="op" id="4957392">)</span>&nbsp;<span class="op" id="4957394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957397">if</span>&nbsp;<span class="ident" id="4957400">r</span><span class="op" id="4957401">.</span><span class="ident" id="4957402">RequestURI</span>&nbsp;<span class="op" id="4957413">==</span>&nbsp;<span class="string" id="4957416">&#34;*&#34;</span>&nbsp;<span class="op" id="4957420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957424">if</span>&nbsp;<span class="ident" id="4957427">r</span><span class="op" id="4957428">.</span><span class="ident" id="4957429">ProtoAtLeast</span><span class="op" id="4957441">(</span><span class="num" id="4957442">1</span><span class="op" id="4957443">,</span>&nbsp;<span class="num" id="4957445">1</span><span class="op" id="4957446">)</span>&nbsp;<span class="op" id="4957448">{</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4957453">w</span><span class="op" id="4957454">.</span><span class="ident" id="4957455">Header</span><span class="op" id="4957461">(</span><span class="op" id="4957462">)</span><span class="op" id="4957463">.</span><span class="ident" id="4957464">Set</span><span class="op" id="4957467">(</span><span class="string" id="4957468">&#34;Connection&#34;</span><span class="op" id="4957480">,</span>&nbsp;<span class="string" id="4957482">&#34;close&#34;</span><span class="op" id="4957489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4957493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4957497">w</span><span class="op" id="4957498">.</span><span class="ident" id="4957499">WriteHeader</span><span class="op" id="4957510">(</span><span class="ident" id="4957511">StatusBadRequest</span><span class="op" id="4957527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957531">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4957539">}</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4957542">h</span><span class="op" id="4957543">,</span>&nbsp;<span class="ident" id="4957545">_</span>&nbsp;<span class="op" id="4957547">:=</span>&nbsp;<span class="ident" id="4957550">mux</span><span class="op" id="4957553">.</span><span class="ident" id="4957554">Handler</span><span class="op" id="4957561">(</span><span class="ident" id="4957562">r</span><span class="op" id="4957563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4957566">h</span><span class="op" id="4957567">.</span><span class="ident" id="4957568">ServeHTTP</span><span class="op" id="4957577">(</span><span class="ident" id="4957578">w</span><span class="op" id="4957579">,</span>&nbsp;<span class="ident" id="4957581">r</span><span class="op" id="4957582">)</span><br>
<span class="lineno"></span><span class="op" id="4957584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4957587">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno">1545</span><span class="comment" id="4957642">//&nbsp;If&nbsp;a&nbsp;handler&nbsp;already&nbsp;exists&nbsp;for&nbsp;pattern,&nbsp;Handle&nbsp;panics.</span><br>
<span class="lineno"></span><span class="keyword" id="4957701">func</span>&nbsp;<span class="op" id="4957706">(</span><span class="ident" id="4957707">mux</span>&nbsp;<span class="op" id="4957711">*</span><span class="ident" id="4957712">ServeMux</span><span class="op" id="4957720">)</span>&nbsp;<span class="ident" id="4957722">Handle</span><span class="op" id="4957728">(</span><span class="ident" id="4957729">pattern</span>&nbsp;<span class="builtintype" id="4957737">string</span><span class="op" id="4957743">,</span>&nbsp;<span class="ident" id="4957745">handler</span>&nbsp;<span class="ident" id="4957753">Handler</span><span class="op" id="4957760">)</span>&nbsp;<span class="op" id="4957762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4957765">mux</span><span class="op" id="4957768">.</span><span class="ident" id="4957769">mu</span><span class="op" id="4957771">.</span><span class="ident" id="4957772">Lock</span><span class="op" id="4957776">(</span><span class="op" id="4957777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957780">defer</span>&nbsp;<span class="ident" id="4957786">mux</span><span class="op" id="4957789">.</span><span class="ident" id="4957790">mu</span><span class="op" id="4957792">.</span><span class="ident" id="4957793">Unlock</span><span class="op" id="4957799">(</span><span class="op" id="4957800">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957804">if</span>&nbsp;<span class="ident" id="4957807">pattern</span>&nbsp;<span class="op" id="4957815">==</span>&nbsp;<span class="string" id="4957818">&#34;&#34;</span>&nbsp;<span class="op" id="4957821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4957825">panic</span><span class="op" id="4957830">(</span><span class="string" id="4957831">&#34;http:&nbsp;invalid&nbsp;pattern&nbsp;&#34;</span>&nbsp;<span class="op" id="4957856">+</span>&nbsp;<span class="ident" id="4957858">pattern</span><span class="op" id="4957865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4957868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957871">if</span>&nbsp;<span class="ident" id="4957874">handler</span>&nbsp;<span class="op" id="4957882">==</span>&nbsp;<span class="ident" id="4957885">nil</span>&nbsp;<span class="op" id="4957889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4957893">panic</span><span class="op" id="4957898">(</span><span class="string" id="4957899">&#34;http:&nbsp;nil&nbsp;handler&#34;</span><span class="op" id="4957918">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4957921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957924">if</span>&nbsp;<span class="ident" id="4957927">mux</span><span class="op" id="4957930">.</span><span class="ident" id="4957931">m</span><span class="op" id="4957932">[</span><span class="ident" id="4957933">pattern</span><span class="op" id="4957940">]</span><span class="op" id="4957941">.</span><span class="ident" id="4957942">explicit</span>&nbsp;<span class="op" id="4957951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4957955">panic</span><span class="op" id="4957960">(</span><span class="string" id="4957961">&#34;http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="4957997">+</span>&nbsp;<span class="ident" id="4957999">pattern</span><span class="op" id="4958006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4958009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4958013">mux</span><span class="op" id="4958016">.</span><span class="ident" id="4958017">m</span><span class="op" id="4958018">[</span><span class="ident" id="4958019">pattern</span><span class="op" id="4958026">]</span>&nbsp;<span class="op" id="4958028">=</span>&nbsp;<span class="ident" id="4958030">muxEntry</span><span class="op" id="4958038">{</span><span class="ident" id="4958039">explicit</span><span class="op" id="4958047">:</span>&nbsp;<span class="builtintype" id="4958049">true</span><span class="op" id="4958053">,</span>&nbsp;<span class="ident" id="4958055">h</span><span class="op" id="4958056">:</span>&nbsp;<span class="ident" id="4958058">handler</span><span class="op" id="4958065">,</span>&nbsp;<span class="ident" id="4958067">pattern</span><span class="op" id="4958074">:</span>&nbsp;<span class="ident" id="4958076">pattern</span><span class="op" id="4958083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4958087">if</span>&nbsp;<span class="ident" id="4958090">pattern</span><span class="op" id="4958097">[</span><span class="num" id="4958098">0</span><span class="op" id="4958099">]</span>&nbsp;<span class="op" id="4958101">!=</span>&nbsp;<span class="string" id="4958104">&#39;/&#39;</span>&nbsp;<span class="op" id="4958108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4958112">mux</span><span class="op" id="4958115">.</span><span class="ident" id="4958116">hosts</span>&nbsp;<span class="op" id="4958122">=</span>&nbsp;<span class="builtintype" id="4958124">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4958130">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4958134">//&nbsp;Helpful&nbsp;behavior:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4958156">//&nbsp;If&nbsp;pattern&nbsp;is&nbsp;/tree/,&nbsp;insert&nbsp;an&nbsp;implicit&nbsp;permanent&nbsp;redirect&nbsp;for&nbsp;/tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4958231">//&nbsp;It&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;an&nbsp;explicit&nbsp;registration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4958285">n</span>&nbsp;<span class="op" id="4958287">:=</span>&nbsp;<span class="builtinfunc" id="4958290">len</span><span class="op" id="4958293">(</span><span class="ident" id="4958294">pattern</span><span class="op" id="4958301">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4958304">if</span>&nbsp;<span class="ident" id="4958307">n</span>&nbsp;<span class="op" id="4958309">&gt;</span>&nbsp;<span class="num" id="4958311">0</span>&nbsp;<span class="op" id="4958313">&amp;&amp;</span>&nbsp;<span class="ident" id="4958316">pattern</span><span class="op" id="4958323">[</span><span class="ident" id="4958324">n</span><span class="op" id="4958325">-</span><span class="num" id="4958326">1</span><span class="op" id="4958327">]</span>&nbsp;<span class="op" id="4958329">==</span>&nbsp;<span class="string" id="4958332">&#39;/&#39;</span>&nbsp;<span class="op" id="4958336">&amp;&amp;</span>&nbsp;<span class="op" id="4958339">!</span><span class="ident" id="4958340">mux</span><span class="op" id="4958343">.</span><span class="ident" id="4958344">m</span><span class="op" id="4958345">[</span><span class="ident" id="4958346">pattern</span><span class="op" id="4958353">[</span><span class="num" id="4958354">0</span><span class="op" id="4958355">:</span><span class="ident" id="4958356">n</span><span class="op" id="4958357">-</span><span class="num" id="4958358">1</span><span class="op" id="4958359">]</span><span class="op" id="4958360">]</span><span class="op" id="4958361">.</span><span class="ident" id="4958362">explicit</span>&nbsp;<span class="op" id="4958371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4958375">//&nbsp;If&nbsp;pattern&nbsp;contains&nbsp;a&nbsp;host&nbsp;name,&nbsp;strip&nbsp;it&nbsp;and&nbsp;use&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4958440">//&nbsp;path&nbsp;for&nbsp;redirect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4958464">path</span>&nbsp;<span class="op" id="4958469">:=</span>&nbsp;<span class="ident" id="4958472">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4958482">if</span>&nbsp;<span class="ident" id="4958485">pattern</span><span class="op" id="4958492">[</span><span class="num" id="4958493">0</span><span class="op" id="4958494">]</span>&nbsp;<span class="op" id="4958496">!=</span>&nbsp;<span class="string" id="4958499">&#39;/&#39;</span>&nbsp;<span class="op" id="4958503">{</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4958508">//&nbsp;In&nbsp;pattern,&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;character&nbsp;is&nbsp;a&nbsp;&#39;/&#39;,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4958567">//&nbsp;strings.Index&nbsp;can&#39;t&nbsp;be&nbsp;-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4958600">path</span>&nbsp;<span class="op" id="4958605">=</span>&nbsp;<span class="ident" id="4958607">pattern</span><span class="op" id="4958614">[</span><span class="ident" id="4958615">strings</span><span class="op" id="4958622">.</span><span class="ident" id="4958623">Index</span><span class="op" id="4958628">(</span><span class="ident" id="4958629">pattern</span><span class="op" id="4958636">,</span>&nbsp;<span class="string" id="4958638">&#34;/&#34;</span><span class="op" id="4958641">)</span><span class="op" id="4958642">:</span><span class="op" id="4958643">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4958647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4958651">mux</span><span class="op" id="4958654">.</span><span class="ident" id="4958655">m</span><span class="op" id="4958656">[</span><span class="ident" id="4958657">pattern</span><span class="op" id="4958664">[</span><span class="num" id="4958665">0</span><span class="op" id="4958666">:</span><span class="ident" id="4958667">n</span><span class="op" id="4958668">-</span><span class="num" id="4958669">1</span><span class="op" id="4958670">]</span><span class="op" id="4958671">]</span>&nbsp;<span class="op" id="4958673">=</span>&nbsp;<span class="ident" id="4958675">muxEntry</span><span class="op" id="4958683">{</span><span class="ident" id="4958684">h</span><span class="op" id="4958685">:</span>&nbsp;<span class="ident" id="4958687">RedirectHandler</span><span class="op" id="4958702">(</span><span class="ident" id="4958703">path</span><span class="op" id="4958707">,</span>&nbsp;<span class="ident" id="4958709">StatusMovedPermanently</span><span class="op" id="4958731">)</span><span class="op" id="4958732">,</span>&nbsp;<span class="ident" id="4958734">pattern</span><span class="op" id="4958741">:</span>&nbsp;<span class="ident" id="4958743">pattern</span><span class="op" id="4958750">}</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4958753">}</span><br>
<span class="lineno"></span><span class="op" id="4958755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4958758">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="4958826">func</span>&nbsp;<span class="op" id="4958831">(</span><span class="ident" id="4958832">mux</span>&nbsp;<span class="op" id="4958836">*</span><span class="ident" id="4958837">ServeMux</span><span class="op" id="4958845">)</span>&nbsp;<span class="ident" id="4958847">HandleFunc</span><span class="op" id="4958857">(</span><span class="ident" id="4958858">pattern</span>&nbsp;<span class="builtintype" id="4958866">string</span><span class="op" id="4958872">,</span>&nbsp;<span class="ident" id="4958874">handler</span>&nbsp;<span class="keyword" id="4958882">func</span><span class="op" id="4958886">(</span><span class="ident" id="4958887">ResponseWriter</span><span class="op" id="4958901">,</span>&nbsp;<span class="op" id="4958903">*</span><span class="ident" id="4958904">Request</span><span class="op" id="4958911">)</span><span class="op" id="4958912">)</span>&nbsp;<span class="op" id="4958914">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4958917">mux</span><span class="op" id="4958920">.</span><span class="ident" id="4958921">Handle</span><span class="op" id="4958927">(</span><span class="ident" id="4958928">pattern</span><span class="op" id="4958935">,</span>&nbsp;<span class="ident" id="4958937">HandlerFunc</span><span class="op" id="4958948">(</span><span class="ident" id="4958949">handler</span><span class="op" id="4958956">)</span><span class="op" id="4958957">)</span><br>
<span class="lineno"></span><span class="op" id="4958959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4958962">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="4959016">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1590</span><span class="comment" id="4959043">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="4959112">func</span>&nbsp;<span class="ident" id="4959117">Handle</span><span class="op" id="4959123">(</span><span class="ident" id="4959124">pattern</span>&nbsp;<span class="builtintype" id="4959132">string</span><span class="op" id="4959138">,</span>&nbsp;<span class="ident" id="4959140">handler</span>&nbsp;<span class="ident" id="4959148">Handler</span><span class="op" id="4959155">)</span>&nbsp;<span class="op" id="4959157">{</span>&nbsp;<span class="ident" id="4959159">DefaultServeMux</span><span class="op" id="4959174">.</span><span class="ident" id="4959175">Handle</span><span class="op" id="4959181">(</span><span class="ident" id="4959182">pattern</span><span class="op" id="4959189">,</span>&nbsp;<span class="ident" id="4959191">handler</span><span class="op" id="4959198">)</span>&nbsp;<span class="op" id="4959200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4959203">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="4959270">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1595</span><span class="comment" id="4959297">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="4959366">func</span>&nbsp;<span class="ident" id="4959371">HandleFunc</span><span class="op" id="4959381">(</span><span class="ident" id="4959382">pattern</span>&nbsp;<span class="builtintype" id="4959390">string</span><span class="op" id="4959396">,</span>&nbsp;<span class="ident" id="4959398">handler</span>&nbsp;<span class="keyword" id="4959406">func</span><span class="op" id="4959410">(</span><span class="ident" id="4959411">ResponseWriter</span><span class="op" id="4959425">,</span>&nbsp;<span class="op" id="4959427">*</span><span class="ident" id="4959428">Request</span><span class="op" id="4959435">)</span><span class="op" id="4959436">)</span>&nbsp;<span class="op" id="4959438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4959441">DefaultServeMux</span><span class="op" id="4959456">.</span><span class="ident" id="4959457">HandleFunc</span><span class="op" id="4959467">(</span><span class="ident" id="4959468">pattern</span><span class="op" id="4959475">,</span>&nbsp;<span class="ident" id="4959477">handler</span><span class="op" id="4959484">)</span><br>
<span class="lineno"></span><span class="op" id="4959486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="4959489">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;HTTP&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,</span><br>
<span class="lineno"></span><span class="comment" id="4959551">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="4959621">//&nbsp;read&nbsp;requests&nbsp;and&nbsp;then&nbsp;call&nbsp;handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="4959678">//&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4959750">func</span>&nbsp;<span class="ident" id="4959755">Serve</span><span class="op" id="4959760">(</span><span class="ident" id="4959761">l</span>&nbsp;<span class="ident" id="4959763">net</span><span class="op" id="4959766">.</span><span class="ident" id="4959767">Listener</span><span class="op" id="4959775">,</span>&nbsp;<span class="ident" id="4959777">handler</span>&nbsp;<span class="ident" id="4959785">Handler</span><span class="op" id="4959792">)</span>&nbsp;<span class="builtintype" id="4959794">error</span>&nbsp;<span class="op" id="4959800">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4959803">srv</span>&nbsp;<span class="op" id="4959807">:=</span>&nbsp;<span class="op" id="4959810">&amp;</span><span class="ident" id="4959811">Server</span><span class="op" id="4959817">{</span><span class="ident" id="4959818">Handler</span><span class="op" id="4959825">:</span>&nbsp;<span class="ident" id="4959827">handler</span><span class="op" id="4959834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4959837">return</span>&nbsp;<span class="ident" id="4959844">srv</span><span class="op" id="4959847">.</span><span class="ident" id="4959848">Serve</span><span class="op" id="4959853">(</span><span class="ident" id="4959854">l</span><span class="op" id="4959855">)</span><br>
<span class="lineno"></span><span class="op" id="4959857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4959860">//&nbsp;A&nbsp;Server&nbsp;defines&nbsp;parameters&nbsp;for&nbsp;running&nbsp;an&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">1610</span><span class="comment" id="4959919">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;Server&nbsp;is&nbsp;a&nbsp;valid&nbsp;configuration.</span><br>
<span class="lineno"></span><span class="keyword" id="4959974">type</span>&nbsp;<span class="ident" id="4959979">Server</span>&nbsp;<span class="keyword" id="4959986">struct</span>&nbsp;<span class="op" id="4959993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4959996">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4960011">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4960025">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;&#34;:http&#34;&nbsp;if&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4960072">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4960087">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4960101">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4960152">ReadTimeout</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4960167">time</span><span class="op" id="4960171">.</span><span class="ident" id="4960172">Duration</span>&nbsp;<span class="comment" id="4960181">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;read&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4960240">WriteTimeout</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4960255">time</span><span class="op" id="4960259">.</span><span class="ident" id="4960260">Duration</span>&nbsp;<span class="comment" id="4960269">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;write&nbsp;of&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4960330">MaxHeaderBytes</span>&nbsp;<span class="builtintype" id="4960345">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4960359">//&nbsp;maximum&nbsp;size&nbsp;of&nbsp;request&nbsp;headers,&nbsp;DefaultMaxHeaderBytes&nbsp;if&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4960423">TLSConfig</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4960438">*</span><span class="ident" id="4960439">tls</span><span class="op" id="4960442">.</span><span class="ident" id="4960443">Config</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4960452">//&nbsp;optional&nbsp;TLS&nbsp;config,&nbsp;used&nbsp;by&nbsp;ListenAndServeTLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4960504">//&nbsp;TLSNextProto&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;take&nbsp;over</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4960566">//&nbsp;ownership&nbsp;of&nbsp;the&nbsp;provided&nbsp;TLS&nbsp;connection&nbsp;when&nbsp;an&nbsp;NPN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4960623">//&nbsp;protocol&nbsp;upgrade&nbsp;has&nbsp;occurred.&nbsp;&nbsp;The&nbsp;map&nbsp;key&nbsp;is&nbsp;the&nbsp;protocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4960687">//&nbsp;name&nbsp;negotiated.&nbsp;The&nbsp;Handler&nbsp;argument&nbsp;should&nbsp;be&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4960747">//&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;and&nbsp;will&nbsp;initialize&nbsp;the&nbsp;Request&#39;s&nbsp;TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4960810">//&nbsp;and&nbsp;RemoteAddr&nbsp;if&nbsp;not&nbsp;already&nbsp;set.&nbsp;&nbsp;The&nbsp;connection&nbsp;is</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4960868">//&nbsp;automatically&nbsp;closed&nbsp;when&nbsp;the&nbsp;function&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4960920">TLSNextProto</span>&nbsp;<span class="keyword" id="4960933">map</span><span class="op" id="4960936">[</span><span class="builtintype" id="4960937">string</span><span class="op" id="4960943">]</span><span class="keyword" id="4960944">func</span><span class="op" id="4960948">(</span><span class="op" id="4960949">*</span><span class="ident" id="4960950">Server</span><span class="op" id="4960956">,</span>&nbsp;<span class="op" id="4960958">*</span><span class="ident" id="4960959">tls</span><span class="op" id="4960962">.</span><span class="ident" id="4960963">Conn</span><span class="op" id="4960967">,</span>&nbsp;<span class="ident" id="4960969">Handler</span><span class="op" id="4960976">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4960980">//&nbsp;ConnState&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;callback&nbsp;function&nbsp;that&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4961042">//&nbsp;called&nbsp;when&nbsp;a&nbsp;client&nbsp;connection&nbsp;changes&nbsp;state.&nbsp;See&nbsp;the</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4961101">//&nbsp;ConnState&nbsp;type&nbsp;and&nbsp;associated&nbsp;constants&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4961158">ConnState</span>&nbsp;<span class="keyword" id="4961168">func</span><span class="op" id="4961172">(</span><span class="ident" id="4961173">net</span><span class="op" id="4961176">.</span><span class="ident" id="4961177">Conn</span><span class="op" id="4961181">,</span>&nbsp;<span class="ident" id="4961183">ConnState</span><span class="op" id="4961192">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4961196">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors&nbsp;accepting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4961259">//&nbsp;connections&nbsp;and&nbsp;unexpected&nbsp;behavior&nbsp;from&nbsp;handlers.</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4961314">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4961374">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4961395">ErrorLog</span>&nbsp;<span class="op" id="4961404">*</span><span class="ident" id="4961405">log</span><span class="op" id="4961408">.</span><span class="ident" id="4961409">Logger</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4961418">disableKeepAlives</span>&nbsp;<span class="builtintype" id="4961436">int32</span>&nbsp;<span class="comment" id="4961442">//&nbsp;accessed&nbsp;atomically.</span><br>
<span class="lineno">1640</span><span class="op" id="4961466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4961469">//&nbsp;A&nbsp;ConnState&nbsp;represents&nbsp;the&nbsp;state&nbsp;of&nbsp;a&nbsp;client&nbsp;connection&nbsp;to&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="comment" id="4961541">//&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;the&nbsp;optional&nbsp;Server.ConnState&nbsp;hook.</span><br>
<span class="lineno"></span><span class="keyword" id="4961593">type</span>&nbsp;<span class="ident" id="4961598">ConnState</span>&nbsp;<span class="builtintype" id="4961608">int</span><br>
<span class="lineno">1645</span><br>
<span class="lineno"></span><span class="keyword" id="4961613">const</span>&nbsp;<span class="op" id="4961619">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4961622">//&nbsp;StateNew&nbsp;represents&nbsp;a&nbsp;new&nbsp;connection&nbsp;that&nbsp;is&nbsp;expected&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4961683">//&nbsp;send&nbsp;a&nbsp;request&nbsp;immediately.&nbsp;Connections&nbsp;begin&nbsp;at&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4961741">//&nbsp;state&nbsp;and&nbsp;then&nbsp;transition&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4961796">//&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4961813">StateNew</span>&nbsp;<span class="ident" id="4961822">ConnState</span>&nbsp;<span class="op" id="4961832">=</span>&nbsp;<span class="ident" id="4961834">iota</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4961841">//&nbsp;StateActive&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;read&nbsp;1&nbsp;or&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4961905">//&nbsp;bytes&nbsp;of&nbsp;a&nbsp;request.&nbsp;The&nbsp;Server.ConnState&nbsp;hook&nbsp;for</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4961959">//&nbsp;StateActive&nbsp;fires&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;entered&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4962022">//&nbsp;and&nbsp;doesn&#39;t&nbsp;fire&nbsp;again&nbsp;until&nbsp;the&nbsp;request&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4962076">//&nbsp;handled.&nbsp;After&nbsp;the&nbsp;request&nbsp;is&nbsp;handled,&nbsp;the&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4962129">//&nbsp;transitions&nbsp;to&nbsp;StateClosed,&nbsp;StateHijacked,&nbsp;or&nbsp;StateIdle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4962190">StateActive</span><br>
<span class="lineno">1660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4962204">//&nbsp;StateIdle&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4962260">//&nbsp;handling&nbsp;a&nbsp;request&nbsp;and&nbsp;is&nbsp;in&nbsp;the&nbsp;keep-alive&nbsp;state,&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4962323">//&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;Connections&nbsp;transition&nbsp;from&nbsp;StateIdle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4962384">//&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or&nbsp;StateClosed.</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4962426">StateIdle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4962438">//&nbsp;StateHijacked&nbsp;represents&nbsp;a&nbsp;hijacked&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4962490">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4962559">StateHijacked</span><br>
<span class="lineno">1670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4962575">//&nbsp;StateClosed&nbsp;represents&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4962623">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;Hijacked&nbsp;connections&nbsp;do&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4962681">//&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4962712">StateClosed</span><br>
<span class="lineno">1675</span><span class="op" id="4962724">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4962727">var</span>&nbsp;<span class="ident" id="4962731">stateName</span>&nbsp;<span class="op" id="4962741">=</span>&nbsp;<span class="keyword" id="4962743">map</span><span class="op" id="4962746">[</span><span class="ident" id="4962747">ConnState</span><span class="op" id="4962756">]</span><span class="builtintype" id="4962757">string</span><span class="op" id="4962763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4962766">StateNew</span><span class="op" id="4962774">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4962781">&#34;new&#34;</span><span class="op" id="4962786">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4962789">StateActive</span><span class="op" id="4962800">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="4962804">&#34;active&#34;</span><span class="op" id="4962812">,</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4962815">StateIdle</span><span class="op" id="4962824">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4962830">&#34;idle&#34;</span><span class="op" id="4962836">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4962839">StateHijacked</span><span class="op" id="4962852">:</span>&nbsp;<span class="string" id="4962854">&#34;hijacked&#34;</span><span class="op" id="4962864">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4962867">StateClosed</span><span class="op" id="4962878">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="4962882">&#34;closed&#34;</span><span class="op" id="4962890">,</span><br>
<span class="lineno"></span><span class="op" id="4962892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1685</span><span class="keyword" id="4962895">func</span>&nbsp;<span class="op" id="4962900">(</span><span class="ident" id="4962901">c</span>&nbsp;<span class="ident" id="4962903">ConnState</span><span class="op" id="4962912">)</span>&nbsp;<span class="ident" id="4962914">String</span><span class="op" id="4962920">(</span><span class="op" id="4962921">)</span>&nbsp;<span class="builtintype" id="4962923">string</span>&nbsp;<span class="op" id="4962930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4962933">return</span>&nbsp;<span class="ident" id="4962940">stateName</span><span class="op" id="4962949">[</span><span class="ident" id="4962950">c</span><span class="op" id="4962951">]</span><br>
<span class="lineno"></span><span class="op" id="4962953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4962956">//&nbsp;serverHandler&nbsp;delegates&nbsp;to&nbsp;either&nbsp;the&nbsp;server&#39;s&nbsp;Handler&nbsp;or</span><br>
<span class="lineno">1690</span><span class="comment" id="4963017">//&nbsp;DefaultServeMux&nbsp;and&nbsp;also&nbsp;handles&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="4963075">type</span>&nbsp;<span class="ident" id="4963080">serverHandler</span>&nbsp;<span class="keyword" id="4963094">struct</span>&nbsp;<span class="op" id="4963101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4963104">srv</span>&nbsp;<span class="op" id="4963108">*</span><span class="ident" id="4963109">Server</span><br>
<span class="lineno"></span><span class="op" id="4963116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1695</span><span class="keyword" id="4963119">func</span>&nbsp;<span class="op" id="4963124">(</span><span class="ident" id="4963125">sh</span>&nbsp;<span class="ident" id="4963128">serverHandler</span><span class="op" id="4963141">)</span>&nbsp;<span class="ident" id="4963143">ServeHTTP</span><span class="op" id="4963152">(</span><span class="ident" id="4963153">rw</span>&nbsp;<span class="ident" id="4963156">ResponseWriter</span><span class="op" id="4963170">,</span>&nbsp;<span class="ident" id="4963172">req</span>&nbsp;<span class="op" id="4963176">*</span><span class="ident" id="4963177">Request</span><span class="op" id="4963184">)</span>&nbsp;<span class="op" id="4963186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4963189">handler</span>&nbsp;<span class="op" id="4963197">:=</span>&nbsp;<span class="ident" id="4963200">sh</span><span class="op" id="4963202">.</span><span class="ident" id="4963203">srv</span><span class="op" id="4963206">.</span><span class="ident" id="4963207">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4963216">if</span>&nbsp;<span class="ident" id="4963219">handler</span>&nbsp;<span class="op" id="4963227">==</span>&nbsp;<span class="ident" id="4963230">nil</span>&nbsp;<span class="op" id="4963234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4963238">handler</span>&nbsp;<span class="op" id="4963246">=</span>&nbsp;<span class="ident" id="4963248">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4963265">}</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4963268">if</span>&nbsp;<span class="ident" id="4963271">req</span><span class="op" id="4963274">.</span><span class="ident" id="4963275">RequestURI</span>&nbsp;<span class="op" id="4963286">==</span>&nbsp;<span class="string" id="4963289">&#34;*&#34;</span>&nbsp;<span class="op" id="4963293">&amp;&amp;</span>&nbsp;<span class="ident" id="4963296">req</span><span class="op" id="4963299">.</span><span class="ident" id="4963300">Method</span>&nbsp;<span class="op" id="4963307">==</span>&nbsp;<span class="string" id="4963310">&#34;OPTIONS&#34;</span>&nbsp;<span class="op" id="4963320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4963324">handler</span>&nbsp;<span class="op" id="4963332">=</span>&nbsp;<span class="ident" id="4963334">globalOptionsHandler</span><span class="op" id="4963354">{</span><span class="op" id="4963355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4963358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4963361">handler</span><span class="op" id="4963368">.</span><span class="ident" id="4963369">ServeHTTP</span><span class="op" id="4963378">(</span><span class="ident" id="4963379">rw</span><span class="op" id="4963381">,</span>&nbsp;<span class="ident" id="4963383">req</span><span class="op" id="4963386">)</span><br>
<span class="lineno"></span><span class="op" id="4963388">}</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span><span class="comment" id="4963391">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="4963462">//&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="4963525">//&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:http&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4963564">func</span>&nbsp;<span class="op" id="4963569">(</span><span class="ident" id="4963570">srv</span>&nbsp;<span class="op" id="4963574">*</span><span class="ident" id="4963575">Server</span><span class="op" id="4963581">)</span>&nbsp;<span class="ident" id="4963583">ListenAndServe</span><span class="op" id="4963597">(</span><span class="op" id="4963598">)</span>&nbsp;<span class="builtintype" id="4963600">error</span>&nbsp;<span class="op" id="4963606">{</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4963609">addr</span>&nbsp;<span class="op" id="4963614">:=</span>&nbsp;<span class="ident" id="4963617">srv</span><span class="op" id="4963620">.</span><span class="ident" id="4963621">Addr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4963627">if</span>&nbsp;<span class="ident" id="4963630">addr</span>&nbsp;<span class="op" id="4963635">==</span>&nbsp;<span class="string" id="4963638">&#34;&#34;</span>&nbsp;<span class="op" id="4963641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4963645">addr</span>&nbsp;<span class="op" id="4963650">=</span>&nbsp;<span class="string" id="4963652">&#34;:http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4963661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4963664">ln</span><span class="op" id="4963666">,</span>&nbsp;<span class="ident" id="4963668">err</span>&nbsp;<span class="op" id="4963672">:=</span>&nbsp;<span class="ident" id="4963675">net</span><span class="op" id="4963678">.</span><span class="ident" id="4963679">Listen</span><span class="op" id="4963685">(</span><span class="string" id="4963686">&#34;tcp&#34;</span><span class="op" id="4963691">,</span>&nbsp;<span class="ident" id="4963693">addr</span><span class="op" id="4963697">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4963700">if</span>&nbsp;<span class="ident" id="4963703">err</span>&nbsp;<span class="op" id="4963707">!=</span>&nbsp;<span class="ident" id="4963710">nil</span>&nbsp;<span class="op" id="4963714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4963718">return</span>&nbsp;<span class="ident" id="4963725">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4963730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4963733">return</span>&nbsp;<span class="ident" id="4963740">srv</span><span class="op" id="4963743">.</span><span class="ident" id="4963744">Serve</span><span class="op" id="4963749">(</span><span class="ident" id="4963750">tcpKeepAliveListener</span><span class="op" id="4963770">{</span><span class="ident" id="4963771">ln</span><span class="op" id="4963773">.</span><span class="op" id="4963774">(</span><span class="op" id="4963775">*</span><span class="ident" id="4963776">net</span><span class="op" id="4963779">.</span><span class="ident" id="4963780">TCPListener</span><span class="op" id="4963791">)</span><span class="op" id="4963792">}</span><span class="op" id="4963793">)</span><br>
<span class="lineno"></span><span class="op" id="4963795">}</span><br>
<span class="lineno">1720</span><br>
<span class="lineno"></span><span class="comment" id="4963798">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;connections&nbsp;on&nbsp;the&nbsp;Listener&nbsp;l,&nbsp;creating&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4963866">//&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines&nbsp;read&nbsp;requests&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4963943">//&nbsp;then&nbsp;call&nbsp;srv.Handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="4963986">func</span>&nbsp;<span class="op" id="4963991">(</span><span class="ident" id="4963992">srv</span>&nbsp;<span class="op" id="4963996">*</span><span class="ident" id="4963997">Server</span><span class="op" id="4964003">)</span>&nbsp;<span class="ident" id="4964005">Serve</span><span class="op" id="4964010">(</span><span class="ident" id="4964011">l</span>&nbsp;<span class="ident" id="4964013">net</span><span class="op" id="4964016">.</span><span class="ident" id="4964017">Listener</span><span class="op" id="4964025">)</span>&nbsp;<span class="builtintype" id="4964027">error</span>&nbsp;<span class="op" id="4964033">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4964036">defer</span>&nbsp;<span class="ident" id="4964042">l</span><span class="op" id="4964043">.</span><span class="ident" id="4964044">Close</span><span class="op" id="4964049">(</span><span class="op" id="4964050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4964053">var</span>&nbsp;<span class="ident" id="4964057">tempDelay</span>&nbsp;<span class="ident" id="4964067">time</span><span class="op" id="4964071">.</span><span class="ident" id="4964072">Duration</span>&nbsp;<span class="comment" id="4964081">//&nbsp;how&nbsp;long&nbsp;to&nbsp;sleep&nbsp;on&nbsp;accept&nbsp;failure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4964121">for</span>&nbsp;<span class="op" id="4964125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4964129">rw</span><span class="op" id="4964131">,</span>&nbsp;<span class="ident" id="4964133">e</span>&nbsp;<span class="op" id="4964135">:=</span>&nbsp;<span class="ident" id="4964138">l</span><span class="op" id="4964139">.</span><span class="ident" id="4964140">Accept</span><span class="op" id="4964146">(</span><span class="op" id="4964147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4964151">if</span>&nbsp;<span class="ident" id="4964154">e</span>&nbsp;<span class="op" id="4964156">!=</span>&nbsp;<span class="ident" id="4964159">nil</span>&nbsp;<span class="op" id="4964163">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4964168">if</span>&nbsp;<span class="ident" id="4964171">ne</span><span class="op" id="4964173">,</span>&nbsp;<span class="ident" id="4964175">ok</span>&nbsp;<span class="op" id="4964178">:=</span>&nbsp;<span class="ident" id="4964181">e</span><span class="op" id="4964182">.</span><span class="op" id="4964183">(</span><span class="ident" id="4964184">net</span><span class="op" id="4964187">.</span><span class="ident" id="4964188">Error</span><span class="op" id="4964193">)</span><span class="op" id="4964194">;</span>&nbsp;<span class="ident" id="4964196">ok</span>&nbsp;<span class="op" id="4964199">&amp;&amp;</span>&nbsp;<span class="ident" id="4964202">ne</span><span class="op" id="4964204">.</span><span class="ident" id="4964205">Temporary</span><span class="op" id="4964214">(</span><span class="op" id="4964215">)</span>&nbsp;<span class="op" id="4964217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4964223">if</span>&nbsp;<span class="ident" id="4964226">tempDelay</span>&nbsp;<span class="op" id="4964236">==</span>&nbsp;<span class="num" id="4964239">0</span>&nbsp;<span class="op" id="4964241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4964248">tempDelay</span>&nbsp;<span class="op" id="4964258">=</span>&nbsp;<span class="num" id="4964260">5</span>&nbsp;<span class="op" id="4964262">*</span>&nbsp;<span class="ident" id="4964264">time</span><span class="op" id="4964268">.</span><span class="ident" id="4964269">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4964285">}</span>&nbsp;<span class="keyword" id="4964287">else</span>&nbsp;<span class="op" id="4964292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4964299">tempDelay</span>&nbsp;<span class="op" id="4964309">*=</span>&nbsp;<span class="num" id="4964312">2</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4964318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4964324">if</span>&nbsp;<span class="ident" id="4964327">max</span>&nbsp;<span class="op" id="4964331">:=</span>&nbsp;<span class="num" id="4964334">1</span>&nbsp;<span class="op" id="4964336">*</span>&nbsp;<span class="ident" id="4964338">time</span><span class="op" id="4964342">.</span><span class="ident" id="4964343">Second</span><span class="op" id="4964349">;</span>&nbsp;<span class="ident" id="4964351">tempDelay</span>&nbsp;<span class="op" id="4964361">&gt;</span>&nbsp;<span class="ident" id="4964363">max</span>&nbsp;<span class="op" id="4964367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4964374">tempDelay</span>&nbsp;<span class="op" id="4964384">=</span>&nbsp;<span class="ident" id="4964386">max</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4964394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4964400">srv</span><span class="op" id="4964403">.</span><span class="ident" id="4964404">logf</span><span class="op" id="4964408">(</span><span class="string" id="4964409">&#34;http:&nbsp;Accept&nbsp;error:&nbsp;%v;&nbsp;retrying&nbsp;in&nbsp;%v&#34;</span><span class="op" id="4964449">,</span>&nbsp;<span class="ident" id="4964451">e</span><span class="op" id="4964452">,</span>&nbsp;<span class="ident" id="4964454">tempDelay</span><span class="op" id="4964463">)</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4964469">time</span><span class="op" id="4964473">.</span><span class="ident" id="4964474">Sleep</span><span class="op" id="4964479">(</span><span class="ident" id="4964480">tempDelay</span><span class="op" id="4964489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4964495">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4964507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4964512">return</span>&nbsp;<span class="ident" id="4964519">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4964523">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4964527">tempDelay</span>&nbsp;<span class="op" id="4964537">=</span>&nbsp;<span class="num" id="4964539">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4964543">c</span><span class="op" id="4964544">,</span>&nbsp;<span class="ident" id="4964546">err</span>&nbsp;<span class="op" id="4964550">:=</span>&nbsp;<span class="ident" id="4964553">srv</span><span class="op" id="4964556">.</span><span class="ident" id="4964557">newConn</span><span class="op" id="4964564">(</span><span class="ident" id="4964565">rw</span><span class="op" id="4964567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4964571">if</span>&nbsp;<span class="ident" id="4964574">err</span>&nbsp;<span class="op" id="4964578">!=</span>&nbsp;<span class="ident" id="4964581">nil</span>&nbsp;<span class="op" id="4964585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4964590">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4964601">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4964605">c</span><span class="op" id="4964606">.</span><span class="ident" id="4964607">setState</span><span class="op" id="4964615">(</span><span class="ident" id="4964616">c</span><span class="op" id="4964617">.</span><span class="ident" id="4964618">rwc</span><span class="op" id="4964621">,</span>&nbsp;<span class="ident" id="4964623">StateNew</span><span class="op" id="4964631">)</span>&nbsp;<span class="comment" id="4964633">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4964662">go</span>&nbsp;<span class="ident" id="4964665">c</span><span class="op" id="4964666">.</span><span class="ident" id="4964667">serve</span><span class="op" id="4964672">(</span><span class="op" id="4964673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4964676">}</span><br>
<span class="lineno"></span><span class="op" id="4964678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span><span class="keyword" id="4964681">func</span>&nbsp;<span class="op" id="4964686">(</span><span class="ident" id="4964687">s</span>&nbsp;<span class="op" id="4964689">*</span><span class="ident" id="4964690">Server</span><span class="op" id="4964696">)</span>&nbsp;<span class="ident" id="4964698">doKeepAlives</span><span class="op" id="4964710">(</span><span class="op" id="4964711">)</span>&nbsp;<span class="builtintype" id="4964713">bool</span>&nbsp;<span class="op" id="4964718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4964721">return</span>&nbsp;<span class="ident" id="4964728">atomic</span><span class="op" id="4964734">.</span><span class="ident" id="4964735">LoadInt32</span><span class="op" id="4964744">(</span><span class="op" id="4964745">&amp;</span><span class="ident" id="4964746">s</span><span class="op" id="4964747">.</span><span class="ident" id="4964748">disableKeepAlives</span><span class="op" id="4964765">)</span>&nbsp;<span class="op" id="4964767">==</span>&nbsp;<span class="num" id="4964770">0</span><br>
<span class="lineno"></span><span class="op" id="4964772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4964775">//&nbsp;SetKeepAlivesEnabled&nbsp;controls&nbsp;whether&nbsp;HTTP&nbsp;keep-alives&nbsp;are&nbsp;enabled.</span><br>
<span class="lineno">1760</span><span class="comment" id="4964846">//&nbsp;By&nbsp;default,&nbsp;keep-alives&nbsp;are&nbsp;always&nbsp;enabled.&nbsp;Only&nbsp;very</span><br>
<span class="lineno"></span><span class="comment" id="4964903">//&nbsp;resource-constrained&nbsp;environments&nbsp;or&nbsp;servers&nbsp;in&nbsp;the&nbsp;process&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4964969">//&nbsp;shutting&nbsp;down&nbsp;should&nbsp;disable&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="4965007">func</span>&nbsp;<span class="op" id="4965012">(</span><span class="ident" id="4965013">s</span>&nbsp;<span class="op" id="4965015">*</span><span class="ident" id="4965016">Server</span><span class="op" id="4965022">)</span>&nbsp;<span class="ident" id="4965024">SetKeepAlivesEnabled</span><span class="op" id="4965044">(</span><span class="ident" id="4965045">v</span>&nbsp;<span class="builtintype" id="4965047">bool</span><span class="op" id="4965051">)</span>&nbsp;<span class="op" id="4965053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4965056">if</span>&nbsp;<span class="ident" id="4965059">v</span>&nbsp;<span class="op" id="4965061">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4965065">atomic</span><span class="op" id="4965071">.</span><span class="ident" id="4965072">StoreInt32</span><span class="op" id="4965082">(</span><span class="op" id="4965083">&amp;</span><span class="ident" id="4965084">s</span><span class="op" id="4965085">.</span><span class="ident" id="4965086">disableKeepAlives</span><span class="op" id="4965103">,</span>&nbsp;<span class="num" id="4965105">0</span><span class="op" id="4965106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4965109">}</span>&nbsp;<span class="keyword" id="4965111">else</span>&nbsp;<span class="op" id="4965116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4965120">atomic</span><span class="op" id="4965126">.</span><span class="ident" id="4965127">StoreInt32</span><span class="op" id="4965137">(</span><span class="op" id="4965138">&amp;</span><span class="ident" id="4965139">s</span><span class="op" id="4965140">.</span><span class="ident" id="4965141">disableKeepAlives</span><span class="op" id="4965158">,</span>&nbsp;<span class="num" id="4965160">1</span><span class="op" id="4965161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4965164">}</span><br>
<span class="lineno"></span><span class="op" id="4965166">}</span><br>
<span class="lineno">1770</span><br>
<span class="lineno"></span><span class="keyword" id="4965169">func</span>&nbsp;<span class="op" id="4965174">(</span><span class="ident" id="4965175">s</span>&nbsp;<span class="op" id="4965177">*</span><span class="ident" id="4965178">Server</span><span class="op" id="4965184">)</span>&nbsp;<span class="ident" id="4965186">logf</span><span class="op" id="4965190">(</span><span class="ident" id="4965191">format</span>&nbsp;<span class="builtintype" id="4965198">string</span><span class="op" id="4965204">,</span>&nbsp;<span class="ident" id="4965206">args</span>&nbsp;<span class="op" id="4965211">...</span><span class="keyword" id="4965214">interface</span><span class="op" id="4965223">{</span><span class="op" id="4965224">}</span><span class="op" id="4965225">)</span>&nbsp;<span class="op" id="4965227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4965230">if</span>&nbsp;<span class="ident" id="4965233">s</span><span class="op" id="4965234">.</span><span class="ident" id="4965235">ErrorLog</span>&nbsp;<span class="op" id="4965244">!=</span>&nbsp;<span class="ident" id="4965247">nil</span>&nbsp;<span class="op" id="4965251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4965255">s</span><span class="op" id="4965256">.</span><span class="ident" id="4965257">ErrorLog</span><span class="op" id="4965265">.</span><span class="ident" id="4965266">Printf</span><span class="op" id="4965272">(</span><span class="ident" id="4965273">format</span><span class="op" id="4965279">,</span>&nbsp;<span class="ident" id="4965281">args</span><span class="op" id="4965285">...</span><span class="op" id="4965288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4965291">}</span>&nbsp;<span class="keyword" id="4965293">else</span>&nbsp;<span class="op" id="4965298">{</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4965302">log</span><span class="op" id="4965305">.</span><span class="ident" id="4965306">Printf</span><span class="op" id="4965312">(</span><span class="ident" id="4965313">format</span><span class="op" id="4965319">,</span>&nbsp;<span class="ident" id="4965321">args</span><span class="op" id="4965325">...</span><span class="op" id="4965328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4965331">}</span><br>
<span class="lineno"></span><span class="op" id="4965333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4965336">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;addr</span><br>
<span class="lineno">1780</span><span class="comment" id="4965394">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;with&nbsp;handler&nbsp;to&nbsp;handle&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4965450">//&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="4965505">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="4965551">//</span><br>
<span class="lineno"></span><span class="comment" id="4965554">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno">1785</span><span class="comment" id="4965586">//</span><br>
<span class="lineno"></span><span class="comment" id="4965589">//&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;main</span><br>
<span class="lineno"></span><span class="comment" id="4965605">//</span><br>
<span class="lineno"></span><span class="comment" id="4965608">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno"></span><span class="comment" id="4965620">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;io&#34;</span><br>
<span class="lineno">1790</span><span class="comment" id="4965629">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4965644">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4965654">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="4965659">//</span><br>
<span class="lineno"></span><span class="comment" id="4965662">//&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;hello&nbsp;world,&nbsp;the&nbsp;web&nbsp;server</span><br>
<span class="lineno">1795</span><span class="comment" id="4965696">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;HelloServer(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4965760">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspio.WriteString(w,&nbsp;&#34;hello,&nbsp;world!\n&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="4965801">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="4965806">//</span><br>
<span class="lineno"></span><span class="comment" id="4965809">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1800</span><span class="comment" id="4965826">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/hello&#34;,&nbsp;HelloServer)</span><br>
<span class="lineno"></span><span class="comment" id="4965869">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServe(&#34;:12345&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="4965915">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4965935">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;ListenAndServe:&nbsp;&#34;,&nbsp;err)</span><br>
<span class="lineno"></span><span class="comment" id="4965975">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">1805</span><span class="comment" id="4965981">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="keyword" id="4965986">func</span>&nbsp;<span class="ident" id="4965991">ListenAndServe</span><span class="op" id="4966005">(</span><span class="ident" id="4966006">addr</span>&nbsp;<span class="builtintype" id="4966011">string</span><span class="op" id="4966017">,</span>&nbsp;<span class="ident" id="4966019">handler</span>&nbsp;<span class="ident" id="4966027">Handler</span><span class="op" id="4966034">)</span>&nbsp;<span class="builtintype" id="4966036">error</span>&nbsp;<span class="op" id="4966042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4966045">server</span>&nbsp;<span class="op" id="4966052">:=</span>&nbsp;<span class="op" id="4966055">&amp;</span><span class="ident" id="4966056">Server</span><span class="op" id="4966062">{</span><span class="ident" id="4966063">Addr</span><span class="op" id="4966067">:</span>&nbsp;<span class="ident" id="4966069">addr</span><span class="op" id="4966073">,</span>&nbsp;<span class="ident" id="4966075">Handler</span><span class="op" id="4966082">:</span>&nbsp;<span class="ident" id="4966084">handler</span><span class="op" id="4966091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966094">return</span>&nbsp;<span class="ident" id="4966101">server</span><span class="op" id="4966107">.</span><span class="ident" id="4966108">ListenAndServe</span><span class="op" id="4966122">(</span><span class="op" id="4966123">)</span><br>
<span class="lineno"></span><span class="op" id="4966125">}</span><br>
<span class="lineno">1810</span><br>
<span class="lineno"></span><span class="comment" id="4966128">//&nbsp;ListenAndServeTLS&nbsp;acts&nbsp;identically&nbsp;to&nbsp;ListenAndServe,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="4966200">//&nbsp;expects&nbsp;HTTPS&nbsp;connections.&nbsp;Additionally,&nbsp;files&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4966279">//&nbsp;matching&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate</span><br>
<span class="lineno"></span><span class="comment" id="4966355">//&nbsp;is&nbsp;signed&nbsp;by&nbsp;a&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1815</span><span class="comment" id="4966437">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="4966502">//</span><br>
<span class="lineno"></span><span class="comment" id="4966505">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="4966537">//</span><br>
<span class="lineno"></span><span class="comment" id="4966540">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno">1820</span><span class="comment" id="4966552">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4966562">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4966577">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="4966582">//</span><br>
<span class="lineno"></span><span class="comment" id="4966585">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;handler(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno">1825</span><span class="comment" id="4966645">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Header().Set(&#34;Content-Type&#34;,&nbsp;&#34;text/plain&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="4966694">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Write([]byte(&#34;This&nbsp;is&nbsp;an&nbsp;example&nbsp;server.\n&#34;))</span><br>
<span class="lineno"></span><span class="comment" id="4966746">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="4966751">//</span><br>
<span class="lineno"></span><span class="comment" id="4966754">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1830</span><span class="comment" id="4966771">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/&#34;,&nbsp;handler)</span><br>
<span class="lineno"></span><span class="comment" id="4966805">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Printf(&#34;About&nbsp;to&nbsp;listen&nbsp;on&nbsp;10443.&nbsp;Go&nbsp;to&nbsp;https://127.0.0.1:10443/&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="4966880">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServeTLS(&#34;:10443&#34;,&nbsp;&#34;cert.pem&#34;,&nbsp;&#34;key.pem&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="4966952">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4966972">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(err)</span><br>
<span class="lineno">1835</span><span class="comment" id="4966992">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="4966998">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="4967003">//</span><br>
<span class="lineno"></span><span class="comment" id="4967006">//&nbsp;One&nbsp;can&nbsp;use&nbsp;generate_cert.go&nbsp;in&nbsp;crypto/tls&nbsp;to&nbsp;generate&nbsp;cert.pem&nbsp;and&nbsp;key.pem.</span><br>
<span class="lineno"></span><span class="keyword" id="4967086">func</span>&nbsp;<span class="ident" id="4967091">ListenAndServeTLS</span><span class="op" id="4967108">(</span><span class="ident" id="4967109">addr</span>&nbsp;<span class="builtintype" id="4967114">string</span><span class="op" id="4967120">,</span>&nbsp;<span class="ident" id="4967122">certFile</span>&nbsp;<span class="builtintype" id="4967131">string</span><span class="op" id="4967137">,</span>&nbsp;<span class="ident" id="4967139">keyFile</span>&nbsp;<span class="builtintype" id="4967147">string</span><span class="op" id="4967153">,</span>&nbsp;<span class="ident" id="4967155">handler</span>&nbsp;<span class="ident" id="4967163">Handler</span><span class="op" id="4967170">)</span>&nbsp;<span class="builtintype" id="4967172">error</span>&nbsp;<span class="op" id="4967178">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4967181">server</span>&nbsp;<span class="op" id="4967188">:=</span>&nbsp;<span class="op" id="4967191">&amp;</span><span class="ident" id="4967192">Server</span><span class="op" id="4967198">{</span><span class="ident" id="4967199">Addr</span><span class="op" id="4967203">:</span>&nbsp;<span class="ident" id="4967205">addr</span><span class="op" id="4967209">,</span>&nbsp;<span class="ident" id="4967211">Handler</span><span class="op" id="4967218">:</span>&nbsp;<span class="ident" id="4967220">handler</span><span class="op" id="4967227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4967230">return</span>&nbsp;<span class="ident" id="4967237">server</span><span class="op" id="4967243">.</span><span class="ident" id="4967244">ListenAndServeTLS</span><span class="op" id="4967261">(</span><span class="ident" id="4967262">certFile</span><span class="op" id="4967270">,</span>&nbsp;<span class="ident" id="4967272">keyFile</span><span class="op" id="4967279">)</span><br>
<span class="lineno"></span><span class="op" id="4967281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4967284">//&nbsp;ListenAndServeTLS&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and</span><br>
<span class="lineno">1845</span><span class="comment" id="4967353">//&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="4967421">//</span><br>
<span class="lineno"></span><span class="comment" id="4967424">//&nbsp;Filenames&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and&nbsp;matching&nbsp;private&nbsp;key&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4967491">//&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4967557">//&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1850</span><span class="comment" id="4967624">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="4967689">//</span><br>
<span class="lineno"></span><span class="comment" id="4967692">//&nbsp;If&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:https&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4967735">func</span>&nbsp;<span class="op" id="4967740">(</span><span class="ident" id="4967741">srv</span>&nbsp;<span class="op" id="4967745">*</span><span class="ident" id="4967746">Server</span><span class="op" id="4967752">)</span>&nbsp;<span class="ident" id="4967754">ListenAndServeTLS</span><span class="op" id="4967771">(</span><span class="ident" id="4967772">certFile</span><span class="op" id="4967780">,</span>&nbsp;<span class="ident" id="4967782">keyFile</span>&nbsp;<span class="builtintype" id="4967790">string</span><span class="op" id="4967796">)</span>&nbsp;<span class="builtintype" id="4967798">error</span>&nbsp;<span class="op" id="4967804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4967807">addr</span>&nbsp;<span class="op" id="4967812">:=</span>&nbsp;<span class="ident" id="4967815">srv</span><span class="op" id="4967818">.</span><span class="ident" id="4967819">Addr</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4967825">if</span>&nbsp;<span class="ident" id="4967828">addr</span>&nbsp;<span class="op" id="4967833">==</span>&nbsp;<span class="string" id="4967836">&#34;&#34;</span>&nbsp;<span class="op" id="4967839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4967843">addr</span>&nbsp;<span class="op" id="4967848">=</span>&nbsp;<span class="string" id="4967850">&#34;:https&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4967860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4967863">config</span>&nbsp;<span class="op" id="4967870">:=</span>&nbsp;<span class="op" id="4967873">&amp;</span><span class="ident" id="4967874">tls</span><span class="op" id="4967877">.</span><span class="ident" id="4967878">Config</span><span class="op" id="4967884">{</span><span class="op" id="4967885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4967888">if</span>&nbsp;<span class="ident" id="4967891">srv</span><span class="op" id="4967894">.</span><span class="ident" id="4967895">TLSConfig</span>&nbsp;<span class="op" id="4967905">!=</span>&nbsp;<span class="ident" id="4967908">nil</span>&nbsp;<span class="op" id="4967912">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4967916">*</span><span class="ident" id="4967917">config</span>&nbsp;<span class="op" id="4967924">=</span>&nbsp;<span class="op" id="4967926">*</span><span class="ident" id="4967927">srv</span><span class="op" id="4967930">.</span><span class="ident" id="4967931">TLSConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4967942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4967945">if</span>&nbsp;<span class="ident" id="4967948">config</span><span class="op" id="4967954">.</span><span class="ident" id="4967955">NextProtos</span>&nbsp;<span class="op" id="4967966">==</span>&nbsp;<span class="ident" id="4967969">nil</span>&nbsp;<span class="op" id="4967973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4967977">config</span><span class="op" id="4967983">.</span><span class="ident" id="4967984">NextProtos</span>&nbsp;<span class="op" id="4967995">=</span>&nbsp;<span class="op" id="4967997">[</span><span class="op" id="4967998">]</span><span class="builtintype" id="4967999">string</span><span class="op" id="4968005">{</span><span class="string" id="4968006">&#34;http/1.1&#34;</span><span class="op" id="4968016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4968019">}</span><br>
<span class="lineno">1865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968023">var</span>&nbsp;<span class="ident" id="4968027">err</span>&nbsp;<span class="builtintype" id="4968031">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4968038">config</span><span class="op" id="4968044">.</span><span class="ident" id="4968045">Certificates</span>&nbsp;<span class="op" id="4968058">=</span>&nbsp;<span class="builtinfunc" id="4968060">make</span><span class="op" id="4968064">(</span><span class="op" id="4968065">[</span><span class="op" id="4968066">]</span><span class="ident" id="4968067">tls</span><span class="op" id="4968070">.</span><span class="ident" id="4968071">Certificate</span><span class="op" id="4968082">,</span>&nbsp;<span class="num" id="4968084">1</span><span class="op" id="4968085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4968088">config</span><span class="op" id="4968094">.</span><span class="ident" id="4968095">Certificates</span><span class="op" id="4968107">[</span><span class="num" id="4968108">0</span><span class="op" id="4968109">]</span><span class="op" id="4968110">,</span>&nbsp;<span class="ident" id="4968112">err</span>&nbsp;<span class="op" id="4968116">=</span>&nbsp;<span class="ident" id="4968118">tls</span><span class="op" id="4968121">.</span><span class="ident" id="4968122">LoadX509KeyPair</span><span class="op" id="4968137">(</span><span class="ident" id="4968138">certFile</span><span class="op" id="4968146">,</span>&nbsp;<span class="ident" id="4968148">keyFile</span><span class="op" id="4968155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968158">if</span>&nbsp;<span class="ident" id="4968161">err</span>&nbsp;<span class="op" id="4968165">!=</span>&nbsp;<span class="ident" id="4968168">nil</span>&nbsp;<span class="op" id="4968172">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968176">return</span>&nbsp;<span class="ident" id="4968183">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4968188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4968192">ln</span><span class="op" id="4968194">,</span>&nbsp;<span class="ident" id="4968196">err</span>&nbsp;<span class="op" id="4968200">:=</span>&nbsp;<span class="ident" id="4968203">net</span><span class="op" id="4968206">.</span><span class="ident" id="4968207">Listen</span><span class="op" id="4968213">(</span><span class="string" id="4968214">&#34;tcp&#34;</span><span class="op" id="4968219">,</span>&nbsp;<span class="ident" id="4968221">addr</span><span class="op" id="4968225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968228">if</span>&nbsp;<span class="ident" id="4968231">err</span>&nbsp;<span class="op" id="4968235">!=</span>&nbsp;<span class="ident" id="4968238">nil</span>&nbsp;<span class="op" id="4968242">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968246">return</span>&nbsp;<span class="ident" id="4968253">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4968258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4968262">tlsListener</span>&nbsp;<span class="op" id="4968274">:=</span>&nbsp;<span class="ident" id="4968277">tls</span><span class="op" id="4968280">.</span><span class="ident" id="4968281">NewListener</span><span class="op" id="4968292">(</span><span class="ident" id="4968293">tcpKeepAliveListener</span><span class="op" id="4968313">{</span><span class="ident" id="4968314">ln</span><span class="op" id="4968316">.</span><span class="op" id="4968317">(</span><span class="op" id="4968318">*</span><span class="ident" id="4968319">net</span><span class="op" id="4968322">.</span><span class="ident" id="4968323">TCPListener</span><span class="op" id="4968334">)</span><span class="op" id="4968335">}</span><span class="op" id="4968336">,</span>&nbsp;<span class="ident" id="4968338">config</span><span class="op" id="4968344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968347">return</span>&nbsp;<span class="ident" id="4968354">srv</span><span class="op" id="4968357">.</span><span class="ident" id="4968358">Serve</span><span class="op" id="4968363">(</span><span class="ident" id="4968364">tlsListener</span><span class="op" id="4968375">)</span><br>
<span class="lineno">1880</span><span class="op" id="4968377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4968380">//&nbsp;TimeoutHandler&nbsp;returns&nbsp;a&nbsp;Handler&nbsp;that&nbsp;runs&nbsp;h&nbsp;with&nbsp;the&nbsp;given&nbsp;time&nbsp;limit.</span><br>
<span class="lineno"></span><span class="comment" id="4968455">//</span><br>
<span class="lineno"></span><span class="comment" id="4968458">//&nbsp;The&nbsp;new&nbsp;Handler&nbsp;calls&nbsp;h.ServeHTTP&nbsp;to&nbsp;handle&nbsp;each&nbsp;request,&nbsp;but&nbsp;if&nbsp;a</span><br>
<span class="lineno">1885</span><span class="comment" id="4968528">//&nbsp;call&nbsp;runs&nbsp;for&nbsp;longer&nbsp;than&nbsp;its&nbsp;time&nbsp;limit,&nbsp;the&nbsp;handler&nbsp;responds&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="4968599">//&nbsp;a&nbsp;503&nbsp;Service&nbsp;Unavailable&nbsp;error&nbsp;and&nbsp;the&nbsp;given&nbsp;message&nbsp;in&nbsp;its&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment" id="4968669">//&nbsp;(If&nbsp;msg&nbsp;is&nbsp;empty,&nbsp;a&nbsp;suitable&nbsp;default&nbsp;message&nbsp;will&nbsp;be&nbsp;sent.)</span><br>
<span class="lineno"></span><span class="comment" id="4968732">//&nbsp;After&nbsp;such&nbsp;a&nbsp;timeout,&nbsp;writes&nbsp;by&nbsp;h&nbsp;to&nbsp;its&nbsp;ResponseWriter&nbsp;will&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="4968803">//&nbsp;ErrHandlerTimeout.</span><br>
<span class="lineno">1890</span><span class="keyword" id="4968825">func</span>&nbsp;<span class="ident" id="4968830">TimeoutHandler</span><span class="op" id="4968844">(</span><span class="ident" id="4968845">h</span>&nbsp;<span class="ident" id="4968847">Handler</span><span class="op" id="4968854">,</span>&nbsp;<span class="ident" id="4968856">dt</span>&nbsp;<span class="ident" id="4968859">time</span><span class="op" id="4968863">.</span><span class="ident" id="4968864">Duration</span><span class="op" id="4968872">,</span>&nbsp;<span class="ident" id="4968874">msg</span>&nbsp;<span class="builtintype" id="4968878">string</span><span class="op" id="4968884">)</span>&nbsp;<span class="ident" id="4968886">Handler</span>&nbsp;<span class="op" id="4968894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4968897">f</span>&nbsp;<span class="op" id="4968899">:=</span>&nbsp;<span class="keyword" id="4968902">func</span><span class="op" id="4968906">(</span><span class="op" id="4968907">)</span>&nbsp;<span class="op" id="4968909">&lt;-</span><span class="keyword" id="4968911">chan</span>&nbsp;<span class="ident" id="4968916">time</span><span class="op" id="4968920">.</span><span class="ident" id="4968921">Time</span>&nbsp;<span class="op" id="4968926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968930">return</span>&nbsp;<span class="ident" id="4968937">time</span><span class="op" id="4968941">.</span><span class="ident" id="4968942">After</span><span class="op" id="4968947">(</span><span class="ident" id="4968948">dt</span><span class="op" id="4968950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4968953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968956">return</span>&nbsp;<span class="op" id="4968963">&amp;</span><span class="ident" id="4968964">timeoutHandler</span><span class="op" id="4968978">{</span><span class="ident" id="4968979">h</span><span class="op" id="4968980">,</span>&nbsp;<span class="ident" id="4968982">f</span><span class="op" id="4968983">,</span>&nbsp;<span class="ident" id="4968985">msg</span><span class="op" id="4968988">}</span><br>
<span class="lineno">1895</span><span class="op" id="4968990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4968993">//&nbsp;ErrHandlerTimeout&nbsp;is&nbsp;returned&nbsp;on&nbsp;ResponseWriter&nbsp;Write&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="4969056">//&nbsp;in&nbsp;handlers&nbsp;which&nbsp;have&nbsp;timed&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="4969093">var</span>&nbsp;<span class="ident" id="4969097">ErrHandlerTimeout</span>&nbsp;<span class="op" id="4969115">=</span>&nbsp;<span class="ident" id="4969117">errors</span><span class="op" id="4969123">.</span><span class="ident" id="4969124">New</span><span class="op" id="4969127">(</span><span class="string" id="4969128">&#34;http:&nbsp;Handler&nbsp;timeout&#34;</span><span class="op" id="4969151">)</span><br>
<span class="lineno">1900</span><br>
<span class="lineno"></span><span class="keyword" id="4969154">type</span>&nbsp;<span class="ident" id="4969159">timeoutHandler</span>&nbsp;<span class="keyword" id="4969174">struct</span>&nbsp;<span class="op" id="4969181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969184">handler</span>&nbsp;<span class="ident" id="4969192">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969201">timeout</span>&nbsp;<span class="keyword" id="4969209">func</span><span class="op" id="4969213">(</span><span class="op" id="4969214">)</span>&nbsp;<span class="op" id="4969216">&lt;-</span><span class="keyword" id="4969218">chan</span>&nbsp;<span class="ident" id="4969223">time</span><span class="op" id="4969227">.</span><span class="ident" id="4969228">Time</span>&nbsp;<span class="comment" id="4969233">//&nbsp;returns&nbsp;channel&nbsp;producing&nbsp;a&nbsp;timeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969273">body</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4969281">string</span><br>
<span class="lineno">1905</span><span class="op" id="4969288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4969291">func</span>&nbsp;<span class="op" id="4969296">(</span><span class="ident" id="4969297">h</span>&nbsp;<span class="op" id="4969299">*</span><span class="ident" id="4969300">timeoutHandler</span><span class="op" id="4969314">)</span>&nbsp;<span class="ident" id="4969316">errorBody</span><span class="op" id="4969325">(</span><span class="op" id="4969326">)</span>&nbsp;<span class="builtintype" id="4969328">string</span>&nbsp;<span class="op" id="4969335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969338">if</span>&nbsp;<span class="ident" id="4969341">h</span><span class="op" id="4969342">.</span><span class="ident" id="4969343">body</span>&nbsp;<span class="op" id="4969348">!=</span>&nbsp;<span class="string" id="4969351">&#34;&#34;</span>&nbsp;<span class="op" id="4969354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969358">return</span>&nbsp;<span class="ident" id="4969365">h</span><span class="op" id="4969366">.</span><span class="ident" id="4969367">body</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4969373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969376">return</span>&nbsp;<span class="string" id="4969383">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Timeout&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Timeout&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><span class="op" id="4969463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4969466">func</span>&nbsp;<span class="op" id="4969471">(</span><span class="ident" id="4969472">h</span>&nbsp;<span class="op" id="4969474">*</span><span class="ident" id="4969475">timeoutHandler</span><span class="op" id="4969489">)</span>&nbsp;<span class="ident" id="4969491">ServeHTTP</span><span class="op" id="4969500">(</span><span class="ident" id="4969501">w</span>&nbsp;<span class="ident" id="4969503">ResponseWriter</span><span class="op" id="4969517">,</span>&nbsp;<span class="ident" id="4969519">r</span>&nbsp;<span class="op" id="4969521">*</span><span class="ident" id="4969522">Request</span><span class="op" id="4969529">)</span>&nbsp;<span class="op" id="4969531">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969534">done</span>&nbsp;<span class="op" id="4969539">:=</span>&nbsp;<span class="builtinfunc" id="4969542">make</span><span class="op" id="4969546">(</span><span class="keyword" id="4969547">chan</span>&nbsp;<span class="builtintype" id="4969552">bool</span><span class="op" id="4969556">,</span>&nbsp;<span class="num" id="4969558">1</span><span class="op" id="4969559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969562">tw</span>&nbsp;<span class="op" id="4969565">:=</span>&nbsp;<span class="op" id="4969568">&amp;</span><span class="ident" id="4969569">timeoutWriter</span><span class="op" id="4969582">{</span><span class="ident" id="4969583">w</span><span class="op" id="4969584">:</span>&nbsp;<span class="ident" id="4969586">w</span><span class="op" id="4969587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969590">go</span>&nbsp;<span class="keyword" id="4969593">func</span><span class="op" id="4969597">(</span><span class="op" id="4969598">)</span>&nbsp;<span class="op" id="4969600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969604">h</span><span class="op" id="4969605">.</span><span class="ident" id="4969606">handler</span><span class="op" id="4969613">.</span><span class="ident" id="4969614">ServeHTTP</span><span class="op" id="4969623">(</span><span class="ident" id="4969624">tw</span><span class="op" id="4969626">,</span>&nbsp;<span class="ident" id="4969628">r</span><span class="op" id="4969629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969633">done</span>&nbsp;<span class="op" id="4969638">&lt;-</span>&nbsp;<span class="builtintype" id="4969641">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4969647">}</span><span class="op" id="4969648">(</span><span class="op" id="4969649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969652">select</span>&nbsp;<span class="op" id="4969659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969662">case</span>&nbsp;<span class="op" id="4969667">&lt;-</span><span class="ident" id="4969669">done</span><span class="op" id="4969673">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969677">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969685">case</span>&nbsp;<span class="op" id="4969690">&lt;-</span><span class="ident" id="4969692">h</span><span class="op" id="4969693">.</span><span class="ident" id="4969694">timeout</span><span class="op" id="4969701">(</span><span class="op" id="4969702">)</span><span class="op" id="4969703">:</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969707">tw</span><span class="op" id="4969709">.</span><span class="ident" id="4969710">mu</span><span class="op" id="4969712">.</span><span class="ident" id="4969713">Lock</span><span class="op" id="4969717">(</span><span class="op" id="4969718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969722">defer</span>&nbsp;<span class="ident" id="4969728">tw</span><span class="op" id="4969730">.</span><span class="ident" id="4969731">mu</span><span class="op" id="4969733">.</span><span class="ident" id="4969734">Unlock</span><span class="op" id="4969740">(</span><span class="op" id="4969741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969745">if</span>&nbsp;<span class="op" id="4969748">!</span><span class="ident" id="4969749">tw</span><span class="op" id="4969751">.</span><span class="ident" id="4969752">wroteHeader</span>&nbsp;<span class="op" id="4969764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969769">tw</span><span class="op" id="4969771">.</span><span class="ident" id="4969772">w</span><span class="op" id="4969773">.</span><span class="ident" id="4969774">WriteHeader</span><span class="op" id="4969785">(</span><span class="ident" id="4969786">StatusServiceUnavailable</span><span class="op" id="4969810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969815">tw</span><span class="op" id="4969817">.</span><span class="ident" id="4969818">w</span><span class="op" id="4969819">.</span><span class="ident" id="4969820">Write</span><span class="op" id="4969825">(</span><span class="op" id="4969826">[</span><span class="op" id="4969827">]</span><span class="builtintype" id="4969828">byte</span><span class="op" id="4969832">(</span><span class="ident" id="4969833">h</span><span class="op" id="4969834">.</span><span class="ident" id="4969835">errorBody</span><span class="op" id="4969844">(</span><span class="op" id="4969845">)</span><span class="op" id="4969846">)</span><span class="op" id="4969847">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4969851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969855">tw</span><span class="op" id="4969857">.</span><span class="ident" id="4969858">timedOut</span>&nbsp;<span class="op" id="4969867">=</span>&nbsp;<span class="builtintype" id="4969869">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4969875">}</span><br>
<span class="lineno"></span><span class="op" id="4969877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1935</span><span class="keyword" id="4969880">type</span>&nbsp;<span class="ident" id="4969885">timeoutWriter</span>&nbsp;<span class="keyword" id="4969899">struct</span>&nbsp;<span class="op" id="4969906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969909">w</span>&nbsp;<span class="ident" id="4969911">ResponseWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969928">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4969940">sync</span><span class="op" id="4969944">.</span><span class="ident" id="4969945">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969952">timedOut</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4969964">bool</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969970">wroteHeader</span>&nbsp;<span class="builtintype" id="4969982">bool</span><br>
<span class="lineno"></span><span class="op" id="4969987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4969990">func</span>&nbsp;<span class="op" id="4969995">(</span><span class="ident" id="4969996">tw</span>&nbsp;<span class="op" id="4969999">*</span><span class="ident" id="4970000">timeoutWriter</span><span class="op" id="4970013">)</span>&nbsp;<span class="ident" id="4970015">Header</span><span class="op" id="4970021">(</span><span class="op" id="4970022">)</span>&nbsp;<span class="ident" id="4970024">Header</span>&nbsp;<span class="op" id="4970031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970034">return</span>&nbsp;<span class="ident" id="4970041">tw</span><span class="op" id="4970043">.</span><span class="ident" id="4970044">w</span><span class="op" id="4970045">.</span><span class="ident" id="4970046">Header</span><span class="op" id="4970052">(</span><span class="op" id="4970053">)</span><br>
<span class="lineno">1945</span><span class="op" id="4970055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4970058">func</span>&nbsp;<span class="op" id="4970063">(</span><span class="ident" id="4970064">tw</span>&nbsp;<span class="op" id="4970067">*</span><span class="ident" id="4970068">timeoutWriter</span><span class="op" id="4970081">)</span>&nbsp;<span class="ident" id="4970083">Write</span><span class="op" id="4970088">(</span><span class="ident" id="4970089">p</span>&nbsp;<span class="op" id="4970091">[</span><span class="op" id="4970092">]</span><span class="builtintype" id="4970093">byte</span><span class="op" id="4970097">)</span>&nbsp;<span class="op" id="4970099">(</span><span class="builtintype" id="4970100">int</span><span class="op" id="4970103">,</span>&nbsp;<span class="builtintype" id="4970105">error</span><span class="op" id="4970110">)</span>&nbsp;<span class="op" id="4970112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4970115">tw</span><span class="op" id="4970117">.</span><span class="ident" id="4970118">mu</span><span class="op" id="4970120">.</span><span class="ident" id="4970121">Lock</span><span class="op" id="4970125">(</span><span class="op" id="4970126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970129">defer</span>&nbsp;<span class="ident" id="4970135">tw</span><span class="op" id="4970137">.</span><span class="ident" id="4970138">mu</span><span class="op" id="4970140">.</span><span class="ident" id="4970141">Unlock</span><span class="op" id="4970147">(</span><span class="op" id="4970148">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4970151">tw</span><span class="op" id="4970153">.</span><span class="ident" id="4970154">wroteHeader</span>&nbsp;<span class="op" id="4970166">=</span>&nbsp;<span class="builtintype" id="4970168">true</span>&nbsp;<span class="comment" id="4970173">//&nbsp;implicitly&nbsp;at&nbsp;least</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970197">if</span>&nbsp;<span class="ident" id="4970200">tw</span><span class="op" id="4970202">.</span><span class="ident" id="4970203">timedOut</span>&nbsp;<span class="op" id="4970212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970216">return</span>&nbsp;<span class="num" id="4970223">0</span><span class="op" id="4970224">,</span>&nbsp;<span class="ident" id="4970226">ErrHandlerTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4970245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970248">return</span>&nbsp;<span class="ident" id="4970255">tw</span><span class="op" id="4970257">.</span><span class="ident" id="4970258">w</span><span class="op" id="4970259">.</span><span class="ident" id="4970260">Write</span><span class="op" id="4970265">(</span><span class="ident" id="4970266">p</span><span class="op" id="4970267">)</span><br>
<span class="lineno">1955</span><span class="op" id="4970269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4970272">func</span>&nbsp;<span class="op" id="4970277">(</span><span class="ident" id="4970278">tw</span>&nbsp;<span class="op" id="4970281">*</span><span class="ident" id="4970282">timeoutWriter</span><span class="op" id="4970295">)</span>&nbsp;<span class="ident" id="4970297">WriteHeader</span><span class="op" id="4970308">(</span><span class="ident" id="4970309">code</span>&nbsp;<span class="builtintype" id="4970314">int</span><span class="op" id="4970317">)</span>&nbsp;<span class="op" id="4970319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4970322">tw</span><span class="op" id="4970324">.</span><span class="ident" id="4970325">mu</span><span class="op" id="4970327">.</span><span class="ident" id="4970328">Lock</span><span class="op" id="4970332">(</span><span class="op" id="4970333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970336">defer</span>&nbsp;<span class="ident" id="4970342">tw</span><span class="op" id="4970344">.</span><span class="ident" id="4970345">mu</span><span class="op" id="4970347">.</span><span class="ident" id="4970348">Unlock</span><span class="op" id="4970354">(</span><span class="op" id="4970355">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970358">if</span>&nbsp;<span class="ident" id="4970361">tw</span><span class="op" id="4970363">.</span><span class="ident" id="4970364">timedOut</span>&nbsp;<span class="op" id="4970373">||</span>&nbsp;<span class="ident" id="4970376">tw</span><span class="op" id="4970378">.</span><span class="ident" id="4970379">wroteHeader</span>&nbsp;<span class="op" id="4970391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970395">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4970403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4970406">tw</span><span class="op" id="4970408">.</span><span class="ident" id="4970409">wroteHeader</span>&nbsp;<span class="op" id="4970421">=</span>&nbsp;<span class="builtintype" id="4970423">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4970429">tw</span><span class="op" id="4970431">.</span><span class="ident" id="4970432">w</span><span class="op" id="4970433">.</span><span class="ident" id="4970434">WriteHeader</span><span class="op" id="4970445">(</span><span class="ident" id="4970446">code</span><span class="op" id="4970450">)</span><br>
<span class="lineno">1965</span><span class="op" id="4970452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4970455">//&nbsp;tcpKeepAliveListener&nbsp;sets&nbsp;TCP&nbsp;keep-alive&nbsp;timeouts&nbsp;on&nbsp;accepted</span><br>
<span class="lineno"></span><span class="comment" id="4970520">//&nbsp;connections.&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;ListenAndServe&nbsp;and&nbsp;ListenAndServeTLS&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="4970589">//&nbsp;dead&nbsp;TCP&nbsp;connections&nbsp;(e.g.&nbsp;closing&nbsp;laptop&nbsp;mid-download)&nbsp;eventually</span><br>
<span class="lineno">1970</span><span class="comment" id="4970659">//&nbsp;go&nbsp;away.</span><br>
<span class="lineno"></span><span class="keyword" id="4970671">type</span>&nbsp;<span class="ident" id="4970676">tcpKeepAliveListener</span>&nbsp;<span class="keyword" id="4970697">struct</span>&nbsp;<span class="op" id="4970704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4970707">*</span><span class="ident" id="4970708">net</span><span class="op" id="4970711">.</span><span class="ident" id="4970712">TCPListener</span><br>
<span class="lineno"></span><span class="op" id="4970724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="keyword" id="4970727">func</span>&nbsp;<span class="op" id="4970732">(</span><span class="ident" id="4970733">ln</span>&nbsp;<span class="ident" id="4970736">tcpKeepAliveListener</span><span class="op" id="4970756">)</span>&nbsp;<span class="ident" id="4970758">Accept</span><span class="op" id="4970764">(</span><span class="op" id="4970765">)</span>&nbsp;<span class="op" id="4970767">(</span><span class="ident" id="4970768">c</span>&nbsp;<span class="ident" id="4970770">net</span><span class="op" id="4970773">.</span><span class="ident" id="4970774">Conn</span><span class="op" id="4970778">,</span>&nbsp;<span class="ident" id="4970780">err</span>&nbsp;<span class="builtintype" id="4970784">error</span><span class="op" id="4970789">)</span>&nbsp;<span class="op" id="4970791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4970794">tc</span><span class="op" id="4970796">,</span>&nbsp;<span class="ident" id="4970798">err</span>&nbsp;<span class="op" id="4970802">:=</span>&nbsp;<span class="ident" id="4970805">ln</span><span class="op" id="4970807">.</span><span class="ident" id="4970808">AcceptTCP</span><span class="op" id="4970817">(</span><span class="op" id="4970818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970821">if</span>&nbsp;<span class="ident" id="4970824">err</span>&nbsp;<span class="op" id="4970828">!=</span>&nbsp;<span class="ident" id="4970831">nil</span>&nbsp;<span class="op" id="4970835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970839">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4970847">}</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4970850">tc</span><span class="op" id="4970852">.</span><span class="ident" id="4970853">SetKeepAlive</span><span class="op" id="4970865">(</span><span class="builtintype" id="4970866">true</span><span class="op" id="4970870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4970873">tc</span><span class="op" id="4970875">.</span><span class="ident" id="4970876">SetKeepAlivePeriod</span><span class="op" id="4970894">(</span><span class="num" id="4970895">3</span>&nbsp;<span class="op" id="4970897">*</span>&nbsp;<span class="ident" id="4970899">time</span><span class="op" id="4970903">.</span><span class="ident" id="4970904">Minute</span><span class="op" id="4970910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970913">return</span>&nbsp;<span class="ident" id="4970920">tc</span><span class="op" id="4970922">,</span>&nbsp;<span class="ident" id="4970924">nil</span><br>
<span class="lineno"></span><span class="op" id="4970928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1985</span><span class="comment" id="4970931">//&nbsp;globalOptionsHandler&nbsp;responds&nbsp;to&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="4970989">type</span>&nbsp;<span class="ident" id="4970994">globalOptionsHandler</span>&nbsp;<span class="keyword" id="4971015">struct</span><span class="op" id="4971021">{</span><span class="op" id="4971022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4971025">func</span>&nbsp;<span class="op" id="4971030">(</span><span class="ident" id="4971031">globalOptionsHandler</span><span class="op" id="4971051">)</span>&nbsp;<span class="ident" id="4971053">ServeHTTP</span><span class="op" id="4971062">(</span><span class="ident" id="4971063">w</span>&nbsp;<span class="ident" id="4971065">ResponseWriter</span><span class="op" id="4971079">,</span>&nbsp;<span class="ident" id="4971081">r</span>&nbsp;<span class="op" id="4971083">*</span><span class="ident" id="4971084">Request</span><span class="op" id="4971091">)</span>&nbsp;<span class="op" id="4971093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4971096">w</span><span class="op" id="4971097">.</span><span class="ident" id="4971098">Header</span><span class="op" id="4971104">(</span><span class="op" id="4971105">)</span><span class="op" id="4971106">.</span><span class="ident" id="4971107">Set</span><span class="op" id="4971110">(</span><span class="string" id="4971111">&#34;Content-Length&#34;</span><span class="op" id="4971127">,</span>&nbsp;<span class="string" id="4971129">&#34;0&#34;</span><span class="op" id="4971132">)</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4971135">if</span>&nbsp;<span class="ident" id="4971138">r</span><span class="op" id="4971139">.</span><span class="ident" id="4971140">ContentLength</span>&nbsp;<span class="op" id="4971154">!=</span>&nbsp;<span class="num" id="4971157">0</span>&nbsp;<span class="op" id="4971159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4971163">//&nbsp;Read&nbsp;up&nbsp;to&nbsp;4KB&nbsp;of&nbsp;OPTIONS&nbsp;body&nbsp;(as&nbsp;mentioned&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4971220">//&nbsp;spec&nbsp;as&nbsp;being&nbsp;reserved&nbsp;for&nbsp;future&nbsp;use),&nbsp;but&nbsp;anything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4971278">//&nbsp;over&nbsp;that&nbsp;is&nbsp;considered&nbsp;a&nbsp;waste&nbsp;of&nbsp;server&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4971335">//&nbsp;(or&nbsp;an&nbsp;attack)&nbsp;and&nbsp;we&nbsp;abort&nbsp;and&nbsp;close&nbsp;the&nbsp;connection,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4971394">//&nbsp;courtesy&nbsp;of&nbsp;MaxBytesReader&#39;s&nbsp;EOF&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4971442">mb</span>&nbsp;<span class="op" id="4971445">:=</span>&nbsp;<span class="ident" id="4971448">MaxBytesReader</span><span class="op" id="4971462">(</span><span class="ident" id="4971463">w</span><span class="op" id="4971464">,</span>&nbsp;<span class="ident" id="4971466">r</span><span class="op" id="4971467">.</span><span class="ident" id="4971468">Body</span><span class="op" id="4971472">,</span>&nbsp;<span class="num" id="4971474">4</span><span class="op" id="4971475">&lt;&lt;</span><span class="num" id="4971477">10</span><span class="op" id="4971479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4971483">io</span><span class="op" id="4971485">.</span><span class="ident" id="4971486">Copy</span><span class="op" id="4971490">(</span><span class="ident" id="4971491">ioutil</span><span class="op" id="4971497">.</span><span class="ident" id="4971498">Discard</span><span class="op" id="4971505">,</span>&nbsp;<span class="ident" id="4971507">mb</span><span class="op" id="4971509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4971512">}</span><br>
<span class="lineno"></span><span class="op" id="4971514">}</span><br>
<span class="lineno">2000</span><br>
<span class="lineno"></span><span class="keyword" id="4971517">type</span>&nbsp;<span class="ident" id="4971522">eofReaderWithWriteTo</span>&nbsp;<span class="keyword" id="4971543">struct</span><span class="op" id="4971549">{</span><span class="op" id="4971550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4971553">func</span>&nbsp;<span class="op" id="4971558">(</span><span class="ident" id="4971559">eofReaderWithWriteTo</span><span class="op" id="4971579">)</span>&nbsp;<span class="ident" id="4971581">WriteTo</span><span class="op" id="4971588">(</span><span class="ident" id="4971589">io</span><span class="op" id="4971591">.</span><span class="ident" id="4971592">Writer</span><span class="op" id="4971598">)</span>&nbsp;<span class="op" id="4971600">(</span><span class="ident" id="4971601">int64</span><span class="op" id="4971606">,</span>&nbsp;<span class="builtintype" id="4971608">error</span><span class="op" id="4971613">)</span>&nbsp;<span class="op" id="4971615">{</span>&nbsp;<span class="keyword" id="4971617">return</span>&nbsp;<span class="num" id="4971624">0</span><span class="op" id="4971625">,</span>&nbsp;<span class="ident" id="4971627">nil</span>&nbsp;<span class="op" id="4971631">}</span><br>
<span class="lineno"></span><span class="keyword" id="4971633">func</span>&nbsp;<span class="op" id="4971638">(</span><span class="ident" id="4971639">eofReaderWithWriteTo</span><span class="op" id="4971659">)</span>&nbsp;<span class="ident" id="4971661">Read</span><span class="op" id="4971665">(</span><span class="op" id="4971666">[</span><span class="op" id="4971667">]</span><span class="builtintype" id="4971668">byte</span><span class="op" id="4971672">)</span>&nbsp;<span class="op" id="4971674">(</span><span class="builtintype" id="4971675">int</span><span class="op" id="4971678">,</span>&nbsp;<span class="builtintype" id="4971680">error</span><span class="op" id="4971685">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4971695">{</span>&nbsp;<span class="keyword" id="4971697">return</span>&nbsp;<span class="num" id="4971704">0</span><span class="op" id="4971705">,</span>&nbsp;<span class="ident" id="4971707">io</span><span class="op" id="4971709">.</span><span class="ident" id="4971710">EOF</span>&nbsp;<span class="op" id="4971714">}</span><br>
<span class="lineno">2005</span><br>
<span class="lineno"></span><span class="comment" id="4971717">//&nbsp;eofReader&nbsp;is&nbsp;a&nbsp;non-nil&nbsp;io.ReadCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="4971782">//&nbsp;It&nbsp;has&nbsp;a&nbsp;WriteTo&nbsp;method&nbsp;so&nbsp;io.Copy&nbsp;won&#39;t&nbsp;need&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4971841">var</span>&nbsp;<span class="ident" id="4971845">eofReader</span>&nbsp;<span class="op" id="4971855">=</span>&nbsp;<span class="op" id="4971857">&amp;</span><span class="keyword" id="4971858">struct</span>&nbsp;<span class="op" id="4971865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4971868">eofReaderWithWriteTo</span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4971890">io</span><span class="op" id="4971892">.</span><span class="ident" id="4971893">Closer</span><br>
<span class="lineno"></span><span class="op" id="4971900">}</span><span class="op" id="4971901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4971904">eofReaderWithWriteTo</span><span class="op" id="4971924">{</span><span class="op" id="4971925">}</span><span class="op" id="4971926">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4971929">ioutil</span><span class="op" id="4971935">.</span><span class="ident" id="4971936">NopCloser</span><span class="op" id="4971945">(</span><span class="ident" id="4971946">nil</span><span class="op" id="4971949">)</span><span class="op" id="4971950">,</span><br>
<span class="lineno"></span><span class="op" id="4971952">}</span><br>
<span class="lineno">2015</span><br>
<span class="lineno"></span><span class="comment" id="4971955">//&nbsp;Verify&nbsp;that&nbsp;an&nbsp;io.Copy&nbsp;from&nbsp;an&nbsp;eofReader&nbsp;won&#39;t&nbsp;require&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4972023">var</span>&nbsp;<span class="ident" id="4972027">_</span>&nbsp;<span class="ident" id="4972029">io</span><span class="op" id="4972031">.</span><span class="ident" id="4972032">WriterTo</span>&nbsp;<span class="op" id="4972041">=</span>&nbsp;<span class="ident" id="4972043">eofReader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4972054">//&nbsp;initNPNRequest&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;that&nbsp;initializes&nbsp;certain</span><br>
<span class="lineno">2020</span><span class="comment" id="4972116">//&nbsp;uninitialized&nbsp;fields&nbsp;in&nbsp;its&nbsp;*Request.&nbsp;Such&nbsp;partially-initialized</span><br>
<span class="lineno"></span><span class="comment" id="4972184">//&nbsp;Requests&nbsp;come&nbsp;from&nbsp;NPN&nbsp;protocol&nbsp;handlers.</span><br>
<span class="lineno"></span><span class="keyword" id="4972229">type</span>&nbsp;<span class="ident" id="4972234">initNPNRequest</span>&nbsp;<span class="keyword" id="4972249">struct</span>&nbsp;<span class="op" id="4972256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972259">c</span>&nbsp;<span class="op" id="4972261">*</span><span class="ident" id="4972262">tls</span><span class="op" id="4972265">.</span><span class="ident" id="4972266">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972272">h</span>&nbsp;<span class="ident" id="4972274">serverHandler</span><br>
<span class="lineno">2025</span><span class="op" id="4972288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4972291">func</span>&nbsp;<span class="op" id="4972296">(</span><span class="ident" id="4972297">h</span>&nbsp;<span class="ident" id="4972299">initNPNRequest</span><span class="op" id="4972313">)</span>&nbsp;<span class="ident" id="4972315">ServeHTTP</span><span class="op" id="4972324">(</span><span class="ident" id="4972325">rw</span>&nbsp;<span class="ident" id="4972328">ResponseWriter</span><span class="op" id="4972342">,</span>&nbsp;<span class="ident" id="4972344">req</span>&nbsp;<span class="op" id="4972348">*</span><span class="ident" id="4972349">Request</span><span class="op" id="4972356">)</span>&nbsp;<span class="op" id="4972358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972361">if</span>&nbsp;<span class="ident" id="4972364">req</span><span class="op" id="4972367">.</span><span class="ident" id="4972368">TLS</span>&nbsp;<span class="op" id="4972372">==</span>&nbsp;<span class="ident" id="4972375">nil</span>&nbsp;<span class="op" id="4972379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972383">req</span><span class="op" id="4972386">.</span><span class="ident" id="4972387">TLS</span>&nbsp;<span class="op" id="4972391">=</span>&nbsp;<span class="op" id="4972393">&amp;</span><span class="ident" id="4972394">tls</span><span class="op" id="4972397">.</span><span class="ident" id="4972398">ConnectionState</span><span class="op" id="4972413">{</span><span class="op" id="4972414">}</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4972418">*</span><span class="ident" id="4972419">req</span><span class="op" id="4972422">.</span><span class="ident" id="4972423">TLS</span>&nbsp;<span class="op" id="4972427">=</span>&nbsp;<span class="ident" id="4972429">h</span><span class="op" id="4972430">.</span><span class="ident" id="4972431">c</span><span class="op" id="4972432">.</span><span class="ident" id="4972433">ConnectionState</span><span class="op" id="4972448">(</span><span class="op" id="4972449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4972452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972455">if</span>&nbsp;<span class="ident" id="4972458">req</span><span class="op" id="4972461">.</span><span class="ident" id="4972462">Body</span>&nbsp;<span class="op" id="4972467">==</span>&nbsp;<span class="ident" id="4972470">nil</span>&nbsp;<span class="op" id="4972474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972478">req</span><span class="op" id="4972481">.</span><span class="ident" id="4972482">Body</span>&nbsp;<span class="op" id="4972487">=</span>&nbsp;<span class="ident" id="4972489">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4972500">}</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972503">if</span>&nbsp;<span class="ident" id="4972506">req</span><span class="op" id="4972509">.</span><span class="ident" id="4972510">RemoteAddr</span>&nbsp;<span class="op" id="4972521">==</span>&nbsp;<span class="string" id="4972524">&#34;&#34;</span>&nbsp;<span class="op" id="4972527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972531">req</span><span class="op" id="4972534">.</span><span class="ident" id="4972535">RemoteAddr</span>&nbsp;<span class="op" id="4972546">=</span>&nbsp;<span class="ident" id="4972548">h</span><span class="op" id="4972549">.</span><span class="ident" id="4972550">c</span><span class="op" id="4972551">.</span><span class="ident" id="4972552">RemoteAddr</span><span class="op" id="4972562">(</span><span class="op" id="4972563">)</span><span class="op" id="4972564">.</span><span class="ident" id="4972565">String</span><span class="op" id="4972571">(</span><span class="op" id="4972572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4972575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972578">h</span><span class="op" id="4972579">.</span><span class="ident" id="4972580">h</span><span class="op" id="4972581">.</span><span class="ident" id="4972582">ServeHTTP</span><span class="op" id="4972591">(</span><span class="ident" id="4972592">rw</span><span class="op" id="4972594">,</span>&nbsp;<span class="ident" id="4972596">req</span><span class="op" id="4972599">)</span><br>
<span class="lineno"></span><span class="op" id="4972601">}</span><br>
<span class="lineno">2040</span><br>
<span class="lineno"></span><span class="comment" id="4972604">//&nbsp;loggingConn&nbsp;is&nbsp;used&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="keyword" id="4972642">type</span>&nbsp;<span class="ident" id="4972647">loggingConn</span>&nbsp;<span class="keyword" id="4972659">struct</span>&nbsp;<span class="op" id="4972666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972669">name</span>&nbsp;<span class="builtintype" id="4972674">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972682">net</span><span class="op" id="4972685">.</span><span class="ident" id="4972686">Conn</span><br>
<span class="lineno">2045</span><span class="op" id="4972691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4972694">var</span>&nbsp;<span class="op" id="4972698">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972701">uniqNameMu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4972714">sync</span><span class="op" id="4972718">.</span><span class="ident" id="4972719">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972726">uniqNameNext</span>&nbsp;<span class="op" id="4972739">=</span>&nbsp;<span class="builtinfunc" id="4972741">make</span><span class="op" id="4972745">(</span><span class="keyword" id="4972746">map</span><span class="op" id="4972749">[</span><span class="builtintype" id="4972750">string</span><span class="op" id="4972756">]</span><span class="builtintype" id="4972757">int</span><span class="op" id="4972760">)</span><br>
<span class="lineno">2050</span><span class="op" id="4972762">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4972765">func</span>&nbsp;<span class="ident" id="4972770">newLoggingConn</span><span class="op" id="4972784">(</span><span class="ident" id="4972785">baseName</span>&nbsp;<span class="builtintype" id="4972794">string</span><span class="op" id="4972800">,</span>&nbsp;<span class="ident" id="4972802">c</span>&nbsp;<span class="ident" id="4972804">net</span><span class="op" id="4972807">.</span><span class="ident" id="4972808">Conn</span><span class="op" id="4972812">)</span>&nbsp;<span class="ident" id="4972814">net</span><span class="op" id="4972817">.</span><span class="ident" id="4972818">Conn</span>&nbsp;<span class="op" id="4972823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972826">uniqNameMu</span><span class="op" id="4972836">.</span><span class="ident" id="4972837">Lock</span><span class="op" id="4972841">(</span><span class="op" id="4972842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972845">defer</span>&nbsp;<span class="ident" id="4972851">uniqNameMu</span><span class="op" id="4972861">.</span><span class="ident" id="4972862">Unlock</span><span class="op" id="4972868">(</span><span class="op" id="4972869">)</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972872">uniqNameNext</span><span class="op" id="4972884">[</span><span class="ident" id="4972885">baseName</span><span class="op" id="4972893">]</span><span class="op" id="4972894">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972898">return</span>&nbsp;<span class="op" id="4972905">&amp;</span><span class="ident" id="4972906">loggingConn</span><span class="op" id="4972917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972921">name</span><span class="op" id="4972925">:</span>&nbsp;<span class="ident" id="4972927">fmt</span><span class="op" id="4972930">.</span><span class="ident" id="4972931">Sprintf</span><span class="op" id="4972938">(</span><span class="string" id="4972939">&#34;%s-%d&#34;</span><span class="op" id="4972946">,</span>&nbsp;<span class="ident" id="4972948">baseName</span><span class="op" id="4972956">,</span>&nbsp;<span class="ident" id="4972958">uniqNameNext</span><span class="op" id="4972970">[</span><span class="ident" id="4972971">baseName</span><span class="op" id="4972979">]</span><span class="op" id="4972980">)</span><span class="op" id="4972981">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972985">Conn</span><span class="op" id="4972989">:</span>&nbsp;<span class="ident" id="4972991">c</span><span class="op" id="4972992">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4972995">}</span><br>
<span class="lineno">2060</span><span class="op" id="4972997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4973000">func</span>&nbsp;<span class="op" id="4973005">(</span><span class="ident" id="4973006">c</span>&nbsp;<span class="op" id="4973008">*</span><span class="ident" id="4973009">loggingConn</span><span class="op" id="4973020">)</span>&nbsp;<span class="ident" id="4973022">Write</span><span class="op" id="4973027">(</span><span class="ident" id="4973028">p</span>&nbsp;<span class="op" id="4973030">[</span><span class="op" id="4973031">]</span><span class="builtintype" id="4973032">byte</span><span class="op" id="4973036">)</span>&nbsp;<span class="op" id="4973038">(</span><span class="ident" id="4973039">n</span>&nbsp;<span class="builtintype" id="4973041">int</span><span class="op" id="4973044">,</span>&nbsp;<span class="ident" id="4973046">err</span>&nbsp;<span class="builtintype" id="4973050">error</span><span class="op" id="4973055">)</span>&nbsp;<span class="op" id="4973057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973060">log</span><span class="op" id="4973063">.</span><span class="ident" id="4973064">Printf</span><span class="op" id="4973070">(</span><span class="string" id="4973071">&#34;%s.Write(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="4973092">,</span>&nbsp;<span class="ident" id="4973094">c</span><span class="op" id="4973095">.</span><span class="ident" id="4973096">name</span><span class="op" id="4973100">,</span>&nbsp;<span class="builtinfunc" id="4973102">len</span><span class="op" id="4973105">(</span><span class="ident" id="4973106">p</span><span class="op" id="4973107">)</span><span class="op" id="4973108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973111">n</span><span class="op" id="4973112">,</span>&nbsp;<span class="ident" id="4973114">err</span>&nbsp;<span class="op" id="4973118">=</span>&nbsp;<span class="ident" id="4973120">c</span><span class="op" id="4973121">.</span><span class="ident" id="4973122">Conn</span><span class="op" id="4973126">.</span><span class="ident" id="4973127">Write</span><span class="op" id="4973132">(</span><span class="ident" id="4973133">p</span><span class="op" id="4973134">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973137">log</span><span class="op" id="4973140">.</span><span class="ident" id="4973141">Printf</span><span class="op" id="4973147">(</span><span class="string" id="4973148">&#34;%s.Write(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="4973171">,</span>&nbsp;<span class="ident" id="4973173">c</span><span class="op" id="4973174">.</span><span class="ident" id="4973175">name</span><span class="op" id="4973179">,</span>&nbsp;<span class="builtinfunc" id="4973181">len</span><span class="op" id="4973184">(</span><span class="ident" id="4973185">p</span><span class="op" id="4973186">)</span><span class="op" id="4973187">,</span>&nbsp;<span class="ident" id="4973189">n</span><span class="op" id="4973190">,</span>&nbsp;<span class="ident" id="4973192">err</span><span class="op" id="4973195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4973198">return</span><br>
<span class="lineno"></span><span class="op" id="4973205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4973208">func</span>&nbsp;<span class="op" id="4973213">(</span><span class="ident" id="4973214">c</span>&nbsp;<span class="op" id="4973216">*</span><span class="ident" id="4973217">loggingConn</span><span class="op" id="4973228">)</span>&nbsp;<span class="ident" id="4973230">Read</span><span class="op" id="4973234">(</span><span class="ident" id="4973235">p</span>&nbsp;<span class="op" id="4973237">[</span><span class="op" id="4973238">]</span><span class="builtintype" id="4973239">byte</span><span class="op" id="4973243">)</span>&nbsp;<span class="op" id="4973245">(</span><span class="ident" id="4973246">n</span>&nbsp;<span class="builtintype" id="4973248">int</span><span class="op" id="4973251">,</span>&nbsp;<span class="ident" id="4973253">err</span>&nbsp;<span class="builtintype" id="4973257">error</span><span class="op" id="4973262">)</span>&nbsp;<span class="op" id="4973264">{</span><br>
<span class="lineno">2070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973267">log</span><span class="op" id="4973270">.</span><span class="ident" id="4973271">Printf</span><span class="op" id="4973277">(</span><span class="string" id="4973278">&#34;%s.Read(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="4973298">,</span>&nbsp;<span class="ident" id="4973300">c</span><span class="op" id="4973301">.</span><span class="ident" id="4973302">name</span><span class="op" id="4973306">,</span>&nbsp;<span class="builtinfunc" id="4973308">len</span><span class="op" id="4973311">(</span><span class="ident" id="4973312">p</span><span class="op" id="4973313">)</span><span class="op" id="4973314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973317">n</span><span class="op" id="4973318">,</span>&nbsp;<span class="ident" id="4973320">err</span>&nbsp;<span class="op" id="4973324">=</span>&nbsp;<span class="ident" id="4973326">c</span><span class="op" id="4973327">.</span><span class="ident" id="4973328">Conn</span><span class="op" id="4973332">.</span><span class="ident" id="4973333">Read</span><span class="op" id="4973337">(</span><span class="ident" id="4973338">p</span><span class="op" id="4973339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973342">log</span><span class="op" id="4973345">.</span><span class="ident" id="4973346">Printf</span><span class="op" id="4973352">(</span><span class="string" id="4973353">&#34;%s.Read(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="4973375">,</span>&nbsp;<span class="ident" id="4973377">c</span><span class="op" id="4973378">.</span><span class="ident" id="4973379">name</span><span class="op" id="4973383">,</span>&nbsp;<span class="builtinfunc" id="4973385">len</span><span class="op" id="4973388">(</span><span class="ident" id="4973389">p</span><span class="op" id="4973390">)</span><span class="op" id="4973391">,</span>&nbsp;<span class="ident" id="4973393">n</span><span class="op" id="4973394">,</span>&nbsp;<span class="ident" id="4973396">err</span><span class="op" id="4973399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4973402">return</span><br>
<span class="lineno"></span><span class="op" id="4973409">}</span><br>
<span class="lineno">2075</span><br>
<span class="lineno"></span><span class="keyword" id="4973412">func</span>&nbsp;<span class="op" id="4973417">(</span><span class="ident" id="4973418">c</span>&nbsp;<span class="op" id="4973420">*</span><span class="ident" id="4973421">loggingConn</span><span class="op" id="4973432">)</span>&nbsp;<span class="ident" id="4973434">Close</span><span class="op" id="4973439">(</span><span class="op" id="4973440">)</span>&nbsp;<span class="op" id="4973442">(</span><span class="ident" id="4973443">err</span>&nbsp;<span class="builtintype" id="4973447">error</span><span class="op" id="4973452">)</span>&nbsp;<span class="op" id="4973454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973457">log</span><span class="op" id="4973460">.</span><span class="ident" id="4973461">Printf</span><span class="op" id="4973467">(</span><span class="string" id="4973468">&#34;%s.Close()&nbsp;=&nbsp;...&#34;</span><span class="op" id="4973486">,</span>&nbsp;<span class="ident" id="4973488">c</span><span class="op" id="4973489">.</span><span class="ident" id="4973490">name</span><span class="op" id="4973494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973497">err</span>&nbsp;<span class="op" id="4973501">=</span>&nbsp;<span class="ident" id="4973503">c</span><span class="op" id="4973504">.</span><span class="ident" id="4973505">Conn</span><span class="op" id="4973509">.</span><span class="ident" id="4973510">Close</span><span class="op" id="4973515">(</span><span class="op" id="4973516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973519">log</span><span class="op" id="4973522">.</span><span class="ident" id="4973523">Printf</span><span class="op" id="4973529">(</span><span class="string" id="4973530">&#34;%s.Close()&nbsp;=&nbsp;%v&#34;</span><span class="op" id="4973547">,</span>&nbsp;<span class="ident" id="4973549">c</span><span class="op" id="4973550">.</span><span class="ident" id="4973551">name</span><span class="op" id="4973555">,</span>&nbsp;<span class="ident" id="4973557">err</span><span class="op" id="4973560">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4973563">return</span><br>
<span class="lineno"></span><span class="op" id="4973570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4973573">//&nbsp;checkConnErrorWriter&nbsp;writes&nbsp;to&nbsp;c.rwc&nbsp;and&nbsp;records&nbsp;any&nbsp;write&nbsp;errors&nbsp;to&nbsp;c.werr.</span><br>
<span class="lineno"></span><span class="comment" id="4973653">//&nbsp;It&nbsp;only&nbsp;contains&nbsp;one&nbsp;field&nbsp;(and&nbsp;a&nbsp;pointer&nbsp;field&nbsp;at&nbsp;that),&nbsp;so&nbsp;it</span><br>
<span class="lineno">2085</span><span class="comment" id="4973720">//&nbsp;fits&nbsp;in&nbsp;an&nbsp;interface&nbsp;value&nbsp;without&nbsp;an&nbsp;extra&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="4973779">type</span>&nbsp;<span class="ident" id="4973784">checkConnErrorWriter</span>&nbsp;<span class="keyword" id="4973805">struct</span>&nbsp;<span class="op" id="4973812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973815">c</span>&nbsp;<span class="op" id="4973817">*</span><span class="ident" id="4973818">conn</span><br>
<span class="lineno"></span><span class="op" id="4973823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2090</span><span class="keyword" id="4973826">func</span>&nbsp;<span class="op" id="4973831">(</span><span class="ident" id="4973832">w</span>&nbsp;<span class="ident" id="4973834">checkConnErrorWriter</span><span class="op" id="4973854">)</span>&nbsp;<span class="ident" id="4973856">Write</span><span class="op" id="4973861">(</span><span class="ident" id="4973862">p</span>&nbsp;<span class="op" id="4973864">[</span><span class="op" id="4973865">]</span><span class="builtintype" id="4973866">byte</span><span class="op" id="4973870">)</span>&nbsp;<span class="op" id="4973872">(</span><span class="ident" id="4973873">n</span>&nbsp;<span class="builtintype" id="4973875">int</span><span class="op" id="4973878">,</span>&nbsp;<span class="ident" id="4973880">err</span>&nbsp;<span class="builtintype" id="4973884">error</span><span class="op" id="4973889">)</span>&nbsp;<span class="op" id="4973891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973894">n</span><span class="op" id="4973895">,</span>&nbsp;<span class="ident" id="4973897">err</span>&nbsp;<span class="op" id="4973901">=</span>&nbsp;<span class="ident" id="4973903">w</span><span class="op" id="4973904">.</span><span class="ident" id="4973905">c</span><span class="op" id="4973906">.</span><span class="ident" id="4973907">w</span><span class="op" id="4973908">.</span><span class="ident" id="4973909">Write</span><span class="op" id="4973914">(</span><span class="ident" id="4973915">p</span><span class="op" id="4973916">)</span>&nbsp;<span class="comment" id="4973918">//&nbsp;c.w&nbsp;==&nbsp;c.rwc,&nbsp;except&nbsp;after&nbsp;a&nbsp;hijack,&nbsp;when&nbsp;rwc&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4973976">if</span>&nbsp;<span class="ident" id="4973979">err</span>&nbsp;<span class="op" id="4973983">!=</span>&nbsp;<span class="ident" id="4973986">nil</span>&nbsp;<span class="op" id="4973990">&amp;&amp;</span>&nbsp;<span class="ident" id="4973993">w</span><span class="op" id="4973994">.</span><span class="ident" id="4973995">c</span><span class="op" id="4973996">.</span><span class="ident" id="4973997">werr</span>&nbsp;<span class="op" id="4974002">==</span>&nbsp;<span class="ident" id="4974005">nil</span>&nbsp;<span class="op" id="4974009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4974013">w</span><span class="op" id="4974014">.</span><span class="ident" id="4974015">c</span><span class="op" id="4974016">.</span><span class="ident" id="4974017">werr</span>&nbsp;<span class="op" id="4974022">=</span>&nbsp;<span class="ident" id="4974024">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4974029">}</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4974032">return</span><br>
<span class="lineno"></span><span class="op" id="4974039">}</span>
</div>
</body>
</html>
