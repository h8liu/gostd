<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2034384">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2034439">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2034493">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2034544">//&nbsp;Semaphore&nbsp;implementation&nbsp;exposed&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="2034587">//&nbsp;Intended&nbsp;use&nbsp;is&nbsp;provide&nbsp;a&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="2034633">//&nbsp;primitive&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;contended&nbsp;case</span><br>
<span class="lineno"></span><span class="comment" id="2034685">//&nbsp;of&nbsp;other&nbsp;synchronization&nbsp;primitives.</span><br>
<span class="lineno"></span><span class="comment" id="2034725">//&nbsp;Thus&nbsp;it&nbsp;targets&nbsp;the&nbsp;same&nbsp;goal&nbsp;as&nbsp;Linux&#39;s&nbsp;futex,</span><br>
<span class="lineno">10</span><span class="comment" id="2034776">//&nbsp;but&nbsp;it&nbsp;has&nbsp;much&nbsp;simpler&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="2034814">//</span><br>
<span class="lineno"></span><span class="comment" id="2034817">//&nbsp;That&nbsp;is,&nbsp;don&#39;t&nbsp;think&nbsp;of&nbsp;these&nbsp;as&nbsp;semaphores.</span><br>
<span class="lineno"></span><span class="comment" id="2034865">//&nbsp;Think&nbsp;of&nbsp;them&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;implement&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="2034921">//&nbsp;such&nbsp;that&nbsp;every&nbsp;sleep&nbsp;is&nbsp;paired&nbsp;with&nbsp;a&nbsp;single&nbsp;wakeup,</span><br>
<span class="lineno">15</span><span class="comment" id="2034978">//&nbsp;even&nbsp;if,&nbsp;due&nbsp;to&nbsp;races,&nbsp;the&nbsp;wakeup&nbsp;happens&nbsp;before&nbsp;the&nbsp;sleep.</span><br>
<span class="lineno"></span><span class="comment" id="2035041">//</span><br>
<span class="lineno"></span><span class="comment" id="2035044">//&nbsp;See&nbsp;Mullender&nbsp;and&nbsp;Cox,&nbsp;``Semaphores&nbsp;in&nbsp;Plan&nbsp;9,&#39;&#39;</span><br>
<span class="lineno"></span><span class="comment" id="2035096">//&nbsp;http://swtch.com/semaphore.pdf</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="2035131">package</span>&nbsp;<span class="ident" id="2035139">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2035148">import</span>&nbsp;<span class="string" id="2035155">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2035165">//&nbsp;Asynchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Mutex.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="2035208">type</span>&nbsp;<span class="ident" id="2035213">semaRoot</span>&nbsp;<span class="keyword" id="2035222">struct</span>&nbsp;<span class="op" id="2035229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2035232">lock</span>&nbsp;&nbsp;<span class="ident" id="2035238">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2035245">head</span>&nbsp;&nbsp;<span class="op" id="2035251">*</span><span class="ident" id="2035252">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2035259">tail</span>&nbsp;&nbsp;<span class="op" id="2035265">*</span><span class="ident" id="2035266">sudog</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2035273">nwait</span>&nbsp;<span class="builtintype" id="2035279">uint32</span>&nbsp;<span class="comment" id="2035286">//&nbsp;Number&nbsp;of&nbsp;waiters.&nbsp;Read&nbsp;w/o&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="op" id="2035327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2035330">//&nbsp;Prime&nbsp;to&nbsp;not&nbsp;correlate&nbsp;with&nbsp;any&nbsp;user&nbsp;patterns.</span><br>
<span class="lineno"></span><span class="keyword" id="2035380">const</span>&nbsp;<span class="ident" id="2035386">semTabSize</span>&nbsp;<span class="op" id="2035397">=</span>&nbsp;<span class="num" id="2035399">251</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="2035404">var</span>&nbsp;<span class="ident" id="2035408">semtable</span>&nbsp;<span class="op" id="2035417">[</span><span class="ident" id="2035418">semTabSize</span><span class="op" id="2035428">]</span><span class="keyword" id="2035429">struct</span>&nbsp;<span class="op" id="2035436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2035439">root</span>&nbsp;<span class="ident" id="2035444">semaRoot</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2035454">pad</span>&nbsp;&nbsp;<span class="op" id="2035459">[</span><span class="ident" id="2035460">_CacheLineSize</span>&nbsp;<span class="op" id="2035475">-</span>&nbsp;<span class="ident" id="2035477">unsafe</span><span class="op" id="2035483">.</span><span class="ident" id="2035484">Sizeof</span><span class="op" id="2035490">(</span><span class="ident" id="2035491">semaRoot</span><span class="op" id="2035499">{</span><span class="op" id="2035500">}</span><span class="op" id="2035501">)</span><span class="op" id="2035502">]</span><span class="builtintype" id="2035503">byte</span><br>
<span class="lineno"></span><span class="op" id="2035508">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="2035511">//&nbsp;Called&nbsp;from&nbsp;sync/net&nbsp;packages.</span><br>
<span class="lineno"></span><span class="keyword" id="2035545">func</span>&nbsp;<span class="ident" id="2035550">asyncsemacquire</span><span class="op" id="2035565">(</span><span class="ident" id="2035566">addr</span>&nbsp;<span class="op" id="2035571">*</span><span class="builtintype" id="2035572">uint32</span><span class="op" id="2035578">)</span>&nbsp;<span class="op" id="2035580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2035583">semacquire</span><span class="op" id="2035593">(</span><span class="ident" id="2035594">addr</span><span class="op" id="2035598">,</span>&nbsp;<span class="builtintype" id="2035600">true</span><span class="op" id="2035604">)</span><br>
<span class="lineno"></span><span class="op" id="2035606">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="2035609">func</span>&nbsp;<span class="ident" id="2035614">asyncsemrelease</span><span class="op" id="2035629">(</span><span class="ident" id="2035630">addr</span>&nbsp;<span class="op" id="2035635">*</span><span class="builtintype" id="2035636">uint32</span><span class="op" id="2035642">)</span>&nbsp;<span class="op" id="2035644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2035647">semrelease</span><span class="op" id="2035657">(</span><span class="ident" id="2035658">addr</span><span class="op" id="2035662">)</span><br>
<span class="lineno"></span><span class="op" id="2035664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="2035667">//&nbsp;Called&nbsp;from&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="2035691">func</span>&nbsp;<span class="ident" id="2035696">semacquire</span><span class="op" id="2035706">(</span><span class="ident" id="2035707">addr</span>&nbsp;<span class="op" id="2035712">*</span><span class="builtintype" id="2035713">uint32</span><span class="op" id="2035719">,</span>&nbsp;<span class="ident" id="2035721">profile</span>&nbsp;<span class="builtintype" id="2035729">bool</span><span class="op" id="2035733">)</span>&nbsp;<span class="op" id="2035735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2035738">gp</span>&nbsp;<span class="op" id="2035741">:=</span>&nbsp;<span class="ident" id="2035744">getg</span><span class="op" id="2035748">(</span><span class="op" id="2035749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2035752">if</span>&nbsp;<span class="ident" id="2035755">gp</span>&nbsp;<span class="op" id="2035758">!=</span>&nbsp;<span class="ident" id="2035761">gp</span><span class="op" id="2035763">.</span><span class="ident" id="2035764">m</span><span class="op" id="2035765">.</span><span class="ident" id="2035766">curg</span>&nbsp;<span class="op" id="2035771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2035775">gothrow</span><span class="op" id="2035782">(</span><span class="string" id="2035783">&#34;semacquire&nbsp;not&nbsp;on&nbsp;the&nbsp;G&nbsp;stack&#34;</span><span class="op" id="2035814">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2035817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2035821">//&nbsp;Easy&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2035836">if</span>&nbsp;<span class="ident" id="2035839">cansemacquire</span><span class="op" id="2035852">(</span><span class="ident" id="2035853">addr</span><span class="op" id="2035857">)</span>&nbsp;<span class="op" id="2035859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2035863">return</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2035871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2035875">//&nbsp;Harder&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2035892">//&nbsp;&nbsp;&nbsp;&nbspincrement&nbsp;waiter&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2035919">//&nbsp;&nbsp;&nbsp;&nbsptry&nbsp;cansemacquire&nbsp;one&nbsp;more&nbsp;time,&nbsp;return&nbsp;if&nbsp;succeeded</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2035976">//&nbsp;&nbsp;&nbsp;&nbspenqueue&nbsp;itself&nbsp;as&nbsp;a&nbsp;waiter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2036007">//&nbsp;&nbsp;&nbsp;&nbspsleep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2036017">//&nbsp;&nbsp;&nbsp;&nbsp(waiter&nbsp;descriptor&nbsp;is&nbsp;dequeued&nbsp;by&nbsp;signaler)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036065">s</span>&nbsp;<span class="op" id="2036067">:=</span>&nbsp;<span class="ident" id="2036070">acquireSudog</span><span class="op" id="2036082">(</span><span class="op" id="2036083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036086">root</span>&nbsp;<span class="op" id="2036091">:=</span>&nbsp;<span class="ident" id="2036094">semroot</span><span class="op" id="2036101">(</span><span class="ident" id="2036102">addr</span><span class="op" id="2036106">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036109">t0</span>&nbsp;<span class="op" id="2036112">:=</span>&nbsp;<span class="ident" id="2036115">int64</span><span class="op" id="2036120">(</span><span class="num" id="2036121">0</span><span class="op" id="2036122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036125">s</span><span class="op" id="2036126">.</span><span class="ident" id="2036127">releasetime</span>&nbsp;<span class="op" id="2036139">=</span>&nbsp;<span class="num" id="2036141">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2036144">if</span>&nbsp;<span class="ident" id="2036147">profile</span>&nbsp;<span class="op" id="2036155">&amp;&amp;</span>&nbsp;<span class="ident" id="2036158">blockprofilerate</span>&nbsp;<span class="op" id="2036175">&gt;</span>&nbsp;<span class="num" id="2036177">0</span>&nbsp;<span class="op" id="2036179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036183">t0</span>&nbsp;<span class="op" id="2036186">=</span>&nbsp;<span class="ident" id="2036188">cputicks</span><span class="op" id="2036196">(</span><span class="op" id="2036197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036201">s</span><span class="op" id="2036202">.</span><span class="ident" id="2036203">releasetime</span>&nbsp;<span class="op" id="2036215">=</span>&nbsp;<span class="op" id="2036217">-</span><span class="num" id="2036218">1</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2036221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2036224">for</span>&nbsp;<span class="op" id="2036228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036232">lock</span><span class="op" id="2036236">(</span><span class="op" id="2036237">&amp;</span><span class="ident" id="2036238">root</span><span class="op" id="2036242">.</span><span class="ident" id="2036243">lock</span><span class="op" id="2036247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2036251">//&nbsp;Add&nbsp;ourselves&nbsp;to&nbsp;nwait&nbsp;to&nbsp;disable&nbsp;&#34;easy&nbsp;case&#34;&nbsp;in&nbsp;semrelease.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036317">xadd</span><span class="op" id="2036321">(</span><span class="op" id="2036322">&amp;</span><span class="ident" id="2036323">root</span><span class="op" id="2036327">.</span><span class="ident" id="2036328">nwait</span><span class="op" id="2036333">,</span>&nbsp;<span class="num" id="2036335">1</span><span class="op" id="2036336">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2036340">//&nbsp;Check&nbsp;cansemacquire&nbsp;to&nbsp;avoid&nbsp;missed&nbsp;wakeup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2036389">if</span>&nbsp;<span class="ident" id="2036392">cansemacquire</span><span class="op" id="2036405">(</span><span class="ident" id="2036406">addr</span><span class="op" id="2036410">)</span>&nbsp;<span class="op" id="2036412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036417">xadd</span><span class="op" id="2036421">(</span><span class="op" id="2036422">&amp;</span><span class="ident" id="2036423">root</span><span class="op" id="2036427">.</span><span class="ident" id="2036428">nwait</span><span class="op" id="2036433">,</span>&nbsp;<span class="op" id="2036435">-</span><span class="num" id="2036436">1</span><span class="op" id="2036437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036442">unlock</span><span class="op" id="2036448">(</span><span class="op" id="2036449">&amp;</span><span class="ident" id="2036450">root</span><span class="op" id="2036454">.</span><span class="ident" id="2036455">lock</span><span class="op" id="2036459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2036464">break</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2036472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2036476">//&nbsp;Any&nbsp;semrelease&nbsp;after&nbsp;the&nbsp;cansemacquire&nbsp;knows&nbsp;we&#39;re&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2036540">//&nbsp;(we&nbsp;set&nbsp;nwait&nbsp;above),&nbsp;so&nbsp;go&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036583">root</span><span class="op" id="2036587">.</span><span class="ident" id="2036588">queue</span><span class="op" id="2036593">(</span><span class="ident" id="2036594">addr</span><span class="op" id="2036598">,</span>&nbsp;<span class="ident" id="2036600">s</span><span class="op" id="2036601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036605">goparkunlock</span><span class="op" id="2036617">(</span><span class="op" id="2036618">&amp;</span><span class="ident" id="2036619">root</span><span class="op" id="2036623">.</span><span class="ident" id="2036624">lock</span><span class="op" id="2036628">,</span>&nbsp;<span class="string" id="2036630">&#34;semacquire&#34;</span><span class="op" id="2036642">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2036646">if</span>&nbsp;<span class="ident" id="2036649">cansemacquire</span><span class="op" id="2036662">(</span><span class="ident" id="2036663">addr</span><span class="op" id="2036667">)</span>&nbsp;<span class="op" id="2036669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2036674">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2036682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2036685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2036688">if</span>&nbsp;<span class="ident" id="2036691">s</span><span class="op" id="2036692">.</span><span class="ident" id="2036693">releasetime</span>&nbsp;<span class="op" id="2036705">&gt;</span>&nbsp;<span class="num" id="2036707">0</span>&nbsp;<span class="op" id="2036709">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036713">blockevent</span><span class="op" id="2036723">(</span><span class="ident" id="2036724">int64</span><span class="op" id="2036729">(</span><span class="ident" id="2036730">s</span><span class="op" id="2036731">.</span><span class="ident" id="2036732">releasetime</span><span class="op" id="2036743">)</span><span class="op" id="2036744">-</span><span class="ident" id="2036745">t0</span><span class="op" id="2036747">,</span>&nbsp;<span class="num" id="2036749">3</span><span class="op" id="2036750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2036753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036756">releaseSudog</span><span class="op" id="2036768">(</span><span class="ident" id="2036769">s</span><span class="op" id="2036770">)</span><br>
<span class="lineno"></span><span class="op" id="2036772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="2036775">func</span>&nbsp;<span class="ident" id="2036780">semrelease</span><span class="op" id="2036790">(</span><span class="ident" id="2036791">addr</span>&nbsp;<span class="op" id="2036796">*</span><span class="builtintype" id="2036797">uint32</span><span class="op" id="2036803">)</span>&nbsp;<span class="op" id="2036805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036808">root</span>&nbsp;<span class="op" id="2036813">:=</span>&nbsp;<span class="ident" id="2036816">semroot</span><span class="op" id="2036823">(</span><span class="ident" id="2036824">addr</span><span class="op" id="2036828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2036831">xadd</span><span class="op" id="2036835">(</span><span class="ident" id="2036836">addr</span><span class="op" id="2036840">,</span>&nbsp;<span class="num" id="2036842">1</span><span class="op" id="2036843">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2036847">//&nbsp;Easy&nbsp;case:&nbsp;no&nbsp;waiters?</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2036874">//&nbsp;This&nbsp;check&nbsp;must&nbsp;happen&nbsp;after&nbsp;the&nbsp;xadd,&nbsp;to&nbsp;avoid&nbsp;a&nbsp;missed&nbsp;wakeup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2036942">//&nbsp;(see&nbsp;loop&nbsp;in&nbsp;semacquire).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2036972">if</span>&nbsp;<span class="ident" id="2036975">atomicload</span><span class="op" id="2036985">(</span><span class="op" id="2036986">&amp;</span><span class="ident" id="2036987">root</span><span class="op" id="2036991">.</span><span class="ident" id="2036992">nwait</span><span class="op" id="2036997">)</span>&nbsp;<span class="op" id="2036999">==</span>&nbsp;<span class="num" id="2037002">0</span>&nbsp;<span class="op" id="2037004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2037008">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2037016">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2037020">//&nbsp;Harder&nbsp;case:&nbsp;search&nbsp;for&nbsp;a&nbsp;waiter&nbsp;and&nbsp;wake&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037070">lock</span><span class="op" id="2037074">(</span><span class="op" id="2037075">&amp;</span><span class="ident" id="2037076">root</span><span class="op" id="2037080">.</span><span class="ident" id="2037081">lock</span><span class="op" id="2037085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2037088">if</span>&nbsp;<span class="ident" id="2037091">atomicload</span><span class="op" id="2037101">(</span><span class="op" id="2037102">&amp;</span><span class="ident" id="2037103">root</span><span class="op" id="2037107">.</span><span class="ident" id="2037108">nwait</span><span class="op" id="2037113">)</span>&nbsp;<span class="op" id="2037115">==</span>&nbsp;<span class="num" id="2037118">0</span>&nbsp;<span class="op" id="2037120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2037124">//&nbsp;The&nbsp;count&nbsp;is&nbsp;already&nbsp;consumed&nbsp;by&nbsp;another&nbsp;goroutine,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2037181">//&nbsp;so&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;up&nbsp;another&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037227">unlock</span><span class="op" id="2037233">(</span><span class="op" id="2037234">&amp;</span><span class="ident" id="2037235">root</span><span class="op" id="2037239">.</span><span class="ident" id="2037240">lock</span><span class="op" id="2037244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2037248">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2037256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037259">s</span>&nbsp;<span class="op" id="2037261">:=</span>&nbsp;<span class="ident" id="2037264">root</span><span class="op" id="2037268">.</span><span class="ident" id="2037269">head</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2037275">for</span>&nbsp;<span class="op" id="2037279">;</span>&nbsp;<span class="ident" id="2037281">s</span>&nbsp;<span class="op" id="2037283">!=</span>&nbsp;<span class="ident" id="2037286">nil</span><span class="op" id="2037289">;</span>&nbsp;<span class="ident" id="2037291">s</span>&nbsp;<span class="op" id="2037293">=</span>&nbsp;<span class="ident" id="2037295">s</span><span class="op" id="2037296">.</span><span class="ident" id="2037297">next</span>&nbsp;<span class="op" id="2037302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2037306">if</span>&nbsp;<span class="ident" id="2037309">s</span><span class="op" id="2037310">.</span><span class="ident" id="2037311">elem</span>&nbsp;<span class="op" id="2037316">==</span>&nbsp;<span class="ident" id="2037319">unsafe</span><span class="op" id="2037325">.</span><span class="ident" id="2037326">Pointer</span><span class="op" id="2037333">(</span><span class="ident" id="2037334">addr</span><span class="op" id="2037338">)</span>&nbsp;<span class="op" id="2037340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037345">xadd</span><span class="op" id="2037349">(</span><span class="op" id="2037350">&amp;</span><span class="ident" id="2037351">root</span><span class="op" id="2037355">.</span><span class="ident" id="2037356">nwait</span><span class="op" id="2037361">,</span>&nbsp;<span class="op" id="2037363">-</span><span class="num" id="2037364">1</span><span class="op" id="2037365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037370">root</span><span class="op" id="2037374">.</span><span class="ident" id="2037375">dequeue</span><span class="op" id="2037382">(</span><span class="ident" id="2037383">s</span><span class="op" id="2037384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2037389">break</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2037397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2037400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037403">unlock</span><span class="op" id="2037409">(</span><span class="op" id="2037410">&amp;</span><span class="ident" id="2037411">root</span><span class="op" id="2037415">.</span><span class="ident" id="2037416">lock</span><span class="op" id="2037420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2037423">if</span>&nbsp;<span class="ident" id="2037426">s</span>&nbsp;<span class="op" id="2037428">!=</span>&nbsp;<span class="ident" id="2037431">nil</span>&nbsp;<span class="op" id="2037435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2037439">if</span>&nbsp;<span class="ident" id="2037442">s</span><span class="op" id="2037443">.</span><span class="ident" id="2037444">releasetime</span>&nbsp;<span class="op" id="2037456">!=</span>&nbsp;<span class="num" id="2037459">0</span>&nbsp;<span class="op" id="2037461">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037466">s</span><span class="op" id="2037467">.</span><span class="ident" id="2037468">releasetime</span>&nbsp;<span class="op" id="2037480">=</span>&nbsp;<span class="ident" id="2037482">cputicks</span><span class="op" id="2037490">(</span><span class="op" id="2037491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2037495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037499">goready</span><span class="op" id="2037506">(</span><span class="ident" id="2037507">s</span><span class="op" id="2037508">.</span><span class="ident" id="2037509">g</span><span class="op" id="2037510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2037513">}</span><br>
<span class="lineno"></span><span class="op" id="2037515">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="2037518">func</span>&nbsp;<span class="ident" id="2037523">semroot</span><span class="op" id="2037530">(</span><span class="ident" id="2037531">addr</span>&nbsp;<span class="op" id="2037536">*</span><span class="builtintype" id="2037537">uint32</span><span class="op" id="2037543">)</span>&nbsp;<span class="op" id="2037545">*</span><span class="ident" id="2037546">semaRoot</span>&nbsp;<span class="op" id="2037555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2037558">return</span>&nbsp;<span class="op" id="2037565">&amp;</span><span class="ident" id="2037566">semtable</span><span class="op" id="2037574">[</span><span class="op" id="2037575">(</span><span class="builtintype" id="2037576">uintptr</span><span class="op" id="2037583">(</span><span class="ident" id="2037584">unsafe</span><span class="op" id="2037590">.</span><span class="ident" id="2037591">Pointer</span><span class="op" id="2037598">(</span><span class="ident" id="2037599">addr</span><span class="op" id="2037603">)</span><span class="op" id="2037604">)</span><span class="op" id="2037605">&gt;&gt;</span><span class="num" id="2037607">3</span><span class="op" id="2037608">)</span><span class="op" id="2037609">%</span><span class="ident" id="2037610">semTabSize</span><span class="op" id="2037620">]</span><span class="op" id="2037621">.</span><span class="ident" id="2037622">root</span><br>
<span class="lineno"></span><span class="op" id="2037627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="2037630">func</span>&nbsp;<span class="ident" id="2037635">cansemacquire</span><span class="op" id="2037648">(</span><span class="ident" id="2037649">addr</span>&nbsp;<span class="op" id="2037654">*</span><span class="builtintype" id="2037655">uint32</span><span class="op" id="2037661">)</span>&nbsp;<span class="builtintype" id="2037663">bool</span>&nbsp;<span class="op" id="2037668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2037671">for</span>&nbsp;<span class="op" id="2037675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037679">v</span>&nbsp;<span class="op" id="2037681">:=</span>&nbsp;<span class="ident" id="2037684">atomicload</span><span class="op" id="2037694">(</span><span class="ident" id="2037695">addr</span><span class="op" id="2037699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2037703">if</span>&nbsp;<span class="ident" id="2037706">v</span>&nbsp;<span class="op" id="2037708">==</span>&nbsp;<span class="num" id="2037711">0</span>&nbsp;<span class="op" id="2037713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2037718">return</span>&nbsp;<span class="builtintype" id="2037725">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2037733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2037737">if</span>&nbsp;<span class="ident" id="2037740">cas</span><span class="op" id="2037743">(</span><span class="ident" id="2037744">addr</span><span class="op" id="2037748">,</span>&nbsp;<span class="ident" id="2037750">v</span><span class="op" id="2037751">,</span>&nbsp;<span class="ident" id="2037753">v</span><span class="op" id="2037754">-</span><span class="num" id="2037755">1</span><span class="op" id="2037756">)</span>&nbsp;<span class="op" id="2037758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2037763">return</span>&nbsp;<span class="builtintype" id="2037770">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2037777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2037780">}</span><br>
<span class="lineno">150</span><span class="op" id="2037782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2037785">func</span>&nbsp;<span class="op" id="2037790">(</span><span class="ident" id="2037791">root</span>&nbsp;<span class="op" id="2037796">*</span><span class="ident" id="2037797">semaRoot</span><span class="op" id="2037805">)</span>&nbsp;<span class="ident" id="2037807">queue</span><span class="op" id="2037812">(</span><span class="ident" id="2037813">addr</span>&nbsp;<span class="op" id="2037818">*</span><span class="builtintype" id="2037819">uint32</span><span class="op" id="2037825">,</span>&nbsp;<span class="ident" id="2037827">s</span>&nbsp;<span class="op" id="2037829">*</span><span class="ident" id="2037830">sudog</span><span class="op" id="2037835">)</span>&nbsp;<span class="op" id="2037837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037840">s</span><span class="op" id="2037841">.</span><span class="ident" id="2037842">g</span>&nbsp;<span class="op" id="2037844">=</span>&nbsp;<span class="ident" id="2037846">getg</span><span class="op" id="2037850">(</span><span class="op" id="2037851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037854">s</span><span class="op" id="2037855">.</span><span class="ident" id="2037856">elem</span>&nbsp;<span class="op" id="2037861">=</span>&nbsp;<span class="ident" id="2037863">unsafe</span><span class="op" id="2037869">.</span><span class="ident" id="2037870">Pointer</span><span class="op" id="2037877">(</span><span class="ident" id="2037878">addr</span><span class="op" id="2037882">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037885">s</span><span class="op" id="2037886">.</span><span class="ident" id="2037887">next</span>&nbsp;<span class="op" id="2037892">=</span>&nbsp;<span class="ident" id="2037894">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037899">s</span><span class="op" id="2037900">.</span><span class="ident" id="2037901">prev</span>&nbsp;<span class="op" id="2037906">=</span>&nbsp;<span class="ident" id="2037908">root</span><span class="op" id="2037912">.</span><span class="ident" id="2037913">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2037919">if</span>&nbsp;<span class="ident" id="2037922">root</span><span class="op" id="2037926">.</span><span class="ident" id="2037927">tail</span>&nbsp;<span class="op" id="2037932">!=</span>&nbsp;<span class="ident" id="2037935">nil</span>&nbsp;<span class="op" id="2037939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037943">root</span><span class="op" id="2037947">.</span><span class="ident" id="2037948">tail</span><span class="op" id="2037952">.</span><span class="ident" id="2037953">next</span>&nbsp;<span class="op" id="2037958">=</span>&nbsp;<span class="ident" id="2037960">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2037963">}</span>&nbsp;<span class="keyword" id="2037965">else</span>&nbsp;<span class="op" id="2037970">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037974">root</span><span class="op" id="2037978">.</span><span class="ident" id="2037979">head</span>&nbsp;<span class="op" id="2037984">=</span>&nbsp;<span class="ident" id="2037986">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2037989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2037992">root</span><span class="op" id="2037996">.</span><span class="ident" id="2037997">tail</span>&nbsp;<span class="op" id="2038002">=</span>&nbsp;<span class="ident" id="2038004">s</span><br>
<span class="lineno"></span><span class="op" id="2038006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="2038009">func</span>&nbsp;<span class="op" id="2038014">(</span><span class="ident" id="2038015">root</span>&nbsp;<span class="op" id="2038020">*</span><span class="ident" id="2038021">semaRoot</span><span class="op" id="2038029">)</span>&nbsp;<span class="ident" id="2038031">dequeue</span><span class="op" id="2038038">(</span><span class="ident" id="2038039">s</span>&nbsp;<span class="op" id="2038041">*</span><span class="ident" id="2038042">sudog</span><span class="op" id="2038047">)</span>&nbsp;<span class="op" id="2038049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2038052">if</span>&nbsp;<span class="ident" id="2038055">s</span><span class="op" id="2038056">.</span><span class="ident" id="2038057">next</span>&nbsp;<span class="op" id="2038062">!=</span>&nbsp;<span class="ident" id="2038065">nil</span>&nbsp;<span class="op" id="2038069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038073">s</span><span class="op" id="2038074">.</span><span class="ident" id="2038075">next</span><span class="op" id="2038079">.</span><span class="ident" id="2038080">prev</span>&nbsp;<span class="op" id="2038085">=</span>&nbsp;<span class="ident" id="2038087">s</span><span class="op" id="2038088">.</span><span class="ident" id="2038089">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2038095">}</span>&nbsp;<span class="keyword" id="2038097">else</span>&nbsp;<span class="op" id="2038102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038106">root</span><span class="op" id="2038110">.</span><span class="ident" id="2038111">tail</span>&nbsp;<span class="op" id="2038116">=</span>&nbsp;<span class="ident" id="2038118">s</span><span class="op" id="2038119">.</span><span class="ident" id="2038120">prev</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2038126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2038129">if</span>&nbsp;<span class="ident" id="2038132">s</span><span class="op" id="2038133">.</span><span class="ident" id="2038134">prev</span>&nbsp;<span class="op" id="2038139">!=</span>&nbsp;<span class="ident" id="2038142">nil</span>&nbsp;<span class="op" id="2038146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038150">s</span><span class="op" id="2038151">.</span><span class="ident" id="2038152">prev</span><span class="op" id="2038156">.</span><span class="ident" id="2038157">next</span>&nbsp;<span class="op" id="2038162">=</span>&nbsp;<span class="ident" id="2038164">s</span><span class="op" id="2038165">.</span><span class="ident" id="2038166">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2038172">}</span>&nbsp;<span class="keyword" id="2038174">else</span>&nbsp;<span class="op" id="2038179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038183">root</span><span class="op" id="2038187">.</span><span class="ident" id="2038188">head</span>&nbsp;<span class="op" id="2038193">=</span>&nbsp;<span class="ident" id="2038195">s</span><span class="op" id="2038196">.</span><span class="ident" id="2038197">next</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2038203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038206">s</span><span class="op" id="2038207">.</span><span class="ident" id="2038208">elem</span>&nbsp;<span class="op" id="2038213">=</span>&nbsp;<span class="ident" id="2038215">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038220">s</span><span class="op" id="2038221">.</span><span class="ident" id="2038222">next</span>&nbsp;<span class="op" id="2038227">=</span>&nbsp;<span class="ident" id="2038229">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038234">s</span><span class="op" id="2038235">.</span><span class="ident" id="2038236">prev</span>&nbsp;<span class="op" id="2038241">=</span>&nbsp;<span class="ident" id="2038243">nil</span><br>
<span class="lineno"></span><span class="op" id="2038247">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="2038250">//&nbsp;Synchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Cond.</span><br>
<span class="lineno"></span><span class="keyword" id="2038290">type</span>&nbsp;<span class="ident" id="2038295">syncSema</span>&nbsp;<span class="keyword" id="2038304">struct</span>&nbsp;<span class="op" id="2038311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038314">lock</span>&nbsp;<span class="ident" id="2038319">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038326">head</span>&nbsp;<span class="op" id="2038331">*</span><span class="ident" id="2038332">sudog</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038339">tail</span>&nbsp;<span class="op" id="2038344">*</span><span class="ident" id="2038345">sudog</span><br>
<span class="lineno"></span><span class="op" id="2038351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2038354">//&nbsp;Syncsemacquire&nbsp;waits&nbsp;for&nbsp;a&nbsp;pairing&nbsp;syncsemrelease&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="2038432">func</span>&nbsp;<span class="ident" id="2038437">syncsemacquire</span><span class="op" id="2038451">(</span><span class="ident" id="2038452">s</span>&nbsp;<span class="op" id="2038454">*</span><span class="ident" id="2038455">syncSema</span><span class="op" id="2038463">)</span>&nbsp;<span class="op" id="2038465">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038468">lock</span><span class="op" id="2038472">(</span><span class="op" id="2038473">&amp;</span><span class="ident" id="2038474">s</span><span class="op" id="2038475">.</span><span class="ident" id="2038476">lock</span><span class="op" id="2038480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2038483">if</span>&nbsp;<span class="ident" id="2038486">s</span><span class="op" id="2038487">.</span><span class="ident" id="2038488">head</span>&nbsp;<span class="op" id="2038493">!=</span>&nbsp;<span class="ident" id="2038496">nil</span>&nbsp;<span class="op" id="2038500">&amp;&amp;</span>&nbsp;<span class="ident" id="2038503">s</span><span class="op" id="2038504">.</span><span class="ident" id="2038505">head</span><span class="op" id="2038509">.</span><span class="ident" id="2038510">nrelease</span>&nbsp;<span class="op" id="2038519">&gt;</span>&nbsp;<span class="num" id="2038521">0</span>&nbsp;<span class="op" id="2038523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2038527">//&nbsp;Have&nbsp;pending&nbsp;release,&nbsp;consume&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2038566">var</span>&nbsp;<span class="ident" id="2038570">wake</span>&nbsp;<span class="op" id="2038575">*</span><span class="ident" id="2038576">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038584">s</span><span class="op" id="2038585">.</span><span class="ident" id="2038586">head</span><span class="op" id="2038590">.</span><span class="ident" id="2038591">nrelease</span><span class="op" id="2038599">--</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2038604">if</span>&nbsp;<span class="ident" id="2038607">s</span><span class="op" id="2038608">.</span><span class="ident" id="2038609">head</span><span class="op" id="2038613">.</span><span class="ident" id="2038614">nrelease</span>&nbsp;<span class="op" id="2038623">==</span>&nbsp;<span class="num" id="2038626">0</span>&nbsp;<span class="op" id="2038628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038633">wake</span>&nbsp;<span class="op" id="2038638">=</span>&nbsp;<span class="ident" id="2038640">s</span><span class="op" id="2038641">.</span><span class="ident" id="2038642">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038650">s</span><span class="op" id="2038651">.</span><span class="ident" id="2038652">head</span>&nbsp;<span class="op" id="2038657">=</span>&nbsp;<span class="ident" id="2038659">wake</span><span class="op" id="2038663">.</span><span class="ident" id="2038664">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2038672">if</span>&nbsp;<span class="ident" id="2038675">s</span><span class="op" id="2038676">.</span><span class="ident" id="2038677">head</span>&nbsp;<span class="op" id="2038682">==</span>&nbsp;<span class="ident" id="2038685">nil</span>&nbsp;<span class="op" id="2038689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038695">s</span><span class="op" id="2038696">.</span><span class="ident" id="2038697">tail</span>&nbsp;<span class="op" id="2038702">=</span>&nbsp;<span class="ident" id="2038704">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2038711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2038715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038719">unlock</span><span class="op" id="2038725">(</span><span class="op" id="2038726">&amp;</span><span class="ident" id="2038727">s</span><span class="op" id="2038728">.</span><span class="ident" id="2038729">lock</span><span class="op" id="2038733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2038737">if</span>&nbsp;<span class="ident" id="2038740">wake</span>&nbsp;<span class="op" id="2038745">!=</span>&nbsp;<span class="ident" id="2038748">nil</span>&nbsp;<span class="op" id="2038752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038757">wake</span><span class="op" id="2038761">.</span><span class="ident" id="2038762">next</span>&nbsp;<span class="op" id="2038767">=</span>&nbsp;<span class="ident" id="2038769">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038776">goready</span><span class="op" id="2038783">(</span><span class="ident" id="2038784">wake</span><span class="op" id="2038788">.</span><span class="ident" id="2038789">g</span><span class="op" id="2038790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2038794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2038797">}</span>&nbsp;<span class="keyword" id="2038799">else</span>&nbsp;<span class="op" id="2038804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2038808">//&nbsp;Enqueue&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038829">w</span>&nbsp;<span class="op" id="2038831">:=</span>&nbsp;<span class="ident" id="2038834">acquireSudog</span><span class="op" id="2038846">(</span><span class="op" id="2038847">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038851">w</span><span class="op" id="2038852">.</span><span class="ident" id="2038853">g</span>&nbsp;<span class="op" id="2038855">=</span>&nbsp;<span class="ident" id="2038857">getg</span><span class="op" id="2038861">(</span><span class="op" id="2038862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038866">w</span><span class="op" id="2038867">.</span><span class="ident" id="2038868">nrelease</span>&nbsp;<span class="op" id="2038877">=</span>&nbsp;<span class="op" id="2038879">-</span><span class="num" id="2038880">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038884">w</span><span class="op" id="2038885">.</span><span class="ident" id="2038886">next</span>&nbsp;<span class="op" id="2038891">=</span>&nbsp;<span class="ident" id="2038893">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038899">w</span><span class="op" id="2038900">.</span><span class="ident" id="2038901">releasetime</span>&nbsp;<span class="op" id="2038913">=</span>&nbsp;<span class="num" id="2038915">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038919">t0</span>&nbsp;<span class="op" id="2038922">:=</span>&nbsp;<span class="ident" id="2038925">int64</span><span class="op" id="2038930">(</span><span class="num" id="2038931">0</span><span class="op" id="2038932">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2038936">if</span>&nbsp;<span class="ident" id="2038939">blockprofilerate</span>&nbsp;<span class="op" id="2038956">&gt;</span>&nbsp;<span class="num" id="2038958">0</span>&nbsp;<span class="op" id="2038960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038965">t0</span>&nbsp;<span class="op" id="2038968">=</span>&nbsp;<span class="ident" id="2038970">cputicks</span><span class="op" id="2038978">(</span><span class="op" id="2038979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2038984">w</span><span class="op" id="2038985">.</span><span class="ident" id="2038986">releasetime</span>&nbsp;<span class="op" id="2038998">=</span>&nbsp;<span class="op" id="2039000">-</span><span class="num" id="2039001">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2039005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2039009">if</span>&nbsp;<span class="ident" id="2039012">s</span><span class="op" id="2039013">.</span><span class="ident" id="2039014">tail</span>&nbsp;<span class="op" id="2039019">==</span>&nbsp;<span class="ident" id="2039022">nil</span>&nbsp;<span class="op" id="2039026">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039031">s</span><span class="op" id="2039032">.</span><span class="ident" id="2039033">head</span>&nbsp;<span class="op" id="2039038">=</span>&nbsp;<span class="ident" id="2039040">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2039044">}</span>&nbsp;<span class="keyword" id="2039046">else</span>&nbsp;<span class="op" id="2039051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039056">s</span><span class="op" id="2039057">.</span><span class="ident" id="2039058">tail</span><span class="op" id="2039062">.</span><span class="ident" id="2039063">next</span>&nbsp;<span class="op" id="2039068">=</span>&nbsp;<span class="ident" id="2039070">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2039074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039078">s</span><span class="op" id="2039079">.</span><span class="ident" id="2039080">tail</span>&nbsp;<span class="op" id="2039085">=</span>&nbsp;<span class="ident" id="2039087">w</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039091">goparkunlock</span><span class="op" id="2039103">(</span><span class="op" id="2039104">&amp;</span><span class="ident" id="2039105">s</span><span class="op" id="2039106">.</span><span class="ident" id="2039107">lock</span><span class="op" id="2039111">,</span>&nbsp;<span class="string" id="2039113">&#34;semacquire&#34;</span><span class="op" id="2039125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2039129">if</span>&nbsp;<span class="ident" id="2039132">t0</span>&nbsp;<span class="op" id="2039135">!=</span>&nbsp;<span class="num" id="2039138">0</span>&nbsp;<span class="op" id="2039140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039145">blockevent</span><span class="op" id="2039155">(</span><span class="ident" id="2039156">int64</span><span class="op" id="2039161">(</span><span class="ident" id="2039162">w</span><span class="op" id="2039163">.</span><span class="ident" id="2039164">releasetime</span><span class="op" id="2039175">)</span><span class="op" id="2039176">-</span><span class="ident" id="2039177">t0</span><span class="op" id="2039179">,</span>&nbsp;<span class="num" id="2039181">2</span><span class="op" id="2039182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2039186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039190">releaseSudog</span><span class="op" id="2039202">(</span><span class="ident" id="2039203">w</span><span class="op" id="2039204">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2039207">}</span><br>
<span class="lineno"></span><span class="op" id="2039209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2039212">//&nbsp;Syncsemrelease&nbsp;waits&nbsp;for&nbsp;n&nbsp;pairing&nbsp;syncsemacquire&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="2039290">func</span>&nbsp;<span class="ident" id="2039295">syncsemrelease</span><span class="op" id="2039309">(</span><span class="ident" id="2039310">s</span>&nbsp;<span class="op" id="2039312">*</span><span class="ident" id="2039313">syncSema</span><span class="op" id="2039321">,</span>&nbsp;<span class="ident" id="2039323">n</span>&nbsp;<span class="builtintype" id="2039325">uint32</span><span class="op" id="2039331">)</span>&nbsp;<span class="op" id="2039333">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039336">lock</span><span class="op" id="2039340">(</span><span class="op" id="2039341">&amp;</span><span class="ident" id="2039342">s</span><span class="op" id="2039343">.</span><span class="ident" id="2039344">lock</span><span class="op" id="2039348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2039351">for</span>&nbsp;<span class="ident" id="2039355">n</span>&nbsp;<span class="op" id="2039357">&gt;</span>&nbsp;<span class="num" id="2039359">0</span>&nbsp;<span class="op" id="2039361">&amp;&amp;</span>&nbsp;<span class="ident" id="2039364">s</span><span class="op" id="2039365">.</span><span class="ident" id="2039366">head</span>&nbsp;<span class="op" id="2039371">!=</span>&nbsp;<span class="ident" id="2039374">nil</span>&nbsp;<span class="op" id="2039378">&amp;&amp;</span>&nbsp;<span class="ident" id="2039381">s</span><span class="op" id="2039382">.</span><span class="ident" id="2039383">head</span><span class="op" id="2039387">.</span><span class="ident" id="2039388">nrelease</span>&nbsp;<span class="op" id="2039397">&lt;</span>&nbsp;<span class="num" id="2039399">0</span>&nbsp;<span class="op" id="2039401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2039405">//&nbsp;Have&nbsp;pending&nbsp;acquire,&nbsp;satisfy&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039444">wake</span>&nbsp;<span class="op" id="2039449">:=</span>&nbsp;<span class="ident" id="2039452">s</span><span class="op" id="2039453">.</span><span class="ident" id="2039454">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039461">s</span><span class="op" id="2039462">.</span><span class="ident" id="2039463">head</span>&nbsp;<span class="op" id="2039468">=</span>&nbsp;<span class="ident" id="2039470">wake</span><span class="op" id="2039474">.</span><span class="ident" id="2039475">next</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2039482">if</span>&nbsp;<span class="ident" id="2039485">s</span><span class="op" id="2039486">.</span><span class="ident" id="2039487">head</span>&nbsp;<span class="op" id="2039492">==</span>&nbsp;<span class="ident" id="2039495">nil</span>&nbsp;<span class="op" id="2039499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039504">s</span><span class="op" id="2039505">.</span><span class="ident" id="2039506">tail</span>&nbsp;<span class="op" id="2039511">=</span>&nbsp;<span class="ident" id="2039513">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2039519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2039523">if</span>&nbsp;<span class="ident" id="2039526">wake</span><span class="op" id="2039530">.</span><span class="ident" id="2039531">releasetime</span>&nbsp;<span class="op" id="2039543">!=</span>&nbsp;<span class="num" id="2039546">0</span>&nbsp;<span class="op" id="2039548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039553">wake</span><span class="op" id="2039557">.</span><span class="ident" id="2039558">releasetime</span>&nbsp;<span class="op" id="2039570">=</span>&nbsp;<span class="ident" id="2039572">cputicks</span><span class="op" id="2039580">(</span><span class="op" id="2039581">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2039585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039589">wake</span><span class="op" id="2039593">.</span><span class="ident" id="2039594">next</span>&nbsp;<span class="op" id="2039599">=</span>&nbsp;<span class="ident" id="2039601">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039607">goready</span><span class="op" id="2039614">(</span><span class="ident" id="2039615">wake</span><span class="op" id="2039619">.</span><span class="ident" id="2039620">g</span><span class="op" id="2039621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039625">n</span><span class="op" id="2039626">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2039630">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2039633">if</span>&nbsp;<span class="ident" id="2039636">n</span>&nbsp;<span class="op" id="2039638">&gt;</span>&nbsp;<span class="num" id="2039640">0</span>&nbsp;<span class="op" id="2039642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2039646">//&nbsp;enqueue&nbsp;itself</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039666">w</span>&nbsp;<span class="op" id="2039668">:=</span>&nbsp;<span class="ident" id="2039671">acquireSudog</span><span class="op" id="2039683">(</span><span class="op" id="2039684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039688">w</span><span class="op" id="2039689">.</span><span class="ident" id="2039690">g</span>&nbsp;<span class="op" id="2039692">=</span>&nbsp;<span class="ident" id="2039694">getg</span><span class="op" id="2039698">(</span><span class="op" id="2039699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039703">w</span><span class="op" id="2039704">.</span><span class="ident" id="2039705">nrelease</span>&nbsp;<span class="op" id="2039714">=</span>&nbsp;<span class="builtintype" id="2039716">int32</span><span class="op" id="2039721">(</span><span class="ident" id="2039722">n</span><span class="op" id="2039723">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039727">w</span><span class="op" id="2039728">.</span><span class="ident" id="2039729">next</span>&nbsp;<span class="op" id="2039734">=</span>&nbsp;<span class="ident" id="2039736">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039742">w</span><span class="op" id="2039743">.</span><span class="ident" id="2039744">releasetime</span>&nbsp;<span class="op" id="2039756">=</span>&nbsp;<span class="num" id="2039758">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2039762">if</span>&nbsp;<span class="ident" id="2039765">s</span><span class="op" id="2039766">.</span><span class="ident" id="2039767">tail</span>&nbsp;<span class="op" id="2039772">==</span>&nbsp;<span class="ident" id="2039775">nil</span>&nbsp;<span class="op" id="2039779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039784">s</span><span class="op" id="2039785">.</span><span class="ident" id="2039786">head</span>&nbsp;<span class="op" id="2039791">=</span>&nbsp;<span class="ident" id="2039793">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2039797">}</span>&nbsp;<span class="keyword" id="2039799">else</span>&nbsp;<span class="op" id="2039804">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039809">s</span><span class="op" id="2039810">.</span><span class="ident" id="2039811">tail</span><span class="op" id="2039815">.</span><span class="ident" id="2039816">next</span>&nbsp;<span class="op" id="2039821">=</span>&nbsp;<span class="ident" id="2039823">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2039827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039831">s</span><span class="op" id="2039832">.</span><span class="ident" id="2039833">tail</span>&nbsp;<span class="op" id="2039838">=</span>&nbsp;<span class="ident" id="2039840">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039844">goparkunlock</span><span class="op" id="2039856">(</span><span class="op" id="2039857">&amp;</span><span class="ident" id="2039858">s</span><span class="op" id="2039859">.</span><span class="ident" id="2039860">lock</span><span class="op" id="2039864">,</span>&nbsp;<span class="string" id="2039866">&#34;semarelease&#34;</span><span class="op" id="2039879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039883">releaseSudog</span><span class="op" id="2039895">(</span><span class="ident" id="2039896">w</span><span class="op" id="2039897">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2039900">}</span>&nbsp;<span class="keyword" id="2039902">else</span>&nbsp;<span class="op" id="2039907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2039911">unlock</span><span class="op" id="2039917">(</span><span class="op" id="2039918">&amp;</span><span class="ident" id="2039919">s</span><span class="op" id="2039920">.</span><span class="ident" id="2039921">lock</span><span class="op" id="2039925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2039928">}</span><br>
<span class="lineno"></span><span class="op" id="2039930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="2039933">func</span>&nbsp;<span class="ident" id="2039938">syncsemcheck</span><span class="op" id="2039950">(</span><span class="ident" id="2039951">sz</span>&nbsp;<span class="builtintype" id="2039954">uintptr</span><span class="op" id="2039961">)</span>&nbsp;<span class="op" id="2039963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2039966">if</span>&nbsp;<span class="ident" id="2039969">sz</span>&nbsp;<span class="op" id="2039972">!=</span>&nbsp;<span class="ident" id="2039975">unsafe</span><span class="op" id="2039981">.</span><span class="ident" id="2039982">Sizeof</span><span class="op" id="2039988">(</span><span class="ident" id="2039989">syncSema</span><span class="op" id="2039997">{</span><span class="op" id="2039998">}</span><span class="op" id="2039999">)</span>&nbsp;<span class="op" id="2040001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2040005">print</span><span class="op" id="2040010">(</span><span class="string" id="2040011">&#34;runtime:&nbsp;bad&nbsp;syncSema&nbsp;size&nbsp;-&nbsp;sync=&#34;</span><span class="op" id="2040047">,</span>&nbsp;<span class="ident" id="2040049">sz</span><span class="op" id="2040051">,</span>&nbsp;<span class="string" id="2040053">&#34;&nbsp;runtime=&#34;</span><span class="op" id="2040064">,</span>&nbsp;<span class="ident" id="2040066">unsafe</span><span class="op" id="2040072">.</span><span class="ident" id="2040073">Sizeof</span><span class="op" id="2040079">(</span><span class="ident" id="2040080">syncSema</span><span class="op" id="2040088">{</span><span class="op" id="2040089">}</span><span class="op" id="2040090">)</span><span class="op" id="2040091">,</span>&nbsp;<span class="string" id="2040093">&#34;\n&#34;</span><span class="op" id="2040097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2040101">gothrow</span><span class="op" id="2040108">(</span><span class="string" id="2040109">&#34;bad&nbsp;syncSema&nbsp;size&#34;</span><span class="op" id="2040128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2040131">}</span><br>
<span class="lineno">275</span><span class="op" id="2040133">}</span>
</div>
</body>
</html>
