<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html" class="current">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1701586">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1701641">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1701695">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1701746">//&nbsp;Semaphore&nbsp;implementation&nbsp;exposed&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="1701789">//&nbsp;Intended&nbsp;use&nbsp;is&nbsp;provide&nbsp;a&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1701835">//&nbsp;primitive&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;contended&nbsp;case</span><br>
<span class="lineno"></span><span class="comment" id="1701887">//&nbsp;of&nbsp;other&nbsp;synchronization&nbsp;primitives.</span><br>
<span class="lineno"></span><span class="comment" id="1701927">//&nbsp;Thus&nbsp;it&nbsp;targets&nbsp;the&nbsp;same&nbsp;goal&nbsp;as&nbsp;Linux&#39;s&nbsp;futex,</span><br>
<span class="lineno">10</span><span class="comment" id="1701978">//&nbsp;but&nbsp;it&nbsp;has&nbsp;much&nbsp;simpler&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="1702016">//</span><br>
<span class="lineno"></span><span class="comment" id="1702019">//&nbsp;That&nbsp;is,&nbsp;don&#39;t&nbsp;think&nbsp;of&nbsp;these&nbsp;as&nbsp;semaphores.</span><br>
<span class="lineno"></span><span class="comment" id="1702067">//&nbsp;Think&nbsp;of&nbsp;them&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;implement&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1702123">//&nbsp;such&nbsp;that&nbsp;every&nbsp;sleep&nbsp;is&nbsp;paired&nbsp;with&nbsp;a&nbsp;single&nbsp;wakeup,</span><br>
<span class="lineno">15</span><span class="comment" id="1702180">//&nbsp;even&nbsp;if,&nbsp;due&nbsp;to&nbsp;races,&nbsp;the&nbsp;wakeup&nbsp;happens&nbsp;before&nbsp;the&nbsp;sleep.</span><br>
<span class="lineno"></span><span class="comment" id="1702243">//</span><br>
<span class="lineno"></span><span class="comment" id="1702246">//&nbsp;See&nbsp;Mullender&nbsp;and&nbsp;Cox,&nbsp;``Semaphores&nbsp;in&nbsp;Plan&nbsp;9,&#39;&#39;</span><br>
<span class="lineno"></span><span class="comment" id="1702298">//&nbsp;http://swtch.com/semaphore.pdf</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1702333">package</span>&nbsp;<span class="ident" id="1702341">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1702350">import</span>&nbsp;<span class="string" id="1702357">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1702367">//&nbsp;Asynchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Mutex.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1702410">type</span>&nbsp;<span class="ident" id="1702415">semaRoot</span>&nbsp;<span class="keyword" id="1702424">struct</span>&nbsp;<span class="op" id="1702431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1702434">lock</span>&nbsp;&nbsp;<span class="ident" id="1702440"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786208">mutex</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1702447">head</span>&nbsp;&nbsp;<span class="op" id="1702453">*</span><span class="ident" id="1702454"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786749">sudog</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1702461">tail</span>&nbsp;&nbsp;<span class="op" id="1702467">*</span><span class="ident" id="1702468"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786749">sudog</a></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1702475">nwait</span>&nbsp;<span class="builtintype" id="1702481">uint32</span>&nbsp;<span class="comment" id="1702488">//&nbsp;Number&nbsp;of&nbsp;waiters.&nbsp;Read&nbsp;w/o&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="op" id="1702529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1702532">//&nbsp;Prime&nbsp;to&nbsp;not&nbsp;correlate&nbsp;with&nbsp;any&nbsp;user&nbsp;patterns.</span><br>
<span class="lineno"></span><span class="keyword" id="1702582">const</span>&nbsp;<span class="ident" id="1702588">semTabSize</span>&nbsp;<span class="op" id="1702599">=</span>&nbsp;<span class="num" id="1702601">251</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1702606">var</span>&nbsp;<span class="ident" id="1702610">semtable</span>&nbsp;<span class="op" id="1702619">[</span><span class="ident" id="1702620"><a href="/gostd/runtime/sema.go.html#1702588">semTabSize</a></span><span class="op" id="1702630">]</span><span class="keyword" id="1702631">struct</span>&nbsp;<span class="op" id="1702638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1702641">root</span>&nbsp;<span class="ident" id="1702646"><a href="/gostd/runtime/sema.go.html#1702415">semaRoot</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1702656">pad</span>&nbsp;&nbsp;<span class="op" id="1702661">[</span><span class="ident" id="1702662"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1791734">_CacheLineSize</a></span>&nbsp;<span class="op" id="1702677">-</span>&nbsp;<span class="ident" id="1702679"><a href="/gostd/runtime/sema.go.html#1702357">unsafe</a></span><span class="op" id="1702685">.</span><span class="ident" id="1702686">Sizeof</span><span class="op" id="1702692">(</span><span class="ident" id="1702693"><a href="/gostd/runtime/sema.go.html#1702415">semaRoot</a></span><span class="op" id="1702701">{</span><span class="op" id="1702702">}</span><span class="op" id="1702703">)</span><span class="op" id="1702704">]</span><span class="builtintype" id="1702705">byte</span><br>
<span class="lineno"></span><span class="op" id="1702710">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="1702713">//&nbsp;Called&nbsp;from&nbsp;sync/net&nbsp;packages.</span><br>
<span class="lineno"></span><span class="keyword" id="1702747">func</span>&nbsp;<span class="ident" id="1702752">asyncsemacquire</span><span class="op" id="1702767">(</span><span class="ident" id="1702768">addr</span>&nbsp;<span class="op" id="1702773">*</span><span class="builtintype" id="1702774">uint32</span><span class="op" id="1702780">)</span>&nbsp;<span class="op" id="1702782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1702785"><a href="/gostd/runtime/sema.go.html#1702898">semacquire</a></span><span class="op" id="1702795">(</span><span class="ident" id="1702796"><a href="/gostd/runtime/sema.go.html#1702768">addr</a></span><span class="op" id="1702800">,</span>&nbsp;<span class="builtintype" id="1702802">true</span><span class="op" id="1702806">)</span><br>
<span class="lineno"></span><span class="op" id="1702808">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="1702811">func</span>&nbsp;<span class="ident" id="1702816">asyncsemrelease</span><span class="op" id="1702831">(</span><span class="ident" id="1702832">addr</span>&nbsp;<span class="op" id="1702837">*</span><span class="builtintype" id="1702838">uint32</span><span class="op" id="1702844">)</span>&nbsp;<span class="op" id="1702846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1702849"><a href="/gostd/runtime/sema.go.html#1703982">semrelease</a></span><span class="op" id="1702859">(</span><span class="ident" id="1702860"><a href="/gostd/runtime/sema.go.html#1702832">addr</a></span><span class="op" id="1702864">)</span><br>
<span class="lineno"></span><span class="op" id="1702866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="1702869">//&nbsp;Called&nbsp;from&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1702893">func</span>&nbsp;<span class="ident" id="1702898">semacquire</span><span class="op" id="1702908">(</span><span class="ident" id="1702909">addr</span>&nbsp;<span class="op" id="1702914">*</span><span class="builtintype" id="1702915">uint32</span><span class="op" id="1702921">,</span>&nbsp;<span class="ident" id="1702923">profile</span>&nbsp;<span class="builtintype" id="1702931">bool</span><span class="op" id="1702935">)</span>&nbsp;<span class="op" id="1702937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1702940">gp</span>&nbsp;<span class="op" id="1702943">:=</span>&nbsp;<span class="ident" id="1702946"><a href="/gostd/runtime/stubs.go.html#1738919">getg</a></span><span class="op" id="1702950">(</span><span class="op" id="1702951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1702954">if</span>&nbsp;<span class="ident" id="1702957"><a href="/gostd/runtime/sema.go.html#1702940">gp</a></span>&nbsp;<span class="op" id="1702960">!=</span>&nbsp;<span class="ident" id="1702963"><a href="/gostd/runtime/sema.go.html#1702940">gp</a></span><span class="op" id="1702965">.</span><span class="ident" id="1702966"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787643">m</a></span><span class="op" id="1702967">.</span><span class="ident" id="1702968"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1787912">curg</a></span>&nbsp;<span class="op" id="1702973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1702977"><a href="/gostd/runtime/panic.go.html#1664327">gothrow</a></span><span class="op" id="1702984">(</span><span class="string" id="1702985">&#34;semacquire&nbsp;not&nbsp;on&nbsp;the&nbsp;G&nbsp;stack&#34;</span><span class="op" id="1703016">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1703019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1703023">//&nbsp;Easy&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1703038">if</span>&nbsp;<span class="ident" id="1703041"><a href="/gostd/runtime/sema.go.html#1704837">cansemacquire</a></span><span class="op" id="1703054">(</span><span class="ident" id="1703055"><a href="/gostd/runtime/sema.go.html#1702909">addr</a></span><span class="op" id="1703059">)</span>&nbsp;<span class="op" id="1703061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1703065">return</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1703073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1703077">//&nbsp;Harder&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1703094">//&nbsp;&nbsp;&nbsp;&nbsp;increment&nbsp;waiter&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1703121">//&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;cansemacquire&nbsp;one&nbsp;more&nbsp;time,&nbsp;return&nbsp;if&nbsp;succeeded</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1703178">//&nbsp;&nbsp;&nbsp;&nbsp;enqueue&nbsp;itself&nbsp;as&nbsp;a&nbsp;waiter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1703209">//&nbsp;&nbsp;&nbsp;&nbsp;sleep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1703219">//&nbsp;&nbsp;&nbsp;&nbsp;(waiter&nbsp;descriptor&nbsp;is&nbsp;dequeued&nbsp;by&nbsp;signaler)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1703267">s</span>&nbsp;<span class="op" id="1703269">:=</span>&nbsp;<span class="ident" id="1703272"><a href="/gostd/runtime/proc.go.html#1674038">acquireSudog</a></span><span class="op" id="1703284">(</span><span class="op" id="1703285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1703288">root</span>&nbsp;<span class="op" id="1703293">:=</span>&nbsp;<span class="ident" id="1703296"><a href="/gostd/runtime/sema.go.html#1704725">semroot</a></span><span class="op" id="1703303">(</span><span class="ident" id="1703304"><a href="/gostd/runtime/sema.go.html#1702909">addr</a></span><span class="op" id="1703308">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1703311">t0</span>&nbsp;<span class="op" id="1703314">:=</span>&nbsp;<span class="builtintype" id="1703317">int64</span><span class="op" id="1703322">(</span><span class="num" id="1703323">0</span><span class="op" id="1703324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1703327"><a href="/gostd/runtime/sema.go.html#1703267">s</a></span><span class="op" id="1703328">.</span><span class="ident" id="1703329"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786838">releasetime</a></span>&nbsp;<span class="op" id="1703341">=</span>&nbsp;<span class="num" id="1703343">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1703346">if</span>&nbsp;<span class="ident" id="1703349"><a href="/gostd/runtime/sema.go.html#1702923">profile</a></span>&nbsp;<span class="op" id="1703357">&amp;&amp;</span>&nbsp;<span class="ident" id="1703360"><a href="/gostd/runtime/mprof.go.html#1626211">blockprofilerate</a></span>&nbsp;<span class="op" id="1703377">&gt;</span>&nbsp;<span class="num" id="1703379">0</span>&nbsp;<span class="op" id="1703381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1703385"><a href="/gostd/runtime/sema.go.html#1703311">t0</a></span>&nbsp;<span class="op" id="1703388">=</span>&nbsp;<span class="ident" id="1703390"><a href="/gostd/runtime/stubs.go.html#1744144">cputicks</a></span><span class="op" id="1703398">(</span><span class="op" id="1703399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1703403"><a href="/gostd/runtime/sema.go.html#1703267">s</a></span><span class="op" id="1703404">.</span><span class="ident" id="1703405"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786838">releasetime</a></span>&nbsp;<span class="op" id="1703417">=</span>&nbsp;<span class="op" id="1703419">-</span><span class="num" id="1703420">1</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1703423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1703426">for</span>&nbsp;<span class="op" id="1703430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1703434"><a href="/gostd/runtime/lock_futex.go.html#1585337">lock</a></span><span class="op" id="1703438">(</span><span class="op" id="1703439">&amp;</span><span class="ident" id="1703440"><a href="/gostd/runtime/sema.go.html#1703288">root</a></span><span class="op" id="1703444">.</span><span class="ident" id="1703445"><a href="/gostd/runtime/sema.go.html#1702434">lock</a></span><span class="op" id="1703449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1703453">//&nbsp;Add&nbsp;ourselves&nbsp;to&nbsp;nwait&nbsp;to&nbsp;disable&nbsp;&#34;easy&nbsp;case&#34;&nbsp;in&nbsp;semrelease.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1703519"><a href="/gostd/runtime/atomic.go.html#1480948">xadd</a></span><span class="op" id="1703523">(</span><span class="op" id="1703524">&amp;</span><span class="ident" id="1703525"><a href="/gostd/runtime/sema.go.html#1703288">root</a></span><span class="op" id="1703529">.</span><span class="ident" id="1703530"><a href="/gostd/runtime/sema.go.html#1702475">nwait</a></span><span class="op" id="1703535">,</span>&nbsp;<span class="num" id="1703537">1</span><span class="op" id="1703538">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1703542">//&nbsp;Check&nbsp;cansemacquire&nbsp;to&nbsp;avoid&nbsp;missed&nbsp;wakeup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1703591">if</span>&nbsp;<span class="ident" id="1703594"><a href="/gostd/runtime/sema.go.html#1704837">cansemacquire</a></span><span class="op" id="1703607">(</span><span class="ident" id="1703608"><a href="/gostd/runtime/sema.go.html#1702909">addr</a></span><span class="op" id="1703612">)</span>&nbsp;<span class="op" id="1703614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1703619"><a href="/gostd/runtime/atomic.go.html#1480948">xadd</a></span><span class="op" id="1703623">(</span><span class="op" id="1703624">&amp;</span><span class="ident" id="1703625"><a href="/gostd/runtime/sema.go.html#1703288">root</a></span><span class="op" id="1703629">.</span><span class="ident" id="1703630"><a href="/gostd/runtime/sema.go.html#1702475">nwait</a></span><span class="op" id="1703635">,</span>&nbsp;<span class="op" id="1703637">-</span><span class="num" id="1703638">1</span><span class="op" id="1703639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1703644"><a href="/gostd/runtime/lock_futex.go.html#1586629">unlock</a></span><span class="op" id="1703650">(</span><span class="op" id="1703651">&amp;</span><span class="ident" id="1703652"><a href="/gostd/runtime/sema.go.html#1703288">root</a></span><span class="op" id="1703656">.</span><span class="ident" id="1703657"><a href="/gostd/runtime/sema.go.html#1702434">lock</a></span><span class="op" id="1703661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1703666">break</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1703674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1703678">//&nbsp;Any&nbsp;semrelease&nbsp;after&nbsp;the&nbsp;cansemacquire&nbsp;knows&nbsp;we&#39;re&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1703742">//&nbsp;(we&nbsp;set&nbsp;nwait&nbsp;above),&nbsp;so&nbsp;go&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1703785"><a href="/gostd/runtime/sema.go.html#1703288">root</a></span><span class="op" id="1703789">.</span><span class="ident" id="1703790"><a href="/gostd/runtime/sema.go.html#1705009">queue</a></span><span class="op" id="1703795">(</span><span class="ident" id="1703796"><a href="/gostd/runtime/sema.go.html#1702909">addr</a></span><span class="op" id="1703800">,</span>&nbsp;<span class="ident" id="1703802"><a href="/gostd/runtime/sema.go.html#1703267">s</a></span><span class="op" id="1703803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1703807"><a href="/gostd/runtime/proc.go.html#1673799">goparkunlock</a></span><span class="op" id="1703819">(</span><span class="op" id="1703820">&amp;</span><span class="ident" id="1703821"><a href="/gostd/runtime/sema.go.html#1703288">root</a></span><span class="op" id="1703825">.</span><span class="ident" id="1703826"><a href="/gostd/runtime/sema.go.html#1702434">lock</a></span><span class="op" id="1703830">,</span>&nbsp;<span class="string" id="1703832">&#34;semacquire&#34;</span><span class="op" id="1703844">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1703848">if</span>&nbsp;<span class="ident" id="1703851"><a href="/gostd/runtime/sema.go.html#1704837">cansemacquire</a></span><span class="op" id="1703864">(</span><span class="ident" id="1703865"><a href="/gostd/runtime/sema.go.html#1702909">addr</a></span><span class="op" id="1703869">)</span>&nbsp;<span class="op" id="1703871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1703876">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1703884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1703887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1703890">if</span>&nbsp;<span class="ident" id="1703893"><a href="/gostd/runtime/sema.go.html#1703267">s</a></span><span class="op" id="1703894">.</span><span class="ident" id="1703895"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786838">releasetime</a></span>&nbsp;<span class="op" id="1703907">&gt;</span>&nbsp;<span class="num" id="1703909">0</span>&nbsp;<span class="op" id="1703911">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1703915"><a href="/gostd/runtime/mprof.go.html#1626994">blockevent</a></span><span class="op" id="1703925">(</span><span class="builtintype" id="1703926">int64</span><span class="op" id="1703931">(</span><span class="ident" id="1703932"><a href="/gostd/runtime/sema.go.html#1703267">s</a></span><span class="op" id="1703933">.</span><span class="ident" id="1703934"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786838">releasetime</a></span><span class="op" id="1703945">)</span><span class="op" id="1703946">-</span><span class="ident" id="1703947"><a href="/gostd/runtime/sema.go.html#1703311">t0</a></span><span class="op" id="1703949">,</span>&nbsp;<span class="num" id="1703951">3</span><span class="op" id="1703952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1703955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1703958"><a href="/gostd/runtime/proc.go.html#1674768">releaseSudog</a></span><span class="op" id="1703970">(</span><span class="ident" id="1703971"><a href="/gostd/runtime/sema.go.html#1703267">s</a></span><span class="op" id="1703972">)</span><br>
<span class="lineno"></span><span class="op" id="1703974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="1703977">func</span>&nbsp;<span class="ident" id="1703982">semrelease</span><span class="op" id="1703992">(</span><span class="ident" id="1703993">addr</span>&nbsp;<span class="op" id="1703998">*</span><span class="builtintype" id="1703999">uint32</span><span class="op" id="1704005">)</span>&nbsp;<span class="op" id="1704007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1704010">root</span>&nbsp;<span class="op" id="1704015">:=</span>&nbsp;<span class="ident" id="1704018"><a href="/gostd/runtime/sema.go.html#1704725">semroot</a></span><span class="op" id="1704025">(</span><span class="ident" id="1704026"><a href="/gostd/runtime/sema.go.html#1703993">addr</a></span><span class="op" id="1704030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1704033"><a href="/gostd/runtime/atomic.go.html#1480948">xadd</a></span><span class="op" id="1704037">(</span><span class="ident" id="1704038"><a href="/gostd/runtime/sema.go.html#1703993">addr</a></span><span class="op" id="1704042">,</span>&nbsp;<span class="num" id="1704044">1</span><span class="op" id="1704045">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1704049">//&nbsp;Easy&nbsp;case:&nbsp;no&nbsp;waiters?</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1704076">//&nbsp;This&nbsp;check&nbsp;must&nbsp;happen&nbsp;after&nbsp;the&nbsp;xadd,&nbsp;to&nbsp;avoid&nbsp;a&nbsp;missed&nbsp;wakeup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1704144">//&nbsp;(see&nbsp;loop&nbsp;in&nbsp;semacquire).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1704174">if</span>&nbsp;<span class="ident" id="1704177"><a href="/gostd/runtime/atomic.go.html#1481330">atomicload</a></span><span class="op" id="1704187">(</span><span class="op" id="1704188">&amp;</span><span class="ident" id="1704189"><a href="/gostd/runtime/sema.go.html#1704010">root</a></span><span class="op" id="1704193">.</span><span class="ident" id="1704194"><a href="/gostd/runtime/sema.go.html#1702475">nwait</a></span><span class="op" id="1704199">)</span>&nbsp;<span class="op" id="1704201">==</span>&nbsp;<span class="num" id="1704204">0</span>&nbsp;<span class="op" id="1704206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1704210">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1704218">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1704222">//&nbsp;Harder&nbsp;case:&nbsp;search&nbsp;for&nbsp;a&nbsp;waiter&nbsp;and&nbsp;wake&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1704272"><a href="/gostd/runtime/lock_futex.go.html#1585337">lock</a></span><span class="op" id="1704276">(</span><span class="op" id="1704277">&amp;</span><span class="ident" id="1704278"><a href="/gostd/runtime/sema.go.html#1704010">root</a></span><span class="op" id="1704282">.</span><span class="ident" id="1704283"><a href="/gostd/runtime/sema.go.html#1702434">lock</a></span><span class="op" id="1704287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1704290">if</span>&nbsp;<span class="ident" id="1704293"><a href="/gostd/runtime/atomic.go.html#1481330">atomicload</a></span><span class="op" id="1704303">(</span><span class="op" id="1704304">&amp;</span><span class="ident" id="1704305"><a href="/gostd/runtime/sema.go.html#1704010">root</a></span><span class="op" id="1704309">.</span><span class="ident" id="1704310"><a href="/gostd/runtime/sema.go.html#1702475">nwait</a></span><span class="op" id="1704315">)</span>&nbsp;<span class="op" id="1704317">==</span>&nbsp;<span class="num" id="1704320">0</span>&nbsp;<span class="op" id="1704322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1704326">//&nbsp;The&nbsp;count&nbsp;is&nbsp;already&nbsp;consumed&nbsp;by&nbsp;another&nbsp;goroutine,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1704383">//&nbsp;so&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;up&nbsp;another&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1704429"><a href="/gostd/runtime/lock_futex.go.html#1586629">unlock</a></span><span class="op" id="1704435">(</span><span class="op" id="1704436">&amp;</span><span class="ident" id="1704437"><a href="/gostd/runtime/sema.go.html#1704010">root</a></span><span class="op" id="1704441">.</span><span class="ident" id="1704442"><a href="/gostd/runtime/sema.go.html#1702434">lock</a></span><span class="op" id="1704446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1704450">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1704458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1704461">s</span>&nbsp;<span class="op" id="1704463">:=</span>&nbsp;<span class="ident" id="1704466"><a href="/gostd/runtime/sema.go.html#1704010">root</a></span><span class="op" id="1704470">.</span><span class="ident" id="1704471"><a href="/gostd/runtime/sema.go.html#1702447">head</a></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1704477">for</span>&nbsp;<span class="op" id="1704481">;</span>&nbsp;<span class="ident" id="1704483"><a href="/gostd/runtime/sema.go.html#1704461">s</a></span>&nbsp;<span class="op" id="1704485">!=</span>&nbsp;<span class="builtintype" id="1704488">nil</span><span class="op" id="1704491">;</span>&nbsp;<span class="ident" id="1704493"><a href="/gostd/runtime/sema.go.html#1704461">s</a></span>&nbsp;<span class="op" id="1704495">=</span>&nbsp;<span class="ident" id="1704497"><a href="/gostd/runtime/sema.go.html#1704461">s</a></span><span class="op" id="1704498">.</span><span class="ident" id="1704499"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span>&nbsp;<span class="op" id="1704504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1704508">if</span>&nbsp;<span class="ident" id="1704511"><a href="/gostd/runtime/sema.go.html#1704461">s</a></span><span class="op" id="1704512">.</span><span class="ident" id="1704513"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786817">elem</a></span>&nbsp;<span class="op" id="1704518">==</span>&nbsp;<span class="ident" id="1704521"><a href="/gostd/runtime/sema.go.html#1702357">unsafe</a></span><span class="op" id="1704527">.</span><span class="ident" id="1704528">Pointer</span><span class="op" id="1704535">(</span><span class="ident" id="1704536"><a href="/gostd/runtime/sema.go.html#1703993">addr</a></span><span class="op" id="1704540">)</span>&nbsp;<span class="op" id="1704542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1704547"><a href="/gostd/runtime/atomic.go.html#1480948">xadd</a></span><span class="op" id="1704551">(</span><span class="op" id="1704552">&amp;</span><span class="ident" id="1704553"><a href="/gostd/runtime/sema.go.html#1704010">root</a></span><span class="op" id="1704557">.</span><span class="ident" id="1704558"><a href="/gostd/runtime/sema.go.html#1702475">nwait</a></span><span class="op" id="1704563">,</span>&nbsp;<span class="op" id="1704565">-</span><span class="num" id="1704566">1</span><span class="op" id="1704567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1704572"><a href="/gostd/runtime/sema.go.html#1704010">root</a></span><span class="op" id="1704576">.</span><span class="ident" id="1704577"><a href="/gostd/runtime/sema.go.html#1705233">dequeue</a></span><span class="op" id="1704584">(</span><span class="ident" id="1704585"><a href="/gostd/runtime/sema.go.html#1704461">s</a></span><span class="op" id="1704586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1704591">break</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1704599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1704602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1704605"><a href="/gostd/runtime/lock_futex.go.html#1586629">unlock</a></span><span class="op" id="1704611">(</span><span class="op" id="1704612">&amp;</span><span class="ident" id="1704613"><a href="/gostd/runtime/sema.go.html#1704010">root</a></span><span class="op" id="1704617">.</span><span class="ident" id="1704618"><a href="/gostd/runtime/sema.go.html#1702434">lock</a></span><span class="op" id="1704622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1704625">if</span>&nbsp;<span class="ident" id="1704628"><a href="/gostd/runtime/sema.go.html#1704461">s</a></span>&nbsp;<span class="op" id="1704630">!=</span>&nbsp;<span class="builtintype" id="1704633">nil</span>&nbsp;<span class="op" id="1704637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1704641">if</span>&nbsp;<span class="ident" id="1704644"><a href="/gostd/runtime/sema.go.html#1704461">s</a></span><span class="op" id="1704645">.</span><span class="ident" id="1704646"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786838">releasetime</a></span>&nbsp;<span class="op" id="1704658">!=</span>&nbsp;<span class="num" id="1704661">0</span>&nbsp;<span class="op" id="1704663">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1704668"><a href="/gostd/runtime/sema.go.html#1704461">s</a></span><span class="op" id="1704669">.</span><span class="ident" id="1704670"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786838">releasetime</a></span>&nbsp;<span class="op" id="1704682">=</span>&nbsp;<span class="ident" id="1704684"><a href="/gostd/runtime/stubs.go.html#1744144">cputicks</a></span><span class="op" id="1704692">(</span><span class="op" id="1704693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1704697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1704701"><a href="/gostd/runtime/proc.go.html#1673919">goready</a></span><span class="op" id="1704708">(</span><span class="ident" id="1704709"><a href="/gostd/runtime/sema.go.html#1704461">s</a></span><span class="op" id="1704710">.</span><span class="ident" id="1704711"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786765">g</a></span><span class="op" id="1704712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1704715">}</span><br>
<span class="lineno"></span><span class="op" id="1704717">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="1704720">func</span>&nbsp;<span class="ident" id="1704725">semroot</span><span class="op" id="1704732">(</span><span class="ident" id="1704733">addr</span>&nbsp;<span class="op" id="1704738">*</span><span class="builtintype" id="1704739">uint32</span><span class="op" id="1704745">)</span>&nbsp;<span class="op" id="1704747">*</span><span class="ident" id="1704748"><a href="/gostd/runtime/sema.go.html#1702415">semaRoot</a></span>&nbsp;<span class="op" id="1704757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1704760">return</span>&nbsp;<span class="op" id="1704767">&amp;</span><span class="ident" id="1704768"><a href="/gostd/runtime/sema.go.html#1702610">semtable</a></span><span class="op" id="1704776">[</span><span class="op" id="1704777">(</span><span class="builtintype" id="1704778">uintptr</span><span class="op" id="1704785">(</span><span class="ident" id="1704786"><a href="/gostd/runtime/sema.go.html#1702357">unsafe</a></span><span class="op" id="1704792">.</span><span class="ident" id="1704793">Pointer</span><span class="op" id="1704800">(</span><span class="ident" id="1704801"><a href="/gostd/runtime/sema.go.html#1704733">addr</a></span><span class="op" id="1704805">)</span><span class="op" id="1704806">)</span><span class="op" id="1704807">&gt;&gt;</span><span class="num" id="1704809">3</span><span class="op" id="1704810">)</span><span class="op" id="1704811">%</span><span class="ident" id="1704812"><a href="/gostd/runtime/sema.go.html#1702588">semTabSize</a></span><span class="op" id="1704822">]</span><span class="op" id="1704823">.</span><span class="ident" id="1704824"><a href="/gostd/runtime/sema.go.html#1702641">root</a></span><br>
<span class="lineno"></span><span class="op" id="1704829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="1704832">func</span>&nbsp;<span class="ident" id="1704837">cansemacquire</span><span class="op" id="1704850">(</span><span class="ident" id="1704851">addr</span>&nbsp;<span class="op" id="1704856">*</span><span class="builtintype" id="1704857">uint32</span><span class="op" id="1704863">)</span>&nbsp;<span class="builtintype" id="1704865">bool</span>&nbsp;<span class="op" id="1704870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1704873">for</span>&nbsp;<span class="op" id="1704877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1704881">v</span>&nbsp;<span class="op" id="1704883">:=</span>&nbsp;<span class="ident" id="1704886"><a href="/gostd/runtime/atomic.go.html#1481330">atomicload</a></span><span class="op" id="1704896">(</span><span class="ident" id="1704897"><a href="/gostd/runtime/sema.go.html#1704851">addr</a></span><span class="op" id="1704901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1704905">if</span>&nbsp;<span class="ident" id="1704908"><a href="/gostd/runtime/sema.go.html#1704881">v</a></span>&nbsp;<span class="op" id="1704910">==</span>&nbsp;<span class="num" id="1704913">0</span>&nbsp;<span class="op" id="1704915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1704920">return</span>&nbsp;<span class="builtintype" id="1704927">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1704935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1704939">if</span>&nbsp;<span class="ident" id="1704942"><a href="/gostd/runtime/stubs.go.html#1744744">cas</a></span><span class="op" id="1704945">(</span><span class="ident" id="1704946"><a href="/gostd/runtime/sema.go.html#1704851">addr</a></span><span class="op" id="1704950">,</span>&nbsp;<span class="ident" id="1704952"><a href="/gostd/runtime/sema.go.html#1704881">v</a></span><span class="op" id="1704953">,</span>&nbsp;<span class="ident" id="1704955"><a href="/gostd/runtime/sema.go.html#1704881">v</a></span><span class="op" id="1704956">-</span><span class="num" id="1704957">1</span><span class="op" id="1704958">)</span>&nbsp;<span class="op" id="1704960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1704965">return</span>&nbsp;<span class="builtintype" id="1704972">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1704979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1704982">}</span><br>
<span class="lineno">150</span><span class="op" id="1704984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1704987">func</span>&nbsp;<span class="op" id="1704992">(</span><span class="ident" id="1704993">root</span>&nbsp;<span class="op" id="1704998">*</span><span class="ident" id="1704999"><a href="/gostd/runtime/sema.go.html#1702415">semaRoot</a></span><span class="op" id="1705007">)</span>&nbsp;<span class="ident" id="1705009">queue</span><span class="op" id="1705014">(</span><span class="ident" id="1705015">addr</span>&nbsp;<span class="op" id="1705020">*</span><span class="builtintype" id="1705021">uint32</span><span class="op" id="1705027">,</span>&nbsp;<span class="ident" id="1705029">s</span>&nbsp;<span class="op" id="1705031">*</span><span class="ident" id="1705032"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786749">sudog</a></span><span class="op" id="1705037">)</span>&nbsp;<span class="op" id="1705039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705042"><a href="/gostd/runtime/sema.go.html#1705029">s</a></span><span class="op" id="1705043">.</span><span class="ident" id="1705044"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786765">g</a></span>&nbsp;<span class="op" id="1705046">=</span>&nbsp;<span class="ident" id="1705048"><a href="/gostd/runtime/stubs.go.html#1738919">getg</a></span><span class="op" id="1705052">(</span><span class="op" id="1705053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705056"><a href="/gostd/runtime/sema.go.html#1705029">s</a></span><span class="op" id="1705057">.</span><span class="ident" id="1705058"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786817">elem</a></span>&nbsp;<span class="op" id="1705063">=</span>&nbsp;<span class="ident" id="1705065"><a href="/gostd/runtime/sema.go.html#1702357">unsafe</a></span><span class="op" id="1705071">.</span><span class="ident" id="1705072">Pointer</span><span class="op" id="1705079">(</span><span class="ident" id="1705080"><a href="/gostd/runtime/sema.go.html#1705015">addr</a></span><span class="op" id="1705084">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705087"><a href="/gostd/runtime/sema.go.html#1705029">s</a></span><span class="op" id="1705088">.</span><span class="ident" id="1705089"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span>&nbsp;<span class="op" id="1705094">=</span>&nbsp;<span class="builtintype" id="1705096">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705101"><a href="/gostd/runtime/sema.go.html#1705029">s</a></span><span class="op" id="1705102">.</span><span class="ident" id="1705103"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786804">prev</a></span>&nbsp;<span class="op" id="1705108">=</span>&nbsp;<span class="ident" id="1705110"><a href="/gostd/runtime/sema.go.html#1704993">root</a></span><span class="op" id="1705114">.</span><span class="ident" id="1705115"><a href="/gostd/runtime/sema.go.html#1702461">tail</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1705121">if</span>&nbsp;<span class="ident" id="1705124"><a href="/gostd/runtime/sema.go.html#1704993">root</a></span><span class="op" id="1705128">.</span><span class="ident" id="1705129"><a href="/gostd/runtime/sema.go.html#1702461">tail</a></span>&nbsp;<span class="op" id="1705134">!=</span>&nbsp;<span class="builtintype" id="1705137">nil</span>&nbsp;<span class="op" id="1705141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705145"><a href="/gostd/runtime/sema.go.html#1704993">root</a></span><span class="op" id="1705149">.</span><span class="ident" id="1705150"><a href="/gostd/runtime/sema.go.html#1702461">tail</a></span><span class="op" id="1705154">.</span><span class="ident" id="1705155"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span>&nbsp;<span class="op" id="1705160">=</span>&nbsp;<span class="ident" id="1705162"><a href="/gostd/runtime/sema.go.html#1705029">s</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1705165">}</span>&nbsp;<span class="keyword" id="1705167">else</span>&nbsp;<span class="op" id="1705172">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705176"><a href="/gostd/runtime/sema.go.html#1704993">root</a></span><span class="op" id="1705180">.</span><span class="ident" id="1705181"><a href="/gostd/runtime/sema.go.html#1702447">head</a></span>&nbsp;<span class="op" id="1705186">=</span>&nbsp;<span class="ident" id="1705188"><a href="/gostd/runtime/sema.go.html#1705029">s</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1705191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705194"><a href="/gostd/runtime/sema.go.html#1704993">root</a></span><span class="op" id="1705198">.</span><span class="ident" id="1705199"><a href="/gostd/runtime/sema.go.html#1702461">tail</a></span>&nbsp;<span class="op" id="1705204">=</span>&nbsp;<span class="ident" id="1705206"><a href="/gostd/runtime/sema.go.html#1705029">s</a></span><br>
<span class="lineno"></span><span class="op" id="1705208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="1705211">func</span>&nbsp;<span class="op" id="1705216">(</span><span class="ident" id="1705217">root</span>&nbsp;<span class="op" id="1705222">*</span><span class="ident" id="1705223"><a href="/gostd/runtime/sema.go.html#1702415">semaRoot</a></span><span class="op" id="1705231">)</span>&nbsp;<span class="ident" id="1705233">dequeue</span><span class="op" id="1705240">(</span><span class="ident" id="1705241">s</span>&nbsp;<span class="op" id="1705243">*</span><span class="ident" id="1705244"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786749">sudog</a></span><span class="op" id="1705249">)</span>&nbsp;<span class="op" id="1705251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1705254">if</span>&nbsp;<span class="ident" id="1705257"><a href="/gostd/runtime/sema.go.html#1705241">s</a></span><span class="op" id="1705258">.</span><span class="ident" id="1705259"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span>&nbsp;<span class="op" id="1705264">!=</span>&nbsp;<span class="builtintype" id="1705267">nil</span>&nbsp;<span class="op" id="1705271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705275"><a href="/gostd/runtime/sema.go.html#1705241">s</a></span><span class="op" id="1705276">.</span><span class="ident" id="1705277"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span><span class="op" id="1705281">.</span><span class="ident" id="1705282"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786804">prev</a></span>&nbsp;<span class="op" id="1705287">=</span>&nbsp;<span class="ident" id="1705289"><a href="/gostd/runtime/sema.go.html#1705241">s</a></span><span class="op" id="1705290">.</span><span class="ident" id="1705291"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786804">prev</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1705297">}</span>&nbsp;<span class="keyword" id="1705299">else</span>&nbsp;<span class="op" id="1705304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705308"><a href="/gostd/runtime/sema.go.html#1705217">root</a></span><span class="op" id="1705312">.</span><span class="ident" id="1705313"><a href="/gostd/runtime/sema.go.html#1702461">tail</a></span>&nbsp;<span class="op" id="1705318">=</span>&nbsp;<span class="ident" id="1705320"><a href="/gostd/runtime/sema.go.html#1705241">s</a></span><span class="op" id="1705321">.</span><span class="ident" id="1705322"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786804">prev</a></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1705328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1705331">if</span>&nbsp;<span class="ident" id="1705334"><a href="/gostd/runtime/sema.go.html#1705241">s</a></span><span class="op" id="1705335">.</span><span class="ident" id="1705336"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786804">prev</a></span>&nbsp;<span class="op" id="1705341">!=</span>&nbsp;<span class="builtintype" id="1705344">nil</span>&nbsp;<span class="op" id="1705348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705352"><a href="/gostd/runtime/sema.go.html#1705241">s</a></span><span class="op" id="1705353">.</span><span class="ident" id="1705354"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786804">prev</a></span><span class="op" id="1705358">.</span><span class="ident" id="1705359"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span>&nbsp;<span class="op" id="1705364">=</span>&nbsp;<span class="ident" id="1705366"><a href="/gostd/runtime/sema.go.html#1705241">s</a></span><span class="op" id="1705367">.</span><span class="ident" id="1705368"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1705374">}</span>&nbsp;<span class="keyword" id="1705376">else</span>&nbsp;<span class="op" id="1705381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705385"><a href="/gostd/runtime/sema.go.html#1705217">root</a></span><span class="op" id="1705389">.</span><span class="ident" id="1705390"><a href="/gostd/runtime/sema.go.html#1702447">head</a></span>&nbsp;<span class="op" id="1705395">=</span>&nbsp;<span class="ident" id="1705397"><a href="/gostd/runtime/sema.go.html#1705241">s</a></span><span class="op" id="1705398">.</span><span class="ident" id="1705399"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1705405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705408"><a href="/gostd/runtime/sema.go.html#1705241">s</a></span><span class="op" id="1705409">.</span><span class="ident" id="1705410"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786817">elem</a></span>&nbsp;<span class="op" id="1705415">=</span>&nbsp;<span class="builtintype" id="1705417">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705422"><a href="/gostd/runtime/sema.go.html#1705241">s</a></span><span class="op" id="1705423">.</span><span class="ident" id="1705424"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span>&nbsp;<span class="op" id="1705429">=</span>&nbsp;<span class="builtintype" id="1705431">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705436"><a href="/gostd/runtime/sema.go.html#1705241">s</a></span><span class="op" id="1705437">.</span><span class="ident" id="1705438"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786804">prev</a></span>&nbsp;<span class="op" id="1705443">=</span>&nbsp;<span class="builtintype" id="1705445">nil</span><br>
<span class="lineno"></span><span class="op" id="1705449">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="1705452">//&nbsp;Synchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Cond.</span><br>
<span class="lineno"></span><span class="keyword" id="1705492">type</span>&nbsp;<span class="ident" id="1705497">syncSema</span>&nbsp;<span class="keyword" id="1705506">struct</span>&nbsp;<span class="op" id="1705513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705516">lock</span>&nbsp;<span class="ident" id="1705521"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786208">mutex</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705528">head</span>&nbsp;<span class="op" id="1705533">*</span><span class="ident" id="1705534"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786749">sudog</a></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705541">tail</span>&nbsp;<span class="op" id="1705546">*</span><span class="ident" id="1705547"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786749">sudog</a></span><br>
<span class="lineno"></span><span class="op" id="1705553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1705556">//&nbsp;Syncsemacquire&nbsp;waits&nbsp;for&nbsp;a&nbsp;pairing&nbsp;syncsemrelease&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1705634">func</span>&nbsp;<span class="ident" id="1705639">syncsemacquire</span><span class="op" id="1705653">(</span><span class="ident" id="1705654">s</span>&nbsp;<span class="op" id="1705656">*</span><span class="ident" id="1705657"><a href="/gostd/runtime/sema.go.html#1705497">syncSema</a></span><span class="op" id="1705665">)</span>&nbsp;<span class="op" id="1705667">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705670"><a href="/gostd/runtime/lock_futex.go.html#1585337">lock</a></span><span class="op" id="1705674">(</span><span class="op" id="1705675">&amp;</span><span class="ident" id="1705676"><a href="/gostd/runtime/sema.go.html#1705654">s</a></span><span class="op" id="1705677">.</span><span class="ident" id="1705678"><a href="/gostd/runtime/sema.go.html#1705516">lock</a></span><span class="op" id="1705682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1705685">if</span>&nbsp;<span class="ident" id="1705688"><a href="/gostd/runtime/sema.go.html#1705654">s</a></span><span class="op" id="1705689">.</span><span class="ident" id="1705690"><a href="/gostd/runtime/sema.go.html#1705528">head</a></span>&nbsp;<span class="op" id="1705695">!=</span>&nbsp;<span class="builtintype" id="1705698">nil</span>&nbsp;<span class="op" id="1705702">&amp;&amp;</span>&nbsp;<span class="ident" id="1705705"><a href="/gostd/runtime/sema.go.html#1705654">s</a></span><span class="op" id="1705706">.</span><span class="ident" id="1705707"><a href="/gostd/runtime/sema.go.html#1705528">head</a></span><span class="op" id="1705711">.</span><span class="ident" id="1705712"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786857">nrelease</a></span>&nbsp;<span class="op" id="1705721">&gt;</span>&nbsp;<span class="num" id="1705723">0</span>&nbsp;<span class="op" id="1705725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1705729">//&nbsp;Have&nbsp;pending&nbsp;release,&nbsp;consume&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1705768">var</span>&nbsp;<span class="ident" id="1705772">wake</span>&nbsp;<span class="op" id="1705777">*</span><span class="ident" id="1705778"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786749">sudog</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705786"><a href="/gostd/runtime/sema.go.html#1705654">s</a></span><span class="op" id="1705787">.</span><span class="ident" id="1705788"><a href="/gostd/runtime/sema.go.html#1705528">head</a></span><span class="op" id="1705792">.</span><span class="ident" id="1705793"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786857">nrelease</a></span><span class="op" id="1705801">--</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1705806">if</span>&nbsp;<span class="ident" id="1705809"><a href="/gostd/runtime/sema.go.html#1705654">s</a></span><span class="op" id="1705810">.</span><span class="ident" id="1705811"><a href="/gostd/runtime/sema.go.html#1705528">head</a></span><span class="op" id="1705815">.</span><span class="ident" id="1705816"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786857">nrelease</a></span>&nbsp;<span class="op" id="1705825">==</span>&nbsp;<span class="num" id="1705828">0</span>&nbsp;<span class="op" id="1705830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705835"><a href="/gostd/runtime/sema.go.html#1705772">wake</a></span>&nbsp;<span class="op" id="1705840">=</span>&nbsp;<span class="ident" id="1705842"><a href="/gostd/runtime/sema.go.html#1705654">s</a></span><span class="op" id="1705843">.</span><span class="ident" id="1705844"><a href="/gostd/runtime/sema.go.html#1705528">head</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705852"><a href="/gostd/runtime/sema.go.html#1705654">s</a></span><span class="op" id="1705853">.</span><span class="ident" id="1705854"><a href="/gostd/runtime/sema.go.html#1705528">head</a></span>&nbsp;<span class="op" id="1705859">=</span>&nbsp;<span class="ident" id="1705861"><a href="/gostd/runtime/sema.go.html#1705772">wake</a></span><span class="op" id="1705865">.</span><span class="ident" id="1705866"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1705874">if</span>&nbsp;<span class="ident" id="1705877"><a href="/gostd/runtime/sema.go.html#1705654">s</a></span><span class="op" id="1705878">.</span><span class="ident" id="1705879"><a href="/gostd/runtime/sema.go.html#1705528">head</a></span>&nbsp;<span class="op" id="1705884">==</span>&nbsp;<span class="builtintype" id="1705887">nil</span>&nbsp;<span class="op" id="1705891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705897"><a href="/gostd/runtime/sema.go.html#1705654">s</a></span><span class="op" id="1705898">.</span><span class="ident" id="1705899"><a href="/gostd/runtime/sema.go.html#1705541">tail</a></span>&nbsp;<span class="op" id="1705904">=</span>&nbsp;<span class="builtintype" id="1705906">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1705913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1705917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705921"><a href="/gostd/runtime/lock_futex.go.html#1586629">unlock</a></span><span class="op" id="1705927">(</span><span class="op" id="1705928">&amp;</span><span class="ident" id="1705929"><a href="/gostd/runtime/sema.go.html#1705654">s</a></span><span class="op" id="1705930">.</span><span class="ident" id="1705931"><a href="/gostd/runtime/sema.go.html#1705516">lock</a></span><span class="op" id="1705935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1705939">if</span>&nbsp;<span class="ident" id="1705942"><a href="/gostd/runtime/sema.go.html#1705772">wake</a></span>&nbsp;<span class="op" id="1705947">!=</span>&nbsp;<span class="builtintype" id="1705950">nil</span>&nbsp;<span class="op" id="1705954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705959"><a href="/gostd/runtime/sema.go.html#1705772">wake</a></span><span class="op" id="1705963">.</span><span class="ident" id="1705964"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span>&nbsp;<span class="op" id="1705969">=</span>&nbsp;<span class="builtintype" id="1705971">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1705978"><a href="/gostd/runtime/proc.go.html#1673919">goready</a></span><span class="op" id="1705985">(</span><span class="ident" id="1705986"><a href="/gostd/runtime/sema.go.html#1705772">wake</a></span><span class="op" id="1705990">.</span><span class="ident" id="1705991"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786765">g</a></span><span class="op" id="1705992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1705996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1705999">}</span>&nbsp;<span class="keyword" id="1706001">else</span>&nbsp;<span class="op" id="1706006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1706010">//&nbsp;Enqueue&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706031">w</span>&nbsp;<span class="op" id="1706033">:=</span>&nbsp;<span class="ident" id="1706036"><a href="/gostd/runtime/proc.go.html#1674038">acquireSudog</a></span><span class="op" id="1706048">(</span><span class="op" id="1706049">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706053"><a href="/gostd/runtime/sema.go.html#1706031">w</a></span><span class="op" id="1706054">.</span><span class="ident" id="1706055"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786765">g</a></span>&nbsp;<span class="op" id="1706057">=</span>&nbsp;<span class="ident" id="1706059"><a href="/gostd/runtime/stubs.go.html#1738919">getg</a></span><span class="op" id="1706063">(</span><span class="op" id="1706064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706068"><a href="/gostd/runtime/sema.go.html#1706031">w</a></span><span class="op" id="1706069">.</span><span class="ident" id="1706070"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786857">nrelease</a></span>&nbsp;<span class="op" id="1706079">=</span>&nbsp;<span class="op" id="1706081">-</span><span class="num" id="1706082">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706086"><a href="/gostd/runtime/sema.go.html#1706031">w</a></span><span class="op" id="1706087">.</span><span class="ident" id="1706088"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span>&nbsp;<span class="op" id="1706093">=</span>&nbsp;<span class="builtintype" id="1706095">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706101"><a href="/gostd/runtime/sema.go.html#1706031">w</a></span><span class="op" id="1706102">.</span><span class="ident" id="1706103"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786838">releasetime</a></span>&nbsp;<span class="op" id="1706115">=</span>&nbsp;<span class="num" id="1706117">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706121">t0</span>&nbsp;<span class="op" id="1706124">:=</span>&nbsp;<span class="builtintype" id="1706127">int64</span><span class="op" id="1706132">(</span><span class="num" id="1706133">0</span><span class="op" id="1706134">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1706138">if</span>&nbsp;<span class="ident" id="1706141"><a href="/gostd/runtime/mprof.go.html#1626211">blockprofilerate</a></span>&nbsp;<span class="op" id="1706158">&gt;</span>&nbsp;<span class="num" id="1706160">0</span>&nbsp;<span class="op" id="1706162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706167"><a href="/gostd/runtime/sema.go.html#1706121">t0</a></span>&nbsp;<span class="op" id="1706170">=</span>&nbsp;<span class="ident" id="1706172"><a href="/gostd/runtime/stubs.go.html#1744144">cputicks</a></span><span class="op" id="1706180">(</span><span class="op" id="1706181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706186"><a href="/gostd/runtime/sema.go.html#1706031">w</a></span><span class="op" id="1706187">.</span><span class="ident" id="1706188"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786838">releasetime</a></span>&nbsp;<span class="op" id="1706200">=</span>&nbsp;<span class="op" id="1706202">-</span><span class="num" id="1706203">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1706207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1706211">if</span>&nbsp;<span class="ident" id="1706214"><a href="/gostd/runtime/sema.go.html#1705654">s</a></span><span class="op" id="1706215">.</span><span class="ident" id="1706216"><a href="/gostd/runtime/sema.go.html#1705541">tail</a></span>&nbsp;<span class="op" id="1706221">==</span>&nbsp;<span class="builtintype" id="1706224">nil</span>&nbsp;<span class="op" id="1706228">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706233"><a href="/gostd/runtime/sema.go.html#1705654">s</a></span><span class="op" id="1706234">.</span><span class="ident" id="1706235"><a href="/gostd/runtime/sema.go.html#1705528">head</a></span>&nbsp;<span class="op" id="1706240">=</span>&nbsp;<span class="ident" id="1706242"><a href="/gostd/runtime/sema.go.html#1706031">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1706246">}</span>&nbsp;<span class="keyword" id="1706248">else</span>&nbsp;<span class="op" id="1706253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706258"><a href="/gostd/runtime/sema.go.html#1705654">s</a></span><span class="op" id="1706259">.</span><span class="ident" id="1706260"><a href="/gostd/runtime/sema.go.html#1705541">tail</a></span><span class="op" id="1706264">.</span><span class="ident" id="1706265"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span>&nbsp;<span class="op" id="1706270">=</span>&nbsp;<span class="ident" id="1706272"><a href="/gostd/runtime/sema.go.html#1706031">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1706276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706280"><a href="/gostd/runtime/sema.go.html#1705654">s</a></span><span class="op" id="1706281">.</span><span class="ident" id="1706282"><a href="/gostd/runtime/sema.go.html#1705541">tail</a></span>&nbsp;<span class="op" id="1706287">=</span>&nbsp;<span class="ident" id="1706289"><a href="/gostd/runtime/sema.go.html#1706031">w</a></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706293"><a href="/gostd/runtime/proc.go.html#1673799">goparkunlock</a></span><span class="op" id="1706305">(</span><span class="op" id="1706306">&amp;</span><span class="ident" id="1706307"><a href="/gostd/runtime/sema.go.html#1705654">s</a></span><span class="op" id="1706308">.</span><span class="ident" id="1706309"><a href="/gostd/runtime/sema.go.html#1705516">lock</a></span><span class="op" id="1706313">,</span>&nbsp;<span class="string" id="1706315">&#34;semacquire&#34;</span><span class="op" id="1706327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1706331">if</span>&nbsp;<span class="ident" id="1706334"><a href="/gostd/runtime/sema.go.html#1706121">t0</a></span>&nbsp;<span class="op" id="1706337">!=</span>&nbsp;<span class="num" id="1706340">0</span>&nbsp;<span class="op" id="1706342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706347"><a href="/gostd/runtime/mprof.go.html#1626994">blockevent</a></span><span class="op" id="1706357">(</span><span class="builtintype" id="1706358">int64</span><span class="op" id="1706363">(</span><span class="ident" id="1706364"><a href="/gostd/runtime/sema.go.html#1706031">w</a></span><span class="op" id="1706365">.</span><span class="ident" id="1706366"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786838">releasetime</a></span><span class="op" id="1706377">)</span><span class="op" id="1706378">-</span><span class="ident" id="1706379"><a href="/gostd/runtime/sema.go.html#1706121">t0</a></span><span class="op" id="1706381">,</span>&nbsp;<span class="num" id="1706383">2</span><span class="op" id="1706384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1706388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706392"><a href="/gostd/runtime/proc.go.html#1674768">releaseSudog</a></span><span class="op" id="1706404">(</span><span class="ident" id="1706405"><a href="/gostd/runtime/sema.go.html#1706031">w</a></span><span class="op" id="1706406">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1706409">}</span><br>
<span class="lineno"></span><span class="op" id="1706411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1706414">//&nbsp;Syncsemrelease&nbsp;waits&nbsp;for&nbsp;n&nbsp;pairing&nbsp;syncsemacquire&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1706492">func</span>&nbsp;<span class="ident" id="1706497">syncsemrelease</span><span class="op" id="1706511">(</span><span class="ident" id="1706512">s</span>&nbsp;<span class="op" id="1706514">*</span><span class="ident" id="1706515"><a href="/gostd/runtime/sema.go.html#1705497">syncSema</a></span><span class="op" id="1706523">,</span>&nbsp;<span class="ident" id="1706525">n</span>&nbsp;<span class="builtintype" id="1706527">uint32</span><span class="op" id="1706533">)</span>&nbsp;<span class="op" id="1706535">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706538"><a href="/gostd/runtime/lock_futex.go.html#1585337">lock</a></span><span class="op" id="1706542">(</span><span class="op" id="1706543">&amp;</span><span class="ident" id="1706544"><a href="/gostd/runtime/sema.go.html#1706512">s</a></span><span class="op" id="1706545">.</span><span class="ident" id="1706546"><a href="/gostd/runtime/sema.go.html#1705516">lock</a></span><span class="op" id="1706550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1706553">for</span>&nbsp;<span class="ident" id="1706557"><a href="/gostd/runtime/sema.go.html#1706525">n</a></span>&nbsp;<span class="op" id="1706559">&gt;</span>&nbsp;<span class="num" id="1706561">0</span>&nbsp;<span class="op" id="1706563">&amp;&amp;</span>&nbsp;<span class="ident" id="1706566"><a href="/gostd/runtime/sema.go.html#1706512">s</a></span><span class="op" id="1706567">.</span><span class="ident" id="1706568"><a href="/gostd/runtime/sema.go.html#1705528">head</a></span>&nbsp;<span class="op" id="1706573">!=</span>&nbsp;<span class="builtintype" id="1706576">nil</span>&nbsp;<span class="op" id="1706580">&amp;&amp;</span>&nbsp;<span class="ident" id="1706583"><a href="/gostd/runtime/sema.go.html#1706512">s</a></span><span class="op" id="1706584">.</span><span class="ident" id="1706585"><a href="/gostd/runtime/sema.go.html#1705528">head</a></span><span class="op" id="1706589">.</span><span class="ident" id="1706590"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786857">nrelease</a></span>&nbsp;<span class="op" id="1706599">&lt;</span>&nbsp;<span class="num" id="1706601">0</span>&nbsp;<span class="op" id="1706603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1706607">//&nbsp;Have&nbsp;pending&nbsp;acquire,&nbsp;satisfy&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706646">wake</span>&nbsp;<span class="op" id="1706651">:=</span>&nbsp;<span class="ident" id="1706654"><a href="/gostd/runtime/sema.go.html#1706512">s</a></span><span class="op" id="1706655">.</span><span class="ident" id="1706656"><a href="/gostd/runtime/sema.go.html#1705528">head</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706663"><a href="/gostd/runtime/sema.go.html#1706512">s</a></span><span class="op" id="1706664">.</span><span class="ident" id="1706665"><a href="/gostd/runtime/sema.go.html#1705528">head</a></span>&nbsp;<span class="op" id="1706670">=</span>&nbsp;<span class="ident" id="1706672"><a href="/gostd/runtime/sema.go.html#1706646">wake</a></span><span class="op" id="1706676">.</span><span class="ident" id="1706677"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1706684">if</span>&nbsp;<span class="ident" id="1706687"><a href="/gostd/runtime/sema.go.html#1706512">s</a></span><span class="op" id="1706688">.</span><span class="ident" id="1706689"><a href="/gostd/runtime/sema.go.html#1705528">head</a></span>&nbsp;<span class="op" id="1706694">==</span>&nbsp;<span class="builtintype" id="1706697">nil</span>&nbsp;<span class="op" id="1706701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706706"><a href="/gostd/runtime/sema.go.html#1706512">s</a></span><span class="op" id="1706707">.</span><span class="ident" id="1706708"><a href="/gostd/runtime/sema.go.html#1705541">tail</a></span>&nbsp;<span class="op" id="1706713">=</span>&nbsp;<span class="builtintype" id="1706715">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1706721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1706725">if</span>&nbsp;<span class="ident" id="1706728"><a href="/gostd/runtime/sema.go.html#1706646">wake</a></span><span class="op" id="1706732">.</span><span class="ident" id="1706733"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786838">releasetime</a></span>&nbsp;<span class="op" id="1706745">!=</span>&nbsp;<span class="num" id="1706748">0</span>&nbsp;<span class="op" id="1706750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706755"><a href="/gostd/runtime/sema.go.html#1706646">wake</a></span><span class="op" id="1706759">.</span><span class="ident" id="1706760"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786838">releasetime</a></span>&nbsp;<span class="op" id="1706772">=</span>&nbsp;<span class="ident" id="1706774"><a href="/gostd/runtime/stubs.go.html#1744144">cputicks</a></span><span class="op" id="1706782">(</span><span class="op" id="1706783">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1706787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706791"><a href="/gostd/runtime/sema.go.html#1706646">wake</a></span><span class="op" id="1706795">.</span><span class="ident" id="1706796"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span>&nbsp;<span class="op" id="1706801">=</span>&nbsp;<span class="builtintype" id="1706803">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706809"><a href="/gostd/runtime/proc.go.html#1673919">goready</a></span><span class="op" id="1706816">(</span><span class="ident" id="1706817"><a href="/gostd/runtime/sema.go.html#1706646">wake</a></span><span class="op" id="1706821">.</span><span class="ident" id="1706822"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786765">g</a></span><span class="op" id="1706823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706827"><a href="/gostd/runtime/sema.go.html#1706525">n</a></span><span class="op" id="1706828">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1706832">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1706835">if</span>&nbsp;<span class="ident" id="1706838"><a href="/gostd/runtime/sema.go.html#1706525">n</a></span>&nbsp;<span class="op" id="1706840">&gt;</span>&nbsp;<span class="num" id="1706842">0</span>&nbsp;<span class="op" id="1706844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1706848">//&nbsp;enqueue&nbsp;itself</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706868">w</span>&nbsp;<span class="op" id="1706870">:=</span>&nbsp;<span class="ident" id="1706873"><a href="/gostd/runtime/proc.go.html#1674038">acquireSudog</a></span><span class="op" id="1706885">(</span><span class="op" id="1706886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706890"><a href="/gostd/runtime/sema.go.html#1706868">w</a></span><span class="op" id="1706891">.</span><span class="ident" id="1706892"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786765">g</a></span>&nbsp;<span class="op" id="1706894">=</span>&nbsp;<span class="ident" id="1706896"><a href="/gostd/runtime/stubs.go.html#1738919">getg</a></span><span class="op" id="1706900">(</span><span class="op" id="1706901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706905"><a href="/gostd/runtime/sema.go.html#1706868">w</a></span><span class="op" id="1706906">.</span><span class="ident" id="1706907"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786857">nrelease</a></span>&nbsp;<span class="op" id="1706916">=</span>&nbsp;<span class="builtintype" id="1706918">int32</span><span class="op" id="1706923">(</span><span class="ident" id="1706924"><a href="/gostd/runtime/sema.go.html#1706525">n</a></span><span class="op" id="1706925">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706929"><a href="/gostd/runtime/sema.go.html#1706868">w</a></span><span class="op" id="1706930">.</span><span class="ident" id="1706931"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span>&nbsp;<span class="op" id="1706936">=</span>&nbsp;<span class="builtintype" id="1706938">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706944"><a href="/gostd/runtime/sema.go.html#1706868">w</a></span><span class="op" id="1706945">.</span><span class="ident" id="1706946"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786838">releasetime</a></span>&nbsp;<span class="op" id="1706958">=</span>&nbsp;<span class="num" id="1706960">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1706964">if</span>&nbsp;<span class="ident" id="1706967"><a href="/gostd/runtime/sema.go.html#1706512">s</a></span><span class="op" id="1706968">.</span><span class="ident" id="1706969"><a href="/gostd/runtime/sema.go.html#1705541">tail</a></span>&nbsp;<span class="op" id="1706974">==</span>&nbsp;<span class="builtintype" id="1706977">nil</span>&nbsp;<span class="op" id="1706981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1706986"><a href="/gostd/runtime/sema.go.html#1706512">s</a></span><span class="op" id="1706987">.</span><span class="ident" id="1706988"><a href="/gostd/runtime/sema.go.html#1705528">head</a></span>&nbsp;<span class="op" id="1706993">=</span>&nbsp;<span class="ident" id="1706995"><a href="/gostd/runtime/sema.go.html#1706868">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1706999">}</span>&nbsp;<span class="keyword" id="1707001">else</span>&nbsp;<span class="op" id="1707006">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1707011"><a href="/gostd/runtime/sema.go.html#1706512">s</a></span><span class="op" id="1707012">.</span><span class="ident" id="1707013"><a href="/gostd/runtime/sema.go.html#1705541">tail</a></span><span class="op" id="1707017">.</span><span class="ident" id="1707018"><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html#1786791">next</a></span>&nbsp;<span class="op" id="1707023">=</span>&nbsp;<span class="ident" id="1707025"><a href="/gostd/runtime/sema.go.html#1706868">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1707029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1707033"><a href="/gostd/runtime/sema.go.html#1706512">s</a></span><span class="op" id="1707034">.</span><span class="ident" id="1707035"><a href="/gostd/runtime/sema.go.html#1705541">tail</a></span>&nbsp;<span class="op" id="1707040">=</span>&nbsp;<span class="ident" id="1707042"><a href="/gostd/runtime/sema.go.html#1706868">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1707046"><a href="/gostd/runtime/proc.go.html#1673799">goparkunlock</a></span><span class="op" id="1707058">(</span><span class="op" id="1707059">&amp;</span><span class="ident" id="1707060"><a href="/gostd/runtime/sema.go.html#1706512">s</a></span><span class="op" id="1707061">.</span><span class="ident" id="1707062"><a href="/gostd/runtime/sema.go.html#1705516">lock</a></span><span class="op" id="1707066">,</span>&nbsp;<span class="string" id="1707068">&#34;semarelease&#34;</span><span class="op" id="1707081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1707085"><a href="/gostd/runtime/proc.go.html#1674768">releaseSudog</a></span><span class="op" id="1707097">(</span><span class="ident" id="1707098"><a href="/gostd/runtime/sema.go.html#1706868">w</a></span><span class="op" id="1707099">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1707102">}</span>&nbsp;<span class="keyword" id="1707104">else</span>&nbsp;<span class="op" id="1707109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1707113"><a href="/gostd/runtime/lock_futex.go.html#1586629">unlock</a></span><span class="op" id="1707119">(</span><span class="op" id="1707120">&amp;</span><span class="ident" id="1707121"><a href="/gostd/runtime/sema.go.html#1706512">s</a></span><span class="op" id="1707122">.</span><span class="ident" id="1707123"><a href="/gostd/runtime/sema.go.html#1705516">lock</a></span><span class="op" id="1707127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1707130">}</span><br>
<span class="lineno"></span><span class="op" id="1707132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1707135">func</span>&nbsp;<span class="ident" id="1707140">syncsemcheck</span><span class="op" id="1707152">(</span><span class="ident" id="1707153">sz</span>&nbsp;<span class="builtintype" id="1707156">uintptr</span><span class="op" id="1707163">)</span>&nbsp;<span class="op" id="1707165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1707168">if</span>&nbsp;<span class="ident" id="1707171"><a href="/gostd/runtime/sema.go.html#1707153">sz</a></span>&nbsp;<span class="op" id="1707174">!=</span>&nbsp;<span class="ident" id="1707177"><a href="/gostd/runtime/sema.go.html#1702357">unsafe</a></span><span class="op" id="1707183">.</span><span class="ident" id="1707184">Sizeof</span><span class="op" id="1707190">(</span><span class="ident" id="1707191"><a href="/gostd/runtime/sema.go.html#1705497">syncSema</a></span><span class="op" id="1707199">{</span><span class="op" id="1707200">}</span><span class="op" id="1707201">)</span>&nbsp;<span class="op" id="1707203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1707207">print</span><span class="op" id="1707212">(</span><span class="string" id="1707213">&#34;runtime:&nbsp;bad&nbsp;syncSema&nbsp;size&nbsp;-&nbsp;sync=&#34;</span><span class="op" id="1707249">,</span>&nbsp;<span class="ident" id="1707251"><a href="/gostd/runtime/sema.go.html#1707153">sz</a></span><span class="op" id="1707253">,</span>&nbsp;<span class="string" id="1707255">&#34;&nbsp;runtime=&#34;</span><span class="op" id="1707266">,</span>&nbsp;<span class="ident" id="1707268"><a href="/gostd/runtime/sema.go.html#1702357">unsafe</a></span><span class="op" id="1707274">.</span><span class="ident" id="1707275">Sizeof</span><span class="op" id="1707281">(</span><span class="ident" id="1707282"><a href="/gostd/runtime/sema.go.html#1705497">syncSema</a></span><span class="op" id="1707290">{</span><span class="op" id="1707291">}</span><span class="op" id="1707292">)</span><span class="op" id="1707293">,</span>&nbsp;<span class="string" id="1707295">&#34;\n&#34;</span><span class="op" id="1707299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1707303"><a href="/gostd/runtime/panic.go.html#1664327">gothrow</a></span><span class="op" id="1707310">(</span><span class="string" id="1707311">&#34;bad&nbsp;syncSema&nbsp;size&#34;</span><span class="op" id="1707330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1707333">}</span><br>
<span class="lineno">275</span><span class="op" id="1707335">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
