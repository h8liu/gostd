<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="425018">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="425073">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="425127">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="425178">package</span>&nbsp;<span class="ident" id="425186">http_test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="425197">import</span>&nbsp;<span class="op" id="425204">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425207">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425216">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425226">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425233">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425239">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425252">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425260">&#34;mime/multipart&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425278">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="425285">.</span>&nbsp;<span class="string" id="425287">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425299">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425320">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425331">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425337">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425348">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425356">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425373">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425384">&#34;regexp&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425394">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425405">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425416">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425427">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="425438">&#34;time&#34;</span><br>
<span class="lineno">30</span><span class="op" id="425445">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="425448">const</span>&nbsp;<span class="op" id="425454">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="425457">testFile</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="425469">=</span>&nbsp;<span class="string" id="425471">&#34;testdata/file&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="425488">testFileLen</span>&nbsp;<span class="op" id="425500">=</span>&nbsp;<span class="num" id="425502">11</span><br>
<span class="lineno">35</span><span class="op" id="425505">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="425508">type</span>&nbsp;<span class="ident" id="425513">wantRange</span>&nbsp;<span class="keyword" id="425523">struct</span>&nbsp;<span class="op" id="425530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="425533">start</span><span class="op" id="425538">,</span>&nbsp;<span class="ident" id="425540">end</span>&nbsp;<span class="ident" id="425544">int64</span>&nbsp;<span class="comment" id="425550">//&nbsp;range&nbsp;[start,end)</span><br>
<span class="lineno"></span><span class="op" id="425571">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="425574">var</span>&nbsp;<span class="ident" id="425578">itoa</span>&nbsp;<span class="op" id="425583">=</span>&nbsp;<span class="ident" id="425585">strconv</span><span class="op" id="425592">.</span><span class="ident" id="425593">Itoa</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="425599">var</span>&nbsp;<span class="ident" id="425603">ServeFileRangeTests</span>&nbsp;<span class="op" id="425623">=</span>&nbsp;<span class="op" id="425625">[</span><span class="op" id="425626">]</span><span class="keyword" id="425627">struct</span>&nbsp;<span class="op" id="425634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="425637">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="425644">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="425652">code</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="425659">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="425664">ranges</span>&nbsp;<span class="op" id="425671">[</span><span class="op" id="425672">]</span><span class="ident" id="425673">wantRange</span><br>
<span class="lineno"></span><span class="op" id="425683">}</span><span class="op" id="425684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="425687">{</span><span class="ident" id="425688">r</span><span class="op" id="425689">:</span>&nbsp;<span class="string" id="425691">&#34;&#34;</span><span class="op" id="425693">,</span>&nbsp;<span class="ident" id="425695">code</span><span class="op" id="425699">:</span>&nbsp;<span class="ident" id="425701">StatusOK</span><span class="op" id="425709">}</span><span class="op" id="425710">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="425713">{</span><span class="ident" id="425714">r</span><span class="op" id="425715">:</span>&nbsp;<span class="string" id="425717">&#34;bytes=0-4&#34;</span><span class="op" id="425728">,</span>&nbsp;<span class="ident" id="425730">code</span><span class="op" id="425734">:</span>&nbsp;<span class="ident" id="425736">StatusPartialContent</span><span class="op" id="425756">,</span>&nbsp;<span class="ident" id="425758">ranges</span><span class="op" id="425764">:</span>&nbsp;<span class="op" id="425766">[</span><span class="op" id="425767">]</span><span class="ident" id="425768">wantRange</span><span class="op" id="425777">{</span><span class="op" id="425778">{</span><span class="num" id="425779">0</span><span class="op" id="425780">,</span>&nbsp;<span class="num" id="425782">5</span><span class="op" id="425783">}</span><span class="op" id="425784">}</span><span class="op" id="425785">}</span><span class="op" id="425786">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="425789">{</span><span class="ident" id="425790">r</span><span class="op" id="425791">:</span>&nbsp;<span class="string" id="425793">&#34;bytes=2-&#34;</span><span class="op" id="425803">,</span>&nbsp;<span class="ident" id="425805">code</span><span class="op" id="425809">:</span>&nbsp;<span class="ident" id="425811">StatusPartialContent</span><span class="op" id="425831">,</span>&nbsp;<span class="ident" id="425833">ranges</span><span class="op" id="425839">:</span>&nbsp;<span class="op" id="425841">[</span><span class="op" id="425842">]</span><span class="ident" id="425843">wantRange</span><span class="op" id="425852">{</span><span class="op" id="425853">{</span><span class="num" id="425854">2</span><span class="op" id="425855">,</span>&nbsp;<span class="ident" id="425857">testFileLen</span><span class="op" id="425868">}</span><span class="op" id="425869">}</span><span class="op" id="425870">}</span><span class="op" id="425871">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="425874">{</span><span class="ident" id="425875">r</span><span class="op" id="425876">:</span>&nbsp;<span class="string" id="425878">&#34;bytes=-5&#34;</span><span class="op" id="425888">,</span>&nbsp;<span class="ident" id="425890">code</span><span class="op" id="425894">:</span>&nbsp;<span class="ident" id="425896">StatusPartialContent</span><span class="op" id="425916">,</span>&nbsp;<span class="ident" id="425918">ranges</span><span class="op" id="425924">:</span>&nbsp;<span class="op" id="425926">[</span><span class="op" id="425927">]</span><span class="ident" id="425928">wantRange</span><span class="op" id="425937">{</span><span class="op" id="425938">{</span><span class="ident" id="425939">testFileLen</span>&nbsp;<span class="op" id="425951">-</span>&nbsp;<span class="num" id="425953">5</span><span class="op" id="425954">,</span>&nbsp;<span class="ident" id="425956">testFileLen</span><span class="op" id="425967">}</span><span class="op" id="425968">}</span><span class="op" id="425969">}</span><span class="op" id="425970">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="425973">{</span><span class="ident" id="425974">r</span><span class="op" id="425975">:</span>&nbsp;<span class="string" id="425977">&#34;bytes=3-7&#34;</span><span class="op" id="425988">,</span>&nbsp;<span class="ident" id="425990">code</span><span class="op" id="425994">:</span>&nbsp;<span class="ident" id="425996">StatusPartialContent</span><span class="op" id="426016">,</span>&nbsp;<span class="ident" id="426018">ranges</span><span class="op" id="426024">:</span>&nbsp;<span class="op" id="426026">[</span><span class="op" id="426027">]</span><span class="ident" id="426028">wantRange</span><span class="op" id="426037">{</span><span class="op" id="426038">{</span><span class="num" id="426039">3</span><span class="op" id="426040">,</span>&nbsp;<span class="num" id="426042">8</span><span class="op" id="426043">}</span><span class="op" id="426044">}</span><span class="op" id="426045">}</span><span class="op" id="426046">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="426049">{</span><span class="ident" id="426050">r</span><span class="op" id="426051">:</span>&nbsp;<span class="string" id="426053">&#34;bytes=20-&#34;</span><span class="op" id="426064">,</span>&nbsp;<span class="ident" id="426066">code</span><span class="op" id="426070">:</span>&nbsp;<span class="ident" id="426072">StatusRequestedRangeNotSatisfiable</span><span class="op" id="426106">}</span><span class="op" id="426107">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="426110">{</span><span class="ident" id="426111">r</span><span class="op" id="426112">:</span>&nbsp;<span class="string" id="426114">&#34;bytes=0-0,-2&#34;</span><span class="op" id="426128">,</span>&nbsp;<span class="ident" id="426130">code</span><span class="op" id="426134">:</span>&nbsp;<span class="ident" id="426136">StatusPartialContent</span><span class="op" id="426156">,</span>&nbsp;<span class="ident" id="426158">ranges</span><span class="op" id="426164">:</span>&nbsp;<span class="op" id="426166">[</span><span class="op" id="426167">]</span><span class="ident" id="426168">wantRange</span><span class="op" id="426177">{</span><span class="op" id="426178">{</span><span class="num" id="426179">0</span><span class="op" id="426180">,</span>&nbsp;<span class="num" id="426182">1</span><span class="op" id="426183">}</span><span class="op" id="426184">,</span>&nbsp;<span class="op" id="426186">{</span><span class="ident" id="426187">testFileLen</span>&nbsp;<span class="op" id="426199">-</span>&nbsp;<span class="num" id="426201">2</span><span class="op" id="426202">,</span>&nbsp;<span class="ident" id="426204">testFileLen</span><span class="op" id="426215">}</span><span class="op" id="426216">}</span><span class="op" id="426217">}</span><span class="op" id="426218">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="426221">{</span><span class="ident" id="426222">r</span><span class="op" id="426223">:</span>&nbsp;<span class="string" id="426225">&#34;bytes=0-1,5-8&#34;</span><span class="op" id="426240">,</span>&nbsp;<span class="ident" id="426242">code</span><span class="op" id="426246">:</span>&nbsp;<span class="ident" id="426248">StatusPartialContent</span><span class="op" id="426268">,</span>&nbsp;<span class="ident" id="426270">ranges</span><span class="op" id="426276">:</span>&nbsp;<span class="op" id="426278">[</span><span class="op" id="426279">]</span><span class="ident" id="426280">wantRange</span><span class="op" id="426289">{</span><span class="op" id="426290">{</span><span class="num" id="426291">0</span><span class="op" id="426292">,</span>&nbsp;<span class="num" id="426294">2</span><span class="op" id="426295">}</span><span class="op" id="426296">,</span>&nbsp;<span class="op" id="426298">{</span><span class="num" id="426299">5</span><span class="op" id="426300">,</span>&nbsp;<span class="num" id="426302">9</span><span class="op" id="426303">}</span><span class="op" id="426304">}</span><span class="op" id="426305">}</span><span class="op" id="426306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="426309">{</span><span class="ident" id="426310">r</span><span class="op" id="426311">:</span>&nbsp;<span class="string" id="426313">&#34;bytes=0-1,5-&#34;</span><span class="op" id="426327">,</span>&nbsp;<span class="ident" id="426329">code</span><span class="op" id="426333">:</span>&nbsp;<span class="ident" id="426335">StatusPartialContent</span><span class="op" id="426355">,</span>&nbsp;<span class="ident" id="426357">ranges</span><span class="op" id="426363">:</span>&nbsp;<span class="op" id="426365">[</span><span class="op" id="426366">]</span><span class="ident" id="426367">wantRange</span><span class="op" id="426376">{</span><span class="op" id="426377">{</span><span class="num" id="426378">0</span><span class="op" id="426379">,</span>&nbsp;<span class="num" id="426381">2</span><span class="op" id="426382">}</span><span class="op" id="426383">,</span>&nbsp;<span class="op" id="426385">{</span><span class="num" id="426386">5</span><span class="op" id="426387">,</span>&nbsp;<span class="ident" id="426389">testFileLen</span><span class="op" id="426400">}</span><span class="op" id="426401">}</span><span class="op" id="426402">}</span><span class="op" id="426403">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="426406">{</span><span class="ident" id="426407">r</span><span class="op" id="426408">:</span>&nbsp;<span class="string" id="426410">&#34;bytes=5-1000&#34;</span><span class="op" id="426424">,</span>&nbsp;<span class="ident" id="426426">code</span><span class="op" id="426430">:</span>&nbsp;<span class="ident" id="426432">StatusPartialContent</span><span class="op" id="426452">,</span>&nbsp;<span class="ident" id="426454">ranges</span><span class="op" id="426460">:</span>&nbsp;<span class="op" id="426462">[</span><span class="op" id="426463">]</span><span class="ident" id="426464">wantRange</span><span class="op" id="426473">{</span><span class="op" id="426474">{</span><span class="num" id="426475">5</span><span class="op" id="426476">,</span>&nbsp;<span class="ident" id="426478">testFileLen</span><span class="op" id="426489">}</span><span class="op" id="426490">}</span><span class="op" id="426491">}</span><span class="op" id="426492">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="426495">{</span><span class="ident" id="426496">r</span><span class="op" id="426497">:</span>&nbsp;<span class="string" id="426499">&#34;bytes=0-,1-,2-,3-,4-&#34;</span><span class="op" id="426521">,</span>&nbsp;<span class="ident" id="426523">code</span><span class="op" id="426527">:</span>&nbsp;<span class="ident" id="426529">StatusOK</span><span class="op" id="426537">}</span><span class="op" id="426538">,</span>&nbsp;<span class="comment" id="426540">//&nbsp;ignore&nbsp;wasteful&nbsp;range&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="426574">{</span><span class="ident" id="426575">r</span><span class="op" id="426576">:</span>&nbsp;<span class="string" id="426578">&#34;bytes=0-&#34;</span>&nbsp;<span class="op" id="426589">+</span>&nbsp;<span class="ident" id="426591">itoa</span><span class="op" id="426595">(</span><span class="ident" id="426596">testFileLen</span><span class="op" id="426607">-</span><span class="num" id="426608">2</span><span class="op" id="426609">)</span><span class="op" id="426610">,</span>&nbsp;<span class="ident" id="426612">code</span><span class="op" id="426616">:</span>&nbsp;<span class="ident" id="426618">StatusPartialContent</span><span class="op" id="426638">,</span>&nbsp;<span class="ident" id="426640">ranges</span><span class="op" id="426646">:</span>&nbsp;<span class="op" id="426648">[</span><span class="op" id="426649">]</span><span class="ident" id="426650">wantRange</span><span class="op" id="426659">{</span><span class="op" id="426660">{</span><span class="num" id="426661">0</span><span class="op" id="426662">,</span>&nbsp;<span class="ident" id="426664">testFileLen</span>&nbsp;<span class="op" id="426676">-</span>&nbsp;<span class="num" id="426678">1</span><span class="op" id="426679">}</span><span class="op" id="426680">}</span><span class="op" id="426681">}</span><span class="op" id="426682">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="426685">{</span><span class="ident" id="426686">r</span><span class="op" id="426687">:</span>&nbsp;<span class="string" id="426689">&#34;bytes=0-&#34;</span>&nbsp;<span class="op" id="426700">+</span>&nbsp;<span class="ident" id="426702">itoa</span><span class="op" id="426706">(</span><span class="ident" id="426707">testFileLen</span><span class="op" id="426718">-</span><span class="num" id="426719">1</span><span class="op" id="426720">)</span><span class="op" id="426721">,</span>&nbsp;<span class="ident" id="426723">code</span><span class="op" id="426727">:</span>&nbsp;<span class="ident" id="426729">StatusPartialContent</span><span class="op" id="426749">,</span>&nbsp;<span class="ident" id="426751">ranges</span><span class="op" id="426757">:</span>&nbsp;<span class="op" id="426759">[</span><span class="op" id="426760">]</span><span class="ident" id="426761">wantRange</span><span class="op" id="426770">{</span><span class="op" id="426771">{</span><span class="num" id="426772">0</span><span class="op" id="426773">,</span>&nbsp;<span class="ident" id="426775">testFileLen</span><span class="op" id="426786">}</span><span class="op" id="426787">}</span><span class="op" id="426788">}</span><span class="op" id="426789">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="426792">{</span><span class="ident" id="426793">r</span><span class="op" id="426794">:</span>&nbsp;<span class="string" id="426796">&#34;bytes=0-&#34;</span>&nbsp;<span class="op" id="426807">+</span>&nbsp;<span class="ident" id="426809">itoa</span><span class="op" id="426813">(</span><span class="ident" id="426814">testFileLen</span><span class="op" id="426825">)</span><span class="op" id="426826">,</span>&nbsp;<span class="ident" id="426828">code</span><span class="op" id="426832">:</span>&nbsp;<span class="ident" id="426834">StatusPartialContent</span><span class="op" id="426854">,</span>&nbsp;<span class="ident" id="426856">ranges</span><span class="op" id="426862">:</span>&nbsp;<span class="op" id="426864">[</span><span class="op" id="426865">]</span><span class="ident" id="426866">wantRange</span><span class="op" id="426875">{</span><span class="op" id="426876">{</span><span class="num" id="426877">0</span><span class="op" id="426878">,</span>&nbsp;<span class="ident" id="426880">testFileLen</span><span class="op" id="426891">}</span><span class="op" id="426892">}</span><span class="op" id="426893">}</span><span class="op" id="426894">,</span><br>
<span class="lineno"></span><span class="op" id="426896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="426899">func</span>&nbsp;<span class="ident" id="426904">TestServeFile</span><span class="op" id="426917">(</span><span class="ident" id="426918">t</span>&nbsp;<span class="op" id="426920">*</span><span class="ident" id="426921">testing</span><span class="op" id="426928">.</span><span class="ident" id="426929">T</span><span class="op" id="426930">)</span>&nbsp;<span class="op" id="426932">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="426935">defer</span>&nbsp;<span class="ident" id="426941">afterTest</span><span class="op" id="426950">(</span><span class="ident" id="426951">t</span><span class="op" id="426952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="426955">ts</span>&nbsp;<span class="op" id="426958">:=</span>&nbsp;<span class="ident" id="426961">httptest</span><span class="op" id="426969">.</span><span class="ident" id="426970">NewServer</span><span class="op" id="426979">(</span><span class="ident" id="426980">HandlerFunc</span><span class="op" id="426991">(</span><span class="keyword" id="426992">func</span><span class="op" id="426996">(</span><span class="ident" id="426997">w</span>&nbsp;<span class="ident" id="426999">ResponseWriter</span><span class="op" id="427013">,</span>&nbsp;<span class="ident" id="427015">r</span>&nbsp;<span class="op" id="427017">*</span><span class="ident" id="427018">Request</span><span class="op" id="427025">)</span>&nbsp;<span class="op" id="427027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="427031">ServeFile</span><span class="op" id="427040">(</span><span class="ident" id="427041">w</span><span class="op" id="427042">,</span>&nbsp;<span class="ident" id="427044">r</span><span class="op" id="427045">,</span>&nbsp;<span class="string" id="427047">&#34;testdata/file&#34;</span><span class="op" id="427062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="427065">}</span><span class="op" id="427066">)</span><span class="op" id="427067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="427070">defer</span>&nbsp;<span class="ident" id="427076">ts</span><span class="op" id="427078">.</span><span class="ident" id="427079">Close</span><span class="op" id="427084">(</span><span class="op" id="427085">)</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="427089">var</span>&nbsp;<span class="ident" id="427093">err</span>&nbsp;<span class="builtintype" id="427097">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="427105">file</span><span class="op" id="427109">,</span>&nbsp;<span class="ident" id="427111">err</span>&nbsp;<span class="op" id="427115">:=</span>&nbsp;<span class="ident" id="427118">ioutil</span><span class="op" id="427124">.</span><span class="ident" id="427125">ReadFile</span><span class="op" id="427133">(</span><span class="ident" id="427134">testFile</span><span class="op" id="427142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="427145">if</span>&nbsp;<span class="ident" id="427148">err</span>&nbsp;<span class="op" id="427152">!=</span>&nbsp;<span class="ident" id="427155">nil</span>&nbsp;<span class="op" id="427159">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="427163">t</span><span class="op" id="427164">.</span><span class="ident" id="427165">Fatal</span><span class="op" id="427170">(</span><span class="string" id="427171">&#34;reading&nbsp;file:&#34;</span><span class="op" id="427186">,</span>&nbsp;<span class="ident" id="427188">err</span><span class="op" id="427191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="427194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="427198">//&nbsp;set&nbsp;up&nbsp;the&nbsp;Request&nbsp;(re-used&nbsp;for&nbsp;all&nbsp;tests)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="427245">var</span>&nbsp;<span class="ident" id="427249">req</span>&nbsp;<span class="ident" id="427253">Request</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="427262">req</span><span class="op" id="427265">.</span><span class="ident" id="427266">Header</span>&nbsp;<span class="op" id="427273">=</span>&nbsp;<span class="builtinfunc" id="427275">make</span><span class="op" id="427279">(</span><span class="ident" id="427280">Header</span><span class="op" id="427286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="427289">if</span>&nbsp;<span class="ident" id="427292">req</span><span class="op" id="427295">.</span><span class="ident" id="427296">URL</span><span class="op" id="427299">,</span>&nbsp;<span class="ident" id="427301">err</span>&nbsp;<span class="op" id="427305">=</span>&nbsp;<span class="ident" id="427307">url</span><span class="op" id="427310">.</span><span class="ident" id="427311">Parse</span><span class="op" id="427316">(</span><span class="ident" id="427317">ts</span><span class="op" id="427319">.</span><span class="ident" id="427320">URL</span><span class="op" id="427323">)</span><span class="op" id="427324">;</span>&nbsp;<span class="ident" id="427326">err</span>&nbsp;<span class="op" id="427330">!=</span>&nbsp;<span class="ident" id="427333">nil</span>&nbsp;<span class="op" id="427337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="427341">t</span><span class="op" id="427342">.</span><span class="ident" id="427343">Fatal</span><span class="op" id="427348">(</span><span class="string" id="427349">&#34;ParseURL:&#34;</span><span class="op" id="427360">,</span>&nbsp;<span class="ident" id="427362">err</span><span class="op" id="427365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="427368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="427371">req</span><span class="op" id="427374">.</span><span class="ident" id="427375">Method</span>&nbsp;<span class="op" id="427382">=</span>&nbsp;<span class="string" id="427384">&#34;GET&#34;</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="427392">//&nbsp;straight&nbsp;GET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="427409">_</span><span class="op" id="427410">,</span>&nbsp;<span class="ident" id="427412">body</span>&nbsp;<span class="op" id="427417">:=</span>&nbsp;<span class="ident" id="427420">getBody</span><span class="op" id="427427">(</span><span class="ident" id="427428">t</span><span class="op" id="427429">,</span>&nbsp;<span class="string" id="427431">&#34;straight&nbsp;get&#34;</span><span class="op" id="427445">,</span>&nbsp;<span class="ident" id="427447">req</span><span class="op" id="427450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="427453">if</span>&nbsp;<span class="op" id="427456">!</span><span class="ident" id="427457">bytes</span><span class="op" id="427462">.</span><span class="ident" id="427463">Equal</span><span class="op" id="427468">(</span><span class="ident" id="427469">body</span><span class="op" id="427473">,</span>&nbsp;<span class="ident" id="427475">file</span><span class="op" id="427479">)</span>&nbsp;<span class="op" id="427481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="427485">t</span><span class="op" id="427486">.</span><span class="ident" id="427487">Fatalf</span><span class="op" id="427493">(</span><span class="string" id="427494">&#34;body&nbsp;mismatch:&nbsp;got&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="427526">,</span>&nbsp;<span class="ident" id="427528">body</span><span class="op" id="427532">,</span>&nbsp;<span class="ident" id="427534">file</span><span class="op" id="427538">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="427541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="427545">//&nbsp;Range&nbsp;tests</span><br>
<span class="lineno"></span><span class="ident" id="427560">Cases</span><span class="op" id="427565">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="427568">for</span>&nbsp;<span class="ident" id="427572">_</span><span class="op" id="427573">,</span>&nbsp;<span class="ident" id="427575">rt</span>&nbsp;<span class="op" id="427578">:=</span>&nbsp;<span class="keyword" id="427581">range</span>&nbsp;<span class="ident" id="427587">ServeFileRangeTests</span>&nbsp;<span class="op" id="427607">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="427611">if</span>&nbsp;<span class="ident" id="427614">rt</span><span class="op" id="427616">.</span><span class="ident" id="427617">r</span>&nbsp;<span class="op" id="427619">!=</span>&nbsp;<span class="string" id="427622">&#34;&#34;</span>&nbsp;<span class="op" id="427625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="427630">req</span><span class="op" id="427633">.</span><span class="ident" id="427634">Header</span><span class="op" id="427640">.</span><span class="ident" id="427641">Set</span><span class="op" id="427644">(</span><span class="string" id="427645">&#34;Range&#34;</span><span class="op" id="427652">,</span>&nbsp;<span class="ident" id="427654">rt</span><span class="op" id="427656">.</span><span class="ident" id="427657">r</span><span class="op" id="427658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="427662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="427666">resp</span><span class="op" id="427670">,</span>&nbsp;<span class="ident" id="427672">body</span>&nbsp;<span class="op" id="427677">:=</span>&nbsp;<span class="ident" id="427680">getBody</span><span class="op" id="427687">(</span><span class="ident" id="427688">t</span><span class="op" id="427689">,</span>&nbsp;<span class="ident" id="427691">fmt</span><span class="op" id="427694">.</span><span class="ident" id="427695">Sprintf</span><span class="op" id="427702">(</span><span class="string" id="427703">&#34;range&nbsp;test&nbsp;%q&#34;</span><span class="op" id="427718">,</span>&nbsp;<span class="ident" id="427720">rt</span><span class="op" id="427722">.</span><span class="ident" id="427723">r</span><span class="op" id="427724">)</span><span class="op" id="427725">,</span>&nbsp;<span class="ident" id="427727">req</span><span class="op" id="427730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="427734">if</span>&nbsp;<span class="ident" id="427737">resp</span><span class="op" id="427741">.</span><span class="ident" id="427742">StatusCode</span>&nbsp;<span class="op" id="427753">!=</span>&nbsp;<span class="ident" id="427756">rt</span><span class="op" id="427758">.</span><span class="ident" id="427759">code</span>&nbsp;<span class="op" id="427764">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="427769">t</span><span class="op" id="427770">.</span><span class="ident" id="427771">Errorf</span><span class="op" id="427777">(</span><span class="string" id="427778">&#34;range=%q:&nbsp;StatusCode=%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="427812">,</span>&nbsp;<span class="ident" id="427814">rt</span><span class="op" id="427816">.</span><span class="ident" id="427817">r</span><span class="op" id="427818">,</span>&nbsp;<span class="ident" id="427820">resp</span><span class="op" id="427824">.</span><span class="ident" id="427825">StatusCode</span><span class="op" id="427835">,</span>&nbsp;<span class="ident" id="427837">rt</span><span class="op" id="427839">.</span><span class="ident" id="427840">code</span><span class="op" id="427844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="427848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="427852">if</span>&nbsp;<span class="ident" id="427855">rt</span><span class="op" id="427857">.</span><span class="ident" id="427858">code</span>&nbsp;<span class="op" id="427863">==</span>&nbsp;<span class="ident" id="427866">StatusRequestedRangeNotSatisfiable</span>&nbsp;<span class="op" id="427901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="427906">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="427917">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="427921">wantContentRange</span>&nbsp;<span class="op" id="427938">:=</span>&nbsp;<span class="string" id="427941">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="427946">if</span>&nbsp;<span class="builtinfunc" id="427949">len</span><span class="op" id="427952">(</span><span class="ident" id="427953">rt</span><span class="op" id="427955">.</span><span class="ident" id="427956">ranges</span><span class="op" id="427962">)</span>&nbsp;<span class="op" id="427964">==</span>&nbsp;<span class="num" id="427967">1</span>&nbsp;<span class="op" id="427969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="427974">rng</span>&nbsp;<span class="op" id="427978">:=</span>&nbsp;<span class="ident" id="427981">rt</span><span class="op" id="427983">.</span><span class="ident" id="427984">ranges</span><span class="op" id="427990">[</span><span class="num" id="427991">0</span><span class="op" id="427992">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="427997">wantContentRange</span>&nbsp;<span class="op" id="428014">=</span>&nbsp;<span class="ident" id="428016">fmt</span><span class="op" id="428019">.</span><span class="ident" id="428020">Sprintf</span><span class="op" id="428027">(</span><span class="string" id="428028">&#34;bytes&nbsp;%d-%d/%d&#34;</span><span class="op" id="428044">,</span>&nbsp;<span class="ident" id="428046">rng</span><span class="op" id="428049">.</span><span class="ident" id="428050">start</span><span class="op" id="428055">,</span>&nbsp;<span class="ident" id="428057">rng</span><span class="op" id="428060">.</span><span class="ident" id="428061">end</span><span class="op" id="428064">-</span><span class="num" id="428065">1</span><span class="op" id="428066">,</span>&nbsp;<span class="ident" id="428068">testFileLen</span><span class="op" id="428079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="428083">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="428087">cr</span>&nbsp;<span class="op" id="428090">:=</span>&nbsp;<span class="ident" id="428093">resp</span><span class="op" id="428097">.</span><span class="ident" id="428098">Header</span><span class="op" id="428104">.</span><span class="ident" id="428105">Get</span><span class="op" id="428108">(</span><span class="string" id="428109">&#34;Content-Range&#34;</span><span class="op" id="428124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="428128">if</span>&nbsp;<span class="ident" id="428131">cr</span>&nbsp;<span class="op" id="428134">!=</span>&nbsp;<span class="ident" id="428137">wantContentRange</span>&nbsp;<span class="op" id="428154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="428159">t</span><span class="op" id="428160">.</span><span class="ident" id="428161">Errorf</span><span class="op" id="428167">(</span><span class="string" id="428168">&#34;range=%q:&nbsp;Content-Range&nbsp;=&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="428207">,</span>&nbsp;<span class="ident" id="428209">rt</span><span class="op" id="428211">.</span><span class="ident" id="428212">r</span><span class="op" id="428213">,</span>&nbsp;<span class="ident" id="428215">cr</span><span class="op" id="428217">,</span>&nbsp;<span class="ident" id="428219">wantContentRange</span><span class="op" id="428235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="428239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="428243">ct</span>&nbsp;<span class="op" id="428246">:=</span>&nbsp;<span class="ident" id="428249">resp</span><span class="op" id="428253">.</span><span class="ident" id="428254">Header</span><span class="op" id="428260">.</span><span class="ident" id="428261">Get</span><span class="op" id="428264">(</span><span class="string" id="428265">&#34;Content-Type&#34;</span><span class="op" id="428279">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="428283">if</span>&nbsp;<span class="builtinfunc" id="428286">len</span><span class="op" id="428289">(</span><span class="ident" id="428290">rt</span><span class="op" id="428292">.</span><span class="ident" id="428293">ranges</span><span class="op" id="428299">)</span>&nbsp;<span class="op" id="428301">==</span>&nbsp;<span class="num" id="428304">1</span>&nbsp;<span class="op" id="428306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="428311">rng</span>&nbsp;<span class="op" id="428315">:=</span>&nbsp;<span class="ident" id="428318">rt</span><span class="op" id="428320">.</span><span class="ident" id="428321">ranges</span><span class="op" id="428327">[</span><span class="num" id="428328">0</span><span class="op" id="428329">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="428334">wantBody</span>&nbsp;<span class="op" id="428343">:=</span>&nbsp;<span class="ident" id="428346">file</span><span class="op" id="428350">[</span><span class="ident" id="428351">rng</span><span class="op" id="428354">.</span><span class="ident" id="428355">start</span><span class="op" id="428360">:</span><span class="ident" id="428361">rng</span><span class="op" id="428364">.</span><span class="ident" id="428365">end</span><span class="op" id="428368">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="428373">if</span>&nbsp;<span class="op" id="428376">!</span><span class="ident" id="428377">bytes</span><span class="op" id="428382">.</span><span class="ident" id="428383">Equal</span><span class="op" id="428388">(</span><span class="ident" id="428389">body</span><span class="op" id="428393">,</span>&nbsp;<span class="ident" id="428395">wantBody</span><span class="op" id="428403">)</span>&nbsp;<span class="op" id="428405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="428411">t</span><span class="op" id="428412">.</span><span class="ident" id="428413">Errorf</span><span class="op" id="428419">(</span><span class="string" id="428420">&#34;range=%q:&nbsp;body&nbsp;=&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="428450">,</span>&nbsp;<span class="ident" id="428452">rt</span><span class="op" id="428454">.</span><span class="ident" id="428455">r</span><span class="op" id="428456">,</span>&nbsp;<span class="ident" id="428458">body</span><span class="op" id="428462">,</span>&nbsp;<span class="ident" id="428464">wantBody</span><span class="op" id="428472">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="428477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="428482">if</span>&nbsp;<span class="ident" id="428485">strings</span><span class="op" id="428492">.</span><span class="ident" id="428493">HasPrefix</span><span class="op" id="428502">(</span><span class="ident" id="428503">ct</span><span class="op" id="428505">,</span>&nbsp;<span class="string" id="428507">&#34;multipart/byteranges&#34;</span><span class="op" id="428529">)</span>&nbsp;<span class="op" id="428531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="428537">t</span><span class="op" id="428538">.</span><span class="ident" id="428539">Errorf</span><span class="op" id="428545">(</span><span class="string" id="428546">&#34;range=%q&nbsp;content-type&nbsp;=&nbsp;%q;&nbsp;unexpected&nbsp;multipart/byteranges&#34;</span><span class="op" id="428607">,</span>&nbsp;<span class="ident" id="428609">rt</span><span class="op" id="428611">.</span><span class="ident" id="428612">r</span><span class="op" id="428613">,</span>&nbsp;<span class="ident" id="428615">ct</span><span class="op" id="428617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="428622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="428626">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="428630">if</span>&nbsp;<span class="builtinfunc" id="428633">len</span><span class="op" id="428636">(</span><span class="ident" id="428637">rt</span><span class="op" id="428639">.</span><span class="ident" id="428640">ranges</span><span class="op" id="428646">)</span>&nbsp;<span class="op" id="428648">&gt;</span>&nbsp;<span class="num" id="428650">1</span>&nbsp;<span class="op" id="428652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="428657">typ</span><span class="op" id="428660">,</span>&nbsp;<span class="ident" id="428662">params</span><span class="op" id="428668">,</span>&nbsp;<span class="ident" id="428670">err</span>&nbsp;<span class="op" id="428674">:=</span>&nbsp;<span class="ident" id="428677">mime</span><span class="op" id="428681">.</span><span class="ident" id="428682">ParseMediaType</span><span class="op" id="428696">(</span><span class="ident" id="428697">ct</span><span class="op" id="428699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="428704">if</span>&nbsp;<span class="ident" id="428707">err</span>&nbsp;<span class="op" id="428711">!=</span>&nbsp;<span class="ident" id="428714">nil</span>&nbsp;<span class="op" id="428718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="428724">t</span><span class="op" id="428725">.</span><span class="ident" id="428726">Errorf</span><span class="op" id="428732">(</span><span class="string" id="428733">&#34;range=%q&nbsp;content-type&nbsp;=&nbsp;%q;&nbsp;%v&#34;</span><span class="op" id="428765">,</span>&nbsp;<span class="ident" id="428767">rt</span><span class="op" id="428769">.</span><span class="ident" id="428770">r</span><span class="op" id="428771">,</span>&nbsp;<span class="ident" id="428773">ct</span><span class="op" id="428775">,</span>&nbsp;<span class="ident" id="428777">err</span><span class="op" id="428780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="428786">continue</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="428798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="428803">if</span>&nbsp;<span class="ident" id="428806">typ</span>&nbsp;<span class="op" id="428810">!=</span>&nbsp;<span class="string" id="428813">&#34;multipart/byteranges&#34;</span>&nbsp;<span class="op" id="428836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="428842">t</span><span class="op" id="428843">.</span><span class="ident" id="428844">Errorf</span><span class="op" id="428850">(</span><span class="string" id="428851">&#34;range=%q&nbsp;content-type&nbsp;=&nbsp;%q;&nbsp;want&nbsp;multipart/byteranges&#34;</span><span class="op" id="428906">,</span>&nbsp;<span class="ident" id="428908">rt</span><span class="op" id="428910">.</span><span class="ident" id="428911">r</span><span class="op" id="428912">,</span>&nbsp;<span class="ident" id="428914">typ</span><span class="op" id="428917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="428923">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="428935">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="428940">if</span>&nbsp;<span class="ident" id="428943">params</span><span class="op" id="428949">[</span><span class="string" id="428950">&#34;boundary&#34;</span><span class="op" id="428960">]</span>&nbsp;<span class="op" id="428962">==</span>&nbsp;<span class="string" id="428965">&#34;&#34;</span>&nbsp;<span class="op" id="428968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="428974">t</span><span class="op" id="428975">.</span><span class="ident" id="428976">Errorf</span><span class="op" id="428982">(</span><span class="string" id="428983">&#34;range=%q&nbsp;content-type&nbsp;=&nbsp;%q;&nbsp;lacks&nbsp;boundary&#34;</span><span class="op" id="429027">,</span>&nbsp;<span class="ident" id="429029">rt</span><span class="op" id="429031">.</span><span class="ident" id="429032">r</span><span class="op" id="429033">,</span>&nbsp;<span class="ident" id="429035">ct</span><span class="op" id="429037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="429043">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="429055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="429060">if</span>&nbsp;<span class="ident" id="429063">g</span><span class="op" id="429064">,</span>&nbsp;<span class="ident" id="429066">w</span>&nbsp;<span class="op" id="429068">:=</span>&nbsp;<span class="ident" id="429071">resp</span><span class="op" id="429075">.</span><span class="ident" id="429076">ContentLength</span><span class="op" id="429089">,</span>&nbsp;<span class="ident" id="429091">int64</span><span class="op" id="429096">(</span><span class="builtinfunc" id="429097">len</span><span class="op" id="429100">(</span><span class="ident" id="429101">body</span><span class="op" id="429105">)</span><span class="op" id="429106">)</span><span class="op" id="429107">;</span>&nbsp;<span class="ident" id="429109">g</span>&nbsp;<span class="op" id="429111">!=</span>&nbsp;<span class="ident" id="429114">w</span>&nbsp;<span class="op" id="429116">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="429122">t</span><span class="op" id="429123">.</span><span class="ident" id="429124">Errorf</span><span class="op" id="429130">(</span><span class="string" id="429131">&#34;range=%q&nbsp;Content-Length&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="429170">,</span>&nbsp;<span class="ident" id="429172">rt</span><span class="op" id="429174">.</span><span class="ident" id="429175">r</span><span class="op" id="429176">,</span>&nbsp;<span class="ident" id="429178">g</span><span class="op" id="429179">,</span>&nbsp;<span class="ident" id="429181">w</span><span class="op" id="429182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="429188">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="429200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="429205">mr</span>&nbsp;<span class="op" id="429208">:=</span>&nbsp;<span class="ident" id="429211">multipart</span><span class="op" id="429220">.</span><span class="ident" id="429221">NewReader</span><span class="op" id="429230">(</span><span class="ident" id="429231">bytes</span><span class="op" id="429236">.</span><span class="ident" id="429237">NewReader</span><span class="op" id="429246">(</span><span class="ident" id="429247">body</span><span class="op" id="429251">)</span><span class="op" id="429252">,</span>&nbsp;<span class="ident" id="429254">params</span><span class="op" id="429260">[</span><span class="string" id="429261">&#34;boundary&#34;</span><span class="op" id="429271">]</span><span class="op" id="429272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="429277">for</span>&nbsp;<span class="ident" id="429281">ri</span><span class="op" id="429283">,</span>&nbsp;<span class="ident" id="429285">rng</span>&nbsp;<span class="op" id="429289">:=</span>&nbsp;<span class="keyword" id="429292">range</span>&nbsp;<span class="ident" id="429298">rt</span><span class="op" id="429300">.</span><span class="ident" id="429301">ranges</span>&nbsp;<span class="op" id="429308">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="429314">part</span><span class="op" id="429318">,</span>&nbsp;<span class="ident" id="429320">err</span>&nbsp;<span class="op" id="429324">:=</span>&nbsp;<span class="ident" id="429327">mr</span><span class="op" id="429329">.</span><span class="ident" id="429330">NextPart</span><span class="op" id="429338">(</span><span class="op" id="429339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="429345">if</span>&nbsp;<span class="ident" id="429348">err</span>&nbsp;<span class="op" id="429352">!=</span>&nbsp;<span class="ident" id="429355">nil</span>&nbsp;<span class="op" id="429359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="429366">t</span><span class="op" id="429367">.</span><span class="ident" id="429368">Errorf</span><span class="op" id="429374">(</span><span class="string" id="429375">&#34;range=%q,&nbsp;reading&nbsp;part&nbsp;index&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="429412">,</span>&nbsp;<span class="ident" id="429414">rt</span><span class="op" id="429416">.</span><span class="ident" id="429417">r</span><span class="op" id="429418">,</span>&nbsp;<span class="ident" id="429420">ri</span><span class="op" id="429422">,</span>&nbsp;<span class="ident" id="429424">err</span><span class="op" id="429427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="429434">continue</span>&nbsp;<span class="ident" id="429443">Cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="429453">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="429459">wantContentRange</span>&nbsp;<span class="op" id="429476">=</span>&nbsp;<span class="ident" id="429478">fmt</span><span class="op" id="429481">.</span><span class="ident" id="429482">Sprintf</span><span class="op" id="429489">(</span><span class="string" id="429490">&#34;bytes&nbsp;%d-%d/%d&#34;</span><span class="op" id="429506">,</span>&nbsp;<span class="ident" id="429508">rng</span><span class="op" id="429511">.</span><span class="ident" id="429512">start</span><span class="op" id="429517">,</span>&nbsp;<span class="ident" id="429519">rng</span><span class="op" id="429522">.</span><span class="ident" id="429523">end</span><span class="op" id="429526">-</span><span class="num" id="429527">1</span><span class="op" id="429528">,</span>&nbsp;<span class="ident" id="429530">testFileLen</span><span class="op" id="429541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="429547">if</span>&nbsp;<span class="ident" id="429550">g</span><span class="op" id="429551">,</span>&nbsp;<span class="ident" id="429553">w</span>&nbsp;<span class="op" id="429555">:=</span>&nbsp;<span class="ident" id="429558">part</span><span class="op" id="429562">.</span><span class="ident" id="429563">Header</span><span class="op" id="429569">.</span><span class="ident" id="429570">Get</span><span class="op" id="429573">(</span><span class="string" id="429574">&#34;Content-Range&#34;</span><span class="op" id="429589">)</span><span class="op" id="429590">,</span>&nbsp;<span class="ident" id="429592">wantContentRange</span><span class="op" id="429608">;</span>&nbsp;<span class="ident" id="429610">g</span>&nbsp;<span class="op" id="429612">!=</span>&nbsp;<span class="ident" id="429615">w</span>&nbsp;<span class="op" id="429617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="429624">t</span><span class="op" id="429625">.</span><span class="ident" id="429626">Errorf</span><span class="op" id="429632">(</span><span class="string" id="429633">&#34;range=%q:&nbsp;part&nbsp;Content-Range&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="429677">,</span>&nbsp;<span class="ident" id="429679">rt</span><span class="op" id="429681">.</span><span class="ident" id="429682">r</span><span class="op" id="429683">,</span>&nbsp;<span class="ident" id="429685">g</span><span class="op" id="429686">,</span>&nbsp;<span class="ident" id="429688">w</span><span class="op" id="429689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="429695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="429701">body</span><span class="op" id="429705">,</span>&nbsp;<span class="ident" id="429707">err</span>&nbsp;<span class="op" id="429711">:=</span>&nbsp;<span class="ident" id="429714">ioutil</span><span class="op" id="429720">.</span><span class="ident" id="429721">ReadAll</span><span class="op" id="429728">(</span><span class="ident" id="429729">part</span><span class="op" id="429733">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="429739">if</span>&nbsp;<span class="ident" id="429742">err</span>&nbsp;<span class="op" id="429746">!=</span>&nbsp;<span class="ident" id="429749">nil</span>&nbsp;<span class="op" id="429753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="429760">t</span><span class="op" id="429761">.</span><span class="ident" id="429762">Errorf</span><span class="op" id="429768">(</span><span class="string" id="429769">&#34;range=%q,&nbsp;reading&nbsp;part&nbsp;index&nbsp;%d&nbsp;body:&nbsp;%v&#34;</span><span class="op" id="429811">,</span>&nbsp;<span class="ident" id="429813">rt</span><span class="op" id="429815">.</span><span class="ident" id="429816">r</span><span class="op" id="429817">,</span>&nbsp;<span class="ident" id="429819">ri</span><span class="op" id="429821">,</span>&nbsp;<span class="ident" id="429823">err</span><span class="op" id="429826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="429833">continue</span>&nbsp;<span class="ident" id="429842">Cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="429852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="429858">wantBody</span>&nbsp;<span class="op" id="429867">:=</span>&nbsp;<span class="ident" id="429870">file</span><span class="op" id="429874">[</span><span class="ident" id="429875">rng</span><span class="op" id="429878">.</span><span class="ident" id="429879">start</span><span class="op" id="429884">:</span><span class="ident" id="429885">rng</span><span class="op" id="429888">.</span><span class="ident" id="429889">end</span><span class="op" id="429892">]</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="429898">if</span>&nbsp;<span class="op" id="429901">!</span><span class="ident" id="429902">bytes</span><span class="op" id="429907">.</span><span class="ident" id="429908">Equal</span><span class="op" id="429913">(</span><span class="ident" id="429914">body</span><span class="op" id="429918">,</span>&nbsp;<span class="ident" id="429920">wantBody</span><span class="op" id="429928">)</span>&nbsp;<span class="op" id="429930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="429937">t</span><span class="op" id="429938">.</span><span class="ident" id="429939">Errorf</span><span class="op" id="429945">(</span><span class="string" id="429946">&#34;range=%q:&nbsp;body&nbsp;=&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="429976">,</span>&nbsp;<span class="ident" id="429978">rt</span><span class="op" id="429980">.</span><span class="ident" id="429981">r</span><span class="op" id="429982">,</span>&nbsp;<span class="ident" id="429984">body</span><span class="op" id="429988">,</span>&nbsp;<span class="ident" id="429990">wantBody</span><span class="op" id="429998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="430004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="430009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="430014">_</span><span class="op" id="430015">,</span>&nbsp;<span class="ident" id="430017">err</span>&nbsp;<span class="op" id="430021">=</span>&nbsp;<span class="ident" id="430023">mr</span><span class="op" id="430025">.</span><span class="ident" id="430026">NextPart</span><span class="op" id="430034">(</span><span class="op" id="430035">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="430040">if</span>&nbsp;<span class="ident" id="430043">err</span>&nbsp;<span class="op" id="430047">!=</span>&nbsp;<span class="ident" id="430050">io</span><span class="op" id="430052">.</span><span class="ident" id="430053">EOF</span>&nbsp;<span class="op" id="430057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="430063">t</span><span class="op" id="430064">.</span><span class="ident" id="430065">Errorf</span><span class="op" id="430071">(</span><span class="string" id="430072">&#34;range=%q;&nbsp;expected&nbsp;final&nbsp;error&nbsp;io.EOF;&nbsp;got&nbsp;%v&#34;</span><span class="op" id="430119">,</span>&nbsp;<span class="ident" id="430121">rt</span><span class="op" id="430123">.</span><span class="ident" id="430124">r</span><span class="op" id="430125">,</span>&nbsp;<span class="ident" id="430127">err</span><span class="op" id="430130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="430135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="430139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="430142">}</span><br>
<span class="lineno">170</span><span class="op" id="430144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="430147">var</span>&nbsp;<span class="ident" id="430151">fsRedirectTestData</span>&nbsp;<span class="op" id="430170">=</span>&nbsp;<span class="op" id="430172">[</span><span class="op" id="430173">]</span><span class="keyword" id="430174">struct</span>&nbsp;<span class="op" id="430181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="430184">original</span><span class="op" id="430192">,</span>&nbsp;<span class="ident" id="430194">redirect</span>&nbsp;<span class="builtintype" id="430203">string</span><br>
<span class="lineno"></span><span class="op" id="430210">}</span><span class="op" id="430211">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="430214">{</span><span class="string" id="430215">&#34;/test/index.html&#34;</span><span class="op" id="430233">,</span>&nbsp;<span class="string" id="430235">&#34;/test/&#34;</span><span class="op" id="430243">}</span><span class="op" id="430244">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="430247">{</span><span class="string" id="430248">&#34;/test/testdata&#34;</span><span class="op" id="430264">,</span>&nbsp;<span class="string" id="430266">&#34;/test/testdata/&#34;</span><span class="op" id="430283">}</span><span class="op" id="430284">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="430287">{</span><span class="string" id="430288">&#34;/test/testdata/file/&#34;</span><span class="op" id="430310">,</span>&nbsp;<span class="string" id="430312">&#34;/test/testdata/file&#34;</span><span class="op" id="430333">}</span><span class="op" id="430334">,</span><br>
<span class="lineno"></span><span class="op" id="430336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="430339">func</span>&nbsp;<span class="ident" id="430344">TestFSRedirect</span><span class="op" id="430358">(</span><span class="ident" id="430359">t</span>&nbsp;<span class="op" id="430361">*</span><span class="ident" id="430362">testing</span><span class="op" id="430369">.</span><span class="ident" id="430370">T</span><span class="op" id="430371">)</span>&nbsp;<span class="op" id="430373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="430376">defer</span>&nbsp;<span class="ident" id="430382">afterTest</span><span class="op" id="430391">(</span><span class="ident" id="430392">t</span><span class="op" id="430393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="430396">ts</span>&nbsp;<span class="op" id="430399">:=</span>&nbsp;<span class="ident" id="430402">httptest</span><span class="op" id="430410">.</span><span class="ident" id="430411">NewServer</span><span class="op" id="430420">(</span><span class="ident" id="430421">StripPrefix</span><span class="op" id="430432">(</span><span class="string" id="430433">&#34;/test&#34;</span><span class="op" id="430440">,</span>&nbsp;<span class="ident" id="430442">FileServer</span><span class="op" id="430452">(</span><span class="ident" id="430453">Dir</span><span class="op" id="430456">(</span><span class="string" id="430457">&#34;.&#34;</span><span class="op" id="430460">)</span><span class="op" id="430461">)</span><span class="op" id="430462">)</span><span class="op" id="430463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="430466">defer</span>&nbsp;<span class="ident" id="430472">ts</span><span class="op" id="430474">.</span><span class="ident" id="430475">Close</span><span class="op" id="430480">(</span><span class="op" id="430481">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="430485">for</span>&nbsp;<span class="ident" id="430489">_</span><span class="op" id="430490">,</span>&nbsp;<span class="ident" id="430492">data</span>&nbsp;<span class="op" id="430497">:=</span>&nbsp;<span class="keyword" id="430500">range</span>&nbsp;<span class="ident" id="430506">fsRedirectTestData</span>&nbsp;<span class="op" id="430525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="430529">res</span><span class="op" id="430532">,</span>&nbsp;<span class="ident" id="430534">err</span>&nbsp;<span class="op" id="430538">:=</span>&nbsp;<span class="ident" id="430541">Get</span><span class="op" id="430544">(</span><span class="ident" id="430545">ts</span><span class="op" id="430547">.</span><span class="ident" id="430548">URL</span>&nbsp;<span class="op" id="430552">+</span>&nbsp;<span class="ident" id="430554">data</span><span class="op" id="430558">.</span><span class="ident" id="430559">original</span><span class="op" id="430567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="430571">if</span>&nbsp;<span class="ident" id="430574">err</span>&nbsp;<span class="op" id="430578">!=</span>&nbsp;<span class="ident" id="430581">nil</span>&nbsp;<span class="op" id="430585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="430590">t</span><span class="op" id="430591">.</span><span class="ident" id="430592">Fatal</span><span class="op" id="430597">(</span><span class="ident" id="430598">err</span><span class="op" id="430601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="430605">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="430609">res</span><span class="op" id="430612">.</span><span class="ident" id="430613">Body</span><span class="op" id="430617">.</span><span class="ident" id="430618">Close</span><span class="op" id="430623">(</span><span class="op" id="430624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="430628">if</span>&nbsp;<span class="ident" id="430631">g</span><span class="op" id="430632">,</span>&nbsp;<span class="ident" id="430634">e</span>&nbsp;<span class="op" id="430636">:=</span>&nbsp;<span class="ident" id="430639">res</span><span class="op" id="430642">.</span><span class="ident" id="430643">Request</span><span class="op" id="430650">.</span><span class="ident" id="430651">URL</span><span class="op" id="430654">.</span><span class="ident" id="430655">Path</span><span class="op" id="430659">,</span>&nbsp;<span class="ident" id="430661">data</span><span class="op" id="430665">.</span><span class="ident" id="430666">redirect</span><span class="op" id="430674">;</span>&nbsp;<span class="ident" id="430676">g</span>&nbsp;<span class="op" id="430678">!=</span>&nbsp;<span class="ident" id="430681">e</span>&nbsp;<span class="op" id="430683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="430688">t</span><span class="op" id="430689">.</span><span class="ident" id="430690">Errorf</span><span class="op" id="430696">(</span><span class="string" id="430697">&#34;redirect&nbsp;from&nbsp;%s:&nbsp;got&nbsp;%s,&nbsp;want&nbsp;%s&#34;</span><span class="op" id="430732">,</span>&nbsp;<span class="ident" id="430734">data</span><span class="op" id="430738">.</span><span class="ident" id="430739">original</span><span class="op" id="430747">,</span>&nbsp;<span class="ident" id="430749">g</span><span class="op" id="430750">,</span>&nbsp;<span class="ident" id="430752">e</span><span class="op" id="430753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="430757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="430760">}</span><br>
<span class="lineno">195</span><span class="op" id="430762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="430765">type</span>&nbsp;<span class="ident" id="430770">testFileSystem</span>&nbsp;<span class="keyword" id="430785">struct</span>&nbsp;<span class="op" id="430792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="430795">open</span>&nbsp;<span class="keyword" id="430800">func</span><span class="op" id="430804">(</span><span class="ident" id="430805">name</span>&nbsp;<span class="builtintype" id="430810">string</span><span class="op" id="430816">)</span>&nbsp;<span class="op" id="430818">(</span><span class="ident" id="430819">File</span><span class="op" id="430823">,</span>&nbsp;<span class="builtintype" id="430825">error</span><span class="op" id="430830">)</span><br>
<span class="lineno"></span><span class="op" id="430832">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="430835">func</span>&nbsp;<span class="op" id="430840">(</span><span class="ident" id="430841">fs</span>&nbsp;<span class="op" id="430844">*</span><span class="ident" id="430845">testFileSystem</span><span class="op" id="430859">)</span>&nbsp;<span class="ident" id="430861">Open</span><span class="op" id="430865">(</span><span class="ident" id="430866">name</span>&nbsp;<span class="builtintype" id="430871">string</span><span class="op" id="430877">)</span>&nbsp;<span class="op" id="430879">(</span><span class="ident" id="430880">File</span><span class="op" id="430884">,</span>&nbsp;<span class="builtintype" id="430886">error</span><span class="op" id="430891">)</span>&nbsp;<span class="op" id="430893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="430896">return</span>&nbsp;<span class="ident" id="430903">fs</span><span class="op" id="430905">.</span><span class="ident" id="430906">open</span><span class="op" id="430910">(</span><span class="ident" id="430911">name</span><span class="op" id="430915">)</span><br>
<span class="lineno"></span><span class="op" id="430917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="keyword" id="430920">func</span>&nbsp;<span class="ident" id="430925">TestFileServerCleans</span><span class="op" id="430945">(</span><span class="ident" id="430946">t</span>&nbsp;<span class="op" id="430948">*</span><span class="ident" id="430949">testing</span><span class="op" id="430956">.</span><span class="ident" id="430957">T</span><span class="op" id="430958">)</span>&nbsp;<span class="op" id="430960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="430963">defer</span>&nbsp;<span class="ident" id="430969">afterTest</span><span class="op" id="430978">(</span><span class="ident" id="430979">t</span><span class="op" id="430980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="430983">ch</span>&nbsp;<span class="op" id="430986">:=</span>&nbsp;<span class="builtinfunc" id="430989">make</span><span class="op" id="430993">(</span><span class="keyword" id="430994">chan</span>&nbsp;<span class="builtintype" id="430999">string</span><span class="op" id="431005">,</span>&nbsp;<span class="num" id="431007">1</span><span class="op" id="431008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="431011">fs</span>&nbsp;<span class="op" id="431014">:=</span>&nbsp;<span class="ident" id="431017">FileServer</span><span class="op" id="431027">(</span><span class="op" id="431028">&amp;</span><span class="ident" id="431029">testFileSystem</span><span class="op" id="431043">{</span><span class="keyword" id="431044">func</span><span class="op" id="431048">(</span><span class="ident" id="431049">name</span>&nbsp;<span class="builtintype" id="431054">string</span><span class="op" id="431060">)</span>&nbsp;<span class="op" id="431062">(</span><span class="ident" id="431063">File</span><span class="op" id="431067">,</span>&nbsp;<span class="builtintype" id="431069">error</span><span class="op" id="431074">)</span>&nbsp;<span class="op" id="431076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="431080">ch</span>&nbsp;<span class="op" id="431083">&lt;-</span>&nbsp;<span class="ident" id="431086">name</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="431093">return</span>&nbsp;<span class="ident" id="431100">nil</span><span class="op" id="431103">,</span>&nbsp;<span class="ident" id="431105">errors</span><span class="op" id="431111">.</span><span class="ident" id="431112">New</span><span class="op" id="431115">(</span><span class="string" id="431116">&#34;file&nbsp;does&nbsp;not&nbsp;exist&#34;</span><span class="op" id="431137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="431140">}</span><span class="op" id="431141">}</span><span class="op" id="431142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="431145">tests</span>&nbsp;<span class="op" id="431151">:=</span>&nbsp;<span class="op" id="431154">[</span><span class="op" id="431155">]</span><span class="keyword" id="431156">struct</span>&nbsp;<span class="op" id="431163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="431167">reqPath</span><span class="op" id="431174">,</span>&nbsp;<span class="ident" id="431176">openArg</span>&nbsp;<span class="builtintype" id="431184">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="431192">}</span><span class="op" id="431193">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="431197">{</span><span class="string" id="431198">&#34;/foo.txt&#34;</span><span class="op" id="431208">,</span>&nbsp;<span class="string" id="431210">&#34;/foo.txt&#34;</span><span class="op" id="431220">}</span><span class="op" id="431221">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="431225">{</span><span class="string" id="431226">&#34;//foo.txt&#34;</span><span class="op" id="431237">,</span>&nbsp;<span class="string" id="431239">&#34;/foo.txt&#34;</span><span class="op" id="431249">}</span><span class="op" id="431250">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="431254">{</span><span class="string" id="431255">&#34;/../foo.txt&#34;</span><span class="op" id="431268">,</span>&nbsp;<span class="string" id="431270">&#34;/foo.txt&#34;</span><span class="op" id="431280">}</span><span class="op" id="431281">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="431284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="431287">req</span><span class="op" id="431290">,</span>&nbsp;<span class="ident" id="431292">_</span>&nbsp;<span class="op" id="431294">:=</span>&nbsp;<span class="ident" id="431297">NewRequest</span><span class="op" id="431307">(</span><span class="string" id="431308">&#34;GET&#34;</span><span class="op" id="431313">,</span>&nbsp;<span class="string" id="431315">&#34;http://example.com&#34;</span><span class="op" id="431335">,</span>&nbsp;<span class="ident" id="431337">nil</span><span class="op" id="431340">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="431343">for</span>&nbsp;<span class="ident" id="431347">n</span><span class="op" id="431348">,</span>&nbsp;<span class="ident" id="431350">test</span>&nbsp;<span class="op" id="431355">:=</span>&nbsp;<span class="keyword" id="431358">range</span>&nbsp;<span class="ident" id="431364">tests</span>&nbsp;<span class="op" id="431370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="431374">rec</span>&nbsp;<span class="op" id="431378">:=</span>&nbsp;<span class="ident" id="431381">httptest</span><span class="op" id="431389">.</span><span class="ident" id="431390">NewRecorder</span><span class="op" id="431401">(</span><span class="op" id="431402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="431406">req</span><span class="op" id="431409">.</span><span class="ident" id="431410">URL</span><span class="op" id="431413">.</span><span class="ident" id="431414">Path</span>&nbsp;<span class="op" id="431419">=</span>&nbsp;<span class="ident" id="431421">test</span><span class="op" id="431425">.</span><span class="ident" id="431426">reqPath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="431436">fs</span><span class="op" id="431438">.</span><span class="ident" id="431439">ServeHTTP</span><span class="op" id="431448">(</span><span class="ident" id="431449">rec</span><span class="op" id="431452">,</span>&nbsp;<span class="ident" id="431454">req</span><span class="op" id="431457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="431461">if</span>&nbsp;<span class="ident" id="431464">got</span>&nbsp;<span class="op" id="431468">:=</span>&nbsp;<span class="op" id="431471">&lt;-</span><span class="ident" id="431473">ch</span><span class="op" id="431475">;</span>&nbsp;<span class="ident" id="431477">got</span>&nbsp;<span class="op" id="431481">!=</span>&nbsp;<span class="ident" id="431484">test</span><span class="op" id="431488">.</span><span class="ident" id="431489">openArg</span>&nbsp;<span class="op" id="431497">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="431502">t</span><span class="op" id="431503">.</span><span class="ident" id="431504">Errorf</span><span class="op" id="431510">(</span><span class="string" id="431511">&#34;test&nbsp;%d:&nbsp;got&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="431537">,</span>&nbsp;<span class="ident" id="431539">n</span><span class="op" id="431540">,</span>&nbsp;<span class="ident" id="431542">got</span><span class="op" id="431545">,</span>&nbsp;<span class="ident" id="431547">test</span><span class="op" id="431551">.</span><span class="ident" id="431552">openArg</span><span class="op" id="431559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="431563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="431566">}</span><br>
<span class="lineno"></span><span class="op" id="431568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="431571">func</span>&nbsp;<span class="ident" id="431576">TestFileServerEscapesNames</span><span class="op" id="431602">(</span><span class="ident" id="431603">t</span>&nbsp;<span class="op" id="431605">*</span><span class="ident" id="431606">testing</span><span class="op" id="431613">.</span><span class="ident" id="431614">T</span><span class="op" id="431615">)</span>&nbsp;<span class="op" id="431617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="431620">defer</span>&nbsp;<span class="ident" id="431626">afterTest</span><span class="op" id="431635">(</span><span class="ident" id="431636">t</span><span class="op" id="431637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="431640">const</span>&nbsp;<span class="ident" id="431646">dirListPrefix</span>&nbsp;<span class="op" id="431660">=</span>&nbsp;<span class="string" id="431662">&#34;&lt;pre&gt;\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="431673">const</span>&nbsp;<span class="ident" id="431679">dirListSuffix</span>&nbsp;<span class="op" id="431693">=</span>&nbsp;<span class="string" id="431695">&#34;\n&lt;/pre&gt;\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="431709">tests</span>&nbsp;<span class="op" id="431715">:=</span>&nbsp;<span class="op" id="431718">[</span><span class="op" id="431719">]</span><span class="keyword" id="431720">struct</span>&nbsp;<span class="op" id="431727">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="431731">name</span><span class="op" id="431735">,</span>&nbsp;<span class="ident" id="431737">escaped</span>&nbsp;<span class="builtintype" id="431745">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="431753">}</span><span class="op" id="431754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="431758">{</span><span class="string" id="431759">`simple_name`</span><span class="op" id="431772">,</span>&nbsp;<span class="string" id="431774">`&lt;a&nbsp;href=&#34;simple_name&#34;&gt;simple_name&lt;/a&gt;`</span><span class="op" id="431813">}</span><span class="op" id="431814">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="431818">{</span><span class="string" id="431819">`&#34;&#39;&lt;&gt;&amp;`</span><span class="op" id="431826">,</span>&nbsp;<span class="string" id="431828">`&lt;a&nbsp;href=&#34;%22%27%3C%3E&amp;&#34;&gt;&amp;#34;&amp;#39;&amp;lt;&amp;gt;&amp;amp;&lt;/a&gt;`</span><span class="op" id="431881">}</span><span class="op" id="431882">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="431886">{</span><span class="string" id="431887">`?foo=bar#baz`</span><span class="op" id="431901">,</span>&nbsp;<span class="string" id="431903">`&lt;a&nbsp;href=&#34;%3Ffoo=bar%23baz&#34;&gt;?foo=bar#baz&lt;/a&gt;`</span><span class="op" id="431948">}</span><span class="op" id="431949">,</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="431953">{</span><span class="string" id="431954">`&lt;combo&gt;?foo`</span><span class="op" id="431967">,</span>&nbsp;<span class="string" id="431969">`&lt;a&nbsp;href=&#34;%3Ccombo%3E%3Ffoo&#34;&gt;&amp;lt;combo&amp;gt;?foo&lt;/a&gt;`</span><span class="op" id="432020">}</span><span class="op" id="432021">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="432024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="432028">//&nbsp;We&nbsp;put&nbsp;each&nbsp;test&nbsp;file&nbsp;in&nbsp;its&nbsp;own&nbsp;directory&nbsp;in&nbsp;the&nbsp;fakeFS&nbsp;so&nbsp;we&nbsp;can&nbsp;look&nbsp;at&nbsp;it&nbsp;in&nbsp;isolation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="432124">fs</span>&nbsp;<span class="op" id="432127">:=</span>&nbsp;<span class="builtinfunc" id="432130">make</span><span class="op" id="432134">(</span><span class="ident" id="432135">fakeFS</span><span class="op" id="432141">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="432144">for</span>&nbsp;<span class="ident" id="432148">i</span><span class="op" id="432149">,</span>&nbsp;<span class="ident" id="432151">test</span>&nbsp;<span class="op" id="432156">:=</span>&nbsp;<span class="keyword" id="432159">range</span>&nbsp;<span class="ident" id="432165">tests</span>&nbsp;<span class="op" id="432171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="432175">testFile</span>&nbsp;<span class="op" id="432184">:=</span>&nbsp;<span class="op" id="432187">&amp;</span><span class="ident" id="432188">fakeFileInfo</span><span class="op" id="432200">{</span><span class="ident" id="432201">basename</span><span class="op" id="432209">:</span>&nbsp;<span class="ident" id="432211">test</span><span class="op" id="432215">.</span><span class="ident" id="432216">name</span><span class="op" id="432220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="432224">fs</span><span class="op" id="432226">[</span><span class="ident" id="432227">fmt</span><span class="op" id="432230">.</span><span class="ident" id="432231">Sprintf</span><span class="op" id="432238">(</span><span class="string" id="432239">&#34;/%d&#34;</span><span class="op" id="432244">,</span>&nbsp;<span class="ident" id="432246">i</span><span class="op" id="432247">)</span><span class="op" id="432248">]</span>&nbsp;<span class="op" id="432250">=</span>&nbsp;<span class="op" id="432252">&amp;</span><span class="ident" id="432253">fakeFileInfo</span><span class="op" id="432265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="432270">dir</span><span class="op" id="432273">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="432279">true</span><span class="op" id="432283">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="432288">modtime</span><span class="op" id="432295">:</span>&nbsp;<span class="ident" id="432297">time</span><span class="op" id="432301">.</span><span class="ident" id="432302">Unix</span><span class="op" id="432306">(</span><span class="num" id="432307">1000000000</span><span class="op" id="432317">,</span>&nbsp;<span class="num" id="432319">0</span><span class="op" id="432320">)</span><span class="op" id="432321">.</span><span class="ident" id="432322">UTC</span><span class="op" id="432325">(</span><span class="op" id="432326">)</span><span class="op" id="432327">,</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="432332">ents</span><span class="op" id="432336">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="432341">[</span><span class="op" id="432342">]</span><span class="op" id="432343">*</span><span class="ident" id="432344">fakeFileInfo</span><span class="op" id="432356">{</span><span class="ident" id="432357">testFile</span><span class="op" id="432365">}</span><span class="op" id="432366">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="432370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="432374">fs</span><span class="op" id="432376">[</span><span class="ident" id="432377">fmt</span><span class="op" id="432380">.</span><span class="ident" id="432381">Sprintf</span><span class="op" id="432388">(</span><span class="string" id="432389">&#34;/%d/%s&#34;</span><span class="op" id="432397">,</span>&nbsp;<span class="ident" id="432399">i</span><span class="op" id="432400">,</span>&nbsp;<span class="ident" id="432402">test</span><span class="op" id="432406">.</span><span class="ident" id="432407">name</span><span class="op" id="432411">)</span><span class="op" id="432412">]</span>&nbsp;<span class="op" id="432414">=</span>&nbsp;<span class="ident" id="432416">testFile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="432426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="432430">ts</span>&nbsp;<span class="op" id="432433">:=</span>&nbsp;<span class="ident" id="432436">httptest</span><span class="op" id="432444">.</span><span class="ident" id="432445">NewServer</span><span class="op" id="432454">(</span><span class="ident" id="432455">FileServer</span><span class="op" id="432465">(</span><span class="op" id="432466">&amp;</span><span class="ident" id="432467">fs</span><span class="op" id="432469">)</span><span class="op" id="432470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="432473">defer</span>&nbsp;<span class="ident" id="432479">ts</span><span class="op" id="432481">.</span><span class="ident" id="432482">Close</span><span class="op" id="432487">(</span><span class="op" id="432488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="432491">for</span>&nbsp;<span class="ident" id="432495">i</span><span class="op" id="432496">,</span>&nbsp;<span class="ident" id="432498">test</span>&nbsp;<span class="op" id="432503">:=</span>&nbsp;<span class="keyword" id="432506">range</span>&nbsp;<span class="ident" id="432512">tests</span>&nbsp;<span class="op" id="432518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="432522">url</span>&nbsp;<span class="op" id="432526">:=</span>&nbsp;<span class="ident" id="432529">fmt</span><span class="op" id="432532">.</span><span class="ident" id="432533">Sprintf</span><span class="op" id="432540">(</span><span class="string" id="432541">&#34;%s/%d&#34;</span><span class="op" id="432548">,</span>&nbsp;<span class="ident" id="432550">ts</span><span class="op" id="432552">.</span><span class="ident" id="432553">URL</span><span class="op" id="432556">,</span>&nbsp;<span class="ident" id="432558">i</span><span class="op" id="432559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="432563">res</span><span class="op" id="432566">,</span>&nbsp;<span class="ident" id="432568">err</span>&nbsp;<span class="op" id="432572">:=</span>&nbsp;<span class="ident" id="432575">Get</span><span class="op" id="432578">(</span><span class="ident" id="432579">url</span><span class="op" id="432582">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="432586">if</span>&nbsp;<span class="ident" id="432589">err</span>&nbsp;<span class="op" id="432593">!=</span>&nbsp;<span class="ident" id="432596">nil</span>&nbsp;<span class="op" id="432600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="432605">t</span><span class="op" id="432606">.</span><span class="ident" id="432607">Fatalf</span><span class="op" id="432613">(</span><span class="string" id="432614">&#34;test&nbsp;%q:&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="432632">,</span>&nbsp;<span class="ident" id="432634">test</span><span class="op" id="432638">.</span><span class="ident" id="432639">name</span><span class="op" id="432643">,</span>&nbsp;<span class="ident" id="432645">err</span><span class="op" id="432648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="432652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="432656">b</span><span class="op" id="432657">,</span>&nbsp;<span class="ident" id="432659">err</span>&nbsp;<span class="op" id="432663">:=</span>&nbsp;<span class="ident" id="432666">ioutil</span><span class="op" id="432672">.</span><span class="ident" id="432673">ReadAll</span><span class="op" id="432680">(</span><span class="ident" id="432681">res</span><span class="op" id="432684">.</span><span class="ident" id="432685">Body</span><span class="op" id="432689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="432693">if</span>&nbsp;<span class="ident" id="432696">err</span>&nbsp;<span class="op" id="432700">!=</span>&nbsp;<span class="ident" id="432703">nil</span>&nbsp;<span class="op" id="432707">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="432712">t</span><span class="op" id="432713">.</span><span class="ident" id="432714">Fatalf</span><span class="op" id="432720">(</span><span class="string" id="432721">&#34;test&nbsp;%q:&nbsp;read&nbsp;Body:&nbsp;%v&#34;</span><span class="op" id="432745">,</span>&nbsp;<span class="ident" id="432747">test</span><span class="op" id="432751">.</span><span class="ident" id="432752">name</span><span class="op" id="432756">,</span>&nbsp;<span class="ident" id="432758">err</span><span class="op" id="432761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="432765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="432769">s</span>&nbsp;<span class="op" id="432771">:=</span>&nbsp;<span class="builtintype" id="432774">string</span><span class="op" id="432780">(</span><span class="ident" id="432781">b</span><span class="op" id="432782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="432786">if</span>&nbsp;<span class="op" id="432789">!</span><span class="ident" id="432790">strings</span><span class="op" id="432797">.</span><span class="ident" id="432798">HasPrefix</span><span class="op" id="432807">(</span><span class="ident" id="432808">s</span><span class="op" id="432809">,</span>&nbsp;<span class="ident" id="432811">dirListPrefix</span><span class="op" id="432824">)</span>&nbsp;<span class="op" id="432826">||</span>&nbsp;<span class="op" id="432829">!</span><span class="ident" id="432830">strings</span><span class="op" id="432837">.</span><span class="ident" id="432838">HasSuffix</span><span class="op" id="432847">(</span><span class="ident" id="432848">s</span><span class="op" id="432849">,</span>&nbsp;<span class="ident" id="432851">dirListSuffix</span><span class="op" id="432864">)</span>&nbsp;<span class="op" id="432866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="432871">t</span><span class="op" id="432872">.</span><span class="ident" id="432873">Errorf</span><span class="op" id="432879">(</span><span class="string" id="432880">&#34;test&nbsp;%q:&nbsp;listing&nbsp;dir,&nbsp;full&nbsp;output&nbsp;is&nbsp;%q,&nbsp;want&nbsp;prefix&nbsp;%q&nbsp;and&nbsp;suffix&nbsp;%q&#34;</span><span class="op" id="432951">,</span>&nbsp;<span class="ident" id="432953">test</span><span class="op" id="432957">.</span><span class="ident" id="432958">name</span><span class="op" id="432962">,</span>&nbsp;<span class="ident" id="432964">s</span><span class="op" id="432965">,</span>&nbsp;<span class="ident" id="432967">dirListPrefix</span><span class="op" id="432980">,</span>&nbsp;<span class="ident" id="432982">dirListSuffix</span><span class="op" id="432995">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="432999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="433003">if</span>&nbsp;<span class="ident" id="433006">trimmed</span>&nbsp;<span class="op" id="433014">:=</span>&nbsp;<span class="ident" id="433017">strings</span><span class="op" id="433024">.</span><span class="ident" id="433025">TrimSuffix</span><span class="op" id="433035">(</span><span class="ident" id="433036">strings</span><span class="op" id="433043">.</span><span class="ident" id="433044">TrimPrefix</span><span class="op" id="433054">(</span><span class="ident" id="433055">s</span><span class="op" id="433056">,</span>&nbsp;<span class="ident" id="433058">dirListPrefix</span><span class="op" id="433071">)</span><span class="op" id="433072">,</span>&nbsp;<span class="ident" id="433074">dirListSuffix</span><span class="op" id="433087">)</span><span class="op" id="433088">;</span>&nbsp;<span class="ident" id="433090">trimmed</span>&nbsp;<span class="op" id="433098">!=</span>&nbsp;<span class="ident" id="433101">test</span><span class="op" id="433105">.</span><span class="ident" id="433106">escaped</span>&nbsp;<span class="op" id="433114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="433119">t</span><span class="op" id="433120">.</span><span class="ident" id="433121">Errorf</span><span class="op" id="433127">(</span><span class="string" id="433128">&#34;test&nbsp;%q:&nbsp;listing&nbsp;dir,&nbsp;filename&nbsp;escaped&nbsp;to&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="433183">,</span>&nbsp;<span class="ident" id="433185">test</span><span class="op" id="433189">.</span><span class="ident" id="433190">name</span><span class="op" id="433194">,</span>&nbsp;<span class="ident" id="433196">trimmed</span><span class="op" id="433203">,</span>&nbsp;<span class="ident" id="433205">test</span><span class="op" id="433209">.</span><span class="ident" id="433210">escaped</span><span class="op" id="433217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="433221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="433225">res</span><span class="op" id="433228">.</span><span class="ident" id="433229">Body</span><span class="op" id="433233">.</span><span class="ident" id="433234">Close</span><span class="op" id="433239">(</span><span class="op" id="433240">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="433243">}</span><br>
<span class="lineno"></span><span class="op" id="433245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="433248">func</span>&nbsp;<span class="ident" id="433253">mustRemoveAll</span><span class="op" id="433266">(</span><span class="ident" id="433267">dir</span>&nbsp;<span class="builtintype" id="433271">string</span><span class="op" id="433277">)</span>&nbsp;<span class="op" id="433279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="433282">err</span>&nbsp;<span class="op" id="433286">:=</span>&nbsp;<span class="ident" id="433289">os</span><span class="op" id="433291">.</span><span class="ident" id="433292">RemoveAll</span><span class="op" id="433301">(</span><span class="ident" id="433302">dir</span><span class="op" id="433305">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="433308">if</span>&nbsp;<span class="ident" id="433311">err</span>&nbsp;<span class="op" id="433315">!=</span>&nbsp;<span class="ident" id="433318">nil</span>&nbsp;<span class="op" id="433322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="433326">panic</span><span class="op" id="433331">(</span><span class="ident" id="433332">err</span><span class="op" id="433335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="433338">}</span><br>
<span class="lineno"></span><span class="op" id="433340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="433343">func</span>&nbsp;<span class="ident" id="433348">TestFileServerImplicitLeadingSlash</span><span class="op" id="433382">(</span><span class="ident" id="433383">t</span>&nbsp;<span class="op" id="433385">*</span><span class="ident" id="433386">testing</span><span class="op" id="433393">.</span><span class="ident" id="433394">T</span><span class="op" id="433395">)</span>&nbsp;<span class="op" id="433397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="433400">defer</span>&nbsp;<span class="ident" id="433406">afterTest</span><span class="op" id="433415">(</span><span class="ident" id="433416">t</span><span class="op" id="433417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="433420">tempDir</span><span class="op" id="433427">,</span>&nbsp;<span class="ident" id="433429">err</span>&nbsp;<span class="op" id="433433">:=</span>&nbsp;<span class="ident" id="433436">ioutil</span><span class="op" id="433442">.</span><span class="ident" id="433443">TempDir</span><span class="op" id="433450">(</span><span class="string" id="433451">&#34;&#34;</span><span class="op" id="433453">,</span>&nbsp;<span class="string" id="433455">&#34;&#34;</span><span class="op" id="433457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="433460">if</span>&nbsp;<span class="ident" id="433463">err</span>&nbsp;<span class="op" id="433467">!=</span>&nbsp;<span class="ident" id="433470">nil</span>&nbsp;<span class="op" id="433474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="433478">t</span><span class="op" id="433479">.</span><span class="ident" id="433480">Fatalf</span><span class="op" id="433486">(</span><span class="string" id="433487">&#34;TempDir:&nbsp;%v&#34;</span><span class="op" id="433500">,</span>&nbsp;<span class="ident" id="433502">err</span><span class="op" id="433505">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="433508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="433511">defer</span>&nbsp;<span class="ident" id="433517">mustRemoveAll</span><span class="op" id="433530">(</span><span class="ident" id="433531">tempDir</span><span class="op" id="433538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="433541">if</span>&nbsp;<span class="ident" id="433544">err</span>&nbsp;<span class="op" id="433548">:=</span>&nbsp;<span class="ident" id="433551">ioutil</span><span class="op" id="433557">.</span><span class="ident" id="433558">WriteFile</span><span class="op" id="433567">(</span><span class="ident" id="433568">filepath</span><span class="op" id="433576">.</span><span class="ident" id="433577">Join</span><span class="op" id="433581">(</span><span class="ident" id="433582">tempDir</span><span class="op" id="433589">,</span>&nbsp;<span class="string" id="433591">&#34;foo.txt&#34;</span><span class="op" id="433600">)</span><span class="op" id="433601">,</span>&nbsp;<span class="op" id="433603">[</span><span class="op" id="433604">]</span><span class="builtintype" id="433605">byte</span><span class="op" id="433609">(</span><span class="string" id="433610">&#34;Hello&nbsp;world&#34;</span><span class="op" id="433623">)</span><span class="op" id="433624">,</span>&nbsp;<span class="num" id="433626">0644</span><span class="op" id="433630">)</span><span class="op" id="433631">;</span>&nbsp;<span class="ident" id="433633">err</span>&nbsp;<span class="op" id="433637">!=</span>&nbsp;<span class="ident" id="433640">nil</span>&nbsp;<span class="op" id="433644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="433648">t</span><span class="op" id="433649">.</span><span class="ident" id="433650">Fatalf</span><span class="op" id="433656">(</span><span class="string" id="433657">&#34;WriteFile:&nbsp;%v&#34;</span><span class="op" id="433672">,</span>&nbsp;<span class="ident" id="433674">err</span><span class="op" id="433677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="433680">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="433683">ts</span>&nbsp;<span class="op" id="433686">:=</span>&nbsp;<span class="ident" id="433689">httptest</span><span class="op" id="433697">.</span><span class="ident" id="433698">NewServer</span><span class="op" id="433707">(</span><span class="ident" id="433708">StripPrefix</span><span class="op" id="433719">(</span><span class="string" id="433720">&#34;/bar/&#34;</span><span class="op" id="433727">,</span>&nbsp;<span class="ident" id="433729">FileServer</span><span class="op" id="433739">(</span><span class="ident" id="433740">Dir</span><span class="op" id="433743">(</span><span class="ident" id="433744">tempDir</span><span class="op" id="433751">)</span><span class="op" id="433752">)</span><span class="op" id="433753">)</span><span class="op" id="433754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="433757">defer</span>&nbsp;<span class="ident" id="433763">ts</span><span class="op" id="433765">.</span><span class="ident" id="433766">Close</span><span class="op" id="433771">(</span><span class="op" id="433772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="433775">get</span>&nbsp;<span class="op" id="433779">:=</span>&nbsp;<span class="keyword" id="433782">func</span><span class="op" id="433786">(</span><span class="ident" id="433787">suffix</span>&nbsp;<span class="builtintype" id="433794">string</span><span class="op" id="433800">)</span>&nbsp;<span class="builtintype" id="433802">string</span>&nbsp;<span class="op" id="433809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="433813">res</span><span class="op" id="433816">,</span>&nbsp;<span class="ident" id="433818">err</span>&nbsp;<span class="op" id="433822">:=</span>&nbsp;<span class="ident" id="433825">Get</span><span class="op" id="433828">(</span><span class="ident" id="433829">ts</span><span class="op" id="433831">.</span><span class="ident" id="433832">URL</span>&nbsp;<span class="op" id="433836">+</span>&nbsp;<span class="ident" id="433838">suffix</span><span class="op" id="433844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="433848">if</span>&nbsp;<span class="ident" id="433851">err</span>&nbsp;<span class="op" id="433855">!=</span>&nbsp;<span class="ident" id="433858">nil</span>&nbsp;<span class="op" id="433862">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="433867">t</span><span class="op" id="433868">.</span><span class="ident" id="433869">Fatalf</span><span class="op" id="433875">(</span><span class="string" id="433876">&#34;Get&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="433888">,</span>&nbsp;<span class="ident" id="433890">suffix</span><span class="op" id="433896">,</span>&nbsp;<span class="ident" id="433898">err</span><span class="op" id="433901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="433905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="433909">b</span><span class="op" id="433910">,</span>&nbsp;<span class="ident" id="433912">err</span>&nbsp;<span class="op" id="433916">:=</span>&nbsp;<span class="ident" id="433919">ioutil</span><span class="op" id="433925">.</span><span class="ident" id="433926">ReadAll</span><span class="op" id="433933">(</span><span class="ident" id="433934">res</span><span class="op" id="433937">.</span><span class="ident" id="433938">Body</span><span class="op" id="433942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="433946">if</span>&nbsp;<span class="ident" id="433949">err</span>&nbsp;<span class="op" id="433953">!=</span>&nbsp;<span class="ident" id="433956">nil</span>&nbsp;<span class="op" id="433960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="433965">t</span><span class="op" id="433966">.</span><span class="ident" id="433967">Fatalf</span><span class="op" id="433973">(</span><span class="string" id="433974">&#34;ReadAll&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="433990">,</span>&nbsp;<span class="ident" id="433992">suffix</span><span class="op" id="433998">,</span>&nbsp;<span class="ident" id="434000">err</span><span class="op" id="434003">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="434007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434011">res</span><span class="op" id="434014">.</span><span class="ident" id="434015">Body</span><span class="op" id="434019">.</span><span class="ident" id="434020">Close</span><span class="op" id="434025">(</span><span class="op" id="434026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="434030">return</span>&nbsp;<span class="builtintype" id="434037">string</span><span class="op" id="434043">(</span><span class="ident" id="434044">b</span><span class="op" id="434045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="434048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="434051">if</span>&nbsp;<span class="ident" id="434054">s</span>&nbsp;<span class="op" id="434056">:=</span>&nbsp;<span class="ident" id="434059">get</span><span class="op" id="434062">(</span><span class="string" id="434063">&#34;/bar/&#34;</span><span class="op" id="434070">)</span><span class="op" id="434071">;</span>&nbsp;<span class="op" id="434073">!</span><span class="ident" id="434074">strings</span><span class="op" id="434081">.</span><span class="ident" id="434082">Contains</span><span class="op" id="434090">(</span><span class="ident" id="434091">s</span><span class="op" id="434092">,</span>&nbsp;<span class="string" id="434094">&#34;&gt;foo.txt&lt;&#34;</span><span class="op" id="434105">)</span>&nbsp;<span class="op" id="434107">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434111">t</span><span class="op" id="434112">.</span><span class="ident" id="434113">Logf</span><span class="op" id="434117">(</span><span class="string" id="434118">&#34;expected&nbsp;a&nbsp;directory&nbsp;listing&nbsp;with&nbsp;foo.txt,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="434169">,</span>&nbsp;<span class="ident" id="434171">s</span><span class="op" id="434172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="434175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="434178">if</span>&nbsp;<span class="ident" id="434181">s</span>&nbsp;<span class="op" id="434183">:=</span>&nbsp;<span class="ident" id="434186">get</span><span class="op" id="434189">(</span><span class="string" id="434190">&#34;/bar/foo.txt&#34;</span><span class="op" id="434204">)</span><span class="op" id="434205">;</span>&nbsp;<span class="ident" id="434207">s</span>&nbsp;<span class="op" id="434209">!=</span>&nbsp;<span class="string" id="434212">&#34;Hello&nbsp;world&#34;</span>&nbsp;<span class="op" id="434226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434230">t</span><span class="op" id="434231">.</span><span class="ident" id="434232">Logf</span><span class="op" id="434236">(</span><span class="string" id="434237">&#34;expected&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="434258">,</span>&nbsp;<span class="string" id="434260">&#34;Hello&nbsp;world&#34;</span><span class="op" id="434273">,</span>&nbsp;<span class="ident" id="434275">s</span><span class="op" id="434276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="434279">}</span><br>
<span class="lineno">315</span><span class="op" id="434281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="434284">func</span>&nbsp;<span class="ident" id="434289">TestDirJoin</span><span class="op" id="434300">(</span><span class="ident" id="434301">t</span>&nbsp;<span class="op" id="434303">*</span><span class="ident" id="434304">testing</span><span class="op" id="434311">.</span><span class="ident" id="434312">T</span><span class="op" id="434313">)</span>&nbsp;<span class="op" id="434315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="434318">if</span>&nbsp;<span class="ident" id="434321">runtime</span><span class="op" id="434328">.</span><span class="ident" id="434329">GOOS</span>&nbsp;<span class="op" id="434334">==</span>&nbsp;<span class="string" id="434337">&#34;windows&#34;</span>&nbsp;<span class="op" id="434347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434351">t</span><span class="op" id="434352">.</span><span class="ident" id="434353">Skip</span><span class="op" id="434357">(</span><span class="string" id="434358">&#34;skipping&nbsp;test&nbsp;on&nbsp;windows&#34;</span><span class="op" id="434384">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="434387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434390">wfi</span><span class="op" id="434393">,</span>&nbsp;<span class="ident" id="434395">err</span>&nbsp;<span class="op" id="434399">:=</span>&nbsp;<span class="ident" id="434402">os</span><span class="op" id="434404">.</span><span class="ident" id="434405">Stat</span><span class="op" id="434409">(</span><span class="string" id="434410">&#34;/etc/hosts&#34;</span><span class="op" id="434422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="434425">if</span>&nbsp;<span class="ident" id="434428">err</span>&nbsp;<span class="op" id="434432">!=</span>&nbsp;<span class="ident" id="434435">nil</span>&nbsp;<span class="op" id="434439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434443">t</span><span class="op" id="434444">.</span><span class="ident" id="434445">Skip</span><span class="op" id="434449">(</span><span class="string" id="434450">&#34;skipping&nbsp;test;&nbsp;no&nbsp;/etc/hosts&nbsp;file&#34;</span><span class="op" id="434485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="434488">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434491">test</span>&nbsp;<span class="op" id="434496">:=</span>&nbsp;<span class="keyword" id="434499">func</span><span class="op" id="434503">(</span><span class="ident" id="434504">d</span>&nbsp;<span class="ident" id="434506">Dir</span><span class="op" id="434509">,</span>&nbsp;<span class="ident" id="434511">name</span>&nbsp;<span class="builtintype" id="434516">string</span><span class="op" id="434522">)</span>&nbsp;<span class="op" id="434524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434528">f</span><span class="op" id="434529">,</span>&nbsp;<span class="ident" id="434531">err</span>&nbsp;<span class="op" id="434535">:=</span>&nbsp;<span class="ident" id="434538">d</span><span class="op" id="434539">.</span><span class="ident" id="434540">Open</span><span class="op" id="434544">(</span><span class="ident" id="434545">name</span><span class="op" id="434549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="434553">if</span>&nbsp;<span class="ident" id="434556">err</span>&nbsp;<span class="op" id="434560">!=</span>&nbsp;<span class="ident" id="434563">nil</span>&nbsp;<span class="op" id="434567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434572">t</span><span class="op" id="434573">.</span><span class="ident" id="434574">Fatalf</span><span class="op" id="434580">(</span><span class="string" id="434581">&#34;open&nbsp;of&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="434597">,</span>&nbsp;<span class="ident" id="434599">name</span><span class="op" id="434603">,</span>&nbsp;<span class="ident" id="434605">err</span><span class="op" id="434608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="434612">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="434616">defer</span>&nbsp;<span class="ident" id="434622">f</span><span class="op" id="434623">.</span><span class="ident" id="434624">Close</span><span class="op" id="434629">(</span><span class="op" id="434630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434634">gfi</span><span class="op" id="434637">,</span>&nbsp;<span class="ident" id="434639">err</span>&nbsp;<span class="op" id="434643">:=</span>&nbsp;<span class="ident" id="434646">f</span><span class="op" id="434647">.</span><span class="ident" id="434648">Stat</span><span class="op" id="434652">(</span><span class="op" id="434653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="434657">if</span>&nbsp;<span class="ident" id="434660">err</span>&nbsp;<span class="op" id="434664">!=</span>&nbsp;<span class="ident" id="434667">nil</span>&nbsp;<span class="op" id="434671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434676">t</span><span class="op" id="434677">.</span><span class="ident" id="434678">Fatalf</span><span class="op" id="434684">(</span><span class="string" id="434685">&#34;stat&nbsp;of&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="434701">,</span>&nbsp;<span class="ident" id="434703">name</span><span class="op" id="434707">,</span>&nbsp;<span class="ident" id="434709">err</span><span class="op" id="434712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="434716">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="434720">if</span>&nbsp;<span class="op" id="434723">!</span><span class="ident" id="434724">os</span><span class="op" id="434726">.</span><span class="ident" id="434727">SameFile</span><span class="op" id="434735">(</span><span class="ident" id="434736">gfi</span><span class="op" id="434739">,</span>&nbsp;<span class="ident" id="434741">wfi</span><span class="op" id="434744">)</span>&nbsp;<span class="op" id="434746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434751">t</span><span class="op" id="434752">.</span><span class="ident" id="434753">Errorf</span><span class="op" id="434759">(</span><span class="string" id="434760">&#34;%s&nbsp;got&nbsp;different&nbsp;file&#34;</span><span class="op" id="434783">,</span>&nbsp;<span class="ident" id="434785">name</span><span class="op" id="434789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="434793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="434796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434799">test</span><span class="op" id="434803">(</span><span class="ident" id="434804">Dir</span><span class="op" id="434807">(</span><span class="string" id="434808">&#34;/etc/&#34;</span><span class="op" id="434815">)</span><span class="op" id="434816">,</span>&nbsp;<span class="string" id="434818">&#34;/hosts&#34;</span><span class="op" id="434826">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434829">test</span><span class="op" id="434833">(</span><span class="ident" id="434834">Dir</span><span class="op" id="434837">(</span><span class="string" id="434838">&#34;/etc/&#34;</span><span class="op" id="434845">)</span><span class="op" id="434846">,</span>&nbsp;<span class="string" id="434848">&#34;hosts&#34;</span><span class="op" id="434855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434858">test</span><span class="op" id="434862">(</span><span class="ident" id="434863">Dir</span><span class="op" id="434866">(</span><span class="string" id="434867">&#34;/etc/&#34;</span><span class="op" id="434874">)</span><span class="op" id="434875">,</span>&nbsp;<span class="string" id="434877">&#34;../../../../hosts&#34;</span><span class="op" id="434896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434899">test</span><span class="op" id="434903">(</span><span class="ident" id="434904">Dir</span><span class="op" id="434907">(</span><span class="string" id="434908">&#34;/etc&#34;</span><span class="op" id="434914">)</span><span class="op" id="434915">,</span>&nbsp;<span class="string" id="434917">&#34;/hosts&#34;</span><span class="op" id="434925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434928">test</span><span class="op" id="434932">(</span><span class="ident" id="434933">Dir</span><span class="op" id="434936">(</span><span class="string" id="434937">&#34;/etc&#34;</span><span class="op" id="434943">)</span><span class="op" id="434944">,</span>&nbsp;<span class="string" id="434946">&#34;hosts&#34;</span><span class="op" id="434953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="434956">test</span><span class="op" id="434960">(</span><span class="ident" id="434961">Dir</span><span class="op" id="434964">(</span><span class="string" id="434965">&#34;/etc&#34;</span><span class="op" id="434971">)</span><span class="op" id="434972">,</span>&nbsp;<span class="string" id="434974">&#34;../../../../hosts&#34;</span><span class="op" id="434993">)</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="434997">//&nbsp;Not&nbsp;really&nbsp;directories,&nbsp;but&nbsp;since&nbsp;we&nbsp;use&nbsp;this&nbsp;trick&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="435056">//&nbsp;ServeFile,&nbsp;test&nbsp;it:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435080">test</span><span class="op" id="435084">(</span><span class="ident" id="435085">Dir</span><span class="op" id="435088">(</span><span class="string" id="435089">&#34;/etc/hosts&#34;</span><span class="op" id="435101">)</span><span class="op" id="435102">,</span>&nbsp;<span class="string" id="435104">&#34;&#34;</span><span class="op" id="435106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435109">test</span><span class="op" id="435113">(</span><span class="ident" id="435114">Dir</span><span class="op" id="435117">(</span><span class="string" id="435118">&#34;/etc/hosts&#34;</span><span class="op" id="435130">)</span><span class="op" id="435131">,</span>&nbsp;<span class="string" id="435133">&#34;/&#34;</span><span class="op" id="435136">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435139">test</span><span class="op" id="435143">(</span><span class="ident" id="435144">Dir</span><span class="op" id="435147">(</span><span class="string" id="435148">&#34;/etc/hosts&#34;</span><span class="op" id="435160">)</span><span class="op" id="435161">,</span>&nbsp;<span class="string" id="435163">&#34;../&#34;</span><span class="op" id="435168">)</span><br>
<span class="lineno"></span><span class="op" id="435170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="435173">func</span>&nbsp;<span class="ident" id="435178">TestEmptyDirOpenCWD</span><span class="op" id="435197">(</span><span class="ident" id="435198">t</span>&nbsp;<span class="op" id="435200">*</span><span class="ident" id="435201">testing</span><span class="op" id="435208">.</span><span class="ident" id="435209">T</span><span class="op" id="435210">)</span>&nbsp;<span class="op" id="435212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435215">test</span>&nbsp;<span class="op" id="435220">:=</span>&nbsp;<span class="keyword" id="435223">func</span><span class="op" id="435227">(</span><span class="ident" id="435228">d</span>&nbsp;<span class="ident" id="435230">Dir</span><span class="op" id="435233">)</span>&nbsp;<span class="op" id="435235">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435239">name</span>&nbsp;<span class="op" id="435244">:=</span>&nbsp;<span class="string" id="435247">&#34;fs_test.go&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435262">f</span><span class="op" id="435263">,</span>&nbsp;<span class="ident" id="435265">err</span>&nbsp;<span class="op" id="435269">:=</span>&nbsp;<span class="ident" id="435272">d</span><span class="op" id="435273">.</span><span class="ident" id="435274">Open</span><span class="op" id="435278">(</span><span class="ident" id="435279">name</span><span class="op" id="435283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="435287">if</span>&nbsp;<span class="ident" id="435290">err</span>&nbsp;<span class="op" id="435294">!=</span>&nbsp;<span class="ident" id="435297">nil</span>&nbsp;<span class="op" id="435301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435306">t</span><span class="op" id="435307">.</span><span class="ident" id="435308">Fatalf</span><span class="op" id="435314">(</span><span class="string" id="435315">&#34;open&nbsp;of&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="435331">,</span>&nbsp;<span class="ident" id="435333">name</span><span class="op" id="435337">,</span>&nbsp;<span class="ident" id="435339">err</span><span class="op" id="435342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="435346">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="435350">defer</span>&nbsp;<span class="ident" id="435356">f</span><span class="op" id="435357">.</span><span class="ident" id="435358">Close</span><span class="op" id="435363">(</span><span class="op" id="435364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="435367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435370">test</span><span class="op" id="435374">(</span><span class="ident" id="435375">Dir</span><span class="op" id="435378">(</span><span class="string" id="435379">&#34;&#34;</span><span class="op" id="435381">)</span><span class="op" id="435382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435385">test</span><span class="op" id="435389">(</span><span class="ident" id="435390">Dir</span><span class="op" id="435393">(</span><span class="string" id="435394">&#34;.&#34;</span><span class="op" id="435397">)</span><span class="op" id="435398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435401">test</span><span class="op" id="435405">(</span><span class="ident" id="435406">Dir</span><span class="op" id="435409">(</span><span class="string" id="435410">&#34;./&#34;</span><span class="op" id="435414">)</span><span class="op" id="435415">)</span><br>
<span class="lineno">365</span><span class="op" id="435417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="435420">func</span>&nbsp;<span class="ident" id="435425">TestServeFileContentType</span><span class="op" id="435449">(</span><span class="ident" id="435450">t</span>&nbsp;<span class="op" id="435452">*</span><span class="ident" id="435453">testing</span><span class="op" id="435460">.</span><span class="ident" id="435461">T</span><span class="op" id="435462">)</span>&nbsp;<span class="op" id="435464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="435467">defer</span>&nbsp;<span class="ident" id="435473">afterTest</span><span class="op" id="435482">(</span><span class="ident" id="435483">t</span><span class="op" id="435484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="435487">const</span>&nbsp;<span class="ident" id="435493">ctype</span>&nbsp;<span class="op" id="435499">=</span>&nbsp;<span class="string" id="435501">&#34;icecream/chocolate&#34;</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435523">ts</span>&nbsp;<span class="op" id="435526">:=</span>&nbsp;<span class="ident" id="435529">httptest</span><span class="op" id="435537">.</span><span class="ident" id="435538">NewServer</span><span class="op" id="435547">(</span><span class="ident" id="435548">HandlerFunc</span><span class="op" id="435559">(</span><span class="keyword" id="435560">func</span><span class="op" id="435564">(</span><span class="ident" id="435565">w</span>&nbsp;<span class="ident" id="435567">ResponseWriter</span><span class="op" id="435581">,</span>&nbsp;<span class="ident" id="435583">r</span>&nbsp;<span class="op" id="435585">*</span><span class="ident" id="435586">Request</span><span class="op" id="435593">)</span>&nbsp;<span class="op" id="435595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="435599">switch</span>&nbsp;<span class="ident" id="435606">r</span><span class="op" id="435607">.</span><span class="ident" id="435608">FormValue</span><span class="op" id="435617">(</span><span class="string" id="435618">&#34;override&#34;</span><span class="op" id="435628">)</span>&nbsp;<span class="op" id="435630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="435634">case</span>&nbsp;<span class="string" id="435639">&#34;1&#34;</span><span class="op" id="435642">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435647">w</span><span class="op" id="435648">.</span><span class="ident" id="435649">Header</span><span class="op" id="435655">(</span><span class="op" id="435656">)</span><span class="op" id="435657">.</span><span class="ident" id="435658">Set</span><span class="op" id="435661">(</span><span class="string" id="435662">&#34;Content-Type&#34;</span><span class="op" id="435676">,</span>&nbsp;<span class="ident" id="435678">ctype</span><span class="op" id="435683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="435687">case</span>&nbsp;<span class="string" id="435692">&#34;2&#34;</span><span class="op" id="435695">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="435700">//&nbsp;Explicitly&nbsp;inhibit&nbsp;sniffing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435735">w</span><span class="op" id="435736">.</span><span class="ident" id="435737">Header</span><span class="op" id="435743">(</span><span class="op" id="435744">)</span><span class="op" id="435745">[</span><span class="string" id="435746">&#34;Content-Type&#34;</span><span class="op" id="435760">]</span>&nbsp;<span class="op" id="435762">=</span>&nbsp;<span class="op" id="435764">[</span><span class="op" id="435765">]</span><span class="builtintype" id="435766">string</span><span class="op" id="435772">{</span><span class="op" id="435773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="435777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435781">ServeFile</span><span class="op" id="435790">(</span><span class="ident" id="435791">w</span><span class="op" id="435792">,</span>&nbsp;<span class="ident" id="435794">r</span><span class="op" id="435795">,</span>&nbsp;<span class="string" id="435797">&#34;testdata/file&#34;</span><span class="op" id="435812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="435815">}</span><span class="op" id="435816">)</span><span class="op" id="435817">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="435820">defer</span>&nbsp;<span class="ident" id="435826">ts</span><span class="op" id="435828">.</span><span class="ident" id="435829">Close</span><span class="op" id="435834">(</span><span class="op" id="435835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435838">get</span>&nbsp;<span class="op" id="435842">:=</span>&nbsp;<span class="keyword" id="435845">func</span><span class="op" id="435849">(</span><span class="ident" id="435850">override</span>&nbsp;<span class="builtintype" id="435859">string</span><span class="op" id="435865">,</span>&nbsp;<span class="ident" id="435867">want</span>&nbsp;<span class="op" id="435872">[</span><span class="op" id="435873">]</span><span class="builtintype" id="435874">string</span><span class="op" id="435880">)</span>&nbsp;<span class="op" id="435882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435886">resp</span><span class="op" id="435890">,</span>&nbsp;<span class="ident" id="435892">err</span>&nbsp;<span class="op" id="435896">:=</span>&nbsp;<span class="ident" id="435899">Get</span><span class="op" id="435902">(</span><span class="ident" id="435903">ts</span><span class="op" id="435905">.</span><span class="ident" id="435906">URL</span>&nbsp;<span class="op" id="435910">+</span>&nbsp;<span class="string" id="435912">&#34;?override=&#34;</span>&nbsp;<span class="op" id="435925">+</span>&nbsp;<span class="ident" id="435927">override</span><span class="op" id="435935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="435939">if</span>&nbsp;<span class="ident" id="435942">err</span>&nbsp;<span class="op" id="435946">!=</span>&nbsp;<span class="ident" id="435949">nil</span>&nbsp;<span class="op" id="435953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="435958">t</span><span class="op" id="435959">.</span><span class="ident" id="435960">Fatal</span><span class="op" id="435965">(</span><span class="ident" id="435966">err</span><span class="op" id="435969">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="435973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="435977">if</span>&nbsp;<span class="ident" id="435980">h</span>&nbsp;<span class="op" id="435982">:=</span>&nbsp;<span class="ident" id="435985">resp</span><span class="op" id="435989">.</span><span class="ident" id="435990">Header</span><span class="op" id="435996">[</span><span class="string" id="435997">&#34;Content-Type&#34;</span><span class="op" id="436011">]</span><span class="op" id="436012">;</span>&nbsp;<span class="op" id="436014">!</span><span class="ident" id="436015">reflect</span><span class="op" id="436022">.</span><span class="ident" id="436023">DeepEqual</span><span class="op" id="436032">(</span><span class="ident" id="436033">h</span><span class="op" id="436034">,</span>&nbsp;<span class="ident" id="436036">want</span><span class="op" id="436040">)</span>&nbsp;<span class="op" id="436042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436047">t</span><span class="op" id="436048">.</span><span class="ident" id="436049">Errorf</span><span class="op" id="436055">(</span><span class="string" id="436056">&#34;Content-Type&nbsp;mismatch:&nbsp;got&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="436096">,</span>&nbsp;<span class="ident" id="436098">h</span><span class="op" id="436099">,</span>&nbsp;<span class="ident" id="436101">want</span><span class="op" id="436105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="436109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436113">resp</span><span class="op" id="436117">.</span><span class="ident" id="436118">Body</span><span class="op" id="436122">.</span><span class="ident" id="436123">Close</span><span class="op" id="436128">(</span><span class="op" id="436129">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="436132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436135">get</span><span class="op" id="436138">(</span><span class="string" id="436139">&#34;0&#34;</span><span class="op" id="436142">,</span>&nbsp;<span class="op" id="436144">[</span><span class="op" id="436145">]</span><span class="builtintype" id="436146">string</span><span class="op" id="436152">{</span><span class="string" id="436153">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="436180">}</span><span class="op" id="436181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436184">get</span><span class="op" id="436187">(</span><span class="string" id="436188">&#34;1&#34;</span><span class="op" id="436191">,</span>&nbsp;<span class="op" id="436193">[</span><span class="op" id="436194">]</span><span class="builtintype" id="436195">string</span><span class="op" id="436201">{</span><span class="ident" id="436202">ctype</span><span class="op" id="436207">}</span><span class="op" id="436208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436211">get</span><span class="op" id="436214">(</span><span class="string" id="436215">&#34;2&#34;</span><span class="op" id="436218">,</span>&nbsp;<span class="ident" id="436220">nil</span><span class="op" id="436223">)</span><br>
<span class="lineno"></span><span class="op" id="436225">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span><span class="keyword" id="436228">func</span>&nbsp;<span class="ident" id="436233">TestServeFileMimeType</span><span class="op" id="436254">(</span><span class="ident" id="436255">t</span>&nbsp;<span class="op" id="436257">*</span><span class="ident" id="436258">testing</span><span class="op" id="436265">.</span><span class="ident" id="436266">T</span><span class="op" id="436267">)</span>&nbsp;<span class="op" id="436269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="436272">defer</span>&nbsp;<span class="ident" id="436278">afterTest</span><span class="op" id="436287">(</span><span class="ident" id="436288">t</span><span class="op" id="436289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436292">ts</span>&nbsp;<span class="op" id="436295">:=</span>&nbsp;<span class="ident" id="436298">httptest</span><span class="op" id="436306">.</span><span class="ident" id="436307">NewServer</span><span class="op" id="436316">(</span><span class="ident" id="436317">HandlerFunc</span><span class="op" id="436328">(</span><span class="keyword" id="436329">func</span><span class="op" id="436333">(</span><span class="ident" id="436334">w</span>&nbsp;<span class="ident" id="436336">ResponseWriter</span><span class="op" id="436350">,</span>&nbsp;<span class="ident" id="436352">r</span>&nbsp;<span class="op" id="436354">*</span><span class="ident" id="436355">Request</span><span class="op" id="436362">)</span>&nbsp;<span class="op" id="436364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436368">ServeFile</span><span class="op" id="436377">(</span><span class="ident" id="436378">w</span><span class="op" id="436379">,</span>&nbsp;<span class="ident" id="436381">r</span><span class="op" id="436382">,</span>&nbsp;<span class="string" id="436384">&#34;testdata/style.css&#34;</span><span class="op" id="436404">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="436407">}</span><span class="op" id="436408">)</span><span class="op" id="436409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="436412">defer</span>&nbsp;<span class="ident" id="436418">ts</span><span class="op" id="436420">.</span><span class="ident" id="436421">Close</span><span class="op" id="436426">(</span><span class="op" id="436427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436430">resp</span><span class="op" id="436434">,</span>&nbsp;<span class="ident" id="436436">err</span>&nbsp;<span class="op" id="436440">:=</span>&nbsp;<span class="ident" id="436443">Get</span><span class="op" id="436446">(</span><span class="ident" id="436447">ts</span><span class="op" id="436449">.</span><span class="ident" id="436450">URL</span><span class="op" id="436453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="436456">if</span>&nbsp;<span class="ident" id="436459">err</span>&nbsp;<span class="op" id="436463">!=</span>&nbsp;<span class="ident" id="436466">nil</span>&nbsp;<span class="op" id="436470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436474">t</span><span class="op" id="436475">.</span><span class="ident" id="436476">Fatal</span><span class="op" id="436481">(</span><span class="ident" id="436482">err</span><span class="op" id="436485">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="436488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436491">resp</span><span class="op" id="436495">.</span><span class="ident" id="436496">Body</span><span class="op" id="436500">.</span><span class="ident" id="436501">Close</span><span class="op" id="436506">(</span><span class="op" id="436507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436510">want</span>&nbsp;<span class="op" id="436515">:=</span>&nbsp;<span class="string" id="436518">&#34;text/css;&nbsp;charset=utf-8&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="436545">if</span>&nbsp;<span class="ident" id="436548">h</span>&nbsp;<span class="op" id="436550">:=</span>&nbsp;<span class="ident" id="436553">resp</span><span class="op" id="436557">.</span><span class="ident" id="436558">Header</span><span class="op" id="436564">.</span><span class="ident" id="436565">Get</span><span class="op" id="436568">(</span><span class="string" id="436569">&#34;Content-Type&#34;</span><span class="op" id="436583">)</span><span class="op" id="436584">;</span>&nbsp;<span class="ident" id="436586">h</span>&nbsp;<span class="op" id="436588">!=</span>&nbsp;<span class="ident" id="436591">want</span>&nbsp;<span class="op" id="436596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436600">t</span><span class="op" id="436601">.</span><span class="ident" id="436602">Errorf</span><span class="op" id="436608">(</span><span class="string" id="436609">&#34;Content-Type&nbsp;mismatch:&nbsp;got&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="436649">,</span>&nbsp;<span class="ident" id="436651">h</span><span class="op" id="436652">,</span>&nbsp;<span class="ident" id="436654">want</span><span class="op" id="436658">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="436661">}</span><br>
<span class="lineno"></span><span class="op" id="436663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="436666">func</span>&nbsp;<span class="ident" id="436671">TestServeFileFromCWD</span><span class="op" id="436691">(</span><span class="ident" id="436692">t</span>&nbsp;<span class="op" id="436694">*</span><span class="ident" id="436695">testing</span><span class="op" id="436702">.</span><span class="ident" id="436703">T</span><span class="op" id="436704">)</span>&nbsp;<span class="op" id="436706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="436709">defer</span>&nbsp;<span class="ident" id="436715">afterTest</span><span class="op" id="436724">(</span><span class="ident" id="436725">t</span><span class="op" id="436726">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436729">ts</span>&nbsp;<span class="op" id="436732">:=</span>&nbsp;<span class="ident" id="436735">httptest</span><span class="op" id="436743">.</span><span class="ident" id="436744">NewServer</span><span class="op" id="436753">(</span><span class="ident" id="436754">HandlerFunc</span><span class="op" id="436765">(</span><span class="keyword" id="436766">func</span><span class="op" id="436770">(</span><span class="ident" id="436771">w</span>&nbsp;<span class="ident" id="436773">ResponseWriter</span><span class="op" id="436787">,</span>&nbsp;<span class="ident" id="436789">r</span>&nbsp;<span class="op" id="436791">*</span><span class="ident" id="436792">Request</span><span class="op" id="436799">)</span>&nbsp;<span class="op" id="436801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436805">ServeFile</span><span class="op" id="436814">(</span><span class="ident" id="436815">w</span><span class="op" id="436816">,</span>&nbsp;<span class="ident" id="436818">r</span><span class="op" id="436819">,</span>&nbsp;<span class="string" id="436821">&#34;fs_test.go&#34;</span><span class="op" id="436833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="436836">}</span><span class="op" id="436837">)</span><span class="op" id="436838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="436841">defer</span>&nbsp;<span class="ident" id="436847">ts</span><span class="op" id="436849">.</span><span class="ident" id="436850">Close</span><span class="op" id="436855">(</span><span class="op" id="436856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436859">r</span><span class="op" id="436860">,</span>&nbsp;<span class="ident" id="436862">err</span>&nbsp;<span class="op" id="436866">:=</span>&nbsp;<span class="ident" id="436869">Get</span><span class="op" id="436872">(</span><span class="ident" id="436873">ts</span><span class="op" id="436875">.</span><span class="ident" id="436876">URL</span><span class="op" id="436879">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="436882">if</span>&nbsp;<span class="ident" id="436885">err</span>&nbsp;<span class="op" id="436889">!=</span>&nbsp;<span class="ident" id="436892">nil</span>&nbsp;<span class="op" id="436896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436900">t</span><span class="op" id="436901">.</span><span class="ident" id="436902">Fatal</span><span class="op" id="436907">(</span><span class="ident" id="436908">err</span><span class="op" id="436911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="436914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436917">r</span><span class="op" id="436918">.</span><span class="ident" id="436919">Body</span><span class="op" id="436923">.</span><span class="ident" id="436924">Close</span><span class="op" id="436929">(</span><span class="op" id="436930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="436933">if</span>&nbsp;<span class="ident" id="436936">r</span><span class="op" id="436937">.</span><span class="ident" id="436938">StatusCode</span>&nbsp;<span class="op" id="436949">!=</span>&nbsp;<span class="num" id="436952">200</span>&nbsp;<span class="op" id="436956">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="436960">t</span><span class="op" id="436961">.</span><span class="ident" id="436962">Fatalf</span><span class="op" id="436968">(</span><span class="string" id="436969">&#34;expected&nbsp;200&nbsp;OK,&nbsp;got&nbsp;%s&#34;</span><span class="op" id="436994">,</span>&nbsp;<span class="ident" id="436996">r</span><span class="op" id="436997">.</span><span class="ident" id="436998">Status</span><span class="op" id="437004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="437007">}</span><br>
<span class="lineno"></span><span class="op" id="437009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="437012">func</span>&nbsp;<span class="ident" id="437017">TestServeFileWithContentEncoding</span><span class="op" id="437049">(</span><span class="ident" id="437050">t</span>&nbsp;<span class="op" id="437052">*</span><span class="ident" id="437053">testing</span><span class="op" id="437060">.</span><span class="ident" id="437061">T</span><span class="op" id="437062">)</span>&nbsp;<span class="op" id="437064">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="437067">defer</span>&nbsp;<span class="ident" id="437073">afterTest</span><span class="op" id="437082">(</span><span class="ident" id="437083">t</span><span class="op" id="437084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="437087">ts</span>&nbsp;<span class="op" id="437090">:=</span>&nbsp;<span class="ident" id="437093">httptest</span><span class="op" id="437101">.</span><span class="ident" id="437102">NewServer</span><span class="op" id="437111">(</span><span class="ident" id="437112">HandlerFunc</span><span class="op" id="437123">(</span><span class="keyword" id="437124">func</span><span class="op" id="437128">(</span><span class="ident" id="437129">w</span>&nbsp;<span class="ident" id="437131">ResponseWriter</span><span class="op" id="437145">,</span>&nbsp;<span class="ident" id="437147">r</span>&nbsp;<span class="op" id="437149">*</span><span class="ident" id="437150">Request</span><span class="op" id="437157">)</span>&nbsp;<span class="op" id="437159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="437163">w</span><span class="op" id="437164">.</span><span class="ident" id="437165">Header</span><span class="op" id="437171">(</span><span class="op" id="437172">)</span><span class="op" id="437173">.</span><span class="ident" id="437174">Set</span><span class="op" id="437177">(</span><span class="string" id="437178">&#34;Content-Encoding&#34;</span><span class="op" id="437196">,</span>&nbsp;<span class="string" id="437198">&#34;foo&#34;</span><span class="op" id="437203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="437207">ServeFile</span><span class="op" id="437216">(</span><span class="ident" id="437217">w</span><span class="op" id="437218">,</span>&nbsp;<span class="ident" id="437220">r</span><span class="op" id="437221">,</span>&nbsp;<span class="string" id="437223">&#34;testdata/file&#34;</span><span class="op" id="437238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="437241">}</span><span class="op" id="437242">)</span><span class="op" id="437243">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="437246">defer</span>&nbsp;<span class="ident" id="437252">ts</span><span class="op" id="437254">.</span><span class="ident" id="437255">Close</span><span class="op" id="437260">(</span><span class="op" id="437261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="437264">resp</span><span class="op" id="437268">,</span>&nbsp;<span class="ident" id="437270">err</span>&nbsp;<span class="op" id="437274">:=</span>&nbsp;<span class="ident" id="437277">Get</span><span class="op" id="437280">(</span><span class="ident" id="437281">ts</span><span class="op" id="437283">.</span><span class="ident" id="437284">URL</span><span class="op" id="437287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="437290">if</span>&nbsp;<span class="ident" id="437293">err</span>&nbsp;<span class="op" id="437297">!=</span>&nbsp;<span class="ident" id="437300">nil</span>&nbsp;<span class="op" id="437304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="437308">t</span><span class="op" id="437309">.</span><span class="ident" id="437310">Fatal</span><span class="op" id="437315">(</span><span class="ident" id="437316">err</span><span class="op" id="437319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="437322">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="437325">resp</span><span class="op" id="437329">.</span><span class="ident" id="437330">Body</span><span class="op" id="437334">.</span><span class="ident" id="437335">Close</span><span class="op" id="437340">(</span><span class="op" id="437341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="437344">if</span>&nbsp;<span class="ident" id="437347">g</span><span class="op" id="437348">,</span>&nbsp;<span class="ident" id="437350">e</span>&nbsp;<span class="op" id="437352">:=</span>&nbsp;<span class="ident" id="437355">resp</span><span class="op" id="437359">.</span><span class="ident" id="437360">ContentLength</span><span class="op" id="437373">,</span>&nbsp;<span class="ident" id="437375">int64</span><span class="op" id="437380">(</span><span class="op" id="437381">-</span><span class="num" id="437382">1</span><span class="op" id="437383">)</span><span class="op" id="437384">;</span>&nbsp;<span class="ident" id="437386">g</span>&nbsp;<span class="op" id="437388">!=</span>&nbsp;<span class="ident" id="437391">e</span>&nbsp;<span class="op" id="437393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="437397">t</span><span class="op" id="437398">.</span><span class="ident" id="437399">Errorf</span><span class="op" id="437405">(</span><span class="string" id="437406">&#34;Content-Length&nbsp;mismatch:&nbsp;got&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="437448">,</span>&nbsp;<span class="ident" id="437450">g</span><span class="op" id="437451">,</span>&nbsp;<span class="ident" id="437453">e</span><span class="op" id="437454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="437457">}</span><br>
<span class="lineno"></span><span class="op" id="437459">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span><span class="keyword" id="437462">func</span>&nbsp;<span class="ident" id="437467">TestServeIndexHtml</span><span class="op" id="437485">(</span><span class="ident" id="437486">t</span>&nbsp;<span class="op" id="437488">*</span><span class="ident" id="437489">testing</span><span class="op" id="437496">.</span><span class="ident" id="437497">T</span><span class="op" id="437498">)</span>&nbsp;<span class="op" id="437500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="437503">defer</span>&nbsp;<span class="ident" id="437509">afterTest</span><span class="op" id="437518">(</span><span class="ident" id="437519">t</span><span class="op" id="437520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="437523">const</span>&nbsp;<span class="ident" id="437529">want</span>&nbsp;<span class="op" id="437534">=</span>&nbsp;<span class="string" id="437536">&#34;index.html&nbsp;says&nbsp;hello\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="437563">ts</span>&nbsp;<span class="op" id="437566">:=</span>&nbsp;<span class="ident" id="437569">httptest</span><span class="op" id="437577">.</span><span class="ident" id="437578">NewServer</span><span class="op" id="437587">(</span><span class="ident" id="437588">FileServer</span><span class="op" id="437598">(</span><span class="ident" id="437599">Dir</span><span class="op" id="437602">(</span><span class="string" id="437603">&#34;.&#34;</span><span class="op" id="437606">)</span><span class="op" id="437607">)</span><span class="op" id="437608">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="437611">defer</span>&nbsp;<span class="ident" id="437617">ts</span><span class="op" id="437619">.</span><span class="ident" id="437620">Close</span><span class="op" id="437625">(</span><span class="op" id="437626">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="437630">for</span>&nbsp;<span class="ident" id="437634">_</span><span class="op" id="437635">,</span>&nbsp;<span class="ident" id="437637">path</span>&nbsp;<span class="op" id="437642">:=</span>&nbsp;<span class="keyword" id="437645">range</span>&nbsp;<span class="op" id="437651">[</span><span class="op" id="437652">]</span><span class="builtintype" id="437653">string</span><span class="op" id="437659">{</span><span class="string" id="437660">&#34;/testdata/&#34;</span><span class="op" id="437672">,</span>&nbsp;<span class="string" id="437674">&#34;/testdata/index.html&#34;</span><span class="op" id="437696">}</span>&nbsp;<span class="op" id="437698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="437702">res</span><span class="op" id="437705">,</span>&nbsp;<span class="ident" id="437707">err</span>&nbsp;<span class="op" id="437711">:=</span>&nbsp;<span class="ident" id="437714">Get</span><span class="op" id="437717">(</span><span class="ident" id="437718">ts</span><span class="op" id="437720">.</span><span class="ident" id="437721">URL</span>&nbsp;<span class="op" id="437725">+</span>&nbsp;<span class="ident" id="437727">path</span><span class="op" id="437731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="437735">if</span>&nbsp;<span class="ident" id="437738">err</span>&nbsp;<span class="op" id="437742">!=</span>&nbsp;<span class="ident" id="437745">nil</span>&nbsp;<span class="op" id="437749">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="437754">t</span><span class="op" id="437755">.</span><span class="ident" id="437756">Fatal</span><span class="op" id="437761">(</span><span class="ident" id="437762">err</span><span class="op" id="437765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="437769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="437773">b</span><span class="op" id="437774">,</span>&nbsp;<span class="ident" id="437776">err</span>&nbsp;<span class="op" id="437780">:=</span>&nbsp;<span class="ident" id="437783">ioutil</span><span class="op" id="437789">.</span><span class="ident" id="437790">ReadAll</span><span class="op" id="437797">(</span><span class="ident" id="437798">res</span><span class="op" id="437801">.</span><span class="ident" id="437802">Body</span><span class="op" id="437806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="437810">if</span>&nbsp;<span class="ident" id="437813">err</span>&nbsp;<span class="op" id="437817">!=</span>&nbsp;<span class="ident" id="437820">nil</span>&nbsp;<span class="op" id="437824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="437829">t</span><span class="op" id="437830">.</span><span class="ident" id="437831">Fatal</span><span class="op" id="437836">(</span><span class="string" id="437837">&#34;reading&nbsp;Body:&#34;</span><span class="op" id="437852">,</span>&nbsp;<span class="ident" id="437854">err</span><span class="op" id="437857">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="437861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="437865">if</span>&nbsp;<span class="ident" id="437868">s</span>&nbsp;<span class="op" id="437870">:=</span>&nbsp;<span class="builtintype" id="437873">string</span><span class="op" id="437879">(</span><span class="ident" id="437880">b</span><span class="op" id="437881">)</span><span class="op" id="437882">;</span>&nbsp;<span class="ident" id="437884">s</span>&nbsp;<span class="op" id="437886">!=</span>&nbsp;<span class="ident" id="437889">want</span>&nbsp;<span class="op" id="437894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="437899">t</span><span class="op" id="437900">.</span><span class="ident" id="437901">Errorf</span><span class="op" id="437907">(</span><span class="string" id="437908">&#34;for&nbsp;path&nbsp;%q&nbsp;got&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="437937">,</span>&nbsp;<span class="ident" id="437939">path</span><span class="op" id="437943">,</span>&nbsp;<span class="ident" id="437945">s</span><span class="op" id="437946">,</span>&nbsp;<span class="ident" id="437948">want</span><span class="op" id="437952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="437956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="437960">res</span><span class="op" id="437963">.</span><span class="ident" id="437964">Body</span><span class="op" id="437968">.</span><span class="ident" id="437969">Close</span><span class="op" id="437974">(</span><span class="op" id="437975">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="437978">}</span><br>
<span class="lineno"></span><span class="op" id="437980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="437983">func</span>&nbsp;<span class="ident" id="437988">TestFileServerZeroByte</span><span class="op" id="438010">(</span><span class="ident" id="438011">t</span>&nbsp;<span class="op" id="438013">*</span><span class="ident" id="438014">testing</span><span class="op" id="438021">.</span><span class="ident" id="438022">T</span><span class="op" id="438023">)</span>&nbsp;<span class="op" id="438025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="438028">defer</span>&nbsp;<span class="ident" id="438034">afterTest</span><span class="op" id="438043">(</span><span class="ident" id="438044">t</span><span class="op" id="438045">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="438048">ts</span>&nbsp;<span class="op" id="438051">:=</span>&nbsp;<span class="ident" id="438054">httptest</span><span class="op" id="438062">.</span><span class="ident" id="438063">NewServer</span><span class="op" id="438072">(</span><span class="ident" id="438073">FileServer</span><span class="op" id="438083">(</span><span class="ident" id="438084">Dir</span><span class="op" id="438087">(</span><span class="string" id="438088">&#34;.&#34;</span><span class="op" id="438091">)</span><span class="op" id="438092">)</span><span class="op" id="438093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="438096">defer</span>&nbsp;<span class="ident" id="438102">ts</span><span class="op" id="438104">.</span><span class="ident" id="438105">Close</span><span class="op" id="438110">(</span><span class="op" id="438111">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="438115">res</span><span class="op" id="438118">,</span>&nbsp;<span class="ident" id="438120">err</span>&nbsp;<span class="op" id="438124">:=</span>&nbsp;<span class="ident" id="438127">Get</span><span class="op" id="438130">(</span><span class="ident" id="438131">ts</span><span class="op" id="438133">.</span><span class="ident" id="438134">URL</span>&nbsp;<span class="op" id="438138">+</span>&nbsp;<span class="string" id="438140">&#34;/..\x00&#34;</span><span class="op" id="438149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="438152">if</span>&nbsp;<span class="ident" id="438155">err</span>&nbsp;<span class="op" id="438159">!=</span>&nbsp;<span class="ident" id="438162">nil</span>&nbsp;<span class="op" id="438166">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="438170">t</span><span class="op" id="438171">.</span><span class="ident" id="438172">Fatal</span><span class="op" id="438177">(</span><span class="ident" id="438178">err</span><span class="op" id="438181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="438184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="438187">b</span><span class="op" id="438188">,</span>&nbsp;<span class="ident" id="438190">err</span>&nbsp;<span class="op" id="438194">:=</span>&nbsp;<span class="ident" id="438197">ioutil</span><span class="op" id="438203">.</span><span class="ident" id="438204">ReadAll</span><span class="op" id="438211">(</span><span class="ident" id="438212">res</span><span class="op" id="438215">.</span><span class="ident" id="438216">Body</span><span class="op" id="438220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="438223">if</span>&nbsp;<span class="ident" id="438226">err</span>&nbsp;<span class="op" id="438230">!=</span>&nbsp;<span class="ident" id="438233">nil</span>&nbsp;<span class="op" id="438237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="438241">t</span><span class="op" id="438242">.</span><span class="ident" id="438243">Fatal</span><span class="op" id="438248">(</span><span class="string" id="438249">&#34;reading&nbsp;Body:&#34;</span><span class="op" id="438264">,</span>&nbsp;<span class="ident" id="438266">err</span><span class="op" id="438269">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="438272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="438275">if</span>&nbsp;<span class="ident" id="438278">res</span><span class="op" id="438281">.</span><span class="ident" id="438282">StatusCode</span>&nbsp;<span class="op" id="438293">==</span>&nbsp;<span class="num" id="438296">200</span>&nbsp;<span class="op" id="438300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="438304">t</span><span class="op" id="438305">.</span><span class="ident" id="438306">Errorf</span><span class="op" id="438312">(</span><span class="string" id="438313">&#34;got&nbsp;status&nbsp;200;&nbsp;want&nbsp;an&nbsp;error.&nbsp;Body&nbsp;is:\n%s&#34;</span><span class="op" id="438358">,</span>&nbsp;<span class="builtintype" id="438360">string</span><span class="op" id="438366">(</span><span class="ident" id="438367">b</span><span class="op" id="438368">)</span><span class="op" id="438369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="438372">}</span><br>
<span class="lineno"></span><span class="op" id="438374">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="438377">type</span>&nbsp;<span class="ident" id="438382">fakeFileInfo</span>&nbsp;<span class="keyword" id="438395">struct</span>&nbsp;<span class="op" id="438402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="438405">dir</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="438414">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="438420">basename</span>&nbsp;<span class="builtintype" id="438429">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="438437">modtime</span>&nbsp;&nbsp;<span class="ident" id="438446">time</span><span class="op" id="438450">.</span><span class="ident" id="438451">Time</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="438457">ents</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="438466">[</span><span class="op" id="438467">]</span><span class="op" id="438468">*</span><span class="ident" id="438469">fakeFileInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="438483">contents</span>&nbsp;<span class="builtintype" id="438492">string</span><br>
<span class="lineno"></span><span class="op" id="438499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="438502">func</span>&nbsp;<span class="op" id="438507">(</span><span class="ident" id="438508">f</span>&nbsp;<span class="op" id="438510">*</span><span class="ident" id="438511">fakeFileInfo</span><span class="op" id="438523">)</span>&nbsp;<span class="ident" id="438525">Name</span><span class="op" id="438529">(</span><span class="op" id="438530">)</span>&nbsp;<span class="builtintype" id="438532">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="438545">{</span>&nbsp;<span class="keyword" id="438547">return</span>&nbsp;<span class="ident" id="438554">f</span><span class="op" id="438555">.</span><span class="ident" id="438556">basename</span>&nbsp;<span class="op" id="438565">}</span><br>
<span class="lineno">495</span><span class="keyword" id="438567">func</span>&nbsp;<span class="op" id="438572">(</span><span class="ident" id="438573">f</span>&nbsp;<span class="op" id="438575">*</span><span class="ident" id="438576">fakeFileInfo</span><span class="op" id="438588">)</span>&nbsp;<span class="ident" id="438590">Sys</span><span class="op" id="438593">(</span><span class="op" id="438594">)</span>&nbsp;<span class="keyword" id="438596">interface</span><span class="op" id="438605">{</span><span class="op" id="438606">}</span>&nbsp;&nbsp;&nbsp;<span class="op" id="438610">{</span>&nbsp;<span class="keyword" id="438612">return</span>&nbsp;<span class="ident" id="438619">nil</span>&nbsp;<span class="op" id="438623">}</span><br>
<span class="lineno"></span><span class="keyword" id="438625">func</span>&nbsp;<span class="op" id="438630">(</span><span class="ident" id="438631">f</span>&nbsp;<span class="op" id="438633">*</span><span class="ident" id="438634">fakeFileInfo</span><span class="op" id="438646">)</span>&nbsp;<span class="ident" id="438648">ModTime</span><span class="op" id="438655">(</span><span class="op" id="438656">)</span>&nbsp;<span class="ident" id="438658">time</span><span class="op" id="438662">.</span><span class="ident" id="438663">Time</span>&nbsp;<span class="op" id="438668">{</span>&nbsp;<span class="keyword" id="438670">return</span>&nbsp;<span class="ident" id="438677">f</span><span class="op" id="438678">.</span><span class="ident" id="438679">modtime</span>&nbsp;<span class="op" id="438687">}</span><br>
<span class="lineno"></span><span class="keyword" id="438689">func</span>&nbsp;<span class="op" id="438694">(</span><span class="ident" id="438695">f</span>&nbsp;<span class="op" id="438697">*</span><span class="ident" id="438698">fakeFileInfo</span><span class="op" id="438710">)</span>&nbsp;<span class="ident" id="438712">IsDir</span><span class="op" id="438717">(</span><span class="op" id="438718">)</span>&nbsp;<span class="builtintype" id="438720">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="438732">{</span>&nbsp;<span class="keyword" id="438734">return</span>&nbsp;<span class="ident" id="438741">f</span><span class="op" id="438742">.</span><span class="ident" id="438743">dir</span>&nbsp;<span class="op" id="438747">}</span><br>
<span class="lineno"></span><span class="keyword" id="438749">func</span>&nbsp;<span class="op" id="438754">(</span><span class="ident" id="438755">f</span>&nbsp;<span class="op" id="438757">*</span><span class="ident" id="438758">fakeFileInfo</span><span class="op" id="438770">)</span>&nbsp;<span class="ident" id="438772">Size</span><span class="op" id="438776">(</span><span class="op" id="438777">)</span>&nbsp;<span class="ident" id="438779">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="438792">{</span>&nbsp;<span class="keyword" id="438794">return</span>&nbsp;<span class="ident" id="438801">int64</span><span class="op" id="438806">(</span><span class="builtinfunc" id="438807">len</span><span class="op" id="438810">(</span><span class="ident" id="438811">f</span><span class="op" id="438812">.</span><span class="ident" id="438813">contents</span><span class="op" id="438821">)</span><span class="op" id="438822">)</span>&nbsp;<span class="op" id="438824">}</span><br>
<span class="lineno"></span><span class="keyword" id="438826">func</span>&nbsp;<span class="op" id="438831">(</span><span class="ident" id="438832">f</span>&nbsp;<span class="op" id="438834">*</span><span class="ident" id="438835">fakeFileInfo</span><span class="op" id="438847">)</span>&nbsp;<span class="ident" id="438849">Mode</span><span class="op" id="438853">(</span><span class="op" id="438854">)</span>&nbsp;<span class="ident" id="438856">os</span><span class="op" id="438858">.</span><span class="ident" id="438859">FileMode</span>&nbsp;<span class="op" id="438868">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="438871">if</span>&nbsp;<span class="ident" id="438874">f</span><span class="op" id="438875">.</span><span class="ident" id="438876">dir</span>&nbsp;<span class="op" id="438880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="438884">return</span>&nbsp;<span class="num" id="438891">0755</span>&nbsp;<span class="op" id="438896">|</span>&nbsp;<span class="ident" id="438898">os</span><span class="op" id="438900">.</span><span class="ident" id="438901">ModeDir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="438910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="438913">return</span>&nbsp;<span class="num" id="438920">0644</span><br>
<span class="lineno"></span><span class="op" id="438925">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span><span class="keyword" id="438928">type</span>&nbsp;<span class="ident" id="438933">fakeFile</span>&nbsp;<span class="keyword" id="438942">struct</span>&nbsp;<span class="op" id="438949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="438952">io</span><span class="op" id="438954">.</span><span class="ident" id="438955">ReadSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="438967">fi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="438974">*</span><span class="ident" id="438975">fakeFileInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="438989">path</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="438996">string</span>&nbsp;<span class="comment" id="439003">//&nbsp;as&nbsp;opened</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="439017">entpos</span>&nbsp;<span class="builtintype" id="439024">int</span><br>
<span class="lineno"></span><span class="op" id="439028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="439031">func</span>&nbsp;<span class="op" id="439036">(</span><span class="ident" id="439037">f</span>&nbsp;<span class="op" id="439039">*</span><span class="ident" id="439040">fakeFile</span><span class="op" id="439048">)</span>&nbsp;<span class="ident" id="439050">Close</span><span class="op" id="439055">(</span><span class="op" id="439056">)</span>&nbsp;<span class="builtintype" id="439058">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="439078">{</span>&nbsp;<span class="keyword" id="439080">return</span>&nbsp;<span class="ident" id="439087">nil</span>&nbsp;<span class="op" id="439091">}</span><br>
<span class="lineno"></span><span class="keyword" id="439093">func</span>&nbsp;<span class="op" id="439098">(</span><span class="ident" id="439099">f</span>&nbsp;<span class="op" id="439101">*</span><span class="ident" id="439102">fakeFile</span><span class="op" id="439110">)</span>&nbsp;<span class="ident" id="439112">Stat</span><span class="op" id="439116">(</span><span class="op" id="439117">)</span>&nbsp;<span class="op" id="439119">(</span><span class="ident" id="439120">os</span><span class="op" id="439122">.</span><span class="ident" id="439123">FileInfo</span><span class="op" id="439131">,</span>&nbsp;<span class="builtintype" id="439133">error</span><span class="op" id="439138">)</span>&nbsp;<span class="op" id="439140">{</span>&nbsp;<span class="keyword" id="439142">return</span>&nbsp;<span class="ident" id="439149">f</span><span class="op" id="439150">.</span><span class="ident" id="439151">fi</span><span class="op" id="439153">,</span>&nbsp;<span class="ident" id="439155">nil</span>&nbsp;<span class="op" id="439159">}</span><br>
<span class="lineno">515</span><span class="keyword" id="439161">func</span>&nbsp;<span class="op" id="439166">(</span><span class="ident" id="439167">f</span>&nbsp;<span class="op" id="439169">*</span><span class="ident" id="439170">fakeFile</span><span class="op" id="439178">)</span>&nbsp;<span class="ident" id="439180">Readdir</span><span class="op" id="439187">(</span><span class="ident" id="439188">count</span>&nbsp;<span class="builtintype" id="439194">int</span><span class="op" id="439197">)</span>&nbsp;<span class="op" id="439199">(</span><span class="op" id="439200">[</span><span class="op" id="439201">]</span><span class="ident" id="439202">os</span><span class="op" id="439204">.</span><span class="ident" id="439205">FileInfo</span><span class="op" id="439213">,</span>&nbsp;<span class="builtintype" id="439215">error</span><span class="op" id="439220">)</span>&nbsp;<span class="op" id="439222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="439225">if</span>&nbsp;<span class="op" id="439228">!</span><span class="ident" id="439229">f</span><span class="op" id="439230">.</span><span class="ident" id="439231">fi</span><span class="op" id="439233">.</span><span class="ident" id="439234">dir</span>&nbsp;<span class="op" id="439238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="439242">return</span>&nbsp;<span class="ident" id="439249">nil</span><span class="op" id="439252">,</span>&nbsp;<span class="ident" id="439254">os</span><span class="op" id="439256">.</span><span class="ident" id="439257">ErrInvalid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="439269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="439272">var</span>&nbsp;<span class="ident" id="439276">fis</span>&nbsp;<span class="op" id="439280">[</span><span class="op" id="439281">]</span><span class="ident" id="439282">os</span><span class="op" id="439284">.</span><span class="ident" id="439285">FileInfo</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="439296">limit</span>&nbsp;<span class="op" id="439302">:=</span>&nbsp;<span class="ident" id="439305">f</span><span class="op" id="439306">.</span><span class="ident" id="439307">entpos</span>&nbsp;<span class="op" id="439314">+</span>&nbsp;<span class="ident" id="439316">count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="439323">if</span>&nbsp;<span class="ident" id="439326">count</span>&nbsp;<span class="op" id="439332">&lt;=</span>&nbsp;<span class="num" id="439335">0</span>&nbsp;<span class="op" id="439337">||</span>&nbsp;<span class="ident" id="439340">limit</span>&nbsp;<span class="op" id="439346">&gt;</span>&nbsp;<span class="builtinfunc" id="439348">len</span><span class="op" id="439351">(</span><span class="ident" id="439352">f</span><span class="op" id="439353">.</span><span class="ident" id="439354">fi</span><span class="op" id="439356">.</span><span class="ident" id="439357">ents</span><span class="op" id="439361">)</span>&nbsp;<span class="op" id="439363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="439367">limit</span>&nbsp;<span class="op" id="439373">=</span>&nbsp;<span class="builtinfunc" id="439375">len</span><span class="op" id="439378">(</span><span class="ident" id="439379">f</span><span class="op" id="439380">.</span><span class="ident" id="439381">fi</span><span class="op" id="439383">.</span><span class="ident" id="439384">ents</span><span class="op" id="439388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="439391">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="439394">for</span>&nbsp;<span class="op" id="439398">;</span>&nbsp;<span class="ident" id="439400">f</span><span class="op" id="439401">.</span><span class="ident" id="439402">entpos</span>&nbsp;<span class="op" id="439409">&lt;</span>&nbsp;<span class="ident" id="439411">limit</span><span class="op" id="439416">;</span>&nbsp;<span class="ident" id="439418">f</span><span class="op" id="439419">.</span><span class="ident" id="439420">entpos</span><span class="op" id="439426">++</span>&nbsp;<span class="op" id="439429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="439433">fis</span>&nbsp;<span class="op" id="439437">=</span>&nbsp;<span class="builtinfunc" id="439439">append</span><span class="op" id="439445">(</span><span class="ident" id="439446">fis</span><span class="op" id="439449">,</span>&nbsp;<span class="ident" id="439451">f</span><span class="op" id="439452">.</span><span class="ident" id="439453">fi</span><span class="op" id="439455">.</span><span class="ident" id="439456">ents</span><span class="op" id="439460">[</span><span class="ident" id="439461">f</span><span class="op" id="439462">.</span><span class="ident" id="439463">entpos</span><span class="op" id="439469">]</span><span class="op" id="439470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="439473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="439477">if</span>&nbsp;<span class="builtinfunc" id="439480">len</span><span class="op" id="439483">(</span><span class="ident" id="439484">fis</span><span class="op" id="439487">)</span>&nbsp;<span class="op" id="439489">==</span>&nbsp;<span class="num" id="439492">0</span>&nbsp;<span class="op" id="439494">&amp;&amp;</span>&nbsp;<span class="ident" id="439497">count</span>&nbsp;<span class="op" id="439503">&gt;</span>&nbsp;<span class="num" id="439505">0</span>&nbsp;<span class="op" id="439507">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="439511">return</span>&nbsp;<span class="ident" id="439518">fis</span><span class="op" id="439521">,</span>&nbsp;<span class="ident" id="439523">io</span><span class="op" id="439525">.</span><span class="ident" id="439526">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="439531">}</span>&nbsp;<span class="keyword" id="439533">else</span>&nbsp;<span class="op" id="439538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="439542">return</span>&nbsp;<span class="ident" id="439549">fis</span><span class="op" id="439552">,</span>&nbsp;<span class="ident" id="439554">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="439559">}</span><br>
<span class="lineno"></span><span class="op" id="439561">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span><span class="keyword" id="439564">type</span>&nbsp;<span class="ident" id="439569">fakeFS</span>&nbsp;<span class="keyword" id="439576">map</span><span class="op" id="439579">[</span><span class="builtintype" id="439580">string</span><span class="op" id="439586">]</span><span class="op" id="439587">*</span><span class="ident" id="439588">fakeFileInfo</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="439602">func</span>&nbsp;<span class="op" id="439607">(</span><span class="ident" id="439608">fs</span>&nbsp;<span class="ident" id="439611">fakeFS</span><span class="op" id="439617">)</span>&nbsp;<span class="ident" id="439619">Open</span><span class="op" id="439623">(</span><span class="ident" id="439624">name</span>&nbsp;<span class="builtintype" id="439629">string</span><span class="op" id="439635">)</span>&nbsp;<span class="op" id="439637">(</span><span class="ident" id="439638">File</span><span class="op" id="439642">,</span>&nbsp;<span class="builtintype" id="439644">error</span><span class="op" id="439649">)</span>&nbsp;<span class="op" id="439651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="439654">name</span>&nbsp;<span class="op" id="439659">=</span>&nbsp;<span class="ident" id="439661">path</span><span class="op" id="439665">.</span><span class="ident" id="439666">Clean</span><span class="op" id="439671">(</span><span class="ident" id="439672">name</span><span class="op" id="439676">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="439679">f</span><span class="op" id="439680">,</span>&nbsp;<span class="ident" id="439682">ok</span>&nbsp;<span class="op" id="439685">:=</span>&nbsp;<span class="ident" id="439688">fs</span><span class="op" id="439690">[</span><span class="ident" id="439691">name</span><span class="op" id="439695">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="439698">if</span>&nbsp;<span class="op" id="439701">!</span><span class="ident" id="439702">ok</span>&nbsp;<span class="op" id="439705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="439709">return</span>&nbsp;<span class="ident" id="439716">nil</span><span class="op" id="439719">,</span>&nbsp;<span class="ident" id="439721">os</span><span class="op" id="439723">.</span><span class="ident" id="439724">ErrNotExist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="439737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="439740">return</span>&nbsp;<span class="op" id="439747">&amp;</span><span class="ident" id="439748">fakeFile</span><span class="op" id="439756">{</span><span class="ident" id="439757">ReadSeeker</span><span class="op" id="439767">:</span>&nbsp;<span class="ident" id="439769">strings</span><span class="op" id="439776">.</span><span class="ident" id="439777">NewReader</span><span class="op" id="439786">(</span><span class="ident" id="439787">f</span><span class="op" id="439788">.</span><span class="ident" id="439789">contents</span><span class="op" id="439797">)</span><span class="op" id="439798">,</span>&nbsp;<span class="ident" id="439800">fi</span><span class="op" id="439802">:</span>&nbsp;<span class="ident" id="439804">f</span><span class="op" id="439805">,</span>&nbsp;<span class="ident" id="439807">path</span><span class="op" id="439811">:</span>&nbsp;<span class="ident" id="439813">name</span><span class="op" id="439817">}</span><span class="op" id="439818">,</span>&nbsp;<span class="ident" id="439820">nil</span><br>
<span class="lineno">545</span><span class="op" id="439824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="439827">func</span>&nbsp;<span class="ident" id="439832">TestDirectoryIfNotModified</span><span class="op" id="439858">(</span><span class="ident" id="439859">t</span>&nbsp;<span class="op" id="439861">*</span><span class="ident" id="439862">testing</span><span class="op" id="439869">.</span><span class="ident" id="439870">T</span><span class="op" id="439871">)</span>&nbsp;<span class="op" id="439873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="439876">defer</span>&nbsp;<span class="ident" id="439882">afterTest</span><span class="op" id="439891">(</span><span class="ident" id="439892">t</span><span class="op" id="439893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="439896">const</span>&nbsp;<span class="ident" id="439902">indexContents</span>&nbsp;<span class="op" id="439916">=</span>&nbsp;<span class="string" id="439918">&#34;I&nbsp;am&nbsp;a&nbsp;fake&nbsp;index.html&nbsp;file&#34;</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="439949">fileMod</span>&nbsp;<span class="op" id="439957">:=</span>&nbsp;<span class="ident" id="439960">time</span><span class="op" id="439964">.</span><span class="ident" id="439965">Unix</span><span class="op" id="439969">(</span><span class="num" id="439970">1000000000</span><span class="op" id="439980">,</span>&nbsp;<span class="num" id="439982">0</span><span class="op" id="439983">)</span><span class="op" id="439984">.</span><span class="ident" id="439985">UTC</span><span class="op" id="439988">(</span><span class="op" id="439989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="439992">fileModStr</span>&nbsp;<span class="op" id="440003">:=</span>&nbsp;<span class="ident" id="440006">fileMod</span><span class="op" id="440013">.</span><span class="ident" id="440014">Format</span><span class="op" id="440020">(</span><span class="ident" id="440021">TimeFormat</span><span class="op" id="440031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440034">dirMod</span>&nbsp;<span class="op" id="440041">:=</span>&nbsp;<span class="ident" id="440044">time</span><span class="op" id="440048">.</span><span class="ident" id="440049">Unix</span><span class="op" id="440053">(</span><span class="num" id="440054">123</span><span class="op" id="440057">,</span>&nbsp;<span class="num" id="440059">0</span><span class="op" id="440060">)</span><span class="op" id="440061">.</span><span class="ident" id="440062">UTC</span><span class="op" id="440065">(</span><span class="op" id="440066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440069">indexFile</span>&nbsp;<span class="op" id="440079">:=</span>&nbsp;<span class="op" id="440082">&amp;</span><span class="ident" id="440083">fakeFileInfo</span><span class="op" id="440095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440099">basename</span><span class="op" id="440107">:</span>&nbsp;<span class="string" id="440109">&#34;index.html&#34;</span><span class="op" id="440121">,</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440125">modtime</span><span class="op" id="440132">:</span>&nbsp;&nbsp;<span class="ident" id="440135">fileMod</span><span class="op" id="440142">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440146">contents</span><span class="op" id="440154">:</span>&nbsp;<span class="ident" id="440156">indexContents</span><span class="op" id="440169">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="440172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440175">fs</span>&nbsp;<span class="op" id="440178">:=</span>&nbsp;<span class="ident" id="440181">fakeFS</span><span class="op" id="440187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="440191">&#34;/&#34;</span><span class="op" id="440194">:</span>&nbsp;<span class="op" id="440196">&amp;</span><span class="ident" id="440197">fakeFileInfo</span><span class="op" id="440209">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440214">dir</span><span class="op" id="440217">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="440223">true</span><span class="op" id="440227">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440232">modtime</span><span class="op" id="440239">:</span>&nbsp;<span class="ident" id="440241">dirMod</span><span class="op" id="440247">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440252">ents</span><span class="op" id="440256">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="440261">[</span><span class="op" id="440262">]</span><span class="op" id="440263">*</span><span class="ident" id="440264">fakeFileInfo</span><span class="op" id="440276">{</span><span class="ident" id="440277">indexFile</span><span class="op" id="440286">}</span><span class="op" id="440287">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="440291">}</span><span class="op" id="440292">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="440296">&#34;/index.html&#34;</span><span class="op" id="440309">:</span>&nbsp;<span class="ident" id="440311">indexFile</span><span class="op" id="440320">,</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="440323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440327">ts</span>&nbsp;<span class="op" id="440330">:=</span>&nbsp;<span class="ident" id="440333">httptest</span><span class="op" id="440341">.</span><span class="ident" id="440342">NewServer</span><span class="op" id="440351">(</span><span class="ident" id="440352">FileServer</span><span class="op" id="440362">(</span><span class="ident" id="440363">fs</span><span class="op" id="440365">)</span><span class="op" id="440366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="440369">defer</span>&nbsp;<span class="ident" id="440375">ts</span><span class="op" id="440377">.</span><span class="ident" id="440378">Close</span><span class="op" id="440383">(</span><span class="op" id="440384">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440388">res</span><span class="op" id="440391">,</span>&nbsp;<span class="ident" id="440393">err</span>&nbsp;<span class="op" id="440397">:=</span>&nbsp;<span class="ident" id="440400">Get</span><span class="op" id="440403">(</span><span class="ident" id="440404">ts</span><span class="op" id="440406">.</span><span class="ident" id="440407">URL</span><span class="op" id="440410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="440413">if</span>&nbsp;<span class="ident" id="440416">err</span>&nbsp;<span class="op" id="440420">!=</span>&nbsp;<span class="ident" id="440423">nil</span>&nbsp;<span class="op" id="440427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440431">t</span><span class="op" id="440432">.</span><span class="ident" id="440433">Fatal</span><span class="op" id="440438">(</span><span class="ident" id="440439">err</span><span class="op" id="440442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="440445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440448">b</span><span class="op" id="440449">,</span>&nbsp;<span class="ident" id="440451">err</span>&nbsp;<span class="op" id="440455">:=</span>&nbsp;<span class="ident" id="440458">ioutil</span><span class="op" id="440464">.</span><span class="ident" id="440465">ReadAll</span><span class="op" id="440472">(</span><span class="ident" id="440473">res</span><span class="op" id="440476">.</span><span class="ident" id="440477">Body</span><span class="op" id="440481">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="440484">if</span>&nbsp;<span class="ident" id="440487">err</span>&nbsp;<span class="op" id="440491">!=</span>&nbsp;<span class="ident" id="440494">nil</span>&nbsp;<span class="op" id="440498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440502">t</span><span class="op" id="440503">.</span><span class="ident" id="440504">Fatal</span><span class="op" id="440509">(</span><span class="ident" id="440510">err</span><span class="op" id="440513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="440516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="440519">if</span>&nbsp;<span class="builtintype" id="440522">string</span><span class="op" id="440528">(</span><span class="ident" id="440529">b</span><span class="op" id="440530">)</span>&nbsp;<span class="op" id="440532">!=</span>&nbsp;<span class="ident" id="440535">indexContents</span>&nbsp;<span class="op" id="440549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440553">t</span><span class="op" id="440554">.</span><span class="ident" id="440555">Fatalf</span><span class="op" id="440561">(</span><span class="string" id="440562">&#34;Got&nbsp;body&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="440584">,</span>&nbsp;<span class="ident" id="440586">b</span><span class="op" id="440587">,</span>&nbsp;<span class="ident" id="440589">indexContents</span><span class="op" id="440602">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="440605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440608">res</span><span class="op" id="440611">.</span><span class="ident" id="440612">Body</span><span class="op" id="440616">.</span><span class="ident" id="440617">Close</span><span class="op" id="440622">(</span><span class="op" id="440623">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440627">lastMod</span>&nbsp;<span class="op" id="440635">:=</span>&nbsp;<span class="ident" id="440638">res</span><span class="op" id="440641">.</span><span class="ident" id="440642">Header</span><span class="op" id="440648">.</span><span class="ident" id="440649">Get</span><span class="op" id="440652">(</span><span class="string" id="440653">&#34;Last-Modified&#34;</span><span class="op" id="440668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="440671">if</span>&nbsp;<span class="ident" id="440674">lastMod</span>&nbsp;<span class="op" id="440682">!=</span>&nbsp;<span class="ident" id="440685">fileModStr</span>&nbsp;<span class="op" id="440696">{</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440700">t</span><span class="op" id="440701">.</span><span class="ident" id="440702">Fatalf</span><span class="op" id="440708">(</span><span class="string" id="440709">&#34;initial&nbsp;Last-Modified&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="440746">,</span>&nbsp;<span class="ident" id="440748">lastMod</span><span class="op" id="440755">,</span>&nbsp;<span class="ident" id="440757">fileModStr</span><span class="op" id="440767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="440770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440774">req</span><span class="op" id="440777">,</span>&nbsp;<span class="ident" id="440779">_</span>&nbsp;<span class="op" id="440781">:=</span>&nbsp;<span class="ident" id="440784">NewRequest</span><span class="op" id="440794">(</span><span class="string" id="440795">&#34;GET&#34;</span><span class="op" id="440800">,</span>&nbsp;<span class="ident" id="440802">ts</span><span class="op" id="440804">.</span><span class="ident" id="440805">URL</span><span class="op" id="440808">,</span>&nbsp;<span class="ident" id="440810">nil</span><span class="op" id="440813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440816">req</span><span class="op" id="440819">.</span><span class="ident" id="440820">Header</span><span class="op" id="440826">.</span><span class="ident" id="440827">Set</span><span class="op" id="440830">(</span><span class="string" id="440831">&#34;If-Modified-Since&#34;</span><span class="op" id="440850">,</span>&nbsp;<span class="ident" id="440852">lastMod</span><span class="op" id="440859">)</span><br>
<span class="lineno">590</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440863">res</span><span class="op" id="440866">,</span>&nbsp;<span class="ident" id="440868">err</span>&nbsp;<span class="op" id="440872">=</span>&nbsp;<span class="ident" id="440874">DefaultClient</span><span class="op" id="440887">.</span><span class="ident" id="440888">Do</span><span class="op" id="440890">(</span><span class="ident" id="440891">req</span><span class="op" id="440894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="440897">if</span>&nbsp;<span class="ident" id="440900">err</span>&nbsp;<span class="op" id="440904">!=</span>&nbsp;<span class="ident" id="440907">nil</span>&nbsp;<span class="op" id="440911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440915">t</span><span class="op" id="440916">.</span><span class="ident" id="440917">Fatal</span><span class="op" id="440922">(</span><span class="ident" id="440923">err</span><span class="op" id="440926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="440929">}</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="440932">if</span>&nbsp;<span class="ident" id="440935">res</span><span class="op" id="440938">.</span><span class="ident" id="440939">StatusCode</span>&nbsp;<span class="op" id="440950">!=</span>&nbsp;<span class="num" id="440953">304</span>&nbsp;<span class="op" id="440957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="440961">t</span><span class="op" id="440962">.</span><span class="ident" id="440963">Fatalf</span><span class="op" id="440969">(</span><span class="string" id="440970">&#34;Code&nbsp;after&nbsp;If-Modified-Since&nbsp;request&nbsp;=&nbsp;%v;&nbsp;want&nbsp;304&#34;</span><span class="op" id="441023">,</span>&nbsp;<span class="ident" id="441025">res</span><span class="op" id="441028">.</span><span class="ident" id="441029">StatusCode</span><span class="op" id="441039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="441042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441045">res</span><span class="op" id="441048">.</span><span class="ident" id="441049">Body</span><span class="op" id="441053">.</span><span class="ident" id="441054">Close</span><span class="op" id="441059">(</span><span class="op" id="441060">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="441064">//&nbsp;Advance&nbsp;the&nbsp;index.html&nbsp;file&#39;s&nbsp;modtime,&nbsp;but&nbsp;not&nbsp;the&nbsp;directory&#39;s.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441132">indexFile</span><span class="op" id="441141">.</span><span class="ident" id="441142">modtime</span>&nbsp;<span class="op" id="441150">=</span>&nbsp;<span class="ident" id="441152">indexFile</span><span class="op" id="441161">.</span><span class="ident" id="441162">modtime</span><span class="op" id="441169">.</span><span class="ident" id="441170">Add</span><span class="op" id="441173">(</span><span class="num" id="441174">1</span>&nbsp;<span class="op" id="441176">*</span>&nbsp;<span class="ident" id="441178">time</span><span class="op" id="441182">.</span><span class="ident" id="441183">Hour</span><span class="op" id="441187">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441191">res</span><span class="op" id="441194">,</span>&nbsp;<span class="ident" id="441196">err</span>&nbsp;<span class="op" id="441200">=</span>&nbsp;<span class="ident" id="441202">DefaultClient</span><span class="op" id="441215">.</span><span class="ident" id="441216">Do</span><span class="op" id="441218">(</span><span class="ident" id="441219">req</span><span class="op" id="441222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="441225">if</span>&nbsp;<span class="ident" id="441228">err</span>&nbsp;<span class="op" id="441232">!=</span>&nbsp;<span class="ident" id="441235">nil</span>&nbsp;<span class="op" id="441239">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441243">t</span><span class="op" id="441244">.</span><span class="ident" id="441245">Fatal</span><span class="op" id="441250">(</span><span class="ident" id="441251">err</span><span class="op" id="441254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="441257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="441260">if</span>&nbsp;<span class="ident" id="441263">res</span><span class="op" id="441266">.</span><span class="ident" id="441267">StatusCode</span>&nbsp;<span class="op" id="441278">!=</span>&nbsp;<span class="num" id="441281">200</span>&nbsp;<span class="op" id="441285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441289">t</span><span class="op" id="441290">.</span><span class="ident" id="441291">Fatalf</span><span class="op" id="441297">(</span><span class="string" id="441298">&#34;Code&nbsp;after&nbsp;second&nbsp;If-Modified-Since&nbsp;request&nbsp;=&nbsp;%v;&nbsp;want&nbsp;200;&nbsp;res&nbsp;is&nbsp;%#v&#34;</span><span class="op" id="441370">,</span>&nbsp;<span class="ident" id="441372">res</span><span class="op" id="441375">.</span><span class="ident" id="441376">StatusCode</span><span class="op" id="441386">,</span>&nbsp;<span class="ident" id="441388">res</span><span class="op" id="441391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="441394">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441397">res</span><span class="op" id="441400">.</span><span class="ident" id="441401">Body</span><span class="op" id="441405">.</span><span class="ident" id="441406">Close</span><span class="op" id="441411">(</span><span class="op" id="441412">)</span><br>
<span class="lineno"></span><span class="op" id="441414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="441417">func</span>&nbsp;<span class="ident" id="441422">mustStat</span><span class="op" id="441430">(</span><span class="ident" id="441431">t</span>&nbsp;<span class="op" id="441433">*</span><span class="ident" id="441434">testing</span><span class="op" id="441441">.</span><span class="ident" id="441442">T</span><span class="op" id="441443">,</span>&nbsp;<span class="ident" id="441445">fileName</span>&nbsp;<span class="builtintype" id="441454">string</span><span class="op" id="441460">)</span>&nbsp;<span class="ident" id="441462">os</span><span class="op" id="441464">.</span><span class="ident" id="441465">FileInfo</span>&nbsp;<span class="op" id="441474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441477">fi</span><span class="op" id="441479">,</span>&nbsp;<span class="ident" id="441481">err</span>&nbsp;<span class="op" id="441485">:=</span>&nbsp;<span class="ident" id="441488">os</span><span class="op" id="441490">.</span><span class="ident" id="441491">Stat</span><span class="op" id="441495">(</span><span class="ident" id="441496">fileName</span><span class="op" id="441504">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="441507">if</span>&nbsp;<span class="ident" id="441510">err</span>&nbsp;<span class="op" id="441514">!=</span>&nbsp;<span class="ident" id="441517">nil</span>&nbsp;<span class="op" id="441521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441525">t</span><span class="op" id="441526">.</span><span class="ident" id="441527">Fatal</span><span class="op" id="441532">(</span><span class="ident" id="441533">err</span><span class="op" id="441536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="441539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="441542">return</span>&nbsp;<span class="ident" id="441549">fi</span><br>
<span class="lineno"></span><span class="op" id="441552">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="441555">func</span>&nbsp;<span class="ident" id="441560">TestServeContent</span><span class="op" id="441576">(</span><span class="ident" id="441577">t</span>&nbsp;<span class="op" id="441579">*</span><span class="ident" id="441580">testing</span><span class="op" id="441587">.</span><span class="ident" id="441588">T</span><span class="op" id="441589">)</span>&nbsp;<span class="op" id="441591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="441594">defer</span>&nbsp;<span class="ident" id="441600">afterTest</span><span class="op" id="441609">(</span><span class="ident" id="441610">t</span><span class="op" id="441611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="441614">type</span>&nbsp;<span class="ident" id="441619">serveParam</span>&nbsp;<span class="keyword" id="441630">struct</span>&nbsp;<span class="op" id="441637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441641">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="441653">string</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441662">modtime</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="441674">time</span><span class="op" id="441678">.</span><span class="ident" id="441679">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441686">content</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="441698">io</span><span class="op" id="441700">.</span><span class="ident" id="441701">ReadSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441714">contentType</span>&nbsp;<span class="builtintype" id="441726">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441735">etag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="441747">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="441755">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441758">servec</span>&nbsp;<span class="op" id="441765">:=</span>&nbsp;<span class="builtinfunc" id="441768">make</span><span class="op" id="441772">(</span><span class="keyword" id="441773">chan</span>&nbsp;<span class="ident" id="441778">serveParam</span><span class="op" id="441788">,</span>&nbsp;<span class="num" id="441790">1</span><span class="op" id="441791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441794">ts</span>&nbsp;<span class="op" id="441797">:=</span>&nbsp;<span class="ident" id="441800">httptest</span><span class="op" id="441808">.</span><span class="ident" id="441809">NewServer</span><span class="op" id="441818">(</span><span class="ident" id="441819">HandlerFunc</span><span class="op" id="441830">(</span><span class="keyword" id="441831">func</span><span class="op" id="441835">(</span><span class="ident" id="441836">w</span>&nbsp;<span class="ident" id="441838">ResponseWriter</span><span class="op" id="441852">,</span>&nbsp;<span class="ident" id="441854">r</span>&nbsp;<span class="op" id="441856">*</span><span class="ident" id="441857">Request</span><span class="op" id="441864">)</span>&nbsp;<span class="op" id="441866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441870">p</span>&nbsp;<span class="op" id="441872">:=</span>&nbsp;<span class="op" id="441875">&lt;-</span><span class="ident" id="441877">servec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="441886">if</span>&nbsp;<span class="ident" id="441889">p</span><span class="op" id="441890">.</span><span class="ident" id="441891">etag</span>&nbsp;<span class="op" id="441896">!=</span>&nbsp;<span class="string" id="441899">&#34;&#34;</span>&nbsp;<span class="op" id="441902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441907">w</span><span class="op" id="441908">.</span><span class="ident" id="441909">Header</span><span class="op" id="441915">(</span><span class="op" id="441916">)</span><span class="op" id="441917">.</span><span class="ident" id="441918">Set</span><span class="op" id="441921">(</span><span class="string" id="441922">&#34;ETag&#34;</span><span class="op" id="441928">,</span>&nbsp;<span class="ident" id="441930">p</span><span class="op" id="441931">.</span><span class="ident" id="441932">etag</span><span class="op" id="441936">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="441940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="441944">if</span>&nbsp;<span class="ident" id="441947">p</span><span class="op" id="441948">.</span><span class="ident" id="441949">contentType</span>&nbsp;<span class="op" id="441961">!=</span>&nbsp;<span class="string" id="441964">&#34;&#34;</span>&nbsp;<span class="op" id="441967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="441972">w</span><span class="op" id="441973">.</span><span class="ident" id="441974">Header</span><span class="op" id="441980">(</span><span class="op" id="441981">)</span><span class="op" id="441982">.</span><span class="ident" id="441983">Set</span><span class="op" id="441986">(</span><span class="string" id="441987">&#34;Content-Type&#34;</span><span class="op" id="442001">,</span>&nbsp;<span class="ident" id="442003">p</span><span class="op" id="442004">.</span><span class="ident" id="442005">contentType</span><span class="op" id="442016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="442020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442024">ServeContent</span><span class="op" id="442036">(</span><span class="ident" id="442037">w</span><span class="op" id="442038">,</span>&nbsp;<span class="ident" id="442040">r</span><span class="op" id="442041">,</span>&nbsp;<span class="ident" id="442043">p</span><span class="op" id="442044">.</span><span class="ident" id="442045">name</span><span class="op" id="442049">,</span>&nbsp;<span class="ident" id="442051">p</span><span class="op" id="442052">.</span><span class="ident" id="442053">modtime</span><span class="op" id="442060">,</span>&nbsp;<span class="ident" id="442062">p</span><span class="op" id="442063">.</span><span class="ident" id="442064">content</span><span class="op" id="442071">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="442074">}</span><span class="op" id="442075">)</span><span class="op" id="442076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="442079">defer</span>&nbsp;<span class="ident" id="442085">ts</span><span class="op" id="442087">.</span><span class="ident" id="442088">Close</span><span class="op" id="442093">(</span><span class="op" id="442094">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="442098">type</span>&nbsp;<span class="ident" id="442103">testCase</span>&nbsp;<span class="keyword" id="442112">struct</span>&nbsp;<span class="op" id="442119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="442123">//&nbsp;One&nbsp;of&nbsp;file&nbsp;or&nbsp;content&nbsp;must&nbsp;be&nbsp;set:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442164">file</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="442172">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442181">content</span>&nbsp;<span class="ident" id="442189">io</span><span class="op" id="442191">.</span><span class="ident" id="442192">ReadSeeker</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442206">modtime</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="442223">time</span><span class="op" id="442227">.</span><span class="ident" id="442228">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442235">serveETag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="442252">string</span>&nbsp;<span class="comment" id="442259">//&nbsp;optional</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442273">serveContentType</span>&nbsp;<span class="builtintype" id="442290">string</span>&nbsp;<span class="comment" id="442297">//&nbsp;optional</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442311">reqHeader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="442328">map</span><span class="op" id="442331">[</span><span class="builtintype" id="442332">string</span><span class="op" id="442338">]</span><span class="builtintype" id="442339">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442348">wantLastMod</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="442365">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442374">wantContentType</span>&nbsp;&nbsp;<span class="builtintype" id="442391">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442400">wantStatus</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="442417">int</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="442422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442425">htmlModTime</span>&nbsp;<span class="op" id="442437">:=</span>&nbsp;<span class="ident" id="442440">mustStat</span><span class="op" id="442448">(</span><span class="ident" id="442449">t</span><span class="op" id="442450">,</span>&nbsp;<span class="string" id="442452">&#34;testdata/index.html&#34;</span><span class="op" id="442473">)</span><span class="op" id="442474">.</span><span class="ident" id="442475">ModTime</span><span class="op" id="442482">(</span><span class="op" id="442483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442486">tests</span>&nbsp;<span class="op" id="442492">:=</span>&nbsp;<span class="keyword" id="442495">map</span><span class="op" id="442498">[</span><span class="builtintype" id="442499">string</span><span class="op" id="442505">]</span><span class="ident" id="442506">testCase</span><span class="op" id="442514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="442518">&#34;no_last_modified&#34;</span><span class="op" id="442536">:</span>&nbsp;<span class="op" id="442538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442543">file</span><span class="op" id="442547">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="442560">&#34;testdata/style.css&#34;</span><span class="op" id="442580">,</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442585">wantContentType</span><span class="op" id="442600">:</span>&nbsp;<span class="string" id="442602">&#34;text/css;&nbsp;charset=utf-8&#34;</span><span class="op" id="442627">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442632">wantStatus</span><span class="op" id="442642">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="442649">200</span><span class="op" id="442652">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="442656">}</span><span class="op" id="442657">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="442661">&#34;with_last_modified&#34;</span><span class="op" id="442681">:</span>&nbsp;<span class="op" id="442683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442688">file</span><span class="op" id="442692">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="442705">&#34;testdata/index.html&#34;</span><span class="op" id="442726">,</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442731">wantContentType</span><span class="op" id="442746">:</span>&nbsp;<span class="string" id="442748">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="442774">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442779">modtime</span><span class="op" id="442786">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="442796">htmlModTime</span><span class="op" id="442807">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442812">wantLastMod</span><span class="op" id="442823">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="442829">htmlModTime</span><span class="op" id="442840">.</span><span class="ident" id="442841">UTC</span><span class="op" id="442844">(</span><span class="op" id="442845">)</span><span class="op" id="442846">.</span><span class="ident" id="442847">Format</span><span class="op" id="442853">(</span><span class="ident" id="442854">TimeFormat</span><span class="op" id="442864">)</span><span class="op" id="442865">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442870">wantStatus</span><span class="op" id="442880">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="442887">200</span><span class="op" id="442890">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="442894">}</span><span class="op" id="442895">,</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="442899">&#34;not_modified_modtime&#34;</span><span class="op" id="442921">:</span>&nbsp;<span class="op" id="442923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442928">file</span><span class="op" id="442932">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="442937">&#34;testdata/style.css&#34;</span><span class="op" id="442957">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442962">modtime</span><span class="op" id="442969">:</span>&nbsp;<span class="ident" id="442971">htmlModTime</span><span class="op" id="442982">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="442987">reqHeader</span><span class="op" id="442996">:</span>&nbsp;<span class="keyword" id="442998">map</span><span class="op" id="443001">[</span><span class="builtintype" id="443002">string</span><span class="op" id="443008">]</span><span class="builtintype" id="443009">string</span><span class="op" id="443015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="443021">&#34;If-Modified-Since&#34;</span><span class="op" id="443040">:</span>&nbsp;<span class="ident" id="443042">htmlModTime</span><span class="op" id="443053">.</span><span class="ident" id="443054">UTC</span><span class="op" id="443057">(</span><span class="op" id="443058">)</span><span class="op" id="443059">.</span><span class="ident" id="443060">Format</span><span class="op" id="443066">(</span><span class="ident" id="443067">TimeFormat</span><span class="op" id="443077">)</span><span class="op" id="443078">,</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="443083">}</span><span class="op" id="443084">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443089">wantStatus</span><span class="op" id="443099">:</span>&nbsp;<span class="num" id="443101">304</span><span class="op" id="443104">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="443108">}</span><span class="op" id="443109">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="443113">&#34;not_modified_modtime_with_contenttype&#34;</span><span class="op" id="443152">:</span>&nbsp;<span class="op" id="443154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443159">file</span><span class="op" id="443163">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="443177">&#34;testdata/style.css&#34;</span><span class="op" id="443197">,</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443202">serveContentType</span><span class="op" id="443218">:</span>&nbsp;<span class="string" id="443220">&#34;text/css&#34;</span><span class="op" id="443230">,</span>&nbsp;<span class="comment" id="443232">//&nbsp;explicit&nbsp;content&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443260">modtime</span><span class="op" id="443267">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="443278">htmlModTime</span><span class="op" id="443289">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443294">reqHeader</span><span class="op" id="443303">:</span>&nbsp;<span class="keyword" id="443305">map</span><span class="op" id="443308">[</span><span class="builtintype" id="443309">string</span><span class="op" id="443315">]</span><span class="builtintype" id="443316">string</span><span class="op" id="443322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="443328">&#34;If-Modified-Since&#34;</span><span class="op" id="443347">:</span>&nbsp;<span class="ident" id="443349">htmlModTime</span><span class="op" id="443360">.</span><span class="ident" id="443361">UTC</span><span class="op" id="443364">(</span><span class="op" id="443365">)</span><span class="op" id="443366">.</span><span class="ident" id="443367">Format</span><span class="op" id="443373">(</span><span class="ident" id="443374">TimeFormat</span><span class="op" id="443384">)</span><span class="op" id="443385">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="443390">}</span><span class="op" id="443391">,</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443396">wantStatus</span><span class="op" id="443406">:</span>&nbsp;<span class="num" id="443408">304</span><span class="op" id="443411">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="443415">}</span><span class="op" id="443416">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="443420">&#34;not_modified_etag&#34;</span><span class="op" id="443439">:</span>&nbsp;<span class="op" id="443441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443446">file</span><span class="op" id="443450">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="443457">&#34;testdata/style.css&#34;</span><span class="op" id="443477">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443482">serveETag</span><span class="op" id="443491">:</span>&nbsp;<span class="string" id="443493">`&#34;foo&#34;`</span><span class="op" id="443500">,</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443505">reqHeader</span><span class="op" id="443514">:</span>&nbsp;<span class="keyword" id="443516">map</span><span class="op" id="443519">[</span><span class="builtintype" id="443520">string</span><span class="op" id="443526">]</span><span class="builtintype" id="443527">string</span><span class="op" id="443533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="443539">&#34;If-None-Match&#34;</span><span class="op" id="443554">:</span>&nbsp;<span class="string" id="443556">`&#34;foo&#34;`</span><span class="op" id="443563">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="443568">}</span><span class="op" id="443569">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443574">wantStatus</span><span class="op" id="443584">:</span>&nbsp;<span class="num" id="443586">304</span><span class="op" id="443589">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="443593">}</span><span class="op" id="443594">,</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="443598">&#34;not_modified_etag_no_seek&#34;</span><span class="op" id="443625">:</span>&nbsp;<span class="op" id="443627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443632">content</span><span class="op" id="443639">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="443643">panicOnSeek</span><span class="op" id="443654">{</span><span class="ident" id="443655">nil</span><span class="op" id="443658">}</span><span class="op" id="443659">,</span>&nbsp;<span class="comment" id="443661">//&nbsp;should&nbsp;never&nbsp;be&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443690">serveETag</span><span class="op" id="443699">:</span>&nbsp;<span class="string" id="443701">`&#34;foo&#34;`</span><span class="op" id="443708">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443713">reqHeader</span><span class="op" id="443722">:</span>&nbsp;<span class="keyword" id="443724">map</span><span class="op" id="443727">[</span><span class="builtintype" id="443728">string</span><span class="op" id="443734">]</span><span class="builtintype" id="443735">string</span><span class="op" id="443741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="443747">&#34;If-None-Match&#34;</span><span class="op" id="443762">:</span>&nbsp;<span class="string" id="443764">`&#34;foo&#34;`</span><span class="op" id="443771">,</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="443776">}</span><span class="op" id="443777">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443782">wantStatus</span><span class="op" id="443792">:</span>&nbsp;<span class="num" id="443794">304</span><span class="op" id="443797">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="443801">}</span><span class="op" id="443802">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="443806">&#34;range_good&#34;</span><span class="op" id="443818">:</span>&nbsp;<span class="op" id="443820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443825">file</span><span class="op" id="443829">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="443836">&#34;testdata/style.css&#34;</span><span class="op" id="443856">,</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443861">serveETag</span><span class="op" id="443870">:</span>&nbsp;<span class="string" id="443872">`&#34;A&#34;`</span><span class="op" id="443877">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443882">reqHeader</span><span class="op" id="443891">:</span>&nbsp;<span class="keyword" id="443893">map</span><span class="op" id="443896">[</span><span class="builtintype" id="443897">string</span><span class="op" id="443903">]</span><span class="builtintype" id="443904">string</span><span class="op" id="443910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="443916">&#34;Range&#34;</span><span class="op" id="443923">:</span>&nbsp;<span class="string" id="443925">&#34;bytes=0-4&#34;</span><span class="op" id="443936">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="443941">}</span><span class="op" id="443942">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443947">wantStatus</span><span class="op" id="443957">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="443964">StatusPartialContent</span><span class="op" id="443984">,</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="443989">wantContentType</span><span class="op" id="444004">:</span>&nbsp;<span class="string" id="444006">&#34;text/css;&nbsp;charset=utf-8&#34;</span><span class="op" id="444031">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="444035">}</span><span class="op" id="444036">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="444040">//&nbsp;An&nbsp;If-Range&nbsp;resource&nbsp;for&nbsp;entity&nbsp;&#34;A&#34;,&nbsp;but&nbsp;entity&nbsp;&#34;B&#34;&nbsp;is&nbsp;now&nbsp;current.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="444113">//&nbsp;The&nbsp;Range&nbsp;request&nbsp;should&nbsp;be&nbsp;ignored.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="444155">&#34;range_no_match&#34;</span><span class="op" id="444171">:</span>&nbsp;<span class="op" id="444173">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="444178">file</span><span class="op" id="444182">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="444189">&#34;testdata/style.css&#34;</span><span class="op" id="444209">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="444214">serveETag</span><span class="op" id="444223">:</span>&nbsp;<span class="string" id="444225">`&#34;A&#34;`</span><span class="op" id="444230">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="444235">reqHeader</span><span class="op" id="444244">:</span>&nbsp;<span class="keyword" id="444246">map</span><span class="op" id="444249">[</span><span class="builtintype" id="444250">string</span><span class="op" id="444256">]</span><span class="builtintype" id="444257">string</span><span class="op" id="444263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="444269">&#34;Range&#34;</span><span class="op" id="444276">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="444281">&#34;bytes=0-4&#34;</span><span class="op" id="444292">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="444298">&#34;If-Range&#34;</span><span class="op" id="444308">:</span>&nbsp;<span class="string" id="444310">`&#34;B&#34;`</span><span class="op" id="444315">,</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="444320">}</span><span class="op" id="444321">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="444326">wantStatus</span><span class="op" id="444336">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="444343">200</span><span class="op" id="444346">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="444351">wantContentType</span><span class="op" id="444366">:</span>&nbsp;<span class="string" id="444368">&#34;text/css;&nbsp;charset=utf-8&#34;</span><span class="op" id="444393">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="444397">}</span><span class="op" id="444398">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="444402">&#34;range_with_modtime&#34;</span><span class="op" id="444422">:</span>&nbsp;<span class="op" id="444424">{</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="444429">file</span><span class="op" id="444433">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="444438">&#34;testdata/style.css&#34;</span><span class="op" id="444458">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="444463">modtime</span><span class="op" id="444470">:</span>&nbsp;<span class="ident" id="444472">time</span><span class="op" id="444476">.</span><span class="ident" id="444477">Date</span><span class="op" id="444481">(</span><span class="num" id="444482">2014</span><span class="op" id="444486">,</span>&nbsp;<span class="num" id="444488">6</span><span class="op" id="444489">,</span>&nbsp;<span class="num" id="444491">25</span><span class="op" id="444493">,</span>&nbsp;<span class="num" id="444495">17</span><span class="op" id="444497">,</span>&nbsp;<span class="num" id="444499">12</span><span class="op" id="444501">,</span>&nbsp;<span class="num" id="444503">18</span><span class="op" id="444505">,</span>&nbsp;<span class="num" id="444507">0</span>&nbsp;<span class="comment" id="444509">/*&nbsp;nanos&nbsp;*/</span><span class="op" id="444520">,</span>&nbsp;<span class="ident" id="444522">time</span><span class="op" id="444526">.</span><span class="ident" id="444527">UTC</span><span class="op" id="444530">)</span><span class="op" id="444531">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="444536">reqHeader</span><span class="op" id="444545">:</span>&nbsp;<span class="keyword" id="444547">map</span><span class="op" id="444550">[</span><span class="builtintype" id="444551">string</span><span class="op" id="444557">]</span><span class="builtintype" id="444558">string</span><span class="op" id="444564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="444570">&#34;Range&#34;</span><span class="op" id="444577">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="444582">&#34;bytes=0-4&#34;</span><span class="op" id="444593">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="444599">&#34;If-Range&#34;</span><span class="op" id="444609">:</span>&nbsp;<span class="string" id="444611">&#34;Wed,&nbsp;25&nbsp;Jun&nbsp;2014&nbsp;17:12:18&nbsp;GMT&#34;</span><span class="op" id="444642">,</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="444647">}</span><span class="op" id="444648">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="444653">wantStatus</span><span class="op" id="444663">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="444670">StatusPartialContent</span><span class="op" id="444690">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="444695">wantContentType</span><span class="op" id="444710">:</span>&nbsp;<span class="string" id="444712">&#34;text/css;&nbsp;charset=utf-8&#34;</span><span class="op" id="444737">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="444742">wantLastMod</span><span class="op" id="444753">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="444759">&#34;Wed,&nbsp;25&nbsp;Jun&nbsp;2014&nbsp;17:12:18&nbsp;GMT&#34;</span><span class="op" id="444790">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="444794">}</span><span class="op" id="444795">,</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="444799">&#34;range_with_modtime_nanos&#34;</span><span class="op" id="444825">:</span>&nbsp;<span class="op" id="444827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="444832">file</span><span class="op" id="444836">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="444841">&#34;testdata/style.css&#34;</span><span class="op" id="444861">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="444866">modtime</span><span class="op" id="444873">:</span>&nbsp;<span class="ident" id="444875">time</span><span class="op" id="444879">.</span><span class="ident" id="444880">Date</span><span class="op" id="444884">(</span><span class="num" id="444885">2014</span><span class="op" id="444889">,</span>&nbsp;<span class="num" id="444891">6</span><span class="op" id="444892">,</span>&nbsp;<span class="num" id="444894">25</span><span class="op" id="444896">,</span>&nbsp;<span class="num" id="444898">17</span><span class="op" id="444900">,</span>&nbsp;<span class="num" id="444902">12</span><span class="op" id="444904">,</span>&nbsp;<span class="num" id="444906">18</span><span class="op" id="444908">,</span>&nbsp;<span class="num" id="444910">123</span>&nbsp;<span class="comment" id="444914">/*&nbsp;nanos&nbsp;*/</span><span class="op" id="444925">,</span>&nbsp;<span class="ident" id="444927">time</span><span class="op" id="444931">.</span><span class="ident" id="444932">UTC</span><span class="op" id="444935">)</span><span class="op" id="444936">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="444941">reqHeader</span><span class="op" id="444950">:</span>&nbsp;<span class="keyword" id="444952">map</span><span class="op" id="444955">[</span><span class="builtintype" id="444956">string</span><span class="op" id="444962">]</span><span class="builtintype" id="444963">string</span><span class="op" id="444969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="444975">&#34;Range&#34;</span><span class="op" id="444982">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="444987">&#34;bytes=0-4&#34;</span><span class="op" id="444998">,</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="445004">&#34;If-Range&#34;</span><span class="op" id="445014">:</span>&nbsp;<span class="string" id="445016">&#34;Wed,&nbsp;25&nbsp;Jun&nbsp;2014&nbsp;17:12:18&nbsp;GMT&#34;</span><span class="op" id="445047">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="445052">}</span><span class="op" id="445053">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445058">wantStatus</span><span class="op" id="445068">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="445075">StatusPartialContent</span><span class="op" id="445095">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445100">wantContentType</span><span class="op" id="445115">:</span>&nbsp;<span class="string" id="445117">&#34;text/css;&nbsp;charset=utf-8&#34;</span><span class="op" id="445142">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445147">wantLastMod</span><span class="op" id="445158">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="445164">&#34;Wed,&nbsp;25&nbsp;Jun&nbsp;2014&nbsp;17:12:18&nbsp;GMT&#34;</span><span class="op" id="445195">,</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="445199">}</span><span class="op" id="445200">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="445203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="445206">for</span>&nbsp;<span class="ident" id="445210">testName</span><span class="op" id="445218">,</span>&nbsp;<span class="ident" id="445220">tt</span>&nbsp;<span class="op" id="445223">:=</span>&nbsp;<span class="keyword" id="445226">range</span>&nbsp;<span class="ident" id="445232">tests</span>&nbsp;<span class="op" id="445238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="445242">var</span>&nbsp;<span class="ident" id="445246">content</span>&nbsp;<span class="ident" id="445254">io</span><span class="op" id="445256">.</span><span class="ident" id="445257">ReadSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="445270">if</span>&nbsp;<span class="ident" id="445273">tt</span><span class="op" id="445275">.</span><span class="ident" id="445276">file</span>&nbsp;<span class="op" id="445281">!=</span>&nbsp;<span class="string" id="445284">&#34;&#34;</span>&nbsp;<span class="op" id="445287">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445292">f</span><span class="op" id="445293">,</span>&nbsp;<span class="ident" id="445295">err</span>&nbsp;<span class="op" id="445299">:=</span>&nbsp;<span class="ident" id="445302">os</span><span class="op" id="445304">.</span><span class="ident" id="445305">Open</span><span class="op" id="445309">(</span><span class="ident" id="445310">tt</span><span class="op" id="445312">.</span><span class="ident" id="445313">file</span><span class="op" id="445317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="445322">if</span>&nbsp;<span class="ident" id="445325">err</span>&nbsp;<span class="op" id="445329">!=</span>&nbsp;<span class="ident" id="445332">nil</span>&nbsp;<span class="op" id="445336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445342">t</span><span class="op" id="445343">.</span><span class="ident" id="445344">Fatalf</span><span class="op" id="445350">(</span><span class="string" id="445351">&#34;test&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="445364">,</span>&nbsp;<span class="ident" id="445366">testName</span><span class="op" id="445374">,</span>&nbsp;<span class="ident" id="445376">err</span><span class="op" id="445379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="445384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="445389">defer</span>&nbsp;<span class="ident" id="445395">f</span><span class="op" id="445396">.</span><span class="ident" id="445397">Close</span><span class="op" id="445402">(</span><span class="op" id="445403">)</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445408">content</span>&nbsp;<span class="op" id="445416">=</span>&nbsp;<span class="ident" id="445418">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="445422">}</span>&nbsp;<span class="keyword" id="445424">else</span>&nbsp;<span class="op" id="445429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445434">content</span>&nbsp;<span class="op" id="445442">=</span>&nbsp;<span class="ident" id="445444">tt</span><span class="op" id="445446">.</span><span class="ident" id="445447">content</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="445457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445462">servec</span>&nbsp;<span class="op" id="445469">&lt;-</span>&nbsp;<span class="ident" id="445472">serveParam</span><span class="op" id="445482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445487">name</span><span class="op" id="445491">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="445500">filepath</span><span class="op" id="445508">.</span><span class="ident" id="445509">Base</span><span class="op" id="445513">(</span><span class="ident" id="445514">tt</span><span class="op" id="445516">.</span><span class="ident" id="445517">file</span><span class="op" id="445521">)</span><span class="op" id="445522">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445527">content</span><span class="op" id="445534">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="445540">content</span><span class="op" id="445547">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445552">modtime</span><span class="op" id="445559">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="445565">tt</span><span class="op" id="445567">.</span><span class="ident" id="445568">modtime</span><span class="op" id="445575">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445580">etag</span><span class="op" id="445584">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="445593">tt</span><span class="op" id="445595">.</span><span class="ident" id="445596">serveETag</span><span class="op" id="445605">,</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445610">contentType</span><span class="op" id="445621">:</span>&nbsp;<span class="ident" id="445623">tt</span><span class="op" id="445625">.</span><span class="ident" id="445626">serveContentType</span><span class="op" id="445642">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="445646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445650">req</span><span class="op" id="445653">,</span>&nbsp;<span class="ident" id="445655">err</span>&nbsp;<span class="op" id="445659">:=</span>&nbsp;<span class="ident" id="445662">NewRequest</span><span class="op" id="445672">(</span><span class="string" id="445673">&#34;GET&#34;</span><span class="op" id="445678">,</span>&nbsp;<span class="ident" id="445680">ts</span><span class="op" id="445682">.</span><span class="ident" id="445683">URL</span><span class="op" id="445686">,</span>&nbsp;<span class="ident" id="445688">nil</span><span class="op" id="445691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="445695">if</span>&nbsp;<span class="ident" id="445698">err</span>&nbsp;<span class="op" id="445702">!=</span>&nbsp;<span class="ident" id="445705">nil</span>&nbsp;<span class="op" id="445709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445714">t</span><span class="op" id="445715">.</span><span class="ident" id="445716">Fatal</span><span class="op" id="445721">(</span><span class="ident" id="445722">err</span><span class="op" id="445725">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="445729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="445733">for</span>&nbsp;<span class="ident" id="445737">k</span><span class="op" id="445738">,</span>&nbsp;<span class="ident" id="445740">v</span>&nbsp;<span class="op" id="445742">:=</span>&nbsp;<span class="keyword" id="445745">range</span>&nbsp;<span class="ident" id="445751">tt</span><span class="op" id="445753">.</span><span class="ident" id="445754">reqHeader</span>&nbsp;<span class="op" id="445764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445769">req</span><span class="op" id="445772">.</span><span class="ident" id="445773">Header</span><span class="op" id="445779">.</span><span class="ident" id="445780">Set</span><span class="op" id="445783">(</span><span class="ident" id="445784">k</span><span class="op" id="445785">,</span>&nbsp;<span class="ident" id="445787">v</span><span class="op" id="445788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="445792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445796">res</span><span class="op" id="445799">,</span>&nbsp;<span class="ident" id="445801">err</span>&nbsp;<span class="op" id="445805">:=</span>&nbsp;<span class="ident" id="445808">DefaultClient</span><span class="op" id="445821">.</span><span class="ident" id="445822">Do</span><span class="op" id="445824">(</span><span class="ident" id="445825">req</span><span class="op" id="445828">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="445832">if</span>&nbsp;<span class="ident" id="445835">err</span>&nbsp;<span class="op" id="445839">!=</span>&nbsp;<span class="ident" id="445842">nil</span>&nbsp;<span class="op" id="445846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445851">t</span><span class="op" id="445852">.</span><span class="ident" id="445853">Fatal</span><span class="op" id="445858">(</span><span class="ident" id="445859">err</span><span class="op" id="445862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="445866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445870">io</span><span class="op" id="445872">.</span><span class="ident" id="445873">Copy</span><span class="op" id="445877">(</span><span class="ident" id="445878">ioutil</span><span class="op" id="445884">.</span><span class="ident" id="445885">Discard</span><span class="op" id="445892">,</span>&nbsp;<span class="ident" id="445894">res</span><span class="op" id="445897">.</span><span class="ident" id="445898">Body</span><span class="op" id="445902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445906">res</span><span class="op" id="445909">.</span><span class="ident" id="445910">Body</span><span class="op" id="445914">.</span><span class="ident" id="445915">Close</span><span class="op" id="445920">(</span><span class="op" id="445921">)</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="445925">if</span>&nbsp;<span class="ident" id="445928">res</span><span class="op" id="445931">.</span><span class="ident" id="445932">StatusCode</span>&nbsp;<span class="op" id="445943">!=</span>&nbsp;<span class="ident" id="445946">tt</span><span class="op" id="445948">.</span><span class="ident" id="445949">wantStatus</span>&nbsp;<span class="op" id="445960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="445965">t</span><span class="op" id="445966">.</span><span class="ident" id="445967">Errorf</span><span class="op" id="445973">(</span><span class="string" id="445974">&#34;test&nbsp;%q:&nbsp;status&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="446005">,</span>&nbsp;<span class="ident" id="446007">testName</span><span class="op" id="446015">,</span>&nbsp;<span class="ident" id="446017">res</span><span class="op" id="446020">.</span><span class="ident" id="446021">StatusCode</span><span class="op" id="446031">,</span>&nbsp;<span class="ident" id="446033">tt</span><span class="op" id="446035">.</span><span class="ident" id="446036">wantStatus</span><span class="op" id="446046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="446050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="446054">if</span>&nbsp;<span class="ident" id="446057">g</span><span class="op" id="446058">,</span>&nbsp;<span class="ident" id="446060">e</span>&nbsp;<span class="op" id="446062">:=</span>&nbsp;<span class="ident" id="446065">res</span><span class="op" id="446068">.</span><span class="ident" id="446069">Header</span><span class="op" id="446075">.</span><span class="ident" id="446076">Get</span><span class="op" id="446079">(</span><span class="string" id="446080">&#34;Content-Type&#34;</span><span class="op" id="446094">)</span><span class="op" id="446095">,</span>&nbsp;<span class="ident" id="446097">tt</span><span class="op" id="446099">.</span><span class="ident" id="446100">wantContentType</span><span class="op" id="446115">;</span>&nbsp;<span class="ident" id="446117">g</span>&nbsp;<span class="op" id="446119">!=</span>&nbsp;<span class="ident" id="446122">e</span>&nbsp;<span class="op" id="446124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="446129">t</span><span class="op" id="446130">.</span><span class="ident" id="446131">Errorf</span><span class="op" id="446137">(</span><span class="string" id="446138">&#34;test&nbsp;%q:&nbsp;content-type&nbsp;=&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="446175">,</span>&nbsp;<span class="ident" id="446177">testName</span><span class="op" id="446185">,</span>&nbsp;<span class="ident" id="446187">g</span><span class="op" id="446188">,</span>&nbsp;<span class="ident" id="446190">e</span><span class="op" id="446191">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="446195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="446199">if</span>&nbsp;<span class="ident" id="446202">g</span><span class="op" id="446203">,</span>&nbsp;<span class="ident" id="446205">e</span>&nbsp;<span class="op" id="446207">:=</span>&nbsp;<span class="ident" id="446210">res</span><span class="op" id="446213">.</span><span class="ident" id="446214">Header</span><span class="op" id="446220">.</span><span class="ident" id="446221">Get</span><span class="op" id="446224">(</span><span class="string" id="446225">&#34;Last-Modified&#34;</span><span class="op" id="446240">)</span><span class="op" id="446241">,</span>&nbsp;<span class="ident" id="446243">tt</span><span class="op" id="446245">.</span><span class="ident" id="446246">wantLastMod</span><span class="op" id="446257">;</span>&nbsp;<span class="ident" id="446259">g</span>&nbsp;<span class="op" id="446261">!=</span>&nbsp;<span class="ident" id="446264">e</span>&nbsp;<span class="op" id="446266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="446271">t</span><span class="op" id="446272">.</span><span class="ident" id="446273">Errorf</span><span class="op" id="446279">(</span><span class="string" id="446280">&#34;test&nbsp;%q:&nbsp;last-modified&nbsp;=&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="446318">,</span>&nbsp;<span class="ident" id="446320">testName</span><span class="op" id="446328">,</span>&nbsp;<span class="ident" id="446330">g</span><span class="op" id="446331">,</span>&nbsp;<span class="ident" id="446333">e</span><span class="op" id="446334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="446338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="446341">}</span><br>
<span class="lineno">790</span><span class="op" id="446343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="446346">//&nbsp;verifies&nbsp;that&nbsp;sendfile&nbsp;is&nbsp;being&nbsp;used&nbsp;on&nbsp;Linux</span><br>
<span class="lineno"></span><span class="keyword" id="446395">func</span>&nbsp;<span class="ident" id="446400">TestLinuxSendfile</span><span class="op" id="446417">(</span><span class="ident" id="446418">t</span>&nbsp;<span class="op" id="446420">*</span><span class="ident" id="446421">testing</span><span class="op" id="446428">.</span><span class="ident" id="446429">T</span><span class="op" id="446430">)</span>&nbsp;<span class="op" id="446432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="446435">defer</span>&nbsp;<span class="ident" id="446441">afterTest</span><span class="op" id="446450">(</span><span class="ident" id="446451">t</span><span class="op" id="446452">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="446455">if</span>&nbsp;<span class="ident" id="446458">runtime</span><span class="op" id="446465">.</span><span class="ident" id="446466">GOOS</span>&nbsp;<span class="op" id="446471">!=</span>&nbsp;<span class="string" id="446474">&#34;linux&#34;</span>&nbsp;<span class="op" id="446482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="446486">t</span><span class="op" id="446487">.</span><span class="ident" id="446488">Skip</span><span class="op" id="446492">(</span><span class="string" id="446493">&#34;skipping;&nbsp;linux-only&nbsp;test&#34;</span><span class="op" id="446520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="446523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="446526">if</span>&nbsp;<span class="ident" id="446529">_</span><span class="op" id="446530">,</span>&nbsp;<span class="ident" id="446532">err</span>&nbsp;<span class="op" id="446536">:=</span>&nbsp;<span class="ident" id="446539">exec</span><span class="op" id="446543">.</span><span class="ident" id="446544">LookPath</span><span class="op" id="446552">(</span><span class="string" id="446553">&#34;strace&#34;</span><span class="op" id="446561">)</span><span class="op" id="446562">;</span>&nbsp;<span class="ident" id="446564">err</span>&nbsp;<span class="op" id="446568">!=</span>&nbsp;<span class="ident" id="446571">nil</span>&nbsp;<span class="op" id="446575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="446579">t</span><span class="op" id="446580">.</span><span class="ident" id="446581">Skip</span><span class="op" id="446585">(</span><span class="string" id="446586">&#34;skipping;&nbsp;strace&nbsp;not&nbsp;found&nbsp;in&nbsp;path&#34;</span><span class="op" id="446622">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="446625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="446629">ln</span><span class="op" id="446631">,</span>&nbsp;<span class="ident" id="446633">err</span>&nbsp;<span class="op" id="446637">:=</span>&nbsp;<span class="ident" id="446640">net</span><span class="op" id="446643">.</span><span class="ident" id="446644">Listen</span><span class="op" id="446650">(</span><span class="string" id="446651">&#34;tcp&#34;</span><span class="op" id="446656">,</span>&nbsp;<span class="string" id="446658">&#34;127.0.0.1:0&#34;</span><span class="op" id="446671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="446674">if</span>&nbsp;<span class="ident" id="446677">err</span>&nbsp;<span class="op" id="446681">!=</span>&nbsp;<span class="ident" id="446684">nil</span>&nbsp;<span class="op" id="446688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="446692">t</span><span class="op" id="446693">.</span><span class="ident" id="446694">Fatal</span><span class="op" id="446699">(</span><span class="ident" id="446700">err</span><span class="op" id="446703">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="446706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="446709">lnf</span><span class="op" id="446712">,</span>&nbsp;<span class="ident" id="446714">err</span>&nbsp;<span class="op" id="446718">:=</span>&nbsp;<span class="ident" id="446721">ln</span><span class="op" id="446723">.</span><span class="op" id="446724">(</span><span class="op" id="446725">*</span><span class="ident" id="446726">net</span><span class="op" id="446729">.</span><span class="ident" id="446730">TCPListener</span><span class="op" id="446741">)</span><span class="op" id="446742">.</span><span class="ident" id="446743">File</span><span class="op" id="446747">(</span><span class="op" id="446748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="446751">if</span>&nbsp;<span class="ident" id="446754">err</span>&nbsp;<span class="op" id="446758">!=</span>&nbsp;<span class="ident" id="446761">nil</span>&nbsp;<span class="op" id="446765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="446769">t</span><span class="op" id="446770">.</span><span class="ident" id="446771">Fatal</span><span class="op" id="446776">(</span><span class="ident" id="446777">err</span><span class="op" id="446780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="446783">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="446786">defer</span>&nbsp;<span class="ident" id="446792">ln</span><span class="op" id="446794">.</span><span class="ident" id="446795">Close</span><span class="op" id="446800">(</span><span class="op" id="446801">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="446805">var</span>&nbsp;<span class="ident" id="446809">buf</span>&nbsp;<span class="ident" id="446813">bytes</span><span class="op" id="446818">.</span><span class="ident" id="446819">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="446827">child</span>&nbsp;<span class="op" id="446833">:=</span>&nbsp;<span class="ident" id="446836">exec</span><span class="op" id="446840">.</span><span class="ident" id="446841">Command</span><span class="op" id="446848">(</span><span class="string" id="446849">&#34;strace&#34;</span><span class="op" id="446857">,</span>&nbsp;<span class="string" id="446859">&#34;-f&#34;</span><span class="op" id="446863">,</span>&nbsp;<span class="string" id="446865">&#34;-q&#34;</span><span class="op" id="446869">,</span>&nbsp;<span class="string" id="446871">&#34;-e&#34;</span><span class="op" id="446875">,</span>&nbsp;<span class="string" id="446877">&#34;trace=sendfile,sendfile64&#34;</span><span class="op" id="446904">,</span>&nbsp;<span class="ident" id="446906">os</span><span class="op" id="446908">.</span><span class="ident" id="446909">Args</span><span class="op" id="446913">[</span><span class="num" id="446914">0</span><span class="op" id="446915">]</span><span class="op" id="446916">,</span>&nbsp;<span class="string" id="446918">&#34;-test.run=TestLinuxSendfileChild&#34;</span><span class="op" id="446952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="446955">child</span><span class="op" id="446960">.</span><span class="ident" id="446961">ExtraFiles</span>&nbsp;<span class="op" id="446972">=</span>&nbsp;<span class="builtinfunc" id="446974">append</span><span class="op" id="446980">(</span><span class="ident" id="446981">child</span><span class="op" id="446986">.</span><span class="ident" id="446987">ExtraFiles</span><span class="op" id="446997">,</span>&nbsp;<span class="ident" id="446999">lnf</span><span class="op" id="447002">)</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447005">child</span><span class="op" id="447010">.</span><span class="ident" id="447011">Env</span>&nbsp;<span class="op" id="447015">=</span>&nbsp;<span class="builtinfunc" id="447017">append</span><span class="op" id="447023">(</span><span class="op" id="447024">[</span><span class="op" id="447025">]</span><span class="builtintype" id="447026">string</span><span class="op" id="447032">{</span><span class="string" id="447033">&#34;GO_WANT_HELPER_PROCESS=1&#34;</span><span class="op" id="447059">}</span><span class="op" id="447060">,</span>&nbsp;<span class="ident" id="447062">os</span><span class="op" id="447064">.</span><span class="ident" id="447065">Environ</span><span class="op" id="447072">(</span><span class="op" id="447073">)</span><span class="op" id="447074">...</span><span class="op" id="447077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447080">child</span><span class="op" id="447085">.</span><span class="ident" id="447086">Stdout</span>&nbsp;<span class="op" id="447093">=</span>&nbsp;<span class="op" id="447095">&amp;</span><span class="ident" id="447096">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447101">child</span><span class="op" id="447106">.</span><span class="ident" id="447107">Stderr</span>&nbsp;<span class="op" id="447114">=</span>&nbsp;<span class="op" id="447116">&amp;</span><span class="ident" id="447117">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="447122">if</span>&nbsp;<span class="ident" id="447125">err</span>&nbsp;<span class="op" id="447129">:=</span>&nbsp;<span class="ident" id="447132">child</span><span class="op" id="447137">.</span><span class="ident" id="447138">Start</span><span class="op" id="447143">(</span><span class="op" id="447144">)</span><span class="op" id="447145">;</span>&nbsp;<span class="ident" id="447147">err</span>&nbsp;<span class="op" id="447151">!=</span>&nbsp;<span class="ident" id="447154">nil</span>&nbsp;<span class="op" id="447158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447162">t</span><span class="op" id="447163">.</span><span class="ident" id="447164">Skipf</span><span class="op" id="447169">(</span><span class="string" id="447170">&#34;skipping;&nbsp;failed&nbsp;to&nbsp;start&nbsp;straced&nbsp;child:&nbsp;%v&#34;</span><span class="op" id="447215">,</span>&nbsp;<span class="ident" id="447217">err</span><span class="op" id="447220">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="447223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447227">res</span><span class="op" id="447230">,</span>&nbsp;<span class="ident" id="447232">err</span>&nbsp;<span class="op" id="447236">:=</span>&nbsp;<span class="ident" id="447239">Get</span><span class="op" id="447242">(</span><span class="ident" id="447243">fmt</span><span class="op" id="447246">.</span><span class="ident" id="447247">Sprintf</span><span class="op" id="447254">(</span><span class="string" id="447255">&#34;http://%s/&#34;</span><span class="op" id="447267">,</span>&nbsp;<span class="ident" id="447269">ln</span><span class="op" id="447271">.</span><span class="ident" id="447272">Addr</span><span class="op" id="447276">(</span><span class="op" id="447277">)</span><span class="op" id="447278">)</span><span class="op" id="447279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="447282">if</span>&nbsp;<span class="ident" id="447285">err</span>&nbsp;<span class="op" id="447289">!=</span>&nbsp;<span class="ident" id="447292">nil</span>&nbsp;<span class="op" id="447296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447300">t</span><span class="op" id="447301">.</span><span class="ident" id="447302">Fatalf</span><span class="op" id="447308">(</span><span class="string" id="447309">&#34;http&nbsp;client&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="447332">,</span>&nbsp;<span class="ident" id="447334">err</span><span class="op" id="447337">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="447340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447343">_</span><span class="op" id="447344">,</span>&nbsp;<span class="ident" id="447346">err</span>&nbsp;<span class="op" id="447350">=</span>&nbsp;<span class="ident" id="447352">io</span><span class="op" id="447354">.</span><span class="ident" id="447355">Copy</span><span class="op" id="447359">(</span><span class="ident" id="447360">ioutil</span><span class="op" id="447366">.</span><span class="ident" id="447367">Discard</span><span class="op" id="447374">,</span>&nbsp;<span class="ident" id="447376">res</span><span class="op" id="447379">.</span><span class="ident" id="447380">Body</span><span class="op" id="447384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="447387">if</span>&nbsp;<span class="ident" id="447390">err</span>&nbsp;<span class="op" id="447394">!=</span>&nbsp;<span class="ident" id="447397">nil</span>&nbsp;<span class="op" id="447401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447405">t</span><span class="op" id="447406">.</span><span class="ident" id="447407">Fatalf</span><span class="op" id="447413">(</span><span class="string" id="447414">&#34;client&nbsp;body&nbsp;read&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="447442">,</span>&nbsp;<span class="ident" id="447444">err</span><span class="op" id="447447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="447450">}</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447453">res</span><span class="op" id="447456">.</span><span class="ident" id="447457">Body</span><span class="op" id="447461">.</span><span class="ident" id="447462">Close</span><span class="op" id="447467">(</span><span class="op" id="447468">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="447472">//&nbsp;Force&nbsp;child&nbsp;to&nbsp;exit&nbsp;cleanly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447505">Get</span><span class="op" id="447508">(</span><span class="ident" id="447509">fmt</span><span class="op" id="447512">.</span><span class="ident" id="447513">Sprintf</span><span class="op" id="447520">(</span><span class="string" id="447521">&#34;http://%s/quit&#34;</span><span class="op" id="447537">,</span>&nbsp;<span class="ident" id="447539">ln</span><span class="op" id="447541">.</span><span class="ident" id="447542">Addr</span><span class="op" id="447546">(</span><span class="op" id="447547">)</span><span class="op" id="447548">)</span><span class="op" id="447549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447552">child</span><span class="op" id="447557">.</span><span class="ident" id="447558">Wait</span><span class="op" id="447562">(</span><span class="op" id="447563">)</span><br>
<span class="lineno">835</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447567">rx</span>&nbsp;<span class="op" id="447570">:=</span>&nbsp;<span class="ident" id="447573">regexp</span><span class="op" id="447579">.</span><span class="ident" id="447580">MustCompile</span><span class="op" id="447591">(</span><span class="string" id="447592">`sendfile(64)?\(\d+,\s*\d+,\s*NULL,\s*\d+\)\s*=\s*\d+\s*\n`</span><span class="op" id="447651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447654">rxResume</span>&nbsp;<span class="op" id="447663">:=</span>&nbsp;<span class="ident" id="447666">regexp</span><span class="op" id="447672">.</span><span class="ident" id="447673">MustCompile</span><span class="op" id="447684">(</span><span class="string" id="447685">`&lt;\.\.\.&nbsp;sendfile(64)?&nbsp;resumed&gt;&nbsp;\)\s*=\s*\d+\s*\n`</span><span class="op" id="447735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447738">out</span>&nbsp;<span class="op" id="447742">:=</span>&nbsp;<span class="ident" id="447745">buf</span><span class="op" id="447748">.</span><span class="ident" id="447749">String</span><span class="op" id="447755">(</span><span class="op" id="447756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="447759">if</span>&nbsp;<span class="op" id="447762">!</span><span class="ident" id="447763">rx</span><span class="op" id="447765">.</span><span class="ident" id="447766">MatchString</span><span class="op" id="447777">(</span><span class="ident" id="447778">out</span><span class="op" id="447781">)</span>&nbsp;<span class="op" id="447783">&amp;&amp;</span>&nbsp;<span class="op" id="447786">!</span><span class="ident" id="447787">rxResume</span><span class="op" id="447795">.</span><span class="ident" id="447796">MatchString</span><span class="op" id="447807">(</span><span class="ident" id="447808">out</span><span class="op" id="447811">)</span>&nbsp;<span class="op" id="447813">{</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447817">t</span><span class="op" id="447818">.</span><span class="ident" id="447819">Errorf</span><span class="op" id="447825">(</span><span class="string" id="447826">&#34;no&nbsp;sendfile&nbsp;system&nbsp;call&nbsp;found&nbsp;in:\n%s&#34;</span><span class="op" id="447865">,</span>&nbsp;<span class="ident" id="447867">out</span><span class="op" id="447870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="447873">}</span><br>
<span class="lineno"></span><span class="op" id="447875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="447878">func</span>&nbsp;<span class="ident" id="447883">getBody</span><span class="op" id="447890">(</span><span class="ident" id="447891">t</span>&nbsp;<span class="op" id="447893">*</span><span class="ident" id="447894">testing</span><span class="op" id="447901">.</span><span class="ident" id="447902">T</span><span class="op" id="447903">,</span>&nbsp;<span class="ident" id="447905">testName</span>&nbsp;<span class="builtintype" id="447914">string</span><span class="op" id="447920">,</span>&nbsp;<span class="ident" id="447922">req</span>&nbsp;<span class="ident" id="447926">Request</span><span class="op" id="447933">)</span>&nbsp;<span class="op" id="447935">(</span><span class="op" id="447936">*</span><span class="ident" id="447937">Response</span><span class="op" id="447945">,</span>&nbsp;<span class="op" id="447947">[</span><span class="op" id="447948">]</span><span class="builtintype" id="447949">byte</span><span class="op" id="447953">)</span>&nbsp;<span class="op" id="447955">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="447958">r</span><span class="op" id="447959">,</span>&nbsp;<span class="ident" id="447961">err</span>&nbsp;<span class="op" id="447965">:=</span>&nbsp;<span class="ident" id="447968">DefaultClient</span><span class="op" id="447981">.</span><span class="ident" id="447982">Do</span><span class="op" id="447984">(</span><span class="op" id="447985">&amp;</span><span class="ident" id="447986">req</span><span class="op" id="447989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="447992">if</span>&nbsp;<span class="ident" id="447995">err</span>&nbsp;<span class="op" id="447999">!=</span>&nbsp;<span class="ident" id="448002">nil</span>&nbsp;<span class="op" id="448006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="448010">t</span><span class="op" id="448011">.</span><span class="ident" id="448012">Fatalf</span><span class="op" id="448018">(</span><span class="string" id="448019">&#34;%s:&nbsp;for&nbsp;URL&nbsp;%q,&nbsp;send&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="448051">,</span>&nbsp;<span class="ident" id="448053">testName</span><span class="op" id="448061">,</span>&nbsp;<span class="ident" id="448063">req</span><span class="op" id="448066">.</span><span class="ident" id="448067">URL</span><span class="op" id="448070">.</span><span class="ident" id="448071">String</span><span class="op" id="448077">(</span><span class="op" id="448078">)</span><span class="op" id="448079">,</span>&nbsp;<span class="ident" id="448081">err</span><span class="op" id="448084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="448087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="448090">b</span><span class="op" id="448091">,</span>&nbsp;<span class="ident" id="448093">err</span>&nbsp;<span class="op" id="448097">:=</span>&nbsp;<span class="ident" id="448100">ioutil</span><span class="op" id="448106">.</span><span class="ident" id="448107">ReadAll</span><span class="op" id="448114">(</span><span class="ident" id="448115">r</span><span class="op" id="448116">.</span><span class="ident" id="448117">Body</span><span class="op" id="448121">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="448124">if</span>&nbsp;<span class="ident" id="448127">err</span>&nbsp;<span class="op" id="448131">!=</span>&nbsp;<span class="ident" id="448134">nil</span>&nbsp;<span class="op" id="448138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="448142">t</span><span class="op" id="448143">.</span><span class="ident" id="448144">Fatalf</span><span class="op" id="448150">(</span><span class="string" id="448151">&#34;%s:&nbsp;for&nbsp;URL&nbsp;%q,&nbsp;reading&nbsp;body:&nbsp;%v&#34;</span><span class="op" id="448185">,</span>&nbsp;<span class="ident" id="448187">testName</span><span class="op" id="448195">,</span>&nbsp;<span class="ident" id="448197">req</span><span class="op" id="448200">.</span><span class="ident" id="448201">URL</span><span class="op" id="448204">.</span><span class="ident" id="448205">String</span><span class="op" id="448211">(</span><span class="op" id="448212">)</span><span class="op" id="448213">,</span>&nbsp;<span class="ident" id="448215">err</span><span class="op" id="448218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="448221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="448224">return</span>&nbsp;<span class="ident" id="448231">r</span><span class="op" id="448232">,</span>&nbsp;<span class="ident" id="448234">b</span><br>
<span class="lineno"></span><span class="op" id="448236">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span><span class="comment" id="448239">//&nbsp;TestLinuxSendfileChild&nbsp;isn&#39;t&nbsp;a&nbsp;real&nbsp;test.&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;helper&nbsp;process</span><br>
<span class="lineno"></span><span class="comment" id="448314">//&nbsp;for&nbsp;TestLinuxSendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="448340">func</span>&nbsp;<span class="ident" id="448345">TestLinuxSendfileChild</span><span class="op" id="448367">(</span><span class="op" id="448368">*</span><span class="ident" id="448369">testing</span><span class="op" id="448376">.</span><span class="ident" id="448377">T</span><span class="op" id="448378">)</span>&nbsp;<span class="op" id="448380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="448383">if</span>&nbsp;<span class="ident" id="448386">os</span><span class="op" id="448388">.</span><span class="ident" id="448389">Getenv</span><span class="op" id="448395">(</span><span class="string" id="448396">&#34;GO_WANT_HELPER_PROCESS&#34;</span><span class="op" id="448420">)</span>&nbsp;<span class="op" id="448422">!=</span>&nbsp;<span class="string" id="448425">&#34;1&#34;</span>&nbsp;<span class="op" id="448429">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="448433">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="448441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="448444">defer</span>&nbsp;<span class="ident" id="448450">os</span><span class="op" id="448452">.</span><span class="ident" id="448453">Exit</span><span class="op" id="448457">(</span><span class="num" id="448458">0</span><span class="op" id="448459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="448462">fd3</span>&nbsp;<span class="op" id="448466">:=</span>&nbsp;<span class="ident" id="448469">os</span><span class="op" id="448471">.</span><span class="ident" id="448472">NewFile</span><span class="op" id="448479">(</span><span class="num" id="448480">3</span><span class="op" id="448481">,</span>&nbsp;<span class="string" id="448483">&#34;ephemeral-port-listener&#34;</span><span class="op" id="448508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="448511">ln</span><span class="op" id="448513">,</span>&nbsp;<span class="ident" id="448515">err</span>&nbsp;<span class="op" id="448519">:=</span>&nbsp;<span class="ident" id="448522">net</span><span class="op" id="448525">.</span><span class="ident" id="448526">FileListener</span><span class="op" id="448538">(</span><span class="ident" id="448539">fd3</span><span class="op" id="448542">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="448545">if</span>&nbsp;<span class="ident" id="448548">err</span>&nbsp;<span class="op" id="448552">!=</span>&nbsp;<span class="ident" id="448555">nil</span>&nbsp;<span class="op" id="448559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="448563">panic</span><span class="op" id="448568">(</span><span class="ident" id="448569">err</span><span class="op" id="448572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="448575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="448578">mux</span>&nbsp;<span class="op" id="448582">:=</span>&nbsp;<span class="ident" id="448585">NewServeMux</span><span class="op" id="448596">(</span><span class="op" id="448597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="448600">mux</span><span class="op" id="448603">.</span><span class="ident" id="448604">Handle</span><span class="op" id="448610">(</span><span class="string" id="448611">&#34;/&#34;</span><span class="op" id="448614">,</span>&nbsp;<span class="ident" id="448616">FileServer</span><span class="op" id="448626">(</span><span class="ident" id="448627">Dir</span><span class="op" id="448630">(</span><span class="string" id="448631">&#34;testdata&#34;</span><span class="op" id="448641">)</span><span class="op" id="448642">)</span><span class="op" id="448643">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="448646">mux</span><span class="op" id="448649">.</span><span class="ident" id="448650">HandleFunc</span><span class="op" id="448660">(</span><span class="string" id="448661">&#34;/quit&#34;</span><span class="op" id="448668">,</span>&nbsp;<span class="keyword" id="448670">func</span><span class="op" id="448674">(</span><span class="ident" id="448675">ResponseWriter</span><span class="op" id="448689">,</span>&nbsp;<span class="op" id="448691">*</span><span class="ident" id="448692">Request</span><span class="op" id="448699">)</span>&nbsp;<span class="op" id="448701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="448705">os</span><span class="op" id="448707">.</span><span class="ident" id="448708">Exit</span><span class="op" id="448712">(</span><span class="num" id="448713">0</span><span class="op" id="448714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="448717">}</span><span class="op" id="448718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="448721">s</span>&nbsp;<span class="op" id="448723">:=</span>&nbsp;<span class="op" id="448726">&amp;</span><span class="ident" id="448727">Server</span><span class="op" id="448733">{</span><span class="ident" id="448734">Handler</span><span class="op" id="448741">:</span>&nbsp;<span class="ident" id="448743">mux</span><span class="op" id="448746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="448749">err</span>&nbsp;<span class="op" id="448753">=</span>&nbsp;<span class="ident" id="448755">s</span><span class="op" id="448756">.</span><span class="ident" id="448757">Serve</span><span class="op" id="448762">(</span><span class="ident" id="448763">ln</span><span class="op" id="448765">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="448768">if</span>&nbsp;<span class="ident" id="448771">err</span>&nbsp;<span class="op" id="448775">!=</span>&nbsp;<span class="ident" id="448778">nil</span>&nbsp;<span class="op" id="448782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="448786">panic</span><span class="op" id="448791">(</span><span class="ident" id="448792">err</span><span class="op" id="448795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="448798">}</span><br>
<span class="lineno"></span><span class="op" id="448800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span><span class="keyword" id="448803">func</span>&nbsp;<span class="ident" id="448808">TestFileServerCleanPath</span><span class="op" id="448831">(</span><span class="ident" id="448832">t</span>&nbsp;<span class="op" id="448834">*</span><span class="ident" id="448835">testing</span><span class="op" id="448842">.</span><span class="ident" id="448843">T</span><span class="op" id="448844">)</span>&nbsp;<span class="op" id="448846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="448849">tests</span>&nbsp;<span class="op" id="448855">:=</span>&nbsp;<span class="op" id="448858">[</span><span class="op" id="448859">]</span><span class="keyword" id="448860">struct</span>&nbsp;<span class="op" id="448867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="448871">path</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="448880">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="448889">wantCode</span>&nbsp;<span class="builtintype" id="448898">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="448904">wantOpen</span>&nbsp;<span class="op" id="448913">[</span><span class="op" id="448914">]</span><span class="builtintype" id="448915">string</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="448923">}</span><span class="op" id="448924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="448928">{</span><span class="string" id="448929">&#34;/&#34;</span><span class="op" id="448932">,</span>&nbsp;<span class="num" id="448934">200</span><span class="op" id="448937">,</span>&nbsp;<span class="op" id="448939">[</span><span class="op" id="448940">]</span><span class="builtintype" id="448941">string</span><span class="op" id="448947">{</span><span class="string" id="448948">&#34;/&#34;</span><span class="op" id="448951">,</span>&nbsp;<span class="string" id="448953">&#34;/index.html&#34;</span><span class="op" id="448966">}</span><span class="op" id="448967">}</span><span class="op" id="448968">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="448972">{</span><span class="string" id="448973">&#34;/dir&#34;</span><span class="op" id="448979">,</span>&nbsp;<span class="num" id="448981">301</span><span class="op" id="448984">,</span>&nbsp;<span class="op" id="448986">[</span><span class="op" id="448987">]</span><span class="builtintype" id="448988">string</span><span class="op" id="448994">{</span><span class="string" id="448995">&#34;/dir&#34;</span><span class="op" id="449001">}</span><span class="op" id="449002">}</span><span class="op" id="449003">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="449007">{</span><span class="string" id="449008">&#34;/dir/&#34;</span><span class="op" id="449015">,</span>&nbsp;<span class="num" id="449017">200</span><span class="op" id="449020">,</span>&nbsp;<span class="op" id="449022">[</span><span class="op" id="449023">]</span><span class="builtintype" id="449024">string</span><span class="op" id="449030">{</span><span class="string" id="449031">&#34;/dir&#34;</span><span class="op" id="449037">,</span>&nbsp;<span class="string" id="449039">&#34;/dir/index.html&#34;</span><span class="op" id="449056">}</span><span class="op" id="449057">}</span><span class="op" id="449058">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="449061">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="449064">for</span>&nbsp;<span class="ident" id="449068">_</span><span class="op" id="449069">,</span>&nbsp;<span class="ident" id="449071">tt</span>&nbsp;<span class="op" id="449074">:=</span>&nbsp;<span class="keyword" id="449077">range</span>&nbsp;<span class="ident" id="449083">tests</span>&nbsp;<span class="op" id="449089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="449093">var</span>&nbsp;<span class="ident" id="449097">log</span>&nbsp;<span class="op" id="449101">[</span><span class="op" id="449102">]</span><span class="builtintype" id="449103">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="449112">rr</span>&nbsp;<span class="op" id="449115">:=</span>&nbsp;<span class="ident" id="449118">httptest</span><span class="op" id="449126">.</span><span class="ident" id="449127">NewRecorder</span><span class="op" id="449138">(</span><span class="op" id="449139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="449143">req</span><span class="op" id="449146">,</span>&nbsp;<span class="ident" id="449148">_</span>&nbsp;<span class="op" id="449150">:=</span>&nbsp;<span class="ident" id="449153">NewRequest</span><span class="op" id="449163">(</span><span class="string" id="449164">&#34;GET&#34;</span><span class="op" id="449169">,</span>&nbsp;<span class="string" id="449171">&#34;http://foo.localhost&#34;</span><span class="op" id="449193">+</span><span class="ident" id="449194">tt</span><span class="op" id="449196">.</span><span class="ident" id="449197">path</span><span class="op" id="449201">,</span>&nbsp;<span class="ident" id="449203">nil</span><span class="op" id="449206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="449210">FileServer</span><span class="op" id="449220">(</span><span class="ident" id="449221">fileServerCleanPathDir</span><span class="op" id="449243">{</span><span class="op" id="449244">&amp;</span><span class="ident" id="449245">log</span><span class="op" id="449248">}</span><span class="op" id="449249">)</span><span class="op" id="449250">.</span><span class="ident" id="449251">ServeHTTP</span><span class="op" id="449260">(</span><span class="ident" id="449261">rr</span><span class="op" id="449263">,</span>&nbsp;<span class="ident" id="449265">req</span><span class="op" id="449268">)</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="449272">if</span>&nbsp;<span class="op" id="449275">!</span><span class="ident" id="449276">reflect</span><span class="op" id="449283">.</span><span class="ident" id="449284">DeepEqual</span><span class="op" id="449293">(</span><span class="ident" id="449294">log</span><span class="op" id="449297">,</span>&nbsp;<span class="ident" id="449299">tt</span><span class="op" id="449301">.</span><span class="ident" id="449302">wantOpen</span><span class="op" id="449310">)</span>&nbsp;<span class="op" id="449312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="449317">t</span><span class="op" id="449318">.</span><span class="ident" id="449319">Logf</span><span class="op" id="449323">(</span><span class="string" id="449324">&#34;For&nbsp;%s:&nbsp;Opens&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="449353">,</span>&nbsp;<span class="ident" id="449355">tt</span><span class="op" id="449357">.</span><span class="ident" id="449358">path</span><span class="op" id="449362">,</span>&nbsp;<span class="ident" id="449364">log</span><span class="op" id="449367">,</span>&nbsp;<span class="ident" id="449369">tt</span><span class="op" id="449371">.</span><span class="ident" id="449372">wantOpen</span><span class="op" id="449380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="449384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="449388">if</span>&nbsp;<span class="ident" id="449391">rr</span><span class="op" id="449393">.</span><span class="ident" id="449394">Code</span>&nbsp;<span class="op" id="449399">!=</span>&nbsp;<span class="ident" id="449402">tt</span><span class="op" id="449404">.</span><span class="ident" id="449405">wantCode</span>&nbsp;<span class="op" id="449414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="449419">t</span><span class="op" id="449420">.</span><span class="ident" id="449421">Logf</span><span class="op" id="449425">(</span><span class="string" id="449426">&#34;For&nbsp;%s:&nbsp;Response&nbsp;code&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="449463">,</span>&nbsp;<span class="ident" id="449465">tt</span><span class="op" id="449467">.</span><span class="ident" id="449468">path</span><span class="op" id="449472">,</span>&nbsp;<span class="ident" id="449474">rr</span><span class="op" id="449476">.</span><span class="ident" id="449477">Code</span><span class="op" id="449481">,</span>&nbsp;<span class="ident" id="449483">tt</span><span class="op" id="449485">.</span><span class="ident" id="449486">wantCode</span><span class="op" id="449494">)</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="449498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="449501">}</span><br>
<span class="lineno"></span><span class="op" id="449503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="449506">type</span>&nbsp;<span class="ident" id="449511">fileServerCleanPathDir</span>&nbsp;<span class="keyword" id="449534">struct</span>&nbsp;<span class="op" id="449541">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="449544">log</span>&nbsp;<span class="op" id="449548">*</span><span class="op" id="449549">[</span><span class="op" id="449550">]</span><span class="builtintype" id="449551">string</span><br>
<span class="lineno"></span><span class="op" id="449558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="449561">func</span>&nbsp;<span class="op" id="449566">(</span><span class="ident" id="449567">d</span>&nbsp;<span class="ident" id="449569">fileServerCleanPathDir</span><span class="op" id="449591">)</span>&nbsp;<span class="ident" id="449593">Open</span><span class="op" id="449597">(</span><span class="ident" id="449598">path</span>&nbsp;<span class="builtintype" id="449603">string</span><span class="op" id="449609">)</span>&nbsp;<span class="op" id="449611">(</span><span class="ident" id="449612">File</span><span class="op" id="449616">,</span>&nbsp;<span class="builtintype" id="449618">error</span><span class="op" id="449623">)</span>&nbsp;<span class="op" id="449625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="449628">*</span><span class="op" id="449629">(</span><span class="ident" id="449630">d</span><span class="op" id="449631">.</span><span class="ident" id="449632">log</span><span class="op" id="449635">)</span>&nbsp;<span class="op" id="449637">=</span>&nbsp;<span class="builtinfunc" id="449639">append</span><span class="op" id="449645">(</span><span class="op" id="449646">*</span><span class="op" id="449647">(</span><span class="ident" id="449648">d</span><span class="op" id="449649">.</span><span class="ident" id="449650">log</span><span class="op" id="449653">)</span><span class="op" id="449654">,</span>&nbsp;<span class="ident" id="449656">path</span><span class="op" id="449660">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="449663">if</span>&nbsp;<span class="ident" id="449666">path</span>&nbsp;<span class="op" id="449671">==</span>&nbsp;<span class="string" id="449674">&#34;/&#34;</span>&nbsp;<span class="op" id="449678">||</span>&nbsp;<span class="ident" id="449681">path</span>&nbsp;<span class="op" id="449686">==</span>&nbsp;<span class="string" id="449689">&#34;/dir&#34;</span>&nbsp;<span class="op" id="449696">||</span>&nbsp;<span class="ident" id="449699">path</span>&nbsp;<span class="op" id="449704">==</span>&nbsp;<span class="string" id="449707">&#34;/dir/&#34;</span>&nbsp;<span class="op" id="449715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="449719">//&nbsp;Just&nbsp;return&nbsp;back&nbsp;something&nbsp;that&#39;s&nbsp;a&nbsp;directory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="449771">return</span>&nbsp;<span class="ident" id="449778">Dir</span><span class="op" id="449781">(</span><span class="string" id="449782">&#34;.&#34;</span><span class="op" id="449785">)</span><span class="op" id="449786">.</span><span class="ident" id="449787">Open</span><span class="op" id="449791">(</span><span class="string" id="449792">&#34;.&#34;</span><span class="op" id="449795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="449798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="449801">return</span>&nbsp;<span class="ident" id="449808">nil</span><span class="op" id="449811">,</span>&nbsp;<span class="ident" id="449813">os</span><span class="op" id="449815">.</span><span class="ident" id="449816">ErrNotExist</span><br>
<span class="lineno">915</span><span class="op" id="449828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="449831">type</span>&nbsp;<span class="ident" id="449836">panicOnSeek</span>&nbsp;<span class="keyword" id="449848">struct</span><span class="op" id="449854">{</span>&nbsp;<span class="ident" id="449856">io</span><span class="op" id="449858">.</span><span class="ident" id="449859">ReadSeeker</span>&nbsp;<span class="op" id="449870">}</span>
</div>
</body>
</html>
