<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2018730">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2018785">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2018839">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2018890">package</span>&nbsp;<span class="ident" id="2018898">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2018907">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;select&nbsp;statements.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2018974">import</span>&nbsp;<span class="string" id="2018981">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="2018991">const</span>&nbsp;<span class="op" id="2018997">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2019000">debugSelect</span>&nbsp;<span class="op" id="2019012">=</span>&nbsp;<span class="builtintype" id="2019014">false</span><br>
<span class="lineno"></span><span class="op" id="2019020">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="2019023">var</span>&nbsp;<span class="op" id="2019027">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2019030">chansendpc</span>&nbsp;<span class="op" id="2019041">=</span>&nbsp;<span class="ident" id="2019043">funcPC</span><span class="op" id="2019049">(</span><span class="ident" id="2019050">chansend</span><span class="op" id="2019058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2019061">chanrecvpc</span>&nbsp;<span class="op" id="2019072">=</span>&nbsp;<span class="ident" id="2019074">funcPC</span><span class="op" id="2019080">(</span><span class="ident" id="2019081">chanrecv</span><span class="op" id="2019089">)</span><br>
<span class="lineno"></span><span class="op" id="2019091">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="2019094">func</span>&nbsp;<span class="ident" id="2019099">selectsize</span><span class="op" id="2019109">(</span><span class="ident" id="2019110">size</span>&nbsp;<span class="builtintype" id="2019115">uintptr</span><span class="op" id="2019122">)</span>&nbsp;<span class="builtintype" id="2019124">uintptr</span>&nbsp;<span class="op" id="2019132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2019135">selsize</span>&nbsp;<span class="op" id="2019143">:=</span>&nbsp;<span class="ident" id="2019146">unsafe</span><span class="op" id="2019152">.</span><span class="ident" id="2019153">Sizeof</span><span class="op" id="2019159">(</span><span class="ident" id="2019160">_select</span><span class="op" id="2019167">{</span><span class="op" id="2019168">}</span><span class="op" id="2019169">)</span>&nbsp;<span class="op" id="2019171">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2019175">(</span><span class="ident" id="2019176">size</span><span class="op" id="2019180">-</span><span class="num" id="2019181">1</span><span class="op" id="2019182">)</span><span class="op" id="2019183">*</span><span class="ident" id="2019184">unsafe</span><span class="op" id="2019190">.</span><span class="ident" id="2019191">Sizeof</span><span class="op" id="2019197">(</span><span class="ident" id="2019198">_select</span><span class="op" id="2019205">{</span><span class="op" id="2019206">}</span><span class="op" id="2019207">.</span><span class="ident" id="2019208">scase</span><span class="op" id="2019213">[</span><span class="num" id="2019214">0</span><span class="op" id="2019215">]</span><span class="op" id="2019216">)</span>&nbsp;<span class="op" id="2019218">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2019222">size</span><span class="op" id="2019226">*</span><span class="ident" id="2019227">unsafe</span><span class="op" id="2019233">.</span><span class="ident" id="2019234">Sizeof</span><span class="op" id="2019240">(</span><span class="op" id="2019241">*</span><span class="ident" id="2019242">_select</span><span class="op" id="2019249">{</span><span class="op" id="2019250">}</span><span class="op" id="2019251">.</span><span class="ident" id="2019252">lockorder</span><span class="op" id="2019261">)</span>&nbsp;<span class="op" id="2019263">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2019267">size</span><span class="op" id="2019271">*</span><span class="ident" id="2019272">unsafe</span><span class="op" id="2019278">.</span><span class="ident" id="2019279">Sizeof</span><span class="op" id="2019285">(</span><span class="op" id="2019286">*</span><span class="ident" id="2019287">_select</span><span class="op" id="2019294">{</span><span class="op" id="2019295">}</span><span class="op" id="2019296">.</span><span class="ident" id="2019297">pollorder</span><span class="op" id="2019306">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2019309">return</span>&nbsp;<span class="ident" id="2019316">round</span><span class="op" id="2019321">(</span><span class="ident" id="2019322">selsize</span><span class="op" id="2019329">,</span>&nbsp;<span class="ident" id="2019331">_Int64Align</span><span class="op" id="2019342">)</span><br>
<span class="lineno"></span><span class="op" id="2019344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2019347">func</span>&nbsp;<span class="ident" id="2019352">newselect</span><span class="op" id="2019361">(</span><span class="ident" id="2019362">sel</span>&nbsp;<span class="op" id="2019366">*</span><span class="ident" id="2019367">_select</span><span class="op" id="2019374">,</span>&nbsp;<span class="ident" id="2019376">selsize</span>&nbsp;<span class="ident" id="2019384">int64</span><span class="op" id="2019389">,</span>&nbsp;<span class="ident" id="2019391">size</span>&nbsp;<span class="builtintype" id="2019396">int32</span><span class="op" id="2019401">)</span>&nbsp;<span class="op" id="2019403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2019406">if</span>&nbsp;<span class="ident" id="2019409">selsize</span>&nbsp;<span class="op" id="2019417">!=</span>&nbsp;<span class="ident" id="2019420">int64</span><span class="op" id="2019425">(</span><span class="ident" id="2019426">selectsize</span><span class="op" id="2019436">(</span><span class="builtintype" id="2019437">uintptr</span><span class="op" id="2019444">(</span><span class="ident" id="2019445">size</span><span class="op" id="2019449">)</span><span class="op" id="2019450">)</span><span class="op" id="2019451">)</span>&nbsp;<span class="op" id="2019453">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2019457">print</span><span class="op" id="2019462">(</span><span class="string" id="2019463">&#34;runtime:&nbsp;bad&nbsp;select&nbsp;size&nbsp;&#34;</span><span class="op" id="2019490">,</span>&nbsp;<span class="ident" id="2019492">selsize</span><span class="op" id="2019499">,</span>&nbsp;<span class="string" id="2019501">&#34;,&nbsp;want&nbsp;&#34;</span><span class="op" id="2019510">,</span>&nbsp;<span class="ident" id="2019512">selectsize</span><span class="op" id="2019522">(</span><span class="builtintype" id="2019523">uintptr</span><span class="op" id="2019530">(</span><span class="ident" id="2019531">size</span><span class="op" id="2019535">)</span><span class="op" id="2019536">)</span><span class="op" id="2019537">,</span>&nbsp;<span class="string" id="2019539">&#34;\n&#34;</span><span class="op" id="2019543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2019547">gothrow</span><span class="op" id="2019554">(</span><span class="string" id="2019555">&#34;bad&nbsp;select&nbsp;size&#34;</span><span class="op" id="2019572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2019575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2019578">sel</span><span class="op" id="2019581">.</span><span class="ident" id="2019582">tcase</span>&nbsp;<span class="op" id="2019588">=</span>&nbsp;<span class="builtintype" id="2019590">uint16</span><span class="op" id="2019596">(</span><span class="ident" id="2019597">size</span><span class="op" id="2019601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2019604">sel</span><span class="op" id="2019607">.</span><span class="ident" id="2019608">ncase</span>&nbsp;<span class="op" id="2019614">=</span>&nbsp;<span class="num" id="2019616">0</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2019619">sel</span><span class="op" id="2019622">.</span><span class="ident" id="2019623">lockorder</span>&nbsp;<span class="op" id="2019633">=</span>&nbsp;<span class="op" id="2019635">(</span><span class="op" id="2019636">*</span><span class="op" id="2019637">*</span><span class="ident" id="2019638">hchan</span><span class="op" id="2019643">)</span><span class="op" id="2019644">(</span><span class="ident" id="2019645">add</span><span class="op" id="2019648">(</span><span class="ident" id="2019649">unsafe</span><span class="op" id="2019655">.</span><span class="ident" id="2019656">Pointer</span><span class="op" id="2019663">(</span><span class="op" id="2019664">&amp;</span><span class="ident" id="2019665">sel</span><span class="op" id="2019668">.</span><span class="ident" id="2019669">scase</span><span class="op" id="2019674">)</span><span class="op" id="2019675">,</span>&nbsp;<span class="builtintype" id="2019677">uintptr</span><span class="op" id="2019684">(</span><span class="ident" id="2019685">size</span><span class="op" id="2019689">)</span><span class="op" id="2019690">*</span><span class="ident" id="2019691">unsafe</span><span class="op" id="2019697">.</span><span class="ident" id="2019698">Sizeof</span><span class="op" id="2019704">(</span><span class="ident" id="2019705">_select</span><span class="op" id="2019712">{</span><span class="op" id="2019713">}</span><span class="op" id="2019714">.</span><span class="ident" id="2019715">scase</span><span class="op" id="2019720">[</span><span class="num" id="2019721">0</span><span class="op" id="2019722">]</span><span class="op" id="2019723">)</span><span class="op" id="2019724">)</span><span class="op" id="2019725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2019728">sel</span><span class="op" id="2019731">.</span><span class="ident" id="2019732">pollorder</span>&nbsp;<span class="op" id="2019742">=</span>&nbsp;<span class="op" id="2019744">(</span><span class="op" id="2019745">*</span><span class="builtintype" id="2019746">uint16</span><span class="op" id="2019752">)</span><span class="op" id="2019753">(</span><span class="ident" id="2019754">add</span><span class="op" id="2019757">(</span><span class="ident" id="2019758">unsafe</span><span class="op" id="2019764">.</span><span class="ident" id="2019765">Pointer</span><span class="op" id="2019772">(</span><span class="ident" id="2019773">sel</span><span class="op" id="2019776">.</span><span class="ident" id="2019777">lockorder</span><span class="op" id="2019786">)</span><span class="op" id="2019787">,</span>&nbsp;<span class="builtintype" id="2019789">uintptr</span><span class="op" id="2019796">(</span><span class="ident" id="2019797">size</span><span class="op" id="2019801">)</span><span class="op" id="2019802">*</span><span class="ident" id="2019803">unsafe</span><span class="op" id="2019809">.</span><span class="ident" id="2019810">Sizeof</span><span class="op" id="2019816">(</span><span class="op" id="2019817">*</span><span class="ident" id="2019818">_select</span><span class="op" id="2019825">{</span><span class="op" id="2019826">}</span><span class="op" id="2019827">.</span><span class="ident" id="2019828">lockorder</span><span class="op" id="2019837">)</span><span class="op" id="2019838">)</span><span class="op" id="2019839">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2019843">if</span>&nbsp;<span class="ident" id="2019846">debugSelect</span>&nbsp;<span class="op" id="2019858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2019862">print</span><span class="op" id="2019867">(</span><span class="string" id="2019868">&#34;newselect&nbsp;s=&#34;</span><span class="op" id="2019882">,</span>&nbsp;<span class="ident" id="2019884">sel</span><span class="op" id="2019887">,</span>&nbsp;<span class="string" id="2019889">&#34;&nbsp;size=&#34;</span><span class="op" id="2019897">,</span>&nbsp;<span class="ident" id="2019899">size</span><span class="op" id="2019903">,</span>&nbsp;<span class="string" id="2019905">&#34;\n&#34;</span><span class="op" id="2019909">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2019912">}</span><br>
<span class="lineno"></span><span class="op" id="2019914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2019917">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="2019930">func</span>&nbsp;<span class="ident" id="2019935">selectsend</span><span class="op" id="2019945">(</span><span class="ident" id="2019946">sel</span>&nbsp;<span class="op" id="2019950">*</span><span class="ident" id="2019951">_select</span><span class="op" id="2019958">,</span>&nbsp;<span class="ident" id="2019960">c</span>&nbsp;<span class="op" id="2019962">*</span><span class="ident" id="2019963">hchan</span><span class="op" id="2019968">,</span>&nbsp;<span class="ident" id="2019970">elem</span>&nbsp;<span class="ident" id="2019975">unsafe</span><span class="op" id="2019981">.</span><span class="ident" id="2019982">Pointer</span><span class="op" id="2019989">)</span>&nbsp;<span class="op" id="2019991">(</span><span class="ident" id="2019992">selected</span>&nbsp;<span class="builtintype" id="2020001">bool</span><span class="op" id="2020005">)</span>&nbsp;<span class="op" id="2020007">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2020010">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2020039">if</span>&nbsp;<span class="ident" id="2020042">c</span>&nbsp;<span class="op" id="2020044">!=</span>&nbsp;<span class="ident" id="2020047">nil</span>&nbsp;<span class="op" id="2020051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2020055">selectsendImpl</span><span class="op" id="2020069">(</span><span class="ident" id="2020070">sel</span><span class="op" id="2020073">,</span>&nbsp;<span class="ident" id="2020075">c</span><span class="op" id="2020076">,</span>&nbsp;<span class="ident" id="2020078">getcallerpc</span><span class="op" id="2020089">(</span><span class="ident" id="2020090">unsafe</span><span class="op" id="2020096">.</span><span class="ident" id="2020097">Pointer</span><span class="op" id="2020104">(</span><span class="op" id="2020105">&amp;</span><span class="ident" id="2020106">sel</span><span class="op" id="2020109">)</span><span class="op" id="2020110">)</span><span class="op" id="2020111">,</span>&nbsp;<span class="ident" id="2020113">elem</span><span class="op" id="2020117">,</span>&nbsp;<span class="builtintype" id="2020119">uintptr</span><span class="op" id="2020126">(</span><span class="ident" id="2020127">unsafe</span><span class="op" id="2020133">.</span><span class="ident" id="2020134">Pointer</span><span class="op" id="2020141">(</span><span class="op" id="2020142">&amp;</span><span class="ident" id="2020143">selected</span><span class="op" id="2020151">)</span><span class="op" id="2020152">)</span><span class="op" id="2020153">-</span><span class="builtintype" id="2020154">uintptr</span><span class="op" id="2020161">(</span><span class="ident" id="2020162">unsafe</span><span class="op" id="2020168">.</span><span class="ident" id="2020169">Pointer</span><span class="op" id="2020176">(</span><span class="op" id="2020177">&amp;</span><span class="ident" id="2020178">sel</span><span class="op" id="2020181">)</span><span class="op" id="2020182">)</span><span class="op" id="2020183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2020186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2020189">return</span><br>
<span class="lineno">50</span><span class="op" id="2020196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2020199">//&nbsp;cut&nbsp;in&nbsp;half&nbsp;to&nbsp;give&nbsp;stack&nbsp;a&nbsp;chance&nbsp;to&nbsp;split</span><br>
<span class="lineno"></span><span class="keyword" id="2020246">func</span>&nbsp;<span class="ident" id="2020251">selectsendImpl</span><span class="op" id="2020265">(</span><span class="ident" id="2020266">sel</span>&nbsp;<span class="op" id="2020270">*</span><span class="ident" id="2020271">_select</span><span class="op" id="2020278">,</span>&nbsp;<span class="ident" id="2020280">c</span>&nbsp;<span class="op" id="2020282">*</span><span class="ident" id="2020283">hchan</span><span class="op" id="2020288">,</span>&nbsp;<span class="ident" id="2020290">pc</span>&nbsp;<span class="builtintype" id="2020293">uintptr</span><span class="op" id="2020300">,</span>&nbsp;<span class="ident" id="2020302">elem</span>&nbsp;<span class="ident" id="2020307">unsafe</span><span class="op" id="2020313">.</span><span class="ident" id="2020314">Pointer</span><span class="op" id="2020321">,</span>&nbsp;<span class="ident" id="2020323">so</span>&nbsp;<span class="builtintype" id="2020326">uintptr</span><span class="op" id="2020333">)</span>&nbsp;<span class="op" id="2020335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2020338">i</span>&nbsp;<span class="op" id="2020340">:=</span>&nbsp;<span class="ident" id="2020343">sel</span><span class="op" id="2020346">.</span><span class="ident" id="2020347">ncase</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2020354">if</span>&nbsp;<span class="ident" id="2020357">i</span>&nbsp;<span class="op" id="2020359">&gt;=</span>&nbsp;<span class="ident" id="2020362">sel</span><span class="op" id="2020365">.</span><span class="ident" id="2020366">tcase</span>&nbsp;<span class="op" id="2020372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2020376">gothrow</span><span class="op" id="2020383">(</span><span class="string" id="2020384">&#34;selectsend:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="2020412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2020415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2020418">sel</span><span class="op" id="2020421">.</span><span class="ident" id="2020422">ncase</span>&nbsp;<span class="op" id="2020428">=</span>&nbsp;<span class="ident" id="2020430">i</span>&nbsp;<span class="op" id="2020432">+</span>&nbsp;<span class="num" id="2020434">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2020437">cas</span>&nbsp;<span class="op" id="2020441">:=</span>&nbsp;<span class="op" id="2020444">(</span><span class="op" id="2020445">*</span><span class="ident" id="2020446">scase</span><span class="op" id="2020451">)</span><span class="op" id="2020452">(</span><span class="ident" id="2020453">add</span><span class="op" id="2020456">(</span><span class="ident" id="2020457">unsafe</span><span class="op" id="2020463">.</span><span class="ident" id="2020464">Pointer</span><span class="op" id="2020471">(</span><span class="op" id="2020472">&amp;</span><span class="ident" id="2020473">sel</span><span class="op" id="2020476">.</span><span class="ident" id="2020477">scase</span><span class="op" id="2020482">)</span><span class="op" id="2020483">,</span>&nbsp;<span class="builtintype" id="2020485">uintptr</span><span class="op" id="2020492">(</span><span class="ident" id="2020493">i</span><span class="op" id="2020494">)</span><span class="op" id="2020495">*</span><span class="ident" id="2020496">unsafe</span><span class="op" id="2020502">.</span><span class="ident" id="2020503">Sizeof</span><span class="op" id="2020509">(</span><span class="ident" id="2020510">sel</span><span class="op" id="2020513">.</span><span class="ident" id="2020514">scase</span><span class="op" id="2020519">[</span><span class="num" id="2020520">0</span><span class="op" id="2020521">]</span><span class="op" id="2020522">)</span><span class="op" id="2020523">)</span><span class="op" id="2020524">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2020528">cas</span><span class="op" id="2020531">.</span><span class="ident" id="2020532">pc</span>&nbsp;<span class="op" id="2020535">=</span>&nbsp;<span class="ident" id="2020537">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2020541">cas</span><span class="op" id="2020544">.</span><span class="ident" id="2020545">_chan</span>&nbsp;<span class="op" id="2020551">=</span>&nbsp;<span class="ident" id="2020553">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2020556">cas</span><span class="op" id="2020559">.</span><span class="ident" id="2020560">so</span>&nbsp;<span class="op" id="2020563">=</span>&nbsp;<span class="builtintype" id="2020565">uint16</span><span class="op" id="2020571">(</span><span class="ident" id="2020572">so</span><span class="op" id="2020574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2020577">cas</span><span class="op" id="2020580">.</span><span class="ident" id="2020581">kind</span>&nbsp;<span class="op" id="2020586">=</span>&nbsp;<span class="ident" id="2020588">_CaseSend</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2020599">cas</span><span class="op" id="2020602">.</span><span class="ident" id="2020603">elem</span>&nbsp;<span class="op" id="2020608">=</span>&nbsp;<span class="ident" id="2020610">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2020617">if</span>&nbsp;<span class="ident" id="2020620">debugSelect</span>&nbsp;<span class="op" id="2020632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2020636">print</span><span class="op" id="2020641">(</span><span class="string" id="2020642">&#34;selectsend&nbsp;s=&#34;</span><span class="op" id="2020657">,</span>&nbsp;<span class="ident" id="2020659">sel</span><span class="op" id="2020662">,</span>&nbsp;<span class="string" id="2020664">&#34;&nbsp;pc=&#34;</span><span class="op" id="2020670">,</span>&nbsp;<span class="ident" id="2020672">hex</span><span class="op" id="2020675">(</span><span class="ident" id="2020676">cas</span><span class="op" id="2020679">.</span><span class="ident" id="2020680">pc</span><span class="op" id="2020682">)</span><span class="op" id="2020683">,</span>&nbsp;<span class="string" id="2020685">&#34;&nbsp;chan=&#34;</span><span class="op" id="2020693">,</span>&nbsp;<span class="ident" id="2020695">cas</span><span class="op" id="2020698">.</span><span class="ident" id="2020699">_chan</span><span class="op" id="2020704">,</span>&nbsp;<span class="string" id="2020706">&#34;&nbsp;so=&#34;</span><span class="op" id="2020712">,</span>&nbsp;<span class="ident" id="2020714">cas</span><span class="op" id="2020717">.</span><span class="ident" id="2020718">so</span><span class="op" id="2020720">,</span>&nbsp;<span class="string" id="2020722">&#34;\n&#34;</span><span class="op" id="2020726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2020729">}</span><br>
<span class="lineno">70</span><span class="op" id="2020731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2020734">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="2020747">func</span>&nbsp;<span class="ident" id="2020752">selectrecv</span><span class="op" id="2020762">(</span><span class="ident" id="2020763">sel</span>&nbsp;<span class="op" id="2020767">*</span><span class="ident" id="2020768">_select</span><span class="op" id="2020775">,</span>&nbsp;<span class="ident" id="2020777">c</span>&nbsp;<span class="op" id="2020779">*</span><span class="ident" id="2020780">hchan</span><span class="op" id="2020785">,</span>&nbsp;<span class="ident" id="2020787">elem</span>&nbsp;<span class="ident" id="2020792">unsafe</span><span class="op" id="2020798">.</span><span class="ident" id="2020799">Pointer</span><span class="op" id="2020806">)</span>&nbsp;<span class="op" id="2020808">(</span><span class="ident" id="2020809">selected</span>&nbsp;<span class="builtintype" id="2020818">bool</span><span class="op" id="2020822">)</span>&nbsp;<span class="op" id="2020824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2020827">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2020856">if</span>&nbsp;<span class="ident" id="2020859">c</span>&nbsp;<span class="op" id="2020861">!=</span>&nbsp;<span class="ident" id="2020864">nil</span>&nbsp;<span class="op" id="2020868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2020872">selectrecvImpl</span><span class="op" id="2020886">(</span><span class="ident" id="2020887">sel</span><span class="op" id="2020890">,</span>&nbsp;<span class="ident" id="2020892">c</span><span class="op" id="2020893">,</span>&nbsp;<span class="ident" id="2020895">getcallerpc</span><span class="op" id="2020906">(</span><span class="ident" id="2020907">unsafe</span><span class="op" id="2020913">.</span><span class="ident" id="2020914">Pointer</span><span class="op" id="2020921">(</span><span class="op" id="2020922">&amp;</span><span class="ident" id="2020923">sel</span><span class="op" id="2020926">)</span><span class="op" id="2020927">)</span><span class="op" id="2020928">,</span>&nbsp;<span class="ident" id="2020930">elem</span><span class="op" id="2020934">,</span>&nbsp;<span class="ident" id="2020936">nil</span><span class="op" id="2020939">,</span>&nbsp;<span class="builtintype" id="2020941">uintptr</span><span class="op" id="2020948">(</span><span class="ident" id="2020949">unsafe</span><span class="op" id="2020955">.</span><span class="ident" id="2020956">Pointer</span><span class="op" id="2020963">(</span><span class="op" id="2020964">&amp;</span><span class="ident" id="2020965">selected</span><span class="op" id="2020973">)</span><span class="op" id="2020974">)</span><span class="op" id="2020975">-</span><span class="builtintype" id="2020976">uintptr</span><span class="op" id="2020983">(</span><span class="ident" id="2020984">unsafe</span><span class="op" id="2020990">.</span><span class="ident" id="2020991">Pointer</span><span class="op" id="2020998">(</span><span class="op" id="2020999">&amp;</span><span class="ident" id="2021000">sel</span><span class="op" id="2021003">)</span><span class="op" id="2021004">)</span><span class="op" id="2021005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2021008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2021011">return</span><br>
<span class="lineno"></span><span class="op" id="2021018">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="comment" id="2021021">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="2021034">func</span>&nbsp;<span class="ident" id="2021039">selectrecv2</span><span class="op" id="2021050">(</span><span class="ident" id="2021051">sel</span>&nbsp;<span class="op" id="2021055">*</span><span class="ident" id="2021056">_select</span><span class="op" id="2021063">,</span>&nbsp;<span class="ident" id="2021065">c</span>&nbsp;<span class="op" id="2021067">*</span><span class="ident" id="2021068">hchan</span><span class="op" id="2021073">,</span>&nbsp;<span class="ident" id="2021075">elem</span>&nbsp;<span class="ident" id="2021080">unsafe</span><span class="op" id="2021086">.</span><span class="ident" id="2021087">Pointer</span><span class="op" id="2021094">,</span>&nbsp;<span class="ident" id="2021096">received</span>&nbsp;<span class="op" id="2021105">*</span><span class="builtintype" id="2021106">bool</span><span class="op" id="2021110">)</span>&nbsp;<span class="op" id="2021112">(</span><span class="ident" id="2021113">selected</span>&nbsp;<span class="builtintype" id="2021122">bool</span><span class="op" id="2021126">)</span>&nbsp;<span class="op" id="2021128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2021131">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2021160">if</span>&nbsp;<span class="ident" id="2021163">c</span>&nbsp;<span class="op" id="2021165">!=</span>&nbsp;<span class="ident" id="2021168">nil</span>&nbsp;<span class="op" id="2021172">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2021176">selectrecvImpl</span><span class="op" id="2021190">(</span><span class="ident" id="2021191">sel</span><span class="op" id="2021194">,</span>&nbsp;<span class="ident" id="2021196">c</span><span class="op" id="2021197">,</span>&nbsp;<span class="ident" id="2021199">getcallerpc</span><span class="op" id="2021210">(</span><span class="ident" id="2021211">unsafe</span><span class="op" id="2021217">.</span><span class="ident" id="2021218">Pointer</span><span class="op" id="2021225">(</span><span class="op" id="2021226">&amp;</span><span class="ident" id="2021227">sel</span><span class="op" id="2021230">)</span><span class="op" id="2021231">)</span><span class="op" id="2021232">,</span>&nbsp;<span class="ident" id="2021234">elem</span><span class="op" id="2021238">,</span>&nbsp;<span class="ident" id="2021240">received</span><span class="op" id="2021248">,</span>&nbsp;<span class="builtintype" id="2021250">uintptr</span><span class="op" id="2021257">(</span><span class="ident" id="2021258">unsafe</span><span class="op" id="2021264">.</span><span class="ident" id="2021265">Pointer</span><span class="op" id="2021272">(</span><span class="op" id="2021273">&amp;</span><span class="ident" id="2021274">selected</span><span class="op" id="2021282">)</span><span class="op" id="2021283">)</span><span class="op" id="2021284">-</span><span class="builtintype" id="2021285">uintptr</span><span class="op" id="2021292">(</span><span class="ident" id="2021293">unsafe</span><span class="op" id="2021299">.</span><span class="ident" id="2021300">Pointer</span><span class="op" id="2021307">(</span><span class="op" id="2021308">&amp;</span><span class="ident" id="2021309">sel</span><span class="op" id="2021312">)</span><span class="op" id="2021313">)</span><span class="op" id="2021314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2021317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2021320">return</span><br>
<span class="lineno"></span><span class="op" id="2021327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="2021330">func</span>&nbsp;<span class="ident" id="2021335">selectrecvImpl</span><span class="op" id="2021349">(</span><span class="ident" id="2021350">sel</span>&nbsp;<span class="op" id="2021354">*</span><span class="ident" id="2021355">_select</span><span class="op" id="2021362">,</span>&nbsp;<span class="ident" id="2021364">c</span>&nbsp;<span class="op" id="2021366">*</span><span class="ident" id="2021367">hchan</span><span class="op" id="2021372">,</span>&nbsp;<span class="ident" id="2021374">pc</span>&nbsp;<span class="builtintype" id="2021377">uintptr</span><span class="op" id="2021384">,</span>&nbsp;<span class="ident" id="2021386">elem</span>&nbsp;<span class="ident" id="2021391">unsafe</span><span class="op" id="2021397">.</span><span class="ident" id="2021398">Pointer</span><span class="op" id="2021405">,</span>&nbsp;<span class="ident" id="2021407">received</span>&nbsp;<span class="op" id="2021416">*</span><span class="builtintype" id="2021417">bool</span><span class="op" id="2021421">,</span>&nbsp;<span class="ident" id="2021423">so</span>&nbsp;<span class="builtintype" id="2021426">uintptr</span><span class="op" id="2021433">)</span>&nbsp;<span class="op" id="2021435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2021438">i</span>&nbsp;<span class="op" id="2021440">:=</span>&nbsp;<span class="ident" id="2021443">sel</span><span class="op" id="2021446">.</span><span class="ident" id="2021447">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2021454">if</span>&nbsp;<span class="ident" id="2021457">i</span>&nbsp;<span class="op" id="2021459">&gt;=</span>&nbsp;<span class="ident" id="2021462">sel</span><span class="op" id="2021465">.</span><span class="ident" id="2021466">tcase</span>&nbsp;<span class="op" id="2021472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2021476">gothrow</span><span class="op" id="2021483">(</span><span class="string" id="2021484">&#34;selectrecv:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="2021512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2021515">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2021518">sel</span><span class="op" id="2021521">.</span><span class="ident" id="2021522">ncase</span>&nbsp;<span class="op" id="2021528">=</span>&nbsp;<span class="ident" id="2021530">i</span>&nbsp;<span class="op" id="2021532">+</span>&nbsp;<span class="num" id="2021534">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2021537">cas</span>&nbsp;<span class="op" id="2021541">:=</span>&nbsp;<span class="op" id="2021544">(</span><span class="op" id="2021545">*</span><span class="ident" id="2021546">scase</span><span class="op" id="2021551">)</span><span class="op" id="2021552">(</span><span class="ident" id="2021553">add</span><span class="op" id="2021556">(</span><span class="ident" id="2021557">unsafe</span><span class="op" id="2021563">.</span><span class="ident" id="2021564">Pointer</span><span class="op" id="2021571">(</span><span class="op" id="2021572">&amp;</span><span class="ident" id="2021573">sel</span><span class="op" id="2021576">.</span><span class="ident" id="2021577">scase</span><span class="op" id="2021582">)</span><span class="op" id="2021583">,</span>&nbsp;<span class="builtintype" id="2021585">uintptr</span><span class="op" id="2021592">(</span><span class="ident" id="2021593">i</span><span class="op" id="2021594">)</span><span class="op" id="2021595">*</span><span class="ident" id="2021596">unsafe</span><span class="op" id="2021602">.</span><span class="ident" id="2021603">Sizeof</span><span class="op" id="2021609">(</span><span class="ident" id="2021610">sel</span><span class="op" id="2021613">.</span><span class="ident" id="2021614">scase</span><span class="op" id="2021619">[</span><span class="num" id="2021620">0</span><span class="op" id="2021621">]</span><span class="op" id="2021622">)</span><span class="op" id="2021623">)</span><span class="op" id="2021624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2021627">cas</span><span class="op" id="2021630">.</span><span class="ident" id="2021631">pc</span>&nbsp;<span class="op" id="2021634">=</span>&nbsp;<span class="ident" id="2021636">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2021640">cas</span><span class="op" id="2021643">.</span><span class="ident" id="2021644">_chan</span>&nbsp;<span class="op" id="2021650">=</span>&nbsp;<span class="ident" id="2021652">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2021655">cas</span><span class="op" id="2021658">.</span><span class="ident" id="2021659">so</span>&nbsp;<span class="op" id="2021662">=</span>&nbsp;<span class="builtintype" id="2021664">uint16</span><span class="op" id="2021670">(</span><span class="ident" id="2021671">so</span><span class="op" id="2021673">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2021676">cas</span><span class="op" id="2021679">.</span><span class="ident" id="2021680">kind</span>&nbsp;<span class="op" id="2021685">=</span>&nbsp;<span class="ident" id="2021687">_CaseRecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2021698">cas</span><span class="op" id="2021701">.</span><span class="ident" id="2021702">elem</span>&nbsp;<span class="op" id="2021707">=</span>&nbsp;<span class="ident" id="2021709">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2021715">cas</span><span class="op" id="2021718">.</span><span class="ident" id="2021719">receivedp</span>&nbsp;<span class="op" id="2021729">=</span>&nbsp;<span class="ident" id="2021731">received</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2021742">if</span>&nbsp;<span class="ident" id="2021745">debugSelect</span>&nbsp;<span class="op" id="2021757">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2021761">print</span><span class="op" id="2021766">(</span><span class="string" id="2021767">&#34;selectrecv&nbsp;s=&#34;</span><span class="op" id="2021782">,</span>&nbsp;<span class="ident" id="2021784">sel</span><span class="op" id="2021787">,</span>&nbsp;<span class="string" id="2021789">&#34;&nbsp;pc=&#34;</span><span class="op" id="2021795">,</span>&nbsp;<span class="ident" id="2021797">hex</span><span class="op" id="2021800">(</span><span class="ident" id="2021801">cas</span><span class="op" id="2021804">.</span><span class="ident" id="2021805">pc</span><span class="op" id="2021807">)</span><span class="op" id="2021808">,</span>&nbsp;<span class="string" id="2021810">&#34;&nbsp;chan=&#34;</span><span class="op" id="2021818">,</span>&nbsp;<span class="ident" id="2021820">cas</span><span class="op" id="2021823">.</span><span class="ident" id="2021824">_chan</span><span class="op" id="2021829">,</span>&nbsp;<span class="string" id="2021831">&#34;&nbsp;so=&#34;</span><span class="op" id="2021837">,</span>&nbsp;<span class="ident" id="2021839">cas</span><span class="op" id="2021842">.</span><span class="ident" id="2021843">so</span><span class="op" id="2021845">,</span>&nbsp;<span class="string" id="2021847">&#34;\n&#34;</span><span class="op" id="2021851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2021854">}</span><br>
<span class="lineno"></span><span class="op" id="2021856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2021859">//go:nosplit</span><br>
<span class="lineno">110</span><span class="keyword" id="2021872">func</span>&nbsp;<span class="ident" id="2021877">selectdefault</span><span class="op" id="2021890">(</span><span class="ident" id="2021891">sel</span>&nbsp;<span class="op" id="2021895">*</span><span class="ident" id="2021896">_select</span><span class="op" id="2021903">)</span>&nbsp;<span class="op" id="2021905">(</span><span class="ident" id="2021906">selected</span>&nbsp;<span class="builtintype" id="2021915">bool</span><span class="op" id="2021919">)</span>&nbsp;<span class="op" id="2021921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2021924">selectdefaultImpl</span><span class="op" id="2021941">(</span><span class="ident" id="2021942">sel</span><span class="op" id="2021945">,</span>&nbsp;<span class="ident" id="2021947">getcallerpc</span><span class="op" id="2021958">(</span><span class="ident" id="2021959">unsafe</span><span class="op" id="2021965">.</span><span class="ident" id="2021966">Pointer</span><span class="op" id="2021973">(</span><span class="op" id="2021974">&amp;</span><span class="ident" id="2021975">sel</span><span class="op" id="2021978">)</span><span class="op" id="2021979">)</span><span class="op" id="2021980">,</span>&nbsp;<span class="builtintype" id="2021982">uintptr</span><span class="op" id="2021989">(</span><span class="ident" id="2021990">unsafe</span><span class="op" id="2021996">.</span><span class="ident" id="2021997">Pointer</span><span class="op" id="2022004">(</span><span class="op" id="2022005">&amp;</span><span class="ident" id="2022006">selected</span><span class="op" id="2022014">)</span><span class="op" id="2022015">)</span><span class="op" id="2022016">-</span><span class="builtintype" id="2022017">uintptr</span><span class="op" id="2022024">(</span><span class="ident" id="2022025">unsafe</span><span class="op" id="2022031">.</span><span class="ident" id="2022032">Pointer</span><span class="op" id="2022039">(</span><span class="op" id="2022040">&amp;</span><span class="ident" id="2022041">sel</span><span class="op" id="2022044">)</span><span class="op" id="2022045">)</span><span class="op" id="2022046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2022049">return</span><br>
<span class="lineno"></span><span class="op" id="2022056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="2022059">func</span>&nbsp;<span class="ident" id="2022064">selectdefaultImpl</span><span class="op" id="2022081">(</span><span class="ident" id="2022082">sel</span>&nbsp;<span class="op" id="2022086">*</span><span class="ident" id="2022087">_select</span><span class="op" id="2022094">,</span>&nbsp;<span class="ident" id="2022096">callerpc</span>&nbsp;<span class="builtintype" id="2022105">uintptr</span><span class="op" id="2022112">,</span>&nbsp;<span class="ident" id="2022114">so</span>&nbsp;<span class="builtintype" id="2022117">uintptr</span><span class="op" id="2022124">)</span>&nbsp;<span class="op" id="2022126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2022129">i</span>&nbsp;<span class="op" id="2022131">:=</span>&nbsp;<span class="ident" id="2022134">sel</span><span class="op" id="2022137">.</span><span class="ident" id="2022138">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2022145">if</span>&nbsp;<span class="ident" id="2022148">i</span>&nbsp;<span class="op" id="2022150">&gt;=</span>&nbsp;<span class="ident" id="2022153">sel</span><span class="op" id="2022156">.</span><span class="ident" id="2022157">tcase</span>&nbsp;<span class="op" id="2022163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2022167">gothrow</span><span class="op" id="2022174">(</span><span class="string" id="2022175">&#34;selectdefault:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="2022206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2022209">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2022212">sel</span><span class="op" id="2022215">.</span><span class="ident" id="2022216">ncase</span>&nbsp;<span class="op" id="2022222">=</span>&nbsp;<span class="ident" id="2022224">i</span>&nbsp;<span class="op" id="2022226">+</span>&nbsp;<span class="num" id="2022228">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2022231">cas</span>&nbsp;<span class="op" id="2022235">:=</span>&nbsp;<span class="op" id="2022238">(</span><span class="op" id="2022239">*</span><span class="ident" id="2022240">scase</span><span class="op" id="2022245">)</span><span class="op" id="2022246">(</span><span class="ident" id="2022247">add</span><span class="op" id="2022250">(</span><span class="ident" id="2022251">unsafe</span><span class="op" id="2022257">.</span><span class="ident" id="2022258">Pointer</span><span class="op" id="2022265">(</span><span class="op" id="2022266">&amp;</span><span class="ident" id="2022267">sel</span><span class="op" id="2022270">.</span><span class="ident" id="2022271">scase</span><span class="op" id="2022276">)</span><span class="op" id="2022277">,</span>&nbsp;<span class="builtintype" id="2022279">uintptr</span><span class="op" id="2022286">(</span><span class="ident" id="2022287">i</span><span class="op" id="2022288">)</span><span class="op" id="2022289">*</span><span class="ident" id="2022290">unsafe</span><span class="op" id="2022296">.</span><span class="ident" id="2022297">Sizeof</span><span class="op" id="2022303">(</span><span class="ident" id="2022304">sel</span><span class="op" id="2022307">.</span><span class="ident" id="2022308">scase</span><span class="op" id="2022313">[</span><span class="num" id="2022314">0</span><span class="op" id="2022315">]</span><span class="op" id="2022316">)</span><span class="op" id="2022317">)</span><span class="op" id="2022318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2022321">cas</span><span class="op" id="2022324">.</span><span class="ident" id="2022325">pc</span>&nbsp;<span class="op" id="2022328">=</span>&nbsp;<span class="ident" id="2022330">callerpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2022340">cas</span><span class="op" id="2022343">.</span><span class="ident" id="2022344">_chan</span>&nbsp;<span class="op" id="2022350">=</span>&nbsp;<span class="ident" id="2022352">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2022357">cas</span><span class="op" id="2022360">.</span><span class="ident" id="2022361">so</span>&nbsp;<span class="op" id="2022364">=</span>&nbsp;<span class="builtintype" id="2022366">uint16</span><span class="op" id="2022372">(</span><span class="ident" id="2022373">so</span><span class="op" id="2022375">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2022378">cas</span><span class="op" id="2022381">.</span><span class="ident" id="2022382">kind</span>&nbsp;<span class="op" id="2022387">=</span>&nbsp;<span class="ident" id="2022389">_CaseDefault</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2022404">if</span>&nbsp;<span class="ident" id="2022407">debugSelect</span>&nbsp;<span class="op" id="2022419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2022423">print</span><span class="op" id="2022428">(</span><span class="string" id="2022429">&#34;selectdefault&nbsp;s=&#34;</span><span class="op" id="2022447">,</span>&nbsp;<span class="ident" id="2022449">sel</span><span class="op" id="2022452">,</span>&nbsp;<span class="string" id="2022454">&#34;&nbsp;pc=&#34;</span><span class="op" id="2022460">,</span>&nbsp;<span class="ident" id="2022462">hex</span><span class="op" id="2022465">(</span><span class="ident" id="2022466">cas</span><span class="op" id="2022469">.</span><span class="ident" id="2022470">pc</span><span class="op" id="2022472">)</span><span class="op" id="2022473">,</span>&nbsp;<span class="string" id="2022475">&#34;&nbsp;so=&#34;</span><span class="op" id="2022481">,</span>&nbsp;<span class="ident" id="2022483">cas</span><span class="op" id="2022486">.</span><span class="ident" id="2022487">so</span><span class="op" id="2022489">,</span>&nbsp;<span class="string" id="2022491">&#34;\n&#34;</span><span class="op" id="2022495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2022498">}</span><br>
<span class="lineno">130</span><span class="op" id="2022500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2022503">func</span>&nbsp;<span class="ident" id="2022508">sellock</span><span class="op" id="2022515">(</span><span class="ident" id="2022516">sel</span>&nbsp;<span class="op" id="2022520">*</span><span class="ident" id="2022521">_select</span><span class="op" id="2022528">)</span>&nbsp;<span class="op" id="2022530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2022533">lockslice</span>&nbsp;<span class="op" id="2022543">:=</span>&nbsp;<span class="ident" id="2022546">sliceStruct</span><span class="op" id="2022557">{</span><span class="ident" id="2022558">unsafe</span><span class="op" id="2022564">.</span><span class="ident" id="2022565">Pointer</span><span class="op" id="2022572">(</span><span class="ident" id="2022573">sel</span><span class="op" id="2022576">.</span><span class="ident" id="2022577">lockorder</span><span class="op" id="2022586">)</span><span class="op" id="2022587">,</span>&nbsp;<span class="builtintype" id="2022589">int</span><span class="op" id="2022592">(</span><span class="ident" id="2022593">sel</span><span class="op" id="2022596">.</span><span class="ident" id="2022597">ncase</span><span class="op" id="2022602">)</span><span class="op" id="2022603">,</span>&nbsp;<span class="builtintype" id="2022605">int</span><span class="op" id="2022608">(</span><span class="ident" id="2022609">sel</span><span class="op" id="2022612">.</span><span class="ident" id="2022613">ncase</span><span class="op" id="2022618">)</span><span class="op" id="2022619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2022622">lockorder</span>&nbsp;<span class="op" id="2022632">:=</span>&nbsp;<span class="op" id="2022635">*</span><span class="op" id="2022636">(</span><span class="op" id="2022637">*</span><span class="op" id="2022638">[</span><span class="op" id="2022639">]</span><span class="op" id="2022640">*</span><span class="ident" id="2022641">hchan</span><span class="op" id="2022646">)</span><span class="op" id="2022647">(</span><span class="ident" id="2022648">unsafe</span><span class="op" id="2022654">.</span><span class="ident" id="2022655">Pointer</span><span class="op" id="2022662">(</span><span class="op" id="2022663">&amp;</span><span class="ident" id="2022664">lockslice</span><span class="op" id="2022673">)</span><span class="op" id="2022674">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2022677">var</span>&nbsp;<span class="ident" id="2022681">c</span>&nbsp;<span class="op" id="2022683">*</span><span class="ident" id="2022684">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2022691">for</span>&nbsp;<span class="ident" id="2022695">_</span><span class="op" id="2022696">,</span>&nbsp;<span class="ident" id="2022698">c0</span>&nbsp;<span class="op" id="2022701">:=</span>&nbsp;<span class="keyword" id="2022704">range</span>&nbsp;<span class="ident" id="2022710">lockorder</span>&nbsp;<span class="op" id="2022720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2022724">if</span>&nbsp;<span class="ident" id="2022727">c0</span>&nbsp;<span class="op" id="2022730">!=</span>&nbsp;<span class="ident" id="2022733">nil</span>&nbsp;<span class="op" id="2022737">&amp;&amp;</span>&nbsp;<span class="ident" id="2022740">c0</span>&nbsp;<span class="op" id="2022743">!=</span>&nbsp;<span class="ident" id="2022746">c</span>&nbsp;<span class="op" id="2022748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2022753">c</span>&nbsp;<span class="op" id="2022755">=</span>&nbsp;<span class="ident" id="2022757">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2022763">lock</span><span class="op" id="2022767">(</span><span class="op" id="2022768">&amp;</span><span class="ident" id="2022769">c</span><span class="op" id="2022770">.</span><span class="ident" id="2022771">lock</span><span class="op" id="2022775">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2022779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2022782">}</span><br>
<span class="lineno"></span><span class="op" id="2022784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2022787">func</span>&nbsp;<span class="ident" id="2022792">selunlock</span><span class="op" id="2022801">(</span><span class="ident" id="2022802">sel</span>&nbsp;<span class="op" id="2022806">*</span><span class="ident" id="2022807">_select</span><span class="op" id="2022814">)</span>&nbsp;<span class="op" id="2022816">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2022819">//&nbsp;We&nbsp;must&nbsp;be&nbsp;very&nbsp;careful&nbsp;here&nbsp;to&nbsp;not&nbsp;touch&nbsp;sel&nbsp;after&nbsp;we&nbsp;have&nbsp;unlocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2022892">//&nbsp;the&nbsp;last&nbsp;lock,&nbsp;because&nbsp;sel&nbsp;can&nbsp;be&nbsp;freed&nbsp;right&nbsp;after&nbsp;the&nbsp;last&nbsp;unlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2022965">//&nbsp;Consider&nbsp;the&nbsp;following&nbsp;situation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2023003">//&nbsp;First&nbsp;M&nbsp;calls&nbsp;runtime·park()&nbsp;in&nbsp;runtime·selectgo()&nbsp;passing&nbsp;the&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2023077">//&nbsp;Once&nbsp;runtime·park()&nbsp;has&nbsp;unlocked&nbsp;the&nbsp;last&nbsp;lock,&nbsp;another&nbsp;M&nbsp;makes</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2023146">//&nbsp;the&nbsp;G&nbsp;that&nbsp;calls&nbsp;select&nbsp;runnable&nbsp;again&nbsp;and&nbsp;schedules&nbsp;it&nbsp;for&nbsp;execution.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2023221">//&nbsp;When&nbsp;the&nbsp;G&nbsp;runs&nbsp;on&nbsp;another&nbsp;M,&nbsp;it&nbsp;locks&nbsp;all&nbsp;the&nbsp;locks&nbsp;and&nbsp;frees&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2023293">//&nbsp;Now&nbsp;if&nbsp;the&nbsp;first&nbsp;M&nbsp;touches&nbsp;sel,&nbsp;it&nbsp;will&nbsp;access&nbsp;freed&nbsp;memory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2023358">n</span>&nbsp;<span class="op" id="2023360">:=</span>&nbsp;<span class="builtintype" id="2023363">int</span><span class="op" id="2023366">(</span><span class="ident" id="2023367">sel</span><span class="op" id="2023370">.</span><span class="ident" id="2023371">ncase</span><span class="op" id="2023376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2023379">r</span>&nbsp;<span class="op" id="2023381">:=</span>&nbsp;<span class="num" id="2023384">0</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2023387">lockslice</span>&nbsp;<span class="op" id="2023397">:=</span>&nbsp;<span class="ident" id="2023400">sliceStruct</span><span class="op" id="2023411">{</span><span class="ident" id="2023412">unsafe</span><span class="op" id="2023418">.</span><span class="ident" id="2023419">Pointer</span><span class="op" id="2023426">(</span><span class="ident" id="2023427">sel</span><span class="op" id="2023430">.</span><span class="ident" id="2023431">lockorder</span><span class="op" id="2023440">)</span><span class="op" id="2023441">,</span>&nbsp;<span class="ident" id="2023443">n</span><span class="op" id="2023444">,</span>&nbsp;<span class="ident" id="2023446">n</span><span class="op" id="2023447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2023450">lockorder</span>&nbsp;<span class="op" id="2023460">:=</span>&nbsp;<span class="op" id="2023463">*</span><span class="op" id="2023464">(</span><span class="op" id="2023465">*</span><span class="op" id="2023466">[</span><span class="op" id="2023467">]</span><span class="op" id="2023468">*</span><span class="ident" id="2023469">hchan</span><span class="op" id="2023474">)</span><span class="op" id="2023475">(</span><span class="ident" id="2023476">unsafe</span><span class="op" id="2023482">.</span><span class="ident" id="2023483">Pointer</span><span class="op" id="2023490">(</span><span class="op" id="2023491">&amp;</span><span class="ident" id="2023492">lockslice</span><span class="op" id="2023501">)</span><span class="op" id="2023502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2023505">//&nbsp;skip&nbsp;the&nbsp;default&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2023531">if</span>&nbsp;<span class="ident" id="2023534">n</span>&nbsp;<span class="op" id="2023536">&gt;</span>&nbsp;<span class="num" id="2023538">0</span>&nbsp;<span class="op" id="2023540">&amp;&amp;</span>&nbsp;<span class="ident" id="2023543">lockorder</span><span class="op" id="2023552">[</span><span class="num" id="2023553">0</span><span class="op" id="2023554">]</span>&nbsp;<span class="op" id="2023556">==</span>&nbsp;<span class="ident" id="2023559">nil</span>&nbsp;<span class="op" id="2023563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2023567">r</span>&nbsp;<span class="op" id="2023569">=</span>&nbsp;<span class="num" id="2023571">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2023574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2023577">for</span>&nbsp;<span class="ident" id="2023581">i</span>&nbsp;<span class="op" id="2023583">:=</span>&nbsp;<span class="ident" id="2023586">n</span>&nbsp;<span class="op" id="2023588">-</span>&nbsp;<span class="num" id="2023590">1</span><span class="op" id="2023591">;</span>&nbsp;<span class="ident" id="2023593">i</span>&nbsp;<span class="op" id="2023595">&gt;=</span>&nbsp;<span class="ident" id="2023598">r</span><span class="op" id="2023599">;</span>&nbsp;<span class="ident" id="2023601">i</span><span class="op" id="2023602">--</span>&nbsp;<span class="op" id="2023605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2023609">c</span>&nbsp;<span class="op" id="2023611">:=</span>&nbsp;<span class="ident" id="2023614">lockorder</span><span class="op" id="2023623">[</span><span class="ident" id="2023624">i</span><span class="op" id="2023625">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2023629">if</span>&nbsp;<span class="ident" id="2023632">i</span>&nbsp;<span class="op" id="2023634">&gt;</span>&nbsp;<span class="num" id="2023636">0</span>&nbsp;<span class="op" id="2023638">&amp;&amp;</span>&nbsp;<span class="ident" id="2023641">c</span>&nbsp;<span class="op" id="2023643">==</span>&nbsp;<span class="ident" id="2023646">lockorder</span><span class="op" id="2023655">[</span><span class="ident" id="2023656">i</span><span class="op" id="2023657">-</span><span class="num" id="2023658">1</span><span class="op" id="2023659">]</span>&nbsp;<span class="op" id="2023661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2023666">continue</span>&nbsp;<span class="comment" id="2023675">//&nbsp;will&nbsp;unlock&nbsp;it&nbsp;on&nbsp;the&nbsp;next&nbsp;iteration</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2023717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2023721">unlock</span><span class="op" id="2023727">(</span><span class="op" id="2023728">&amp;</span><span class="ident" id="2023729">c</span><span class="op" id="2023730">.</span><span class="ident" id="2023731">lock</span><span class="op" id="2023735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2023738">}</span><br>
<span class="lineno"></span><span class="op" id="2023740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="keyword" id="2023743">func</span>&nbsp;<span class="ident" id="2023748">selparkcommit</span><span class="op" id="2023761">(</span><span class="ident" id="2023762">gp</span>&nbsp;<span class="op" id="2023765">*</span><span class="ident" id="2023766">g</span><span class="op" id="2023767">,</span>&nbsp;<span class="ident" id="2023769">sel</span>&nbsp;<span class="op" id="2023773">*</span><span class="ident" id="2023774">_select</span><span class="op" id="2023781">)</span>&nbsp;<span class="builtintype" id="2023783">bool</span>&nbsp;<span class="op" id="2023788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2023791">selunlock</span><span class="op" id="2023800">(</span><span class="ident" id="2023801">sel</span><span class="op" id="2023804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2023807">return</span>&nbsp;<span class="builtintype" id="2023814">true</span><br>
<span class="lineno"></span><span class="op" id="2023819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="2023822">func</span>&nbsp;<span class="ident" id="2023827">block</span><span class="op" id="2023832">(</span><span class="op" id="2023833">)</span>&nbsp;<span class="op" id="2023835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2023838">gopark</span><span class="op" id="2023844">(</span><span class="ident" id="2023845">nil</span><span class="op" id="2023848">,</span>&nbsp;<span class="ident" id="2023850">nil</span><span class="op" id="2023853">,</span>&nbsp;<span class="string" id="2023855">&#34;select&nbsp;(no&nbsp;cases)&#34;</span><span class="op" id="2023874">)</span>&nbsp;<span class="comment" id="2023876">//&nbsp;forever</span><br>
<span class="lineno"></span><span class="op" id="2023887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2023890">//&nbsp;overwrites&nbsp;return&nbsp;pc&nbsp;on&nbsp;stack&nbsp;to&nbsp;signal&nbsp;which&nbsp;case&nbsp;of&nbsp;the&nbsp;select</span><br>
<span class="lineno">180</span><span class="comment" id="2023958">//&nbsp;to&nbsp;run,&nbsp;so&nbsp;cannot&nbsp;appear&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="2024015">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="2024028">func</span>&nbsp;<span class="ident" id="2024033">selectgo</span><span class="op" id="2024041">(</span><span class="ident" id="2024042">sel</span>&nbsp;<span class="op" id="2024046">*</span><span class="ident" id="2024047">_select</span><span class="op" id="2024054">)</span>&nbsp;<span class="op" id="2024056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2024059">pc</span><span class="op" id="2024061">,</span>&nbsp;<span class="ident" id="2024063">offset</span>&nbsp;<span class="op" id="2024070">:=</span>&nbsp;<span class="ident" id="2024073">selectgoImpl</span><span class="op" id="2024085">(</span><span class="ident" id="2024086">sel</span><span class="op" id="2024089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2024092">*</span><span class="op" id="2024093">(</span><span class="op" id="2024094">*</span><span class="builtintype" id="2024095">bool</span><span class="op" id="2024099">)</span><span class="op" id="2024100">(</span><span class="ident" id="2024101">add</span><span class="op" id="2024104">(</span><span class="ident" id="2024105">unsafe</span><span class="op" id="2024111">.</span><span class="ident" id="2024112">Pointer</span><span class="op" id="2024119">(</span><span class="op" id="2024120">&amp;</span><span class="ident" id="2024121">sel</span><span class="op" id="2024124">)</span><span class="op" id="2024125">,</span>&nbsp;<span class="builtintype" id="2024127">uintptr</span><span class="op" id="2024134">(</span><span class="ident" id="2024135">offset</span><span class="op" id="2024141">)</span><span class="op" id="2024142">)</span><span class="op" id="2024143">)</span>&nbsp;<span class="op" id="2024145">=</span>&nbsp;<span class="builtintype" id="2024147">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2024153">setcallerpc</span><span class="op" id="2024164">(</span><span class="ident" id="2024165">unsafe</span><span class="op" id="2024171">.</span><span class="ident" id="2024172">Pointer</span><span class="op" id="2024179">(</span><span class="op" id="2024180">&amp;</span><span class="ident" id="2024181">sel</span><span class="op" id="2024184">)</span><span class="op" id="2024185">,</span>&nbsp;<span class="ident" id="2024187">pc</span><span class="op" id="2024189">)</span><br>
<span class="lineno"></span><span class="op" id="2024191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2024194">//&nbsp;selectgoImpl&nbsp;returns&nbsp;scase.pc&nbsp;and&nbsp;scase.so&nbsp;for&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span><span class="comment" id="2024255">//&nbsp;case&nbsp;which&nbsp;fired.</span><br>
<span class="lineno">190</span><span class="keyword" id="2024276">func</span>&nbsp;<span class="ident" id="2024281">selectgoImpl</span><span class="op" id="2024293">(</span><span class="ident" id="2024294">sel</span>&nbsp;<span class="op" id="2024298">*</span><span class="ident" id="2024299">_select</span><span class="op" id="2024306">)</span>&nbsp;<span class="op" id="2024308">(</span><span class="builtintype" id="2024309">uintptr</span><span class="op" id="2024316">,</span>&nbsp;<span class="builtintype" id="2024318">uint16</span><span class="op" id="2024324">)</span>&nbsp;<span class="op" id="2024326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2024329">if</span>&nbsp;<span class="ident" id="2024332">debugSelect</span>&nbsp;<span class="op" id="2024344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2024348">print</span><span class="op" id="2024353">(</span><span class="string" id="2024354">&#34;select:&nbsp;sel=&#34;</span><span class="op" id="2024368">,</span>&nbsp;<span class="ident" id="2024370">sel</span><span class="op" id="2024373">,</span>&nbsp;<span class="string" id="2024375">&#34;\n&#34;</span><span class="op" id="2024379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2024382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2024386">scaseslice</span>&nbsp;<span class="op" id="2024397">:=</span>&nbsp;<span class="ident" id="2024400">sliceStruct</span><span class="op" id="2024411">{</span><span class="ident" id="2024412">unsafe</span><span class="op" id="2024418">.</span><span class="ident" id="2024419">Pointer</span><span class="op" id="2024426">(</span><span class="op" id="2024427">&amp;</span><span class="ident" id="2024428">sel</span><span class="op" id="2024431">.</span><span class="ident" id="2024432">scase</span><span class="op" id="2024437">)</span><span class="op" id="2024438">,</span>&nbsp;<span class="builtintype" id="2024440">int</span><span class="op" id="2024443">(</span><span class="ident" id="2024444">sel</span><span class="op" id="2024447">.</span><span class="ident" id="2024448">ncase</span><span class="op" id="2024453">)</span><span class="op" id="2024454">,</span>&nbsp;<span class="builtintype" id="2024456">int</span><span class="op" id="2024459">(</span><span class="ident" id="2024460">sel</span><span class="op" id="2024463">.</span><span class="ident" id="2024464">ncase</span><span class="op" id="2024469">)</span><span class="op" id="2024470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2024473">scases</span>&nbsp;<span class="op" id="2024480">:=</span>&nbsp;<span class="op" id="2024483">*</span><span class="op" id="2024484">(</span><span class="op" id="2024485">*</span><span class="op" id="2024486">[</span><span class="op" id="2024487">]</span><span class="ident" id="2024488">scase</span><span class="op" id="2024493">)</span><span class="op" id="2024494">(</span><span class="ident" id="2024495">unsafe</span><span class="op" id="2024501">.</span><span class="ident" id="2024502">Pointer</span><span class="op" id="2024509">(</span><span class="op" id="2024510">&amp;</span><span class="ident" id="2024511">scaseslice</span><span class="op" id="2024521">)</span><span class="op" id="2024522">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2024526">var</span>&nbsp;<span class="ident" id="2024530">t0</span>&nbsp;<span class="ident" id="2024533">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2024540">if</span>&nbsp;<span class="ident" id="2024543">blockprofilerate</span>&nbsp;<span class="op" id="2024560">&gt;</span>&nbsp;<span class="num" id="2024562">0</span>&nbsp;<span class="op" id="2024564">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2024568">t0</span>&nbsp;<span class="op" id="2024571">=</span>&nbsp;<span class="ident" id="2024573">cputicks</span><span class="op" id="2024581">(</span><span class="op" id="2024582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2024586">for</span>&nbsp;<span class="ident" id="2024590">i</span>&nbsp;<span class="op" id="2024592">:=</span>&nbsp;<span class="num" id="2024595">0</span><span class="op" id="2024596">;</span>&nbsp;<span class="ident" id="2024598">i</span>&nbsp;<span class="op" id="2024600">&lt;</span>&nbsp;<span class="builtintype" id="2024602">int</span><span class="op" id="2024605">(</span><span class="ident" id="2024606">sel</span><span class="op" id="2024609">.</span><span class="ident" id="2024610">ncase</span><span class="op" id="2024615">)</span><span class="op" id="2024616">;</span>&nbsp;<span class="ident" id="2024618">i</span><span class="op" id="2024619">++</span>&nbsp;<span class="op" id="2024622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2024627">scases</span><span class="op" id="2024633">[</span><span class="ident" id="2024634">i</span><span class="op" id="2024635">]</span><span class="op" id="2024636">.</span><span class="ident" id="2024637">releasetime</span>&nbsp;<span class="op" id="2024649">=</span>&nbsp;<span class="op" id="2024651">-</span><span class="num" id="2024652">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2024656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2024659">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2024663">//&nbsp;The&nbsp;compiler&nbsp;rewrites&nbsp;selects&nbsp;that&nbsp;statically&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2024718">//&nbsp;only&nbsp;0&nbsp;or&nbsp;1&nbsp;cases&nbsp;plus&nbsp;default&nbsp;into&nbsp;simpler&nbsp;constructs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2024778">//&nbsp;The&nbsp;only&nbsp;way&nbsp;we&nbsp;can&nbsp;end&nbsp;up&nbsp;with&nbsp;such&nbsp;small&nbsp;sel.ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2024835">//&nbsp;values&nbsp;here&nbsp;is&nbsp;for&nbsp;a&nbsp;larger&nbsp;select&nbsp;in&nbsp;which&nbsp;most&nbsp;channels</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2024897">//&nbsp;have&nbsp;been&nbsp;nilled&nbsp;out.&nbsp;&nbsp;The&nbsp;general&nbsp;code&nbsp;handles&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2024955">//&nbsp;cases&nbsp;correctly,&nbsp;and&nbsp;they&nbsp;are&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2025015">//&nbsp;optimizing&nbsp;(and&nbsp;needing&nbsp;to&nbsp;test).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2025054">//&nbsp;generate&nbsp;permuted&nbsp;order</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025082">pollslice</span>&nbsp;<span class="op" id="2025092">:=</span>&nbsp;<span class="ident" id="2025095">sliceStruct</span><span class="op" id="2025106">{</span><span class="ident" id="2025107">unsafe</span><span class="op" id="2025113">.</span><span class="ident" id="2025114">Pointer</span><span class="op" id="2025121">(</span><span class="ident" id="2025122">sel</span><span class="op" id="2025125">.</span><span class="ident" id="2025126">pollorder</span><span class="op" id="2025135">)</span><span class="op" id="2025136">,</span>&nbsp;<span class="builtintype" id="2025138">int</span><span class="op" id="2025141">(</span><span class="ident" id="2025142">sel</span><span class="op" id="2025145">.</span><span class="ident" id="2025146">ncase</span><span class="op" id="2025151">)</span><span class="op" id="2025152">,</span>&nbsp;<span class="builtintype" id="2025154">int</span><span class="op" id="2025157">(</span><span class="ident" id="2025158">sel</span><span class="op" id="2025161">.</span><span class="ident" id="2025162">ncase</span><span class="op" id="2025167">)</span><span class="op" id="2025168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025171">pollorder</span>&nbsp;<span class="op" id="2025181">:=</span>&nbsp;<span class="op" id="2025184">*</span><span class="op" id="2025185">(</span><span class="op" id="2025186">*</span><span class="op" id="2025187">[</span><span class="op" id="2025188">]</span><span class="builtintype" id="2025189">uint16</span><span class="op" id="2025195">)</span><span class="op" id="2025196">(</span><span class="ident" id="2025197">unsafe</span><span class="op" id="2025203">.</span><span class="ident" id="2025204">Pointer</span><span class="op" id="2025211">(</span><span class="op" id="2025212">&amp;</span><span class="ident" id="2025213">pollslice</span><span class="op" id="2025222">)</span><span class="op" id="2025223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2025226">for</span>&nbsp;<span class="ident" id="2025230">i</span>&nbsp;<span class="op" id="2025232">:=</span>&nbsp;<span class="num" id="2025235">0</span><span class="op" id="2025236">;</span>&nbsp;<span class="ident" id="2025238">i</span>&nbsp;<span class="op" id="2025240">&lt;</span>&nbsp;<span class="builtintype" id="2025242">int</span><span class="op" id="2025245">(</span><span class="ident" id="2025246">sel</span><span class="op" id="2025249">.</span><span class="ident" id="2025250">ncase</span><span class="op" id="2025255">)</span><span class="op" id="2025256">;</span>&nbsp;<span class="ident" id="2025258">i</span><span class="op" id="2025259">++</span>&nbsp;<span class="op" id="2025262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025266">pollorder</span><span class="op" id="2025275">[</span><span class="ident" id="2025276">i</span><span class="op" id="2025277">]</span>&nbsp;<span class="op" id="2025279">=</span>&nbsp;<span class="builtintype" id="2025281">uint16</span><span class="op" id="2025287">(</span><span class="ident" id="2025288">i</span><span class="op" id="2025289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2025292">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2025295">for</span>&nbsp;<span class="ident" id="2025299">i</span>&nbsp;<span class="op" id="2025301">:=</span>&nbsp;<span class="num" id="2025304">1</span><span class="op" id="2025305">;</span>&nbsp;<span class="ident" id="2025307">i</span>&nbsp;<span class="op" id="2025309">&lt;</span>&nbsp;<span class="builtintype" id="2025311">int</span><span class="op" id="2025314">(</span><span class="ident" id="2025315">sel</span><span class="op" id="2025318">.</span><span class="ident" id="2025319">ncase</span><span class="op" id="2025324">)</span><span class="op" id="2025325">;</span>&nbsp;<span class="ident" id="2025327">i</span><span class="op" id="2025328">++</span>&nbsp;<span class="op" id="2025331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025335">o</span>&nbsp;<span class="op" id="2025337">:=</span>&nbsp;<span class="ident" id="2025340">pollorder</span><span class="op" id="2025349">[</span><span class="ident" id="2025350">i</span><span class="op" id="2025351">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025355">j</span>&nbsp;<span class="op" id="2025357">:=</span>&nbsp;<span class="builtintype" id="2025360">int</span><span class="op" id="2025363">(</span><span class="ident" id="2025364">fastrand1</span><span class="op" id="2025373">(</span><span class="op" id="2025374">)</span><span class="op" id="2025375">)</span>&nbsp;<span class="op" id="2025377">%</span>&nbsp;<span class="op" id="2025379">(</span><span class="ident" id="2025380">i</span>&nbsp;<span class="op" id="2025382">+</span>&nbsp;<span class="num" id="2025384">1</span><span class="op" id="2025385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025389">pollorder</span><span class="op" id="2025398">[</span><span class="ident" id="2025399">i</span><span class="op" id="2025400">]</span>&nbsp;<span class="op" id="2025402">=</span>&nbsp;<span class="ident" id="2025404">pollorder</span><span class="op" id="2025413">[</span><span class="ident" id="2025414">j</span><span class="op" id="2025415">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025419">pollorder</span><span class="op" id="2025428">[</span><span class="ident" id="2025429">j</span><span class="op" id="2025430">]</span>&nbsp;<span class="op" id="2025432">=</span>&nbsp;<span class="ident" id="2025434">o</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2025437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2025441">//&nbsp;sort&nbsp;the&nbsp;cases&nbsp;by&nbsp;Hchan&nbsp;address&nbsp;to&nbsp;get&nbsp;the&nbsp;locking&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2025503">//&nbsp;simple&nbsp;heap&nbsp;sort,&nbsp;to&nbsp;guarantee&nbsp;n&nbsp;log&nbsp;n&nbsp;time&nbsp;and&nbsp;constant&nbsp;stack&nbsp;footprint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025581">lockslice</span>&nbsp;<span class="op" id="2025591">:=</span>&nbsp;<span class="ident" id="2025594">sliceStruct</span><span class="op" id="2025605">{</span><span class="ident" id="2025606">unsafe</span><span class="op" id="2025612">.</span><span class="ident" id="2025613">Pointer</span><span class="op" id="2025620">(</span><span class="ident" id="2025621">sel</span><span class="op" id="2025624">.</span><span class="ident" id="2025625">lockorder</span><span class="op" id="2025634">)</span><span class="op" id="2025635">,</span>&nbsp;<span class="builtintype" id="2025637">int</span><span class="op" id="2025640">(</span><span class="ident" id="2025641">sel</span><span class="op" id="2025644">.</span><span class="ident" id="2025645">ncase</span><span class="op" id="2025650">)</span><span class="op" id="2025651">,</span>&nbsp;<span class="builtintype" id="2025653">int</span><span class="op" id="2025656">(</span><span class="ident" id="2025657">sel</span><span class="op" id="2025660">.</span><span class="ident" id="2025661">ncase</span><span class="op" id="2025666">)</span><span class="op" id="2025667">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025670">lockorder</span>&nbsp;<span class="op" id="2025680">:=</span>&nbsp;<span class="op" id="2025683">*</span><span class="op" id="2025684">(</span><span class="op" id="2025685">*</span><span class="op" id="2025686">[</span><span class="op" id="2025687">]</span><span class="op" id="2025688">*</span><span class="ident" id="2025689">hchan</span><span class="op" id="2025694">)</span><span class="op" id="2025695">(</span><span class="ident" id="2025696">unsafe</span><span class="op" id="2025702">.</span><span class="ident" id="2025703">Pointer</span><span class="op" id="2025710">(</span><span class="op" id="2025711">&amp;</span><span class="ident" id="2025712">lockslice</span><span class="op" id="2025721">)</span><span class="op" id="2025722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2025725">for</span>&nbsp;<span class="ident" id="2025729">i</span>&nbsp;<span class="op" id="2025731">:=</span>&nbsp;<span class="num" id="2025734">0</span><span class="op" id="2025735">;</span>&nbsp;<span class="ident" id="2025737">i</span>&nbsp;<span class="op" id="2025739">&lt;</span>&nbsp;<span class="builtintype" id="2025741">int</span><span class="op" id="2025744">(</span><span class="ident" id="2025745">sel</span><span class="op" id="2025748">.</span><span class="ident" id="2025749">ncase</span><span class="op" id="2025754">)</span><span class="op" id="2025755">;</span>&nbsp;<span class="ident" id="2025757">i</span><span class="op" id="2025758">++</span>&nbsp;<span class="op" id="2025761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025765">j</span>&nbsp;<span class="op" id="2025767">:=</span>&nbsp;<span class="ident" id="2025770">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025774">c</span>&nbsp;<span class="op" id="2025776">:=</span>&nbsp;<span class="ident" id="2025779">scases</span><span class="op" id="2025785">[</span><span class="ident" id="2025786">j</span><span class="op" id="2025787">]</span><span class="op" id="2025788">.</span><span class="ident" id="2025789">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2025797">for</span>&nbsp;<span class="ident" id="2025801">j</span>&nbsp;<span class="op" id="2025803">&gt;</span>&nbsp;<span class="num" id="2025805">0</span>&nbsp;<span class="op" id="2025807">&amp;&amp;</span>&nbsp;<span class="ident" id="2025810">lockorder</span><span class="op" id="2025819">[</span><span class="op" id="2025820">(</span><span class="ident" id="2025821">j</span><span class="op" id="2025822">-</span><span class="num" id="2025823">1</span><span class="op" id="2025824">)</span><span class="op" id="2025825">/</span><span class="num" id="2025826">2</span><span class="op" id="2025827">]</span><span class="op" id="2025828">.</span><span class="ident" id="2025829">sortkey</span><span class="op" id="2025836">(</span><span class="op" id="2025837">)</span>&nbsp;<span class="op" id="2025839">&lt;</span>&nbsp;<span class="ident" id="2025841">c</span><span class="op" id="2025842">.</span><span class="ident" id="2025843">sortkey</span><span class="op" id="2025850">(</span><span class="op" id="2025851">)</span>&nbsp;<span class="op" id="2025853">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025858">k</span>&nbsp;<span class="op" id="2025860">:=</span>&nbsp;<span class="op" id="2025863">(</span><span class="ident" id="2025864">j</span>&nbsp;<span class="op" id="2025866">-</span>&nbsp;<span class="num" id="2025868">1</span><span class="op" id="2025869">)</span>&nbsp;<span class="op" id="2025871">/</span>&nbsp;<span class="num" id="2025873">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025878">lockorder</span><span class="op" id="2025887">[</span><span class="ident" id="2025888">j</span><span class="op" id="2025889">]</span>&nbsp;<span class="op" id="2025891">=</span>&nbsp;<span class="ident" id="2025893">lockorder</span><span class="op" id="2025902">[</span><span class="ident" id="2025903">k</span><span class="op" id="2025904">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025909">j</span>&nbsp;<span class="op" id="2025911">=</span>&nbsp;<span class="ident" id="2025913">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2025917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025921">lockorder</span><span class="op" id="2025930">[</span><span class="ident" id="2025931">j</span><span class="op" id="2025932">]</span>&nbsp;<span class="op" id="2025934">=</span>&nbsp;<span class="ident" id="2025936">c</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2025939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2025942">for</span>&nbsp;<span class="ident" id="2025946">i</span>&nbsp;<span class="op" id="2025948">:=</span>&nbsp;<span class="builtintype" id="2025951">int</span><span class="op" id="2025954">(</span><span class="ident" id="2025955">sel</span><span class="op" id="2025958">.</span><span class="ident" id="2025959">ncase</span><span class="op" id="2025964">)</span>&nbsp;<span class="op" id="2025966">-</span>&nbsp;<span class="num" id="2025968">1</span><span class="op" id="2025969">;</span>&nbsp;<span class="ident" id="2025971">i</span>&nbsp;<span class="op" id="2025973">&gt;=</span>&nbsp;<span class="num" id="2025976">0</span><span class="op" id="2025977">;</span>&nbsp;<span class="ident" id="2025979">i</span><span class="op" id="2025980">--</span>&nbsp;<span class="op" id="2025983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2025987">c</span>&nbsp;<span class="op" id="2025989">:=</span>&nbsp;<span class="ident" id="2025992">lockorder</span><span class="op" id="2026001">[</span><span class="ident" id="2026002">i</span><span class="op" id="2026003">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026007">lockorder</span><span class="op" id="2026016">[</span><span class="ident" id="2026017">i</span><span class="op" id="2026018">]</span>&nbsp;<span class="op" id="2026020">=</span>&nbsp;<span class="ident" id="2026022">lockorder</span><span class="op" id="2026031">[</span><span class="num" id="2026032">0</span><span class="op" id="2026033">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026037">j</span>&nbsp;<span class="op" id="2026039">:=</span>&nbsp;<span class="num" id="2026042">0</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026046">for</span>&nbsp;<span class="op" id="2026050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026055">k</span>&nbsp;<span class="op" id="2026057">:=</span>&nbsp;<span class="ident" id="2026060">j</span><span class="op" id="2026061">*</span><span class="num" id="2026062">2</span>&nbsp;<span class="op" id="2026064">+</span>&nbsp;<span class="num" id="2026066">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026071">if</span>&nbsp;<span class="ident" id="2026074">k</span>&nbsp;<span class="op" id="2026076">&gt;=</span>&nbsp;<span class="ident" id="2026079">i</span>&nbsp;<span class="op" id="2026081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026087">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2026096">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026101">if</span>&nbsp;<span class="ident" id="2026104">k</span><span class="op" id="2026105">+</span><span class="num" id="2026106">1</span>&nbsp;<span class="op" id="2026108">&lt;</span>&nbsp;<span class="ident" id="2026110">i</span>&nbsp;<span class="op" id="2026112">&amp;&amp;</span>&nbsp;<span class="ident" id="2026115">lockorder</span><span class="op" id="2026124">[</span><span class="ident" id="2026125">k</span><span class="op" id="2026126">]</span><span class="op" id="2026127">.</span><span class="ident" id="2026128">sortkey</span><span class="op" id="2026135">(</span><span class="op" id="2026136">)</span>&nbsp;<span class="op" id="2026138">&lt;</span>&nbsp;<span class="ident" id="2026140">lockorder</span><span class="op" id="2026149">[</span><span class="ident" id="2026150">k</span><span class="op" id="2026151">+</span><span class="num" id="2026152">1</span><span class="op" id="2026153">]</span><span class="op" id="2026154">.</span><span class="ident" id="2026155">sortkey</span><span class="op" id="2026162">(</span><span class="op" id="2026163">)</span>&nbsp;<span class="op" id="2026165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026171">k</span><span class="op" id="2026172">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2026178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026183">if</span>&nbsp;<span class="ident" id="2026186">c</span><span class="op" id="2026187">.</span><span class="ident" id="2026188">sortkey</span><span class="op" id="2026195">(</span><span class="op" id="2026196">)</span>&nbsp;<span class="op" id="2026198">&lt;</span>&nbsp;<span class="ident" id="2026200">lockorder</span><span class="op" id="2026209">[</span><span class="ident" id="2026210">k</span><span class="op" id="2026211">]</span><span class="op" id="2026212">.</span><span class="ident" id="2026213">sortkey</span><span class="op" id="2026220">(</span><span class="op" id="2026221">)</span>&nbsp;<span class="op" id="2026223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026229">lockorder</span><span class="op" id="2026238">[</span><span class="ident" id="2026239">j</span><span class="op" id="2026240">]</span>&nbsp;<span class="op" id="2026242">=</span>&nbsp;<span class="ident" id="2026244">lockorder</span><span class="op" id="2026253">[</span><span class="ident" id="2026254">k</span><span class="op" id="2026255">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026261">j</span>&nbsp;<span class="op" id="2026263">=</span>&nbsp;<span class="ident" id="2026265">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026271">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2026283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026288">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2026296">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026300">lockorder</span><span class="op" id="2026309">[</span><span class="ident" id="2026310">j</span><span class="op" id="2026311">]</span>&nbsp;<span class="op" id="2026313">=</span>&nbsp;<span class="ident" id="2026315">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2026318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2026321">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfor&nbsp;i&nbsp;:=&nbsp;0;&nbsp;i+1&nbsp;&lt;&nbsp;int(sel.ncase);&nbsp;i++&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;lockorder[i].sortkey()&nbsp;&gt;&nbsp;lockorder[i+1].sortkey()&nbsp;{<br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspprint(&#34;i=&#34;,&nbsp;i,&nbsp;&#34;&nbsp;x=&#34;,&nbsp;lockorder[i],&nbsp;&#34;&nbsp;y=&#34;,&nbsp;lockorder[i+1],&nbsp;&#34;\n&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspgothrow(&#34;select:&nbsp;broken&nbsp;sort&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*/</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2026543">//&nbsp;lock&nbsp;all&nbsp;the&nbsp;channels&nbsp;involved&nbsp;in&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026592">sellock</span><span class="op" id="2026599">(</span><span class="ident" id="2026600">sel</span><span class="op" id="2026603">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026607">var</span>&nbsp;<span class="op" id="2026611">(</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026615">gp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2026622">*</span><span class="ident" id="2026623">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026627">done</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2026634">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026643">sg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2026650">*</span><span class="ident" id="2026651">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026659">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2026666">*</span><span class="ident" id="2026667">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026675">k</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2026682">*</span><span class="ident" id="2026683">scase</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026691">sglist</span>&nbsp;<span class="op" id="2026698">*</span><span class="ident" id="2026699">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026707">sgnext</span>&nbsp;<span class="op" id="2026714">*</span><span class="ident" id="2026715">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2026722">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="2026725">loop</span><span class="op" id="2026729">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2026732">//&nbsp;pass&nbsp;1&nbsp;-&nbsp;look&nbsp;for&nbsp;something&nbsp;already&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026780">var</span>&nbsp;<span class="ident" id="2026784">dfl</span>&nbsp;<span class="op" id="2026788">*</span><span class="ident" id="2026789">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026796">var</span>&nbsp;<span class="ident" id="2026800">cas</span>&nbsp;<span class="op" id="2026804">*</span><span class="ident" id="2026805">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026812">for</span>&nbsp;<span class="ident" id="2026816">i</span>&nbsp;<span class="op" id="2026818">:=</span>&nbsp;<span class="num" id="2026821">0</span><span class="op" id="2026822">;</span>&nbsp;<span class="ident" id="2026824">i</span>&nbsp;<span class="op" id="2026826">&lt;</span>&nbsp;<span class="builtintype" id="2026828">int</span><span class="op" id="2026831">(</span><span class="ident" id="2026832">sel</span><span class="op" id="2026835">.</span><span class="ident" id="2026836">ncase</span><span class="op" id="2026841">)</span><span class="op" id="2026842">;</span>&nbsp;<span class="ident" id="2026844">i</span><span class="op" id="2026845">++</span>&nbsp;<span class="op" id="2026848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026852">cas</span>&nbsp;<span class="op" id="2026856">=</span>&nbsp;<span class="op" id="2026858">&amp;</span><span class="ident" id="2026859">scases</span><span class="op" id="2026865">[</span><span class="ident" id="2026866">pollorder</span><span class="op" id="2026875">[</span><span class="ident" id="2026876">i</span><span class="op" id="2026877">]</span><span class="op" id="2026878">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2026882">c</span>&nbsp;<span class="op" id="2026884">=</span>&nbsp;<span class="ident" id="2026886">cas</span><span class="op" id="2026889">.</span><span class="ident" id="2026890">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026899">switch</span>&nbsp;<span class="ident" id="2026906">cas</span><span class="op" id="2026909">.</span><span class="ident" id="2026910">kind</span>&nbsp;<span class="op" id="2026915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026919">case</span>&nbsp;<span class="ident" id="2026924">_CaseRecv</span><span class="op" id="2026933">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026938">if</span>&nbsp;<span class="ident" id="2026941">c</span><span class="op" id="2026942">.</span><span class="ident" id="2026943">dataqsiz</span>&nbsp;<span class="op" id="2026952">&gt;</span>&nbsp;<span class="num" id="2026954">0</span>&nbsp;<span class="op" id="2026956">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026962">if</span>&nbsp;<span class="ident" id="2026965">c</span><span class="op" id="2026966">.</span><span class="ident" id="2026967">qcount</span>&nbsp;<span class="op" id="2026974">&gt;</span>&nbsp;<span class="num" id="2026976">0</span>&nbsp;<span class="op" id="2026978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2026985">goto</span>&nbsp;<span class="ident" id="2026990">asyncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2027004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2027009">}</span>&nbsp;<span class="keyword" id="2027011">else</span>&nbsp;<span class="op" id="2027016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027022">sg</span>&nbsp;<span class="op" id="2027025">=</span>&nbsp;<span class="ident" id="2027027">c</span><span class="op" id="2027028">.</span><span class="ident" id="2027029">sendq</span><span class="op" id="2027034">.</span><span class="ident" id="2027035">dequeue</span><span class="op" id="2027042">(</span><span class="op" id="2027043">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027049">if</span>&nbsp;<span class="ident" id="2027052">sg</span>&nbsp;<span class="op" id="2027055">!=</span>&nbsp;<span class="ident" id="2027058">nil</span>&nbsp;<span class="op" id="2027062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027069">goto</span>&nbsp;<span class="ident" id="2027074">syncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2027087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2027092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027097">if</span>&nbsp;<span class="ident" id="2027100">c</span><span class="op" id="2027101">.</span><span class="ident" id="2027102">closed</span>&nbsp;<span class="op" id="2027109">!=</span>&nbsp;<span class="num" id="2027112">0</span>&nbsp;<span class="op" id="2027114">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027120">goto</span>&nbsp;<span class="ident" id="2027125">rclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2027135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027140">case</span>&nbsp;<span class="ident" id="2027145">_CaseSend</span><span class="op" id="2027154">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027159">if</span>&nbsp;<span class="ident" id="2027162">raceenabled</span>&nbsp;<span class="op" id="2027174">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027180">racereadpc</span><span class="op" id="2027190">(</span><span class="ident" id="2027191">unsafe</span><span class="op" id="2027197">.</span><span class="ident" id="2027198">Pointer</span><span class="op" id="2027205">(</span><span class="ident" id="2027206">c</span><span class="op" id="2027207">)</span><span class="op" id="2027208">,</span>&nbsp;<span class="ident" id="2027210">cas</span><span class="op" id="2027213">.</span><span class="ident" id="2027214">pc</span><span class="op" id="2027216">,</span>&nbsp;<span class="ident" id="2027218">chansendpc</span><span class="op" id="2027228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2027233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027238">if</span>&nbsp;<span class="ident" id="2027241">c</span><span class="op" id="2027242">.</span><span class="ident" id="2027243">closed</span>&nbsp;<span class="op" id="2027250">!=</span>&nbsp;<span class="num" id="2027253">0</span>&nbsp;<span class="op" id="2027255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027261">goto</span>&nbsp;<span class="ident" id="2027266">sclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2027276">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027281">if</span>&nbsp;<span class="ident" id="2027284">c</span><span class="op" id="2027285">.</span><span class="ident" id="2027286">dataqsiz</span>&nbsp;<span class="op" id="2027295">&gt;</span>&nbsp;<span class="num" id="2027297">0</span>&nbsp;<span class="op" id="2027299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027305">if</span>&nbsp;<span class="ident" id="2027308">c</span><span class="op" id="2027309">.</span><span class="ident" id="2027310">qcount</span>&nbsp;<span class="op" id="2027317">&lt;</span>&nbsp;<span class="ident" id="2027319">c</span><span class="op" id="2027320">.</span><span class="ident" id="2027321">dataqsiz</span>&nbsp;<span class="op" id="2027330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027337">goto</span>&nbsp;<span class="ident" id="2027342">asyncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2027356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2027361">}</span>&nbsp;<span class="keyword" id="2027363">else</span>&nbsp;<span class="op" id="2027368">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027374">sg</span>&nbsp;<span class="op" id="2027377">=</span>&nbsp;<span class="ident" id="2027379">c</span><span class="op" id="2027380">.</span><span class="ident" id="2027381">recvq</span><span class="op" id="2027386">.</span><span class="ident" id="2027387">dequeue</span><span class="op" id="2027394">(</span><span class="op" id="2027395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027401">if</span>&nbsp;<span class="ident" id="2027404">sg</span>&nbsp;<span class="op" id="2027407">!=</span>&nbsp;<span class="ident" id="2027410">nil</span>&nbsp;<span class="op" id="2027414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027421">goto</span>&nbsp;<span class="ident" id="2027426">syncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2027439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2027444">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027449">case</span>&nbsp;<span class="ident" id="2027454">_CaseDefault</span><span class="op" id="2027466">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027471">dfl</span>&nbsp;<span class="op" id="2027475">=</span>&nbsp;<span class="ident" id="2027477">cas</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2027483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2027486">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027490">if</span>&nbsp;<span class="ident" id="2027493">dfl</span>&nbsp;<span class="op" id="2027497">!=</span>&nbsp;<span class="ident" id="2027500">nil</span>&nbsp;<span class="op" id="2027504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027508">selunlock</span><span class="op" id="2027517">(</span><span class="ident" id="2027518">sel</span><span class="op" id="2027521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027525">cas</span>&nbsp;<span class="op" id="2027529">=</span>&nbsp;<span class="ident" id="2027531">dfl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027537">goto</span>&nbsp;<span class="ident" id="2027542">retc</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2027548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2027552">//&nbsp;pass&nbsp;2&nbsp;-&nbsp;enqueue&nbsp;on&nbsp;all&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027586">gp</span>&nbsp;<span class="op" id="2027589">=</span>&nbsp;<span class="ident" id="2027591">getg</span><span class="op" id="2027595">(</span><span class="op" id="2027596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027599">done</span>&nbsp;<span class="op" id="2027604">=</span>&nbsp;<span class="num" id="2027606">0</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027609">for</span>&nbsp;<span class="ident" id="2027613">i</span>&nbsp;<span class="op" id="2027615">:=</span>&nbsp;<span class="num" id="2027618">0</span><span class="op" id="2027619">;</span>&nbsp;<span class="ident" id="2027621">i</span>&nbsp;<span class="op" id="2027623">&lt;</span>&nbsp;<span class="builtintype" id="2027625">int</span><span class="op" id="2027628">(</span><span class="ident" id="2027629">sel</span><span class="op" id="2027632">.</span><span class="ident" id="2027633">ncase</span><span class="op" id="2027638">)</span><span class="op" id="2027639">;</span>&nbsp;<span class="ident" id="2027641">i</span><span class="op" id="2027642">++</span>&nbsp;<span class="op" id="2027645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027649">cas</span>&nbsp;<span class="op" id="2027653">=</span>&nbsp;<span class="op" id="2027655">&amp;</span><span class="ident" id="2027656">scases</span><span class="op" id="2027662">[</span><span class="ident" id="2027663">pollorder</span><span class="op" id="2027672">[</span><span class="ident" id="2027673">i</span><span class="op" id="2027674">]</span><span class="op" id="2027675">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027679">c</span>&nbsp;<span class="op" id="2027681">=</span>&nbsp;<span class="ident" id="2027683">cas</span><span class="op" id="2027686">.</span><span class="ident" id="2027687">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027695">sg</span>&nbsp;<span class="op" id="2027698">:=</span>&nbsp;<span class="ident" id="2027701">acquireSudog</span><span class="op" id="2027713">(</span><span class="op" id="2027714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027718">sg</span><span class="op" id="2027720">.</span><span class="ident" id="2027721">g</span>&nbsp;<span class="op" id="2027723">=</span>&nbsp;<span class="ident" id="2027725">gp</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2027730">//&nbsp;Note:&nbsp;selectdone&nbsp;is&nbsp;adjusted&nbsp;for&nbsp;stack&nbsp;copies&nbsp;in&nbsp;stack.c:adjustsudogs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027805">sg</span><span class="op" id="2027807">.</span><span class="ident" id="2027808">selectdone</span>&nbsp;<span class="op" id="2027819">=</span>&nbsp;<span class="op" id="2027821">(</span><span class="op" id="2027822">*</span><span class="builtintype" id="2027823">uint32</span><span class="op" id="2027829">)</span><span class="op" id="2027830">(</span><span class="ident" id="2027831">noescape</span><span class="op" id="2027839">(</span><span class="ident" id="2027840">unsafe</span><span class="op" id="2027846">.</span><span class="ident" id="2027847">Pointer</span><span class="op" id="2027854">(</span><span class="op" id="2027855">&amp;</span><span class="ident" id="2027856">done</span><span class="op" id="2027860">)</span><span class="op" id="2027861">)</span><span class="op" id="2027862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027866">sg</span><span class="op" id="2027868">.</span><span class="ident" id="2027869">elem</span>&nbsp;<span class="op" id="2027874">=</span>&nbsp;<span class="ident" id="2027876">cas</span><span class="op" id="2027879">.</span><span class="ident" id="2027880">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027887">sg</span><span class="op" id="2027889">.</span><span class="ident" id="2027890">releasetime</span>&nbsp;<span class="op" id="2027902">=</span>&nbsp;<span class="num" id="2027904">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027908">if</span>&nbsp;<span class="ident" id="2027911">t0</span>&nbsp;<span class="op" id="2027914">!=</span>&nbsp;<span class="num" id="2027917">0</span>&nbsp;<span class="op" id="2027919">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027924">sg</span><span class="op" id="2027926">.</span><span class="ident" id="2027927">releasetime</span>&nbsp;<span class="op" id="2027939">=</span>&nbsp;<span class="op" id="2027941">-</span><span class="num" id="2027942">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2027946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027950">sg</span><span class="op" id="2027952">.</span><span class="ident" id="2027953">waitlink</span>&nbsp;<span class="op" id="2027962">=</span>&nbsp;<span class="ident" id="2027964">gp</span><span class="op" id="2027966">.</span><span class="ident" id="2027967">waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2027977">gp</span><span class="op" id="2027979">.</span><span class="ident" id="2027980">waiting</span>&nbsp;<span class="op" id="2027988">=</span>&nbsp;<span class="ident" id="2027990">sg</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2027996">switch</span>&nbsp;<span class="ident" id="2028003">cas</span><span class="op" id="2028006">.</span><span class="ident" id="2028007">kind</span>&nbsp;<span class="op" id="2028012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2028016">case</span>&nbsp;<span class="ident" id="2028021">_CaseRecv</span><span class="op" id="2028030">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2028035">c</span><span class="op" id="2028036">.</span><span class="ident" id="2028037">recvq</span><span class="op" id="2028042">.</span><span class="ident" id="2028043">enqueue</span><span class="op" id="2028050">(</span><span class="ident" id="2028051">sg</span><span class="op" id="2028053">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2028058">case</span>&nbsp;<span class="ident" id="2028063">_CaseSend</span><span class="op" id="2028072">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2028077">c</span><span class="op" id="2028078">.</span><span class="ident" id="2028079">sendq</span><span class="op" id="2028084">.</span><span class="ident" id="2028085">enqueue</span><span class="op" id="2028092">(</span><span class="ident" id="2028093">sg</span><span class="op" id="2028095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2028099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2028102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2028106">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;wake&nbsp;us&nbsp;up</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2028141">gp</span><span class="op" id="2028143">.</span><span class="ident" id="2028144">param</span>&nbsp;<span class="op" id="2028150">=</span>&nbsp;<span class="ident" id="2028152">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2028157">gopark</span><span class="op" id="2028163">(</span><span class="ident" id="2028164">unsafe</span><span class="op" id="2028170">.</span><span class="ident" id="2028171">Pointer</span><span class="op" id="2028178">(</span><span class="ident" id="2028179">funcPC</span><span class="op" id="2028185">(</span><span class="ident" id="2028186">selparkcommit</span><span class="op" id="2028199">)</span><span class="op" id="2028200">)</span><span class="op" id="2028201">,</span>&nbsp;<span class="ident" id="2028203">unsafe</span><span class="op" id="2028209">.</span><span class="ident" id="2028210">Pointer</span><span class="op" id="2028217">(</span><span class="ident" id="2028218">sel</span><span class="op" id="2028221">)</span><span class="op" id="2028222">,</span>&nbsp;<span class="string" id="2028224">&#34;select&#34;</span><span class="op" id="2028232">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2028236">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2028259">sellock</span><span class="op" id="2028266">(</span><span class="ident" id="2028267">sel</span><span class="op" id="2028270">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2028273">sg</span>&nbsp;<span class="op" id="2028276">=</span>&nbsp;<span class="op" id="2028278">(</span><span class="op" id="2028279">*</span><span class="ident" id="2028280">sudog</span><span class="op" id="2028285">)</span><span class="op" id="2028286">(</span><span class="ident" id="2028287">gp</span><span class="op" id="2028289">.</span><span class="ident" id="2028290">param</span><span class="op" id="2028295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2028298">gp</span><span class="op" id="2028300">.</span><span class="ident" id="2028301">param</span>&nbsp;<span class="op" id="2028307">=</span>&nbsp;<span class="ident" id="2028309">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2028315">//&nbsp;pass&nbsp;3&nbsp;-&nbsp;dequeue&nbsp;from&nbsp;unsuccessful&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2028360">//&nbsp;otherwise&nbsp;they&nbsp;stack&nbsp;up&nbsp;on&nbsp;quiet&nbsp;channels</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2028406">//&nbsp;record&nbsp;the&nbsp;successful&nbsp;case,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2028446">//&nbsp;We&nbsp;singly-linked&nbsp;up&nbsp;the&nbsp;SudoGs&nbsp;in&nbsp;case&nbsp;order,&nbsp;so&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2028504">//&nbsp;iterating&nbsp;through&nbsp;the&nbsp;linked&nbsp;list&nbsp;they&nbsp;are&nbsp;in&nbsp;reverse&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2028569">cas</span>&nbsp;<span class="op" id="2028573">=</span>&nbsp;<span class="ident" id="2028575">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2028580">sglist</span>&nbsp;<span class="op" id="2028587">=</span>&nbsp;<span class="ident" id="2028589">gp</span><span class="op" id="2028591">.</span><span class="ident" id="2028592">waiting</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2028601">//&nbsp;Clear&nbsp;all&nbsp;selectdone&nbsp;and&nbsp;elem&nbsp;before&nbsp;unlinking&nbsp;from&nbsp;gp.waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2028669">//&nbsp;They&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;being&nbsp;put&nbsp;back&nbsp;into&nbsp;the&nbsp;sudog&nbsp;cache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2028738">//&nbsp;Clear&nbsp;before&nbsp;unlinking,&nbsp;because&nbsp;if&nbsp;a&nbsp;stack&nbsp;copy&nbsp;happens&nbsp;after&nbsp;the&nbsp;unlink,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2028816">//&nbsp;they&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;they&nbsp;will&nbsp;be&nbsp;left&nbsp;pointing&nbsp;to&nbsp;the&nbsp;old&nbsp;stack,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2028891">//&nbsp;which&nbsp;creates&nbsp;dangling&nbsp;pointers,&nbsp;which&nbsp;may&nbsp;be&nbsp;detected&nbsp;by&nbsp;the</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2028957">//&nbsp;garbage&nbsp;collector.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2028980">for</span>&nbsp;<span class="ident" id="2028984">sg1</span>&nbsp;<span class="op" id="2028988">:=</span>&nbsp;<span class="ident" id="2028991">gp</span><span class="op" id="2028993">.</span><span class="ident" id="2028994">waiting</span><span class="op" id="2029001">;</span>&nbsp;<span class="ident" id="2029003">sg1</span>&nbsp;<span class="op" id="2029007">!=</span>&nbsp;<span class="ident" id="2029010">nil</span><span class="op" id="2029013">;</span>&nbsp;<span class="ident" id="2029015">sg1</span>&nbsp;<span class="op" id="2029019">=</span>&nbsp;<span class="ident" id="2029021">sg1</span><span class="op" id="2029024">.</span><span class="ident" id="2029025">waitlink</span>&nbsp;<span class="op" id="2029034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029038">sg1</span><span class="op" id="2029041">.</span><span class="ident" id="2029042">selectdone</span>&nbsp;<span class="op" id="2029053">=</span>&nbsp;<span class="ident" id="2029055">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029061">sg1</span><span class="op" id="2029064">.</span><span class="ident" id="2029065">elem</span>&nbsp;<span class="op" id="2029070">=</span>&nbsp;<span class="ident" id="2029072">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2029077">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029080">gp</span><span class="op" id="2029082">.</span><span class="ident" id="2029083">waiting</span>&nbsp;<span class="op" id="2029091">=</span>&nbsp;<span class="ident" id="2029093">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2029098">for</span>&nbsp;<span class="ident" id="2029102">i</span>&nbsp;<span class="op" id="2029104">:=</span>&nbsp;<span class="builtintype" id="2029107">int</span><span class="op" id="2029110">(</span><span class="ident" id="2029111">sel</span><span class="op" id="2029114">.</span><span class="ident" id="2029115">ncase</span><span class="op" id="2029120">)</span>&nbsp;<span class="op" id="2029122">-</span>&nbsp;<span class="num" id="2029124">1</span><span class="op" id="2029125">;</span>&nbsp;<span class="ident" id="2029127">i</span>&nbsp;<span class="op" id="2029129">&gt;=</span>&nbsp;<span class="num" id="2029132">0</span><span class="op" id="2029133">;</span>&nbsp;<span class="ident" id="2029135">i</span><span class="op" id="2029136">--</span>&nbsp;<span class="op" id="2029139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029143">k</span>&nbsp;<span class="op" id="2029145">=</span>&nbsp;<span class="op" id="2029147">&amp;</span><span class="ident" id="2029148">scases</span><span class="op" id="2029154">[</span><span class="ident" id="2029155">pollorder</span><span class="op" id="2029164">[</span><span class="ident" id="2029165">i</span><span class="op" id="2029166">]</span><span class="op" id="2029167">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2029171">if</span>&nbsp;<span class="ident" id="2029174">sglist</span><span class="op" id="2029180">.</span><span class="ident" id="2029181">releasetime</span>&nbsp;<span class="op" id="2029193">&gt;</span>&nbsp;<span class="num" id="2029195">0</span>&nbsp;<span class="op" id="2029197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029202">k</span><span class="op" id="2029203">.</span><span class="ident" id="2029204">releasetime</span>&nbsp;<span class="op" id="2029216">=</span>&nbsp;<span class="ident" id="2029218">sglist</span><span class="op" id="2029224">.</span><span class="ident" id="2029225">releasetime</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2029239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2029243">if</span>&nbsp;<span class="ident" id="2029246">sg</span>&nbsp;<span class="op" id="2029249">==</span>&nbsp;<span class="ident" id="2029252">sglist</span>&nbsp;<span class="op" id="2029259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029264">cas</span>&nbsp;<span class="op" id="2029268">=</span>&nbsp;<span class="ident" id="2029270">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2029274">}</span>&nbsp;<span class="keyword" id="2029276">else</span>&nbsp;<span class="op" id="2029281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029286">c</span>&nbsp;<span class="op" id="2029288">=</span>&nbsp;<span class="ident" id="2029290">k</span><span class="op" id="2029291">.</span><span class="ident" id="2029292">_chan</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2029301">if</span>&nbsp;<span class="ident" id="2029304">k</span><span class="op" id="2029305">.</span><span class="ident" id="2029306">kind</span>&nbsp;<span class="op" id="2029311">==</span>&nbsp;<span class="ident" id="2029314">_CaseSend</span>&nbsp;<span class="op" id="2029324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029330">c</span><span class="op" id="2029331">.</span><span class="ident" id="2029332">sendq</span><span class="op" id="2029337">.</span><span class="ident" id="2029338">dequeueSudoG</span><span class="op" id="2029350">(</span><span class="ident" id="2029351">sglist</span><span class="op" id="2029357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2029362">}</span>&nbsp;<span class="keyword" id="2029364">else</span>&nbsp;<span class="op" id="2029369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029375">c</span><span class="op" id="2029376">.</span><span class="ident" id="2029377">recvq</span><span class="op" id="2029382">.</span><span class="ident" id="2029383">dequeueSudoG</span><span class="op" id="2029395">(</span><span class="ident" id="2029396">sglist</span><span class="op" id="2029402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2029407">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2029411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029415">sgnext</span>&nbsp;<span class="op" id="2029422">=</span>&nbsp;<span class="ident" id="2029424">sglist</span><span class="op" id="2029430">.</span><span class="ident" id="2029431">waitlink</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029442">sglist</span><span class="op" id="2029448">.</span><span class="ident" id="2029449">waitlink</span>&nbsp;<span class="op" id="2029458">=</span>&nbsp;<span class="ident" id="2029460">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029466">releaseSudog</span><span class="op" id="2029478">(</span><span class="ident" id="2029479">sglist</span><span class="op" id="2029485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029489">sglist</span>&nbsp;<span class="op" id="2029496">=</span>&nbsp;<span class="ident" id="2029498">sgnext</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2029506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2029510">if</span>&nbsp;<span class="ident" id="2029513">cas</span>&nbsp;<span class="op" id="2029517">==</span>&nbsp;<span class="ident" id="2029520">nil</span>&nbsp;<span class="op" id="2029524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2029528">goto</span>&nbsp;<span class="ident" id="2029533">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2029539">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029543">c</span>&nbsp;<span class="op" id="2029545">=</span>&nbsp;<span class="ident" id="2029547">cas</span><span class="op" id="2029550">.</span><span class="ident" id="2029551">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2029559">if</span>&nbsp;<span class="ident" id="2029562">c</span><span class="op" id="2029563">.</span><span class="ident" id="2029564">dataqsiz</span>&nbsp;<span class="op" id="2029573">&gt;</span>&nbsp;<span class="num" id="2029575">0</span>&nbsp;<span class="op" id="2029577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029581">gothrow</span><span class="op" id="2029588">(</span><span class="string" id="2029589">&#34;selectgo:&nbsp;shouldn&#39;t&nbsp;happen&#34;</span><span class="op" id="2029617">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2029620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2029624">if</span>&nbsp;<span class="ident" id="2029627">debugSelect</span>&nbsp;<span class="op" id="2029639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2029643">print</span><span class="op" id="2029648">(</span><span class="string" id="2029649">&#34;wait-return:&nbsp;sel=&#34;</span><span class="op" id="2029668">,</span>&nbsp;<span class="ident" id="2029670">sel</span><span class="op" id="2029673">,</span>&nbsp;<span class="string" id="2029675">&#34;&nbsp;c=&#34;</span><span class="op" id="2029680">,</span>&nbsp;<span class="ident" id="2029682">c</span><span class="op" id="2029683">,</span>&nbsp;<span class="string" id="2029685">&#34;&nbsp;cas=&#34;</span><span class="op" id="2029692">,</span>&nbsp;<span class="ident" id="2029694">cas</span><span class="op" id="2029697">,</span>&nbsp;<span class="string" id="2029699">&#34;&nbsp;kind=&#34;</span><span class="op" id="2029707">,</span>&nbsp;<span class="ident" id="2029709">cas</span><span class="op" id="2029712">.</span><span class="ident" id="2029713">kind</span><span class="op" id="2029717">,</span>&nbsp;<span class="string" id="2029719">&#34;\n&#34;</span><span class="op" id="2029723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2029726">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2029730">if</span>&nbsp;<span class="ident" id="2029733">cas</span><span class="op" id="2029736">.</span><span class="ident" id="2029737">kind</span>&nbsp;<span class="op" id="2029742">==</span>&nbsp;<span class="ident" id="2029745">_CaseRecv</span>&nbsp;<span class="op" id="2029755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2029759">if</span>&nbsp;<span class="ident" id="2029762">cas</span><span class="op" id="2029765">.</span><span class="ident" id="2029766">receivedp</span>&nbsp;<span class="op" id="2029776">!=</span>&nbsp;<span class="ident" id="2029779">nil</span>&nbsp;<span class="op" id="2029783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2029788">*</span><span class="ident" id="2029789">cas</span><span class="op" id="2029792">.</span><span class="ident" id="2029793">receivedp</span>&nbsp;<span class="op" id="2029803">=</span>&nbsp;<span class="builtintype" id="2029805">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2029812">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2029815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2029819">if</span>&nbsp;<span class="ident" id="2029822">raceenabled</span>&nbsp;<span class="op" id="2029834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2029838">if</span>&nbsp;<span class="ident" id="2029841">cas</span><span class="op" id="2029844">.</span><span class="ident" id="2029845">kind</span>&nbsp;<span class="op" id="2029850">==</span>&nbsp;<span class="ident" id="2029853">_CaseRecv</span>&nbsp;<span class="op" id="2029863">&amp;&amp;</span>&nbsp;<span class="ident" id="2029866">cas</span><span class="op" id="2029869">.</span><span class="ident" id="2029870">elem</span>&nbsp;<span class="op" id="2029875">!=</span>&nbsp;<span class="ident" id="2029878">nil</span>&nbsp;<span class="op" id="2029882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029887">raceWriteObjectPC</span><span class="op" id="2029904">(</span><span class="ident" id="2029905">c</span><span class="op" id="2029906">.</span><span class="ident" id="2029907">elemtype</span><span class="op" id="2029915">,</span>&nbsp;<span class="ident" id="2029917">cas</span><span class="op" id="2029920">.</span><span class="ident" id="2029921">elem</span><span class="op" id="2029925">,</span>&nbsp;<span class="ident" id="2029927">cas</span><span class="op" id="2029930">.</span><span class="ident" id="2029931">pc</span><span class="op" id="2029933">,</span>&nbsp;<span class="ident" id="2029935">chanrecvpc</span><span class="op" id="2029945">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2029949">}</span>&nbsp;<span class="keyword" id="2029951">else</span>&nbsp;<span class="keyword" id="2029956">if</span>&nbsp;<span class="ident" id="2029959">cas</span><span class="op" id="2029962">.</span><span class="ident" id="2029963">kind</span>&nbsp;<span class="op" id="2029968">==</span>&nbsp;<span class="ident" id="2029971">_CaseSend</span>&nbsp;<span class="op" id="2029981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2029986">raceReadObjectPC</span><span class="op" id="2030002">(</span><span class="ident" id="2030003">c</span><span class="op" id="2030004">.</span><span class="ident" id="2030005">elemtype</span><span class="op" id="2030013">,</span>&nbsp;<span class="ident" id="2030015">cas</span><span class="op" id="2030018">.</span><span class="ident" id="2030019">elem</span><span class="op" id="2030023">,</span>&nbsp;<span class="ident" id="2030025">cas</span><span class="op" id="2030028">.</span><span class="ident" id="2030029">pc</span><span class="op" id="2030031">,</span>&nbsp;<span class="ident" id="2030033">chansendpc</span><span class="op" id="2030043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2030047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2030050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030054">selunlock</span><span class="op" id="2030063">(</span><span class="ident" id="2030064">sel</span><span class="op" id="2030067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2030070">goto</span>&nbsp;<span class="ident" id="2030075">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="2030081">asyncrecv</span><span class="op" id="2030090">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2030093">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;buffer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2030121">if</span>&nbsp;<span class="ident" id="2030124">raceenabled</span>&nbsp;<span class="op" id="2030136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2030140">if</span>&nbsp;<span class="ident" id="2030143">cas</span><span class="op" id="2030146">.</span><span class="ident" id="2030147">elem</span>&nbsp;<span class="op" id="2030152">!=</span>&nbsp;<span class="ident" id="2030155">nil</span>&nbsp;<span class="op" id="2030159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030164">raceWriteObjectPC</span><span class="op" id="2030181">(</span><span class="ident" id="2030182">c</span><span class="op" id="2030183">.</span><span class="ident" id="2030184">elemtype</span><span class="op" id="2030192">,</span>&nbsp;<span class="ident" id="2030194">cas</span><span class="op" id="2030197">.</span><span class="ident" id="2030198">elem</span><span class="op" id="2030202">,</span>&nbsp;<span class="ident" id="2030204">cas</span><span class="op" id="2030207">.</span><span class="ident" id="2030208">pc</span><span class="op" id="2030210">,</span>&nbsp;<span class="ident" id="2030212">chanrecvpc</span><span class="op" id="2030222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2030226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030230">raceacquire</span><span class="op" id="2030241">(</span><span class="ident" id="2030242">chanbuf</span><span class="op" id="2030249">(</span><span class="ident" id="2030250">c</span><span class="op" id="2030251">,</span>&nbsp;<span class="ident" id="2030253">c</span><span class="op" id="2030254">.</span><span class="ident" id="2030255">recvx</span><span class="op" id="2030260">)</span><span class="op" id="2030261">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030265">racerelease</span><span class="op" id="2030276">(</span><span class="ident" id="2030277">chanbuf</span><span class="op" id="2030284">(</span><span class="ident" id="2030285">c</span><span class="op" id="2030286">,</span>&nbsp;<span class="ident" id="2030288">c</span><span class="op" id="2030289">.</span><span class="ident" id="2030290">recvx</span><span class="op" id="2030295">)</span><span class="op" id="2030296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2030299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2030302">if</span>&nbsp;<span class="ident" id="2030305">cas</span><span class="op" id="2030308">.</span><span class="ident" id="2030309">receivedp</span>&nbsp;<span class="op" id="2030319">!=</span>&nbsp;<span class="ident" id="2030322">nil</span>&nbsp;<span class="op" id="2030326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2030330">*</span><span class="ident" id="2030331">cas</span><span class="op" id="2030334">.</span><span class="ident" id="2030335">receivedp</span>&nbsp;<span class="op" id="2030345">=</span>&nbsp;<span class="builtintype" id="2030347">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2030353">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2030356">if</span>&nbsp;<span class="ident" id="2030359">cas</span><span class="op" id="2030362">.</span><span class="ident" id="2030363">elem</span>&nbsp;<span class="op" id="2030368">!=</span>&nbsp;<span class="ident" id="2030371">nil</span>&nbsp;<span class="op" id="2030375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030379">memmove</span><span class="op" id="2030386">(</span><span class="ident" id="2030387">cas</span><span class="op" id="2030390">.</span><span class="ident" id="2030391">elem</span><span class="op" id="2030395">,</span>&nbsp;<span class="ident" id="2030397">chanbuf</span><span class="op" id="2030404">(</span><span class="ident" id="2030405">c</span><span class="op" id="2030406">,</span>&nbsp;<span class="ident" id="2030408">c</span><span class="op" id="2030409">.</span><span class="ident" id="2030410">recvx</span><span class="op" id="2030415">)</span><span class="op" id="2030416">,</span>&nbsp;<span class="builtintype" id="2030418">uintptr</span><span class="op" id="2030425">(</span><span class="ident" id="2030426">c</span><span class="op" id="2030427">.</span><span class="ident" id="2030428">elemsize</span><span class="op" id="2030436">)</span><span class="op" id="2030437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2030440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030443">memclr</span><span class="op" id="2030449">(</span><span class="ident" id="2030450">chanbuf</span><span class="op" id="2030457">(</span><span class="ident" id="2030458">c</span><span class="op" id="2030459">,</span>&nbsp;<span class="ident" id="2030461">c</span><span class="op" id="2030462">.</span><span class="ident" id="2030463">recvx</span><span class="op" id="2030468">)</span><span class="op" id="2030469">,</span>&nbsp;<span class="builtintype" id="2030471">uintptr</span><span class="op" id="2030478">(</span><span class="ident" id="2030479">c</span><span class="op" id="2030480">.</span><span class="ident" id="2030481">elemsize</span><span class="op" id="2030489">)</span><span class="op" id="2030490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030493">c</span><span class="op" id="2030494">.</span><span class="ident" id="2030495">recvx</span><span class="op" id="2030500">++</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2030504">if</span>&nbsp;<span class="ident" id="2030507">c</span><span class="op" id="2030508">.</span><span class="ident" id="2030509">recvx</span>&nbsp;<span class="op" id="2030515">==</span>&nbsp;<span class="ident" id="2030518">c</span><span class="op" id="2030519">.</span><span class="ident" id="2030520">dataqsiz</span>&nbsp;<span class="op" id="2030529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030533">c</span><span class="op" id="2030534">.</span><span class="ident" id="2030535">recvx</span>&nbsp;<span class="op" id="2030541">=</span>&nbsp;<span class="num" id="2030543">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2030546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030549">c</span><span class="op" id="2030550">.</span><span class="ident" id="2030551">qcount</span><span class="op" id="2030557">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030561">sg</span>&nbsp;<span class="op" id="2030564">=</span>&nbsp;<span class="ident" id="2030566">c</span><span class="op" id="2030567">.</span><span class="ident" id="2030568">sendq</span><span class="op" id="2030573">.</span><span class="ident" id="2030574">dequeue</span><span class="op" id="2030581">(</span><span class="op" id="2030582">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2030585">if</span>&nbsp;<span class="ident" id="2030588">sg</span>&nbsp;<span class="op" id="2030591">!=</span>&nbsp;<span class="ident" id="2030594">nil</span>&nbsp;<span class="op" id="2030598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030602">gp</span>&nbsp;<span class="op" id="2030605">=</span>&nbsp;<span class="ident" id="2030607">sg</span><span class="op" id="2030609">.</span><span class="ident" id="2030610">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030614">selunlock</span><span class="op" id="2030623">(</span><span class="ident" id="2030624">sel</span><span class="op" id="2030627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2030631">if</span>&nbsp;<span class="ident" id="2030634">sg</span><span class="op" id="2030636">.</span><span class="ident" id="2030637">releasetime</span>&nbsp;<span class="op" id="2030649">!=</span>&nbsp;<span class="num" id="2030652">0</span>&nbsp;<span class="op" id="2030654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030659">sg</span><span class="op" id="2030661">.</span><span class="ident" id="2030662">releasetime</span>&nbsp;<span class="op" id="2030674">=</span>&nbsp;<span class="ident" id="2030676">cputicks</span><span class="op" id="2030684">(</span><span class="op" id="2030685">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2030689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030693">goready</span><span class="op" id="2030700">(</span><span class="ident" id="2030701">gp</span><span class="op" id="2030703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2030706">}</span>&nbsp;<span class="keyword" id="2030708">else</span>&nbsp;<span class="op" id="2030713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030717">selunlock</span><span class="op" id="2030726">(</span><span class="ident" id="2030727">sel</span><span class="op" id="2030730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2030733">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2030736">goto</span>&nbsp;<span class="ident" id="2030741">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="2030747">asyncsend</span><span class="op" id="2030756">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2030759">//&nbsp;can&nbsp;send&nbsp;to&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2030782">if</span>&nbsp;<span class="ident" id="2030785">raceenabled</span>&nbsp;<span class="op" id="2030797">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030801">raceacquire</span><span class="op" id="2030812">(</span><span class="ident" id="2030813">chanbuf</span><span class="op" id="2030820">(</span><span class="ident" id="2030821">c</span><span class="op" id="2030822">,</span>&nbsp;<span class="ident" id="2030824">c</span><span class="op" id="2030825">.</span><span class="ident" id="2030826">sendx</span><span class="op" id="2030831">)</span><span class="op" id="2030832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030836">racerelease</span><span class="op" id="2030847">(</span><span class="ident" id="2030848">chanbuf</span><span class="op" id="2030855">(</span><span class="ident" id="2030856">c</span><span class="op" id="2030857">,</span>&nbsp;<span class="ident" id="2030859">c</span><span class="op" id="2030860">.</span><span class="ident" id="2030861">sendx</span><span class="op" id="2030866">)</span><span class="op" id="2030867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030871">raceReadObjectPC</span><span class="op" id="2030887">(</span><span class="ident" id="2030888">c</span><span class="op" id="2030889">.</span><span class="ident" id="2030890">elemtype</span><span class="op" id="2030898">,</span>&nbsp;<span class="ident" id="2030900">cas</span><span class="op" id="2030903">.</span><span class="ident" id="2030904">elem</span><span class="op" id="2030908">,</span>&nbsp;<span class="ident" id="2030910">cas</span><span class="op" id="2030913">.</span><span class="ident" id="2030914">pc</span><span class="op" id="2030916">,</span>&nbsp;<span class="ident" id="2030918">chansendpc</span><span class="op" id="2030928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2030931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030934">memmove</span><span class="op" id="2030941">(</span><span class="ident" id="2030942">chanbuf</span><span class="op" id="2030949">(</span><span class="ident" id="2030950">c</span><span class="op" id="2030951">,</span>&nbsp;<span class="ident" id="2030953">c</span><span class="op" id="2030954">.</span><span class="ident" id="2030955">sendx</span><span class="op" id="2030960">)</span><span class="op" id="2030961">,</span>&nbsp;<span class="ident" id="2030963">cas</span><span class="op" id="2030966">.</span><span class="ident" id="2030967">elem</span><span class="op" id="2030971">,</span>&nbsp;<span class="builtintype" id="2030973">uintptr</span><span class="op" id="2030980">(</span><span class="ident" id="2030981">c</span><span class="op" id="2030982">.</span><span class="ident" id="2030983">elemsize</span><span class="op" id="2030991">)</span><span class="op" id="2030992">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2030995">c</span><span class="op" id="2030996">.</span><span class="ident" id="2030997">sendx</span><span class="op" id="2031002">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2031006">if</span>&nbsp;<span class="ident" id="2031009">c</span><span class="op" id="2031010">.</span><span class="ident" id="2031011">sendx</span>&nbsp;<span class="op" id="2031017">==</span>&nbsp;<span class="ident" id="2031020">c</span><span class="op" id="2031021">.</span><span class="ident" id="2031022">dataqsiz</span>&nbsp;<span class="op" id="2031031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031035">c</span><span class="op" id="2031036">.</span><span class="ident" id="2031037">sendx</span>&nbsp;<span class="op" id="2031043">=</span>&nbsp;<span class="num" id="2031045">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2031048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031051">c</span><span class="op" id="2031052">.</span><span class="ident" id="2031053">qcount</span><span class="op" id="2031059">++</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031063">sg</span>&nbsp;<span class="op" id="2031066">=</span>&nbsp;<span class="ident" id="2031068">c</span><span class="op" id="2031069">.</span><span class="ident" id="2031070">recvq</span><span class="op" id="2031075">.</span><span class="ident" id="2031076">dequeue</span><span class="op" id="2031083">(</span><span class="op" id="2031084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2031087">if</span>&nbsp;<span class="ident" id="2031090">sg</span>&nbsp;<span class="op" id="2031093">!=</span>&nbsp;<span class="ident" id="2031096">nil</span>&nbsp;<span class="op" id="2031100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031104">gp</span>&nbsp;<span class="op" id="2031107">=</span>&nbsp;<span class="ident" id="2031109">sg</span><span class="op" id="2031111">.</span><span class="ident" id="2031112">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031116">selunlock</span><span class="op" id="2031125">(</span><span class="ident" id="2031126">sel</span><span class="op" id="2031129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2031133">if</span>&nbsp;<span class="ident" id="2031136">sg</span><span class="op" id="2031138">.</span><span class="ident" id="2031139">releasetime</span>&nbsp;<span class="op" id="2031151">!=</span>&nbsp;<span class="num" id="2031154">0</span>&nbsp;<span class="op" id="2031156">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031161">sg</span><span class="op" id="2031163">.</span><span class="ident" id="2031164">releasetime</span>&nbsp;<span class="op" id="2031176">=</span>&nbsp;<span class="ident" id="2031178">cputicks</span><span class="op" id="2031186">(</span><span class="op" id="2031187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2031191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031195">goready</span><span class="op" id="2031202">(</span><span class="ident" id="2031203">gp</span><span class="op" id="2031205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2031208">}</span>&nbsp;<span class="keyword" id="2031210">else</span>&nbsp;<span class="op" id="2031215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031219">selunlock</span><span class="op" id="2031228">(</span><span class="ident" id="2031229">sel</span><span class="op" id="2031232">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2031235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2031238">goto</span>&nbsp;<span class="ident" id="2031243">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="2031249">syncrecv</span><span class="op" id="2031257">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2031260">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;sleeping&nbsp;sender&nbsp;(sg)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2031302">if</span>&nbsp;<span class="ident" id="2031305">raceenabled</span>&nbsp;<span class="op" id="2031317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2031321">if</span>&nbsp;<span class="ident" id="2031324">cas</span><span class="op" id="2031327">.</span><span class="ident" id="2031328">elem</span>&nbsp;<span class="op" id="2031333">!=</span>&nbsp;<span class="ident" id="2031336">nil</span>&nbsp;<span class="op" id="2031340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031345">raceWriteObjectPC</span><span class="op" id="2031362">(</span><span class="ident" id="2031363">c</span><span class="op" id="2031364">.</span><span class="ident" id="2031365">elemtype</span><span class="op" id="2031373">,</span>&nbsp;<span class="ident" id="2031375">cas</span><span class="op" id="2031378">.</span><span class="ident" id="2031379">elem</span><span class="op" id="2031383">,</span>&nbsp;<span class="ident" id="2031385">cas</span><span class="op" id="2031388">.</span><span class="ident" id="2031389">pc</span><span class="op" id="2031391">,</span>&nbsp;<span class="ident" id="2031393">chanrecvpc</span><span class="op" id="2031403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2031407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031411">racesync</span><span class="op" id="2031419">(</span><span class="ident" id="2031420">c</span><span class="op" id="2031421">,</span>&nbsp;<span class="ident" id="2031423">sg</span><span class="op" id="2031425">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2031428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031431">selunlock</span><span class="op" id="2031440">(</span><span class="ident" id="2031441">sel</span><span class="op" id="2031444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2031447">if</span>&nbsp;<span class="ident" id="2031450">debugSelect</span>&nbsp;<span class="op" id="2031462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2031466">print</span><span class="op" id="2031471">(</span><span class="string" id="2031472">&#34;syncrecv:&nbsp;sel=&#34;</span><span class="op" id="2031488">,</span>&nbsp;<span class="ident" id="2031490">sel</span><span class="op" id="2031493">,</span>&nbsp;<span class="string" id="2031495">&#34;&nbsp;c=&#34;</span><span class="op" id="2031500">,</span>&nbsp;<span class="ident" id="2031502">c</span><span class="op" id="2031503">,</span>&nbsp;<span class="string" id="2031505">&#34;\n&#34;</span><span class="op" id="2031509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2031512">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2031515">if</span>&nbsp;<span class="ident" id="2031518">cas</span><span class="op" id="2031521">.</span><span class="ident" id="2031522">receivedp</span>&nbsp;<span class="op" id="2031532">!=</span>&nbsp;<span class="ident" id="2031535">nil</span>&nbsp;<span class="op" id="2031539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2031543">*</span><span class="ident" id="2031544">cas</span><span class="op" id="2031547">.</span><span class="ident" id="2031548">receivedp</span>&nbsp;<span class="op" id="2031558">=</span>&nbsp;<span class="builtintype" id="2031560">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2031566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2031569">if</span>&nbsp;<span class="ident" id="2031572">cas</span><span class="op" id="2031575">.</span><span class="ident" id="2031576">elem</span>&nbsp;<span class="op" id="2031581">!=</span>&nbsp;<span class="ident" id="2031584">nil</span>&nbsp;<span class="op" id="2031588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031592">memmove</span><span class="op" id="2031599">(</span><span class="ident" id="2031600">cas</span><span class="op" id="2031603">.</span><span class="ident" id="2031604">elem</span><span class="op" id="2031608">,</span>&nbsp;<span class="ident" id="2031610">sg</span><span class="op" id="2031612">.</span><span class="ident" id="2031613">elem</span><span class="op" id="2031617">,</span>&nbsp;<span class="builtintype" id="2031619">uintptr</span><span class="op" id="2031626">(</span><span class="ident" id="2031627">c</span><span class="op" id="2031628">.</span><span class="ident" id="2031629">elemsize</span><span class="op" id="2031637">)</span><span class="op" id="2031638">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2031641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031644">sg</span><span class="op" id="2031646">.</span><span class="ident" id="2031647">elem</span>&nbsp;<span class="op" id="2031652">=</span>&nbsp;<span class="ident" id="2031654">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031659">gp</span>&nbsp;<span class="op" id="2031662">=</span>&nbsp;<span class="ident" id="2031664">sg</span><span class="op" id="2031666">.</span><span class="ident" id="2031667">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031670">gp</span><span class="op" id="2031672">.</span><span class="ident" id="2031673">param</span>&nbsp;<span class="op" id="2031679">=</span>&nbsp;<span class="ident" id="2031681">unsafe</span><span class="op" id="2031687">.</span><span class="ident" id="2031688">Pointer</span><span class="op" id="2031695">(</span><span class="ident" id="2031696">sg</span><span class="op" id="2031698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2031701">if</span>&nbsp;<span class="ident" id="2031704">sg</span><span class="op" id="2031706">.</span><span class="ident" id="2031707">releasetime</span>&nbsp;<span class="op" id="2031719">!=</span>&nbsp;<span class="num" id="2031722">0</span>&nbsp;<span class="op" id="2031724">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031728">sg</span><span class="op" id="2031730">.</span><span class="ident" id="2031731">releasetime</span>&nbsp;<span class="op" id="2031743">=</span>&nbsp;<span class="ident" id="2031745">cputicks</span><span class="op" id="2031753">(</span><span class="op" id="2031754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2031757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031760">goready</span><span class="op" id="2031767">(</span><span class="ident" id="2031768">gp</span><span class="op" id="2031770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2031773">goto</span>&nbsp;<span class="ident" id="2031778">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="ident" id="2031784">rclose</span><span class="op" id="2031790">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2031793">//&nbsp;read&nbsp;at&nbsp;end&nbsp;of&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031827">selunlock</span><span class="op" id="2031836">(</span><span class="ident" id="2031837">sel</span><span class="op" id="2031840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2031843">if</span>&nbsp;<span class="ident" id="2031846">cas</span><span class="op" id="2031849">.</span><span class="ident" id="2031850">receivedp</span>&nbsp;<span class="op" id="2031860">!=</span>&nbsp;<span class="ident" id="2031863">nil</span>&nbsp;<span class="op" id="2031867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2031871">*</span><span class="ident" id="2031872">cas</span><span class="op" id="2031875">.</span><span class="ident" id="2031876">receivedp</span>&nbsp;<span class="op" id="2031886">=</span>&nbsp;<span class="builtintype" id="2031888">false</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2031895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2031898">if</span>&nbsp;<span class="ident" id="2031901">cas</span><span class="op" id="2031904">.</span><span class="ident" id="2031905">elem</span>&nbsp;<span class="op" id="2031910">!=</span>&nbsp;<span class="ident" id="2031913">nil</span>&nbsp;<span class="op" id="2031917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031921">memclr</span><span class="op" id="2031927">(</span><span class="ident" id="2031928">cas</span><span class="op" id="2031931">.</span><span class="ident" id="2031932">elem</span><span class="op" id="2031936">,</span>&nbsp;<span class="builtintype" id="2031938">uintptr</span><span class="op" id="2031945">(</span><span class="ident" id="2031946">c</span><span class="op" id="2031947">.</span><span class="ident" id="2031948">elemsize</span><span class="op" id="2031956">)</span><span class="op" id="2031957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2031960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2031963">if</span>&nbsp;<span class="ident" id="2031966">raceenabled</span>&nbsp;<span class="op" id="2031978">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2031982">raceacquire</span><span class="op" id="2031993">(</span><span class="ident" id="2031994">unsafe</span><span class="op" id="2032000">.</span><span class="ident" id="2032001">Pointer</span><span class="op" id="2032008">(</span><span class="ident" id="2032009">c</span><span class="op" id="2032010">)</span><span class="op" id="2032011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2032014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2032017">goto</span>&nbsp;<span class="ident" id="2032022">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="2032028">syncsend</span><span class="op" id="2032036">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2032039">//&nbsp;can&nbsp;send&nbsp;to&nbsp;sleeping&nbsp;receiver&nbsp;(sg)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2032078">if</span>&nbsp;<span class="ident" id="2032081">raceenabled</span>&nbsp;<span class="op" id="2032093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2032097">raceReadObjectPC</span><span class="op" id="2032113">(</span><span class="ident" id="2032114">c</span><span class="op" id="2032115">.</span><span class="ident" id="2032116">elemtype</span><span class="op" id="2032124">,</span>&nbsp;<span class="ident" id="2032126">cas</span><span class="op" id="2032129">.</span><span class="ident" id="2032130">elem</span><span class="op" id="2032134">,</span>&nbsp;<span class="ident" id="2032136">cas</span><span class="op" id="2032139">.</span><span class="ident" id="2032140">pc</span><span class="op" id="2032142">,</span>&nbsp;<span class="ident" id="2032144">chansendpc</span><span class="op" id="2032154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2032158">racesync</span><span class="op" id="2032166">(</span><span class="ident" id="2032167">c</span><span class="op" id="2032168">,</span>&nbsp;<span class="ident" id="2032170">sg</span><span class="op" id="2032172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2032175">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2032178">selunlock</span><span class="op" id="2032187">(</span><span class="ident" id="2032188">sel</span><span class="op" id="2032191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2032194">if</span>&nbsp;<span class="ident" id="2032197">debugSelect</span>&nbsp;<span class="op" id="2032209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2032213">print</span><span class="op" id="2032218">(</span><span class="string" id="2032219">&#34;syncsend:&nbsp;sel=&#34;</span><span class="op" id="2032235">,</span>&nbsp;<span class="ident" id="2032237">sel</span><span class="op" id="2032240">,</span>&nbsp;<span class="string" id="2032242">&#34;&nbsp;c=&#34;</span><span class="op" id="2032247">,</span>&nbsp;<span class="ident" id="2032249">c</span><span class="op" id="2032250">,</span>&nbsp;<span class="string" id="2032252">&#34;\n&#34;</span><span class="op" id="2032256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2032259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2032262">if</span>&nbsp;<span class="ident" id="2032265">sg</span><span class="op" id="2032267">.</span><span class="ident" id="2032268">elem</span>&nbsp;<span class="op" id="2032273">!=</span>&nbsp;<span class="ident" id="2032276">nil</span>&nbsp;<span class="op" id="2032280">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2032284">memmove</span><span class="op" id="2032291">(</span><span class="ident" id="2032292">sg</span><span class="op" id="2032294">.</span><span class="ident" id="2032295">elem</span><span class="op" id="2032299">,</span>&nbsp;<span class="ident" id="2032301">cas</span><span class="op" id="2032304">.</span><span class="ident" id="2032305">elem</span><span class="op" id="2032309">,</span>&nbsp;<span class="builtintype" id="2032311">uintptr</span><span class="op" id="2032318">(</span><span class="ident" id="2032319">c</span><span class="op" id="2032320">.</span><span class="ident" id="2032321">elemsize</span><span class="op" id="2032329">)</span><span class="op" id="2032330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2032333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2032336">sg</span><span class="op" id="2032338">.</span><span class="ident" id="2032339">elem</span>&nbsp;<span class="op" id="2032344">=</span>&nbsp;<span class="ident" id="2032346">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2032351">gp</span>&nbsp;<span class="op" id="2032354">=</span>&nbsp;<span class="ident" id="2032356">sg</span><span class="op" id="2032358">.</span><span class="ident" id="2032359">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2032362">gp</span><span class="op" id="2032364">.</span><span class="ident" id="2032365">param</span>&nbsp;<span class="op" id="2032371">=</span>&nbsp;<span class="ident" id="2032373">unsafe</span><span class="op" id="2032379">.</span><span class="ident" id="2032380">Pointer</span><span class="op" id="2032387">(</span><span class="ident" id="2032388">sg</span><span class="op" id="2032390">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2032393">if</span>&nbsp;<span class="ident" id="2032396">sg</span><span class="op" id="2032398">.</span><span class="ident" id="2032399">releasetime</span>&nbsp;<span class="op" id="2032411">!=</span>&nbsp;<span class="num" id="2032414">0</span>&nbsp;<span class="op" id="2032416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2032420">sg</span><span class="op" id="2032422">.</span><span class="ident" id="2032423">releasetime</span>&nbsp;<span class="op" id="2032435">=</span>&nbsp;<span class="ident" id="2032437">cputicks</span><span class="op" id="2032445">(</span><span class="op" id="2032446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2032449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2032452">goready</span><span class="op" id="2032459">(</span><span class="ident" id="2032460">gp</span><span class="op" id="2032462">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span><span class="ident" id="2032465">retc</span><span class="op" id="2032469">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2032472">if</span>&nbsp;<span class="ident" id="2032475">cas</span><span class="op" id="2032478">.</span><span class="ident" id="2032479">releasetime</span>&nbsp;<span class="op" id="2032491">&gt;</span>&nbsp;<span class="num" id="2032493">0</span>&nbsp;<span class="op" id="2032495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2032499">blockevent</span><span class="op" id="2032509">(</span><span class="ident" id="2032510">cas</span><span class="op" id="2032513">.</span><span class="ident" id="2032514">releasetime</span><span class="op" id="2032525">-</span><span class="ident" id="2032526">t0</span><span class="op" id="2032528">,</span>&nbsp;<span class="num" id="2032530">2</span><span class="op" id="2032531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2032534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2032537">return</span>&nbsp;<span class="ident" id="2032544">cas</span><span class="op" id="2032547">.</span><span class="ident" id="2032548">pc</span><span class="op" id="2032550">,</span>&nbsp;<span class="ident" id="2032552">cas</span><span class="op" id="2032555">.</span><span class="ident" id="2032556">so</span><br>
<span class="lineno">570</span><br>
<span class="lineno"></span><span class="ident" id="2032560">sclose</span><span class="op" id="2032566">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2032569">//&nbsp;send&nbsp;on&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2032596">selunlock</span><span class="op" id="2032605">(</span><span class="ident" id="2032606">sel</span><span class="op" id="2032609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2032612">panic</span><span class="op" id="2032617">(</span><span class="string" id="2032618">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="2032642">)</span><br>
<span class="lineno">575</span><span class="op" id="2032644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2032647">func</span>&nbsp;<span class="op" id="2032652">(</span><span class="ident" id="2032653">c</span>&nbsp;<span class="op" id="2032655">*</span><span class="ident" id="2032656">hchan</span><span class="op" id="2032661">)</span>&nbsp;<span class="ident" id="2032663">sortkey</span><span class="op" id="2032670">(</span><span class="op" id="2032671">)</span>&nbsp;<span class="builtintype" id="2032673">uintptr</span>&nbsp;<span class="op" id="2032681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2032684">//&nbsp;TODO(khr):&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;moving&nbsp;garbage&nbsp;collector,&nbsp;we&#39;ll&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2032752">//&nbsp;change&nbsp;this&nbsp;function.</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2032778">return</span>&nbsp;<span class="builtintype" id="2032785">uintptr</span><span class="op" id="2032792">(</span><span class="ident" id="2032793">unsafe</span><span class="op" id="2032799">.</span><span class="ident" id="2032800">Pointer</span><span class="op" id="2032807">(</span><span class="ident" id="2032808">c</span><span class="op" id="2032809">)</span><span class="op" id="2032810">)</span><br>
<span class="lineno"></span><span class="op" id="2032812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2032815">//&nbsp;A&nbsp;runtimeSelect&nbsp;is&nbsp;a&nbsp;single&nbsp;case&nbsp;passed&nbsp;to&nbsp;rselect.</span><br>
<span class="lineno"></span><span class="comment" id="2032870">//&nbsp;This&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/runtimeSelect</span><br>
<span class="lineno">585</span><span class="keyword" id="2032924">type</span>&nbsp;<span class="ident" id="2032929">runtimeSelect</span>&nbsp;<span class="keyword" id="2032943">struct</span>&nbsp;<span class="op" id="2032950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2032953">dir</span>&nbsp;<span class="ident" id="2032957">selectDir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2032968">typ</span>&nbsp;<span class="ident" id="2032972">unsafe</span><span class="op" id="2032978">.</span><span class="ident" id="2032979">Pointer</span>&nbsp;<span class="comment" id="2032987">//&nbsp;channel&nbsp;type&nbsp;(not&nbsp;used&nbsp;here)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2033020">ch</span>&nbsp;&nbsp;<span class="op" id="2033024">*</span><span class="ident" id="2033025">hchan</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2033039">//&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2033051">val</span>&nbsp;<span class="ident" id="2033055">unsafe</span><span class="op" id="2033061">.</span><span class="ident" id="2033062">Pointer</span>&nbsp;<span class="comment" id="2033070">//&nbsp;ptr&nbsp;to&nbsp;data&nbsp;(SendDir)&nbsp;or&nbsp;ptr&nbsp;to&nbsp;receive&nbsp;buffer&nbsp;(RecvDir)</span><br>
<span class="lineno">590</span><span class="op" id="2033130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2033133">//&nbsp;These&nbsp;values&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/SelectDir.</span><br>
<span class="lineno"></span><span class="keyword" id="2033192">type</span>&nbsp;<span class="ident" id="2033197">selectDir</span>&nbsp;<span class="builtintype" id="2033207">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span><span class="keyword" id="2033212">const</span>&nbsp;<span class="op" id="2033218">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2033221">_</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2033235">selectDir</span>&nbsp;<span class="op" id="2033245">=</span>&nbsp;<span class="ident" id="2033247">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2033253">selectSend</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2033277">//&nbsp;case&nbsp;Chan&nbsp;&lt;-&nbsp;Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2033299">selectRecv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2033323">//&nbsp;case&nbsp;&lt;-Chan:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2033340">selectDefault</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2033364">//&nbsp;default</span><br>
<span class="lineno">600</span><span class="op" id="2033375">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2033378">func</span>&nbsp;<span class="ident" id="2033383">reflect_rselect</span><span class="op" id="2033398">(</span><span class="ident" id="2033399">cases</span>&nbsp;<span class="op" id="2033405">[</span><span class="op" id="2033406">]</span><span class="ident" id="2033407">runtimeSelect</span><span class="op" id="2033420">)</span>&nbsp;<span class="op" id="2033422">(</span><span class="ident" id="2033423">chosen</span>&nbsp;<span class="builtintype" id="2033430">int</span><span class="op" id="2033433">,</span>&nbsp;<span class="ident" id="2033435">recvOK</span>&nbsp;<span class="builtintype" id="2033442">bool</span><span class="op" id="2033446">)</span>&nbsp;<span class="op" id="2033448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2033451">//&nbsp;flagNoScan&nbsp;is&nbsp;safe&nbsp;here,&nbsp;because&nbsp;all&nbsp;objects&nbsp;are&nbsp;also&nbsp;referenced&nbsp;from&nbsp;cases.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2033532">size</span>&nbsp;<span class="op" id="2033537">:=</span>&nbsp;<span class="ident" id="2033540">selectsize</span><span class="op" id="2033550">(</span><span class="builtintype" id="2033551">uintptr</span><span class="op" id="2033558">(</span><span class="builtinfunc" id="2033559">len</span><span class="op" id="2033562">(</span><span class="ident" id="2033563">cases</span><span class="op" id="2033568">)</span><span class="op" id="2033569">)</span><span class="op" id="2033570">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2033573">sel</span>&nbsp;<span class="op" id="2033577">:=</span>&nbsp;<span class="op" id="2033580">(</span><span class="op" id="2033581">*</span><span class="ident" id="2033582">_select</span><span class="op" id="2033589">)</span><span class="op" id="2033590">(</span><span class="ident" id="2033591">mallocgc</span><span class="op" id="2033599">(</span><span class="ident" id="2033600">size</span><span class="op" id="2033604">,</span>&nbsp;<span class="ident" id="2033606">nil</span><span class="op" id="2033609">,</span>&nbsp;<span class="ident" id="2033611">flagNoScan</span><span class="op" id="2033621">)</span><span class="op" id="2033622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2033625">newselect</span><span class="op" id="2033634">(</span><span class="ident" id="2033635">sel</span><span class="op" id="2033638">,</span>&nbsp;<span class="ident" id="2033640">int64</span><span class="op" id="2033645">(</span><span class="ident" id="2033646">size</span><span class="op" id="2033650">)</span><span class="op" id="2033651">,</span>&nbsp;<span class="builtintype" id="2033653">int32</span><span class="op" id="2033658">(</span><span class="builtinfunc" id="2033659">len</span><span class="op" id="2033662">(</span><span class="ident" id="2033663">cases</span><span class="op" id="2033668">)</span><span class="op" id="2033669">)</span><span class="op" id="2033670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2033673">r</span>&nbsp;<span class="op" id="2033675">:=</span>&nbsp;<span class="builtinfunc" id="2033678">new</span><span class="op" id="2033681">(</span><span class="builtintype" id="2033682">bool</span><span class="op" id="2033686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2033689">for</span>&nbsp;<span class="ident" id="2033693">i</span>&nbsp;<span class="op" id="2033695">:=</span>&nbsp;<span class="keyword" id="2033698">range</span>&nbsp;<span class="ident" id="2033704">cases</span>&nbsp;<span class="op" id="2033710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2033714">rc</span>&nbsp;<span class="op" id="2033717">:=</span>&nbsp;<span class="op" id="2033720">&amp;</span><span class="ident" id="2033721">cases</span><span class="op" id="2033726">[</span><span class="ident" id="2033727">i</span><span class="op" id="2033728">]</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2033732">switch</span>&nbsp;<span class="ident" id="2033739">rc</span><span class="op" id="2033741">.</span><span class="ident" id="2033742">dir</span>&nbsp;<span class="op" id="2033746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2033750">case</span>&nbsp;<span class="ident" id="2033755">selectDefault</span><span class="op" id="2033768">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2033773">selectdefaultImpl</span><span class="op" id="2033790">(</span><span class="ident" id="2033791">sel</span><span class="op" id="2033794">,</span>&nbsp;<span class="builtintype" id="2033796">uintptr</span><span class="op" id="2033803">(</span><span class="ident" id="2033804">i</span><span class="op" id="2033805">)</span><span class="op" id="2033806">,</span>&nbsp;<span class="num" id="2033808">0</span><span class="op" id="2033809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2033813">case</span>&nbsp;<span class="ident" id="2033818">selectSend</span><span class="op" id="2033828">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2033833">if</span>&nbsp;<span class="ident" id="2033836">rc</span><span class="op" id="2033838">.</span><span class="ident" id="2033839">ch</span>&nbsp;<span class="op" id="2033842">==</span>&nbsp;<span class="ident" id="2033845">nil</span>&nbsp;<span class="op" id="2033849">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2033855">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2033864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2033869">selectsendImpl</span><span class="op" id="2033883">(</span><span class="ident" id="2033884">sel</span><span class="op" id="2033887">,</span>&nbsp;<span class="ident" id="2033889">rc</span><span class="op" id="2033891">.</span><span class="ident" id="2033892">ch</span><span class="op" id="2033894">,</span>&nbsp;<span class="builtintype" id="2033896">uintptr</span><span class="op" id="2033903">(</span><span class="ident" id="2033904">i</span><span class="op" id="2033905">)</span><span class="op" id="2033906">,</span>&nbsp;<span class="ident" id="2033908">rc</span><span class="op" id="2033910">.</span><span class="ident" id="2033911">val</span><span class="op" id="2033914">,</span>&nbsp;<span class="num" id="2033916">0</span><span class="op" id="2033917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2033921">case</span>&nbsp;<span class="ident" id="2033926">selectRecv</span><span class="op" id="2033936">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2033941">if</span>&nbsp;<span class="ident" id="2033944">rc</span><span class="op" id="2033946">.</span><span class="ident" id="2033947">ch</span>&nbsp;<span class="op" id="2033950">==</span>&nbsp;<span class="ident" id="2033953">nil</span>&nbsp;<span class="op" id="2033957">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2033963">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2033972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2033977">selectrecvImpl</span><span class="op" id="2033991">(</span><span class="ident" id="2033992">sel</span><span class="op" id="2033995">,</span>&nbsp;<span class="ident" id="2033997">rc</span><span class="op" id="2033999">.</span><span class="ident" id="2034000">ch</span><span class="op" id="2034002">,</span>&nbsp;<span class="builtintype" id="2034004">uintptr</span><span class="op" id="2034011">(</span><span class="ident" id="2034012">i</span><span class="op" id="2034013">)</span><span class="op" id="2034014">,</span>&nbsp;<span class="ident" id="2034016">rc</span><span class="op" id="2034018">.</span><span class="ident" id="2034019">val</span><span class="op" id="2034022">,</span>&nbsp;<span class="ident" id="2034024">r</span><span class="op" id="2034025">,</span>&nbsp;<span class="num" id="2034027">0</span><span class="op" id="2034028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2034032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2034035">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2034039">pc</span><span class="op" id="2034041">,</span>&nbsp;<span class="ident" id="2034043">_</span>&nbsp;<span class="op" id="2034045">:=</span>&nbsp;<span class="ident" id="2034048">selectgoImpl</span><span class="op" id="2034060">(</span><span class="ident" id="2034061">sel</span><span class="op" id="2034064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2034067">chosen</span>&nbsp;<span class="op" id="2034074">=</span>&nbsp;<span class="builtintype" id="2034076">int</span><span class="op" id="2034079">(</span><span class="ident" id="2034080">pc</span><span class="op" id="2034082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2034085">recvOK</span>&nbsp;<span class="op" id="2034092">=</span>&nbsp;<span class="op" id="2034094">*</span><span class="ident" id="2034095">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2034098">return</span><br>
<span class="lineno">630</span><span class="op" id="2034105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2034108">func</span>&nbsp;<span class="op" id="2034113">(</span><span class="ident" id="2034114">q</span>&nbsp;<span class="op" id="2034116">*</span><span class="ident" id="2034117">waitq</span><span class="op" id="2034122">)</span>&nbsp;<span class="ident" id="2034124">dequeueSudoG</span><span class="op" id="2034136">(</span><span class="ident" id="2034137">s</span>&nbsp;<span class="op" id="2034139">*</span><span class="ident" id="2034140">sudog</span><span class="op" id="2034145">)</span>&nbsp;<span class="op" id="2034147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2034150">var</span>&nbsp;<span class="ident" id="2034154">prevsgp</span>&nbsp;<span class="op" id="2034162">*</span><span class="ident" id="2034163">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2034170">l</span>&nbsp;<span class="op" id="2034172">:=</span>&nbsp;<span class="op" id="2034175">&amp;</span><span class="ident" id="2034176">q</span><span class="op" id="2034177">.</span><span class="ident" id="2034178">first</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2034185">for</span>&nbsp;<span class="op" id="2034189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2034193">sgp</span>&nbsp;<span class="op" id="2034197">:=</span>&nbsp;<span class="op" id="2034200">*</span><span class="ident" id="2034201">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2034205">if</span>&nbsp;<span class="ident" id="2034208">sgp</span>&nbsp;<span class="op" id="2034212">==</span>&nbsp;<span class="ident" id="2034215">nil</span>&nbsp;<span class="op" id="2034219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2034224">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2034233">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2034237">if</span>&nbsp;<span class="ident" id="2034240">sgp</span>&nbsp;<span class="op" id="2034244">==</span>&nbsp;<span class="ident" id="2034247">s</span>&nbsp;<span class="op" id="2034249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2034254">*</span><span class="ident" id="2034255">l</span>&nbsp;<span class="op" id="2034257">=</span>&nbsp;<span class="ident" id="2034259">sgp</span><span class="op" id="2034262">.</span><span class="ident" id="2034263">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2034271">if</span>&nbsp;<span class="ident" id="2034274">q</span><span class="op" id="2034275">.</span><span class="ident" id="2034276">last</span>&nbsp;<span class="op" id="2034281">==</span>&nbsp;<span class="ident" id="2034284">sgp</span>&nbsp;<span class="op" id="2034288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2034294">q</span><span class="op" id="2034295">.</span><span class="ident" id="2034296">last</span>&nbsp;<span class="op" id="2034301">=</span>&nbsp;<span class="ident" id="2034303">prevsgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2034314">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2034319">s</span><span class="op" id="2034320">.</span><span class="ident" id="2034321">next</span>&nbsp;<span class="op" id="2034326">=</span>&nbsp;<span class="ident" id="2034328">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2034335">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2034344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2034348">l</span>&nbsp;<span class="op" id="2034350">=</span>&nbsp;<span class="op" id="2034352">&amp;</span><span class="ident" id="2034353">sgp</span><span class="op" id="2034356">.</span><span class="ident" id="2034357">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2034364">prevsgp</span>&nbsp;<span class="op" id="2034372">=</span>&nbsp;<span class="ident" id="2034374">sgp</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2034379">}</span><br>
<span class="lineno"></span><span class="op" id="2034381">}</span>
</div>
</body>
</html>
