<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>text/template/parse</h2>
<ul>
<li><a href="/gostd/text/template/parse/lex.go.html">lex.go</a></li>
<li><a href="/gostd/text/template/parse/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/text/template/parse/node.go.html">node.go</a></li>
<li><a href="/gostd/text/template/parse/parse.go.html" class="current">parse.go</a></li>
<li><a href="/gostd/text/template/parse/parse_test.go.html">parse_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4433019">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4433074">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4433128">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4433179">//&nbsp;Package&nbsp;parse&nbsp;builds&nbsp;parse&nbsp;trees&nbsp;for&nbsp;templates&nbsp;as&nbsp;defined&nbsp;by&nbsp;text/template</span><br>
<span class="lineno"></span><span class="comment" id="4433257">//&nbsp;and&nbsp;html/template.&nbsp;Clients&nbsp;should&nbsp;use&nbsp;those&nbsp;packages&nbsp;to&nbsp;construct&nbsp;templates</span><br>
<span class="lineno"></span><span class="comment" id="4433336">//&nbsp;rather&nbsp;than&nbsp;this&nbsp;one,&nbsp;which&nbsp;provides&nbsp;shared&nbsp;internal&nbsp;data&nbsp;structures&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="4433412">//&nbsp;intended&nbsp;for&nbsp;general&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="4433441">package</span>&nbsp;<span class="ident" id="4433449">parse</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4433456">import</span>&nbsp;<span class="op" id="4433463">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4433466">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4433475">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4433482">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4433493">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4433504">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="4433514">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4433517">//&nbsp;Tree&nbsp;is&nbsp;the&nbsp;representation&nbsp;of&nbsp;a&nbsp;single&nbsp;parsed&nbsp;template.</span><br>
<span class="lineno">20</span><span class="keyword" id="4433576">type</span>&nbsp;<span class="ident" id="4433581">Tree</span>&nbsp;<span class="keyword" id="4433586">struct</span>&nbsp;<span class="op" id="4433593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4433596">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4433606">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4433616">//&nbsp;name&nbsp;of&nbsp;the&nbsp;template&nbsp;represented&nbsp;by&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4433666">ParseName</span>&nbsp;<span class="builtintype" id="4433676">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4433686">//&nbsp;name&nbsp;of&nbsp;the&nbsp;top-level&nbsp;template&nbsp;during&nbsp;parsing,&nbsp;for&nbsp;error&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4433757">Root</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4433767">*</span><span class="ident" id="4433768">ListNode</span>&nbsp;<span class="comment" id="4433777">//&nbsp;top-level&nbsp;root&nbsp;of&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4433809">text</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4433819">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4433829">//&nbsp;text&nbsp;parsed&nbsp;to&nbsp;create&nbsp;the&nbsp;template&nbsp;(or&nbsp;its&nbsp;parent)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4433884">//&nbsp;Parsing&nbsp;only;&nbsp;cleared&nbsp;after&nbsp;parse.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4433923">funcs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4433933">[</span><span class="op" id="4433934">]</span><span class="keyword" id="4433935">map</span><span class="op" id="4433938">[</span><span class="builtintype" id="4433939">string</span><span class="op" id="4433945">]</span><span class="keyword" id="4433946">interface</span><span class="op" id="4433955">{</span><span class="op" id="4433956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4433959">lex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4433969">*</span><span class="ident" id="4433970">lexer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4433977">token</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4433987">[</span><span class="num" id="4433988">3</span><span class="op" id="4433989">]</span><span class="ident" id="4433990">item</span>&nbsp;<span class="comment" id="4433995">//&nbsp;three-token&nbsp;lookahead&nbsp;for&nbsp;parser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434033">peekCount</span>&nbsp;<span class="builtintype" id="4434043">int</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434048">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4434058">[</span><span class="op" id="4434059">]</span><span class="builtintype" id="4434060">string</span>&nbsp;<span class="comment" id="4434067">//&nbsp;variables&nbsp;defined&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span><span class="op" id="4434103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4434106">//&nbsp;Copy&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;Tree.&nbsp;Any&nbsp;parsing&nbsp;state&nbsp;is&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="4434174">func</span>&nbsp;<span class="op" id="4434179">(</span><span class="ident" id="4434180">t</span>&nbsp;<span class="op" id="4434182">*</span><span class="ident" id="4434183">Tree</span><span class="op" id="4434187">)</span>&nbsp;<span class="ident" id="4434189">Copy</span><span class="op" id="4434193">(</span><span class="op" id="4434194">)</span>&nbsp;<span class="op" id="4434196">*</span><span class="ident" id="4434197">Tree</span>&nbsp;<span class="op" id="4434202">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4434205">if</span>&nbsp;<span class="ident" id="4434208">t</span>&nbsp;<span class="op" id="4434210">==</span>&nbsp;<span class="builtintype" id="4434213">nil</span>&nbsp;<span class="op" id="4434217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4434221">return</span>&nbsp;<span class="builtintype" id="4434228">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4434233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4434236">return</span>&nbsp;<span class="op" id="4434243">&amp;</span><span class="ident" id="4434244">Tree</span><span class="op" id="4434248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434252">Name</span><span class="op" id="4434256">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434263">t</span><span class="op" id="4434264">.</span><span class="ident" id="4434265">Name</span><span class="op" id="4434269">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434273">ParseName</span><span class="op" id="4434282">:</span>&nbsp;<span class="ident" id="4434284">t</span><span class="op" id="4434285">.</span><span class="ident" id="4434286">ParseName</span><span class="op" id="4434295">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434299">Root</span><span class="op" id="4434303">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434310">t</span><span class="op" id="4434311">.</span><span class="ident" id="4434312">Root</span><span class="op" id="4434316">.</span><span class="ident" id="4434317">CopyList</span><span class="op" id="4434325">(</span><span class="op" id="4434326">)</span><span class="op" id="4434327">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434331">text</span><span class="op" id="4434335">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434342">t</span><span class="op" id="4434343">.</span><span class="ident" id="4434344">text</span><span class="op" id="4434348">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4434351">}</span><br>
<span class="lineno"></span><span class="op" id="4434353">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="4434356">//&nbsp;Parse&nbsp;returns&nbsp;a&nbsp;map&nbsp;from&nbsp;template&nbsp;name&nbsp;to&nbsp;parse.Tree,&nbsp;created&nbsp;by&nbsp;parsing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4434436">//&nbsp;templates&nbsp;described&nbsp;in&nbsp;the&nbsp;argument&nbsp;string.&nbsp;The&nbsp;top-level&nbsp;template&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4434514">//&nbsp;given&nbsp;the&nbsp;specified&nbsp;name.&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;encountered,&nbsp;parsing&nbsp;stops&nbsp;and&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4434592">//&nbsp;empty&nbsp;map&nbsp;is&nbsp;returned&nbsp;with&nbsp;the&nbsp;error.</span><br>
<span class="lineno">50</span><span class="keyword" id="4434633">func</span>&nbsp;<span class="ident" id="4434638">Parse</span><span class="op" id="4434643">(</span><span class="ident" id="4434644">name</span><span class="op" id="4434648">,</span>&nbsp;<span class="ident" id="4434650">text</span><span class="op" id="4434654">,</span>&nbsp;<span class="ident" id="4434656">leftDelim</span><span class="op" id="4434665">,</span>&nbsp;<span class="ident" id="4434667">rightDelim</span>&nbsp;<span class="builtintype" id="4434678">string</span><span class="op" id="4434684">,</span>&nbsp;<span class="ident" id="4434686">funcs</span>&nbsp;<span class="op" id="4434692">...</span><span class="keyword" id="4434695">map</span><span class="op" id="4434698">[</span><span class="builtintype" id="4434699">string</span><span class="op" id="4434705">]</span><span class="keyword" id="4434706">interface</span><span class="op" id="4434715">{</span><span class="op" id="4434716">}</span><span class="op" id="4434717">)</span>&nbsp;<span class="op" id="4434719">(</span><span class="ident" id="4434720">treeSet</span>&nbsp;<span class="keyword" id="4434728">map</span><span class="op" id="4434731">[</span><span class="builtintype" id="4434732">string</span><span class="op" id="4434738">]</span><span class="op" id="4434739">*</span><span class="ident" id="4434740">Tree</span><span class="op" id="4434744">,</span>&nbsp;<span class="ident" id="4434746">err</span>&nbsp;<span class="builtintype" id="4434750">error</span><span class="op" id="4434755">)</span>&nbsp;<span class="op" id="4434757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434760">treeSet</span>&nbsp;<span class="op" id="4434768">=</span>&nbsp;<span class="builtinfunc" id="4434770">make</span><span class="op" id="4434774">(</span><span class="keyword" id="4434775">map</span><span class="op" id="4434778">[</span><span class="builtintype" id="4434779">string</span><span class="op" id="4434785">]</span><span class="op" id="4434786">*</span><span class="ident" id="4434787">Tree</span><span class="op" id="4434791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434794">t</span>&nbsp;<span class="op" id="4434796">:=</span>&nbsp;<span class="ident" id="4434799">New</span><span class="op" id="4434802">(</span><span class="ident" id="4434803">name</span><span class="op" id="4434807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434810">t</span><span class="op" id="4434811">.</span><span class="ident" id="4434812">text</span>&nbsp;<span class="op" id="4434817">=</span>&nbsp;<span class="ident" id="4434819">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434825">_</span><span class="op" id="4434826">,</span>&nbsp;<span class="ident" id="4434828">err</span>&nbsp;<span class="op" id="4434832">=</span>&nbsp;<span class="ident" id="4434834">t</span><span class="op" id="4434835">.</span><span class="ident" id="4434836">Parse</span><span class="op" id="4434841">(</span><span class="ident" id="4434842">text</span><span class="op" id="4434846">,</span>&nbsp;<span class="ident" id="4434848">leftDelim</span><span class="op" id="4434857">,</span>&nbsp;<span class="ident" id="4434859">rightDelim</span><span class="op" id="4434869">,</span>&nbsp;<span class="ident" id="4434871">treeSet</span><span class="op" id="4434878">,</span>&nbsp;<span class="ident" id="4434880">funcs</span><span class="op" id="4434885">...</span><span class="op" id="4434888">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4434891">return</span><br>
<span class="lineno"></span><span class="op" id="4434898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4434901">//&nbsp;next&nbsp;returns&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4434933">func</span>&nbsp;<span class="op" id="4434938">(</span><span class="ident" id="4434939">t</span>&nbsp;<span class="op" id="4434941">*</span><span class="ident" id="4434942">Tree</span><span class="op" id="4434946">)</span>&nbsp;<span class="ident" id="4434948">next</span><span class="op" id="4434952">(</span><span class="op" id="4434953">)</span>&nbsp;<span class="ident" id="4434955">item</span>&nbsp;<span class="op" id="4434960">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4434963">if</span>&nbsp;<span class="ident" id="4434966">t</span><span class="op" id="4434967">.</span><span class="ident" id="4434968">peekCount</span>&nbsp;<span class="op" id="4434978">&gt;</span>&nbsp;<span class="num" id="4434980">0</span>&nbsp;<span class="op" id="4434982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434986">t</span><span class="op" id="4434987">.</span><span class="ident" id="4434988">peekCount</span><span class="op" id="4434997">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4435001">}</span>&nbsp;<span class="keyword" id="4435003">else</span>&nbsp;<span class="op" id="4435008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435012">t</span><span class="op" id="4435013">.</span><span class="ident" id="4435014">token</span><span class="op" id="4435019">[</span><span class="num" id="4435020">0</span><span class="op" id="4435021">]</span>&nbsp;<span class="op" id="4435023">=</span>&nbsp;<span class="ident" id="4435025">t</span><span class="op" id="4435026">.</span><span class="ident" id="4435027">lex</span><span class="op" id="4435030">.</span><span class="ident" id="4435031">nextItem</span><span class="op" id="4435039">(</span><span class="op" id="4435040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4435043">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4435046">return</span>&nbsp;<span class="ident" id="4435053">t</span><span class="op" id="4435054">.</span><span class="ident" id="4435055">token</span><span class="op" id="4435060">[</span><span class="ident" id="4435061">t</span><span class="op" id="4435062">.</span><span class="ident" id="4435063">peekCount</span><span class="op" id="4435072">]</span><br>
<span class="lineno"></span><span class="op" id="4435074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4435077">//&nbsp;backup&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;one&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4435124">func</span>&nbsp;<span class="op" id="4435129">(</span><span class="ident" id="4435130">t</span>&nbsp;<span class="op" id="4435132">*</span><span class="ident" id="4435133">Tree</span><span class="op" id="4435137">)</span>&nbsp;<span class="ident" id="4435139">backup</span><span class="op" id="4435145">(</span><span class="op" id="4435146">)</span>&nbsp;<span class="op" id="4435148">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435151">t</span><span class="op" id="4435152">.</span><span class="ident" id="4435153">peekCount</span><span class="op" id="4435162">++</span><br>
<span class="lineno"></span><span class="op" id="4435165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4435168">//&nbsp;backup2&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;two&nbsp;tokens.</span><br>
<span class="lineno"></span><span class="comment" id="4435217">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno">75</span><span class="keyword" id="4435255">func</span>&nbsp;<span class="op" id="4435260">(</span><span class="ident" id="4435261">t</span>&nbsp;<span class="op" id="4435263">*</span><span class="ident" id="4435264">Tree</span><span class="op" id="4435268">)</span>&nbsp;<span class="ident" id="4435270">backup2</span><span class="op" id="4435277">(</span><span class="ident" id="4435278">t1</span>&nbsp;<span class="ident" id="4435281">item</span><span class="op" id="4435285">)</span>&nbsp;<span class="op" id="4435287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435290">t</span><span class="op" id="4435291">.</span><span class="ident" id="4435292">token</span><span class="op" id="4435297">[</span><span class="num" id="4435298">1</span><span class="op" id="4435299">]</span>&nbsp;<span class="op" id="4435301">=</span>&nbsp;<span class="ident" id="4435303">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435307">t</span><span class="op" id="4435308">.</span><span class="ident" id="4435309">peekCount</span>&nbsp;<span class="op" id="4435319">=</span>&nbsp;<span class="num" id="4435321">2</span><br>
<span class="lineno"></span><span class="op" id="4435323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="4435326">//&nbsp;backup3&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;three&nbsp;tokens</span><br>
<span class="lineno"></span><span class="comment" id="4435376">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno"></span><span class="keyword" id="4435414">func</span>&nbsp;<span class="op" id="4435419">(</span><span class="ident" id="4435420">t</span>&nbsp;<span class="op" id="4435422">*</span><span class="ident" id="4435423">Tree</span><span class="op" id="4435427">)</span>&nbsp;<span class="ident" id="4435429">backup3</span><span class="op" id="4435436">(</span><span class="ident" id="4435437">t2</span><span class="op" id="4435439">,</span>&nbsp;<span class="ident" id="4435441">t1</span>&nbsp;<span class="ident" id="4435444">item</span><span class="op" id="4435448">)</span>&nbsp;<span class="op" id="4435450">{</span>&nbsp;<span class="comment" id="4435452">//&nbsp;Reverse&nbsp;order:&nbsp;we&#39;re&nbsp;pushing&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435491">t</span><span class="op" id="4435492">.</span><span class="ident" id="4435493">token</span><span class="op" id="4435498">[</span><span class="num" id="4435499">1</span><span class="op" id="4435500">]</span>&nbsp;<span class="op" id="4435502">=</span>&nbsp;<span class="ident" id="4435504">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435508">t</span><span class="op" id="4435509">.</span><span class="ident" id="4435510">token</span><span class="op" id="4435515">[</span><span class="num" id="4435516">2</span><span class="op" id="4435517">]</span>&nbsp;<span class="op" id="4435519">=</span>&nbsp;<span class="ident" id="4435521">t2</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435525">t</span><span class="op" id="4435526">.</span><span class="ident" id="4435527">peekCount</span>&nbsp;<span class="op" id="4435537">=</span>&nbsp;<span class="num" id="4435539">3</span><br>
<span class="lineno"></span><span class="op" id="4435541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4435544">//&nbsp;peek&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4435597">func</span>&nbsp;<span class="op" id="4435602">(</span><span class="ident" id="4435603">t</span>&nbsp;<span class="op" id="4435605">*</span><span class="ident" id="4435606">Tree</span><span class="op" id="4435610">)</span>&nbsp;<span class="ident" id="4435612">peek</span><span class="op" id="4435616">(</span><span class="op" id="4435617">)</span>&nbsp;<span class="ident" id="4435619">item</span>&nbsp;<span class="op" id="4435624">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4435627">if</span>&nbsp;<span class="ident" id="4435630">t</span><span class="op" id="4435631">.</span><span class="ident" id="4435632">peekCount</span>&nbsp;<span class="op" id="4435642">&gt;</span>&nbsp;<span class="num" id="4435644">0</span>&nbsp;<span class="op" id="4435646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4435650">return</span>&nbsp;<span class="ident" id="4435657">t</span><span class="op" id="4435658">.</span><span class="ident" id="4435659">token</span><span class="op" id="4435664">[</span><span class="ident" id="4435665">t</span><span class="op" id="4435666">.</span><span class="ident" id="4435667">peekCount</span><span class="op" id="4435676">-</span><span class="num" id="4435677">1</span><span class="op" id="4435678">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4435681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435684">t</span><span class="op" id="4435685">.</span><span class="ident" id="4435686">peekCount</span>&nbsp;<span class="op" id="4435696">=</span>&nbsp;<span class="num" id="4435698">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435701">t</span><span class="op" id="4435702">.</span><span class="ident" id="4435703">token</span><span class="op" id="4435708">[</span><span class="num" id="4435709">0</span><span class="op" id="4435710">]</span>&nbsp;<span class="op" id="4435712">=</span>&nbsp;<span class="ident" id="4435714">t</span><span class="op" id="4435715">.</span><span class="ident" id="4435716">lex</span><span class="op" id="4435719">.</span><span class="ident" id="4435720">nextItem</span><span class="op" id="4435728">(</span><span class="op" id="4435729">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4435732">return</span>&nbsp;<span class="ident" id="4435739">t</span><span class="op" id="4435740">.</span><span class="ident" id="4435741">token</span><span class="op" id="4435746">[</span><span class="num" id="4435747">0</span><span class="op" id="4435748">]</span><br>
<span class="lineno"></span><span class="op" id="4435750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4435753">//&nbsp;nextNonSpace&nbsp;returns&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4435803">func</span>&nbsp;<span class="op" id="4435808">(</span><span class="ident" id="4435809">t</span>&nbsp;<span class="op" id="4435811">*</span><span class="ident" id="4435812">Tree</span><span class="op" id="4435816">)</span>&nbsp;<span class="ident" id="4435818">nextNonSpace</span><span class="op" id="4435830">(</span><span class="op" id="4435831">)</span>&nbsp;<span class="op" id="4435833">(</span><span class="ident" id="4435834">token</span>&nbsp;<span class="ident" id="4435840">item</span><span class="op" id="4435844">)</span>&nbsp;<span class="op" id="4435846">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4435849">for</span>&nbsp;<span class="op" id="4435853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435857">token</span>&nbsp;<span class="op" id="4435863">=</span>&nbsp;<span class="ident" id="4435865">t</span><span class="op" id="4435866">.</span><span class="ident" id="4435867">next</span><span class="op" id="4435871">(</span><span class="op" id="4435872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4435876">if</span>&nbsp;<span class="ident" id="4435879">token</span><span class="op" id="4435884">.</span><span class="ident" id="4435885">typ</span>&nbsp;<span class="op" id="4435889">!=</span>&nbsp;<span class="ident" id="4435892">itemSpace</span>&nbsp;<span class="op" id="4435902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4435907">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4435915">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4435918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4435921">return</span>&nbsp;<span class="ident" id="4435928">token</span><br>
<span class="lineno"></span><span class="op" id="4435934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4435937">//&nbsp;peekNonSpace&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno">110</span><span class="keyword" id="4436008">func</span>&nbsp;<span class="op" id="4436013">(</span><span class="ident" id="4436014">t</span>&nbsp;<span class="op" id="4436016">*</span><span class="ident" id="4436017">Tree</span><span class="op" id="4436021">)</span>&nbsp;<span class="ident" id="4436023">peekNonSpace</span><span class="op" id="4436035">(</span><span class="op" id="4436036">)</span>&nbsp;<span class="op" id="4436038">(</span><span class="ident" id="4436039">token</span>&nbsp;<span class="ident" id="4436045">item</span><span class="op" id="4436049">)</span>&nbsp;<span class="op" id="4436051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436054">for</span>&nbsp;<span class="op" id="4436058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436062">token</span>&nbsp;<span class="op" id="4436068">=</span>&nbsp;<span class="ident" id="4436070">t</span><span class="op" id="4436071">.</span><span class="ident" id="4436072">next</span><span class="op" id="4436076">(</span><span class="op" id="4436077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436081">if</span>&nbsp;<span class="ident" id="4436084">token</span><span class="op" id="4436089">.</span><span class="ident" id="4436090">typ</span>&nbsp;<span class="op" id="4436094">!=</span>&nbsp;<span class="ident" id="4436097">itemSpace</span>&nbsp;<span class="op" id="4436107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436112">break</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4436120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4436123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436126">t</span><span class="op" id="4436127">.</span><span class="ident" id="4436128">backup</span><span class="op" id="4436134">(</span><span class="op" id="4436135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436138">return</span>&nbsp;<span class="ident" id="4436145">token</span><br>
<span class="lineno"></span><span class="op" id="4436151">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="4436154">//&nbsp;Parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4436167">//&nbsp;New&nbsp;allocates&nbsp;a&nbsp;new&nbsp;parse&nbsp;tree&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="4436222">func</span>&nbsp;<span class="ident" id="4436227">New</span><span class="op" id="4436230">(</span><span class="ident" id="4436231">name</span>&nbsp;<span class="builtintype" id="4436236">string</span><span class="op" id="4436242">,</span>&nbsp;<span class="ident" id="4436244">funcs</span>&nbsp;<span class="op" id="4436250">...</span><span class="keyword" id="4436253">map</span><span class="op" id="4436256">[</span><span class="builtintype" id="4436257">string</span><span class="op" id="4436263">]</span><span class="keyword" id="4436264">interface</span><span class="op" id="4436273">{</span><span class="op" id="4436274">}</span><span class="op" id="4436275">)</span>&nbsp;<span class="op" id="4436277">*</span><span class="ident" id="4436278">Tree</span>&nbsp;<span class="op" id="4436283">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436286">return</span>&nbsp;<span class="op" id="4436293">&amp;</span><span class="ident" id="4436294">Tree</span><span class="op" id="4436298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436302">Name</span><span class="op" id="4436306">:</span>&nbsp;&nbsp;<span class="ident" id="4436309">name</span><span class="op" id="4436313">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436317">funcs</span><span class="op" id="4436322">:</span>&nbsp;<span class="ident" id="4436324">funcs</span><span class="op" id="4436329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4436332">}</span><br>
<span class="lineno"></span><span class="op" id="4436334">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="4436337">//&nbsp;ErrorContext&nbsp;returns&nbsp;a&nbsp;textual&nbsp;representation&nbsp;of&nbsp;the&nbsp;location&nbsp;of&nbsp;the&nbsp;node&nbsp;in&nbsp;the&nbsp;input&nbsp;text.</span><br>
<span class="lineno"></span><span class="comment" id="4436433">//&nbsp;The&nbsp;receiver&nbsp;is&nbsp;only&nbsp;used&nbsp;when&nbsp;the&nbsp;node&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;tree&nbsp;inside,</span><br>
<span class="lineno"></span><span class="comment" id="4436520">//&nbsp;which&nbsp;can&nbsp;occur&nbsp;in&nbsp;old&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="4436552">func</span>&nbsp;<span class="op" id="4436557">(</span><span class="ident" id="4436558">t</span>&nbsp;<span class="op" id="4436560">*</span><span class="ident" id="4436561">Tree</span><span class="op" id="4436565">)</span>&nbsp;<span class="ident" id="4436567">ErrorContext</span><span class="op" id="4436579">(</span><span class="ident" id="4436580">n</span>&nbsp;<span class="ident" id="4436582">Node</span><span class="op" id="4436586">)</span>&nbsp;<span class="op" id="4436588">(</span><span class="ident" id="4436589">location</span><span class="op" id="4436597">,</span>&nbsp;<span class="ident" id="4436599">context</span>&nbsp;<span class="builtintype" id="4436607">string</span><span class="op" id="4436613">)</span>&nbsp;<span class="op" id="4436615">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436618">pos</span>&nbsp;<span class="op" id="4436622">:=</span>&nbsp;<span class="builtintype" id="4436625">int</span><span class="op" id="4436628">(</span><span class="ident" id="4436629">n</span><span class="op" id="4436630">.</span><span class="ident" id="4436631">Position</span><span class="op" id="4436639">(</span><span class="op" id="4436640">)</span><span class="op" id="4436641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436644">tree</span>&nbsp;<span class="op" id="4436649">:=</span>&nbsp;<span class="ident" id="4436652">n</span><span class="op" id="4436653">.</span><span class="ident" id="4436654">tree</span><span class="op" id="4436658">(</span><span class="op" id="4436659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436662">if</span>&nbsp;<span class="ident" id="4436665">tree</span>&nbsp;<span class="op" id="4436670">==</span>&nbsp;<span class="builtintype" id="4436673">nil</span>&nbsp;<span class="op" id="4436677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436681">tree</span>&nbsp;<span class="op" id="4436686">=</span>&nbsp;<span class="ident" id="4436688">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4436691">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436694">text</span>&nbsp;<span class="op" id="4436699">:=</span>&nbsp;<span class="ident" id="4436702">tree</span><span class="op" id="4436706">.</span><span class="ident" id="4436707">text</span><span class="op" id="4436711">[</span><span class="op" id="4436712">:</span><span class="ident" id="4436713">pos</span><span class="op" id="4436716">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436719">byteNum</span>&nbsp;<span class="op" id="4436727">:=</span>&nbsp;<span class="ident" id="4436730">strings</span><span class="op" id="4436737">.</span><span class="ident" id="4436738">LastIndex</span><span class="op" id="4436747">(</span><span class="ident" id="4436748">text</span><span class="op" id="4436752">,</span>&nbsp;<span class="string" id="4436754">&#34;\n&#34;</span><span class="op" id="4436758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436761">if</span>&nbsp;<span class="ident" id="4436764">byteNum</span>&nbsp;<span class="op" id="4436772">==</span>&nbsp;<span class="op" id="4436775">-</span><span class="num" id="4436776">1</span>&nbsp;<span class="op" id="4436778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436782">byteNum</span>&nbsp;<span class="op" id="4436790">=</span>&nbsp;<span class="ident" id="4436792">pos</span>&nbsp;<span class="comment" id="4436796">//&nbsp;On&nbsp;first&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4436815">}</span>&nbsp;<span class="keyword" id="4436817">else</span>&nbsp;<span class="op" id="4436822">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436826">byteNum</span><span class="op" id="4436833">++</span>&nbsp;<span class="comment" id="4436836">//&nbsp;After&nbsp;the&nbsp;newline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436860">byteNum</span>&nbsp;<span class="op" id="4436868">=</span>&nbsp;<span class="ident" id="4436870">pos</span>&nbsp;<span class="op" id="4436874">-</span>&nbsp;<span class="ident" id="4436876">byteNum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4436885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436888">lineNum</span>&nbsp;<span class="op" id="4436896">:=</span>&nbsp;<span class="num" id="4436899">1</span>&nbsp;<span class="op" id="4436901">+</span>&nbsp;<span class="ident" id="4436903">strings</span><span class="op" id="4436910">.</span><span class="ident" id="4436911">Count</span><span class="op" id="4436916">(</span><span class="ident" id="4436917">text</span><span class="op" id="4436921">,</span>&nbsp;<span class="string" id="4436923">&#34;\n&#34;</span><span class="op" id="4436927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436930">context</span>&nbsp;<span class="op" id="4436938">=</span>&nbsp;<span class="ident" id="4436940">n</span><span class="op" id="4436941">.</span><span class="ident" id="4436942">String</span><span class="op" id="4436948">(</span><span class="op" id="4436949">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436952">if</span>&nbsp;<span class="builtinfunc" id="4436955">len</span><span class="op" id="4436958">(</span><span class="ident" id="4436959">context</span><span class="op" id="4436966">)</span>&nbsp;<span class="op" id="4436968">&gt;</span>&nbsp;<span class="num" id="4436970">20</span>&nbsp;<span class="op" id="4436973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436977">context</span>&nbsp;<span class="op" id="4436985">=</span>&nbsp;<span class="ident" id="4436987">fmt</span><span class="op" id="4436990">.</span><span class="ident" id="4436991">Sprintf</span><span class="op" id="4436998">(</span><span class="string" id="4436999">&#34;%.20s...&#34;</span><span class="op" id="4437009">,</span>&nbsp;<span class="ident" id="4437011">context</span><span class="op" id="4437018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4437021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4437024">return</span>&nbsp;<span class="ident" id="4437031">fmt</span><span class="op" id="4437034">.</span><span class="ident" id="4437035">Sprintf</span><span class="op" id="4437042">(</span><span class="string" id="4437043">&#34;%s:%d:%d&#34;</span><span class="op" id="4437053">,</span>&nbsp;<span class="ident" id="4437055">tree</span><span class="op" id="4437059">.</span><span class="ident" id="4437060">ParseName</span><span class="op" id="4437069">,</span>&nbsp;<span class="ident" id="4437071">lineNum</span><span class="op" id="4437078">,</span>&nbsp;<span class="ident" id="4437080">byteNum</span><span class="op" id="4437087">)</span><span class="op" id="4437088">,</span>&nbsp;<span class="ident" id="4437090">context</span><br>
<span class="lineno"></span><span class="op" id="4437098">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4437101">//&nbsp;errorf&nbsp;formats&nbsp;the&nbsp;error&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="4437156">func</span>&nbsp;<span class="op" id="4437161">(</span><span class="ident" id="4437162">t</span>&nbsp;<span class="op" id="4437164">*</span><span class="ident" id="4437165">Tree</span><span class="op" id="4437169">)</span>&nbsp;<span class="ident" id="4437171">errorf</span><span class="op" id="4437177">(</span><span class="ident" id="4437178">format</span>&nbsp;<span class="builtintype" id="4437185">string</span><span class="op" id="4437191">,</span>&nbsp;<span class="ident" id="4437193">args</span>&nbsp;<span class="op" id="4437198">...</span><span class="keyword" id="4437201">interface</span><span class="op" id="4437210">{</span><span class="op" id="4437211">}</span><span class="op" id="4437212">)</span>&nbsp;<span class="op" id="4437214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437217">t</span><span class="op" id="4437218">.</span><span class="ident" id="4437219">Root</span>&nbsp;<span class="op" id="4437224">=</span>&nbsp;<span class="builtintype" id="4437226">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437231">format</span>&nbsp;<span class="op" id="4437238">=</span>&nbsp;<span class="ident" id="4437240">fmt</span><span class="op" id="4437243">.</span><span class="ident" id="4437244">Sprintf</span><span class="op" id="4437251">(</span><span class="string" id="4437252">&#34;template:&nbsp;%s:%d:&nbsp;%s&#34;</span><span class="op" id="4437273">,</span>&nbsp;<span class="ident" id="4437275">t</span><span class="op" id="4437276">.</span><span class="ident" id="4437277">ParseName</span><span class="op" id="4437286">,</span>&nbsp;<span class="ident" id="4437288">t</span><span class="op" id="4437289">.</span><span class="ident" id="4437290">lex</span><span class="op" id="4437293">.</span><span class="ident" id="4437294">lineNumber</span><span class="op" id="4437304">(</span><span class="op" id="4437305">)</span><span class="op" id="4437306">,</span>&nbsp;<span class="ident" id="4437308">format</span><span class="op" id="4437314">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4437317">panic</span><span class="op" id="4437322">(</span><span class="ident" id="4437323">fmt</span><span class="op" id="4437326">.</span><span class="ident" id="4437327">Errorf</span><span class="op" id="4437333">(</span><span class="ident" id="4437334">format</span><span class="op" id="4437340">,</span>&nbsp;<span class="ident" id="4437342">args</span><span class="op" id="4437346">...</span><span class="op" id="4437349">)</span><span class="op" id="4437350">)</span><br>
<span class="lineno"></span><span class="op" id="4437352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4437355">//&nbsp;error&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="4437387">func</span>&nbsp;<span class="op" id="4437392">(</span><span class="ident" id="4437393">t</span>&nbsp;<span class="op" id="4437395">*</span><span class="ident" id="4437396">Tree</span><span class="op" id="4437400">)</span>&nbsp;<span class="builtintype" id="4437402">error</span><span class="op" id="4437407">(</span><span class="ident" id="4437408">err</span>&nbsp;<span class="builtintype" id="4437412">error</span><span class="op" id="4437417">)</span>&nbsp;<span class="op" id="4437419">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437422">t</span><span class="op" id="4437423">.</span><span class="ident" id="4437424">errorf</span><span class="op" id="4437430">(</span><span class="string" id="4437431">&#34;%s&#34;</span><span class="op" id="4437435">,</span>&nbsp;<span class="ident" id="4437437">err</span><span class="op" id="4437440">)</span><br>
<span class="lineno"></span><span class="op" id="4437442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4437445">//&nbsp;expect&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;the&nbsp;required&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4437520">func</span>&nbsp;<span class="op" id="4437525">(</span><span class="ident" id="4437526">t</span>&nbsp;<span class="op" id="4437528">*</span><span class="ident" id="4437529">Tree</span><span class="op" id="4437533">)</span>&nbsp;<span class="ident" id="4437535">expect</span><span class="op" id="4437541">(</span><span class="ident" id="4437542">expected</span>&nbsp;<span class="ident" id="4437551">itemType</span><span class="op" id="4437559">,</span>&nbsp;<span class="ident" id="4437561">context</span>&nbsp;<span class="builtintype" id="4437569">string</span><span class="op" id="4437575">)</span>&nbsp;<span class="ident" id="4437577">item</span>&nbsp;<span class="op" id="4437582">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437585">token</span>&nbsp;<span class="op" id="4437591">:=</span>&nbsp;<span class="ident" id="4437594">t</span><span class="op" id="4437595">.</span><span class="ident" id="4437596">nextNonSpace</span><span class="op" id="4437608">(</span><span class="op" id="4437609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4437612">if</span>&nbsp;<span class="ident" id="4437615">token</span><span class="op" id="4437620">.</span><span class="ident" id="4437621">typ</span>&nbsp;<span class="op" id="4437625">!=</span>&nbsp;<span class="ident" id="4437628">expected</span>&nbsp;<span class="op" id="4437637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437641">t</span><span class="op" id="4437642">.</span><span class="ident" id="4437643">unexpected</span><span class="op" id="4437653">(</span><span class="ident" id="4437654">token</span><span class="op" id="4437659">,</span>&nbsp;<span class="ident" id="4437661">context</span><span class="op" id="4437668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4437671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4437674">return</span>&nbsp;<span class="ident" id="4437681">token</span><br>
<span class="lineno">175</span><span class="op" id="4437687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4437690">//&nbsp;expectOneOf&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;one&nbsp;of&nbsp;the&nbsp;required&nbsp;types.</span><br>
<span class="lineno"></span><span class="keyword" id="4437778">func</span>&nbsp;<span class="op" id="4437783">(</span><span class="ident" id="4437784">t</span>&nbsp;<span class="op" id="4437786">*</span><span class="ident" id="4437787">Tree</span><span class="op" id="4437791">)</span>&nbsp;<span class="ident" id="4437793">expectOneOf</span><span class="op" id="4437804">(</span><span class="ident" id="4437805">expected1</span><span class="op" id="4437814">,</span>&nbsp;<span class="ident" id="4437816">expected2</span>&nbsp;<span class="ident" id="4437826">itemType</span><span class="op" id="4437834">,</span>&nbsp;<span class="ident" id="4437836">context</span>&nbsp;<span class="builtintype" id="4437844">string</span><span class="op" id="4437850">)</span>&nbsp;<span class="ident" id="4437852">item</span>&nbsp;<span class="op" id="4437857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437860">token</span>&nbsp;<span class="op" id="4437866">:=</span>&nbsp;<span class="ident" id="4437869">t</span><span class="op" id="4437870">.</span><span class="ident" id="4437871">nextNonSpace</span><span class="op" id="4437883">(</span><span class="op" id="4437884">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4437887">if</span>&nbsp;<span class="ident" id="4437890">token</span><span class="op" id="4437895">.</span><span class="ident" id="4437896">typ</span>&nbsp;<span class="op" id="4437900">!=</span>&nbsp;<span class="ident" id="4437903">expected1</span>&nbsp;<span class="op" id="4437913">&amp;&amp;</span>&nbsp;<span class="ident" id="4437916">token</span><span class="op" id="4437921">.</span><span class="ident" id="4437922">typ</span>&nbsp;<span class="op" id="4437926">!=</span>&nbsp;<span class="ident" id="4437929">expected2</span>&nbsp;<span class="op" id="4437939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437943">t</span><span class="op" id="4437944">.</span><span class="ident" id="4437945">unexpected</span><span class="op" id="4437955">(</span><span class="ident" id="4437956">token</span><span class="op" id="4437961">,</span>&nbsp;<span class="ident" id="4437963">context</span><span class="op" id="4437970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4437973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4437976">return</span>&nbsp;<span class="ident" id="4437983">token</span><br>
<span class="lineno"></span><span class="op" id="4437989">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="comment" id="4437992">//&nbsp;unexpected&nbsp;complains&nbsp;about&nbsp;the&nbsp;token&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="4438059">func</span>&nbsp;<span class="op" id="4438064">(</span><span class="ident" id="4438065">t</span>&nbsp;<span class="op" id="4438067">*</span><span class="ident" id="4438068">Tree</span><span class="op" id="4438072">)</span>&nbsp;<span class="ident" id="4438074">unexpected</span><span class="op" id="4438084">(</span><span class="ident" id="4438085">token</span>&nbsp;<span class="ident" id="4438091">item</span><span class="op" id="4438095">,</span>&nbsp;<span class="ident" id="4438097">context</span>&nbsp;<span class="builtintype" id="4438105">string</span><span class="op" id="4438111">)</span>&nbsp;<span class="op" id="4438113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438116">t</span><span class="op" id="4438117">.</span><span class="ident" id="4438118">errorf</span><span class="op" id="4438124">(</span><span class="string" id="4438125">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="4438146">,</span>&nbsp;<span class="ident" id="4438148">token</span><span class="op" id="4438153">,</span>&nbsp;<span class="ident" id="4438155">context</span><span class="op" id="4438162">)</span><br>
<span class="lineno"></span><span class="op" id="4438164">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="4438167">//&nbsp;recover&nbsp;is&nbsp;the&nbsp;handler&nbsp;that&nbsp;turns&nbsp;panics&nbsp;into&nbsp;returns&nbsp;from&nbsp;the&nbsp;top&nbsp;level&nbsp;of&nbsp;Parse.</span><br>
<span class="lineno"></span><span class="keyword" id="4438253">func</span>&nbsp;<span class="op" id="4438258">(</span><span class="ident" id="4438259">t</span>&nbsp;<span class="op" id="4438261">*</span><span class="ident" id="4438262">Tree</span><span class="op" id="4438266">)</span>&nbsp;<span class="builtinfunc" id="4438268">recover</span><span class="op" id="4438275">(</span><span class="ident" id="4438276">errp</span>&nbsp;<span class="op" id="4438281">*</span><span class="builtintype" id="4438282">error</span><span class="op" id="4438287">)</span>&nbsp;<span class="op" id="4438289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438292">e</span>&nbsp;<span class="op" id="4438294">:=</span>&nbsp;<span class="builtinfunc" id="4438297">recover</span><span class="op" id="4438304">(</span><span class="op" id="4438305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4438308">if</span>&nbsp;<span class="ident" id="4438311">e</span>&nbsp;<span class="op" id="4438313">!=</span>&nbsp;<span class="builtintype" id="4438316">nil</span>&nbsp;<span class="op" id="4438320">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4438324">if</span>&nbsp;<span class="ident" id="4438327">_</span><span class="op" id="4438328">,</span>&nbsp;<span class="ident" id="4438330">ok</span>&nbsp;<span class="op" id="4438333">:=</span>&nbsp;<span class="ident" id="4438336">e</span><span class="op" id="4438337">.</span><span class="op" id="4438338">(</span><span class="ident" id="4438339">runtime</span><span class="op" id="4438346">.</span><span class="ident" id="4438347">Error</span><span class="op" id="4438352">)</span><span class="op" id="4438353">;</span>&nbsp;<span class="ident" id="4438355">ok</span>&nbsp;<span class="op" id="4438358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4438363">panic</span><span class="op" id="4438368">(</span><span class="ident" id="4438369">e</span><span class="op" id="4438370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4438374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4438378">if</span>&nbsp;<span class="ident" id="4438381">t</span>&nbsp;<span class="op" id="4438383">!=</span>&nbsp;<span class="builtintype" id="4438386">nil</span>&nbsp;<span class="op" id="4438390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438395">t</span><span class="op" id="4438396">.</span><span class="ident" id="4438397">stopParse</span><span class="op" id="4438406">(</span><span class="op" id="4438407">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4438411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4438415">*</span><span class="ident" id="4438416">errp</span>&nbsp;<span class="op" id="4438421">=</span>&nbsp;<span class="ident" id="4438423">e</span><span class="op" id="4438424">.</span><span class="op" id="4438425">(</span><span class="builtintype" id="4438426">error</span><span class="op" id="4438431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4438434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4438437">return</span><br>
<span class="lineno"></span><span class="op" id="4438444">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="4438447">//&nbsp;startParse&nbsp;initializes&nbsp;the&nbsp;parser,&nbsp;using&nbsp;the&nbsp;lexer.</span><br>
<span class="lineno"></span><span class="keyword" id="4438502">func</span>&nbsp;<span class="op" id="4438507">(</span><span class="ident" id="4438508">t</span>&nbsp;<span class="op" id="4438510">*</span><span class="ident" id="4438511">Tree</span><span class="op" id="4438515">)</span>&nbsp;<span class="ident" id="4438517">startParse</span><span class="op" id="4438527">(</span><span class="ident" id="4438528">funcs</span>&nbsp;<span class="op" id="4438534">[</span><span class="op" id="4438535">]</span><span class="keyword" id="4438536">map</span><span class="op" id="4438539">[</span><span class="builtintype" id="4438540">string</span><span class="op" id="4438546">]</span><span class="keyword" id="4438547">interface</span><span class="op" id="4438556">{</span><span class="op" id="4438557">}</span><span class="op" id="4438558">,</span>&nbsp;<span class="ident" id="4438560">lex</span>&nbsp;<span class="op" id="4438564">*</span><span class="ident" id="4438565">lexer</span><span class="op" id="4438570">)</span>&nbsp;<span class="op" id="4438572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438575">t</span><span class="op" id="4438576">.</span><span class="ident" id="4438577">Root</span>&nbsp;<span class="op" id="4438582">=</span>&nbsp;<span class="builtintype" id="4438584">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438589">t</span><span class="op" id="4438590">.</span><span class="ident" id="4438591">lex</span>&nbsp;<span class="op" id="4438595">=</span>&nbsp;<span class="ident" id="4438597">lex</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438602">t</span><span class="op" id="4438603">.</span><span class="ident" id="4438604">vars</span>&nbsp;<span class="op" id="4438609">=</span>&nbsp;<span class="op" id="4438611">[</span><span class="op" id="4438612">]</span><span class="builtintype" id="4438613">string</span><span class="op" id="4438619">{</span><span class="string" id="4438620">&#34;$&#34;</span><span class="op" id="4438623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438626">t</span><span class="op" id="4438627">.</span><span class="ident" id="4438628">funcs</span>&nbsp;<span class="op" id="4438634">=</span>&nbsp;<span class="ident" id="4438636">funcs</span><br>
<span class="lineno"></span><span class="op" id="4438642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4438645">//&nbsp;stopParse&nbsp;terminates&nbsp;parsing.</span><br>
<span class="lineno">215</span><span class="keyword" id="4438678">func</span>&nbsp;<span class="op" id="4438683">(</span><span class="ident" id="4438684">t</span>&nbsp;<span class="op" id="4438686">*</span><span class="ident" id="4438687">Tree</span><span class="op" id="4438691">)</span>&nbsp;<span class="ident" id="4438693">stopParse</span><span class="op" id="4438702">(</span><span class="op" id="4438703">)</span>&nbsp;<span class="op" id="4438705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438708">t</span><span class="op" id="4438709">.</span><span class="ident" id="4438710">lex</span>&nbsp;<span class="op" id="4438714">=</span>&nbsp;<span class="builtintype" id="4438716">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438721">t</span><span class="op" id="4438722">.</span><span class="ident" id="4438723">vars</span>&nbsp;<span class="op" id="4438728">=</span>&nbsp;<span class="builtintype" id="4438730">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438735">t</span><span class="op" id="4438736">.</span><span class="ident" id="4438737">funcs</span>&nbsp;<span class="op" id="4438743">=</span>&nbsp;<span class="builtintype" id="4438745">nil</span><br>
<span class="lineno"></span><span class="op" id="4438749">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="4438752">//&nbsp;Parse&nbsp;parses&nbsp;the&nbsp;template&nbsp;definition&nbsp;string&nbsp;to&nbsp;construct&nbsp;a&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4438832">//&nbsp;the&nbsp;template&nbsp;for&nbsp;execution.&nbsp;If&nbsp;either&nbsp;action&nbsp;delimiter&nbsp;string&nbsp;is&nbsp;empty,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4438911">//&nbsp;default&nbsp;(&#34;{{&#34;&nbsp;or&nbsp;&#34;}}&#34;)&nbsp;is&nbsp;used.&nbsp;Embedded&nbsp;template&nbsp;definitions&nbsp;are&nbsp;added&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4438989">//&nbsp;the&nbsp;treeSet&nbsp;map.</span><br>
<span class="lineno">225</span><span class="keyword" id="4439009">func</span>&nbsp;<span class="op" id="4439014">(</span><span class="ident" id="4439015">t</span>&nbsp;<span class="op" id="4439017">*</span><span class="ident" id="4439018">Tree</span><span class="op" id="4439022">)</span>&nbsp;<span class="ident" id="4439024">Parse</span><span class="op" id="4439029">(</span><span class="ident" id="4439030">text</span><span class="op" id="4439034">,</span>&nbsp;<span class="ident" id="4439036">leftDelim</span><span class="op" id="4439045">,</span>&nbsp;<span class="ident" id="4439047">rightDelim</span>&nbsp;<span class="builtintype" id="4439058">string</span><span class="op" id="4439064">,</span>&nbsp;<span class="ident" id="4439066">treeSet</span>&nbsp;<span class="keyword" id="4439074">map</span><span class="op" id="4439077">[</span><span class="builtintype" id="4439078">string</span><span class="op" id="4439084">]</span><span class="op" id="4439085">*</span><span class="ident" id="4439086">Tree</span><span class="op" id="4439090">,</span>&nbsp;<span class="ident" id="4439092">funcs</span>&nbsp;<span class="op" id="4439098">...</span><span class="keyword" id="4439101">map</span><span class="op" id="4439104">[</span><span class="builtintype" id="4439105">string</span><span class="op" id="4439111">]</span><span class="keyword" id="4439112">interface</span><span class="op" id="4439121">{</span><span class="op" id="4439122">}</span><span class="op" id="4439123">)</span>&nbsp;<span class="op" id="4439125">(</span><span class="ident" id="4439126">tree</span>&nbsp;<span class="op" id="4439131">*</span><span class="ident" id="4439132">Tree</span><span class="op" id="4439136">,</span>&nbsp;<span class="ident" id="4439138">err</span>&nbsp;<span class="builtintype" id="4439142">error</span><span class="op" id="4439147">)</span>&nbsp;<span class="op" id="4439149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439152">defer</span>&nbsp;<span class="ident" id="4439158">t</span><span class="op" id="4439159">.</span><span class="builtinfunc" id="4439160">recover</span><span class="op" id="4439167">(</span><span class="op" id="4439168">&amp;</span><span class="ident" id="4439169">err</span><span class="op" id="4439172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439175">t</span><span class="op" id="4439176">.</span><span class="ident" id="4439177">ParseName</span>&nbsp;<span class="op" id="4439187">=</span>&nbsp;<span class="ident" id="4439189">t</span><span class="op" id="4439190">.</span><span class="ident" id="4439191">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439197">t</span><span class="op" id="4439198">.</span><span class="ident" id="4439199">startParse</span><span class="op" id="4439209">(</span><span class="ident" id="4439210">funcs</span><span class="op" id="4439215">,</span>&nbsp;<span class="ident" id="4439217">lex</span><span class="op" id="4439220">(</span><span class="ident" id="4439221">t</span><span class="op" id="4439222">.</span><span class="ident" id="4439223">Name</span><span class="op" id="4439227">,</span>&nbsp;<span class="ident" id="4439229">text</span><span class="op" id="4439233">,</span>&nbsp;<span class="ident" id="4439235">leftDelim</span><span class="op" id="4439244">,</span>&nbsp;<span class="ident" id="4439246">rightDelim</span><span class="op" id="4439256">)</span><span class="op" id="4439257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439260">t</span><span class="op" id="4439261">.</span><span class="ident" id="4439262">text</span>&nbsp;<span class="op" id="4439267">=</span>&nbsp;<span class="ident" id="4439269">text</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439275">t</span><span class="op" id="4439276">.</span><span class="ident" id="4439277">parse</span><span class="op" id="4439282">(</span><span class="ident" id="4439283">treeSet</span><span class="op" id="4439290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439293">t</span><span class="op" id="4439294">.</span><span class="ident" id="4439295">add</span><span class="op" id="4439298">(</span><span class="ident" id="4439299">treeSet</span><span class="op" id="4439306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439309">t</span><span class="op" id="4439310">.</span><span class="ident" id="4439311">stopParse</span><span class="op" id="4439320">(</span><span class="op" id="4439321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439324">return</span>&nbsp;<span class="ident" id="4439331">t</span><span class="op" id="4439332">,</span>&nbsp;<span class="builtintype" id="4439334">nil</span><br>
<span class="lineno"></span><span class="op" id="4439338">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="4439341">//&nbsp;add&nbsp;adds&nbsp;tree&nbsp;to&nbsp;the&nbsp;treeSet.</span><br>
<span class="lineno"></span><span class="keyword" id="4439374">func</span>&nbsp;<span class="op" id="4439379">(</span><span class="ident" id="4439380">t</span>&nbsp;<span class="op" id="4439382">*</span><span class="ident" id="4439383">Tree</span><span class="op" id="4439387">)</span>&nbsp;<span class="ident" id="4439389">add</span><span class="op" id="4439392">(</span><span class="ident" id="4439393">treeSet</span>&nbsp;<span class="keyword" id="4439401">map</span><span class="op" id="4439404">[</span><span class="builtintype" id="4439405">string</span><span class="op" id="4439411">]</span><span class="op" id="4439412">*</span><span class="ident" id="4439413">Tree</span><span class="op" id="4439417">)</span>&nbsp;<span class="op" id="4439419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439422">tree</span>&nbsp;<span class="op" id="4439427">:=</span>&nbsp;<span class="ident" id="4439430">treeSet</span><span class="op" id="4439437">[</span><span class="ident" id="4439438">t</span><span class="op" id="4439439">.</span><span class="ident" id="4439440">Name</span><span class="op" id="4439444">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439447">if</span>&nbsp;<span class="ident" id="4439450">tree</span>&nbsp;<span class="op" id="4439455">==</span>&nbsp;<span class="builtintype" id="4439458">nil</span>&nbsp;<span class="op" id="4439462">||</span>&nbsp;<span class="ident" id="4439465">IsEmptyTree</span><span class="op" id="4439476">(</span><span class="ident" id="4439477">tree</span><span class="op" id="4439481">.</span><span class="ident" id="4439482">Root</span><span class="op" id="4439486">)</span>&nbsp;<span class="op" id="4439488">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439492">treeSet</span><span class="op" id="4439499">[</span><span class="ident" id="4439500">t</span><span class="op" id="4439501">.</span><span class="ident" id="4439502">Name</span><span class="op" id="4439506">]</span>&nbsp;<span class="op" id="4439508">=</span>&nbsp;<span class="ident" id="4439510">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439514">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4439522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439525">if</span>&nbsp;<span class="op" id="4439528">!</span><span class="ident" id="4439529">IsEmptyTree</span><span class="op" id="4439540">(</span><span class="ident" id="4439541">t</span><span class="op" id="4439542">.</span><span class="ident" id="4439543">Root</span><span class="op" id="4439547">)</span>&nbsp;<span class="op" id="4439549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439553">t</span><span class="op" id="4439554">.</span><span class="ident" id="4439555">errorf</span><span class="op" id="4439561">(</span><span class="string" id="4439562">&#34;template:&nbsp;multiple&nbsp;definition&nbsp;of&nbsp;template&nbsp;%q&#34;</span><span class="op" id="4439608">,</span>&nbsp;<span class="ident" id="4439610">t</span><span class="op" id="4439611">.</span><span class="ident" id="4439612">Name</span><span class="op" id="4439616">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4439619">}</span><br>
<span class="lineno"></span><span class="op" id="4439621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4439624">//&nbsp;IsEmptyTree&nbsp;reports&nbsp;whether&nbsp;this&nbsp;tree&nbsp;(node)&nbsp;is&nbsp;empty&nbsp;of&nbsp;everything&nbsp;but&nbsp;space.</span><br>
<span class="lineno"></span><span class="keyword" id="4439706">func</span>&nbsp;<span class="ident" id="4439711">IsEmptyTree</span><span class="op" id="4439722">(</span><span class="ident" id="4439723">n</span>&nbsp;<span class="ident" id="4439725">Node</span><span class="op" id="4439729">)</span>&nbsp;<span class="builtintype" id="4439731">bool</span>&nbsp;<span class="op" id="4439736">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439739">switch</span>&nbsp;<span class="ident" id="4439746">n</span>&nbsp;<span class="op" id="4439748">:=</span>&nbsp;<span class="ident" id="4439751">n</span><span class="op" id="4439752">.</span><span class="op" id="4439753">(</span><span class="keyword" id="4439754">type</span><span class="op" id="4439758">)</span>&nbsp;<span class="op" id="4439760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439763">case</span>&nbsp;<span class="builtintype" id="4439768">nil</span><span class="op" id="4439771">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439775">return</span>&nbsp;<span class="builtintype" id="4439782">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439788">case</span>&nbsp;<span class="op" id="4439793">*</span><span class="ident" id="4439794">ActionNode</span><span class="op" id="4439804">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439807">case</span>&nbsp;<span class="op" id="4439812">*</span><span class="ident" id="4439813">IfNode</span><span class="op" id="4439819">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439822">case</span>&nbsp;<span class="op" id="4439827">*</span><span class="ident" id="4439828">ListNode</span><span class="op" id="4439836">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439840">for</span>&nbsp;<span class="ident" id="4439844">_</span><span class="op" id="4439845">,</span>&nbsp;<span class="ident" id="4439847">node</span>&nbsp;<span class="op" id="4439852">:=</span>&nbsp;<span class="keyword" id="4439855">range</span>&nbsp;<span class="ident" id="4439861">n</span><span class="op" id="4439862">.</span><span class="ident" id="4439863">Nodes</span>&nbsp;<span class="op" id="4439869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439874">if</span>&nbsp;<span class="op" id="4439877">!</span><span class="ident" id="4439878">IsEmptyTree</span><span class="op" id="4439889">(</span><span class="ident" id="4439890">node</span><span class="op" id="4439894">)</span>&nbsp;<span class="op" id="4439896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439902">return</span>&nbsp;<span class="builtintype" id="4439909">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4439918">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4439922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439926">return</span>&nbsp;<span class="builtintype" id="4439933">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439939">case</span>&nbsp;<span class="op" id="4439944">*</span><span class="ident" id="4439945">RangeNode</span><span class="op" id="4439954">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439957">case</span>&nbsp;<span class="op" id="4439962">*</span><span class="ident" id="4439963">TemplateNode</span><span class="op" id="4439975">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439978">case</span>&nbsp;<span class="op" id="4439983">*</span><span class="ident" id="4439984">TextNode</span><span class="op" id="4439992">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439996">return</span>&nbsp;<span class="builtinfunc" id="4440003">len</span><span class="op" id="4440006">(</span><span class="ident" id="4440007">bytes</span><span class="op" id="4440012">.</span><span class="ident" id="4440013">TrimSpace</span><span class="op" id="4440022">(</span><span class="ident" id="4440023">n</span><span class="op" id="4440024">.</span><span class="ident" id="4440025">Text</span><span class="op" id="4440029">)</span><span class="op" id="4440030">)</span>&nbsp;<span class="op" id="4440032">==</span>&nbsp;<span class="num" id="4440035">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440038">case</span>&nbsp;<span class="op" id="4440043">*</span><span class="ident" id="4440044">WithNode</span><span class="op" id="4440052">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440055">default</span><span class="op" id="4440062">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4440066">panic</span><span class="op" id="4440071">(</span><span class="string" id="4440072">&#34;unknown&nbsp;node:&nbsp;&#34;</span>&nbsp;<span class="op" id="4440089">+</span>&nbsp;<span class="ident" id="4440091">n</span><span class="op" id="4440092">.</span><span class="ident" id="4440093">String</span><span class="op" id="4440099">(</span><span class="op" id="4440100">)</span><span class="op" id="4440101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4440104">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440107">return</span>&nbsp;<span class="builtintype" id="4440114">false</span><br>
<span class="lineno"></span><span class="op" id="4440120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4440123">//&nbsp;parse&nbsp;is&nbsp;the&nbsp;top-level&nbsp;parser&nbsp;for&nbsp;a&nbsp;template,&nbsp;essentially&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="4440193">//&nbsp;as&nbsp;itemList&nbsp;except&nbsp;it&nbsp;also&nbsp;parses&nbsp;{{define}}&nbsp;actions.</span><br>
<span class="lineno">275</span><span class="comment" id="4440250">//&nbsp;It&nbsp;runs&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="4440269">func</span>&nbsp;<span class="op" id="4440274">(</span><span class="ident" id="4440275">t</span>&nbsp;<span class="op" id="4440277">*</span><span class="ident" id="4440278">Tree</span><span class="op" id="4440282">)</span>&nbsp;<span class="ident" id="4440284">parse</span><span class="op" id="4440289">(</span><span class="ident" id="4440290">treeSet</span>&nbsp;<span class="keyword" id="4440298">map</span><span class="op" id="4440301">[</span><span class="builtintype" id="4440302">string</span><span class="op" id="4440308">]</span><span class="op" id="4440309">*</span><span class="ident" id="4440310">Tree</span><span class="op" id="4440314">)</span>&nbsp;<span class="op" id="4440316">(</span><span class="ident" id="4440317">next</span>&nbsp;<span class="ident" id="4440322">Node</span><span class="op" id="4440326">)</span>&nbsp;<span class="op" id="4440328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4440331">t</span><span class="op" id="4440332">.</span><span class="ident" id="4440333">Root</span>&nbsp;<span class="op" id="4440338">=</span>&nbsp;<span class="ident" id="4440340">t</span><span class="op" id="4440341">.</span><span class="ident" id="4440342">newList</span><span class="op" id="4440349">(</span><span class="ident" id="4440350">t</span><span class="op" id="4440351">.</span><span class="ident" id="4440352">peek</span><span class="op" id="4440356">(</span><span class="op" id="4440357">)</span><span class="op" id="4440358">.</span><span class="ident" id="4440359">pos</span><span class="op" id="4440362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440365">for</span>&nbsp;<span class="ident" id="4440369">t</span><span class="op" id="4440370">.</span><span class="ident" id="4440371">peek</span><span class="op" id="4440375">(</span><span class="op" id="4440376">)</span><span class="op" id="4440377">.</span><span class="ident" id="4440378">typ</span>&nbsp;<span class="op" id="4440382">!=</span>&nbsp;<span class="ident" id="4440385">itemEOF</span>&nbsp;<span class="op" id="4440393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440397">if</span>&nbsp;<span class="ident" id="4440400">t</span><span class="op" id="4440401">.</span><span class="ident" id="4440402">peek</span><span class="op" id="4440406">(</span><span class="op" id="4440407">)</span><span class="op" id="4440408">.</span><span class="ident" id="4440409">typ</span>&nbsp;<span class="op" id="4440413">==</span>&nbsp;<span class="ident" id="4440416">itemLeftDelim</span>&nbsp;<span class="op" id="4440430">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4440435">delim</span>&nbsp;<span class="op" id="4440441">:=</span>&nbsp;<span class="ident" id="4440444">t</span><span class="op" id="4440445">.</span><span class="ident" id="4440446">next</span><span class="op" id="4440450">(</span><span class="op" id="4440451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440456">if</span>&nbsp;<span class="ident" id="4440459">t</span><span class="op" id="4440460">.</span><span class="ident" id="4440461">nextNonSpace</span><span class="op" id="4440473">(</span><span class="op" id="4440474">)</span><span class="op" id="4440475">.</span><span class="ident" id="4440476">typ</span>&nbsp;<span class="op" id="4440480">==</span>&nbsp;<span class="ident" id="4440483">itemDefine</span>&nbsp;<span class="op" id="4440494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4440500">newT</span>&nbsp;<span class="op" id="4440505">:=</span>&nbsp;<span class="ident" id="4440508">New</span><span class="op" id="4440511">(</span><span class="string" id="4440512">&#34;definition&#34;</span><span class="op" id="4440524">)</span>&nbsp;<span class="comment" id="4440526">//&nbsp;name&nbsp;will&nbsp;be&nbsp;updated&nbsp;once&nbsp;we&nbsp;know&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4440571">newT</span><span class="op" id="4440575">.</span><span class="ident" id="4440576">text</span>&nbsp;<span class="op" id="4440581">=</span>&nbsp;<span class="ident" id="4440583">t</span><span class="op" id="4440584">.</span><span class="ident" id="4440585">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4440594">newT</span><span class="op" id="4440598">.</span><span class="ident" id="4440599">ParseName</span>&nbsp;<span class="op" id="4440609">=</span>&nbsp;<span class="ident" id="4440611">t</span><span class="op" id="4440612">.</span><span class="ident" id="4440613">ParseName</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4440627">newT</span><span class="op" id="4440631">.</span><span class="ident" id="4440632">startParse</span><span class="op" id="4440642">(</span><span class="ident" id="4440643">t</span><span class="op" id="4440644">.</span><span class="ident" id="4440645">funcs</span><span class="op" id="4440650">,</span>&nbsp;<span class="ident" id="4440652">t</span><span class="op" id="4440653">.</span><span class="ident" id="4440654">lex</span><span class="op" id="4440657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4440663">newT</span><span class="op" id="4440667">.</span><span class="ident" id="4440668">parseDefinition</span><span class="op" id="4440683">(</span><span class="ident" id="4440684">treeSet</span><span class="op" id="4440691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440697">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4440709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4440714">t</span><span class="op" id="4440715">.</span><span class="ident" id="4440716">backup2</span><span class="op" id="4440723">(</span><span class="ident" id="4440724">delim</span><span class="op" id="4440729">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4440733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4440737">n</span>&nbsp;<span class="op" id="4440739">:=</span>&nbsp;<span class="ident" id="4440742">t</span><span class="op" id="4440743">.</span><span class="ident" id="4440744">textOrAction</span><span class="op" id="4440756">(</span><span class="op" id="4440757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440761">if</span>&nbsp;<span class="ident" id="4440764">n</span><span class="op" id="4440765">.</span><span class="ident" id="4440766">Type</span><span class="op" id="4440770">(</span><span class="op" id="4440771">)</span>&nbsp;<span class="op" id="4440773">==</span>&nbsp;<span class="ident" id="4440776">nodeEnd</span>&nbsp;<span class="op" id="4440784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4440789">t</span><span class="op" id="4440790">.</span><span class="ident" id="4440791">errorf</span><span class="op" id="4440797">(</span><span class="string" id="4440798">&#34;unexpected&nbsp;%s&#34;</span><span class="op" id="4440813">,</span>&nbsp;<span class="ident" id="4440815">n</span><span class="op" id="4440816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4440820">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4440824">t</span><span class="op" id="4440825">.</span><span class="ident" id="4440826">Root</span><span class="op" id="4440830">.</span><span class="builtinfunc" id="4440831">append</span><span class="op" id="4440837">(</span><span class="ident" id="4440838">n</span><span class="op" id="4440839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4440842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440845">return</span>&nbsp;<span class="builtintype" id="4440852">nil</span><br>
<span class="lineno"></span><span class="op" id="4440856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="4440859">//&nbsp;parseDefinition&nbsp;parses&nbsp;a&nbsp;{{define}}&nbsp;...&nbsp;&nbsp;{{end}}&nbsp;template&nbsp;definition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4440935">//&nbsp;installs&nbsp;the&nbsp;definition&nbsp;in&nbsp;the&nbsp;treeSet&nbsp;map.&nbsp;&nbsp;The&nbsp;&#34;define&#34;&nbsp;keyword&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="4441016">//&nbsp;been&nbsp;scanned.</span><br>
<span class="lineno"></span><span class="keyword" id="4441033">func</span>&nbsp;<span class="op" id="4441038">(</span><span class="ident" id="4441039">t</span>&nbsp;<span class="op" id="4441041">*</span><span class="ident" id="4441042">Tree</span><span class="op" id="4441046">)</span>&nbsp;<span class="ident" id="4441048">parseDefinition</span><span class="op" id="4441063">(</span><span class="ident" id="4441064">treeSet</span>&nbsp;<span class="keyword" id="4441072">map</span><span class="op" id="4441075">[</span><span class="builtintype" id="4441076">string</span><span class="op" id="4441082">]</span><span class="op" id="4441083">*</span><span class="ident" id="4441084">Tree</span><span class="op" id="4441088">)</span>&nbsp;<span class="op" id="4441090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441093">const</span>&nbsp;<span class="ident" id="4441099">context</span>&nbsp;<span class="op" id="4441107">=</span>&nbsp;<span class="string" id="4441109">&#34;define&nbsp;clause&#34;</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441126">name</span>&nbsp;<span class="op" id="4441131">:=</span>&nbsp;<span class="ident" id="4441134">t</span><span class="op" id="4441135">.</span><span class="ident" id="4441136">expectOneOf</span><span class="op" id="4441147">(</span><span class="ident" id="4441148">itemString</span><span class="op" id="4441158">,</span>&nbsp;<span class="ident" id="4441160">itemRawString</span><span class="op" id="4441173">,</span>&nbsp;<span class="ident" id="4441175">context</span><span class="op" id="4441182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441185">var</span>&nbsp;<span class="ident" id="4441189">err</span>&nbsp;<span class="builtintype" id="4441193">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441200">t</span><span class="op" id="4441201">.</span><span class="ident" id="4441202">Name</span><span class="op" id="4441206">,</span>&nbsp;<span class="ident" id="4441208">err</span>&nbsp;<span class="op" id="4441212">=</span>&nbsp;<span class="ident" id="4441214">strconv</span><span class="op" id="4441221">.</span><span class="ident" id="4441222">Unquote</span><span class="op" id="4441229">(</span><span class="ident" id="4441230">name</span><span class="op" id="4441234">.</span><span class="ident" id="4441235">val</span><span class="op" id="4441238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441241">if</span>&nbsp;<span class="ident" id="4441244">err</span>&nbsp;<span class="op" id="4441248">!=</span>&nbsp;<span class="builtintype" id="4441251">nil</span>&nbsp;<span class="op" id="4441255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441259">t</span><span class="op" id="4441260">.</span><span class="builtintype" id="4441261">error</span><span class="op" id="4441266">(</span><span class="ident" id="4441267">err</span><span class="op" id="4441270">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4441273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441276">t</span><span class="op" id="4441277">.</span><span class="ident" id="4441278">expect</span><span class="op" id="4441284">(</span><span class="ident" id="4441285">itemRightDelim</span><span class="op" id="4441299">,</span>&nbsp;<span class="ident" id="4441301">context</span><span class="op" id="4441308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441311">var</span>&nbsp;<span class="ident" id="4441315">end</span>&nbsp;<span class="ident" id="4441319">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441325">t</span><span class="op" id="4441326">.</span><span class="ident" id="4441327">Root</span><span class="op" id="4441331">,</span>&nbsp;<span class="ident" id="4441333">end</span>&nbsp;<span class="op" id="4441337">=</span>&nbsp;<span class="ident" id="4441339">t</span><span class="op" id="4441340">.</span><span class="ident" id="4441341">itemList</span><span class="op" id="4441349">(</span><span class="op" id="4441350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441353">if</span>&nbsp;<span class="ident" id="4441356">end</span><span class="op" id="4441359">.</span><span class="ident" id="4441360">Type</span><span class="op" id="4441364">(</span><span class="op" id="4441365">)</span>&nbsp;<span class="op" id="4441367">!=</span>&nbsp;<span class="ident" id="4441370">nodeEnd</span>&nbsp;<span class="op" id="4441378">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441382">t</span><span class="op" id="4441383">.</span><span class="ident" id="4441384">errorf</span><span class="op" id="4441390">(</span><span class="string" id="4441391">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="4441412">,</span>&nbsp;<span class="ident" id="4441414">end</span><span class="op" id="4441417">,</span>&nbsp;<span class="ident" id="4441419">context</span><span class="op" id="4441426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4441429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441432">t</span><span class="op" id="4441433">.</span><span class="ident" id="4441434">add</span><span class="op" id="4441437">(</span><span class="ident" id="4441438">treeSet</span><span class="op" id="4441445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441448">t</span><span class="op" id="4441449">.</span><span class="ident" id="4441450">stopParse</span><span class="op" id="4441459">(</span><span class="op" id="4441460">)</span><br>
<span class="lineno"></span><span class="op" id="4441462">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span><span class="comment" id="4441465">//&nbsp;itemList:</span><br>
<span class="lineno"></span><span class="comment" id="4441478">//&nbsp;&nbsp;&nbsp;&nbsp;textOrAction*</span><br>
<span class="lineno"></span><span class="comment" id="4441495">//&nbsp;Terminates&nbsp;at&nbsp;{{end}}&nbsp;or&nbsp;{{else}},&nbsp;returned&nbsp;separately.</span><br>
<span class="lineno"></span><span class="keyword" id="4441554">func</span>&nbsp;<span class="op" id="4441559">(</span><span class="ident" id="4441560">t</span>&nbsp;<span class="op" id="4441562">*</span><span class="ident" id="4441563">Tree</span><span class="op" id="4441567">)</span>&nbsp;<span class="ident" id="4441569">itemList</span><span class="op" id="4441577">(</span><span class="op" id="4441578">)</span>&nbsp;<span class="op" id="4441580">(</span><span class="ident" id="4441581">list</span>&nbsp;<span class="op" id="4441586">*</span><span class="ident" id="4441587">ListNode</span><span class="op" id="4441595">,</span>&nbsp;<span class="ident" id="4441597">next</span>&nbsp;<span class="ident" id="4441602">Node</span><span class="op" id="4441606">)</span>&nbsp;<span class="op" id="4441608">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441611">list</span>&nbsp;<span class="op" id="4441616">=</span>&nbsp;<span class="ident" id="4441618">t</span><span class="op" id="4441619">.</span><span class="ident" id="4441620">newList</span><span class="op" id="4441627">(</span><span class="ident" id="4441628">t</span><span class="op" id="4441629">.</span><span class="ident" id="4441630">peekNonSpace</span><span class="op" id="4441642">(</span><span class="op" id="4441643">)</span><span class="op" id="4441644">.</span><span class="ident" id="4441645">pos</span><span class="op" id="4441648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441651">for</span>&nbsp;<span class="ident" id="4441655">t</span><span class="op" id="4441656">.</span><span class="ident" id="4441657">peekNonSpace</span><span class="op" id="4441669">(</span><span class="op" id="4441670">)</span><span class="op" id="4441671">.</span><span class="ident" id="4441672">typ</span>&nbsp;<span class="op" id="4441676">!=</span>&nbsp;<span class="ident" id="4441679">itemEOF</span>&nbsp;<span class="op" id="4441687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441691">n</span>&nbsp;<span class="op" id="4441693">:=</span>&nbsp;<span class="ident" id="4441696">t</span><span class="op" id="4441697">.</span><span class="ident" id="4441698">textOrAction</span><span class="op" id="4441710">(</span><span class="op" id="4441711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441715">switch</span>&nbsp;<span class="ident" id="4441722">n</span><span class="op" id="4441723">.</span><span class="ident" id="4441724">Type</span><span class="op" id="4441728">(</span><span class="op" id="4441729">)</span>&nbsp;<span class="op" id="4441731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441735">case</span>&nbsp;<span class="ident" id="4441740">nodeEnd</span><span class="op" id="4441747">,</span>&nbsp;<span class="ident" id="4441749">nodeElse</span><span class="op" id="4441757">:</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441762">return</span>&nbsp;<span class="ident" id="4441769">list</span><span class="op" id="4441773">,</span>&nbsp;<span class="ident" id="4441775">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4441779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441783">list</span><span class="op" id="4441787">.</span><span class="builtinfunc" id="4441788">append</span><span class="op" id="4441794">(</span><span class="ident" id="4441795">n</span><span class="op" id="4441796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4441799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4441802">t</span><span class="op" id="4441803">.</span><span class="ident" id="4441804">errorf</span><span class="op" id="4441810">(</span><span class="string" id="4441811">&#34;unexpected&nbsp;EOF&#34;</span><span class="op" id="4441827">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441830">return</span><br>
<span class="lineno"></span><span class="op" id="4441837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4441840">//&nbsp;textOrAction:</span><br>
<span class="lineno"></span><span class="comment" id="4441857">//&nbsp;&nbsp;&nbsp;&nbsp;text&nbsp;|&nbsp;action</span><br>
<span class="lineno">340</span><span class="keyword" id="4441874">func</span>&nbsp;<span class="op" id="4441879">(</span><span class="ident" id="4441880">t</span>&nbsp;<span class="op" id="4441882">*</span><span class="ident" id="4441883">Tree</span><span class="op" id="4441887">)</span>&nbsp;<span class="ident" id="4441889">textOrAction</span><span class="op" id="4441901">(</span><span class="op" id="4441902">)</span>&nbsp;<span class="ident" id="4441904">Node</span>&nbsp;<span class="op" id="4441909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441912">switch</span>&nbsp;<span class="ident" id="4441919">token</span>&nbsp;<span class="op" id="4441925">:=</span>&nbsp;<span class="ident" id="4441928">t</span><span class="op" id="4441929">.</span><span class="ident" id="4441930">nextNonSpace</span><span class="op" id="4441942">(</span><span class="op" id="4441943">)</span><span class="op" id="4441944">;</span>&nbsp;<span class="ident" id="4441946">token</span><span class="op" id="4441951">.</span><span class="ident" id="4441952">typ</span>&nbsp;<span class="op" id="4441956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441959">case</span>&nbsp;<span class="ident" id="4441964">itemText</span><span class="op" id="4441972">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4441976">return</span>&nbsp;<span class="ident" id="4441983">t</span><span class="op" id="4441984">.</span><span class="ident" id="4441985">newText</span><span class="op" id="4441992">(</span><span class="ident" id="4441993">token</span><span class="op" id="4441998">.</span><span class="ident" id="4441999">pos</span><span class="op" id="4442002">,</span>&nbsp;<span class="ident" id="4442004">token</span><span class="op" id="4442009">.</span><span class="ident" id="4442010">val</span><span class="op" id="4442013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442016">case</span>&nbsp;<span class="ident" id="4442021">itemLeftDelim</span><span class="op" id="4442034">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442038">return</span>&nbsp;<span class="ident" id="4442045">t</span><span class="op" id="4442046">.</span><span class="ident" id="4442047">action</span><span class="op" id="4442053">(</span><span class="op" id="4442054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442057">default</span><span class="op" id="4442064">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4442068">t</span><span class="op" id="4442069">.</span><span class="ident" id="4442070">unexpected</span><span class="op" id="4442080">(</span><span class="ident" id="4442081">token</span><span class="op" id="4442086">,</span>&nbsp;<span class="string" id="4442088">&#34;input&#34;</span><span class="op" id="4442095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4442098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442101">return</span>&nbsp;<span class="builtintype" id="4442108">nil</span><br>
<span class="lineno">350</span><span class="op" id="4442112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4442115">//&nbsp;Action:</span><br>
<span class="lineno"></span><span class="comment" id="4442126">//&nbsp;&nbsp;&nbsp;&nbsp;control</span><br>
<span class="lineno"></span><span class="comment" id="4442137">//&nbsp;&nbsp;&nbsp;&nbsp;command&nbsp;(&#34;|&#34;&nbsp;command)*</span><br>
<span class="lineno">355</span><span class="comment" id="4442163">//&nbsp;Left&nbsp;delim&nbsp;is&nbsp;past.&nbsp;Now&nbsp;get&nbsp;actions.</span><br>
<span class="lineno"></span><span class="comment" id="4442203">//&nbsp;First&nbsp;word&nbsp;could&nbsp;be&nbsp;a&nbsp;keyword&nbsp;such&nbsp;as&nbsp;range.</span><br>
<span class="lineno"></span><span class="keyword" id="4442251">func</span>&nbsp;<span class="op" id="4442256">(</span><span class="ident" id="4442257">t</span>&nbsp;<span class="op" id="4442259">*</span><span class="ident" id="4442260">Tree</span><span class="op" id="4442264">)</span>&nbsp;<span class="ident" id="4442266">action</span><span class="op" id="4442272">(</span><span class="op" id="4442273">)</span>&nbsp;<span class="op" id="4442275">(</span><span class="ident" id="4442276">n</span>&nbsp;<span class="ident" id="4442278">Node</span><span class="op" id="4442282">)</span>&nbsp;<span class="op" id="4442284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442287">switch</span>&nbsp;<span class="ident" id="4442294">token</span>&nbsp;<span class="op" id="4442300">:=</span>&nbsp;<span class="ident" id="4442303">t</span><span class="op" id="4442304">.</span><span class="ident" id="4442305">nextNonSpace</span><span class="op" id="4442317">(</span><span class="op" id="4442318">)</span><span class="op" id="4442319">;</span>&nbsp;<span class="ident" id="4442321">token</span><span class="op" id="4442326">.</span><span class="ident" id="4442327">typ</span>&nbsp;<span class="op" id="4442331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442334">case</span>&nbsp;<span class="ident" id="4442339">itemElse</span><span class="op" id="4442347">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442351">return</span>&nbsp;<span class="ident" id="4442358">t</span><span class="op" id="4442359">.</span><span class="ident" id="4442360">elseControl</span><span class="op" id="4442371">(</span><span class="op" id="4442372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442375">case</span>&nbsp;<span class="ident" id="4442380">itemEnd</span><span class="op" id="4442387">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442391">return</span>&nbsp;<span class="ident" id="4442398">t</span><span class="op" id="4442399">.</span><span class="ident" id="4442400">endControl</span><span class="op" id="4442410">(</span><span class="op" id="4442411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442414">case</span>&nbsp;<span class="ident" id="4442419">itemIf</span><span class="op" id="4442425">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442429">return</span>&nbsp;<span class="ident" id="4442436">t</span><span class="op" id="4442437">.</span><span class="ident" id="4442438">ifControl</span><span class="op" id="4442447">(</span><span class="op" id="4442448">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442451">case</span>&nbsp;<span class="ident" id="4442456">itemRange</span><span class="op" id="4442465">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442469">return</span>&nbsp;<span class="ident" id="4442476">t</span><span class="op" id="4442477">.</span><span class="ident" id="4442478">rangeControl</span><span class="op" id="4442490">(</span><span class="op" id="4442491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442494">case</span>&nbsp;<span class="ident" id="4442499">itemTemplate</span><span class="op" id="4442511">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442515">return</span>&nbsp;<span class="ident" id="4442522">t</span><span class="op" id="4442523">.</span><span class="ident" id="4442524">templateControl</span><span class="op" id="4442539">(</span><span class="op" id="4442540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442543">case</span>&nbsp;<span class="ident" id="4442548">itemWith</span><span class="op" id="4442556">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442560">return</span>&nbsp;<span class="ident" id="4442567">t</span><span class="op" id="4442568">.</span><span class="ident" id="4442569">withControl</span><span class="op" id="4442580">(</span><span class="op" id="4442581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4442584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4442587">t</span><span class="op" id="4442588">.</span><span class="ident" id="4442589">backup</span><span class="op" id="4442595">(</span><span class="op" id="4442596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4442599">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442651">return</span>&nbsp;<span class="ident" id="4442658">t</span><span class="op" id="4442659">.</span><span class="ident" id="4442660">newAction</span><span class="op" id="4442669">(</span><span class="ident" id="4442670">t</span><span class="op" id="4442671">.</span><span class="ident" id="4442672">peek</span><span class="op" id="4442676">(</span><span class="op" id="4442677">)</span><span class="op" id="4442678">.</span><span class="ident" id="4442679">pos</span><span class="op" id="4442682">,</span>&nbsp;<span class="ident" id="4442684">t</span><span class="op" id="4442685">.</span><span class="ident" id="4442686">lex</span><span class="op" id="4442689">.</span><span class="ident" id="4442690">lineNumber</span><span class="op" id="4442700">(</span><span class="op" id="4442701">)</span><span class="op" id="4442702">,</span>&nbsp;<span class="ident" id="4442704">t</span><span class="op" id="4442705">.</span><span class="ident" id="4442706">pipeline</span><span class="op" id="4442714">(</span><span class="string" id="4442715">&#34;command&#34;</span><span class="op" id="4442724">)</span><span class="op" id="4442725">)</span><br>
<span class="lineno">375</span><span class="op" id="4442727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4442730">//&nbsp;Pipeline:</span><br>
<span class="lineno"></span><span class="comment" id="4442743">//&nbsp;&nbsp;&nbsp;&nbsp;declarations?&nbsp;command&nbsp;(&#39;|&#39;&nbsp;command)*</span><br>
<span class="lineno"></span><span class="keyword" id="4442783">func</span>&nbsp;<span class="op" id="4442788">(</span><span class="ident" id="4442789">t</span>&nbsp;<span class="op" id="4442791">*</span><span class="ident" id="4442792">Tree</span><span class="op" id="4442796">)</span>&nbsp;<span class="ident" id="4442798">pipeline</span><span class="op" id="4442806">(</span><span class="ident" id="4442807">context</span>&nbsp;<span class="builtintype" id="4442815">string</span><span class="op" id="4442821">)</span>&nbsp;<span class="op" id="4442823">(</span><span class="ident" id="4442824">pipe</span>&nbsp;<span class="op" id="4442829">*</span><span class="ident" id="4442830">PipeNode</span><span class="op" id="4442838">)</span>&nbsp;<span class="op" id="4442840">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442843">var</span>&nbsp;<span class="ident" id="4442847">decl</span>&nbsp;<span class="op" id="4442852">[</span><span class="op" id="4442853">]</span><span class="op" id="4442854">*</span><span class="ident" id="4442855">VariableNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4442869">pos</span>&nbsp;<span class="op" id="4442873">:=</span>&nbsp;<span class="ident" id="4442876">t</span><span class="op" id="4442877">.</span><span class="ident" id="4442878">peekNonSpace</span><span class="op" id="4442890">(</span><span class="op" id="4442891">)</span><span class="op" id="4442892">.</span><span class="ident" id="4442893">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4442898">//&nbsp;Are&nbsp;there&nbsp;declarations?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442926">for</span>&nbsp;<span class="op" id="4442930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4442934">if</span>&nbsp;<span class="ident" id="4442937">v</span>&nbsp;<span class="op" id="4442939">:=</span>&nbsp;<span class="ident" id="4442942">t</span><span class="op" id="4442943">.</span><span class="ident" id="4442944">peekNonSpace</span><span class="op" id="4442956">(</span><span class="op" id="4442957">)</span><span class="op" id="4442958">;</span>&nbsp;<span class="ident" id="4442960">v</span><span class="op" id="4442961">.</span><span class="ident" id="4442962">typ</span>&nbsp;<span class="op" id="4442966">==</span>&nbsp;<span class="ident" id="4442969">itemVariable</span>&nbsp;<span class="op" id="4442982">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4442987">t</span><span class="op" id="4442988">.</span><span class="ident" id="4442989">next</span><span class="op" id="4442993">(</span><span class="op" id="4442994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4442999">//&nbsp;Since&nbsp;space&nbsp;is&nbsp;a&nbsp;token,&nbsp;we&nbsp;need&nbsp;3-token&nbsp;look-ahead&nbsp;here&nbsp;in&nbsp;the&nbsp;worst&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4443080">//&nbsp;in&nbsp;&#34;$x&nbsp;foo&#34;&nbsp;we&nbsp;need&nbsp;to&nbsp;read&nbsp;&#34;foo&#34;&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;&#34;:=&#34;)&nbsp;to&nbsp;know&nbsp;that&nbsp;$x&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4443163">//&nbsp;argument&nbsp;variable&nbsp;rather&nbsp;than&nbsp;a&nbsp;declaration.&nbsp;So&nbsp;remember&nbsp;the&nbsp;token</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4443236">//&nbsp;adjacent&nbsp;to&nbsp;the&nbsp;variable&nbsp;so&nbsp;we&nbsp;can&nbsp;push&nbsp;it&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443304">tokenAfterVariable</span>&nbsp;<span class="op" id="4443323">:=</span>&nbsp;<span class="ident" id="4443326">t</span><span class="op" id="4443327">.</span><span class="ident" id="4443328">peek</span><span class="op" id="4443332">(</span><span class="op" id="4443333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4443338">if</span>&nbsp;<span class="ident" id="4443341">next</span>&nbsp;<span class="op" id="4443346">:=</span>&nbsp;<span class="ident" id="4443349">t</span><span class="op" id="4443350">.</span><span class="ident" id="4443351">peekNonSpace</span><span class="op" id="4443363">(</span><span class="op" id="4443364">)</span><span class="op" id="4443365">;</span>&nbsp;<span class="ident" id="4443367">next</span><span class="op" id="4443371">.</span><span class="ident" id="4443372">typ</span>&nbsp;<span class="op" id="4443376">==</span>&nbsp;<span class="ident" id="4443379">itemColonEquals</span>&nbsp;<span class="op" id="4443395">||</span>&nbsp;<span class="op" id="4443398">(</span><span class="ident" id="4443399">next</span><span class="op" id="4443403">.</span><span class="ident" id="4443404">typ</span>&nbsp;<span class="op" id="4443408">==</span>&nbsp;<span class="ident" id="4443411">itemChar</span>&nbsp;<span class="op" id="4443420">&amp;&amp;</span>&nbsp;<span class="ident" id="4443423">next</span><span class="op" id="4443427">.</span><span class="ident" id="4443428">val</span>&nbsp;<span class="op" id="4443432">==</span>&nbsp;<span class="string" id="4443435">&#34;,&#34;</span><span class="op" id="4443438">)</span>&nbsp;<span class="op" id="4443440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443446">t</span><span class="op" id="4443447">.</span><span class="ident" id="4443448">nextNonSpace</span><span class="op" id="4443460">(</span><span class="op" id="4443461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443467">variable</span>&nbsp;<span class="op" id="4443476">:=</span>&nbsp;<span class="ident" id="4443479">t</span><span class="op" id="4443480">.</span><span class="ident" id="4443481">newVariable</span><span class="op" id="4443492">(</span><span class="ident" id="4443493">v</span><span class="op" id="4443494">.</span><span class="ident" id="4443495">pos</span><span class="op" id="4443498">,</span>&nbsp;<span class="ident" id="4443500">v</span><span class="op" id="4443501">.</span><span class="ident" id="4443502">val</span><span class="op" id="4443505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443511">decl</span>&nbsp;<span class="op" id="4443516">=</span>&nbsp;<span class="builtinfunc" id="4443518">append</span><span class="op" id="4443524">(</span><span class="ident" id="4443525">decl</span><span class="op" id="4443529">,</span>&nbsp;<span class="ident" id="4443531">variable</span><span class="op" id="4443539">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443545">t</span><span class="op" id="4443546">.</span><span class="ident" id="4443547">vars</span>&nbsp;<span class="op" id="4443552">=</span>&nbsp;<span class="builtinfunc" id="4443554">append</span><span class="op" id="4443560">(</span><span class="ident" id="4443561">t</span><span class="op" id="4443562">.</span><span class="ident" id="4443563">vars</span><span class="op" id="4443567">,</span>&nbsp;<span class="ident" id="4443569">v</span><span class="op" id="4443570">.</span><span class="ident" id="4443571">val</span><span class="op" id="4443574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4443580">if</span>&nbsp;<span class="ident" id="4443583">next</span><span class="op" id="4443587">.</span><span class="ident" id="4443588">typ</span>&nbsp;<span class="op" id="4443592">==</span>&nbsp;<span class="ident" id="4443595">itemChar</span>&nbsp;<span class="op" id="4443604">&amp;&amp;</span>&nbsp;<span class="ident" id="4443607">next</span><span class="op" id="4443611">.</span><span class="ident" id="4443612">val</span>&nbsp;<span class="op" id="4443616">==</span>&nbsp;<span class="string" id="4443619">&#34;,&#34;</span>&nbsp;<span class="op" id="4443623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4443630">if</span>&nbsp;<span class="ident" id="4443633">context</span>&nbsp;<span class="op" id="4443641">==</span>&nbsp;<span class="string" id="4443644">&#34;range&#34;</span>&nbsp;<span class="op" id="4443652">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4443655">len</span><span class="op" id="4443658">(</span><span class="ident" id="4443659">decl</span><span class="op" id="4443663">)</span>&nbsp;<span class="op" id="4443665">&lt;</span>&nbsp;<span class="num" id="4443667">2</span>&nbsp;<span class="op" id="4443669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4443677">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4443691">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443698">t</span><span class="op" id="4443699">.</span><span class="ident" id="4443700">errorf</span><span class="op" id="4443706">(</span><span class="string" id="4443707">&#34;too&nbsp;many&nbsp;declarations&nbsp;in&nbsp;%s&#34;</span><span class="op" id="4443736">,</span>&nbsp;<span class="ident" id="4443738">context</span><span class="op" id="4443745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4443751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4443756">}</span>&nbsp;<span class="keyword" id="4443758">else</span>&nbsp;<span class="keyword" id="4443763">if</span>&nbsp;<span class="ident" id="4443766">tokenAfterVariable</span><span class="op" id="4443784">.</span><span class="ident" id="4443785">typ</span>&nbsp;<span class="op" id="4443789">==</span>&nbsp;<span class="ident" id="4443792">itemSpace</span>&nbsp;<span class="op" id="4443802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443808">t</span><span class="op" id="4443809">.</span><span class="ident" id="4443810">backup3</span><span class="op" id="4443817">(</span><span class="ident" id="4443818">v</span><span class="op" id="4443819">,</span>&nbsp;<span class="ident" id="4443821">tokenAfterVariable</span><span class="op" id="4443839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4443844">}</span>&nbsp;<span class="keyword" id="4443846">else</span>&nbsp;<span class="op" id="4443851">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443857">t</span><span class="op" id="4443858">.</span><span class="ident" id="4443859">backup2</span><span class="op" id="4443866">(</span><span class="ident" id="4443867">v</span><span class="op" id="4443868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4443873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4443877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4443881">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4443888">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4443891">pipe</span>&nbsp;<span class="op" id="4443896">=</span>&nbsp;<span class="ident" id="4443898">t</span><span class="op" id="4443899">.</span><span class="ident" id="4443900">newPipeline</span><span class="op" id="4443911">(</span><span class="ident" id="4443912">pos</span><span class="op" id="4443915">,</span>&nbsp;<span class="ident" id="4443917">t</span><span class="op" id="4443918">.</span><span class="ident" id="4443919">lex</span><span class="op" id="4443922">.</span><span class="ident" id="4443923">lineNumber</span><span class="op" id="4443933">(</span><span class="op" id="4443934">)</span><span class="op" id="4443935">,</span>&nbsp;<span class="ident" id="4443937">decl</span><span class="op" id="4443941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4443944">for</span>&nbsp;<span class="op" id="4443948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4443952">switch</span>&nbsp;<span class="ident" id="4443959">token</span>&nbsp;<span class="op" id="4443965">:=</span>&nbsp;<span class="ident" id="4443968">t</span><span class="op" id="4443969">.</span><span class="ident" id="4443970">nextNonSpace</span><span class="op" id="4443982">(</span><span class="op" id="4443983">)</span><span class="op" id="4443984">;</span>&nbsp;<span class="ident" id="4443986">token</span><span class="op" id="4443991">.</span><span class="ident" id="4443992">typ</span>&nbsp;<span class="op" id="4443996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444000">case</span>&nbsp;<span class="ident" id="4444005">itemRightDelim</span><span class="op" id="4444019">,</span>&nbsp;<span class="ident" id="4444021">itemRightParen</span><span class="op" id="4444035">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444040">if</span>&nbsp;<span class="builtinfunc" id="4444043">len</span><span class="op" id="4444046">(</span><span class="ident" id="4444047">pipe</span><span class="op" id="4444051">.</span><span class="ident" id="4444052">Cmds</span><span class="op" id="4444056">)</span>&nbsp;<span class="op" id="4444058">==</span>&nbsp;<span class="num" id="4444061">0</span>&nbsp;<span class="op" id="4444063">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4444069">t</span><span class="op" id="4444070">.</span><span class="ident" id="4444071">errorf</span><span class="op" id="4444077">(</span><span class="string" id="4444078">&#34;missing&nbsp;value&nbsp;for&nbsp;%s&#34;</span><span class="op" id="4444100">,</span>&nbsp;<span class="ident" id="4444102">context</span><span class="op" id="4444109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4444114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444119">if</span>&nbsp;<span class="ident" id="4444122">token</span><span class="op" id="4444127">.</span><span class="ident" id="4444128">typ</span>&nbsp;<span class="op" id="4444132">==</span>&nbsp;<span class="ident" id="4444135">itemRightParen</span>&nbsp;<span class="op" id="4444150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4444156">t</span><span class="op" id="4444157">.</span><span class="ident" id="4444158">backup</span><span class="op" id="4444164">(</span><span class="op" id="4444165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4444170">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444175">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444184">case</span>&nbsp;<span class="ident" id="4444189">itemBool</span><span class="op" id="4444197">,</span>&nbsp;<span class="ident" id="4444199">itemCharConstant</span><span class="op" id="4444215">,</span>&nbsp;<span class="ident" id="4444217">itemComplex</span><span class="op" id="4444228">,</span>&nbsp;<span class="ident" id="4444230">itemDot</span><span class="op" id="4444237">,</span>&nbsp;<span class="ident" id="4444239">itemField</span><span class="op" id="4444248">,</span>&nbsp;<span class="ident" id="4444250">itemIdentifier</span><span class="op" id="4444264">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4444269">itemNumber</span><span class="op" id="4444279">,</span>&nbsp;<span class="ident" id="4444281">itemNil</span><span class="op" id="4444288">,</span>&nbsp;<span class="ident" id="4444290">itemRawString</span><span class="op" id="4444303">,</span>&nbsp;<span class="ident" id="4444305">itemString</span><span class="op" id="4444315">,</span>&nbsp;<span class="ident" id="4444317">itemVariable</span><span class="op" id="4444329">,</span>&nbsp;<span class="ident" id="4444331">itemLeftParen</span><span class="op" id="4444344">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4444349">t</span><span class="op" id="4444350">.</span><span class="ident" id="4444351">backup</span><span class="op" id="4444357">(</span><span class="op" id="4444358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4444363">pipe</span><span class="op" id="4444367">.</span><span class="builtinfunc" id="4444368">append</span><span class="op" id="4444374">(</span><span class="ident" id="4444375">t</span><span class="op" id="4444376">.</span><span class="ident" id="4444377">command</span><span class="op" id="4444384">(</span><span class="op" id="4444385">)</span><span class="op" id="4444386">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444390">default</span><span class="op" id="4444397">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4444402">t</span><span class="op" id="4444403">.</span><span class="ident" id="4444404">unexpected</span><span class="op" id="4444414">(</span><span class="ident" id="4444415">token</span><span class="op" id="4444420">,</span>&nbsp;<span class="ident" id="4444422">context</span><span class="op" id="4444429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4444433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4444436">}</span><br>
<span class="lineno"></span><span class="op" id="4444438">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="4444441">func</span>&nbsp;<span class="op" id="4444446">(</span><span class="ident" id="4444447">t</span>&nbsp;<span class="op" id="4444449">*</span><span class="ident" id="4444450">Tree</span><span class="op" id="4444454">)</span>&nbsp;<span class="ident" id="4444456">parseControl</span><span class="op" id="4444468">(</span><span class="ident" id="4444469">allowElseIf</span>&nbsp;<span class="builtintype" id="4444481">bool</span><span class="op" id="4444485">,</span>&nbsp;<span class="ident" id="4444487">context</span>&nbsp;<span class="builtintype" id="4444495">string</span><span class="op" id="4444501">)</span>&nbsp;<span class="op" id="4444503">(</span><span class="ident" id="4444504">pos</span>&nbsp;<span class="ident" id="4444508">Pos</span><span class="op" id="4444511">,</span>&nbsp;<span class="ident" id="4444513">line</span>&nbsp;<span class="builtintype" id="4444518">int</span><span class="op" id="4444521">,</span>&nbsp;<span class="ident" id="4444523">pipe</span>&nbsp;<span class="op" id="4444528">*</span><span class="ident" id="4444529">PipeNode</span><span class="op" id="4444537">,</span>&nbsp;<span class="ident" id="4444539">list</span><span class="op" id="4444543">,</span>&nbsp;<span class="ident" id="4444545">elseList</span>&nbsp;<span class="op" id="4444554">*</span><span class="ident" id="4444555">ListNode</span><span class="op" id="4444563">)</span>&nbsp;<span class="op" id="4444565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444568">defer</span>&nbsp;<span class="ident" id="4444574">t</span><span class="op" id="4444575">.</span><span class="ident" id="4444576">popVars</span><span class="op" id="4444583">(</span><span class="builtinfunc" id="4444584">len</span><span class="op" id="4444587">(</span><span class="ident" id="4444588">t</span><span class="op" id="4444589">.</span><span class="ident" id="4444590">vars</span><span class="op" id="4444594">)</span><span class="op" id="4444595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4444598">line</span>&nbsp;<span class="op" id="4444603">=</span>&nbsp;<span class="ident" id="4444605">t</span><span class="op" id="4444606">.</span><span class="ident" id="4444607">lex</span><span class="op" id="4444610">.</span><span class="ident" id="4444611">lineNumber</span><span class="op" id="4444621">(</span><span class="op" id="4444622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4444625">pipe</span>&nbsp;<span class="op" id="4444630">=</span>&nbsp;<span class="ident" id="4444632">t</span><span class="op" id="4444633">.</span><span class="ident" id="4444634">pipeline</span><span class="op" id="4444642">(</span><span class="ident" id="4444643">context</span><span class="op" id="4444650">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444653">var</span>&nbsp;<span class="ident" id="4444657">next</span>&nbsp;<span class="ident" id="4444662">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4444668">list</span><span class="op" id="4444672">,</span>&nbsp;<span class="ident" id="4444674">next</span>&nbsp;<span class="op" id="4444679">=</span>&nbsp;<span class="ident" id="4444681">t</span><span class="op" id="4444682">.</span><span class="ident" id="4444683">itemList</span><span class="op" id="4444691">(</span><span class="op" id="4444692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444695">switch</span>&nbsp;<span class="ident" id="4444702">next</span><span class="op" id="4444706">.</span><span class="ident" id="4444707">Type</span><span class="op" id="4444711">(</span><span class="op" id="4444712">)</span>&nbsp;<span class="op" id="4444714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444717">case</span>&nbsp;<span class="ident" id="4444722">nodeEnd</span><span class="op" id="4444729">:</span>&nbsp;<span class="comment" id="4444731">//done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444739">case</span>&nbsp;<span class="ident" id="4444744">nodeElse</span><span class="op" id="4444752">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4444756">if</span>&nbsp;<span class="ident" id="4444759">allowElseIf</span>&nbsp;<span class="op" id="4444771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4444776">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.&nbsp;If&nbsp;the&nbsp;&#34;else&#34;&nbsp;is&nbsp;followed&nbsp;immediately&nbsp;by&nbsp;an&nbsp;&#34;if&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4444860">//&nbsp;the&nbsp;elseControl&nbsp;will&nbsp;have&nbsp;left&nbsp;the&nbsp;&#34;if&#34;&nbsp;token&nbsp;pending.&nbsp;Treat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4444927">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;a}}_{{else&nbsp;if&nbsp;b}}_{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4444964">//&nbsp;as</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4444973">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;a}}_{{else}}{{if&nbsp;b}}_{{end}}{{end}}.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4445021">//&nbsp;To&nbsp;do&nbsp;this,&nbsp;parse&nbsp;the&nbsp;if&nbsp;as&nbsp;usual&nbsp;and&nbsp;stop&nbsp;at&nbsp;it&nbsp;{{end}};&nbsp;the&nbsp;subsequent{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4445107">//&nbsp;is&nbsp;assumed.&nbsp;This&nbsp;technique&nbsp;works&nbsp;even&nbsp;for&nbsp;long&nbsp;if-else-if&nbsp;chains.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4445179">//&nbsp;TODO:&nbsp;Should&nbsp;we&nbsp;allow&nbsp;else-if&nbsp;in&nbsp;with&nbsp;and&nbsp;range?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445234">if</span>&nbsp;<span class="ident" id="4445237">t</span><span class="op" id="4445238">.</span><span class="ident" id="4445239">peek</span><span class="op" id="4445243">(</span><span class="op" id="4445244">)</span><span class="op" id="4445245">.</span><span class="ident" id="4445246">typ</span>&nbsp;<span class="op" id="4445250">==</span>&nbsp;<span class="ident" id="4445253">itemIf</span>&nbsp;<span class="op" id="4445260">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4445266">t</span><span class="op" id="4445267">.</span><span class="ident" id="4445268">next</span><span class="op" id="4445272">(</span><span class="op" id="4445273">)</span>&nbsp;<span class="comment" id="4445275">//&nbsp;Consume&nbsp;the&nbsp;&#34;if&#34;&nbsp;token.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4445306">elseList</span>&nbsp;<span class="op" id="4445315">=</span>&nbsp;<span class="ident" id="4445317">t</span><span class="op" id="4445318">.</span><span class="ident" id="4445319">newList</span><span class="op" id="4445326">(</span><span class="ident" id="4445327">next</span><span class="op" id="4445331">.</span><span class="ident" id="4445332">Position</span><span class="op" id="4445340">(</span><span class="op" id="4445341">)</span><span class="op" id="4445342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4445348">elseList</span><span class="op" id="4445356">.</span><span class="builtinfunc" id="4445357">append</span><span class="op" id="4445363">(</span><span class="ident" id="4445364">t</span><span class="op" id="4445365">.</span><span class="ident" id="4445366">ifControl</span><span class="op" id="4445375">(</span><span class="op" id="4445376">)</span><span class="op" id="4445377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4445383">//&nbsp;Do&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;item&nbsp;-&nbsp;only&nbsp;one&nbsp;{{end}}&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445448">break</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4445457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4445461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4445465">elseList</span><span class="op" id="4445473">,</span>&nbsp;<span class="ident" id="4445475">next</span>&nbsp;<span class="op" id="4445480">=</span>&nbsp;<span class="ident" id="4445482">t</span><span class="op" id="4445483">.</span><span class="ident" id="4445484">itemList</span><span class="op" id="4445492">(</span><span class="op" id="4445493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445497">if</span>&nbsp;<span class="ident" id="4445500">next</span><span class="op" id="4445504">.</span><span class="ident" id="4445505">Type</span><span class="op" id="4445509">(</span><span class="op" id="4445510">)</span>&nbsp;<span class="op" id="4445512">!=</span>&nbsp;<span class="ident" id="4445515">nodeEnd</span>&nbsp;<span class="op" id="4445523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4445528">t</span><span class="op" id="4445529">.</span><span class="ident" id="4445530">errorf</span><span class="op" id="4445536">(</span><span class="string" id="4445537">&#34;expected&nbsp;end;&nbsp;found&nbsp;%s&#34;</span><span class="op" id="4445561">,</span>&nbsp;<span class="ident" id="4445563">next</span><span class="op" id="4445567">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4445571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4445574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445577">return</span>&nbsp;<span class="ident" id="4445584">pipe</span><span class="op" id="4445588">.</span><span class="ident" id="4445589">Position</span><span class="op" id="4445597">(</span><span class="op" id="4445598">)</span><span class="op" id="4445599">,</span>&nbsp;<span class="ident" id="4445601">line</span><span class="op" id="4445605">,</span>&nbsp;<span class="ident" id="4445607">pipe</span><span class="op" id="4445611">,</span>&nbsp;<span class="ident" id="4445613">list</span><span class="op" id="4445617">,</span>&nbsp;<span class="ident" id="4445619">elseList</span><br>
<span class="lineno"></span><span class="op" id="4445628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="comment" id="4445631">//&nbsp;If:</span><br>
<span class="lineno"></span><span class="comment" id="4445638">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4445674">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4445728">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4445751">func</span>&nbsp;<span class="op" id="4445756">(</span><span class="ident" id="4445757">t</span>&nbsp;<span class="op" id="4445759">*</span><span class="ident" id="4445760">Tree</span><span class="op" id="4445764">)</span>&nbsp;<span class="ident" id="4445766">ifControl</span><span class="op" id="4445775">(</span><span class="op" id="4445776">)</span>&nbsp;<span class="ident" id="4445778">Node</span>&nbsp;<span class="op" id="4445783">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4445786">return</span>&nbsp;<span class="ident" id="4445793">t</span><span class="op" id="4445794">.</span><span class="ident" id="4445795">newIf</span><span class="op" id="4445800">(</span><span class="ident" id="4445801">t</span><span class="op" id="4445802">.</span><span class="ident" id="4445803">parseControl</span><span class="op" id="4445815">(</span><span class="builtintype" id="4445816">true</span><span class="op" id="4445820">,</span>&nbsp;<span class="string" id="4445822">&#34;if&#34;</span><span class="op" id="4445826">)</span><span class="op" id="4445827">)</span><br>
<span class="lineno"></span><span class="op" id="4445829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4445832">//&nbsp;Range:</span><br>
<span class="lineno"></span><span class="comment" id="4445842">//&nbsp;&nbsp;&nbsp;&nbsp;{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno">475</span><span class="comment" id="4445881">//&nbsp;&nbsp;&nbsp;&nbsp;{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4445938">//&nbsp;Range&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4445964">func</span>&nbsp;<span class="op" id="4445969">(</span><span class="ident" id="4445970">t</span>&nbsp;<span class="op" id="4445972">*</span><span class="ident" id="4445973">Tree</span><span class="op" id="4445977">)</span>&nbsp;<span class="ident" id="4445979">rangeControl</span><span class="op" id="4445991">(</span><span class="op" id="4445992">)</span>&nbsp;<span class="ident" id="4445994">Node</span>&nbsp;<span class="op" id="4445999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446002">return</span>&nbsp;<span class="ident" id="4446009">t</span><span class="op" id="4446010">.</span><span class="ident" id="4446011">newRange</span><span class="op" id="4446019">(</span><span class="ident" id="4446020">t</span><span class="op" id="4446021">.</span><span class="ident" id="4446022">parseControl</span><span class="op" id="4446034">(</span><span class="builtintype" id="4446035">false</span><span class="op" id="4446040">,</span>&nbsp;<span class="string" id="4446042">&#34;range&#34;</span><span class="op" id="4446049">)</span><span class="op" id="4446050">)</span><br>
<span class="lineno"></span><span class="op" id="4446052">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="4446055">//&nbsp;With:</span><br>
<span class="lineno"></span><span class="comment" id="4446064">//&nbsp;&nbsp;&nbsp;&nbsp;{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4446102">//&nbsp;&nbsp;&nbsp;&nbsp;{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4446158">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno">485</span><span class="keyword" id="4446181">func</span>&nbsp;<span class="op" id="4446186">(</span><span class="ident" id="4446187">t</span>&nbsp;<span class="op" id="4446189">*</span><span class="ident" id="4446190">Tree</span><span class="op" id="4446194">)</span>&nbsp;<span class="ident" id="4446196">withControl</span><span class="op" id="4446207">(</span><span class="op" id="4446208">)</span>&nbsp;<span class="ident" id="4446210">Node</span>&nbsp;<span class="op" id="4446215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446218">return</span>&nbsp;<span class="ident" id="4446225">t</span><span class="op" id="4446226">.</span><span class="ident" id="4446227">newWith</span><span class="op" id="4446234">(</span><span class="ident" id="4446235">t</span><span class="op" id="4446236">.</span><span class="ident" id="4446237">parseControl</span><span class="op" id="4446249">(</span><span class="builtintype" id="4446250">false</span><span class="op" id="4446255">,</span>&nbsp;<span class="string" id="4446257">&#34;with&#34;</span><span class="op" id="4446263">)</span><span class="op" id="4446264">)</span><br>
<span class="lineno"></span><span class="op" id="4446266">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4446269">//&nbsp;End:</span><br>
<span class="lineno">490</span><span class="comment" id="4446277">//&nbsp;&nbsp;&nbsp;&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4446288">//&nbsp;End&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4446312">func</span>&nbsp;<span class="op" id="4446317">(</span><span class="ident" id="4446318">t</span>&nbsp;<span class="op" id="4446320">*</span><span class="ident" id="4446321">Tree</span><span class="op" id="4446325">)</span>&nbsp;<span class="ident" id="4446327">endControl</span><span class="op" id="4446337">(</span><span class="op" id="4446338">)</span>&nbsp;<span class="ident" id="4446340">Node</span>&nbsp;<span class="op" id="4446345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446348">return</span>&nbsp;<span class="ident" id="4446355">t</span><span class="op" id="4446356">.</span><span class="ident" id="4446357">newEnd</span><span class="op" id="4446363">(</span><span class="ident" id="4446364">t</span><span class="op" id="4446365">.</span><span class="ident" id="4446366">expect</span><span class="op" id="4446372">(</span><span class="ident" id="4446373">itemRightDelim</span><span class="op" id="4446387">,</span>&nbsp;<span class="string" id="4446389">&#34;end&#34;</span><span class="op" id="4446394">)</span><span class="op" id="4446395">.</span><span class="ident" id="4446396">pos</span><span class="op" id="4446399">)</span><br>
<span class="lineno"></span><span class="op" id="4446401">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="comment" id="4446404">//&nbsp;Else:</span><br>
<span class="lineno"></span><span class="comment" id="4446413">//&nbsp;&nbsp;&nbsp;&nbsp;{{else}}</span><br>
<span class="lineno"></span><span class="comment" id="4446425">//&nbsp;Else&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4446450">func</span>&nbsp;<span class="op" id="4446455">(</span><span class="ident" id="4446456">t</span>&nbsp;<span class="op" id="4446458">*</span><span class="ident" id="4446459">Tree</span><span class="op" id="4446463">)</span>&nbsp;<span class="ident" id="4446465">elseControl</span><span class="op" id="4446476">(</span><span class="op" id="4446477">)</span>&nbsp;<span class="ident" id="4446479">Node</span>&nbsp;<span class="op" id="4446484">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4446487">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4446519">peek</span>&nbsp;<span class="op" id="4446524">:=</span>&nbsp;<span class="ident" id="4446527">t</span><span class="op" id="4446528">.</span><span class="ident" id="4446529">peekNonSpace</span><span class="op" id="4446541">(</span><span class="op" id="4446542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446545">if</span>&nbsp;<span class="ident" id="4446548">peek</span><span class="op" id="4446552">.</span><span class="ident" id="4446553">typ</span>&nbsp;<span class="op" id="4446557">==</span>&nbsp;<span class="ident" id="4446560">itemIf</span>&nbsp;<span class="op" id="4446567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4446571">//&nbsp;We&nbsp;see&nbsp;&#34;{{else&nbsp;if&nbsp;...&nbsp;&#34;&nbsp;but&nbsp;in&nbsp;effect&nbsp;rewrite&nbsp;it&nbsp;to&nbsp;{{else}}{{if&nbsp;...&nbsp;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446648">return</span>&nbsp;<span class="ident" id="4446655">t</span><span class="op" id="4446656">.</span><span class="ident" id="4446657">newElse</span><span class="op" id="4446664">(</span><span class="ident" id="4446665">peek</span><span class="op" id="4446669">.</span><span class="ident" id="4446670">pos</span><span class="op" id="4446673">,</span>&nbsp;<span class="ident" id="4446675">t</span><span class="op" id="4446676">.</span><span class="ident" id="4446677">lex</span><span class="op" id="4446680">.</span><span class="ident" id="4446681">lineNumber</span><span class="op" id="4446691">(</span><span class="op" id="4446692">)</span><span class="op" id="4446693">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4446696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446699">return</span>&nbsp;<span class="ident" id="4446706">t</span><span class="op" id="4446707">.</span><span class="ident" id="4446708">newElse</span><span class="op" id="4446715">(</span><span class="ident" id="4446716">t</span><span class="op" id="4446717">.</span><span class="ident" id="4446718">expect</span><span class="op" id="4446724">(</span><span class="ident" id="4446725">itemRightDelim</span><span class="op" id="4446739">,</span>&nbsp;<span class="string" id="4446741">&#34;else&#34;</span><span class="op" id="4446747">)</span><span class="op" id="4446748">.</span><span class="ident" id="4446749">pos</span><span class="op" id="4446752">,</span>&nbsp;<span class="ident" id="4446754">t</span><span class="op" id="4446755">.</span><span class="ident" id="4446756">lex</span><span class="op" id="4446759">.</span><span class="ident" id="4446760">lineNumber</span><span class="op" id="4446770">(</span><span class="op" id="4446771">)</span><span class="op" id="4446772">)</span><br>
<span class="lineno"></span><span class="op" id="4446774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4446777">//&nbsp;Template:</span><br>
<span class="lineno">510</span><span class="comment" id="4446790">//&nbsp;&nbsp;&nbsp;&nbsp;{{template&nbsp;stringValue&nbsp;pipeline}}</span><br>
<span class="lineno"></span><span class="comment" id="4446827">//&nbsp;Template&nbsp;keyword&nbsp;is&nbsp;past.&nbsp;&nbsp;The&nbsp;name&nbsp;must&nbsp;be&nbsp;something&nbsp;that&nbsp;can&nbsp;evaluate</span><br>
<span class="lineno"></span><span class="comment" id="4446902">//&nbsp;to&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="4446918">func</span>&nbsp;<span class="op" id="4446923">(</span><span class="ident" id="4446924">t</span>&nbsp;<span class="op" id="4446926">*</span><span class="ident" id="4446927">Tree</span><span class="op" id="4446931">)</span>&nbsp;<span class="ident" id="4446933">templateControl</span><span class="op" id="4446948">(</span><span class="op" id="4446949">)</span>&nbsp;<span class="ident" id="4446951">Node</span>&nbsp;<span class="op" id="4446956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4446959">var</span>&nbsp;<span class="ident" id="4446963">name</span>&nbsp;<span class="builtintype" id="4446968">string</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4446976">token</span>&nbsp;<span class="op" id="4446982">:=</span>&nbsp;<span class="ident" id="4446985">t</span><span class="op" id="4446986">.</span><span class="ident" id="4446987">nextNonSpace</span><span class="op" id="4446999">(</span><span class="op" id="4447000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447003">switch</span>&nbsp;<span class="ident" id="4447010">token</span><span class="op" id="4447015">.</span><span class="ident" id="4447016">typ</span>&nbsp;<span class="op" id="4447020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447023">case</span>&nbsp;<span class="ident" id="4447028">itemString</span><span class="op" id="4447038">,</span>&nbsp;<span class="ident" id="4447040">itemRawString</span><span class="op" id="4447053">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447057">s</span><span class="op" id="4447058">,</span>&nbsp;<span class="ident" id="4447060">err</span>&nbsp;<span class="op" id="4447064">:=</span>&nbsp;<span class="ident" id="4447067">strconv</span><span class="op" id="4447074">.</span><span class="ident" id="4447075">Unquote</span><span class="op" id="4447082">(</span><span class="ident" id="4447083">token</span><span class="op" id="4447088">.</span><span class="ident" id="4447089">val</span><span class="op" id="4447092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447096">if</span>&nbsp;<span class="ident" id="4447099">err</span>&nbsp;<span class="op" id="4447103">!=</span>&nbsp;<span class="builtintype" id="4447106">nil</span>&nbsp;<span class="op" id="4447110">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447115">t</span><span class="op" id="4447116">.</span><span class="builtintype" id="4447117">error</span><span class="op" id="4447122">(</span><span class="ident" id="4447123">err</span><span class="op" id="4447126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4447130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447134">name</span>&nbsp;<span class="op" id="4447139">=</span>&nbsp;<span class="ident" id="4447141">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447144">default</span><span class="op" id="4447151">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447155">t</span><span class="op" id="4447156">.</span><span class="ident" id="4447157">unexpected</span><span class="op" id="4447167">(</span><span class="ident" id="4447168">token</span><span class="op" id="4447173">,</span>&nbsp;<span class="string" id="4447175">&#34;template&nbsp;invocation&#34;</span><span class="op" id="4447196">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4447199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447202">var</span>&nbsp;<span class="ident" id="4447206">pipe</span>&nbsp;<span class="op" id="4447211">*</span><span class="ident" id="4447212">PipeNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447222">if</span>&nbsp;<span class="ident" id="4447225">t</span><span class="op" id="4447226">.</span><span class="ident" id="4447227">nextNonSpace</span><span class="op" id="4447239">(</span><span class="op" id="4447240">)</span><span class="op" id="4447241">.</span><span class="ident" id="4447242">typ</span>&nbsp;<span class="op" id="4447246">!=</span>&nbsp;<span class="ident" id="4447249">itemRightDelim</span>&nbsp;<span class="op" id="4447264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447268">t</span><span class="op" id="4447269">.</span><span class="ident" id="4447270">backup</span><span class="op" id="4447276">(</span><span class="op" id="4447277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4447281">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447334">pipe</span>&nbsp;<span class="op" id="4447339">=</span>&nbsp;<span class="ident" id="4447341">t</span><span class="op" id="4447342">.</span><span class="ident" id="4447343">pipeline</span><span class="op" id="4447351">(</span><span class="string" id="4447352">&#34;template&#34;</span><span class="op" id="4447362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4447365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447368">return</span>&nbsp;<span class="ident" id="4447375">t</span><span class="op" id="4447376">.</span><span class="ident" id="4447377">newTemplate</span><span class="op" id="4447388">(</span><span class="ident" id="4447389">token</span><span class="op" id="4447394">.</span><span class="ident" id="4447395">pos</span><span class="op" id="4447398">,</span>&nbsp;<span class="ident" id="4447400">t</span><span class="op" id="4447401">.</span><span class="ident" id="4447402">lex</span><span class="op" id="4447405">.</span><span class="ident" id="4447406">lineNumber</span><span class="op" id="4447416">(</span><span class="op" id="4447417">)</span><span class="op" id="4447418">,</span>&nbsp;<span class="ident" id="4447420">name</span><span class="op" id="4447424">,</span>&nbsp;<span class="ident" id="4447426">pipe</span><span class="op" id="4447430">)</span><br>
<span class="lineno"></span><span class="op" id="4447432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="comment" id="4447435">//&nbsp;command:</span><br>
<span class="lineno"></span><span class="comment" id="4447447">//&nbsp;&nbsp;&nbsp;&nbsp;operand&nbsp;(space&nbsp;operand)*</span><br>
<span class="lineno"></span><span class="comment" id="4447475">//&nbsp;space-separated&nbsp;arguments&nbsp;up&nbsp;to&nbsp;a&nbsp;pipeline&nbsp;character&nbsp;or&nbsp;right&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="4447551">//&nbsp;we&nbsp;consume&nbsp;the&nbsp;pipe&nbsp;character&nbsp;but&nbsp;leave&nbsp;the&nbsp;right&nbsp;delim&nbsp;to&nbsp;terminate&nbsp;the&nbsp;action.</span><br>
<span class="lineno"></span><span class="keyword" id="4447635">func</span>&nbsp;<span class="op" id="4447640">(</span><span class="ident" id="4447641">t</span>&nbsp;<span class="op" id="4447643">*</span><span class="ident" id="4447644">Tree</span><span class="op" id="4447648">)</span>&nbsp;<span class="ident" id="4447650">command</span><span class="op" id="4447657">(</span><span class="op" id="4447658">)</span>&nbsp;<span class="op" id="4447660">*</span><span class="ident" id="4447661">CommandNode</span>&nbsp;<span class="op" id="4447673">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447676">cmd</span>&nbsp;<span class="op" id="4447680">:=</span>&nbsp;<span class="ident" id="4447683">t</span><span class="op" id="4447684">.</span><span class="ident" id="4447685">newCommand</span><span class="op" id="4447695">(</span><span class="ident" id="4447696">t</span><span class="op" id="4447697">.</span><span class="ident" id="4447698">peekNonSpace</span><span class="op" id="4447710">(</span><span class="op" id="4447711">)</span><span class="op" id="4447712">.</span><span class="ident" id="4447713">pos</span><span class="op" id="4447716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447719">for</span>&nbsp;<span class="op" id="4447723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447727">t</span><span class="op" id="4447728">.</span><span class="ident" id="4447729">peekNonSpace</span><span class="op" id="4447741">(</span><span class="op" id="4447742">)</span>&nbsp;<span class="comment" id="4447744">//&nbsp;skip&nbsp;leading&nbsp;spaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447770">operand</span>&nbsp;<span class="op" id="4447778">:=</span>&nbsp;<span class="ident" id="4447781">t</span><span class="op" id="4447782">.</span><span class="ident" id="4447783">operand</span><span class="op" id="4447790">(</span><span class="op" id="4447791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447795">if</span>&nbsp;<span class="ident" id="4447798">operand</span>&nbsp;<span class="op" id="4447806">!=</span>&nbsp;<span class="builtintype" id="4447809">nil</span>&nbsp;<span class="op" id="4447813">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447818">cmd</span><span class="op" id="4447821">.</span><span class="builtinfunc" id="4447822">append</span><span class="op" id="4447828">(</span><span class="ident" id="4447829">operand</span><span class="op" id="4447836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4447840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447844">switch</span>&nbsp;<span class="ident" id="4447851">token</span>&nbsp;<span class="op" id="4447857">:=</span>&nbsp;<span class="ident" id="4447860">t</span><span class="op" id="4447861">.</span><span class="ident" id="4447862">next</span><span class="op" id="4447866">(</span><span class="op" id="4447867">)</span><span class="op" id="4447868">;</span>&nbsp;<span class="ident" id="4447870">token</span><span class="op" id="4447875">.</span><span class="ident" id="4447876">typ</span>&nbsp;<span class="op" id="4447880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447884">case</span>&nbsp;<span class="ident" id="4447889">itemSpace</span><span class="op" id="4447898">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447903">continue</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447914">case</span>&nbsp;<span class="ident" id="4447919">itemError</span><span class="op" id="4447928">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4447933">t</span><span class="op" id="4447934">.</span><span class="ident" id="4447935">errorf</span><span class="op" id="4447941">(</span><span class="string" id="4447942">&#34;%s&#34;</span><span class="op" id="4447946">,</span>&nbsp;<span class="ident" id="4447948">token</span><span class="op" id="4447953">.</span><span class="ident" id="4447954">val</span><span class="op" id="4447957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4447961">case</span>&nbsp;<span class="ident" id="4447966">itemRightDelim</span><span class="op" id="4447980">,</span>&nbsp;<span class="ident" id="4447982">itemRightParen</span><span class="op" id="4447996">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4448001">t</span><span class="op" id="4448002">.</span><span class="ident" id="4448003">backup</span><span class="op" id="4448009">(</span><span class="op" id="4448010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448014">case</span>&nbsp;<span class="ident" id="4448019">itemPipe</span><span class="op" id="4448027">:</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448031">default</span><span class="op" id="4448038">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4448043">t</span><span class="op" id="4448044">.</span><span class="ident" id="4448045">errorf</span><span class="op" id="4448051">(</span><span class="string" id="4448052">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;operand;&nbsp;missing&nbsp;space?&#34;</span><span class="op" id="4448094">,</span>&nbsp;<span class="ident" id="4448096">token</span><span class="op" id="4448101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4448105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448109">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4448116">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448119">if</span>&nbsp;<span class="builtinfunc" id="4448122">len</span><span class="op" id="4448125">(</span><span class="ident" id="4448126">cmd</span><span class="op" id="4448129">.</span><span class="ident" id="4448130">Args</span><span class="op" id="4448134">)</span>&nbsp;<span class="op" id="4448136">==</span>&nbsp;<span class="num" id="4448139">0</span>&nbsp;<span class="op" id="4448141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4448145">t</span><span class="op" id="4448146">.</span><span class="ident" id="4448147">errorf</span><span class="op" id="4448153">(</span><span class="string" id="4448154">&#34;empty&nbsp;command&#34;</span><span class="op" id="4448169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4448172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448175">return</span>&nbsp;<span class="ident" id="4448182">cmd</span><br>
<span class="lineno"></span><span class="op" id="4448186">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="comment" id="4448189">//&nbsp;operand:</span><br>
<span class="lineno"></span><span class="comment" id="4448201">//&nbsp;&nbsp;&nbsp;&nbsp;term&nbsp;.Field*</span><br>
<span class="lineno"></span><span class="comment" id="4448217">//&nbsp;An&nbsp;operand&nbsp;is&nbsp;a&nbsp;space-separated&nbsp;component&nbsp;of&nbsp;a&nbsp;command,</span><br>
<span class="lineno"></span><span class="comment" id="4448276">//&nbsp;a&nbsp;term&nbsp;possibly&nbsp;followed&nbsp;by&nbsp;field&nbsp;accesses.</span><br>
<span class="lineno">570</span><span class="comment" id="4448323">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;an&nbsp;operand.</span><br>
<span class="lineno"></span><span class="keyword" id="4448378">func</span>&nbsp;<span class="op" id="4448383">(</span><span class="ident" id="4448384">t</span>&nbsp;<span class="op" id="4448386">*</span><span class="ident" id="4448387">Tree</span><span class="op" id="4448391">)</span>&nbsp;<span class="ident" id="4448393">operand</span><span class="op" id="4448400">(</span><span class="op" id="4448401">)</span>&nbsp;<span class="ident" id="4448403">Node</span>&nbsp;<span class="op" id="4448408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4448411">node</span>&nbsp;<span class="op" id="4448416">:=</span>&nbsp;<span class="ident" id="4448419">t</span><span class="op" id="4448420">.</span><span class="ident" id="4448421">term</span><span class="op" id="4448425">(</span><span class="op" id="4448426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448429">if</span>&nbsp;<span class="ident" id="4448432">node</span>&nbsp;<span class="op" id="4448437">==</span>&nbsp;<span class="builtintype" id="4448440">nil</span>&nbsp;<span class="op" id="4448444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448448">return</span>&nbsp;<span class="builtintype" id="4448455">nil</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4448460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448463">if</span>&nbsp;<span class="ident" id="4448466">t</span><span class="op" id="4448467">.</span><span class="ident" id="4448468">peek</span><span class="op" id="4448472">(</span><span class="op" id="4448473">)</span><span class="op" id="4448474">.</span><span class="ident" id="4448475">typ</span>&nbsp;<span class="op" id="4448479">==</span>&nbsp;<span class="ident" id="4448482">itemField</span>&nbsp;<span class="op" id="4448492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4448496">chain</span>&nbsp;<span class="op" id="4448502">:=</span>&nbsp;<span class="ident" id="4448505">t</span><span class="op" id="4448506">.</span><span class="ident" id="4448507">newChain</span><span class="op" id="4448515">(</span><span class="ident" id="4448516">t</span><span class="op" id="4448517">.</span><span class="ident" id="4448518">peek</span><span class="op" id="4448522">(</span><span class="op" id="4448523">)</span><span class="op" id="4448524">.</span><span class="ident" id="4448525">pos</span><span class="op" id="4448528">,</span>&nbsp;<span class="ident" id="4448530">node</span><span class="op" id="4448534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448538">for</span>&nbsp;<span class="ident" id="4448542">t</span><span class="op" id="4448543">.</span><span class="ident" id="4448544">peek</span><span class="op" id="4448548">(</span><span class="op" id="4448549">)</span><span class="op" id="4448550">.</span><span class="ident" id="4448551">typ</span>&nbsp;<span class="op" id="4448555">==</span>&nbsp;<span class="ident" id="4448558">itemField</span>&nbsp;<span class="op" id="4448568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4448573">chain</span><span class="op" id="4448578">.</span><span class="ident" id="4448579">Add</span><span class="op" id="4448582">(</span><span class="ident" id="4448583">t</span><span class="op" id="4448584">.</span><span class="ident" id="4448585">next</span><span class="op" id="4448589">(</span><span class="op" id="4448590">)</span><span class="op" id="4448591">.</span><span class="ident" id="4448592">val</span><span class="op" id="4448595">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4448599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4448603">//&nbsp;Compatibility&nbsp;with&nbsp;original&nbsp;API:&nbsp;If&nbsp;the&nbsp;term&nbsp;is&nbsp;of&nbsp;type&nbsp;NodeField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4448674">//&nbsp;or&nbsp;NodeVariable,&nbsp;just&nbsp;put&nbsp;more&nbsp;fields&nbsp;on&nbsp;the&nbsp;original.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4448734">//&nbsp;Otherwise,&nbsp;keep&nbsp;the&nbsp;Chain&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4448771">//&nbsp;TODO:&nbsp;Switch&nbsp;to&nbsp;Chains&nbsp;always&nbsp;when&nbsp;we&nbsp;can.</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448819">switch</span>&nbsp;<span class="ident" id="4448826">node</span><span class="op" id="4448830">.</span><span class="ident" id="4448831">Type</span><span class="op" id="4448835">(</span><span class="op" id="4448836">)</span>&nbsp;<span class="op" id="4448838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448842">case</span>&nbsp;<span class="ident" id="4448847">NodeField</span><span class="op" id="4448856">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4448861">node</span>&nbsp;<span class="op" id="4448866">=</span>&nbsp;<span class="ident" id="4448868">t</span><span class="op" id="4448869">.</span><span class="ident" id="4448870">newField</span><span class="op" id="4448878">(</span><span class="ident" id="4448879">chain</span><span class="op" id="4448884">.</span><span class="ident" id="4448885">Position</span><span class="op" id="4448893">(</span><span class="op" id="4448894">)</span><span class="op" id="4448895">,</span>&nbsp;<span class="ident" id="4448897">chain</span><span class="op" id="4448902">.</span><span class="ident" id="4448903">String</span><span class="op" id="4448909">(</span><span class="op" id="4448910">)</span><span class="op" id="4448911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448915">case</span>&nbsp;<span class="ident" id="4448920">NodeVariable</span><span class="op" id="4448932">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4448937">node</span>&nbsp;<span class="op" id="4448942">=</span>&nbsp;<span class="ident" id="4448944">t</span><span class="op" id="4448945">.</span><span class="ident" id="4448946">newVariable</span><span class="op" id="4448957">(</span><span class="ident" id="4448958">chain</span><span class="op" id="4448963">.</span><span class="ident" id="4448964">Position</span><span class="op" id="4448972">(</span><span class="op" id="4448973">)</span><span class="op" id="4448974">,</span>&nbsp;<span class="ident" id="4448976">chain</span><span class="op" id="4448981">.</span><span class="ident" id="4448982">String</span><span class="op" id="4448988">(</span><span class="op" id="4448989">)</span><span class="op" id="4448990">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4448994">default</span><span class="op" id="4449001">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449006">node</span>&nbsp;<span class="op" id="4449011">=</span>&nbsp;<span class="ident" id="4449013">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4449021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4449024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449027">return</span>&nbsp;<span class="ident" id="4449034">node</span><br>
<span class="lineno">595</span><span class="op" id="4449039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4449042">//&nbsp;term:</span><br>
<span class="lineno"></span><span class="comment" id="4449051">//&nbsp;&nbsp;&nbsp;&nbsp;literal&nbsp;(number,&nbsp;string,&nbsp;nil,&nbsp;boolean)</span><br>
<span class="lineno"></span><span class="comment" id="4449093">//&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;(identifier)</span><br>
<span class="lineno">600</span><span class="comment" id="4449118">//&nbsp;&nbsp;&nbsp;&nbsp;.</span><br>
<span class="lineno"></span><span class="comment" id="4449123">//&nbsp;&nbsp;&nbsp;&nbsp;.Field</span><br>
<span class="lineno"></span><span class="comment" id="4449133">//&nbsp;&nbsp;&nbsp;&nbsp;$</span><br>
<span class="lineno"></span><span class="comment" id="4449138">//&nbsp;&nbsp;&nbsp;&nbsp;&#39;(&#39;&nbsp;pipeline&nbsp;&#39;)&#39;</span><br>
<span class="lineno"></span><span class="comment" id="4449158">//&nbsp;A&nbsp;term&nbsp;is&nbsp;a&nbsp;simple&nbsp;&#34;expression&#34;.</span><br>
<span class="lineno">605</span><span class="comment" id="4449194">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;a&nbsp;term.</span><br>
<span class="lineno"></span><span class="keyword" id="4449245">func</span>&nbsp;<span class="op" id="4449250">(</span><span class="ident" id="4449251">t</span>&nbsp;<span class="op" id="4449253">*</span><span class="ident" id="4449254">Tree</span><span class="op" id="4449258">)</span>&nbsp;<span class="ident" id="4449260">term</span><span class="op" id="4449264">(</span><span class="op" id="4449265">)</span>&nbsp;<span class="ident" id="4449267">Node</span>&nbsp;<span class="op" id="4449272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449275">switch</span>&nbsp;<span class="ident" id="4449282">token</span>&nbsp;<span class="op" id="4449288">:=</span>&nbsp;<span class="ident" id="4449291">t</span><span class="op" id="4449292">.</span><span class="ident" id="4449293">nextNonSpace</span><span class="op" id="4449305">(</span><span class="op" id="4449306">)</span><span class="op" id="4449307">;</span>&nbsp;<span class="ident" id="4449309">token</span><span class="op" id="4449314">.</span><span class="ident" id="4449315">typ</span>&nbsp;<span class="op" id="4449319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449322">case</span>&nbsp;<span class="ident" id="4449327">itemError</span><span class="op" id="4449336">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449340">t</span><span class="op" id="4449341">.</span><span class="ident" id="4449342">errorf</span><span class="op" id="4449348">(</span><span class="string" id="4449349">&#34;%s&#34;</span><span class="op" id="4449353">,</span>&nbsp;<span class="ident" id="4449355">token</span><span class="op" id="4449360">.</span><span class="ident" id="4449361">val</span><span class="op" id="4449364">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449367">case</span>&nbsp;<span class="ident" id="4449372">itemIdentifier</span><span class="op" id="4449386">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449390">if</span>&nbsp;<span class="op" id="4449393">!</span><span class="ident" id="4449394">t</span><span class="op" id="4449395">.</span><span class="ident" id="4449396">hasFunction</span><span class="op" id="4449407">(</span><span class="ident" id="4449408">token</span><span class="op" id="4449413">.</span><span class="ident" id="4449414">val</span><span class="op" id="4449417">)</span>&nbsp;<span class="op" id="4449419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449424">t</span><span class="op" id="4449425">.</span><span class="ident" id="4449426">errorf</span><span class="op" id="4449432">(</span><span class="string" id="4449433">&#34;function&nbsp;%q&nbsp;not&nbsp;defined&#34;</span><span class="op" id="4449458">,</span>&nbsp;<span class="ident" id="4449460">token</span><span class="op" id="4449465">.</span><span class="ident" id="4449466">val</span><span class="op" id="4449469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4449473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449477">return</span>&nbsp;<span class="ident" id="4449484">NewIdentifier</span><span class="op" id="4449497">(</span><span class="ident" id="4449498">token</span><span class="op" id="4449503">.</span><span class="ident" id="4449504">val</span><span class="op" id="4449507">)</span><span class="op" id="4449508">.</span><span class="ident" id="4449509">SetTree</span><span class="op" id="4449516">(</span><span class="ident" id="4449517">t</span><span class="op" id="4449518">)</span><span class="op" id="4449519">.</span><span class="ident" id="4449520">SetPos</span><span class="op" id="4449526">(</span><span class="ident" id="4449527">token</span><span class="op" id="4449532">.</span><span class="ident" id="4449533">pos</span><span class="op" id="4449536">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449539">case</span>&nbsp;<span class="ident" id="4449544">itemDot</span><span class="op" id="4449551">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449555">return</span>&nbsp;<span class="ident" id="4449562">t</span><span class="op" id="4449563">.</span><span class="ident" id="4449564">newDot</span><span class="op" id="4449570">(</span><span class="ident" id="4449571">token</span><span class="op" id="4449576">.</span><span class="ident" id="4449577">pos</span><span class="op" id="4449580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449583">case</span>&nbsp;<span class="ident" id="4449588">itemNil</span><span class="op" id="4449595">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449599">return</span>&nbsp;<span class="ident" id="4449606">t</span><span class="op" id="4449607">.</span><span class="ident" id="4449608">newNil</span><span class="op" id="4449614">(</span><span class="ident" id="4449615">token</span><span class="op" id="4449620">.</span><span class="ident" id="4449621">pos</span><span class="op" id="4449624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449627">case</span>&nbsp;<span class="ident" id="4449632">itemVariable</span><span class="op" id="4449644">:</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449648">return</span>&nbsp;<span class="ident" id="4449655">t</span><span class="op" id="4449656">.</span><span class="ident" id="4449657">useVar</span><span class="op" id="4449663">(</span><span class="ident" id="4449664">token</span><span class="op" id="4449669">.</span><span class="ident" id="4449670">pos</span><span class="op" id="4449673">,</span>&nbsp;<span class="ident" id="4449675">token</span><span class="op" id="4449680">.</span><span class="ident" id="4449681">val</span><span class="op" id="4449684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449687">case</span>&nbsp;<span class="ident" id="4449692">itemField</span><span class="op" id="4449701">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449705">return</span>&nbsp;<span class="ident" id="4449712">t</span><span class="op" id="4449713">.</span><span class="ident" id="4449714">newField</span><span class="op" id="4449722">(</span><span class="ident" id="4449723">token</span><span class="op" id="4449728">.</span><span class="ident" id="4449729">pos</span><span class="op" id="4449732">,</span>&nbsp;<span class="ident" id="4449734">token</span><span class="op" id="4449739">.</span><span class="ident" id="4449740">val</span><span class="op" id="4449743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449746">case</span>&nbsp;<span class="ident" id="4449751">itemBool</span><span class="op" id="4449759">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449763">return</span>&nbsp;<span class="ident" id="4449770">t</span><span class="op" id="4449771">.</span><span class="ident" id="4449772">newBool</span><span class="op" id="4449779">(</span><span class="ident" id="4449780">token</span><span class="op" id="4449785">.</span><span class="ident" id="4449786">pos</span><span class="op" id="4449789">,</span>&nbsp;<span class="ident" id="4449791">token</span><span class="op" id="4449796">.</span><span class="ident" id="4449797">val</span>&nbsp;<span class="op" id="4449801">==</span>&nbsp;<span class="string" id="4449804">&#34;true&#34;</span><span class="op" id="4449810">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449813">case</span>&nbsp;<span class="ident" id="4449818">itemCharConstant</span><span class="op" id="4449834">,</span>&nbsp;<span class="ident" id="4449836">itemComplex</span><span class="op" id="4449847">,</span>&nbsp;<span class="ident" id="4449849">itemNumber</span><span class="op" id="4449859">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449863">number</span><span class="op" id="4449869">,</span>&nbsp;<span class="ident" id="4449871">err</span>&nbsp;<span class="op" id="4449875">:=</span>&nbsp;<span class="ident" id="4449878">t</span><span class="op" id="4449879">.</span><span class="ident" id="4449880">newNumber</span><span class="op" id="4449889">(</span><span class="ident" id="4449890">token</span><span class="op" id="4449895">.</span><span class="ident" id="4449896">pos</span><span class="op" id="4449899">,</span>&nbsp;<span class="ident" id="4449901">token</span><span class="op" id="4449906">.</span><span class="ident" id="4449907">val</span><span class="op" id="4449910">,</span>&nbsp;<span class="ident" id="4449912">token</span><span class="op" id="4449917">.</span><span class="ident" id="4449918">typ</span><span class="op" id="4449921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449925">if</span>&nbsp;<span class="ident" id="4449928">err</span>&nbsp;<span class="op" id="4449932">!=</span>&nbsp;<span class="builtintype" id="4449935">nil</span>&nbsp;<span class="op" id="4449939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4449944">t</span><span class="op" id="4449945">.</span><span class="builtintype" id="4449946">error</span><span class="op" id="4449951">(</span><span class="ident" id="4449952">err</span><span class="op" id="4449955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4449959">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449963">return</span>&nbsp;<span class="ident" id="4449970">number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4449978">case</span>&nbsp;<span class="ident" id="4449983">itemLeftParen</span><span class="op" id="4449996">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4450000">pipe</span>&nbsp;<span class="op" id="4450005">:=</span>&nbsp;<span class="ident" id="4450008">t</span><span class="op" id="4450009">.</span><span class="ident" id="4450010">pipeline</span><span class="op" id="4450018">(</span><span class="string" id="4450019">&#34;parenthesized&nbsp;pipeline&#34;</span><span class="op" id="4450043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450047">if</span>&nbsp;<span class="ident" id="4450050">token</span>&nbsp;<span class="op" id="4450056">:=</span>&nbsp;<span class="ident" id="4450059">t</span><span class="op" id="4450060">.</span><span class="ident" id="4450061">next</span><span class="op" id="4450065">(</span><span class="op" id="4450066">)</span><span class="op" id="4450067">;</span>&nbsp;<span class="ident" id="4450069">token</span><span class="op" id="4450074">.</span><span class="ident" id="4450075">typ</span>&nbsp;<span class="op" id="4450079">!=</span>&nbsp;<span class="ident" id="4450082">itemRightParen</span>&nbsp;<span class="op" id="4450097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4450102">t</span><span class="op" id="4450103">.</span><span class="ident" id="4450104">errorf</span><span class="op" id="4450110">(</span><span class="string" id="4450111">&#34;unclosed&nbsp;right&nbsp;paren:&nbsp;unexpected&nbsp;%s&#34;</span><span class="op" id="4450148">,</span>&nbsp;<span class="ident" id="4450150">token</span><span class="op" id="4450155">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4450159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450163">return</span>&nbsp;<span class="ident" id="4450170">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450176">case</span>&nbsp;<span class="ident" id="4450181">itemString</span><span class="op" id="4450191">,</span>&nbsp;<span class="ident" id="4450193">itemRawString</span><span class="op" id="4450206">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4450210">s</span><span class="op" id="4450211">,</span>&nbsp;<span class="ident" id="4450213">err</span>&nbsp;<span class="op" id="4450217">:=</span>&nbsp;<span class="ident" id="4450220">strconv</span><span class="op" id="4450227">.</span><span class="ident" id="4450228">Unquote</span><span class="op" id="4450235">(</span><span class="ident" id="4450236">token</span><span class="op" id="4450241">.</span><span class="ident" id="4450242">val</span><span class="op" id="4450245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450249">if</span>&nbsp;<span class="ident" id="4450252">err</span>&nbsp;<span class="op" id="4450256">!=</span>&nbsp;<span class="builtintype" id="4450259">nil</span>&nbsp;<span class="op" id="4450263">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4450268">t</span><span class="op" id="4450269">.</span><span class="builtintype" id="4450270">error</span><span class="op" id="4450275">(</span><span class="ident" id="4450276">err</span><span class="op" id="4450279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4450283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450287">return</span>&nbsp;<span class="ident" id="4450294">t</span><span class="op" id="4450295">.</span><span class="ident" id="4450296">newString</span><span class="op" id="4450305">(</span><span class="ident" id="4450306">token</span><span class="op" id="4450311">.</span><span class="ident" id="4450312">pos</span><span class="op" id="4450315">,</span>&nbsp;<span class="ident" id="4450317">token</span><span class="op" id="4450322">.</span><span class="ident" id="4450323">val</span><span class="op" id="4450326">,</span>&nbsp;<span class="ident" id="4450328">s</span><span class="op" id="4450329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4450332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4450335">t</span><span class="op" id="4450336">.</span><span class="ident" id="4450337">backup</span><span class="op" id="4450343">(</span><span class="op" id="4450344">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450347">return</span>&nbsp;<span class="builtintype" id="4450354">nil</span><br>
<span class="lineno"></span><span class="op" id="4450358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4450361">//&nbsp;hasFunction&nbsp;reports&nbsp;if&nbsp;a&nbsp;function&nbsp;name&nbsp;exists&nbsp;in&nbsp;the&nbsp;Tree&#39;s&nbsp;maps.</span><br>
<span class="lineno"></span><span class="keyword" id="4450430">func</span>&nbsp;<span class="op" id="4450435">(</span><span class="ident" id="4450436">t</span>&nbsp;<span class="op" id="4450438">*</span><span class="ident" id="4450439">Tree</span><span class="op" id="4450443">)</span>&nbsp;<span class="ident" id="4450445">hasFunction</span><span class="op" id="4450456">(</span><span class="ident" id="4450457">name</span>&nbsp;<span class="builtintype" id="4450462">string</span><span class="op" id="4450468">)</span>&nbsp;<span class="builtintype" id="4450470">bool</span>&nbsp;<span class="op" id="4450475">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450478">for</span>&nbsp;<span class="ident" id="4450482">_</span><span class="op" id="4450483">,</span>&nbsp;<span class="ident" id="4450485">funcMap</span>&nbsp;<span class="op" id="4450493">:=</span>&nbsp;<span class="keyword" id="4450496">range</span>&nbsp;<span class="ident" id="4450502">t</span><span class="op" id="4450503">.</span><span class="ident" id="4450504">funcs</span>&nbsp;<span class="op" id="4450510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450514">if</span>&nbsp;<span class="ident" id="4450517">funcMap</span>&nbsp;<span class="op" id="4450525">==</span>&nbsp;<span class="builtintype" id="4450528">nil</span>&nbsp;<span class="op" id="4450532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450537">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4450548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450552">if</span>&nbsp;<span class="ident" id="4450555">funcMap</span><span class="op" id="4450562">[</span><span class="ident" id="4450563">name</span><span class="op" id="4450567">]</span>&nbsp;<span class="op" id="4450569">!=</span>&nbsp;<span class="builtintype" id="4450572">nil</span>&nbsp;<span class="op" id="4450576">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450581">return</span>&nbsp;<span class="builtintype" id="4450588">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4450595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4450598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450601">return</span>&nbsp;<span class="builtintype" id="4450608">false</span><br>
<span class="lineno"></span><span class="op" id="4450614">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="comment" id="4450617">//&nbsp;popVars&nbsp;trims&nbsp;the&nbsp;variable&nbsp;list&nbsp;to&nbsp;the&nbsp;specified&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="4450676">func</span>&nbsp;<span class="op" id="4450681">(</span><span class="ident" id="4450682">t</span>&nbsp;<span class="op" id="4450684">*</span><span class="ident" id="4450685">Tree</span><span class="op" id="4450689">)</span>&nbsp;<span class="ident" id="4450691">popVars</span><span class="op" id="4450698">(</span><span class="ident" id="4450699">n</span>&nbsp;<span class="builtintype" id="4450701">int</span><span class="op" id="4450704">)</span>&nbsp;<span class="op" id="4450706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4450709">t</span><span class="op" id="4450710">.</span><span class="ident" id="4450711">vars</span>&nbsp;<span class="op" id="4450716">=</span>&nbsp;<span class="ident" id="4450718">t</span><span class="op" id="4450719">.</span><span class="ident" id="4450720">vars</span><span class="op" id="4450724">[</span><span class="op" id="4450725">:</span><span class="ident" id="4450726">n</span><span class="op" id="4450727">]</span><br>
<span class="lineno"></span><span class="op" id="4450729">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="4450732">//&nbsp;useVar&nbsp;returns&nbsp;a&nbsp;node&nbsp;for&nbsp;a&nbsp;variable&nbsp;reference.&nbsp;It&nbsp;errors&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4450800">//&nbsp;variable&nbsp;is&nbsp;not&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="4450828">func</span>&nbsp;<span class="op" id="4450833">(</span><span class="ident" id="4450834">t</span>&nbsp;<span class="op" id="4450836">*</span><span class="ident" id="4450837">Tree</span><span class="op" id="4450841">)</span>&nbsp;<span class="ident" id="4450843">useVar</span><span class="op" id="4450849">(</span><span class="ident" id="4450850">pos</span>&nbsp;<span class="ident" id="4450854">Pos</span><span class="op" id="4450857">,</span>&nbsp;<span class="ident" id="4450859">name</span>&nbsp;<span class="builtintype" id="4450864">string</span><span class="op" id="4450870">)</span>&nbsp;<span class="ident" id="4450872">Node</span>&nbsp;<span class="op" id="4450877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4450880">v</span>&nbsp;<span class="op" id="4450882">:=</span>&nbsp;<span class="ident" id="4450885">t</span><span class="op" id="4450886">.</span><span class="ident" id="4450887">newVariable</span><span class="op" id="4450898">(</span><span class="ident" id="4450899">pos</span><span class="op" id="4450902">,</span>&nbsp;<span class="ident" id="4450904">name</span><span class="op" id="4450908">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450911">for</span>&nbsp;<span class="ident" id="4450915">_</span><span class="op" id="4450916">,</span>&nbsp;<span class="ident" id="4450918">varName</span>&nbsp;<span class="op" id="4450926">:=</span>&nbsp;<span class="keyword" id="4450929">range</span>&nbsp;<span class="ident" id="4450935">t</span><span class="op" id="4450936">.</span><span class="ident" id="4450937">vars</span>&nbsp;<span class="op" id="4450942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450946">if</span>&nbsp;<span class="ident" id="4450949">varName</span>&nbsp;<span class="op" id="4450957">==</span>&nbsp;<span class="ident" id="4450960">v</span><span class="op" id="4450961">.</span><span class="ident" id="4450962">Ident</span><span class="op" id="4450967">[</span><span class="num" id="4450968">0</span><span class="op" id="4450969">]</span>&nbsp;<span class="op" id="4450971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4450976">return</span>&nbsp;<span class="ident" id="4450983">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4450987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4450990">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4450993">t</span><span class="op" id="4450994">.</span><span class="ident" id="4450995">errorf</span><span class="op" id="4451001">(</span><span class="string" id="4451002">&#34;undefined&nbsp;variable&nbsp;%q&#34;</span><span class="op" id="4451025">,</span>&nbsp;<span class="ident" id="4451027">v</span><span class="op" id="4451028">.</span><span class="ident" id="4451029">Ident</span><span class="op" id="4451034">[</span><span class="num" id="4451035">0</span><span class="op" id="4451036">]</span><span class="op" id="4451037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4451040">return</span>&nbsp;<span class="builtintype" id="4451047">nil</span><br>
<span class="lineno"></span><span class="op" id="4451051">}</span>
</div>
</body>
</html>
