<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;BUG(mikio):&nbsp;On&nbsp;every&nbsp;POSIX&nbsp;platform,&nbsp;reads&nbsp;from&nbsp;the&nbsp;&#34;ip4&#34;&nbsp;network</span><br>
<span class="lineno">15</span><span class="comment">//&nbsp;using&nbsp;the&nbsp;ReadFrom&nbsp;or&nbsp;ReadFromIP&nbsp;method&nbsp;might&nbsp;not&nbsp;return&nbsp;a&nbsp;complete</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;IPv4&nbsp;packet,&nbsp;including&nbsp;its&nbsp;header,&nbsp;even&nbsp;if&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;available.&nbsp;This&nbsp;can&nbsp;occur&nbsp;even&nbsp;in&nbsp;cases&nbsp;where&nbsp;Read&nbsp;or&nbsp;ReadMsgIP</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;could&nbsp;return&nbsp;a&nbsp;complete&nbsp;packet.&nbsp;For&nbsp;this&nbsp;reason,&nbsp;it&nbsp;is&nbsp;recommended</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;that&nbsp;you&nbsp;do&nbsp;not&nbsp;uses&nbsp;these&nbsp;methods&nbsp;if&nbsp;it&nbsp;is&nbsp;important&nbsp;to&nbsp;receive&nbsp;a</span><br>
<span class="lineno">20</span><span class="comment">//&nbsp;full&nbsp;packet.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;Go&nbsp;1&nbsp;compatibility&nbsp;guidelines&nbsp;make&nbsp;it&nbsp;impossible&nbsp;for&nbsp;us&nbsp;to</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;change&nbsp;the&nbsp;behavior&nbsp;of&nbsp;these&nbsp;methods;&nbsp;use&nbsp;Read&nbsp;or&nbsp;ReadMsgIP</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;instead.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">sockaddrToIP</span><span class="op">(</span><span class="ident">sa</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Sockaddr</span><span class="op">)</span>&nbsp;<span class="ident">Addr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">sa</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">sa</span><span class="op">.</span><span class="op">(</span><span class="keyword">type</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">SockaddrInet4</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">IPAddr</span><span class="op">{</span><span class="ident">IP</span><span class="op">:</span>&nbsp;<span class="ident">sa</span><span class="op">.</span><span class="ident">Addr</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><span class="op">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">SockaddrInet6</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">IPAddr</span><span class="op">{</span><span class="ident">IP</span><span class="op">:</span>&nbsp;<span class="ident">sa</span><span class="op">.</span><span class="ident">Addr</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">Zone</span><span class="op">:</span>&nbsp;<span class="ident">zoneToString</span><span class="op">(</span><span class="builtintype">int</span><span class="op">(</span><span class="ident">sa</span><span class="op">.</span><span class="ident">ZoneId</span><span class="op">)</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">a</span>&nbsp;<span class="op">*</span><span class="ident">IPAddr</span><span class="op">)</span>&nbsp;<span class="ident">family</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">a</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">a</span><span class="op">.</span><span class="ident">IP</span><span class="op">)</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">IPv4len</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">IP</span><span class="op">.</span><span class="ident">To4</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_INET6</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">a</span>&nbsp;<span class="op">*</span><span class="ident">IPAddr</span><span class="op">)</span>&nbsp;<span class="ident">isWildcard</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">a</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">IP</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">IP</span><span class="op">.</span><span class="ident">IsUnspecified</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">a</span>&nbsp;<span class="op">*</span><span class="ident">IPAddr</span><span class="op">)</span>&nbsp;<span class="ident">sockaddr</span><span class="op">(</span><span class="ident">family</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">Sockaddr</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">a</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">ipToSockaddr</span><span class="op">(</span><span class="ident">family</span><span class="op">,</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">IP</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">Zone</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment">//&nbsp;IPConn&nbsp;is&nbsp;the&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;and&nbsp;PacketConn&nbsp;interfaces</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;for&nbsp;IP&nbsp;network&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">IPConn</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">conn</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">newIPConn</span><span class="op">(</span><span class="ident">fd</span>&nbsp;<span class="op">*</span><span class="ident">netFD</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">IPConn</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">IPConn</span><span class="op">{</span><span class="ident">conn</span><span class="op">{</span><span class="ident">fd</span><span class="op">}</span><span class="op">}</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ReadFromIP&nbsp;reads&nbsp;an&nbsp;IP&nbsp;packet&nbsp;from&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;into&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;b&nbsp;and&nbsp;the&nbsp;return&nbsp;address</span><br>
<span class="lineno">70</span><span class="comment">//&nbsp;that&nbsp;was&nbsp;on&nbsp;the&nbsp;packet.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ReadFromIP&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;an&nbsp;error&nbsp;with</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Timeout()&nbsp;==&nbsp;true&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;SetReadDeadline.</span><br>
<span class="lineno">75</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">IPConn</span><span class="op">)</span>&nbsp;<span class="ident">ReadFromIP</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">IPAddr</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">c</span><span class="op">.</span><span class="ident">ok</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO(cw,rsc):&nbsp;consider&nbsp;using&nbsp;readv&nbsp;if&nbsp;we&nbsp;know&nbsp;the&nbsp;family</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;type&nbsp;to&nbsp;avoid&nbsp;the&nbsp;header&nbsp;trim/copy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">addr</span>&nbsp;<span class="op">*</span><span class="ident">IPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">sa</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">fd</span><span class="op">.</span><span class="ident">readFrom</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">sa</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">sa</span><span class="op">.</span><span class="op">(</span><span class="keyword">type</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">SockaddrInet4</span><span class="op">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">addr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">IPAddr</span><span class="op">{</span><span class="ident">IP</span><span class="op">:</span>&nbsp;<span class="ident">sa</span><span class="op">.</span><span class="ident">Addr</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">IPv4len</span>&nbsp;<span class="op">{</span>&nbsp;<span class="comment">//&nbsp;discard&nbsp;ipv4&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hsize</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="builtintype">int</span><span class="op">(</span><span class="ident">b</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">0xf</span><span class="op">)</span>&nbsp;<span class="op">*</span>&nbsp;<span class="num">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">[</span><span class="ident">hsize</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="ident">hsize</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">SockaddrInet6</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">addr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">IPAddr</span><span class="op">{</span><span class="ident">IP</span><span class="op">:</span>&nbsp;<span class="ident">sa</span><span class="op">.</span><span class="ident">Addr</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">Zone</span><span class="op">:</span>&nbsp;<span class="ident">zoneToString</span><span class="op">(</span><span class="builtintype">int</span><span class="op">(</span><span class="ident">sa</span><span class="op">.</span><span class="ident">ZoneId</span><span class="op">)</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">addr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno">95</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;PacketConn&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">IPConn</span><span class="op">)</span>&nbsp;<span class="ident">ReadFrom</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">c</span><span class="op">.</span><span class="ident">ok</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">addr</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">ReadFromIP</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">addr</span><span class="op">.</span><span class="ident">toAddr</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ReadMsgIP&nbsp;reads&nbsp;a&nbsp;packet&nbsp;from&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;into&nbsp;b&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;associated&nbsp;out-of-band&nbsp;data&nbsp;into&nbsp;oob.&nbsp;&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;b,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;oob,&nbsp;the&nbsp;flags</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;that&nbsp;were&nbsp;set&nbsp;on&nbsp;the&nbsp;packet&nbsp;and&nbsp;the&nbsp;source&nbsp;address&nbsp;of&nbsp;the&nbsp;packet.</span><br>
<span class="lineno">110</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">IPConn</span><span class="op">)</span>&nbsp;<span class="ident">ReadMsgIP</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">oob</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">oobn</span><span class="op">,</span>&nbsp;<span class="ident">flags</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">addr</span>&nbsp;<span class="op">*</span><span class="ident">IPAddr</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">c</span><span class="op">.</span><span class="ident">ok</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">sa</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Sockaddr</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">oobn</span><span class="op">,</span>&nbsp;<span class="ident">flags</span><span class="op">,</span>&nbsp;<span class="ident">sa</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">fd</span><span class="op">.</span><span class="ident">readMsg</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">oob</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">sa</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">sa</span><span class="op">.</span><span class="op">(</span><span class="keyword">type</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">SockaddrInet4</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">addr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">IPAddr</span><span class="op">{</span><span class="ident">IP</span><span class="op">:</span>&nbsp;<span class="ident">sa</span><span class="op">.</span><span class="ident">Addr</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">SockaddrInet6</span><span class="op">:</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">addr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">IPAddr</span><span class="op">{</span><span class="ident">IP</span><span class="op">:</span>&nbsp;<span class="ident">sa</span><span class="op">.</span><span class="ident">Addr</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">Zone</span><span class="op">:</span>&nbsp;<span class="ident">zoneToString</span><span class="op">(</span><span class="builtintype">int</span><span class="op">(</span><span class="ident">sa</span><span class="op">.</span><span class="ident">ZoneId</span><span class="op">)</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment">//&nbsp;WriteToIP&nbsp;writes&nbsp;an&nbsp;IP&nbsp;packet&nbsp;to&nbsp;addr&nbsp;via&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;WriteToIP&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;an&nbsp;error&nbsp;with</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Timeout()&nbsp;==&nbsp;true&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and</span><br>
<span class="lineno">130</span><span class="comment">//&nbsp;SetWriteDeadline.&nbsp;&nbsp;On&nbsp;packet-oriented&nbsp;connections,&nbsp;write&nbsp;timeouts</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;are&nbsp;rare.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">IPConn</span><span class="op">)</span>&nbsp;<span class="ident">WriteToIP</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">addr</span>&nbsp;<span class="op">*</span><span class="ident">IPAddr</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">c</span><span class="op">.</span><span class="ident">ok</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EINVAL</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">fd</span><span class="op">.</span><span class="ident">isConnected</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;write&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">fd</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">addr</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="ident">ErrWriteToConnected</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">addr</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;write&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">fd</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="ident">errMissingAddress</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sa</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">addr</span><span class="op">.</span><span class="ident">sockaddr</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">fd</span><span class="op">.</span><span class="ident">family</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="string">&#34;write&#34;</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">fd</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">addr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">fd</span><span class="op">.</span><span class="ident">writeTo</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">sa</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;WriteTo&nbsp;implements&nbsp;the&nbsp;PacketConn&nbsp;WriteTo&nbsp;method.</span><br>
<span class="lineno">150</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">IPConn</span><span class="op">)</span>&nbsp;<span class="ident">WriteTo</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">addr</span>&nbsp;<span class="ident">Addr</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">c</span><span class="op">.</span><span class="ident">ok</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">addr</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">IPAddr</span><span class="op">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="string">&#34;write&#34;</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">fd</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">addr</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EINVAL</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">WriteToIP</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">a</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;WriteMsgIP&nbsp;writes&nbsp;a&nbsp;packet&nbsp;to&nbsp;addr&nbsp;via&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;from</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;b&nbsp;and&nbsp;the&nbsp;associated&nbsp;out-of-band&nbsp;data&nbsp;from&nbsp;oob.&nbsp;&nbsp;It&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;number&nbsp;of&nbsp;payload&nbsp;and&nbsp;out-of-band&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">IPConn</span><span class="op">)</span>&nbsp;<span class="ident">WriteMsgIP</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">oob</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">addr</span>&nbsp;<span class="op">*</span><span class="ident">IPAddr</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">oobn</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">c</span><span class="op">.</span><span class="ident">ok</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">fd</span><span class="op">.</span><span class="ident">isConnected</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;write&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">fd</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">addr</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="ident">ErrWriteToConnected</span><span class="op">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">addr</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;write&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">fd</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="ident">errMissingAddress</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sa</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">addr</span><span class="op">.</span><span class="ident">sockaddr</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">fd</span><span class="op">.</span><span class="ident">family</span><span class="op">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="string">&#34;write&#34;</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">fd</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">addr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">fd</span><span class="op">.</span><span class="ident">writeMsg</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">oob</span><span class="op">,</span>&nbsp;<span class="ident">sa</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;DialIP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;protocol</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;netProto,&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;ip&#34;,&nbsp;&#34;ip4&#34;,&nbsp;or&nbsp;&#34;ip6&#34;&nbsp;followed&nbsp;by&nbsp;a&nbsp;colon</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;and&nbsp;a&nbsp;protocol&nbsp;number&nbsp;or&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">DialIP</span><span class="op">(</span><span class="ident">netProto</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">raddr</span>&nbsp;<span class="op">*</span><span class="ident">IPAddr</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">IPConn</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">dialIP</span><span class="op">(</span><span class="ident">netProto</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">raddr</span><span class="op">,</span>&nbsp;<span class="ident">noDeadline</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">dialIP</span><span class="op">(</span><span class="ident">netProto</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">raddr</span>&nbsp;<span class="op">*</span><span class="ident">IPAddr</span><span class="op">,</span>&nbsp;<span class="ident">deadline</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Time</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">IPConn</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">proto</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">parseNetwork</span><span class="op">(</span><span class="ident">netProto</span><span class="op">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;dial&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">netProto</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">raddr</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="ident">err</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">net</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;ip&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;ip4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;ip6&#34;</span><span class="op">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;dial&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">netProto</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">raddr</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="ident">UnknownNetworkError</span><span class="op">(</span><span class="ident">netProto</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">raddr</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;dial&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">netProto</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="ident">errMissingAddress</span><span class="op">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fd</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">internetSocket</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">raddr</span><span class="op">,</span>&nbsp;<span class="ident">deadline</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">SOCK_RAW</span><span class="op">,</span>&nbsp;<span class="ident">proto</span><span class="op">,</span>&nbsp;<span class="string">&#34;dial&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;dial&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">netProto</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">raddr</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="ident">err</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">newIPConn</span><span class="op">(</span><span class="ident">fd</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ListenIP&nbsp;listens&nbsp;for&nbsp;incoming&nbsp;IP&nbsp;packets&nbsp;addressed&nbsp;to&nbsp;the&nbsp;local</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;address&nbsp;laddr.&nbsp;&nbsp;The&nbsp;returned&nbsp;connection&#39;s&nbsp;ReadFrom&nbsp;and&nbsp;WriteTo</span><br>
<span class="lineno">210</span><span class="comment">//&nbsp;methods&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;receive&nbsp;and&nbsp;send&nbsp;IP&nbsp;packets&nbsp;with&nbsp;per-packet</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;addressing.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">ListenIP</span><span class="op">(</span><span class="ident">netProto</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span>&nbsp;<span class="op">*</span><span class="ident">IPAddr</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">IPConn</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">proto</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">parseNetwork</span><span class="op">(</span><span class="ident">netProto</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;dial&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">netProto</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="ident">err</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">net</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;ip&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;ip4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;ip6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;listen&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">netProto</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="ident">UnknownNetworkError</span><span class="op">(</span><span class="ident">netProto</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fd</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">internetSocket</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">noDeadline</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">SOCK_RAW</span><span class="op">,</span>&nbsp;<span class="ident">proto</span><span class="op">,</span>&nbsp;<span class="string">&#34;listen&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;listen&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">netProto</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="ident">err</span><span class="op">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">newIPConn</span><span class="op">(</span><span class="ident">fd</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
