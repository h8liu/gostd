<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>reflect</h2>
<ul>
<li><a href="/gostd/reflect/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/reflect/deepequal.go.html">deepequal.go</a></li>
<li><a href="/gostd/reflect/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/reflect/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/reflect/makefunc.go.html" class="current">makefunc.go</a></li>
<li><a href="/gostd/reflect/set_test.go.html">set_test.go</a></li>
<li><a href="/gostd/reflect/tostring_test.go.html">tostring_test.go</a></li>
<li><a href="/gostd/reflect/type.go.html">type.go</a></li>
<li><a href="/gostd/reflect/value.go.html">value.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2184190">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2184246">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2184300">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2184351">//&nbsp;MakeFunc&nbsp;implementation.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2184380">package</span>&nbsp;<span class="ident" id="2184388">reflect</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2184397">import</span>&nbsp;<span class="op" id="2184404">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2184407">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2184416">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2184419">//&nbsp;makeFuncImpl&nbsp;is&nbsp;the&nbsp;closure&nbsp;value&nbsp;implementing&nbsp;the&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2184482">//&nbsp;returned&nbsp;by&nbsp;MakeFunc.</span><br>
<span class="lineno">15</span><span class="keyword" id="2184507">type</span>&nbsp;<span class="ident" id="2184512">makeFuncImpl</span>&nbsp;<span class="keyword" id="2184525">struct</span>&nbsp;<span class="op" id="2184532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2184535">code</span>&nbsp;&nbsp;<span class="builtintype" id="2184541">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2184550">stack</span>&nbsp;<span class="op" id="2184556">*</span><span class="ident" id="2184557">bitVector</span>&nbsp;<span class="comment" id="2184567">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2184619">typ</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2184625">*</span><span class="ident" id="2184626">funcType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2184636">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2184642">func</span><span class="op" id="2184646">(</span><span class="op" id="2184647">[</span><span class="op" id="2184648">]</span><span class="ident" id="2184649">Value</span><span class="op" id="2184654">)</span>&nbsp;<span class="op" id="2184656">[</span><span class="op" id="2184657">]</span><span class="ident" id="2184658">Value</span><br>
<span class="lineno">20</span><span class="op" id="2184664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2184667">//&nbsp;MakeFunc&nbsp;returns&nbsp;a&nbsp;new&nbsp;function&nbsp;of&nbsp;the&nbsp;given&nbsp;Type</span><br>
<span class="lineno"></span><span class="comment" id="2184720">//&nbsp;that&nbsp;wraps&nbsp;the&nbsp;function&nbsp;fn.&nbsp;When&nbsp;called,&nbsp;that&nbsp;new&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2184782">//&nbsp;does&nbsp;the&nbsp;following:</span><br>
<span class="lineno">25</span><span class="comment" id="2184805">//</span><br>
<span class="lineno"></span><span class="comment" id="2184808">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;converts&nbsp;its&nbsp;arguments&nbsp;to&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values.</span><br>
<span class="lineno"></span><span class="comment" id="2184858">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;runs&nbsp;results&nbsp;:=&nbsp;fn(args).</span><br>
<span class="lineno"></span><span class="comment" id="2184889">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;returns&nbsp;the&nbsp;results&nbsp;as&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values,&nbsp;one&nbsp;per&nbsp;formal&nbsp;result.</span><br>
<span class="lineno"></span><span class="comment" id="2184959">//</span><br>
<span class="lineno">30</span><span class="comment" id="2184962">//&nbsp;The&nbsp;implementation&nbsp;fn&nbsp;can&nbsp;assume&nbsp;that&nbsp;the&nbsp;argument&nbsp;Value&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="2185028">//&nbsp;has&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;arguments&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2185082">//&nbsp;If&nbsp;typ&nbsp;describes&nbsp;a&nbsp;variadic&nbsp;function,&nbsp;the&nbsp;final&nbsp;Value&nbsp;is&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2185149">//&nbsp;a&nbsp;slice&nbsp;representing&nbsp;the&nbsp;variadic&nbsp;arguments,&nbsp;as&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2185207">//&nbsp;body&nbsp;of&nbsp;a&nbsp;variadic&nbsp;function.&nbsp;The&nbsp;result&nbsp;Value&nbsp;slice&nbsp;returned&nbsp;by&nbsp;fn</span><br>
<span class="lineno">35</span><span class="comment" id="2185277">//&nbsp;must&nbsp;have&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;results&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2185335">//</span><br>
<span class="lineno"></span><span class="comment" id="2185338">//&nbsp;The&nbsp;Value.Call&nbsp;method&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;invoke&nbsp;a&nbsp;typed&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2185408">//&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values;&nbsp;in&nbsp;contrast,&nbsp;MakeFunc&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;implement</span><br>
<span class="lineno"></span><span class="comment" id="2185484">//&nbsp;a&nbsp;typed&nbsp;function&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values.</span><br>
<span class="lineno">40</span><span class="comment" id="2185524">//</span><br>
<span class="lineno"></span><span class="comment" id="2185527">//&nbsp;The&nbsp;Examples&nbsp;section&nbsp;of&nbsp;the&nbsp;documentation&nbsp;includes&nbsp;an&nbsp;illustration</span><br>
<span class="lineno"></span><span class="comment" id="2185597">//&nbsp;of&nbsp;how&nbsp;to&nbsp;use&nbsp;MakeFunc&nbsp;to&nbsp;build&nbsp;a&nbsp;swap&nbsp;function&nbsp;for&nbsp;different&nbsp;types.</span><br>
<span class="lineno"></span><span class="comment" id="2185669">//</span><br>
<span class="lineno"></span><span class="keyword" id="2185672">func</span>&nbsp;<span class="ident" id="2185677">MakeFunc</span><span class="op" id="2185685">(</span><span class="ident" id="2185686">typ</span>&nbsp;<span class="ident" id="2185690">Type</span><span class="op" id="2185694">,</span>&nbsp;<span class="ident" id="2185696">fn</span>&nbsp;<span class="keyword" id="2185699">func</span><span class="op" id="2185703">(</span><span class="ident" id="2185704">args</span>&nbsp;<span class="op" id="2185709">[</span><span class="op" id="2185710">]</span><span class="ident" id="2185711">Value</span><span class="op" id="2185716">)</span>&nbsp;<span class="op" id="2185718">(</span><span class="ident" id="2185719">results</span>&nbsp;<span class="op" id="2185727">[</span><span class="op" id="2185728">]</span><span class="ident" id="2185729">Value</span><span class="op" id="2185734">)</span><span class="op" id="2185735">)</span>&nbsp;<span class="ident" id="2185737">Value</span>&nbsp;<span class="op" id="2185743">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2185746">if</span>&nbsp;<span class="ident" id="2185749">typ</span><span class="op" id="2185752">.</span><span class="ident" id="2185753">Kind</span><span class="op" id="2185757">(</span><span class="op" id="2185758">)</span>&nbsp;<span class="op" id="2185760">!=</span>&nbsp;<span class="ident" id="2185763">Func</span>&nbsp;<span class="op" id="2185768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2185772">panic</span><span class="op" id="2185777">(</span><span class="string" id="2185778">&#34;reflect:&nbsp;call&nbsp;of&nbsp;MakeFunc&nbsp;with&nbsp;non-Func&nbsp;type&#34;</span><span class="op" id="2185824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2185827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2185831">t</span>&nbsp;<span class="op" id="2185833">:=</span>&nbsp;<span class="ident" id="2185836">typ</span><span class="op" id="2185839">.</span><span class="ident" id="2185840">common</span><span class="op" id="2185846">(</span><span class="op" id="2185847">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2185850">ftyp</span>&nbsp;<span class="op" id="2185855">:=</span>&nbsp;<span class="op" id="2185858">(</span><span class="op" id="2185859">*</span><span class="ident" id="2185860">funcType</span><span class="op" id="2185868">)</span><span class="op" id="2185869">(</span><span class="ident" id="2185870">unsafe</span><span class="op" id="2185876">.</span><span class="ident" id="2185877">Pointer</span><span class="op" id="2185884">(</span><span class="ident" id="2185885">t</span><span class="op" id="2185886">)</span><span class="op" id="2185887">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2185891">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2185936">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2185991">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2186051">dummy</span>&nbsp;<span class="op" id="2186057">:=</span>&nbsp;<span class="ident" id="2186060">makeFuncStub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2186074">code</span>&nbsp;<span class="op" id="2186079">:=</span>&nbsp;<span class="op" id="2186082">*</span><span class="op" id="2186083">*</span><span class="op" id="2186084">(</span><span class="op" id="2186085">*</span><span class="op" id="2186086">*</span><span class="builtintype" id="2186087">uintptr</span><span class="op" id="2186094">)</span><span class="op" id="2186095">(</span><span class="ident" id="2186096">unsafe</span><span class="op" id="2186102">.</span><span class="ident" id="2186103">Pointer</span><span class="op" id="2186110">(</span><span class="op" id="2186111">&amp;</span><span class="ident" id="2186112">dummy</span><span class="op" id="2186117">)</span><span class="op" id="2186118">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2186122">//&nbsp;makeFuncImpl&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2186183">_</span><span class="op" id="2186184">,</span>&nbsp;<span class="ident" id="2186186">_</span><span class="op" id="2186187">,</span>&nbsp;<span class="ident" id="2186189">_</span><span class="op" id="2186190">,</span>&nbsp;<span class="ident" id="2186192">stack</span>&nbsp;<span class="op" id="2186198">:=</span>&nbsp;<span class="ident" id="2186201">funcLayout</span><span class="op" id="2186211">(</span><span class="ident" id="2186212">t</span><span class="op" id="2186213">,</span>&nbsp;<span class="ident" id="2186215">nil</span><span class="op" id="2186218">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2186222">impl</span>&nbsp;<span class="op" id="2186227">:=</span>&nbsp;<span class="op" id="2186230">&amp;</span><span class="ident" id="2186231">makeFuncImpl</span><span class="op" id="2186243">{</span><span class="ident" id="2186244">code</span><span class="op" id="2186248">:</span>&nbsp;<span class="ident" id="2186250">code</span><span class="op" id="2186254">,</span>&nbsp;<span class="ident" id="2186256">stack</span><span class="op" id="2186261">:</span>&nbsp;<span class="ident" id="2186263">stack</span><span class="op" id="2186268">,</span>&nbsp;<span class="ident" id="2186270">typ</span><span class="op" id="2186273">:</span>&nbsp;<span class="ident" id="2186275">ftyp</span><span class="op" id="2186279">,</span>&nbsp;<span class="ident" id="2186281">fn</span><span class="op" id="2186283">:</span>&nbsp;<span class="ident" id="2186285">fn</span><span class="op" id="2186287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2186291">return</span>&nbsp;<span class="ident" id="2186298">Value</span><span class="op" id="2186303">{</span><span class="ident" id="2186304">t</span><span class="op" id="2186305">,</span>&nbsp;<span class="ident" id="2186307">unsafe</span><span class="op" id="2186313">.</span><span class="ident" id="2186314">Pointer</span><span class="op" id="2186321">(</span><span class="ident" id="2186322">impl</span><span class="op" id="2186326">)</span><span class="op" id="2186327">,</span>&nbsp;<span class="ident" id="2186329">flag</span><span class="op" id="2186333">(</span><span class="ident" id="2186334">Func</span><span class="op" id="2186338">)</span><span class="op" id="2186339">}</span><br>
<span class="lineno"></span><span class="op" id="2186341">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2186344">//&nbsp;makeFuncStub&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2186409">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;MakeFunc.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*callReflectFunc</span><br>
<span class="lineno"></span><span class="comment" id="2186479">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callReflect(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2186557">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno">70</span><span class="comment" id="2186631">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2186672">func</span>&nbsp;<span class="ident" id="2186677">makeFuncStub</span><span class="op" id="2186689">(</span><span class="op" id="2186690">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2186693">type</span>&nbsp;<span class="ident" id="2186698">methodValue</span>&nbsp;<span class="keyword" id="2186710">struct</span>&nbsp;<span class="op" id="2186717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2186720">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2186727">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2186736">stack</span>&nbsp;&nbsp;<span class="op" id="2186743">*</span><span class="ident" id="2186744">bitVector</span>&nbsp;<span class="comment" id="2186754">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2186806">method</span>&nbsp;<span class="builtintype" id="2186813">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2186818">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2186825">Value</span><br>
<span class="lineno"></span><span class="op" id="2186831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="2186834">//&nbsp;makeMethodValue&nbsp;converts&nbsp;v&nbsp;from&nbsp;the&nbsp;rcvr+method&nbsp;index&nbsp;representation</span><br>
<span class="lineno"></span><span class="comment" id="2186906">//&nbsp;of&nbsp;a&nbsp;method&nbsp;value&nbsp;to&nbsp;an&nbsp;actual&nbsp;method&nbsp;func&nbsp;value,&nbsp;which&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2186968">//&nbsp;basically&nbsp;the&nbsp;receiver&nbsp;value&nbsp;with&nbsp;a&nbsp;special&nbsp;bit&nbsp;set,&nbsp;into&nbsp;a&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="2187036">//&nbsp;func&nbsp;value&nbsp;-&nbsp;a&nbsp;value&nbsp;holding&nbsp;an&nbsp;actual&nbsp;func.&nbsp;The&nbsp;output&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2187098">//&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;input&nbsp;as&nbsp;far&nbsp;as&nbsp;the&nbsp;user&nbsp;of&nbsp;package</span><br>
<span class="lineno">85</span><span class="comment" id="2187168">//&nbsp;reflect&nbsp;can&nbsp;tell,&nbsp;but&nbsp;the&nbsp;true&nbsp;func&nbsp;representation&nbsp;can&nbsp;be&nbsp;handled</span><br>
<span class="lineno"></span><span class="comment" id="2187237">//&nbsp;by&nbsp;code&nbsp;like&nbsp;Convert&nbsp;and&nbsp;Interface&nbsp;and&nbsp;Assign.</span><br>
<span class="lineno"></span><span class="keyword" id="2187287">func</span>&nbsp;<span class="ident" id="2187292">makeMethodValue</span><span class="op" id="2187307">(</span><span class="ident" id="2187308">op</span>&nbsp;<span class="builtintype" id="2187311">string</span><span class="op" id="2187317">,</span>&nbsp;<span class="ident" id="2187319">v</span>&nbsp;<span class="ident" id="2187321">Value</span><span class="op" id="2187326">)</span>&nbsp;<span class="ident" id="2187328">Value</span>&nbsp;<span class="op" id="2187334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2187337">if</span>&nbsp;<span class="ident" id="2187340">v</span><span class="op" id="2187341">.</span><span class="ident" id="2187342">flag</span><span class="op" id="2187346">&amp;</span><span class="ident" id="2187347">flagMethod</span>&nbsp;<span class="op" id="2187358">==</span>&nbsp;<span class="num" id="2187361">0</span>&nbsp;<span class="op" id="2187363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2187367">panic</span><span class="op" id="2187372">(</span><span class="string" id="2187373">&#34;reflect:&nbsp;internal&nbsp;error:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;makeMethodValue&#34;</span><span class="op" id="2187430">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2187433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2187437">//&nbsp;Ignoring&nbsp;the&nbsp;flagMethod&nbsp;bit,&nbsp;v&nbsp;describes&nbsp;the&nbsp;receiver,&nbsp;not&nbsp;the&nbsp;method&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2187517">fl</span>&nbsp;<span class="op" id="2187520">:=</span>&nbsp;<span class="ident" id="2187523">v</span><span class="op" id="2187524">.</span><span class="ident" id="2187525">flag</span>&nbsp;<span class="op" id="2187530">&amp;</span>&nbsp;<span class="op" id="2187532">(</span><span class="ident" id="2187533">flagRO</span>&nbsp;<span class="op" id="2187540">|</span>&nbsp;<span class="ident" id="2187542">flagAddr</span>&nbsp;<span class="op" id="2187551">|</span>&nbsp;<span class="ident" id="2187553">flagIndir</span><span class="op" id="2187562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2187565">fl</span>&nbsp;<span class="op" id="2187568">|=</span>&nbsp;<span class="ident" id="2187571">flag</span><span class="op" id="2187575">(</span><span class="ident" id="2187576">v</span><span class="op" id="2187577">.</span><span class="ident" id="2187578">typ</span><span class="op" id="2187581">.</span><span class="ident" id="2187582">Kind</span><span class="op" id="2187586">(</span><span class="op" id="2187587">)</span><span class="op" id="2187588">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2187591">rcvr</span>&nbsp;<span class="op" id="2187596">:=</span>&nbsp;<span class="ident" id="2187599">Value</span><span class="op" id="2187604">{</span><span class="ident" id="2187605">v</span><span class="op" id="2187606">.</span><span class="ident" id="2187607">typ</span><span class="op" id="2187610">,</span>&nbsp;<span class="ident" id="2187612">v</span><span class="op" id="2187613">.</span><span class="ident" id="2187614">ptr</span><span class="op" id="2187617">,</span>&nbsp;<span class="ident" id="2187619">fl</span><span class="op" id="2187621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2187625">//&nbsp;v.Type&nbsp;returns&nbsp;the&nbsp;actual&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2187681">funcType</span>&nbsp;<span class="op" id="2187690">:=</span>&nbsp;<span class="ident" id="2187693">v</span><span class="op" id="2187694">.</span><span class="ident" id="2187695">Type</span><span class="op" id="2187699">(</span><span class="op" id="2187700">)</span><span class="op" id="2187701">.</span><span class="op" id="2187702">(</span><span class="op" id="2187703">*</span><span class="ident" id="2187704">rtype</span><span class="op" id="2187709">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2187713">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2187758">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2187813">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2187873">dummy</span>&nbsp;<span class="op" id="2187879">:=</span>&nbsp;<span class="ident" id="2187882">methodValueCall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2187899">code</span>&nbsp;<span class="op" id="2187904">:=</span>&nbsp;<span class="op" id="2187907">*</span><span class="op" id="2187908">*</span><span class="op" id="2187909">(</span><span class="op" id="2187910">*</span><span class="op" id="2187911">*</span><span class="builtintype" id="2187912">uintptr</span><span class="op" id="2187919">)</span><span class="op" id="2187920">(</span><span class="ident" id="2187921">unsafe</span><span class="op" id="2187927">.</span><span class="ident" id="2187928">Pointer</span><span class="op" id="2187935">(</span><span class="op" id="2187936">&amp;</span><span class="ident" id="2187937">dummy</span><span class="op" id="2187942">)</span><span class="op" id="2187943">)</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2187947">//&nbsp;methodValue&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2188007">_</span><span class="op" id="2188008">,</span>&nbsp;<span class="ident" id="2188010">_</span><span class="op" id="2188011">,</span>&nbsp;<span class="ident" id="2188013">_</span><span class="op" id="2188014">,</span>&nbsp;<span class="ident" id="2188016">stack</span>&nbsp;<span class="op" id="2188022">:=</span>&nbsp;<span class="ident" id="2188025">funcLayout</span><span class="op" id="2188035">(</span><span class="ident" id="2188036">funcType</span><span class="op" id="2188044">,</span>&nbsp;<span class="ident" id="2188046">nil</span><span class="op" id="2188049">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2188053">fv</span>&nbsp;<span class="op" id="2188056">:=</span>&nbsp;<span class="op" id="2188059">&amp;</span><span class="ident" id="2188060">methodValue</span><span class="op" id="2188071">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2188075">fn</span><span class="op" id="2188077">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2188083">code</span><span class="op" id="2188087">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2188091">stack</span><span class="op" id="2188096">:</span>&nbsp;&nbsp;<span class="ident" id="2188099">stack</span><span class="op" id="2188104">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2188108">method</span><span class="op" id="2188114">:</span>&nbsp;<span class="builtintype" id="2188116">int</span><span class="op" id="2188119">(</span><span class="ident" id="2188120">v</span><span class="op" id="2188121">.</span><span class="ident" id="2188122">flag</span><span class="op" id="2188126">)</span>&nbsp;<span class="op" id="2188128">&gt;&gt;</span>&nbsp;<span class="ident" id="2188131">flagMethodShift</span><span class="op" id="2188146">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2188150">rcvr</span><span class="op" id="2188154">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2188158">rcvr</span><span class="op" id="2188162">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2188165">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2188169">//&nbsp;Cause&nbsp;panic&nbsp;if&nbsp;method&nbsp;is&nbsp;not&nbsp;appropriate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2188215">//&nbsp;The&nbsp;panic&nbsp;would&nbsp;still&nbsp;happen&nbsp;during&nbsp;the&nbsp;call&nbsp;if&nbsp;we&nbsp;omit&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2188281">//&nbsp;but&nbsp;we&nbsp;want&nbsp;Interface()&nbsp;and&nbsp;other&nbsp;operations&nbsp;to&nbsp;fail&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2188345">methodReceiver</span><span class="op" id="2188359">(</span><span class="ident" id="2188360">op</span><span class="op" id="2188362">,</span>&nbsp;<span class="ident" id="2188364">fv</span><span class="op" id="2188366">.</span><span class="ident" id="2188367">rcvr</span><span class="op" id="2188371">,</span>&nbsp;<span class="ident" id="2188373">fv</span><span class="op" id="2188375">.</span><span class="ident" id="2188376">method</span><span class="op" id="2188382">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2188386">return</span>&nbsp;<span class="ident" id="2188393">Value</span><span class="op" id="2188398">{</span><span class="ident" id="2188399">funcType</span><span class="op" id="2188407">,</span>&nbsp;<span class="ident" id="2188409">unsafe</span><span class="op" id="2188415">.</span><span class="ident" id="2188416">Pointer</span><span class="op" id="2188423">(</span><span class="ident" id="2188424">fv</span><span class="op" id="2188426">)</span><span class="op" id="2188427">,</span>&nbsp;<span class="ident" id="2188429">v</span><span class="op" id="2188430">.</span><span class="ident" id="2188431">flag</span><span class="op" id="2188435">&amp;</span><span class="ident" id="2188436">flagRO</span>&nbsp;<span class="op" id="2188443">|</span>&nbsp;<span class="ident" id="2188445">flag</span><span class="op" id="2188449">(</span><span class="ident" id="2188450">Func</span><span class="op" id="2188454">)</span><span class="op" id="2188455">}</span><br>
<span class="lineno"></span><span class="op" id="2188457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2188460">//&nbsp;methodValueCall&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno">125</span><span class="comment" id="2188528">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;makeMethodValue.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*methodValue</span><br>
<span class="lineno"></span><span class="comment" id="2188601">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callMethod(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2188678">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="2188752">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2188793">func</span>&nbsp;<span class="ident" id="2188798">methodValueCall</span><span class="op" id="2188813">(</span><span class="op" id="2188814">)</span>
</div>
</body>
</html>
