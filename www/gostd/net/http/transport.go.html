<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4909809">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4909864">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4909918">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4909969">//&nbsp;HTTP&nbsp;client&nbsp;implementation.&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="comment" id="4910014">//</span><br>
<span class="lineno"></span><span class="comment" id="4910017">//&nbsp;This&nbsp;is&nbsp;the&nbsp;low-level&nbsp;Transport&nbsp;implementation&nbsp;of&nbsp;RoundTripper.</span><br>
<span class="lineno"></span><span class="comment" id="4910084">//&nbsp;The&nbsp;high-level&nbsp;interface&nbsp;is&nbsp;in&nbsp;client.go.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="4910130">package</span>&nbsp;<span class="ident" id="4910138">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4910144">import</span>&nbsp;<span class="op" id="4910151">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4910154">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4910163">&#34;compress/gzip&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4910180">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4910194">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4910204">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4910211">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4910217">&#34;log&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4910224">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4910231">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4910242">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4910248">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4910259">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4910267">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4910274">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4910277">//&nbsp;DefaultTransport&nbsp;is&nbsp;the&nbsp;default&nbsp;implementation&nbsp;of&nbsp;Transport&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4910347">//&nbsp;used&nbsp;by&nbsp;DefaultClient.&nbsp;It&nbsp;establishes&nbsp;network&nbsp;connections&nbsp;as&nbsp;needed</span><br>
<span class="lineno">30</span><span class="comment" id="4910418">//&nbsp;and&nbsp;caches&nbsp;them&nbsp;for&nbsp;reuse&nbsp;by&nbsp;subsequent&nbsp;calls.&nbsp;It&nbsp;uses&nbsp;HTTP&nbsp;proxies</span><br>
<span class="lineno"></span><span class="comment" id="4910489">//&nbsp;as&nbsp;directed&nbsp;by&nbsp;the&nbsp;$HTTP_PROXY&nbsp;and&nbsp;$NO_PROXY&nbsp;(or&nbsp;$http_proxy&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4910557">//&nbsp;$no_proxy)&nbsp;environment&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="4910594">var</span>&nbsp;<span class="ident" id="4910598">DefaultTransport</span>&nbsp;<span class="ident" id="4910615">RoundTripper</span>&nbsp;<span class="op" id="4910628">=</span>&nbsp;<span class="op" id="4910630">&amp;</span><span class="ident" id="4910631">Transport</span><span class="op" id="4910640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910643">Proxy</span><span class="op" id="4910648">:</span>&nbsp;<span class="ident" id="4910650">ProxyFromEnvironment</span><span class="op" id="4910670">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910673">Dial</span><span class="op" id="4910677">:</span>&nbsp;<span class="op" id="4910679">(</span><span class="op" id="4910680">&amp;</span><span class="ident" id="4910681">net</span><span class="op" id="4910684">.</span><span class="ident" id="4910685">Dialer</span><span class="op" id="4910691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910695">Timeout</span><span class="op" id="4910702">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="4910706">30</span>&nbsp;<span class="op" id="4910709">*</span>&nbsp;<span class="ident" id="4910711">time</span><span class="op" id="4910715">.</span><span class="ident" id="4910716">Second</span><span class="op" id="4910722">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910726">KeepAlive</span><span class="op" id="4910735">:</span>&nbsp;<span class="num" id="4910737">30</span>&nbsp;<span class="op" id="4910740">*</span>&nbsp;<span class="ident" id="4910742">time</span><span class="op" id="4910746">.</span><span class="ident" id="4910747">Second</span><span class="op" id="4910753">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910756">}</span><span class="op" id="4910757">)</span><span class="op" id="4910758">.</span><span class="ident" id="4910759">Dial</span><span class="op" id="4910763">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910766">TLSHandshakeTimeout</span><span class="op" id="4910785">:</span>&nbsp;<span class="num" id="4910787">10</span>&nbsp;<span class="op" id="4910790">*</span>&nbsp;<span class="ident" id="4910792">time</span><span class="op" id="4910796">.</span><span class="ident" id="4910797">Second</span><span class="op" id="4910803">,</span><br>
<span class="lineno">40</span><span class="op" id="4910805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4910808">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;the&nbsp;default&nbsp;value&nbsp;of&nbsp;Transport&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4910874">//&nbsp;MaxIdleConnsPerHost.</span><br>
<span class="lineno"></span><span class="keyword" id="4910898">const</span>&nbsp;<span class="ident" id="4910904">DefaultMaxIdleConnsPerHost</span>&nbsp;<span class="op" id="4910931">=</span>&nbsp;<span class="num" id="4910933">2</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="4910936">//&nbsp;Transport&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;RoundTripper&nbsp;that&nbsp;supports&nbsp;HTTP,</span><br>
<span class="lineno"></span><span class="comment" id="4911006">//&nbsp;HTTPS,&nbsp;and&nbsp;HTTP&nbsp;proxies&nbsp;(for&nbsp;either&nbsp;HTTP&nbsp;or&nbsp;HTTPS&nbsp;with&nbsp;CONNECT).</span><br>
<span class="lineno"></span><span class="comment" id="4911074">//&nbsp;Transport&nbsp;can&nbsp;also&nbsp;cache&nbsp;connections&nbsp;for&nbsp;future&nbsp;re-use.</span><br>
<span class="lineno"></span><span class="keyword" id="4911133">type</span>&nbsp;<span class="ident" id="4911138">Transport</span>&nbsp;<span class="keyword" id="4911148">struct</span>&nbsp;<span class="op" id="4911155">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911158">idleMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4911169">sync</span><span class="op" id="4911173">.</span><span class="ident" id="4911174">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911181">wantIdle</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4911192">bool</span>&nbsp;<span class="comment" id="4911197">//&nbsp;user&nbsp;has&nbsp;requested&nbsp;to&nbsp;close&nbsp;all&nbsp;idle&nbsp;conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911244">idleConn</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="4911255">map</span><span class="op" id="4911258">[</span><span class="ident" id="4911259">connectMethodKey</span><span class="op" id="4911275">]</span><span class="op" id="4911276">[</span><span class="op" id="4911277">]</span><span class="op" id="4911278">*</span><span class="ident" id="4911279">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911292">idleConnCh</span>&nbsp;<span class="keyword" id="4911303">map</span><span class="op" id="4911306">[</span><span class="ident" id="4911307">connectMethodKey</span><span class="op" id="4911323">]</span><span class="keyword" id="4911324">chan</span>&nbsp;<span class="op" id="4911329">*</span><span class="ident" id="4911330">persistConn</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911344">reqMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4911356">sync</span><span class="op" id="4911360">.</span><span class="ident" id="4911361">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911368">reqCanceler</span>&nbsp;<span class="keyword" id="4911380">map</span><span class="op" id="4911383">[</span><span class="op" id="4911384">*</span><span class="ident" id="4911385">Request</span><span class="op" id="4911392">]</span><span class="keyword" id="4911393">func</span><span class="op" id="4911397">(</span><span class="op" id="4911398">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911402">altMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4911411">sync</span><span class="op" id="4911415">.</span><span class="ident" id="4911416">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911425">altProto</span>&nbsp;<span class="keyword" id="4911434">map</span><span class="op" id="4911437">[</span><span class="builtintype" id="4911438">string</span><span class="op" id="4911444">]</span><span class="ident" id="4911445">RoundTripper</span>&nbsp;<span class="comment" id="4911458">//&nbsp;nil&nbsp;or&nbsp;map&nbsp;of&nbsp;URI&nbsp;scheme&nbsp;=&gt;&nbsp;RoundTripper</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911504">//&nbsp;Proxy&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;return&nbsp;a&nbsp;proxy&nbsp;for&nbsp;a&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911565">//&nbsp;Request.&nbsp;If&nbsp;the&nbsp;function&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911623">//&nbsp;request&nbsp;is&nbsp;aborted&nbsp;with&nbsp;the&nbsp;provided&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911671">//&nbsp;If&nbsp;Proxy&nbsp;is&nbsp;nil&nbsp;or&nbsp;returns&nbsp;a&nbsp;nil&nbsp;*URL,&nbsp;no&nbsp;proxy&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911732">Proxy</span>&nbsp;<span class="keyword" id="4911738">func</span><span class="op" id="4911742">(</span><span class="op" id="4911743">*</span><span class="ident" id="4911744">Request</span><span class="op" id="4911751">)</span>&nbsp;<span class="op" id="4911753">(</span><span class="op" id="4911754">*</span><span class="ident" id="4911755">url</span><span class="op" id="4911758">.</span><span class="ident" id="4911759">URL</span><span class="op" id="4911762">,</span>&nbsp;<span class="builtintype" id="4911764">error</span><span class="op" id="4911769">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911773">//&nbsp;Dial&nbsp;specifies&nbsp;the&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating&nbsp;unencrypted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911835">//&nbsp;TCP&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911856">//&nbsp;If&nbsp;Dial&nbsp;is&nbsp;nil,&nbsp;net.Dial&nbsp;is&nbsp;used.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911894">Dial</span>&nbsp;<span class="keyword" id="4911899">func</span><span class="op" id="4911903">(</span><span class="ident" id="4911904">network</span><span class="op" id="4911911">,</span>&nbsp;<span class="ident" id="4911913">addr</span>&nbsp;<span class="builtintype" id="4911918">string</span><span class="op" id="4911924">)</span>&nbsp;<span class="op" id="4911926">(</span><span class="ident" id="4911927">net</span><span class="op" id="4911930">.</span><span class="ident" id="4911931">Conn</span><span class="op" id="4911935">,</span>&nbsp;<span class="builtintype" id="4911937">error</span><span class="op" id="4911942">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911946">//&nbsp;DialTLS&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912007">//&nbsp;TLS&nbsp;connections&nbsp;for&nbsp;non-proxied&nbsp;HTTPS&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912059">//</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912063">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;nil,&nbsp;Dial&nbsp;and&nbsp;TLSClientConfig&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912121">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912125">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;set,&nbsp;the&nbsp;Dial&nbsp;hook&nbsp;is&nbsp;not&nbsp;used&nbsp;for&nbsp;HTTPS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912184">//&nbsp;requests&nbsp;and&nbsp;the&nbsp;TLSClientConfig&nbsp;and&nbsp;TLSHandshakeTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912245">//&nbsp;are&nbsp;ignored.&nbsp;The&nbsp;returned&nbsp;net.Conn&nbsp;is&nbsp;assumed&nbsp;to&nbsp;already&nbsp;be</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912309">//&nbsp;past&nbsp;the&nbsp;TLS&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912337">DialTLS</span>&nbsp;<span class="keyword" id="4912345">func</span><span class="op" id="4912349">(</span><span class="ident" id="4912350">network</span><span class="op" id="4912357">,</span>&nbsp;<span class="ident" id="4912359">addr</span>&nbsp;<span class="builtintype" id="4912364">string</span><span class="op" id="4912370">)</span>&nbsp;<span class="op" id="4912372">(</span><span class="ident" id="4912373">net</span><span class="op" id="4912376">.</span><span class="ident" id="4912377">Conn</span><span class="op" id="4912381">,</span>&nbsp;<span class="builtintype" id="4912383">error</span><span class="op" id="4912388">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912392">//&nbsp;TLSClientConfig&nbsp;specifies&nbsp;the&nbsp;TLS&nbsp;configuration&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912456">//&nbsp;tls.Client.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;default&nbsp;configuration&nbsp;is&nbsp;used.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912515">TLSClientConfig</span>&nbsp;<span class="op" id="4912531">*</span><span class="ident" id="4912532">tls</span><span class="op" id="4912535">.</span><span class="ident" id="4912536">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912545">//&nbsp;TLSHandshakeTimeout&nbsp;specifies&nbsp;the&nbsp;maximum&nbsp;amount&nbsp;of&nbsp;time&nbsp;waiting&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912617">//&nbsp;wait&nbsp;for&nbsp;a&nbsp;TLS&nbsp;handshake.&nbsp;Zero&nbsp;means&nbsp;no&nbsp;timeout.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912670">TLSHandshakeTimeout</span>&nbsp;<span class="ident" id="4912690">time</span><span class="op" id="4912694">.</span><span class="ident" id="4912695">Duration</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912706">//&nbsp;DisableKeepAlives,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;re-use&nbsp;of&nbsp;TCP&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912773">//&nbsp;between&nbsp;different&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912810">DisableKeepAlives</span>&nbsp;<span class="builtintype" id="4912828">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912835">//&nbsp;DisableCompression,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;the&nbsp;Transport&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912896">//&nbsp;requesting&nbsp;compression&nbsp;with&nbsp;an&nbsp;&#34;Accept-Encoding:&nbsp;gzip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912955">//&nbsp;request&nbsp;header&nbsp;when&nbsp;the&nbsp;Request&nbsp;contains&nbsp;no&nbsp;existing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913012">//&nbsp;Accept-Encoding&nbsp;value.&nbsp;If&nbsp;the&nbsp;Transport&nbsp;requests&nbsp;gzip&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913073">//&nbsp;its&nbsp;own&nbsp;and&nbsp;gets&nbsp;a&nbsp;gzipped&nbsp;response,&nbsp;it&#39;s&nbsp;transparently</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913133">//&nbsp;decoded&nbsp;in&nbsp;the&nbsp;Response.Body.&nbsp;However,&nbsp;if&nbsp;the&nbsp;user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913188">//&nbsp;explicitly&nbsp;requested&nbsp;gzip&nbsp;it&nbsp;is&nbsp;not&nbsp;automatically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913242">//&nbsp;uncompressed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913260">DisableCompression</span>&nbsp;<span class="builtintype" id="4913279">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913286">//&nbsp;MaxIdleConnsPerHost,&nbsp;if&nbsp;non-zero,&nbsp;controls&nbsp;the&nbsp;maximum&nbsp;idle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913350">//&nbsp;(keep-alive)&nbsp;to&nbsp;keep&nbsp;per-host.&nbsp;&nbsp;If&nbsp;zero,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913395">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913435">MaxIdleConnsPerHost</span>&nbsp;<span class="builtintype" id="4913455">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913461">//&nbsp;ResponseHeaderTimeout,&nbsp;if&nbsp;non-zero,&nbsp;specifies&nbsp;the&nbsp;amount&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913525">//&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;a&nbsp;server&#39;s&nbsp;response&nbsp;headers&nbsp;after&nbsp;fully</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913586">//&nbsp;writing&nbsp;the&nbsp;request&nbsp;(including&nbsp;its&nbsp;body,&nbsp;if&nbsp;any).&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913645">//&nbsp;time&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;time&nbsp;to&nbsp;read&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913707">ResponseHeaderTimeout</span>&nbsp;<span class="ident" id="4913729">time</span><span class="op" id="4913733">.</span><span class="ident" id="4913734">Duration</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913745">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;global&nbsp;max&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913796">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;timeout&nbsp;on&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span><span class="op" id="4913846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="4913849">//&nbsp;ProxyFromEnvironment&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;proxy&nbsp;to&nbsp;use&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4913915">//&nbsp;given&nbsp;request,&nbsp;as&nbsp;indicated&nbsp;by&nbsp;the&nbsp;environment&nbsp;variables</span><br>
<span class="lineno"></span><span class="comment" id="4913975">//&nbsp;HTTP_PROXY,&nbsp;HTTPS_PROXY&nbsp;and&nbsp;NO_PROXY&nbsp;(or&nbsp;the&nbsp;lowercase&nbsp;versions</span><br>
<span class="lineno"></span><span class="comment" id="4914042">//&nbsp;thereof).&nbsp;HTTPS_PROXY&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;HTTP_PROXY&nbsp;for&nbsp;https</span><br>
<span class="lineno"></span><span class="comment" id="4914110">//&nbsp;requests.</span><br>
<span class="lineno">125</span><span class="comment" id="4914123">//</span><br>
<span class="lineno"></span><span class="comment" id="4914126">//&nbsp;The&nbsp;environment&nbsp;values&nbsp;may&nbsp;be&nbsp;either&nbsp;a&nbsp;complete&nbsp;URL&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4914186">//&nbsp;&#34;host[:port]&#34;,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;&#34;http&#34;&nbsp;scheme&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="4914248">//&nbsp;An&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;a&nbsp;different&nbsp;form.</span><br>
<span class="lineno"></span><span class="comment" id="4914306">//</span><br>
<span class="lineno">130</span><span class="comment" id="4914309">//&nbsp;A&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;are&nbsp;returned&nbsp;if&nbsp;no&nbsp;proxy&nbsp;is&nbsp;defined&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4914379">//&nbsp;environment,&nbsp;or&nbsp;a&nbsp;proxy&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="4914448">//&nbsp;as&nbsp;defined&nbsp;by&nbsp;NO_PROXY.</span><br>
<span class="lineno"></span><span class="comment" id="4914475">//</span><br>
<span class="lineno"></span><span class="comment" id="4914478">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;req.URL.Host&nbsp;is&nbsp;&#34;localhost&#34;&nbsp;(with&nbsp;or&nbsp;without</span><br>
<span class="lineno">135</span><span class="comment" id="4914548">//&nbsp;a&nbsp;port&nbsp;number),&nbsp;then&nbsp;a&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="4914614">func</span>&nbsp;<span class="ident" id="4914619">ProxyFromEnvironment</span><span class="op" id="4914639">(</span><span class="ident" id="4914640">req</span>&nbsp;<span class="op" id="4914644">*</span><span class="ident" id="4914645">Request</span><span class="op" id="4914652">)</span>&nbsp;<span class="op" id="4914654">(</span><span class="op" id="4914655">*</span><span class="ident" id="4914656">url</span><span class="op" id="4914659">.</span><span class="ident" id="4914660">URL</span><span class="op" id="4914663">,</span>&nbsp;<span class="builtintype" id="4914665">error</span><span class="op" id="4914670">)</span>&nbsp;<span class="op" id="4914672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4914675">var</span>&nbsp;<span class="ident" id="4914679">proxy</span>&nbsp;<span class="builtintype" id="4914685">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4914693">if</span>&nbsp;<span class="ident" id="4914696">req</span><span class="op" id="4914699">.</span><span class="ident" id="4914700">URL</span><span class="op" id="4914703">.</span><span class="ident" id="4914704">Scheme</span>&nbsp;<span class="op" id="4914711">==</span>&nbsp;<span class="string" id="4914714">&#34;https&#34;</span>&nbsp;<span class="op" id="4914722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914726">proxy</span>&nbsp;<span class="op" id="4914732">=</span>&nbsp;<span class="ident" id="4914734">httpsProxyEnv</span><span class="op" id="4914747">.</span><span class="ident" id="4914748">Get</span><span class="op" id="4914751">(</span><span class="op" id="4914752">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4914755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4914758">if</span>&nbsp;<span class="ident" id="4914761">proxy</span>&nbsp;<span class="op" id="4914767">==</span>&nbsp;<span class="string" id="4914770">&#34;&#34;</span>&nbsp;<span class="op" id="4914773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914777">proxy</span>&nbsp;<span class="op" id="4914783">=</span>&nbsp;<span class="ident" id="4914785">httpProxyEnv</span><span class="op" id="4914797">.</span><span class="ident" id="4914798">Get</span><span class="op" id="4914801">(</span><span class="op" id="4914802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4914805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4914808">if</span>&nbsp;<span class="ident" id="4914811">proxy</span>&nbsp;<span class="op" id="4914817">==</span>&nbsp;<span class="string" id="4914820">&#34;&#34;</span>&nbsp;<span class="op" id="4914823">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4914827">return</span>&nbsp;<span class="ident" id="4914834">nil</span><span class="op" id="4914837">,</span>&nbsp;<span class="ident" id="4914839">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4914844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4914847">if</span>&nbsp;<span class="op" id="4914850">!</span><span class="ident" id="4914851">useProxy</span><span class="op" id="4914859">(</span><span class="ident" id="4914860">canonicalAddr</span><span class="op" id="4914873">(</span><span class="ident" id="4914874">req</span><span class="op" id="4914877">.</span><span class="ident" id="4914878">URL</span><span class="op" id="4914881">)</span><span class="op" id="4914882">)</span>&nbsp;<span class="op" id="4914884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4914888">return</span>&nbsp;<span class="ident" id="4914895">nil</span><span class="op" id="4914898">,</span>&nbsp;<span class="ident" id="4914900">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4914905">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914908">proxyURL</span><span class="op" id="4914916">,</span>&nbsp;<span class="ident" id="4914918">err</span>&nbsp;<span class="op" id="4914922">:=</span>&nbsp;<span class="ident" id="4914925">url</span><span class="op" id="4914928">.</span><span class="ident" id="4914929">Parse</span><span class="op" id="4914934">(</span><span class="ident" id="4914935">proxy</span><span class="op" id="4914940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4914943">if</span>&nbsp;<span class="ident" id="4914946">err</span>&nbsp;<span class="op" id="4914950">!=</span>&nbsp;<span class="ident" id="4914953">nil</span>&nbsp;<span class="op" id="4914957">||</span>&nbsp;<span class="op" id="4914960">!</span><span class="ident" id="4914961">strings</span><span class="op" id="4914968">.</span><span class="ident" id="4914969">HasPrefix</span><span class="op" id="4914978">(</span><span class="ident" id="4914979">proxyURL</span><span class="op" id="4914987">.</span><span class="ident" id="4914988">Scheme</span><span class="op" id="4914994">,</span>&nbsp;<span class="string" id="4914996">&#34;http&#34;</span><span class="op" id="4915002">)</span>&nbsp;<span class="op" id="4915004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4915008">//&nbsp;proxy&nbsp;was&nbsp;bogus.&nbsp;Try&nbsp;prepending&nbsp;&#34;http://&#34;&nbsp;to&nbsp;it&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4915065">//&nbsp;see&nbsp;if&nbsp;that&nbsp;parses&nbsp;correctly.&nbsp;If&nbsp;not,&nbsp;we&nbsp;fall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4915116">//&nbsp;through&nbsp;and&nbsp;complain&nbsp;about&nbsp;the&nbsp;original&nbsp;one.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915166">if</span>&nbsp;<span class="ident" id="4915169">proxyURL</span><span class="op" id="4915177">,</span>&nbsp;<span class="ident" id="4915179">err</span>&nbsp;<span class="op" id="4915183">:=</span>&nbsp;<span class="ident" id="4915186">url</span><span class="op" id="4915189">.</span><span class="ident" id="4915190">Parse</span><span class="op" id="4915195">(</span><span class="string" id="4915196">&#34;http://&#34;</span>&nbsp;<span class="op" id="4915206">+</span>&nbsp;<span class="ident" id="4915208">proxy</span><span class="op" id="4915213">)</span><span class="op" id="4915214">;</span>&nbsp;<span class="ident" id="4915216">err</span>&nbsp;<span class="op" id="4915220">==</span>&nbsp;<span class="ident" id="4915223">nil</span>&nbsp;<span class="op" id="4915227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915232">return</span>&nbsp;<span class="ident" id="4915239">proxyURL</span><span class="op" id="4915247">,</span>&nbsp;<span class="ident" id="4915249">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4915255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4915258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915261">if</span>&nbsp;<span class="ident" id="4915264">err</span>&nbsp;<span class="op" id="4915268">!=</span>&nbsp;<span class="ident" id="4915271">nil</span>&nbsp;<span class="op" id="4915275">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915279">return</span>&nbsp;<span class="ident" id="4915286">nil</span><span class="op" id="4915289">,</span>&nbsp;<span class="ident" id="4915291">fmt</span><span class="op" id="4915294">.</span><span class="ident" id="4915295">Errorf</span><span class="op" id="4915301">(</span><span class="string" id="4915302">&#34;invalid&nbsp;proxy&nbsp;address&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="4915332">,</span>&nbsp;<span class="ident" id="4915334">proxy</span><span class="op" id="4915339">,</span>&nbsp;<span class="ident" id="4915341">err</span><span class="op" id="4915344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4915347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915350">return</span>&nbsp;<span class="ident" id="4915357">proxyURL</span><span class="op" id="4915365">,</span>&nbsp;<span class="ident" id="4915367">nil</span><br>
<span class="lineno"></span><span class="op" id="4915371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="4915374">//&nbsp;ProxyURL&nbsp;returns&nbsp;a&nbsp;proxy&nbsp;function&nbsp;(for&nbsp;use&nbsp;in&nbsp;a&nbsp;Transport)</span><br>
<span class="lineno"></span><span class="comment" id="4915436">//&nbsp;that&nbsp;always&nbsp;returns&nbsp;the&nbsp;same&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="4915473">func</span>&nbsp;<span class="ident" id="4915478">ProxyURL</span><span class="op" id="4915486">(</span><span class="ident" id="4915487">fixedURL</span>&nbsp;<span class="op" id="4915496">*</span><span class="ident" id="4915497">url</span><span class="op" id="4915500">.</span><span class="ident" id="4915501">URL</span><span class="op" id="4915504">)</span>&nbsp;<span class="keyword" id="4915506">func</span><span class="op" id="4915510">(</span><span class="op" id="4915511">*</span><span class="ident" id="4915512">Request</span><span class="op" id="4915519">)</span>&nbsp;<span class="op" id="4915521">(</span><span class="op" id="4915522">*</span><span class="ident" id="4915523">url</span><span class="op" id="4915526">.</span><span class="ident" id="4915527">URL</span><span class="op" id="4915530">,</span>&nbsp;<span class="builtintype" id="4915532">error</span><span class="op" id="4915537">)</span>&nbsp;<span class="op" id="4915539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915542">return</span>&nbsp;<span class="keyword" id="4915549">func</span><span class="op" id="4915553">(</span><span class="op" id="4915554">*</span><span class="ident" id="4915555">Request</span><span class="op" id="4915562">)</span>&nbsp;<span class="op" id="4915564">(</span><span class="op" id="4915565">*</span><span class="ident" id="4915566">url</span><span class="op" id="4915569">.</span><span class="ident" id="4915570">URL</span><span class="op" id="4915573">,</span>&nbsp;<span class="builtintype" id="4915575">error</span><span class="op" id="4915580">)</span>&nbsp;<span class="op" id="4915582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915586">return</span>&nbsp;<span class="ident" id="4915593">fixedURL</span><span class="op" id="4915601">,</span>&nbsp;<span class="ident" id="4915603">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4915608">}</span><br>
<span class="lineno"></span><span class="op" id="4915610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4915613">//&nbsp;transportRequest&nbsp;is&nbsp;a&nbsp;wrapper&nbsp;around&nbsp;a&nbsp;*Request&nbsp;that&nbsp;adds</span><br>
<span class="lineno"></span><span class="comment" id="4915674">//&nbsp;optional&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write.</span><br>
<span class="lineno">175</span><span class="keyword" id="4915710">type</span>&nbsp;<span class="ident" id="4915715">transportRequest</span>&nbsp;<span class="keyword" id="4915732">struct</span>&nbsp;<span class="op" id="4915739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4915742">*</span><span class="ident" id="4915743">Request</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4915758">//&nbsp;original&nbsp;request,&nbsp;not&nbsp;to&nbsp;be&nbsp;mutated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4915798">extra</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4915807">Header</span>&nbsp;<span class="comment" id="4915814">//&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write,&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="4915848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="4915851">func</span>&nbsp;<span class="op" id="4915856">(</span><span class="ident" id="4915857">tr</span>&nbsp;<span class="op" id="4915860">*</span><span class="ident" id="4915861">transportRequest</span><span class="op" id="4915877">)</span>&nbsp;<span class="ident" id="4915879">extraHeaders</span><span class="op" id="4915891">(</span><span class="op" id="4915892">)</span>&nbsp;<span class="ident" id="4915894">Header</span>&nbsp;<span class="op" id="4915901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915904">if</span>&nbsp;<span class="ident" id="4915907">tr</span><span class="op" id="4915909">.</span><span class="ident" id="4915910">extra</span>&nbsp;<span class="op" id="4915916">==</span>&nbsp;<span class="ident" id="4915919">nil</span>&nbsp;<span class="op" id="4915923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4915927">tr</span><span class="op" id="4915929">.</span><span class="ident" id="4915930">extra</span>&nbsp;<span class="op" id="4915936">=</span>&nbsp;<span class="builtinfunc" id="4915938">make</span><span class="op" id="4915942">(</span><span class="ident" id="4915943">Header</span><span class="op" id="4915949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4915952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915955">return</span>&nbsp;<span class="ident" id="4915962">tr</span><span class="op" id="4915964">.</span><span class="ident" id="4915965">extra</span><br>
<span class="lineno">185</span><span class="op" id="4915971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4915974">//&nbsp;RoundTrip&nbsp;implements&nbsp;the&nbsp;RoundTripper&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="4916026">//</span><br>
<span class="lineno"></span><span class="comment" id="4916029">//&nbsp;For&nbsp;higher-level&nbsp;HTTP&nbsp;client&nbsp;support&nbsp;(such&nbsp;as&nbsp;handling&nbsp;of&nbsp;cookies</span><br>
<span class="lineno">190</span><span class="comment" id="4916098">//&nbsp;and&nbsp;redirects),&nbsp;see&nbsp;Get,&nbsp;Post,&nbsp;and&nbsp;the&nbsp;Client&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4916153">func</span>&nbsp;<span class="op" id="4916158">(</span><span class="ident" id="4916159">t</span>&nbsp;<span class="op" id="4916161">*</span><span class="ident" id="4916162">Transport</span><span class="op" id="4916171">)</span>&nbsp;<span class="ident" id="4916173">RoundTrip</span><span class="op" id="4916182">(</span><span class="ident" id="4916183">req</span>&nbsp;<span class="op" id="4916187">*</span><span class="ident" id="4916188">Request</span><span class="op" id="4916195">)</span>&nbsp;<span class="op" id="4916197">(</span><span class="ident" id="4916198">resp</span>&nbsp;<span class="op" id="4916203">*</span><span class="ident" id="4916204">Response</span><span class="op" id="4916212">,</span>&nbsp;<span class="ident" id="4916214">err</span>&nbsp;<span class="builtintype" id="4916218">error</span><span class="op" id="4916223">)</span>&nbsp;<span class="op" id="4916225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916228">if</span>&nbsp;<span class="ident" id="4916231">req</span><span class="op" id="4916234">.</span><span class="ident" id="4916235">URL</span>&nbsp;<span class="op" id="4916239">==</span>&nbsp;<span class="ident" id="4916242">nil</span>&nbsp;<span class="op" id="4916246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916250">req</span><span class="op" id="4916253">.</span><span class="ident" id="4916254">closeBody</span><span class="op" id="4916263">(</span><span class="op" id="4916264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916268">return</span>&nbsp;<span class="ident" id="4916275">nil</span><span class="op" id="4916278">,</span>&nbsp;<span class="ident" id="4916280">errors</span><span class="op" id="4916286">.</span><span class="ident" id="4916287">New</span><span class="op" id="4916290">(</span><span class="string" id="4916291">&#34;http:&nbsp;nil&nbsp;Request.URL&#34;</span><span class="op" id="4916314">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4916317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916320">if</span>&nbsp;<span class="ident" id="4916323">req</span><span class="op" id="4916326">.</span><span class="ident" id="4916327">Header</span>&nbsp;<span class="op" id="4916334">==</span>&nbsp;<span class="ident" id="4916337">nil</span>&nbsp;<span class="op" id="4916341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916345">req</span><span class="op" id="4916348">.</span><span class="ident" id="4916349">closeBody</span><span class="op" id="4916358">(</span><span class="op" id="4916359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916363">return</span>&nbsp;<span class="ident" id="4916370">nil</span><span class="op" id="4916373">,</span>&nbsp;<span class="ident" id="4916375">errors</span><span class="op" id="4916381">.</span><span class="ident" id="4916382">New</span><span class="op" id="4916385">(</span><span class="string" id="4916386">&#34;http:&nbsp;nil&nbsp;Request.Header&#34;</span><span class="op" id="4916412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4916415">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916418">if</span>&nbsp;<span class="ident" id="4916421">req</span><span class="op" id="4916424">.</span><span class="ident" id="4916425">URL</span><span class="op" id="4916428">.</span><span class="ident" id="4916429">Scheme</span>&nbsp;<span class="op" id="4916436">!=</span>&nbsp;<span class="string" id="4916439">&#34;http&#34;</span>&nbsp;<span class="op" id="4916446">&amp;&amp;</span>&nbsp;<span class="ident" id="4916449">req</span><span class="op" id="4916452">.</span><span class="ident" id="4916453">URL</span><span class="op" id="4916456">.</span><span class="ident" id="4916457">Scheme</span>&nbsp;<span class="op" id="4916464">!=</span>&nbsp;<span class="string" id="4916467">&#34;https&#34;</span>&nbsp;<span class="op" id="4916475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916479">t</span><span class="op" id="4916480">.</span><span class="ident" id="4916481">altMu</span><span class="op" id="4916486">.</span><span class="ident" id="4916487">RLock</span><span class="op" id="4916492">(</span><span class="op" id="4916493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916497">var</span>&nbsp;<span class="ident" id="4916501">rt</span>&nbsp;<span class="ident" id="4916504">RoundTripper</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916519">if</span>&nbsp;<span class="ident" id="4916522">t</span><span class="op" id="4916523">.</span><span class="ident" id="4916524">altProto</span>&nbsp;<span class="op" id="4916533">!=</span>&nbsp;<span class="ident" id="4916536">nil</span>&nbsp;<span class="op" id="4916540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916545">rt</span>&nbsp;<span class="op" id="4916548">=</span>&nbsp;<span class="ident" id="4916550">t</span><span class="op" id="4916551">.</span><span class="ident" id="4916552">altProto</span><span class="op" id="4916560">[</span><span class="ident" id="4916561">req</span><span class="op" id="4916564">.</span><span class="ident" id="4916565">URL</span><span class="op" id="4916568">.</span><span class="ident" id="4916569">Scheme</span><span class="op" id="4916575">]</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4916579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916583">t</span><span class="op" id="4916584">.</span><span class="ident" id="4916585">altMu</span><span class="op" id="4916590">.</span><span class="ident" id="4916591">RUnlock</span><span class="op" id="4916598">(</span><span class="op" id="4916599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916603">if</span>&nbsp;<span class="ident" id="4916606">rt</span>&nbsp;<span class="op" id="4916609">==</span>&nbsp;<span class="ident" id="4916612">nil</span>&nbsp;<span class="op" id="4916616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916621">req</span><span class="op" id="4916624">.</span><span class="ident" id="4916625">closeBody</span><span class="op" id="4916634">(</span><span class="op" id="4916635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916640">return</span>&nbsp;<span class="ident" id="4916647">nil</span><span class="op" id="4916650">,</span>&nbsp;<span class="op" id="4916652">&amp;</span><span class="ident" id="4916653">badStringError</span><span class="op" id="4916667">{</span><span class="string" id="4916668">&#34;unsupported&nbsp;protocol&nbsp;scheme&#34;</span><span class="op" id="4916697">,</span>&nbsp;<span class="ident" id="4916699">req</span><span class="op" id="4916702">.</span><span class="ident" id="4916703">URL</span><span class="op" id="4916706">.</span><span class="ident" id="4916707">Scheme</span><span class="op" id="4916713">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4916717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916721">return</span>&nbsp;<span class="ident" id="4916728">rt</span><span class="op" id="4916730">.</span><span class="ident" id="4916731">RoundTrip</span><span class="op" id="4916740">(</span><span class="ident" id="4916741">req</span><span class="op" id="4916744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4916747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916750">if</span>&nbsp;<span class="ident" id="4916753">req</span><span class="op" id="4916756">.</span><span class="ident" id="4916757">URL</span><span class="op" id="4916760">.</span><span class="ident" id="4916761">Host</span>&nbsp;<span class="op" id="4916766">==</span>&nbsp;<span class="string" id="4916769">&#34;&#34;</span>&nbsp;<span class="op" id="4916772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916776">req</span><span class="op" id="4916779">.</span><span class="ident" id="4916780">closeBody</span><span class="op" id="4916789">(</span><span class="op" id="4916790">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916794">return</span>&nbsp;<span class="ident" id="4916801">nil</span><span class="op" id="4916804">,</span>&nbsp;<span class="ident" id="4916806">errors</span><span class="op" id="4916812">.</span><span class="ident" id="4916813">New</span><span class="op" id="4916816">(</span><span class="string" id="4916817">&#34;http:&nbsp;no&nbsp;Host&nbsp;in&nbsp;request&nbsp;URL&#34;</span><span class="op" id="4916847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4916850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916853">treq</span>&nbsp;<span class="op" id="4916858">:=</span>&nbsp;<span class="op" id="4916861">&amp;</span><span class="ident" id="4916862">transportRequest</span><span class="op" id="4916878">{</span><span class="ident" id="4916879">Request</span><span class="op" id="4916886">:</span>&nbsp;<span class="ident" id="4916888">req</span><span class="op" id="4916891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916894">cm</span><span class="op" id="4916896">,</span>&nbsp;<span class="ident" id="4916898">err</span>&nbsp;<span class="op" id="4916902">:=</span>&nbsp;<span class="ident" id="4916905">t</span><span class="op" id="4916906">.</span><span class="ident" id="4916907">connectMethodForRequest</span><span class="op" id="4916930">(</span><span class="ident" id="4916931">treq</span><span class="op" id="4916935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916938">if</span>&nbsp;<span class="ident" id="4916941">err</span>&nbsp;<span class="op" id="4916945">!=</span>&nbsp;<span class="ident" id="4916948">nil</span>&nbsp;<span class="op" id="4916952">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916956">req</span><span class="op" id="4916959">.</span><span class="ident" id="4916960">closeBody</span><span class="op" id="4916969">(</span><span class="op" id="4916970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916974">return</span>&nbsp;<span class="ident" id="4916981">nil</span><span class="op" id="4916984">,</span>&nbsp;<span class="ident" id="4916986">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4916991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4916995">//&nbsp;Get&nbsp;the&nbsp;cached&nbsp;or&nbsp;newly-created&nbsp;connection&nbsp;to&nbsp;either&nbsp;the</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4917056">//&nbsp;host&nbsp;(for&nbsp;http&nbsp;or&nbsp;https),&nbsp;the&nbsp;http&nbsp;proxy,&nbsp;or&nbsp;the&nbsp;http&nbsp;proxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4917120">//&nbsp;pre-CONNECTed&nbsp;to&nbsp;https&nbsp;server.&nbsp;&nbsp;In&nbsp;any&nbsp;case,&nbsp;we&#39;ll&nbsp;be&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4917184">//&nbsp;to&nbsp;send&nbsp;it&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917209">pconn</span><span class="op" id="4917214">,</span>&nbsp;<span class="ident" id="4917216">err</span>&nbsp;<span class="op" id="4917220">:=</span>&nbsp;<span class="ident" id="4917223">t</span><span class="op" id="4917224">.</span><span class="ident" id="4917225">getConn</span><span class="op" id="4917232">(</span><span class="ident" id="4917233">req</span><span class="op" id="4917236">,</span>&nbsp;<span class="ident" id="4917238">cm</span><span class="op" id="4917240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917243">if</span>&nbsp;<span class="ident" id="4917246">err</span>&nbsp;<span class="op" id="4917250">!=</span>&nbsp;<span class="ident" id="4917253">nil</span>&nbsp;<span class="op" id="4917257">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917261">t</span><span class="op" id="4917262">.</span><span class="ident" id="4917263">setReqCanceler</span><span class="op" id="4917277">(</span><span class="ident" id="4917278">req</span><span class="op" id="4917281">,</span>&nbsp;<span class="ident" id="4917283">nil</span><span class="op" id="4917286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917290">req</span><span class="op" id="4917293">.</span><span class="ident" id="4917294">closeBody</span><span class="op" id="4917303">(</span><span class="op" id="4917304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917308">return</span>&nbsp;<span class="ident" id="4917315">nil</span><span class="op" id="4917318">,</span>&nbsp;<span class="ident" id="4917320">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4917325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917329">return</span>&nbsp;<span class="ident" id="4917336">pconn</span><span class="op" id="4917341">.</span><span class="ident" id="4917342">roundTrip</span><span class="op" id="4917351">(</span><span class="ident" id="4917352">treq</span><span class="op" id="4917356">)</span><br>
<span class="lineno"></span><span class="op" id="4917358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4917361">//&nbsp;RegisterProtocol&nbsp;registers&nbsp;a&nbsp;new&nbsp;protocol&nbsp;with&nbsp;scheme.</span><br>
<span class="lineno"></span><span class="comment" id="4917419">//&nbsp;The&nbsp;Transport&nbsp;will&nbsp;pass&nbsp;requests&nbsp;using&nbsp;the&nbsp;given&nbsp;scheme&nbsp;to&nbsp;rt.</span><br>
<span class="lineno">240</span><span class="comment" id="4917485">//&nbsp;It&nbsp;is&nbsp;rt&#39;s&nbsp;responsibility&nbsp;to&nbsp;simulate&nbsp;HTTP&nbsp;request&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="4917550">//</span><br>
<span class="lineno"></span><span class="comment" id="4917553">//&nbsp;RegisterProtocol&nbsp;can&nbsp;be&nbsp;used&nbsp;by&nbsp;other&nbsp;packages&nbsp;to&nbsp;provide</span><br>
<span class="lineno"></span><span class="comment" id="4917614">//&nbsp;implementations&nbsp;of&nbsp;protocol&nbsp;schemes&nbsp;like&nbsp;&#34;ftp&#34;&nbsp;or&nbsp;&#34;file&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4917675">func</span>&nbsp;<span class="op" id="4917680">(</span><span class="ident" id="4917681">t</span>&nbsp;<span class="op" id="4917683">*</span><span class="ident" id="4917684">Transport</span><span class="op" id="4917693">)</span>&nbsp;<span class="ident" id="4917695">RegisterProtocol</span><span class="op" id="4917711">(</span><span class="ident" id="4917712">scheme</span>&nbsp;<span class="builtintype" id="4917719">string</span><span class="op" id="4917725">,</span>&nbsp;<span class="ident" id="4917727">rt</span>&nbsp;<span class="ident" id="4917730">RoundTripper</span><span class="op" id="4917742">)</span>&nbsp;<span class="op" id="4917744">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917747">if</span>&nbsp;<span class="ident" id="4917750">scheme</span>&nbsp;<span class="op" id="4917757">==</span>&nbsp;<span class="string" id="4917760">&#34;http&#34;</span>&nbsp;<span class="op" id="4917767">||</span>&nbsp;<span class="ident" id="4917770">scheme</span>&nbsp;<span class="op" id="4917777">==</span>&nbsp;<span class="string" id="4917780">&#34;https&#34;</span>&nbsp;<span class="op" id="4917788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4917792">panic</span><span class="op" id="4917797">(</span><span class="string" id="4917798">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="4917810">+</span>&nbsp;<span class="ident" id="4917812">scheme</span>&nbsp;<span class="op" id="4917819">+</span>&nbsp;<span class="string" id="4917821">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="4917842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4917845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917848">t</span><span class="op" id="4917849">.</span><span class="ident" id="4917850">altMu</span><span class="op" id="4917855">.</span><span class="ident" id="4917856">Lock</span><span class="op" id="4917860">(</span><span class="op" id="4917861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917864">defer</span>&nbsp;<span class="ident" id="4917870">t</span><span class="op" id="4917871">.</span><span class="ident" id="4917872">altMu</span><span class="op" id="4917877">.</span><span class="ident" id="4917878">Unlock</span><span class="op" id="4917884">(</span><span class="op" id="4917885">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917888">if</span>&nbsp;<span class="ident" id="4917891">t</span><span class="op" id="4917892">.</span><span class="ident" id="4917893">altProto</span>&nbsp;<span class="op" id="4917902">==</span>&nbsp;<span class="ident" id="4917905">nil</span>&nbsp;<span class="op" id="4917909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917913">t</span><span class="op" id="4917914">.</span><span class="ident" id="4917915">altProto</span>&nbsp;<span class="op" id="4917924">=</span>&nbsp;<span class="builtinfunc" id="4917926">make</span><span class="op" id="4917930">(</span><span class="keyword" id="4917931">map</span><span class="op" id="4917934">[</span><span class="builtintype" id="4917935">string</span><span class="op" id="4917941">]</span><span class="ident" id="4917942">RoundTripper</span><span class="op" id="4917954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4917957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917960">if</span>&nbsp;<span class="ident" id="4917963">_</span><span class="op" id="4917964">,</span>&nbsp;<span class="ident" id="4917966">exists</span>&nbsp;<span class="op" id="4917973">:=</span>&nbsp;<span class="ident" id="4917976">t</span><span class="op" id="4917977">.</span><span class="ident" id="4917978">altProto</span><span class="op" id="4917986">[</span><span class="ident" id="4917987">scheme</span><span class="op" id="4917993">]</span><span class="op" id="4917994">;</span>&nbsp;<span class="ident" id="4917996">exists</span>&nbsp;<span class="op" id="4918003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4918007">panic</span><span class="op" id="4918012">(</span><span class="string" id="4918013">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="4918025">+</span>&nbsp;<span class="ident" id="4918027">scheme</span>&nbsp;<span class="op" id="4918034">+</span>&nbsp;<span class="string" id="4918036">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="4918057">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4918060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918063">t</span><span class="op" id="4918064">.</span><span class="ident" id="4918065">altProto</span><span class="op" id="4918073">[</span><span class="ident" id="4918074">scheme</span><span class="op" id="4918080">]</span>&nbsp;<span class="op" id="4918082">=</span>&nbsp;<span class="ident" id="4918084">rt</span><br>
<span class="lineno"></span><span class="op" id="4918087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4918090">//&nbsp;CloseIdleConnections&nbsp;closes&nbsp;any&nbsp;connections&nbsp;which&nbsp;were&nbsp;previously</span><br>
<span class="lineno">260</span><span class="comment" id="4918159">//&nbsp;connected&nbsp;from&nbsp;previous&nbsp;requests&nbsp;but&nbsp;are&nbsp;now&nbsp;sitting&nbsp;idle&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4918223">//&nbsp;a&nbsp;&#34;keep-alive&#34;&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;interrupt&nbsp;any&nbsp;connections&nbsp;currently</span><br>
<span class="lineno"></span><span class="comment" id="4918296">//&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="4918307">func</span>&nbsp;<span class="op" id="4918312">(</span><span class="ident" id="4918313">t</span>&nbsp;<span class="op" id="4918315">*</span><span class="ident" id="4918316">Transport</span><span class="op" id="4918325">)</span>&nbsp;<span class="ident" id="4918327">CloseIdleConnections</span><span class="op" id="4918347">(</span><span class="op" id="4918348">)</span>&nbsp;<span class="op" id="4918350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918353">t</span><span class="op" id="4918354">.</span><span class="ident" id="4918355">idleMu</span><span class="op" id="4918361">.</span><span class="ident" id="4918362">Lock</span><span class="op" id="4918366">(</span><span class="op" id="4918367">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918370">m</span>&nbsp;<span class="op" id="4918372">:=</span>&nbsp;<span class="ident" id="4918375">t</span><span class="op" id="4918376">.</span><span class="ident" id="4918377">idleConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918387">t</span><span class="op" id="4918388">.</span><span class="ident" id="4918389">idleConn</span>&nbsp;<span class="op" id="4918398">=</span>&nbsp;<span class="ident" id="4918400">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918405">t</span><span class="op" id="4918406">.</span><span class="ident" id="4918407">idleConnCh</span>&nbsp;<span class="op" id="4918418">=</span>&nbsp;<span class="ident" id="4918420">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918425">t</span><span class="op" id="4918426">.</span><span class="ident" id="4918427">wantIdle</span>&nbsp;<span class="op" id="4918436">=</span>&nbsp;<span class="builtintype" id="4918438">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918444">t</span><span class="op" id="4918445">.</span><span class="ident" id="4918446">idleMu</span><span class="op" id="4918452">.</span><span class="ident" id="4918453">Unlock</span><span class="op" id="4918459">(</span><span class="op" id="4918460">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4918463">for</span>&nbsp;<span class="ident" id="4918467">_</span><span class="op" id="4918468">,</span>&nbsp;<span class="ident" id="4918470">conns</span>&nbsp;<span class="op" id="4918476">:=</span>&nbsp;<span class="keyword" id="4918479">range</span>&nbsp;<span class="ident" id="4918485">m</span>&nbsp;<span class="op" id="4918487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4918491">for</span>&nbsp;<span class="ident" id="4918495">_</span><span class="op" id="4918496">,</span>&nbsp;<span class="ident" id="4918498">pconn</span>&nbsp;<span class="op" id="4918504">:=</span>&nbsp;<span class="keyword" id="4918507">range</span>&nbsp;<span class="ident" id="4918513">conns</span>&nbsp;<span class="op" id="4918519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918524">pconn</span><span class="op" id="4918529">.</span><span class="builtinfunc" id="4918530">close</span><span class="op" id="4918535">(</span><span class="op" id="4918536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4918540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4918543">}</span><br>
<span class="lineno">275</span><span class="op" id="4918545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4918548">//&nbsp;CancelRequest&nbsp;cancels&nbsp;an&nbsp;in-flight&nbsp;request&nbsp;by&nbsp;closing&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="4918609">//&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4918624">func</span>&nbsp;<span class="op" id="4918629">(</span><span class="ident" id="4918630">t</span>&nbsp;<span class="op" id="4918632">*</span><span class="ident" id="4918633">Transport</span><span class="op" id="4918642">)</span>&nbsp;<span class="ident" id="4918644">CancelRequest</span><span class="op" id="4918657">(</span><span class="ident" id="4918658">req</span>&nbsp;<span class="op" id="4918662">*</span><span class="ident" id="4918663">Request</span><span class="op" id="4918670">)</span>&nbsp;<span class="op" id="4918672">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918675">t</span><span class="op" id="4918676">.</span><span class="ident" id="4918677">reqMu</span><span class="op" id="4918682">.</span><span class="ident" id="4918683">Lock</span><span class="op" id="4918687">(</span><span class="op" id="4918688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918691">cancel</span>&nbsp;<span class="op" id="4918698">:=</span>&nbsp;<span class="ident" id="4918701">t</span><span class="op" id="4918702">.</span><span class="ident" id="4918703">reqCanceler</span><span class="op" id="4918714">[</span><span class="ident" id="4918715">req</span><span class="op" id="4918718">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918721">t</span><span class="op" id="4918722">.</span><span class="ident" id="4918723">reqMu</span><span class="op" id="4918728">.</span><span class="ident" id="4918729">Unlock</span><span class="op" id="4918735">(</span><span class="op" id="4918736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4918739">if</span>&nbsp;<span class="ident" id="4918742">cancel</span>&nbsp;<span class="op" id="4918749">!=</span>&nbsp;<span class="ident" id="4918752">nil</span>&nbsp;<span class="op" id="4918756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918760">cancel</span><span class="op" id="4918766">(</span><span class="op" id="4918767">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4918770">}</span><br>
<span class="lineno"></span><span class="op" id="4918772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4918775">//</span><br>
<span class="lineno"></span><span class="comment" id="4918778">//&nbsp;Private&nbsp;implementation&nbsp;past&nbsp;this&nbsp;point.</span><br>
<span class="lineno">290</span><span class="comment" id="4918821">//</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4918825">var</span>&nbsp;<span class="op" id="4918829">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918832">httpProxyEnv</span>&nbsp;<span class="op" id="4918845">=</span>&nbsp;<span class="op" id="4918847">&amp;</span><span class="ident" id="4918848">envOnce</span><span class="op" id="4918855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918859">names</span><span class="op" id="4918864">:</span>&nbsp;<span class="op" id="4918866">[</span><span class="op" id="4918867">]</span><span class="builtintype" id="4918868">string</span><span class="op" id="4918874">{</span><span class="string" id="4918875">&#34;HTTP_PROXY&#34;</span><span class="op" id="4918887">,</span>&nbsp;<span class="string" id="4918889">&#34;http_proxy&#34;</span><span class="op" id="4918901">}</span><span class="op" id="4918902">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4918905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918908">httpsProxyEnv</span>&nbsp;<span class="op" id="4918922">=</span>&nbsp;<span class="op" id="4918924">&amp;</span><span class="ident" id="4918925">envOnce</span><span class="op" id="4918932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918936">names</span><span class="op" id="4918941">:</span>&nbsp;<span class="op" id="4918943">[</span><span class="op" id="4918944">]</span><span class="builtintype" id="4918945">string</span><span class="op" id="4918951">{</span><span class="string" id="4918952">&#34;HTTPS_PROXY&#34;</span><span class="op" id="4918965">,</span>&nbsp;<span class="string" id="4918967">&#34;https_proxy&#34;</span><span class="op" id="4918980">}</span><span class="op" id="4918981">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4918984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918987">noProxyEnv</span>&nbsp;<span class="op" id="4918998">=</span>&nbsp;<span class="op" id="4919000">&amp;</span><span class="ident" id="4919001">envOnce</span><span class="op" id="4919008">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919012">names</span><span class="op" id="4919017">:</span>&nbsp;<span class="op" id="4919019">[</span><span class="op" id="4919020">]</span><span class="builtintype" id="4919021">string</span><span class="op" id="4919027">{</span><span class="string" id="4919028">&#34;NO_PROXY&#34;</span><span class="op" id="4919038">,</span>&nbsp;<span class="string" id="4919040">&#34;no_proxy&#34;</span><span class="op" id="4919050">}</span><span class="op" id="4919051">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4919054">}</span><br>
<span class="lineno"></span><span class="op" id="4919056">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4919059">//&nbsp;envOnce&nbsp;looks&nbsp;up&nbsp;an&nbsp;environment&nbsp;variable&nbsp;(optionally&nbsp;by&nbsp;multiple</span><br>
<span class="lineno">305</span><span class="comment" id="4919127">//&nbsp;names)&nbsp;once.&nbsp;It&nbsp;mitigates&nbsp;expensive&nbsp;lookups&nbsp;on&nbsp;some&nbsp;platforms</span><br>
<span class="lineno"></span><span class="comment" id="4919192">//&nbsp;(e.g.&nbsp;Windows).</span><br>
<span class="lineno"></span><span class="keyword" id="4919211">type</span>&nbsp;<span class="ident" id="4919216">envOnce</span>&nbsp;<span class="keyword" id="4919224">struct</span>&nbsp;<span class="op" id="4919231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919234">names</span>&nbsp;<span class="op" id="4919240">[</span><span class="op" id="4919241">]</span><span class="builtintype" id="4919242">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919250">once</span>&nbsp;&nbsp;<span class="ident" id="4919256">sync</span><span class="op" id="4919260">.</span><span class="ident" id="4919261">Once</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919267">val</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4919273">string</span><br>
<span class="lineno"></span><span class="op" id="4919280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4919283">func</span>&nbsp;<span class="op" id="4919288">(</span><span class="ident" id="4919289">e</span>&nbsp;<span class="op" id="4919291">*</span><span class="ident" id="4919292">envOnce</span><span class="op" id="4919299">)</span>&nbsp;<span class="ident" id="4919301">Get</span><span class="op" id="4919304">(</span><span class="op" id="4919305">)</span>&nbsp;<span class="builtintype" id="4919307">string</span>&nbsp;<span class="op" id="4919314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919317">e</span><span class="op" id="4919318">.</span><span class="ident" id="4919319">once</span><span class="op" id="4919323">.</span><span class="ident" id="4919324">Do</span><span class="op" id="4919326">(</span><span class="ident" id="4919327">e</span><span class="op" id="4919328">.</span><span class="ident" id="4919329">init</span><span class="op" id="4919333">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4919336">return</span>&nbsp;<span class="ident" id="4919343">e</span><span class="op" id="4919344">.</span><span class="ident" id="4919345">val</span><br>
<span class="lineno"></span><span class="op" id="4919349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4919352">func</span>&nbsp;<span class="op" id="4919357">(</span><span class="ident" id="4919358">e</span>&nbsp;<span class="op" id="4919360">*</span><span class="ident" id="4919361">envOnce</span><span class="op" id="4919368">)</span>&nbsp;<span class="ident" id="4919370">init</span><span class="op" id="4919374">(</span><span class="op" id="4919375">)</span>&nbsp;<span class="op" id="4919377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4919380">for</span>&nbsp;<span class="ident" id="4919384">_</span><span class="op" id="4919385">,</span>&nbsp;<span class="ident" id="4919387">n</span>&nbsp;<span class="op" id="4919389">:=</span>&nbsp;<span class="keyword" id="4919392">range</span>&nbsp;<span class="ident" id="4919398">e</span><span class="op" id="4919399">.</span><span class="ident" id="4919400">names</span>&nbsp;<span class="op" id="4919406">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919410">e</span><span class="op" id="4919411">.</span><span class="ident" id="4919412">val</span>&nbsp;<span class="op" id="4919416">=</span>&nbsp;<span class="ident" id="4919418">os</span><span class="op" id="4919420">.</span><span class="ident" id="4919421">Getenv</span><span class="op" id="4919427">(</span><span class="ident" id="4919428">n</span><span class="op" id="4919429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4919433">if</span>&nbsp;<span class="ident" id="4919436">e</span><span class="op" id="4919437">.</span><span class="ident" id="4919438">val</span>&nbsp;<span class="op" id="4919442">!=</span>&nbsp;<span class="string" id="4919445">&#34;&#34;</span>&nbsp;<span class="op" id="4919448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4919453">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4919462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4919465">}</span><br>
<span class="lineno">325</span><span class="op" id="4919467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4919470">//&nbsp;reset&nbsp;is&nbsp;used&nbsp;by&nbsp;tests</span><br>
<span class="lineno"></span><span class="keyword" id="4919496">func</span>&nbsp;<span class="op" id="4919501">(</span><span class="ident" id="4919502">e</span>&nbsp;<span class="op" id="4919504">*</span><span class="ident" id="4919505">envOnce</span><span class="op" id="4919512">)</span>&nbsp;<span class="ident" id="4919514">reset</span><span class="op" id="4919519">(</span><span class="op" id="4919520">)</span>&nbsp;<span class="op" id="4919522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919525">e</span><span class="op" id="4919526">.</span><span class="ident" id="4919527">once</span>&nbsp;<span class="op" id="4919532">=</span>&nbsp;<span class="ident" id="4919534">sync</span><span class="op" id="4919538">.</span><span class="ident" id="4919539">Once</span><span class="op" id="4919543">{</span><span class="op" id="4919544">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919547">e</span><span class="op" id="4919548">.</span><span class="ident" id="4919549">val</span>&nbsp;<span class="op" id="4919553">=</span>&nbsp;<span class="string" id="4919555">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="4919558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4919561">func</span>&nbsp;<span class="op" id="4919566">(</span><span class="ident" id="4919567">t</span>&nbsp;<span class="op" id="4919569">*</span><span class="ident" id="4919570">Transport</span><span class="op" id="4919579">)</span>&nbsp;<span class="ident" id="4919581">connectMethodForRequest</span><span class="op" id="4919604">(</span><span class="ident" id="4919605">treq</span>&nbsp;<span class="op" id="4919610">*</span><span class="ident" id="4919611">transportRequest</span><span class="op" id="4919627">)</span>&nbsp;<span class="op" id="4919629">(</span><span class="ident" id="4919630">cm</span>&nbsp;<span class="ident" id="4919633">connectMethod</span><span class="op" id="4919646">,</span>&nbsp;<span class="ident" id="4919648">err</span>&nbsp;<span class="builtintype" id="4919652">error</span><span class="op" id="4919657">)</span>&nbsp;<span class="op" id="4919659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919662">cm</span><span class="op" id="4919664">.</span><span class="ident" id="4919665">targetScheme</span>&nbsp;<span class="op" id="4919678">=</span>&nbsp;<span class="ident" id="4919680">treq</span><span class="op" id="4919684">.</span><span class="ident" id="4919685">URL</span><span class="op" id="4919688">.</span><span class="ident" id="4919689">Scheme</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919697">cm</span><span class="op" id="4919699">.</span><span class="ident" id="4919700">targetAddr</span>&nbsp;<span class="op" id="4919711">=</span>&nbsp;<span class="ident" id="4919713">canonicalAddr</span><span class="op" id="4919726">(</span><span class="ident" id="4919727">treq</span><span class="op" id="4919731">.</span><span class="ident" id="4919732">URL</span><span class="op" id="4919735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4919738">if</span>&nbsp;<span class="ident" id="4919741">t</span><span class="op" id="4919742">.</span><span class="ident" id="4919743">Proxy</span>&nbsp;<span class="op" id="4919749">!=</span>&nbsp;<span class="ident" id="4919752">nil</span>&nbsp;<span class="op" id="4919756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919760">cm</span><span class="op" id="4919762">.</span><span class="ident" id="4919763">proxyURL</span><span class="op" id="4919771">,</span>&nbsp;<span class="ident" id="4919773">err</span>&nbsp;<span class="op" id="4919777">=</span>&nbsp;<span class="ident" id="4919779">t</span><span class="op" id="4919780">.</span><span class="ident" id="4919781">Proxy</span><span class="op" id="4919786">(</span><span class="ident" id="4919787">treq</span><span class="op" id="4919791">.</span><span class="ident" id="4919792">Request</span><span class="op" id="4919799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4919802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4919805">return</span>&nbsp;<span class="ident" id="4919812">cm</span><span class="op" id="4919814">,</span>&nbsp;<span class="ident" id="4919816">err</span><br>
<span class="lineno">340</span><span class="op" id="4919820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4919823">//&nbsp;proxyAuth&nbsp;returns&nbsp;the&nbsp;Proxy-Authorization&nbsp;header&nbsp;to&nbsp;set</span><br>
<span class="lineno"></span><span class="comment" id="4919882">//&nbsp;on&nbsp;requests,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="4919913">func</span>&nbsp;<span class="op" id="4919918">(</span><span class="ident" id="4919919">cm</span>&nbsp;<span class="op" id="4919922">*</span><span class="ident" id="4919923">connectMethod</span><span class="op" id="4919936">)</span>&nbsp;<span class="ident" id="4919938">proxyAuth</span><span class="op" id="4919947">(</span><span class="op" id="4919948">)</span>&nbsp;<span class="builtintype" id="4919950">string</span>&nbsp;<span class="op" id="4919957">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4919960">if</span>&nbsp;<span class="ident" id="4919963">cm</span><span class="op" id="4919965">.</span><span class="ident" id="4919966">proxyURL</span>&nbsp;<span class="op" id="4919975">==</span>&nbsp;<span class="ident" id="4919978">nil</span>&nbsp;<span class="op" id="4919982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4919986">return</span>&nbsp;<span class="string" id="4919993">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4919997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920000">if</span>&nbsp;<span class="ident" id="4920003">u</span>&nbsp;<span class="op" id="4920005">:=</span>&nbsp;<span class="ident" id="4920008">cm</span><span class="op" id="4920010">.</span><span class="ident" id="4920011">proxyURL</span><span class="op" id="4920019">.</span><span class="ident" id="4920020">User</span><span class="op" id="4920024">;</span>&nbsp;<span class="ident" id="4920026">u</span>&nbsp;<span class="op" id="4920028">!=</span>&nbsp;<span class="ident" id="4920031">nil</span>&nbsp;<span class="op" id="4920035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920039">username</span>&nbsp;<span class="op" id="4920048">:=</span>&nbsp;<span class="ident" id="4920051">u</span><span class="op" id="4920052">.</span><span class="ident" id="4920053">Username</span><span class="op" id="4920061">(</span><span class="op" id="4920062">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920066">password</span><span class="op" id="4920074">,</span>&nbsp;<span class="ident" id="4920076">_</span>&nbsp;<span class="op" id="4920078">:=</span>&nbsp;<span class="ident" id="4920081">u</span><span class="op" id="4920082">.</span><span class="ident" id="4920083">Password</span><span class="op" id="4920091">(</span><span class="op" id="4920092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920096">return</span>&nbsp;<span class="string" id="4920103">&#34;Basic&nbsp;&#34;</span>&nbsp;<span class="op" id="4920112">+</span>&nbsp;<span class="ident" id="4920114">basicAuth</span><span class="op" id="4920123">(</span><span class="ident" id="4920124">username</span><span class="op" id="4920132">,</span>&nbsp;<span class="ident" id="4920134">password</span><span class="op" id="4920142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920148">return</span>&nbsp;<span class="string" id="4920155">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="4920158">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="4920161">//&nbsp;putIdleConn&nbsp;adds&nbsp;pconn&nbsp;to&nbsp;the&nbsp;list&nbsp;of&nbsp;idle&nbsp;persistent&nbsp;connections&nbsp;awaiting</span><br>
<span class="lineno"></span><span class="comment" id="4920239">//&nbsp;a&nbsp;new&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="4920257">//&nbsp;If&nbsp;pconn&nbsp;is&nbsp;no&nbsp;longer&nbsp;needed&nbsp;or&nbsp;not&nbsp;in&nbsp;a&nbsp;good&nbsp;state,&nbsp;putIdleConn</span><br>
<span class="lineno"></span><span class="comment" id="4920325">//&nbsp;returns&nbsp;false.</span><br>
<span class="lineno">360</span><span class="keyword" id="4920343">func</span>&nbsp;<span class="op" id="4920348">(</span><span class="ident" id="4920349">t</span>&nbsp;<span class="op" id="4920351">*</span><span class="ident" id="4920352">Transport</span><span class="op" id="4920361">)</span>&nbsp;<span class="ident" id="4920363">putIdleConn</span><span class="op" id="4920374">(</span><span class="ident" id="4920375">pconn</span>&nbsp;<span class="op" id="4920381">*</span><span class="ident" id="4920382">persistConn</span><span class="op" id="4920393">)</span>&nbsp;<span class="builtintype" id="4920395">bool</span>&nbsp;<span class="op" id="4920400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920403">if</span>&nbsp;<span class="ident" id="4920406">t</span><span class="op" id="4920407">.</span><span class="ident" id="4920408">DisableKeepAlives</span>&nbsp;<span class="op" id="4920426">||</span>&nbsp;<span class="ident" id="4920429">t</span><span class="op" id="4920430">.</span><span class="ident" id="4920431">MaxIdleConnsPerHost</span>&nbsp;<span class="op" id="4920451">&lt;</span>&nbsp;<span class="num" id="4920453">0</span>&nbsp;<span class="op" id="4920455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920459">pconn</span><span class="op" id="4920464">.</span><span class="builtinfunc" id="4920465">close</span><span class="op" id="4920470">(</span><span class="op" id="4920471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920475">return</span>&nbsp;<span class="builtintype" id="4920482">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920489">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920492">if</span>&nbsp;<span class="ident" id="4920495">pconn</span><span class="op" id="4920500">.</span><span class="ident" id="4920501">isBroken</span><span class="op" id="4920509">(</span><span class="op" id="4920510">)</span>&nbsp;<span class="op" id="4920512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920516">return</span>&nbsp;<span class="builtintype" id="4920523">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920533">key</span>&nbsp;<span class="op" id="4920537">:=</span>&nbsp;<span class="ident" id="4920540">pconn</span><span class="op" id="4920545">.</span><span class="ident" id="4920546">cacheKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920556">max</span>&nbsp;<span class="op" id="4920560">:=</span>&nbsp;<span class="ident" id="4920563">t</span><span class="op" id="4920564">.</span><span class="ident" id="4920565">MaxIdleConnsPerHost</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920586">if</span>&nbsp;<span class="ident" id="4920589">max</span>&nbsp;<span class="op" id="4920593">==</span>&nbsp;<span class="num" id="4920596">0</span>&nbsp;<span class="op" id="4920598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920602">max</span>&nbsp;<span class="op" id="4920606">=</span>&nbsp;<span class="ident" id="4920608">DefaultMaxIdleConnsPerHost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920639">t</span><span class="op" id="4920640">.</span><span class="ident" id="4920641">idleMu</span><span class="op" id="4920647">.</span><span class="ident" id="4920648">Lock</span><span class="op" id="4920652">(</span><span class="op" id="4920653">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920657">waitingDialer</span>&nbsp;<span class="op" id="4920671">:=</span>&nbsp;<span class="ident" id="4920674">t</span><span class="op" id="4920675">.</span><span class="ident" id="4920676">idleConnCh</span><span class="op" id="4920686">[</span><span class="ident" id="4920687">key</span><span class="op" id="4920690">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920693">select</span>&nbsp;<span class="op" id="4920700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920703">case</span>&nbsp;<span class="ident" id="4920708">waitingDialer</span>&nbsp;<span class="op" id="4920722">&lt;-</span>&nbsp;<span class="ident" id="4920725">pconn</span><span class="op" id="4920730">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4920734">//&nbsp;We&#39;re&nbsp;done&nbsp;with&nbsp;this&nbsp;pconn&nbsp;and&nbsp;somebody&nbsp;else&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4920787">//&nbsp;currently&nbsp;waiting&nbsp;for&nbsp;a&nbsp;conn&nbsp;of&nbsp;this&nbsp;type&nbsp;(they&#39;re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4920843">//&nbsp;actively&nbsp;dialing,&nbsp;but&nbsp;this&nbsp;conn&nbsp;is&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4920889">//&nbsp;first).&nbsp;Chrome&nbsp;calls&nbsp;this&nbsp;socket&nbsp;late&nbsp;binding.&nbsp;&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4920946">//&nbsp;https://insouciant.org/tech/connection-management-in-chromium/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921014">t</span><span class="op" id="4921015">.</span><span class="ident" id="4921016">idleMu</span><span class="op" id="4921022">.</span><span class="ident" id="4921023">Unlock</span><span class="op" id="4921029">(</span><span class="op" id="4921030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921034">return</span>&nbsp;<span class="builtintype" id="4921041">true</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921047">default</span><span class="op" id="4921054">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921058">if</span>&nbsp;<span class="ident" id="4921061">waitingDialer</span>&nbsp;<span class="op" id="4921075">!=</span>&nbsp;<span class="ident" id="4921078">nil</span>&nbsp;<span class="op" id="4921082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4921087">//&nbsp;They&nbsp;had&nbsp;populated&nbsp;this,&nbsp;but&nbsp;their&nbsp;dial&nbsp;won</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4921137">//&nbsp;first,&nbsp;so&nbsp;we&nbsp;can&nbsp;clean&nbsp;up&nbsp;this&nbsp;map&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4921185">delete</span><span class="op" id="4921191">(</span><span class="ident" id="4921192">t</span><span class="op" id="4921193">.</span><span class="ident" id="4921194">idleConnCh</span><span class="op" id="4921204">,</span>&nbsp;<span class="ident" id="4921206">key</span><span class="op" id="4921209">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4921213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4921216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921219">if</span>&nbsp;<span class="ident" id="4921222">t</span><span class="op" id="4921223">.</span><span class="ident" id="4921224">wantIdle</span>&nbsp;<span class="op" id="4921233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921237">t</span><span class="op" id="4921238">.</span><span class="ident" id="4921239">idleMu</span><span class="op" id="4921245">.</span><span class="ident" id="4921246">Unlock</span><span class="op" id="4921252">(</span><span class="op" id="4921253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921257">pconn</span><span class="op" id="4921262">.</span><span class="builtinfunc" id="4921263">close</span><span class="op" id="4921268">(</span><span class="op" id="4921269">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921273">return</span>&nbsp;<span class="builtintype" id="4921280">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4921287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921290">if</span>&nbsp;<span class="ident" id="4921293">t</span><span class="op" id="4921294">.</span><span class="ident" id="4921295">idleConn</span>&nbsp;<span class="op" id="4921304">==</span>&nbsp;<span class="ident" id="4921307">nil</span>&nbsp;<span class="op" id="4921311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921315">t</span><span class="op" id="4921316">.</span><span class="ident" id="4921317">idleConn</span>&nbsp;<span class="op" id="4921326">=</span>&nbsp;<span class="builtinfunc" id="4921328">make</span><span class="op" id="4921332">(</span><span class="keyword" id="4921333">map</span><span class="op" id="4921336">[</span><span class="ident" id="4921337">connectMethodKey</span><span class="op" id="4921353">]</span><span class="op" id="4921354">[</span><span class="op" id="4921355">]</span><span class="op" id="4921356">*</span><span class="ident" id="4921357">persistConn</span><span class="op" id="4921368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4921371">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921374">if</span>&nbsp;<span class="builtinfunc" id="4921377">len</span><span class="op" id="4921380">(</span><span class="ident" id="4921381">t</span><span class="op" id="4921382">.</span><span class="ident" id="4921383">idleConn</span><span class="op" id="4921391">[</span><span class="ident" id="4921392">key</span><span class="op" id="4921395">]</span><span class="op" id="4921396">)</span>&nbsp;<span class="op" id="4921398">&gt;=</span>&nbsp;<span class="ident" id="4921401">max</span>&nbsp;<span class="op" id="4921405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921409">t</span><span class="op" id="4921410">.</span><span class="ident" id="4921411">idleMu</span><span class="op" id="4921417">.</span><span class="ident" id="4921418">Unlock</span><span class="op" id="4921424">(</span><span class="op" id="4921425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921429">pconn</span><span class="op" id="4921434">.</span><span class="builtinfunc" id="4921435">close</span><span class="op" id="4921440">(</span><span class="op" id="4921441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921445">return</span>&nbsp;<span class="builtintype" id="4921452">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4921459">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921462">for</span>&nbsp;<span class="ident" id="4921466">_</span><span class="op" id="4921467">,</span>&nbsp;<span class="ident" id="4921469">exist</span>&nbsp;<span class="op" id="4921475">:=</span>&nbsp;<span class="keyword" id="4921478">range</span>&nbsp;<span class="ident" id="4921484">t</span><span class="op" id="4921485">.</span><span class="ident" id="4921486">idleConn</span><span class="op" id="4921494">[</span><span class="ident" id="4921495">key</span><span class="op" id="4921498">]</span>&nbsp;<span class="op" id="4921500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921504">if</span>&nbsp;<span class="ident" id="4921507">exist</span>&nbsp;<span class="op" id="4921513">==</span>&nbsp;<span class="ident" id="4921516">pconn</span>&nbsp;<span class="op" id="4921522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921527">log</span><span class="op" id="4921530">.</span><span class="ident" id="4921531">Fatalf</span><span class="op" id="4921537">(</span><span class="string" id="4921538">&#34;dup&nbsp;idle&nbsp;pconn&nbsp;%p&nbsp;in&nbsp;freelist&#34;</span><span class="op" id="4921569">,</span>&nbsp;<span class="ident" id="4921571">pconn</span><span class="op" id="4921576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4921580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4921583">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921586">t</span><span class="op" id="4921587">.</span><span class="ident" id="4921588">idleConn</span><span class="op" id="4921596">[</span><span class="ident" id="4921597">key</span><span class="op" id="4921600">]</span>&nbsp;<span class="op" id="4921602">=</span>&nbsp;<span class="builtinfunc" id="4921604">append</span><span class="op" id="4921610">(</span><span class="ident" id="4921611">t</span><span class="op" id="4921612">.</span><span class="ident" id="4921613">idleConn</span><span class="op" id="4921621">[</span><span class="ident" id="4921622">key</span><span class="op" id="4921625">]</span><span class="op" id="4921626">,</span>&nbsp;<span class="ident" id="4921628">pconn</span><span class="op" id="4921633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921636">t</span><span class="op" id="4921637">.</span><span class="ident" id="4921638">idleMu</span><span class="op" id="4921644">.</span><span class="ident" id="4921645">Unlock</span><span class="op" id="4921651">(</span><span class="op" id="4921652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921655">return</span>&nbsp;<span class="builtintype" id="4921662">true</span><br>
<span class="lineno"></span><span class="op" id="4921667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="4921670">//&nbsp;getIdleConnCh&nbsp;returns&nbsp;a&nbsp;channel&nbsp;to&nbsp;receive&nbsp;and&nbsp;return&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="4921732">//&nbsp;persistent&nbsp;connection&nbsp;for&nbsp;the&nbsp;given&nbsp;connectMethod.</span><br>
<span class="lineno"></span><span class="comment" id="4921786">//&nbsp;It&nbsp;may&nbsp;return&nbsp;nil,&nbsp;if&nbsp;persistent&nbsp;connections&nbsp;are&nbsp;not&nbsp;being&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4921854">func</span>&nbsp;<span class="op" id="4921859">(</span><span class="ident" id="4921860">t</span>&nbsp;<span class="op" id="4921862">*</span><span class="ident" id="4921863">Transport</span><span class="op" id="4921872">)</span>&nbsp;<span class="ident" id="4921874">getIdleConnCh</span><span class="op" id="4921887">(</span><span class="ident" id="4921888">cm</span>&nbsp;<span class="ident" id="4921891">connectMethod</span><span class="op" id="4921904">)</span>&nbsp;<span class="keyword" id="4921906">chan</span>&nbsp;<span class="op" id="4921911">*</span><span class="ident" id="4921912">persistConn</span>&nbsp;<span class="op" id="4921924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921927">if</span>&nbsp;<span class="ident" id="4921930">t</span><span class="op" id="4921931">.</span><span class="ident" id="4921932">DisableKeepAlives</span>&nbsp;<span class="op" id="4921950">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921954">return</span>&nbsp;<span class="ident" id="4921961">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4921966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921969">key</span>&nbsp;<span class="op" id="4921973">:=</span>&nbsp;<span class="ident" id="4921976">cm</span><span class="op" id="4921978">.</span><span class="ident" id="4921979">key</span><span class="op" id="4921982">(</span><span class="op" id="4921983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921986">t</span><span class="op" id="4921987">.</span><span class="ident" id="4921988">idleMu</span><span class="op" id="4921994">.</span><span class="ident" id="4921995">Lock</span><span class="op" id="4921999">(</span><span class="op" id="4922000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922003">defer</span>&nbsp;<span class="ident" id="4922009">t</span><span class="op" id="4922010">.</span><span class="ident" id="4922011">idleMu</span><span class="op" id="4922017">.</span><span class="ident" id="4922018">Unlock</span><span class="op" id="4922024">(</span><span class="op" id="4922025">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922028">t</span><span class="op" id="4922029">.</span><span class="ident" id="4922030">wantIdle</span>&nbsp;<span class="op" id="4922039">=</span>&nbsp;<span class="builtintype" id="4922041">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922048">if</span>&nbsp;<span class="ident" id="4922051">t</span><span class="op" id="4922052">.</span><span class="ident" id="4922053">idleConnCh</span>&nbsp;<span class="op" id="4922064">==</span>&nbsp;<span class="ident" id="4922067">nil</span>&nbsp;<span class="op" id="4922071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922075">t</span><span class="op" id="4922076">.</span><span class="ident" id="4922077">idleConnCh</span>&nbsp;<span class="op" id="4922088">=</span>&nbsp;<span class="builtinfunc" id="4922090">make</span><span class="op" id="4922094">(</span><span class="keyword" id="4922095">map</span><span class="op" id="4922098">[</span><span class="ident" id="4922099">connectMethodKey</span><span class="op" id="4922115">]</span><span class="keyword" id="4922116">chan</span>&nbsp;<span class="op" id="4922121">*</span><span class="ident" id="4922122">persistConn</span><span class="op" id="4922133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4922136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922139">ch</span><span class="op" id="4922141">,</span>&nbsp;<span class="ident" id="4922143">ok</span>&nbsp;<span class="op" id="4922146">:=</span>&nbsp;<span class="ident" id="4922149">t</span><span class="op" id="4922150">.</span><span class="ident" id="4922151">idleConnCh</span><span class="op" id="4922161">[</span><span class="ident" id="4922162">key</span><span class="op" id="4922165">]</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922168">if</span>&nbsp;<span class="op" id="4922171">!</span><span class="ident" id="4922172">ok</span>&nbsp;<span class="op" id="4922175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922179">ch</span>&nbsp;<span class="op" id="4922182">=</span>&nbsp;<span class="builtinfunc" id="4922184">make</span><span class="op" id="4922188">(</span><span class="keyword" id="4922189">chan</span>&nbsp;<span class="op" id="4922194">*</span><span class="ident" id="4922195">persistConn</span><span class="op" id="4922206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922210">t</span><span class="op" id="4922211">.</span><span class="ident" id="4922212">idleConnCh</span><span class="op" id="4922222">[</span><span class="ident" id="4922223">key</span><span class="op" id="4922226">]</span>&nbsp;<span class="op" id="4922228">=</span>&nbsp;<span class="ident" id="4922230">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4922234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922237">return</span>&nbsp;<span class="ident" id="4922244">ch</span><br>
<span class="lineno">435</span><span class="op" id="4922247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4922250">func</span>&nbsp;<span class="op" id="4922255">(</span><span class="ident" id="4922256">t</span>&nbsp;<span class="op" id="4922258">*</span><span class="ident" id="4922259">Transport</span><span class="op" id="4922268">)</span>&nbsp;<span class="ident" id="4922270">getIdleConn</span><span class="op" id="4922281">(</span><span class="ident" id="4922282">cm</span>&nbsp;<span class="ident" id="4922285">connectMethod</span><span class="op" id="4922298">)</span>&nbsp;<span class="op" id="4922300">(</span><span class="ident" id="4922301">pconn</span>&nbsp;<span class="op" id="4922307">*</span><span class="ident" id="4922308">persistConn</span><span class="op" id="4922319">)</span>&nbsp;<span class="op" id="4922321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922324">key</span>&nbsp;<span class="op" id="4922328">:=</span>&nbsp;<span class="ident" id="4922331">cm</span><span class="op" id="4922333">.</span><span class="ident" id="4922334">key</span><span class="op" id="4922337">(</span><span class="op" id="4922338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922341">t</span><span class="op" id="4922342">.</span><span class="ident" id="4922343">idleMu</span><span class="op" id="4922349">.</span><span class="ident" id="4922350">Lock</span><span class="op" id="4922354">(</span><span class="op" id="4922355">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922358">defer</span>&nbsp;<span class="ident" id="4922364">t</span><span class="op" id="4922365">.</span><span class="ident" id="4922366">idleMu</span><span class="op" id="4922372">.</span><span class="ident" id="4922373">Unlock</span><span class="op" id="4922379">(</span><span class="op" id="4922380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922383">if</span>&nbsp;<span class="ident" id="4922386">t</span><span class="op" id="4922387">.</span><span class="ident" id="4922388">idleConn</span>&nbsp;<span class="op" id="4922397">==</span>&nbsp;<span class="ident" id="4922400">nil</span>&nbsp;<span class="op" id="4922404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922408">return</span>&nbsp;<span class="ident" id="4922415">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4922420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922423">for</span>&nbsp;<span class="op" id="4922427">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922431">pconns</span><span class="op" id="4922437">,</span>&nbsp;<span class="ident" id="4922439">ok</span>&nbsp;<span class="op" id="4922442">:=</span>&nbsp;<span class="ident" id="4922445">t</span><span class="op" id="4922446">.</span><span class="ident" id="4922447">idleConn</span><span class="op" id="4922455">[</span><span class="ident" id="4922456">key</span><span class="op" id="4922459">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922463">if</span>&nbsp;<span class="op" id="4922466">!</span><span class="ident" id="4922467">ok</span>&nbsp;<span class="op" id="4922470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922475">return</span>&nbsp;<span class="ident" id="4922482">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4922488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922492">if</span>&nbsp;<span class="builtinfunc" id="4922495">len</span><span class="op" id="4922498">(</span><span class="ident" id="4922499">pconns</span><span class="op" id="4922505">)</span>&nbsp;<span class="op" id="4922507">==</span>&nbsp;<span class="num" id="4922510">1</span>&nbsp;<span class="op" id="4922512">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922517">pconn</span>&nbsp;<span class="op" id="4922523">=</span>&nbsp;<span class="ident" id="4922525">pconns</span><span class="op" id="4922531">[</span><span class="num" id="4922532">0</span><span class="op" id="4922533">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4922538">delete</span><span class="op" id="4922544">(</span><span class="ident" id="4922545">t</span><span class="op" id="4922546">.</span><span class="ident" id="4922547">idleConn</span><span class="op" id="4922555">,</span>&nbsp;<span class="ident" id="4922557">key</span><span class="op" id="4922560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4922564">}</span>&nbsp;<span class="keyword" id="4922566">else</span>&nbsp;<span class="op" id="4922571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4922576">//&nbsp;2&nbsp;or&nbsp;more&nbsp;cached&nbsp;connections;&nbsp;pop&nbsp;last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4922621">//&nbsp;TODO:&nbsp;queue?</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922640">pconn</span>&nbsp;<span class="op" id="4922646">=</span>&nbsp;<span class="ident" id="4922648">pconns</span><span class="op" id="4922654">[</span><span class="builtinfunc" id="4922655">len</span><span class="op" id="4922658">(</span><span class="ident" id="4922659">pconns</span><span class="op" id="4922665">)</span><span class="op" id="4922666">-</span><span class="num" id="4922667">1</span><span class="op" id="4922668">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922673">t</span><span class="op" id="4922674">.</span><span class="ident" id="4922675">idleConn</span><span class="op" id="4922683">[</span><span class="ident" id="4922684">key</span><span class="op" id="4922687">]</span>&nbsp;<span class="op" id="4922689">=</span>&nbsp;<span class="ident" id="4922691">pconns</span><span class="op" id="4922697">[</span><span class="op" id="4922698">:</span><span class="builtinfunc" id="4922699">len</span><span class="op" id="4922702">(</span><span class="ident" id="4922703">pconns</span><span class="op" id="4922709">)</span><span class="op" id="4922710">-</span><span class="num" id="4922711">1</span><span class="op" id="4922712">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4922716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922720">if</span>&nbsp;<span class="op" id="4922723">!</span><span class="ident" id="4922724">pconn</span><span class="op" id="4922729">.</span><span class="ident" id="4922730">isBroken</span><span class="op" id="4922738">(</span><span class="op" id="4922739">)</span>&nbsp;<span class="op" id="4922741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922746">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4922755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4922758">}</span><br>
<span class="lineno"></span><span class="op" id="4922760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4922763">func</span>&nbsp;<span class="op" id="4922768">(</span><span class="ident" id="4922769">t</span>&nbsp;<span class="op" id="4922771">*</span><span class="ident" id="4922772">Transport</span><span class="op" id="4922781">)</span>&nbsp;<span class="ident" id="4922783">setReqCanceler</span><span class="op" id="4922797">(</span><span class="ident" id="4922798">r</span>&nbsp;<span class="op" id="4922800">*</span><span class="ident" id="4922801">Request</span><span class="op" id="4922808">,</span>&nbsp;<span class="ident" id="4922810">fn</span>&nbsp;<span class="keyword" id="4922813">func</span><span class="op" id="4922817">(</span><span class="op" id="4922818">)</span><span class="op" id="4922819">)</span>&nbsp;<span class="op" id="4922821">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922824">t</span><span class="op" id="4922825">.</span><span class="ident" id="4922826">reqMu</span><span class="op" id="4922831">.</span><span class="ident" id="4922832">Lock</span><span class="op" id="4922836">(</span><span class="op" id="4922837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922840">defer</span>&nbsp;<span class="ident" id="4922846">t</span><span class="op" id="4922847">.</span><span class="ident" id="4922848">reqMu</span><span class="op" id="4922853">.</span><span class="ident" id="4922854">Unlock</span><span class="op" id="4922860">(</span><span class="op" id="4922861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922864">if</span>&nbsp;<span class="ident" id="4922867">t</span><span class="op" id="4922868">.</span><span class="ident" id="4922869">reqCanceler</span>&nbsp;<span class="op" id="4922881">==</span>&nbsp;<span class="ident" id="4922884">nil</span>&nbsp;<span class="op" id="4922888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922892">t</span><span class="op" id="4922893">.</span><span class="ident" id="4922894">reqCanceler</span>&nbsp;<span class="op" id="4922906">=</span>&nbsp;<span class="builtinfunc" id="4922908">make</span><span class="op" id="4922912">(</span><span class="keyword" id="4922913">map</span><span class="op" id="4922916">[</span><span class="op" id="4922917">*</span><span class="ident" id="4922918">Request</span><span class="op" id="4922925">]</span><span class="keyword" id="4922926">func</span><span class="op" id="4922930">(</span><span class="op" id="4922931">)</span><span class="op" id="4922932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4922935">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922938">if</span>&nbsp;<span class="ident" id="4922941">fn</span>&nbsp;<span class="op" id="4922944">!=</span>&nbsp;<span class="ident" id="4922947">nil</span>&nbsp;<span class="op" id="4922951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922955">t</span><span class="op" id="4922956">.</span><span class="ident" id="4922957">reqCanceler</span><span class="op" id="4922968">[</span><span class="ident" id="4922969">r</span><span class="op" id="4922970">]</span>&nbsp;<span class="op" id="4922972">=</span>&nbsp;<span class="ident" id="4922974">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4922978">}</span>&nbsp;<span class="keyword" id="4922980">else</span>&nbsp;<span class="op" id="4922985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4922989">delete</span><span class="op" id="4922995">(</span><span class="ident" id="4922996">t</span><span class="op" id="4922997">.</span><span class="ident" id="4922998">reqCanceler</span><span class="op" id="4923009">,</span>&nbsp;<span class="ident" id="4923011">r</span><span class="op" id="4923012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4923015">}</span><br>
<span class="lineno">475</span><span class="op" id="4923017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4923020">func</span>&nbsp;<span class="op" id="4923025">(</span><span class="ident" id="4923026">t</span>&nbsp;<span class="op" id="4923028">*</span><span class="ident" id="4923029">Transport</span><span class="op" id="4923038">)</span>&nbsp;<span class="ident" id="4923040">dial</span><span class="op" id="4923044">(</span><span class="ident" id="4923045">network</span><span class="op" id="4923052">,</span>&nbsp;<span class="ident" id="4923054">addr</span>&nbsp;<span class="builtintype" id="4923059">string</span><span class="op" id="4923065">)</span>&nbsp;<span class="op" id="4923067">(</span><span class="ident" id="4923068">c</span>&nbsp;<span class="ident" id="4923070">net</span><span class="op" id="4923073">.</span><span class="ident" id="4923074">Conn</span><span class="op" id="4923078">,</span>&nbsp;<span class="ident" id="4923080">err</span>&nbsp;<span class="builtintype" id="4923084">error</span><span class="op" id="4923089">)</span>&nbsp;<span class="op" id="4923091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923094">if</span>&nbsp;<span class="ident" id="4923097">t</span><span class="op" id="4923098">.</span><span class="ident" id="4923099">Dial</span>&nbsp;<span class="op" id="4923104">!=</span>&nbsp;<span class="ident" id="4923107">nil</span>&nbsp;<span class="op" id="4923111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923115">return</span>&nbsp;<span class="ident" id="4923122">t</span><span class="op" id="4923123">.</span><span class="ident" id="4923124">Dial</span><span class="op" id="4923128">(</span><span class="ident" id="4923129">network</span><span class="op" id="4923136">,</span>&nbsp;<span class="ident" id="4923138">addr</span><span class="op" id="4923142">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4923145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923148">return</span>&nbsp;<span class="ident" id="4923155">net</span><span class="op" id="4923158">.</span><span class="ident" id="4923159">Dial</span><span class="op" id="4923163">(</span><span class="ident" id="4923164">network</span><span class="op" id="4923171">,</span>&nbsp;<span class="ident" id="4923173">addr</span><span class="op" id="4923177">)</span><br>
<span class="lineno"></span><span class="op" id="4923179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4923182">//&nbsp;Testing&nbsp;hooks:</span><br>
<span class="lineno">485</span><span class="keyword" id="4923200">var</span>&nbsp;<span class="ident" id="4923204">prePendingDial</span><span class="op" id="4923218">,</span>&nbsp;<span class="ident" id="4923220">postPendingDial</span>&nbsp;<span class="keyword" id="4923236">func</span><span class="op" id="4923240">(</span><span class="op" id="4923241">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4923244">//&nbsp;getConn&nbsp;dials&nbsp;and&nbsp;creates&nbsp;a&nbsp;new&nbsp;persistConn&nbsp;to&nbsp;the&nbsp;target&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="4923308">//&nbsp;specified&nbsp;in&nbsp;the&nbsp;connectMethod.&nbsp;&nbsp;This&nbsp;includes&nbsp;doing&nbsp;a&nbsp;proxy&nbsp;CONNECT</span><br>
<span class="lineno"></span><span class="comment" id="4923380">//&nbsp;and/or&nbsp;setting&nbsp;up&nbsp;TLS.&nbsp;&nbsp;If&nbsp;this&nbsp;doesn&#39;t&nbsp;return&nbsp;an&nbsp;error,&nbsp;the&nbsp;persistConn</span><br>
<span class="lineno">490</span><span class="comment" id="4923456">//&nbsp;is&nbsp;ready&nbsp;to&nbsp;write&nbsp;requests&nbsp;to.</span><br>
<span class="lineno"></span><span class="keyword" id="4923490">func</span>&nbsp;<span class="op" id="4923495">(</span><span class="ident" id="4923496">t</span>&nbsp;<span class="op" id="4923498">*</span><span class="ident" id="4923499">Transport</span><span class="op" id="4923508">)</span>&nbsp;<span class="ident" id="4923510">getConn</span><span class="op" id="4923517">(</span><span class="ident" id="4923518">req</span>&nbsp;<span class="op" id="4923522">*</span><span class="ident" id="4923523">Request</span><span class="op" id="4923530">,</span>&nbsp;<span class="ident" id="4923532">cm</span>&nbsp;<span class="ident" id="4923535">connectMethod</span><span class="op" id="4923548">)</span>&nbsp;<span class="op" id="4923550">(</span><span class="op" id="4923551">*</span><span class="ident" id="4923552">persistConn</span><span class="op" id="4923563">,</span>&nbsp;<span class="builtintype" id="4923565">error</span><span class="op" id="4923570">)</span>&nbsp;<span class="op" id="4923572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923575">if</span>&nbsp;<span class="ident" id="4923578">pc</span>&nbsp;<span class="op" id="4923581">:=</span>&nbsp;<span class="ident" id="4923584">t</span><span class="op" id="4923585">.</span><span class="ident" id="4923586">getIdleConn</span><span class="op" id="4923597">(</span><span class="ident" id="4923598">cm</span><span class="op" id="4923600">)</span><span class="op" id="4923601">;</span>&nbsp;<span class="ident" id="4923603">pc</span>&nbsp;<span class="op" id="4923606">!=</span>&nbsp;<span class="ident" id="4923609">nil</span>&nbsp;<span class="op" id="4923613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923617">return</span>&nbsp;<span class="ident" id="4923624">pc</span><span class="op" id="4923626">,</span>&nbsp;<span class="ident" id="4923628">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4923633">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923637">type</span>&nbsp;<span class="ident" id="4923642">dialRes</span>&nbsp;<span class="keyword" id="4923650">struct</span>&nbsp;<span class="op" id="4923657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923661">pc</span>&nbsp;&nbsp;<span class="op" id="4923665">*</span><span class="ident" id="4923666">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923680">err</span>&nbsp;<span class="builtintype" id="4923684">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4923691">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923694">dialc</span>&nbsp;<span class="op" id="4923700">:=</span>&nbsp;<span class="builtinfunc" id="4923703">make</span><span class="op" id="4923707">(</span><span class="keyword" id="4923708">chan</span>&nbsp;<span class="ident" id="4923713">dialRes</span><span class="op" id="4923720">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923724">handlePendingDial</span>&nbsp;<span class="op" id="4923742">:=</span>&nbsp;<span class="keyword" id="4923745">func</span><span class="op" id="4923749">(</span><span class="op" id="4923750">)</span>&nbsp;<span class="op" id="4923752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923756">if</span>&nbsp;<span class="ident" id="4923759">prePendingDial</span>&nbsp;<span class="op" id="4923774">!=</span>&nbsp;<span class="ident" id="4923777">nil</span>&nbsp;<span class="op" id="4923781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923786">prePendingDial</span><span class="op" id="4923800">(</span><span class="op" id="4923801">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4923805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923809">go</span>&nbsp;<span class="keyword" id="4923812">func</span><span class="op" id="4923816">(</span><span class="op" id="4923817">)</span>&nbsp;<span class="op" id="4923819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923824">if</span>&nbsp;<span class="ident" id="4923827">v</span>&nbsp;<span class="op" id="4923829">:=</span>&nbsp;<span class="op" id="4923832">&lt;-</span><span class="ident" id="4923834">dialc</span><span class="op" id="4923839">;</span>&nbsp;<span class="ident" id="4923841">v</span><span class="op" id="4923842">.</span><span class="ident" id="4923843">err</span>&nbsp;<span class="op" id="4923847">==</span>&nbsp;<span class="ident" id="4923850">nil</span>&nbsp;<span class="op" id="4923854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923860">t</span><span class="op" id="4923861">.</span><span class="ident" id="4923862">putIdleConn</span><span class="op" id="4923873">(</span><span class="ident" id="4923874">v</span><span class="op" id="4923875">.</span><span class="ident" id="4923876">pc</span><span class="op" id="4923878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4923883">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923888">if</span>&nbsp;<span class="ident" id="4923891">postPendingDial</span>&nbsp;<span class="op" id="4923907">!=</span>&nbsp;<span class="ident" id="4923910">nil</span>&nbsp;<span class="op" id="4923914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923920">postPendingDial</span><span class="op" id="4923935">(</span><span class="op" id="4923936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4923941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4923945">}</span><span class="op" id="4923946">(</span><span class="op" id="4923947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4923950">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923954">cancelc</span>&nbsp;<span class="op" id="4923962">:=</span>&nbsp;<span class="builtinfunc" id="4923965">make</span><span class="op" id="4923969">(</span><span class="keyword" id="4923970">chan</span>&nbsp;<span class="keyword" id="4923975">struct</span><span class="op" id="4923981">{</span><span class="op" id="4923982">}</span><span class="op" id="4923983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923986">t</span><span class="op" id="4923987">.</span><span class="ident" id="4923988">setReqCanceler</span><span class="op" id="4924002">(</span><span class="ident" id="4924003">req</span><span class="op" id="4924006">,</span>&nbsp;<span class="keyword" id="4924008">func</span><span class="op" id="4924012">(</span><span class="op" id="4924013">)</span>&nbsp;<span class="op" id="4924015">{</span>&nbsp;<span class="builtinfunc" id="4924017">close</span><span class="op" id="4924022">(</span><span class="ident" id="4924023">cancelc</span><span class="op" id="4924030">)</span>&nbsp;<span class="op" id="4924032">}</span><span class="op" id="4924033">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924037">go</span>&nbsp;<span class="keyword" id="4924040">func</span><span class="op" id="4924044">(</span><span class="op" id="4924045">)</span>&nbsp;<span class="op" id="4924047">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924051">pc</span><span class="op" id="4924053">,</span>&nbsp;<span class="ident" id="4924055">err</span>&nbsp;<span class="op" id="4924059">:=</span>&nbsp;<span class="ident" id="4924062">t</span><span class="op" id="4924063">.</span><span class="ident" id="4924064">dialConn</span><span class="op" id="4924072">(</span><span class="ident" id="4924073">cm</span><span class="op" id="4924075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924079">dialc</span>&nbsp;<span class="op" id="4924085">&lt;-</span>&nbsp;<span class="ident" id="4924088">dialRes</span><span class="op" id="4924095">{</span><span class="ident" id="4924096">pc</span><span class="op" id="4924098">,</span>&nbsp;<span class="ident" id="4924100">err</span><span class="op" id="4924103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924106">}</span><span class="op" id="4924107">(</span><span class="op" id="4924108">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924112">idleConnCh</span>&nbsp;<span class="op" id="4924123">:=</span>&nbsp;<span class="ident" id="4924126">t</span><span class="op" id="4924127">.</span><span class="ident" id="4924128">getIdleConnCh</span><span class="op" id="4924141">(</span><span class="ident" id="4924142">cm</span><span class="op" id="4924144">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924147">select</span>&nbsp;<span class="op" id="4924154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924157">case</span>&nbsp;<span class="ident" id="4924162">v</span>&nbsp;<span class="op" id="4924164">:=</span>&nbsp;<span class="op" id="4924167">&lt;-</span><span class="ident" id="4924169">dialc</span><span class="op" id="4924174">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4924178">//&nbsp;Our&nbsp;dial&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924202">return</span>&nbsp;<span class="ident" id="4924209">v</span><span class="op" id="4924210">.</span><span class="ident" id="4924211">pc</span><span class="op" id="4924213">,</span>&nbsp;<span class="ident" id="4924215">v</span><span class="op" id="4924216">.</span><span class="ident" id="4924217">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924222">case</span>&nbsp;<span class="ident" id="4924227">pc</span>&nbsp;<span class="op" id="4924230">:=</span>&nbsp;<span class="op" id="4924233">&lt;-</span><span class="ident" id="4924235">idleConnCh</span><span class="op" id="4924245">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4924249">//&nbsp;Another&nbsp;request&nbsp;finished&nbsp;first&nbsp;and&nbsp;its&nbsp;net.Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4924302">//&nbsp;became&nbsp;available&nbsp;before&nbsp;our&nbsp;dial.&nbsp;Or&nbsp;somebody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4924353">//&nbsp;else&#39;s&nbsp;dial&nbsp;that&nbsp;they&nbsp;didn&#39;t&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4924392">//&nbsp;But&nbsp;our&nbsp;dial&nbsp;is&nbsp;still&nbsp;going,&nbsp;so&nbsp;give&nbsp;it&nbsp;away</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4924442">//&nbsp;when&nbsp;it&nbsp;finishes:</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924465">handlePendingDial</span><span class="op" id="4924482">(</span><span class="op" id="4924483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924487">return</span>&nbsp;<span class="ident" id="4924494">pc</span><span class="op" id="4924496">,</span>&nbsp;<span class="ident" id="4924498">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924503">case</span>&nbsp;<span class="op" id="4924508">&lt;-</span><span class="ident" id="4924510">cancelc</span><span class="op" id="4924517">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924521">handlePendingDial</span><span class="op" id="4924538">(</span><span class="op" id="4924539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924543">return</span>&nbsp;<span class="ident" id="4924550">nil</span><span class="op" id="4924553">,</span>&nbsp;<span class="ident" id="4924555">errors</span><span class="op" id="4924561">.</span><span class="ident" id="4924562">New</span><span class="op" id="4924565">(</span><span class="string" id="4924566">&#34;net/http:&nbsp;request&nbsp;canceled&nbsp;while&nbsp;waiting&nbsp;for&nbsp;connection&#34;</span><span class="op" id="4924623">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924626">}</span><br>
<span class="lineno"></span><span class="op" id="4924628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4924631">func</span>&nbsp;<span class="op" id="4924636">(</span><span class="ident" id="4924637">t</span>&nbsp;<span class="op" id="4924639">*</span><span class="ident" id="4924640">Transport</span><span class="op" id="4924649">)</span>&nbsp;<span class="ident" id="4924651">dialConn</span><span class="op" id="4924659">(</span><span class="ident" id="4924660">cm</span>&nbsp;<span class="ident" id="4924663">connectMethod</span><span class="op" id="4924676">)</span>&nbsp;<span class="op" id="4924678">(</span><span class="op" id="4924679">*</span><span class="ident" id="4924680">persistConn</span><span class="op" id="4924691">,</span>&nbsp;<span class="builtintype" id="4924693">error</span><span class="op" id="4924698">)</span>&nbsp;<span class="op" id="4924700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924703">pconn</span>&nbsp;<span class="op" id="4924709">:=</span>&nbsp;<span class="op" id="4924712">&amp;</span><span class="ident" id="4924713">persistConn</span><span class="op" id="4924724">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924728">t</span><span class="op" id="4924729">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4924740">t</span><span class="op" id="4924741">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924745">cacheKey</span><span class="op" id="4924753">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4924757">cm</span><span class="op" id="4924759">.</span><span class="ident" id="4924760">key</span><span class="op" id="4924763">(</span><span class="op" id="4924764">)</span><span class="op" id="4924765">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924769">reqch</span><span class="op" id="4924774">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4924781">make</span><span class="op" id="4924785">(</span><span class="keyword" id="4924786">chan</span>&nbsp;<span class="ident" id="4924791">requestAndChan</span><span class="op" id="4924805">,</span>&nbsp;<span class="num" id="4924807">1</span><span class="op" id="4924808">)</span><span class="op" id="4924809">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924813">writech</span><span class="op" id="4924820">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4924825">make</span><span class="op" id="4924829">(</span><span class="keyword" id="4924830">chan</span>&nbsp;<span class="ident" id="4924835">writeRequest</span><span class="op" id="4924847">,</span>&nbsp;<span class="num" id="4924849">1</span><span class="op" id="4924850">)</span><span class="op" id="4924851">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924855">closech</span><span class="op" id="4924862">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4924867">make</span><span class="op" id="4924871">(</span><span class="keyword" id="4924872">chan</span>&nbsp;<span class="keyword" id="4924877">struct</span><span class="op" id="4924883">{</span><span class="op" id="4924884">}</span><span class="op" id="4924885">)</span><span class="op" id="4924886">,</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924890">writeErrCh</span><span class="op" id="4924900">:</span>&nbsp;<span class="builtinfunc" id="4924902">make</span><span class="op" id="4924906">(</span><span class="keyword" id="4924907">chan</span>&nbsp;<span class="builtintype" id="4924912">error</span><span class="op" id="4924917">,</span>&nbsp;<span class="num" id="4924919">1</span><span class="op" id="4924920">)</span><span class="op" id="4924921">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924927">tlsDial</span>&nbsp;<span class="op" id="4924935">:=</span>&nbsp;<span class="ident" id="4924938">t</span><span class="op" id="4924939">.</span><span class="ident" id="4924940">DialTLS</span>&nbsp;<span class="op" id="4924948">!=</span>&nbsp;<span class="ident" id="4924951">nil</span>&nbsp;<span class="op" id="4924955">&amp;&amp;</span>&nbsp;<span class="ident" id="4924958">cm</span><span class="op" id="4924960">.</span><span class="ident" id="4924961">targetScheme</span>&nbsp;<span class="op" id="4924974">==</span>&nbsp;<span class="string" id="4924977">&#34;https&#34;</span>&nbsp;<span class="op" id="4924985">&amp;&amp;</span>&nbsp;<span class="ident" id="4924988">cm</span><span class="op" id="4924990">.</span><span class="ident" id="4924991">proxyURL</span>&nbsp;<span class="op" id="4925000">==</span>&nbsp;<span class="ident" id="4925003">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925008">if</span>&nbsp;<span class="ident" id="4925011">tlsDial</span>&nbsp;<span class="op" id="4925019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925023">var</span>&nbsp;<span class="ident" id="4925027">err</span>&nbsp;<span class="builtintype" id="4925031">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925039">pconn</span><span class="op" id="4925044">.</span><span class="ident" id="4925045">conn</span><span class="op" id="4925049">,</span>&nbsp;<span class="ident" id="4925051">err</span>&nbsp;<span class="op" id="4925055">=</span>&nbsp;<span class="ident" id="4925057">t</span><span class="op" id="4925058">.</span><span class="ident" id="4925059">DialTLS</span><span class="op" id="4925066">(</span><span class="string" id="4925067">&#34;tcp&#34;</span><span class="op" id="4925072">,</span>&nbsp;<span class="ident" id="4925074">cm</span><span class="op" id="4925076">.</span><span class="ident" id="4925077">addr</span><span class="op" id="4925081">(</span><span class="op" id="4925082">)</span><span class="op" id="4925083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925087">if</span>&nbsp;<span class="ident" id="4925090">err</span>&nbsp;<span class="op" id="4925094">!=</span>&nbsp;<span class="ident" id="4925097">nil</span>&nbsp;<span class="op" id="4925101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925106">return</span>&nbsp;<span class="ident" id="4925113">nil</span><span class="op" id="4925116">,</span>&nbsp;<span class="ident" id="4925118">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925128">if</span>&nbsp;<span class="ident" id="4925131">tc</span><span class="op" id="4925133">,</span>&nbsp;<span class="ident" id="4925135">ok</span>&nbsp;<span class="op" id="4925138">:=</span>&nbsp;<span class="ident" id="4925141">pconn</span><span class="op" id="4925146">.</span><span class="ident" id="4925147">conn</span><span class="op" id="4925151">.</span><span class="op" id="4925152">(</span><span class="op" id="4925153">*</span><span class="ident" id="4925154">tls</span><span class="op" id="4925157">.</span><span class="ident" id="4925158">Conn</span><span class="op" id="4925162">)</span><span class="op" id="4925163">;</span>&nbsp;<span class="ident" id="4925165">ok</span>&nbsp;<span class="op" id="4925168">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925173">cs</span>&nbsp;<span class="op" id="4925176">:=</span>&nbsp;<span class="ident" id="4925179">tc</span><span class="op" id="4925181">.</span><span class="ident" id="4925182">ConnectionState</span><span class="op" id="4925197">(</span><span class="op" id="4925198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925203">pconn</span><span class="op" id="4925208">.</span><span class="ident" id="4925209">tlsState</span>&nbsp;<span class="op" id="4925218">=</span>&nbsp;<span class="op" id="4925220">&amp;</span><span class="ident" id="4925221">cs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925229">}</span>&nbsp;<span class="keyword" id="4925231">else</span>&nbsp;<span class="op" id="4925236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925240">conn</span><span class="op" id="4925244">,</span>&nbsp;<span class="ident" id="4925246">err</span>&nbsp;<span class="op" id="4925250">:=</span>&nbsp;<span class="ident" id="4925253">t</span><span class="op" id="4925254">.</span><span class="ident" id="4925255">dial</span><span class="op" id="4925259">(</span><span class="string" id="4925260">&#34;tcp&#34;</span><span class="op" id="4925265">,</span>&nbsp;<span class="ident" id="4925267">cm</span><span class="op" id="4925269">.</span><span class="ident" id="4925270">addr</span><span class="op" id="4925274">(</span><span class="op" id="4925275">)</span><span class="op" id="4925276">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925280">if</span>&nbsp;<span class="ident" id="4925283">err</span>&nbsp;<span class="op" id="4925287">!=</span>&nbsp;<span class="ident" id="4925290">nil</span>&nbsp;<span class="op" id="4925294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925299">if</span>&nbsp;<span class="ident" id="4925302">cm</span><span class="op" id="4925304">.</span><span class="ident" id="4925305">proxyURL</span>&nbsp;<span class="op" id="4925314">!=</span>&nbsp;<span class="ident" id="4925317">nil</span>&nbsp;<span class="op" id="4925321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925327">err</span>&nbsp;<span class="op" id="4925331">=</span>&nbsp;<span class="ident" id="4925333">fmt</span><span class="op" id="4925336">.</span><span class="ident" id="4925337">Errorf</span><span class="op" id="4925343">(</span><span class="string" id="4925344">&#34;http:&nbsp;error&nbsp;connecting&nbsp;to&nbsp;proxy&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="4925384">,</span>&nbsp;<span class="ident" id="4925386">cm</span><span class="op" id="4925388">.</span><span class="ident" id="4925389">proxyURL</span><span class="op" id="4925397">,</span>&nbsp;<span class="ident" id="4925399">err</span><span class="op" id="4925402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925412">return</span>&nbsp;<span class="ident" id="4925419">nil</span><span class="op" id="4925422">,</span>&nbsp;<span class="ident" id="4925424">err</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925434">pconn</span><span class="op" id="4925439">.</span><span class="ident" id="4925440">conn</span>&nbsp;<span class="op" id="4925445">=</span>&nbsp;<span class="ident" id="4925447">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4925457">//&nbsp;Proxy&nbsp;setup.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925474">switch</span>&nbsp;<span class="op" id="4925481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925484">case</span>&nbsp;<span class="ident" id="4925489">cm</span><span class="op" id="4925491">.</span><span class="ident" id="4925492">proxyURL</span>&nbsp;<span class="op" id="4925501">==</span>&nbsp;<span class="ident" id="4925504">nil</span><span class="op" id="4925507">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4925511">//&nbsp;Do&nbsp;nothing.&nbsp;Not&nbsp;using&nbsp;a&nbsp;proxy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925546">case</span>&nbsp;<span class="ident" id="4925551">cm</span><span class="op" id="4925553">.</span><span class="ident" id="4925554">targetScheme</span>&nbsp;<span class="op" id="4925567">==</span>&nbsp;<span class="string" id="4925570">&#34;http&#34;</span><span class="op" id="4925576">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925580">pconn</span><span class="op" id="4925585">.</span><span class="ident" id="4925586">isProxy</span>&nbsp;<span class="op" id="4925594">=</span>&nbsp;<span class="builtintype" id="4925596">true</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925603">if</span>&nbsp;<span class="ident" id="4925606">pa</span>&nbsp;<span class="op" id="4925609">:=</span>&nbsp;<span class="ident" id="4925612">cm</span><span class="op" id="4925614">.</span><span class="ident" id="4925615">proxyAuth</span><span class="op" id="4925624">(</span><span class="op" id="4925625">)</span><span class="op" id="4925626">;</span>&nbsp;<span class="ident" id="4925628">pa</span>&nbsp;<span class="op" id="4925631">!=</span>&nbsp;<span class="string" id="4925634">&#34;&#34;</span>&nbsp;<span class="op" id="4925637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925642">pconn</span><span class="op" id="4925647">.</span><span class="ident" id="4925648">mutateHeaderFunc</span>&nbsp;<span class="op" id="4925665">=</span>&nbsp;<span class="keyword" id="4925667">func</span><span class="op" id="4925671">(</span><span class="ident" id="4925672">h</span>&nbsp;<span class="ident" id="4925674">Header</span><span class="op" id="4925680">)</span>&nbsp;<span class="op" id="4925682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925688">h</span><span class="op" id="4925689">.</span><span class="ident" id="4925690">Set</span><span class="op" id="4925693">(</span><span class="string" id="4925694">&#34;Proxy-Authorization&#34;</span><span class="op" id="4925715">,</span>&nbsp;<span class="ident" id="4925717">pa</span><span class="op" id="4925719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925728">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925731">case</span>&nbsp;<span class="ident" id="4925736">cm</span><span class="op" id="4925738">.</span><span class="ident" id="4925739">targetScheme</span>&nbsp;<span class="op" id="4925752">==</span>&nbsp;<span class="string" id="4925755">&#34;https&#34;</span><span class="op" id="4925762">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925766">conn</span>&nbsp;<span class="op" id="4925771">:=</span>&nbsp;<span class="ident" id="4925774">pconn</span><span class="op" id="4925779">.</span><span class="ident" id="4925780">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925787">connectReq</span>&nbsp;<span class="op" id="4925798">:=</span>&nbsp;<span class="op" id="4925801">&amp;</span><span class="ident" id="4925802">Request</span><span class="op" id="4925809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925814">Method</span><span class="op" id="4925820">:</span>&nbsp;<span class="string" id="4925822">&#34;CONNECT&#34;</span><span class="op" id="4925831">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925836">URL</span><span class="op" id="4925839">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4925844">&amp;</span><span class="ident" id="4925845">url</span><span class="op" id="4925848">.</span><span class="ident" id="4925849">URL</span><span class="op" id="4925852">{</span><span class="ident" id="4925853">Opaque</span><span class="op" id="4925859">:</span>&nbsp;<span class="ident" id="4925861">cm</span><span class="op" id="4925863">.</span><span class="ident" id="4925864">targetAddr</span><span class="op" id="4925874">}</span><span class="op" id="4925875">,</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925880">Host</span><span class="op" id="4925884">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4925888">cm</span><span class="op" id="4925890">.</span><span class="ident" id="4925891">targetAddr</span><span class="op" id="4925901">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925906">Header</span><span class="op" id="4925912">:</span>&nbsp;<span class="builtinfunc" id="4925914">make</span><span class="op" id="4925918">(</span><span class="ident" id="4925919">Header</span><span class="op" id="4925925">)</span><span class="op" id="4925926">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925934">if</span>&nbsp;<span class="ident" id="4925937">pa</span>&nbsp;<span class="op" id="4925940">:=</span>&nbsp;<span class="ident" id="4925943">cm</span><span class="op" id="4925945">.</span><span class="ident" id="4925946">proxyAuth</span><span class="op" id="4925955">(</span><span class="op" id="4925956">)</span><span class="op" id="4925957">;</span>&nbsp;<span class="ident" id="4925959">pa</span>&nbsp;<span class="op" id="4925962">!=</span>&nbsp;<span class="string" id="4925965">&#34;&#34;</span>&nbsp;<span class="op" id="4925968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925973">connectReq</span><span class="op" id="4925983">.</span><span class="ident" id="4925984">Header</span><span class="op" id="4925990">.</span><span class="ident" id="4925991">Set</span><span class="op" id="4925994">(</span><span class="string" id="4925995">&#34;Proxy-Authorization&#34;</span><span class="op" id="4926016">,</span>&nbsp;<span class="ident" id="4926018">pa</span><span class="op" id="4926020">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4926024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926028">connectReq</span><span class="op" id="4926038">.</span><span class="ident" id="4926039">Write</span><span class="op" id="4926044">(</span><span class="ident" id="4926045">conn</span><span class="op" id="4926049">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4926054">//&nbsp;Read&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4926074">//&nbsp;Okay&nbsp;to&nbsp;use&nbsp;and&nbsp;discard&nbsp;buffered&nbsp;reader&nbsp;here,&nbsp;because</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4926133">//&nbsp;TLS&nbsp;server&nbsp;will&nbsp;not&nbsp;speak&nbsp;until&nbsp;spoken&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926181">br</span>&nbsp;<span class="op" id="4926184">:=</span>&nbsp;<span class="ident" id="4926187">bufio</span><span class="op" id="4926192">.</span><span class="ident" id="4926193">NewReader</span><span class="op" id="4926202">(</span><span class="ident" id="4926203">conn</span><span class="op" id="4926207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926211">resp</span><span class="op" id="4926215">,</span>&nbsp;<span class="ident" id="4926217">err</span>&nbsp;<span class="op" id="4926221">:=</span>&nbsp;<span class="ident" id="4926224">ReadResponse</span><span class="op" id="4926236">(</span><span class="ident" id="4926237">br</span><span class="op" id="4926239">,</span>&nbsp;<span class="ident" id="4926241">connectReq</span><span class="op" id="4926251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926255">if</span>&nbsp;<span class="ident" id="4926258">err</span>&nbsp;<span class="op" id="4926262">!=</span>&nbsp;<span class="ident" id="4926265">nil</span>&nbsp;<span class="op" id="4926269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926274">conn</span><span class="op" id="4926278">.</span><span class="ident" id="4926279">Close</span><span class="op" id="4926284">(</span><span class="op" id="4926285">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926290">return</span>&nbsp;<span class="ident" id="4926297">nil</span><span class="op" id="4926300">,</span>&nbsp;<span class="ident" id="4926302">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4926308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926312">if</span>&nbsp;<span class="ident" id="4926315">resp</span><span class="op" id="4926319">.</span><span class="ident" id="4926320">StatusCode</span>&nbsp;<span class="op" id="4926331">!=</span>&nbsp;<span class="num" id="4926334">200</span>&nbsp;<span class="op" id="4926338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926343">f</span>&nbsp;<span class="op" id="4926345">:=</span>&nbsp;<span class="ident" id="4926348">strings</span><span class="op" id="4926355">.</span><span class="ident" id="4926356">SplitN</span><span class="op" id="4926362">(</span><span class="ident" id="4926363">resp</span><span class="op" id="4926367">.</span><span class="ident" id="4926368">Status</span><span class="op" id="4926374">,</span>&nbsp;<span class="string" id="4926376">&#34;&nbsp;&#34;</span><span class="op" id="4926379">,</span>&nbsp;<span class="num" id="4926381">2</span><span class="op" id="4926382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926387">conn</span><span class="op" id="4926391">.</span><span class="ident" id="4926392">Close</span><span class="op" id="4926397">(</span><span class="op" id="4926398">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926403">return</span>&nbsp;<span class="ident" id="4926410">nil</span><span class="op" id="4926413">,</span>&nbsp;<span class="ident" id="4926415">errors</span><span class="op" id="4926421">.</span><span class="ident" id="4926422">New</span><span class="op" id="4926425">(</span><span class="ident" id="4926426">f</span><span class="op" id="4926427">[</span><span class="num" id="4926428">1</span><span class="op" id="4926429">]</span><span class="op" id="4926430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4926434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4926437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926441">if</span>&nbsp;<span class="ident" id="4926444">cm</span><span class="op" id="4926446">.</span><span class="ident" id="4926447">targetScheme</span>&nbsp;<span class="op" id="4926460">==</span>&nbsp;<span class="string" id="4926463">&#34;https&#34;</span>&nbsp;<span class="op" id="4926471">&amp;&amp;</span>&nbsp;<span class="op" id="4926474">!</span><span class="ident" id="4926475">tlsDial</span>&nbsp;<span class="op" id="4926483">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4926487">//&nbsp;Initiate&nbsp;TLS&nbsp;and&nbsp;check&nbsp;remote&nbsp;host&nbsp;name&nbsp;against&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926553">cfg</span>&nbsp;<span class="op" id="4926557">:=</span>&nbsp;<span class="ident" id="4926560">t</span><span class="op" id="4926561">.</span><span class="ident" id="4926562">TLSClientConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926580">if</span>&nbsp;<span class="ident" id="4926583">cfg</span>&nbsp;<span class="op" id="4926587">==</span>&nbsp;<span class="ident" id="4926590">nil</span>&nbsp;<span class="op" id="4926594">||</span>&nbsp;<span class="ident" id="4926597">cfg</span><span class="op" id="4926600">.</span><span class="ident" id="4926601">ServerName</span>&nbsp;<span class="op" id="4926612">==</span>&nbsp;<span class="string" id="4926615">&#34;&#34;</span>&nbsp;<span class="op" id="4926618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926623">host</span>&nbsp;<span class="op" id="4926628">:=</span>&nbsp;<span class="ident" id="4926631">cm</span><span class="op" id="4926633">.</span><span class="ident" id="4926634">tlsHost</span><span class="op" id="4926641">(</span><span class="op" id="4926642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926647">if</span>&nbsp;<span class="ident" id="4926650">cfg</span>&nbsp;<span class="op" id="4926654">==</span>&nbsp;<span class="ident" id="4926657">nil</span>&nbsp;<span class="op" id="4926661">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926667">cfg</span>&nbsp;<span class="op" id="4926671">=</span>&nbsp;<span class="op" id="4926673">&amp;</span><span class="ident" id="4926674">tls</span><span class="op" id="4926677">.</span><span class="ident" id="4926678">Config</span><span class="op" id="4926684">{</span><span class="ident" id="4926685">ServerName</span><span class="op" id="4926695">:</span>&nbsp;<span class="ident" id="4926697">host</span><span class="op" id="4926701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4926706">}</span>&nbsp;<span class="keyword" id="4926708">else</span>&nbsp;<span class="op" id="4926713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926719">clone</span>&nbsp;<span class="op" id="4926725">:=</span>&nbsp;<span class="op" id="4926728">*</span><span class="ident" id="4926729">cfg</span>&nbsp;<span class="comment" id="4926733">//&nbsp;shallow&nbsp;clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926754">clone</span><span class="op" id="4926759">.</span><span class="ident" id="4926760">ServerName</span>&nbsp;<span class="op" id="4926771">=</span>&nbsp;<span class="ident" id="4926773">host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926782">cfg</span>&nbsp;<span class="op" id="4926786">=</span>&nbsp;<span class="op" id="4926788">&amp;</span><span class="ident" id="4926789">clone</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4926798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4926802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926806">plainConn</span>&nbsp;<span class="op" id="4926816">:=</span>&nbsp;<span class="ident" id="4926819">pconn</span><span class="op" id="4926824">.</span><span class="ident" id="4926825">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926832">tlsConn</span>&nbsp;<span class="op" id="4926840">:=</span>&nbsp;<span class="ident" id="4926843">tls</span><span class="op" id="4926846">.</span><span class="ident" id="4926847">Client</span><span class="op" id="4926853">(</span><span class="ident" id="4926854">plainConn</span><span class="op" id="4926863">,</span>&nbsp;<span class="ident" id="4926865">cfg</span><span class="op" id="4926868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926872">errc</span>&nbsp;<span class="op" id="4926877">:=</span>&nbsp;<span class="builtinfunc" id="4926880">make</span><span class="op" id="4926884">(</span><span class="keyword" id="4926885">chan</span>&nbsp;<span class="builtintype" id="4926890">error</span><span class="op" id="4926895">,</span>&nbsp;<span class="num" id="4926897">2</span><span class="op" id="4926898">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926902">var</span>&nbsp;<span class="ident" id="4926906">timer</span>&nbsp;<span class="op" id="4926912">*</span><span class="ident" id="4926913">time</span><span class="op" id="4926917">.</span><span class="ident" id="4926918">Timer</span>&nbsp;<span class="comment" id="4926924">//&nbsp;for&nbsp;canceling&nbsp;TLS&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926957">if</span>&nbsp;<span class="ident" id="4926960">d</span>&nbsp;<span class="op" id="4926962">:=</span>&nbsp;<span class="ident" id="4926965">t</span><span class="op" id="4926966">.</span><span class="ident" id="4926967">TLSHandshakeTimeout</span><span class="op" id="4926986">;</span>&nbsp;<span class="ident" id="4926988">d</span>&nbsp;<span class="op" id="4926990">!=</span>&nbsp;<span class="num" id="4926993">0</span>&nbsp;<span class="op" id="4926995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927000">timer</span>&nbsp;<span class="op" id="4927006">=</span>&nbsp;<span class="ident" id="4927008">time</span><span class="op" id="4927012">.</span><span class="ident" id="4927013">AfterFunc</span><span class="op" id="4927022">(</span><span class="ident" id="4927023">d</span><span class="op" id="4927024">,</span>&nbsp;<span class="keyword" id="4927026">func</span><span class="op" id="4927030">(</span><span class="op" id="4927031">)</span>&nbsp;<span class="op" id="4927033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927039">errc</span>&nbsp;<span class="op" id="4927044">&lt;-</span>&nbsp;<span class="ident" id="4927047">tlsHandshakeTimeoutError</span><span class="op" id="4927071">{</span><span class="op" id="4927072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927077">}</span><span class="op" id="4927078">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927086">go</span>&nbsp;<span class="keyword" id="4927089">func</span><span class="op" id="4927093">(</span><span class="op" id="4927094">)</span>&nbsp;<span class="op" id="4927096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927101">err</span>&nbsp;<span class="op" id="4927105">:=</span>&nbsp;<span class="ident" id="4927108">tlsConn</span><span class="op" id="4927115">.</span><span class="ident" id="4927116">Handshake</span><span class="op" id="4927125">(</span><span class="op" id="4927126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927131">if</span>&nbsp;<span class="ident" id="4927134">timer</span>&nbsp;<span class="op" id="4927140">!=</span>&nbsp;<span class="ident" id="4927143">nil</span>&nbsp;<span class="op" id="4927147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927153">timer</span><span class="op" id="4927158">.</span><span class="ident" id="4927159">Stop</span><span class="op" id="4927163">(</span><span class="op" id="4927164">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927174">errc</span>&nbsp;<span class="op" id="4927179">&lt;-</span>&nbsp;<span class="ident" id="4927182">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927188">}</span><span class="op" id="4927189">(</span><span class="op" id="4927190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927194">if</span>&nbsp;<span class="ident" id="4927197">err</span>&nbsp;<span class="op" id="4927201">:=</span>&nbsp;<span class="op" id="4927204">&lt;-</span><span class="ident" id="4927206">errc</span><span class="op" id="4927210">;</span>&nbsp;<span class="ident" id="4927212">err</span>&nbsp;<span class="op" id="4927216">!=</span>&nbsp;<span class="ident" id="4927219">nil</span>&nbsp;<span class="op" id="4927223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927228">plainConn</span><span class="op" id="4927237">.</span><span class="ident" id="4927238">Close</span><span class="op" id="4927243">(</span><span class="op" id="4927244">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927249">return</span>&nbsp;<span class="ident" id="4927256">nil</span><span class="op" id="4927259">,</span>&nbsp;<span class="ident" id="4927261">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927271">if</span>&nbsp;<span class="op" id="4927274">!</span><span class="ident" id="4927275">cfg</span><span class="op" id="4927278">.</span><span class="ident" id="4927279">InsecureSkipVerify</span>&nbsp;<span class="op" id="4927298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927303">if</span>&nbsp;<span class="ident" id="4927306">err</span>&nbsp;<span class="op" id="4927310">:=</span>&nbsp;<span class="ident" id="4927313">tlsConn</span><span class="op" id="4927320">.</span><span class="ident" id="4927321">VerifyHostname</span><span class="op" id="4927335">(</span><span class="ident" id="4927336">cfg</span><span class="op" id="4927339">.</span><span class="ident" id="4927340">ServerName</span><span class="op" id="4927350">)</span><span class="op" id="4927351">;</span>&nbsp;<span class="ident" id="4927353">err</span>&nbsp;<span class="op" id="4927357">!=</span>&nbsp;<span class="ident" id="4927360">nil</span>&nbsp;<span class="op" id="4927364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927370">plainConn</span><span class="op" id="4927379">.</span><span class="ident" id="4927380">Close</span><span class="op" id="4927385">(</span><span class="op" id="4927386">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927392">return</span>&nbsp;<span class="ident" id="4927399">nil</span><span class="op" id="4927402">,</span>&nbsp;<span class="ident" id="4927404">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927419">cs</span>&nbsp;<span class="op" id="4927422">:=</span>&nbsp;<span class="ident" id="4927425">tlsConn</span><span class="op" id="4927432">.</span><span class="ident" id="4927433">ConnectionState</span><span class="op" id="4927448">(</span><span class="op" id="4927449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927453">pconn</span><span class="op" id="4927458">.</span><span class="ident" id="4927459">tlsState</span>&nbsp;<span class="op" id="4927468">=</span>&nbsp;<span class="op" id="4927470">&amp;</span><span class="ident" id="4927471">cs</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927476">pconn</span><span class="op" id="4927481">.</span><span class="ident" id="4927482">conn</span>&nbsp;<span class="op" id="4927487">=</span>&nbsp;<span class="ident" id="4927489">tlsConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927502">pconn</span><span class="op" id="4927507">.</span><span class="ident" id="4927508">br</span>&nbsp;<span class="op" id="4927511">=</span>&nbsp;<span class="ident" id="4927513">bufio</span><span class="op" id="4927518">.</span><span class="ident" id="4927519">NewReader</span><span class="op" id="4927528">(</span><span class="ident" id="4927529">noteEOFReader</span><span class="op" id="4927542">{</span><span class="ident" id="4927543">pconn</span><span class="op" id="4927548">.</span><span class="ident" id="4927549">conn</span><span class="op" id="4927553">,</span>&nbsp;<span class="op" id="4927555">&amp;</span><span class="ident" id="4927556">pconn</span><span class="op" id="4927561">.</span><span class="ident" id="4927562">sawEOF</span><span class="op" id="4927568">}</span><span class="op" id="4927569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927572">pconn</span><span class="op" id="4927577">.</span><span class="ident" id="4927578">bw</span>&nbsp;<span class="op" id="4927581">=</span>&nbsp;<span class="ident" id="4927583">bufio</span><span class="op" id="4927588">.</span><span class="ident" id="4927589">NewWriter</span><span class="op" id="4927598">(</span><span class="ident" id="4927599">pconn</span><span class="op" id="4927604">.</span><span class="ident" id="4927605">conn</span><span class="op" id="4927609">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927612">go</span>&nbsp;<span class="ident" id="4927615">pconn</span><span class="op" id="4927620">.</span><span class="ident" id="4927621">readLoop</span><span class="op" id="4927629">(</span><span class="op" id="4927630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927633">go</span>&nbsp;<span class="ident" id="4927636">pconn</span><span class="op" id="4927641">.</span><span class="ident" id="4927642">writeLoop</span><span class="op" id="4927651">(</span><span class="op" id="4927652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927655">return</span>&nbsp;<span class="ident" id="4927662">pconn</span><span class="op" id="4927667">,</span>&nbsp;<span class="ident" id="4927669">nil</span><br>
<span class="lineno"></span><span class="op" id="4927673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="4927676">//&nbsp;useProxy&nbsp;returns&nbsp;true&nbsp;if&nbsp;requests&nbsp;to&nbsp;addr&nbsp;should&nbsp;use&nbsp;a&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="4927741">//&nbsp;according&nbsp;to&nbsp;the&nbsp;NO_PROXY&nbsp;or&nbsp;no_proxy&nbsp;environment&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="4927804">//&nbsp;addr&nbsp;is&nbsp;always&nbsp;a&nbsp;canonicalAddr&nbsp;with&nbsp;a&nbsp;host&nbsp;and&nbsp;port.</span><br>
<span class="lineno"></span><span class="keyword" id="4927860">func</span>&nbsp;<span class="ident" id="4927865">useProxy</span><span class="op" id="4927873">(</span><span class="ident" id="4927874">addr</span>&nbsp;<span class="builtintype" id="4927879">string</span><span class="op" id="4927885">)</span>&nbsp;<span class="builtintype" id="4927887">bool</span>&nbsp;<span class="op" id="4927892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927895">if</span>&nbsp;<span class="builtinfunc" id="4927898">len</span><span class="op" id="4927901">(</span><span class="ident" id="4927902">addr</span><span class="op" id="4927906">)</span>&nbsp;<span class="op" id="4927908">==</span>&nbsp;<span class="num" id="4927911">0</span>&nbsp;<span class="op" id="4927913">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927917">return</span>&nbsp;<span class="builtintype" id="4927924">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927933">host</span><span class="op" id="4927937">,</span>&nbsp;<span class="ident" id="4927939">_</span><span class="op" id="4927940">,</span>&nbsp;<span class="ident" id="4927942">err</span>&nbsp;<span class="op" id="4927946">:=</span>&nbsp;<span class="ident" id="4927949">net</span><span class="op" id="4927952">.</span><span class="ident" id="4927953">SplitHostPort</span><span class="op" id="4927966">(</span><span class="ident" id="4927967">addr</span><span class="op" id="4927971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927974">if</span>&nbsp;<span class="ident" id="4927977">err</span>&nbsp;<span class="op" id="4927981">!=</span>&nbsp;<span class="ident" id="4927984">nil</span>&nbsp;<span class="op" id="4927988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927992">return</span>&nbsp;<span class="builtintype" id="4927999">false</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928009">if</span>&nbsp;<span class="ident" id="4928012">host</span>&nbsp;<span class="op" id="4928017">==</span>&nbsp;<span class="string" id="4928020">&#34;localhost&#34;</span>&nbsp;<span class="op" id="4928032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928036">return</span>&nbsp;<span class="builtintype" id="4928043">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928053">if</span>&nbsp;<span class="ident" id="4928056">ip</span>&nbsp;<span class="op" id="4928059">:=</span>&nbsp;<span class="ident" id="4928062">net</span><span class="op" id="4928065">.</span><span class="ident" id="4928066">ParseIP</span><span class="op" id="4928073">(</span><span class="ident" id="4928074">host</span><span class="op" id="4928078">)</span><span class="op" id="4928079">;</span>&nbsp;<span class="ident" id="4928081">ip</span>&nbsp;<span class="op" id="4928084">!=</span>&nbsp;<span class="ident" id="4928087">nil</span>&nbsp;<span class="op" id="4928091">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928095">if</span>&nbsp;<span class="ident" id="4928098">ip</span><span class="op" id="4928100">.</span><span class="ident" id="4928101">IsLoopback</span><span class="op" id="4928111">(</span><span class="op" id="4928112">)</span>&nbsp;<span class="op" id="4928114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928119">return</span>&nbsp;<span class="builtintype" id="4928126">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4928141">no_proxy</span>&nbsp;<span class="op" id="4928150">:=</span>&nbsp;<span class="ident" id="4928153">noProxyEnv</span><span class="op" id="4928163">.</span><span class="ident" id="4928164">Get</span><span class="op" id="4928167">(</span><span class="op" id="4928168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928171">if</span>&nbsp;<span class="ident" id="4928174">no_proxy</span>&nbsp;<span class="op" id="4928183">==</span>&nbsp;<span class="string" id="4928186">&#34;*&#34;</span>&nbsp;<span class="op" id="4928190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928194">return</span>&nbsp;<span class="builtintype" id="4928201">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4928212">addr</span>&nbsp;<span class="op" id="4928217">=</span>&nbsp;<span class="ident" id="4928219">strings</span><span class="op" id="4928226">.</span><span class="ident" id="4928227">ToLower</span><span class="op" id="4928234">(</span><span class="ident" id="4928235">strings</span><span class="op" id="4928242">.</span><span class="ident" id="4928243">TrimSpace</span><span class="op" id="4928252">(</span><span class="ident" id="4928253">addr</span><span class="op" id="4928257">)</span><span class="op" id="4928258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928261">if</span>&nbsp;<span class="ident" id="4928264">hasPort</span><span class="op" id="4928271">(</span><span class="ident" id="4928272">addr</span><span class="op" id="4928276">)</span>&nbsp;<span class="op" id="4928278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4928282">addr</span>&nbsp;<span class="op" id="4928287">=</span>&nbsp;<span class="ident" id="4928289">addr</span><span class="op" id="4928293">[</span><span class="op" id="4928294">:</span><span class="ident" id="4928295">strings</span><span class="op" id="4928302">.</span><span class="ident" id="4928303">LastIndex</span><span class="op" id="4928312">(</span><span class="ident" id="4928313">addr</span><span class="op" id="4928317">,</span>&nbsp;<span class="string" id="4928319">&#34;:&#34;</span><span class="op" id="4928322">)</span><span class="op" id="4928323">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928330">for</span>&nbsp;<span class="ident" id="4928334">_</span><span class="op" id="4928335">,</span>&nbsp;<span class="ident" id="4928337">p</span>&nbsp;<span class="op" id="4928339">:=</span>&nbsp;<span class="keyword" id="4928342">range</span>&nbsp;<span class="ident" id="4928348">strings</span><span class="op" id="4928355">.</span><span class="ident" id="4928356">Split</span><span class="op" id="4928361">(</span><span class="ident" id="4928362">no_proxy</span><span class="op" id="4928370">,</span>&nbsp;<span class="string" id="4928372">&#34;,&#34;</span><span class="op" id="4928375">)</span>&nbsp;<span class="op" id="4928377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4928381">p</span>&nbsp;<span class="op" id="4928383">=</span>&nbsp;<span class="ident" id="4928385">strings</span><span class="op" id="4928392">.</span><span class="ident" id="4928393">ToLower</span><span class="op" id="4928400">(</span><span class="ident" id="4928401">strings</span><span class="op" id="4928408">.</span><span class="ident" id="4928409">TrimSpace</span><span class="op" id="4928418">(</span><span class="ident" id="4928419">p</span><span class="op" id="4928420">)</span><span class="op" id="4928421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928425">if</span>&nbsp;<span class="builtinfunc" id="4928428">len</span><span class="op" id="4928431">(</span><span class="ident" id="4928432">p</span><span class="op" id="4928433">)</span>&nbsp;<span class="op" id="4928435">==</span>&nbsp;<span class="num" id="4928438">0</span>&nbsp;<span class="op" id="4928440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928445">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928456">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928460">if</span>&nbsp;<span class="ident" id="4928463">hasPort</span><span class="op" id="4928470">(</span><span class="ident" id="4928471">p</span><span class="op" id="4928472">)</span>&nbsp;<span class="op" id="4928474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4928479">p</span>&nbsp;<span class="op" id="4928481">=</span>&nbsp;<span class="ident" id="4928483">p</span><span class="op" id="4928484">[</span><span class="op" id="4928485">:</span><span class="ident" id="4928486">strings</span><span class="op" id="4928493">.</span><span class="ident" id="4928494">LastIndex</span><span class="op" id="4928503">(</span><span class="ident" id="4928504">p</span><span class="op" id="4928505">,</span>&nbsp;<span class="string" id="4928507">&#34;:&#34;</span><span class="op" id="4928510">)</span><span class="op" id="4928511">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928519">if</span>&nbsp;<span class="ident" id="4928522">addr</span>&nbsp;<span class="op" id="4928527">==</span>&nbsp;<span class="ident" id="4928530">p</span>&nbsp;<span class="op" id="4928532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928537">return</span>&nbsp;<span class="builtintype" id="4928544">false</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928556">if</span>&nbsp;<span class="ident" id="4928559">p</span><span class="op" id="4928560">[</span><span class="num" id="4928561">0</span><span class="op" id="4928562">]</span>&nbsp;<span class="op" id="4928564">==</span>&nbsp;<span class="string" id="4928567">&#39;.&#39;</span>&nbsp;<span class="op" id="4928571">&amp;&amp;</span>&nbsp;<span class="op" id="4928574">(</span><span class="ident" id="4928575">strings</span><span class="op" id="4928582">.</span><span class="ident" id="4928583">HasSuffix</span><span class="op" id="4928592">(</span><span class="ident" id="4928593">addr</span><span class="op" id="4928597">,</span>&nbsp;<span class="ident" id="4928599">p</span><span class="op" id="4928600">)</span>&nbsp;<span class="op" id="4928602">||</span>&nbsp;<span class="ident" id="4928605">addr</span>&nbsp;<span class="op" id="4928610">==</span>&nbsp;<span class="ident" id="4928613">p</span><span class="op" id="4928614">[</span><span class="num" id="4928615">1</span><span class="op" id="4928616">:</span><span class="op" id="4928617">]</span><span class="op" id="4928618">)</span>&nbsp;<span class="op" id="4928620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4928625">//&nbsp;no_proxy&nbsp;&#34;.foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;&nbsp;or&nbsp;&#34;foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928686">return</span>&nbsp;<span class="builtintype" id="4928693">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928701">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928705">if</span>&nbsp;<span class="ident" id="4928708">p</span><span class="op" id="4928709">[</span><span class="num" id="4928710">0</span><span class="op" id="4928711">]</span>&nbsp;<span class="op" id="4928713">!=</span>&nbsp;<span class="string" id="4928716">&#39;.&#39;</span>&nbsp;<span class="op" id="4928720">&amp;&amp;</span>&nbsp;<span class="ident" id="4928723">strings</span><span class="op" id="4928730">.</span><span class="ident" id="4928731">HasSuffix</span><span class="op" id="4928740">(</span><span class="ident" id="4928741">addr</span><span class="op" id="4928745">,</span>&nbsp;<span class="ident" id="4928747">p</span><span class="op" id="4928748">)</span>&nbsp;<span class="op" id="4928750">&amp;&amp;</span>&nbsp;<span class="ident" id="4928753">addr</span><span class="op" id="4928757">[</span><span class="builtinfunc" id="4928758">len</span><span class="op" id="4928761">(</span><span class="ident" id="4928762">addr</span><span class="op" id="4928766">)</span><span class="op" id="4928767">-</span><span class="builtinfunc" id="4928768">len</span><span class="op" id="4928771">(</span><span class="ident" id="4928772">p</span><span class="op" id="4928773">)</span><span class="op" id="4928774">-</span><span class="num" id="4928775">1</span><span class="op" id="4928776">]</span>&nbsp;<span class="op" id="4928778">==</span>&nbsp;<span class="string" id="4928781">&#39;.&#39;</span>&nbsp;<span class="op" id="4928785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4928790">//&nbsp;no_proxy&nbsp;&#34;foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928837">return</span>&nbsp;<span class="builtintype" id="4928844">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928855">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928858">return</span>&nbsp;<span class="builtintype" id="4928865">true</span><br>
<span class="lineno"></span><span class="op" id="4928870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4928873">//&nbsp;connectMethod&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;(in&nbsp;its&nbsp;String&nbsp;form)&nbsp;for&nbsp;keeping&nbsp;persistent</span><br>
<span class="lineno"></span><span class="comment" id="4928949">//&nbsp;TCP&nbsp;connections&nbsp;alive&nbsp;for&nbsp;subsequent&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno">720</span><span class="comment" id="4929004">//</span><br>
<span class="lineno"></span><span class="comment" id="4929007">//&nbsp;A&nbsp;connect&nbsp;method&nbsp;may&nbsp;be&nbsp;of&nbsp;the&nbsp;following&nbsp;types:</span><br>
<span class="lineno"></span><span class="comment" id="4929058">//</span><br>
<span class="lineno"></span><span class="comment" id="4929061">//&nbsp;Cache&nbsp;key&nbsp;form&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description</span><br>
<span class="lineno"></span><span class="comment" id="4929106">//&nbsp;-----------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-------------------------</span><br>
<span class="lineno">725</span><span class="comment" id="4929165">//&nbsp;|http|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="4929232">//&nbsp;|https|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="4929300">//&nbsp;http://proxy.com|https|foo.com&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;then&nbsp;CONNECT&nbsp;to&nbsp;foo.com</span><br>
<span class="lineno"></span><span class="comment" id="4929374">//&nbsp;http://proxy.com|http&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;http&nbsp;to&nbsp;anywhere&nbsp;after&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4929452">//</span><br>
<span class="lineno">730</span><span class="comment" id="4929455">//&nbsp;Note:&nbsp;no&nbsp;support&nbsp;to&nbsp;https&nbsp;to&nbsp;the&nbsp;proxy&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="4929502">//</span><br>
<span class="lineno"></span><span class="keyword" id="4929505">type</span>&nbsp;<span class="ident" id="4929510">connectMethod</span>&nbsp;<span class="keyword" id="4929524">struct</span>&nbsp;<span class="op" id="4929531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929534">proxyURL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4929547">*</span><span class="ident" id="4929548">url</span><span class="op" id="4929551">.</span><span class="ident" id="4929552">URL</span>&nbsp;<span class="comment" id="4929556">//&nbsp;nil&nbsp;for&nbsp;no&nbsp;proxy,&nbsp;else&nbsp;full&nbsp;proxy&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929598">targetScheme</span>&nbsp;<span class="builtintype" id="4929611">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4929620">//&nbsp;&#34;http&#34;&nbsp;or&nbsp;&#34;https&#34;</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929642">targetAddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4929655">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4929664">//&nbsp;Not&nbsp;used&nbsp;if&nbsp;proxy&nbsp;+&nbsp;http&nbsp;targetScheme&nbsp;(4th&nbsp;example&nbsp;in&nbsp;table)</span><br>
<span class="lineno"></span><span class="op" id="4929728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4929731">func</span>&nbsp;<span class="op" id="4929736">(</span><span class="ident" id="4929737">cm</span>&nbsp;<span class="op" id="4929740">*</span><span class="ident" id="4929741">connectMethod</span><span class="op" id="4929754">)</span>&nbsp;<span class="ident" id="4929756">key</span><span class="op" id="4929759">(</span><span class="op" id="4929760">)</span>&nbsp;<span class="ident" id="4929762">connectMethodKey</span>&nbsp;<span class="op" id="4929779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929782">proxyStr</span>&nbsp;<span class="op" id="4929791">:=</span>&nbsp;<span class="string" id="4929794">&#34;&#34;</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929798">targetAddr</span>&nbsp;<span class="op" id="4929809">:=</span>&nbsp;<span class="ident" id="4929812">cm</span><span class="op" id="4929814">.</span><span class="ident" id="4929815">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4929827">if</span>&nbsp;<span class="ident" id="4929830">cm</span><span class="op" id="4929832">.</span><span class="ident" id="4929833">proxyURL</span>&nbsp;<span class="op" id="4929842">!=</span>&nbsp;<span class="ident" id="4929845">nil</span>&nbsp;<span class="op" id="4929849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929853">proxyStr</span>&nbsp;<span class="op" id="4929862">=</span>&nbsp;<span class="ident" id="4929864">cm</span><span class="op" id="4929866">.</span><span class="ident" id="4929867">proxyURL</span><span class="op" id="4929875">.</span><span class="ident" id="4929876">String</span><span class="op" id="4929882">(</span><span class="op" id="4929883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4929887">if</span>&nbsp;<span class="ident" id="4929890">cm</span><span class="op" id="4929892">.</span><span class="ident" id="4929893">targetScheme</span>&nbsp;<span class="op" id="4929906">==</span>&nbsp;<span class="string" id="4929909">&#34;http&#34;</span>&nbsp;<span class="op" id="4929916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929921">targetAddr</span>&nbsp;<span class="op" id="4929932">=</span>&nbsp;<span class="string" id="4929934">&#34;&#34;</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4929939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4929942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4929945">return</span>&nbsp;<span class="ident" id="4929952">connectMethodKey</span><span class="op" id="4929968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929972">proxy</span><span class="op" id="4929977">:</span>&nbsp;&nbsp;<span class="ident" id="4929980">proxyStr</span><span class="op" id="4929988">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929992">scheme</span><span class="op" id="4929998">:</span>&nbsp;<span class="ident" id="4930000">cm</span><span class="op" id="4930002">.</span><span class="ident" id="4930003">targetScheme</span><span class="op" id="4930015">,</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930019">addr</span><span class="op" id="4930023">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4930027">targetAddr</span><span class="op" id="4930037">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4930040">}</span><br>
<span class="lineno"></span><span class="op" id="4930042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4930045">//&nbsp;addr&nbsp;returns&nbsp;the&nbsp;first&nbsp;hop&nbsp;&#34;host:port&#34;&nbsp;to&nbsp;which&nbsp;we&nbsp;need&nbsp;to&nbsp;TCP&nbsp;connect.</span><br>
<span class="lineno">755</span><span class="keyword" id="4930120">func</span>&nbsp;<span class="op" id="4930125">(</span><span class="ident" id="4930126">cm</span>&nbsp;<span class="op" id="4930129">*</span><span class="ident" id="4930130">connectMethod</span><span class="op" id="4930143">)</span>&nbsp;<span class="ident" id="4930145">addr</span><span class="op" id="4930149">(</span><span class="op" id="4930150">)</span>&nbsp;<span class="builtintype" id="4930152">string</span>&nbsp;<span class="op" id="4930159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930162">if</span>&nbsp;<span class="ident" id="4930165">cm</span><span class="op" id="4930167">.</span><span class="ident" id="4930168">proxyURL</span>&nbsp;<span class="op" id="4930177">!=</span>&nbsp;<span class="ident" id="4930180">nil</span>&nbsp;<span class="op" id="4930184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930188">return</span>&nbsp;<span class="ident" id="4930195">canonicalAddr</span><span class="op" id="4930208">(</span><span class="ident" id="4930209">cm</span><span class="op" id="4930211">.</span><span class="ident" id="4930212">proxyURL</span><span class="op" id="4930220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4930223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930226">return</span>&nbsp;<span class="ident" id="4930233">cm</span><span class="op" id="4930235">.</span><span class="ident" id="4930236">targetAddr</span><br>
<span class="lineno">760</span><span class="op" id="4930247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4930250">//&nbsp;tlsHost&nbsp;returns&nbsp;the&nbsp;host&nbsp;name&nbsp;to&nbsp;match&nbsp;against&nbsp;the&nbsp;peer&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4930311">//&nbsp;TLS&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4930331">func</span>&nbsp;<span class="op" id="4930336">(</span><span class="ident" id="4930337">cm</span>&nbsp;<span class="op" id="4930340">*</span><span class="ident" id="4930341">connectMethod</span><span class="op" id="4930354">)</span>&nbsp;<span class="ident" id="4930356">tlsHost</span><span class="op" id="4930363">(</span><span class="op" id="4930364">)</span>&nbsp;<span class="builtintype" id="4930366">string</span>&nbsp;<span class="op" id="4930373">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930376">h</span>&nbsp;<span class="op" id="4930378">:=</span>&nbsp;<span class="ident" id="4930381">cm</span><span class="op" id="4930383">.</span><span class="ident" id="4930384">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930396">if</span>&nbsp;<span class="ident" id="4930399">hasPort</span><span class="op" id="4930406">(</span><span class="ident" id="4930407">h</span><span class="op" id="4930408">)</span>&nbsp;<span class="op" id="4930410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930414">h</span>&nbsp;<span class="op" id="4930416">=</span>&nbsp;<span class="ident" id="4930418">h</span><span class="op" id="4930419">[</span><span class="op" id="4930420">:</span><span class="ident" id="4930421">strings</span><span class="op" id="4930428">.</span><span class="ident" id="4930429">LastIndex</span><span class="op" id="4930438">(</span><span class="ident" id="4930439">h</span><span class="op" id="4930440">,</span>&nbsp;<span class="string" id="4930442">&#34;:&#34;</span><span class="op" id="4930445">)</span><span class="op" id="4930446">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4930449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930452">return</span>&nbsp;<span class="ident" id="4930459">h</span><br>
<span class="lineno">770</span><span class="op" id="4930461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4930464">//&nbsp;connectMethodKey&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;version&nbsp;of&nbsp;connectMethod,&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4930532">//&nbsp;stringified&nbsp;proxy&nbsp;URL&nbsp;(or&nbsp;the&nbsp;empty&nbsp;string)&nbsp;instead&nbsp;of&nbsp;a&nbsp;pointer&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4930603">//&nbsp;a&nbsp;URL.</span><br>
<span class="lineno">775</span><span class="keyword" id="4930613">type</span>&nbsp;<span class="ident" id="4930618">connectMethodKey</span>&nbsp;<span class="keyword" id="4930635">struct</span>&nbsp;<span class="op" id="4930642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930645">proxy</span><span class="op" id="4930650">,</span>&nbsp;<span class="ident" id="4930652">scheme</span><span class="op" id="4930658">,</span>&nbsp;<span class="ident" id="4930660">addr</span>&nbsp;<span class="builtintype" id="4930665">string</span><br>
<span class="lineno"></span><span class="op" id="4930672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4930675">func</span>&nbsp;<span class="op" id="4930680">(</span><span class="ident" id="4930681">k</span>&nbsp;<span class="ident" id="4930683">connectMethodKey</span><span class="op" id="4930699">)</span>&nbsp;<span class="ident" id="4930701">String</span><span class="op" id="4930707">(</span><span class="op" id="4930708">)</span>&nbsp;<span class="builtintype" id="4930710">string</span>&nbsp;<span class="op" id="4930717">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4930720">//&nbsp;Only&nbsp;used&nbsp;by&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930744">return</span>&nbsp;<span class="ident" id="4930751">fmt</span><span class="op" id="4930754">.</span><span class="ident" id="4930755">Sprintf</span><span class="op" id="4930762">(</span><span class="string" id="4930763">&#34;%s|%s|%s&#34;</span><span class="op" id="4930773">,</span>&nbsp;<span class="ident" id="4930775">k</span><span class="op" id="4930776">.</span><span class="ident" id="4930777">proxy</span><span class="op" id="4930782">,</span>&nbsp;<span class="ident" id="4930784">k</span><span class="op" id="4930785">.</span><span class="ident" id="4930786">scheme</span><span class="op" id="4930792">,</span>&nbsp;<span class="ident" id="4930794">k</span><span class="op" id="4930795">.</span><span class="ident" id="4930796">addr</span><span class="op" id="4930800">)</span><br>
<span class="lineno"></span><span class="op" id="4930802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4930805">//&nbsp;persistConn&nbsp;wraps&nbsp;a&nbsp;connection,&nbsp;usually&nbsp;a&nbsp;persistent&nbsp;one</span><br>
<span class="lineno">785</span><span class="comment" id="4930865">//&nbsp;(but&nbsp;may&nbsp;be&nbsp;used&nbsp;for&nbsp;non-keep-alive&nbsp;requests&nbsp;as&nbsp;well)</span><br>
<span class="lineno"></span><span class="keyword" id="4930922">type</span>&nbsp;<span class="ident" id="4930927">persistConn</span>&nbsp;<span class="keyword" id="4930939">struct</span>&nbsp;<span class="op" id="4930946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930949">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4930958">*</span><span class="ident" id="4930959">Transport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930970">cacheKey</span>&nbsp;<span class="ident" id="4930979">connectMethodKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930997">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4931006">net</span><span class="op" id="4931009">.</span><span class="ident" id="4931010">Conn</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931016">tlsState</span>&nbsp;<span class="op" id="4931025">*</span><span class="ident" id="4931026">tls</span><span class="op" id="4931029">.</span><span class="ident" id="4931030">ConnectionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931047">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4931056">*</span><span class="ident" id="4931057">bufio</span><span class="op" id="4931062">.</span><span class="ident" id="4931063">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4931076">//&nbsp;from&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931090">sawEOF</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4931099">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4931119">//&nbsp;whether&nbsp;we&#39;ve&nbsp;seen&nbsp;EOF&nbsp;from&nbsp;conn;&nbsp;owned&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931175">bw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4931184">*</span><span class="ident" id="4931185">bufio</span><span class="op" id="4931190">.</span><span class="ident" id="4931191">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4931204">//&nbsp;to&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931216">reqch</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4931225">chan</span>&nbsp;<span class="ident" id="4931230">requestAndChan</span>&nbsp;<span class="comment" id="4931245">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931288">writech</span>&nbsp;&nbsp;<span class="keyword" id="4931297">chan</span>&nbsp;<span class="ident" id="4931302">writeRequest</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4931317">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;writeLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931361">closech</span>&nbsp;&nbsp;<span class="keyword" id="4931370">chan</span>&nbsp;<span class="keyword" id="4931375">struct</span><span class="op" id="4931381">{</span><span class="op" id="4931382">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4931390">//&nbsp;closed&nbsp;when&nbsp;conn&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931418">isProxy</span>&nbsp;&nbsp;<span class="builtintype" id="4931427">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4931433">//&nbsp;writeErrCh&nbsp;passes&nbsp;the&nbsp;request&nbsp;write&nbsp;error&nbsp;(usually&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4931493">//&nbsp;from&nbsp;the&nbsp;writeLoop&nbsp;goroutine&nbsp;to&nbsp;the&nbsp;readLoop&nbsp;which&nbsp;passes</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4931555">//&nbsp;it&nbsp;off&nbsp;to&nbsp;the&nbsp;res.Body&nbsp;reader,&nbsp;which&nbsp;then&nbsp;uses&nbsp;it&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4931619">//&nbsp;whether&nbsp;or&nbsp;not&nbsp;a&nbsp;connection&nbsp;can&nbsp;be&nbsp;reused.&nbsp;Issue&nbsp;7569.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931678">writeErrCh</span>&nbsp;<span class="keyword" id="4931689">chan</span>&nbsp;<span class="builtintype" id="4931694">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931702">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4931723">sync</span><span class="op" id="4931727">.</span><span class="ident" id="4931728">Mutex</span>&nbsp;<span class="comment" id="4931734">//&nbsp;guards&nbsp;following&nbsp;fields</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931762">numExpectedResponses</span>&nbsp;<span class="builtintype" id="4931783">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931788">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4931809">bool</span>&nbsp;<span class="comment" id="4931814">//&nbsp;whether&nbsp;conn&nbsp;has&nbsp;been&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931847">broken</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4931868">bool</span>&nbsp;<span class="comment" id="4931873">//&nbsp;an&nbsp;error&nbsp;has&nbsp;happened&nbsp;on&nbsp;this&nbsp;connection;&nbsp;marked&nbsp;broken&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4931953">//&nbsp;mutateHeaderFunc&nbsp;is&nbsp;an&nbsp;optional&nbsp;func&nbsp;to&nbsp;modify&nbsp;extra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4932010">//&nbsp;headers&nbsp;on&nbsp;each&nbsp;outbound&nbsp;request&nbsp;before&nbsp;it&#39;s&nbsp;written.&nbsp;(the</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4932073">//&nbsp;original&nbsp;Request&nbsp;given&nbsp;to&nbsp;RoundTrip&nbsp;is&nbsp;not&nbsp;modified)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932130">mutateHeaderFunc</span>&nbsp;<span class="keyword" id="4932147">func</span><span class="op" id="4932151">(</span><span class="ident" id="4932152">Header</span><span class="op" id="4932158">)</span><br>
<span class="lineno"></span><span class="op" id="4932160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4932163">//&nbsp;isBroken&nbsp;reports&nbsp;whether&nbsp;this&nbsp;connection&nbsp;is&nbsp;in&nbsp;a&nbsp;known&nbsp;broken&nbsp;state.</span><br>
<span class="lineno">815</span><span class="keyword" id="4932235">func</span>&nbsp;<span class="op" id="4932240">(</span><span class="ident" id="4932241">pc</span>&nbsp;<span class="op" id="4932244">*</span><span class="ident" id="4932245">persistConn</span><span class="op" id="4932256">)</span>&nbsp;<span class="ident" id="4932258">isBroken</span><span class="op" id="4932266">(</span><span class="op" id="4932267">)</span>&nbsp;<span class="builtintype" id="4932269">bool</span>&nbsp;<span class="op" id="4932274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932277">pc</span><span class="op" id="4932279">.</span><span class="ident" id="4932280">lk</span><span class="op" id="4932282">.</span><span class="ident" id="4932283">Lock</span><span class="op" id="4932287">(</span><span class="op" id="4932288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932291">b</span>&nbsp;<span class="op" id="4932293">:=</span>&nbsp;<span class="ident" id="4932296">pc</span><span class="op" id="4932298">.</span><span class="ident" id="4932299">broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932307">pc</span><span class="op" id="4932309">.</span><span class="ident" id="4932310">lk</span><span class="op" id="4932312">.</span><span class="ident" id="4932313">Unlock</span><span class="op" id="4932319">(</span><span class="op" id="4932320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932323">return</span>&nbsp;<span class="ident" id="4932330">b</span><br>
<span class="lineno">820</span><span class="op" id="4932332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4932335">func</span>&nbsp;<span class="op" id="4932340">(</span><span class="ident" id="4932341">pc</span>&nbsp;<span class="op" id="4932344">*</span><span class="ident" id="4932345">persistConn</span><span class="op" id="4932356">)</span>&nbsp;<span class="ident" id="4932358">cancelRequest</span><span class="op" id="4932371">(</span><span class="op" id="4932372">)</span>&nbsp;<span class="op" id="4932374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932377">pc</span><span class="op" id="4932379">.</span><span class="ident" id="4932380">conn</span><span class="op" id="4932384">.</span><span class="ident" id="4932385">Close</span><span class="op" id="4932390">(</span><span class="op" id="4932391">)</span><br>
<span class="lineno"></span><span class="op" id="4932393">}</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="keyword" id="4932396">var</span>&nbsp;<span class="ident" id="4932400">remoteSideClosedFunc</span>&nbsp;<span class="keyword" id="4932421">func</span><span class="op" id="4932425">(</span><span class="builtintype" id="4932426">error</span><span class="op" id="4932431">)</span>&nbsp;<span class="builtintype" id="4932433">bool</span>&nbsp;<span class="comment" id="4932438">//&nbsp;or&nbsp;nil&nbsp;to&nbsp;use&nbsp;default</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4932464">func</span>&nbsp;<span class="ident" id="4932469">remoteSideClosed</span><span class="op" id="4932485">(</span><span class="ident" id="4932486">err</span>&nbsp;<span class="builtintype" id="4932490">error</span><span class="op" id="4932495">)</span>&nbsp;<span class="builtintype" id="4932497">bool</span>&nbsp;<span class="op" id="4932502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932505">if</span>&nbsp;<span class="ident" id="4932508">err</span>&nbsp;<span class="op" id="4932512">==</span>&nbsp;<span class="ident" id="4932515">io</span><span class="op" id="4932517">.</span><span class="ident" id="4932518">EOF</span>&nbsp;<span class="op" id="4932522">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932526">return</span>&nbsp;<span class="builtintype" id="4932533">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4932539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932542">if</span>&nbsp;<span class="ident" id="4932545">remoteSideClosedFunc</span>&nbsp;<span class="op" id="4932566">!=</span>&nbsp;<span class="ident" id="4932569">nil</span>&nbsp;<span class="op" id="4932573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932577">return</span>&nbsp;<span class="ident" id="4932584">remoteSideClosedFunc</span><span class="op" id="4932604">(</span><span class="ident" id="4932605">err</span><span class="op" id="4932608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4932611">}</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932614">return</span>&nbsp;<span class="builtintype" id="4932621">false</span><br>
<span class="lineno"></span><span class="op" id="4932627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4932630">func</span>&nbsp;<span class="op" id="4932635">(</span><span class="ident" id="4932636">pc</span>&nbsp;<span class="op" id="4932639">*</span><span class="ident" id="4932640">persistConn</span><span class="op" id="4932651">)</span>&nbsp;<span class="ident" id="4932653">readLoop</span><span class="op" id="4932661">(</span><span class="op" id="4932662">)</span>&nbsp;<span class="op" id="4932664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932667">alive</span>&nbsp;<span class="op" id="4932673">:=</span>&nbsp;<span class="builtintype" id="4932676">true</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932683">for</span>&nbsp;<span class="ident" id="4932687">alive</span>&nbsp;<span class="op" id="4932693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932697">pb</span><span class="op" id="4932699">,</span>&nbsp;<span class="ident" id="4932701">err</span>&nbsp;<span class="op" id="4932705">:=</span>&nbsp;<span class="ident" id="4932708">pc</span><span class="op" id="4932710">.</span><span class="ident" id="4932711">br</span><span class="op" id="4932713">.</span><span class="ident" id="4932714">Peek</span><span class="op" id="4932718">(</span><span class="num" id="4932719">1</span><span class="op" id="4932720">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932725">pc</span><span class="op" id="4932727">.</span><span class="ident" id="4932728">lk</span><span class="op" id="4932730">.</span><span class="ident" id="4932731">Lock</span><span class="op" id="4932735">(</span><span class="op" id="4932736">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932740">if</span>&nbsp;<span class="ident" id="4932743">pc</span><span class="op" id="4932745">.</span><span class="ident" id="4932746">numExpectedResponses</span>&nbsp;<span class="op" id="4932767">==</span>&nbsp;<span class="num" id="4932770">0</span>&nbsp;<span class="op" id="4932772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932777">if</span>&nbsp;<span class="op" id="4932780">!</span><span class="ident" id="4932781">pc</span><span class="op" id="4932783">.</span><span class="ident" id="4932784">closed</span>&nbsp;<span class="op" id="4932791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932797">pc</span><span class="op" id="4932799">.</span><span class="ident" id="4932800">closeLocked</span><span class="op" id="4932811">(</span><span class="op" id="4932812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932818">if</span>&nbsp;<span class="builtinfunc" id="4932821">len</span><span class="op" id="4932824">(</span><span class="ident" id="4932825">pb</span><span class="op" id="4932827">)</span>&nbsp;<span class="op" id="4932829">&gt;</span>&nbsp;<span class="num" id="4932831">0</span>&nbsp;<span class="op" id="4932833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932840">log</span><span class="op" id="4932843">.</span><span class="ident" id="4932844">Printf</span><span class="op" id="4932850">(</span><span class="string" id="4932851">&#34;Unsolicited&nbsp;response&nbsp;received&nbsp;on&nbsp;idle&nbsp;HTTP&nbsp;channel&nbsp;starting&nbsp;with&nbsp;%q;&nbsp;err=%v&#34;</span><span class="op" id="4932928">,</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4932936">string</span><span class="op" id="4932942">(</span><span class="ident" id="4932943">pb</span><span class="op" id="4932945">)</span><span class="op" id="4932946">,</span>&nbsp;<span class="ident" id="4932948">err</span><span class="op" id="4932951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4932957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4932962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932967">pc</span><span class="op" id="4932969">.</span><span class="ident" id="4932970">lk</span><span class="op" id="4932972">.</span><span class="ident" id="4932973">Unlock</span><span class="op" id="4932979">(</span><span class="op" id="4932980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932985">return</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4932994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932998">pc</span><span class="op" id="4933000">.</span><span class="ident" id="4933001">lk</span><span class="op" id="4933003">.</span><span class="ident" id="4933004">Unlock</span><span class="op" id="4933010">(</span><span class="op" id="4933011">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933016">rc</span>&nbsp;<span class="op" id="4933019">:=</span>&nbsp;<span class="op" id="4933022">&lt;-</span><span class="ident" id="4933024">pc</span><span class="op" id="4933026">.</span><span class="ident" id="4933027">reqch</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933036">var</span>&nbsp;<span class="ident" id="4933040">resp</span>&nbsp;<span class="op" id="4933045">*</span><span class="ident" id="4933046">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933057">if</span>&nbsp;<span class="ident" id="4933060">err</span>&nbsp;<span class="op" id="4933064">==</span>&nbsp;<span class="ident" id="4933067">nil</span>&nbsp;<span class="op" id="4933071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933076">resp</span><span class="op" id="4933080">,</span>&nbsp;<span class="ident" id="4933082">err</span>&nbsp;<span class="op" id="4933086">=</span>&nbsp;<span class="ident" id="4933088">ReadResponse</span><span class="op" id="4933100">(</span><span class="ident" id="4933101">pc</span><span class="op" id="4933103">.</span><span class="ident" id="4933104">br</span><span class="op" id="4933106">,</span>&nbsp;<span class="ident" id="4933108">rc</span><span class="op" id="4933110">.</span><span class="ident" id="4933111">req</span><span class="op" id="4933114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933119">if</span>&nbsp;<span class="ident" id="4933122">err</span>&nbsp;<span class="op" id="4933126">==</span>&nbsp;<span class="ident" id="4933129">nil</span>&nbsp;<span class="op" id="4933133">&amp;&amp;</span>&nbsp;<span class="ident" id="4933136">resp</span><span class="op" id="4933140">.</span><span class="ident" id="4933141">StatusCode</span>&nbsp;<span class="op" id="4933152">==</span>&nbsp;<span class="num" id="4933155">100</span>&nbsp;<span class="op" id="4933159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933165">//&nbsp;Skip&nbsp;any&nbsp;100-continue&nbsp;for&nbsp;now.</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933203">//&nbsp;TODO(bradfitz):&nbsp;if&nbsp;rc.req&nbsp;had&nbsp;&#34;Expect:&nbsp;100-continue&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933264">//&nbsp;actually&nbsp;block&nbsp;the&nbsp;request&nbsp;body&nbsp;write&nbsp;and&nbsp;signal&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933324">//&nbsp;writeLoop&nbsp;now&nbsp;to&nbsp;begin&nbsp;sending&nbsp;it.&nbsp;(Issue&nbsp;2184)&nbsp;For&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933390">//&nbsp;eat&nbsp;it,&nbsp;since&nbsp;we&#39;re&nbsp;never&nbsp;expecting&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933438">resp</span><span class="op" id="4933442">,</span>&nbsp;<span class="ident" id="4933444">err</span>&nbsp;<span class="op" id="4933448">=</span>&nbsp;<span class="ident" id="4933450">ReadResponse</span><span class="op" id="4933462">(</span><span class="ident" id="4933463">pc</span><span class="op" id="4933465">.</span><span class="ident" id="4933466">br</span><span class="op" id="4933468">,</span>&nbsp;<span class="ident" id="4933470">rc</span><span class="op" id="4933472">.</span><span class="ident" id="4933473">req</span><span class="op" id="4933476">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933490">if</span>&nbsp;<span class="ident" id="4933493">resp</span>&nbsp;<span class="op" id="4933498">!=</span>&nbsp;<span class="ident" id="4933501">nil</span>&nbsp;<span class="op" id="4933505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933510">resp</span><span class="op" id="4933514">.</span><span class="ident" id="4933515">TLS</span>&nbsp;<span class="op" id="4933519">=</span>&nbsp;<span class="ident" id="4933521">pc</span><span class="op" id="4933523">.</span><span class="ident" id="4933524">tlsState</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933540">hasBody</span>&nbsp;<span class="op" id="4933548">:=</span>&nbsp;<span class="ident" id="4933551">resp</span>&nbsp;<span class="op" id="4933556">!=</span>&nbsp;<span class="ident" id="4933559">nil</span>&nbsp;<span class="op" id="4933563">&amp;&amp;</span>&nbsp;<span class="ident" id="4933566">rc</span><span class="op" id="4933568">.</span><span class="ident" id="4933569">req</span><span class="op" id="4933572">.</span><span class="ident" id="4933573">Method</span>&nbsp;<span class="op" id="4933580">!=</span>&nbsp;<span class="string" id="4933583">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4933590">&amp;&amp;</span>&nbsp;<span class="ident" id="4933593">resp</span><span class="op" id="4933597">.</span><span class="ident" id="4933598">ContentLength</span>&nbsp;<span class="op" id="4933612">!=</span>&nbsp;<span class="num" id="4933615">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933620">if</span>&nbsp;<span class="ident" id="4933623">err</span>&nbsp;<span class="op" id="4933627">!=</span>&nbsp;<span class="ident" id="4933630">nil</span>&nbsp;<span class="op" id="4933634">{</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933639">pc</span><span class="op" id="4933641">.</span><span class="builtinfunc" id="4933642">close</span><span class="op" id="4933647">(</span><span class="op" id="4933648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933652">}</span>&nbsp;<span class="keyword" id="4933654">else</span>&nbsp;<span class="op" id="4933659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933664">if</span>&nbsp;<span class="ident" id="4933667">rc</span><span class="op" id="4933669">.</span><span class="ident" id="4933670">addedGzip</span>&nbsp;<span class="op" id="4933680">&amp;&amp;</span>&nbsp;<span class="ident" id="4933683">hasBody</span>&nbsp;<span class="op" id="4933691">&amp;&amp;</span>&nbsp;<span class="ident" id="4933694">resp</span><span class="op" id="4933698">.</span><span class="ident" id="4933699">Header</span><span class="op" id="4933705">.</span><span class="ident" id="4933706">Get</span><span class="op" id="4933709">(</span><span class="string" id="4933710">&#34;Content-Encoding&#34;</span><span class="op" id="4933728">)</span>&nbsp;<span class="op" id="4933730">==</span>&nbsp;<span class="string" id="4933733">&#34;gzip&#34;</span>&nbsp;<span class="op" id="4933740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933746">resp</span><span class="op" id="4933750">.</span><span class="ident" id="4933751">Header</span><span class="op" id="4933757">.</span><span class="ident" id="4933758">Del</span><span class="op" id="4933761">(</span><span class="string" id="4933762">&#34;Content-Encoding&#34;</span><span class="op" id="4933780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933786">resp</span><span class="op" id="4933790">.</span><span class="ident" id="4933791">Header</span><span class="op" id="4933797">.</span><span class="ident" id="4933798">Del</span><span class="op" id="4933801">(</span><span class="string" id="4933802">&#34;Content-Length&#34;</span><span class="op" id="4933818">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933824">resp</span><span class="op" id="4933828">.</span><span class="ident" id="4933829">ContentLength</span>&nbsp;<span class="op" id="4933843">=</span>&nbsp;<span class="op" id="4933845">-</span><span class="num" id="4933846">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933852">resp</span><span class="op" id="4933856">.</span><span class="ident" id="4933857">Body</span>&nbsp;<span class="op" id="4933862">=</span>&nbsp;<span class="op" id="4933864">&amp;</span><span class="ident" id="4933865">gzipReader</span><span class="op" id="4933875">{</span><span class="ident" id="4933876">body</span><span class="op" id="4933880">:</span>&nbsp;<span class="ident" id="4933882">resp</span><span class="op" id="4933886">.</span><span class="ident" id="4933887">Body</span><span class="op" id="4933891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933901">resp</span><span class="op" id="4933905">.</span><span class="ident" id="4933906">Body</span>&nbsp;<span class="op" id="4933911">=</span>&nbsp;<span class="op" id="4933913">&amp;</span><span class="ident" id="4933914">bodyEOFSignal</span><span class="op" id="4933927">{</span><span class="ident" id="4933928">body</span><span class="op" id="4933932">:</span>&nbsp;<span class="ident" id="4933934">resp</span><span class="op" id="4933938">.</span><span class="ident" id="4933939">Body</span><span class="op" id="4933943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933947">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933952">if</span>&nbsp;<span class="ident" id="4933955">err</span>&nbsp;<span class="op" id="4933959">!=</span>&nbsp;<span class="ident" id="4933962">nil</span>&nbsp;<span class="op" id="4933966">||</span>&nbsp;<span class="ident" id="4933969">resp</span><span class="op" id="4933973">.</span><span class="ident" id="4933974">Close</span>&nbsp;<span class="op" id="4933980">||</span>&nbsp;<span class="ident" id="4933983">rc</span><span class="op" id="4933985">.</span><span class="ident" id="4933986">req</span><span class="op" id="4933989">.</span><span class="ident" id="4933990">Close</span>&nbsp;<span class="op" id="4933996">||</span>&nbsp;<span class="ident" id="4933999">resp</span><span class="op" id="4934003">.</span><span class="ident" id="4934004">StatusCode</span>&nbsp;<span class="op" id="4934015">&lt;=</span>&nbsp;<span class="num" id="4934018">199</span>&nbsp;<span class="op" id="4934022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4934027">//&nbsp;Don&#39;t&nbsp;do&nbsp;keep-alive&nbsp;on&nbsp;error&nbsp;if&nbsp;either&nbsp;party&nbsp;requested&nbsp;a&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4934096">//&nbsp;or&nbsp;we&nbsp;get&nbsp;an&nbsp;unexpected&nbsp;informational&nbsp;(1xx)&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4934156">//&nbsp;StatusCode&nbsp;100&nbsp;is&nbsp;already&nbsp;handled&nbsp;above.</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934203">alive</span>&nbsp;<span class="op" id="4934209">=</span>&nbsp;<span class="builtintype" id="4934211">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934224">var</span>&nbsp;<span class="ident" id="4934228">waitForBodyRead</span>&nbsp;<span class="keyword" id="4934244">chan</span>&nbsp;<span class="builtintype" id="4934249">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934256">if</span>&nbsp;<span class="ident" id="4934259">hasBody</span>&nbsp;<span class="op" id="4934267">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934272">waitForBodyRead</span>&nbsp;<span class="op" id="4934288">=</span>&nbsp;<span class="builtinfunc" id="4934290">make</span><span class="op" id="4934294">(</span><span class="keyword" id="4934295">chan</span>&nbsp;<span class="builtintype" id="4934300">bool</span><span class="op" id="4934304">,</span>&nbsp;<span class="num" id="4934306">2</span><span class="op" id="4934307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934312">resp</span><span class="op" id="4934316">.</span><span class="ident" id="4934317">Body</span><span class="op" id="4934321">.</span><span class="op" id="4934322">(</span><span class="op" id="4934323">*</span><span class="ident" id="4934324">bodyEOFSignal</span><span class="op" id="4934337">)</span><span class="op" id="4934338">.</span><span class="ident" id="4934339">earlyCloseFn</span>&nbsp;<span class="op" id="4934352">=</span>&nbsp;<span class="keyword" id="4934354">func</span><span class="op" id="4934358">(</span><span class="op" id="4934359">)</span>&nbsp;<span class="builtintype" id="4934361">error</span>&nbsp;<span class="op" id="4934367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4934373">//&nbsp;Sending&nbsp;false&nbsp;here&nbsp;sets&nbsp;alive&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4934413">//&nbsp;false&nbsp;and&nbsp;closes&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4934452">//&nbsp;below.</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934466">waitForBodyRead</span>&nbsp;<span class="op" id="4934482">&lt;-</span>&nbsp;<span class="builtintype" id="4934485">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934495">return</span>&nbsp;<span class="ident" id="4934502">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934514">resp</span><span class="op" id="4934518">.</span><span class="ident" id="4934519">Body</span><span class="op" id="4934523">.</span><span class="op" id="4934524">(</span><span class="op" id="4934525">*</span><span class="ident" id="4934526">bodyEOFSignal</span><span class="op" id="4934539">)</span><span class="op" id="4934540">.</span><span class="ident" id="4934541">fn</span>&nbsp;<span class="op" id="4934544">=</span>&nbsp;<span class="keyword" id="4934546">func</span><span class="op" id="4934550">(</span><span class="ident" id="4934551">err</span>&nbsp;<span class="builtintype" id="4934555">error</span><span class="op" id="4934560">)</span>&nbsp;<span class="op" id="4934562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934568">waitForBodyRead</span>&nbsp;<span class="op" id="4934584">&lt;-</span>&nbsp;<span class="ident" id="4934587">alive</span>&nbsp;<span class="op" id="4934593">&amp;&amp;</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934601">err</span>&nbsp;<span class="op" id="4934605">==</span>&nbsp;<span class="ident" id="4934608">nil</span>&nbsp;<span class="op" id="4934612">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934620">!</span><span class="ident" id="4934621">pc</span><span class="op" id="4934623">.</span><span class="ident" id="4934624">sawEOF</span>&nbsp;<span class="op" id="4934631">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934639">pc</span><span class="op" id="4934641">.</span><span class="ident" id="4934642">wroteRequest</span><span class="op" id="4934654">(</span><span class="op" id="4934655">)</span>&nbsp;<span class="op" id="4934657">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934665">pc</span><span class="op" id="4934667">.</span><span class="ident" id="4934668">t</span><span class="op" id="4934669">.</span><span class="ident" id="4934670">putIdleConn</span><span class="op" id="4934681">(</span><span class="ident" id="4934682">pc</span><span class="op" id="4934684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934689">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934698">if</span>&nbsp;<span class="ident" id="4934701">alive</span>&nbsp;<span class="op" id="4934707">&amp;&amp;</span>&nbsp;<span class="op" id="4934710">!</span><span class="ident" id="4934711">hasBody</span>&nbsp;<span class="op" id="4934719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934724">alive</span>&nbsp;<span class="op" id="4934730">=</span>&nbsp;<span class="op" id="4934732">!</span><span class="ident" id="4934733">pc</span><span class="op" id="4934735">.</span><span class="ident" id="4934736">sawEOF</span>&nbsp;<span class="op" id="4934743">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934750">pc</span><span class="op" id="4934752">.</span><span class="ident" id="4934753">wroteRequest</span><span class="op" id="4934765">(</span><span class="op" id="4934766">)</span>&nbsp;<span class="op" id="4934768">&amp;&amp;</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934775">pc</span><span class="op" id="4934777">.</span><span class="ident" id="4934778">t</span><span class="op" id="4934779">.</span><span class="ident" id="4934780">putIdleConn</span><span class="op" id="4934791">(</span><span class="ident" id="4934792">pc</span><span class="op" id="4934794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934803">rc</span><span class="op" id="4934805">.</span><span class="ident" id="4934806">ch</span>&nbsp;<span class="op" id="4934809">&lt;-</span>&nbsp;<span class="ident" id="4934812">responseAndError</span><span class="op" id="4934828">{</span><span class="ident" id="4934829">resp</span><span class="op" id="4934833">,</span>&nbsp;<span class="ident" id="4934835">err</span><span class="op" id="4934838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4934843">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;just-returned&nbsp;response&nbsp;body&nbsp;to&nbsp;be&nbsp;fully&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4934910">//&nbsp;before&nbsp;we&nbsp;race&nbsp;and&nbsp;peek&nbsp;on&nbsp;the&nbsp;underlying&nbsp;bufio&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934971">if</span>&nbsp;<span class="ident" id="4934974">waitForBodyRead</span>&nbsp;<span class="op" id="4934990">!=</span>&nbsp;<span class="ident" id="4934993">nil</span>&nbsp;<span class="op" id="4934997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935002">select</span>&nbsp;<span class="op" id="4935009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935014">case</span>&nbsp;<span class="ident" id="4935019">alive</span>&nbsp;<span class="op" id="4935025">=</span>&nbsp;<span class="op" id="4935027">&lt;-</span><span class="ident" id="4935029">waitForBodyRead</span><span class="op" id="4935044">:</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935049">case</span>&nbsp;<span class="op" id="4935054">&lt;-</span><span class="ident" id="4935056">pc</span><span class="op" id="4935058">.</span><span class="ident" id="4935059">closech</span><span class="op" id="4935066">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935072">alive</span>&nbsp;<span class="op" id="4935078">=</span>&nbsp;<span class="builtintype" id="4935080">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935098">pc</span><span class="op" id="4935100">.</span><span class="ident" id="4935101">t</span><span class="op" id="4935102">.</span><span class="ident" id="4935103">setReqCanceler</span><span class="op" id="4935117">(</span><span class="ident" id="4935118">rc</span><span class="op" id="4935120">.</span><span class="ident" id="4935121">req</span><span class="op" id="4935124">,</span>&nbsp;<span class="ident" id="4935126">nil</span><span class="op" id="4935129">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935134">if</span>&nbsp;<span class="op" id="4935137">!</span><span class="ident" id="4935138">alive</span>&nbsp;<span class="op" id="4935144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935149">pc</span><span class="op" id="4935151">.</span><span class="builtinfunc" id="4935152">close</span><span class="op" id="4935157">(</span><span class="op" id="4935158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935162">}</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935165">}</span><br>
<span class="lineno"></span><span class="op" id="4935167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4935170">func</span>&nbsp;<span class="op" id="4935175">(</span><span class="ident" id="4935176">pc</span>&nbsp;<span class="op" id="4935179">*</span><span class="ident" id="4935180">persistConn</span><span class="op" id="4935191">)</span>&nbsp;<span class="ident" id="4935193">writeLoop</span><span class="op" id="4935202">(</span><span class="op" id="4935203">)</span>&nbsp;<span class="op" id="4935205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935208">for</span>&nbsp;<span class="op" id="4935212">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935216">select</span>&nbsp;<span class="op" id="4935223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935227">case</span>&nbsp;<span class="ident" id="4935232">wr</span>&nbsp;<span class="op" id="4935235">:=</span>&nbsp;<span class="op" id="4935238">&lt;-</span><span class="ident" id="4935240">pc</span><span class="op" id="4935242">.</span><span class="ident" id="4935243">writech</span><span class="op" id="4935250">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935255">if</span>&nbsp;<span class="ident" id="4935258">pc</span><span class="op" id="4935260">.</span><span class="ident" id="4935261">isBroken</span><span class="op" id="4935269">(</span><span class="op" id="4935270">)</span>&nbsp;<span class="op" id="4935272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935278">wr</span><span class="op" id="4935280">.</span><span class="ident" id="4935281">ch</span>&nbsp;<span class="op" id="4935284">&lt;-</span>&nbsp;<span class="ident" id="4935287">errors</span><span class="op" id="4935293">.</span><span class="ident" id="4935294">New</span><span class="op" id="4935297">(</span><span class="string" id="4935298">&#34;http:&nbsp;can&#39;t&nbsp;write&nbsp;HTTP&nbsp;request&nbsp;on&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="4935351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935357">continue</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935374">err</span>&nbsp;<span class="op" id="4935378">:=</span>&nbsp;<span class="ident" id="4935381">wr</span><span class="op" id="4935383">.</span><span class="ident" id="4935384">req</span><span class="op" id="4935387">.</span><span class="ident" id="4935388">Request</span><span class="op" id="4935395">.</span><span class="ident" id="4935396">write</span><span class="op" id="4935401">(</span><span class="ident" id="4935402">pc</span><span class="op" id="4935404">.</span><span class="ident" id="4935405">bw</span><span class="op" id="4935407">,</span>&nbsp;<span class="ident" id="4935409">pc</span><span class="op" id="4935411">.</span><span class="ident" id="4935412">isProxy</span><span class="op" id="4935419">,</span>&nbsp;<span class="ident" id="4935421">wr</span><span class="op" id="4935423">.</span><span class="ident" id="4935424">req</span><span class="op" id="4935427">.</span><span class="ident" id="4935428">extra</span><span class="op" id="4935433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935438">if</span>&nbsp;<span class="ident" id="4935441">err</span>&nbsp;<span class="op" id="4935445">==</span>&nbsp;<span class="ident" id="4935448">nil</span>&nbsp;<span class="op" id="4935452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935458">err</span>&nbsp;<span class="op" id="4935462">=</span>&nbsp;<span class="ident" id="4935464">pc</span><span class="op" id="4935466">.</span><span class="ident" id="4935467">bw</span><span class="op" id="4935469">.</span><span class="ident" id="4935470">Flush</span><span class="op" id="4935475">(</span><span class="op" id="4935476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935481">}</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935486">if</span>&nbsp;<span class="ident" id="4935489">err</span>&nbsp;<span class="op" id="4935493">!=</span>&nbsp;<span class="ident" id="4935496">nil</span>&nbsp;<span class="op" id="4935500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935506">pc</span><span class="op" id="4935508">.</span><span class="ident" id="4935509">markBroken</span><span class="op" id="4935519">(</span><span class="op" id="4935520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935526">wr</span><span class="op" id="4935528">.</span><span class="ident" id="4935529">req</span><span class="op" id="4935532">.</span><span class="ident" id="4935533">Request</span><span class="op" id="4935540">.</span><span class="ident" id="4935541">closeBody</span><span class="op" id="4935550">(</span><span class="op" id="4935551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935561">pc</span><span class="op" id="4935563">.</span><span class="ident" id="4935564">writeErrCh</span>&nbsp;<span class="op" id="4935575">&lt;-</span>&nbsp;<span class="ident" id="4935578">err</span>&nbsp;<span class="comment" id="4935582">//&nbsp;to&nbsp;the&nbsp;body&nbsp;reader,&nbsp;which&nbsp;might&nbsp;recycle&nbsp;us</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935631">wr</span><span class="op" id="4935633">.</span><span class="ident" id="4935634">ch</span>&nbsp;<span class="op" id="4935637">&lt;-</span>&nbsp;<span class="ident" id="4935640">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4935652">//&nbsp;to&nbsp;the&nbsp;roundTrip&nbsp;function</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935683">case</span>&nbsp;<span class="op" id="4935688">&lt;-</span><span class="ident" id="4935690">pc</span><span class="op" id="4935692">.</span><span class="ident" id="4935693">closech</span><span class="op" id="4935700">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935705">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935717">}</span><br>
<span class="lineno">965</span><span class="op" id="4935719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4935722">//&nbsp;wroteRequest&nbsp;is&nbsp;a&nbsp;check&nbsp;before&nbsp;recycling&nbsp;a&nbsp;connection&nbsp;that&nbsp;the&nbsp;previous&nbsp;write</span><br>
<span class="lineno"></span><span class="comment" id="4935803">//&nbsp;(from&nbsp;writeLoop&nbsp;above)&nbsp;happened&nbsp;and&nbsp;was&nbsp;successful.</span><br>
<span class="lineno"></span><span class="keyword" id="4935858">func</span>&nbsp;<span class="op" id="4935863">(</span><span class="ident" id="4935864">pc</span>&nbsp;<span class="op" id="4935867">*</span><span class="ident" id="4935868">persistConn</span><span class="op" id="4935879">)</span>&nbsp;<span class="ident" id="4935881">wroteRequest</span><span class="op" id="4935893">(</span><span class="op" id="4935894">)</span>&nbsp;<span class="builtintype" id="4935896">bool</span>&nbsp;<span class="op" id="4935901">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935904">select</span>&nbsp;<span class="op" id="4935911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935914">case</span>&nbsp;<span class="ident" id="4935919">err</span>&nbsp;<span class="op" id="4935923">:=</span>&nbsp;<span class="op" id="4935926">&lt;-</span><span class="ident" id="4935928">pc</span><span class="op" id="4935930">.</span><span class="ident" id="4935931">writeErrCh</span><span class="op" id="4935941">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4935945">//&nbsp;Common&nbsp;case:&nbsp;the&nbsp;write&nbsp;happened&nbsp;well&nbsp;before&nbsp;the&nbsp;response,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936011">//&nbsp;avoid&nbsp;creating&nbsp;a&nbsp;timer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4936040">return</span>&nbsp;<span class="ident" id="4936047">err</span>&nbsp;<span class="op" id="4936051">==</span>&nbsp;<span class="ident" id="4936054">nil</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4936059">default</span><span class="op" id="4936066">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936070">//&nbsp;Rare&nbsp;case:&nbsp;the&nbsp;request&nbsp;was&nbsp;written&nbsp;in&nbsp;writeLoop&nbsp;above&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936133">//&nbsp;before&nbsp;it&nbsp;could&nbsp;send&nbsp;to&nbsp;pc.writeErrCh,&nbsp;the&nbsp;reader&nbsp;read&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936196">//&nbsp;all,&nbsp;processed&nbsp;it,&nbsp;and&nbsp;called&nbsp;us&nbsp;here.&nbsp;In&nbsp;this&nbsp;case,&nbsp;give&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936263">//&nbsp;write&nbsp;goroutine&nbsp;a&nbsp;bit&nbsp;of&nbsp;time&nbsp;to&nbsp;finish&nbsp;its&nbsp;send.</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936318">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936323">//&nbsp;Less&nbsp;rare&nbsp;case:&nbsp;We&nbsp;also&nbsp;get&nbsp;here&nbsp;in&nbsp;the&nbsp;legitimate&nbsp;case&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936387">//&nbsp;Issue&nbsp;7569,&nbsp;where&nbsp;the&nbsp;writer&nbsp;is&nbsp;still&nbsp;writing&nbsp;(or&nbsp;stalled),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936452">//&nbsp;but&nbsp;the&nbsp;server&nbsp;has&nbsp;already&nbsp;replied.&nbsp;In&nbsp;this&nbsp;case,&nbsp;we&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936516">//&nbsp;want&nbsp;to&nbsp;wait&nbsp;too&nbsp;long,&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;return&nbsp;false&nbsp;so&nbsp;this</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936580">//&nbsp;connection&nbsp;isn&#39;t&nbsp;re-used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4936611">select</span>&nbsp;<span class="op" id="4936618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4936622">case</span>&nbsp;<span class="ident" id="4936627">err</span>&nbsp;<span class="op" id="4936631">:=</span>&nbsp;<span class="op" id="4936634">&lt;-</span><span class="ident" id="4936636">pc</span><span class="op" id="4936638">.</span><span class="ident" id="4936639">writeErrCh</span><span class="op" id="4936649">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4936654">return</span>&nbsp;<span class="ident" id="4936661">err</span>&nbsp;<span class="op" id="4936665">==</span>&nbsp;<span class="ident" id="4936668">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4936674">case</span>&nbsp;<span class="op" id="4936679">&lt;-</span><span class="ident" id="4936681">time</span><span class="op" id="4936685">.</span><span class="ident" id="4936686">After</span><span class="op" id="4936691">(</span><span class="num" id="4936692">50</span>&nbsp;<span class="op" id="4936695">*</span>&nbsp;<span class="ident" id="4936697">time</span><span class="op" id="4936701">.</span><span class="ident" id="4936702">Millisecond</span><span class="op" id="4936713">)</span><span class="op" id="4936714">:</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4936719">return</span>&nbsp;<span class="builtintype" id="4936726">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4936734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4936737">}</span><br>
<span class="lineno"></span><span class="op" id="4936739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">995</span><span class="keyword" id="4936742">type</span>&nbsp;<span class="ident" id="4936747">responseAndError</span>&nbsp;<span class="keyword" id="4936764">struct</span>&nbsp;<span class="op" id="4936771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936774">res</span>&nbsp;<span class="op" id="4936778">*</span><span class="ident" id="4936779">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936789">err</span>&nbsp;<span class="builtintype" id="4936793">error</span><br>
<span class="lineno"></span><span class="op" id="4936799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span><span class="keyword" id="4936802">type</span>&nbsp;<span class="ident" id="4936807">requestAndChan</span>&nbsp;<span class="keyword" id="4936822">struct</span>&nbsp;<span class="op" id="4936829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936832">req</span>&nbsp;<span class="op" id="4936836">*</span><span class="ident" id="4936837">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936846">ch</span>&nbsp;&nbsp;<span class="keyword" id="4936850">chan</span>&nbsp;<span class="ident" id="4936855">responseAndError</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936874">//&nbsp;did&nbsp;the&nbsp;Transport&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;the&nbsp;client&nbsp;code)&nbsp;add&nbsp;an</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936935">//&nbsp;Accept-Encoding&nbsp;gzip&nbsp;header?&nbsp;only&nbsp;if&nbsp;it&nbsp;we&nbsp;set&nbsp;it&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4936992">//&nbsp;we&nbsp;transparently&nbsp;decode&nbsp;the&nbsp;gzip.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937030">addedGzip</span>&nbsp;<span class="builtintype" id="4937040">bool</span><br>
<span class="lineno"></span><span class="op" id="4937045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1010</span><span class="comment" id="4937048">//&nbsp;A&nbsp;writeRequest&nbsp;is&nbsp;sent&nbsp;by&nbsp;the&nbsp;readLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4937109">//&nbsp;writeLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;while&nbsp;the&nbsp;read&nbsp;loop</span><br>
<span class="lineno"></span><span class="comment" id="4937173">//&nbsp;concurrently&nbsp;waits&nbsp;on&nbsp;both&nbsp;the&nbsp;write&nbsp;response&nbsp;and&nbsp;the&nbsp;server&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4937239">//&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="4937249">type</span>&nbsp;<span class="ident" id="4937254">writeRequest</span>&nbsp;<span class="keyword" id="4937267">struct</span>&nbsp;<span class="op" id="4937274">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937277">req</span>&nbsp;<span class="op" id="4937281">*</span><span class="ident" id="4937282">transportRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937300">ch</span>&nbsp;&nbsp;<span class="keyword" id="4937304">chan</span><span class="op" id="4937308">&lt;-</span>&nbsp;<span class="builtintype" id="4937311">error</span><br>
<span class="lineno"></span><span class="op" id="4937317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4937320">type</span>&nbsp;<span class="ident" id="4937325">httpError</span>&nbsp;<span class="keyword" id="4937335">struct</span>&nbsp;<span class="op" id="4937342">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937345">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4937353">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937361">timeout</span>&nbsp;<span class="builtintype" id="4937369">bool</span><br>
<span class="lineno"></span><span class="op" id="4937374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4937377">func</span>&nbsp;<span class="op" id="4937382">(</span><span class="ident" id="4937383">e</span>&nbsp;<span class="op" id="4937385">*</span><span class="ident" id="4937386">httpError</span><span class="op" id="4937395">)</span>&nbsp;<span class="ident" id="4937397">Error</span><span class="op" id="4937402">(</span><span class="op" id="4937403">)</span>&nbsp;<span class="builtintype" id="4937405">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4937414">{</span>&nbsp;<span class="keyword" id="4937416">return</span>&nbsp;<span class="ident" id="4937423">e</span><span class="op" id="4937424">.</span><span class="ident" id="4937425">err</span>&nbsp;<span class="op" id="4937429">}</span><br>
<span class="lineno">1025</span><span class="keyword" id="4937431">func</span>&nbsp;<span class="op" id="4937436">(</span><span class="ident" id="4937437">e</span>&nbsp;<span class="op" id="4937439">*</span><span class="ident" id="4937440">httpError</span><span class="op" id="4937449">)</span>&nbsp;<span class="ident" id="4937451">Timeout</span><span class="op" id="4937458">(</span><span class="op" id="4937459">)</span>&nbsp;<span class="builtintype" id="4937461">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4937468">{</span>&nbsp;<span class="keyword" id="4937470">return</span>&nbsp;<span class="ident" id="4937477">e</span><span class="op" id="4937478">.</span><span class="ident" id="4937479">timeout</span>&nbsp;<span class="op" id="4937487">}</span><br>
<span class="lineno"></span><span class="keyword" id="4937489">func</span>&nbsp;<span class="op" id="4937494">(</span><span class="ident" id="4937495">e</span>&nbsp;<span class="op" id="4937497">*</span><span class="ident" id="4937498">httpError</span><span class="op" id="4937507">)</span>&nbsp;<span class="ident" id="4937509">Temporary</span><span class="op" id="4937518">(</span><span class="op" id="4937519">)</span>&nbsp;<span class="builtintype" id="4937521">bool</span>&nbsp;<span class="op" id="4937526">{</span>&nbsp;<span class="keyword" id="4937528">return</span>&nbsp;<span class="builtintype" id="4937535">true</span>&nbsp;<span class="op" id="4937540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4937543">var</span>&nbsp;<span class="ident" id="4937547">errTimeout</span>&nbsp;<span class="builtintype" id="4937558">error</span>&nbsp;<span class="op" id="4937564">=</span>&nbsp;<span class="op" id="4937566">&amp;</span><span class="ident" id="4937567">httpError</span><span class="op" id="4937576">{</span><span class="ident" id="4937577">err</span><span class="op" id="4937580">:</span>&nbsp;<span class="string" id="4937582">&#34;net/http:&nbsp;timeout&nbsp;awaiting&nbsp;response&nbsp;headers&#34;</span><span class="op" id="4937627">,</span>&nbsp;<span class="ident" id="4937629">timeout</span><span class="op" id="4937636">:</span>&nbsp;<span class="builtintype" id="4937638">true</span><span class="op" id="4937642">}</span><br>
<span class="lineno"></span><span class="keyword" id="4937644">var</span>&nbsp;<span class="ident" id="4937648">errClosed</span>&nbsp;<span class="builtintype" id="4937658">error</span>&nbsp;<span class="op" id="4937664">=</span>&nbsp;<span class="op" id="4937666">&amp;</span><span class="ident" id="4937667">httpError</span><span class="op" id="4937676">{</span><span class="ident" id="4937677">err</span><span class="op" id="4937680">:</span>&nbsp;<span class="string" id="4937682">&#34;net/http:&nbsp;transport&nbsp;closed&nbsp;before&nbsp;response&nbsp;was&nbsp;received&#34;</span><span class="op" id="4937739">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span><span class="keyword" id="4937742">func</span>&nbsp;<span class="op" id="4937747">(</span><span class="ident" id="4937748">pc</span>&nbsp;<span class="op" id="4937751">*</span><span class="ident" id="4937752">persistConn</span><span class="op" id="4937763">)</span>&nbsp;<span class="ident" id="4937765">roundTrip</span><span class="op" id="4937774">(</span><span class="ident" id="4937775">req</span>&nbsp;<span class="op" id="4937779">*</span><span class="ident" id="4937780">transportRequest</span><span class="op" id="4937796">)</span>&nbsp;<span class="op" id="4937798">(</span><span class="ident" id="4937799">resp</span>&nbsp;<span class="op" id="4937804">*</span><span class="ident" id="4937805">Response</span><span class="op" id="4937813">,</span>&nbsp;<span class="ident" id="4937815">err</span>&nbsp;<span class="builtintype" id="4937819">error</span><span class="op" id="4937824">)</span>&nbsp;<span class="op" id="4937826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937829">pc</span><span class="op" id="4937831">.</span><span class="ident" id="4937832">t</span><span class="op" id="4937833">.</span><span class="ident" id="4937834">setReqCanceler</span><span class="op" id="4937848">(</span><span class="ident" id="4937849">req</span><span class="op" id="4937852">.</span><span class="ident" id="4937853">Request</span><span class="op" id="4937860">,</span>&nbsp;<span class="ident" id="4937862">pc</span><span class="op" id="4937864">.</span><span class="ident" id="4937865">cancelRequest</span><span class="op" id="4937878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937881">pc</span><span class="op" id="4937883">.</span><span class="ident" id="4937884">lk</span><span class="op" id="4937886">.</span><span class="ident" id="4937887">Lock</span><span class="op" id="4937891">(</span><span class="op" id="4937892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937895">pc</span><span class="op" id="4937897">.</span><span class="ident" id="4937898">numExpectedResponses</span><span class="op" id="4937918">++</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937922">headerFn</span>&nbsp;<span class="op" id="4937931">:=</span>&nbsp;<span class="ident" id="4937934">pc</span><span class="op" id="4937936">.</span><span class="ident" id="4937937">mutateHeaderFunc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937955">pc</span><span class="op" id="4937957">.</span><span class="ident" id="4937958">lk</span><span class="op" id="4937960">.</span><span class="ident" id="4937961">Unlock</span><span class="op" id="4937967">(</span><span class="op" id="4937968">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4937972">if</span>&nbsp;<span class="ident" id="4937975">headerFn</span>&nbsp;<span class="op" id="4937984">!=</span>&nbsp;<span class="ident" id="4937987">nil</span>&nbsp;<span class="op" id="4937991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937995">headerFn</span><span class="op" id="4938003">(</span><span class="ident" id="4938004">req</span><span class="op" id="4938007">.</span><span class="ident" id="4938008">extraHeaders</span><span class="op" id="4938020">(</span><span class="op" id="4938021">)</span><span class="op" id="4938022">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4938025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938029">//&nbsp;Ask&nbsp;for&nbsp;a&nbsp;compressed&nbsp;version&nbsp;if&nbsp;the&nbsp;caller&nbsp;didn&#39;t&nbsp;set&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938093">//&nbsp;own&nbsp;value&nbsp;for&nbsp;Accept-Encoding.&nbsp;We&nbsp;only&nbsp;attempt&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938147">//&nbsp;uncompress&nbsp;the&nbsp;gzip&nbsp;stream&nbsp;if&nbsp;we&nbsp;were&nbsp;the&nbsp;layer&nbsp;that</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938204">//&nbsp;requested&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938222">requestedGzip</span>&nbsp;<span class="op" id="4938236">:=</span>&nbsp;<span class="builtintype" id="4938239">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4938246">if</span>&nbsp;<span class="op" id="4938249">!</span><span class="ident" id="4938250">pc</span><span class="op" id="4938252">.</span><span class="ident" id="4938253">t</span><span class="op" id="4938254">.</span><span class="ident" id="4938255">DisableCompression</span>&nbsp;<span class="op" id="4938274">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938279">req</span><span class="op" id="4938282">.</span><span class="ident" id="4938283">Header</span><span class="op" id="4938289">.</span><span class="ident" id="4938290">Get</span><span class="op" id="4938293">(</span><span class="string" id="4938294">&#34;Accept-Encoding&#34;</span><span class="op" id="4938311">)</span>&nbsp;<span class="op" id="4938313">==</span>&nbsp;<span class="string" id="4938316">&#34;&#34;</span>&nbsp;<span class="op" id="4938319">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938324">req</span><span class="op" id="4938327">.</span><span class="ident" id="4938328">Header</span><span class="op" id="4938334">.</span><span class="ident" id="4938335">Get</span><span class="op" id="4938338">(</span><span class="string" id="4938339">&#34;Range&#34;</span><span class="op" id="4938346">)</span>&nbsp;<span class="op" id="4938348">==</span>&nbsp;<span class="string" id="4938351">&#34;&#34;</span>&nbsp;<span class="op" id="4938354">&amp;&amp;</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938359">req</span><span class="op" id="4938362">.</span><span class="ident" id="4938363">Method</span>&nbsp;<span class="op" id="4938370">!=</span>&nbsp;<span class="string" id="4938373">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4938380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938384">//&nbsp;Request&nbsp;gzip&nbsp;only,&nbsp;not&nbsp;deflate.&nbsp;Deflate&nbsp;is&nbsp;ambiguous&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938446">//&nbsp;not&nbsp;as&nbsp;universally&nbsp;supported&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938488">//&nbsp;See:&nbsp;http://www.gzip.org/zlib/zlib_faq.html#faq38</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938543">//</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938548">//&nbsp;Note&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;request&nbsp;this&nbsp;for&nbsp;HEAD&nbsp;requests,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938604">//&nbsp;due&nbsp;to&nbsp;a&nbsp;bug&nbsp;in&nbsp;nginx:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938632">//&nbsp;&nbsp;&nbsp;http://trac.nginx.org/nginx/ticket/358</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938678">//&nbsp;&nbsp;&nbsp;http://golang.org/issue/5522</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938714">//</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938719">//&nbsp;We&nbsp;don&#39;t&nbsp;request&nbsp;gzip&nbsp;if&nbsp;the&nbsp;request&nbsp;is&nbsp;for&nbsp;a&nbsp;range,&nbsp;since</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938783">//&nbsp;auto-decoding&nbsp;a&nbsp;portion&nbsp;of&nbsp;a&nbsp;gzipped&nbsp;document&nbsp;will&nbsp;just&nbsp;fail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938849">//&nbsp;anyway.&nbsp;See&nbsp;http://golang.org/issue/8923</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938895">requestedGzip</span>&nbsp;<span class="op" id="4938909">=</span>&nbsp;<span class="builtintype" id="4938911">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938918">req</span><span class="op" id="4938921">.</span><span class="ident" id="4938922">extraHeaders</span><span class="op" id="4938934">(</span><span class="op" id="4938935">)</span><span class="op" id="4938936">.</span><span class="ident" id="4938937">Set</span><span class="op" id="4938940">(</span><span class="string" id="4938941">&#34;Accept-Encoding&#34;</span><span class="op" id="4938958">,</span>&nbsp;<span class="string" id="4938960">&#34;gzip&#34;</span><span class="op" id="4938966">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4938969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938973">//&nbsp;Write&nbsp;the&nbsp;request&nbsp;concurrently&nbsp;with&nbsp;waiting&nbsp;for&nbsp;a&nbsp;response,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4939037">//&nbsp;in&nbsp;case&nbsp;the&nbsp;server&nbsp;decides&nbsp;to&nbsp;reply&nbsp;before&nbsp;reading&nbsp;our&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4939101">//&nbsp;request&nbsp;body.</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939119">writeErrCh</span>&nbsp;<span class="op" id="4939130">:=</span>&nbsp;<span class="builtinfunc" id="4939133">make</span><span class="op" id="4939137">(</span><span class="keyword" id="4939138">chan</span>&nbsp;<span class="builtintype" id="4939143">error</span><span class="op" id="4939148">,</span>&nbsp;<span class="num" id="4939150">1</span><span class="op" id="4939151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939154">pc</span><span class="op" id="4939156">.</span><span class="ident" id="4939157">writech</span>&nbsp;<span class="op" id="4939165">&lt;-</span>&nbsp;<span class="ident" id="4939168">writeRequest</span><span class="op" id="4939180">{</span><span class="ident" id="4939181">req</span><span class="op" id="4939184">,</span>&nbsp;<span class="ident" id="4939186">writeErrCh</span><span class="op" id="4939196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939200">resc</span>&nbsp;<span class="op" id="4939205">:=</span>&nbsp;<span class="builtinfunc" id="4939208">make</span><span class="op" id="4939212">(</span><span class="keyword" id="4939213">chan</span>&nbsp;<span class="ident" id="4939218">responseAndError</span><span class="op" id="4939234">,</span>&nbsp;<span class="num" id="4939236">1</span><span class="op" id="4939237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939240">pc</span><span class="op" id="4939242">.</span><span class="ident" id="4939243">reqch</span>&nbsp;<span class="op" id="4939249">&lt;-</span>&nbsp;<span class="ident" id="4939252">requestAndChan</span><span class="op" id="4939266">{</span><span class="ident" id="4939267">req</span><span class="op" id="4939270">.</span><span class="ident" id="4939271">Request</span><span class="op" id="4939278">,</span>&nbsp;<span class="ident" id="4939280">resc</span><span class="op" id="4939284">,</span>&nbsp;<span class="ident" id="4939286">requestedGzip</span><span class="op" id="4939299">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939303">var</span>&nbsp;<span class="ident" id="4939307">re</span>&nbsp;<span class="ident" id="4939310">responseAndError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939328">var</span>&nbsp;<span class="ident" id="4939332">pconnDeadCh</span>&nbsp;<span class="op" id="4939344">=</span>&nbsp;<span class="ident" id="4939346">pc</span><span class="op" id="4939348">.</span><span class="ident" id="4939349">closech</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939358">var</span>&nbsp;<span class="ident" id="4939362">failTicker</span>&nbsp;<span class="op" id="4939373">&lt;-</span><span class="keyword" id="4939375">chan</span>&nbsp;<span class="ident" id="4939380">time</span><span class="op" id="4939384">.</span><span class="ident" id="4939385">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939391">var</span>&nbsp;<span class="ident" id="4939395">respHeaderTimer</span>&nbsp;<span class="op" id="4939411">&lt;-</span><span class="keyword" id="4939413">chan</span>&nbsp;<span class="ident" id="4939418">time</span><span class="op" id="4939422">.</span><span class="ident" id="4939423">Time</span><br>
<span class="lineno">1080</span><span class="ident" id="4939428">WaitResponse</span><span class="op" id="4939440">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939443">for</span>&nbsp;<span class="op" id="4939447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939451">select</span>&nbsp;<span class="op" id="4939458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939462">case</span>&nbsp;<span class="ident" id="4939467">err</span>&nbsp;<span class="op" id="4939471">:=</span>&nbsp;<span class="op" id="4939474">&lt;-</span><span class="ident" id="4939476">writeErrCh</span><span class="op" id="4939486">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939491">if</span>&nbsp;<span class="ident" id="4939494">err</span>&nbsp;<span class="op" id="4939498">!=</span>&nbsp;<span class="ident" id="4939501">nil</span>&nbsp;<span class="op" id="4939505">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939511">re</span>&nbsp;<span class="op" id="4939514">=</span>&nbsp;<span class="ident" id="4939516">responseAndError</span><span class="op" id="4939532">{</span><span class="ident" id="4939533">nil</span><span class="op" id="4939536">,</span>&nbsp;<span class="ident" id="4939538">err</span><span class="op" id="4939541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939547">pc</span><span class="op" id="4939549">.</span><span class="builtinfunc" id="4939550">close</span><span class="op" id="4939555">(</span><span class="op" id="4939556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939562">break</span>&nbsp;<span class="ident" id="4939568">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4939584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939589">if</span>&nbsp;<span class="ident" id="4939592">d</span>&nbsp;<span class="op" id="4939594">:=</span>&nbsp;<span class="ident" id="4939597">pc</span><span class="op" id="4939599">.</span><span class="ident" id="4939600">t</span><span class="op" id="4939601">.</span><span class="ident" id="4939602">ResponseHeaderTimeout</span><span class="op" id="4939623">;</span>&nbsp;<span class="ident" id="4939625">d</span>&nbsp;<span class="op" id="4939627">&gt;</span>&nbsp;<span class="num" id="4939629">0</span>&nbsp;<span class="op" id="4939631">{</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939637">respHeaderTimer</span>&nbsp;<span class="op" id="4939653">=</span>&nbsp;<span class="ident" id="4939655">time</span><span class="op" id="4939659">.</span><span class="ident" id="4939660">After</span><span class="op" id="4939665">(</span><span class="ident" id="4939666">d</span><span class="op" id="4939667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4939672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939676">case</span>&nbsp;<span class="op" id="4939681">&lt;-</span><span class="ident" id="4939683">pconnDeadCh</span><span class="op" id="4939694">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4939699">//&nbsp;The&nbsp;persist&nbsp;connection&nbsp;is&nbsp;dead.&nbsp;This&nbsp;shouldn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4939752">//&nbsp;usually&nbsp;happen&nbsp;(only&nbsp;with&nbsp;Connection:&nbsp;close&nbsp;responses</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4939812">//&nbsp;with&nbsp;no&nbsp;response&nbsp;bodies),&nbsp;but&nbsp;if&nbsp;it&nbsp;does&nbsp;happen&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4939869">//&nbsp;means&nbsp;either&nbsp;a)&nbsp;the&nbsp;remote&nbsp;server&nbsp;hung&nbsp;up&nbsp;on&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4939923">//&nbsp;prematurely,&nbsp;or&nbsp;b)&nbsp;the&nbsp;readLoop&nbsp;sent&nbsp;us&nbsp;a&nbsp;response&nbsp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4939982">//&nbsp;closed&nbsp;its&nbsp;closech&nbsp;at&nbsp;roughly&nbsp;the&nbsp;same&nbsp;time,&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4940040">//&nbsp;selected&nbsp;this&nbsp;case&nbsp;first,&nbsp;in&nbsp;which&nbsp;case&nbsp;a&nbsp;response</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4940097">//&nbsp;might&nbsp;still&nbsp;be&nbsp;coming&nbsp;soon.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4940131">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4940137">//&nbsp;We&nbsp;can&#39;t&nbsp;avoid&nbsp;the&nbsp;select&nbsp;race&nbsp;in&nbsp;b)&nbsp;by&nbsp;using&nbsp;a&nbsp;unbuffered</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4940202">//&nbsp;resc&nbsp;channel&nbsp;instead,&nbsp;because&nbsp;then&nbsp;goroutines&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4940258">//&nbsp;leak&nbsp;if&nbsp;we&nbsp;exit&nbsp;due&nbsp;to&nbsp;other&nbsp;errors.</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4940301">pconnDeadCh</span>&nbsp;<span class="op" id="4940313">=</span>&nbsp;<span class="ident" id="4940315">nil</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4940349">//&nbsp;avoid&nbsp;spinning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4940370">failTicker</span>&nbsp;<span class="op" id="4940381">=</span>&nbsp;<span class="ident" id="4940383">time</span><span class="op" id="4940387">.</span><span class="ident" id="4940388">After</span><span class="op" id="4940393">(</span><span class="num" id="4940394">100</span>&nbsp;<span class="op" id="4940398">*</span>&nbsp;<span class="ident" id="4940400">time</span><span class="op" id="4940404">.</span><span class="ident" id="4940405">Millisecond</span><span class="op" id="4940416">)</span>&nbsp;<span class="comment" id="4940418">//&nbsp;arbitrary&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940455">case</span>&nbsp;<span class="op" id="4940460">&lt;-</span><span class="ident" id="4940462">failTicker</span><span class="op" id="4940472">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4940477">re</span>&nbsp;<span class="op" id="4940480">=</span>&nbsp;<span class="ident" id="4940482">responseAndError</span><span class="op" id="4940498">{</span><span class="ident" id="4940499">err</span><span class="op" id="4940502">:</span>&nbsp;<span class="ident" id="4940504">errClosed</span><span class="op" id="4940513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940518">break</span>&nbsp;<span class="ident" id="4940524">WaitResponse</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940539">case</span>&nbsp;<span class="op" id="4940544">&lt;-</span><span class="ident" id="4940546">respHeaderTimer</span><span class="op" id="4940561">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4940566">pc</span><span class="op" id="4940568">.</span><span class="builtinfunc" id="4940569">close</span><span class="op" id="4940574">(</span><span class="op" id="4940575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4940580">re</span>&nbsp;<span class="op" id="4940583">=</span>&nbsp;<span class="ident" id="4940585">responseAndError</span><span class="op" id="4940601">{</span><span class="ident" id="4940602">err</span><span class="op" id="4940605">:</span>&nbsp;<span class="ident" id="4940607">errTimeout</span><span class="op" id="4940617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940622">break</span>&nbsp;<span class="ident" id="4940628">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940643">case</span>&nbsp;<span class="ident" id="4940648">re</span>&nbsp;<span class="op" id="4940651">=</span>&nbsp;<span class="op" id="4940653">&lt;-</span><span class="ident" id="4940655">resc</span><span class="op" id="4940659">:</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940664">break</span>&nbsp;<span class="ident" id="4940670">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4940685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4940688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4940692">pc</span><span class="op" id="4940694">.</span><span class="ident" id="4940695">lk</span><span class="op" id="4940697">.</span><span class="ident" id="4940698">Lock</span><span class="op" id="4940702">(</span><span class="op" id="4940703">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4940706">pc</span><span class="op" id="4940708">.</span><span class="ident" id="4940709">numExpectedResponses</span><span class="op" id="4940729">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4940733">pc</span><span class="op" id="4940735">.</span><span class="ident" id="4940736">lk</span><span class="op" id="4940738">.</span><span class="ident" id="4940739">Unlock</span><span class="op" id="4940745">(</span><span class="op" id="4940746">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940750">if</span>&nbsp;<span class="ident" id="4940753">re</span><span class="op" id="4940755">.</span><span class="ident" id="4940756">err</span>&nbsp;<span class="op" id="4940760">!=</span>&nbsp;<span class="ident" id="4940763">nil</span>&nbsp;<span class="op" id="4940767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4940771">pc</span><span class="op" id="4940773">.</span><span class="ident" id="4940774">t</span><span class="op" id="4940775">.</span><span class="ident" id="4940776">setReqCanceler</span><span class="op" id="4940790">(</span><span class="ident" id="4940791">req</span><span class="op" id="4940794">.</span><span class="ident" id="4940795">Request</span><span class="op" id="4940802">,</span>&nbsp;<span class="ident" id="4940804">nil</span><span class="op" id="4940807">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4940810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940813">return</span>&nbsp;<span class="ident" id="4940820">re</span><span class="op" id="4940822">.</span><span class="ident" id="4940823">res</span><span class="op" id="4940826">,</span>&nbsp;<span class="ident" id="4940828">re</span><span class="op" id="4940830">.</span><span class="ident" id="4940831">err</span><br>
<span class="lineno"></span><span class="op" id="4940835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4940838">//&nbsp;markBroken&nbsp;marks&nbsp;a&nbsp;connection&nbsp;as&nbsp;broken&nbsp;(so&nbsp;it&#39;s&nbsp;not&nbsp;reused).</span><br>
<span class="lineno">1130</span><span class="comment" id="4940903">//&nbsp;It&nbsp;differs&nbsp;from&nbsp;close&nbsp;in&nbsp;that&nbsp;it&nbsp;doesn&#39;t&nbsp;close&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="4940968">//&nbsp;connection&nbsp;for&nbsp;use&nbsp;when&nbsp;it&#39;s&nbsp;still&nbsp;being&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="4941018">func</span>&nbsp;<span class="op" id="4941023">(</span><span class="ident" id="4941024">pc</span>&nbsp;<span class="op" id="4941027">*</span><span class="ident" id="4941028">persistConn</span><span class="op" id="4941039">)</span>&nbsp;<span class="ident" id="4941041">markBroken</span><span class="op" id="4941051">(</span><span class="op" id="4941052">)</span>&nbsp;<span class="op" id="4941054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941057">pc</span><span class="op" id="4941059">.</span><span class="ident" id="4941060">lk</span><span class="op" id="4941062">.</span><span class="ident" id="4941063">Lock</span><span class="op" id="4941067">(</span><span class="op" id="4941068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941071">defer</span>&nbsp;<span class="ident" id="4941077">pc</span><span class="op" id="4941079">.</span><span class="ident" id="4941080">lk</span><span class="op" id="4941082">.</span><span class="ident" id="4941083">Unlock</span><span class="op" id="4941089">(</span><span class="op" id="4941090">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941093">pc</span><span class="op" id="4941095">.</span><span class="ident" id="4941096">broken</span>&nbsp;<span class="op" id="4941103">=</span>&nbsp;<span class="builtintype" id="4941105">true</span><br>
<span class="lineno"></span><span class="op" id="4941110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4941113">func</span>&nbsp;<span class="op" id="4941118">(</span><span class="ident" id="4941119">pc</span>&nbsp;<span class="op" id="4941122">*</span><span class="ident" id="4941123">persistConn</span><span class="op" id="4941134">)</span>&nbsp;<span class="builtinfunc" id="4941136">close</span><span class="op" id="4941141">(</span><span class="op" id="4941142">)</span>&nbsp;<span class="op" id="4941144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941147">pc</span><span class="op" id="4941149">.</span><span class="ident" id="4941150">lk</span><span class="op" id="4941152">.</span><span class="ident" id="4941153">Lock</span><span class="op" id="4941157">(</span><span class="op" id="4941158">)</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941161">defer</span>&nbsp;<span class="ident" id="4941167">pc</span><span class="op" id="4941169">.</span><span class="ident" id="4941170">lk</span><span class="op" id="4941172">.</span><span class="ident" id="4941173">Unlock</span><span class="op" id="4941179">(</span><span class="op" id="4941180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941183">pc</span><span class="op" id="4941185">.</span><span class="ident" id="4941186">closeLocked</span><span class="op" id="4941197">(</span><span class="op" id="4941198">)</span><br>
<span class="lineno"></span><span class="op" id="4941200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4941203">func</span>&nbsp;<span class="op" id="4941208">(</span><span class="ident" id="4941209">pc</span>&nbsp;<span class="op" id="4941212">*</span><span class="ident" id="4941213">persistConn</span><span class="op" id="4941224">)</span>&nbsp;<span class="ident" id="4941226">closeLocked</span><span class="op" id="4941237">(</span><span class="op" id="4941238">)</span>&nbsp;<span class="op" id="4941240">{</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941243">pc</span><span class="op" id="4941245">.</span><span class="ident" id="4941246">broken</span>&nbsp;<span class="op" id="4941253">=</span>&nbsp;<span class="builtintype" id="4941255">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941261">if</span>&nbsp;<span class="op" id="4941264">!</span><span class="ident" id="4941265">pc</span><span class="op" id="4941267">.</span><span class="ident" id="4941268">closed</span>&nbsp;<span class="op" id="4941275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941279">pc</span><span class="op" id="4941281">.</span><span class="ident" id="4941282">conn</span><span class="op" id="4941286">.</span><span class="ident" id="4941287">Close</span><span class="op" id="4941292">(</span><span class="op" id="4941293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941297">pc</span><span class="op" id="4941299">.</span><span class="ident" id="4941300">closed</span>&nbsp;<span class="op" id="4941307">=</span>&nbsp;<span class="builtintype" id="4941309">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4941316">close</span><span class="op" id="4941321">(</span><span class="ident" id="4941322">pc</span><span class="op" id="4941324">.</span><span class="ident" id="4941325">closech</span><span class="op" id="4941332">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4941335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941338">pc</span><span class="op" id="4941340">.</span><span class="ident" id="4941341">mutateHeaderFunc</span>&nbsp;<span class="op" id="4941358">=</span>&nbsp;<span class="ident" id="4941360">nil</span><br>
<span class="lineno"></span><span class="op" id="4941364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4941367">var</span>&nbsp;<span class="ident" id="4941371">portMap</span>&nbsp;<span class="op" id="4941379">=</span>&nbsp;<span class="keyword" id="4941381">map</span><span class="op" id="4941384">[</span><span class="builtintype" id="4941385">string</span><span class="op" id="4941391">]</span><span class="builtintype" id="4941392">string</span><span class="op" id="4941398">{</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4941401">&#34;http&#34;</span><span class="op" id="4941407">:</span>&nbsp;&nbsp;<span class="string" id="4941410">&#34;80&#34;</span><span class="op" id="4941414">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4941417">&#34;https&#34;</span><span class="op" id="4941424">:</span>&nbsp;<span class="string" id="4941426">&#34;443&#34;</span><span class="op" id="4941431">,</span><br>
<span class="lineno"></span><span class="op" id="4941433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4941436">//&nbsp;canonicalAddr&nbsp;returns&nbsp;url.Host&nbsp;but&nbsp;always&nbsp;with&nbsp;a&nbsp;&#34;:port&#34;&nbsp;suffix</span><br>
<span class="lineno">1160</span><span class="keyword" id="4941503">func</span>&nbsp;<span class="ident" id="4941508">canonicalAddr</span><span class="op" id="4941521">(</span><span class="ident" id="4941522">url</span>&nbsp;<span class="op" id="4941526">*</span><span class="ident" id="4941527">url</span><span class="op" id="4941530">.</span><span class="ident" id="4941531">URL</span><span class="op" id="4941534">)</span>&nbsp;<span class="builtintype" id="4941536">string</span>&nbsp;<span class="op" id="4941543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941546">addr</span>&nbsp;<span class="op" id="4941551">:=</span>&nbsp;<span class="ident" id="4941554">url</span><span class="op" id="4941557">.</span><span class="ident" id="4941558">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941564">if</span>&nbsp;<span class="op" id="4941567">!</span><span class="ident" id="4941568">hasPort</span><span class="op" id="4941575">(</span><span class="ident" id="4941576">addr</span><span class="op" id="4941580">)</span>&nbsp;<span class="op" id="4941582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941586">return</span>&nbsp;<span class="ident" id="4941593">addr</span>&nbsp;<span class="op" id="4941598">+</span>&nbsp;<span class="string" id="4941600">&#34;:&#34;</span>&nbsp;<span class="op" id="4941604">+</span>&nbsp;<span class="ident" id="4941606">portMap</span><span class="op" id="4941613">[</span><span class="ident" id="4941614">url</span><span class="op" id="4941617">.</span><span class="ident" id="4941618">Scheme</span><span class="op" id="4941624">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4941627">}</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941630">return</span>&nbsp;<span class="ident" id="4941637">addr</span><br>
<span class="lineno"></span><span class="op" id="4941642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4941645">//&nbsp;bodyEOFSignal&nbsp;wraps&nbsp;a&nbsp;ReadCloser&nbsp;but&nbsp;runs&nbsp;fn&nbsp;(if&nbsp;non-nil)&nbsp;at&nbsp;most</span><br>
<span class="lineno"></span><span class="comment" id="4941714">//&nbsp;once,&nbsp;right&nbsp;before&nbsp;its&nbsp;final&nbsp;(error-producing)&nbsp;Read&nbsp;or&nbsp;Close&nbsp;call</span><br>
<span class="lineno">1170</span><span class="comment" id="4941783">//&nbsp;returns.&nbsp;If&nbsp;earlyCloseFn&nbsp;is&nbsp;non-nil&nbsp;and&nbsp;Close&nbsp;is&nbsp;called&nbsp;before</span><br>
<span class="lineno"></span><span class="comment" id="4941849">//&nbsp;io.EOF&nbsp;is&nbsp;seen,&nbsp;earlyCloseFn&nbsp;is&nbsp;called&nbsp;instead&nbsp;of&nbsp;fn,&nbsp;and&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="4941914">//&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="4941962">type</span>&nbsp;<span class="ident" id="4941967">bodyEOFSignal</span>&nbsp;<span class="keyword" id="4941981">struct</span>&nbsp;<span class="op" id="4941988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941991">body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4942004">io</span><span class="op" id="4942006">.</span><span class="ident" id="4942007">ReadCloser</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942019">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4942032">sync</span><span class="op" id="4942036">.</span><span class="ident" id="4942037">Mutex</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4942045">//&nbsp;guards&nbsp;following&nbsp;4&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942075">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4942088">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4942101">//&nbsp;whether&nbsp;Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942135">rerr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4942148">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4942161">//&nbsp;sticky&nbsp;Read&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942183">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4942196">func</span><span class="op" id="4942200">(</span><span class="builtintype" id="4942201">error</span><span class="op" id="4942206">)</span>&nbsp;&nbsp;<span class="comment" id="4942209">//&nbsp;error&nbsp;will&nbsp;be&nbsp;nil&nbsp;on&nbsp;Read&nbsp;io.EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942246">earlyCloseFn</span>&nbsp;<span class="keyword" id="4942259">func</span><span class="op" id="4942263">(</span><span class="op" id="4942264">)</span>&nbsp;<span class="builtintype" id="4942266">error</span>&nbsp;<span class="comment" id="4942272">//&nbsp;optional&nbsp;alt&nbsp;Close&nbsp;func&nbsp;used&nbsp;if&nbsp;io.EOF&nbsp;not&nbsp;seen</span><br>
<span class="lineno">1180</span><span class="op" id="4942323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4942326">func</span>&nbsp;<span class="op" id="4942331">(</span><span class="ident" id="4942332">es</span>&nbsp;<span class="op" id="4942335">*</span><span class="ident" id="4942336">bodyEOFSignal</span><span class="op" id="4942349">)</span>&nbsp;<span class="ident" id="4942351">Read</span><span class="op" id="4942355">(</span><span class="ident" id="4942356">p</span>&nbsp;<span class="op" id="4942358">[</span><span class="op" id="4942359">]</span><span class="builtintype" id="4942360">byte</span><span class="op" id="4942364">)</span>&nbsp;<span class="op" id="4942366">(</span><span class="ident" id="4942367">n</span>&nbsp;<span class="builtintype" id="4942369">int</span><span class="op" id="4942372">,</span>&nbsp;<span class="ident" id="4942374">err</span>&nbsp;<span class="builtintype" id="4942378">error</span><span class="op" id="4942383">)</span>&nbsp;<span class="op" id="4942385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942388">es</span><span class="op" id="4942390">.</span><span class="ident" id="4942391">mu</span><span class="op" id="4942393">.</span><span class="ident" id="4942394">Lock</span><span class="op" id="4942398">(</span><span class="op" id="4942399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942402">closed</span><span class="op" id="4942408">,</span>&nbsp;<span class="ident" id="4942410">rerr</span>&nbsp;<span class="op" id="4942415">:=</span>&nbsp;<span class="ident" id="4942418">es</span><span class="op" id="4942420">.</span><span class="ident" id="4942421">closed</span><span class="op" id="4942427">,</span>&nbsp;<span class="ident" id="4942429">es</span><span class="op" id="4942431">.</span><span class="ident" id="4942432">rerr</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942438">es</span><span class="op" id="4942440">.</span><span class="ident" id="4942441">mu</span><span class="op" id="4942443">.</span><span class="ident" id="4942444">Unlock</span><span class="op" id="4942450">(</span><span class="op" id="4942451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942454">if</span>&nbsp;<span class="ident" id="4942457">closed</span>&nbsp;<span class="op" id="4942464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942468">return</span>&nbsp;<span class="num" id="4942475">0</span><span class="op" id="4942476">,</span>&nbsp;<span class="ident" id="4942478">errors</span><span class="op" id="4942484">.</span><span class="ident" id="4942485">New</span><span class="op" id="4942488">(</span><span class="string" id="4942489">&#34;http:&nbsp;read&nbsp;on&nbsp;closed&nbsp;response&nbsp;body&#34;</span><span class="op" id="4942525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4942528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942531">if</span>&nbsp;<span class="ident" id="4942534">rerr</span>&nbsp;<span class="op" id="4942539">!=</span>&nbsp;<span class="ident" id="4942542">nil</span>&nbsp;<span class="op" id="4942546">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942550">return</span>&nbsp;<span class="num" id="4942557">0</span><span class="op" id="4942558">,</span>&nbsp;<span class="ident" id="4942560">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4942566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942570">n</span><span class="op" id="4942571">,</span>&nbsp;<span class="ident" id="4942573">err</span>&nbsp;<span class="op" id="4942577">=</span>&nbsp;<span class="ident" id="4942579">es</span><span class="op" id="4942581">.</span><span class="ident" id="4942582">body</span><span class="op" id="4942586">.</span><span class="ident" id="4942587">Read</span><span class="op" id="4942591">(</span><span class="ident" id="4942592">p</span><span class="op" id="4942593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942596">if</span>&nbsp;<span class="ident" id="4942599">err</span>&nbsp;<span class="op" id="4942603">!=</span>&nbsp;<span class="ident" id="4942606">nil</span>&nbsp;<span class="op" id="4942610">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942614">es</span><span class="op" id="4942616">.</span><span class="ident" id="4942617">mu</span><span class="op" id="4942619">.</span><span class="ident" id="4942620">Lock</span><span class="op" id="4942624">(</span><span class="op" id="4942625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942629">defer</span>&nbsp;<span class="ident" id="4942635">es</span><span class="op" id="4942637">.</span><span class="ident" id="4942638">mu</span><span class="op" id="4942640">.</span><span class="ident" id="4942641">Unlock</span><span class="op" id="4942647">(</span><span class="op" id="4942648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942652">if</span>&nbsp;<span class="ident" id="4942655">es</span><span class="op" id="4942657">.</span><span class="ident" id="4942658">rerr</span>&nbsp;<span class="op" id="4942663">==</span>&nbsp;<span class="ident" id="4942666">nil</span>&nbsp;<span class="op" id="4942670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942675">es</span><span class="op" id="4942677">.</span><span class="ident" id="4942678">rerr</span>&nbsp;<span class="op" id="4942683">=</span>&nbsp;<span class="ident" id="4942685">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4942691">}</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942695">es</span><span class="op" id="4942697">.</span><span class="ident" id="4942698">condfn</span><span class="op" id="4942704">(</span><span class="ident" id="4942705">err</span><span class="op" id="4942708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4942711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942714">return</span><br>
<span class="lineno"></span><span class="op" id="4942721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1205</span><span class="keyword" id="4942724">func</span>&nbsp;<span class="op" id="4942729">(</span><span class="ident" id="4942730">es</span>&nbsp;<span class="op" id="4942733">*</span><span class="ident" id="4942734">bodyEOFSignal</span><span class="op" id="4942747">)</span>&nbsp;<span class="ident" id="4942749">Close</span><span class="op" id="4942754">(</span><span class="op" id="4942755">)</span>&nbsp;<span class="builtintype" id="4942757">error</span>&nbsp;<span class="op" id="4942763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942766">es</span><span class="op" id="4942768">.</span><span class="ident" id="4942769">mu</span><span class="op" id="4942771">.</span><span class="ident" id="4942772">Lock</span><span class="op" id="4942776">(</span><span class="op" id="4942777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942780">defer</span>&nbsp;<span class="ident" id="4942786">es</span><span class="op" id="4942788">.</span><span class="ident" id="4942789">mu</span><span class="op" id="4942791">.</span><span class="ident" id="4942792">Unlock</span><span class="op" id="4942798">(</span><span class="op" id="4942799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942802">if</span>&nbsp;<span class="ident" id="4942805">es</span><span class="op" id="4942807">.</span><span class="ident" id="4942808">closed</span>&nbsp;<span class="op" id="4942815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942819">return</span>&nbsp;<span class="ident" id="4942826">nil</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4942831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942834">es</span><span class="op" id="4942836">.</span><span class="ident" id="4942837">closed</span>&nbsp;<span class="op" id="4942844">=</span>&nbsp;<span class="builtintype" id="4942846">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942852">if</span>&nbsp;<span class="ident" id="4942855">es</span><span class="op" id="4942857">.</span><span class="ident" id="4942858">earlyCloseFn</span>&nbsp;<span class="op" id="4942871">!=</span>&nbsp;<span class="ident" id="4942874">nil</span>&nbsp;<span class="op" id="4942878">&amp;&amp;</span>&nbsp;<span class="ident" id="4942881">es</span><span class="op" id="4942883">.</span><span class="ident" id="4942884">rerr</span>&nbsp;<span class="op" id="4942889">!=</span>&nbsp;<span class="ident" id="4942892">io</span><span class="op" id="4942894">.</span><span class="ident" id="4942895">EOF</span>&nbsp;<span class="op" id="4942899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942903">return</span>&nbsp;<span class="ident" id="4942910">es</span><span class="op" id="4942912">.</span><span class="ident" id="4942913">earlyCloseFn</span><span class="op" id="4942925">(</span><span class="op" id="4942926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4942929">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942932">err</span>&nbsp;<span class="op" id="4942936">:=</span>&nbsp;<span class="ident" id="4942939">es</span><span class="op" id="4942941">.</span><span class="ident" id="4942942">body</span><span class="op" id="4942946">.</span><span class="ident" id="4942947">Close</span><span class="op" id="4942952">(</span><span class="op" id="4942953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942956">es</span><span class="op" id="4942958">.</span><span class="ident" id="4942959">condfn</span><span class="op" id="4942965">(</span><span class="ident" id="4942966">err</span><span class="op" id="4942969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942972">return</span>&nbsp;<span class="ident" id="4942979">err</span><br>
<span class="lineno"></span><span class="op" id="4942983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span><span class="comment" id="4942986">//&nbsp;caller&nbsp;must&nbsp;hold&nbsp;es.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="4943013">func</span>&nbsp;<span class="op" id="4943018">(</span><span class="ident" id="4943019">es</span>&nbsp;<span class="op" id="4943022">*</span><span class="ident" id="4943023">bodyEOFSignal</span><span class="op" id="4943036">)</span>&nbsp;<span class="ident" id="4943038">condfn</span><span class="op" id="4943044">(</span><span class="ident" id="4943045">err</span>&nbsp;<span class="builtintype" id="4943049">error</span><span class="op" id="4943054">)</span>&nbsp;<span class="op" id="4943056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943059">if</span>&nbsp;<span class="ident" id="4943062">es</span><span class="op" id="4943064">.</span><span class="ident" id="4943065">fn</span>&nbsp;<span class="op" id="4943068">==</span>&nbsp;<span class="ident" id="4943071">nil</span>&nbsp;<span class="op" id="4943075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943079">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4943087">}</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943090">if</span>&nbsp;<span class="ident" id="4943093">err</span>&nbsp;<span class="op" id="4943097">==</span>&nbsp;<span class="ident" id="4943100">io</span><span class="op" id="4943102">.</span><span class="ident" id="4943103">EOF</span>&nbsp;<span class="op" id="4943107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943111">err</span>&nbsp;<span class="op" id="4943115">=</span>&nbsp;<span class="ident" id="4943117">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4943122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943125">es</span><span class="op" id="4943127">.</span><span class="ident" id="4943128">fn</span><span class="op" id="4943130">(</span><span class="ident" id="4943131">err</span><span class="op" id="4943134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943137">es</span><span class="op" id="4943139">.</span><span class="ident" id="4943140">fn</span>&nbsp;<span class="op" id="4943143">=</span>&nbsp;<span class="ident" id="4943145">nil</span><br>
<span class="lineno">1230</span><span class="op" id="4943149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4943152">//&nbsp;gzipReader&nbsp;wraps&nbsp;a&nbsp;response&nbsp;body&nbsp;so&nbsp;it&nbsp;can&nbsp;lazily</span><br>
<span class="lineno"></span><span class="comment" id="4943205">//&nbsp;call&nbsp;gzip.NewReader&nbsp;on&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Read</span><br>
<span class="lineno"></span><span class="keyword" id="4943254">type</span>&nbsp;<span class="ident" id="4943259">gzipReader</span>&nbsp;<span class="keyword" id="4943270">struct</span>&nbsp;<span class="op" id="4943277">{</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943280">body</span>&nbsp;<span class="ident" id="4943285">io</span><span class="op" id="4943287">.</span><span class="ident" id="4943288">ReadCloser</span>&nbsp;<span class="comment" id="4943299">//&nbsp;underlying&nbsp;Response.Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943328">zr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4943333">io</span><span class="op" id="4943335">.</span><span class="ident" id="4943336">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4943347">//&nbsp;lazily-initialized&nbsp;gzip&nbsp;reader</span><br>
<span class="lineno"></span><span class="op" id="4943381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4943384">func</span>&nbsp;<span class="op" id="4943389">(</span><span class="ident" id="4943390">gz</span>&nbsp;<span class="op" id="4943393">*</span><span class="ident" id="4943394">gzipReader</span><span class="op" id="4943404">)</span>&nbsp;<span class="ident" id="4943406">Read</span><span class="op" id="4943410">(</span><span class="ident" id="4943411">p</span>&nbsp;<span class="op" id="4943413">[</span><span class="op" id="4943414">]</span><span class="builtintype" id="4943415">byte</span><span class="op" id="4943419">)</span>&nbsp;<span class="op" id="4943421">(</span><span class="ident" id="4943422">n</span>&nbsp;<span class="builtintype" id="4943424">int</span><span class="op" id="4943427">,</span>&nbsp;<span class="ident" id="4943429">err</span>&nbsp;<span class="builtintype" id="4943433">error</span><span class="op" id="4943438">)</span>&nbsp;<span class="op" id="4943440">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943443">if</span>&nbsp;<span class="ident" id="4943446">gz</span><span class="op" id="4943448">.</span><span class="ident" id="4943449">zr</span>&nbsp;<span class="op" id="4943452">==</span>&nbsp;<span class="ident" id="4943455">nil</span>&nbsp;<span class="op" id="4943459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943463">gz</span><span class="op" id="4943465">.</span><span class="ident" id="4943466">zr</span><span class="op" id="4943468">,</span>&nbsp;<span class="ident" id="4943470">err</span>&nbsp;<span class="op" id="4943474">=</span>&nbsp;<span class="ident" id="4943476">gzip</span><span class="op" id="4943480">.</span><span class="ident" id="4943481">NewReader</span><span class="op" id="4943490">(</span><span class="ident" id="4943491">gz</span><span class="op" id="4943493">.</span><span class="ident" id="4943494">body</span><span class="op" id="4943498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943502">if</span>&nbsp;<span class="ident" id="4943505">err</span>&nbsp;<span class="op" id="4943509">!=</span>&nbsp;<span class="ident" id="4943512">nil</span>&nbsp;<span class="op" id="4943516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943521">return</span>&nbsp;<span class="num" id="4943528">0</span><span class="op" id="4943529">,</span>&nbsp;<span class="ident" id="4943531">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4943537">}</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4943540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943543">return</span>&nbsp;<span class="ident" id="4943550">gz</span><span class="op" id="4943552">.</span><span class="ident" id="4943553">zr</span><span class="op" id="4943555">.</span><span class="ident" id="4943556">Read</span><span class="op" id="4943560">(</span><span class="ident" id="4943561">p</span><span class="op" id="4943562">)</span><br>
<span class="lineno"></span><span class="op" id="4943564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4943567">func</span>&nbsp;<span class="op" id="4943572">(</span><span class="ident" id="4943573">gz</span>&nbsp;<span class="op" id="4943576">*</span><span class="ident" id="4943577">gzipReader</span><span class="op" id="4943587">)</span>&nbsp;<span class="ident" id="4943589">Close</span><span class="op" id="4943594">(</span><span class="op" id="4943595">)</span>&nbsp;<span class="builtintype" id="4943597">error</span>&nbsp;<span class="op" id="4943603">{</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943606">return</span>&nbsp;<span class="ident" id="4943613">gz</span><span class="op" id="4943615">.</span><span class="ident" id="4943616">body</span><span class="op" id="4943620">.</span><span class="ident" id="4943621">Close</span><span class="op" id="4943626">(</span><span class="op" id="4943627">)</span><br>
<span class="lineno"></span><span class="op" id="4943629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4943632">type</span>&nbsp;<span class="ident" id="4943637">readerAndCloser</span>&nbsp;<span class="keyword" id="4943653">struct</span>&nbsp;<span class="op" id="4943660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943663">io</span><span class="op" id="4943665">.</span><span class="ident" id="4943666">Reader</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943674">io</span><span class="op" id="4943676">.</span><span class="ident" id="4943677">Closer</span><br>
<span class="lineno"></span><span class="op" id="4943684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4943687">type</span>&nbsp;<span class="ident" id="4943692">tlsHandshakeTimeoutError</span>&nbsp;<span class="keyword" id="4943717">struct</span><span class="op" id="4943723">{</span><span class="op" id="4943724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1260</span><span class="keyword" id="4943727">func</span>&nbsp;<span class="op" id="4943732">(</span><span class="ident" id="4943733">tlsHandshakeTimeoutError</span><span class="op" id="4943757">)</span>&nbsp;<span class="ident" id="4943759">Timeout</span><span class="op" id="4943766">(</span><span class="op" id="4943767">)</span>&nbsp;<span class="builtintype" id="4943769">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4943776">{</span>&nbsp;<span class="keyword" id="4943778">return</span>&nbsp;<span class="builtintype" id="4943785">true</span>&nbsp;<span class="op" id="4943790">}</span><br>
<span class="lineno"></span><span class="keyword" id="4943792">func</span>&nbsp;<span class="op" id="4943797">(</span><span class="ident" id="4943798">tlsHandshakeTimeoutError</span><span class="op" id="4943822">)</span>&nbsp;<span class="ident" id="4943824">Temporary</span><span class="op" id="4943833">(</span><span class="op" id="4943834">)</span>&nbsp;<span class="builtintype" id="4943836">bool</span>&nbsp;<span class="op" id="4943841">{</span>&nbsp;<span class="keyword" id="4943843">return</span>&nbsp;<span class="builtintype" id="4943850">true</span>&nbsp;<span class="op" id="4943855">}</span><br>
<span class="lineno"></span><span class="keyword" id="4943857">func</span>&nbsp;<span class="op" id="4943862">(</span><span class="ident" id="4943863">tlsHandshakeTimeoutError</span><span class="op" id="4943887">)</span>&nbsp;<span class="ident" id="4943889">Error</span><span class="op" id="4943894">(</span><span class="op" id="4943895">)</span>&nbsp;<span class="builtintype" id="4943897">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4943906">{</span>&nbsp;<span class="keyword" id="4943908">return</span>&nbsp;<span class="string" id="4943915">&#34;net/http:&nbsp;TLS&nbsp;handshake&nbsp;timeout&#34;</span>&nbsp;<span class="op" id="4943949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4943952">type</span>&nbsp;<span class="ident" id="4943957">noteEOFReader</span>&nbsp;<span class="keyword" id="4943971">struct</span>&nbsp;<span class="op" id="4943978">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943981">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4943988">io</span><span class="op" id="4943990">.</span><span class="ident" id="4943991">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943999">sawEOF</span>&nbsp;<span class="op" id="4944006">*</span><span class="builtintype" id="4944007">bool</span><br>
<span class="lineno"></span><span class="op" id="4944012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4944015">func</span>&nbsp;<span class="op" id="4944020">(</span><span class="ident" id="4944021">nr</span>&nbsp;<span class="ident" id="4944024">noteEOFReader</span><span class="op" id="4944037">)</span>&nbsp;<span class="ident" id="4944039">Read</span><span class="op" id="4944043">(</span><span class="ident" id="4944044">p</span>&nbsp;<span class="op" id="4944046">[</span><span class="op" id="4944047">]</span><span class="builtintype" id="4944048">byte</span><span class="op" id="4944052">)</span>&nbsp;<span class="op" id="4944054">(</span><span class="ident" id="4944055">n</span>&nbsp;<span class="builtintype" id="4944057">int</span><span class="op" id="4944060">,</span>&nbsp;<span class="ident" id="4944062">err</span>&nbsp;<span class="builtintype" id="4944066">error</span><span class="op" id="4944071">)</span>&nbsp;<span class="op" id="4944073">{</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4944076">n</span><span class="op" id="4944077">,</span>&nbsp;<span class="ident" id="4944079">err</span>&nbsp;<span class="op" id="4944083">=</span>&nbsp;<span class="ident" id="4944085">nr</span><span class="op" id="4944087">.</span><span class="ident" id="4944088">r</span><span class="op" id="4944089">.</span><span class="ident" id="4944090">Read</span><span class="op" id="4944094">(</span><span class="ident" id="4944095">p</span><span class="op" id="4944096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4944099">if</span>&nbsp;<span class="ident" id="4944102">err</span>&nbsp;<span class="op" id="4944106">==</span>&nbsp;<span class="ident" id="4944109">io</span><span class="op" id="4944111">.</span><span class="ident" id="4944112">EOF</span>&nbsp;<span class="op" id="4944116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4944120">*</span><span class="ident" id="4944121">nr</span><span class="op" id="4944123">.</span><span class="ident" id="4944124">sawEOF</span>&nbsp;<span class="op" id="4944131">=</span>&nbsp;<span class="builtintype" id="4944133">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4944139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4944142">return</span><br>
<span class="lineno">1275</span><span class="op" id="4944149">}</span>
</div>
</body>
</html>
