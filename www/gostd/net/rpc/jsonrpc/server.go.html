<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc/jsonrpc</h2>
<ul>
<li><a href="/gostd/net/rpc/jsonrpc/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/server.go.html">server.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4692181">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4692237">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4692291">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4692342">package</span>&nbsp;<span class="ident" id="4692350">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4692359">import</span>&nbsp;<span class="op" id="4692366">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4692369">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4692386">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4692396">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4692402">&#34;net/rpc&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4692413">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="4692420">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="4692423">var</span>&nbsp;<span class="ident" id="4692427">errMissingParams</span>&nbsp;<span class="op" id="4692444">=</span>&nbsp;<span class="ident" id="4692446">errors</span><span class="op" id="4692452">.</span><span class="ident" id="4692453">New</span><span class="op" id="4692456">(</span><span class="string" id="4692457">&#34;jsonrpc:&nbsp;request&nbsp;body&nbsp;missing&nbsp;params&#34;</span><span class="op" id="4692495">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4692498">type</span>&nbsp;<span class="ident" id="4692503">serverCodec</span>&nbsp;<span class="keyword" id="4692515">struct</span>&nbsp;<span class="op" id="4692522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692525">dec</span>&nbsp;<span class="op" id="4692529">*</span><span class="ident" id="4692530">json</span><span class="op" id="4692534">.</span><span class="ident" id="4692535">Decoder</span>&nbsp;<span class="comment" id="4692543">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692571">enc</span>&nbsp;<span class="op" id="4692575">*</span><span class="ident" id="4692576">json</span><span class="op" id="4692580">.</span><span class="ident" id="4692581">Encoder</span>&nbsp;<span class="comment" id="4692589">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692617">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4692621">io</span><span class="op" id="4692623">.</span><span class="ident" id="4692624">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4692633">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692658">req</span>&nbsp;<span class="ident" id="4692662">serverRequest</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4692678">//&nbsp;JSON-RPC&nbsp;clients&nbsp;can&nbsp;use&nbsp;arbitrary&nbsp;json&nbsp;values&nbsp;as&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4692745">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;uint64&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4692789">//&nbsp;We&nbsp;assign&nbsp;uint64&nbsp;sequence&nbsp;numbers&nbsp;to&nbsp;incoming&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4692848">//&nbsp;but&nbsp;save&nbsp;the&nbsp;original&nbsp;request&nbsp;ID&nbsp;in&nbsp;the&nbsp;pending&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4692905">//&nbsp;When&nbsp;rpc&nbsp;responds,&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number&nbsp;in</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4692958">//&nbsp;the&nbsp;response&nbsp;to&nbsp;find&nbsp;the&nbsp;original&nbsp;request&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693008">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4693016">sync</span><span class="op" id="4693020">.</span><span class="ident" id="4693021">Mutex</span>&nbsp;<span class="comment" id="4693027">//&nbsp;protects&nbsp;seq,&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693053">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4693061">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693069">pending</span>&nbsp;<span class="keyword" id="4693077">map</span><span class="op" id="4693080">[</span><span class="ident" id="4693081">uint64</span><span class="op" id="4693087">]</span><span class="op" id="4693088">*</span><span class="ident" id="4693089">json</span><span class="op" id="4693093">.</span><span class="ident" id="4693094">RawMessage</span><br>
<span class="lineno"></span><span class="op" id="4693105">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="4693108">//&nbsp;NewServerCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ServerCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="4693180">func</span>&nbsp;<span class="ident" id="4693185">NewServerCodec</span><span class="op" id="4693199">(</span><span class="ident" id="4693200">conn</span>&nbsp;<span class="ident" id="4693205">io</span><span class="op" id="4693207">.</span><span class="ident" id="4693208">ReadWriteCloser</span><span class="op" id="4693223">)</span>&nbsp;<span class="ident" id="4693225">rpc</span><span class="op" id="4693228">.</span><span class="ident" id="4693229">ServerCodec</span>&nbsp;<span class="op" id="4693241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693244">return</span>&nbsp;<span class="op" id="4693251">&amp;</span><span class="ident" id="4693252">serverCodec</span><span class="op" id="4693263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693267">dec</span><span class="op" id="4693270">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4693276">json</span><span class="op" id="4693280">.</span><span class="ident" id="4693281">NewDecoder</span><span class="op" id="4693291">(</span><span class="ident" id="4693292">conn</span><span class="op" id="4693296">)</span><span class="op" id="4693297">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693301">enc</span><span class="op" id="4693304">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4693310">json</span><span class="op" id="4693314">.</span><span class="ident" id="4693315">NewEncoder</span><span class="op" id="4693325">(</span><span class="ident" id="4693326">conn</span><span class="op" id="4693330">)</span><span class="op" id="4693331">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693335">c</span><span class="op" id="4693336">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4693344">conn</span><span class="op" id="4693348">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693352">pending</span><span class="op" id="4693359">:</span>&nbsp;<span class="builtinfunc" id="4693361">make</span><span class="op" id="4693365">(</span><span class="keyword" id="4693366">map</span><span class="op" id="4693369">[</span><span class="ident" id="4693370">uint64</span><span class="op" id="4693376">]</span><span class="op" id="4693377">*</span><span class="ident" id="4693378">json</span><span class="op" id="4693382">.</span><span class="ident" id="4693383">RawMessage</span><span class="op" id="4693393">)</span><span class="op" id="4693394">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4693397">}</span><br>
<span class="lineno"></span><span class="op" id="4693399">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="4693402">type</span>&nbsp;<span class="ident" id="4693407">serverRequest</span>&nbsp;<span class="keyword" id="4693421">struct</span>&nbsp;<span class="op" id="4693428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693431">Method</span>&nbsp;<span class="builtintype" id="4693438">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4693455">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693472">Params</span>&nbsp;<span class="op" id="4693479">*</span><span class="ident" id="4693480">json</span><span class="op" id="4693484">.</span><span class="ident" id="4693485">RawMessage</span>&nbsp;<span class="string" id="4693496">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693513">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4693520">*</span><span class="ident" id="4693521">json</span><span class="op" id="4693525">.</span><span class="ident" id="4693526">RawMessage</span>&nbsp;<span class="string" id="4693537">`json:&#34;id&#34;`</span><br>
<span class="lineno">50</span><span class="op" id="4693549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4693552">func</span>&nbsp;<span class="op" id="4693557">(</span><span class="ident" id="4693558">r</span>&nbsp;<span class="op" id="4693560">*</span><span class="ident" id="4693561">serverRequest</span><span class="op" id="4693574">)</span>&nbsp;<span class="ident" id="4693576">reset</span><span class="op" id="4693581">(</span><span class="op" id="4693582">)</span>&nbsp;<span class="op" id="4693584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693587">r</span><span class="op" id="4693588">.</span><span class="ident" id="4693589">Method</span>&nbsp;<span class="op" id="4693596">=</span>&nbsp;<span class="string" id="4693598">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693602">r</span><span class="op" id="4693603">.</span><span class="ident" id="4693604">Params</span>&nbsp;<span class="op" id="4693611">=</span>&nbsp;<span class="ident" id="4693613">nil</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693618">r</span><span class="op" id="4693619">.</span><span class="ident" id="4693620">Id</span>&nbsp;<span class="op" id="4693623">=</span>&nbsp;<span class="ident" id="4693625">nil</span><br>
<span class="lineno"></span><span class="op" id="4693629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4693632">type</span>&nbsp;<span class="ident" id="4693637">serverResponse</span>&nbsp;<span class="keyword" id="4693652">struct</span>&nbsp;<span class="op" id="4693659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693662">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4693669">*</span><span class="ident" id="4693670">json</span><span class="op" id="4693674">.</span><span class="ident" id="4693675">RawMessage</span>&nbsp;<span class="string" id="4693686">`json:&#34;id&#34;`</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693699">Result</span>&nbsp;<span class="keyword" id="4693706">interface</span><span class="op" id="4693715">{</span><span class="op" id="4693716">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4693723">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693740">Error</span>&nbsp;&nbsp;<span class="keyword" id="4693747">interface</span><span class="op" id="4693756">{</span><span class="op" id="4693757">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4693764">`json:&#34;error&#34;`</span><br>
<span class="lineno"></span><span class="op" id="4693779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4693782">func</span>&nbsp;<span class="op" id="4693787">(</span><span class="ident" id="4693788">c</span>&nbsp;<span class="op" id="4693790">*</span><span class="ident" id="4693791">serverCodec</span><span class="op" id="4693802">)</span>&nbsp;<span class="ident" id="4693804">ReadRequestHeader</span><span class="op" id="4693821">(</span><span class="ident" id="4693822">r</span>&nbsp;<span class="op" id="4693824">*</span><span class="ident" id="4693825">rpc</span><span class="op" id="4693828">.</span><span class="ident" id="4693829">Request</span><span class="op" id="4693836">)</span>&nbsp;<span class="builtintype" id="4693838">error</span>&nbsp;<span class="op" id="4693844">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693847">c</span><span class="op" id="4693848">.</span><span class="ident" id="4693849">req</span><span class="op" id="4693852">.</span><span class="ident" id="4693853">reset</span><span class="op" id="4693858">(</span><span class="op" id="4693859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693862">if</span>&nbsp;<span class="ident" id="4693865">err</span>&nbsp;<span class="op" id="4693869">:=</span>&nbsp;<span class="ident" id="4693872">c</span><span class="op" id="4693873">.</span><span class="ident" id="4693874">dec</span><span class="op" id="4693877">.</span><span class="ident" id="4693878">Decode</span><span class="op" id="4693884">(</span><span class="op" id="4693885">&amp;</span><span class="ident" id="4693886">c</span><span class="op" id="4693887">.</span><span class="ident" id="4693888">req</span><span class="op" id="4693891">)</span><span class="op" id="4693892">;</span>&nbsp;<span class="ident" id="4693894">err</span>&nbsp;<span class="op" id="4693898">!=</span>&nbsp;<span class="ident" id="4693901">nil</span>&nbsp;<span class="op" id="4693905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693909">return</span>&nbsp;<span class="ident" id="4693916">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4693921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693924">r</span><span class="op" id="4693925">.</span><span class="ident" id="4693926">ServiceMethod</span>&nbsp;<span class="op" id="4693940">=</span>&nbsp;<span class="ident" id="4693942">c</span><span class="op" id="4693943">.</span><span class="ident" id="4693944">req</span><span class="op" id="4693947">.</span><span class="ident" id="4693948">Method</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4693957">//&nbsp;JSON&nbsp;request&nbsp;id&nbsp;can&nbsp;be&nbsp;any&nbsp;JSON&nbsp;value;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4694000">//&nbsp;RPC&nbsp;package&nbsp;expects&nbsp;uint64.&nbsp;&nbsp;Translate&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4694046">//&nbsp;internal&nbsp;uint64&nbsp;and&nbsp;save&nbsp;JSON&nbsp;on&nbsp;the&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694093">c</span><span class="op" id="4694094">.</span><span class="ident" id="4694095">mutex</span><span class="op" id="4694100">.</span><span class="ident" id="4694101">Lock</span><span class="op" id="4694105">(</span><span class="op" id="4694106">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694109">c</span><span class="op" id="4694110">.</span><span class="ident" id="4694111">seq</span><span class="op" id="4694114">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694118">c</span><span class="op" id="4694119">.</span><span class="ident" id="4694120">pending</span><span class="op" id="4694127">[</span><span class="ident" id="4694128">c</span><span class="op" id="4694129">.</span><span class="ident" id="4694130">seq</span><span class="op" id="4694133">]</span>&nbsp;<span class="op" id="4694135">=</span>&nbsp;<span class="ident" id="4694137">c</span><span class="op" id="4694138">.</span><span class="ident" id="4694139">req</span><span class="op" id="4694142">.</span><span class="ident" id="4694143">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694147">c</span><span class="op" id="4694148">.</span><span class="ident" id="4694149">req</span><span class="op" id="4694152">.</span><span class="ident" id="4694153">Id</span>&nbsp;<span class="op" id="4694156">=</span>&nbsp;<span class="ident" id="4694158">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694163">r</span><span class="op" id="4694164">.</span><span class="ident" id="4694165">Seq</span>&nbsp;<span class="op" id="4694169">=</span>&nbsp;<span class="ident" id="4694171">c</span><span class="op" id="4694172">.</span><span class="ident" id="4694173">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694178">c</span><span class="op" id="4694179">.</span><span class="ident" id="4694180">mutex</span><span class="op" id="4694185">.</span><span class="ident" id="4694186">Unlock</span><span class="op" id="4694192">(</span><span class="op" id="4694193">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694197">return</span>&nbsp;<span class="ident" id="4694204">nil</span><br>
<span class="lineno"></span><span class="op" id="4694208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4694211">func</span>&nbsp;<span class="op" id="4694216">(</span><span class="ident" id="4694217">c</span>&nbsp;<span class="op" id="4694219">*</span><span class="ident" id="4694220">serverCodec</span><span class="op" id="4694231">)</span>&nbsp;<span class="ident" id="4694233">ReadRequestBody</span><span class="op" id="4694248">(</span><span class="ident" id="4694249">x</span>&nbsp;<span class="keyword" id="4694251">interface</span><span class="op" id="4694260">{</span><span class="op" id="4694261">}</span><span class="op" id="4694262">)</span>&nbsp;<span class="builtintype" id="4694264">error</span>&nbsp;<span class="op" id="4694270">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694273">if</span>&nbsp;<span class="ident" id="4694276">x</span>&nbsp;<span class="op" id="4694278">==</span>&nbsp;<span class="ident" id="4694281">nil</span>&nbsp;<span class="op" id="4694285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694289">return</span>&nbsp;<span class="ident" id="4694296">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4694301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694304">if</span>&nbsp;<span class="ident" id="4694307">c</span><span class="op" id="4694308">.</span><span class="ident" id="4694309">req</span><span class="op" id="4694312">.</span><span class="ident" id="4694313">Params</span>&nbsp;<span class="op" id="4694320">==</span>&nbsp;<span class="ident" id="4694323">nil</span>&nbsp;<span class="op" id="4694327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694331">return</span>&nbsp;<span class="ident" id="4694338">errMissingParams</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4694356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4694359">//&nbsp;JSON&nbsp;params&nbsp;is&nbsp;array&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4694391">//&nbsp;RPC&nbsp;params&nbsp;is&nbsp;struct.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4694417">//&nbsp;Unmarshal&nbsp;into&nbsp;array&nbsp;containing&nbsp;struct&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4694469">//&nbsp;Should&nbsp;think&nbsp;about&nbsp;making&nbsp;RPC&nbsp;more&nbsp;general.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694517">var</span>&nbsp;<span class="ident" id="4694521">params</span>&nbsp;<span class="op" id="4694528">[</span><span class="num" id="4694529">1</span><span class="op" id="4694530">]</span><span class="keyword" id="4694531">interface</span><span class="op" id="4694540">{</span><span class="op" id="4694541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694544">params</span><span class="op" id="4694550">[</span><span class="num" id="4694551">0</span><span class="op" id="4694552">]</span>&nbsp;<span class="op" id="4694554">=</span>&nbsp;<span class="ident" id="4694556">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694559">return</span>&nbsp;<span class="ident" id="4694566">json</span><span class="op" id="4694570">.</span><span class="ident" id="4694571">Unmarshal</span><span class="op" id="4694580">(</span><span class="op" id="4694581">*</span><span class="ident" id="4694582">c</span><span class="op" id="4694583">.</span><span class="ident" id="4694584">req</span><span class="op" id="4694587">.</span><span class="ident" id="4694588">Params</span><span class="op" id="4694594">,</span>&nbsp;<span class="op" id="4694596">&amp;</span><span class="ident" id="4694597">params</span><span class="op" id="4694603">)</span><br>
<span class="lineno"></span><span class="op" id="4694605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="4694608">var</span>&nbsp;<span class="ident" id="4694612">null</span>&nbsp;<span class="op" id="4694617">=</span>&nbsp;<span class="ident" id="4694619">json</span><span class="op" id="4694623">.</span><span class="ident" id="4694624">RawMessage</span><span class="op" id="4694634">(</span><span class="op" id="4694635">[</span><span class="op" id="4694636">]</span><span class="builtintype" id="4694637">byte</span><span class="op" id="4694641">(</span><span class="string" id="4694642">&#34;null&#34;</span><span class="op" id="4694648">)</span><span class="op" id="4694649">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4694652">func</span>&nbsp;<span class="op" id="4694657">(</span><span class="ident" id="4694658">c</span>&nbsp;<span class="op" id="4694660">*</span><span class="ident" id="4694661">serverCodec</span><span class="op" id="4694672">)</span>&nbsp;<span class="ident" id="4694674">WriteResponse</span><span class="op" id="4694687">(</span><span class="ident" id="4694688">r</span>&nbsp;<span class="op" id="4694690">*</span><span class="ident" id="4694691">rpc</span><span class="op" id="4694694">.</span><span class="ident" id="4694695">Response</span><span class="op" id="4694703">,</span>&nbsp;<span class="ident" id="4694705">x</span>&nbsp;<span class="keyword" id="4694707">interface</span><span class="op" id="4694716">{</span><span class="op" id="4694717">}</span><span class="op" id="4694718">)</span>&nbsp;<span class="builtintype" id="4694720">error</span>&nbsp;<span class="op" id="4694726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694729">c</span><span class="op" id="4694730">.</span><span class="ident" id="4694731">mutex</span><span class="op" id="4694736">.</span><span class="ident" id="4694737">Lock</span><span class="op" id="4694741">(</span><span class="op" id="4694742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694745">b</span><span class="op" id="4694746">,</span>&nbsp;<span class="ident" id="4694748">ok</span>&nbsp;<span class="op" id="4694751">:=</span>&nbsp;<span class="ident" id="4694754">c</span><span class="op" id="4694755">.</span><span class="ident" id="4694756">pending</span><span class="op" id="4694763">[</span><span class="ident" id="4694764">r</span><span class="op" id="4694765">.</span><span class="ident" id="4694766">Seq</span><span class="op" id="4694769">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694772">if</span>&nbsp;<span class="op" id="4694775">!</span><span class="ident" id="4694776">ok</span>&nbsp;<span class="op" id="4694779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694783">c</span><span class="op" id="4694784">.</span><span class="ident" id="4694785">mutex</span><span class="op" id="4694790">.</span><span class="ident" id="4694791">Unlock</span><span class="op" id="4694797">(</span><span class="op" id="4694798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694802">return</span>&nbsp;<span class="ident" id="4694809">errors</span><span class="op" id="4694815">.</span><span class="ident" id="4694816">New</span><span class="op" id="4694819">(</span><span class="string" id="4694820">&#34;invalid&nbsp;sequence&nbsp;number&nbsp;in&nbsp;response&#34;</span><span class="op" id="4694857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4694860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4694863">delete</span><span class="op" id="4694869">(</span><span class="ident" id="4694870">c</span><span class="op" id="4694871">.</span><span class="ident" id="4694872">pending</span><span class="op" id="4694879">,</span>&nbsp;<span class="ident" id="4694881">r</span><span class="op" id="4694882">.</span><span class="ident" id="4694883">Seq</span><span class="op" id="4694886">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694889">c</span><span class="op" id="4694890">.</span><span class="ident" id="4694891">mutex</span><span class="op" id="4694896">.</span><span class="ident" id="4694897">Unlock</span><span class="op" id="4694903">(</span><span class="op" id="4694904">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694908">if</span>&nbsp;<span class="ident" id="4694911">b</span>&nbsp;<span class="op" id="4694913">==</span>&nbsp;<span class="ident" id="4694916">nil</span>&nbsp;<span class="op" id="4694920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4694924">//&nbsp;Invalid&nbsp;request&nbsp;so&nbsp;no&nbsp;id.&nbsp;&nbsp;Use&nbsp;JSON&nbsp;null.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694971">b</span>&nbsp;<span class="op" id="4694973">=</span>&nbsp;<span class="op" id="4694975">&amp;</span><span class="ident" id="4694976">null</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4694982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694985">resp</span>&nbsp;<span class="op" id="4694990">:=</span>&nbsp;<span class="ident" id="4694993">serverResponse</span><span class="op" id="4695007">{</span><span class="ident" id="4695008">Id</span><span class="op" id="4695010">:</span>&nbsp;<span class="ident" id="4695012">b</span><span class="op" id="4695013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695016">if</span>&nbsp;<span class="ident" id="4695019">r</span><span class="op" id="4695020">.</span><span class="ident" id="4695021">Error</span>&nbsp;<span class="op" id="4695027">==</span>&nbsp;<span class="string" id="4695030">&#34;&#34;</span>&nbsp;<span class="op" id="4695033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695037">resp</span><span class="op" id="4695041">.</span><span class="ident" id="4695042">Result</span>&nbsp;<span class="op" id="4695049">=</span>&nbsp;<span class="ident" id="4695051">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4695054">}</span>&nbsp;<span class="keyword" id="4695056">else</span>&nbsp;<span class="op" id="4695061">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695065">resp</span><span class="op" id="4695069">.</span><span class="ident" id="4695070">Error</span>&nbsp;<span class="op" id="4695076">=</span>&nbsp;<span class="ident" id="4695078">r</span><span class="op" id="4695079">.</span><span class="ident" id="4695080">Error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4695087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695090">return</span>&nbsp;<span class="ident" id="4695097">c</span><span class="op" id="4695098">.</span><span class="ident" id="4695099">enc</span><span class="op" id="4695102">.</span><span class="ident" id="4695103">Encode</span><span class="op" id="4695109">(</span><span class="ident" id="4695110">resp</span><span class="op" id="4695114">)</span><br>
<span class="lineno"></span><span class="op" id="4695116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="keyword" id="4695119">func</span>&nbsp;<span class="op" id="4695124">(</span><span class="ident" id="4695125">c</span>&nbsp;<span class="op" id="4695127">*</span><span class="ident" id="4695128">serverCodec</span><span class="op" id="4695139">)</span>&nbsp;<span class="ident" id="4695141">Close</span><span class="op" id="4695146">(</span><span class="op" id="4695147">)</span>&nbsp;<span class="builtintype" id="4695149">error</span>&nbsp;<span class="op" id="4695155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695158">return</span>&nbsp;<span class="ident" id="4695165">c</span><span class="op" id="4695166">.</span><span class="ident" id="4695167">c</span><span class="op" id="4695168">.</span><span class="ident" id="4695169">Close</span><span class="op" id="4695174">(</span><span class="op" id="4695175">)</span><br>
<span class="lineno"></span><span class="op" id="4695177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4695180">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;JSON-RPC&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno">130</span><span class="comment" id="4695242">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="4695313">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="4695374">func</span>&nbsp;<span class="ident" id="4695379">ServeConn</span><span class="op" id="4695388">(</span><span class="ident" id="4695389">conn</span>&nbsp;<span class="ident" id="4695394">io</span><span class="op" id="4695396">.</span><span class="ident" id="4695397">ReadWriteCloser</span><span class="op" id="4695412">)</span>&nbsp;<span class="op" id="4695414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695417">rpc</span><span class="op" id="4695420">.</span><span class="ident" id="4695421">ServeCodec</span><span class="op" id="4695431">(</span><span class="ident" id="4695432">NewServerCodec</span><span class="op" id="4695446">(</span><span class="ident" id="4695447">conn</span><span class="op" id="4695451">)</span><span class="op" id="4695452">)</span><br>
<span class="lineno"></span><span class="op" id="4695454">}</span>
</div>
</body>
</html>
