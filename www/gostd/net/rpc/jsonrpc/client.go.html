<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc/jsonrpc</h2>
<ul>
<li><a href="/gostd/net/rpc/jsonrpc/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/client.go.html" class="current">client.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/server.go.html">server.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4744424">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4744480">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4744534">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4744585">//&nbsp;Package&nbsp;jsonrpc&nbsp;implements&nbsp;a&nbsp;JSON-RPC&nbsp;ClientCodec&nbsp;and&nbsp;ServerCodec</span><br>
<span class="lineno"></span><span class="comment" id="4744654">//&nbsp;for&nbsp;the&nbsp;rpc&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4744678">package</span>&nbsp;<span class="ident" id="4744686">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4744695">import</span>&nbsp;<span class="op" id="4744702">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4744705">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4744722">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4744729">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4744735">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4744742">&#34;net/rpc&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4744753">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="4744760">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4744763">type</span>&nbsp;<span class="ident" id="4744768">clientCodec</span>&nbsp;<span class="keyword" id="4744780">struct</span>&nbsp;<span class="op" id="4744787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4744790">dec</span>&nbsp;<span class="op" id="4744794">*</span><span class="ident" id="4744795">json</span><span class="op" id="4744799">.</span><span class="ident" id="4744800">Decoder</span>&nbsp;<span class="comment" id="4744808">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4744836">enc</span>&nbsp;<span class="op" id="4744840">*</span><span class="ident" id="4744841">json</span><span class="op" id="4744845">.</span><span class="ident" id="4744846">Encoder</span>&nbsp;<span class="comment" id="4744854">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4744882">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4744886">io</span><span class="op" id="4744888">.</span><span class="ident" id="4744889">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4744898">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4744923">req</span>&nbsp;&nbsp;<span class="ident" id="4744928">clientRequest</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4744943">resp</span>&nbsp;<span class="ident" id="4744948">clientResponse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4744965">//&nbsp;JSON-RPC&nbsp;responses&nbsp;include&nbsp;the&nbsp;request&nbsp;id&nbsp;but&nbsp;not&nbsp;the&nbsp;request&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4745039">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;both.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4745069">//&nbsp;We&nbsp;save&nbsp;the&nbsp;request&nbsp;method&nbsp;in&nbsp;pending&nbsp;when&nbsp;sending&nbsp;a&nbsp;request</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4745134">//&nbsp;and&nbsp;then&nbsp;look&nbsp;it&nbsp;up&nbsp;by&nbsp;request&nbsp;ID&nbsp;when&nbsp;filling&nbsp;out&nbsp;the&nbsp;rpc&nbsp;Response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745207">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4745215">sync</span><span class="op" id="4745219">.</span><span class="ident" id="4745220">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4745233">//&nbsp;protects&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745254">pending</span>&nbsp;<span class="keyword" id="4745262">map</span><span class="op" id="4745265">[</span><span class="ident" id="4745266">uint64</span><span class="op" id="4745272">]</span><span class="builtintype" id="4745273">string</span>&nbsp;<span class="comment" id="4745280">//&nbsp;map&nbsp;request&nbsp;id&nbsp;to&nbsp;method&nbsp;name</span><br>
<span class="lineno"></span><span class="op" id="4745313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="4745316">//&nbsp;NewClientCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ClientCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="4745388">func</span>&nbsp;<span class="ident" id="4745393">NewClientCodec</span><span class="op" id="4745407">(</span><span class="ident" id="4745408">conn</span>&nbsp;<span class="ident" id="4745413">io</span><span class="op" id="4745415">.</span><span class="ident" id="4745416">ReadWriteCloser</span><span class="op" id="4745431">)</span>&nbsp;<span class="ident" id="4745433">rpc</span><span class="op" id="4745436">.</span><span class="ident" id="4745437">ClientCodec</span>&nbsp;<span class="op" id="4745449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4745452">return</span>&nbsp;<span class="op" id="4745459">&amp;</span><span class="ident" id="4745460">clientCodec</span><span class="op" id="4745471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745475">dec</span><span class="op" id="4745478">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745484">json</span><span class="op" id="4745488">.</span><span class="ident" id="4745489">NewDecoder</span><span class="op" id="4745499">(</span><span class="ident" id="4745500">conn</span><span class="op" id="4745504">)</span><span class="op" id="4745505">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745509">enc</span><span class="op" id="4745512">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745518">json</span><span class="op" id="4745522">.</span><span class="ident" id="4745523">NewEncoder</span><span class="op" id="4745533">(</span><span class="ident" id="4745534">conn</span><span class="op" id="4745538">)</span><span class="op" id="4745539">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745543">c</span><span class="op" id="4745544">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745552">conn</span><span class="op" id="4745556">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745560">pending</span><span class="op" id="4745567">:</span>&nbsp;<span class="builtinfunc" id="4745569">make</span><span class="op" id="4745573">(</span><span class="keyword" id="4745574">map</span><span class="op" id="4745577">[</span><span class="ident" id="4745578">uint64</span><span class="op" id="4745584">]</span><span class="builtintype" id="4745585">string</span><span class="op" id="4745591">)</span><span class="op" id="4745592">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4745595">}</span><br>
<span class="lineno"></span><span class="op" id="4745597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="4745600">type</span>&nbsp;<span class="ident" id="4745605">clientRequest</span>&nbsp;<span class="keyword" id="4745619">struct</span>&nbsp;<span class="op" id="4745626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745629">Method</span>&nbsp;<span class="builtintype" id="4745636">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4745651">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745668">Params</span>&nbsp;<span class="op" id="4745675">[</span><span class="num" id="4745676">1</span><span class="op" id="4745677">]</span><span class="keyword" id="4745678">interface</span><span class="op" id="4745687">{</span><span class="op" id="4745688">}</span>&nbsp;<span class="string" id="4745690">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745707">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745714">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4745729">`json:&#34;id&#34;`</span><br>
<span class="lineno"></span><span class="op" id="4745741">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="4745744">func</span>&nbsp;<span class="op" id="4745749">(</span><span class="ident" id="4745750">c</span>&nbsp;<span class="op" id="4745752">*</span><span class="ident" id="4745753">clientCodec</span><span class="op" id="4745764">)</span>&nbsp;<span class="ident" id="4745766">WriteRequest</span><span class="op" id="4745778">(</span><span class="ident" id="4745779">r</span>&nbsp;<span class="op" id="4745781">*</span><span class="ident" id="4745782">rpc</span><span class="op" id="4745785">.</span><span class="ident" id="4745786">Request</span><span class="op" id="4745793">,</span>&nbsp;<span class="ident" id="4745795">param</span>&nbsp;<span class="keyword" id="4745801">interface</span><span class="op" id="4745810">{</span><span class="op" id="4745811">}</span><span class="op" id="4745812">)</span>&nbsp;<span class="builtintype" id="4745814">error</span>&nbsp;<span class="op" id="4745820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745823">c</span><span class="op" id="4745824">.</span><span class="ident" id="4745825">mutex</span><span class="op" id="4745830">.</span><span class="ident" id="4745831">Lock</span><span class="op" id="4745835">(</span><span class="op" id="4745836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745839">c</span><span class="op" id="4745840">.</span><span class="ident" id="4745841">pending</span><span class="op" id="4745848">[</span><span class="ident" id="4745849">r</span><span class="op" id="4745850">.</span><span class="ident" id="4745851">Seq</span><span class="op" id="4745854">]</span>&nbsp;<span class="op" id="4745856">=</span>&nbsp;<span class="ident" id="4745858">r</span><span class="op" id="4745859">.</span><span class="ident" id="4745860">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745875">c</span><span class="op" id="4745876">.</span><span class="ident" id="4745877">mutex</span><span class="op" id="4745882">.</span><span class="ident" id="4745883">Unlock</span><span class="op" id="4745889">(</span><span class="op" id="4745890">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745893">c</span><span class="op" id="4745894">.</span><span class="ident" id="4745895">req</span><span class="op" id="4745898">.</span><span class="ident" id="4745899">Method</span>&nbsp;<span class="op" id="4745906">=</span>&nbsp;<span class="ident" id="4745908">r</span><span class="op" id="4745909">.</span><span class="ident" id="4745910">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745925">c</span><span class="op" id="4745926">.</span><span class="ident" id="4745927">req</span><span class="op" id="4745930">.</span><span class="ident" id="4745931">Params</span><span class="op" id="4745937">[</span><span class="num" id="4745938">0</span><span class="op" id="4745939">]</span>&nbsp;<span class="op" id="4745941">=</span>&nbsp;<span class="ident" id="4745943">param</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4745950">c</span><span class="op" id="4745951">.</span><span class="ident" id="4745952">req</span><span class="op" id="4745955">.</span><span class="ident" id="4745956">Id</span>&nbsp;<span class="op" id="4745959">=</span>&nbsp;<span class="ident" id="4745961">r</span><span class="op" id="4745962">.</span><span class="ident" id="4745963">Seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4745968">return</span>&nbsp;<span class="ident" id="4745975">c</span><span class="op" id="4745976">.</span><span class="ident" id="4745977">enc</span><span class="op" id="4745980">.</span><span class="ident" id="4745981">Encode</span><span class="op" id="4745987">(</span><span class="op" id="4745988">&amp;</span><span class="ident" id="4745989">c</span><span class="op" id="4745990">.</span><span class="ident" id="4745991">req</span><span class="op" id="4745994">)</span><br>
<span class="lineno"></span><span class="op" id="4745996">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="4745999">type</span>&nbsp;<span class="ident" id="4746004">clientResponse</span>&nbsp;<span class="keyword" id="4746019">struct</span>&nbsp;<span class="op" id="4746026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746029">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746036">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4746053">`json:&#34;id&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746066">Result</span>&nbsp;<span class="op" id="4746073">*</span><span class="ident" id="4746074">json</span><span class="op" id="4746078">.</span><span class="ident" id="4746079">RawMessage</span>&nbsp;<span class="string" id="4746090">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746107">Error</span>&nbsp;&nbsp;<span class="keyword" id="4746114">interface</span><span class="op" id="4746123">{</span><span class="op" id="4746124">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4746131">`json:&#34;error&#34;`</span><br>
<span class="lineno">65</span><span class="op" id="4746146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4746149">func</span>&nbsp;<span class="op" id="4746154">(</span><span class="ident" id="4746155">r</span>&nbsp;<span class="op" id="4746157">*</span><span class="ident" id="4746158">clientResponse</span><span class="op" id="4746172">)</span>&nbsp;<span class="ident" id="4746174">reset</span><span class="op" id="4746179">(</span><span class="op" id="4746180">)</span>&nbsp;<span class="op" id="4746182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746185">r</span><span class="op" id="4746186">.</span><span class="ident" id="4746187">Id</span>&nbsp;<span class="op" id="4746190">=</span>&nbsp;<span class="num" id="4746192">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746195">r</span><span class="op" id="4746196">.</span><span class="ident" id="4746197">Result</span>&nbsp;<span class="op" id="4746204">=</span>&nbsp;<span class="ident" id="4746206">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746211">r</span><span class="op" id="4746212">.</span><span class="ident" id="4746213">Error</span>&nbsp;<span class="op" id="4746219">=</span>&nbsp;<span class="ident" id="4746221">nil</span><br>
<span class="lineno"></span><span class="op" id="4746225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4746228">func</span>&nbsp;<span class="op" id="4746233">(</span><span class="ident" id="4746234">c</span>&nbsp;<span class="op" id="4746236">*</span><span class="ident" id="4746237">clientCodec</span><span class="op" id="4746248">)</span>&nbsp;<span class="ident" id="4746250">ReadResponseHeader</span><span class="op" id="4746268">(</span><span class="ident" id="4746269">r</span>&nbsp;<span class="op" id="4746271">*</span><span class="ident" id="4746272">rpc</span><span class="op" id="4746275">.</span><span class="ident" id="4746276">Response</span><span class="op" id="4746284">)</span>&nbsp;<span class="builtintype" id="4746286">error</span>&nbsp;<span class="op" id="4746292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746295">c</span><span class="op" id="4746296">.</span><span class="ident" id="4746297">resp</span><span class="op" id="4746301">.</span><span class="ident" id="4746302">reset</span><span class="op" id="4746307">(</span><span class="op" id="4746308">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4746311">if</span>&nbsp;<span class="ident" id="4746314">err</span>&nbsp;<span class="op" id="4746318">:=</span>&nbsp;<span class="ident" id="4746321">c</span><span class="op" id="4746322">.</span><span class="ident" id="4746323">dec</span><span class="op" id="4746326">.</span><span class="ident" id="4746327">Decode</span><span class="op" id="4746333">(</span><span class="op" id="4746334">&amp;</span><span class="ident" id="4746335">c</span><span class="op" id="4746336">.</span><span class="ident" id="4746337">resp</span><span class="op" id="4746341">)</span><span class="op" id="4746342">;</span>&nbsp;<span class="ident" id="4746344">err</span>&nbsp;<span class="op" id="4746348">!=</span>&nbsp;<span class="ident" id="4746351">nil</span>&nbsp;<span class="op" id="4746355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4746359">return</span>&nbsp;<span class="ident" id="4746366">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4746371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746375">c</span><span class="op" id="4746376">.</span><span class="ident" id="4746377">mutex</span><span class="op" id="4746382">.</span><span class="ident" id="4746383">Lock</span><span class="op" id="4746387">(</span><span class="op" id="4746388">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746391">r</span><span class="op" id="4746392">.</span><span class="ident" id="4746393">ServiceMethod</span>&nbsp;<span class="op" id="4746407">=</span>&nbsp;<span class="ident" id="4746409">c</span><span class="op" id="4746410">.</span><span class="ident" id="4746411">pending</span><span class="op" id="4746418">[</span><span class="ident" id="4746419">c</span><span class="op" id="4746420">.</span><span class="ident" id="4746421">resp</span><span class="op" id="4746425">.</span><span class="ident" id="4746426">Id</span><span class="op" id="4746428">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4746431">delete</span><span class="op" id="4746437">(</span><span class="ident" id="4746438">c</span><span class="op" id="4746439">.</span><span class="ident" id="4746440">pending</span><span class="op" id="4746447">,</span>&nbsp;<span class="ident" id="4746449">c</span><span class="op" id="4746450">.</span><span class="ident" id="4746451">resp</span><span class="op" id="4746455">.</span><span class="ident" id="4746456">Id</span><span class="op" id="4746458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746461">c</span><span class="op" id="4746462">.</span><span class="ident" id="4746463">mutex</span><span class="op" id="4746468">.</span><span class="ident" id="4746469">Unlock</span><span class="op" id="4746475">(</span><span class="op" id="4746476">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746480">r</span><span class="op" id="4746481">.</span><span class="ident" id="4746482">Error</span>&nbsp;<span class="op" id="4746488">=</span>&nbsp;<span class="string" id="4746490">&#34;&#34;</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746494">r</span><span class="op" id="4746495">.</span><span class="ident" id="4746496">Seq</span>&nbsp;<span class="op" id="4746500">=</span>&nbsp;<span class="ident" id="4746502">c</span><span class="op" id="4746503">.</span><span class="ident" id="4746504">resp</span><span class="op" id="4746508">.</span><span class="ident" id="4746509">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4746513">if</span>&nbsp;<span class="ident" id="4746516">c</span><span class="op" id="4746517">.</span><span class="ident" id="4746518">resp</span><span class="op" id="4746522">.</span><span class="ident" id="4746523">Error</span>&nbsp;<span class="op" id="4746529">!=</span>&nbsp;<span class="ident" id="4746532">nil</span>&nbsp;<span class="op" id="4746536">||</span>&nbsp;<span class="ident" id="4746539">c</span><span class="op" id="4746540">.</span><span class="ident" id="4746541">resp</span><span class="op" id="4746545">.</span><span class="ident" id="4746546">Result</span>&nbsp;<span class="op" id="4746553">==</span>&nbsp;<span class="ident" id="4746556">nil</span>&nbsp;<span class="op" id="4746560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746564">x</span><span class="op" id="4746565">,</span>&nbsp;<span class="ident" id="4746567">ok</span>&nbsp;<span class="op" id="4746570">:=</span>&nbsp;<span class="ident" id="4746573">c</span><span class="op" id="4746574">.</span><span class="ident" id="4746575">resp</span><span class="op" id="4746579">.</span><span class="ident" id="4746580">Error</span><span class="op" id="4746585">.</span><span class="op" id="4746586">(</span><span class="builtintype" id="4746587">string</span><span class="op" id="4746593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4746597">if</span>&nbsp;<span class="op" id="4746600">!</span><span class="ident" id="4746601">ok</span>&nbsp;<span class="op" id="4746604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4746609">return</span>&nbsp;<span class="ident" id="4746616">fmt</span><span class="op" id="4746619">.</span><span class="ident" id="4746620">Errorf</span><span class="op" id="4746626">(</span><span class="string" id="4746627">&#34;invalid&nbsp;error&nbsp;%v&#34;</span><span class="op" id="4746645">,</span>&nbsp;<span class="ident" id="4746647">c</span><span class="op" id="4746648">.</span><span class="ident" id="4746649">resp</span><span class="op" id="4746653">.</span><span class="ident" id="4746654">Error</span><span class="op" id="4746659">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4746663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4746667">if</span>&nbsp;<span class="ident" id="4746670">x</span>&nbsp;<span class="op" id="4746672">==</span>&nbsp;<span class="string" id="4746675">&#34;&#34;</span>&nbsp;<span class="op" id="4746678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746683">x</span>&nbsp;<span class="op" id="4746685">=</span>&nbsp;<span class="string" id="4746687">&#34;unspecified&nbsp;error&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4746709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4746713">r</span><span class="op" id="4746714">.</span><span class="ident" id="4746715">Error</span>&nbsp;<span class="op" id="4746721">=</span>&nbsp;<span class="ident" id="4746723">x</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4746726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4746729">return</span>&nbsp;<span class="ident" id="4746736">nil</span><br>
<span class="lineno"></span><span class="op" id="4746740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4746743">func</span>&nbsp;<span class="op" id="4746748">(</span><span class="ident" id="4746749">c</span>&nbsp;<span class="op" id="4746751">*</span><span class="ident" id="4746752">clientCodec</span><span class="op" id="4746763">)</span>&nbsp;<span class="ident" id="4746765">ReadResponseBody</span><span class="op" id="4746781">(</span><span class="ident" id="4746782">x</span>&nbsp;<span class="keyword" id="4746784">interface</span><span class="op" id="4746793">{</span><span class="op" id="4746794">}</span><span class="op" id="4746795">)</span>&nbsp;<span class="builtintype" id="4746797">error</span>&nbsp;<span class="op" id="4746803">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4746806">if</span>&nbsp;<span class="ident" id="4746809">x</span>&nbsp;<span class="op" id="4746811">==</span>&nbsp;<span class="ident" id="4746814">nil</span>&nbsp;<span class="op" id="4746818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4746822">return</span>&nbsp;<span class="ident" id="4746829">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4746834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4746837">return</span>&nbsp;<span class="ident" id="4746844">json</span><span class="op" id="4746848">.</span><span class="ident" id="4746849">Unmarshal</span><span class="op" id="4746858">(</span><span class="op" id="4746859">*</span><span class="ident" id="4746860">c</span><span class="op" id="4746861">.</span><span class="ident" id="4746862">resp</span><span class="op" id="4746866">.</span><span class="ident" id="4746867">Result</span><span class="op" id="4746873">,</span>&nbsp;<span class="ident" id="4746875">x</span><span class="op" id="4746876">)</span><br>
<span class="lineno"></span><span class="op" id="4746878">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="4746881">func</span>&nbsp;<span class="op" id="4746886">(</span><span class="ident" id="4746887">c</span>&nbsp;<span class="op" id="4746889">*</span><span class="ident" id="4746890">clientCodec</span><span class="op" id="4746901">)</span>&nbsp;<span class="ident" id="4746903">Close</span><span class="op" id="4746908">(</span><span class="op" id="4746909">)</span>&nbsp;<span class="builtintype" id="4746911">error</span>&nbsp;<span class="op" id="4746917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4746920">return</span>&nbsp;<span class="ident" id="4746927">c</span><span class="op" id="4746928">.</span><span class="ident" id="4746929">c</span><span class="op" id="4746930">.</span><span class="ident" id="4746931">Close</span><span class="op" id="4746936">(</span><span class="op" id="4746937">)</span><br>
<span class="lineno"></span><span class="op" id="4746939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="4746942">//&nbsp;NewClient&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.Client&nbsp;to&nbsp;handle&nbsp;requests&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4747006">//&nbsp;set&nbsp;of&nbsp;services&nbsp;at&nbsp;the&nbsp;other&nbsp;end&nbsp;of&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4747061">func</span>&nbsp;<span class="ident" id="4747066">NewClient</span><span class="op" id="4747075">(</span><span class="ident" id="4747076">conn</span>&nbsp;<span class="ident" id="4747081">io</span><span class="op" id="4747083">.</span><span class="ident" id="4747084">ReadWriteCloser</span><span class="op" id="4747099">)</span>&nbsp;<span class="op" id="4747101">*</span><span class="ident" id="4747102">rpc</span><span class="op" id="4747105">.</span><span class="ident" id="4747106">Client</span>&nbsp;<span class="op" id="4747113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4747116">return</span>&nbsp;<span class="ident" id="4747123">rpc</span><span class="op" id="4747126">.</span><span class="ident" id="4747127">NewClientWithCodec</span><span class="op" id="4747145">(</span><span class="ident" id="4747146">NewClientCodec</span><span class="op" id="4747160">(</span><span class="ident" id="4747161">conn</span><span class="op" id="4747165">)</span><span class="op" id="4747166">)</span><br>
<span class="lineno"></span><span class="op" id="4747168">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="4747171">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;a&nbsp;JSON-RPC&nbsp;server&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4747243">func</span>&nbsp;<span class="ident" id="4747248">Dial</span><span class="op" id="4747252">(</span><span class="ident" id="4747253">network</span><span class="op" id="4747260">,</span>&nbsp;<span class="ident" id="4747262">address</span>&nbsp;<span class="builtintype" id="4747270">string</span><span class="op" id="4747276">)</span>&nbsp;<span class="op" id="4747278">(</span><span class="op" id="4747279">*</span><span class="ident" id="4747280">rpc</span><span class="op" id="4747283">.</span><span class="ident" id="4747284">Client</span><span class="op" id="4747290">,</span>&nbsp;<span class="builtintype" id="4747292">error</span><span class="op" id="4747297">)</span>&nbsp;<span class="op" id="4747299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4747302">conn</span><span class="op" id="4747306">,</span>&nbsp;<span class="ident" id="4747308">err</span>&nbsp;<span class="op" id="4747312">:=</span>&nbsp;<span class="ident" id="4747315">net</span><span class="op" id="4747318">.</span><span class="ident" id="4747319">Dial</span><span class="op" id="4747323">(</span><span class="ident" id="4747324">network</span><span class="op" id="4747331">,</span>&nbsp;<span class="ident" id="4747333">address</span><span class="op" id="4747340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4747343">if</span>&nbsp;<span class="ident" id="4747346">err</span>&nbsp;<span class="op" id="4747350">!=</span>&nbsp;<span class="ident" id="4747353">nil</span>&nbsp;<span class="op" id="4747357">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4747361">return</span>&nbsp;<span class="ident" id="4747368">nil</span><span class="op" id="4747371">,</span>&nbsp;<span class="ident" id="4747373">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4747378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4747381">return</span>&nbsp;<span class="ident" id="4747388">NewClient</span><span class="op" id="4747397">(</span><span class="ident" id="4747398">conn</span><span class="op" id="4747402">)</span><span class="op" id="4747403">,</span>&nbsp;<span class="ident" id="4747405">err</span><br>
<span class="lineno"></span><span class="op" id="4747409">}</span>
</div>
</body>
</html>
