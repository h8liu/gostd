<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/bzip2</h2>
<ul>
<li><a href="/gostd/compress/bzip2/bit_reader.go.html">bit_reader.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2.go.html">bzip2.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2_test.go.html">bzip2_test.go</a></li>
<li><a href="/gostd/compress/bzip2/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/compress/bzip2/move_to_front.go.html">move_to_front.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5886611">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5886666">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5886720">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5886771">//&nbsp;Package&nbsp;bzip2&nbsp;implements&nbsp;bzip2&nbsp;decompression.</span><br>
<span class="lineno"></span><span class="keyword" id="5886820">package</span>&nbsp;<span class="ident" id="5886828">bzip2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5886835">import</span>&nbsp;<span class="string" id="5886842">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="5886848">//&nbsp;There&#39;s&nbsp;no&nbsp;RFC&nbsp;for&nbsp;bzip2.&nbsp;I&nbsp;used&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for&nbsp;reference&nbsp;and&nbsp;a&nbsp;lot</span><br>
<span class="lineno"></span><span class="comment" id="5886927">//&nbsp;of&nbsp;guessing:&nbsp;http://en.wikipedia.org/wiki/Bzip2</span><br>
<span class="lineno"></span><span class="comment" id="5886978">//&nbsp;The&nbsp;source&nbsp;code&nbsp;to&nbsp;pyflate&nbsp;was&nbsp;useful&nbsp;for&nbsp;debugging:</span><br>
<span class="lineno"></span><span class="comment" id="5887034">//&nbsp;http://www.paul.sladen.org/projects/pyflate</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="5887082">//&nbsp;A&nbsp;StructuralError&nbsp;is&nbsp;returned&nbsp;when&nbsp;the&nbsp;bzip2&nbsp;data&nbsp;is&nbsp;found&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5887150">//&nbsp;syntactically&nbsp;invalid.</span><br>
<span class="lineno"></span><span class="keyword" id="5887176">type</span>&nbsp;<span class="ident" id="5887181">StructuralError</span>&nbsp;<span class="builtintype" id="5887197">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5887205">func</span>&nbsp;<span class="op" id="5887210">(</span><span class="ident" id="5887211">s</span>&nbsp;<span class="ident" id="5887213">StructuralError</span><span class="op" id="5887228">)</span>&nbsp;<span class="ident" id="5887230">Error</span><span class="op" id="5887235">(</span><span class="op" id="5887236">)</span>&nbsp;<span class="builtintype" id="5887238">string</span>&nbsp;<span class="op" id="5887245">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5887248">return</span>&nbsp;<span class="string" id="5887255">&#34;bzip2&nbsp;data&nbsp;invalid:&nbsp;&#34;</span>&nbsp;<span class="op" id="5887278">+</span>&nbsp;<span class="builtintype" id="5887280">string</span><span class="op" id="5887286">(</span><span class="ident" id="5887287">s</span><span class="op" id="5887288">)</span><br>
<span class="lineno"></span><span class="op" id="5887290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5887293">//&nbsp;A&nbsp;reader&nbsp;decompresses&nbsp;bzip2&nbsp;compressed&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5887341">type</span>&nbsp;<span class="ident" id="5887346">reader</span>&nbsp;<span class="keyword" id="5887353">struct</span>&nbsp;<span class="op" id="5887360">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887363">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5887376">bitReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887387">fileCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5887400">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887408">blockCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5887421">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887429">wantBlockCRC</span>&nbsp;<span class="builtintype" id="5887442">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887450">setupDone</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5887463">bool</span>&nbsp;<span class="comment" id="5887468">//&nbsp;true&nbsp;if&nbsp;we&nbsp;have&nbsp;parsed&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887513">blockSize</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5887526">int</span>&nbsp;&nbsp;<span class="comment" id="5887531">//&nbsp;blockSize&nbsp;in&nbsp;bytes,&nbsp;i.e.&nbsp;900&nbsp;*&nbsp;1024.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887572">eof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5887585">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887591">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5887604">[</span><span class="op" id="5887605">]</span><span class="builtintype" id="5887606">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5887614">//&nbsp;stores&nbsp;Burrows-Wheeler&nbsp;transformed&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887659">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5887672">[</span><span class="num" id="5887673">256</span><span class="op" id="5887676">]</span><span class="builtintype" id="5887677">uint</span>&nbsp;<span class="comment" id="5887682">//&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;for&nbsp;the&nbsp;inverse&nbsp;BWT.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887721">tt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5887734">[</span><span class="op" id="5887735">]</span><span class="builtintype" id="5887736">uint32</span>&nbsp;&nbsp;<span class="comment" id="5887744">//&nbsp;mirrors&nbsp;the&nbsp;`tt&#39;&nbsp;array&nbsp;in&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;and&nbsp;contains&nbsp;the&nbsp;P&nbsp;array&nbsp;in&nbsp;the&nbsp;upper&nbsp;24&nbsp;bits.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887838">tPos</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5887851">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5887861">//&nbsp;Index&nbsp;of&nbsp;the&nbsp;next&nbsp;output&nbsp;byte&nbsp;in&nbsp;tt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887903">preRLE</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5887915">[</span><span class="op" id="5887916">]</span><span class="builtintype" id="5887917">uint32</span>&nbsp;<span class="comment" id="5887924">//&nbsp;contains&nbsp;the&nbsp;RLE&nbsp;data&nbsp;still&nbsp;to&nbsp;be&nbsp;processed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887973">preRLEUsed</span>&nbsp;&nbsp;<span class="builtintype" id="5887985">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5887994">//&nbsp;number&nbsp;of&nbsp;entries&nbsp;of&nbsp;preRLE&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888032">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5888044">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5888053">//&nbsp;the&nbsp;last&nbsp;byte&nbsp;value&nbsp;seen.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888083">byteRepeats</span>&nbsp;<span class="builtintype" id="5888095">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5888104">//&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;lastByte&nbsp;seen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888148">repeats</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5888160">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5888169">//&nbsp;the&nbsp;number&nbsp;of&nbsp;copies&nbsp;of&nbsp;lastByte&nbsp;to&nbsp;output.</span><br>
<span class="lineno"></span><span class="op" id="5888216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5888219">//&nbsp;NewReader&nbsp;returns&nbsp;an&nbsp;io.Reader&nbsp;which&nbsp;decompresses&nbsp;bzip2&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">45</span><span class="comment" id="5888291">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="5888338">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5888400">func</span>&nbsp;<span class="ident" id="5888405">NewReader</span><span class="op" id="5888414">(</span><span class="ident" id="5888415">r</span>&nbsp;<span class="ident" id="5888417">io</span><span class="op" id="5888419">.</span><span class="ident" id="5888420">Reader</span><span class="op" id="5888426">)</span>&nbsp;<span class="ident" id="5888428">io</span><span class="op" id="5888430">.</span><span class="ident" id="5888431">Reader</span>&nbsp;<span class="op" id="5888438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888441">bz2</span>&nbsp;<span class="op" id="5888445">:=</span>&nbsp;<span class="builtinfunc" id="5888448">new</span><span class="op" id="5888451">(</span><span class="ident" id="5888452">reader</span><span class="op" id="5888458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888461">bz2</span><span class="op" id="5888464">.</span><span class="ident" id="5888465">br</span>&nbsp;<span class="op" id="5888468">=</span>&nbsp;<span class="ident" id="5888470">newBitReader</span><span class="op" id="5888482">(</span><span class="ident" id="5888483">r</span><span class="op" id="5888484">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888487">return</span>&nbsp;<span class="ident" id="5888494">bz2</span><br>
<span class="lineno"></span><span class="op" id="5888498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5888501">const</span>&nbsp;<span class="ident" id="5888507">bzip2FileMagic</span>&nbsp;<span class="op" id="5888522">=</span>&nbsp;<span class="num" id="5888524">0x425a</span>&nbsp;<span class="comment" id="5888531">//&nbsp;&#34;BZ&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="5888539">const</span>&nbsp;<span class="ident" id="5888545">bzip2BlockMagic</span>&nbsp;<span class="op" id="5888561">=</span>&nbsp;<span class="num" id="5888563">0x314159265359</span><br>
<span class="lineno">55</span><span class="keyword" id="5888578">const</span>&nbsp;<span class="ident" id="5888584">bzip2FinalMagic</span>&nbsp;<span class="op" id="5888600">=</span>&nbsp;<span class="num" id="5888602">0x177245385090</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5888618">//&nbsp;setup&nbsp;parses&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5888652">func</span>&nbsp;<span class="op" id="5888657">(</span><span class="ident" id="5888658">bz2</span>&nbsp;<span class="op" id="5888662">*</span><span class="ident" id="5888663">reader</span><span class="op" id="5888669">)</span>&nbsp;<span class="ident" id="5888671">setup</span><span class="op" id="5888676">(</span><span class="ident" id="5888677">needMagic</span>&nbsp;<span class="builtintype" id="5888687">bool</span><span class="op" id="5888691">)</span>&nbsp;<span class="builtintype" id="5888693">error</span>&nbsp;<span class="op" id="5888699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888702">br</span>&nbsp;<span class="op" id="5888705">:=</span>&nbsp;<span class="op" id="5888708">&amp;</span><span class="ident" id="5888709">bz2</span><span class="op" id="5888712">.</span><span class="ident" id="5888713">br</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888718">if</span>&nbsp;<span class="ident" id="5888721">needMagic</span>&nbsp;<span class="op" id="5888731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888735">magic</span>&nbsp;<span class="op" id="5888741">:=</span>&nbsp;<span class="ident" id="5888744">br</span><span class="op" id="5888746">.</span><span class="ident" id="5888747">ReadBits</span><span class="op" id="5888755">(</span><span class="num" id="5888756">16</span><span class="op" id="5888758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888762">if</span>&nbsp;<span class="ident" id="5888765">magic</span>&nbsp;<span class="op" id="5888771">!=</span>&nbsp;<span class="ident" id="5888774">bzip2FileMagic</span>&nbsp;<span class="op" id="5888789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888794">return</span>&nbsp;<span class="ident" id="5888801">StructuralError</span><span class="op" id="5888816">(</span><span class="string" id="5888817">&#34;bad&nbsp;magic&nbsp;value&#34;</span><span class="op" id="5888834">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5888838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5888841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888845">t</span>&nbsp;<span class="op" id="5888847">:=</span>&nbsp;<span class="ident" id="5888850">br</span><span class="op" id="5888852">.</span><span class="ident" id="5888853">ReadBits</span><span class="op" id="5888861">(</span><span class="num" id="5888862">8</span><span class="op" id="5888863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888866">if</span>&nbsp;<span class="ident" id="5888869">t</span>&nbsp;<span class="op" id="5888871">!=</span>&nbsp;<span class="string" id="5888874">&#39;h&#39;</span>&nbsp;<span class="op" id="5888878">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888882">return</span>&nbsp;<span class="ident" id="5888889">StructuralError</span><span class="op" id="5888904">(</span><span class="string" id="5888905">&#34;non-Huffman&nbsp;entropy&nbsp;encoding&#34;</span><span class="op" id="5888935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5888938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888942">level</span>&nbsp;<span class="op" id="5888948">:=</span>&nbsp;<span class="ident" id="5888951">br</span><span class="op" id="5888953">.</span><span class="ident" id="5888954">ReadBits</span><span class="op" id="5888962">(</span><span class="num" id="5888963">8</span><span class="op" id="5888964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888967">if</span>&nbsp;<span class="ident" id="5888970">level</span>&nbsp;<span class="op" id="5888976">&lt;</span>&nbsp;<span class="string" id="5888978">&#39;1&#39;</span>&nbsp;<span class="op" id="5888982">||</span>&nbsp;<span class="ident" id="5888985">level</span>&nbsp;<span class="op" id="5888991">&gt;</span>&nbsp;<span class="string" id="5888993">&#39;9&#39;</span>&nbsp;<span class="op" id="5888997">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889001">return</span>&nbsp;<span class="ident" id="5889008">StructuralError</span><span class="op" id="5889023">(</span><span class="string" id="5889024">&#34;invalid&nbsp;compression&nbsp;level&#34;</span><span class="op" id="5889051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5889054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889058">bz2</span><span class="op" id="5889061">.</span><span class="ident" id="5889062">fileCRC</span>&nbsp;<span class="op" id="5889070">=</span>&nbsp;<span class="num" id="5889072">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889075">bz2</span><span class="op" id="5889078">.</span><span class="ident" id="5889079">blockSize</span>&nbsp;<span class="op" id="5889089">=</span>&nbsp;<span class="num" id="5889091">100</span>&nbsp;<span class="op" id="5889095">*</span>&nbsp;<span class="num" id="5889097">1024</span>&nbsp;<span class="op" id="5889102">*</span>&nbsp;<span class="op" id="5889104">(</span><span class="builtintype" id="5889105">int</span><span class="op" id="5889108">(</span><span class="ident" id="5889109">level</span><span class="op" id="5889114">)</span>&nbsp;<span class="op" id="5889116">-</span>&nbsp;<span class="string" id="5889118">&#39;0&#39;</span><span class="op" id="5889121">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889124">if</span>&nbsp;<span class="ident" id="5889127">bz2</span><span class="op" id="5889130">.</span><span class="ident" id="5889131">blockSize</span>&nbsp;<span class="op" id="5889141">&gt;</span>&nbsp;<span class="builtinfunc" id="5889143">len</span><span class="op" id="5889146">(</span><span class="ident" id="5889147">bz2</span><span class="op" id="5889150">.</span><span class="ident" id="5889151">tt</span><span class="op" id="5889153">)</span>&nbsp;<span class="op" id="5889155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889159">bz2</span><span class="op" id="5889162">.</span><span class="ident" id="5889163">tt</span>&nbsp;<span class="op" id="5889166">=</span>&nbsp;<span class="builtinfunc" id="5889168">make</span><span class="op" id="5889172">(</span><span class="op" id="5889173">[</span><span class="op" id="5889174">]</span><span class="builtintype" id="5889175">uint32</span><span class="op" id="5889181">,</span>&nbsp;<span class="ident" id="5889183">bz2</span><span class="op" id="5889186">.</span><span class="ident" id="5889187">blockSize</span><span class="op" id="5889196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5889199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889202">return</span>&nbsp;<span class="ident" id="5889209">nil</span><br>
<span class="lineno"></span><span class="op" id="5889213">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="5889216">func</span>&nbsp;<span class="op" id="5889221">(</span><span class="ident" id="5889222">bz2</span>&nbsp;<span class="op" id="5889226">*</span><span class="ident" id="5889227">reader</span><span class="op" id="5889233">)</span>&nbsp;<span class="ident" id="5889235">Read</span><span class="op" id="5889239">(</span><span class="ident" id="5889240">buf</span>&nbsp;<span class="op" id="5889244">[</span><span class="op" id="5889245">]</span><span class="builtintype" id="5889246">byte</span><span class="op" id="5889250">)</span>&nbsp;<span class="op" id="5889252">(</span><span class="ident" id="5889253">n</span>&nbsp;<span class="builtintype" id="5889255">int</span><span class="op" id="5889258">,</span>&nbsp;<span class="ident" id="5889260">err</span>&nbsp;<span class="builtintype" id="5889264">error</span><span class="op" id="5889269">)</span>&nbsp;<span class="op" id="5889271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889274">if</span>&nbsp;<span class="ident" id="5889277">bz2</span><span class="op" id="5889280">.</span><span class="ident" id="5889281">eof</span>&nbsp;<span class="op" id="5889285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889289">return</span>&nbsp;<span class="num" id="5889296">0</span><span class="op" id="5889297">,</span>&nbsp;<span class="ident" id="5889299">io</span><span class="op" id="5889301">.</span><span class="ident" id="5889302">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5889307">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889311">if</span>&nbsp;<span class="op" id="5889314">!</span><span class="ident" id="5889315">bz2</span><span class="op" id="5889318">.</span><span class="ident" id="5889319">setupDone</span>&nbsp;<span class="op" id="5889329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889333">err</span>&nbsp;<span class="op" id="5889337">=</span>&nbsp;<span class="ident" id="5889339">bz2</span><span class="op" id="5889342">.</span><span class="ident" id="5889343">setup</span><span class="op" id="5889348">(</span><span class="builtintype" id="5889349">true</span><span class="op" id="5889353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889357">brErr</span>&nbsp;<span class="op" id="5889363">:=</span>&nbsp;<span class="ident" id="5889366">bz2</span><span class="op" id="5889369">.</span><span class="ident" id="5889370">br</span><span class="op" id="5889372">.</span><span class="ident" id="5889373">Err</span><span class="op" id="5889376">(</span><span class="op" id="5889377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889381">if</span>&nbsp;<span class="ident" id="5889384">brErr</span>&nbsp;<span class="op" id="5889390">!=</span>&nbsp;<span class="ident" id="5889393">nil</span>&nbsp;<span class="op" id="5889397">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889402">err</span>&nbsp;<span class="op" id="5889406">=</span>&nbsp;<span class="ident" id="5889408">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5889416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889420">if</span>&nbsp;<span class="ident" id="5889423">err</span>&nbsp;<span class="op" id="5889427">!=</span>&nbsp;<span class="ident" id="5889430">nil</span>&nbsp;<span class="op" id="5889434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889439">return</span>&nbsp;<span class="num" id="5889446">0</span><span class="op" id="5889447">,</span>&nbsp;<span class="ident" id="5889449">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5889455">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889459">bz2</span><span class="op" id="5889462">.</span><span class="ident" id="5889463">setupDone</span>&nbsp;<span class="op" id="5889473">=</span>&nbsp;<span class="builtintype" id="5889475">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5889481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889485">n</span><span class="op" id="5889486">,</span>&nbsp;<span class="ident" id="5889488">err</span>&nbsp;<span class="op" id="5889492">=</span>&nbsp;<span class="ident" id="5889494">bz2</span><span class="op" id="5889497">.</span><span class="ident" id="5889498">read</span><span class="op" id="5889502">(</span><span class="ident" id="5889503">buf</span><span class="op" id="5889506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889509">brErr</span>&nbsp;<span class="op" id="5889515">:=</span>&nbsp;<span class="ident" id="5889518">bz2</span><span class="op" id="5889521">.</span><span class="ident" id="5889522">br</span><span class="op" id="5889524">.</span><span class="ident" id="5889525">Err</span><span class="op" id="5889528">(</span><span class="op" id="5889529">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889532">if</span>&nbsp;<span class="ident" id="5889535">brErr</span>&nbsp;<span class="op" id="5889541">!=</span>&nbsp;<span class="ident" id="5889544">nil</span>&nbsp;<span class="op" id="5889548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889552">err</span>&nbsp;<span class="op" id="5889556">=</span>&nbsp;<span class="ident" id="5889558">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5889565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889568">return</span><br>
<span class="lineno"></span><span class="op" id="5889575">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="5889578">func</span>&nbsp;<span class="op" id="5889583">(</span><span class="ident" id="5889584">bz2</span>&nbsp;<span class="op" id="5889588">*</span><span class="ident" id="5889589">reader</span><span class="op" id="5889595">)</span>&nbsp;<span class="ident" id="5889597">readFromBlock</span><span class="op" id="5889610">(</span><span class="ident" id="5889611">buf</span>&nbsp;<span class="op" id="5889615">[</span><span class="op" id="5889616">]</span><span class="builtintype" id="5889617">byte</span><span class="op" id="5889621">)</span>&nbsp;<span class="builtintype" id="5889623">int</span>&nbsp;<span class="op" id="5889627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5889630">//&nbsp;bzip2&nbsp;is&nbsp;a&nbsp;block&nbsp;based&nbsp;compressor,&nbsp;except&nbsp;that&nbsp;it&nbsp;has&nbsp;a&nbsp;run-length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5889701">//&nbsp;preprocessing&nbsp;step.&nbsp;The&nbsp;block&nbsp;based&nbsp;nature&nbsp;means&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5889766">//&nbsp;preallocate&nbsp;fixed-size&nbsp;buffers&nbsp;and&nbsp;reuse&nbsp;them.&nbsp;However,&nbsp;the&nbsp;RLE</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5889834">//&nbsp;preprocessing&nbsp;would&nbsp;require&nbsp;allocating&nbsp;huge&nbsp;buffers&nbsp;to&nbsp;store&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5889903">//&nbsp;maximum&nbsp;expansion.&nbsp;Thus&nbsp;we&nbsp;process&nbsp;blocks&nbsp;all&nbsp;at&nbsp;once,&nbsp;except&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5889973">//&nbsp;the&nbsp;RLE&nbsp;which&nbsp;we&nbsp;decompress&nbsp;as&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890018">n</span>&nbsp;<span class="op" id="5890020">:=</span>&nbsp;<span class="num" id="5890023">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890026">for</span>&nbsp;<span class="op" id="5890030">(</span><span class="ident" id="5890031">bz2</span><span class="op" id="5890034">.</span><span class="ident" id="5890035">repeats</span>&nbsp;<span class="op" id="5890043">&gt;</span>&nbsp;<span class="num" id="5890045">0</span>&nbsp;<span class="op" id="5890047">||</span>&nbsp;<span class="ident" id="5890050">bz2</span><span class="op" id="5890053">.</span><span class="ident" id="5890054">preRLEUsed</span>&nbsp;<span class="op" id="5890065">&lt;</span>&nbsp;<span class="builtinfunc" id="5890067">len</span><span class="op" id="5890070">(</span><span class="ident" id="5890071">bz2</span><span class="op" id="5890074">.</span><span class="ident" id="5890075">preRLE</span><span class="op" id="5890081">)</span><span class="op" id="5890082">)</span>&nbsp;<span class="op" id="5890084">&amp;&amp;</span>&nbsp;<span class="ident" id="5890087">n</span>&nbsp;<span class="op" id="5890089">&lt;</span>&nbsp;<span class="builtinfunc" id="5890091">len</span><span class="op" id="5890094">(</span><span class="ident" id="5890095">buf</span><span class="op" id="5890098">)</span>&nbsp;<span class="op" id="5890100">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890104">//&nbsp;We&nbsp;have&nbsp;RLE&nbsp;data&nbsp;pending.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890136">//&nbsp;The&nbsp;run-length&nbsp;encoding&nbsp;works&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890182">//&nbsp;Any&nbsp;sequence&nbsp;of&nbsp;four&nbsp;equal&nbsp;bytes&nbsp;is&nbsp;followed&nbsp;by&nbsp;a&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890244">//&nbsp;byte&nbsp;which&nbsp;contains&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;that&nbsp;byte&nbsp;to</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890307">//&nbsp;include.&nbsp;(The&nbsp;number&nbsp;of&nbsp;repeats&nbsp;can&nbsp;be&nbsp;zero.)&nbsp;Because&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890373">//&nbsp;decompressing&nbsp;on-demand&nbsp;our&nbsp;state&nbsp;is&nbsp;kept&nbsp;in&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890434">//&nbsp;object.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890448">if</span>&nbsp;<span class="ident" id="5890451">bz2</span><span class="op" id="5890454">.</span><span class="ident" id="5890455">repeats</span>&nbsp;<span class="op" id="5890463">&gt;</span>&nbsp;<span class="num" id="5890465">0</span>&nbsp;<span class="op" id="5890467">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890472">buf</span><span class="op" id="5890475">[</span><span class="ident" id="5890476">n</span><span class="op" id="5890477">]</span>&nbsp;<span class="op" id="5890479">=</span>&nbsp;<span class="builtintype" id="5890481">byte</span><span class="op" id="5890485">(</span><span class="ident" id="5890486">bz2</span><span class="op" id="5890489">.</span><span class="ident" id="5890490">lastByte</span><span class="op" id="5890498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890503">n</span><span class="op" id="5890504">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890510">bz2</span><span class="op" id="5890513">.</span><span class="ident" id="5890514">repeats</span><span class="op" id="5890521">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890527">if</span>&nbsp;<span class="ident" id="5890530">bz2</span><span class="op" id="5890533">.</span><span class="ident" id="5890534">repeats</span>&nbsp;<span class="op" id="5890542">==</span>&nbsp;<span class="num" id="5890545">0</span>&nbsp;<span class="op" id="5890547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890553">bz2</span><span class="op" id="5890556">.</span><span class="ident" id="5890557">lastByte</span>&nbsp;<span class="op" id="5890566">=</span>&nbsp;<span class="op" id="5890568">-</span><span class="num" id="5890569">1</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5890574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890579">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5890590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890595">bz2</span><span class="op" id="5890598">.</span><span class="ident" id="5890599">tPos</span>&nbsp;<span class="op" id="5890604">=</span>&nbsp;<span class="ident" id="5890606">bz2</span><span class="op" id="5890609">.</span><span class="ident" id="5890610">preRLE</span><span class="op" id="5890616">[</span><span class="ident" id="5890617">bz2</span><span class="op" id="5890620">.</span><span class="ident" id="5890621">tPos</span><span class="op" id="5890625">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890629">b</span>&nbsp;<span class="op" id="5890631">:=</span>&nbsp;<span class="builtintype" id="5890634">byte</span><span class="op" id="5890638">(</span><span class="ident" id="5890639">bz2</span><span class="op" id="5890642">.</span><span class="ident" id="5890643">tPos</span><span class="op" id="5890647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890651">bz2</span><span class="op" id="5890654">.</span><span class="ident" id="5890655">tPos</span>&nbsp;<span class="op" id="5890660">&gt;&gt;=</span>&nbsp;<span class="num" id="5890664">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890668">bz2</span><span class="op" id="5890671">.</span><span class="ident" id="5890672">preRLEUsed</span><span class="op" id="5890682">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890688">if</span>&nbsp;<span class="ident" id="5890691">bz2</span><span class="op" id="5890694">.</span><span class="ident" id="5890695">byteRepeats</span>&nbsp;<span class="op" id="5890707">==</span>&nbsp;<span class="num" id="5890710">3</span>&nbsp;<span class="op" id="5890712">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890717">bz2</span><span class="op" id="5890720">.</span><span class="ident" id="5890721">repeats</span>&nbsp;<span class="op" id="5890729">=</span>&nbsp;<span class="builtintype" id="5890731">uint</span><span class="op" id="5890735">(</span><span class="ident" id="5890736">b</span><span class="op" id="5890737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890742">bz2</span><span class="op" id="5890745">.</span><span class="ident" id="5890746">byteRepeats</span>&nbsp;<span class="op" id="5890758">=</span>&nbsp;<span class="num" id="5890760">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890765">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5890776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890781">if</span>&nbsp;<span class="ident" id="5890784">bz2</span><span class="op" id="5890787">.</span><span class="ident" id="5890788">lastByte</span>&nbsp;<span class="op" id="5890797">==</span>&nbsp;<span class="builtintype" id="5890800">int</span><span class="op" id="5890803">(</span><span class="ident" id="5890804">b</span><span class="op" id="5890805">)</span>&nbsp;<span class="op" id="5890807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890812">bz2</span><span class="op" id="5890815">.</span><span class="ident" id="5890816">byteRepeats</span><span class="op" id="5890827">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5890832">}</span>&nbsp;<span class="keyword" id="5890834">else</span>&nbsp;<span class="op" id="5890839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890844">bz2</span><span class="op" id="5890847">.</span><span class="ident" id="5890848">byteRepeats</span>&nbsp;<span class="op" id="5890860">=</span>&nbsp;<span class="num" id="5890862">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5890866">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890870">bz2</span><span class="op" id="5890873">.</span><span class="ident" id="5890874">lastByte</span>&nbsp;<span class="op" id="5890883">=</span>&nbsp;<span class="builtintype" id="5890885">int</span><span class="op" id="5890888">(</span><span class="ident" id="5890889">b</span><span class="op" id="5890890">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890895">buf</span><span class="op" id="5890898">[</span><span class="ident" id="5890899">n</span><span class="op" id="5890900">]</span>&nbsp;<span class="op" id="5890902">=</span>&nbsp;<span class="ident" id="5890904">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890908">n</span><span class="op" id="5890909">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5890913">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890917">return</span>&nbsp;<span class="ident" id="5890924">n</span><br>
<span class="lineno"></span><span class="op" id="5890926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5890929">func</span>&nbsp;<span class="op" id="5890934">(</span><span class="ident" id="5890935">bz2</span>&nbsp;<span class="op" id="5890939">*</span><span class="ident" id="5890940">reader</span><span class="op" id="5890946">)</span>&nbsp;<span class="ident" id="5890948">read</span><span class="op" id="5890952">(</span><span class="ident" id="5890953">buf</span>&nbsp;<span class="op" id="5890957">[</span><span class="op" id="5890958">]</span><span class="builtintype" id="5890959">byte</span><span class="op" id="5890963">)</span>&nbsp;<span class="op" id="5890965">(</span><span class="builtintype" id="5890966">int</span><span class="op" id="5890969">,</span>&nbsp;<span class="builtintype" id="5890971">error</span><span class="op" id="5890976">)</span>&nbsp;<span class="op" id="5890978">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890981">for</span>&nbsp;<span class="op" id="5890985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890989">n</span>&nbsp;<span class="op" id="5890991">:=</span>&nbsp;<span class="ident" id="5890994">bz2</span><span class="op" id="5890997">.</span><span class="ident" id="5890998">readFromBlock</span><span class="op" id="5891011">(</span><span class="ident" id="5891012">buf</span><span class="op" id="5891015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891019">if</span>&nbsp;<span class="ident" id="5891022">n</span>&nbsp;<span class="op" id="5891024">&gt;</span>&nbsp;<span class="num" id="5891026">0</span>&nbsp;<span class="op" id="5891028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891033">bz2</span><span class="op" id="5891036">.</span><span class="ident" id="5891037">blockCRC</span>&nbsp;<span class="op" id="5891046">=</span>&nbsp;<span class="ident" id="5891048">updateCRC</span><span class="op" id="5891057">(</span><span class="ident" id="5891058">bz2</span><span class="op" id="5891061">.</span><span class="ident" id="5891062">blockCRC</span><span class="op" id="5891070">,</span>&nbsp;<span class="ident" id="5891072">buf</span><span class="op" id="5891075">[</span><span class="op" id="5891076">:</span><span class="ident" id="5891077">n</span><span class="op" id="5891078">]</span><span class="op" id="5891079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891084">return</span>&nbsp;<span class="ident" id="5891091">n</span><span class="op" id="5891092">,</span>&nbsp;<span class="ident" id="5891094">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891105">//&nbsp;End&nbsp;of&nbsp;block.&nbsp;Check&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891135">if</span>&nbsp;<span class="ident" id="5891138">bz2</span><span class="op" id="5891141">.</span><span class="ident" id="5891142">blockCRC</span>&nbsp;<span class="op" id="5891151">!=</span>&nbsp;<span class="ident" id="5891154">bz2</span><span class="op" id="5891157">.</span><span class="ident" id="5891158">wantBlockCRC</span>&nbsp;<span class="op" id="5891171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891176">bz2</span><span class="op" id="5891179">.</span><span class="ident" id="5891180">br</span><span class="op" id="5891182">.</span><span class="ident" id="5891183">err</span>&nbsp;<span class="op" id="5891187">=</span>&nbsp;<span class="ident" id="5891189">StructuralError</span><span class="op" id="5891204">(</span><span class="string" id="5891205">&#34;block&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="5891230">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891235">return</span>&nbsp;<span class="num" id="5891242">0</span><span class="op" id="5891243">,</span>&nbsp;<span class="ident" id="5891245">bz2</span><span class="op" id="5891248">.</span><span class="ident" id="5891249">br</span><span class="op" id="5891251">.</span><span class="ident" id="5891252">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891263">//&nbsp;Find&nbsp;next&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891285">br</span>&nbsp;<span class="op" id="5891288">:=</span>&nbsp;<span class="op" id="5891291">&amp;</span><span class="ident" id="5891292">bz2</span><span class="op" id="5891295">.</span><span class="ident" id="5891296">br</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891301">switch</span>&nbsp;<span class="ident" id="5891308">br</span><span class="op" id="5891310">.</span><span class="ident" id="5891311">ReadBits64</span><span class="op" id="5891321">(</span><span class="num" id="5891322">48</span><span class="op" id="5891324">)</span>&nbsp;<span class="op" id="5891326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891330">default</span><span class="op" id="5891337">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891342">return</span>&nbsp;<span class="num" id="5891349">0</span><span class="op" id="5891350">,</span>&nbsp;<span class="ident" id="5891352">StructuralError</span><span class="op" id="5891367">(</span><span class="string" id="5891368">&#34;bad&nbsp;magic&nbsp;value&nbsp;found&#34;</span><span class="op" id="5891391">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891396">case</span>&nbsp;<span class="ident" id="5891401">bzip2BlockMagic</span><span class="op" id="5891416">:</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891421">//&nbsp;Start&nbsp;of&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891443">err</span>&nbsp;<span class="op" id="5891447">:=</span>&nbsp;<span class="ident" id="5891450">bz2</span><span class="op" id="5891453">.</span><span class="ident" id="5891454">readBlock</span><span class="op" id="5891463">(</span><span class="op" id="5891464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891469">if</span>&nbsp;<span class="ident" id="5891472">err</span>&nbsp;<span class="op" id="5891476">!=</span>&nbsp;<span class="ident" id="5891479">nil</span>&nbsp;<span class="op" id="5891483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891489">return</span>&nbsp;<span class="num" id="5891496">0</span><span class="op" id="5891497">,</span>&nbsp;<span class="ident" id="5891499">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891506">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891511">case</span>&nbsp;<span class="ident" id="5891516">bzip2FinalMagic</span><span class="op" id="5891531">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891536">//&nbsp;Check&nbsp;end-of-file&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891565">wantFileCRC</span>&nbsp;<span class="op" id="5891577">:=</span>&nbsp;<span class="builtintype" id="5891580">uint32</span><span class="op" id="5891586">(</span><span class="ident" id="5891587">br</span><span class="op" id="5891589">.</span><span class="ident" id="5891590">ReadBits64</span><span class="op" id="5891600">(</span><span class="num" id="5891601">32</span><span class="op" id="5891603">)</span><span class="op" id="5891604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891609">if</span>&nbsp;<span class="ident" id="5891612">br</span><span class="op" id="5891614">.</span><span class="ident" id="5891615">err</span>&nbsp;<span class="op" id="5891619">!=</span>&nbsp;<span class="ident" id="5891622">nil</span>&nbsp;<span class="op" id="5891626">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891632">return</span>&nbsp;<span class="num" id="5891639">0</span><span class="op" id="5891640">,</span>&nbsp;<span class="ident" id="5891642">br</span><span class="op" id="5891644">.</span><span class="ident" id="5891645">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891657">if</span>&nbsp;<span class="ident" id="5891660">bz2</span><span class="op" id="5891663">.</span><span class="ident" id="5891664">fileCRC</span>&nbsp;<span class="op" id="5891672">!=</span>&nbsp;<span class="ident" id="5891675">wantFileCRC</span>&nbsp;<span class="op" id="5891687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891693">br</span><span class="op" id="5891695">.</span><span class="ident" id="5891696">err</span>&nbsp;<span class="op" id="5891700">=</span>&nbsp;<span class="ident" id="5891702">StructuralError</span><span class="op" id="5891717">(</span><span class="string" id="5891718">&#34;file&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="5891742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891748">return</span>&nbsp;<span class="num" id="5891755">0</span><span class="op" id="5891756">,</span>&nbsp;<span class="ident" id="5891758">br</span><span class="op" id="5891760">.</span><span class="ident" id="5891761">err</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891774">//&nbsp;Skip&nbsp;ahead&nbsp;to&nbsp;byte&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891809">//&nbsp;Is&nbsp;there&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;to&nbsp;this&nbsp;one?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891857">//&nbsp;It&nbsp;would&nbsp;start&nbsp;with&nbsp;BZ.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891887">if</span>&nbsp;<span class="ident" id="5891890">br</span><span class="op" id="5891892">.</span><span class="ident" id="5891893">bits</span><span class="op" id="5891897">%</span><span class="num" id="5891898">8</span>&nbsp;<span class="op" id="5891900">!=</span>&nbsp;<span class="num" id="5891903">0</span>&nbsp;<span class="op" id="5891905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891911">br</span><span class="op" id="5891913">.</span><span class="ident" id="5891914">ReadBits</span><span class="op" id="5891922">(</span><span class="ident" id="5891923">br</span><span class="op" id="5891925">.</span><span class="ident" id="5891926">bits</span>&nbsp;<span class="op" id="5891931">%</span>&nbsp;<span class="num" id="5891933">8</span><span class="op" id="5891934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891944">b</span><span class="op" id="5891945">,</span>&nbsp;<span class="ident" id="5891947">err</span>&nbsp;<span class="op" id="5891951">:=</span>&nbsp;<span class="ident" id="5891954">br</span><span class="op" id="5891956">.</span><span class="ident" id="5891957">r</span><span class="op" id="5891958">.</span><span class="ident" id="5891959">ReadByte</span><span class="op" id="5891967">(</span><span class="op" id="5891968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891973">if</span>&nbsp;<span class="ident" id="5891976">err</span>&nbsp;<span class="op" id="5891980">==</span>&nbsp;<span class="ident" id="5891983">io</span><span class="op" id="5891985">.</span><span class="ident" id="5891986">EOF</span>&nbsp;<span class="op" id="5891990">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891996">br</span><span class="op" id="5891998">.</span><span class="ident" id="5891999">err</span>&nbsp;<span class="op" id="5892003">=</span>&nbsp;<span class="ident" id="5892005">io</span><span class="op" id="5892007">.</span><span class="ident" id="5892008">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892016">bz2</span><span class="op" id="5892019">.</span><span class="ident" id="5892020">eof</span>&nbsp;<span class="op" id="5892024">=</span>&nbsp;<span class="builtintype" id="5892026">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892035">return</span>&nbsp;<span class="num" id="5892042">0</span><span class="op" id="5892043">,</span>&nbsp;<span class="ident" id="5892045">io</span><span class="op" id="5892047">.</span><span class="ident" id="5892048">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892060">if</span>&nbsp;<span class="ident" id="5892063">err</span>&nbsp;<span class="op" id="5892067">!=</span>&nbsp;<span class="ident" id="5892070">nil</span>&nbsp;<span class="op" id="5892074">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892080">br</span><span class="op" id="5892082">.</span><span class="ident" id="5892083">err</span>&nbsp;<span class="op" id="5892087">=</span>&nbsp;<span class="ident" id="5892089">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892097">return</span>&nbsp;<span class="num" id="5892104">0</span><span class="op" id="5892105">,</span>&nbsp;<span class="ident" id="5892107">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892119">z</span><span class="op" id="5892120">,</span>&nbsp;<span class="ident" id="5892122">err</span>&nbsp;<span class="op" id="5892126">:=</span>&nbsp;<span class="ident" id="5892129">br</span><span class="op" id="5892131">.</span><span class="ident" id="5892132">r</span><span class="op" id="5892133">.</span><span class="ident" id="5892134">ReadByte</span><span class="op" id="5892142">(</span><span class="op" id="5892143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892148">if</span>&nbsp;<span class="ident" id="5892151">err</span>&nbsp;<span class="op" id="5892155">!=</span>&nbsp;<span class="ident" id="5892158">nil</span>&nbsp;<span class="op" id="5892162">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892168">if</span>&nbsp;<span class="ident" id="5892171">err</span>&nbsp;<span class="op" id="5892175">==</span>&nbsp;<span class="ident" id="5892178">io</span><span class="op" id="5892180">.</span><span class="ident" id="5892181">EOF</span>&nbsp;<span class="op" id="5892185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892192">err</span>&nbsp;<span class="op" id="5892196">=</span>&nbsp;<span class="ident" id="5892198">io</span><span class="op" id="5892200">.</span><span class="ident" id="5892201">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892228">br</span><span class="op" id="5892230">.</span><span class="ident" id="5892231">err</span>&nbsp;<span class="op" id="5892235">=</span>&nbsp;<span class="ident" id="5892237">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892245">return</span>&nbsp;<span class="num" id="5892252">0</span><span class="op" id="5892253">,</span>&nbsp;<span class="ident" id="5892255">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892267">if</span>&nbsp;<span class="ident" id="5892270">b</span>&nbsp;<span class="op" id="5892272">!=</span>&nbsp;<span class="string" id="5892275">&#39;B&#39;</span>&nbsp;<span class="op" id="5892279">||</span>&nbsp;<span class="ident" id="5892282">z</span>&nbsp;<span class="op" id="5892284">!=</span>&nbsp;<span class="string" id="5892287">&#39;Z&#39;</span>&nbsp;<span class="op" id="5892291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892297">return</span>&nbsp;<span class="num" id="5892304">0</span><span class="op" id="5892305">,</span>&nbsp;<span class="ident" id="5892307">StructuralError</span><span class="op" id="5892322">(</span><span class="string" id="5892323">&#34;bad&nbsp;magic&nbsp;value&nbsp;in&nbsp;continuation&nbsp;file&#34;</span><span class="op" id="5892361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892371">if</span>&nbsp;<span class="ident" id="5892374">err</span>&nbsp;<span class="op" id="5892378">:=</span>&nbsp;<span class="ident" id="5892381">bz2</span><span class="op" id="5892384">.</span><span class="ident" id="5892385">setup</span><span class="op" id="5892390">(</span><span class="builtintype" id="5892391">false</span><span class="op" id="5892396">)</span><span class="op" id="5892397">;</span>&nbsp;<span class="ident" id="5892399">err</span>&nbsp;<span class="op" id="5892403">!=</span>&nbsp;<span class="ident" id="5892406">nil</span>&nbsp;<span class="op" id="5892410">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892416">return</span>&nbsp;<span class="num" id="5892423">0</span><span class="op" id="5892424">,</span>&nbsp;<span class="ident" id="5892426">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892440">}</span><br>
<span class="lineno"></span><span class="op" id="5892442">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="5892445">//&nbsp;readBlock&nbsp;reads&nbsp;a&nbsp;bzip2&nbsp;block.&nbsp;The&nbsp;magic&nbsp;number&nbsp;should&nbsp;already&nbsp;have&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span><span class="keyword" id="5892531">func</span>&nbsp;<span class="op" id="5892536">(</span><span class="ident" id="5892537">bz2</span>&nbsp;<span class="op" id="5892541">*</span><span class="ident" id="5892542">reader</span><span class="op" id="5892548">)</span>&nbsp;<span class="ident" id="5892550">readBlock</span><span class="op" id="5892559">(</span><span class="op" id="5892560">)</span>&nbsp;<span class="op" id="5892562">(</span><span class="ident" id="5892563">err</span>&nbsp;<span class="builtintype" id="5892567">error</span><span class="op" id="5892572">)</span>&nbsp;<span class="op" id="5892574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892577">br</span>&nbsp;<span class="op" id="5892580">:=</span>&nbsp;<span class="op" id="5892583">&amp;</span><span class="ident" id="5892584">bz2</span><span class="op" id="5892587">.</span><span class="ident" id="5892588">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892592">bz2</span><span class="op" id="5892595">.</span><span class="ident" id="5892596">wantBlockCRC</span>&nbsp;<span class="op" id="5892609">=</span>&nbsp;<span class="builtintype" id="5892611">uint32</span><span class="op" id="5892617">(</span><span class="ident" id="5892618">br</span><span class="op" id="5892620">.</span><span class="ident" id="5892621">ReadBits64</span><span class="op" id="5892631">(</span><span class="num" id="5892632">32</span><span class="op" id="5892634">)</span><span class="op" id="5892635">)</span>&nbsp;<span class="comment" id="5892637">//&nbsp;skip&nbsp;checksum.&nbsp;TODO:&nbsp;check&nbsp;it&nbsp;if&nbsp;we&nbsp;can&nbsp;figure&nbsp;out&nbsp;what&nbsp;it&nbsp;is.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892704">bz2</span><span class="op" id="5892707">.</span><span class="ident" id="5892708">blockCRC</span>&nbsp;<span class="op" id="5892717">=</span>&nbsp;<span class="num" id="5892719">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892722">bz2</span><span class="op" id="5892725">.</span><span class="ident" id="5892726">fileCRC</span>&nbsp;<span class="op" id="5892734">=</span>&nbsp;<span class="op" id="5892736">(</span><span class="ident" id="5892737">bz2</span><span class="op" id="5892740">.</span><span class="ident" id="5892741">fileCRC</span><span class="op" id="5892748">&lt;&lt;</span><span class="num" id="5892750">1</span>&nbsp;<span class="op" id="5892752">|</span>&nbsp;<span class="ident" id="5892754">bz2</span><span class="op" id="5892757">.</span><span class="ident" id="5892758">fileCRC</span><span class="op" id="5892765">&gt;&gt;</span><span class="num" id="5892767">31</span><span class="op" id="5892769">)</span>&nbsp;<span class="op" id="5892771">^</span>&nbsp;<span class="ident" id="5892773">bz2</span><span class="op" id="5892776">.</span><span class="ident" id="5892777">wantBlockCRC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892791">randomized</span>&nbsp;<span class="op" id="5892802">:=</span>&nbsp;<span class="ident" id="5892805">br</span><span class="op" id="5892807">.</span><span class="ident" id="5892808">ReadBits</span><span class="op" id="5892816">(</span><span class="num" id="5892817">1</span><span class="op" id="5892818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892821">if</span>&nbsp;<span class="ident" id="5892824">randomized</span>&nbsp;<span class="op" id="5892835">!=</span>&nbsp;<span class="num" id="5892838">0</span>&nbsp;<span class="op" id="5892840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892844">return</span>&nbsp;<span class="ident" id="5892851">StructuralError</span><span class="op" id="5892866">(</span><span class="string" id="5892867">&#34;deprecated&nbsp;randomized&nbsp;files&#34;</span><span class="op" id="5892896">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892902">origPtr</span>&nbsp;<span class="op" id="5892910">:=</span>&nbsp;<span class="builtintype" id="5892913">uint</span><span class="op" id="5892917">(</span><span class="ident" id="5892918">br</span><span class="op" id="5892920">.</span><span class="ident" id="5892921">ReadBits</span><span class="op" id="5892929">(</span><span class="num" id="5892930">24</span><span class="op" id="5892932">)</span><span class="op" id="5892933">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5892937">//&nbsp;If&nbsp;not&nbsp;every&nbsp;byte&nbsp;value&nbsp;is&nbsp;used&nbsp;in&nbsp;the&nbsp;block&nbsp;(i.e.,&nbsp;it&#39;s&nbsp;text)&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5893009">//&nbsp;the&nbsp;symbol&nbsp;set&nbsp;is&nbsp;reduced.&nbsp;The&nbsp;symbols&nbsp;used&nbsp;are&nbsp;stored&nbsp;as&nbsp;a</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5893073">//&nbsp;two-level,&nbsp;16x16&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893102">symbolRangeUsedBitmap</span>&nbsp;<span class="op" id="5893124">:=</span>&nbsp;<span class="ident" id="5893127">br</span><span class="op" id="5893129">.</span><span class="ident" id="5893130">ReadBits</span><span class="op" id="5893138">(</span><span class="num" id="5893139">16</span><span class="op" id="5893141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893144">symbolPresent</span>&nbsp;<span class="op" id="5893158">:=</span>&nbsp;<span class="builtinfunc" id="5893161">make</span><span class="op" id="5893165">(</span><span class="op" id="5893166">[</span><span class="op" id="5893167">]</span><span class="builtintype" id="5893168">bool</span><span class="op" id="5893172">,</span>&nbsp;<span class="num" id="5893174">256</span><span class="op" id="5893177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893180">numSymbols</span>&nbsp;<span class="op" id="5893191">:=</span>&nbsp;<span class="num" id="5893194">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893197">for</span>&nbsp;<span class="ident" id="5893201">symRange</span>&nbsp;<span class="op" id="5893210">:=</span>&nbsp;<span class="builtintype" id="5893213">uint</span><span class="op" id="5893217">(</span><span class="num" id="5893218">0</span><span class="op" id="5893219">)</span><span class="op" id="5893220">;</span>&nbsp;<span class="ident" id="5893222">symRange</span>&nbsp;<span class="op" id="5893231">&lt;</span>&nbsp;<span class="num" id="5893233">16</span><span class="op" id="5893235">;</span>&nbsp;<span class="ident" id="5893237">symRange</span><span class="op" id="5893245">++</span>&nbsp;<span class="op" id="5893248">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893252">if</span>&nbsp;<span class="ident" id="5893255">symbolRangeUsedBitmap</span><span class="op" id="5893276">&amp;</span><span class="op" id="5893277">(</span><span class="num" id="5893278">1</span><span class="op" id="5893279">&lt;&lt;</span><span class="op" id="5893281">(</span><span class="num" id="5893282">15</span><span class="op" id="5893284">-</span><span class="ident" id="5893285">symRange</span><span class="op" id="5893293">)</span><span class="op" id="5893294">)</span>&nbsp;<span class="op" id="5893296">!=</span>&nbsp;<span class="num" id="5893299">0</span>&nbsp;<span class="op" id="5893301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893306">bits</span>&nbsp;<span class="op" id="5893311">:=</span>&nbsp;<span class="ident" id="5893314">br</span><span class="op" id="5893316">.</span><span class="ident" id="5893317">ReadBits</span><span class="op" id="5893325">(</span><span class="num" id="5893326">16</span><span class="op" id="5893328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893333">for</span>&nbsp;<span class="ident" id="5893337">symbol</span>&nbsp;<span class="op" id="5893344">:=</span>&nbsp;<span class="builtintype" id="5893347">uint</span><span class="op" id="5893351">(</span><span class="num" id="5893352">0</span><span class="op" id="5893353">)</span><span class="op" id="5893354">;</span>&nbsp;<span class="ident" id="5893356">symbol</span>&nbsp;<span class="op" id="5893363">&lt;</span>&nbsp;<span class="num" id="5893365">16</span><span class="op" id="5893367">;</span>&nbsp;<span class="ident" id="5893369">symbol</span><span class="op" id="5893375">++</span>&nbsp;<span class="op" id="5893378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893384">if</span>&nbsp;<span class="ident" id="5893387">bits</span><span class="op" id="5893391">&amp;</span><span class="op" id="5893392">(</span><span class="num" id="5893393">1</span><span class="op" id="5893394">&lt;&lt;</span><span class="op" id="5893396">(</span><span class="num" id="5893397">15</span><span class="op" id="5893399">-</span><span class="ident" id="5893400">symbol</span><span class="op" id="5893406">)</span><span class="op" id="5893407">)</span>&nbsp;<span class="op" id="5893409">!=</span>&nbsp;<span class="num" id="5893412">0</span>&nbsp;<span class="op" id="5893414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893421">symbolPresent</span><span class="op" id="5893434">[</span><span class="num" id="5893435">16</span><span class="op" id="5893437">*</span><span class="ident" id="5893438">symRange</span><span class="op" id="5893446">+</span><span class="ident" id="5893447">symbol</span><span class="op" id="5893453">]</span>&nbsp;<span class="op" id="5893455">=</span>&nbsp;<span class="builtintype" id="5893457">true</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893467">numSymbols</span><span class="op" id="5893477">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5893484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5893489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5893493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5893496">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893500">if</span>&nbsp;<span class="ident" id="5893503">numSymbols</span>&nbsp;<span class="op" id="5893514">==</span>&nbsp;<span class="num" id="5893517">0</span>&nbsp;<span class="op" id="5893519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5893523">//&nbsp;There&nbsp;must&nbsp;be&nbsp;an&nbsp;EOF&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893557">return</span>&nbsp;<span class="ident" id="5893564">StructuralError</span><span class="op" id="5893579">(</span><span class="string" id="5893580">&#34;no&nbsp;symbols&nbsp;in&nbsp;input&#34;</span><span class="op" id="5893601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5893604">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5893608">//&nbsp;A&nbsp;block&nbsp;uses&nbsp;between&nbsp;two&nbsp;and&nbsp;six&nbsp;different&nbsp;Huffman&nbsp;trees.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893670">numHuffmanTrees</span>&nbsp;<span class="op" id="5893686">:=</span>&nbsp;<span class="ident" id="5893689">br</span><span class="op" id="5893691">.</span><span class="ident" id="5893692">ReadBits</span><span class="op" id="5893700">(</span><span class="num" id="5893701">3</span><span class="op" id="5893702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893705">if</span>&nbsp;<span class="ident" id="5893708">numHuffmanTrees</span>&nbsp;<span class="op" id="5893724">&lt;</span>&nbsp;<span class="num" id="5893726">2</span>&nbsp;<span class="op" id="5893728">||</span>&nbsp;<span class="ident" id="5893731">numHuffmanTrees</span>&nbsp;<span class="op" id="5893747">&gt;</span>&nbsp;<span class="num" id="5893749">6</span>&nbsp;<span class="op" id="5893751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893755">return</span>&nbsp;<span class="ident" id="5893762">StructuralError</span><span class="op" id="5893777">(</span><span class="string" id="5893778">&#34;invalid&nbsp;number&nbsp;of&nbsp;Huffman&nbsp;trees&#34;</span><span class="op" id="5893811">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5893814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5893818">//&nbsp;The&nbsp;Huffman&nbsp;tree&nbsp;can&nbsp;switch&nbsp;every&nbsp;50&nbsp;symbols&nbsp;so&nbsp;there&#39;s&nbsp;a&nbsp;list&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5893888">//&nbsp;tree&nbsp;indexes&nbsp;telling&nbsp;us&nbsp;which&nbsp;tree&nbsp;to&nbsp;use&nbsp;for&nbsp;each&nbsp;50&nbsp;symbol&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893960">numSelectors</span>&nbsp;<span class="op" id="5893973">:=</span>&nbsp;<span class="ident" id="5893976">br</span><span class="op" id="5893978">.</span><span class="ident" id="5893979">ReadBits</span><span class="op" id="5893987">(</span><span class="num" id="5893988">15</span><span class="op" id="5893990">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893993">treeIndexes</span>&nbsp;<span class="op" id="5894005">:=</span>&nbsp;<span class="builtinfunc" id="5894008">make</span><span class="op" id="5894012">(</span><span class="op" id="5894013">[</span><span class="op" id="5894014">]</span><span class="builtintype" id="5894015">uint8</span><span class="op" id="5894020">,</span>&nbsp;<span class="ident" id="5894022">numSelectors</span><span class="op" id="5894034">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5894038">//&nbsp;The&nbsp;tree&nbsp;indexes&nbsp;are&nbsp;move-to-front&nbsp;transformed&nbsp;and&nbsp;stored&nbsp;as&nbsp;unary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5894109">//&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894122">mtfTreeDecoder</span>&nbsp;<span class="op" id="5894137">:=</span>&nbsp;<span class="ident" id="5894140">newMTFDecoderWithRange</span><span class="op" id="5894162">(</span><span class="ident" id="5894163">numHuffmanTrees</span><span class="op" id="5894178">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894181">for</span>&nbsp;<span class="ident" id="5894185">i</span>&nbsp;<span class="op" id="5894187">:=</span>&nbsp;<span class="keyword" id="5894190">range</span>&nbsp;<span class="ident" id="5894196">treeIndexes</span>&nbsp;<span class="op" id="5894208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894212">c</span>&nbsp;<span class="op" id="5894214">:=</span>&nbsp;<span class="num" id="5894217">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894221">for</span>&nbsp;<span class="op" id="5894225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894230">inc</span>&nbsp;<span class="op" id="5894234">:=</span>&nbsp;<span class="ident" id="5894237">br</span><span class="op" id="5894239">.</span><span class="ident" id="5894240">ReadBits</span><span class="op" id="5894248">(</span><span class="num" id="5894249">1</span><span class="op" id="5894250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894255">if</span>&nbsp;<span class="ident" id="5894258">inc</span>&nbsp;<span class="op" id="5894262">==</span>&nbsp;<span class="num" id="5894265">0</span>&nbsp;<span class="op" id="5894267">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894273">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5894282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894287">c</span><span class="op" id="5894288">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5894293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894297">if</span>&nbsp;<span class="ident" id="5894300">c</span>&nbsp;<span class="op" id="5894302">&gt;=</span>&nbsp;<span class="ident" id="5894305">numHuffmanTrees</span>&nbsp;<span class="op" id="5894321">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894326">return</span>&nbsp;<span class="ident" id="5894333">StructuralError</span><span class="op" id="5894348">(</span><span class="string" id="5894349">&#34;tree&nbsp;index&nbsp;too&nbsp;large&#34;</span><span class="op" id="5894371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5894375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894379">treeIndexes</span><span class="op" id="5894390">[</span><span class="ident" id="5894391">i</span><span class="op" id="5894392">]</span>&nbsp;<span class="op" id="5894394">=</span>&nbsp;<span class="builtintype" id="5894396">uint8</span><span class="op" id="5894401">(</span><span class="ident" id="5894402">mtfTreeDecoder</span><span class="op" id="5894416">.</span><span class="ident" id="5894417">Decode</span><span class="op" id="5894423">(</span><span class="ident" id="5894424">c</span><span class="op" id="5894425">)</span><span class="op" id="5894426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5894429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5894433">//&nbsp;The&nbsp;list&nbsp;of&nbsp;symbols&nbsp;for&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;taken&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5894503">//&nbsp;the&nbsp;previously&nbsp;decoded&nbsp;symbol&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894545">symbols</span>&nbsp;<span class="op" id="5894553">:=</span>&nbsp;<span class="builtinfunc" id="5894556">make</span><span class="op" id="5894560">(</span><span class="op" id="5894561">[</span><span class="op" id="5894562">]</span><span class="builtintype" id="5894563">byte</span><span class="op" id="5894567">,</span>&nbsp;<span class="ident" id="5894569">numSymbols</span><span class="op" id="5894579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894582">nextSymbol</span>&nbsp;<span class="op" id="5894593">:=</span>&nbsp;<span class="num" id="5894596">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894599">for</span>&nbsp;<span class="ident" id="5894603">i</span>&nbsp;<span class="op" id="5894605">:=</span>&nbsp;<span class="num" id="5894608">0</span><span class="op" id="5894609">;</span>&nbsp;<span class="ident" id="5894611">i</span>&nbsp;<span class="op" id="5894613">&lt;</span>&nbsp;<span class="num" id="5894615">256</span><span class="op" id="5894618">;</span>&nbsp;<span class="ident" id="5894620">i</span><span class="op" id="5894621">++</span>&nbsp;<span class="op" id="5894624">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894628">if</span>&nbsp;<span class="ident" id="5894631">symbolPresent</span><span class="op" id="5894644">[</span><span class="ident" id="5894645">i</span><span class="op" id="5894646">]</span>&nbsp;<span class="op" id="5894648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894653">symbols</span><span class="op" id="5894660">[</span><span class="ident" id="5894661">nextSymbol</span><span class="op" id="5894671">]</span>&nbsp;<span class="op" id="5894673">=</span>&nbsp;<span class="builtintype" id="5894675">byte</span><span class="op" id="5894679">(</span><span class="ident" id="5894680">i</span><span class="op" id="5894681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894686">nextSymbol</span><span class="op" id="5894696">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5894701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5894704">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894707">mtf</span>&nbsp;<span class="op" id="5894711">:=</span>&nbsp;<span class="ident" id="5894714">newMTFDecoder</span><span class="op" id="5894727">(</span><span class="ident" id="5894728">symbols</span><span class="op" id="5894735">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894739">numSymbols</span>&nbsp;<span class="op" id="5894750">+=</span>&nbsp;<span class="num" id="5894753">2</span>&nbsp;<span class="comment" id="5894755">//&nbsp;to&nbsp;account&nbsp;for&nbsp;RUNA&nbsp;and&nbsp;RUNB&nbsp;symbols</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894796">huffmanTrees</span>&nbsp;<span class="op" id="5894809">:=</span>&nbsp;<span class="builtinfunc" id="5894812">make</span><span class="op" id="5894816">(</span><span class="op" id="5894817">[</span><span class="op" id="5894818">]</span><span class="ident" id="5894819">huffmanTree</span><span class="op" id="5894830">,</span>&nbsp;<span class="ident" id="5894832">numHuffmanTrees</span><span class="op" id="5894847">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5894851">//&nbsp;Now&nbsp;we&nbsp;decode&nbsp;the&nbsp;arrays&nbsp;of&nbsp;code-lengths&nbsp;for&nbsp;each&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894911">lengths</span>&nbsp;<span class="op" id="5894919">:=</span>&nbsp;<span class="builtinfunc" id="5894922">make</span><span class="op" id="5894926">(</span><span class="op" id="5894927">[</span><span class="op" id="5894928">]</span><span class="builtintype" id="5894929">uint8</span><span class="op" id="5894934">,</span>&nbsp;<span class="ident" id="5894936">numSymbols</span><span class="op" id="5894946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894949">for</span>&nbsp;<span class="ident" id="5894953">i</span>&nbsp;<span class="op" id="5894955">:=</span>&nbsp;<span class="keyword" id="5894958">range</span>&nbsp;<span class="ident" id="5894964">huffmanTrees</span>&nbsp;<span class="op" id="5894977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5894981">//&nbsp;The&nbsp;code&nbsp;lengths&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;from&nbsp;a&nbsp;5-bit&nbsp;base&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895046">length</span>&nbsp;<span class="op" id="5895053">:=</span>&nbsp;<span class="ident" id="5895056">br</span><span class="op" id="5895058">.</span><span class="ident" id="5895059">ReadBits</span><span class="op" id="5895067">(</span><span class="num" id="5895068">5</span><span class="op" id="5895069">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895073">for</span>&nbsp;<span class="ident" id="5895077">j</span>&nbsp;<span class="op" id="5895079">:=</span>&nbsp;<span class="keyword" id="5895082">range</span>&nbsp;<span class="ident" id="5895088">lengths</span>&nbsp;<span class="op" id="5895096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895101">for</span>&nbsp;<span class="op" id="5895105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895111">if</span>&nbsp;<span class="op" id="5895114">!</span><span class="ident" id="5895115">br</span><span class="op" id="5895117">.</span><span class="ident" id="5895118">ReadBit</span><span class="op" id="5895125">(</span><span class="op" id="5895126">)</span>&nbsp;<span class="op" id="5895128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895135">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895145">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895151">if</span>&nbsp;<span class="ident" id="5895154">br</span><span class="op" id="5895156">.</span><span class="ident" id="5895157">ReadBit</span><span class="op" id="5895164">(</span><span class="op" id="5895165">)</span>&nbsp;<span class="op" id="5895167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895174">length</span><span class="op" id="5895180">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895187">}</span>&nbsp;<span class="keyword" id="5895189">else</span>&nbsp;<span class="op" id="5895194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895201">length</span><span class="op" id="5895207">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895214">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895224">if</span>&nbsp;<span class="ident" id="5895227">length</span>&nbsp;<span class="op" id="5895234">&lt;</span>&nbsp;<span class="num" id="5895236">0</span>&nbsp;<span class="op" id="5895238">||</span>&nbsp;<span class="ident" id="5895241">length</span>&nbsp;<span class="op" id="5895248">&gt;</span>&nbsp;<span class="num" id="5895250">20</span>&nbsp;<span class="op" id="5895253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895259">return</span>&nbsp;<span class="ident" id="5895266">StructuralError</span><span class="op" id="5895281">(</span><span class="string" id="5895282">&#34;Huffman&nbsp;length&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5895311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895321">lengths</span><span class="op" id="5895328">[</span><span class="ident" id="5895329">j</span><span class="op" id="5895330">]</span>&nbsp;<span class="op" id="5895332">=</span>&nbsp;<span class="builtintype" id="5895334">uint8</span><span class="op" id="5895339">(</span><span class="ident" id="5895340">length</span><span class="op" id="5895346">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895354">huffmanTrees</span><span class="op" id="5895366">[</span><span class="ident" id="5895367">i</span><span class="op" id="5895368">]</span><span class="op" id="5895369">,</span>&nbsp;<span class="ident" id="5895371">err</span>&nbsp;<span class="op" id="5895375">=</span>&nbsp;<span class="ident" id="5895377">newHuffmanTree</span><span class="op" id="5895391">(</span><span class="ident" id="5895392">lengths</span><span class="op" id="5895399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895403">if</span>&nbsp;<span class="ident" id="5895406">err</span>&nbsp;<span class="op" id="5895410">!=</span>&nbsp;<span class="ident" id="5895413">nil</span>&nbsp;<span class="op" id="5895417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895422">return</span>&nbsp;<span class="ident" id="5895429">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895435">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895442">selectorIndex</span>&nbsp;<span class="op" id="5895456">:=</span>&nbsp;<span class="num" id="5895459">1</span>&nbsp;<span class="comment" id="5895461">//&nbsp;the&nbsp;next&nbsp;tree&nbsp;index&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895492">if</span>&nbsp;<span class="builtinfunc" id="5895495">len</span><span class="op" id="5895498">(</span><span class="ident" id="5895499">treeIndexes</span><span class="op" id="5895510">)</span>&nbsp;<span class="op" id="5895512">==</span>&nbsp;<span class="num" id="5895515">0</span>&nbsp;<span class="op" id="5895517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895521">return</span>&nbsp;<span class="ident" id="5895528">StructuralError</span><span class="op" id="5895543">(</span><span class="string" id="5895544">&#34;no&nbsp;tree&nbsp;selectors&nbsp;given&#34;</span><span class="op" id="5895569">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895575">if</span>&nbsp;<span class="builtintype" id="5895578">int</span><span class="op" id="5895581">(</span><span class="ident" id="5895582">treeIndexes</span><span class="op" id="5895593">[</span><span class="num" id="5895594">0</span><span class="op" id="5895595">]</span><span class="op" id="5895596">)</span>&nbsp;<span class="op" id="5895598">&gt;=</span>&nbsp;<span class="builtinfunc" id="5895601">len</span><span class="op" id="5895604">(</span><span class="ident" id="5895605">huffmanTrees</span><span class="op" id="5895617">)</span>&nbsp;<span class="op" id="5895619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895623">return</span>&nbsp;<span class="ident" id="5895630">StructuralError</span><span class="op" id="5895645">(</span><span class="string" id="5895646">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5895674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895680">currentHuffmanTree</span>&nbsp;<span class="op" id="5895699">:=</span>&nbsp;<span class="ident" id="5895702">huffmanTrees</span><span class="op" id="5895714">[</span><span class="ident" id="5895715">treeIndexes</span><span class="op" id="5895726">[</span><span class="num" id="5895727">0</span><span class="op" id="5895728">]</span><span class="op" id="5895729">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895732">bufIndex</span>&nbsp;<span class="op" id="5895741">:=</span>&nbsp;<span class="num" id="5895744">0</span>&nbsp;<span class="comment" id="5895746">//&nbsp;indexes&nbsp;bz2.buf,&nbsp;the&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5895786">//&nbsp;The&nbsp;output&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;run-length&nbsp;encoded&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5895858">//&nbsp;we&nbsp;merge&nbsp;the&nbsp;decoding&nbsp;into&nbsp;the&nbsp;Huffman&nbsp;parsing&nbsp;loop.&nbsp;These&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5895925">//&nbsp;variables&nbsp;accumulate&nbsp;the&nbsp;repeat&nbsp;count.&nbsp;See&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5895995">//&nbsp;details.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896008">repeat</span>&nbsp;<span class="op" id="5896015">:=</span>&nbsp;<span class="num" id="5896018">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896021">repeat_power</span>&nbsp;<span class="op" id="5896034">:=</span>&nbsp;<span class="num" id="5896037">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5896041">//&nbsp;The&nbsp;`C&#39;&nbsp;array&nbsp;(used&nbsp;by&nbsp;the&nbsp;inverse&nbsp;BWT)&nbsp;needs&nbsp;to&nbsp;be&nbsp;zero&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896115">for</span>&nbsp;<span class="ident" id="5896119">i</span>&nbsp;<span class="op" id="5896121">:=</span>&nbsp;<span class="keyword" id="5896124">range</span>&nbsp;<span class="ident" id="5896130">bz2</span><span class="op" id="5896133">.</span><span class="ident" id="5896134">c</span>&nbsp;<span class="op" id="5896136">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896140">bz2</span><span class="op" id="5896143">.</span><span class="ident" id="5896144">c</span><span class="op" id="5896145">[</span><span class="ident" id="5896146">i</span><span class="op" id="5896147">]</span>&nbsp;<span class="op" id="5896149">=</span>&nbsp;<span class="num" id="5896151">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896158">decoded</span>&nbsp;<span class="op" id="5896166">:=</span>&nbsp;<span class="num" id="5896169">0</span>&nbsp;<span class="comment" id="5896171">//&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;symbols&nbsp;decoded&nbsp;by&nbsp;the&nbsp;current&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896233">for</span>&nbsp;<span class="op" id="5896237">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896241">if</span>&nbsp;<span class="ident" id="5896244">decoded</span>&nbsp;<span class="op" id="5896252">==</span>&nbsp;<span class="num" id="5896255">50</span>&nbsp;<span class="op" id="5896258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896263">if</span>&nbsp;<span class="ident" id="5896266">selectorIndex</span>&nbsp;<span class="op" id="5896280">&gt;=</span>&nbsp;<span class="ident" id="5896283">numSelectors</span>&nbsp;<span class="op" id="5896296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896302">return</span>&nbsp;<span class="ident" id="5896309">StructuralError</span><span class="op" id="5896324">(</span><span class="string" id="5896325">&#34;insufficient&nbsp;selector&nbsp;indices&nbsp;for&nbsp;number&nbsp;of&nbsp;symbols&#34;</span><span class="op" id="5896378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896388">if</span>&nbsp;<span class="builtintype" id="5896391">int</span><span class="op" id="5896394">(</span><span class="ident" id="5896395">treeIndexes</span><span class="op" id="5896406">[</span><span class="ident" id="5896407">selectorIndex</span><span class="op" id="5896420">]</span><span class="op" id="5896421">)</span>&nbsp;<span class="op" id="5896423">&gt;=</span>&nbsp;<span class="builtinfunc" id="5896426">len</span><span class="op" id="5896429">(</span><span class="ident" id="5896430">huffmanTrees</span><span class="op" id="5896442">)</span>&nbsp;<span class="op" id="5896444">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896450">return</span>&nbsp;<span class="ident" id="5896457">StructuralError</span><span class="op" id="5896472">(</span><span class="string" id="5896473">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5896501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896511">currentHuffmanTree</span>&nbsp;<span class="op" id="5896530">=</span>&nbsp;<span class="ident" id="5896532">huffmanTrees</span><span class="op" id="5896544">[</span><span class="ident" id="5896545">treeIndexes</span><span class="op" id="5896556">[</span><span class="ident" id="5896557">selectorIndex</span><span class="op" id="5896570">]</span><span class="op" id="5896571">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896576">selectorIndex</span><span class="op" id="5896589">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896595">decoded</span>&nbsp;<span class="op" id="5896603">=</span>&nbsp;<span class="num" id="5896605">0</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896614">v</span>&nbsp;<span class="op" id="5896616">:=</span>&nbsp;<span class="ident" id="5896619">currentHuffmanTree</span><span class="op" id="5896637">.</span><span class="ident" id="5896638">Decode</span><span class="op" id="5896644">(</span><span class="ident" id="5896645">br</span><span class="op" id="5896647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896651">decoded</span><span class="op" id="5896658">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896664">if</span>&nbsp;<span class="ident" id="5896667">v</span>&nbsp;<span class="op" id="5896669">&lt;</span>&nbsp;<span class="num" id="5896671">2</span>&nbsp;<span class="op" id="5896673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5896678">//&nbsp;This&nbsp;is&nbsp;either&nbsp;the&nbsp;RUNA&nbsp;or&nbsp;RUNB&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896724">if</span>&nbsp;<span class="ident" id="5896727">repeat</span>&nbsp;<span class="op" id="5896734">==</span>&nbsp;<span class="num" id="5896737">0</span>&nbsp;<span class="op" id="5896739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896745">repeat_power</span>&nbsp;<span class="op" id="5896758">=</span>&nbsp;<span class="num" id="5896760">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896765">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896770">repeat</span>&nbsp;<span class="op" id="5896777">+=</span>&nbsp;<span class="ident" id="5896780">repeat_power</span>&nbsp;<span class="op" id="5896793">&lt;&lt;</span>&nbsp;<span class="ident" id="5896796">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896801">repeat_power</span>&nbsp;<span class="op" id="5896814">&lt;&lt;=</span>&nbsp;<span class="num" id="5896818">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5896824">//&nbsp;This&nbsp;limit&nbsp;of&nbsp;2&nbsp;million&nbsp;comes&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5896882">//&nbsp;code.&nbsp;It&nbsp;prevents&nbsp;repeat&nbsp;from&nbsp;overflowing.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896931">if</span>&nbsp;<span class="ident" id="5896934">repeat</span>&nbsp;<span class="op" id="5896941">&gt;</span>&nbsp;<span class="num" id="5896943">2</span><span class="op" id="5896944">*</span><span class="num" id="5896945">1024</span><span class="op" id="5896949">*</span><span class="num" id="5896950">1024</span>&nbsp;<span class="op" id="5896955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896961">return</span>&nbsp;<span class="ident" id="5896968">StructuralError</span><span class="op" id="5896983">(</span><span class="string" id="5896984">&#34;repeat&nbsp;count&nbsp;too&nbsp;large&#34;</span><span class="op" id="5897008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897018">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897029">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897034">if</span>&nbsp;<span class="ident" id="5897037">repeat</span>&nbsp;<span class="op" id="5897044">&gt;</span>&nbsp;<span class="num" id="5897046">0</span>&nbsp;<span class="op" id="5897048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5897053">//&nbsp;We&nbsp;have&nbsp;decoded&nbsp;a&nbsp;complete&nbsp;run-length&nbsp;so&nbsp;we&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5897111">//&nbsp;replicate&nbsp;the&nbsp;last&nbsp;output&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897151">if</span>&nbsp;<span class="ident" id="5897154">repeat</span>&nbsp;<span class="op" id="5897161">&gt;</span>&nbsp;<span class="ident" id="5897163">bz2</span><span class="op" id="5897166">.</span><span class="ident" id="5897167">blockSize</span><span class="op" id="5897176">-</span><span class="ident" id="5897177">bufIndex</span>&nbsp;<span class="op" id="5897186">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897192">return</span>&nbsp;<span class="ident" id="5897199">StructuralError</span><span class="op" id="5897214">(</span><span class="string" id="5897215">&#34;repeats&nbsp;past&nbsp;end&nbsp;of&nbsp;block&#34;</span><span class="op" id="5897242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897252">for</span>&nbsp;<span class="ident" id="5897256">i</span>&nbsp;<span class="op" id="5897258">:=</span>&nbsp;<span class="num" id="5897261">0</span><span class="op" id="5897262">;</span>&nbsp;<span class="ident" id="5897264">i</span>&nbsp;<span class="op" id="5897266">&lt;</span>&nbsp;<span class="ident" id="5897268">repeat</span><span class="op" id="5897274">;</span>&nbsp;<span class="ident" id="5897276">i</span><span class="op" id="5897277">++</span>&nbsp;<span class="op" id="5897280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897286">b</span>&nbsp;<span class="op" id="5897288">:=</span>&nbsp;<span class="builtintype" id="5897291">byte</span><span class="op" id="5897295">(</span><span class="ident" id="5897296">mtf</span><span class="op" id="5897299">.</span><span class="ident" id="5897300">First</span><span class="op" id="5897305">(</span><span class="op" id="5897306">)</span><span class="op" id="5897307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897313">bz2</span><span class="op" id="5897316">.</span><span class="ident" id="5897317">tt</span><span class="op" id="5897319">[</span><span class="ident" id="5897320">bufIndex</span><span class="op" id="5897328">]</span>&nbsp;<span class="op" id="5897330">=</span>&nbsp;<span class="builtintype" id="5897332">uint32</span><span class="op" id="5897338">(</span><span class="ident" id="5897339">b</span><span class="op" id="5897340">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897346">bz2</span><span class="op" id="5897349">.</span><span class="ident" id="5897350">c</span><span class="op" id="5897351">[</span><span class="ident" id="5897352">b</span><span class="op" id="5897353">]</span><span class="op" id="5897354">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897361">bufIndex</span><span class="op" id="5897369">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897380">repeat</span>&nbsp;<span class="op" id="5897387">=</span>&nbsp;<span class="num" id="5897389">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897393">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897398">if</span>&nbsp;<span class="builtintype" id="5897401">int</span><span class="op" id="5897404">(</span><span class="ident" id="5897405">v</span><span class="op" id="5897406">)</span>&nbsp;<span class="op" id="5897408">==</span>&nbsp;<span class="ident" id="5897411">numSymbols</span><span class="op" id="5897421">-</span><span class="num" id="5897422">1</span>&nbsp;<span class="op" id="5897424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5897429">//&nbsp;This&nbsp;is&nbsp;the&nbsp;EOF&nbsp;symbol.&nbsp;Because&nbsp;it&#39;s&nbsp;always&nbsp;at&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5897486">//&nbsp;end&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;list,&nbsp;and&nbsp;never&nbsp;gets&nbsp;moved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5897544">//&nbsp;to&nbsp;the&nbsp;front,&nbsp;it&nbsp;has&nbsp;this&nbsp;unique&nbsp;value.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897590">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5897603">//&nbsp;Since&nbsp;two&nbsp;metasymbols&nbsp;(RUNA&nbsp;and&nbsp;RUNB)&nbsp;have&nbsp;values&nbsp;0&nbsp;and&nbsp;1,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5897667">//&nbsp;one&nbsp;would&nbsp;expect&nbsp;|v-2|&nbsp;to&nbsp;be&nbsp;passed&nbsp;to&nbsp;the&nbsp;MTF&nbsp;decoder.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5897728">//&nbsp;However,&nbsp;the&nbsp;front&nbsp;of&nbsp;the&nbsp;MTF&nbsp;list&nbsp;is&nbsp;never&nbsp;referenced&nbsp;as&nbsp;0,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5897794">//&nbsp;it&#39;s&nbsp;always&nbsp;referenced&nbsp;with&nbsp;a&nbsp;run-length&nbsp;of&nbsp;1.&nbsp;Thus&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5897853">//&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;encoded&nbsp;and&nbsp;we&nbsp;have&nbsp;|v-1|&nbsp;in&nbsp;the&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5897915">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897926">b</span>&nbsp;<span class="op" id="5897928">:=</span>&nbsp;<span class="builtintype" id="5897931">byte</span><span class="op" id="5897935">(</span><span class="ident" id="5897936">mtf</span><span class="op" id="5897939">.</span><span class="ident" id="5897940">Decode</span><span class="op" id="5897946">(</span><span class="builtintype" id="5897947">int</span><span class="op" id="5897950">(</span><span class="ident" id="5897951">v</span>&nbsp;<span class="op" id="5897953">-</span>&nbsp;<span class="num" id="5897955">1</span><span class="op" id="5897956">)</span><span class="op" id="5897957">)</span><span class="op" id="5897958">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897962">if</span>&nbsp;<span class="ident" id="5897965">bufIndex</span>&nbsp;<span class="op" id="5897974">&gt;=</span>&nbsp;<span class="ident" id="5897977">bz2</span><span class="op" id="5897980">.</span><span class="ident" id="5897981">blockSize</span>&nbsp;<span class="op" id="5897991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897996">return</span>&nbsp;<span class="ident" id="5898003">StructuralError</span><span class="op" id="5898018">(</span><span class="string" id="5898019">&#34;data&nbsp;exceeds&nbsp;block&nbsp;size&#34;</span><span class="op" id="5898044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898052">bz2</span><span class="op" id="5898055">.</span><span class="ident" id="5898056">tt</span><span class="op" id="5898058">[</span><span class="ident" id="5898059">bufIndex</span><span class="op" id="5898067">]</span>&nbsp;<span class="op" id="5898069">=</span>&nbsp;<span class="builtintype" id="5898071">uint32</span><span class="op" id="5898077">(</span><span class="ident" id="5898078">b</span><span class="op" id="5898079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898083">bz2</span><span class="op" id="5898086">.</span><span class="ident" id="5898087">c</span><span class="op" id="5898088">[</span><span class="ident" id="5898089">b</span><span class="op" id="5898090">]</span><span class="op" id="5898091">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898096">bufIndex</span><span class="op" id="5898104">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898112">if</span>&nbsp;<span class="ident" id="5898115">origPtr</span>&nbsp;<span class="op" id="5898123">&gt;=</span>&nbsp;<span class="builtintype" id="5898126">uint</span><span class="op" id="5898130">(</span><span class="ident" id="5898131">bufIndex</span><span class="op" id="5898139">)</span>&nbsp;<span class="op" id="5898141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898145">return</span>&nbsp;<span class="ident" id="5898152">StructuralError</span><span class="op" id="5898167">(</span><span class="string" id="5898168">&#34;origPtr&nbsp;out&nbsp;of&nbsp;bounds&#34;</span><span class="op" id="5898191">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5898198">//&nbsp;We&nbsp;have&nbsp;completed&nbsp;the&nbsp;entropy&nbsp;decoding.&nbsp;Now&nbsp;we&nbsp;can&nbsp;perform&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5898265">//&nbsp;inverse&nbsp;BWT&nbsp;and&nbsp;setup&nbsp;the&nbsp;RLE&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898307">bz2</span><span class="op" id="5898310">.</span><span class="ident" id="5898311">preRLE</span>&nbsp;<span class="op" id="5898318">=</span>&nbsp;<span class="ident" id="5898320">bz2</span><span class="op" id="5898323">.</span><span class="ident" id="5898324">tt</span><span class="op" id="5898326">[</span><span class="op" id="5898327">:</span><span class="ident" id="5898328">bufIndex</span><span class="op" id="5898336">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898339">bz2</span><span class="op" id="5898342">.</span><span class="ident" id="5898343">preRLEUsed</span>&nbsp;<span class="op" id="5898354">=</span>&nbsp;<span class="num" id="5898356">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898359">bz2</span><span class="op" id="5898362">.</span><span class="ident" id="5898363">tPos</span>&nbsp;<span class="op" id="5898368">=</span>&nbsp;<span class="ident" id="5898370">inverseBWT</span><span class="op" id="5898380">(</span><span class="ident" id="5898381">bz2</span><span class="op" id="5898384">.</span><span class="ident" id="5898385">preRLE</span><span class="op" id="5898391">,</span>&nbsp;<span class="ident" id="5898393">origPtr</span><span class="op" id="5898400">,</span>&nbsp;<span class="ident" id="5898402">bz2</span><span class="op" id="5898405">.</span><span class="ident" id="5898406">c</span><span class="op" id="5898407">[</span><span class="op" id="5898408">:</span><span class="op" id="5898409">]</span><span class="op" id="5898410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898413">bz2</span><span class="op" id="5898416">.</span><span class="ident" id="5898417">lastByte</span>&nbsp;<span class="op" id="5898426">=</span>&nbsp;<span class="op" id="5898428">-</span><span class="num" id="5898429">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898432">bz2</span><span class="op" id="5898435">.</span><span class="ident" id="5898436">byteRepeats</span>&nbsp;<span class="op" id="5898448">=</span>&nbsp;<span class="num" id="5898450">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898453">bz2</span><span class="op" id="5898456">.</span><span class="ident" id="5898457">repeats</span>&nbsp;<span class="op" id="5898465">=</span>&nbsp;<span class="num" id="5898467">0</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898471">return</span>&nbsp;<span class="ident" id="5898478">nil</span><br>
<span class="lineno"></span><span class="op" id="5898482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5898485">//&nbsp;inverseBWT&nbsp;implements&nbsp;the&nbsp;inverse&nbsp;Burrows-Wheeler&nbsp;transform&nbsp;as&nbsp;described&nbsp;in</span><br>
<span class="lineno">450</span><span class="comment" id="5898564">//&nbsp;http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-124.pdf,&nbsp;section&nbsp;4.2.</span><br>
<span class="lineno"></span><span class="comment" id="5898641">//&nbsp;In&nbsp;that&nbsp;document,&nbsp;origPtr&nbsp;is&nbsp;called&nbsp;`I&#39;&nbsp;and&nbsp;c&nbsp;is&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5898717">//&nbsp;first&nbsp;pass&nbsp;over&nbsp;the&nbsp;data.&nbsp;It&#39;s&nbsp;an&nbsp;argument&nbsp;here&nbsp;because&nbsp;we&nbsp;merge&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="5898795">//&nbsp;pass&nbsp;with&nbsp;the&nbsp;Huffman&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="comment" id="5898830">//</span><br>
<span class="lineno">455</span><span class="comment" id="5898833">//&nbsp;This&nbsp;also&nbsp;implements&nbsp;the&nbsp;`single&nbsp;array&#39;&nbsp;method&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="5898910">//&nbsp;which&nbsp;leaves&nbsp;the&nbsp;output,&nbsp;still&nbsp;shuffled,&nbsp;in&nbsp;the&nbsp;bottom&nbsp;8&nbsp;bits&nbsp;of&nbsp;tt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5898990">//&nbsp;index&nbsp;of&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;top&nbsp;24-bits.&nbsp;The&nbsp;index&nbsp;of&nbsp;the&nbsp;first&nbsp;byte&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5899067">//&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5899080">func</span>&nbsp;<span class="ident" id="5899085">inverseBWT</span><span class="op" id="5899095">(</span><span class="ident" id="5899096">tt</span>&nbsp;<span class="op" id="5899099">[</span><span class="op" id="5899100">]</span><span class="builtintype" id="5899101">uint32</span><span class="op" id="5899107">,</span>&nbsp;<span class="ident" id="5899109">origPtr</span>&nbsp;<span class="builtintype" id="5899117">uint</span><span class="op" id="5899121">,</span>&nbsp;<span class="ident" id="5899123">c</span>&nbsp;<span class="op" id="5899125">[</span><span class="op" id="5899126">]</span><span class="builtintype" id="5899127">uint</span><span class="op" id="5899131">)</span>&nbsp;<span class="builtintype" id="5899133">uint32</span>&nbsp;<span class="op" id="5899140">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899143">sum</span>&nbsp;<span class="op" id="5899147">:=</span>&nbsp;<span class="builtintype" id="5899150">uint</span><span class="op" id="5899154">(</span><span class="num" id="5899155">0</span><span class="op" id="5899156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899159">for</span>&nbsp;<span class="ident" id="5899163">i</span>&nbsp;<span class="op" id="5899165">:=</span>&nbsp;<span class="num" id="5899168">0</span><span class="op" id="5899169">;</span>&nbsp;<span class="ident" id="5899171">i</span>&nbsp;<span class="op" id="5899173">&lt;</span>&nbsp;<span class="num" id="5899175">256</span><span class="op" id="5899178">;</span>&nbsp;<span class="ident" id="5899180">i</span><span class="op" id="5899181">++</span>&nbsp;<span class="op" id="5899184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899188">sum</span>&nbsp;<span class="op" id="5899192">+=</span>&nbsp;<span class="ident" id="5899195">c</span><span class="op" id="5899196">[</span><span class="ident" id="5899197">i</span><span class="op" id="5899198">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899202">c</span><span class="op" id="5899203">[</span><span class="ident" id="5899204">i</span><span class="op" id="5899205">]</span>&nbsp;<span class="op" id="5899207">=</span>&nbsp;<span class="ident" id="5899209">sum</span>&nbsp;<span class="op" id="5899213">-</span>&nbsp;<span class="ident" id="5899215">c</span><span class="op" id="5899216">[</span><span class="ident" id="5899217">i</span><span class="op" id="5899218">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5899221">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899225">for</span>&nbsp;<span class="ident" id="5899229">i</span>&nbsp;<span class="op" id="5899231">:=</span>&nbsp;<span class="keyword" id="5899234">range</span>&nbsp;<span class="ident" id="5899240">tt</span>&nbsp;<span class="op" id="5899243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899247">b</span>&nbsp;<span class="op" id="5899249">:=</span>&nbsp;<span class="ident" id="5899252">tt</span><span class="op" id="5899254">[</span><span class="ident" id="5899255">i</span><span class="op" id="5899256">]</span>&nbsp;<span class="op" id="5899258">&amp;</span>&nbsp;<span class="num" id="5899260">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899267">tt</span><span class="op" id="5899269">[</span><span class="ident" id="5899270">c</span><span class="op" id="5899271">[</span><span class="ident" id="5899272">b</span><span class="op" id="5899273">]</span><span class="op" id="5899274">]</span>&nbsp;<span class="op" id="5899276">|=</span>&nbsp;<span class="builtintype" id="5899279">uint32</span><span class="op" id="5899285">(</span><span class="ident" id="5899286">i</span><span class="op" id="5899287">)</span>&nbsp;<span class="op" id="5899289">&lt;&lt;</span>&nbsp;<span class="num" id="5899292">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899296">c</span><span class="op" id="5899297">[</span><span class="ident" id="5899298">b</span><span class="op" id="5899299">]</span><span class="op" id="5899300">++</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5899304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899308">return</span>&nbsp;<span class="ident" id="5899315">tt</span><span class="op" id="5899317">[</span><span class="ident" id="5899318">origPtr</span><span class="op" id="5899325">]</span>&nbsp;<span class="op" id="5899327">&gt;&gt;</span>&nbsp;<span class="num" id="5899330">8</span><br>
<span class="lineno"></span><span class="op" id="5899332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span><span class="comment" id="5899335">//&nbsp;This&nbsp;is&nbsp;a&nbsp;standard&nbsp;CRC32&nbsp;like&nbsp;in&nbsp;hash/crc32&nbsp;except&nbsp;that&nbsp;all&nbsp;the&nbsp;shifts&nbsp;are&nbsp;reversed,</span><br>
<span class="lineno"></span><span class="comment" id="5899423">//&nbsp;causing&nbsp;the&nbsp;bits&nbsp;in&nbsp;the&nbsp;input&nbsp;to&nbsp;be&nbsp;processed&nbsp;in&nbsp;the&nbsp;reverse&nbsp;of&nbsp;the&nbsp;usual&nbsp;order.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5899508">var</span>&nbsp;<span class="ident" id="5899512">crctab</span>&nbsp;<span class="op" id="5899519">[</span><span class="num" id="5899520">256</span><span class="op" id="5899523">]</span><span class="builtintype" id="5899524">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span><span class="keyword" id="5899532">func</span>&nbsp;<span class="ident" id="5899537">init</span><span class="op" id="5899541">(</span><span class="op" id="5899542">)</span>&nbsp;<span class="op" id="5899544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899547">const</span>&nbsp;<span class="ident" id="5899553">poly</span>&nbsp;<span class="op" id="5899558">=</span>&nbsp;<span class="num" id="5899560">0x04C11DB7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899572">for</span>&nbsp;<span class="ident" id="5899576">i</span>&nbsp;<span class="op" id="5899578">:=</span>&nbsp;<span class="keyword" id="5899581">range</span>&nbsp;<span class="ident" id="5899587">crctab</span>&nbsp;<span class="op" id="5899594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899598">crc</span>&nbsp;<span class="op" id="5899602">:=</span>&nbsp;<span class="builtintype" id="5899605">uint32</span><span class="op" id="5899611">(</span><span class="ident" id="5899612">i</span><span class="op" id="5899613">)</span>&nbsp;<span class="op" id="5899615">&lt;&lt;</span>&nbsp;<span class="num" id="5899618">24</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899623">for</span>&nbsp;<span class="ident" id="5899627">j</span>&nbsp;<span class="op" id="5899629">:=</span>&nbsp;<span class="num" id="5899632">0</span><span class="op" id="5899633">;</span>&nbsp;<span class="ident" id="5899635">j</span>&nbsp;<span class="op" id="5899637">&lt;</span>&nbsp;<span class="num" id="5899639">8</span><span class="op" id="5899640">;</span>&nbsp;<span class="ident" id="5899642">j</span><span class="op" id="5899643">++</span>&nbsp;<span class="op" id="5899646">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899651">if</span>&nbsp;<span class="ident" id="5899654">crc</span><span class="op" id="5899657">&amp;</span><span class="num" id="5899658">0x80000000</span>&nbsp;<span class="op" id="5899669">!=</span>&nbsp;<span class="num" id="5899672">0</span>&nbsp;<span class="op" id="5899674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899680">crc</span>&nbsp;<span class="op" id="5899684">=</span>&nbsp;<span class="op" id="5899686">(</span><span class="ident" id="5899687">crc</span>&nbsp;<span class="op" id="5899691">&lt;&lt;</span>&nbsp;<span class="num" id="5899694">1</span><span class="op" id="5899695">)</span>&nbsp;<span class="op" id="5899697">^</span>&nbsp;<span class="ident" id="5899699">poly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5899707">}</span>&nbsp;<span class="keyword" id="5899709">else</span>&nbsp;<span class="op" id="5899714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899720">crc</span>&nbsp;<span class="op" id="5899724">&lt;&lt;=</span>&nbsp;<span class="num" id="5899728">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5899733">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5899737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899741">crctab</span><span class="op" id="5899747">[</span><span class="ident" id="5899748">i</span><span class="op" id="5899749">]</span>&nbsp;<span class="op" id="5899751">=</span>&nbsp;<span class="ident" id="5899753">crc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5899758">}</span><br>
<span class="lineno"></span><span class="op" id="5899760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="5899763">//&nbsp;updateCRC&nbsp;updates&nbsp;the&nbsp;crc&nbsp;value&nbsp;to&nbsp;incorporate&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="5899828">//&nbsp;The&nbsp;initial&nbsp;value&nbsp;is&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="5899855">func</span>&nbsp;<span class="ident" id="5899860">updateCRC</span><span class="op" id="5899869">(</span><span class="ident" id="5899870">val</span>&nbsp;<span class="builtintype" id="5899874">uint32</span><span class="op" id="5899880">,</span>&nbsp;<span class="ident" id="5899882">b</span>&nbsp;<span class="op" id="5899884">[</span><span class="op" id="5899885">]</span><span class="builtintype" id="5899886">byte</span><span class="op" id="5899890">)</span>&nbsp;<span class="builtintype" id="5899892">uint32</span>&nbsp;<span class="op" id="5899899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899902">crc</span>&nbsp;<span class="op" id="5899906">:=</span>&nbsp;<span class="op" id="5899909">^</span><span class="ident" id="5899910">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899915">for</span>&nbsp;<span class="ident" id="5899919">_</span><span class="op" id="5899920">,</span>&nbsp;<span class="ident" id="5899922">v</span>&nbsp;<span class="op" id="5899924">:=</span>&nbsp;<span class="keyword" id="5899927">range</span>&nbsp;<span class="ident" id="5899933">b</span>&nbsp;<span class="op" id="5899935">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899939">crc</span>&nbsp;<span class="op" id="5899943">=</span>&nbsp;<span class="ident" id="5899945">crctab</span><span class="op" id="5899951">[</span><span class="builtintype" id="5899952">byte</span><span class="op" id="5899956">(</span><span class="ident" id="5899957">crc</span><span class="op" id="5899960">&gt;&gt;</span><span class="num" id="5899962">24</span><span class="op" id="5899964">)</span><span class="op" id="5899965">^</span><span class="ident" id="5899966">v</span><span class="op" id="5899967">]</span>&nbsp;<span class="op" id="5899969">^</span>&nbsp;<span class="op" id="5899971">(</span><span class="ident" id="5899972">crc</span>&nbsp;<span class="op" id="5899976">&lt;&lt;</span>&nbsp;<span class="num" id="5899979">8</span><span class="op" id="5899980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5899983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899986">return</span>&nbsp;<span class="op" id="5899993">^</span><span class="ident" id="5899994">crc</span><br>
<span class="lineno"></span><span class="op" id="5899998">}</span>
</div>
</body>
</html>
