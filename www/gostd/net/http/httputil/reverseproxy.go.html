<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html" class="current">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3828042">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3828097">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3828151">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3828202">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3828233">package</span>&nbsp;<span class="ident" id="3828241">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3828251">import</span>&nbsp;<span class="op" id="3828258">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3828261">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3828267">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3828274">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3828281">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3828293">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3828304">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3828315">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3828323">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3828330">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="3828333">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3828406">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="3828432">var</span>&nbsp;<span class="ident" id="3828436">onExitFlushLoop</span>&nbsp;<span class="keyword" id="3828452">func</span><span class="op" id="3828456">(</span><span class="op" id="3828457">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3828460">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="3828530">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3828595">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3828606">type</span>&nbsp;<span class="ident" id="3828611">ReverseProxy</span>&nbsp;<span class="keyword" id="3828624">struct</span>&nbsp;<span class="op" id="3828631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828634">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828681">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828727">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828776">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3828820">Director</span>&nbsp;<span class="keyword" id="3828829">func</span><span class="op" id="3828833">(</span><span class="op" id="3828834">*</span><span class="ident" id="3828835">http</span><span class="op" id="3828839">.</span><span class="ident" id="3828840">Request</span><span class="op" id="3828847">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828851">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828901">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3828944">Transport</span>&nbsp;<span class="ident" id="3828954">http</span><span class="op" id="3828958">.</span><span class="ident" id="3828959">RoundTripper</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828974">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3829021">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3829066">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3829085">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3829128">FlushInterval</span>&nbsp;<span class="ident" id="3829142">time</span><span class="op" id="3829146">.</span><span class="ident" id="3829147">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3829158">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3829211">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3829264">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3829324">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3829345">ErrorLog</span>&nbsp;<span class="op" id="3829354">*</span><span class="ident" id="3829355">log</span><span class="op" id="3829358">.</span><span class="ident" id="3829359">Logger</span><br>
<span class="lineno"></span><span class="op" id="3829366">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="3829369">func</span>&nbsp;<span class="ident" id="3829374">singleJoiningSlash</span><span class="op" id="3829392">(</span><span class="ident" id="3829393">a</span><span class="op" id="3829394">,</span>&nbsp;<span class="ident" id="3829396">b</span>&nbsp;<span class="builtintype" id="3829398">string</span><span class="op" id="3829404">)</span>&nbsp;<span class="builtintype" id="3829406">string</span>&nbsp;<span class="op" id="3829413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3829416">aslash</span>&nbsp;<span class="op" id="3829423">:=</span>&nbsp;<span class="ident" id="3829426">strings</span><span class="op" id="3829433">.</span><span class="ident" id="3829434">HasSuffix</span><span class="op" id="3829443">(</span><span class="ident" id="3829444">a</span><span class="op" id="3829445">,</span>&nbsp;<span class="string" id="3829447">&#34;/&#34;</span><span class="op" id="3829450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3829453">bslash</span>&nbsp;<span class="op" id="3829460">:=</span>&nbsp;<span class="ident" id="3829463">strings</span><span class="op" id="3829470">.</span><span class="ident" id="3829471">HasPrefix</span><span class="op" id="3829480">(</span><span class="ident" id="3829481">b</span><span class="op" id="3829482">,</span>&nbsp;<span class="string" id="3829484">&#34;/&#34;</span><span class="op" id="3829487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829490">switch</span>&nbsp;<span class="op" id="3829497">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829500">case</span>&nbsp;<span class="ident" id="3829505">aslash</span>&nbsp;<span class="op" id="3829512">&amp;&amp;</span>&nbsp;<span class="ident" id="3829515">bslash</span><span class="op" id="3829521">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829525">return</span>&nbsp;<span class="ident" id="3829532">a</span>&nbsp;<span class="op" id="3829534">+</span>&nbsp;<span class="ident" id="3829536">b</span><span class="op" id="3829537">[</span><span class="num" id="3829538">1</span><span class="op" id="3829539">:</span><span class="op" id="3829540">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829543">case</span>&nbsp;<span class="op" id="3829548">!</span><span class="ident" id="3829549">aslash</span>&nbsp;<span class="op" id="3829556">&amp;&amp;</span>&nbsp;<span class="op" id="3829559">!</span><span class="ident" id="3829560">bslash</span><span class="op" id="3829566">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829570">return</span>&nbsp;<span class="ident" id="3829577">a</span>&nbsp;<span class="op" id="3829579">+</span>&nbsp;<span class="string" id="3829581">&#34;/&#34;</span>&nbsp;<span class="op" id="3829585">+</span>&nbsp;<span class="ident" id="3829587">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3829590">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829593">return</span>&nbsp;<span class="ident" id="3829600">a</span>&nbsp;<span class="op" id="3829602">+</span>&nbsp;<span class="ident" id="3829604">b</span><br>
<span class="lineno"></span><span class="op" id="3829606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3829609">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="3829679">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="3829749">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="3829818">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="3829863">func</span>&nbsp;<span class="ident" id="3829868">NewSingleHostReverseProxy</span><span class="op" id="3829893">(</span><span class="ident" id="3829894">target</span>&nbsp;<span class="op" id="3829901">*</span><span class="ident" id="3829902">url</span><span class="op" id="3829905">.</span><span class="ident" id="3829906">URL</span><span class="op" id="3829909">)</span>&nbsp;<span class="op" id="3829911">*</span><span class="ident" id="3829912">ReverseProxy</span>&nbsp;<span class="op" id="3829925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3829928">targetQuery</span>&nbsp;<span class="op" id="3829940">:=</span>&nbsp;<span class="ident" id="3829943">target</span><span class="op" id="3829949">.</span><span class="ident" id="3829950">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3829960">director</span>&nbsp;<span class="op" id="3829969">:=</span>&nbsp;<span class="keyword" id="3829972">func</span><span class="op" id="3829976">(</span><span class="ident" id="3829977">req</span>&nbsp;<span class="op" id="3829981">*</span><span class="ident" id="3829982">http</span><span class="op" id="3829986">.</span><span class="ident" id="3829987">Request</span><span class="op" id="3829994">)</span>&nbsp;<span class="op" id="3829996">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830000">req</span><span class="op" id="3830003">.</span><span class="ident" id="3830004">URL</span><span class="op" id="3830007">.</span><span class="ident" id="3830008">Scheme</span>&nbsp;<span class="op" id="3830015">=</span>&nbsp;<span class="ident" id="3830017">target</span><span class="op" id="3830023">.</span><span class="ident" id="3830024">Scheme</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830033">req</span><span class="op" id="3830036">.</span><span class="ident" id="3830037">URL</span><span class="op" id="3830040">.</span><span class="ident" id="3830041">Host</span>&nbsp;<span class="op" id="3830046">=</span>&nbsp;<span class="ident" id="3830048">target</span><span class="op" id="3830054">.</span><span class="ident" id="3830055">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830062">req</span><span class="op" id="3830065">.</span><span class="ident" id="3830066">URL</span><span class="op" id="3830069">.</span><span class="ident" id="3830070">Path</span>&nbsp;<span class="op" id="3830075">=</span>&nbsp;<span class="ident" id="3830077">singleJoiningSlash</span><span class="op" id="3830095">(</span><span class="ident" id="3830096">target</span><span class="op" id="3830102">.</span><span class="ident" id="3830103">Path</span><span class="op" id="3830107">,</span>&nbsp;<span class="ident" id="3830109">req</span><span class="op" id="3830112">.</span><span class="ident" id="3830113">URL</span><span class="op" id="3830116">.</span><span class="ident" id="3830117">Path</span><span class="op" id="3830121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3830125">if</span>&nbsp;<span class="ident" id="3830128">targetQuery</span>&nbsp;<span class="op" id="3830140">==</span>&nbsp;<span class="string" id="3830143">&#34;&#34;</span>&nbsp;<span class="op" id="3830146">||</span>&nbsp;<span class="ident" id="3830149">req</span><span class="op" id="3830152">.</span><span class="ident" id="3830153">URL</span><span class="op" id="3830156">.</span><span class="ident" id="3830157">RawQuery</span>&nbsp;<span class="op" id="3830166">==</span>&nbsp;<span class="string" id="3830169">&#34;&#34;</span>&nbsp;<span class="op" id="3830172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830177">req</span><span class="op" id="3830180">.</span><span class="ident" id="3830181">URL</span><span class="op" id="3830184">.</span><span class="ident" id="3830185">RawQuery</span>&nbsp;<span class="op" id="3830194">=</span>&nbsp;<span class="ident" id="3830196">targetQuery</span>&nbsp;<span class="op" id="3830208">+</span>&nbsp;<span class="ident" id="3830210">req</span><span class="op" id="3830213">.</span><span class="ident" id="3830214">URL</span><span class="op" id="3830217">.</span><span class="ident" id="3830218">RawQuery</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3830229">}</span>&nbsp;<span class="keyword" id="3830231">else</span>&nbsp;<span class="op" id="3830236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830241">req</span><span class="op" id="3830244">.</span><span class="ident" id="3830245">URL</span><span class="op" id="3830248">.</span><span class="ident" id="3830249">RawQuery</span>&nbsp;<span class="op" id="3830258">=</span>&nbsp;<span class="ident" id="3830260">targetQuery</span>&nbsp;<span class="op" id="3830272">+</span>&nbsp;<span class="string" id="3830274">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="3830278">+</span>&nbsp;<span class="ident" id="3830280">req</span><span class="op" id="3830283">.</span><span class="ident" id="3830284">URL</span><span class="op" id="3830287">.</span><span class="ident" id="3830288">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3830299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3830302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3830305">return</span>&nbsp;<span class="op" id="3830312">&amp;</span><span class="ident" id="3830313">ReverseProxy</span><span class="op" id="3830325">{</span><span class="ident" id="3830326">Director</span><span class="op" id="3830334">:</span>&nbsp;<span class="ident" id="3830336">director</span><span class="op" id="3830344">}</span><br>
<span class="lineno">80</span><span class="op" id="3830346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3830349">func</span>&nbsp;<span class="ident" id="3830354">copyHeader</span><span class="op" id="3830364">(</span><span class="ident" id="3830365">dst</span><span class="op" id="3830368">,</span>&nbsp;<span class="ident" id="3830370">src</span>&nbsp;<span class="ident" id="3830374">http</span><span class="op" id="3830378">.</span><span class="ident" id="3830379">Header</span><span class="op" id="3830385">)</span>&nbsp;<span class="op" id="3830387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3830390">for</span>&nbsp;<span class="ident" id="3830394">k</span><span class="op" id="3830395">,</span>&nbsp;<span class="ident" id="3830397">vv</span>&nbsp;<span class="op" id="3830400">:=</span>&nbsp;<span class="keyword" id="3830403">range</span>&nbsp;<span class="ident" id="3830409">src</span>&nbsp;<span class="op" id="3830413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3830417">for</span>&nbsp;<span class="ident" id="3830421">_</span><span class="op" id="3830422">,</span>&nbsp;<span class="ident" id="3830424">v</span>&nbsp;<span class="op" id="3830426">:=</span>&nbsp;<span class="keyword" id="3830429">range</span>&nbsp;<span class="ident" id="3830435">vv</span>&nbsp;<span class="op" id="3830438">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830443">dst</span><span class="op" id="3830446">.</span><span class="ident" id="3830447">Add</span><span class="op" id="3830450">(</span><span class="ident" id="3830451">k</span><span class="op" id="3830452">,</span>&nbsp;<span class="ident" id="3830454">v</span><span class="op" id="3830455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3830459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3830462">}</span><br>
<span class="lineno"></span><span class="op" id="3830464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="3830467">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="3830534">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="3830592">var</span>&nbsp;<span class="ident" id="3830596">hopHeaders</span>&nbsp;<span class="op" id="3830607">=</span>&nbsp;<span class="op" id="3830609">[</span><span class="op" id="3830610">]</span><span class="builtintype" id="3830611">string</span><span class="op" id="3830617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3830620">&#34;Connection&#34;</span><span class="op" id="3830632">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3830635">&#34;Keep-Alive&#34;</span><span class="op" id="3830647">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3830650">&#34;Proxy-Authenticate&#34;</span><span class="op" id="3830670">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3830673">&#34;Proxy-Authorization&#34;</span><span class="op" id="3830694">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3830697">&#34;Te&#34;</span><span class="op" id="3830701">,</span>&nbsp;<span class="comment" id="3830703">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3830737">&#34;Trailers&#34;</span><span class="op" id="3830747">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3830750">&#34;Transfer-Encoding&#34;</span><span class="op" id="3830769">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3830772">&#34;Upgrade&#34;</span><span class="op" id="3830781">,</span><br>
<span class="lineno"></span><span class="op" id="3830783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3830786">func</span>&nbsp;<span class="op" id="3830791">(</span><span class="ident" id="3830792">p</span>&nbsp;<span class="op" id="3830794">*</span><span class="ident" id="3830795">ReverseProxy</span><span class="op" id="3830807">)</span>&nbsp;<span class="ident" id="3830809">ServeHTTP</span><span class="op" id="3830818">(</span><span class="ident" id="3830819">rw</span>&nbsp;<span class="ident" id="3830822">http</span><span class="op" id="3830826">.</span><span class="ident" id="3830827">ResponseWriter</span><span class="op" id="3830841">,</span>&nbsp;<span class="ident" id="3830843">req</span>&nbsp;<span class="op" id="3830847">*</span><span class="ident" id="3830848">http</span><span class="op" id="3830852">.</span><span class="ident" id="3830853">Request</span><span class="op" id="3830860">)</span>&nbsp;<span class="op" id="3830862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830865">transport</span>&nbsp;<span class="op" id="3830875">:=</span>&nbsp;<span class="ident" id="3830878">p</span><span class="op" id="3830879">.</span><span class="ident" id="3830880">Transport</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3830891">if</span>&nbsp;<span class="ident" id="3830894">transport</span>&nbsp;<span class="op" id="3830904">==</span>&nbsp;<span class="builtintype" id="3830907">nil</span>&nbsp;<span class="op" id="3830911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830915">transport</span>&nbsp;<span class="op" id="3830925">=</span>&nbsp;<span class="ident" id="3830927">http</span><span class="op" id="3830931">.</span><span class="ident" id="3830932">DefaultTransport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3830950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830954">outreq</span>&nbsp;<span class="op" id="3830961">:=</span>&nbsp;<span class="builtinfunc" id="3830964">new</span><span class="op" id="3830967">(</span><span class="ident" id="3830968">http</span><span class="op" id="3830972">.</span><span class="ident" id="3830973">Request</span><span class="op" id="3830980">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3830983">*</span><span class="ident" id="3830984">outreq</span>&nbsp;<span class="op" id="3830991">=</span>&nbsp;<span class="op" id="3830993">*</span><span class="ident" id="3830994">req</span>&nbsp;<span class="comment" id="3830998">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831045">p</span><span class="op" id="3831046">.</span><span class="ident" id="3831047">Director</span><span class="op" id="3831055">(</span><span class="ident" id="3831056">outreq</span><span class="op" id="3831062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831065">outreq</span><span class="op" id="3831071">.</span><span class="ident" id="3831072">Proto</span>&nbsp;<span class="op" id="3831078">=</span>&nbsp;<span class="string" id="3831080">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831092">outreq</span><span class="op" id="3831098">.</span><span class="ident" id="3831099">ProtoMajor</span>&nbsp;<span class="op" id="3831110">=</span>&nbsp;<span class="num" id="3831112">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831115">outreq</span><span class="op" id="3831121">.</span><span class="ident" id="3831122">ProtoMinor</span>&nbsp;<span class="op" id="3831133">=</span>&nbsp;<span class="num" id="3831135">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831138">outreq</span><span class="op" id="3831144">.</span><span class="ident" id="3831145">Close</span>&nbsp;<span class="op" id="3831151">=</span>&nbsp;<span class="builtintype" id="3831153">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831161">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831219">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831278">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831342">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831401">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831452">copiedHeaders</span>&nbsp;<span class="op" id="3831466">:=</span>&nbsp;<span class="builtintype" id="3831469">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3831476">for</span>&nbsp;<span class="ident" id="3831480">_</span><span class="op" id="3831481">,</span>&nbsp;<span class="ident" id="3831483">h</span>&nbsp;<span class="op" id="3831485">:=</span>&nbsp;<span class="keyword" id="3831488">range</span>&nbsp;<span class="ident" id="3831494">hopHeaders</span>&nbsp;<span class="op" id="3831505">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3831509">if</span>&nbsp;<span class="ident" id="3831512">outreq</span><span class="op" id="3831518">.</span><span class="ident" id="3831519">Header</span><span class="op" id="3831525">.</span><span class="ident" id="3831526">Get</span><span class="op" id="3831529">(</span><span class="ident" id="3831530">h</span><span class="op" id="3831531">)</span>&nbsp;<span class="op" id="3831533">!=</span>&nbsp;<span class="string" id="3831536">&#34;&#34;</span>&nbsp;<span class="op" id="3831539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3831544">if</span>&nbsp;<span class="op" id="3831547">!</span><span class="ident" id="3831548">copiedHeaders</span>&nbsp;<span class="op" id="3831562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831568">outreq</span><span class="op" id="3831574">.</span><span class="ident" id="3831575">Header</span>&nbsp;<span class="op" id="3831582">=</span>&nbsp;<span class="builtinfunc" id="3831584">make</span><span class="op" id="3831588">(</span><span class="ident" id="3831589">http</span><span class="op" id="3831593">.</span><span class="ident" id="3831594">Header</span><span class="op" id="3831600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831606">copyHeader</span><span class="op" id="3831616">(</span><span class="ident" id="3831617">outreq</span><span class="op" id="3831623">.</span><span class="ident" id="3831624">Header</span><span class="op" id="3831630">,</span>&nbsp;<span class="ident" id="3831632">req</span><span class="op" id="3831635">.</span><span class="ident" id="3831636">Header</span><span class="op" id="3831642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831648">copiedHeaders</span>&nbsp;<span class="op" id="3831662">=</span>&nbsp;<span class="builtintype" id="3831664">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3831672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831677">outreq</span><span class="op" id="3831683">.</span><span class="ident" id="3831684">Header</span><span class="op" id="3831690">.</span><span class="ident" id="3831691">Del</span><span class="op" id="3831694">(</span><span class="ident" id="3831695">h</span><span class="op" id="3831696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3831700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3831703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3831707">if</span>&nbsp;<span class="ident" id="3831710">clientIP</span><span class="op" id="3831718">,</span>&nbsp;<span class="ident" id="3831720">_</span><span class="op" id="3831721">,</span>&nbsp;<span class="ident" id="3831723">err</span>&nbsp;<span class="op" id="3831727">:=</span>&nbsp;<span class="ident" id="3831730">net</span><span class="op" id="3831733">.</span><span class="ident" id="3831734">SplitHostPort</span><span class="op" id="3831747">(</span><span class="ident" id="3831748">req</span><span class="op" id="3831751">.</span><span class="ident" id="3831752">RemoteAddr</span><span class="op" id="3831762">)</span><span class="op" id="3831763">;</span>&nbsp;<span class="ident" id="3831765">err</span>&nbsp;<span class="op" id="3831769">==</span>&nbsp;<span class="builtintype" id="3831772">nil</span>&nbsp;<span class="op" id="3831776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831780">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831827">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831877">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3831933">if</span>&nbsp;<span class="ident" id="3831936">prior</span><span class="op" id="3831941">,</span>&nbsp;<span class="ident" id="3831943">ok</span>&nbsp;<span class="op" id="3831946">:=</span>&nbsp;<span class="ident" id="3831949">outreq</span><span class="op" id="3831955">.</span><span class="ident" id="3831956">Header</span><span class="op" id="3831962">[</span><span class="string" id="3831963">&#34;X-Forwarded-For&#34;</span><span class="op" id="3831980">]</span><span class="op" id="3831981">;</span>&nbsp;<span class="ident" id="3831983">ok</span>&nbsp;<span class="op" id="3831986">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831991">clientIP</span>&nbsp;<span class="op" id="3832000">=</span>&nbsp;<span class="ident" id="3832002">strings</span><span class="op" id="3832009">.</span><span class="ident" id="3832010">Join</span><span class="op" id="3832014">(</span><span class="ident" id="3832015">prior</span><span class="op" id="3832020">,</span>&nbsp;<span class="string" id="3832022">&#34;,&nbsp;&#34;</span><span class="op" id="3832026">)</span>&nbsp;<span class="op" id="3832028">+</span>&nbsp;<span class="string" id="3832030">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="3832035">+</span>&nbsp;<span class="ident" id="3832037">clientIP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832052">outreq</span><span class="op" id="3832058">.</span><span class="ident" id="3832059">Header</span><span class="op" id="3832065">.</span><span class="ident" id="3832066">Set</span><span class="op" id="3832069">(</span><span class="string" id="3832070">&#34;X-Forwarded-For&#34;</span><span class="op" id="3832087">,</span>&nbsp;<span class="ident" id="3832089">clientIP</span><span class="op" id="3832097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832104">res</span><span class="op" id="3832107">,</span>&nbsp;<span class="ident" id="3832109">err</span>&nbsp;<span class="op" id="3832113">:=</span>&nbsp;<span class="ident" id="3832116">transport</span><span class="op" id="3832125">.</span><span class="ident" id="3832126">RoundTrip</span><span class="op" id="3832135">(</span><span class="ident" id="3832136">outreq</span><span class="op" id="3832142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832145">if</span>&nbsp;<span class="ident" id="3832148">err</span>&nbsp;<span class="op" id="3832152">!=</span>&nbsp;<span class="builtintype" id="3832155">nil</span>&nbsp;<span class="op" id="3832159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832163">p</span><span class="op" id="3832164">.</span><span class="ident" id="3832165">logf</span><span class="op" id="3832169">(</span><span class="string" id="3832170">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="3832193">,</span>&nbsp;<span class="ident" id="3832195">err</span><span class="op" id="3832198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832202">rw</span><span class="op" id="3832204">.</span><span class="ident" id="3832205">WriteHeader</span><span class="op" id="3832216">(</span><span class="ident" id="3832217">http</span><span class="op" id="3832221">.</span><span class="ident" id="3832222">StatusInternalServerError</span><span class="op" id="3832247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832251">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832262">defer</span>&nbsp;<span class="ident" id="3832268">res</span><span class="op" id="3832271">.</span><span class="ident" id="3832272">Body</span><span class="op" id="3832276">.</span><span class="ident" id="3832277">Close</span><span class="op" id="3832282">(</span><span class="op" id="3832283">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832287">for</span>&nbsp;<span class="ident" id="3832291">_</span><span class="op" id="3832292">,</span>&nbsp;<span class="ident" id="3832294">h</span>&nbsp;<span class="op" id="3832296">:=</span>&nbsp;<span class="keyword" id="3832299">range</span>&nbsp;<span class="ident" id="3832305">hopHeaders</span>&nbsp;<span class="op" id="3832316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832320">res</span><span class="op" id="3832323">.</span><span class="ident" id="3832324">Header</span><span class="op" id="3832330">.</span><span class="ident" id="3832331">Del</span><span class="op" id="3832334">(</span><span class="ident" id="3832335">h</span><span class="op" id="3832336">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832343">copyHeader</span><span class="op" id="3832353">(</span><span class="ident" id="3832354">rw</span><span class="op" id="3832356">.</span><span class="ident" id="3832357">Header</span><span class="op" id="3832363">(</span><span class="op" id="3832364">)</span><span class="op" id="3832365">,</span>&nbsp;<span class="ident" id="3832367">res</span><span class="op" id="3832370">.</span><span class="ident" id="3832371">Header</span><span class="op" id="3832377">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832381">rw</span><span class="op" id="3832383">.</span><span class="ident" id="3832384">WriteHeader</span><span class="op" id="3832395">(</span><span class="ident" id="3832396">res</span><span class="op" id="3832399">.</span><span class="ident" id="3832400">StatusCode</span><span class="op" id="3832410">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832413">p</span><span class="op" id="3832414">.</span><span class="ident" id="3832415">copyResponse</span><span class="op" id="3832427">(</span><span class="ident" id="3832428">rw</span><span class="op" id="3832430">,</span>&nbsp;<span class="ident" id="3832432">res</span><span class="op" id="3832435">.</span><span class="ident" id="3832436">Body</span><span class="op" id="3832440">)</span><br>
<span class="lineno"></span><span class="op" id="3832442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3832445">func</span>&nbsp;<span class="op" id="3832450">(</span><span class="ident" id="3832451">p</span>&nbsp;<span class="op" id="3832453">*</span><span class="ident" id="3832454">ReverseProxy</span><span class="op" id="3832466">)</span>&nbsp;<span class="ident" id="3832468">copyResponse</span><span class="op" id="3832480">(</span><span class="ident" id="3832481">dst</span>&nbsp;<span class="ident" id="3832485">io</span><span class="op" id="3832487">.</span><span class="ident" id="3832488">Writer</span><span class="op" id="3832494">,</span>&nbsp;<span class="ident" id="3832496">src</span>&nbsp;<span class="ident" id="3832500">io</span><span class="op" id="3832502">.</span><span class="ident" id="3832503">Reader</span><span class="op" id="3832509">)</span>&nbsp;<span class="op" id="3832511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832514">if</span>&nbsp;<span class="ident" id="3832517">p</span><span class="op" id="3832518">.</span><span class="ident" id="3832519">FlushInterval</span>&nbsp;<span class="op" id="3832533">!=</span>&nbsp;<span class="num" id="3832536">0</span>&nbsp;<span class="op" id="3832538">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832542">if</span>&nbsp;<span class="ident" id="3832545">wf</span><span class="op" id="3832547">,</span>&nbsp;<span class="ident" id="3832549">ok</span>&nbsp;<span class="op" id="3832552">:=</span>&nbsp;<span class="ident" id="3832555">dst</span><span class="op" id="3832558">.</span><span class="op" id="3832559">(</span><span class="ident" id="3832560">writeFlusher</span><span class="op" id="3832572">)</span><span class="op" id="3832573">;</span>&nbsp;<span class="ident" id="3832575">ok</span>&nbsp;<span class="op" id="3832578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832583">mlw</span>&nbsp;<span class="op" id="3832587">:=</span>&nbsp;<span class="op" id="3832590">&amp;</span><span class="ident" id="3832591">maxLatencyWriter</span><span class="op" id="3832607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832613">dst</span><span class="op" id="3832616">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832622">wf</span><span class="op" id="3832624">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832630">latency</span><span class="op" id="3832637">:</span>&nbsp;<span class="ident" id="3832639">p</span><span class="op" id="3832640">.</span><span class="ident" id="3832641">FlushInterval</span><span class="op" id="3832654">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832660">done</span><span class="op" id="3832664">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3832669">make</span><span class="op" id="3832673">(</span><span class="keyword" id="3832674">chan</span>&nbsp;<span class="builtintype" id="3832679">bool</span><span class="op" id="3832683">)</span><span class="op" id="3832684">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832694">go</span>&nbsp;<span class="ident" id="3832697">mlw</span><span class="op" id="3832700">.</span><span class="ident" id="3832701">flushLoop</span><span class="op" id="3832710">(</span><span class="op" id="3832711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832716">defer</span>&nbsp;<span class="ident" id="3832722">mlw</span><span class="op" id="3832725">.</span><span class="ident" id="3832726">stop</span><span class="op" id="3832730">(</span><span class="op" id="3832731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832736">dst</span>&nbsp;<span class="op" id="3832740">=</span>&nbsp;<span class="ident" id="3832742">mlw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832748">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832755">io</span><span class="op" id="3832757">.</span><span class="ident" id="3832758">Copy</span><span class="op" id="3832762">(</span><span class="ident" id="3832763">dst</span><span class="op" id="3832766">,</span>&nbsp;<span class="ident" id="3832768">src</span><span class="op" id="3832771">)</span><br>
<span class="lineno"></span><span class="op" id="3832773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="3832776">func</span>&nbsp;<span class="op" id="3832781">(</span><span class="ident" id="3832782">p</span>&nbsp;<span class="op" id="3832784">*</span><span class="ident" id="3832785">ReverseProxy</span><span class="op" id="3832797">)</span>&nbsp;<span class="ident" id="3832799">logf</span><span class="op" id="3832803">(</span><span class="ident" id="3832804">format</span>&nbsp;<span class="builtintype" id="3832811">string</span><span class="op" id="3832817">,</span>&nbsp;<span class="ident" id="3832819">args</span>&nbsp;<span class="op" id="3832824">...</span><span class="keyword" id="3832827">interface</span><span class="op" id="3832836">{</span><span class="op" id="3832837">}</span><span class="op" id="3832838">)</span>&nbsp;<span class="op" id="3832840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832843">if</span>&nbsp;<span class="ident" id="3832846">p</span><span class="op" id="3832847">.</span><span class="ident" id="3832848">ErrorLog</span>&nbsp;<span class="op" id="3832857">!=</span>&nbsp;<span class="builtintype" id="3832860">nil</span>&nbsp;<span class="op" id="3832864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832868">p</span><span class="op" id="3832869">.</span><span class="ident" id="3832870">ErrorLog</span><span class="op" id="3832878">.</span><span class="ident" id="3832879">Printf</span><span class="op" id="3832885">(</span><span class="ident" id="3832886">format</span><span class="op" id="3832892">,</span>&nbsp;<span class="ident" id="3832894">args</span><span class="op" id="3832898">...</span><span class="op" id="3832901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832904">}</span>&nbsp;<span class="keyword" id="3832906">else</span>&nbsp;<span class="op" id="3832911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832915">log</span><span class="op" id="3832918">.</span><span class="ident" id="3832919">Printf</span><span class="op" id="3832925">(</span><span class="ident" id="3832926">format</span><span class="op" id="3832932">,</span>&nbsp;<span class="ident" id="3832934">args</span><span class="op" id="3832938">...</span><span class="op" id="3832941">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832944">}</span><br>
<span class="lineno"></span><span class="op" id="3832946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3832949">type</span>&nbsp;<span class="ident" id="3832954">writeFlusher</span>&nbsp;<span class="keyword" id="3832967">interface</span>&nbsp;<span class="op" id="3832977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832980">io</span><span class="op" id="3832982">.</span><span class="ident" id="3832983">Writer</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832991">http</span><span class="op" id="3832995">.</span><span class="ident" id="3832996">Flusher</span><br>
<span class="lineno"></span><span class="op" id="3833004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3833007">type</span>&nbsp;<span class="ident" id="3833012">maxLatencyWriter</span>&nbsp;<span class="keyword" id="3833029">struct</span>&nbsp;<span class="op" id="3833036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833039">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833047">writeFlusher</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833061">latency</span>&nbsp;<span class="ident" id="3833069">time</span><span class="op" id="3833073">.</span><span class="ident" id="3833074">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833085">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3833090">sync</span><span class="op" id="3833094">.</span><span class="ident" id="3833095">Mutex</span>&nbsp;<span class="comment" id="3833101">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833128">done</span>&nbsp;<span class="keyword" id="3833133">chan</span>&nbsp;<span class="builtintype" id="3833138">bool</span><br>
<span class="lineno"></span><span class="op" id="3833143">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="3833146">func</span>&nbsp;<span class="op" id="3833151">(</span><span class="ident" id="3833152">m</span>&nbsp;<span class="op" id="3833154">*</span><span class="ident" id="3833155">maxLatencyWriter</span><span class="op" id="3833171">)</span>&nbsp;<span class="ident" id="3833173">Write</span><span class="op" id="3833178">(</span><span class="ident" id="3833179">p</span>&nbsp;<span class="op" id="3833181">[</span><span class="op" id="3833182">]</span><span class="builtintype" id="3833183">byte</span><span class="op" id="3833187">)</span>&nbsp;<span class="op" id="3833189">(</span><span class="builtintype" id="3833190">int</span><span class="op" id="3833193">,</span>&nbsp;<span class="builtintype" id="3833195">error</span><span class="op" id="3833200">)</span>&nbsp;<span class="op" id="3833202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833205">m</span><span class="op" id="3833206">.</span><span class="ident" id="3833207">lk</span><span class="op" id="3833209">.</span><span class="ident" id="3833210">Lock</span><span class="op" id="3833214">(</span><span class="op" id="3833215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833218">defer</span>&nbsp;<span class="ident" id="3833224">m</span><span class="op" id="3833225">.</span><span class="ident" id="3833226">lk</span><span class="op" id="3833228">.</span><span class="ident" id="3833229">Unlock</span><span class="op" id="3833235">(</span><span class="op" id="3833236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833239">return</span>&nbsp;<span class="ident" id="3833246">m</span><span class="op" id="3833247">.</span><span class="ident" id="3833248">dst</span><span class="op" id="3833251">.</span><span class="ident" id="3833252">Write</span><span class="op" id="3833257">(</span><span class="ident" id="3833258">p</span><span class="op" id="3833259">)</span><br>
<span class="lineno">205</span><span class="op" id="3833261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3833264">func</span>&nbsp;<span class="op" id="3833269">(</span><span class="ident" id="3833270">m</span>&nbsp;<span class="op" id="3833272">*</span><span class="ident" id="3833273">maxLatencyWriter</span><span class="op" id="3833289">)</span>&nbsp;<span class="ident" id="3833291">flushLoop</span><span class="op" id="3833300">(</span><span class="op" id="3833301">)</span>&nbsp;<span class="op" id="3833303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833306">t</span>&nbsp;<span class="op" id="3833308">:=</span>&nbsp;<span class="ident" id="3833311">time</span><span class="op" id="3833315">.</span><span class="ident" id="3833316">NewTicker</span><span class="op" id="3833325">(</span><span class="ident" id="3833326">m</span><span class="op" id="3833327">.</span><span class="ident" id="3833328">latency</span><span class="op" id="3833335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833338">defer</span>&nbsp;<span class="ident" id="3833344">t</span><span class="op" id="3833345">.</span><span class="ident" id="3833346">Stop</span><span class="op" id="3833350">(</span><span class="op" id="3833351">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833354">for</span>&nbsp;<span class="op" id="3833358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833362">select</span>&nbsp;<span class="op" id="3833369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833373">case</span>&nbsp;<span class="op" id="3833378">&lt;-</span><span class="ident" id="3833380">m</span><span class="op" id="3833381">.</span><span class="ident" id="3833382">done</span><span class="op" id="3833386">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833391">if</span>&nbsp;<span class="ident" id="3833394">onExitFlushLoop</span>&nbsp;<span class="op" id="3833410">!=</span>&nbsp;<span class="builtintype" id="3833413">nil</span>&nbsp;<span class="op" id="3833417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833423">onExitFlushLoop</span><span class="op" id="3833438">(</span><span class="op" id="3833439">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3833444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833449">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833458">case</span>&nbsp;<span class="op" id="3833463">&lt;-</span><span class="ident" id="3833465">t</span><span class="op" id="3833466">.</span><span class="ident" id="3833467">C</span><span class="op" id="3833468">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833473">m</span><span class="op" id="3833474">.</span><span class="ident" id="3833475">lk</span><span class="op" id="3833477">.</span><span class="ident" id="3833478">Lock</span><span class="op" id="3833482">(</span><span class="op" id="3833483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833488">m</span><span class="op" id="3833489">.</span><span class="ident" id="3833490">dst</span><span class="op" id="3833493">.</span><span class="ident" id="3833494">Flush</span><span class="op" id="3833499">(</span><span class="op" id="3833500">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833505">m</span><span class="op" id="3833506">.</span><span class="ident" id="3833507">lk</span><span class="op" id="3833509">.</span><span class="ident" id="3833510">Unlock</span><span class="op" id="3833516">(</span><span class="op" id="3833517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3833521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3833524">}</span><br>
<span class="lineno"></span><span class="op" id="3833526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="3833529">func</span>&nbsp;<span class="op" id="3833534">(</span><span class="ident" id="3833535">m</span>&nbsp;<span class="op" id="3833537">*</span><span class="ident" id="3833538">maxLatencyWriter</span><span class="op" id="3833554">)</span>&nbsp;<span class="ident" id="3833556">stop</span><span class="op" id="3833560">(</span><span class="op" id="3833561">)</span>&nbsp;<span class="op" id="3833563">{</span>&nbsp;<span class="ident" id="3833565">m</span><span class="op" id="3833566">.</span><span class="ident" id="3833567">done</span>&nbsp;<span class="op" id="3833572">&lt;-</span>&nbsp;<span class="builtintype" id="3833575">true</span>&nbsp;<span class="op" id="3833580">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
