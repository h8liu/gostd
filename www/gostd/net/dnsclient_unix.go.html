<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html" class="current">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3201952">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3202007">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3202061">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3202112">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3202177">//&nbsp;DNS&nbsp;client:&nbsp;see&nbsp;RFC&nbsp;1035.</span><br>
<span class="lineno"></span><span class="comment" id="3202206">//&nbsp;Has&nbsp;to&nbsp;be&nbsp;linked&nbsp;into&nbsp;package&nbsp;net&nbsp;for&nbsp;Dial.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3202254">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span><span class="comment" id="3202268">//&nbsp;&nbsp;&nbsp;&nbsp;Could&nbsp;potentially&nbsp;handle&nbsp;many&nbsp;outstanding&nbsp;lookups&nbsp;faster.</span><br>
<span class="lineno"></span><span class="comment" id="3202329">//&nbsp;&nbsp;&nbsp;&nbsp;Could&nbsp;have&nbsp;a&nbsp;small&nbsp;cache.</span><br>
<span class="lineno"></span><span class="comment" id="3202358">//&nbsp;&nbsp;&nbsp;&nbsp;Random&nbsp;UDP&nbsp;source&nbsp;port&nbsp;(net.Dial&nbsp;should&nbsp;do&nbsp;that&nbsp;for&nbsp;us).</span><br>
<span class="lineno"></span><span class="comment" id="3202418">//&nbsp;&nbsp;&nbsp;&nbsp;Random&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3202442">package</span>&nbsp;<span class="ident" id="3202450">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3202455">import</span>&nbsp;<span class="op" id="3202462">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3202465">&#34;errors&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3202475">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3202481">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3202494">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3202500">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3202508">&#34;time&#34;</span><br>
<span class="lineno">25</span><span class="op" id="3202515">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3202518">//&nbsp;A&nbsp;dnsConn&nbsp;represents&nbsp;a&nbsp;DNS&nbsp;transport&nbsp;endpoint.</span><br>
<span class="lineno"></span><span class="keyword" id="3202568">type</span>&nbsp;<span class="ident" id="3202573">dnsConn</span>&nbsp;<span class="keyword" id="3202581">interface</span>&nbsp;<span class="op" id="3202591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3202594">Conn</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3202601">//&nbsp;readDNSResponse&nbsp;reads&nbsp;a&nbsp;DNS&nbsp;response&nbsp;message&nbsp;from&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3202663">//&nbsp;transport&nbsp;endpoint&nbsp;and&nbsp;returns&nbsp;the&nbsp;received&nbsp;DNS&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3202724">//&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3202737">readDNSResponse</span><span class="op" id="3202752">(</span><span class="op" id="3202753">)</span>&nbsp;<span class="op" id="3202755">(</span><span class="op" id="3202756">*</span><span class="ident" id="3202757">dnsMsg</span><span class="op" id="3202763">,</span>&nbsp;<span class="builtintype" id="3202765">error</span><span class="op" id="3202770">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3202774">//&nbsp;writeDNSQuery&nbsp;writes&nbsp;a&nbsp;DNS&nbsp;query&nbsp;message&nbsp;to&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3202830">//&nbsp;connection&nbsp;endpoint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3202855">writeDNSQuery</span><span class="op" id="3202868">(</span><span class="op" id="3202869">*</span><span class="ident" id="3202870">dnsMsg</span><span class="op" id="3202876">)</span>&nbsp;<span class="builtintype" id="3202878">error</span><br>
<span class="lineno"></span><span class="op" id="3202884">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3202887">func</span>&nbsp;<span class="op" id="3202892">(</span><span class="ident" id="3202893">c</span>&nbsp;<span class="op" id="3202895">*</span><span class="ident" id="3202896">UDPConn</span><span class="op" id="3202903">)</span>&nbsp;<span class="ident" id="3202905">readDNSResponse</span><span class="op" id="3202920">(</span><span class="op" id="3202921">)</span>&nbsp;<span class="op" id="3202923">(</span><span class="op" id="3202924">*</span><span class="ident" id="3202925">dnsMsg</span><span class="op" id="3202931">,</span>&nbsp;<span class="builtintype" id="3202933">error</span><span class="op" id="3202938">)</span>&nbsp;<span class="op" id="3202940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3202943">b</span>&nbsp;<span class="op" id="3202945">:=</span>&nbsp;<span class="builtinfunc" id="3202948">make</span><span class="op" id="3202952">(</span><span class="op" id="3202953">[</span><span class="op" id="3202954">]</span><span class="builtintype" id="3202955">byte</span><span class="op" id="3202959">,</span>&nbsp;<span class="num" id="3202961">512</span><span class="op" id="3202964">)</span>&nbsp;<span class="comment" id="3202966">//&nbsp;see&nbsp;RFC&nbsp;1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3202983">n</span><span class="op" id="3202984">,</span>&nbsp;<span class="ident" id="3202986">err</span>&nbsp;<span class="op" id="3202990">:=</span>&nbsp;<span class="ident" id="3202993">c</span><span class="op" id="3202994">.</span><span class="ident" id="3202995">Read</span><span class="op" id="3202999">(</span><span class="ident" id="3203000">b</span><span class="op" id="3203001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203004">if</span>&nbsp;<span class="ident" id="3203007">err</span>&nbsp;<span class="op" id="3203011">!=</span>&nbsp;<span class="builtintype" id="3203014">nil</span>&nbsp;<span class="op" id="3203018">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203022">return</span>&nbsp;<span class="builtintype" id="3203029">nil</span><span class="op" id="3203032">,</span>&nbsp;<span class="ident" id="3203034">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3203039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3203042">msg</span>&nbsp;<span class="op" id="3203046">:=</span>&nbsp;<span class="op" id="3203049">&amp;</span><span class="ident" id="3203050">dnsMsg</span><span class="op" id="3203056">{</span><span class="op" id="3203057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203060">if</span>&nbsp;<span class="op" id="3203063">!</span><span class="ident" id="3203064">msg</span><span class="op" id="3203067">.</span><span class="ident" id="3203068">Unpack</span><span class="op" id="3203074">(</span><span class="ident" id="3203075">b</span><span class="op" id="3203076">[</span><span class="op" id="3203077">:</span><span class="ident" id="3203078">n</span><span class="op" id="3203079">]</span><span class="op" id="3203080">)</span>&nbsp;<span class="op" id="3203082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203086">return</span>&nbsp;<span class="builtintype" id="3203093">nil</span><span class="op" id="3203096">,</span>&nbsp;<span class="ident" id="3203098">errors</span><span class="op" id="3203104">.</span><span class="ident" id="3203105">New</span><span class="op" id="3203108">(</span><span class="string" id="3203109">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3203139">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3203142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203145">return</span>&nbsp;<span class="ident" id="3203152">msg</span><span class="op" id="3203155">,</span>&nbsp;<span class="builtintype" id="3203157">nil</span><br>
<span class="lineno"></span><span class="op" id="3203161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3203164">func</span>&nbsp;<span class="op" id="3203169">(</span><span class="ident" id="3203170">c</span>&nbsp;<span class="op" id="3203172">*</span><span class="ident" id="3203173">UDPConn</span><span class="op" id="3203180">)</span>&nbsp;<span class="ident" id="3203182">writeDNSQuery</span><span class="op" id="3203195">(</span><span class="ident" id="3203196">msg</span>&nbsp;<span class="op" id="3203200">*</span><span class="ident" id="3203201">dnsMsg</span><span class="op" id="3203207">)</span>&nbsp;<span class="builtintype" id="3203209">error</span>&nbsp;<span class="op" id="3203215">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3203218">b</span><span class="op" id="3203219">,</span>&nbsp;<span class="ident" id="3203221">ok</span>&nbsp;<span class="op" id="3203224">:=</span>&nbsp;<span class="ident" id="3203227">msg</span><span class="op" id="3203230">.</span><span class="ident" id="3203231">Pack</span><span class="op" id="3203235">(</span><span class="op" id="3203236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203239">if</span>&nbsp;<span class="op" id="3203242">!</span><span class="ident" id="3203243">ok</span>&nbsp;<span class="op" id="3203246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203250">return</span>&nbsp;<span class="ident" id="3203257">errors</span><span class="op" id="3203263">.</span><span class="ident" id="3203264">New</span><span class="op" id="3203267">(</span><span class="string" id="3203268">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3203296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3203299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203302">if</span>&nbsp;<span class="ident" id="3203305">_</span><span class="op" id="3203306">,</span>&nbsp;<span class="ident" id="3203308">err</span>&nbsp;<span class="op" id="3203312">:=</span>&nbsp;<span class="ident" id="3203315">c</span><span class="op" id="3203316">.</span><span class="ident" id="3203317">Write</span><span class="op" id="3203322">(</span><span class="ident" id="3203323">b</span><span class="op" id="3203324">)</span><span class="op" id="3203325">;</span>&nbsp;<span class="ident" id="3203327">err</span>&nbsp;<span class="op" id="3203331">!=</span>&nbsp;<span class="builtintype" id="3203334">nil</span>&nbsp;<span class="op" id="3203338">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203342">return</span>&nbsp;<span class="ident" id="3203349">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3203354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203357">return</span>&nbsp;<span class="builtintype" id="3203364">nil</span><br>
<span class="lineno"></span><span class="op" id="3203368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="3203371">func</span>&nbsp;<span class="op" id="3203376">(</span><span class="ident" id="3203377">c</span>&nbsp;<span class="op" id="3203379">*</span><span class="ident" id="3203380">TCPConn</span><span class="op" id="3203387">)</span>&nbsp;<span class="ident" id="3203389">readDNSResponse</span><span class="op" id="3203404">(</span><span class="op" id="3203405">)</span>&nbsp;<span class="op" id="3203407">(</span><span class="op" id="3203408">*</span><span class="ident" id="3203409">dnsMsg</span><span class="op" id="3203415">,</span>&nbsp;<span class="builtintype" id="3203417">error</span><span class="op" id="3203422">)</span>&nbsp;<span class="op" id="3203424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3203427">b</span>&nbsp;<span class="op" id="3203429">:=</span>&nbsp;<span class="builtinfunc" id="3203432">make</span><span class="op" id="3203436">(</span><span class="op" id="3203437">[</span><span class="op" id="3203438">]</span><span class="builtintype" id="3203439">byte</span><span class="op" id="3203443">,</span>&nbsp;<span class="num" id="3203445">1280</span><span class="op" id="3203449">)</span>&nbsp;<span class="comment" id="3203451">//&nbsp;1280&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;initial&nbsp;size&nbsp;for&nbsp;IP&nbsp;over&nbsp;Ethernet,&nbsp;see&nbsp;RFC&nbsp;4035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203524">if</span>&nbsp;<span class="ident" id="3203527">_</span><span class="op" id="3203528">,</span>&nbsp;<span class="ident" id="3203530">err</span>&nbsp;<span class="op" id="3203534">:=</span>&nbsp;<span class="ident" id="3203537">io</span><span class="op" id="3203539">.</span><span class="ident" id="3203540">ReadFull</span><span class="op" id="3203548">(</span><span class="ident" id="3203549">c</span><span class="op" id="3203550">,</span>&nbsp;<span class="ident" id="3203552">b</span><span class="op" id="3203553">[</span><span class="op" id="3203554">:</span><span class="num" id="3203555">2</span><span class="op" id="3203556">]</span><span class="op" id="3203557">)</span><span class="op" id="3203558">;</span>&nbsp;<span class="ident" id="3203560">err</span>&nbsp;<span class="op" id="3203564">!=</span>&nbsp;<span class="builtintype" id="3203567">nil</span>&nbsp;<span class="op" id="3203571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203575">return</span>&nbsp;<span class="builtintype" id="3203582">nil</span><span class="op" id="3203585">,</span>&nbsp;<span class="ident" id="3203587">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3203592">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3203595">l</span>&nbsp;<span class="op" id="3203597">:=</span>&nbsp;<span class="builtintype" id="3203600">int</span><span class="op" id="3203603">(</span><span class="ident" id="3203604">b</span><span class="op" id="3203605">[</span><span class="num" id="3203606">0</span><span class="op" id="3203607">]</span><span class="op" id="3203608">)</span><span class="op" id="3203609">&lt;&lt;</span><span class="num" id="3203611">8</span>&nbsp;<span class="op" id="3203613">|</span>&nbsp;<span class="builtintype" id="3203615">int</span><span class="op" id="3203618">(</span><span class="ident" id="3203619">b</span><span class="op" id="3203620">[</span><span class="num" id="3203621">1</span><span class="op" id="3203622">]</span><span class="op" id="3203623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203626">if</span>&nbsp;<span class="ident" id="3203629">l</span>&nbsp;<span class="op" id="3203631">&gt;</span>&nbsp;<span class="builtinfunc" id="3203633">len</span><span class="op" id="3203636">(</span><span class="ident" id="3203637">b</span><span class="op" id="3203638">)</span>&nbsp;<span class="op" id="3203640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3203644">b</span>&nbsp;<span class="op" id="3203646">=</span>&nbsp;<span class="builtinfunc" id="3203648">make</span><span class="op" id="3203652">(</span><span class="op" id="3203653">[</span><span class="op" id="3203654">]</span><span class="builtintype" id="3203655">byte</span><span class="op" id="3203659">,</span>&nbsp;<span class="ident" id="3203661">l</span><span class="op" id="3203662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3203665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3203668">n</span><span class="op" id="3203669">,</span>&nbsp;<span class="ident" id="3203671">err</span>&nbsp;<span class="op" id="3203675">:=</span>&nbsp;<span class="ident" id="3203678">io</span><span class="op" id="3203680">.</span><span class="ident" id="3203681">ReadFull</span><span class="op" id="3203689">(</span><span class="ident" id="3203690">c</span><span class="op" id="3203691">,</span>&nbsp;<span class="ident" id="3203693">b</span><span class="op" id="3203694">[</span><span class="op" id="3203695">:</span><span class="ident" id="3203696">l</span><span class="op" id="3203697">]</span><span class="op" id="3203698">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203701">if</span>&nbsp;<span class="ident" id="3203704">err</span>&nbsp;<span class="op" id="3203708">!=</span>&nbsp;<span class="builtintype" id="3203711">nil</span>&nbsp;<span class="op" id="3203715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203719">return</span>&nbsp;<span class="builtintype" id="3203726">nil</span><span class="op" id="3203729">,</span>&nbsp;<span class="ident" id="3203731">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3203736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3203739">msg</span>&nbsp;<span class="op" id="3203743">:=</span>&nbsp;<span class="op" id="3203746">&amp;</span><span class="ident" id="3203747">dnsMsg</span><span class="op" id="3203753">{</span><span class="op" id="3203754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203757">if</span>&nbsp;<span class="op" id="3203760">!</span><span class="ident" id="3203761">msg</span><span class="op" id="3203764">.</span><span class="ident" id="3203765">Unpack</span><span class="op" id="3203771">(</span><span class="ident" id="3203772">b</span><span class="op" id="3203773">[</span><span class="op" id="3203774">:</span><span class="ident" id="3203775">n</span><span class="op" id="3203776">]</span><span class="op" id="3203777">)</span>&nbsp;<span class="op" id="3203779">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203783">return</span>&nbsp;<span class="builtintype" id="3203790">nil</span><span class="op" id="3203793">,</span>&nbsp;<span class="ident" id="3203795">errors</span><span class="op" id="3203801">.</span><span class="ident" id="3203802">New</span><span class="op" id="3203805">(</span><span class="string" id="3203806">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3203836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3203839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203842">return</span>&nbsp;<span class="ident" id="3203849">msg</span><span class="op" id="3203852">,</span>&nbsp;<span class="builtintype" id="3203854">nil</span><br>
<span class="lineno"></span><span class="op" id="3203858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="3203861">func</span>&nbsp;<span class="op" id="3203866">(</span><span class="ident" id="3203867">c</span>&nbsp;<span class="op" id="3203869">*</span><span class="ident" id="3203870">TCPConn</span><span class="op" id="3203877">)</span>&nbsp;<span class="ident" id="3203879">writeDNSQuery</span><span class="op" id="3203892">(</span><span class="ident" id="3203893">msg</span>&nbsp;<span class="op" id="3203897">*</span><span class="ident" id="3203898">dnsMsg</span><span class="op" id="3203904">)</span>&nbsp;<span class="builtintype" id="3203906">error</span>&nbsp;<span class="op" id="3203912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3203915">b</span><span class="op" id="3203916">,</span>&nbsp;<span class="ident" id="3203918">ok</span>&nbsp;<span class="op" id="3203921">:=</span>&nbsp;<span class="ident" id="3203924">msg</span><span class="op" id="3203927">.</span><span class="ident" id="3203928">Pack</span><span class="op" id="3203932">(</span><span class="op" id="3203933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203936">if</span>&nbsp;<span class="op" id="3203939">!</span><span class="ident" id="3203940">ok</span>&nbsp;<span class="op" id="3203943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3203947">return</span>&nbsp;<span class="ident" id="3203954">errors</span><span class="op" id="3203960">.</span><span class="ident" id="3203961">New</span><span class="op" id="3203964">(</span><span class="string" id="3203965">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3203993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3203996">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3203999">l</span>&nbsp;<span class="op" id="3204001">:=</span>&nbsp;<span class="builtintype" id="3204004">uint16</span><span class="op" id="3204010">(</span><span class="builtinfunc" id="3204011">len</span><span class="op" id="3204014">(</span><span class="ident" id="3204015">b</span><span class="op" id="3204016">)</span><span class="op" id="3204017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3204020">b</span>&nbsp;<span class="op" id="3204022">=</span>&nbsp;<span class="builtinfunc" id="3204024">append</span><span class="op" id="3204030">(</span><span class="op" id="3204031">[</span><span class="op" id="3204032">]</span><span class="builtintype" id="3204033">byte</span><span class="op" id="3204037">{</span><span class="builtintype" id="3204038">byte</span><span class="op" id="3204042">(</span><span class="ident" id="3204043">l</span>&nbsp;<span class="op" id="3204045">&gt;&gt;</span>&nbsp;<span class="num" id="3204048">8</span><span class="op" id="3204049">)</span><span class="op" id="3204050">,</span>&nbsp;<span class="builtintype" id="3204052">byte</span><span class="op" id="3204056">(</span><span class="ident" id="3204057">l</span><span class="op" id="3204058">)</span><span class="op" id="3204059">}</span><span class="op" id="3204060">,</span>&nbsp;<span class="ident" id="3204062">b</span><span class="op" id="3204063">...</span><span class="op" id="3204066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3204069">if</span>&nbsp;<span class="ident" id="3204072">_</span><span class="op" id="3204073">,</span>&nbsp;<span class="ident" id="3204075">err</span>&nbsp;<span class="op" id="3204079">:=</span>&nbsp;<span class="ident" id="3204082">c</span><span class="op" id="3204083">.</span><span class="ident" id="3204084">Write</span><span class="op" id="3204089">(</span><span class="ident" id="3204090">b</span><span class="op" id="3204091">)</span><span class="op" id="3204092">;</span>&nbsp;<span class="ident" id="3204094">err</span>&nbsp;<span class="op" id="3204098">!=</span>&nbsp;<span class="builtintype" id="3204101">nil</span>&nbsp;<span class="op" id="3204105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3204109">return</span>&nbsp;<span class="ident" id="3204116">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3204121">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3204124">return</span>&nbsp;<span class="builtintype" id="3204131">nil</span><br>
<span class="lineno"></span><span class="op" id="3204135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3204138">func</span>&nbsp;<span class="op" id="3204143">(</span><span class="ident" id="3204144">d</span>&nbsp;<span class="op" id="3204146">*</span><span class="ident" id="3204147">Dialer</span><span class="op" id="3204153">)</span>&nbsp;<span class="ident" id="3204155">dialDNS</span><span class="op" id="3204162">(</span><span class="ident" id="3204163">network</span><span class="op" id="3204170">,</span>&nbsp;<span class="ident" id="3204172">server</span>&nbsp;<span class="builtintype" id="3204179">string</span><span class="op" id="3204185">)</span>&nbsp;<span class="op" id="3204187">(</span><span class="ident" id="3204188">dnsConn</span><span class="op" id="3204195">,</span>&nbsp;<span class="builtintype" id="3204197">error</span><span class="op" id="3204202">)</span>&nbsp;<span class="op" id="3204204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3204207">switch</span>&nbsp;<span class="ident" id="3204214">network</span>&nbsp;<span class="op" id="3204222">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3204225">case</span>&nbsp;<span class="string" id="3204230">&#34;tcp&#34;</span><span class="op" id="3204235">,</span>&nbsp;<span class="string" id="3204237">&#34;tcp4&#34;</span><span class="op" id="3204243">,</span>&nbsp;<span class="string" id="3204245">&#34;tcp6&#34;</span><span class="op" id="3204251">,</span>&nbsp;<span class="string" id="3204253">&#34;udp&#34;</span><span class="op" id="3204258">,</span>&nbsp;<span class="string" id="3204260">&#34;udp4&#34;</span><span class="op" id="3204266">,</span>&nbsp;<span class="string" id="3204268">&#34;udp6&#34;</span><span class="op" id="3204274">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3204277">default</span><span class="op" id="3204284">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3204288">return</span>&nbsp;<span class="builtintype" id="3204295">nil</span><span class="op" id="3204298">,</span>&nbsp;<span class="ident" id="3204300">UnknownNetworkError</span><span class="op" id="3204319">(</span><span class="ident" id="3204320">network</span><span class="op" id="3204327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3204330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3204333">//&nbsp;Calling&nbsp;Dial&nbsp;here&nbsp;is&nbsp;scary&nbsp;--&nbsp;we&nbsp;have&nbsp;to&nbsp;be&nbsp;sure&nbsp;not&nbsp;to</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3204393">//&nbsp;dial&nbsp;a&nbsp;name&nbsp;that&nbsp;will&nbsp;require&nbsp;a&nbsp;DNS&nbsp;lookup,&nbsp;or&nbsp;Dial&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3204454">//&nbsp;call&nbsp;back&nbsp;here&nbsp;to&nbsp;translate&nbsp;it.&nbsp;The&nbsp;DNS&nbsp;config&nbsp;parser&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3204516">//&nbsp;already&nbsp;checked&nbsp;that&nbsp;all&nbsp;the&nbsp;cfg.servers[i]&nbsp;are&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3204571">//&nbsp;addresses,&nbsp;which&nbsp;Dial&nbsp;will&nbsp;use&nbsp;without&nbsp;a&nbsp;DNS&nbsp;lookup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3204628">c</span><span class="op" id="3204629">,</span>&nbsp;<span class="ident" id="3204631">err</span>&nbsp;<span class="op" id="3204635">:=</span>&nbsp;<span class="ident" id="3204638">d</span><span class="op" id="3204639">.</span><span class="ident" id="3204640">Dial</span><span class="op" id="3204644">(</span><span class="ident" id="3204645">network</span><span class="op" id="3204652">,</span>&nbsp;<span class="ident" id="3204654">server</span><span class="op" id="3204660">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3204663">if</span>&nbsp;<span class="ident" id="3204666">err</span>&nbsp;<span class="op" id="3204670">!=</span>&nbsp;<span class="builtintype" id="3204673">nil</span>&nbsp;<span class="op" id="3204677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3204681">return</span>&nbsp;<span class="builtintype" id="3204688">nil</span><span class="op" id="3204691">,</span>&nbsp;<span class="ident" id="3204693">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3204698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3204701">switch</span>&nbsp;<span class="ident" id="3204708">network</span>&nbsp;<span class="op" id="3204716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3204719">case</span>&nbsp;<span class="string" id="3204724">&#34;tcp&#34;</span><span class="op" id="3204729">,</span>&nbsp;<span class="string" id="3204731">&#34;tcp4&#34;</span><span class="op" id="3204737">,</span>&nbsp;<span class="string" id="3204739">&#34;tcp6&#34;</span><span class="op" id="3204745">:</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3204749">return</span>&nbsp;<span class="ident" id="3204756">c</span><span class="op" id="3204757">.</span><span class="op" id="3204758">(</span><span class="op" id="3204759">*</span><span class="ident" id="3204760">TCPConn</span><span class="op" id="3204767">)</span><span class="op" id="3204768">,</span>&nbsp;<span class="builtintype" id="3204770">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3204775">case</span>&nbsp;<span class="string" id="3204780">&#34;udp&#34;</span><span class="op" id="3204785">,</span>&nbsp;<span class="string" id="3204787">&#34;udp4&#34;</span><span class="op" id="3204793">,</span>&nbsp;<span class="string" id="3204795">&#34;udp6&#34;</span><span class="op" id="3204801">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3204805">return</span>&nbsp;<span class="ident" id="3204812">c</span><span class="op" id="3204813">.</span><span class="op" id="3204814">(</span><span class="op" id="3204815">*</span><span class="ident" id="3204816">UDPConn</span><span class="op" id="3204823">)</span><span class="op" id="3204824">,</span>&nbsp;<span class="builtintype" id="3204826">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3204831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3204834">panic</span><span class="op" id="3204839">(</span><span class="string" id="3204840">&#34;unreachable&#34;</span><span class="op" id="3204853">)</span><br>
<span class="lineno">120</span><span class="op" id="3204855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3204858">//&nbsp;exchange&nbsp;sends&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;connection&nbsp;and&nbsp;hopes&nbsp;for&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3204928">func</span>&nbsp;<span class="ident" id="3204933">exchange</span><span class="op" id="3204941">(</span><span class="ident" id="3204942">server</span><span class="op" id="3204948">,</span>&nbsp;<span class="ident" id="3204950">name</span>&nbsp;<span class="builtintype" id="3204955">string</span><span class="op" id="3204961">,</span>&nbsp;<span class="ident" id="3204963">qtype</span>&nbsp;<span class="builtintype" id="3204969">uint16</span><span class="op" id="3204975">,</span>&nbsp;<span class="ident" id="3204977">timeout</span>&nbsp;<span class="ident" id="3204985">time</span><span class="op" id="3204989">.</span><span class="ident" id="3204990">Duration</span><span class="op" id="3204998">)</span>&nbsp;<span class="op" id="3205000">(</span><span class="op" id="3205001">*</span><span class="ident" id="3205002">dnsMsg</span><span class="op" id="3205008">,</span>&nbsp;<span class="builtintype" id="3205010">error</span><span class="op" id="3205015">)</span>&nbsp;<span class="op" id="3205017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3205020">d</span>&nbsp;<span class="op" id="3205022">:=</span>&nbsp;<span class="ident" id="3205025">Dialer</span><span class="op" id="3205031">{</span><span class="ident" id="3205032">Timeout</span><span class="op" id="3205039">:</span>&nbsp;<span class="ident" id="3205041">timeout</span><span class="op" id="3205048">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3205051">out</span>&nbsp;<span class="op" id="3205055">:=</span>&nbsp;<span class="ident" id="3205058">dnsMsg</span><span class="op" id="3205064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3205068">dnsMsgHdr</span><span class="op" id="3205077">:</span>&nbsp;<span class="ident" id="3205079">dnsMsgHdr</span><span class="op" id="3205088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3205093">recursion_desired</span><span class="op" id="3205110">:</span>&nbsp;<span class="builtintype" id="3205112">true</span><span class="op" id="3205116">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3205120">}</span><span class="op" id="3205121">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3205125">question</span><span class="op" id="3205133">:</span>&nbsp;<span class="op" id="3205135">[</span><span class="op" id="3205136">]</span><span class="ident" id="3205137">dnsQuestion</span><span class="op" id="3205148">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3205153">{</span><span class="ident" id="3205154">name</span><span class="op" id="3205158">,</span>&nbsp;<span class="ident" id="3205160">qtype</span><span class="op" id="3205165">,</span>&nbsp;<span class="ident" id="3205167">dnsClassINET</span><span class="op" id="3205179">}</span><span class="op" id="3205180">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3205184">}</span><span class="op" id="3205185">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3205188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3205191">for</span>&nbsp;<span class="ident" id="3205195">_</span><span class="op" id="3205196">,</span>&nbsp;<span class="ident" id="3205198">network</span>&nbsp;<span class="op" id="3205206">:=</span>&nbsp;<span class="keyword" id="3205209">range</span>&nbsp;<span class="op" id="3205215">[</span><span class="op" id="3205216">]</span><span class="builtintype" id="3205217">string</span><span class="op" id="3205223">{</span><span class="string" id="3205224">&#34;udp&#34;</span><span class="op" id="3205229">,</span>&nbsp;<span class="string" id="3205231">&#34;tcp&#34;</span><span class="op" id="3205236">}</span>&nbsp;<span class="op" id="3205238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3205242">c</span><span class="op" id="3205243">,</span>&nbsp;<span class="ident" id="3205245">err</span>&nbsp;<span class="op" id="3205249">:=</span>&nbsp;<span class="ident" id="3205252">d</span><span class="op" id="3205253">.</span><span class="ident" id="3205254">dialDNS</span><span class="op" id="3205261">(</span><span class="ident" id="3205262">network</span><span class="op" id="3205269">,</span>&nbsp;<span class="ident" id="3205271">server</span><span class="op" id="3205277">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3205281">if</span>&nbsp;<span class="ident" id="3205284">err</span>&nbsp;<span class="op" id="3205288">!=</span>&nbsp;<span class="builtintype" id="3205291">nil</span>&nbsp;<span class="op" id="3205295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3205300">return</span>&nbsp;<span class="builtintype" id="3205307">nil</span><span class="op" id="3205310">,</span>&nbsp;<span class="ident" id="3205312">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3205318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3205322">defer</span>&nbsp;<span class="ident" id="3205328">c</span><span class="op" id="3205329">.</span><span class="ident" id="3205330">Close</span><span class="op" id="3205335">(</span><span class="op" id="3205336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3205340">if</span>&nbsp;<span class="ident" id="3205343">timeout</span>&nbsp;<span class="op" id="3205351">&gt;</span>&nbsp;<span class="num" id="3205353">0</span>&nbsp;<span class="op" id="3205355">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3205360">c</span><span class="op" id="3205361">.</span><span class="ident" id="3205362">SetDeadline</span><span class="op" id="3205373">(</span><span class="ident" id="3205374">time</span><span class="op" id="3205378">.</span><span class="ident" id="3205379">Now</span><span class="op" id="3205382">(</span><span class="op" id="3205383">)</span><span class="op" id="3205384">.</span><span class="ident" id="3205385">Add</span><span class="op" id="3205388">(</span><span class="ident" id="3205389">timeout</span><span class="op" id="3205396">)</span><span class="op" id="3205397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3205401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3205405">out</span><span class="op" id="3205408">.</span><span class="ident" id="3205409">id</span>&nbsp;<span class="op" id="3205412">=</span>&nbsp;<span class="builtintype" id="3205414">uint16</span><span class="op" id="3205420">(</span><span class="ident" id="3205421">rand</span><span class="op" id="3205425">.</span><span class="ident" id="3205426">Int</span><span class="op" id="3205429">(</span><span class="op" id="3205430">)</span><span class="op" id="3205431">)</span>&nbsp;<span class="op" id="3205433">^</span>&nbsp;<span class="builtintype" id="3205435">uint16</span><span class="op" id="3205441">(</span><span class="ident" id="3205442">time</span><span class="op" id="3205446">.</span><span class="ident" id="3205447">Now</span><span class="op" id="3205450">(</span><span class="op" id="3205451">)</span><span class="op" id="3205452">.</span><span class="ident" id="3205453">UnixNano</span><span class="op" id="3205461">(</span><span class="op" id="3205462">)</span><span class="op" id="3205463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3205467">if</span>&nbsp;<span class="ident" id="3205470">err</span>&nbsp;<span class="op" id="3205474">:=</span>&nbsp;<span class="ident" id="3205477">c</span><span class="op" id="3205478">.</span><span class="ident" id="3205479">writeDNSQuery</span><span class="op" id="3205492">(</span><span class="op" id="3205493">&amp;</span><span class="ident" id="3205494">out</span><span class="op" id="3205497">)</span><span class="op" id="3205498">;</span>&nbsp;<span class="ident" id="3205500">err</span>&nbsp;<span class="op" id="3205504">!=</span>&nbsp;<span class="builtintype" id="3205507">nil</span>&nbsp;<span class="op" id="3205511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3205516">return</span>&nbsp;<span class="builtintype" id="3205523">nil</span><span class="op" id="3205526">,</span>&nbsp;<span class="ident" id="3205528">err</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3205534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3205538">in</span><span class="op" id="3205540">,</span>&nbsp;<span class="ident" id="3205542">err</span>&nbsp;<span class="op" id="3205546">:=</span>&nbsp;<span class="ident" id="3205549">c</span><span class="op" id="3205550">.</span><span class="ident" id="3205551">readDNSResponse</span><span class="op" id="3205566">(</span><span class="op" id="3205567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3205571">if</span>&nbsp;<span class="ident" id="3205574">err</span>&nbsp;<span class="op" id="3205578">!=</span>&nbsp;<span class="builtintype" id="3205581">nil</span>&nbsp;<span class="op" id="3205585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3205590">return</span>&nbsp;<span class="builtintype" id="3205597">nil</span><span class="op" id="3205600">,</span>&nbsp;<span class="ident" id="3205602">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3205608">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3205612">if</span>&nbsp;<span class="ident" id="3205615">in</span><span class="op" id="3205617">.</span><span class="ident" id="3205618">id</span>&nbsp;<span class="op" id="3205621">!=</span>&nbsp;<span class="ident" id="3205624">out</span><span class="op" id="3205627">.</span><span class="ident" id="3205628">id</span>&nbsp;<span class="op" id="3205631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3205636">return</span>&nbsp;<span class="builtintype" id="3205643">nil</span><span class="op" id="3205646">,</span>&nbsp;<span class="ident" id="3205648">errors</span><span class="op" id="3205654">.</span><span class="ident" id="3205655">New</span><span class="op" id="3205658">(</span><span class="string" id="3205659">&#34;DNS&nbsp;message&nbsp;ID&nbsp;mismatch&#34;</span><span class="op" id="3205684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3205688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3205692">if</span>&nbsp;<span class="ident" id="3205695">in</span><span class="op" id="3205697">.</span><span class="ident" id="3205698">truncated</span>&nbsp;<span class="op" id="3205708">{</span>&nbsp;<span class="comment" id="3205710">//&nbsp;see&nbsp;RFC&nbsp;5966</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3205729">continue</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3205740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3205744">return</span>&nbsp;<span class="ident" id="3205751">in</span><span class="op" id="3205753">,</span>&nbsp;<span class="builtintype" id="3205755">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3205760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3205763">return</span>&nbsp;<span class="builtintype" id="3205770">nil</span><span class="op" id="3205773">,</span>&nbsp;<span class="ident" id="3205775">errors</span><span class="op" id="3205781">.</span><span class="ident" id="3205782">New</span><span class="op" id="3205785">(</span><span class="string" id="3205786">&#34;no&nbsp;answer&nbsp;from&nbsp;DNS&nbsp;server&#34;</span><span class="op" id="3205813">)</span><br>
<span class="lineno"></span><span class="op" id="3205815">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="3205818">//&nbsp;Do&nbsp;a&nbsp;lookup&nbsp;for&nbsp;a&nbsp;single&nbsp;name,&nbsp;which&nbsp;must&nbsp;be&nbsp;rooted</span><br>
<span class="lineno"></span><span class="comment" id="3205873">//&nbsp;(otherwise&nbsp;answer&nbsp;will&nbsp;not&nbsp;find&nbsp;the&nbsp;answers).</span><br>
<span class="lineno"></span><span class="keyword" id="3205922">func</span>&nbsp;<span class="ident" id="3205927">tryOneName</span><span class="op" id="3205937">(</span><span class="ident" id="3205938">cfg</span>&nbsp;<span class="op" id="3205942">*</span><span class="ident" id="3205943">dnsConfig</span><span class="op" id="3205952">,</span>&nbsp;<span class="ident" id="3205954">name</span>&nbsp;<span class="builtintype" id="3205959">string</span><span class="op" id="3205965">,</span>&nbsp;<span class="ident" id="3205967">qtype</span>&nbsp;<span class="builtintype" id="3205973">uint16</span><span class="op" id="3205979">)</span>&nbsp;<span class="op" id="3205981">(</span><span class="builtintype" id="3205982">string</span><span class="op" id="3205988">,</span>&nbsp;<span class="op" id="3205990">[</span><span class="op" id="3205991">]</span><span class="ident" id="3205992">dnsRR</span><span class="op" id="3205997">,</span>&nbsp;<span class="builtintype" id="3205999">error</span><span class="op" id="3206004">)</span>&nbsp;<span class="op" id="3206006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3206009">if</span>&nbsp;<span class="builtinfunc" id="3206012">len</span><span class="op" id="3206015">(</span><span class="ident" id="3206016">cfg</span><span class="op" id="3206019">.</span><span class="ident" id="3206020">servers</span><span class="op" id="3206027">)</span>&nbsp;<span class="op" id="3206029">==</span>&nbsp;<span class="num" id="3206032">0</span>&nbsp;<span class="op" id="3206034">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3206038">return</span>&nbsp;<span class="string" id="3206045">&#34;&#34;</span><span class="op" id="3206047">,</span>&nbsp;<span class="builtintype" id="3206049">nil</span><span class="op" id="3206052">,</span>&nbsp;<span class="op" id="3206054">&amp;</span><span class="ident" id="3206055">DNSError</span><span class="op" id="3206063">{</span><span class="ident" id="3206064">Err</span><span class="op" id="3206067">:</span>&nbsp;<span class="string" id="3206069">&#34;no&nbsp;DNS&nbsp;servers&#34;</span><span class="op" id="3206085">,</span>&nbsp;<span class="ident" id="3206087">Name</span><span class="op" id="3206091">:</span>&nbsp;<span class="ident" id="3206093">name</span><span class="op" id="3206097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3206100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3206103">if</span>&nbsp;<span class="builtinfunc" id="3206106">len</span><span class="op" id="3206109">(</span><span class="ident" id="3206110">name</span><span class="op" id="3206114">)</span>&nbsp;<span class="op" id="3206116">&gt;=</span>&nbsp;<span class="num" id="3206119">256</span>&nbsp;<span class="op" id="3206123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3206127">return</span>&nbsp;<span class="string" id="3206134">&#34;&#34;</span><span class="op" id="3206136">,</span>&nbsp;<span class="builtintype" id="3206138">nil</span><span class="op" id="3206141">,</span>&nbsp;<span class="op" id="3206143">&amp;</span><span class="ident" id="3206144">DNSError</span><span class="op" id="3206152">{</span><span class="ident" id="3206153">Err</span><span class="op" id="3206156">:</span>&nbsp;<span class="string" id="3206158">&#34;DNS&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="3206177">,</span>&nbsp;<span class="ident" id="3206179">Name</span><span class="op" id="3206183">:</span>&nbsp;<span class="ident" id="3206185">name</span><span class="op" id="3206189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3206192">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3206195">timeout</span>&nbsp;<span class="op" id="3206203">:=</span>&nbsp;<span class="ident" id="3206206">time</span><span class="op" id="3206210">.</span><span class="ident" id="3206211">Duration</span><span class="op" id="3206219">(</span><span class="ident" id="3206220">cfg</span><span class="op" id="3206223">.</span><span class="ident" id="3206224">timeout</span><span class="op" id="3206231">)</span>&nbsp;<span class="op" id="3206233">*</span>&nbsp;<span class="ident" id="3206235">time</span><span class="op" id="3206239">.</span><span class="ident" id="3206240">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3206248">var</span>&nbsp;<span class="ident" id="3206252">lastErr</span>&nbsp;<span class="builtintype" id="3206260">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3206267">for</span>&nbsp;<span class="ident" id="3206271">i</span>&nbsp;<span class="op" id="3206273">:=</span>&nbsp;<span class="num" id="3206276">0</span><span class="op" id="3206277">;</span>&nbsp;<span class="ident" id="3206279">i</span>&nbsp;<span class="op" id="3206281">&lt;</span>&nbsp;<span class="ident" id="3206283">cfg</span><span class="op" id="3206286">.</span><span class="ident" id="3206287">attempts</span><span class="op" id="3206295">;</span>&nbsp;<span class="ident" id="3206297">i</span><span class="op" id="3206298">++</span>&nbsp;<span class="op" id="3206301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3206305">for</span>&nbsp;<span class="ident" id="3206309">_</span><span class="op" id="3206310">,</span>&nbsp;<span class="ident" id="3206312">server</span>&nbsp;<span class="op" id="3206319">:=</span>&nbsp;<span class="keyword" id="3206322">range</span>&nbsp;<span class="ident" id="3206328">cfg</span><span class="op" id="3206331">.</span><span class="ident" id="3206332">servers</span>&nbsp;<span class="op" id="3206340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3206345">server</span>&nbsp;<span class="op" id="3206352">=</span>&nbsp;<span class="ident" id="3206354">JoinHostPort</span><span class="op" id="3206366">(</span><span class="ident" id="3206367">server</span><span class="op" id="3206373">,</span>&nbsp;<span class="string" id="3206375">&#34;53&#34;</span><span class="op" id="3206379">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3206384">msg</span><span class="op" id="3206387">,</span>&nbsp;<span class="ident" id="3206389">err</span>&nbsp;<span class="op" id="3206393">:=</span>&nbsp;<span class="ident" id="3206396">exchange</span><span class="op" id="3206404">(</span><span class="ident" id="3206405">server</span><span class="op" id="3206411">,</span>&nbsp;<span class="ident" id="3206413">name</span><span class="op" id="3206417">,</span>&nbsp;<span class="ident" id="3206419">qtype</span><span class="op" id="3206424">,</span>&nbsp;<span class="ident" id="3206426">timeout</span><span class="op" id="3206433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3206438">if</span>&nbsp;<span class="ident" id="3206441">err</span>&nbsp;<span class="op" id="3206445">!=</span>&nbsp;<span class="builtintype" id="3206448">nil</span>&nbsp;<span class="op" id="3206452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3206458">lastErr</span>&nbsp;<span class="op" id="3206466">=</span>&nbsp;<span class="op" id="3206468">&amp;</span><span class="ident" id="3206469">DNSError</span><span class="op" id="3206477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3206484">Err</span><span class="op" id="3206487">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3206492">err</span><span class="op" id="3206495">.</span><span class="ident" id="3206496">Error</span><span class="op" id="3206501">(</span><span class="op" id="3206502">)</span><span class="op" id="3206503">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3206510">Name</span><span class="op" id="3206514">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3206518">name</span><span class="op" id="3206522">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3206529">Server</span><span class="op" id="3206535">:</span>&nbsp;<span class="ident" id="3206537">server</span><span class="op" id="3206543">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3206549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3206555">if</span>&nbsp;<span class="ident" id="3206558">nerr</span><span class="op" id="3206562">,</span>&nbsp;<span class="ident" id="3206564">ok</span>&nbsp;<span class="op" id="3206567">:=</span>&nbsp;<span class="ident" id="3206570">err</span><span class="op" id="3206573">.</span><span class="op" id="3206574">(</span><span class="ident" id="3206575">Error</span><span class="op" id="3206580">)</span><span class="op" id="3206581">;</span>&nbsp;<span class="ident" id="3206583">ok</span>&nbsp;<span class="op" id="3206586">&amp;&amp;</span>&nbsp;<span class="ident" id="3206589">nerr</span><span class="op" id="3206593">.</span><span class="ident" id="3206594">Timeout</span><span class="op" id="3206601">(</span><span class="op" id="3206602">)</span>&nbsp;<span class="op" id="3206604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3206611">lastErr</span><span class="op" id="3206618">.</span><span class="op" id="3206619">(</span><span class="op" id="3206620">*</span><span class="ident" id="3206621">DNSError</span><span class="op" id="3206629">)</span><span class="op" id="3206630">.</span><span class="ident" id="3206631">IsTimeout</span>&nbsp;<span class="op" id="3206641">=</span>&nbsp;<span class="builtintype" id="3206643">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3206652">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3206658">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3206670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3206675">cname</span><span class="op" id="3206680">,</span>&nbsp;<span class="ident" id="3206682">addrs</span><span class="op" id="3206687">,</span>&nbsp;<span class="ident" id="3206689">err</span>&nbsp;<span class="op" id="3206693">:=</span>&nbsp;<span class="ident" id="3206696">answer</span><span class="op" id="3206702">(</span><span class="ident" id="3206703">name</span><span class="op" id="3206707">,</span>&nbsp;<span class="ident" id="3206709">server</span><span class="op" id="3206715">,</span>&nbsp;<span class="ident" id="3206717">msg</span><span class="op" id="3206720">,</span>&nbsp;<span class="ident" id="3206722">qtype</span><span class="op" id="3206727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3206732">if</span>&nbsp;<span class="ident" id="3206735">err</span>&nbsp;<span class="op" id="3206739">==</span>&nbsp;<span class="builtintype" id="3206742">nil</span>&nbsp;<span class="op" id="3206746">||</span>&nbsp;<span class="ident" id="3206749">err</span><span class="op" id="3206752">.</span><span class="op" id="3206753">(</span><span class="op" id="3206754">*</span><span class="ident" id="3206755">DNSError</span><span class="op" id="3206763">)</span><span class="op" id="3206764">.</span><span class="ident" id="3206765">Err</span>&nbsp;<span class="op" id="3206769">==</span>&nbsp;<span class="ident" id="3206772">noSuchHost</span>&nbsp;<span class="op" id="3206783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3206789">return</span>&nbsp;<span class="ident" id="3206796">cname</span><span class="op" id="3206801">,</span>&nbsp;<span class="ident" id="3206803">addrs</span><span class="op" id="3206808">,</span>&nbsp;<span class="ident" id="3206810">err</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3206817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3206822">lastErr</span>&nbsp;<span class="op" id="3206830">=</span>&nbsp;<span class="ident" id="3206832">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3206838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3206841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3206844">return</span>&nbsp;<span class="string" id="3206851">&#34;&#34;</span><span class="op" id="3206853">,</span>&nbsp;<span class="builtintype" id="3206855">nil</span><span class="op" id="3206858">,</span>&nbsp;<span class="ident" id="3206860">lastErr</span><br>
<span class="lineno">195</span><span class="op" id="3206868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3206871">func</span>&nbsp;<span class="ident" id="3206876">convertRR_A</span><span class="op" id="3206887">(</span><span class="ident" id="3206888">records</span>&nbsp;<span class="op" id="3206896">[</span><span class="op" id="3206897">]</span><span class="ident" id="3206898">dnsRR</span><span class="op" id="3206903">)</span>&nbsp;<span class="op" id="3206905">[</span><span class="op" id="3206906">]</span><span class="ident" id="3206907">IP</span>&nbsp;<span class="op" id="3206910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3206913">addrs</span>&nbsp;<span class="op" id="3206919">:=</span>&nbsp;<span class="builtinfunc" id="3206922">make</span><span class="op" id="3206926">(</span><span class="op" id="3206927">[</span><span class="op" id="3206928">]</span><span class="ident" id="3206929">IP</span><span class="op" id="3206931">,</span>&nbsp;<span class="builtinfunc" id="3206933">len</span><span class="op" id="3206936">(</span><span class="ident" id="3206937">records</span><span class="op" id="3206944">)</span><span class="op" id="3206945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3206948">for</span>&nbsp;<span class="ident" id="3206952">i</span><span class="op" id="3206953">,</span>&nbsp;<span class="ident" id="3206955">rr</span>&nbsp;<span class="op" id="3206958">:=</span>&nbsp;<span class="keyword" id="3206961">range</span>&nbsp;<span class="ident" id="3206967">records</span>&nbsp;<span class="op" id="3206975">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3206979">a</span>&nbsp;<span class="op" id="3206981">:=</span>&nbsp;<span class="ident" id="3206984">rr</span><span class="op" id="3206986">.</span><span class="op" id="3206987">(</span><span class="op" id="3206988">*</span><span class="ident" id="3206989">dnsRR_A</span><span class="op" id="3206996">)</span><span class="op" id="3206997">.</span><span class="ident" id="3206998">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207002">addrs</span><span class="op" id="3207007">[</span><span class="ident" id="3207008">i</span><span class="op" id="3207009">]</span>&nbsp;<span class="op" id="3207011">=</span>&nbsp;<span class="ident" id="3207013">IPv4</span><span class="op" id="3207017">(</span><span class="builtintype" id="3207018">byte</span><span class="op" id="3207022">(</span><span class="ident" id="3207023">a</span><span class="op" id="3207024">&gt;&gt;</span><span class="num" id="3207026">24</span><span class="op" id="3207028">)</span><span class="op" id="3207029">,</span>&nbsp;<span class="builtintype" id="3207031">byte</span><span class="op" id="3207035">(</span><span class="ident" id="3207036">a</span><span class="op" id="3207037">&gt;&gt;</span><span class="num" id="3207039">16</span><span class="op" id="3207041">)</span><span class="op" id="3207042">,</span>&nbsp;<span class="builtintype" id="3207044">byte</span><span class="op" id="3207048">(</span><span class="ident" id="3207049">a</span><span class="op" id="3207050">&gt;&gt;</span><span class="num" id="3207052">8</span><span class="op" id="3207053">)</span><span class="op" id="3207054">,</span>&nbsp;<span class="builtintype" id="3207056">byte</span><span class="op" id="3207060">(</span><span class="ident" id="3207061">a</span><span class="op" id="3207062">)</span><span class="op" id="3207063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3207066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3207069">return</span>&nbsp;<span class="ident" id="3207076">addrs</span><br>
<span class="lineno"></span><span class="op" id="3207082">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="3207085">func</span>&nbsp;<span class="ident" id="3207090">convertRR_AAAA</span><span class="op" id="3207104">(</span><span class="ident" id="3207105">records</span>&nbsp;<span class="op" id="3207113">[</span><span class="op" id="3207114">]</span><span class="ident" id="3207115">dnsRR</span><span class="op" id="3207120">)</span>&nbsp;<span class="op" id="3207122">[</span><span class="op" id="3207123">]</span><span class="ident" id="3207124">IP</span>&nbsp;<span class="op" id="3207127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207130">addrs</span>&nbsp;<span class="op" id="3207136">:=</span>&nbsp;<span class="builtinfunc" id="3207139">make</span><span class="op" id="3207143">(</span><span class="op" id="3207144">[</span><span class="op" id="3207145">]</span><span class="ident" id="3207146">IP</span><span class="op" id="3207148">,</span>&nbsp;<span class="builtinfunc" id="3207150">len</span><span class="op" id="3207153">(</span><span class="ident" id="3207154">records</span><span class="op" id="3207161">)</span><span class="op" id="3207162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3207165">for</span>&nbsp;<span class="ident" id="3207169">i</span><span class="op" id="3207170">,</span>&nbsp;<span class="ident" id="3207172">rr</span>&nbsp;<span class="op" id="3207175">:=</span>&nbsp;<span class="keyword" id="3207178">range</span>&nbsp;<span class="ident" id="3207184">records</span>&nbsp;<span class="op" id="3207192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207196">a</span>&nbsp;<span class="op" id="3207198">:=</span>&nbsp;<span class="builtinfunc" id="3207201">make</span><span class="op" id="3207205">(</span><span class="ident" id="3207206">IP</span><span class="op" id="3207208">,</span>&nbsp;<span class="ident" id="3207210">IPv6len</span><span class="op" id="3207217">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3207221">copy</span><span class="op" id="3207225">(</span><span class="ident" id="3207226">a</span><span class="op" id="3207227">,</span>&nbsp;<span class="ident" id="3207229">rr</span><span class="op" id="3207231">.</span><span class="op" id="3207232">(</span><span class="op" id="3207233">*</span><span class="ident" id="3207234">dnsRR_AAAA</span><span class="op" id="3207244">)</span><span class="op" id="3207245">.</span><span class="ident" id="3207246">AAAA</span><span class="op" id="3207250">[</span><span class="op" id="3207251">:</span><span class="op" id="3207252">]</span><span class="op" id="3207253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207257">addrs</span><span class="op" id="3207262">[</span><span class="ident" id="3207263">i</span><span class="op" id="3207264">]</span>&nbsp;<span class="op" id="3207266">=</span>&nbsp;<span class="ident" id="3207268">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3207271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3207274">return</span>&nbsp;<span class="ident" id="3207281">addrs</span><br>
<span class="lineno"></span><span class="op" id="3207287">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="3207290">var</span>&nbsp;<span class="ident" id="3207294">cfg</span>&nbsp;<span class="keyword" id="3207298">struct</span>&nbsp;<span class="op" id="3207305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207308">ch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3207318">chan</span>&nbsp;<span class="keyword" id="3207323">struct</span><span class="op" id="3207329">{</span><span class="op" id="3207330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207333">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207343">sync</span><span class="op" id="3207347">.</span><span class="ident" id="3207348">RWMutex</span>&nbsp;<span class="comment" id="3207356">//&nbsp;protects&nbsp;dnsConfig&nbsp;and&nbsp;dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207390">dnsConfig</span>&nbsp;<span class="op" id="3207400">*</span><span class="ident" id="3207401">dnsConfig</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207412">dnserr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3207422">error</span><br>
<span class="lineno"></span><span class="op" id="3207428">}</span><br>
<span class="lineno"></span><span class="keyword" id="3207430">var</span>&nbsp;<span class="ident" id="3207434">onceLoadConfig</span>&nbsp;<span class="ident" id="3207449">sync</span><span class="op" id="3207453">.</span><span class="ident" id="3207454">Once</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3207460">//&nbsp;Assume&nbsp;dns&nbsp;config&nbsp;file&nbsp;is&nbsp;/etc/resolv.conf&nbsp;here</span><br>
<span class="lineno">225</span><span class="keyword" id="3207511">func</span>&nbsp;<span class="ident" id="3207516">loadDefaultConfig</span><span class="op" id="3207533">(</span><span class="op" id="3207534">)</span>&nbsp;<span class="op" id="3207536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207539">loadConfig</span><span class="op" id="3207549">(</span><span class="string" id="3207550">&#34;/etc/resolv.conf&#34;</span><span class="op" id="3207568">,</span>&nbsp;<span class="num" id="3207570">5</span><span class="op" id="3207571">*</span><span class="ident" id="3207572">time</span><span class="op" id="3207576">.</span><span class="ident" id="3207577">Second</span><span class="op" id="3207583">,</span>&nbsp;<span class="builtintype" id="3207585">nil</span><span class="op" id="3207588">)</span><br>
<span class="lineno"></span><span class="op" id="3207590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3207593">func</span>&nbsp;<span class="ident" id="3207598">loadConfig</span><span class="op" id="3207608">(</span><span class="ident" id="3207609">resolvConfPath</span>&nbsp;<span class="builtintype" id="3207624">string</span><span class="op" id="3207630">,</span>&nbsp;<span class="ident" id="3207632">reloadTime</span>&nbsp;<span class="ident" id="3207643">time</span><span class="op" id="3207647">.</span><span class="ident" id="3207648">Duration</span><span class="op" id="3207656">,</span>&nbsp;<span class="ident" id="3207658">quit</span>&nbsp;<span class="op" id="3207663">&lt;-</span><span class="keyword" id="3207665">chan</span>&nbsp;<span class="keyword" id="3207670">chan</span>&nbsp;<span class="keyword" id="3207675">struct</span><span class="op" id="3207681">{</span><span class="op" id="3207682">}</span><span class="op" id="3207683">)</span>&nbsp;<span class="op" id="3207685">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3207688">var</span>&nbsp;<span class="ident" id="3207692">mtime</span>&nbsp;<span class="ident" id="3207698">time</span><span class="op" id="3207702">.</span><span class="ident" id="3207703">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207709">cfg</span><span class="op" id="3207712">.</span><span class="ident" id="3207713">ch</span>&nbsp;<span class="op" id="3207716">=</span>&nbsp;<span class="builtinfunc" id="3207718">make</span><span class="op" id="3207722">(</span><span class="keyword" id="3207723">chan</span>&nbsp;<span class="keyword" id="3207728">struct</span><span class="op" id="3207734">{</span><span class="op" id="3207735">}</span><span class="op" id="3207736">,</span>&nbsp;<span class="num" id="3207738">1</span><span class="op" id="3207739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3207742">if</span>&nbsp;<span class="ident" id="3207745">fi</span><span class="op" id="3207747">,</span>&nbsp;<span class="ident" id="3207749">err</span>&nbsp;<span class="op" id="3207753">:=</span>&nbsp;<span class="ident" id="3207756">os</span><span class="op" id="3207758">.</span><span class="ident" id="3207759">Stat</span><span class="op" id="3207763">(</span><span class="ident" id="3207764">resolvConfPath</span><span class="op" id="3207778">)</span><span class="op" id="3207779">;</span>&nbsp;<span class="ident" id="3207781">err</span>&nbsp;<span class="op" id="3207785">!=</span>&nbsp;<span class="builtintype" id="3207788">nil</span>&nbsp;<span class="op" id="3207792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207796">cfg</span><span class="op" id="3207799">.</span><span class="ident" id="3207800">dnserr</span>&nbsp;<span class="op" id="3207807">=</span>&nbsp;<span class="ident" id="3207809">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3207814">}</span>&nbsp;<span class="keyword" id="3207816">else</span>&nbsp;<span class="op" id="3207821">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207825">mtime</span>&nbsp;<span class="op" id="3207831">=</span>&nbsp;<span class="ident" id="3207833">fi</span><span class="op" id="3207835">.</span><span class="ident" id="3207836">ModTime</span><span class="op" id="3207843">(</span><span class="op" id="3207844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207848">cfg</span><span class="op" id="3207851">.</span><span class="ident" id="3207852">dnsConfig</span><span class="op" id="3207861">,</span>&nbsp;<span class="ident" id="3207863">cfg</span><span class="op" id="3207866">.</span><span class="ident" id="3207867">dnserr</span>&nbsp;<span class="op" id="3207874">=</span>&nbsp;<span class="ident" id="3207876">dnsReadConfig</span><span class="op" id="3207889">(</span><span class="ident" id="3207890">resolvConfPath</span><span class="op" id="3207904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3207907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3207910">go</span>&nbsp;<span class="keyword" id="3207913">func</span><span class="op" id="3207917">(</span><span class="op" id="3207918">)</span>&nbsp;<span class="op" id="3207920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3207924">for</span>&nbsp;<span class="op" id="3207928">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207933">time</span><span class="op" id="3207937">.</span><span class="ident" id="3207938">Sleep</span><span class="op" id="3207943">(</span><span class="ident" id="3207944">reloadTime</span><span class="op" id="3207954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3207959">select</span>&nbsp;<span class="op" id="3207966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3207971">case</span>&nbsp;<span class="ident" id="3207976">qresp</span>&nbsp;<span class="op" id="3207982">:=</span>&nbsp;<span class="op" id="3207985">&lt;-</span><span class="ident" id="3207987">quit</span><span class="op" id="3207991">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3207997">qresp</span>&nbsp;<span class="op" id="3208003">&lt;-</span>&nbsp;<span class="keyword" id="3208006">struct</span><span class="op" id="3208012">{</span><span class="op" id="3208013">}</span><span class="op" id="3208014">{</span><span class="op" id="3208015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208021">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208031">case</span>&nbsp;<span class="op" id="3208036">&lt;-</span><span class="ident" id="3208038">cfg</span><span class="op" id="3208041">.</span><span class="ident" id="3208042">ch</span><span class="op" id="3208044">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3208049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3208055">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3208107">fi</span><span class="op" id="3208109">,</span>&nbsp;<span class="ident" id="3208111">err</span>&nbsp;<span class="op" id="3208115">:=</span>&nbsp;<span class="ident" id="3208118">os</span><span class="op" id="3208120">.</span><span class="ident" id="3208121">Stat</span><span class="op" id="3208125">(</span><span class="ident" id="3208126">resolvConfPath</span><span class="op" id="3208140">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208145">if</span>&nbsp;<span class="ident" id="3208148">err</span>&nbsp;<span class="op" id="3208152">!=</span>&nbsp;<span class="builtintype" id="3208155">nil</span>&nbsp;<span class="op" id="3208159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208165">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3208177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3208182">//&nbsp;If&nbsp;the&nbsp;resolv.conf&nbsp;mtime&nbsp;didn&#39;t&nbsp;change,&nbsp;do&nbsp;not&nbsp;reload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3208242">m</span>&nbsp;<span class="op" id="3208244">:=</span>&nbsp;<span class="ident" id="3208247">fi</span><span class="op" id="3208249">.</span><span class="ident" id="3208250">ModTime</span><span class="op" id="3208257">(</span><span class="op" id="3208258">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208263">if</span>&nbsp;<span class="ident" id="3208266">m</span><span class="op" id="3208267">.</span><span class="ident" id="3208268">Equal</span><span class="op" id="3208273">(</span><span class="ident" id="3208274">mtime</span><span class="op" id="3208279">)</span>&nbsp;<span class="op" id="3208281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208287">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3208299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3208304">mtime</span>&nbsp;<span class="op" id="3208310">=</span>&nbsp;<span class="ident" id="3208312">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3208317">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3208369">ncfg</span><span class="op" id="3208373">,</span>&nbsp;<span class="ident" id="3208375">err</span>&nbsp;<span class="op" id="3208379">:=</span>&nbsp;<span class="ident" id="3208382">dnsReadConfig</span><span class="op" id="3208395">(</span><span class="ident" id="3208396">resolvConfPath</span><span class="op" id="3208410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208415">if</span>&nbsp;<span class="ident" id="3208418">err</span>&nbsp;<span class="op" id="3208422">!=</span>&nbsp;<span class="builtintype" id="3208425">nil</span>&nbsp;<span class="op" id="3208429">||</span>&nbsp;<span class="builtinfunc" id="3208432">len</span><span class="op" id="3208435">(</span><span class="ident" id="3208436">ncfg</span><span class="op" id="3208440">.</span><span class="ident" id="3208441">servers</span><span class="op" id="3208448">)</span>&nbsp;<span class="op" id="3208450">==</span>&nbsp;<span class="num" id="3208453">0</span>&nbsp;<span class="op" id="3208455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208461">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3208473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3208478">cfg</span><span class="op" id="3208481">.</span><span class="ident" id="3208482">mu</span><span class="op" id="3208484">.</span><span class="ident" id="3208485">Lock</span><span class="op" id="3208489">(</span><span class="op" id="3208490">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3208495">cfg</span><span class="op" id="3208498">.</span><span class="ident" id="3208499">dnsConfig</span>&nbsp;<span class="op" id="3208509">=</span>&nbsp;<span class="ident" id="3208511">ncfg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3208519">cfg</span><span class="op" id="3208522">.</span><span class="ident" id="3208523">dnserr</span>&nbsp;<span class="op" id="3208530">=</span>&nbsp;<span class="builtintype" id="3208532">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3208539">cfg</span><span class="op" id="3208542">.</span><span class="ident" id="3208543">mu</span><span class="op" id="3208545">.</span><span class="ident" id="3208546">Unlock</span><span class="op" id="3208552">(</span><span class="op" id="3208553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3208557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3208560">}</span><span class="op" id="3208561">(</span><span class="op" id="3208562">)</span><br>
<span class="lineno">270</span><span class="op" id="3208564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3208567">func</span>&nbsp;<span class="ident" id="3208572">lookup</span><span class="op" id="3208578">(</span><span class="ident" id="3208579">name</span>&nbsp;<span class="builtintype" id="3208584">string</span><span class="op" id="3208590">,</span>&nbsp;<span class="ident" id="3208592">qtype</span>&nbsp;<span class="builtintype" id="3208598">uint16</span><span class="op" id="3208604">)</span>&nbsp;<span class="op" id="3208606">(</span><span class="ident" id="3208607">cname</span>&nbsp;<span class="builtintype" id="3208613">string</span><span class="op" id="3208619">,</span>&nbsp;<span class="ident" id="3208621">addrs</span>&nbsp;<span class="op" id="3208627">[</span><span class="op" id="3208628">]</span><span class="ident" id="3208629">dnsRR</span><span class="op" id="3208634">,</span>&nbsp;<span class="ident" id="3208636">err</span>&nbsp;<span class="builtintype" id="3208640">error</span><span class="op" id="3208645">)</span>&nbsp;<span class="op" id="3208647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208650">if</span>&nbsp;<span class="op" id="3208653">!</span><span class="ident" id="3208654">isDomainName</span><span class="op" id="3208666">(</span><span class="ident" id="3208667">name</span><span class="op" id="3208671">)</span>&nbsp;<span class="op" id="3208673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208677">return</span>&nbsp;<span class="ident" id="3208684">name</span><span class="op" id="3208688">,</span>&nbsp;<span class="builtintype" id="3208690">nil</span><span class="op" id="3208693">,</span>&nbsp;<span class="op" id="3208695">&amp;</span><span class="ident" id="3208696">DNSError</span><span class="op" id="3208704">{</span><span class="ident" id="3208705">Err</span><span class="op" id="3208708">:</span>&nbsp;<span class="string" id="3208710">&#34;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="3208731">,</span>&nbsp;<span class="ident" id="3208733">Name</span><span class="op" id="3208737">:</span>&nbsp;<span class="ident" id="3208739">name</span><span class="op" id="3208743">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3208746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3208749">onceLoadConfig</span><span class="op" id="3208763">.</span><span class="ident" id="3208764">Do</span><span class="op" id="3208766">(</span><span class="ident" id="3208767">loadDefaultConfig</span><span class="op" id="3208784">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208788">select</span>&nbsp;<span class="op" id="3208795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208798">case</span>&nbsp;<span class="ident" id="3208803">cfg</span><span class="op" id="3208806">.</span><span class="ident" id="3208807">ch</span>&nbsp;<span class="op" id="3208810">&lt;-</span>&nbsp;<span class="keyword" id="3208813">struct</span><span class="op" id="3208819">{</span><span class="op" id="3208820">}</span><span class="op" id="3208821">{</span><span class="op" id="3208822">}</span><span class="op" id="3208823">:</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208826">default</span><span class="op" id="3208833">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3208836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3208840">cfg</span><span class="op" id="3208843">.</span><span class="ident" id="3208844">mu</span><span class="op" id="3208846">.</span><span class="ident" id="3208847">RLock</span><span class="op" id="3208852">(</span><span class="op" id="3208853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208856">defer</span>&nbsp;<span class="ident" id="3208862">cfg</span><span class="op" id="3208865">.</span><span class="ident" id="3208866">mu</span><span class="op" id="3208868">.</span><span class="ident" id="3208869">RUnlock</span><span class="op" id="3208876">(</span><span class="op" id="3208877">)</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208881">if</span>&nbsp;<span class="ident" id="3208884">cfg</span><span class="op" id="3208887">.</span><span class="ident" id="3208888">dnserr</span>&nbsp;<span class="op" id="3208895">!=</span>&nbsp;<span class="builtintype" id="3208898">nil</span>&nbsp;<span class="op" id="3208902">||</span>&nbsp;<span class="ident" id="3208905">cfg</span><span class="op" id="3208908">.</span><span class="ident" id="3208909">dnsConfig</span>&nbsp;<span class="op" id="3208919">==</span>&nbsp;<span class="builtintype" id="3208922">nil</span>&nbsp;<span class="op" id="3208926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3208930">err</span>&nbsp;<span class="op" id="3208934">=</span>&nbsp;<span class="ident" id="3208936">cfg</span><span class="op" id="3208939">.</span><span class="ident" id="3208940">dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3208949">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3208957">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3208960">//&nbsp;If&nbsp;name&nbsp;is&nbsp;rooted&nbsp;(trailing&nbsp;dot)&nbsp;or&nbsp;has&nbsp;enough&nbsp;dots,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3209017">//&nbsp;try&nbsp;it&nbsp;by&nbsp;itself&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3209045">rooted</span>&nbsp;<span class="op" id="3209052">:=</span>&nbsp;<span class="builtinfunc" id="3209055">len</span><span class="op" id="3209058">(</span><span class="ident" id="3209059">name</span><span class="op" id="3209063">)</span>&nbsp;<span class="op" id="3209065">&gt;</span>&nbsp;<span class="num" id="3209067">0</span>&nbsp;<span class="op" id="3209069">&amp;&amp;</span>&nbsp;<span class="ident" id="3209072">name</span><span class="op" id="3209076">[</span><span class="builtinfunc" id="3209077">len</span><span class="op" id="3209080">(</span><span class="ident" id="3209081">name</span><span class="op" id="3209085">)</span><span class="op" id="3209086">-</span><span class="num" id="3209087">1</span><span class="op" id="3209088">]</span>&nbsp;<span class="op" id="3209090">==</span>&nbsp;<span class="string" id="3209093">&#39;.&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3209098">if</span>&nbsp;<span class="ident" id="3209101">rooted</span>&nbsp;<span class="op" id="3209108">||</span>&nbsp;<span class="ident" id="3209111">count</span><span class="op" id="3209116">(</span><span class="ident" id="3209117">name</span><span class="op" id="3209121">,</span>&nbsp;<span class="string" id="3209123">&#39;.&#39;</span><span class="op" id="3209126">)</span>&nbsp;<span class="op" id="3209128">&gt;=</span>&nbsp;<span class="ident" id="3209131">cfg</span><span class="op" id="3209134">.</span><span class="ident" id="3209135">dnsConfig</span><span class="op" id="3209144">.</span><span class="ident" id="3209145">ndots</span>&nbsp;<span class="op" id="3209151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3209155">rname</span>&nbsp;<span class="op" id="3209161">:=</span>&nbsp;<span class="ident" id="3209164">name</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3209171">if</span>&nbsp;<span class="op" id="3209174">!</span><span class="ident" id="3209175">rooted</span>&nbsp;<span class="op" id="3209182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3209187">rname</span>&nbsp;<span class="op" id="3209193">+=</span>&nbsp;<span class="string" id="3209196">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3209202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3209206">//&nbsp;Can&nbsp;try&nbsp;as&nbsp;ordinary&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3209237">cname</span><span class="op" id="3209242">,</span>&nbsp;<span class="ident" id="3209244">addrs</span><span class="op" id="3209249">,</span>&nbsp;<span class="ident" id="3209251">err</span>&nbsp;<span class="op" id="3209255">=</span>&nbsp;<span class="ident" id="3209257">tryOneName</span><span class="op" id="3209267">(</span><span class="ident" id="3209268">cfg</span><span class="op" id="3209271">.</span><span class="ident" id="3209272">dnsConfig</span><span class="op" id="3209281">,</span>&nbsp;<span class="ident" id="3209283">rname</span><span class="op" id="3209288">,</span>&nbsp;<span class="ident" id="3209290">qtype</span><span class="op" id="3209295">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3209299">if</span>&nbsp;<span class="ident" id="3209302">rooted</span>&nbsp;<span class="op" id="3209309">||</span>&nbsp;<span class="ident" id="3209312">err</span>&nbsp;<span class="op" id="3209316">==</span>&nbsp;<span class="builtintype" id="3209319">nil</span>&nbsp;<span class="op" id="3209323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3209328">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3209337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3209340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3209344">//&nbsp;Otherwise,&nbsp;try&nbsp;suffixes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3209373">for</span>&nbsp;<span class="ident" id="3209377">i</span>&nbsp;<span class="op" id="3209379">:=</span>&nbsp;<span class="num" id="3209382">0</span><span class="op" id="3209383">;</span>&nbsp;<span class="ident" id="3209385">i</span>&nbsp;<span class="op" id="3209387">&lt;</span>&nbsp;<span class="builtinfunc" id="3209389">len</span><span class="op" id="3209392">(</span><span class="ident" id="3209393">cfg</span><span class="op" id="3209396">.</span><span class="ident" id="3209397">dnsConfig</span><span class="op" id="3209406">.</span><span class="ident" id="3209407">search</span><span class="op" id="3209413">)</span><span class="op" id="3209414">;</span>&nbsp;<span class="ident" id="3209416">i</span><span class="op" id="3209417">++</span>&nbsp;<span class="op" id="3209420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3209424">rname</span>&nbsp;<span class="op" id="3209430">:=</span>&nbsp;<span class="ident" id="3209433">name</span>&nbsp;<span class="op" id="3209438">+</span>&nbsp;<span class="string" id="3209440">&#34;.&#34;</span>&nbsp;<span class="op" id="3209444">+</span>&nbsp;<span class="ident" id="3209446">cfg</span><span class="op" id="3209449">.</span><span class="ident" id="3209450">dnsConfig</span><span class="op" id="3209459">.</span><span class="ident" id="3209460">search</span><span class="op" id="3209466">[</span><span class="ident" id="3209467">i</span><span class="op" id="3209468">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3209472">if</span>&nbsp;<span class="ident" id="3209475">rname</span><span class="op" id="3209480">[</span><span class="builtinfunc" id="3209481">len</span><span class="op" id="3209484">(</span><span class="ident" id="3209485">rname</span><span class="op" id="3209490">)</span><span class="op" id="3209491">-</span><span class="num" id="3209492">1</span><span class="op" id="3209493">]</span>&nbsp;<span class="op" id="3209495">!=</span>&nbsp;<span class="string" id="3209498">&#39;.&#39;</span>&nbsp;<span class="op" id="3209502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3209507">rname</span>&nbsp;<span class="op" id="3209513">+=</span>&nbsp;<span class="string" id="3209516">&#34;.&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3209522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3209526">cname</span><span class="op" id="3209531">,</span>&nbsp;<span class="ident" id="3209533">addrs</span><span class="op" id="3209538">,</span>&nbsp;<span class="ident" id="3209540">err</span>&nbsp;<span class="op" id="3209544">=</span>&nbsp;<span class="ident" id="3209546">tryOneName</span><span class="op" id="3209556">(</span><span class="ident" id="3209557">cfg</span><span class="op" id="3209560">.</span><span class="ident" id="3209561">dnsConfig</span><span class="op" id="3209570">,</span>&nbsp;<span class="ident" id="3209572">rname</span><span class="op" id="3209577">,</span>&nbsp;<span class="ident" id="3209579">qtype</span><span class="op" id="3209584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3209588">if</span>&nbsp;<span class="ident" id="3209591">err</span>&nbsp;<span class="op" id="3209595">==</span>&nbsp;<span class="builtintype" id="3209598">nil</span>&nbsp;<span class="op" id="3209602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3209607">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3209616">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3209619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3209623">//&nbsp;Last&nbsp;ditch&nbsp;effort:&nbsp;try&nbsp;unsuffixed&nbsp;only&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3209689">//&nbsp;that&nbsp;is,&nbsp;name&nbsp;is&nbsp;not&nbsp;rooted&nbsp;and&nbsp;has&nbsp;less&nbsp;than&nbsp;ndots&nbsp;dots.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3209751">if</span>&nbsp;<span class="ident" id="3209754">count</span><span class="op" id="3209759">(</span><span class="ident" id="3209760">name</span><span class="op" id="3209764">,</span>&nbsp;<span class="string" id="3209766">&#39;.&#39;</span><span class="op" id="3209769">)</span>&nbsp;<span class="op" id="3209771">&lt;</span>&nbsp;<span class="ident" id="3209773">cfg</span><span class="op" id="3209776">.</span><span class="ident" id="3209777">dnsConfig</span><span class="op" id="3209786">.</span><span class="ident" id="3209787">ndots</span>&nbsp;<span class="op" id="3209793">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3209797">cname</span><span class="op" id="3209802">,</span>&nbsp;<span class="ident" id="3209804">addrs</span><span class="op" id="3209809">,</span>&nbsp;<span class="ident" id="3209811">err</span>&nbsp;<span class="op" id="3209815">=</span>&nbsp;<span class="ident" id="3209817">tryOneName</span><span class="op" id="3209827">(</span><span class="ident" id="3209828">cfg</span><span class="op" id="3209831">.</span><span class="ident" id="3209832">dnsConfig</span><span class="op" id="3209841">,</span>&nbsp;<span class="ident" id="3209843">name</span><span class="op" id="3209847">+</span><span class="string" id="3209848">&#34;.&#34;</span><span class="op" id="3209851">,</span>&nbsp;<span class="ident" id="3209853">qtype</span><span class="op" id="3209858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3209862">if</span>&nbsp;<span class="ident" id="3209865">err</span>&nbsp;<span class="op" id="3209869">==</span>&nbsp;<span class="builtintype" id="3209872">nil</span>&nbsp;<span class="op" id="3209876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3209881">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3209890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3209893">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3209897">if</span>&nbsp;<span class="ident" id="3209900">e</span><span class="op" id="3209901">,</span>&nbsp;<span class="ident" id="3209903">ok</span>&nbsp;<span class="op" id="3209906">:=</span>&nbsp;<span class="ident" id="3209909">err</span><span class="op" id="3209912">.</span><span class="op" id="3209913">(</span><span class="op" id="3209914">*</span><span class="ident" id="3209915">DNSError</span><span class="op" id="3209923">)</span><span class="op" id="3209924">;</span>&nbsp;<span class="ident" id="3209926">ok</span>&nbsp;<span class="op" id="3209929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3209933">//&nbsp;Show&nbsp;original&nbsp;name&nbsp;passed&nbsp;to&nbsp;lookup,&nbsp;not&nbsp;suffixed&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3209993">//&nbsp;In&nbsp;general&nbsp;we&nbsp;might&nbsp;have&nbsp;tried&nbsp;many&nbsp;suffixes;&nbsp;showing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3210052">//&nbsp;just&nbsp;one&nbsp;is&nbsp;misleading.&nbsp;See&nbsp;also&nbsp;golang.org/issue/6324.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3210113">e</span><span class="op" id="3210114">.</span><span class="ident" id="3210115">Name</span>&nbsp;<span class="op" id="3210120">=</span>&nbsp;<span class="ident" id="3210122">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3210128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3210131">return</span><br>
<span class="lineno"></span><span class="op" id="3210138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="3210141">//&nbsp;goLookupHost&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupHost.</span><br>
<span class="lineno"></span><span class="comment" id="3210204">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3210264">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3210328">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3210389">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">340</span><span class="comment" id="3210452">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3210464">func</span>&nbsp;<span class="ident" id="3210469">goLookupHost</span><span class="op" id="3210481">(</span><span class="ident" id="3210482">name</span>&nbsp;<span class="builtintype" id="3210487">string</span><span class="op" id="3210493">)</span>&nbsp;<span class="op" id="3210495">(</span><span class="ident" id="3210496">addrs</span>&nbsp;<span class="op" id="3210502">[</span><span class="op" id="3210503">]</span><span class="builtintype" id="3210504">string</span><span class="op" id="3210510">,</span>&nbsp;<span class="ident" id="3210512">err</span>&nbsp;<span class="builtintype" id="3210516">error</span><span class="op" id="3210521">)</span>&nbsp;<span class="op" id="3210523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3210526">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;they&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3210573">addrs</span>&nbsp;<span class="op" id="3210579">=</span>&nbsp;<span class="ident" id="3210581">lookupStaticHost</span><span class="op" id="3210597">(</span><span class="ident" id="3210598">name</span><span class="op" id="3210602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3210605">if</span>&nbsp;<span class="builtinfunc" id="3210608">len</span><span class="op" id="3210611">(</span><span class="ident" id="3210612">addrs</span><span class="op" id="3210617">)</span>&nbsp;<span class="op" id="3210619">&gt;</span>&nbsp;<span class="num" id="3210621">0</span>&nbsp;<span class="op" id="3210623">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3210627">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3210635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3210638">ips</span><span class="op" id="3210641">,</span>&nbsp;<span class="ident" id="3210643">err</span>&nbsp;<span class="op" id="3210647">:=</span>&nbsp;<span class="ident" id="3210650">goLookupIP</span><span class="op" id="3210660">(</span><span class="ident" id="3210661">name</span><span class="op" id="3210665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3210668">if</span>&nbsp;<span class="ident" id="3210671">err</span>&nbsp;<span class="op" id="3210675">!=</span>&nbsp;<span class="builtintype" id="3210678">nil</span>&nbsp;<span class="op" id="3210682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3210686">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3210694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3210697">addrs</span>&nbsp;<span class="op" id="3210703">=</span>&nbsp;<span class="builtinfunc" id="3210705">make</span><span class="op" id="3210709">(</span><span class="op" id="3210710">[</span><span class="op" id="3210711">]</span><span class="builtintype" id="3210712">string</span><span class="op" id="3210718">,</span>&nbsp;<span class="num" id="3210720">0</span><span class="op" id="3210721">,</span>&nbsp;<span class="builtinfunc" id="3210723">len</span><span class="op" id="3210726">(</span><span class="ident" id="3210727">ips</span><span class="op" id="3210730">)</span><span class="op" id="3210731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3210734">for</span>&nbsp;<span class="ident" id="3210738">_</span><span class="op" id="3210739">,</span>&nbsp;<span class="ident" id="3210741">ip</span>&nbsp;<span class="op" id="3210744">:=</span>&nbsp;<span class="keyword" id="3210747">range</span>&nbsp;<span class="ident" id="3210753">ips</span>&nbsp;<span class="op" id="3210757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3210761">addrs</span>&nbsp;<span class="op" id="3210767">=</span>&nbsp;<span class="builtinfunc" id="3210769">append</span><span class="op" id="3210775">(</span><span class="ident" id="3210776">addrs</span><span class="op" id="3210781">,</span>&nbsp;<span class="ident" id="3210783">ip</span><span class="op" id="3210785">.</span><span class="ident" id="3210786">String</span><span class="op" id="3210792">(</span><span class="op" id="3210793">)</span><span class="op" id="3210794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3210797">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3210800">return</span><br>
<span class="lineno"></span><span class="op" id="3210807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3210810">//&nbsp;goLookupIP&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupIP.</span><br>
<span class="lineno"></span><span class="comment" id="3210869">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno">360</span><span class="comment" id="3210927">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3210989">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3211050">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="3211113">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3211125">func</span>&nbsp;<span class="ident" id="3211130">goLookupIP</span><span class="op" id="3211140">(</span><span class="ident" id="3211141">name</span>&nbsp;<span class="builtintype" id="3211146">string</span><span class="op" id="3211152">)</span>&nbsp;<span class="op" id="3211154">(</span><span class="ident" id="3211155">addrs</span>&nbsp;<span class="op" id="3211161">[</span><span class="op" id="3211162">]</span><span class="ident" id="3211163">IP</span><span class="op" id="3211165">,</span>&nbsp;<span class="ident" id="3211167">err</span>&nbsp;<span class="builtintype" id="3211171">error</span><span class="op" id="3211176">)</span>&nbsp;<span class="op" id="3211178">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3211181">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3211226">haddrs</span>&nbsp;<span class="op" id="3211233">:=</span>&nbsp;<span class="ident" id="3211236">lookupStaticHost</span><span class="op" id="3211252">(</span><span class="ident" id="3211253">name</span><span class="op" id="3211257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3211260">if</span>&nbsp;<span class="builtinfunc" id="3211263">len</span><span class="op" id="3211266">(</span><span class="ident" id="3211267">haddrs</span><span class="op" id="3211273">)</span>&nbsp;<span class="op" id="3211275">&gt;</span>&nbsp;<span class="num" id="3211277">0</span>&nbsp;<span class="op" id="3211279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3211283">for</span>&nbsp;<span class="ident" id="3211287">_</span><span class="op" id="3211288">,</span>&nbsp;<span class="ident" id="3211290">haddr</span>&nbsp;<span class="op" id="3211296">:=</span>&nbsp;<span class="keyword" id="3211299">range</span>&nbsp;<span class="ident" id="3211305">haddrs</span>&nbsp;<span class="op" id="3211312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3211317">if</span>&nbsp;<span class="ident" id="3211320">ip</span>&nbsp;<span class="op" id="3211323">:=</span>&nbsp;<span class="ident" id="3211326">ParseIP</span><span class="op" id="3211333">(</span><span class="ident" id="3211334">haddr</span><span class="op" id="3211339">)</span><span class="op" id="3211340">;</span>&nbsp;<span class="ident" id="3211342">ip</span>&nbsp;<span class="op" id="3211345">!=</span>&nbsp;<span class="builtintype" id="3211348">nil</span>&nbsp;<span class="op" id="3211352">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3211358">addrs</span>&nbsp;<span class="op" id="3211364">=</span>&nbsp;<span class="builtinfunc" id="3211366">append</span><span class="op" id="3211372">(</span><span class="ident" id="3211373">addrs</span><span class="op" id="3211378">,</span>&nbsp;<span class="ident" id="3211380">ip</span><span class="op" id="3211382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3211387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3211391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3211395">if</span>&nbsp;<span class="builtinfunc" id="3211398">len</span><span class="op" id="3211401">(</span><span class="ident" id="3211402">addrs</span><span class="op" id="3211407">)</span>&nbsp;<span class="op" id="3211409">&gt;</span>&nbsp;<span class="num" id="3211411">0</span>&nbsp;<span class="op" id="3211413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3211418">return</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3211427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3211430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3211433">type</span>&nbsp;<span class="ident" id="3211438">racer</span>&nbsp;<span class="keyword" id="3211444">struct</span>&nbsp;<span class="op" id="3211451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3211455">qtype</span>&nbsp;<span class="builtintype" id="3211461">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3211470">rrs</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3211476">[</span><span class="op" id="3211477">]</span><span class="ident" id="3211478">dnsRR</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3211486">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3211493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3211496">lane</span>&nbsp;<span class="op" id="3211501">:=</span>&nbsp;<span class="builtinfunc" id="3211504">make</span><span class="op" id="3211508">(</span><span class="keyword" id="3211509">chan</span>&nbsp;<span class="ident" id="3211514">racer</span><span class="op" id="3211519">,</span>&nbsp;<span class="num" id="3211521">1</span><span class="op" id="3211522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3211525">qtypes</span>&nbsp;<span class="op" id="3211532">:=</span>&nbsp;<span class="op" id="3211535">[</span><span class="op" id="3211536">...</span><span class="op" id="3211539">]</span><span class="builtintype" id="3211540">uint16</span><span class="op" id="3211546">{</span><span class="ident" id="3211547">dnsTypeA</span><span class="op" id="3211555">,</span>&nbsp;<span class="ident" id="3211557">dnsTypeAAAA</span><span class="op" id="3211568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3211571">for</span>&nbsp;<span class="ident" id="3211575">_</span><span class="op" id="3211576">,</span>&nbsp;<span class="ident" id="3211578">qtype</span>&nbsp;<span class="op" id="3211584">:=</span>&nbsp;<span class="keyword" id="3211587">range</span>&nbsp;<span class="ident" id="3211593">qtypes</span>&nbsp;<span class="op" id="3211600">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3211604">go</span>&nbsp;<span class="keyword" id="3211607">func</span><span class="op" id="3211611">(</span><span class="ident" id="3211612">qtype</span>&nbsp;<span class="builtintype" id="3211618">uint16</span><span class="op" id="3211624">)</span>&nbsp;<span class="op" id="3211626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3211631">_</span><span class="op" id="3211632">,</span>&nbsp;<span class="ident" id="3211634">rrs</span><span class="op" id="3211637">,</span>&nbsp;<span class="ident" id="3211639">err</span>&nbsp;<span class="op" id="3211643">:=</span>&nbsp;<span class="ident" id="3211646">lookup</span><span class="op" id="3211652">(</span><span class="ident" id="3211653">name</span><span class="op" id="3211657">,</span>&nbsp;<span class="ident" id="3211659">qtype</span><span class="op" id="3211664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3211669">lane</span>&nbsp;<span class="op" id="3211674">&lt;-</span>&nbsp;<span class="ident" id="3211677">racer</span><span class="op" id="3211682">{</span><span class="ident" id="3211683">qtype</span><span class="op" id="3211688">,</span>&nbsp;<span class="ident" id="3211690">rrs</span><span class="op" id="3211693">,</span>&nbsp;<span class="ident" id="3211695">err</span><span class="op" id="3211698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3211702">}</span><span class="op" id="3211703">(</span><span class="ident" id="3211704">qtype</span><span class="op" id="3211709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3211712">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3211715">var</span>&nbsp;<span class="ident" id="3211719">lastErr</span>&nbsp;<span class="builtintype" id="3211727">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3211734">for</span>&nbsp;<span class="keyword" id="3211738">range</span>&nbsp;<span class="ident" id="3211744">qtypes</span>&nbsp;<span class="op" id="3211751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3211755">racer</span>&nbsp;<span class="op" id="3211761">:=</span>&nbsp;<span class="op" id="3211764">&lt;-</span><span class="ident" id="3211766">lane</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3211773">if</span>&nbsp;<span class="ident" id="3211776">racer</span><span class="op" id="3211781">.</span><span class="builtintype" id="3211782">error</span>&nbsp;<span class="op" id="3211788">!=</span>&nbsp;<span class="builtintype" id="3211791">nil</span>&nbsp;<span class="op" id="3211795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3211800">lastErr</span>&nbsp;<span class="op" id="3211808">=</span>&nbsp;<span class="ident" id="3211810">racer</span><span class="op" id="3211815">.</span><span class="builtintype" id="3211816">error</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3211825">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3211836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3211840">switch</span>&nbsp;<span class="ident" id="3211847">racer</span><span class="op" id="3211852">.</span><span class="ident" id="3211853">qtype</span>&nbsp;<span class="op" id="3211859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3211863">case</span>&nbsp;<span class="ident" id="3211868">dnsTypeA</span><span class="op" id="3211876">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3211881">addrs</span>&nbsp;<span class="op" id="3211887">=</span>&nbsp;<span class="builtinfunc" id="3211889">append</span><span class="op" id="3211895">(</span><span class="ident" id="3211896">addrs</span><span class="op" id="3211901">,</span>&nbsp;<span class="ident" id="3211903">convertRR_A</span><span class="op" id="3211914">(</span><span class="ident" id="3211915">racer</span><span class="op" id="3211920">.</span><span class="ident" id="3211921">rrs</span><span class="op" id="3211924">)</span><span class="op" id="3211925">...</span><span class="op" id="3211928">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3211932">case</span>&nbsp;<span class="ident" id="3211937">dnsTypeAAAA</span><span class="op" id="3211948">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3211953">addrs</span>&nbsp;<span class="op" id="3211959">=</span>&nbsp;<span class="builtinfunc" id="3211961">append</span><span class="op" id="3211967">(</span><span class="ident" id="3211968">addrs</span><span class="op" id="3211973">,</span>&nbsp;<span class="ident" id="3211975">convertRR_AAAA</span><span class="op" id="3211989">(</span><span class="ident" id="3211990">racer</span><span class="op" id="3211995">.</span><span class="ident" id="3211996">rrs</span><span class="op" id="3211999">)</span><span class="op" id="3212000">...</span><span class="op" id="3212003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3212007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3212010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3212013">if</span>&nbsp;<span class="builtinfunc" id="3212016">len</span><span class="op" id="3212019">(</span><span class="ident" id="3212020">addrs</span><span class="op" id="3212025">)</span>&nbsp;<span class="op" id="3212027">==</span>&nbsp;<span class="num" id="3212030">0</span>&nbsp;<span class="op" id="3212032">&amp;&amp;</span>&nbsp;<span class="ident" id="3212035">lastErr</span>&nbsp;<span class="op" id="3212043">!=</span>&nbsp;<span class="builtintype" id="3212046">nil</span>&nbsp;<span class="op" id="3212050">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3212054">return</span>&nbsp;<span class="builtintype" id="3212061">nil</span><span class="op" id="3212064">,</span>&nbsp;<span class="ident" id="3212066">lastErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3212075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3212078">return</span>&nbsp;<span class="ident" id="3212085">addrs</span><span class="op" id="3212090">,</span>&nbsp;<span class="builtintype" id="3212092">nil</span><br>
<span class="lineno"></span><span class="op" id="3212096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="3212099">//&nbsp;goLookupCNAME&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupCNAME.</span><br>
<span class="lineno"></span><span class="comment" id="3212164">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3212225">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3212290">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3212351">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">415</span><span class="comment" id="3212414">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3212426">func</span>&nbsp;<span class="ident" id="3212431">goLookupCNAME</span><span class="op" id="3212444">(</span><span class="ident" id="3212445">name</span>&nbsp;<span class="builtintype" id="3212450">string</span><span class="op" id="3212456">)</span>&nbsp;<span class="op" id="3212458">(</span><span class="ident" id="3212459">cname</span>&nbsp;<span class="builtintype" id="3212465">string</span><span class="op" id="3212471">,</span>&nbsp;<span class="ident" id="3212473">err</span>&nbsp;<span class="builtintype" id="3212477">error</span><span class="op" id="3212482">)</span>&nbsp;<span class="op" id="3212484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3212487">_</span><span class="op" id="3212488">,</span>&nbsp;<span class="ident" id="3212490">rr</span><span class="op" id="3212492">,</span>&nbsp;<span class="ident" id="3212494">err</span>&nbsp;<span class="op" id="3212498">:=</span>&nbsp;<span class="ident" id="3212501">lookup</span><span class="op" id="3212507">(</span><span class="ident" id="3212508">name</span><span class="op" id="3212512">,</span>&nbsp;<span class="ident" id="3212514">dnsTypeCNAME</span><span class="op" id="3212526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3212529">if</span>&nbsp;<span class="ident" id="3212532">err</span>&nbsp;<span class="op" id="3212536">!=</span>&nbsp;<span class="builtintype" id="3212539">nil</span>&nbsp;<span class="op" id="3212543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3212547">return</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3212555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3212558">cname</span>&nbsp;<span class="op" id="3212564">=</span>&nbsp;<span class="ident" id="3212566">rr</span><span class="op" id="3212568">[</span><span class="num" id="3212569">0</span><span class="op" id="3212570">]</span><span class="op" id="3212571">.</span><span class="op" id="3212572">(</span><span class="op" id="3212573">*</span><span class="ident" id="3212574">dnsRR_CNAME</span><span class="op" id="3212585">)</span><span class="op" id="3212586">.</span><span class="ident" id="3212587">Cname</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3212594">return</span><br>
<span class="lineno"></span><span class="op" id="3212601">}</span>
</div>
</body>
</html>
