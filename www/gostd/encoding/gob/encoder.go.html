<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4492763">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4492818">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4492872">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4492923">package</span>&nbsp;<span class="ident" id="4492931">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4492936">import</span>&nbsp;<span class="op" id="4492943">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4492946">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4492952">&#34;reflect&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4492963">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="4492970">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4492973">//&nbsp;An&nbsp;Encoder&nbsp;manages&nbsp;the&nbsp;transmission&nbsp;of&nbsp;type&nbsp;and&nbsp;data&nbsp;information&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4493048">//&nbsp;other&nbsp;side&nbsp;of&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">15</span><span class="keyword" id="4493079">type</span>&nbsp;<span class="ident" id="4493084">Encoder</span>&nbsp;<span class="keyword" id="4493092">struct</span>&nbsp;<span class="op" id="4493099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4493102">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4493113">sync</span><span class="op" id="4493117">.</span><span class="ident" id="4493118">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4493137">//&nbsp;each&nbsp;item&nbsp;must&nbsp;be&nbsp;sent&nbsp;atomically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4493175">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4493186">[</span><span class="op" id="4493187">]</span><span class="ident" id="4493188">io</span><span class="op" id="4493190">.</span><span class="ident" id="4493191">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4493210">//&nbsp;where&nbsp;to&nbsp;send&nbsp;the&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4493237">sent</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4493248">map</span><span class="op" id="4493251">[</span><span class="ident" id="4493252">reflect</span><span class="op" id="4493259">.</span><span class="ident" id="4493260">Type</span><span class="op" id="4493264">]</span><span class="ident" id="4493265">typeId</span>&nbsp;<span class="comment" id="4493272">//&nbsp;which&nbsp;types&nbsp;we&#39;ve&nbsp;already&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4493307">countState</span>&nbsp;<span class="op" id="4493318">*</span><span class="ident" id="4493319">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4493342">//&nbsp;stage&nbsp;for&nbsp;writing&nbsp;counts</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4493371">freeList</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4493382">*</span><span class="ident" id="4493383">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4493406">//&nbsp;list&nbsp;of&nbsp;free&nbsp;encoderStates;&nbsp;avoids&nbsp;reallocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4493458">byteBuf</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4493469">encBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4493493">//&nbsp;buffer&nbsp;for&nbsp;top-level&nbsp;encoderState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4493531">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4493542">error</span><br>
<span class="lineno"></span><span class="op" id="4493548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4493551">//&nbsp;Before&nbsp;we&nbsp;encode&nbsp;a&nbsp;message,&nbsp;we&nbsp;reserve&nbsp;space&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4493618">//&nbsp;buffer&nbsp;in&nbsp;which&nbsp;to&nbsp;encode&nbsp;its&nbsp;length.&nbsp;This&nbsp;means&nbsp;we&nbsp;can&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4493685">//&nbsp;buffer&nbsp;to&nbsp;assemble&nbsp;the&nbsp;message&nbsp;without&nbsp;another&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="4493747">const</span>&nbsp;<span class="ident" id="4493753">maxLength</span>&nbsp;<span class="op" id="4493763">=</span>&nbsp;<span class="num" id="4493765">9</span>&nbsp;<span class="comment" id="4493767">//&nbsp;Maximum&nbsp;size&nbsp;of&nbsp;an&nbsp;encoded&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="4493805">var</span>&nbsp;<span class="ident" id="4493809">spaceForLength</span>&nbsp;<span class="op" id="4493824">=</span>&nbsp;<span class="builtinfunc" id="4493826">make</span><span class="op" id="4493830">(</span><span class="op" id="4493831">[</span><span class="op" id="4493832">]</span><span class="builtintype" id="4493833">byte</span><span class="op" id="4493837">,</span>&nbsp;<span class="ident" id="4493839">maxLength</span><span class="op" id="4493848">)</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="4493851">//&nbsp;NewEncoder&nbsp;returns&nbsp;a&nbsp;new&nbsp;encoder&nbsp;that&nbsp;will&nbsp;transmit&nbsp;on&nbsp;the&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4493924">func</span>&nbsp;<span class="ident" id="4493929">NewEncoder</span><span class="op" id="4493939">(</span><span class="ident" id="4493940">w</span>&nbsp;<span class="ident" id="4493942">io</span><span class="op" id="4493944">.</span><span class="ident" id="4493945">Writer</span><span class="op" id="4493951">)</span>&nbsp;<span class="op" id="4493953">*</span><span class="ident" id="4493954">Encoder</span>&nbsp;<span class="op" id="4493962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4493965">enc</span>&nbsp;<span class="op" id="4493969">:=</span>&nbsp;<span class="builtinfunc" id="4493972">new</span><span class="op" id="4493975">(</span><span class="ident" id="4493976">Encoder</span><span class="op" id="4493983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4493986">enc</span><span class="op" id="4493989">.</span><span class="ident" id="4493990">w</span>&nbsp;<span class="op" id="4493992">=</span>&nbsp;<span class="op" id="4493994">[</span><span class="op" id="4493995">]</span><span class="ident" id="4493996">io</span><span class="op" id="4493998">.</span><span class="ident" id="4493999">Writer</span><span class="op" id="4494005">{</span><span class="ident" id="4494006">w</span><span class="op" id="4494007">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4494010">enc</span><span class="op" id="4494013">.</span><span class="ident" id="4494014">sent</span>&nbsp;<span class="op" id="4494019">=</span>&nbsp;<span class="builtinfunc" id="4494021">make</span><span class="op" id="4494025">(</span><span class="keyword" id="4494026">map</span><span class="op" id="4494029">[</span><span class="ident" id="4494030">reflect</span><span class="op" id="4494037">.</span><span class="ident" id="4494038">Type</span><span class="op" id="4494042">]</span><span class="ident" id="4494043">typeId</span><span class="op" id="4494049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4494052">enc</span><span class="op" id="4494055">.</span><span class="ident" id="4494056">countState</span>&nbsp;<span class="op" id="4494067">=</span>&nbsp;<span class="ident" id="4494069">enc</span><span class="op" id="4494072">.</span><span class="ident" id="4494073">newEncoderState</span><span class="op" id="4494088">(</span><span class="builtinfunc" id="4494089">new</span><span class="op" id="4494092">(</span><span class="ident" id="4494093">encBuffer</span><span class="op" id="4494102">)</span><span class="op" id="4494103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4494106">return</span>&nbsp;<span class="ident" id="4494113">enc</span><br>
<span class="lineno"></span><span class="op" id="4494117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="4494120">//&nbsp;writer()&nbsp;returns&nbsp;the&nbsp;innermost&nbsp;writer&nbsp;the&nbsp;encoder&nbsp;is&nbsp;using</span><br>
<span class="lineno"></span><span class="keyword" id="4494182">func</span>&nbsp;<span class="op" id="4494187">(</span><span class="ident" id="4494188">enc</span>&nbsp;<span class="op" id="4494192">*</span><span class="ident" id="4494193">Encoder</span><span class="op" id="4494200">)</span>&nbsp;<span class="ident" id="4494202">writer</span><span class="op" id="4494208">(</span><span class="op" id="4494209">)</span>&nbsp;<span class="ident" id="4494211">io</span><span class="op" id="4494213">.</span><span class="ident" id="4494214">Writer</span>&nbsp;<span class="op" id="4494221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4494224">return</span>&nbsp;<span class="ident" id="4494231">enc</span><span class="op" id="4494234">.</span><span class="ident" id="4494235">w</span><span class="op" id="4494236">[</span><span class="builtinfunc" id="4494237">len</span><span class="op" id="4494240">(</span><span class="ident" id="4494241">enc</span><span class="op" id="4494244">.</span><span class="ident" id="4494245">w</span><span class="op" id="4494246">)</span><span class="op" id="4494247">-</span><span class="num" id="4494248">1</span><span class="op" id="4494249">]</span><br>
<span class="lineno"></span><span class="op" id="4494251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="4494254">//&nbsp;pushWriter&nbsp;adds&nbsp;a&nbsp;writer&nbsp;to&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="keyword" id="4494298">func</span>&nbsp;<span class="op" id="4494303">(</span><span class="ident" id="4494304">enc</span>&nbsp;<span class="op" id="4494308">*</span><span class="ident" id="4494309">Encoder</span><span class="op" id="4494316">)</span>&nbsp;<span class="ident" id="4494318">pushWriter</span><span class="op" id="4494328">(</span><span class="ident" id="4494329">w</span>&nbsp;<span class="ident" id="4494331">io</span><span class="op" id="4494333">.</span><span class="ident" id="4494334">Writer</span><span class="op" id="4494340">)</span>&nbsp;<span class="op" id="4494342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4494345">enc</span><span class="op" id="4494348">.</span><span class="ident" id="4494349">w</span>&nbsp;<span class="op" id="4494351">=</span>&nbsp;<span class="builtinfunc" id="4494353">append</span><span class="op" id="4494359">(</span><span class="ident" id="4494360">enc</span><span class="op" id="4494363">.</span><span class="ident" id="4494364">w</span><span class="op" id="4494365">,</span>&nbsp;<span class="ident" id="4494367">w</span><span class="op" id="4494368">)</span><br>
<span class="lineno"></span><span class="op" id="4494370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4494373">//&nbsp;popWriter&nbsp;pops&nbsp;the&nbsp;innermost&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4494413">func</span>&nbsp;<span class="op" id="4494418">(</span><span class="ident" id="4494419">enc</span>&nbsp;<span class="op" id="4494423">*</span><span class="ident" id="4494424">Encoder</span><span class="op" id="4494431">)</span>&nbsp;<span class="ident" id="4494433">popWriter</span><span class="op" id="4494442">(</span><span class="op" id="4494443">)</span>&nbsp;<span class="op" id="4494445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4494448">enc</span><span class="op" id="4494451">.</span><span class="ident" id="4494452">w</span>&nbsp;<span class="op" id="4494454">=</span>&nbsp;<span class="ident" id="4494456">enc</span><span class="op" id="4494459">.</span><span class="ident" id="4494460">w</span><span class="op" id="4494461">[</span><span class="num" id="4494462">0</span>&nbsp;<span class="op" id="4494464">:</span>&nbsp;<span class="builtinfunc" id="4494466">len</span><span class="op" id="4494469">(</span><span class="ident" id="4494470">enc</span><span class="op" id="4494473">.</span><span class="ident" id="4494474">w</span><span class="op" id="4494475">)</span><span class="op" id="4494476">-</span><span class="num" id="4494477">1</span><span class="op" id="4494478">]</span><br>
<span class="lineno"></span><span class="op" id="4494480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="4494483">func</span>&nbsp;<span class="op" id="4494488">(</span><span class="ident" id="4494489">enc</span>&nbsp;<span class="op" id="4494493">*</span><span class="ident" id="4494494">Encoder</span><span class="op" id="4494501">)</span>&nbsp;<span class="ident" id="4494503">setError</span><span class="op" id="4494511">(</span><span class="ident" id="4494512">err</span>&nbsp;<span class="builtintype" id="4494516">error</span><span class="op" id="4494521">)</span>&nbsp;<span class="op" id="4494523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4494526">if</span>&nbsp;<span class="ident" id="4494529">enc</span><span class="op" id="4494532">.</span><span class="ident" id="4494533">err</span>&nbsp;<span class="op" id="4494537">==</span>&nbsp;<span class="ident" id="4494540">nil</span>&nbsp;<span class="op" id="4494544">{</span>&nbsp;<span class="comment" id="4494546">//&nbsp;remember&nbsp;the&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4494571">enc</span><span class="op" id="4494574">.</span><span class="ident" id="4494575">err</span>&nbsp;<span class="op" id="4494579">=</span>&nbsp;<span class="ident" id="4494581">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4494586">}</span><br>
<span class="lineno"></span><span class="op" id="4494588">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="4494591">//&nbsp;writeMessage&nbsp;sends&nbsp;the&nbsp;data&nbsp;item&nbsp;preceded&nbsp;by&nbsp;a&nbsp;unsigned&nbsp;count&nbsp;of&nbsp;its&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="4494671">func</span>&nbsp;<span class="op" id="4494676">(</span><span class="ident" id="4494677">enc</span>&nbsp;<span class="op" id="4494681">*</span><span class="ident" id="4494682">Encoder</span><span class="op" id="4494689">)</span>&nbsp;<span class="ident" id="4494691">writeMessage</span><span class="op" id="4494703">(</span><span class="ident" id="4494704">w</span>&nbsp;<span class="ident" id="4494706">io</span><span class="op" id="4494708">.</span><span class="ident" id="4494709">Writer</span><span class="op" id="4494715">,</span>&nbsp;<span class="ident" id="4494717">b</span>&nbsp;<span class="op" id="4494719">*</span><span class="ident" id="4494720">encBuffer</span><span class="op" id="4494729">)</span>&nbsp;<span class="op" id="4494731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4494734">//&nbsp;Space&nbsp;has&nbsp;been&nbsp;reserved&nbsp;for&nbsp;the&nbsp;length&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4494805">//&nbsp;This&nbsp;is&nbsp;a&nbsp;little&nbsp;dirty:&nbsp;we&nbsp;grab&nbsp;the&nbsp;slice&nbsp;from&nbsp;the&nbsp;bytes.Buffer&nbsp;and&nbsp;massage</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4494885">//&nbsp;it&nbsp;by&nbsp;hand.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4494901">message</span>&nbsp;<span class="op" id="4494909">:=</span>&nbsp;<span class="ident" id="4494912">b</span><span class="op" id="4494913">.</span><span class="ident" id="4494914">Bytes</span><span class="op" id="4494919">(</span><span class="op" id="4494920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4494923">messageLen</span>&nbsp;<span class="op" id="4494934">:=</span>&nbsp;<span class="builtinfunc" id="4494937">len</span><span class="op" id="4494940">(</span><span class="ident" id="4494941">message</span><span class="op" id="4494948">)</span>&nbsp;<span class="op" id="4494950">-</span>&nbsp;<span class="ident" id="4494952">maxLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4494963">//&nbsp;Encode&nbsp;the&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4494986">enc</span><span class="op" id="4494989">.</span><span class="ident" id="4494990">countState</span><span class="op" id="4495000">.</span><span class="ident" id="4495001">b</span><span class="op" id="4495002">.</span><span class="ident" id="4495003">Reset</span><span class="op" id="4495008">(</span><span class="op" id="4495009">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4495012">enc</span><span class="op" id="4495015">.</span><span class="ident" id="4495016">countState</span><span class="op" id="4495026">.</span><span class="ident" id="4495027">encodeUint</span><span class="op" id="4495037">(</span><span class="ident" id="4495038">uint64</span><span class="op" id="4495044">(</span><span class="ident" id="4495045">messageLen</span><span class="op" id="4495055">)</span><span class="op" id="4495056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4495059">//&nbsp;Copy&nbsp;the&nbsp;length&nbsp;to&nbsp;be&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4495110">offset</span>&nbsp;<span class="op" id="4495117">:=</span>&nbsp;<span class="ident" id="4495120">maxLength</span>&nbsp;<span class="op" id="4495130">-</span>&nbsp;<span class="ident" id="4495132">enc</span><span class="op" id="4495135">.</span><span class="ident" id="4495136">countState</span><span class="op" id="4495146">.</span><span class="ident" id="4495147">b</span><span class="op" id="4495148">.</span><span class="ident" id="4495149">Len</span><span class="op" id="4495152">(</span><span class="op" id="4495153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4495156">copy</span><span class="op" id="4495160">(</span><span class="ident" id="4495161">message</span><span class="op" id="4495168">[</span><span class="ident" id="4495169">offset</span><span class="op" id="4495175">:</span><span class="op" id="4495176">]</span><span class="op" id="4495177">,</span>&nbsp;<span class="ident" id="4495179">enc</span><span class="op" id="4495182">.</span><span class="ident" id="4495183">countState</span><span class="op" id="4495193">.</span><span class="ident" id="4495194">b</span><span class="op" id="4495195">.</span><span class="ident" id="4495196">Bytes</span><span class="op" id="4495201">(</span><span class="op" id="4495202">)</span><span class="op" id="4495203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4495206">//&nbsp;Write&nbsp;the&nbsp;data.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4495226">_</span><span class="op" id="4495227">,</span>&nbsp;<span class="ident" id="4495229">err</span>&nbsp;<span class="op" id="4495233">:=</span>&nbsp;<span class="ident" id="4495236">w</span><span class="op" id="4495237">.</span><span class="ident" id="4495238">Write</span><span class="op" id="4495243">(</span><span class="ident" id="4495244">message</span><span class="op" id="4495251">[</span><span class="ident" id="4495252">offset</span><span class="op" id="4495258">:</span><span class="op" id="4495259">]</span><span class="op" id="4495260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4495263">//&nbsp;Drain&nbsp;the&nbsp;buffer&nbsp;and&nbsp;restore&nbsp;the&nbsp;space&nbsp;at&nbsp;the&nbsp;front&nbsp;for&nbsp;the&nbsp;count&nbsp;of&nbsp;the&nbsp;next&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4495354">b</span><span class="op" id="4495355">.</span><span class="ident" id="4495356">Reset</span><span class="op" id="4495361">(</span><span class="op" id="4495362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4495365">b</span><span class="op" id="4495366">.</span><span class="ident" id="4495367">Write</span><span class="op" id="4495372">(</span><span class="ident" id="4495373">spaceForLength</span><span class="op" id="4495387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4495390">if</span>&nbsp;<span class="ident" id="4495393">err</span>&nbsp;<span class="op" id="4495397">!=</span>&nbsp;<span class="ident" id="4495400">nil</span>&nbsp;<span class="op" id="4495404">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4495408">enc</span><span class="op" id="4495411">.</span><span class="ident" id="4495412">setError</span><span class="op" id="4495420">(</span><span class="ident" id="4495421">err</span><span class="op" id="4495424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4495427">}</span><br>
<span class="lineno"></span><span class="op" id="4495429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4495432">//&nbsp;sendActualType&nbsp;sends&nbsp;the&nbsp;requested&nbsp;type,&nbsp;without&nbsp;further&nbsp;investigation,&nbsp;unless</span><br>
<span class="lineno">85</span><span class="comment" id="4495514">//&nbsp;it&#39;s&nbsp;been&nbsp;sent&nbsp;before.</span><br>
<span class="lineno"></span><span class="keyword" id="4495540">func</span>&nbsp;<span class="op" id="4495545">(</span><span class="ident" id="4495546">enc</span>&nbsp;<span class="op" id="4495550">*</span><span class="ident" id="4495551">Encoder</span><span class="op" id="4495558">)</span>&nbsp;<span class="ident" id="4495560">sendActualType</span><span class="op" id="4495574">(</span><span class="ident" id="4495575">w</span>&nbsp;<span class="ident" id="4495577">io</span><span class="op" id="4495579">.</span><span class="ident" id="4495580">Writer</span><span class="op" id="4495586">,</span>&nbsp;<span class="ident" id="4495588">state</span>&nbsp;<span class="op" id="4495594">*</span><span class="ident" id="4495595">encoderState</span><span class="op" id="4495607">,</span>&nbsp;<span class="ident" id="4495609">ut</span>&nbsp;<span class="op" id="4495612">*</span><span class="ident" id="4495613">userTypeInfo</span><span class="op" id="4495625">,</span>&nbsp;<span class="ident" id="4495627">actual</span>&nbsp;<span class="ident" id="4495634">reflect</span><span class="op" id="4495641">.</span><span class="ident" id="4495642">Type</span><span class="op" id="4495646">)</span>&nbsp;<span class="op" id="4495648">(</span><span class="ident" id="4495649">sent</span>&nbsp;<span class="builtintype" id="4495654">bool</span><span class="op" id="4495658">)</span>&nbsp;<span class="op" id="4495660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4495663">if</span>&nbsp;<span class="ident" id="4495666">_</span><span class="op" id="4495667">,</span>&nbsp;<span class="ident" id="4495669">alreadySent</span>&nbsp;<span class="op" id="4495681">:=</span>&nbsp;<span class="ident" id="4495684">enc</span><span class="op" id="4495687">.</span><span class="ident" id="4495688">sent</span><span class="op" id="4495692">[</span><span class="ident" id="4495693">actual</span><span class="op" id="4495699">]</span><span class="op" id="4495700">;</span>&nbsp;<span class="ident" id="4495702">alreadySent</span>&nbsp;<span class="op" id="4495714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4495718">return</span>&nbsp;<span class="builtintype" id="4495725">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4495732">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4495735">info</span><span class="op" id="4495739">,</span>&nbsp;<span class="ident" id="4495741">err</span>&nbsp;<span class="op" id="4495745">:=</span>&nbsp;<span class="ident" id="4495748">getTypeInfo</span><span class="op" id="4495759">(</span><span class="ident" id="4495760">ut</span><span class="op" id="4495762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4495765">if</span>&nbsp;<span class="ident" id="4495768">err</span>&nbsp;<span class="op" id="4495772">!=</span>&nbsp;<span class="ident" id="4495775">nil</span>&nbsp;<span class="op" id="4495779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4495783">enc</span><span class="op" id="4495786">.</span><span class="ident" id="4495787">setError</span><span class="op" id="4495795">(</span><span class="ident" id="4495796">err</span><span class="op" id="4495799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4495803">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4495811">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4495814">//&nbsp;Send&nbsp;the&nbsp;pair&nbsp;(-id,&nbsp;type)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4495844">//&nbsp;Id:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4495852">state</span><span class="op" id="4495857">.</span><span class="ident" id="4495858">encodeInt</span><span class="op" id="4495867">(</span><span class="op" id="4495868">-</span><span class="ident" id="4495869">int64</span><span class="op" id="4495874">(</span><span class="ident" id="4495875">info</span><span class="op" id="4495879">.</span><span class="ident" id="4495880">id</span><span class="op" id="4495882">)</span><span class="op" id="4495883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4495886">//&nbsp;Type:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4495896">enc</span><span class="op" id="4495899">.</span><span class="ident" id="4495900">encode</span><span class="op" id="4495906">(</span><span class="ident" id="4495907">state</span><span class="op" id="4495912">.</span><span class="ident" id="4495913">b</span><span class="op" id="4495914">,</span>&nbsp;<span class="ident" id="4495916">reflect</span><span class="op" id="4495923">.</span><span class="ident" id="4495924">ValueOf</span><span class="op" id="4495931">(</span><span class="ident" id="4495932">info</span><span class="op" id="4495936">.</span><span class="ident" id="4495937">wire</span><span class="op" id="4495941">)</span><span class="op" id="4495942">,</span>&nbsp;<span class="ident" id="4495944">wireTypeUserInfo</span><span class="op" id="4495960">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4495963">enc</span><span class="op" id="4495966">.</span><span class="ident" id="4495967">writeMessage</span><span class="op" id="4495979">(</span><span class="ident" id="4495980">w</span><span class="op" id="4495981">,</span>&nbsp;<span class="ident" id="4495983">state</span><span class="op" id="4495988">.</span><span class="ident" id="4495989">b</span><span class="op" id="4495990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4495993">if</span>&nbsp;<span class="ident" id="4495996">enc</span><span class="op" id="4495999">.</span><span class="ident" id="4496000">err</span>&nbsp;<span class="op" id="4496004">!=</span>&nbsp;<span class="ident" id="4496007">nil</span>&nbsp;<span class="op" id="4496011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4496015">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4496023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4496027">//&nbsp;Remember&nbsp;we&#39;ve&nbsp;sent&nbsp;this&nbsp;type,&nbsp;both&nbsp;what&nbsp;the&nbsp;user&nbsp;gave&nbsp;us&nbsp;and&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4496108">enc</span><span class="op" id="4496111">.</span><span class="ident" id="4496112">sent</span><span class="op" id="4496116">[</span><span class="ident" id="4496117">ut</span><span class="op" id="4496119">.</span><span class="ident" id="4496120">base</span><span class="op" id="4496124">]</span>&nbsp;<span class="op" id="4496126">=</span>&nbsp;<span class="ident" id="4496128">info</span><span class="op" id="4496132">.</span><span class="ident" id="4496133">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4496137">if</span>&nbsp;<span class="ident" id="4496140">ut</span><span class="op" id="4496142">.</span><span class="ident" id="4496143">user</span>&nbsp;<span class="op" id="4496148">!=</span>&nbsp;<span class="ident" id="4496151">ut</span><span class="op" id="4496153">.</span><span class="ident" id="4496154">base</span>&nbsp;<span class="op" id="4496159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4496163">enc</span><span class="op" id="4496166">.</span><span class="ident" id="4496167">sent</span><span class="op" id="4496171">[</span><span class="ident" id="4496172">ut</span><span class="op" id="4496174">.</span><span class="ident" id="4496175">user</span><span class="op" id="4496179">]</span>&nbsp;<span class="op" id="4496181">=</span>&nbsp;<span class="ident" id="4496183">info</span><span class="op" id="4496187">.</span><span class="ident" id="4496188">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4496192">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4496195">//&nbsp;Now&nbsp;send&nbsp;the&nbsp;inner&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4496224">switch</span>&nbsp;<span class="ident" id="4496231">st</span>&nbsp;<span class="op" id="4496234">:=</span>&nbsp;<span class="ident" id="4496237">actual</span><span class="op" id="4496243">;</span>&nbsp;<span class="ident" id="4496245">st</span><span class="op" id="4496247">.</span><span class="ident" id="4496248">Kind</span><span class="op" id="4496252">(</span><span class="op" id="4496253">)</span>&nbsp;<span class="op" id="4496255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4496258">case</span>&nbsp;<span class="ident" id="4496263">reflect</span><span class="op" id="4496270">.</span><span class="ident" id="4496271">Struct</span><span class="op" id="4496277">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4496281">for</span>&nbsp;<span class="ident" id="4496285">i</span>&nbsp;<span class="op" id="4496287">:=</span>&nbsp;<span class="num" id="4496290">0</span><span class="op" id="4496291">;</span>&nbsp;<span class="ident" id="4496293">i</span>&nbsp;<span class="op" id="4496295">&lt;</span>&nbsp;<span class="ident" id="4496297">st</span><span class="op" id="4496299">.</span><span class="ident" id="4496300">NumField</span><span class="op" id="4496308">(</span><span class="op" id="4496309">)</span><span class="op" id="4496310">;</span>&nbsp;<span class="ident" id="4496312">i</span><span class="op" id="4496313">++</span>&nbsp;<span class="op" id="4496316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4496321">if</span>&nbsp;<span class="ident" id="4496324">isExported</span><span class="op" id="4496334">(</span><span class="ident" id="4496335">st</span><span class="op" id="4496337">.</span><span class="ident" id="4496338">Field</span><span class="op" id="4496343">(</span><span class="ident" id="4496344">i</span><span class="op" id="4496345">)</span><span class="op" id="4496346">.</span><span class="ident" id="4496347">Name</span><span class="op" id="4496351">)</span>&nbsp;<span class="op" id="4496353">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4496359">enc</span><span class="op" id="4496362">.</span><span class="ident" id="4496363">sendType</span><span class="op" id="4496371">(</span><span class="ident" id="4496372">w</span><span class="op" id="4496373">,</span>&nbsp;<span class="ident" id="4496375">state</span><span class="op" id="4496380">,</span>&nbsp;<span class="ident" id="4496382">st</span><span class="op" id="4496384">.</span><span class="ident" id="4496385">Field</span><span class="op" id="4496390">(</span><span class="ident" id="4496391">i</span><span class="op" id="4496392">)</span><span class="op" id="4496393">.</span><span class="ident" id="4496394">Type</span><span class="op" id="4496398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4496403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4496407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4496410">case</span>&nbsp;<span class="ident" id="4496415">reflect</span><span class="op" id="4496422">.</span><span class="ident" id="4496423">Array</span><span class="op" id="4496428">,</span>&nbsp;<span class="ident" id="4496430">reflect</span><span class="op" id="4496437">.</span><span class="ident" id="4496438">Slice</span><span class="op" id="4496443">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4496447">enc</span><span class="op" id="4496450">.</span><span class="ident" id="4496451">sendType</span><span class="op" id="4496459">(</span><span class="ident" id="4496460">w</span><span class="op" id="4496461">,</span>&nbsp;<span class="ident" id="4496463">state</span><span class="op" id="4496468">,</span>&nbsp;<span class="ident" id="4496470">st</span><span class="op" id="4496472">.</span><span class="ident" id="4496473">Elem</span><span class="op" id="4496477">(</span><span class="op" id="4496478">)</span><span class="op" id="4496479">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4496482">case</span>&nbsp;<span class="ident" id="4496487">reflect</span><span class="op" id="4496494">.</span><span class="ident" id="4496495">Map</span><span class="op" id="4496498">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4496502">enc</span><span class="op" id="4496505">.</span><span class="ident" id="4496506">sendType</span><span class="op" id="4496514">(</span><span class="ident" id="4496515">w</span><span class="op" id="4496516">,</span>&nbsp;<span class="ident" id="4496518">state</span><span class="op" id="4496523">,</span>&nbsp;<span class="ident" id="4496525">st</span><span class="op" id="4496527">.</span><span class="ident" id="4496528">Key</span><span class="op" id="4496531">(</span><span class="op" id="4496532">)</span><span class="op" id="4496533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4496537">enc</span><span class="op" id="4496540">.</span><span class="ident" id="4496541">sendType</span><span class="op" id="4496549">(</span><span class="ident" id="4496550">w</span><span class="op" id="4496551">,</span>&nbsp;<span class="ident" id="4496553">state</span><span class="op" id="4496558">,</span>&nbsp;<span class="ident" id="4496560">st</span><span class="op" id="4496562">.</span><span class="ident" id="4496563">Elem</span><span class="op" id="4496567">(</span><span class="op" id="4496568">)</span><span class="op" id="4496569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4496572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4496575">return</span>&nbsp;<span class="builtintype" id="4496582">true</span><br>
<span class="lineno">125</span><span class="op" id="4496587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4496590">//&nbsp;sendType&nbsp;sends&nbsp;the&nbsp;type&nbsp;info&nbsp;to&nbsp;the&nbsp;other&nbsp;side,&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4496655">func</span>&nbsp;<span class="op" id="4496660">(</span><span class="ident" id="4496661">enc</span>&nbsp;<span class="op" id="4496665">*</span><span class="ident" id="4496666">Encoder</span><span class="op" id="4496673">)</span>&nbsp;<span class="ident" id="4496675">sendType</span><span class="op" id="4496683">(</span><span class="ident" id="4496684">w</span>&nbsp;<span class="ident" id="4496686">io</span><span class="op" id="4496688">.</span><span class="ident" id="4496689">Writer</span><span class="op" id="4496695">,</span>&nbsp;<span class="ident" id="4496697">state</span>&nbsp;<span class="op" id="4496703">*</span><span class="ident" id="4496704">encoderState</span><span class="op" id="4496716">,</span>&nbsp;<span class="ident" id="4496718">origt</span>&nbsp;<span class="ident" id="4496724">reflect</span><span class="op" id="4496731">.</span><span class="ident" id="4496732">Type</span><span class="op" id="4496736">)</span>&nbsp;<span class="op" id="4496738">(</span><span class="ident" id="4496739">sent</span>&nbsp;<span class="builtintype" id="4496744">bool</span><span class="op" id="4496748">)</span>&nbsp;<span class="op" id="4496750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4496753">ut</span>&nbsp;<span class="op" id="4496756">:=</span>&nbsp;<span class="ident" id="4496759">userType</span><span class="op" id="4496767">(</span><span class="ident" id="4496768">origt</span><span class="op" id="4496773">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4496776">if</span>&nbsp;<span class="ident" id="4496779">ut</span><span class="op" id="4496781">.</span><span class="ident" id="4496782">externalEnc</span>&nbsp;<span class="op" id="4496794">!=</span>&nbsp;<span class="num" id="4496797">0</span>&nbsp;<span class="op" id="4496799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4496803">//&nbsp;The&nbsp;rules&nbsp;are&nbsp;different:&nbsp;regardless&nbsp;of&nbsp;the&nbsp;underlying&nbsp;type&#39;s&nbsp;representation,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4496885">//&nbsp;we&nbsp;need&nbsp;to&nbsp;tell&nbsp;the&nbsp;other&nbsp;side&nbsp;that&nbsp;the&nbsp;base&nbsp;type&nbsp;is&nbsp;a&nbsp;GobEncoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4496957">return</span>&nbsp;<span class="ident" id="4496964">enc</span><span class="op" id="4496967">.</span><span class="ident" id="4496968">sendActualType</span><span class="op" id="4496982">(</span><span class="ident" id="4496983">w</span><span class="op" id="4496984">,</span>&nbsp;<span class="ident" id="4496986">state</span><span class="op" id="4496991">,</span>&nbsp;<span class="ident" id="4496993">ut</span><span class="op" id="4496995">,</span>&nbsp;<span class="ident" id="4496997">ut</span><span class="op" id="4496999">.</span><span class="ident" id="4497000">base</span><span class="op" id="4497004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4497007">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4497011">//&nbsp;It&#39;s&nbsp;a&nbsp;concrete&nbsp;value,&nbsp;so&nbsp;drill&nbsp;down&nbsp;to&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497070">switch</span>&nbsp;<span class="ident" id="4497077">rt</span>&nbsp;<span class="op" id="4497080">:=</span>&nbsp;<span class="ident" id="4497083">ut</span><span class="op" id="4497085">.</span><span class="ident" id="4497086">base</span><span class="op" id="4497090">;</span>&nbsp;<span class="ident" id="4497092">rt</span><span class="op" id="4497094">.</span><span class="ident" id="4497095">Kind</span><span class="op" id="4497099">(</span><span class="op" id="4497100">)</span>&nbsp;<span class="op" id="4497102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497105">default</span><span class="op" id="4497112">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4497116">//&nbsp;Basic&nbsp;types&nbsp;and&nbsp;interfaces&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;described.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497177">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497185">case</span>&nbsp;<span class="ident" id="4497190">reflect</span><span class="op" id="4497197">.</span><span class="ident" id="4497198">Slice</span><span class="op" id="4497203">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4497207">//&nbsp;If&nbsp;it&#39;s&nbsp;[]uint8,&nbsp;don&#39;t&nbsp;send;&nbsp;it&#39;s&nbsp;considered&nbsp;basic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497264">if</span>&nbsp;<span class="ident" id="4497267">rt</span><span class="op" id="4497269">.</span><span class="ident" id="4497270">Elem</span><span class="op" id="4497274">(</span><span class="op" id="4497275">)</span><span class="op" id="4497276">.</span><span class="ident" id="4497277">Kind</span><span class="op" id="4497281">(</span><span class="op" id="4497282">)</span>&nbsp;<span class="op" id="4497284">==</span>&nbsp;<span class="ident" id="4497287">reflect</span><span class="op" id="4497294">.</span><span class="ident" id="4497295">Uint8</span>&nbsp;<span class="op" id="4497301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497306">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4497315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4497319">//&nbsp;Otherwise&nbsp;we&nbsp;do&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497346">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497353">case</span>&nbsp;<span class="ident" id="4497358">reflect</span><span class="op" id="4497365">.</span><span class="ident" id="4497366">Array</span><span class="op" id="4497371">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4497375">//&nbsp;arrays&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;element&nbsp;types.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497444">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497451">case</span>&nbsp;<span class="ident" id="4497456">reflect</span><span class="op" id="4497463">.</span><span class="ident" id="4497464">Map</span><span class="op" id="4497467">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4497471">//&nbsp;maps&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;key/value&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497540">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497547">case</span>&nbsp;<span class="ident" id="4497552">reflect</span><span class="op" id="4497559">.</span><span class="ident" id="4497560">Struct</span><span class="op" id="4497566">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4497570">//&nbsp;structs&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497621">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497628">case</span>&nbsp;<span class="ident" id="4497633">reflect</span><span class="op" id="4497640">.</span><span class="ident" id="4497641">Chan</span><span class="op" id="4497645">,</span>&nbsp;<span class="ident" id="4497647">reflect</span><span class="op" id="4497654">.</span><span class="ident" id="4497655">Func</span><span class="op" id="4497659">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4497663">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here,&nbsp;it&#39;s&nbsp;a&nbsp;field&nbsp;of&nbsp;a&nbsp;struct;&nbsp;ignore&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497721">return</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4497729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497733">return</span>&nbsp;<span class="ident" id="4497740">enc</span><span class="op" id="4497743">.</span><span class="ident" id="4497744">sendActualType</span><span class="op" id="4497758">(</span><span class="ident" id="4497759">w</span><span class="op" id="4497760">,</span>&nbsp;<span class="ident" id="4497762">state</span><span class="op" id="4497767">,</span>&nbsp;<span class="ident" id="4497769">ut</span><span class="op" id="4497771">,</span>&nbsp;<span class="ident" id="4497773">ut</span><span class="op" id="4497775">.</span><span class="ident" id="4497776">base</span><span class="op" id="4497780">)</span><br>
<span class="lineno"></span><span class="op" id="4497782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="4497785">//&nbsp;Encode&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;empty&nbsp;interface&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="4497861">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="4497941">func</span>&nbsp;<span class="op" id="4497946">(</span><span class="ident" id="4497947">enc</span>&nbsp;<span class="op" id="4497951">*</span><span class="ident" id="4497952">Encoder</span><span class="op" id="4497959">)</span>&nbsp;<span class="ident" id="4497961">Encode</span><span class="op" id="4497967">(</span><span class="ident" id="4497968">e</span>&nbsp;<span class="keyword" id="4497970">interface</span><span class="op" id="4497979">{</span><span class="op" id="4497980">}</span><span class="op" id="4497981">)</span>&nbsp;<span class="builtintype" id="4497983">error</span>&nbsp;<span class="op" id="4497989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4497992">return</span>&nbsp;<span class="ident" id="4497999">enc</span><span class="op" id="4498002">.</span><span class="ident" id="4498003">EncodeValue</span><span class="op" id="4498014">(</span><span class="ident" id="4498015">reflect</span><span class="op" id="4498022">.</span><span class="ident" id="4498023">ValueOf</span><span class="op" id="4498030">(</span><span class="ident" id="4498031">e</span><span class="op" id="4498032">)</span><span class="op" id="4498033">)</span><br>
<span class="lineno"></span><span class="op" id="4498035">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="4498038">//&nbsp;sendTypeDescriptor&nbsp;makes&nbsp;sure&nbsp;the&nbsp;remote&nbsp;side&nbsp;knows&nbsp;about&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="4498110">//&nbsp;It&nbsp;will&nbsp;send&nbsp;a&nbsp;descriptor&nbsp;if&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;time&nbsp;the&nbsp;type&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span><span class="comment" id="4498183">//&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="4498192">func</span>&nbsp;<span class="op" id="4498197">(</span><span class="ident" id="4498198">enc</span>&nbsp;<span class="op" id="4498202">*</span><span class="ident" id="4498203">Encoder</span><span class="op" id="4498210">)</span>&nbsp;<span class="ident" id="4498212">sendTypeDescriptor</span><span class="op" id="4498230">(</span><span class="ident" id="4498231">w</span>&nbsp;<span class="ident" id="4498233">io</span><span class="op" id="4498235">.</span><span class="ident" id="4498236">Writer</span><span class="op" id="4498242">,</span>&nbsp;<span class="ident" id="4498244">state</span>&nbsp;<span class="op" id="4498250">*</span><span class="ident" id="4498251">encoderState</span><span class="op" id="4498263">,</span>&nbsp;<span class="ident" id="4498265">ut</span>&nbsp;<span class="op" id="4498268">*</span><span class="ident" id="4498269">userTypeInfo</span><span class="op" id="4498281">)</span>&nbsp;<span class="op" id="4498283">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4498286">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;type&nbsp;is&nbsp;known&nbsp;to&nbsp;the&nbsp;other&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4498337">//&nbsp;First,&nbsp;have&nbsp;we&nbsp;already&nbsp;sent&nbsp;this&nbsp;type?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4498380">rt</span>&nbsp;<span class="op" id="4498383">:=</span>&nbsp;<span class="ident" id="4498386">ut</span><span class="op" id="4498388">.</span><span class="ident" id="4498389">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4498395">if</span>&nbsp;<span class="ident" id="4498398">ut</span><span class="op" id="4498400">.</span><span class="ident" id="4498401">externalEnc</span>&nbsp;<span class="op" id="4498413">!=</span>&nbsp;<span class="num" id="4498416">0</span>&nbsp;<span class="op" id="4498418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4498422">rt</span>&nbsp;<span class="op" id="4498425">=</span>&nbsp;<span class="ident" id="4498427">ut</span><span class="op" id="4498429">.</span><span class="ident" id="4498430">user</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4498436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4498439">if</span>&nbsp;<span class="ident" id="4498442">_</span><span class="op" id="4498443">,</span>&nbsp;<span class="ident" id="4498445">alreadySent</span>&nbsp;<span class="op" id="4498457">:=</span>&nbsp;<span class="ident" id="4498460">enc</span><span class="op" id="4498463">.</span><span class="ident" id="4498464">sent</span><span class="op" id="4498468">[</span><span class="ident" id="4498469">rt</span><span class="op" id="4498471">]</span><span class="op" id="4498472">;</span>&nbsp;<span class="op" id="4498474">!</span><span class="ident" id="4498475">alreadySent</span>&nbsp;<span class="op" id="4498487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4498491">//&nbsp;No,&nbsp;so&nbsp;send&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4498512">sent</span>&nbsp;<span class="op" id="4498517">:=</span>&nbsp;<span class="ident" id="4498520">enc</span><span class="op" id="4498523">.</span><span class="ident" id="4498524">sendType</span><span class="op" id="4498532">(</span><span class="ident" id="4498533">w</span><span class="op" id="4498534">,</span>&nbsp;<span class="ident" id="4498536">state</span><span class="op" id="4498541">,</span>&nbsp;<span class="ident" id="4498543">rt</span><span class="op" id="4498545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4498549">if</span>&nbsp;<span class="ident" id="4498552">enc</span><span class="op" id="4498555">.</span><span class="ident" id="4498556">err</span>&nbsp;<span class="op" id="4498560">!=</span>&nbsp;<span class="ident" id="4498563">nil</span>&nbsp;<span class="op" id="4498567">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4498572">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4498581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4498585">//&nbsp;If&nbsp;the&nbsp;type&nbsp;info&nbsp;has&nbsp;still&nbsp;not&nbsp;been&nbsp;transmitted,&nbsp;it&nbsp;means&nbsp;we&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4498656">//&nbsp;a&nbsp;singleton&nbsp;basic&nbsp;type&nbsp;(int,&nbsp;[]byte&nbsp;etc.)&nbsp;at&nbsp;top&nbsp;level.&nbsp;&nbsp;We&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4498727">//&nbsp;need&nbsp;to&nbsp;send&nbsp;the&nbsp;type&nbsp;info&nbsp;but&nbsp;we&nbsp;do&nbsp;need&nbsp;to&nbsp;update&nbsp;enc.sent.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4498794">if</span>&nbsp;<span class="op" id="4498797">!</span><span class="ident" id="4498798">sent</span>&nbsp;<span class="op" id="4498803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4498808">info</span><span class="op" id="4498812">,</span>&nbsp;<span class="ident" id="4498814">err</span>&nbsp;<span class="op" id="4498818">:=</span>&nbsp;<span class="ident" id="4498821">getTypeInfo</span><span class="op" id="4498832">(</span><span class="ident" id="4498833">ut</span><span class="op" id="4498835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4498840">if</span>&nbsp;<span class="ident" id="4498843">err</span>&nbsp;<span class="op" id="4498847">!=</span>&nbsp;<span class="ident" id="4498850">nil</span>&nbsp;<span class="op" id="4498854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4498860">enc</span><span class="op" id="4498863">.</span><span class="ident" id="4498864">setError</span><span class="op" id="4498872">(</span><span class="ident" id="4498873">err</span><span class="op" id="4498876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4498882">return</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4498892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4498897">enc</span><span class="op" id="4498900">.</span><span class="ident" id="4498901">sent</span><span class="op" id="4498905">[</span><span class="ident" id="4498906">rt</span><span class="op" id="4498908">]</span>&nbsp;<span class="op" id="4498910">=</span>&nbsp;<span class="ident" id="4498912">info</span><span class="op" id="4498916">.</span><span class="ident" id="4498917">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4498922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4498925">}</span><br>
<span class="lineno"></span><span class="op" id="4498927">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="4498930">//&nbsp;sendTypeId&nbsp;sends&nbsp;the&nbsp;id,&nbsp;which&nbsp;must&nbsp;have&nbsp;already&nbsp;been&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="4498996">func</span>&nbsp;<span class="op" id="4499001">(</span><span class="ident" id="4499002">enc</span>&nbsp;<span class="op" id="4499006">*</span><span class="ident" id="4499007">Encoder</span><span class="op" id="4499014">)</span>&nbsp;<span class="ident" id="4499016">sendTypeId</span><span class="op" id="4499026">(</span><span class="ident" id="4499027">state</span>&nbsp;<span class="op" id="4499033">*</span><span class="ident" id="4499034">encoderState</span><span class="op" id="4499046">,</span>&nbsp;<span class="ident" id="4499048">ut</span>&nbsp;<span class="op" id="4499051">*</span><span class="ident" id="4499052">userTypeInfo</span><span class="op" id="4499064">)</span>&nbsp;<span class="op" id="4499066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4499069">//&nbsp;Identify&nbsp;the&nbsp;type&nbsp;of&nbsp;this&nbsp;top-level&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4499116">state</span><span class="op" id="4499121">.</span><span class="ident" id="4499122">encodeInt</span><span class="op" id="4499131">(</span><span class="ident" id="4499132">int64</span><span class="op" id="4499137">(</span><span class="ident" id="4499138">enc</span><span class="op" id="4499141">.</span><span class="ident" id="4499142">sent</span><span class="op" id="4499146">[</span><span class="ident" id="4499147">ut</span><span class="op" id="4499149">.</span><span class="ident" id="4499150">base</span><span class="op" id="4499154">]</span><span class="op" id="4499155">)</span><span class="op" id="4499156">)</span><br>
<span class="lineno">205</span><span class="op" id="4499158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4499161">//&nbsp;EncodeValue&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;reflection&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="4499237">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="4499317">func</span>&nbsp;<span class="op" id="4499322">(</span><span class="ident" id="4499323">enc</span>&nbsp;<span class="op" id="4499327">*</span><span class="ident" id="4499328">Encoder</span><span class="op" id="4499335">)</span>&nbsp;<span class="ident" id="4499337">EncodeValue</span><span class="op" id="4499348">(</span><span class="ident" id="4499349">value</span>&nbsp;<span class="ident" id="4499355">reflect</span><span class="op" id="4499362">.</span><span class="ident" id="4499363">Value</span><span class="op" id="4499368">)</span>&nbsp;<span class="builtintype" id="4499370">error</span>&nbsp;<span class="op" id="4499376">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4499379">//&nbsp;Gobs&nbsp;contain&nbsp;values.&nbsp;They&nbsp;cannot&nbsp;represent&nbsp;nil&nbsp;pointers,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4499446">//&nbsp;have&nbsp;no&nbsp;value&nbsp;to&nbsp;encode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4499475">if</span>&nbsp;<span class="ident" id="4499478">value</span><span class="op" id="4499483">.</span><span class="ident" id="4499484">Kind</span><span class="op" id="4499488">(</span><span class="op" id="4499489">)</span>&nbsp;<span class="op" id="4499491">==</span>&nbsp;<span class="ident" id="4499494">reflect</span><span class="op" id="4499501">.</span><span class="ident" id="4499502">Ptr</span>&nbsp;<span class="op" id="4499506">&amp;&amp;</span>&nbsp;<span class="ident" id="4499509">value</span><span class="op" id="4499514">.</span><span class="ident" id="4499515">IsNil</span><span class="op" id="4499520">(</span><span class="op" id="4499521">)</span>&nbsp;<span class="op" id="4499523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4499527">panic</span><span class="op" id="4499532">(</span><span class="string" id="4499533">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4499575">+</span>&nbsp;<span class="ident" id="4499577">value</span><span class="op" id="4499582">.</span><span class="ident" id="4499583">Type</span><span class="op" id="4499587">(</span><span class="op" id="4499588">)</span><span class="op" id="4499589">.</span><span class="ident" id="4499590">String</span><span class="op" id="4499596">(</span><span class="op" id="4499597">)</span><span class="op" id="4499598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4499601">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4499605">//&nbsp;Make&nbsp;sure&nbsp;we&#39;re&nbsp;single-threaded&nbsp;through&nbsp;here,&nbsp;so&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4499667">//&nbsp;goroutines&nbsp;can&nbsp;share&nbsp;an&nbsp;encoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4499704">enc</span><span class="op" id="4499707">.</span><span class="ident" id="4499708">mutex</span><span class="op" id="4499713">.</span><span class="ident" id="4499714">Lock</span><span class="op" id="4499718">(</span><span class="op" id="4499719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4499722">defer</span>&nbsp;<span class="ident" id="4499728">enc</span><span class="op" id="4499731">.</span><span class="ident" id="4499732">mutex</span><span class="op" id="4499737">.</span><span class="ident" id="4499738">Unlock</span><span class="op" id="4499744">(</span><span class="op" id="4499745">)</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4499749">//&nbsp;Remove&nbsp;any&nbsp;nested&nbsp;writers&nbsp;remaining&nbsp;due&nbsp;to&nbsp;previous&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4499813">enc</span><span class="op" id="4499816">.</span><span class="ident" id="4499817">w</span>&nbsp;<span class="op" id="4499819">=</span>&nbsp;<span class="ident" id="4499821">enc</span><span class="op" id="4499824">.</span><span class="ident" id="4499825">w</span><span class="op" id="4499826">[</span><span class="num" id="4499827">0</span><span class="op" id="4499828">:</span><span class="num" id="4499829">1</span><span class="op" id="4499830">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4499834">ut</span><span class="op" id="4499836">,</span>&nbsp;<span class="ident" id="4499838">err</span>&nbsp;<span class="op" id="4499842">:=</span>&nbsp;<span class="ident" id="4499845">validUserType</span><span class="op" id="4499858">(</span><span class="ident" id="4499859">value</span><span class="op" id="4499864">.</span><span class="ident" id="4499865">Type</span><span class="op" id="4499869">(</span><span class="op" id="4499870">)</span><span class="op" id="4499871">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4499874">if</span>&nbsp;<span class="ident" id="4499877">err</span>&nbsp;<span class="op" id="4499881">!=</span>&nbsp;<span class="ident" id="4499884">nil</span>&nbsp;<span class="op" id="4499888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4499892">return</span>&nbsp;<span class="ident" id="4499899">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4499904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4499908">enc</span><span class="op" id="4499911">.</span><span class="ident" id="4499912">err</span>&nbsp;<span class="op" id="4499916">=</span>&nbsp;<span class="ident" id="4499918">nil</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4499923">enc</span><span class="op" id="4499926">.</span><span class="ident" id="4499927">byteBuf</span><span class="op" id="4499934">.</span><span class="ident" id="4499935">Reset</span><span class="op" id="4499940">(</span><span class="op" id="4499941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4499944">enc</span><span class="op" id="4499947">.</span><span class="ident" id="4499948">byteBuf</span><span class="op" id="4499955">.</span><span class="ident" id="4499956">Write</span><span class="op" id="4499961">(</span><span class="ident" id="4499962">spaceForLength</span><span class="op" id="4499976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4499979">state</span>&nbsp;<span class="op" id="4499985">:=</span>&nbsp;<span class="ident" id="4499988">enc</span><span class="op" id="4499991">.</span><span class="ident" id="4499992">newEncoderState</span><span class="op" id="4500007">(</span><span class="op" id="4500008">&amp;</span><span class="ident" id="4500009">enc</span><span class="op" id="4500012">.</span><span class="ident" id="4500013">byteBuf</span><span class="op" id="4500020">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4500024">enc</span><span class="op" id="4500027">.</span><span class="ident" id="4500028">sendTypeDescriptor</span><span class="op" id="4500046">(</span><span class="ident" id="4500047">enc</span><span class="op" id="4500050">.</span><span class="ident" id="4500051">writer</span><span class="op" id="4500057">(</span><span class="op" id="4500058">)</span><span class="op" id="4500059">,</span>&nbsp;<span class="ident" id="4500061">state</span><span class="op" id="4500066">,</span>&nbsp;<span class="ident" id="4500068">ut</span><span class="op" id="4500070">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4500073">enc</span><span class="op" id="4500076">.</span><span class="ident" id="4500077">sendTypeId</span><span class="op" id="4500087">(</span><span class="ident" id="4500088">state</span><span class="op" id="4500093">,</span>&nbsp;<span class="ident" id="4500095">ut</span><span class="op" id="4500097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4500100">if</span>&nbsp;<span class="ident" id="4500103">enc</span><span class="op" id="4500106">.</span><span class="ident" id="4500107">err</span>&nbsp;<span class="op" id="4500111">!=</span>&nbsp;<span class="ident" id="4500114">nil</span>&nbsp;<span class="op" id="4500118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4500122">return</span>&nbsp;<span class="ident" id="4500129">enc</span><span class="op" id="4500132">.</span><span class="ident" id="4500133">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4500138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4500142">//&nbsp;Encode&nbsp;the&nbsp;object.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4500165">enc</span><span class="op" id="4500168">.</span><span class="ident" id="4500169">encode</span><span class="op" id="4500175">(</span><span class="ident" id="4500176">state</span><span class="op" id="4500181">.</span><span class="ident" id="4500182">b</span><span class="op" id="4500183">,</span>&nbsp;<span class="ident" id="4500185">value</span><span class="op" id="4500190">,</span>&nbsp;<span class="ident" id="4500192">ut</span><span class="op" id="4500194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4500197">if</span>&nbsp;<span class="ident" id="4500200">enc</span><span class="op" id="4500203">.</span><span class="ident" id="4500204">err</span>&nbsp;<span class="op" id="4500208">==</span>&nbsp;<span class="ident" id="4500211">nil</span>&nbsp;<span class="op" id="4500215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4500219">enc</span><span class="op" id="4500222">.</span><span class="ident" id="4500223">writeMessage</span><span class="op" id="4500235">(</span><span class="ident" id="4500236">enc</span><span class="op" id="4500239">.</span><span class="ident" id="4500240">writer</span><span class="op" id="4500246">(</span><span class="op" id="4500247">)</span><span class="op" id="4500248">,</span>&nbsp;<span class="ident" id="4500250">state</span><span class="op" id="4500255">.</span><span class="ident" id="4500256">b</span><span class="op" id="4500257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4500260">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4500264">enc</span><span class="op" id="4500267">.</span><span class="ident" id="4500268">freeEncoderState</span><span class="op" id="4500284">(</span><span class="ident" id="4500285">state</span><span class="op" id="4500290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4500293">return</span>&nbsp;<span class="ident" id="4500300">enc</span><span class="op" id="4500303">.</span><span class="ident" id="4500304">err</span><br>
<span class="lineno"></span><span class="op" id="4500308">}</span>
</div>
</body>
</html>
