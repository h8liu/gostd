<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1688793">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1688848">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1688902">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1688953">//&nbsp;Semaphore&nbsp;implementation&nbsp;exposed&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="1688996">//&nbsp;Intended&nbsp;use&nbsp;is&nbsp;provide&nbsp;a&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1689042">//&nbsp;primitive&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;contended&nbsp;case</span><br>
<span class="lineno"></span><span class="comment" id="1689094">//&nbsp;of&nbsp;other&nbsp;synchronization&nbsp;primitives.</span><br>
<span class="lineno"></span><span class="comment" id="1689134">//&nbsp;Thus&nbsp;it&nbsp;targets&nbsp;the&nbsp;same&nbsp;goal&nbsp;as&nbsp;Linux&#39;s&nbsp;futex,</span><br>
<span class="lineno">10</span><span class="comment" id="1689185">//&nbsp;but&nbsp;it&nbsp;has&nbsp;much&nbsp;simpler&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="1689223">//</span><br>
<span class="lineno"></span><span class="comment" id="1689226">//&nbsp;That&nbsp;is,&nbsp;don&#39;t&nbsp;think&nbsp;of&nbsp;these&nbsp;as&nbsp;semaphores.</span><br>
<span class="lineno"></span><span class="comment" id="1689274">//&nbsp;Think&nbsp;of&nbsp;them&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;implement&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1689330">//&nbsp;such&nbsp;that&nbsp;every&nbsp;sleep&nbsp;is&nbsp;paired&nbsp;with&nbsp;a&nbsp;single&nbsp;wakeup,</span><br>
<span class="lineno">15</span><span class="comment" id="1689387">//&nbsp;even&nbsp;if,&nbsp;due&nbsp;to&nbsp;races,&nbsp;the&nbsp;wakeup&nbsp;happens&nbsp;before&nbsp;the&nbsp;sleep.</span><br>
<span class="lineno"></span><span class="comment" id="1689450">//</span><br>
<span class="lineno"></span><span class="comment" id="1689453">//&nbsp;See&nbsp;Mullender&nbsp;and&nbsp;Cox,&nbsp;``Semaphores&nbsp;in&nbsp;Plan&nbsp;9,&#39;&#39;</span><br>
<span class="lineno"></span><span class="comment" id="1689505">//&nbsp;http://swtch.com/semaphore.pdf</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1689540">package</span>&nbsp;<span class="ident" id="1689548">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1689557">import</span>&nbsp;<span class="string" id="1689564">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1689574">//&nbsp;Asynchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Mutex.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1689617">type</span>&nbsp;<span class="ident" id="1689622">semaRoot</span>&nbsp;<span class="keyword" id="1689631">struct</span>&nbsp;<span class="op" id="1689638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689641">lock</span>&nbsp;&nbsp;<span class="ident" id="1689647">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689654">head</span>&nbsp;&nbsp;<span class="op" id="1689660">*</span><span class="ident" id="1689661">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689668">tail</span>&nbsp;&nbsp;<span class="op" id="1689674">*</span><span class="ident" id="1689675">sudog</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689682">nwait</span>&nbsp;<span class="builtintype" id="1689688">uint32</span>&nbsp;<span class="comment" id="1689695">//&nbsp;Number&nbsp;of&nbsp;waiters.&nbsp;Read&nbsp;w/o&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="op" id="1689736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1689739">//&nbsp;Prime&nbsp;to&nbsp;not&nbsp;correlate&nbsp;with&nbsp;any&nbsp;user&nbsp;patterns.</span><br>
<span class="lineno"></span><span class="keyword" id="1689789">const</span>&nbsp;<span class="ident" id="1689795">semTabSize</span>&nbsp;<span class="op" id="1689806">=</span>&nbsp;<span class="num" id="1689808">251</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1689813">var</span>&nbsp;<span class="ident" id="1689817">semtable</span>&nbsp;<span class="op" id="1689826">[</span><span class="ident" id="1689827">semTabSize</span><span class="op" id="1689837">]</span><span class="keyword" id="1689838">struct</span>&nbsp;<span class="op" id="1689845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689848">root</span>&nbsp;<span class="ident" id="1689853">semaRoot</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689863">pad</span>&nbsp;&nbsp;<span class="op" id="1689868">[</span><span class="ident" id="1689869">_CacheLineSize</span>&nbsp;<span class="op" id="1689884">-</span>&nbsp;<span class="ident" id="1689886">unsafe</span><span class="op" id="1689892">.</span><span class="ident" id="1689893">Sizeof</span><span class="op" id="1689899">(</span><span class="ident" id="1689900">semaRoot</span><span class="op" id="1689908">{</span><span class="op" id="1689909">}</span><span class="op" id="1689910">)</span><span class="op" id="1689911">]</span><span class="builtintype" id="1689912">byte</span><br>
<span class="lineno"></span><span class="op" id="1689917">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="1689920">//&nbsp;Called&nbsp;from&nbsp;sync/net&nbsp;packages.</span><br>
<span class="lineno"></span><span class="keyword" id="1689954">func</span>&nbsp;<span class="ident" id="1689959">asyncsemacquire</span><span class="op" id="1689974">(</span><span class="ident" id="1689975">addr</span>&nbsp;<span class="op" id="1689980">*</span><span class="builtintype" id="1689981">uint32</span><span class="op" id="1689987">)</span>&nbsp;<span class="op" id="1689989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689992">semacquire</span><span class="op" id="1690002">(</span><span class="ident" id="1690003">addr</span><span class="op" id="1690007">,</span>&nbsp;<span class="ident" id="1690009">true</span><span class="op" id="1690013">)</span><br>
<span class="lineno"></span><span class="op" id="1690015">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="1690018">func</span>&nbsp;<span class="ident" id="1690023">asyncsemrelease</span><span class="op" id="1690038">(</span><span class="ident" id="1690039">addr</span>&nbsp;<span class="op" id="1690044">*</span><span class="builtintype" id="1690045">uint32</span><span class="op" id="1690051">)</span>&nbsp;<span class="op" id="1690053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690056">semrelease</span><span class="op" id="1690066">(</span><span class="ident" id="1690067">addr</span><span class="op" id="1690071">)</span><br>
<span class="lineno"></span><span class="op" id="1690073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="1690076">//&nbsp;Called&nbsp;from&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1690100">func</span>&nbsp;<span class="ident" id="1690105">semacquire</span><span class="op" id="1690115">(</span><span class="ident" id="1690116">addr</span>&nbsp;<span class="op" id="1690121">*</span><span class="builtintype" id="1690122">uint32</span><span class="op" id="1690128">,</span>&nbsp;<span class="ident" id="1690130">profile</span>&nbsp;<span class="builtintype" id="1690138">bool</span><span class="op" id="1690142">)</span>&nbsp;<span class="op" id="1690144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690147">gp</span>&nbsp;<span class="op" id="1690150">:=</span>&nbsp;<span class="ident" id="1690153">getg</span><span class="op" id="1690157">(</span><span class="op" id="1690158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690161">if</span>&nbsp;<span class="ident" id="1690164">gp</span>&nbsp;<span class="op" id="1690167">!=</span>&nbsp;<span class="ident" id="1690170">gp</span><span class="op" id="1690172">.</span><span class="ident" id="1690173">m</span><span class="op" id="1690174">.</span><span class="ident" id="1690175">curg</span>&nbsp;<span class="op" id="1690180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690184">gothrow</span><span class="op" id="1690191">(</span><span class="string" id="1690192">&#34;semacquire&nbsp;not&nbsp;on&nbsp;the&nbsp;G&nbsp;stack&#34;</span><span class="op" id="1690223">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1690226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1690230">//&nbsp;Easy&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690245">if</span>&nbsp;<span class="ident" id="1690248">cansemacquire</span><span class="op" id="1690261">(</span><span class="ident" id="1690262">addr</span><span class="op" id="1690266">)</span>&nbsp;<span class="op" id="1690268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690272">return</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1690280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1690284">//&nbsp;Harder&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1690301">//&nbsp;&nbsp;&nbsp;&nbspincrement&nbsp;waiter&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1690328">//&nbsp;&nbsp;&nbsp;&nbsptry&nbsp;cansemacquire&nbsp;one&nbsp;more&nbsp;time,&nbsp;return&nbsp;if&nbsp;succeeded</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1690385">//&nbsp;&nbsp;&nbsp;&nbspenqueue&nbsp;itself&nbsp;as&nbsp;a&nbsp;waiter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1690416">//&nbsp;&nbsp;&nbsp;&nbspsleep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1690426">//&nbsp;&nbsp;&nbsp;&nbsp(waiter&nbsp;descriptor&nbsp;is&nbsp;dequeued&nbsp;by&nbsp;signaler)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690474">s</span>&nbsp;<span class="op" id="1690476">:=</span>&nbsp;<span class="ident" id="1690479">acquireSudog</span><span class="op" id="1690491">(</span><span class="op" id="1690492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690495">root</span>&nbsp;<span class="op" id="1690500">:=</span>&nbsp;<span class="ident" id="1690503">semroot</span><span class="op" id="1690510">(</span><span class="ident" id="1690511">addr</span><span class="op" id="1690515">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690518">t0</span>&nbsp;<span class="op" id="1690521">:=</span>&nbsp;<span class="ident" id="1690524">int64</span><span class="op" id="1690529">(</span><span class="num" id="1690530">0</span><span class="op" id="1690531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690534">s</span><span class="op" id="1690535">.</span><span class="ident" id="1690536">releasetime</span>&nbsp;<span class="op" id="1690548">=</span>&nbsp;<span class="num" id="1690550">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690553">if</span>&nbsp;<span class="ident" id="1690556">profile</span>&nbsp;<span class="op" id="1690564">&amp;&amp;</span>&nbsp;<span class="ident" id="1690567">blockprofilerate</span>&nbsp;<span class="op" id="1690584">&gt;</span>&nbsp;<span class="num" id="1690586">0</span>&nbsp;<span class="op" id="1690588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690592">t0</span>&nbsp;<span class="op" id="1690595">=</span>&nbsp;<span class="ident" id="1690597">cputicks</span><span class="op" id="1690605">(</span><span class="op" id="1690606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690610">s</span><span class="op" id="1690611">.</span><span class="ident" id="1690612">releasetime</span>&nbsp;<span class="op" id="1690624">=</span>&nbsp;<span class="op" id="1690626">-</span><span class="num" id="1690627">1</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1690630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690633">for</span>&nbsp;<span class="op" id="1690637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690641">lock</span><span class="op" id="1690645">(</span><span class="op" id="1690646">&amp;</span><span class="ident" id="1690647">root</span><span class="op" id="1690651">.</span><span class="ident" id="1690652">lock</span><span class="op" id="1690656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1690660">//&nbsp;Add&nbsp;ourselves&nbsp;to&nbsp;nwait&nbsp;to&nbsp;disable&nbsp;&#34;easy&nbsp;case&#34;&nbsp;in&nbsp;semrelease.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690726">xadd</span><span class="op" id="1690730">(</span><span class="op" id="1690731">&amp;</span><span class="ident" id="1690732">root</span><span class="op" id="1690736">.</span><span class="ident" id="1690737">nwait</span><span class="op" id="1690742">,</span>&nbsp;<span class="num" id="1690744">1</span><span class="op" id="1690745">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1690749">//&nbsp;Check&nbsp;cansemacquire&nbsp;to&nbsp;avoid&nbsp;missed&nbsp;wakeup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690798">if</span>&nbsp;<span class="ident" id="1690801">cansemacquire</span><span class="op" id="1690814">(</span><span class="ident" id="1690815">addr</span><span class="op" id="1690819">)</span>&nbsp;<span class="op" id="1690821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690826">xadd</span><span class="op" id="1690830">(</span><span class="op" id="1690831">&amp;</span><span class="ident" id="1690832">root</span><span class="op" id="1690836">.</span><span class="ident" id="1690837">nwait</span><span class="op" id="1690842">,</span>&nbsp;<span class="op" id="1690844">-</span><span class="num" id="1690845">1</span><span class="op" id="1690846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690851">unlock</span><span class="op" id="1690857">(</span><span class="op" id="1690858">&amp;</span><span class="ident" id="1690859">root</span><span class="op" id="1690863">.</span><span class="ident" id="1690864">lock</span><span class="op" id="1690868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690873">break</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1690881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1690885">//&nbsp;Any&nbsp;semrelease&nbsp;after&nbsp;the&nbsp;cansemacquire&nbsp;knows&nbsp;we&#39;re&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1690949">//&nbsp;(we&nbsp;set&nbsp;nwait&nbsp;above),&nbsp;so&nbsp;go&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690992">root</span><span class="op" id="1690996">.</span><span class="ident" id="1690997">queue</span><span class="op" id="1691002">(</span><span class="ident" id="1691003">addr</span><span class="op" id="1691007">,</span>&nbsp;<span class="ident" id="1691009">s</span><span class="op" id="1691010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691014">goparkunlock</span><span class="op" id="1691026">(</span><span class="op" id="1691027">&amp;</span><span class="ident" id="1691028">root</span><span class="op" id="1691032">.</span><span class="ident" id="1691033">lock</span><span class="op" id="1691037">,</span>&nbsp;<span class="string" id="1691039">&#34;semacquire&#34;</span><span class="op" id="1691051">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691055">if</span>&nbsp;<span class="ident" id="1691058">cansemacquire</span><span class="op" id="1691071">(</span><span class="ident" id="1691072">addr</span><span class="op" id="1691076">)</span>&nbsp;<span class="op" id="1691078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691083">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691097">if</span>&nbsp;<span class="ident" id="1691100">s</span><span class="op" id="1691101">.</span><span class="ident" id="1691102">releasetime</span>&nbsp;<span class="op" id="1691114">&gt;</span>&nbsp;<span class="num" id="1691116">0</span>&nbsp;<span class="op" id="1691118">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691122">blockevent</span><span class="op" id="1691132">(</span><span class="ident" id="1691133">int64</span><span class="op" id="1691138">(</span><span class="ident" id="1691139">s</span><span class="op" id="1691140">.</span><span class="ident" id="1691141">releasetime</span><span class="op" id="1691152">)</span><span class="op" id="1691153">-</span><span class="ident" id="1691154">t0</span><span class="op" id="1691156">,</span>&nbsp;<span class="num" id="1691158">3</span><span class="op" id="1691159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691165">releaseSudog</span><span class="op" id="1691177">(</span><span class="ident" id="1691178">s</span><span class="op" id="1691179">)</span><br>
<span class="lineno"></span><span class="op" id="1691181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="1691184">func</span>&nbsp;<span class="ident" id="1691189">semrelease</span><span class="op" id="1691199">(</span><span class="ident" id="1691200">addr</span>&nbsp;<span class="op" id="1691205">*</span><span class="builtintype" id="1691206">uint32</span><span class="op" id="1691212">)</span>&nbsp;<span class="op" id="1691214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691217">root</span>&nbsp;<span class="op" id="1691222">:=</span>&nbsp;<span class="ident" id="1691225">semroot</span><span class="op" id="1691232">(</span><span class="ident" id="1691233">addr</span><span class="op" id="1691237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691240">xadd</span><span class="op" id="1691244">(</span><span class="ident" id="1691245">addr</span><span class="op" id="1691249">,</span>&nbsp;<span class="num" id="1691251">1</span><span class="op" id="1691252">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1691256">//&nbsp;Easy&nbsp;case:&nbsp;no&nbsp;waiters?</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1691283">//&nbsp;This&nbsp;check&nbsp;must&nbsp;happen&nbsp;after&nbsp;the&nbsp;xadd,&nbsp;to&nbsp;avoid&nbsp;a&nbsp;missed&nbsp;wakeup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1691351">//&nbsp;(see&nbsp;loop&nbsp;in&nbsp;semacquire).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691381">if</span>&nbsp;<span class="ident" id="1691384">atomicload</span><span class="op" id="1691394">(</span><span class="op" id="1691395">&amp;</span><span class="ident" id="1691396">root</span><span class="op" id="1691400">.</span><span class="ident" id="1691401">nwait</span><span class="op" id="1691406">)</span>&nbsp;<span class="op" id="1691408">==</span>&nbsp;<span class="num" id="1691411">0</span>&nbsp;<span class="op" id="1691413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691417">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691425">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1691429">//&nbsp;Harder&nbsp;case:&nbsp;search&nbsp;for&nbsp;a&nbsp;waiter&nbsp;and&nbsp;wake&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691479">lock</span><span class="op" id="1691483">(</span><span class="op" id="1691484">&amp;</span><span class="ident" id="1691485">root</span><span class="op" id="1691489">.</span><span class="ident" id="1691490">lock</span><span class="op" id="1691494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691497">if</span>&nbsp;<span class="ident" id="1691500">atomicload</span><span class="op" id="1691510">(</span><span class="op" id="1691511">&amp;</span><span class="ident" id="1691512">root</span><span class="op" id="1691516">.</span><span class="ident" id="1691517">nwait</span><span class="op" id="1691522">)</span>&nbsp;<span class="op" id="1691524">==</span>&nbsp;<span class="num" id="1691527">0</span>&nbsp;<span class="op" id="1691529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1691533">//&nbsp;The&nbsp;count&nbsp;is&nbsp;already&nbsp;consumed&nbsp;by&nbsp;another&nbsp;goroutine,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1691590">//&nbsp;so&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;up&nbsp;another&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691636">unlock</span><span class="op" id="1691642">(</span><span class="op" id="1691643">&amp;</span><span class="ident" id="1691644">root</span><span class="op" id="1691648">.</span><span class="ident" id="1691649">lock</span><span class="op" id="1691653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691657">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691668">s</span>&nbsp;<span class="op" id="1691670">:=</span>&nbsp;<span class="ident" id="1691673">root</span><span class="op" id="1691677">.</span><span class="ident" id="1691678">head</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691684">for</span>&nbsp;<span class="op" id="1691688">;</span>&nbsp;<span class="ident" id="1691690">s</span>&nbsp;<span class="op" id="1691692">!=</span>&nbsp;<span class="ident" id="1691695">nil</span><span class="op" id="1691698">;</span>&nbsp;<span class="ident" id="1691700">s</span>&nbsp;<span class="op" id="1691702">=</span>&nbsp;<span class="ident" id="1691704">s</span><span class="op" id="1691705">.</span><span class="ident" id="1691706">next</span>&nbsp;<span class="op" id="1691711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691715">if</span>&nbsp;<span class="ident" id="1691718">s</span><span class="op" id="1691719">.</span><span class="ident" id="1691720">elem</span>&nbsp;<span class="op" id="1691725">==</span>&nbsp;<span class="ident" id="1691728">unsafe</span><span class="op" id="1691734">.</span><span class="ident" id="1691735">Pointer</span><span class="op" id="1691742">(</span><span class="ident" id="1691743">addr</span><span class="op" id="1691747">)</span>&nbsp;<span class="op" id="1691749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691754">xadd</span><span class="op" id="1691758">(</span><span class="op" id="1691759">&amp;</span><span class="ident" id="1691760">root</span><span class="op" id="1691764">.</span><span class="ident" id="1691765">nwait</span><span class="op" id="1691770">,</span>&nbsp;<span class="op" id="1691772">-</span><span class="num" id="1691773">1</span><span class="op" id="1691774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691779">root</span><span class="op" id="1691783">.</span><span class="ident" id="1691784">dequeue</span><span class="op" id="1691791">(</span><span class="ident" id="1691792">s</span><span class="op" id="1691793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691798">break</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691812">unlock</span><span class="op" id="1691818">(</span><span class="op" id="1691819">&amp;</span><span class="ident" id="1691820">root</span><span class="op" id="1691824">.</span><span class="ident" id="1691825">lock</span><span class="op" id="1691829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691832">if</span>&nbsp;<span class="ident" id="1691835">s</span>&nbsp;<span class="op" id="1691837">!=</span>&nbsp;<span class="ident" id="1691840">nil</span>&nbsp;<span class="op" id="1691844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691848">if</span>&nbsp;<span class="ident" id="1691851">s</span><span class="op" id="1691852">.</span><span class="ident" id="1691853">releasetime</span>&nbsp;<span class="op" id="1691865">!=</span>&nbsp;<span class="num" id="1691868">0</span>&nbsp;<span class="op" id="1691870">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691875">s</span><span class="op" id="1691876">.</span><span class="ident" id="1691877">releasetime</span>&nbsp;<span class="op" id="1691889">=</span>&nbsp;<span class="ident" id="1691891">cputicks</span><span class="op" id="1691899">(</span><span class="op" id="1691900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691908">goready</span><span class="op" id="1691915">(</span><span class="ident" id="1691916">s</span><span class="op" id="1691917">.</span><span class="ident" id="1691918">g</span><span class="op" id="1691919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691922">}</span><br>
<span class="lineno"></span><span class="op" id="1691924">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="1691927">func</span>&nbsp;<span class="ident" id="1691932">semroot</span><span class="op" id="1691939">(</span><span class="ident" id="1691940">addr</span>&nbsp;<span class="op" id="1691945">*</span><span class="builtintype" id="1691946">uint32</span><span class="op" id="1691952">)</span>&nbsp;<span class="op" id="1691954">*</span><span class="ident" id="1691955">semaRoot</span>&nbsp;<span class="op" id="1691964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691967">return</span>&nbsp;<span class="op" id="1691974">&amp;</span><span class="ident" id="1691975">semtable</span><span class="op" id="1691983">[</span><span class="op" id="1691984">(</span><span class="builtintype" id="1691985">uintptr</span><span class="op" id="1691992">(</span><span class="ident" id="1691993">unsafe</span><span class="op" id="1691999">.</span><span class="ident" id="1692000">Pointer</span><span class="op" id="1692007">(</span><span class="ident" id="1692008">addr</span><span class="op" id="1692012">)</span><span class="op" id="1692013">)</span><span class="op" id="1692014">&gt;&gt;</span><span class="num" id="1692016">3</span><span class="op" id="1692017">)</span><span class="op" id="1692018">%</span><span class="ident" id="1692019">semTabSize</span><span class="op" id="1692029">]</span><span class="op" id="1692030">.</span><span class="ident" id="1692031">root</span><br>
<span class="lineno"></span><span class="op" id="1692036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="1692039">func</span>&nbsp;<span class="ident" id="1692044">cansemacquire</span><span class="op" id="1692057">(</span><span class="ident" id="1692058">addr</span>&nbsp;<span class="op" id="1692063">*</span><span class="builtintype" id="1692064">uint32</span><span class="op" id="1692070">)</span>&nbsp;<span class="builtintype" id="1692072">bool</span>&nbsp;<span class="op" id="1692077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692080">for</span>&nbsp;<span class="op" id="1692084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692088">v</span>&nbsp;<span class="op" id="1692090">:=</span>&nbsp;<span class="ident" id="1692093">atomicload</span><span class="op" id="1692103">(</span><span class="ident" id="1692104">addr</span><span class="op" id="1692108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692112">if</span>&nbsp;<span class="ident" id="1692115">v</span>&nbsp;<span class="op" id="1692117">==</span>&nbsp;<span class="num" id="1692120">0</span>&nbsp;<span class="op" id="1692122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692127">return</span>&nbsp;<span class="ident" id="1692134">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692146">if</span>&nbsp;<span class="ident" id="1692149">cas</span><span class="op" id="1692152">(</span><span class="ident" id="1692153">addr</span><span class="op" id="1692157">,</span>&nbsp;<span class="ident" id="1692159">v</span><span class="op" id="1692160">,</span>&nbsp;<span class="ident" id="1692162">v</span><span class="op" id="1692163">-</span><span class="num" id="1692164">1</span><span class="op" id="1692165">)</span>&nbsp;<span class="op" id="1692167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692172">return</span>&nbsp;<span class="ident" id="1692179">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692189">}</span><br>
<span class="lineno">150</span><span class="op" id="1692191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1692194">func</span>&nbsp;<span class="op" id="1692199">(</span><span class="ident" id="1692200">root</span>&nbsp;<span class="op" id="1692205">*</span><span class="ident" id="1692206">semaRoot</span><span class="op" id="1692214">)</span>&nbsp;<span class="ident" id="1692216">queue</span><span class="op" id="1692221">(</span><span class="ident" id="1692222">addr</span>&nbsp;<span class="op" id="1692227">*</span><span class="builtintype" id="1692228">uint32</span><span class="op" id="1692234">,</span>&nbsp;<span class="ident" id="1692236">s</span>&nbsp;<span class="op" id="1692238">*</span><span class="ident" id="1692239">sudog</span><span class="op" id="1692244">)</span>&nbsp;<span class="op" id="1692246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692249">s</span><span class="op" id="1692250">.</span><span class="ident" id="1692251">g</span>&nbsp;<span class="op" id="1692253">=</span>&nbsp;<span class="ident" id="1692255">getg</span><span class="op" id="1692259">(</span><span class="op" id="1692260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692263">s</span><span class="op" id="1692264">.</span><span class="ident" id="1692265">elem</span>&nbsp;<span class="op" id="1692270">=</span>&nbsp;<span class="ident" id="1692272">unsafe</span><span class="op" id="1692278">.</span><span class="ident" id="1692279">Pointer</span><span class="op" id="1692286">(</span><span class="ident" id="1692287">addr</span><span class="op" id="1692291">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692294">s</span><span class="op" id="1692295">.</span><span class="ident" id="1692296">next</span>&nbsp;<span class="op" id="1692301">=</span>&nbsp;<span class="ident" id="1692303">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692308">s</span><span class="op" id="1692309">.</span><span class="ident" id="1692310">prev</span>&nbsp;<span class="op" id="1692315">=</span>&nbsp;<span class="ident" id="1692317">root</span><span class="op" id="1692321">.</span><span class="ident" id="1692322">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692328">if</span>&nbsp;<span class="ident" id="1692331">root</span><span class="op" id="1692335">.</span><span class="ident" id="1692336">tail</span>&nbsp;<span class="op" id="1692341">!=</span>&nbsp;<span class="ident" id="1692344">nil</span>&nbsp;<span class="op" id="1692348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692352">root</span><span class="op" id="1692356">.</span><span class="ident" id="1692357">tail</span><span class="op" id="1692361">.</span><span class="ident" id="1692362">next</span>&nbsp;<span class="op" id="1692367">=</span>&nbsp;<span class="ident" id="1692369">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692372">}</span>&nbsp;<span class="keyword" id="1692374">else</span>&nbsp;<span class="op" id="1692379">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692383">root</span><span class="op" id="1692387">.</span><span class="ident" id="1692388">head</span>&nbsp;<span class="op" id="1692393">=</span>&nbsp;<span class="ident" id="1692395">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692401">root</span><span class="op" id="1692405">.</span><span class="ident" id="1692406">tail</span>&nbsp;<span class="op" id="1692411">=</span>&nbsp;<span class="ident" id="1692413">s</span><br>
<span class="lineno"></span><span class="op" id="1692415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="1692418">func</span>&nbsp;<span class="op" id="1692423">(</span><span class="ident" id="1692424">root</span>&nbsp;<span class="op" id="1692429">*</span><span class="ident" id="1692430">semaRoot</span><span class="op" id="1692438">)</span>&nbsp;<span class="ident" id="1692440">dequeue</span><span class="op" id="1692447">(</span><span class="ident" id="1692448">s</span>&nbsp;<span class="op" id="1692450">*</span><span class="ident" id="1692451">sudog</span><span class="op" id="1692456">)</span>&nbsp;<span class="op" id="1692458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692461">if</span>&nbsp;<span class="ident" id="1692464">s</span><span class="op" id="1692465">.</span><span class="ident" id="1692466">next</span>&nbsp;<span class="op" id="1692471">!=</span>&nbsp;<span class="ident" id="1692474">nil</span>&nbsp;<span class="op" id="1692478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692482">s</span><span class="op" id="1692483">.</span><span class="ident" id="1692484">next</span><span class="op" id="1692488">.</span><span class="ident" id="1692489">prev</span>&nbsp;<span class="op" id="1692494">=</span>&nbsp;<span class="ident" id="1692496">s</span><span class="op" id="1692497">.</span><span class="ident" id="1692498">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692504">}</span>&nbsp;<span class="keyword" id="1692506">else</span>&nbsp;<span class="op" id="1692511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692515">root</span><span class="op" id="1692519">.</span><span class="ident" id="1692520">tail</span>&nbsp;<span class="op" id="1692525">=</span>&nbsp;<span class="ident" id="1692527">s</span><span class="op" id="1692528">.</span><span class="ident" id="1692529">prev</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692538">if</span>&nbsp;<span class="ident" id="1692541">s</span><span class="op" id="1692542">.</span><span class="ident" id="1692543">prev</span>&nbsp;<span class="op" id="1692548">!=</span>&nbsp;<span class="ident" id="1692551">nil</span>&nbsp;<span class="op" id="1692555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692559">s</span><span class="op" id="1692560">.</span><span class="ident" id="1692561">prev</span><span class="op" id="1692565">.</span><span class="ident" id="1692566">next</span>&nbsp;<span class="op" id="1692571">=</span>&nbsp;<span class="ident" id="1692573">s</span><span class="op" id="1692574">.</span><span class="ident" id="1692575">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692581">}</span>&nbsp;<span class="keyword" id="1692583">else</span>&nbsp;<span class="op" id="1692588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692592">root</span><span class="op" id="1692596">.</span><span class="ident" id="1692597">head</span>&nbsp;<span class="op" id="1692602">=</span>&nbsp;<span class="ident" id="1692604">s</span><span class="op" id="1692605">.</span><span class="ident" id="1692606">next</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692615">s</span><span class="op" id="1692616">.</span><span class="ident" id="1692617">elem</span>&nbsp;<span class="op" id="1692622">=</span>&nbsp;<span class="ident" id="1692624">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692629">s</span><span class="op" id="1692630">.</span><span class="ident" id="1692631">next</span>&nbsp;<span class="op" id="1692636">=</span>&nbsp;<span class="ident" id="1692638">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692643">s</span><span class="op" id="1692644">.</span><span class="ident" id="1692645">prev</span>&nbsp;<span class="op" id="1692650">=</span>&nbsp;<span class="ident" id="1692652">nil</span><br>
<span class="lineno"></span><span class="op" id="1692656">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="1692659">//&nbsp;Synchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Cond.</span><br>
<span class="lineno"></span><span class="keyword" id="1692699">type</span>&nbsp;<span class="ident" id="1692704">syncSema</span>&nbsp;<span class="keyword" id="1692713">struct</span>&nbsp;<span class="op" id="1692720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692723">lock</span>&nbsp;<span class="ident" id="1692728">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692735">head</span>&nbsp;<span class="op" id="1692740">*</span><span class="ident" id="1692741">sudog</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692748">tail</span>&nbsp;<span class="op" id="1692753">*</span><span class="ident" id="1692754">sudog</span><br>
<span class="lineno"></span><span class="op" id="1692760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1692763">//&nbsp;Syncsemacquire&nbsp;waits&nbsp;for&nbsp;a&nbsp;pairing&nbsp;syncsemrelease&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1692841">func</span>&nbsp;<span class="ident" id="1692846">syncsemacquire</span><span class="op" id="1692860">(</span><span class="ident" id="1692861">s</span>&nbsp;<span class="op" id="1692863">*</span><span class="ident" id="1692864">syncSema</span><span class="op" id="1692872">)</span>&nbsp;<span class="op" id="1692874">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692877">lock</span><span class="op" id="1692881">(</span><span class="op" id="1692882">&amp;</span><span class="ident" id="1692883">s</span><span class="op" id="1692884">.</span><span class="ident" id="1692885">lock</span><span class="op" id="1692889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692892">if</span>&nbsp;<span class="ident" id="1692895">s</span><span class="op" id="1692896">.</span><span class="ident" id="1692897">head</span>&nbsp;<span class="op" id="1692902">!=</span>&nbsp;<span class="ident" id="1692905">nil</span>&nbsp;<span class="op" id="1692909">&amp;&amp;</span>&nbsp;<span class="ident" id="1692912">s</span><span class="op" id="1692913">.</span><span class="ident" id="1692914">head</span><span class="op" id="1692918">.</span><span class="ident" id="1692919">nrelease</span>&nbsp;<span class="op" id="1692928">&gt;</span>&nbsp;<span class="num" id="1692930">0</span>&nbsp;<span class="op" id="1692932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692936">//&nbsp;Have&nbsp;pending&nbsp;release,&nbsp;consume&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692975">var</span>&nbsp;<span class="ident" id="1692979">wake</span>&nbsp;<span class="op" id="1692984">*</span><span class="ident" id="1692985">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692993">s</span><span class="op" id="1692994">.</span><span class="ident" id="1692995">head</span><span class="op" id="1692999">.</span><span class="ident" id="1693000">nrelease</span><span class="op" id="1693008">--</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693013">if</span>&nbsp;<span class="ident" id="1693016">s</span><span class="op" id="1693017">.</span><span class="ident" id="1693018">head</span><span class="op" id="1693022">.</span><span class="ident" id="1693023">nrelease</span>&nbsp;<span class="op" id="1693032">==</span>&nbsp;<span class="num" id="1693035">0</span>&nbsp;<span class="op" id="1693037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693042">wake</span>&nbsp;<span class="op" id="1693047">=</span>&nbsp;<span class="ident" id="1693049">s</span><span class="op" id="1693050">.</span><span class="ident" id="1693051">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693059">s</span><span class="op" id="1693060">.</span><span class="ident" id="1693061">head</span>&nbsp;<span class="op" id="1693066">=</span>&nbsp;<span class="ident" id="1693068">wake</span><span class="op" id="1693072">.</span><span class="ident" id="1693073">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693081">if</span>&nbsp;<span class="ident" id="1693084">s</span><span class="op" id="1693085">.</span><span class="ident" id="1693086">head</span>&nbsp;<span class="op" id="1693091">==</span>&nbsp;<span class="ident" id="1693094">nil</span>&nbsp;<span class="op" id="1693098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693104">s</span><span class="op" id="1693105">.</span><span class="ident" id="1693106">tail</span>&nbsp;<span class="op" id="1693111">=</span>&nbsp;<span class="ident" id="1693113">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693128">unlock</span><span class="op" id="1693134">(</span><span class="op" id="1693135">&amp;</span><span class="ident" id="1693136">s</span><span class="op" id="1693137">.</span><span class="ident" id="1693138">lock</span><span class="op" id="1693142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693146">if</span>&nbsp;<span class="ident" id="1693149">wake</span>&nbsp;<span class="op" id="1693154">!=</span>&nbsp;<span class="ident" id="1693157">nil</span>&nbsp;<span class="op" id="1693161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693166">wake</span><span class="op" id="1693170">.</span><span class="ident" id="1693171">next</span>&nbsp;<span class="op" id="1693176">=</span>&nbsp;<span class="ident" id="1693178">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693185">goready</span><span class="op" id="1693192">(</span><span class="ident" id="1693193">wake</span><span class="op" id="1693197">.</span><span class="ident" id="1693198">g</span><span class="op" id="1693199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693206">}</span>&nbsp;<span class="keyword" id="1693208">else</span>&nbsp;<span class="op" id="1693213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1693217">//&nbsp;Enqueue&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693238">w</span>&nbsp;<span class="op" id="1693240">:=</span>&nbsp;<span class="ident" id="1693243">acquireSudog</span><span class="op" id="1693255">(</span><span class="op" id="1693256">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693260">w</span><span class="op" id="1693261">.</span><span class="ident" id="1693262">g</span>&nbsp;<span class="op" id="1693264">=</span>&nbsp;<span class="ident" id="1693266">getg</span><span class="op" id="1693270">(</span><span class="op" id="1693271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693275">w</span><span class="op" id="1693276">.</span><span class="ident" id="1693277">nrelease</span>&nbsp;<span class="op" id="1693286">=</span>&nbsp;<span class="op" id="1693288">-</span><span class="num" id="1693289">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693293">w</span><span class="op" id="1693294">.</span><span class="ident" id="1693295">next</span>&nbsp;<span class="op" id="1693300">=</span>&nbsp;<span class="ident" id="1693302">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693308">w</span><span class="op" id="1693309">.</span><span class="ident" id="1693310">releasetime</span>&nbsp;<span class="op" id="1693322">=</span>&nbsp;<span class="num" id="1693324">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693328">t0</span>&nbsp;<span class="op" id="1693331">:=</span>&nbsp;<span class="ident" id="1693334">int64</span><span class="op" id="1693339">(</span><span class="num" id="1693340">0</span><span class="op" id="1693341">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693345">if</span>&nbsp;<span class="ident" id="1693348">blockprofilerate</span>&nbsp;<span class="op" id="1693365">&gt;</span>&nbsp;<span class="num" id="1693367">0</span>&nbsp;<span class="op" id="1693369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693374">t0</span>&nbsp;<span class="op" id="1693377">=</span>&nbsp;<span class="ident" id="1693379">cputicks</span><span class="op" id="1693387">(</span><span class="op" id="1693388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693393">w</span><span class="op" id="1693394">.</span><span class="ident" id="1693395">releasetime</span>&nbsp;<span class="op" id="1693407">=</span>&nbsp;<span class="op" id="1693409">-</span><span class="num" id="1693410">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693418">if</span>&nbsp;<span class="ident" id="1693421">s</span><span class="op" id="1693422">.</span><span class="ident" id="1693423">tail</span>&nbsp;<span class="op" id="1693428">==</span>&nbsp;<span class="ident" id="1693431">nil</span>&nbsp;<span class="op" id="1693435">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693440">s</span><span class="op" id="1693441">.</span><span class="ident" id="1693442">head</span>&nbsp;<span class="op" id="1693447">=</span>&nbsp;<span class="ident" id="1693449">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693453">}</span>&nbsp;<span class="keyword" id="1693455">else</span>&nbsp;<span class="op" id="1693460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693465">s</span><span class="op" id="1693466">.</span><span class="ident" id="1693467">tail</span><span class="op" id="1693471">.</span><span class="ident" id="1693472">next</span>&nbsp;<span class="op" id="1693477">=</span>&nbsp;<span class="ident" id="1693479">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693487">s</span><span class="op" id="1693488">.</span><span class="ident" id="1693489">tail</span>&nbsp;<span class="op" id="1693494">=</span>&nbsp;<span class="ident" id="1693496">w</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693500">goparkunlock</span><span class="op" id="1693512">(</span><span class="op" id="1693513">&amp;</span><span class="ident" id="1693514">s</span><span class="op" id="1693515">.</span><span class="ident" id="1693516">lock</span><span class="op" id="1693520">,</span>&nbsp;<span class="string" id="1693522">&#34;semacquire&#34;</span><span class="op" id="1693534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693538">if</span>&nbsp;<span class="ident" id="1693541">t0</span>&nbsp;<span class="op" id="1693544">!=</span>&nbsp;<span class="num" id="1693547">0</span>&nbsp;<span class="op" id="1693549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693554">blockevent</span><span class="op" id="1693564">(</span><span class="ident" id="1693565">int64</span><span class="op" id="1693570">(</span><span class="ident" id="1693571">w</span><span class="op" id="1693572">.</span><span class="ident" id="1693573">releasetime</span><span class="op" id="1693584">)</span><span class="op" id="1693585">-</span><span class="ident" id="1693586">t0</span><span class="op" id="1693588">,</span>&nbsp;<span class="num" id="1693590">2</span><span class="op" id="1693591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693599">releaseSudog</span><span class="op" id="1693611">(</span><span class="ident" id="1693612">w</span><span class="op" id="1693613">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693616">}</span><br>
<span class="lineno"></span><span class="op" id="1693618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1693621">//&nbsp;Syncsemrelease&nbsp;waits&nbsp;for&nbsp;n&nbsp;pairing&nbsp;syncsemacquire&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1693699">func</span>&nbsp;<span class="ident" id="1693704">syncsemrelease</span><span class="op" id="1693718">(</span><span class="ident" id="1693719">s</span>&nbsp;<span class="op" id="1693721">*</span><span class="ident" id="1693722">syncSema</span><span class="op" id="1693730">,</span>&nbsp;<span class="ident" id="1693732">n</span>&nbsp;<span class="builtintype" id="1693734">uint32</span><span class="op" id="1693740">)</span>&nbsp;<span class="op" id="1693742">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693745">lock</span><span class="op" id="1693749">(</span><span class="op" id="1693750">&amp;</span><span class="ident" id="1693751">s</span><span class="op" id="1693752">.</span><span class="ident" id="1693753">lock</span><span class="op" id="1693757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693760">for</span>&nbsp;<span class="ident" id="1693764">n</span>&nbsp;<span class="op" id="1693766">&gt;</span>&nbsp;<span class="num" id="1693768">0</span>&nbsp;<span class="op" id="1693770">&amp;&amp;</span>&nbsp;<span class="ident" id="1693773">s</span><span class="op" id="1693774">.</span><span class="ident" id="1693775">head</span>&nbsp;<span class="op" id="1693780">!=</span>&nbsp;<span class="ident" id="1693783">nil</span>&nbsp;<span class="op" id="1693787">&amp;&amp;</span>&nbsp;<span class="ident" id="1693790">s</span><span class="op" id="1693791">.</span><span class="ident" id="1693792">head</span><span class="op" id="1693796">.</span><span class="ident" id="1693797">nrelease</span>&nbsp;<span class="op" id="1693806">&lt;</span>&nbsp;<span class="num" id="1693808">0</span>&nbsp;<span class="op" id="1693810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1693814">//&nbsp;Have&nbsp;pending&nbsp;acquire,&nbsp;satisfy&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693853">wake</span>&nbsp;<span class="op" id="1693858">:=</span>&nbsp;<span class="ident" id="1693861">s</span><span class="op" id="1693862">.</span><span class="ident" id="1693863">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693870">s</span><span class="op" id="1693871">.</span><span class="ident" id="1693872">head</span>&nbsp;<span class="op" id="1693877">=</span>&nbsp;<span class="ident" id="1693879">wake</span><span class="op" id="1693883">.</span><span class="ident" id="1693884">next</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693891">if</span>&nbsp;<span class="ident" id="1693894">s</span><span class="op" id="1693895">.</span><span class="ident" id="1693896">head</span>&nbsp;<span class="op" id="1693901">==</span>&nbsp;<span class="ident" id="1693904">nil</span>&nbsp;<span class="op" id="1693908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693913">s</span><span class="op" id="1693914">.</span><span class="ident" id="1693915">tail</span>&nbsp;<span class="op" id="1693920">=</span>&nbsp;<span class="ident" id="1693922">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693932">if</span>&nbsp;<span class="ident" id="1693935">wake</span><span class="op" id="1693939">.</span><span class="ident" id="1693940">releasetime</span>&nbsp;<span class="op" id="1693952">!=</span>&nbsp;<span class="num" id="1693955">0</span>&nbsp;<span class="op" id="1693957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693962">wake</span><span class="op" id="1693966">.</span><span class="ident" id="1693967">releasetime</span>&nbsp;<span class="op" id="1693979">=</span>&nbsp;<span class="ident" id="1693981">cputicks</span><span class="op" id="1693989">(</span><span class="op" id="1693990">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693998">wake</span><span class="op" id="1694002">.</span><span class="ident" id="1694003">next</span>&nbsp;<span class="op" id="1694008">=</span>&nbsp;<span class="ident" id="1694010">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694016">goready</span><span class="op" id="1694023">(</span><span class="ident" id="1694024">wake</span><span class="op" id="1694028">.</span><span class="ident" id="1694029">g</span><span class="op" id="1694030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694034">n</span><span class="op" id="1694035">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694039">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694042">if</span>&nbsp;<span class="ident" id="1694045">n</span>&nbsp;<span class="op" id="1694047">&gt;</span>&nbsp;<span class="num" id="1694049">0</span>&nbsp;<span class="op" id="1694051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1694055">//&nbsp;enqueue&nbsp;itself</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694075">w</span>&nbsp;<span class="op" id="1694077">:=</span>&nbsp;<span class="ident" id="1694080">acquireSudog</span><span class="op" id="1694092">(</span><span class="op" id="1694093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694097">w</span><span class="op" id="1694098">.</span><span class="ident" id="1694099">g</span>&nbsp;<span class="op" id="1694101">=</span>&nbsp;<span class="ident" id="1694103">getg</span><span class="op" id="1694107">(</span><span class="op" id="1694108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694112">w</span><span class="op" id="1694113">.</span><span class="ident" id="1694114">nrelease</span>&nbsp;<span class="op" id="1694123">=</span>&nbsp;<span class="builtintype" id="1694125">int32</span><span class="op" id="1694130">(</span><span class="ident" id="1694131">n</span><span class="op" id="1694132">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694136">w</span><span class="op" id="1694137">.</span><span class="ident" id="1694138">next</span>&nbsp;<span class="op" id="1694143">=</span>&nbsp;<span class="ident" id="1694145">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694151">w</span><span class="op" id="1694152">.</span><span class="ident" id="1694153">releasetime</span>&nbsp;<span class="op" id="1694165">=</span>&nbsp;<span class="num" id="1694167">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694171">if</span>&nbsp;<span class="ident" id="1694174">s</span><span class="op" id="1694175">.</span><span class="ident" id="1694176">tail</span>&nbsp;<span class="op" id="1694181">==</span>&nbsp;<span class="ident" id="1694184">nil</span>&nbsp;<span class="op" id="1694188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694193">s</span><span class="op" id="1694194">.</span><span class="ident" id="1694195">head</span>&nbsp;<span class="op" id="1694200">=</span>&nbsp;<span class="ident" id="1694202">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694206">}</span>&nbsp;<span class="keyword" id="1694208">else</span>&nbsp;<span class="op" id="1694213">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694218">s</span><span class="op" id="1694219">.</span><span class="ident" id="1694220">tail</span><span class="op" id="1694224">.</span><span class="ident" id="1694225">next</span>&nbsp;<span class="op" id="1694230">=</span>&nbsp;<span class="ident" id="1694232">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694240">s</span><span class="op" id="1694241">.</span><span class="ident" id="1694242">tail</span>&nbsp;<span class="op" id="1694247">=</span>&nbsp;<span class="ident" id="1694249">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694253">goparkunlock</span><span class="op" id="1694265">(</span><span class="op" id="1694266">&amp;</span><span class="ident" id="1694267">s</span><span class="op" id="1694268">.</span><span class="ident" id="1694269">lock</span><span class="op" id="1694273">,</span>&nbsp;<span class="string" id="1694275">&#34;semarelease&#34;</span><span class="op" id="1694288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694292">releaseSudog</span><span class="op" id="1694304">(</span><span class="ident" id="1694305">w</span><span class="op" id="1694306">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694309">}</span>&nbsp;<span class="keyword" id="1694311">else</span>&nbsp;<span class="op" id="1694316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694320">unlock</span><span class="op" id="1694326">(</span><span class="op" id="1694327">&amp;</span><span class="ident" id="1694328">s</span><span class="op" id="1694329">.</span><span class="ident" id="1694330">lock</span><span class="op" id="1694334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694337">}</span><br>
<span class="lineno"></span><span class="op" id="1694339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1694342">func</span>&nbsp;<span class="ident" id="1694347">syncsemcheck</span><span class="op" id="1694359">(</span><span class="ident" id="1694360">sz</span>&nbsp;<span class="builtintype" id="1694363">uintptr</span><span class="op" id="1694370">)</span>&nbsp;<span class="op" id="1694372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694375">if</span>&nbsp;<span class="ident" id="1694378">sz</span>&nbsp;<span class="op" id="1694381">!=</span>&nbsp;<span class="ident" id="1694384">unsafe</span><span class="op" id="1694390">.</span><span class="ident" id="1694391">Sizeof</span><span class="op" id="1694397">(</span><span class="ident" id="1694398">syncSema</span><span class="op" id="1694406">{</span><span class="op" id="1694407">}</span><span class="op" id="1694408">)</span>&nbsp;<span class="op" id="1694410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1694414">print</span><span class="op" id="1694419">(</span><span class="string" id="1694420">&#34;runtime:&nbsp;bad&nbsp;syncSema&nbsp;size&nbsp;-&nbsp;sync=&#34;</span><span class="op" id="1694456">,</span>&nbsp;<span class="ident" id="1694458">sz</span><span class="op" id="1694460">,</span>&nbsp;<span class="string" id="1694462">&#34;&nbsp;runtime=&#34;</span><span class="op" id="1694473">,</span>&nbsp;<span class="ident" id="1694475">unsafe</span><span class="op" id="1694481">.</span><span class="ident" id="1694482">Sizeof</span><span class="op" id="1694488">(</span><span class="ident" id="1694489">syncSema</span><span class="op" id="1694497">{</span><span class="op" id="1694498">}</span><span class="op" id="1694499">)</span><span class="op" id="1694500">,</span>&nbsp;<span class="string" id="1694502">&#34;\n&#34;</span><span class="op" id="1694506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694510">gothrow</span><span class="op" id="1694517">(</span><span class="string" id="1694518">&#34;bad&nbsp;syncSema&nbsp;size&#34;</span><span class="op" id="1694537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694540">}</span><br>
<span class="lineno">275</span><span class="op" id="1694542">}</span>
</div>
</body>
</html>
