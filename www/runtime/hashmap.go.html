<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1521015">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1521070">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1521124">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1521175">package</span>&nbsp;<span class="ident" id="1521183">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1521192">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&#39;s&nbsp;map&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="1521251">//</span><br>
<span class="lineno"></span><span class="comment" id="1521254">//&nbsp;A&nbsp;map&nbsp;is&nbsp;just&nbsp;a&nbsp;hash&nbsp;table.&nbsp;&nbsp;The&nbsp;data&nbsp;is&nbsp;arranged</span><br>
<span class="lineno">10</span><span class="comment" id="1521307">//&nbsp;into&nbsp;an&nbsp;array&nbsp;of&nbsp;buckets.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;up&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1521364">//&nbsp;8&nbsp;key/value&nbsp;pairs.&nbsp;&nbsp;The&nbsp;low-order&nbsp;bits&nbsp;of&nbsp;the&nbsp;hash&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="1521422">//&nbsp;used&nbsp;to&nbsp;select&nbsp;a&nbsp;bucket.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;a&nbsp;few</span><br>
<span class="lineno"></span><span class="comment" id="1521478">//&nbsp;high-order&nbsp;bits&nbsp;of&nbsp;each&nbsp;hash&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;entries</span><br>
<span class="lineno"></span><span class="comment" id="1521537">//&nbsp;within&nbsp;a&nbsp;single&nbsp;bucket.</span><br>
<span class="lineno">15</span><span class="comment" id="1521564">//</span><br>
<span class="lineno"></span><span class="comment" id="1521567">//&nbsp;If&nbsp;more&nbsp;than&nbsp;8&nbsp;keys&nbsp;hash&nbsp;to&nbsp;a&nbsp;bucket,&nbsp;we&nbsp;chain&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="1521620">//&nbsp;extra&nbsp;buckets.</span><br>
<span class="lineno"></span><span class="comment" id="1521638">//</span><br>
<span class="lineno"></span><span class="comment" id="1521641">//&nbsp;When&nbsp;the&nbsp;hashtable&nbsp;grows,&nbsp;we&nbsp;allocate&nbsp;a&nbsp;new&nbsp;array</span><br>
<span class="lineno">20</span><span class="comment" id="1521694">//&nbsp;of&nbsp;buckets&nbsp;twice&nbsp;as&nbsp;big.&nbsp;&nbsp;Buckets&nbsp;are&nbsp;incrementally</span><br>
<span class="lineno"></span><span class="comment" id="1521749">//&nbsp;copied&nbsp;from&nbsp;the&nbsp;old&nbsp;bucket&nbsp;array&nbsp;to&nbsp;the&nbsp;new&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span><span class="comment" id="1521810">//</span><br>
<span class="lineno"></span><span class="comment" id="1521813">//&nbsp;Map&nbsp;iterators&nbsp;walk&nbsp;through&nbsp;the&nbsp;array&nbsp;of&nbsp;buckets&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1521868">//&nbsp;return&nbsp;the&nbsp;keys&nbsp;in&nbsp;walk&nbsp;order&nbsp;(bucket&nbsp;#,&nbsp;then&nbsp;overflow</span><br>
<span class="lineno">25</span><span class="comment" id="1521926">//&nbsp;chain&nbsp;order,&nbsp;then&nbsp;bucket&nbsp;index).&nbsp;&nbsp;To&nbsp;maintain&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="1521985">//&nbsp;semantics,&nbsp;we&nbsp;never&nbsp;move&nbsp;keys&nbsp;within&nbsp;their&nbsp;bucket&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="1522042">//&nbsp;we&nbsp;did,&nbsp;keys&nbsp;might&nbsp;be&nbsp;returned&nbsp;0&nbsp;or&nbsp;2&nbsp;times).&nbsp;&nbsp;When</span><br>
<span class="lineno"></span><span class="comment" id="1522097">//&nbsp;growing&nbsp;the&nbsp;table,&nbsp;iterators&nbsp;remain&nbsp;iterating&nbsp;through&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1522158">//&nbsp;old&nbsp;table&nbsp;and&nbsp;must&nbsp;check&nbsp;the&nbsp;new&nbsp;table&nbsp;if&nbsp;the&nbsp;bucket</span><br>
<span class="lineno">30</span><span class="comment" id="1522214">//&nbsp;they&nbsp;are&nbsp;iterating&nbsp;through&nbsp;has&nbsp;been&nbsp;moved&nbsp;(&#34;evacuated&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="1522273">//&nbsp;to&nbsp;the&nbsp;new&nbsp;table.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1522295">//&nbsp;Picking&nbsp;loadFactor:&nbsp;too&nbsp;large&nbsp;and&nbsp;we&nbsp;have&nbsp;lots&nbsp;of&nbsp;overflow</span><br>
<span class="lineno"></span><span class="comment" id="1522357">//&nbsp;buckets,&nbsp;too&nbsp;small&nbsp;and&nbsp;we&nbsp;waste&nbsp;a&nbsp;lot&nbsp;of&nbsp;space.&nbsp;&nbsp;I&nbsp;wrote</span><br>
<span class="lineno">35</span><span class="comment" id="1522417">//&nbsp;a&nbsp;simple&nbsp;program&nbsp;to&nbsp;check&nbsp;some&nbsp;stats&nbsp;for&nbsp;different&nbsp;loads:</span><br>
<span class="lineno"></span><span class="comment" id="1522478">//&nbsp;(64-bit,&nbsp;8&nbsp;byte&nbsp;keys&nbsp;and&nbsp;values)</span><br>
<span class="lineno"></span><span class="comment" id="1522514">//&nbsp;&nbsp;loadFactor&nbsp;&nbsp;&nbsp;&nbsp;%overflow&nbsp;&nbsp;bytes/entry&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;missprobe</span><br>
<span class="lineno"></span><span class="comment" id="1522581">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00</span><br>
<span class="lineno"></span><span class="comment" id="1522648">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;17.30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50</span><br>
<span class="lineno">40</span><span class="comment" id="1522715">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;14.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00</span><br>
<span class="lineno"></span><span class="comment" id="1522782">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12.94&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50</span><br>
<span class="lineno"></span><span class="comment" id="1522849">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15.27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;11.67&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00</span><br>
<span class="lineno"></span><span class="comment" id="1522916">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50</span><br>
<span class="lineno"></span><span class="comment" id="1522983">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;27.14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00</span><br>
<span class="lineno">45</span><span class="comment" id="1523050">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;34.03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.73&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50</span><br>
<span class="lineno"></span><span class="comment" id="1523117">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;41.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00</span><br>
<span class="lineno"></span><span class="comment" id="1523184">//</span><br>
<span class="lineno"></span><span class="comment" id="1523187">//&nbsp;%overflow&nbsp;&nbsp;&nbsp;=&nbsp;percentage&nbsp;of&nbsp;buckets&nbsp;which&nbsp;have&nbsp;an&nbsp;overflow&nbsp;bucket</span><br>
<span class="lineno"></span><span class="comment" id="1523256">//&nbsp;bytes/entry&nbsp;=&nbsp;overhead&nbsp;bytes&nbsp;used&nbsp;per&nbsp;key/value&nbsp;pair</span><br>
<span class="lineno">50</span><span class="comment" id="1523312">//&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;a&nbsp;present&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1523381">//&nbsp;missprobe&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;an&nbsp;absent&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1523450">//</span><br>
<span class="lineno"></span><span class="comment" id="1523453">//&nbsp;Keep&nbsp;in&nbsp;mind&nbsp;this&nbsp;data&nbsp;is&nbsp;for&nbsp;maximally&nbsp;loaded&nbsp;tables,&nbsp;i.e.&nbsp;just</span><br>
<span class="lineno"></span><span class="comment" id="1523521">//&nbsp;before&nbsp;the&nbsp;table&nbsp;grows.&nbsp;&nbsp;Typical&nbsp;tables&nbsp;will&nbsp;be&nbsp;somewhat&nbsp;less&nbsp;loaded.</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="1523595">import</span>&nbsp;<span class="op" id="1523602">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1523605">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1523614">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="1523617">const</span>&nbsp;<span class="op" id="1523623">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523626">//&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;key/value&nbsp;pairs&nbsp;a&nbsp;bucket&nbsp;can&nbsp;hold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523683">bucketCntBits</span>&nbsp;<span class="op" id="1523697">=</span>&nbsp;<span class="num" id="1523699">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523702">bucketCnt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1523716">=</span>&nbsp;<span class="num" id="1523718">1</span>&nbsp;<span class="op" id="1523720">&lt;&lt;</span>&nbsp;<span class="ident" id="1523723">bucketCntBits</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523739">//&nbsp;Maximum&nbsp;average&nbsp;load&nbsp;of&nbsp;a&nbsp;bucket&nbsp;that&nbsp;triggers&nbsp;growth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523798">loadFactor</span>&nbsp;<span class="op" id="1523809">=</span>&nbsp;<span class="num" id="1523811">6.5</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523817">//&nbsp;Maximum&nbsp;key&nbsp;or&nbsp;value&nbsp;size&nbsp;to&nbsp;keep&nbsp;inline&nbsp;(instead&nbsp;of&nbsp;mallocing&nbsp;per&nbsp;element).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523898">//&nbsp;Must&nbsp;fit&nbsp;in&nbsp;a&nbsp;uint8.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523923">//&nbsp;Fast&nbsp;versions&nbsp;cannot&nbsp;handle&nbsp;big&nbsp;values&nbsp;-&nbsp;the&nbsp;cutoff&nbsp;size&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523988">//&nbsp;fast&nbsp;versions&nbsp;in&nbsp;../../cmd/gc/walk.c&nbsp;must&nbsp;be&nbsp;at&nbsp;most&nbsp;this&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524057">maxKeySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1524070">=</span>&nbsp;<span class="num" id="1524072">128</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524077">maxValueSize</span>&nbsp;<span class="op" id="1524090">=</span>&nbsp;<span class="num" id="1524092">128</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1524098">//&nbsp;data&nbsp;offset&nbsp;should&nbsp;be&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;bmap&nbsp;struct,&nbsp;but&nbsp;needs&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1524169">//&nbsp;aligned&nbsp;correctly.&nbsp;&nbsp;For&nbsp;amd64p32&nbsp;this&nbsp;means&nbsp;64-bit&nbsp;alignment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1524234">//&nbsp;even&nbsp;though&nbsp;pointers&nbsp;are&nbsp;32&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524271">dataOffset</span>&nbsp;<span class="op" id="1524282">=</span>&nbsp;<span class="ident" id="1524284">unsafe</span><span class="op" id="1524290">.</span><span class="ident" id="1524291">Offsetof</span><span class="op" id="1524299">(</span><span class="keyword" id="1524300">struct</span>&nbsp;<span class="op" id="1524307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524311">b</span>&nbsp;<span class="ident" id="1524313">bmap</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524320">v</span>&nbsp;<span class="ident" id="1524322">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1524329">}</span><span class="op" id="1524330">{</span><span class="op" id="1524331">}</span><span class="op" id="1524332">.</span><span class="ident" id="1524333">v</span><span class="op" id="1524334">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1524338">//&nbsp;Possible&nbsp;tophash&nbsp;values.&nbsp;&nbsp;We&nbsp;reserve&nbsp;a&nbsp;few&nbsp;possibilities&nbsp;for&nbsp;special&nbsp;marks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1524418">//&nbsp;Each&nbsp;bucket&nbsp;(including&nbsp;its&nbsp;overflow&nbsp;buckets,&nbsp;if&nbsp;any)&nbsp;will&nbsp;have&nbsp;either&nbsp;all&nbsp;or&nbsp;none&nbsp;of&nbsp;its</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1524511">//&nbsp;entries&nbsp;in&nbsp;the&nbsp;evacuated*&nbsp;states&nbsp;(except&nbsp;during&nbsp;the&nbsp;evacuate()&nbsp;method,&nbsp;which&nbsp;only&nbsp;happens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1524605">//&nbsp;during&nbsp;map&nbsp;writes&nbsp;and&nbsp;thus&nbsp;no&nbsp;one&nbsp;else&nbsp;can&nbsp;observe&nbsp;the&nbsp;map&nbsp;during&nbsp;that&nbsp;time).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524687">empty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524702">=</span>&nbsp;<span class="num" id="1524704">0</span>&nbsp;<span class="comment" id="1524706">//&nbsp;cell&nbsp;is&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524724">evacuatedEmpty</span>&nbsp;<span class="op" id="1524739">=</span>&nbsp;<span class="num" id="1524741">1</span>&nbsp;<span class="comment" id="1524743">//&nbsp;cell&nbsp;is&nbsp;empty,&nbsp;bucket&nbsp;is&nbsp;evacuated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524783">evacuatedX</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524798">=</span>&nbsp;<span class="num" id="1524800">2</span>&nbsp;<span class="comment" id="1524802">//&nbsp;key/value&nbsp;is&nbsp;valid.&nbsp;&nbsp;Entry&nbsp;has&nbsp;been&nbsp;evacuated&nbsp;to&nbsp;first&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524883">evacuatedY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524898">=</span>&nbsp;<span class="num" id="1524900">3</span>&nbsp;<span class="comment" id="1524902">//&nbsp;same&nbsp;as&nbsp;above,&nbsp;but&nbsp;evacuated&nbsp;to&nbsp;second&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524967">minTopHash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524982">=</span>&nbsp;<span class="num" id="1524984">4</span>&nbsp;<span class="comment" id="1524986">//&nbsp;minimum&nbsp;tophash&nbsp;for&nbsp;a&nbsp;normal&nbsp;filled&nbsp;cell.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1525033">//&nbsp;flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525043">iterator</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525055">=</span>&nbsp;<span class="num" id="1525057">1</span>&nbsp;<span class="comment" id="1525059">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;buckets</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525102">oldIterator</span>&nbsp;<span class="op" id="1525114">=</span>&nbsp;<span class="num" id="1525116">2</span>&nbsp;<span class="comment" id="1525118">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;oldbuckets</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1525165">//&nbsp;sentinel&nbsp;bucket&nbsp;ID&nbsp;for&nbsp;iterator&nbsp;checks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525208">noCheck</span>&nbsp;<span class="op" id="1525216">=</span>&nbsp;<span class="num" id="1525218">1</span><span class="op" id="1525219">&lt;&lt;</span><span class="op" id="1525221">(</span><span class="num" id="1525222">8</span><span class="op" id="1525223">*</span><span class="ident" id="1525224">ptrSize</span><span class="op" id="1525231">)</span>&nbsp;<span class="op" id="1525233">-</span>&nbsp;<span class="num" id="1525235">1</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1525239">//&nbsp;trigger&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;at&nbsp;every&nbsp;alloc&nbsp;called&nbsp;from&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525309">checkgc</span>&nbsp;<span class="op" id="1525317">=</span>&nbsp;<span class="ident" id="1525319">false</span><br>
<span class="lineno"></span><span class="op" id="1525325">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1525328">//&nbsp;A&nbsp;header&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno">105</span><span class="keyword" id="1525354">type</span>&nbsp;<span class="ident" id="1525359">hmap</span>&nbsp;<span class="keyword" id="1525364">struct</span>&nbsp;<span class="op" id="1525371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1525374">//&nbsp;Note:&nbsp;the&nbsp;format&nbsp;of&nbsp;the&nbsp;Hmap&nbsp;is&nbsp;encoded&nbsp;in&nbsp;../../cmd/gc/reflect.c&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1525448">//&nbsp;../reflect/type.go.&nbsp;&nbsp;Don&#39;t&nbsp;change&nbsp;this&nbsp;structure&nbsp;without&nbsp;also&nbsp;changing&nbsp;that&nbsp;code!</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525534">count</span>&nbsp;<span class="builtintype" id="1525540">int</span>&nbsp;<span class="comment" id="1525544">//&nbsp;#&nbsp;live&nbsp;cells&nbsp;==&nbsp;size&nbsp;of&nbsp;map.&nbsp;&nbsp;Must&nbsp;be&nbsp;first&nbsp;(used&nbsp;by&nbsp;len()&nbsp;builtin)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525616">flags</span>&nbsp;<span class="builtintype" id="1525622">uint32</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525630">hash0</span>&nbsp;<span class="builtintype" id="1525636">uint32</span>&nbsp;<span class="comment" id="1525643">//&nbsp;hash&nbsp;seed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525657">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1525663">uint8</span>&nbsp;&nbsp;<span class="comment" id="1525670">//&nbsp;log_2&nbsp;of&nbsp;#&nbsp;of&nbsp;buckets&nbsp;(can&nbsp;hold&nbsp;up&nbsp;to&nbsp;loadFactor&nbsp;*&nbsp;2^B&nbsp;items)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525737">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525748">unsafe</span><span class="op" id="1525754">.</span><span class="ident" id="1525755">Pointer</span>&nbsp;<span class="comment" id="1525763">//&nbsp;array&nbsp;of&nbsp;2^B&nbsp;Buckets.&nbsp;may&nbsp;be&nbsp;nil&nbsp;if&nbsp;count==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525813">oldbuckets</span>&nbsp;<span class="ident" id="1525824">unsafe</span><span class="op" id="1525830">.</span><span class="ident" id="1525831">Pointer</span>&nbsp;<span class="comment" id="1525839">//&nbsp;previous&nbsp;bucket&nbsp;array&nbsp;of&nbsp;half&nbsp;the&nbsp;size,&nbsp;non-nil&nbsp;only&nbsp;when&nbsp;growing</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525909">nevacuate</span>&nbsp;&nbsp;<span class="builtintype" id="1525920">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1525935">//&nbsp;progress&nbsp;counter&nbsp;for&nbsp;evacuation&nbsp;(buckets&nbsp;less&nbsp;than&nbsp;this&nbsp;have&nbsp;been&nbsp;evacuated)</span><br>
<span class="lineno"></span><span class="op" id="1526015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1526018">//&nbsp;A&nbsp;bucket&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="1526044">type</span>&nbsp;<span class="ident" id="1526049">bmap</span>&nbsp;<span class="keyword" id="1526054">struct</span>&nbsp;<span class="op" id="1526061">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526064">tophash</span>&nbsp;&nbsp;<span class="op" id="1526073">[</span><span class="ident" id="1526074">bucketCnt</span><span class="op" id="1526083">]</span><span class="builtintype" id="1526084">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526091">overflow</span>&nbsp;<span class="op" id="1526100">*</span><span class="ident" id="1526101">bmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526107">//&nbsp;Followed&nbsp;by&nbsp;bucketCnt&nbsp;keys&nbsp;and&nbsp;then&nbsp;bucketCnt&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526165">//&nbsp;NOTE:&nbsp;packing&nbsp;all&nbsp;the&nbsp;keys&nbsp;together&nbsp;and&nbsp;then&nbsp;all&nbsp;the&nbsp;values&nbsp;together&nbsp;makes&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526248">//&nbsp;code&nbsp;a&nbsp;bit&nbsp;more&nbsp;complicated&nbsp;than&nbsp;alternating&nbsp;key/value/key/value/...&nbsp;but&nbsp;it&nbsp;allows</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526335">//&nbsp;us&nbsp;to&nbsp;eliminate&nbsp;padding&nbsp;which&nbsp;would&nbsp;be&nbsp;needed&nbsp;for,&nbsp;e.g.,&nbsp;map[int64]int8.</span><br>
<span class="lineno"></span><span class="op" id="1526411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1526414">//&nbsp;A&nbsp;hash&nbsp;iteration&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="1526445">//&nbsp;If&nbsp;you&nbsp;modify&nbsp;hiter,&nbsp;also&nbsp;change&nbsp;cmd/gc/reflect.c&nbsp;to&nbsp;indicate</span><br>
<span class="lineno">130</span><span class="comment" id="1526510">//&nbsp;the&nbsp;layout&nbsp;of&nbsp;this&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="1526543">type</span>&nbsp;<span class="ident" id="1526548">hiter</span>&nbsp;<span class="keyword" id="1526554">struct</span>&nbsp;<span class="op" id="1526561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526564">key</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1526576">unsafe</span><span class="op" id="1526582">.</span><span class="ident" id="1526583">Pointer</span>&nbsp;<span class="comment" id="1526591">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;first&nbsp;position.&nbsp;&nbsp;Write&nbsp;nil&nbsp;to&nbsp;indicate&nbsp;iteration&nbsp;end&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526681">value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1526693">unsafe</span><span class="op" id="1526699">.</span><span class="ident" id="1526700">Pointer</span>&nbsp;<span class="comment" id="1526708">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;second&nbsp;position&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526761">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1526773">*</span><span class="ident" id="1526774">maptype</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526783">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1526795">*</span><span class="ident" id="1526796">hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526802">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1526814">unsafe</span><span class="op" id="1526820">.</span><span class="ident" id="1526821">Pointer</span>&nbsp;<span class="comment" id="1526829">//&nbsp;bucket&nbsp;ptr&nbsp;at&nbsp;hash_iter&nbsp;initialization&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526877">bptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1526889">*</span><span class="ident" id="1526890">bmap</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1526904">//&nbsp;current&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526923">startBucket</span>&nbsp;<span class="builtintype" id="1526935">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1526950">//&nbsp;bucket&nbsp;iteration&nbsp;started&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526982">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1526994">uint8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1527009">//&nbsp;intra-bucket&nbsp;offset&nbsp;to&nbsp;start&nbsp;from&nbsp;during&nbsp;iteration&nbsp;(should&nbsp;be&nbsp;big&nbsp;enough&nbsp;to&nbsp;hold&nbsp;bucketCnt-1)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527107">wrapped</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1527119">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1527134">//&nbsp;already&nbsp;wrapped&nbsp;around&nbsp;from&nbsp;end&nbsp;of&nbsp;bucket&nbsp;array&nbsp;to&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527199">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1527211">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527218">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1527230">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527237">bucket</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1527249">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527258">checkBucket</span>&nbsp;<span class="builtintype" id="1527270">uintptr</span><br>
<span class="lineno">145</span><span class="op" id="1527278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1527281">func</span>&nbsp;<span class="ident" id="1527286">evacuated</span><span class="op" id="1527295">(</span><span class="ident" id="1527296">b</span>&nbsp;<span class="op" id="1527298">*</span><span class="ident" id="1527299">bmap</span><span class="op" id="1527303">)</span>&nbsp;<span class="builtintype" id="1527305">bool</span>&nbsp;<span class="op" id="1527310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527313">h</span>&nbsp;<span class="op" id="1527315">:=</span>&nbsp;<span class="ident" id="1527318">b</span><span class="op" id="1527319">.</span><span class="ident" id="1527320">tophash</span><span class="op" id="1527327">[</span><span class="num" id="1527328">0</span><span class="op" id="1527329">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527332">return</span>&nbsp;<span class="ident" id="1527339">h</span>&nbsp;<span class="op" id="1527341">&gt;</span>&nbsp;<span class="ident" id="1527343">empty</span>&nbsp;<span class="op" id="1527349">&amp;&amp;</span>&nbsp;<span class="ident" id="1527352">h</span>&nbsp;<span class="op" id="1527354">&lt;</span>&nbsp;<span class="ident" id="1527356">minTopHash</span><br>
<span class="lineno">150</span><span class="op" id="1527367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1527370">func</span>&nbsp;<span class="ident" id="1527375">makemap</span><span class="op" id="1527382">(</span><span class="ident" id="1527383">t</span>&nbsp;<span class="op" id="1527385">*</span><span class="ident" id="1527386">maptype</span><span class="op" id="1527393">,</span>&nbsp;<span class="ident" id="1527395">hint</span>&nbsp;<span class="ident" id="1527400">int64</span><span class="op" id="1527405">)</span>&nbsp;<span class="op" id="1527407">*</span><span class="ident" id="1527408">hmap</span>&nbsp;<span class="op" id="1527413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527416">if</span>&nbsp;<span class="ident" id="1527419">sz</span>&nbsp;<span class="op" id="1527422">:=</span>&nbsp;<span class="ident" id="1527425">unsafe</span><span class="op" id="1527431">.</span><span class="ident" id="1527432">Sizeof</span><span class="op" id="1527438">(</span><span class="ident" id="1527439">hmap</span><span class="op" id="1527443">{</span><span class="op" id="1527444">}</span><span class="op" id="1527445">)</span><span class="op" id="1527446">;</span>&nbsp;<span class="ident" id="1527448">sz</span>&nbsp;<span class="op" id="1527451">&gt;</span>&nbsp;<span class="num" id="1527453">48</span>&nbsp;<span class="op" id="1527456">||</span>&nbsp;<span class="ident" id="1527459">sz</span>&nbsp;<span class="op" id="1527462">!=</span>&nbsp;<span class="builtintype" id="1527465">uintptr</span><span class="op" id="1527472">(</span><span class="ident" id="1527473">t</span><span class="op" id="1527474">.</span><span class="ident" id="1527475">hmap</span><span class="op" id="1527479">.</span><span class="ident" id="1527480">size</span><span class="op" id="1527484">)</span>&nbsp;<span class="op" id="1527486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527490">gothrow</span><span class="op" id="1527497">(</span><span class="string" id="1527498">&#34;bad&nbsp;hmap&nbsp;size&#34;</span><span class="op" id="1527513">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527520">if</span>&nbsp;<span class="ident" id="1527523">hint</span>&nbsp;<span class="op" id="1527528">&lt;</span>&nbsp;<span class="num" id="1527530">0</span>&nbsp;<span class="op" id="1527532">||</span>&nbsp;<span class="ident" id="1527535">int64</span><span class="op" id="1527540">(</span><span class="builtintype" id="1527541">int32</span><span class="op" id="1527546">(</span><span class="ident" id="1527547">hint</span><span class="op" id="1527551">)</span><span class="op" id="1527552">)</span>&nbsp;<span class="op" id="1527554">!=</span>&nbsp;<span class="ident" id="1527557">hint</span>&nbsp;<span class="op" id="1527562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1527566">panic</span><span class="op" id="1527571">(</span><span class="string" id="1527572">&#34;makemap:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1527600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527604">//&nbsp;TODO:&nbsp;make&nbsp;hint&nbsp;an&nbsp;int,&nbsp;then&nbsp;none&nbsp;of&nbsp;this&nbsp;nonsense</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527663">if</span>&nbsp;<span class="op" id="1527666">!</span><span class="ident" id="1527667">ismapkey</span><span class="op" id="1527675">(</span><span class="ident" id="1527676">t</span><span class="op" id="1527677">.</span><span class="ident" id="1527678">key</span><span class="op" id="1527681">)</span>&nbsp;<span class="op" id="1527683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527687">gothrow</span><span class="op" id="1527694">(</span><span class="string" id="1527695">&#34;runtime.makemap:&nbsp;unsupported&nbsp;map&nbsp;key&nbsp;type&#34;</span><span class="op" id="1527738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527741">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527745">//&nbsp;check&nbsp;compiler&#39;s&nbsp;and&nbsp;reflect&#39;s&nbsp;math</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527785">if</span>&nbsp;<span class="ident" id="1527788">t</span><span class="op" id="1527789">.</span><span class="ident" id="1527790">key</span><span class="op" id="1527793">.</span><span class="ident" id="1527794">size</span>&nbsp;<span class="op" id="1527799">&gt;</span>&nbsp;<span class="ident" id="1527801">maxKeySize</span>&nbsp;<span class="op" id="1527812">&amp;&amp;</span>&nbsp;<span class="op" id="1527815">(</span><span class="op" id="1527816">!</span><span class="ident" id="1527817">t</span><span class="op" id="1527818">.</span><span class="ident" id="1527819">indirectkey</span>&nbsp;<span class="op" id="1527831">||</span>&nbsp;<span class="ident" id="1527834">t</span><span class="op" id="1527835">.</span><span class="ident" id="1527836">keysize</span>&nbsp;<span class="op" id="1527844">!=</span>&nbsp;<span class="builtintype" id="1527847">uint8</span><span class="op" id="1527852">(</span><span class="ident" id="1527853">ptrSize</span><span class="op" id="1527860">)</span><span class="op" id="1527861">)</span>&nbsp;<span class="op" id="1527863">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527868">t</span><span class="op" id="1527869">.</span><span class="ident" id="1527870">key</span><span class="op" id="1527873">.</span><span class="ident" id="1527874">size</span>&nbsp;<span class="op" id="1527879">&lt;=</span>&nbsp;<span class="ident" id="1527882">maxKeySize</span>&nbsp;<span class="op" id="1527893">&amp;&amp;</span>&nbsp;<span class="op" id="1527896">(</span><span class="ident" id="1527897">t</span><span class="op" id="1527898">.</span><span class="ident" id="1527899">indirectkey</span>&nbsp;<span class="op" id="1527911">||</span>&nbsp;<span class="ident" id="1527914">t</span><span class="op" id="1527915">.</span><span class="ident" id="1527916">keysize</span>&nbsp;<span class="op" id="1527924">!=</span>&nbsp;<span class="builtintype" id="1527927">uint8</span><span class="op" id="1527932">(</span><span class="ident" id="1527933">t</span><span class="op" id="1527934">.</span><span class="ident" id="1527935">key</span><span class="op" id="1527938">.</span><span class="ident" id="1527939">size</span><span class="op" id="1527943">)</span><span class="op" id="1527944">)</span>&nbsp;<span class="op" id="1527946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527950">gothrow</span><span class="op" id="1527957">(</span><span class="string" id="1527958">&#34;key&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1527974">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527980">if</span>&nbsp;<span class="ident" id="1527983">t</span><span class="op" id="1527984">.</span><span class="ident" id="1527985">elem</span><span class="op" id="1527989">.</span><span class="ident" id="1527990">size</span>&nbsp;<span class="op" id="1527995">&gt;</span>&nbsp;<span class="ident" id="1527997">maxValueSize</span>&nbsp;<span class="op" id="1528010">&amp;&amp;</span>&nbsp;<span class="op" id="1528013">(</span><span class="op" id="1528014">!</span><span class="ident" id="1528015">t</span><span class="op" id="1528016">.</span><span class="ident" id="1528017">indirectvalue</span>&nbsp;<span class="op" id="1528031">||</span>&nbsp;<span class="ident" id="1528034">t</span><span class="op" id="1528035">.</span><span class="ident" id="1528036">valuesize</span>&nbsp;<span class="op" id="1528046">!=</span>&nbsp;<span class="builtintype" id="1528049">uint8</span><span class="op" id="1528054">(</span><span class="ident" id="1528055">ptrSize</span><span class="op" id="1528062">)</span><span class="op" id="1528063">)</span>&nbsp;<span class="op" id="1528065">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528070">t</span><span class="op" id="1528071">.</span><span class="ident" id="1528072">elem</span><span class="op" id="1528076">.</span><span class="ident" id="1528077">size</span>&nbsp;<span class="op" id="1528082">&lt;=</span>&nbsp;<span class="ident" id="1528085">maxValueSize</span>&nbsp;<span class="op" id="1528098">&amp;&amp;</span>&nbsp;<span class="op" id="1528101">(</span><span class="ident" id="1528102">t</span><span class="op" id="1528103">.</span><span class="ident" id="1528104">indirectvalue</span>&nbsp;<span class="op" id="1528118">||</span>&nbsp;<span class="ident" id="1528121">t</span><span class="op" id="1528122">.</span><span class="ident" id="1528123">valuesize</span>&nbsp;<span class="op" id="1528133">!=</span>&nbsp;<span class="builtintype" id="1528136">uint8</span><span class="op" id="1528141">(</span><span class="ident" id="1528142">t</span><span class="op" id="1528143">.</span><span class="ident" id="1528144">elem</span><span class="op" id="1528148">.</span><span class="ident" id="1528149">size</span><span class="op" id="1528153">)</span><span class="op" id="1528154">)</span>&nbsp;<span class="op" id="1528156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528160">gothrow</span><span class="op" id="1528167">(</span><span class="string" id="1528168">&#34;value&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1528186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528189">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1528193">//&nbsp;invariants&nbsp;we&nbsp;depend&nbsp;on.&nbsp;&nbsp;We&nbsp;should&nbsp;probably&nbsp;check&nbsp;these&nbsp;at&nbsp;compile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1528270">//&nbsp;somewhere,&nbsp;but&nbsp;for&nbsp;now&nbsp;we&#39;ll&nbsp;do&nbsp;it&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528315">if</span>&nbsp;<span class="ident" id="1528318">t</span><span class="op" id="1528319">.</span><span class="ident" id="1528320">key</span><span class="op" id="1528323">.</span><span class="ident" id="1528324">align</span>&nbsp;<span class="op" id="1528330">&gt;</span>&nbsp;<span class="ident" id="1528332">bucketCnt</span>&nbsp;<span class="op" id="1528342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528346">gothrow</span><span class="op" id="1528353">(</span><span class="string" id="1528354">&#34;key&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1528373">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528379">if</span>&nbsp;<span class="ident" id="1528382">t</span><span class="op" id="1528383">.</span><span class="ident" id="1528384">elem</span><span class="op" id="1528388">.</span><span class="ident" id="1528389">align</span>&nbsp;<span class="op" id="1528395">&gt;</span>&nbsp;<span class="ident" id="1528397">bucketCnt</span>&nbsp;<span class="op" id="1528407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528411">gothrow</span><span class="op" id="1528418">(</span><span class="string" id="1528419">&#34;value&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1528440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528446">if</span>&nbsp;<span class="builtintype" id="1528449">uintptr</span><span class="op" id="1528456">(</span><span class="ident" id="1528457">t</span><span class="op" id="1528458">.</span><span class="ident" id="1528459">key</span><span class="op" id="1528462">.</span><span class="ident" id="1528463">size</span><span class="op" id="1528467">)</span><span class="op" id="1528468">%</span><span class="builtintype" id="1528469">uintptr</span><span class="op" id="1528476">(</span><span class="ident" id="1528477">t</span><span class="op" id="1528478">.</span><span class="ident" id="1528479">key</span><span class="op" id="1528482">.</span><span class="ident" id="1528483">align</span><span class="op" id="1528488">)</span>&nbsp;<span class="op" id="1528490">!=</span>&nbsp;<span class="num" id="1528493">0</span>&nbsp;<span class="op" id="1528495">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528499">gothrow</span><span class="op" id="1528506">(</span><span class="string" id="1528507">&#34;key&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;key&nbsp;align&#34;</span><span class="op" id="1528545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528551">if</span>&nbsp;<span class="builtintype" id="1528554">uintptr</span><span class="op" id="1528561">(</span><span class="ident" id="1528562">t</span><span class="op" id="1528563">.</span><span class="ident" id="1528564">elem</span><span class="op" id="1528568">.</span><span class="ident" id="1528569">size</span><span class="op" id="1528573">)</span><span class="op" id="1528574">%</span><span class="builtintype" id="1528575">uintptr</span><span class="op" id="1528582">(</span><span class="ident" id="1528583">t</span><span class="op" id="1528584">.</span><span class="ident" id="1528585">elem</span><span class="op" id="1528589">.</span><span class="ident" id="1528590">align</span><span class="op" id="1528595">)</span>&nbsp;<span class="op" id="1528597">!=</span>&nbsp;<span class="num" id="1528600">0</span>&nbsp;<span class="op" id="1528602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528606">gothrow</span><span class="op" id="1528613">(</span><span class="string" id="1528614">&#34;value&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;value&nbsp;align&#34;</span><span class="op" id="1528656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528659">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528662">if</span>&nbsp;<span class="ident" id="1528665">bucketCnt</span>&nbsp;<span class="op" id="1528675">&lt;</span>&nbsp;<span class="num" id="1528677">8</span>&nbsp;<span class="op" id="1528679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528683">gothrow</span><span class="op" id="1528690">(</span><span class="string" id="1528691">&#34;bucketsize&nbsp;too&nbsp;small&nbsp;for&nbsp;proper&nbsp;alignment&#34;</span><span class="op" id="1528734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528740">if</span>&nbsp;<span class="ident" id="1528743">dataOffset</span><span class="op" id="1528753">%</span><span class="builtintype" id="1528754">uintptr</span><span class="op" id="1528761">(</span><span class="ident" id="1528762">t</span><span class="op" id="1528763">.</span><span class="ident" id="1528764">key</span><span class="op" id="1528767">.</span><span class="ident" id="1528768">align</span><span class="op" id="1528773">)</span>&nbsp;<span class="op" id="1528775">!=</span>&nbsp;<span class="num" id="1528778">0</span>&nbsp;<span class="op" id="1528780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528784">gothrow</span><span class="op" id="1528791">(</span><span class="string" id="1528792">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(key)&#34;</span><span class="op" id="1528822">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528828">if</span>&nbsp;<span class="ident" id="1528831">dataOffset</span><span class="op" id="1528841">%</span><span class="builtintype" id="1528842">uintptr</span><span class="op" id="1528849">(</span><span class="ident" id="1528850">t</span><span class="op" id="1528851">.</span><span class="ident" id="1528852">elem</span><span class="op" id="1528856">.</span><span class="ident" id="1528857">align</span><span class="op" id="1528862">)</span>&nbsp;<span class="op" id="1528864">!=</span>&nbsp;<span class="num" id="1528867">0</span>&nbsp;<span class="op" id="1528869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528873">gothrow</span><span class="op" id="1528880">(</span><span class="string" id="1528881">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(value)&#34;</span><span class="op" id="1528913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1528920">//&nbsp;find&nbsp;size&nbsp;parameter&nbsp;which&nbsp;will&nbsp;hold&nbsp;the&nbsp;requested&nbsp;#&nbsp;of&nbsp;elements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528988">B</span>&nbsp;<span class="op" id="1528990">:=</span>&nbsp;<span class="builtintype" id="1528993">uint8</span><span class="op" id="1528998">(</span><span class="num" id="1528999">0</span><span class="op" id="1529000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529003">for</span>&nbsp;<span class="op" id="1529007">;</span>&nbsp;<span class="ident" id="1529009">hint</span>&nbsp;<span class="op" id="1529014">&gt;</span>&nbsp;<span class="ident" id="1529016">bucketCnt</span>&nbsp;<span class="op" id="1529026">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1529029">float32</span><span class="op" id="1529036">(</span><span class="ident" id="1529037">hint</span><span class="op" id="1529041">)</span>&nbsp;<span class="op" id="1529043">&gt;</span>&nbsp;<span class="ident" id="1529045">loadFactor</span><span class="op" id="1529055">*</span><span class="builtintype" id="1529056">float32</span><span class="op" id="1529063">(</span><span class="builtintype" id="1529064">uintptr</span><span class="op" id="1529071">(</span><span class="num" id="1529072">1</span><span class="op" id="1529073">)</span><span class="op" id="1529074">&lt;&lt;</span><span class="ident" id="1529076">B</span><span class="op" id="1529077">)</span><span class="op" id="1529078">;</span>&nbsp;<span class="ident" id="1529080">B</span><span class="op" id="1529081">++</span>&nbsp;<span class="op" id="1529084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1529087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1529091">//&nbsp;allocate&nbsp;initial&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1529123">//&nbsp;if&nbsp;B&nbsp;==&nbsp;0,&nbsp;the&nbsp;buckets&nbsp;field&nbsp;is&nbsp;allocated&nbsp;lazily&nbsp;later&nbsp;(in&nbsp;mapassign)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1529197">//&nbsp;If&nbsp;hint&nbsp;is&nbsp;large&nbsp;zeroing&nbsp;this&nbsp;memory&nbsp;could&nbsp;take&nbsp;a&nbsp;while.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529258">var</span>&nbsp;<span class="ident" id="1529262">buckets</span>&nbsp;<span class="ident" id="1529270">unsafe</span><span class="op" id="1529276">.</span><span class="ident" id="1529277">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529286">if</span>&nbsp;<span class="ident" id="1529289">B</span>&nbsp;<span class="op" id="1529291">!=</span>&nbsp;<span class="num" id="1529294">0</span>&nbsp;<span class="op" id="1529296">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529300">if</span>&nbsp;<span class="ident" id="1529303">checkgc</span>&nbsp;<span class="op" id="1529311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529316">memstats</span><span class="op" id="1529324">.</span><span class="ident" id="1529325">next_gc</span>&nbsp;<span class="op" id="1529333">=</span>&nbsp;<span class="ident" id="1529335">memstats</span><span class="op" id="1529343">.</span><span class="ident" id="1529344">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1529357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529361">buckets</span>&nbsp;<span class="op" id="1529369">=</span>&nbsp;<span class="ident" id="1529371">newarray</span><span class="op" id="1529379">(</span><span class="ident" id="1529380">t</span><span class="op" id="1529381">.</span><span class="ident" id="1529382">bucket</span><span class="op" id="1529388">,</span>&nbsp;<span class="builtintype" id="1529390">uintptr</span><span class="op" id="1529397">(</span><span class="num" id="1529398">1</span><span class="op" id="1529399">)</span><span class="op" id="1529400">&lt;&lt;</span><span class="ident" id="1529402">B</span><span class="op" id="1529403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1529406">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1529410">//&nbsp;initialize&nbsp;Hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529430">if</span>&nbsp;<span class="ident" id="1529433">checkgc</span>&nbsp;<span class="op" id="1529441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529445">memstats</span><span class="op" id="1529453">.</span><span class="ident" id="1529454">next_gc</span>&nbsp;<span class="op" id="1529462">=</span>&nbsp;<span class="ident" id="1529464">memstats</span><span class="op" id="1529472">.</span><span class="ident" id="1529473">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1529485">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529488">h</span>&nbsp;<span class="op" id="1529490">:=</span>&nbsp;<span class="op" id="1529493">(</span><span class="op" id="1529494">*</span><span class="ident" id="1529495">hmap</span><span class="op" id="1529499">)</span><span class="op" id="1529500">(</span><span class="ident" id="1529501">newobject</span><span class="op" id="1529510">(</span><span class="ident" id="1529511">t</span><span class="op" id="1529512">.</span><span class="ident" id="1529513">hmap</span><span class="op" id="1529517">)</span><span class="op" id="1529518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529521">h</span><span class="op" id="1529522">.</span><span class="ident" id="1529523">count</span>&nbsp;<span class="op" id="1529529">=</span>&nbsp;<span class="num" id="1529531">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529534">h</span><span class="op" id="1529535">.</span><span class="ident" id="1529536">B</span>&nbsp;<span class="op" id="1529538">=</span>&nbsp;<span class="ident" id="1529540">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529543">h</span><span class="op" id="1529544">.</span><span class="ident" id="1529545">flags</span>&nbsp;<span class="op" id="1529551">=</span>&nbsp;<span class="num" id="1529553">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529556">h</span><span class="op" id="1529557">.</span><span class="ident" id="1529558">hash0</span>&nbsp;<span class="op" id="1529564">=</span>&nbsp;<span class="ident" id="1529566">fastrand1</span><span class="op" id="1529575">(</span><span class="op" id="1529576">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529579">h</span><span class="op" id="1529580">.</span><span class="ident" id="1529581">buckets</span>&nbsp;<span class="op" id="1529589">=</span>&nbsp;<span class="ident" id="1529591">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529600">h</span><span class="op" id="1529601">.</span><span class="ident" id="1529602">oldbuckets</span>&nbsp;<span class="op" id="1529613">=</span>&nbsp;<span class="ident" id="1529615">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529620">h</span><span class="op" id="1529621">.</span><span class="ident" id="1529622">nevacuate</span>&nbsp;<span class="op" id="1529632">=</span>&nbsp;<span class="num" id="1529634">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529638">return</span>&nbsp;<span class="ident" id="1529645">h</span><br>
<span class="lineno">230</span><span class="op" id="1529647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1529650">//&nbsp;mapaccess1&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;h[key].&nbsp;&nbsp;Never&nbsp;returns&nbsp;nil,&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1529721">//&nbsp;it&nbsp;will&nbsp;return&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;zero&nbsp;object&nbsp;for&nbsp;the&nbsp;value&nbsp;type&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="1529792">//&nbsp;the&nbsp;key&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">235</span><span class="comment" id="1529822">//&nbsp;NOTE:&nbsp;The&nbsp;returned&nbsp;pointer&nbsp;may&nbsp;keep&nbsp;the&nbsp;whole&nbsp;map&nbsp;live,&nbsp;so&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="1529890">//&nbsp;hold&nbsp;onto&nbsp;it&nbsp;for&nbsp;very&nbsp;long.</span><br>
<span class="lineno"></span><span class="keyword" id="1529921">func</span>&nbsp;<span class="ident" id="1529926">mapaccess1</span><span class="op" id="1529936">(</span><span class="ident" id="1529937">t</span>&nbsp;<span class="op" id="1529939">*</span><span class="ident" id="1529940">maptype</span><span class="op" id="1529947">,</span>&nbsp;<span class="ident" id="1529949">h</span>&nbsp;<span class="op" id="1529951">*</span><span class="ident" id="1529952">hmap</span><span class="op" id="1529956">,</span>&nbsp;<span class="ident" id="1529958">key</span>&nbsp;<span class="ident" id="1529962">unsafe</span><span class="op" id="1529968">.</span><span class="ident" id="1529969">Pointer</span><span class="op" id="1529976">)</span>&nbsp;<span class="ident" id="1529978">unsafe</span><span class="op" id="1529984">.</span><span class="ident" id="1529985">Pointer</span>&nbsp;<span class="op" id="1529993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529996">if</span>&nbsp;<span class="ident" id="1529999">raceenabled</span>&nbsp;<span class="op" id="1530011">&amp;&amp;</span>&nbsp;<span class="ident" id="1530014">h</span>&nbsp;<span class="op" id="1530016">!=</span>&nbsp;<span class="ident" id="1530019">nil</span>&nbsp;<span class="op" id="1530023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530027">callerpc</span>&nbsp;<span class="op" id="1530036">:=</span>&nbsp;<span class="ident" id="1530039">getcallerpc</span><span class="op" id="1530050">(</span><span class="ident" id="1530051">unsafe</span><span class="op" id="1530057">.</span><span class="ident" id="1530058">Pointer</span><span class="op" id="1530065">(</span><span class="op" id="1530066">&amp;</span><span class="ident" id="1530067">t</span><span class="op" id="1530068">)</span><span class="op" id="1530069">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530073">pc</span>&nbsp;<span class="op" id="1530076">:=</span>&nbsp;<span class="ident" id="1530079">funcPC</span><span class="op" id="1530085">(</span><span class="ident" id="1530086">mapaccess1</span><span class="op" id="1530096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530100">racereadpc</span><span class="op" id="1530110">(</span><span class="ident" id="1530111">unsafe</span><span class="op" id="1530117">.</span><span class="ident" id="1530118">Pointer</span><span class="op" id="1530125">(</span><span class="ident" id="1530126">h</span><span class="op" id="1530127">)</span><span class="op" id="1530128">,</span>&nbsp;<span class="ident" id="1530130">callerpc</span><span class="op" id="1530138">,</span>&nbsp;<span class="ident" id="1530140">pc</span><span class="op" id="1530142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530146">raceReadObjectPC</span><span class="op" id="1530162">(</span><span class="ident" id="1530163">t</span><span class="op" id="1530164">.</span><span class="ident" id="1530165">key</span><span class="op" id="1530168">,</span>&nbsp;<span class="ident" id="1530170">key</span><span class="op" id="1530173">,</span>&nbsp;<span class="ident" id="1530175">callerpc</span><span class="op" id="1530183">,</span>&nbsp;<span class="ident" id="1530185">pc</span><span class="op" id="1530187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530193">if</span>&nbsp;<span class="ident" id="1530196">h</span>&nbsp;<span class="op" id="1530198">==</span>&nbsp;<span class="ident" id="1530201">nil</span>&nbsp;<span class="op" id="1530205">||</span>&nbsp;<span class="ident" id="1530208">h</span><span class="op" id="1530209">.</span><span class="ident" id="1530210">count</span>&nbsp;<span class="op" id="1530216">==</span>&nbsp;<span class="num" id="1530219">0</span>&nbsp;<span class="op" id="1530221">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530225">return</span>&nbsp;<span class="ident" id="1530232">unsafe</span><span class="op" id="1530238">.</span><span class="ident" id="1530239">Pointer</span><span class="op" id="1530246">(</span><span class="ident" id="1530247">t</span><span class="op" id="1530248">.</span><span class="ident" id="1530249">elem</span><span class="op" id="1530253">.</span><span class="ident" id="1530254">zero</span><span class="op" id="1530258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530264">alg</span>&nbsp;<span class="op" id="1530268">:=</span>&nbsp;<span class="ident" id="1530271">goalg</span><span class="op" id="1530276">(</span><span class="ident" id="1530277">t</span><span class="op" id="1530278">.</span><span class="ident" id="1530279">key</span><span class="op" id="1530282">.</span><span class="ident" id="1530283">alg</span><span class="op" id="1530286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530289">hash</span>&nbsp;<span class="op" id="1530294">:=</span>&nbsp;<span class="ident" id="1530297">alg</span><span class="op" id="1530300">.</span><span class="ident" id="1530301">hash</span><span class="op" id="1530305">(</span><span class="ident" id="1530306">key</span><span class="op" id="1530309">,</span>&nbsp;<span class="builtintype" id="1530311">uintptr</span><span class="op" id="1530318">(</span><span class="ident" id="1530319">t</span><span class="op" id="1530320">.</span><span class="ident" id="1530321">key</span><span class="op" id="1530324">.</span><span class="ident" id="1530325">size</span><span class="op" id="1530329">)</span><span class="op" id="1530330">,</span>&nbsp;<span class="builtintype" id="1530332">uintptr</span><span class="op" id="1530339">(</span><span class="ident" id="1530340">h</span><span class="op" id="1530341">.</span><span class="ident" id="1530342">hash0</span><span class="op" id="1530347">)</span><span class="op" id="1530348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530351">m</span>&nbsp;<span class="op" id="1530353">:=</span>&nbsp;<span class="builtintype" id="1530356">uintptr</span><span class="op" id="1530363">(</span><span class="num" id="1530364">1</span><span class="op" id="1530365">)</span><span class="op" id="1530366">&lt;&lt;</span><span class="ident" id="1530368">h</span><span class="op" id="1530369">.</span><span class="ident" id="1530370">B</span>&nbsp;<span class="op" id="1530372">-</span>&nbsp;<span class="num" id="1530374">1</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530377">b</span>&nbsp;<span class="op" id="1530379">:=</span>&nbsp;<span class="op" id="1530382">(</span><span class="op" id="1530383">*</span><span class="ident" id="1530384">bmap</span><span class="op" id="1530388">)</span><span class="op" id="1530389">(</span><span class="ident" id="1530390">add</span><span class="op" id="1530393">(</span><span class="ident" id="1530394">h</span><span class="op" id="1530395">.</span><span class="ident" id="1530396">buckets</span><span class="op" id="1530403">,</span>&nbsp;<span class="op" id="1530405">(</span><span class="ident" id="1530406">hash</span><span class="op" id="1530410">&amp;</span><span class="ident" id="1530411">m</span><span class="op" id="1530412">)</span><span class="op" id="1530413">*</span><span class="builtintype" id="1530414">uintptr</span><span class="op" id="1530421">(</span><span class="ident" id="1530422">t</span><span class="op" id="1530423">.</span><span class="ident" id="1530424">bucketsize</span><span class="op" id="1530434">)</span><span class="op" id="1530435">)</span><span class="op" id="1530436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530439">if</span>&nbsp;<span class="ident" id="1530442">c</span>&nbsp;<span class="op" id="1530444">:=</span>&nbsp;<span class="ident" id="1530447">h</span><span class="op" id="1530448">.</span><span class="ident" id="1530449">oldbuckets</span><span class="op" id="1530459">;</span>&nbsp;<span class="ident" id="1530461">c</span>&nbsp;<span class="op" id="1530463">!=</span>&nbsp;<span class="ident" id="1530466">nil</span>&nbsp;<span class="op" id="1530470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530474">oldb</span>&nbsp;<span class="op" id="1530479">:=</span>&nbsp;<span class="op" id="1530482">(</span><span class="op" id="1530483">*</span><span class="ident" id="1530484">bmap</span><span class="op" id="1530488">)</span><span class="op" id="1530489">(</span><span class="ident" id="1530490">add</span><span class="op" id="1530493">(</span><span class="ident" id="1530494">c</span><span class="op" id="1530495">,</span>&nbsp;<span class="op" id="1530497">(</span><span class="ident" id="1530498">hash</span><span class="op" id="1530502">&amp;</span><span class="op" id="1530503">(</span><span class="ident" id="1530504">m</span><span class="op" id="1530505">&gt;&gt;</span><span class="num" id="1530507">1</span><span class="op" id="1530508">)</span><span class="op" id="1530509">)</span><span class="op" id="1530510">*</span><span class="builtintype" id="1530511">uintptr</span><span class="op" id="1530518">(</span><span class="ident" id="1530519">t</span><span class="op" id="1530520">.</span><span class="ident" id="1530521">bucketsize</span><span class="op" id="1530531">)</span><span class="op" id="1530532">)</span><span class="op" id="1530533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530537">if</span>&nbsp;<span class="op" id="1530540">!</span><span class="ident" id="1530541">evacuated</span><span class="op" id="1530550">(</span><span class="ident" id="1530551">oldb</span><span class="op" id="1530555">)</span>&nbsp;<span class="op" id="1530557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530562">b</span>&nbsp;<span class="op" id="1530564">=</span>&nbsp;<span class="ident" id="1530566">oldb</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530579">top</span>&nbsp;<span class="op" id="1530583">:=</span>&nbsp;<span class="builtintype" id="1530586">uint8</span><span class="op" id="1530591">(</span><span class="ident" id="1530592">hash</span>&nbsp;<span class="op" id="1530597">&gt;&gt;</span>&nbsp;<span class="op" id="1530600">(</span><span class="ident" id="1530601">ptrSize</span><span class="op" id="1530608">*</span><span class="num" id="1530609">8</span>&nbsp;<span class="op" id="1530611">-</span>&nbsp;<span class="num" id="1530613">8</span><span class="op" id="1530614">)</span><span class="op" id="1530615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530618">if</span>&nbsp;<span class="ident" id="1530621">top</span>&nbsp;<span class="op" id="1530625">&lt;</span>&nbsp;<span class="ident" id="1530627">minTopHash</span>&nbsp;<span class="op" id="1530638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530642">top</span>&nbsp;<span class="op" id="1530646">+=</span>&nbsp;<span class="ident" id="1530649">minTopHash</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530664">for</span>&nbsp;<span class="op" id="1530668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530672">for</span>&nbsp;<span class="ident" id="1530676">i</span>&nbsp;<span class="op" id="1530678">:=</span>&nbsp;<span class="builtintype" id="1530681">uintptr</span><span class="op" id="1530688">(</span><span class="num" id="1530689">0</span><span class="op" id="1530690">)</span><span class="op" id="1530691">;</span>&nbsp;<span class="ident" id="1530693">i</span>&nbsp;<span class="op" id="1530695">&lt;</span>&nbsp;<span class="ident" id="1530697">bucketCnt</span><span class="op" id="1530706">;</span>&nbsp;<span class="ident" id="1530708">i</span><span class="op" id="1530709">++</span>&nbsp;<span class="op" id="1530712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530717">if</span>&nbsp;<span class="ident" id="1530720">b</span><span class="op" id="1530721">.</span><span class="ident" id="1530722">tophash</span><span class="op" id="1530729">[</span><span class="ident" id="1530730">i</span><span class="op" id="1530731">]</span>&nbsp;<span class="op" id="1530733">!=</span>&nbsp;<span class="ident" id="1530736">top</span>&nbsp;<span class="op" id="1530740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530746">continue</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530763">k</span>&nbsp;<span class="op" id="1530765">:=</span>&nbsp;<span class="ident" id="1530768">add</span><span class="op" id="1530771">(</span><span class="ident" id="1530772">unsafe</span><span class="op" id="1530778">.</span><span class="ident" id="1530779">Pointer</span><span class="op" id="1530786">(</span><span class="ident" id="1530787">b</span><span class="op" id="1530788">)</span><span class="op" id="1530789">,</span>&nbsp;<span class="ident" id="1530791">dataOffset</span><span class="op" id="1530801">+</span><span class="ident" id="1530802">i</span><span class="op" id="1530803">*</span><span class="builtintype" id="1530804">uintptr</span><span class="op" id="1530811">(</span><span class="ident" id="1530812">t</span><span class="op" id="1530813">.</span><span class="ident" id="1530814">keysize</span><span class="op" id="1530821">)</span><span class="op" id="1530822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530827">if</span>&nbsp;<span class="ident" id="1530830">t</span><span class="op" id="1530831">.</span><span class="ident" id="1530832">indirectkey</span>&nbsp;<span class="op" id="1530844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530850">k</span>&nbsp;<span class="op" id="1530852">=</span>&nbsp;<span class="op" id="1530854">*</span><span class="op" id="1530855">(</span><span class="op" id="1530856">(</span><span class="op" id="1530857">*</span><span class="ident" id="1530858">unsafe</span><span class="op" id="1530864">.</span><span class="ident" id="1530865">Pointer</span><span class="op" id="1530872">)</span><span class="op" id="1530873">(</span><span class="ident" id="1530874">k</span><span class="op" id="1530875">)</span><span class="op" id="1530876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530881">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530886">if</span>&nbsp;<span class="ident" id="1530889">alg</span><span class="op" id="1530892">.</span><span class="ident" id="1530893">equal</span><span class="op" id="1530898">(</span><span class="ident" id="1530899">key</span><span class="op" id="1530902">,</span>&nbsp;<span class="ident" id="1530904">k</span><span class="op" id="1530905">,</span>&nbsp;<span class="builtintype" id="1530907">uintptr</span><span class="op" id="1530914">(</span><span class="ident" id="1530915">t</span><span class="op" id="1530916">.</span><span class="ident" id="1530917">key</span><span class="op" id="1530920">.</span><span class="ident" id="1530921">size</span><span class="op" id="1530925">)</span><span class="op" id="1530926">)</span>&nbsp;<span class="op" id="1530928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530934">v</span>&nbsp;<span class="op" id="1530936">:=</span>&nbsp;<span class="ident" id="1530939">add</span><span class="op" id="1530942">(</span><span class="ident" id="1530943">unsafe</span><span class="op" id="1530949">.</span><span class="ident" id="1530950">Pointer</span><span class="op" id="1530957">(</span><span class="ident" id="1530958">b</span><span class="op" id="1530959">)</span><span class="op" id="1530960">,</span>&nbsp;<span class="ident" id="1530962">dataOffset</span><span class="op" id="1530972">+</span><span class="ident" id="1530973">bucketCnt</span><span class="op" id="1530982">*</span><span class="builtintype" id="1530983">uintptr</span><span class="op" id="1530990">(</span><span class="ident" id="1530991">t</span><span class="op" id="1530992">.</span><span class="ident" id="1530993">keysize</span><span class="op" id="1531000">)</span><span class="op" id="1531001">+</span><span class="ident" id="1531002">i</span><span class="op" id="1531003">*</span><span class="builtintype" id="1531004">uintptr</span><span class="op" id="1531011">(</span><span class="ident" id="1531012">t</span><span class="op" id="1531013">.</span><span class="ident" id="1531014">valuesize</span><span class="op" id="1531023">)</span><span class="op" id="1531024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531030">if</span>&nbsp;<span class="ident" id="1531033">t</span><span class="op" id="1531034">.</span><span class="ident" id="1531035">indirectvalue</span>&nbsp;<span class="op" id="1531049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531056">v</span>&nbsp;<span class="op" id="1531058">=</span>&nbsp;<span class="op" id="1531060">*</span><span class="op" id="1531061">(</span><span class="op" id="1531062">(</span><span class="op" id="1531063">*</span><span class="ident" id="1531064">unsafe</span><span class="op" id="1531070">.</span><span class="ident" id="1531071">Pointer</span><span class="op" id="1531078">)</span><span class="op" id="1531079">(</span><span class="ident" id="1531080">v</span><span class="op" id="1531081">)</span><span class="op" id="1531082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531088">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531094">return</span>&nbsp;<span class="ident" id="1531101">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531114">b</span>&nbsp;<span class="op" id="1531116">=</span>&nbsp;<span class="ident" id="1531118">b</span><span class="op" id="1531119">.</span><span class="ident" id="1531120">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531131">if</span>&nbsp;<span class="ident" id="1531134">b</span>&nbsp;<span class="op" id="1531136">==</span>&nbsp;<span class="ident" id="1531139">nil</span>&nbsp;<span class="op" id="1531143">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531148">return</span>&nbsp;<span class="ident" id="1531155">unsafe</span><span class="op" id="1531161">.</span><span class="ident" id="1531162">Pointer</span><span class="op" id="1531169">(</span><span class="ident" id="1531170">t</span><span class="op" id="1531171">.</span><span class="ident" id="1531172">elem</span><span class="op" id="1531176">.</span><span class="ident" id="1531177">zero</span><span class="op" id="1531181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531188">}</span><br>
<span class="lineno"></span><span class="op" id="1531190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="1531193">func</span>&nbsp;<span class="ident" id="1531198">mapaccess2</span><span class="op" id="1531208">(</span><span class="ident" id="1531209">t</span>&nbsp;<span class="op" id="1531211">*</span><span class="ident" id="1531212">maptype</span><span class="op" id="1531219">,</span>&nbsp;<span class="ident" id="1531221">h</span>&nbsp;<span class="op" id="1531223">*</span><span class="ident" id="1531224">hmap</span><span class="op" id="1531228">,</span>&nbsp;<span class="ident" id="1531230">key</span>&nbsp;<span class="ident" id="1531234">unsafe</span><span class="op" id="1531240">.</span><span class="ident" id="1531241">Pointer</span><span class="op" id="1531248">)</span>&nbsp;<span class="op" id="1531250">(</span><span class="ident" id="1531251">unsafe</span><span class="op" id="1531257">.</span><span class="ident" id="1531258">Pointer</span><span class="op" id="1531265">,</span>&nbsp;<span class="builtintype" id="1531267">bool</span><span class="op" id="1531271">)</span>&nbsp;<span class="op" id="1531273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531276">if</span>&nbsp;<span class="ident" id="1531279">raceenabled</span>&nbsp;<span class="op" id="1531291">&amp;&amp;</span>&nbsp;<span class="ident" id="1531294">h</span>&nbsp;<span class="op" id="1531296">!=</span>&nbsp;<span class="ident" id="1531299">nil</span>&nbsp;<span class="op" id="1531303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531307">callerpc</span>&nbsp;<span class="op" id="1531316">:=</span>&nbsp;<span class="ident" id="1531319">getcallerpc</span><span class="op" id="1531330">(</span><span class="ident" id="1531331">unsafe</span><span class="op" id="1531337">.</span><span class="ident" id="1531338">Pointer</span><span class="op" id="1531345">(</span><span class="op" id="1531346">&amp;</span><span class="ident" id="1531347">t</span><span class="op" id="1531348">)</span><span class="op" id="1531349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531353">pc</span>&nbsp;<span class="op" id="1531356">:=</span>&nbsp;<span class="ident" id="1531359">funcPC</span><span class="op" id="1531365">(</span><span class="ident" id="1531366">mapaccess2</span><span class="op" id="1531376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531380">racereadpc</span><span class="op" id="1531390">(</span><span class="ident" id="1531391">unsafe</span><span class="op" id="1531397">.</span><span class="ident" id="1531398">Pointer</span><span class="op" id="1531405">(</span><span class="ident" id="1531406">h</span><span class="op" id="1531407">)</span><span class="op" id="1531408">,</span>&nbsp;<span class="ident" id="1531410">callerpc</span><span class="op" id="1531418">,</span>&nbsp;<span class="ident" id="1531420">pc</span><span class="op" id="1531422">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531426">raceReadObjectPC</span><span class="op" id="1531442">(</span><span class="ident" id="1531443">t</span><span class="op" id="1531444">.</span><span class="ident" id="1531445">key</span><span class="op" id="1531448">,</span>&nbsp;<span class="ident" id="1531450">key</span><span class="op" id="1531453">,</span>&nbsp;<span class="ident" id="1531455">callerpc</span><span class="op" id="1531463">,</span>&nbsp;<span class="ident" id="1531465">pc</span><span class="op" id="1531467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531473">if</span>&nbsp;<span class="ident" id="1531476">h</span>&nbsp;<span class="op" id="1531478">==</span>&nbsp;<span class="ident" id="1531481">nil</span>&nbsp;<span class="op" id="1531485">||</span>&nbsp;<span class="ident" id="1531488">h</span><span class="op" id="1531489">.</span><span class="ident" id="1531490">count</span>&nbsp;<span class="op" id="1531496">==</span>&nbsp;<span class="num" id="1531499">0</span>&nbsp;<span class="op" id="1531501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531505">return</span>&nbsp;<span class="ident" id="1531512">unsafe</span><span class="op" id="1531518">.</span><span class="ident" id="1531519">Pointer</span><span class="op" id="1531526">(</span><span class="ident" id="1531527">t</span><span class="op" id="1531528">.</span><span class="ident" id="1531529">elem</span><span class="op" id="1531533">.</span><span class="ident" id="1531534">zero</span><span class="op" id="1531538">)</span><span class="op" id="1531539">,</span>&nbsp;<span class="ident" id="1531541">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531548">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531551">alg</span>&nbsp;<span class="op" id="1531555">:=</span>&nbsp;<span class="ident" id="1531558">goalg</span><span class="op" id="1531563">(</span><span class="ident" id="1531564">t</span><span class="op" id="1531565">.</span><span class="ident" id="1531566">key</span><span class="op" id="1531569">.</span><span class="ident" id="1531570">alg</span><span class="op" id="1531573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531576">hash</span>&nbsp;<span class="op" id="1531581">:=</span>&nbsp;<span class="ident" id="1531584">alg</span><span class="op" id="1531587">.</span><span class="ident" id="1531588">hash</span><span class="op" id="1531592">(</span><span class="ident" id="1531593">key</span><span class="op" id="1531596">,</span>&nbsp;<span class="builtintype" id="1531598">uintptr</span><span class="op" id="1531605">(</span><span class="ident" id="1531606">t</span><span class="op" id="1531607">.</span><span class="ident" id="1531608">key</span><span class="op" id="1531611">.</span><span class="ident" id="1531612">size</span><span class="op" id="1531616">)</span><span class="op" id="1531617">,</span>&nbsp;<span class="builtintype" id="1531619">uintptr</span><span class="op" id="1531626">(</span><span class="ident" id="1531627">h</span><span class="op" id="1531628">.</span><span class="ident" id="1531629">hash0</span><span class="op" id="1531634">)</span><span class="op" id="1531635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531638">m</span>&nbsp;<span class="op" id="1531640">:=</span>&nbsp;<span class="builtintype" id="1531643">uintptr</span><span class="op" id="1531650">(</span><span class="num" id="1531651">1</span><span class="op" id="1531652">)</span><span class="op" id="1531653">&lt;&lt;</span><span class="ident" id="1531655">h</span><span class="op" id="1531656">.</span><span class="ident" id="1531657">B</span>&nbsp;<span class="op" id="1531659">-</span>&nbsp;<span class="num" id="1531661">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531664">b</span>&nbsp;<span class="op" id="1531666">:=</span>&nbsp;<span class="op" id="1531669">(</span><span class="op" id="1531670">*</span><span class="ident" id="1531671">bmap</span><span class="op" id="1531675">)</span><span class="op" id="1531676">(</span><span class="ident" id="1531677">unsafe</span><span class="op" id="1531683">.</span><span class="ident" id="1531684">Pointer</span><span class="op" id="1531691">(</span><span class="builtintype" id="1531692">uintptr</span><span class="op" id="1531699">(</span><span class="ident" id="1531700">h</span><span class="op" id="1531701">.</span><span class="ident" id="1531702">buckets</span><span class="op" id="1531709">)</span>&nbsp;<span class="op" id="1531711">+</span>&nbsp;<span class="op" id="1531713">(</span><span class="ident" id="1531714">hash</span><span class="op" id="1531718">&amp;</span><span class="ident" id="1531719">m</span><span class="op" id="1531720">)</span><span class="op" id="1531721">*</span><span class="builtintype" id="1531722">uintptr</span><span class="op" id="1531729">(</span><span class="ident" id="1531730">t</span><span class="op" id="1531731">.</span><span class="ident" id="1531732">bucketsize</span><span class="op" id="1531742">)</span><span class="op" id="1531743">)</span><span class="op" id="1531744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531747">if</span>&nbsp;<span class="ident" id="1531750">c</span>&nbsp;<span class="op" id="1531752">:=</span>&nbsp;<span class="ident" id="1531755">h</span><span class="op" id="1531756">.</span><span class="ident" id="1531757">oldbuckets</span><span class="op" id="1531767">;</span>&nbsp;<span class="ident" id="1531769">c</span>&nbsp;<span class="op" id="1531771">!=</span>&nbsp;<span class="ident" id="1531774">nil</span>&nbsp;<span class="op" id="1531778">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531782">oldb</span>&nbsp;<span class="op" id="1531787">:=</span>&nbsp;<span class="op" id="1531790">(</span><span class="op" id="1531791">*</span><span class="ident" id="1531792">bmap</span><span class="op" id="1531796">)</span><span class="op" id="1531797">(</span><span class="ident" id="1531798">unsafe</span><span class="op" id="1531804">.</span><span class="ident" id="1531805">Pointer</span><span class="op" id="1531812">(</span><span class="builtintype" id="1531813">uintptr</span><span class="op" id="1531820">(</span><span class="ident" id="1531821">c</span><span class="op" id="1531822">)</span>&nbsp;<span class="op" id="1531824">+</span>&nbsp;<span class="op" id="1531826">(</span><span class="ident" id="1531827">hash</span><span class="op" id="1531831">&amp;</span><span class="op" id="1531832">(</span><span class="ident" id="1531833">m</span><span class="op" id="1531834">&gt;&gt;</span><span class="num" id="1531836">1</span><span class="op" id="1531837">)</span><span class="op" id="1531838">)</span><span class="op" id="1531839">*</span><span class="builtintype" id="1531840">uintptr</span><span class="op" id="1531847">(</span><span class="ident" id="1531848">t</span><span class="op" id="1531849">.</span><span class="ident" id="1531850">bucketsize</span><span class="op" id="1531860">)</span><span class="op" id="1531861">)</span><span class="op" id="1531862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531866">if</span>&nbsp;<span class="op" id="1531869">!</span><span class="ident" id="1531870">evacuated</span><span class="op" id="1531879">(</span><span class="ident" id="1531880">oldb</span><span class="op" id="1531884">)</span>&nbsp;<span class="op" id="1531886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531891">b</span>&nbsp;<span class="op" id="1531893">=</span>&nbsp;<span class="ident" id="1531895">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531905">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531908">top</span>&nbsp;<span class="op" id="1531912">:=</span>&nbsp;<span class="builtintype" id="1531915">uint8</span><span class="op" id="1531920">(</span><span class="ident" id="1531921">hash</span>&nbsp;<span class="op" id="1531926">&gt;&gt;</span>&nbsp;<span class="op" id="1531929">(</span><span class="ident" id="1531930">ptrSize</span><span class="op" id="1531937">*</span><span class="num" id="1531938">8</span>&nbsp;<span class="op" id="1531940">-</span>&nbsp;<span class="num" id="1531942">8</span><span class="op" id="1531943">)</span><span class="op" id="1531944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531947">if</span>&nbsp;<span class="ident" id="1531950">top</span>&nbsp;<span class="op" id="1531954">&lt;</span>&nbsp;<span class="ident" id="1531956">minTopHash</span>&nbsp;<span class="op" id="1531967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531971">top</span>&nbsp;<span class="op" id="1531975">+=</span>&nbsp;<span class="ident" id="1531978">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531993">for</span>&nbsp;<span class="op" id="1531997">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532001">for</span>&nbsp;<span class="ident" id="1532005">i</span>&nbsp;<span class="op" id="1532007">:=</span>&nbsp;<span class="builtintype" id="1532010">uintptr</span><span class="op" id="1532017">(</span><span class="num" id="1532018">0</span><span class="op" id="1532019">)</span><span class="op" id="1532020">;</span>&nbsp;<span class="ident" id="1532022">i</span>&nbsp;<span class="op" id="1532024">&lt;</span>&nbsp;<span class="ident" id="1532026">bucketCnt</span><span class="op" id="1532035">;</span>&nbsp;<span class="ident" id="1532037">i</span><span class="op" id="1532038">++</span>&nbsp;<span class="op" id="1532041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532046">if</span>&nbsp;<span class="ident" id="1532049">b</span><span class="op" id="1532050">.</span><span class="ident" id="1532051">tophash</span><span class="op" id="1532058">[</span><span class="ident" id="1532059">i</span><span class="op" id="1532060">]</span>&nbsp;<span class="op" id="1532062">!=</span>&nbsp;<span class="ident" id="1532065">top</span>&nbsp;<span class="op" id="1532069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532075">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532092">k</span>&nbsp;<span class="op" id="1532094">:=</span>&nbsp;<span class="ident" id="1532097">add</span><span class="op" id="1532100">(</span><span class="ident" id="1532101">unsafe</span><span class="op" id="1532107">.</span><span class="ident" id="1532108">Pointer</span><span class="op" id="1532115">(</span><span class="ident" id="1532116">b</span><span class="op" id="1532117">)</span><span class="op" id="1532118">,</span>&nbsp;<span class="ident" id="1532120">dataOffset</span><span class="op" id="1532130">+</span><span class="ident" id="1532131">i</span><span class="op" id="1532132">*</span><span class="builtintype" id="1532133">uintptr</span><span class="op" id="1532140">(</span><span class="ident" id="1532141">t</span><span class="op" id="1532142">.</span><span class="ident" id="1532143">keysize</span><span class="op" id="1532150">)</span><span class="op" id="1532151">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532156">if</span>&nbsp;<span class="ident" id="1532159">t</span><span class="op" id="1532160">.</span><span class="ident" id="1532161">indirectkey</span>&nbsp;<span class="op" id="1532173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532179">k</span>&nbsp;<span class="op" id="1532181">=</span>&nbsp;<span class="op" id="1532183">*</span><span class="op" id="1532184">(</span><span class="op" id="1532185">(</span><span class="op" id="1532186">*</span><span class="ident" id="1532187">unsafe</span><span class="op" id="1532193">.</span><span class="ident" id="1532194">Pointer</span><span class="op" id="1532201">)</span><span class="op" id="1532202">(</span><span class="ident" id="1532203">k</span><span class="op" id="1532204">)</span><span class="op" id="1532205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532215">if</span>&nbsp;<span class="ident" id="1532218">alg</span><span class="op" id="1532221">.</span><span class="ident" id="1532222">equal</span><span class="op" id="1532227">(</span><span class="ident" id="1532228">key</span><span class="op" id="1532231">,</span>&nbsp;<span class="ident" id="1532233">k</span><span class="op" id="1532234">,</span>&nbsp;<span class="builtintype" id="1532236">uintptr</span><span class="op" id="1532243">(</span><span class="ident" id="1532244">t</span><span class="op" id="1532245">.</span><span class="ident" id="1532246">key</span><span class="op" id="1532249">.</span><span class="ident" id="1532250">size</span><span class="op" id="1532254">)</span><span class="op" id="1532255">)</span>&nbsp;<span class="op" id="1532257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532263">v</span>&nbsp;<span class="op" id="1532265">:=</span>&nbsp;<span class="ident" id="1532268">add</span><span class="op" id="1532271">(</span><span class="ident" id="1532272">unsafe</span><span class="op" id="1532278">.</span><span class="ident" id="1532279">Pointer</span><span class="op" id="1532286">(</span><span class="ident" id="1532287">b</span><span class="op" id="1532288">)</span><span class="op" id="1532289">,</span>&nbsp;<span class="ident" id="1532291">dataOffset</span><span class="op" id="1532301">+</span><span class="ident" id="1532302">bucketCnt</span><span class="op" id="1532311">*</span><span class="builtintype" id="1532312">uintptr</span><span class="op" id="1532319">(</span><span class="ident" id="1532320">t</span><span class="op" id="1532321">.</span><span class="ident" id="1532322">keysize</span><span class="op" id="1532329">)</span><span class="op" id="1532330">+</span><span class="ident" id="1532331">i</span><span class="op" id="1532332">*</span><span class="builtintype" id="1532333">uintptr</span><span class="op" id="1532340">(</span><span class="ident" id="1532341">t</span><span class="op" id="1532342">.</span><span class="ident" id="1532343">valuesize</span><span class="op" id="1532352">)</span><span class="op" id="1532353">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532359">if</span>&nbsp;<span class="ident" id="1532362">t</span><span class="op" id="1532363">.</span><span class="ident" id="1532364">indirectvalue</span>&nbsp;<span class="op" id="1532378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532385">v</span>&nbsp;<span class="op" id="1532387">=</span>&nbsp;<span class="op" id="1532389">*</span><span class="op" id="1532390">(</span><span class="op" id="1532391">(</span><span class="op" id="1532392">*</span><span class="ident" id="1532393">unsafe</span><span class="op" id="1532399">.</span><span class="ident" id="1532400">Pointer</span><span class="op" id="1532407">)</span><span class="op" id="1532408">(</span><span class="ident" id="1532409">v</span><span class="op" id="1532410">)</span><span class="op" id="1532411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532423">return</span>&nbsp;<span class="ident" id="1532430">v</span><span class="op" id="1532431">,</span>&nbsp;<span class="ident" id="1532433">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532441">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532449">b</span>&nbsp;<span class="op" id="1532451">=</span>&nbsp;<span class="ident" id="1532453">b</span><span class="op" id="1532454">.</span><span class="ident" id="1532455">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532466">if</span>&nbsp;<span class="ident" id="1532469">b</span>&nbsp;<span class="op" id="1532471">==</span>&nbsp;<span class="ident" id="1532474">nil</span>&nbsp;<span class="op" id="1532478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532483">return</span>&nbsp;<span class="ident" id="1532490">unsafe</span><span class="op" id="1532496">.</span><span class="ident" id="1532497">Pointer</span><span class="op" id="1532504">(</span><span class="ident" id="1532505">t</span><span class="op" id="1532506">.</span><span class="ident" id="1532507">elem</span><span class="op" id="1532511">.</span><span class="ident" id="1532512">zero</span><span class="op" id="1532516">)</span><span class="op" id="1532517">,</span>&nbsp;<span class="ident" id="1532519">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532527">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532530">}</span><br>
<span class="lineno"></span><span class="op" id="1532532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1532535">//&nbsp;returns&nbsp;both&nbsp;key&nbsp;and&nbsp;value.&nbsp;&nbsp;Used&nbsp;by&nbsp;map&nbsp;iterator</span><br>
<span class="lineno"></span><span class="keyword" id="1532588">func</span>&nbsp;<span class="ident" id="1532593">mapaccessK</span><span class="op" id="1532603">(</span><span class="ident" id="1532604">t</span>&nbsp;<span class="op" id="1532606">*</span><span class="ident" id="1532607">maptype</span><span class="op" id="1532614">,</span>&nbsp;<span class="ident" id="1532616">h</span>&nbsp;<span class="op" id="1532618">*</span><span class="ident" id="1532619">hmap</span><span class="op" id="1532623">,</span>&nbsp;<span class="ident" id="1532625">key</span>&nbsp;<span class="ident" id="1532629">unsafe</span><span class="op" id="1532635">.</span><span class="ident" id="1532636">Pointer</span><span class="op" id="1532643">)</span>&nbsp;<span class="op" id="1532645">(</span><span class="ident" id="1532646">unsafe</span><span class="op" id="1532652">.</span><span class="ident" id="1532653">Pointer</span><span class="op" id="1532660">,</span>&nbsp;<span class="ident" id="1532662">unsafe</span><span class="op" id="1532668">.</span><span class="ident" id="1532669">Pointer</span><span class="op" id="1532676">)</span>&nbsp;<span class="op" id="1532678">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532681">if</span>&nbsp;<span class="ident" id="1532684">h</span>&nbsp;<span class="op" id="1532686">==</span>&nbsp;<span class="ident" id="1532689">nil</span>&nbsp;<span class="op" id="1532693">||</span>&nbsp;<span class="ident" id="1532696">h</span><span class="op" id="1532697">.</span><span class="ident" id="1532698">count</span>&nbsp;<span class="op" id="1532704">==</span>&nbsp;<span class="num" id="1532707">0</span>&nbsp;<span class="op" id="1532709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532713">return</span>&nbsp;<span class="ident" id="1532720">nil</span><span class="op" id="1532723">,</span>&nbsp;<span class="ident" id="1532725">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532733">alg</span>&nbsp;<span class="op" id="1532737">:=</span>&nbsp;<span class="ident" id="1532740">goalg</span><span class="op" id="1532745">(</span><span class="ident" id="1532746">t</span><span class="op" id="1532747">.</span><span class="ident" id="1532748">key</span><span class="op" id="1532751">.</span><span class="ident" id="1532752">alg</span><span class="op" id="1532755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532758">hash</span>&nbsp;<span class="op" id="1532763">:=</span>&nbsp;<span class="ident" id="1532766">alg</span><span class="op" id="1532769">.</span><span class="ident" id="1532770">hash</span><span class="op" id="1532774">(</span><span class="ident" id="1532775">key</span><span class="op" id="1532778">,</span>&nbsp;<span class="builtintype" id="1532780">uintptr</span><span class="op" id="1532787">(</span><span class="ident" id="1532788">t</span><span class="op" id="1532789">.</span><span class="ident" id="1532790">key</span><span class="op" id="1532793">.</span><span class="ident" id="1532794">size</span><span class="op" id="1532798">)</span><span class="op" id="1532799">,</span>&nbsp;<span class="builtintype" id="1532801">uintptr</span><span class="op" id="1532808">(</span><span class="ident" id="1532809">h</span><span class="op" id="1532810">.</span><span class="ident" id="1532811">hash0</span><span class="op" id="1532816">)</span><span class="op" id="1532817">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532820">m</span>&nbsp;<span class="op" id="1532822">:=</span>&nbsp;<span class="builtintype" id="1532825">uintptr</span><span class="op" id="1532832">(</span><span class="num" id="1532833">1</span><span class="op" id="1532834">)</span><span class="op" id="1532835">&lt;&lt;</span><span class="ident" id="1532837">h</span><span class="op" id="1532838">.</span><span class="ident" id="1532839">B</span>&nbsp;<span class="op" id="1532841">-</span>&nbsp;<span class="num" id="1532843">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532846">b</span>&nbsp;<span class="op" id="1532848">:=</span>&nbsp;<span class="op" id="1532851">(</span><span class="op" id="1532852">*</span><span class="ident" id="1532853">bmap</span><span class="op" id="1532857">)</span><span class="op" id="1532858">(</span><span class="ident" id="1532859">unsafe</span><span class="op" id="1532865">.</span><span class="ident" id="1532866">Pointer</span><span class="op" id="1532873">(</span><span class="builtintype" id="1532874">uintptr</span><span class="op" id="1532881">(</span><span class="ident" id="1532882">h</span><span class="op" id="1532883">.</span><span class="ident" id="1532884">buckets</span><span class="op" id="1532891">)</span>&nbsp;<span class="op" id="1532893">+</span>&nbsp;<span class="op" id="1532895">(</span><span class="ident" id="1532896">hash</span><span class="op" id="1532900">&amp;</span><span class="ident" id="1532901">m</span><span class="op" id="1532902">)</span><span class="op" id="1532903">*</span><span class="builtintype" id="1532904">uintptr</span><span class="op" id="1532911">(</span><span class="ident" id="1532912">t</span><span class="op" id="1532913">.</span><span class="ident" id="1532914">bucketsize</span><span class="op" id="1532924">)</span><span class="op" id="1532925">)</span><span class="op" id="1532926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532929">if</span>&nbsp;<span class="ident" id="1532932">c</span>&nbsp;<span class="op" id="1532934">:=</span>&nbsp;<span class="ident" id="1532937">h</span><span class="op" id="1532938">.</span><span class="ident" id="1532939">oldbuckets</span><span class="op" id="1532949">;</span>&nbsp;<span class="ident" id="1532951">c</span>&nbsp;<span class="op" id="1532953">!=</span>&nbsp;<span class="ident" id="1532956">nil</span>&nbsp;<span class="op" id="1532960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532964">oldb</span>&nbsp;<span class="op" id="1532969">:=</span>&nbsp;<span class="op" id="1532972">(</span><span class="op" id="1532973">*</span><span class="ident" id="1532974">bmap</span><span class="op" id="1532978">)</span><span class="op" id="1532979">(</span><span class="ident" id="1532980">unsafe</span><span class="op" id="1532986">.</span><span class="ident" id="1532987">Pointer</span><span class="op" id="1532994">(</span><span class="builtintype" id="1532995">uintptr</span><span class="op" id="1533002">(</span><span class="ident" id="1533003">c</span><span class="op" id="1533004">)</span>&nbsp;<span class="op" id="1533006">+</span>&nbsp;<span class="op" id="1533008">(</span><span class="ident" id="1533009">hash</span><span class="op" id="1533013">&amp;</span><span class="op" id="1533014">(</span><span class="ident" id="1533015">m</span><span class="op" id="1533016">&gt;&gt;</span><span class="num" id="1533018">1</span><span class="op" id="1533019">)</span><span class="op" id="1533020">)</span><span class="op" id="1533021">*</span><span class="builtintype" id="1533022">uintptr</span><span class="op" id="1533029">(</span><span class="ident" id="1533030">t</span><span class="op" id="1533031">.</span><span class="ident" id="1533032">bucketsize</span><span class="op" id="1533042">)</span><span class="op" id="1533043">)</span><span class="op" id="1533044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533048">if</span>&nbsp;<span class="op" id="1533051">!</span><span class="ident" id="1533052">evacuated</span><span class="op" id="1533061">(</span><span class="ident" id="1533062">oldb</span><span class="op" id="1533066">)</span>&nbsp;<span class="op" id="1533068">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533073">b</span>&nbsp;<span class="op" id="1533075">=</span>&nbsp;<span class="ident" id="1533077">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533090">top</span>&nbsp;<span class="op" id="1533094">:=</span>&nbsp;<span class="builtintype" id="1533097">uint8</span><span class="op" id="1533102">(</span><span class="ident" id="1533103">hash</span>&nbsp;<span class="op" id="1533108">&gt;&gt;</span>&nbsp;<span class="op" id="1533111">(</span><span class="ident" id="1533112">ptrSize</span><span class="op" id="1533119">*</span><span class="num" id="1533120">8</span>&nbsp;<span class="op" id="1533122">-</span>&nbsp;<span class="num" id="1533124">8</span><span class="op" id="1533125">)</span><span class="op" id="1533126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533129">if</span>&nbsp;<span class="ident" id="1533132">top</span>&nbsp;<span class="op" id="1533136">&lt;</span>&nbsp;<span class="ident" id="1533138">minTopHash</span>&nbsp;<span class="op" id="1533149">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533153">top</span>&nbsp;<span class="op" id="1533157">+=</span>&nbsp;<span class="ident" id="1533160">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533175">for</span>&nbsp;<span class="op" id="1533179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533183">for</span>&nbsp;<span class="ident" id="1533187">i</span>&nbsp;<span class="op" id="1533189">:=</span>&nbsp;<span class="builtintype" id="1533192">uintptr</span><span class="op" id="1533199">(</span><span class="num" id="1533200">0</span><span class="op" id="1533201">)</span><span class="op" id="1533202">;</span>&nbsp;<span class="ident" id="1533204">i</span>&nbsp;<span class="op" id="1533206">&lt;</span>&nbsp;<span class="ident" id="1533208">bucketCnt</span><span class="op" id="1533217">;</span>&nbsp;<span class="ident" id="1533219">i</span><span class="op" id="1533220">++</span>&nbsp;<span class="op" id="1533223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533228">if</span>&nbsp;<span class="ident" id="1533231">b</span><span class="op" id="1533232">.</span><span class="ident" id="1533233">tophash</span><span class="op" id="1533240">[</span><span class="ident" id="1533241">i</span><span class="op" id="1533242">]</span>&nbsp;<span class="op" id="1533244">!=</span>&nbsp;<span class="ident" id="1533247">top</span>&nbsp;<span class="op" id="1533251">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533257">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533274">k</span>&nbsp;<span class="op" id="1533276">:=</span>&nbsp;<span class="ident" id="1533279">add</span><span class="op" id="1533282">(</span><span class="ident" id="1533283">unsafe</span><span class="op" id="1533289">.</span><span class="ident" id="1533290">Pointer</span><span class="op" id="1533297">(</span><span class="ident" id="1533298">b</span><span class="op" id="1533299">)</span><span class="op" id="1533300">,</span>&nbsp;<span class="ident" id="1533302">dataOffset</span><span class="op" id="1533312">+</span><span class="ident" id="1533313">i</span><span class="op" id="1533314">*</span><span class="builtintype" id="1533315">uintptr</span><span class="op" id="1533322">(</span><span class="ident" id="1533323">t</span><span class="op" id="1533324">.</span><span class="ident" id="1533325">keysize</span><span class="op" id="1533332">)</span><span class="op" id="1533333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533338">if</span>&nbsp;<span class="ident" id="1533341">t</span><span class="op" id="1533342">.</span><span class="ident" id="1533343">indirectkey</span>&nbsp;<span class="op" id="1533355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533361">k</span>&nbsp;<span class="op" id="1533363">=</span>&nbsp;<span class="op" id="1533365">*</span><span class="op" id="1533366">(</span><span class="op" id="1533367">(</span><span class="op" id="1533368">*</span><span class="ident" id="1533369">unsafe</span><span class="op" id="1533375">.</span><span class="ident" id="1533376">Pointer</span><span class="op" id="1533383">)</span><span class="op" id="1533384">(</span><span class="ident" id="1533385">k</span><span class="op" id="1533386">)</span><span class="op" id="1533387">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533397">if</span>&nbsp;<span class="ident" id="1533400">alg</span><span class="op" id="1533403">.</span><span class="ident" id="1533404">equal</span><span class="op" id="1533409">(</span><span class="ident" id="1533410">key</span><span class="op" id="1533413">,</span>&nbsp;<span class="ident" id="1533415">k</span><span class="op" id="1533416">,</span>&nbsp;<span class="builtintype" id="1533418">uintptr</span><span class="op" id="1533425">(</span><span class="ident" id="1533426">t</span><span class="op" id="1533427">.</span><span class="ident" id="1533428">key</span><span class="op" id="1533431">.</span><span class="ident" id="1533432">size</span><span class="op" id="1533436">)</span><span class="op" id="1533437">)</span>&nbsp;<span class="op" id="1533439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533445">v</span>&nbsp;<span class="op" id="1533447">:=</span>&nbsp;<span class="ident" id="1533450">add</span><span class="op" id="1533453">(</span><span class="ident" id="1533454">unsafe</span><span class="op" id="1533460">.</span><span class="ident" id="1533461">Pointer</span><span class="op" id="1533468">(</span><span class="ident" id="1533469">b</span><span class="op" id="1533470">)</span><span class="op" id="1533471">,</span>&nbsp;<span class="ident" id="1533473">dataOffset</span><span class="op" id="1533483">+</span><span class="ident" id="1533484">bucketCnt</span><span class="op" id="1533493">*</span><span class="builtintype" id="1533494">uintptr</span><span class="op" id="1533501">(</span><span class="ident" id="1533502">t</span><span class="op" id="1533503">.</span><span class="ident" id="1533504">keysize</span><span class="op" id="1533511">)</span><span class="op" id="1533512">+</span><span class="ident" id="1533513">i</span><span class="op" id="1533514">*</span><span class="builtintype" id="1533515">uintptr</span><span class="op" id="1533522">(</span><span class="ident" id="1533523">t</span><span class="op" id="1533524">.</span><span class="ident" id="1533525">valuesize</span><span class="op" id="1533534">)</span><span class="op" id="1533535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533541">if</span>&nbsp;<span class="ident" id="1533544">t</span><span class="op" id="1533545">.</span><span class="ident" id="1533546">indirectvalue</span>&nbsp;<span class="op" id="1533560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533567">v</span>&nbsp;<span class="op" id="1533569">=</span>&nbsp;<span class="op" id="1533571">*</span><span class="op" id="1533572">(</span><span class="op" id="1533573">(</span><span class="op" id="1533574">*</span><span class="ident" id="1533575">unsafe</span><span class="op" id="1533581">.</span><span class="ident" id="1533582">Pointer</span><span class="op" id="1533589">)</span><span class="op" id="1533590">(</span><span class="ident" id="1533591">v</span><span class="op" id="1533592">)</span><span class="op" id="1533593">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533605">return</span>&nbsp;<span class="ident" id="1533612">k</span><span class="op" id="1533613">,</span>&nbsp;<span class="ident" id="1533615">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533628">b</span>&nbsp;<span class="op" id="1533630">=</span>&nbsp;<span class="ident" id="1533632">b</span><span class="op" id="1533633">.</span><span class="ident" id="1533634">overflow</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533645">if</span>&nbsp;<span class="ident" id="1533648">b</span>&nbsp;<span class="op" id="1533650">==</span>&nbsp;<span class="ident" id="1533653">nil</span>&nbsp;<span class="op" id="1533657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533662">return</span>&nbsp;<span class="ident" id="1533669">nil</span><span class="op" id="1533672">,</span>&nbsp;<span class="ident" id="1533674">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533683">}</span><br>
<span class="lineno"></span><span class="op" id="1533685">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="1533688">func</span>&nbsp;<span class="ident" id="1533693">mapassign1</span><span class="op" id="1533703">(</span><span class="ident" id="1533704">t</span>&nbsp;<span class="op" id="1533706">*</span><span class="ident" id="1533707">maptype</span><span class="op" id="1533714">,</span>&nbsp;<span class="ident" id="1533716">h</span>&nbsp;<span class="op" id="1533718">*</span><span class="ident" id="1533719">hmap</span><span class="op" id="1533723">,</span>&nbsp;<span class="ident" id="1533725">key</span>&nbsp;<span class="ident" id="1533729">unsafe</span><span class="op" id="1533735">.</span><span class="ident" id="1533736">Pointer</span><span class="op" id="1533743">,</span>&nbsp;<span class="ident" id="1533745">val</span>&nbsp;<span class="ident" id="1533749">unsafe</span><span class="op" id="1533755">.</span><span class="ident" id="1533756">Pointer</span><span class="op" id="1533763">)</span>&nbsp;<span class="op" id="1533765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533768">if</span>&nbsp;<span class="ident" id="1533771">h</span>&nbsp;<span class="op" id="1533773">==</span>&nbsp;<span class="ident" id="1533776">nil</span>&nbsp;<span class="op" id="1533780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1533784">panic</span><span class="op" id="1533789">(</span><span class="string" id="1533790">&#34;assignment&nbsp;to&nbsp;entry&nbsp;in&nbsp;nil&nbsp;map&#34;</span><span class="op" id="1533822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533825">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533828">if</span>&nbsp;<span class="ident" id="1533831">raceenabled</span>&nbsp;<span class="op" id="1533843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533847">callerpc</span>&nbsp;<span class="op" id="1533856">:=</span>&nbsp;<span class="ident" id="1533859">getcallerpc</span><span class="op" id="1533870">(</span><span class="ident" id="1533871">unsafe</span><span class="op" id="1533877">.</span><span class="ident" id="1533878">Pointer</span><span class="op" id="1533885">(</span><span class="op" id="1533886">&amp;</span><span class="ident" id="1533887">t</span><span class="op" id="1533888">)</span><span class="op" id="1533889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533893">pc</span>&nbsp;<span class="op" id="1533896">:=</span>&nbsp;<span class="ident" id="1533899">funcPC</span><span class="op" id="1533905">(</span><span class="ident" id="1533906">mapassign1</span><span class="op" id="1533916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533920">racewritepc</span><span class="op" id="1533931">(</span><span class="ident" id="1533932">unsafe</span><span class="op" id="1533938">.</span><span class="ident" id="1533939">Pointer</span><span class="op" id="1533946">(</span><span class="ident" id="1533947">h</span><span class="op" id="1533948">)</span><span class="op" id="1533949">,</span>&nbsp;<span class="ident" id="1533951">callerpc</span><span class="op" id="1533959">,</span>&nbsp;<span class="ident" id="1533961">pc</span><span class="op" id="1533963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533967">raceReadObjectPC</span><span class="op" id="1533983">(</span><span class="ident" id="1533984">t</span><span class="op" id="1533985">.</span><span class="ident" id="1533986">key</span><span class="op" id="1533989">,</span>&nbsp;<span class="ident" id="1533991">key</span><span class="op" id="1533994">,</span>&nbsp;<span class="ident" id="1533996">callerpc</span><span class="op" id="1534004">,</span>&nbsp;<span class="ident" id="1534006">pc</span><span class="op" id="1534008">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534012">raceReadObjectPC</span><span class="op" id="1534028">(</span><span class="ident" id="1534029">t</span><span class="op" id="1534030">.</span><span class="ident" id="1534031">elem</span><span class="op" id="1534035">,</span>&nbsp;<span class="ident" id="1534037">val</span><span class="op" id="1534040">,</span>&nbsp;<span class="ident" id="1534042">callerpc</span><span class="op" id="1534050">,</span>&nbsp;<span class="ident" id="1534052">pc</span><span class="op" id="1534054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534061">alg</span>&nbsp;<span class="op" id="1534065">:=</span>&nbsp;<span class="ident" id="1534068">goalg</span><span class="op" id="1534073">(</span><span class="ident" id="1534074">t</span><span class="op" id="1534075">.</span><span class="ident" id="1534076">key</span><span class="op" id="1534079">.</span><span class="ident" id="1534080">alg</span><span class="op" id="1534083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534086">hash</span>&nbsp;<span class="op" id="1534091">:=</span>&nbsp;<span class="ident" id="1534094">alg</span><span class="op" id="1534097">.</span><span class="ident" id="1534098">hash</span><span class="op" id="1534102">(</span><span class="ident" id="1534103">key</span><span class="op" id="1534106">,</span>&nbsp;<span class="builtintype" id="1534108">uintptr</span><span class="op" id="1534115">(</span><span class="ident" id="1534116">t</span><span class="op" id="1534117">.</span><span class="ident" id="1534118">key</span><span class="op" id="1534121">.</span><span class="ident" id="1534122">size</span><span class="op" id="1534126">)</span><span class="op" id="1534127">,</span>&nbsp;<span class="builtintype" id="1534129">uintptr</span><span class="op" id="1534136">(</span><span class="ident" id="1534137">h</span><span class="op" id="1534138">.</span><span class="ident" id="1534139">hash0</span><span class="op" id="1534144">)</span><span class="op" id="1534145">)</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534149">if</span>&nbsp;<span class="ident" id="1534152">h</span><span class="op" id="1534153">.</span><span class="ident" id="1534154">buckets</span>&nbsp;<span class="op" id="1534162">==</span>&nbsp;<span class="ident" id="1534165">nil</span>&nbsp;<span class="op" id="1534169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534173">if</span>&nbsp;<span class="ident" id="1534176">checkgc</span>&nbsp;<span class="op" id="1534184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534189">memstats</span><span class="op" id="1534197">.</span><span class="ident" id="1534198">next_gc</span>&nbsp;<span class="op" id="1534206">=</span>&nbsp;<span class="ident" id="1534208">memstats</span><span class="op" id="1534216">.</span><span class="ident" id="1534217">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534230">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534234">h</span><span class="op" id="1534235">.</span><span class="ident" id="1534236">buckets</span>&nbsp;<span class="op" id="1534244">=</span>&nbsp;<span class="ident" id="1534246">newarray</span><span class="op" id="1534254">(</span><span class="ident" id="1534255">t</span><span class="op" id="1534256">.</span><span class="ident" id="1534257">bucket</span><span class="op" id="1534263">,</span>&nbsp;<span class="num" id="1534265">1</span><span class="op" id="1534266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1534272">again</span><span class="op" id="1534277">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534280">bucket</span>&nbsp;<span class="op" id="1534287">:=</span>&nbsp;<span class="ident" id="1534290">hash</span>&nbsp;<span class="op" id="1534295">&amp;</span>&nbsp;<span class="op" id="1534297">(</span><span class="builtintype" id="1534298">uintptr</span><span class="op" id="1534305">(</span><span class="num" id="1534306">1</span><span class="op" id="1534307">)</span><span class="op" id="1534308">&lt;&lt;</span><span class="ident" id="1534310">h</span><span class="op" id="1534311">.</span><span class="ident" id="1534312">B</span>&nbsp;<span class="op" id="1534314">-</span>&nbsp;<span class="num" id="1534316">1</span><span class="op" id="1534317">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534320">if</span>&nbsp;<span class="ident" id="1534323">h</span><span class="op" id="1534324">.</span><span class="ident" id="1534325">oldbuckets</span>&nbsp;<span class="op" id="1534336">!=</span>&nbsp;<span class="ident" id="1534339">nil</span>&nbsp;<span class="op" id="1534343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534347">growWork</span><span class="op" id="1534355">(</span><span class="ident" id="1534356">t</span><span class="op" id="1534357">,</span>&nbsp;<span class="ident" id="1534359">h</span><span class="op" id="1534360">,</span>&nbsp;<span class="ident" id="1534362">bucket</span><span class="op" id="1534368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534374">b</span>&nbsp;<span class="op" id="1534376">:=</span>&nbsp;<span class="op" id="1534379">(</span><span class="op" id="1534380">*</span><span class="ident" id="1534381">bmap</span><span class="op" id="1534385">)</span><span class="op" id="1534386">(</span><span class="ident" id="1534387">unsafe</span><span class="op" id="1534393">.</span><span class="ident" id="1534394">Pointer</span><span class="op" id="1534401">(</span><span class="builtintype" id="1534402">uintptr</span><span class="op" id="1534409">(</span><span class="ident" id="1534410">h</span><span class="op" id="1534411">.</span><span class="ident" id="1534412">buckets</span><span class="op" id="1534419">)</span>&nbsp;<span class="op" id="1534421">+</span>&nbsp;<span class="ident" id="1534423">bucket</span><span class="op" id="1534429">*</span><span class="builtintype" id="1534430">uintptr</span><span class="op" id="1534437">(</span><span class="ident" id="1534438">t</span><span class="op" id="1534439">.</span><span class="ident" id="1534440">bucketsize</span><span class="op" id="1534450">)</span><span class="op" id="1534451">)</span><span class="op" id="1534452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534455">top</span>&nbsp;<span class="op" id="1534459">:=</span>&nbsp;<span class="builtintype" id="1534462">uint8</span><span class="op" id="1534467">(</span><span class="ident" id="1534468">hash</span>&nbsp;<span class="op" id="1534473">&gt;&gt;</span>&nbsp;<span class="op" id="1534476">(</span><span class="ident" id="1534477">ptrSize</span><span class="op" id="1534484">*</span><span class="num" id="1534485">8</span>&nbsp;<span class="op" id="1534487">-</span>&nbsp;<span class="num" id="1534489">8</span><span class="op" id="1534490">)</span><span class="op" id="1534491">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534494">if</span>&nbsp;<span class="ident" id="1534497">top</span>&nbsp;<span class="op" id="1534501">&lt;</span>&nbsp;<span class="ident" id="1534503">minTopHash</span>&nbsp;<span class="op" id="1534514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534518">top</span>&nbsp;<span class="op" id="1534522">+=</span>&nbsp;<span class="ident" id="1534525">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534541">var</span>&nbsp;<span class="ident" id="1534545">inserti</span>&nbsp;<span class="op" id="1534553">*</span><span class="builtintype" id="1534554">uint8</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534561">var</span>&nbsp;<span class="ident" id="1534565">insertk</span>&nbsp;<span class="ident" id="1534573">unsafe</span><span class="op" id="1534579">.</span><span class="ident" id="1534580">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534589">var</span>&nbsp;<span class="ident" id="1534593">insertv</span>&nbsp;<span class="ident" id="1534601">unsafe</span><span class="op" id="1534607">.</span><span class="ident" id="1534608">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534617">for</span>&nbsp;<span class="op" id="1534621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534625">for</span>&nbsp;<span class="ident" id="1534629">i</span>&nbsp;<span class="op" id="1534631">:=</span>&nbsp;<span class="builtintype" id="1534634">uintptr</span><span class="op" id="1534641">(</span><span class="num" id="1534642">0</span><span class="op" id="1534643">)</span><span class="op" id="1534644">;</span>&nbsp;<span class="ident" id="1534646">i</span>&nbsp;<span class="op" id="1534648">&lt;</span>&nbsp;<span class="ident" id="1534650">bucketCnt</span><span class="op" id="1534659">;</span>&nbsp;<span class="ident" id="1534661">i</span><span class="op" id="1534662">++</span>&nbsp;<span class="op" id="1534665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534670">if</span>&nbsp;<span class="ident" id="1534673">b</span><span class="op" id="1534674">.</span><span class="ident" id="1534675">tophash</span><span class="op" id="1534682">[</span><span class="ident" id="1534683">i</span><span class="op" id="1534684">]</span>&nbsp;<span class="op" id="1534686">!=</span>&nbsp;<span class="ident" id="1534689">top</span>&nbsp;<span class="op" id="1534693">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534699">if</span>&nbsp;<span class="ident" id="1534702">b</span><span class="op" id="1534703">.</span><span class="ident" id="1534704">tophash</span><span class="op" id="1534711">[</span><span class="ident" id="1534712">i</span><span class="op" id="1534713">]</span>&nbsp;<span class="op" id="1534715">==</span>&nbsp;<span class="ident" id="1534718">empty</span>&nbsp;<span class="op" id="1534724">&amp;&amp;</span>&nbsp;<span class="ident" id="1534727">inserti</span>&nbsp;<span class="op" id="1534735">==</span>&nbsp;<span class="ident" id="1534738">nil</span>&nbsp;<span class="op" id="1534742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534749">inserti</span>&nbsp;<span class="op" id="1534757">=</span>&nbsp;<span class="op" id="1534759">&amp;</span><span class="ident" id="1534760">b</span><span class="op" id="1534761">.</span><span class="ident" id="1534762">tophash</span><span class="op" id="1534769">[</span><span class="ident" id="1534770">i</span><span class="op" id="1534771">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534778">insertk</span>&nbsp;<span class="op" id="1534786">=</span>&nbsp;<span class="ident" id="1534788">add</span><span class="op" id="1534791">(</span><span class="ident" id="1534792">unsafe</span><span class="op" id="1534798">.</span><span class="ident" id="1534799">Pointer</span><span class="op" id="1534806">(</span><span class="ident" id="1534807">b</span><span class="op" id="1534808">)</span><span class="op" id="1534809">,</span>&nbsp;<span class="ident" id="1534811">dataOffset</span><span class="op" id="1534821">+</span><span class="ident" id="1534822">i</span><span class="op" id="1534823">*</span><span class="builtintype" id="1534824">uintptr</span><span class="op" id="1534831">(</span><span class="ident" id="1534832">t</span><span class="op" id="1534833">.</span><span class="ident" id="1534834">keysize</span><span class="op" id="1534841">)</span><span class="op" id="1534842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534849">insertv</span>&nbsp;<span class="op" id="1534857">=</span>&nbsp;<span class="ident" id="1534859">add</span><span class="op" id="1534862">(</span><span class="ident" id="1534863">unsafe</span><span class="op" id="1534869">.</span><span class="ident" id="1534870">Pointer</span><span class="op" id="1534877">(</span><span class="ident" id="1534878">b</span><span class="op" id="1534879">)</span><span class="op" id="1534880">,</span>&nbsp;<span class="ident" id="1534882">dataOffset</span><span class="op" id="1534892">+</span><span class="ident" id="1534893">bucketCnt</span><span class="op" id="1534902">*</span><span class="builtintype" id="1534903">uintptr</span><span class="op" id="1534910">(</span><span class="ident" id="1534911">t</span><span class="op" id="1534912">.</span><span class="ident" id="1534913">keysize</span><span class="op" id="1534920">)</span><span class="op" id="1534921">+</span><span class="ident" id="1534922">i</span><span class="op" id="1534923">*</span><span class="builtintype" id="1534924">uintptr</span><span class="op" id="1534931">(</span><span class="ident" id="1534932">t</span><span class="op" id="1534933">.</span><span class="ident" id="1534934">valuesize</span><span class="op" id="1534943">)</span><span class="op" id="1534944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534950">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534956">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534973">k</span>&nbsp;<span class="op" id="1534975">:=</span>&nbsp;<span class="ident" id="1534978">add</span><span class="op" id="1534981">(</span><span class="ident" id="1534982">unsafe</span><span class="op" id="1534988">.</span><span class="ident" id="1534989">Pointer</span><span class="op" id="1534996">(</span><span class="ident" id="1534997">b</span><span class="op" id="1534998">)</span><span class="op" id="1534999">,</span>&nbsp;<span class="ident" id="1535001">dataOffset</span><span class="op" id="1535011">+</span><span class="ident" id="1535012">i</span><span class="op" id="1535013">*</span><span class="builtintype" id="1535014">uintptr</span><span class="op" id="1535021">(</span><span class="ident" id="1535022">t</span><span class="op" id="1535023">.</span><span class="ident" id="1535024">keysize</span><span class="op" id="1535031">)</span><span class="op" id="1535032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535037">k2</span>&nbsp;<span class="op" id="1535040">:=</span>&nbsp;<span class="ident" id="1535043">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535048">if</span>&nbsp;<span class="ident" id="1535051">t</span><span class="op" id="1535052">.</span><span class="ident" id="1535053">indirectkey</span>&nbsp;<span class="op" id="1535065">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535071">k2</span>&nbsp;<span class="op" id="1535074">=</span>&nbsp;<span class="op" id="1535076">*</span><span class="op" id="1535077">(</span><span class="op" id="1535078">(</span><span class="op" id="1535079">*</span><span class="ident" id="1535080">unsafe</span><span class="op" id="1535086">.</span><span class="ident" id="1535087">Pointer</span><span class="op" id="1535094">)</span><span class="op" id="1535095">(</span><span class="ident" id="1535096">k2</span><span class="op" id="1535098">)</span><span class="op" id="1535099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535109">if</span>&nbsp;<span class="op" id="1535112">!</span><span class="ident" id="1535113">alg</span><span class="op" id="1535116">.</span><span class="ident" id="1535117">equal</span><span class="op" id="1535122">(</span><span class="ident" id="1535123">key</span><span class="op" id="1535126">,</span>&nbsp;<span class="ident" id="1535128">k2</span><span class="op" id="1535130">,</span>&nbsp;<span class="builtintype" id="1535132">uintptr</span><span class="op" id="1535139">(</span><span class="ident" id="1535140">t</span><span class="op" id="1535141">.</span><span class="ident" id="1535142">key</span><span class="op" id="1535145">.</span><span class="ident" id="1535146">size</span><span class="op" id="1535150">)</span><span class="op" id="1535151">)</span>&nbsp;<span class="op" id="1535153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535159">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535171">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535176">//&nbsp;already&nbsp;have&nbsp;a&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Update&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535226">memmove</span><span class="op" id="1535233">(</span><span class="ident" id="1535234">k2</span><span class="op" id="1535236">,</span>&nbsp;<span class="ident" id="1535238">key</span><span class="op" id="1535241">,</span>&nbsp;<span class="builtintype" id="1535243">uintptr</span><span class="op" id="1535250">(</span><span class="ident" id="1535251">t</span><span class="op" id="1535252">.</span><span class="ident" id="1535253">key</span><span class="op" id="1535256">.</span><span class="ident" id="1535257">size</span><span class="op" id="1535261">)</span><span class="op" id="1535262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535267">v</span>&nbsp;<span class="op" id="1535269">:=</span>&nbsp;<span class="ident" id="1535272">add</span><span class="op" id="1535275">(</span><span class="ident" id="1535276">unsafe</span><span class="op" id="1535282">.</span><span class="ident" id="1535283">Pointer</span><span class="op" id="1535290">(</span><span class="ident" id="1535291">b</span><span class="op" id="1535292">)</span><span class="op" id="1535293">,</span>&nbsp;<span class="ident" id="1535295">dataOffset</span><span class="op" id="1535305">+</span><span class="ident" id="1535306">bucketCnt</span><span class="op" id="1535315">*</span><span class="builtintype" id="1535316">uintptr</span><span class="op" id="1535323">(</span><span class="ident" id="1535324">t</span><span class="op" id="1535325">.</span><span class="ident" id="1535326">keysize</span><span class="op" id="1535333">)</span><span class="op" id="1535334">+</span><span class="ident" id="1535335">i</span><span class="op" id="1535336">*</span><span class="builtintype" id="1535337">uintptr</span><span class="op" id="1535344">(</span><span class="ident" id="1535345">t</span><span class="op" id="1535346">.</span><span class="ident" id="1535347">valuesize</span><span class="op" id="1535356">)</span><span class="op" id="1535357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535362">v2</span>&nbsp;<span class="op" id="1535365">:=</span>&nbsp;<span class="ident" id="1535368">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535373">if</span>&nbsp;<span class="ident" id="1535376">t</span><span class="op" id="1535377">.</span><span class="ident" id="1535378">indirectvalue</span>&nbsp;<span class="op" id="1535392">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535398">v2</span>&nbsp;<span class="op" id="1535401">=</span>&nbsp;<span class="op" id="1535403">*</span><span class="op" id="1535404">(</span><span class="op" id="1535405">(</span><span class="op" id="1535406">*</span><span class="ident" id="1535407">unsafe</span><span class="op" id="1535413">.</span><span class="ident" id="1535414">Pointer</span><span class="op" id="1535421">)</span><span class="op" id="1535422">(</span><span class="ident" id="1535423">v2</span><span class="op" id="1535425">)</span><span class="op" id="1535426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535436">memmove</span><span class="op" id="1535443">(</span><span class="ident" id="1535444">v2</span><span class="op" id="1535446">,</span>&nbsp;<span class="ident" id="1535448">val</span><span class="op" id="1535451">,</span>&nbsp;<span class="builtintype" id="1535453">uintptr</span><span class="op" id="1535460">(</span><span class="ident" id="1535461">t</span><span class="op" id="1535462">.</span><span class="ident" id="1535463">elem</span><span class="op" id="1535467">.</span><span class="ident" id="1535468">size</span><span class="op" id="1535472">)</span><span class="op" id="1535473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535478">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535487">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535491">if</span>&nbsp;<span class="ident" id="1535494">b</span><span class="op" id="1535495">.</span><span class="ident" id="1535496">overflow</span>&nbsp;<span class="op" id="1535505">==</span>&nbsp;<span class="ident" id="1535508">nil</span>&nbsp;<span class="op" id="1535512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535517">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535529">b</span>&nbsp;<span class="op" id="1535531">=</span>&nbsp;<span class="ident" id="1535533">b</span><span class="op" id="1535534">.</span><span class="ident" id="1535535">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535545">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535549">//&nbsp;did&nbsp;not&nbsp;find&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Allocate&nbsp;new&nbsp;cell&nbsp;&amp;&nbsp;add&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535615">if</span>&nbsp;<span class="builtintype" id="1535618">float32</span><span class="op" id="1535625">(</span><span class="ident" id="1535626">h</span><span class="op" id="1535627">.</span><span class="ident" id="1535628">count</span><span class="op" id="1535633">)</span>&nbsp;<span class="op" id="1535635">&gt;=</span>&nbsp;<span class="ident" id="1535638">loadFactor</span><span class="op" id="1535648">*</span><span class="builtintype" id="1535649">float32</span><span class="op" id="1535656">(</span><span class="op" id="1535657">(</span><span class="builtintype" id="1535658">uintptr</span><span class="op" id="1535665">(</span><span class="num" id="1535666">1</span><span class="op" id="1535667">)</span><span class="op" id="1535668">&lt;&lt;</span><span class="ident" id="1535670">h</span><span class="op" id="1535671">.</span><span class="ident" id="1535672">B</span><span class="op" id="1535673">)</span><span class="op" id="1535674">)</span>&nbsp;<span class="op" id="1535676">&amp;&amp;</span>&nbsp;<span class="ident" id="1535679">h</span><span class="op" id="1535680">.</span><span class="ident" id="1535681">count</span>&nbsp;<span class="op" id="1535687">&gt;=</span>&nbsp;<span class="ident" id="1535690">bucketCnt</span>&nbsp;<span class="op" id="1535700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535704">hashGrow</span><span class="op" id="1535712">(</span><span class="ident" id="1535713">t</span><span class="op" id="1535714">,</span>&nbsp;<span class="ident" id="1535716">h</span><span class="op" id="1535717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535721">goto</span>&nbsp;<span class="ident" id="1535726">again</span>&nbsp;<span class="comment" id="1535732">//&nbsp;Growing&nbsp;the&nbsp;table&nbsp;invalidates&nbsp;everything,&nbsp;so&nbsp;try&nbsp;again</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535795">if</span>&nbsp;<span class="ident" id="1535798">inserti</span>&nbsp;<span class="op" id="1535806">==</span>&nbsp;<span class="ident" id="1535809">nil</span>&nbsp;<span class="op" id="1535813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535817">//&nbsp;all&nbsp;current&nbsp;buckets&nbsp;are&nbsp;full,&nbsp;allocate&nbsp;a&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535872">if</span>&nbsp;<span class="ident" id="1535875">checkgc</span>&nbsp;<span class="op" id="1535883">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535888">memstats</span><span class="op" id="1535896">.</span><span class="ident" id="1535897">next_gc</span>&nbsp;<span class="op" id="1535905">=</span>&nbsp;<span class="ident" id="1535907">memstats</span><span class="op" id="1535915">.</span><span class="ident" id="1535916">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535933">newb</span>&nbsp;<span class="op" id="1535938">:=</span>&nbsp;<span class="op" id="1535941">(</span><span class="op" id="1535942">*</span><span class="ident" id="1535943">bmap</span><span class="op" id="1535947">)</span><span class="op" id="1535948">(</span><span class="ident" id="1535949">newobject</span><span class="op" id="1535958">(</span><span class="ident" id="1535959">t</span><span class="op" id="1535960">.</span><span class="ident" id="1535961">bucket</span><span class="op" id="1535967">)</span><span class="op" id="1535968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535972">b</span><span class="op" id="1535973">.</span><span class="ident" id="1535974">overflow</span>&nbsp;<span class="op" id="1535983">=</span>&nbsp;<span class="ident" id="1535985">newb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535992">inserti</span>&nbsp;<span class="op" id="1536000">=</span>&nbsp;<span class="op" id="1536002">&amp;</span><span class="ident" id="1536003">newb</span><span class="op" id="1536007">.</span><span class="ident" id="1536008">tophash</span><span class="op" id="1536015">[</span><span class="num" id="1536016">0</span><span class="op" id="1536017">]</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536021">insertk</span>&nbsp;<span class="op" id="1536029">=</span>&nbsp;<span class="ident" id="1536031">add</span><span class="op" id="1536034">(</span><span class="ident" id="1536035">unsafe</span><span class="op" id="1536041">.</span><span class="ident" id="1536042">Pointer</span><span class="op" id="1536049">(</span><span class="ident" id="1536050">newb</span><span class="op" id="1536054">)</span><span class="op" id="1536055">,</span>&nbsp;<span class="ident" id="1536057">dataOffset</span><span class="op" id="1536067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536071">insertv</span>&nbsp;<span class="op" id="1536079">=</span>&nbsp;<span class="ident" id="1536081">add</span><span class="op" id="1536084">(</span><span class="ident" id="1536085">insertk</span><span class="op" id="1536092">,</span>&nbsp;<span class="ident" id="1536094">bucketCnt</span><span class="op" id="1536103">*</span><span class="builtintype" id="1536104">uintptr</span><span class="op" id="1536111">(</span><span class="ident" id="1536112">t</span><span class="op" id="1536113">.</span><span class="ident" id="1536114">keysize</span><span class="op" id="1536121">)</span><span class="op" id="1536122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1536129">//&nbsp;store&nbsp;new&nbsp;key/value&nbsp;at&nbsp;insert&nbsp;position</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536172">if</span>&nbsp;<span class="ident" id="1536175">t</span><span class="op" id="1536176">.</span><span class="ident" id="1536177">indirectkey</span>&nbsp;<span class="op" id="1536189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536193">if</span>&nbsp;<span class="ident" id="1536196">checkgc</span>&nbsp;<span class="op" id="1536204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536209">memstats</span><span class="op" id="1536217">.</span><span class="ident" id="1536218">next_gc</span>&nbsp;<span class="op" id="1536226">=</span>&nbsp;<span class="ident" id="1536228">memstats</span><span class="op" id="1536236">.</span><span class="ident" id="1536237">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536254">kmem</span>&nbsp;<span class="op" id="1536259">:=</span>&nbsp;<span class="ident" id="1536262">newobject</span><span class="op" id="1536271">(</span><span class="ident" id="1536272">t</span><span class="op" id="1536273">.</span><span class="ident" id="1536274">key</span><span class="op" id="1536277">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536281">*</span><span class="op" id="1536282">(</span><span class="op" id="1536283">*</span><span class="ident" id="1536284">unsafe</span><span class="op" id="1536290">.</span><span class="ident" id="1536291">Pointer</span><span class="op" id="1536298">)</span><span class="op" id="1536299">(</span><span class="ident" id="1536300">insertk</span><span class="op" id="1536307">)</span>&nbsp;<span class="op" id="1536309">=</span>&nbsp;<span class="ident" id="1536311">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536318">insertk</span>&nbsp;<span class="op" id="1536326">=</span>&nbsp;<span class="ident" id="1536328">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536337">if</span>&nbsp;<span class="ident" id="1536340">t</span><span class="op" id="1536341">.</span><span class="ident" id="1536342">indirectvalue</span>&nbsp;<span class="op" id="1536356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536360">if</span>&nbsp;<span class="ident" id="1536363">checkgc</span>&nbsp;<span class="op" id="1536371">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536376">memstats</span><span class="op" id="1536384">.</span><span class="ident" id="1536385">next_gc</span>&nbsp;<span class="op" id="1536393">=</span>&nbsp;<span class="ident" id="1536395">memstats</span><span class="op" id="1536403">.</span><span class="ident" id="1536404">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536421">vmem</span>&nbsp;<span class="op" id="1536426">:=</span>&nbsp;<span class="ident" id="1536429">newobject</span><span class="op" id="1536438">(</span><span class="ident" id="1536439">t</span><span class="op" id="1536440">.</span><span class="ident" id="1536441">elem</span><span class="op" id="1536445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536449">*</span><span class="op" id="1536450">(</span><span class="op" id="1536451">*</span><span class="ident" id="1536452">unsafe</span><span class="op" id="1536458">.</span><span class="ident" id="1536459">Pointer</span><span class="op" id="1536466">)</span><span class="op" id="1536467">(</span><span class="ident" id="1536468">insertv</span><span class="op" id="1536475">)</span>&nbsp;<span class="op" id="1536477">=</span>&nbsp;<span class="ident" id="1536479">vmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536486">insertv</span>&nbsp;<span class="op" id="1536494">=</span>&nbsp;<span class="ident" id="1536496">vmem</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536505">memmove</span><span class="op" id="1536512">(</span><span class="ident" id="1536513">insertk</span><span class="op" id="1536520">,</span>&nbsp;<span class="ident" id="1536522">key</span><span class="op" id="1536525">,</span>&nbsp;<span class="builtintype" id="1536527">uintptr</span><span class="op" id="1536534">(</span><span class="ident" id="1536535">t</span><span class="op" id="1536536">.</span><span class="ident" id="1536537">key</span><span class="op" id="1536540">.</span><span class="ident" id="1536541">size</span><span class="op" id="1536545">)</span><span class="op" id="1536546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536549">memmove</span><span class="op" id="1536556">(</span><span class="ident" id="1536557">insertv</span><span class="op" id="1536564">,</span>&nbsp;<span class="ident" id="1536566">val</span><span class="op" id="1536569">,</span>&nbsp;<span class="builtintype" id="1536571">uintptr</span><span class="op" id="1536578">(</span><span class="ident" id="1536579">t</span><span class="op" id="1536580">.</span><span class="ident" id="1536581">elem</span><span class="op" id="1536585">.</span><span class="ident" id="1536586">size</span><span class="op" id="1536590">)</span><span class="op" id="1536591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536594">*</span><span class="ident" id="1536595">inserti</span>&nbsp;<span class="op" id="1536603">=</span>&nbsp;<span class="ident" id="1536605">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536610">h</span><span class="op" id="1536611">.</span><span class="ident" id="1536612">count</span><span class="op" id="1536617">++</span><br>
<span class="lineno">485</span><span class="op" id="1536620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1536623">func</span>&nbsp;<span class="ident" id="1536628">mapdelete</span><span class="op" id="1536637">(</span><span class="ident" id="1536638">t</span>&nbsp;<span class="op" id="1536640">*</span><span class="ident" id="1536641">maptype</span><span class="op" id="1536648">,</span>&nbsp;<span class="ident" id="1536650">h</span>&nbsp;<span class="op" id="1536652">*</span><span class="ident" id="1536653">hmap</span><span class="op" id="1536657">,</span>&nbsp;<span class="ident" id="1536659">key</span>&nbsp;<span class="ident" id="1536663">unsafe</span><span class="op" id="1536669">.</span><span class="ident" id="1536670">Pointer</span><span class="op" id="1536677">)</span>&nbsp;<span class="op" id="1536679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536682">if</span>&nbsp;<span class="ident" id="1536685">raceenabled</span>&nbsp;<span class="op" id="1536697">&amp;&amp;</span>&nbsp;<span class="ident" id="1536700">h</span>&nbsp;<span class="op" id="1536702">!=</span>&nbsp;<span class="ident" id="1536705">nil</span>&nbsp;<span class="op" id="1536709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536713">callerpc</span>&nbsp;<span class="op" id="1536722">:=</span>&nbsp;<span class="ident" id="1536725">getcallerpc</span><span class="op" id="1536736">(</span><span class="ident" id="1536737">unsafe</span><span class="op" id="1536743">.</span><span class="ident" id="1536744">Pointer</span><span class="op" id="1536751">(</span><span class="op" id="1536752">&amp;</span><span class="ident" id="1536753">t</span><span class="op" id="1536754">)</span><span class="op" id="1536755">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536759">pc</span>&nbsp;<span class="op" id="1536762">:=</span>&nbsp;<span class="ident" id="1536765">funcPC</span><span class="op" id="1536771">(</span><span class="ident" id="1536772">mapdelete</span><span class="op" id="1536781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536785">racewritepc</span><span class="op" id="1536796">(</span><span class="ident" id="1536797">unsafe</span><span class="op" id="1536803">.</span><span class="ident" id="1536804">Pointer</span><span class="op" id="1536811">(</span><span class="ident" id="1536812">h</span><span class="op" id="1536813">)</span><span class="op" id="1536814">,</span>&nbsp;<span class="ident" id="1536816">callerpc</span><span class="op" id="1536824">,</span>&nbsp;<span class="ident" id="1536826">pc</span><span class="op" id="1536828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536832">raceReadObjectPC</span><span class="op" id="1536848">(</span><span class="ident" id="1536849">t</span><span class="op" id="1536850">.</span><span class="ident" id="1536851">key</span><span class="op" id="1536854">,</span>&nbsp;<span class="ident" id="1536856">key</span><span class="op" id="1536859">,</span>&nbsp;<span class="ident" id="1536861">callerpc</span><span class="op" id="1536869">,</span>&nbsp;<span class="ident" id="1536871">pc</span><span class="op" id="1536873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536879">if</span>&nbsp;<span class="ident" id="1536882">h</span>&nbsp;<span class="op" id="1536884">==</span>&nbsp;<span class="ident" id="1536887">nil</span>&nbsp;<span class="op" id="1536891">||</span>&nbsp;<span class="ident" id="1536894">h</span><span class="op" id="1536895">.</span><span class="ident" id="1536896">count</span>&nbsp;<span class="op" id="1536902">==</span>&nbsp;<span class="num" id="1536905">0</span>&nbsp;<span class="op" id="1536907">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536911">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536922">alg</span>&nbsp;<span class="op" id="1536926">:=</span>&nbsp;<span class="ident" id="1536929">goalg</span><span class="op" id="1536934">(</span><span class="ident" id="1536935">t</span><span class="op" id="1536936">.</span><span class="ident" id="1536937">key</span><span class="op" id="1536940">.</span><span class="ident" id="1536941">alg</span><span class="op" id="1536944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536947">hash</span>&nbsp;<span class="op" id="1536952">:=</span>&nbsp;<span class="ident" id="1536955">alg</span><span class="op" id="1536958">.</span><span class="ident" id="1536959">hash</span><span class="op" id="1536963">(</span><span class="ident" id="1536964">key</span><span class="op" id="1536967">,</span>&nbsp;<span class="builtintype" id="1536969">uintptr</span><span class="op" id="1536976">(</span><span class="ident" id="1536977">t</span><span class="op" id="1536978">.</span><span class="ident" id="1536979">key</span><span class="op" id="1536982">.</span><span class="ident" id="1536983">size</span><span class="op" id="1536987">)</span><span class="op" id="1536988">,</span>&nbsp;<span class="builtintype" id="1536990">uintptr</span><span class="op" id="1536997">(</span><span class="ident" id="1536998">h</span><span class="op" id="1536999">.</span><span class="ident" id="1537000">hash0</span><span class="op" id="1537005">)</span><span class="op" id="1537006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537009">bucket</span>&nbsp;<span class="op" id="1537016">:=</span>&nbsp;<span class="ident" id="1537019">hash</span>&nbsp;<span class="op" id="1537024">&amp;</span>&nbsp;<span class="op" id="1537026">(</span><span class="builtintype" id="1537027">uintptr</span><span class="op" id="1537034">(</span><span class="num" id="1537035">1</span><span class="op" id="1537036">)</span><span class="op" id="1537037">&lt;&lt;</span><span class="ident" id="1537039">h</span><span class="op" id="1537040">.</span><span class="ident" id="1537041">B</span>&nbsp;<span class="op" id="1537043">-</span>&nbsp;<span class="num" id="1537045">1</span><span class="op" id="1537046">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537049">if</span>&nbsp;<span class="ident" id="1537052">h</span><span class="op" id="1537053">.</span><span class="ident" id="1537054">oldbuckets</span>&nbsp;<span class="op" id="1537065">!=</span>&nbsp;<span class="ident" id="1537068">nil</span>&nbsp;<span class="op" id="1537072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537076">growWork</span><span class="op" id="1537084">(</span><span class="ident" id="1537085">t</span><span class="op" id="1537086">,</span>&nbsp;<span class="ident" id="1537088">h</span><span class="op" id="1537089">,</span>&nbsp;<span class="ident" id="1537091">bucket</span><span class="op" id="1537097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537103">b</span>&nbsp;<span class="op" id="1537105">:=</span>&nbsp;<span class="op" id="1537108">(</span><span class="op" id="1537109">*</span><span class="ident" id="1537110">bmap</span><span class="op" id="1537114">)</span><span class="op" id="1537115">(</span><span class="ident" id="1537116">unsafe</span><span class="op" id="1537122">.</span><span class="ident" id="1537123">Pointer</span><span class="op" id="1537130">(</span><span class="builtintype" id="1537131">uintptr</span><span class="op" id="1537138">(</span><span class="ident" id="1537139">h</span><span class="op" id="1537140">.</span><span class="ident" id="1537141">buckets</span><span class="op" id="1537148">)</span>&nbsp;<span class="op" id="1537150">+</span>&nbsp;<span class="ident" id="1537152">bucket</span><span class="op" id="1537158">*</span><span class="builtintype" id="1537159">uintptr</span><span class="op" id="1537166">(</span><span class="ident" id="1537167">t</span><span class="op" id="1537168">.</span><span class="ident" id="1537169">bucketsize</span><span class="op" id="1537179">)</span><span class="op" id="1537180">)</span><span class="op" id="1537181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537184">top</span>&nbsp;<span class="op" id="1537188">:=</span>&nbsp;<span class="builtintype" id="1537191">uint8</span><span class="op" id="1537196">(</span><span class="ident" id="1537197">hash</span>&nbsp;<span class="op" id="1537202">&gt;&gt;</span>&nbsp;<span class="op" id="1537205">(</span><span class="ident" id="1537206">ptrSize</span><span class="op" id="1537213">*</span><span class="num" id="1537214">8</span>&nbsp;<span class="op" id="1537216">-</span>&nbsp;<span class="num" id="1537218">8</span><span class="op" id="1537219">)</span><span class="op" id="1537220">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537223">if</span>&nbsp;<span class="ident" id="1537226">top</span>&nbsp;<span class="op" id="1537230">&lt;</span>&nbsp;<span class="ident" id="1537232">minTopHash</span>&nbsp;<span class="op" id="1537243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537247">top</span>&nbsp;<span class="op" id="1537251">+=</span>&nbsp;<span class="ident" id="1537254">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537269">for</span>&nbsp;<span class="op" id="1537273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537277">for</span>&nbsp;<span class="ident" id="1537281">i</span>&nbsp;<span class="op" id="1537283">:=</span>&nbsp;<span class="builtintype" id="1537286">uintptr</span><span class="op" id="1537293">(</span><span class="num" id="1537294">0</span><span class="op" id="1537295">)</span><span class="op" id="1537296">;</span>&nbsp;<span class="ident" id="1537298">i</span>&nbsp;<span class="op" id="1537300">&lt;</span>&nbsp;<span class="ident" id="1537302">bucketCnt</span><span class="op" id="1537311">;</span>&nbsp;<span class="ident" id="1537313">i</span><span class="op" id="1537314">++</span>&nbsp;<span class="op" id="1537317">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537322">if</span>&nbsp;<span class="ident" id="1537325">b</span><span class="op" id="1537326">.</span><span class="ident" id="1537327">tophash</span><span class="op" id="1537334">[</span><span class="ident" id="1537335">i</span><span class="op" id="1537336">]</span>&nbsp;<span class="op" id="1537338">!=</span>&nbsp;<span class="ident" id="1537341">top</span>&nbsp;<span class="op" id="1537345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537351">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537368">k</span>&nbsp;<span class="op" id="1537370">:=</span>&nbsp;<span class="ident" id="1537373">add</span><span class="op" id="1537376">(</span><span class="ident" id="1537377">unsafe</span><span class="op" id="1537383">.</span><span class="ident" id="1537384">Pointer</span><span class="op" id="1537391">(</span><span class="ident" id="1537392">b</span><span class="op" id="1537393">)</span><span class="op" id="1537394">,</span>&nbsp;<span class="ident" id="1537396">dataOffset</span><span class="op" id="1537406">+</span><span class="ident" id="1537407">i</span><span class="op" id="1537408">*</span><span class="builtintype" id="1537409">uintptr</span><span class="op" id="1537416">(</span><span class="ident" id="1537417">t</span><span class="op" id="1537418">.</span><span class="ident" id="1537419">keysize</span><span class="op" id="1537426">)</span><span class="op" id="1537427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537432">k2</span>&nbsp;<span class="op" id="1537435">:=</span>&nbsp;<span class="ident" id="1537438">k</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537443">if</span>&nbsp;<span class="ident" id="1537446">t</span><span class="op" id="1537447">.</span><span class="ident" id="1537448">indirectkey</span>&nbsp;<span class="op" id="1537460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537466">k2</span>&nbsp;<span class="op" id="1537469">=</span>&nbsp;<span class="op" id="1537471">*</span><span class="op" id="1537472">(</span><span class="op" id="1537473">(</span><span class="op" id="1537474">*</span><span class="ident" id="1537475">unsafe</span><span class="op" id="1537481">.</span><span class="ident" id="1537482">Pointer</span><span class="op" id="1537489">)</span><span class="op" id="1537490">(</span><span class="ident" id="1537491">k2</span><span class="op" id="1537493">)</span><span class="op" id="1537494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537504">if</span>&nbsp;<span class="op" id="1537507">!</span><span class="ident" id="1537508">alg</span><span class="op" id="1537511">.</span><span class="ident" id="1537512">equal</span><span class="op" id="1537517">(</span><span class="ident" id="1537518">key</span><span class="op" id="1537521">,</span>&nbsp;<span class="ident" id="1537523">k2</span><span class="op" id="1537525">,</span>&nbsp;<span class="builtintype" id="1537527">uintptr</span><span class="op" id="1537534">(</span><span class="ident" id="1537535">t</span><span class="op" id="1537536">.</span><span class="ident" id="1537537">key</span><span class="op" id="1537540">.</span><span class="ident" id="1537541">size</span><span class="op" id="1537545">)</span><span class="op" id="1537546">)</span>&nbsp;<span class="op" id="1537548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537554">continue</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537571">memclr</span><span class="op" id="1537577">(</span><span class="ident" id="1537578">k</span><span class="op" id="1537579">,</span>&nbsp;<span class="builtintype" id="1537581">uintptr</span><span class="op" id="1537588">(</span><span class="ident" id="1537589">t</span><span class="op" id="1537590">.</span><span class="ident" id="1537591">keysize</span><span class="op" id="1537598">)</span><span class="op" id="1537599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537604">v</span>&nbsp;<span class="op" id="1537606">:=</span>&nbsp;<span class="ident" id="1537609">unsafe</span><span class="op" id="1537615">.</span><span class="ident" id="1537616">Pointer</span><span class="op" id="1537623">(</span><span class="builtintype" id="1537624">uintptr</span><span class="op" id="1537631">(</span><span class="ident" id="1537632">unsafe</span><span class="op" id="1537638">.</span><span class="ident" id="1537639">Pointer</span><span class="op" id="1537646">(</span><span class="ident" id="1537647">b</span><span class="op" id="1537648">)</span><span class="op" id="1537649">)</span>&nbsp;<span class="op" id="1537651">+</span>&nbsp;<span class="ident" id="1537653">dataOffset</span>&nbsp;<span class="op" id="1537664">+</span>&nbsp;<span class="ident" id="1537666">bucketCnt</span><span class="op" id="1537675">*</span><span class="builtintype" id="1537676">uintptr</span><span class="op" id="1537683">(</span><span class="ident" id="1537684">t</span><span class="op" id="1537685">.</span><span class="ident" id="1537686">keysize</span><span class="op" id="1537693">)</span>&nbsp;<span class="op" id="1537695">+</span>&nbsp;<span class="ident" id="1537697">i</span><span class="op" id="1537698">*</span><span class="builtintype" id="1537699">uintptr</span><span class="op" id="1537706">(</span><span class="ident" id="1537707">t</span><span class="op" id="1537708">.</span><span class="ident" id="1537709">valuesize</span><span class="op" id="1537718">)</span><span class="op" id="1537719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537724">memclr</span><span class="op" id="1537730">(</span><span class="ident" id="1537731">v</span><span class="op" id="1537732">,</span>&nbsp;<span class="builtintype" id="1537734">uintptr</span><span class="op" id="1537741">(</span><span class="ident" id="1537742">t</span><span class="op" id="1537743">.</span><span class="ident" id="1537744">valuesize</span><span class="op" id="1537753">)</span><span class="op" id="1537754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537759">b</span><span class="op" id="1537760">.</span><span class="ident" id="1537761">tophash</span><span class="op" id="1537768">[</span><span class="ident" id="1537769">i</span><span class="op" id="1537770">]</span>&nbsp;<span class="op" id="1537772">=</span>&nbsp;<span class="ident" id="1537774">empty</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537783">h</span><span class="op" id="1537784">.</span><span class="ident" id="1537785">count</span><span class="op" id="1537790">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537796">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537809">b</span>&nbsp;<span class="op" id="1537811">=</span>&nbsp;<span class="ident" id="1537813">b</span><span class="op" id="1537814">.</span><span class="ident" id="1537815">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537826">if</span>&nbsp;<span class="ident" id="1537829">b</span>&nbsp;<span class="op" id="1537831">==</span>&nbsp;<span class="ident" id="1537834">nil</span>&nbsp;<span class="op" id="1537838">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537843">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537855">}</span><br>
<span class="lineno"></span><span class="op" id="1537857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="1537860">func</span>&nbsp;<span class="ident" id="1537865">mapiterinit</span><span class="op" id="1537876">(</span><span class="ident" id="1537877">t</span>&nbsp;<span class="op" id="1537879">*</span><span class="ident" id="1537880">maptype</span><span class="op" id="1537887">,</span>&nbsp;<span class="ident" id="1537889">h</span>&nbsp;<span class="op" id="1537891">*</span><span class="ident" id="1537892">hmap</span><span class="op" id="1537896">,</span>&nbsp;<span class="ident" id="1537898">it</span>&nbsp;<span class="op" id="1537901">*</span><span class="ident" id="1537902">hiter</span><span class="op" id="1537907">)</span>&nbsp;<span class="op" id="1537909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537912">//&nbsp;Clear&nbsp;pointer&nbsp;fields&nbsp;so&nbsp;garbage&nbsp;collector&nbsp;does&nbsp;not&nbsp;complain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537977">it</span><span class="op" id="1537979">.</span><span class="ident" id="1537980">key</span>&nbsp;<span class="op" id="1537984">=</span>&nbsp;<span class="ident" id="1537986">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537991">it</span><span class="op" id="1537993">.</span><span class="ident" id="1537994">value</span>&nbsp;<span class="op" id="1538000">=</span>&nbsp;<span class="ident" id="1538002">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538007">it</span><span class="op" id="1538009">.</span><span class="ident" id="1538010">t</span>&nbsp;<span class="op" id="1538012">=</span>&nbsp;<span class="ident" id="1538014">nil</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538019">it</span><span class="op" id="1538021">.</span><span class="ident" id="1538022">h</span>&nbsp;<span class="op" id="1538024">=</span>&nbsp;<span class="ident" id="1538026">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538031">it</span><span class="op" id="1538033">.</span><span class="ident" id="1538034">buckets</span>&nbsp;<span class="op" id="1538042">=</span>&nbsp;<span class="ident" id="1538044">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538049">it</span><span class="op" id="1538051">.</span><span class="ident" id="1538052">bptr</span>&nbsp;<span class="op" id="1538057">=</span>&nbsp;<span class="ident" id="1538059">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538065">if</span>&nbsp;<span class="ident" id="1538068">raceenabled</span>&nbsp;<span class="op" id="1538080">&amp;&amp;</span>&nbsp;<span class="ident" id="1538083">h</span>&nbsp;<span class="op" id="1538085">!=</span>&nbsp;<span class="ident" id="1538088">nil</span>&nbsp;<span class="op" id="1538092">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538096">callerpc</span>&nbsp;<span class="op" id="1538105">:=</span>&nbsp;<span class="ident" id="1538108">getcallerpc</span><span class="op" id="1538119">(</span><span class="ident" id="1538120">unsafe</span><span class="op" id="1538126">.</span><span class="ident" id="1538127">Pointer</span><span class="op" id="1538134">(</span><span class="op" id="1538135">&amp;</span><span class="ident" id="1538136">t</span><span class="op" id="1538137">)</span><span class="op" id="1538138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538142">racereadpc</span><span class="op" id="1538152">(</span><span class="ident" id="1538153">unsafe</span><span class="op" id="1538159">.</span><span class="ident" id="1538160">Pointer</span><span class="op" id="1538167">(</span><span class="ident" id="1538168">h</span><span class="op" id="1538169">)</span><span class="op" id="1538170">,</span>&nbsp;<span class="ident" id="1538172">callerpc</span><span class="op" id="1538180">,</span>&nbsp;<span class="ident" id="1538182">funcPC</span><span class="op" id="1538188">(</span><span class="ident" id="1538189">mapiterinit</span><span class="op" id="1538200">)</span><span class="op" id="1538201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538208">if</span>&nbsp;<span class="ident" id="1538211">h</span>&nbsp;<span class="op" id="1538213">==</span>&nbsp;<span class="ident" id="1538216">nil</span>&nbsp;<span class="op" id="1538220">||</span>&nbsp;<span class="ident" id="1538223">h</span><span class="op" id="1538224">.</span><span class="ident" id="1538225">count</span>&nbsp;<span class="op" id="1538231">==</span>&nbsp;<span class="num" id="1538234">0</span>&nbsp;<span class="op" id="1538236">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538240">it</span><span class="op" id="1538242">.</span><span class="ident" id="1538243">key</span>&nbsp;<span class="op" id="1538247">=</span>&nbsp;<span class="ident" id="1538249">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538255">it</span><span class="op" id="1538257">.</span><span class="ident" id="1538258">value</span>&nbsp;<span class="op" id="1538264">=</span>&nbsp;<span class="ident" id="1538266">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538272">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538284">if</span>&nbsp;<span class="ident" id="1538287">unsafe</span><span class="op" id="1538293">.</span><span class="ident" id="1538294">Sizeof</span><span class="op" id="1538300">(</span><span class="ident" id="1538301">hiter</span><span class="op" id="1538306">{</span><span class="op" id="1538307">}</span><span class="op" id="1538308">)</span><span class="op" id="1538309">/</span><span class="ident" id="1538310">ptrSize</span>&nbsp;<span class="op" id="1538318">!=</span>&nbsp;<span class="num" id="1538321">10</span>&nbsp;<span class="op" id="1538324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538328">gothrow</span><span class="op" id="1538335">(</span><span class="string" id="1538336">&#34;hash_iter&nbsp;size&nbsp;incorrect&#34;</span><span class="op" id="1538362">)</span>&nbsp;<span class="comment" id="1538364">//&nbsp;see&nbsp;../../cmd/gc/reflect.c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538398">it</span><span class="op" id="1538400">.</span><span class="ident" id="1538401">t</span>&nbsp;<span class="op" id="1538403">=</span>&nbsp;<span class="ident" id="1538405">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538408">it</span><span class="op" id="1538410">.</span><span class="ident" id="1538411">h</span>&nbsp;<span class="op" id="1538413">=</span>&nbsp;<span class="ident" id="1538415">h</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538419">//&nbsp;grab&nbsp;snapshot&nbsp;of&nbsp;bucket&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538453">it</span><span class="op" id="1538455">.</span><span class="ident" id="1538456">B</span>&nbsp;<span class="op" id="1538458">=</span>&nbsp;<span class="ident" id="1538460">h</span><span class="op" id="1538461">.</span><span class="ident" id="1538462">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538465">it</span><span class="op" id="1538467">.</span><span class="ident" id="1538468">buckets</span>&nbsp;<span class="op" id="1538476">=</span>&nbsp;<span class="ident" id="1538478">h</span><span class="op" id="1538479">.</span><span class="ident" id="1538480">buckets</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538490">//&nbsp;decide&nbsp;where&nbsp;to&nbsp;start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538516">r</span>&nbsp;<span class="op" id="1538518">:=</span>&nbsp;<span class="builtintype" id="1538521">uintptr</span><span class="op" id="1538528">(</span><span class="ident" id="1538529">fastrand1</span><span class="op" id="1538538">(</span><span class="op" id="1538539">)</span><span class="op" id="1538540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538543">if</span>&nbsp;<span class="ident" id="1538546">h</span><span class="op" id="1538547">.</span><span class="ident" id="1538548">B</span>&nbsp;<span class="op" id="1538550">&gt;</span>&nbsp;<span class="num" id="1538552">31</span><span class="op" id="1538554">-</span><span class="ident" id="1538555">bucketCntBits</span>&nbsp;<span class="op" id="1538569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538573">r</span>&nbsp;<span class="op" id="1538575">+=</span>&nbsp;<span class="builtintype" id="1538578">uintptr</span><span class="op" id="1538585">(</span><span class="ident" id="1538586">fastrand1</span><span class="op" id="1538595">(</span><span class="op" id="1538596">)</span><span class="op" id="1538597">)</span>&nbsp;<span class="op" id="1538599">&lt;&lt;</span>&nbsp;<span class="num" id="1538602">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538606">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538609">it</span><span class="op" id="1538611">.</span><span class="ident" id="1538612">startBucket</span>&nbsp;<span class="op" id="1538624">=</span>&nbsp;<span class="ident" id="1538626">r</span>&nbsp;<span class="op" id="1538628">&amp;</span>&nbsp;<span class="op" id="1538630">(</span><span class="builtintype" id="1538631">uintptr</span><span class="op" id="1538638">(</span><span class="num" id="1538639">1</span><span class="op" id="1538640">)</span><span class="op" id="1538641">&lt;&lt;</span><span class="ident" id="1538643">h</span><span class="op" id="1538644">.</span><span class="ident" id="1538645">B</span>&nbsp;<span class="op" id="1538647">-</span>&nbsp;<span class="num" id="1538649">1</span><span class="op" id="1538650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538653">it</span><span class="op" id="1538655">.</span><span class="ident" id="1538656">offset</span>&nbsp;<span class="op" id="1538663">=</span>&nbsp;<span class="builtintype" id="1538665">uint8</span><span class="op" id="1538670">(</span><span class="ident" id="1538671">r</span>&nbsp;<span class="op" id="1538673">&gt;&gt;</span>&nbsp;<span class="ident" id="1538676">h</span><span class="op" id="1538677">.</span><span class="ident" id="1538678">B</span>&nbsp;<span class="op" id="1538680">&amp;</span>&nbsp;<span class="op" id="1538682">(</span><span class="ident" id="1538683">bucketCnt</span>&nbsp;<span class="op" id="1538693">-</span>&nbsp;<span class="num" id="1538695">1</span><span class="op" id="1538696">)</span><span class="op" id="1538697">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538701">//&nbsp;iterator&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538720">it</span><span class="op" id="1538722">.</span><span class="ident" id="1538723">bucket</span>&nbsp;<span class="op" id="1538730">=</span>&nbsp;<span class="ident" id="1538732">it</span><span class="op" id="1538734">.</span><span class="ident" id="1538735">startBucket</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538748">it</span><span class="op" id="1538750">.</span><span class="ident" id="1538751">wrapped</span>&nbsp;<span class="op" id="1538759">=</span>&nbsp;<span class="ident" id="1538761">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538768">it</span><span class="op" id="1538770">.</span><span class="ident" id="1538771">bptr</span>&nbsp;<span class="op" id="1538776">=</span>&nbsp;<span class="ident" id="1538778">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538784">//&nbsp;Remember&nbsp;we&nbsp;have&nbsp;an&nbsp;iterator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538818">//&nbsp;Can&nbsp;run&nbsp;concurrently&nbsp;with&nbsp;another&nbsp;hash_iter_init().</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538874">for</span>&nbsp;<span class="op" id="1538878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538882">old</span>&nbsp;<span class="op" id="1538886">:=</span>&nbsp;<span class="ident" id="1538889">h</span><span class="op" id="1538890">.</span><span class="ident" id="1538891">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538899">if</span>&nbsp;<span class="ident" id="1538902">old</span>&nbsp;<span class="op" id="1538906">==</span>&nbsp;<span class="ident" id="1538909">old</span><span class="op" id="1538912">|</span><span class="ident" id="1538913">iterator</span><span class="op" id="1538921">|</span><span class="ident" id="1538922">oldIterator</span>&nbsp;<span class="op" id="1538934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538939">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538947">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538951">if</span>&nbsp;<span class="ident" id="1538954">cas</span><span class="op" id="1538957">(</span><span class="op" id="1538958">&amp;</span><span class="ident" id="1538959">h</span><span class="op" id="1538960">.</span><span class="ident" id="1538961">flags</span><span class="op" id="1538966">,</span>&nbsp;<span class="ident" id="1538968">old</span><span class="op" id="1538971">,</span>&nbsp;<span class="ident" id="1538973">old</span><span class="op" id="1538976">|</span><span class="ident" id="1538977">iterator</span><span class="op" id="1538985">|</span><span class="ident" id="1538986">oldIterator</span><span class="op" id="1538997">)</span>&nbsp;<span class="op" id="1538999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539004">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539019">mapiternext</span><span class="op" id="1539030">(</span><span class="ident" id="1539031">it</span><span class="op" id="1539033">)</span><br>
<span class="lineno"></span><span class="op" id="1539035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1539038">func</span>&nbsp;<span class="ident" id="1539043">mapiternext</span><span class="op" id="1539054">(</span><span class="ident" id="1539055">it</span>&nbsp;<span class="op" id="1539058">*</span><span class="ident" id="1539059">hiter</span><span class="op" id="1539064">)</span>&nbsp;<span class="op" id="1539066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539069">h</span>&nbsp;<span class="op" id="1539071">:=</span>&nbsp;<span class="ident" id="1539074">it</span><span class="op" id="1539076">.</span><span class="ident" id="1539077">h</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539080">if</span>&nbsp;<span class="ident" id="1539083">raceenabled</span>&nbsp;<span class="op" id="1539095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539099">callerpc</span>&nbsp;<span class="op" id="1539108">:=</span>&nbsp;<span class="ident" id="1539111">getcallerpc</span><span class="op" id="1539122">(</span><span class="ident" id="1539123">unsafe</span><span class="op" id="1539129">.</span><span class="ident" id="1539130">Pointer</span><span class="op" id="1539137">(</span><span class="op" id="1539138">&amp;</span><span class="ident" id="1539139">it</span><span class="op" id="1539141">)</span><span class="op" id="1539142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539146">racereadpc</span><span class="op" id="1539156">(</span><span class="ident" id="1539157">unsafe</span><span class="op" id="1539163">.</span><span class="ident" id="1539164">Pointer</span><span class="op" id="1539171">(</span><span class="ident" id="1539172">h</span><span class="op" id="1539173">)</span><span class="op" id="1539174">,</span>&nbsp;<span class="ident" id="1539176">callerpc</span><span class="op" id="1539184">,</span>&nbsp;<span class="ident" id="1539186">funcPC</span><span class="op" id="1539192">(</span><span class="ident" id="1539193">mapiternext</span><span class="op" id="1539204">)</span><span class="op" id="1539205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539211">t</span>&nbsp;<span class="op" id="1539213">:=</span>&nbsp;<span class="ident" id="1539216">it</span><span class="op" id="1539218">.</span><span class="ident" id="1539219">t</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539222">bucket</span>&nbsp;<span class="op" id="1539229">:=</span>&nbsp;<span class="ident" id="1539232">it</span><span class="op" id="1539234">.</span><span class="ident" id="1539235">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539243">b</span>&nbsp;<span class="op" id="1539245">:=</span>&nbsp;<span class="ident" id="1539248">it</span><span class="op" id="1539250">.</span><span class="ident" id="1539251">bptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539257">i</span>&nbsp;<span class="op" id="1539259">:=</span>&nbsp;<span class="ident" id="1539262">it</span><span class="op" id="1539264">.</span><span class="ident" id="1539265">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539268">checkBucket</span>&nbsp;<span class="op" id="1539280">:=</span>&nbsp;<span class="ident" id="1539283">it</span><span class="op" id="1539285">.</span><span class="ident" id="1539286">checkBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539299">alg</span>&nbsp;<span class="op" id="1539303">:=</span>&nbsp;<span class="ident" id="1539306">goalg</span><span class="op" id="1539311">(</span><span class="ident" id="1539312">t</span><span class="op" id="1539313">.</span><span class="ident" id="1539314">key</span><span class="op" id="1539317">.</span><span class="ident" id="1539318">alg</span><span class="op" id="1539321">)</span><br>
<span class="lineno">605</span><br>
<span class="lineno"></span><span class="ident" id="1539324">next</span><span class="op" id="1539328">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539331">if</span>&nbsp;<span class="ident" id="1539334">b</span>&nbsp;<span class="op" id="1539336">==</span>&nbsp;<span class="ident" id="1539339">nil</span>&nbsp;<span class="op" id="1539343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539347">if</span>&nbsp;<span class="ident" id="1539350">bucket</span>&nbsp;<span class="op" id="1539357">==</span>&nbsp;<span class="ident" id="1539360">it</span><span class="op" id="1539362">.</span><span class="ident" id="1539363">startBucket</span>&nbsp;<span class="op" id="1539375">&amp;&amp;</span>&nbsp;<span class="ident" id="1539378">it</span><span class="op" id="1539380">.</span><span class="ident" id="1539381">wrapped</span>&nbsp;<span class="op" id="1539389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539394">//&nbsp;end&nbsp;of&nbsp;iteration</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539417">it</span><span class="op" id="1539419">.</span><span class="ident" id="1539420">key</span>&nbsp;<span class="op" id="1539424">=</span>&nbsp;<span class="ident" id="1539426">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539433">it</span><span class="op" id="1539435">.</span><span class="ident" id="1539436">value</span>&nbsp;<span class="op" id="1539442">=</span>&nbsp;<span class="ident" id="1539444">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539451">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539464">if</span>&nbsp;<span class="ident" id="1539467">h</span><span class="op" id="1539468">.</span><span class="ident" id="1539469">oldbuckets</span>&nbsp;<span class="op" id="1539480">!=</span>&nbsp;<span class="ident" id="1539483">nil</span>&nbsp;<span class="op" id="1539487">&amp;&amp;</span>&nbsp;<span class="ident" id="1539490">it</span><span class="op" id="1539492">.</span><span class="ident" id="1539493">B</span>&nbsp;<span class="op" id="1539495">==</span>&nbsp;<span class="ident" id="1539498">h</span><span class="op" id="1539499">.</span><span class="ident" id="1539500">B</span>&nbsp;<span class="op" id="1539502">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539507">//&nbsp;Iterator&nbsp;was&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;grow,&nbsp;and&nbsp;the&nbsp;grow&nbsp;isn&#39;t&nbsp;done&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539588">//&nbsp;If&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;looking&nbsp;at&nbsp;hasn&#39;t&nbsp;been&nbsp;filled&nbsp;in&nbsp;yet&nbsp;(i.e.&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539665">//&nbsp;bucket&nbsp;hasn&#39;t&nbsp;been&nbsp;evacuated)&nbsp;then&nbsp;we&nbsp;need&nbsp;to&nbsp;iterate&nbsp;through&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539741">//&nbsp;bucket&nbsp;and&nbsp;only&nbsp;return&nbsp;the&nbsp;ones&nbsp;that&nbsp;will&nbsp;be&nbsp;migrated&nbsp;to&nbsp;this&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539817">oldbucket</span>&nbsp;<span class="op" id="1539827">:=</span>&nbsp;<span class="ident" id="1539830">bucket</span>&nbsp;<span class="op" id="1539837">&amp;</span>&nbsp;<span class="op" id="1539839">(</span><span class="builtintype" id="1539840">uintptr</span><span class="op" id="1539847">(</span><span class="num" id="1539848">1</span><span class="op" id="1539849">)</span><span class="op" id="1539850">&lt;&lt;</span><span class="op" id="1539852">(</span><span class="ident" id="1539853">it</span><span class="op" id="1539855">.</span><span class="ident" id="1539856">B</span><span class="op" id="1539857">-</span><span class="num" id="1539858">1</span><span class="op" id="1539859">)</span>&nbsp;<span class="op" id="1539861">-</span>&nbsp;<span class="num" id="1539863">1</span><span class="op" id="1539864">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539869">b</span>&nbsp;<span class="op" id="1539871">=</span>&nbsp;<span class="op" id="1539873">(</span><span class="op" id="1539874">*</span><span class="ident" id="1539875">bmap</span><span class="op" id="1539879">)</span><span class="op" id="1539880">(</span><span class="ident" id="1539881">add</span><span class="op" id="1539884">(</span><span class="ident" id="1539885">h</span><span class="op" id="1539886">.</span><span class="ident" id="1539887">oldbuckets</span><span class="op" id="1539897">,</span>&nbsp;<span class="ident" id="1539899">oldbucket</span><span class="op" id="1539908">*</span><span class="builtintype" id="1539909">uintptr</span><span class="op" id="1539916">(</span><span class="ident" id="1539917">t</span><span class="op" id="1539918">.</span><span class="ident" id="1539919">bucketsize</span><span class="op" id="1539929">)</span><span class="op" id="1539930">)</span><span class="op" id="1539931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539936">if</span>&nbsp;<span class="op" id="1539939">!</span><span class="ident" id="1539940">evacuated</span><span class="op" id="1539949">(</span><span class="ident" id="1539950">b</span><span class="op" id="1539951">)</span>&nbsp;<span class="op" id="1539953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539959">checkBucket</span>&nbsp;<span class="op" id="1539971">=</span>&nbsp;<span class="ident" id="1539973">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539983">}</span>&nbsp;<span class="keyword" id="1539985">else</span>&nbsp;<span class="op" id="1539990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539996">b</span>&nbsp;<span class="op" id="1539998">=</span>&nbsp;<span class="op" id="1540000">(</span><span class="op" id="1540001">*</span><span class="ident" id="1540002">bmap</span><span class="op" id="1540006">)</span><span class="op" id="1540007">(</span><span class="ident" id="1540008">add</span><span class="op" id="1540011">(</span><span class="ident" id="1540012">it</span><span class="op" id="1540014">.</span><span class="ident" id="1540015">buckets</span><span class="op" id="1540022">,</span>&nbsp;<span class="ident" id="1540024">bucket</span><span class="op" id="1540030">*</span><span class="builtintype" id="1540031">uintptr</span><span class="op" id="1540038">(</span><span class="ident" id="1540039">t</span><span class="op" id="1540040">.</span><span class="ident" id="1540041">bucketsize</span><span class="op" id="1540051">)</span><span class="op" id="1540052">)</span><span class="op" id="1540053">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540059">checkBucket</span>&nbsp;<span class="op" id="1540071">=</span>&nbsp;<span class="ident" id="1540073">noCheck</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540088">}</span>&nbsp;<span class="keyword" id="1540090">else</span>&nbsp;<span class="op" id="1540095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540100">b</span>&nbsp;<span class="op" id="1540102">=</span>&nbsp;<span class="op" id="1540104">(</span><span class="op" id="1540105">*</span><span class="ident" id="1540106">bmap</span><span class="op" id="1540110">)</span><span class="op" id="1540111">(</span><span class="ident" id="1540112">add</span><span class="op" id="1540115">(</span><span class="ident" id="1540116">it</span><span class="op" id="1540118">.</span><span class="ident" id="1540119">buckets</span><span class="op" id="1540126">,</span>&nbsp;<span class="ident" id="1540128">bucket</span><span class="op" id="1540134">*</span><span class="builtintype" id="1540135">uintptr</span><span class="op" id="1540142">(</span><span class="ident" id="1540143">t</span><span class="op" id="1540144">.</span><span class="ident" id="1540145">bucketsize</span><span class="op" id="1540155">)</span><span class="op" id="1540156">)</span><span class="op" id="1540157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540162">checkBucket</span>&nbsp;<span class="op" id="1540174">=</span>&nbsp;<span class="ident" id="1540176">noCheck</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540190">bucket</span><span class="op" id="1540196">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540201">if</span>&nbsp;<span class="ident" id="1540204">bucket</span>&nbsp;<span class="op" id="1540211">==</span>&nbsp;<span class="builtintype" id="1540214">uintptr</span><span class="op" id="1540221">(</span><span class="num" id="1540222">1</span><span class="op" id="1540223">)</span><span class="op" id="1540224">&lt;&lt;</span><span class="ident" id="1540226">it</span><span class="op" id="1540228">.</span><span class="ident" id="1540229">B</span>&nbsp;<span class="op" id="1540231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540236">bucket</span>&nbsp;<span class="op" id="1540243">=</span>&nbsp;<span class="num" id="1540245">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540250">it</span><span class="op" id="1540252">.</span><span class="ident" id="1540253">wrapped</span>&nbsp;<span class="op" id="1540261">=</span>&nbsp;<span class="ident" id="1540263">true</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540274">i</span>&nbsp;<span class="op" id="1540276">=</span>&nbsp;<span class="num" id="1540278">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540284">for</span>&nbsp;<span class="op" id="1540288">;</span>&nbsp;<span class="ident" id="1540290">i</span>&nbsp;<span class="op" id="1540292">&lt;</span>&nbsp;<span class="ident" id="1540294">bucketCnt</span><span class="op" id="1540303">;</span>&nbsp;<span class="ident" id="1540305">i</span><span class="op" id="1540306">++</span>&nbsp;<span class="op" id="1540309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540313">offi</span>&nbsp;<span class="op" id="1540318">:=</span>&nbsp;<span class="op" id="1540321">(</span><span class="ident" id="1540322">i</span>&nbsp;<span class="op" id="1540324">+</span>&nbsp;<span class="ident" id="1540326">it</span><span class="op" id="1540328">.</span><span class="ident" id="1540329">offset</span><span class="op" id="1540335">)</span>&nbsp;<span class="op" id="1540337">&amp;</span>&nbsp;<span class="op" id="1540339">(</span><span class="ident" id="1540340">bucketCnt</span>&nbsp;<span class="op" id="1540350">-</span>&nbsp;<span class="num" id="1540352">1</span><span class="op" id="1540353">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540357">k</span>&nbsp;<span class="op" id="1540359">:=</span>&nbsp;<span class="ident" id="1540362">add</span><span class="op" id="1540365">(</span><span class="ident" id="1540366">unsafe</span><span class="op" id="1540372">.</span><span class="ident" id="1540373">Pointer</span><span class="op" id="1540380">(</span><span class="ident" id="1540381">b</span><span class="op" id="1540382">)</span><span class="op" id="1540383">,</span>&nbsp;<span class="ident" id="1540385">dataOffset</span><span class="op" id="1540395">+</span><span class="builtintype" id="1540396">uintptr</span><span class="op" id="1540403">(</span><span class="ident" id="1540404">offi</span><span class="op" id="1540408">)</span><span class="op" id="1540409">*</span><span class="builtintype" id="1540410">uintptr</span><span class="op" id="1540417">(</span><span class="ident" id="1540418">t</span><span class="op" id="1540419">.</span><span class="ident" id="1540420">keysize</span><span class="op" id="1540427">)</span><span class="op" id="1540428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540432">v</span>&nbsp;<span class="op" id="1540434">:=</span>&nbsp;<span class="ident" id="1540437">add</span><span class="op" id="1540440">(</span><span class="ident" id="1540441">unsafe</span><span class="op" id="1540447">.</span><span class="ident" id="1540448">Pointer</span><span class="op" id="1540455">(</span><span class="ident" id="1540456">b</span><span class="op" id="1540457">)</span><span class="op" id="1540458">,</span>&nbsp;<span class="ident" id="1540460">dataOffset</span><span class="op" id="1540470">+</span><span class="ident" id="1540471">bucketCnt</span><span class="op" id="1540480">*</span><span class="builtintype" id="1540481">uintptr</span><span class="op" id="1540488">(</span><span class="ident" id="1540489">t</span><span class="op" id="1540490">.</span><span class="ident" id="1540491">keysize</span><span class="op" id="1540498">)</span><span class="op" id="1540499">+</span><span class="builtintype" id="1540500">uintptr</span><span class="op" id="1540507">(</span><span class="ident" id="1540508">offi</span><span class="op" id="1540512">)</span><span class="op" id="1540513">*</span><span class="builtintype" id="1540514">uintptr</span><span class="op" id="1540521">(</span><span class="ident" id="1540522">t</span><span class="op" id="1540523">.</span><span class="ident" id="1540524">valuesize</span><span class="op" id="1540533">)</span><span class="op" id="1540534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540538">if</span>&nbsp;<span class="ident" id="1540541">b</span><span class="op" id="1540542">.</span><span class="ident" id="1540543">tophash</span><span class="op" id="1540550">[</span><span class="ident" id="1540551">offi</span><span class="op" id="1540555">]</span>&nbsp;<span class="op" id="1540557">!=</span>&nbsp;<span class="ident" id="1540560">empty</span>&nbsp;<span class="op" id="1540566">&amp;&amp;</span>&nbsp;<span class="ident" id="1540569">b</span><span class="op" id="1540570">.</span><span class="ident" id="1540571">tophash</span><span class="op" id="1540578">[</span><span class="ident" id="1540579">offi</span><span class="op" id="1540583">]</span>&nbsp;<span class="op" id="1540585">!=</span>&nbsp;<span class="ident" id="1540588">evacuatedEmpty</span>&nbsp;<span class="op" id="1540603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540608">if</span>&nbsp;<span class="ident" id="1540611">checkBucket</span>&nbsp;<span class="op" id="1540623">!=</span>&nbsp;<span class="ident" id="1540626">noCheck</span>&nbsp;<span class="op" id="1540634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1540640">//&nbsp;Special&nbsp;case:&nbsp;iterator&nbsp;was&nbsp;started&nbsp;during&nbsp;a&nbsp;grow&nbsp;and&nbsp;the</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1540704">//&nbsp;grow&nbsp;is&nbsp;not&nbsp;done&nbsp;yet.&nbsp;&nbsp;We&#39;re&nbsp;working&nbsp;on&nbsp;a&nbsp;bucket&nbsp;whose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1540766">//&nbsp;oldbucket&nbsp;has&nbsp;not&nbsp;been&nbsp;evacuated&nbsp;yet.&nbsp;&nbsp;Or&nbsp;at&nbsp;least,&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1540835">//&nbsp;evacuated&nbsp;when&nbsp;we&nbsp;started&nbsp;the&nbsp;bucket.&nbsp;&nbsp;So&nbsp;we&#39;re&nbsp;iterating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1540900">//&nbsp;through&nbsp;the&nbsp;oldbucket,&nbsp;skipping&nbsp;any&nbsp;keys&nbsp;that&nbsp;will&nbsp;go</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1540961">//&nbsp;to&nbsp;the&nbsp;other&nbsp;new&nbsp;bucket&nbsp;(each&nbsp;oldbucket&nbsp;expands&nbsp;to&nbsp;two</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541023">//&nbsp;buckets&nbsp;during&nbsp;a&nbsp;grow).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541054">k2</span>&nbsp;<span class="op" id="1541057">:=</span>&nbsp;<span class="ident" id="1541060">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541066">if</span>&nbsp;<span class="ident" id="1541069">t</span><span class="op" id="1541070">.</span><span class="ident" id="1541071">indirectkey</span>&nbsp;<span class="op" id="1541083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541090">k2</span>&nbsp;<span class="op" id="1541093">=</span>&nbsp;<span class="op" id="1541095">*</span><span class="op" id="1541096">(</span><span class="op" id="1541097">(</span><span class="op" id="1541098">*</span><span class="ident" id="1541099">unsafe</span><span class="op" id="1541105">.</span><span class="ident" id="1541106">Pointer</span><span class="op" id="1541113">)</span><span class="op" id="1541114">(</span><span class="ident" id="1541115">k2</span><span class="op" id="1541117">)</span><span class="op" id="1541118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541124">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541130">if</span>&nbsp;<span class="ident" id="1541133">alg</span><span class="op" id="1541136">.</span><span class="ident" id="1541137">equal</span><span class="op" id="1541142">(</span><span class="ident" id="1541143">k2</span><span class="op" id="1541145">,</span>&nbsp;<span class="ident" id="1541147">k2</span><span class="op" id="1541149">,</span>&nbsp;<span class="builtintype" id="1541151">uintptr</span><span class="op" id="1541158">(</span><span class="ident" id="1541159">t</span><span class="op" id="1541160">.</span><span class="ident" id="1541161">key</span><span class="op" id="1541164">.</span><span class="ident" id="1541165">size</span><span class="op" id="1541169">)</span><span class="op" id="1541170">)</span>&nbsp;<span class="op" id="1541172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541179">//&nbsp;If&nbsp;the&nbsp;item&nbsp;in&nbsp;the&nbsp;oldbucket&nbsp;is&nbsp;not&nbsp;destined&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541236">//&nbsp;the&nbsp;current&nbsp;new&nbsp;bucket&nbsp;in&nbsp;the&nbsp;iteration,&nbsp;skip&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541294">hash</span>&nbsp;<span class="op" id="1541299">:=</span>&nbsp;<span class="ident" id="1541302">alg</span><span class="op" id="1541305">.</span><span class="ident" id="1541306">hash</span><span class="op" id="1541310">(</span><span class="ident" id="1541311">k2</span><span class="op" id="1541313">,</span>&nbsp;<span class="builtintype" id="1541315">uintptr</span><span class="op" id="1541322">(</span><span class="ident" id="1541323">t</span><span class="op" id="1541324">.</span><span class="ident" id="1541325">key</span><span class="op" id="1541328">.</span><span class="ident" id="1541329">size</span><span class="op" id="1541333">)</span><span class="op" id="1541334">,</span>&nbsp;<span class="builtintype" id="1541336">uintptr</span><span class="op" id="1541343">(</span><span class="ident" id="1541344">h</span><span class="op" id="1541345">.</span><span class="ident" id="1541346">hash0</span><span class="op" id="1541351">)</span><span class="op" id="1541352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541359">if</span>&nbsp;<span class="ident" id="1541362">hash</span><span class="op" id="1541366">&amp;</span><span class="op" id="1541367">(</span><span class="builtintype" id="1541368">uintptr</span><span class="op" id="1541375">(</span><span class="num" id="1541376">1</span><span class="op" id="1541377">)</span><span class="op" id="1541378">&lt;&lt;</span><span class="ident" id="1541380">it</span><span class="op" id="1541382">.</span><span class="ident" id="1541383">B</span><span class="op" id="1541384">-</span><span class="num" id="1541385">1</span><span class="op" id="1541386">)</span>&nbsp;<span class="op" id="1541388">!=</span>&nbsp;<span class="ident" id="1541391">checkBucket</span>&nbsp;<span class="op" id="1541403">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541411">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541431">}</span>&nbsp;<span class="keyword" id="1541433">else</span>&nbsp;<span class="op" id="1541438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541445">//&nbsp;Hash&nbsp;isn&#39;t&nbsp;repeatable&nbsp;if&nbsp;k&nbsp;!=&nbsp;k&nbsp;(NaNs).&nbsp;&nbsp;We&nbsp;need&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541504">//&nbsp;repeatable&nbsp;and&nbsp;randomish&nbsp;choice&nbsp;of&nbsp;which&nbsp;direction</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541563">//&nbsp;to&nbsp;send&nbsp;NaNs&nbsp;during&nbsp;evacuation.&nbsp;&nbsp;We&#39;ll&nbsp;use&nbsp;the&nbsp;low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541622">//&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;to&nbsp;decide&nbsp;which&nbsp;way&nbsp;NaNs&nbsp;go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541674">//&nbsp;NOTE:&nbsp;this&nbsp;case&nbsp;is&nbsp;why&nbsp;we&nbsp;need&nbsp;two&nbsp;evacuate&nbsp;tophash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541734">//&nbsp;values,&nbsp;evacuatedX&nbsp;and&nbsp;evacuatedY,&nbsp;that&nbsp;differ&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541792">//&nbsp;their&nbsp;low&nbsp;bit.</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541815">if</span>&nbsp;<span class="ident" id="1541818">checkBucket</span><span class="op" id="1541829">&gt;&gt;</span><span class="op" id="1541831">(</span><span class="ident" id="1541832">it</span><span class="op" id="1541834">.</span><span class="ident" id="1541835">B</span><span class="op" id="1541836">-</span><span class="num" id="1541837">1</span><span class="op" id="1541838">)</span>&nbsp;<span class="op" id="1541840">!=</span>&nbsp;<span class="builtintype" id="1541843">uintptr</span><span class="op" id="1541850">(</span><span class="ident" id="1541851">b</span><span class="op" id="1541852">.</span><span class="ident" id="1541853">tophash</span><span class="op" id="1541860">[</span><span class="ident" id="1541861">offi</span><span class="op" id="1541865">]</span><span class="op" id="1541866">&amp;</span><span class="num" id="1541867">1</span><span class="op" id="1541868">)</span>&nbsp;<span class="op" id="1541870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541878">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541903">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541908">if</span>&nbsp;<span class="ident" id="1541911">b</span><span class="op" id="1541912">.</span><span class="ident" id="1541913">tophash</span><span class="op" id="1541920">[</span><span class="ident" id="1541921">offi</span><span class="op" id="1541925">]</span>&nbsp;<span class="op" id="1541927">!=</span>&nbsp;<span class="ident" id="1541930">evacuatedX</span>&nbsp;<span class="op" id="1541941">&amp;&amp;</span>&nbsp;<span class="ident" id="1541944">b</span><span class="op" id="1541945">.</span><span class="ident" id="1541946">tophash</span><span class="op" id="1541953">[</span><span class="ident" id="1541954">offi</span><span class="op" id="1541958">]</span>&nbsp;<span class="op" id="1541960">!=</span>&nbsp;<span class="ident" id="1541963">evacuatedY</span>&nbsp;<span class="op" id="1541974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541980">//&nbsp;this&nbsp;is&nbsp;the&nbsp;golden&nbsp;data,&nbsp;we&nbsp;can&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542030">if</span>&nbsp;<span class="ident" id="1542033">t</span><span class="op" id="1542034">.</span><span class="ident" id="1542035">indirectkey</span>&nbsp;<span class="op" id="1542047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542054">k</span>&nbsp;<span class="op" id="1542056">=</span>&nbsp;<span class="op" id="1542058">*</span><span class="op" id="1542059">(</span><span class="op" id="1542060">(</span><span class="op" id="1542061">*</span><span class="ident" id="1542062">unsafe</span><span class="op" id="1542068">.</span><span class="ident" id="1542069">Pointer</span><span class="op" id="1542076">)</span><span class="op" id="1542077">(</span><span class="ident" id="1542078">k</span><span class="op" id="1542079">)</span><span class="op" id="1542080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542086">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542092">it</span><span class="op" id="1542094">.</span><span class="ident" id="1542095">key</span>&nbsp;<span class="op" id="1542099">=</span>&nbsp;<span class="ident" id="1542101">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542107">if</span>&nbsp;<span class="ident" id="1542110">t</span><span class="op" id="1542111">.</span><span class="ident" id="1542112">indirectvalue</span>&nbsp;<span class="op" id="1542126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542133">v</span>&nbsp;<span class="op" id="1542135">=</span>&nbsp;<span class="op" id="1542137">*</span><span class="op" id="1542138">(</span><span class="op" id="1542139">(</span><span class="op" id="1542140">*</span><span class="ident" id="1542141">unsafe</span><span class="op" id="1542147">.</span><span class="ident" id="1542148">Pointer</span><span class="op" id="1542155">)</span><span class="op" id="1542156">(</span><span class="ident" id="1542157">v</span><span class="op" id="1542158">)</span><span class="op" id="1542159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542171">it</span><span class="op" id="1542173">.</span><span class="ident" id="1542174">value</span>&nbsp;<span class="op" id="1542180">=</span>&nbsp;<span class="ident" id="1542182">v</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542187">}</span>&nbsp;<span class="keyword" id="1542189">else</span>&nbsp;<span class="op" id="1542194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542200">//&nbsp;The&nbsp;hash&nbsp;table&nbsp;has&nbsp;grown&nbsp;since&nbsp;the&nbsp;iterator&nbsp;was&nbsp;started.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542264">//&nbsp;The&nbsp;golden&nbsp;data&nbsp;for&nbsp;this&nbsp;key&nbsp;is&nbsp;now&nbsp;somewhere&nbsp;else.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542323">k2</span>&nbsp;<span class="op" id="1542326">:=</span>&nbsp;<span class="ident" id="1542329">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542335">if</span>&nbsp;<span class="ident" id="1542338">t</span><span class="op" id="1542339">.</span><span class="ident" id="1542340">indirectkey</span>&nbsp;<span class="op" id="1542352">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542359">k2</span>&nbsp;<span class="op" id="1542362">=</span>&nbsp;<span class="op" id="1542364">*</span><span class="op" id="1542365">(</span><span class="op" id="1542366">(</span><span class="op" id="1542367">*</span><span class="ident" id="1542368">unsafe</span><span class="op" id="1542374">.</span><span class="ident" id="1542375">Pointer</span><span class="op" id="1542382">)</span><span class="op" id="1542383">(</span><span class="ident" id="1542384">k2</span><span class="op" id="1542386">)</span><span class="op" id="1542387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542399">if</span>&nbsp;<span class="ident" id="1542402">alg</span><span class="op" id="1542405">.</span><span class="ident" id="1542406">equal</span><span class="op" id="1542411">(</span><span class="ident" id="1542412">k2</span><span class="op" id="1542414">,</span>&nbsp;<span class="ident" id="1542416">k2</span><span class="op" id="1542418">,</span>&nbsp;<span class="builtintype" id="1542420">uintptr</span><span class="op" id="1542427">(</span><span class="ident" id="1542428">t</span><span class="op" id="1542429">.</span><span class="ident" id="1542430">key</span><span class="op" id="1542433">.</span><span class="ident" id="1542434">size</span><span class="op" id="1542438">)</span><span class="op" id="1542439">)</span>&nbsp;<span class="op" id="1542441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542448">//&nbsp;Check&nbsp;the&nbsp;current&nbsp;hash&nbsp;table&nbsp;for&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542499">//&nbsp;This&nbsp;code&nbsp;handles&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;key</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542548">//&nbsp;has&nbsp;been&nbsp;deleted,&nbsp;updated,&nbsp;or&nbsp;deleted&nbsp;and&nbsp;reinserted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542610">//&nbsp;NOTE:&nbsp;we&nbsp;need&nbsp;to&nbsp;regrab&nbsp;the&nbsp;key&nbsp;as&nbsp;it&nbsp;has&nbsp;potentially&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542677">//&nbsp;updated&nbsp;to&nbsp;an&nbsp;equal()&nbsp;but&nbsp;not&nbsp;identical&nbsp;key&nbsp;(e.g.&nbsp;+0.0&nbsp;vs&nbsp;-0.0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542750">rk</span><span class="op" id="1542752">,</span>&nbsp;<span class="ident" id="1542754">rv</span>&nbsp;<span class="op" id="1542757">:=</span>&nbsp;<span class="ident" id="1542760">mapaccessK</span><span class="op" id="1542770">(</span><span class="ident" id="1542771">t</span><span class="op" id="1542772">,</span>&nbsp;<span class="ident" id="1542774">h</span><span class="op" id="1542775">,</span>&nbsp;<span class="ident" id="1542777">k2</span><span class="op" id="1542779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542786">if</span>&nbsp;<span class="ident" id="1542789">rk</span>&nbsp;<span class="op" id="1542792">==</span>&nbsp;<span class="ident" id="1542795">nil</span>&nbsp;<span class="op" id="1542799">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542807">continue</span>&nbsp;<span class="comment" id="1542816">//&nbsp;key&nbsp;has&nbsp;been&nbsp;deleted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542852">it</span><span class="op" id="1542854">.</span><span class="ident" id="1542855">key</span>&nbsp;<span class="op" id="1542859">=</span>&nbsp;<span class="ident" id="1542861">rk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542869">it</span><span class="op" id="1542871">.</span><span class="ident" id="1542872">value</span>&nbsp;<span class="op" id="1542878">=</span>&nbsp;<span class="ident" id="1542880">rv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542887">}</span>&nbsp;<span class="keyword" id="1542889">else</span>&nbsp;<span class="op" id="1542894">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542901">//&nbsp;if&nbsp;key!=key&nbsp;then&nbsp;the&nbsp;entry&nbsp;can&#39;t&nbsp;be&nbsp;deleted&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542956">//&nbsp;updated,&nbsp;so&nbsp;we&nbsp;can&nbsp;just&nbsp;return&nbsp;it.&nbsp;&nbsp;That&#39;s&nbsp;lucky&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543017">//&nbsp;us&nbsp;because&nbsp;when&nbsp;key!=key&nbsp;we&nbsp;can&#39;t&nbsp;look&nbsp;it&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543070">//&nbsp;successfully&nbsp;in&nbsp;the&nbsp;current&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543113">it</span><span class="op" id="1543115">.</span><span class="ident" id="1543116">key</span>&nbsp;<span class="op" id="1543120">=</span>&nbsp;<span class="ident" id="1543122">k2</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543130">if</span>&nbsp;<span class="ident" id="1543133">t</span><span class="op" id="1543134">.</span><span class="ident" id="1543135">indirectvalue</span>&nbsp;<span class="op" id="1543149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543157">v</span>&nbsp;<span class="op" id="1543159">=</span>&nbsp;<span class="op" id="1543161">*</span><span class="op" id="1543162">(</span><span class="op" id="1543163">(</span><span class="op" id="1543164">*</span><span class="ident" id="1543165">unsafe</span><span class="op" id="1543171">.</span><span class="ident" id="1543172">Pointer</span><span class="op" id="1543179">)</span><span class="op" id="1543180">(</span><span class="ident" id="1543181">v</span><span class="op" id="1543182">)</span><span class="op" id="1543183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543197">it</span><span class="op" id="1543199">.</span><span class="ident" id="1543200">value</span>&nbsp;<span class="op" id="1543206">=</span>&nbsp;<span class="ident" id="1543208">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543214">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543224">it</span><span class="op" id="1543226">.</span><span class="ident" id="1543227">bucket</span>&nbsp;<span class="op" id="1543234">=</span>&nbsp;<span class="ident" id="1543236">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543246">it</span><span class="op" id="1543248">.</span><span class="ident" id="1543249">bptr</span>&nbsp;<span class="op" id="1543254">=</span>&nbsp;<span class="ident" id="1543256">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543261">it</span><span class="op" id="1543263">.</span><span class="ident" id="1543264">i</span>&nbsp;<span class="op" id="1543266">=</span>&nbsp;<span class="ident" id="1543268">i</span>&nbsp;<span class="op" id="1543270">+</span>&nbsp;<span class="num" id="1543272">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543277">it</span><span class="op" id="1543279">.</span><span class="ident" id="1543280">checkBucket</span>&nbsp;<span class="op" id="1543292">=</span>&nbsp;<span class="ident" id="1543294">checkBucket</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543309">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543324">b</span>&nbsp;<span class="op" id="1543326">=</span>&nbsp;<span class="ident" id="1543328">b</span><span class="op" id="1543329">.</span><span class="ident" id="1543330">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543340">i</span>&nbsp;<span class="op" id="1543342">=</span>&nbsp;<span class="num" id="1543344">0</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543347">goto</span>&nbsp;<span class="ident" id="1543352">next</span><br>
<span class="lineno"></span><span class="op" id="1543357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1543360">func</span>&nbsp;<span class="ident" id="1543365">hashGrow</span><span class="op" id="1543373">(</span><span class="ident" id="1543374">t</span>&nbsp;<span class="op" id="1543376">*</span><span class="ident" id="1543377">maptype</span><span class="op" id="1543384">,</span>&nbsp;<span class="ident" id="1543386">h</span>&nbsp;<span class="op" id="1543388">*</span><span class="ident" id="1543389">hmap</span><span class="op" id="1543393">)</span>&nbsp;<span class="op" id="1543395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543398">if</span>&nbsp;<span class="ident" id="1543401">h</span><span class="op" id="1543402">.</span><span class="ident" id="1543403">oldbuckets</span>&nbsp;<span class="op" id="1543414">!=</span>&nbsp;<span class="ident" id="1543417">nil</span>&nbsp;<span class="op" id="1543421">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543425">gothrow</span><span class="op" id="1543432">(</span><span class="string" id="1543433">&#34;evacuation&nbsp;not&nbsp;done&nbsp;in&nbsp;time&#34;</span><span class="op" id="1543462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543468">oldbuckets</span>&nbsp;<span class="op" id="1543479">:=</span>&nbsp;<span class="ident" id="1543482">h</span><span class="op" id="1543483">.</span><span class="ident" id="1543484">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543493">if</span>&nbsp;<span class="ident" id="1543496">checkgc</span>&nbsp;<span class="op" id="1543504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543508">memstats</span><span class="op" id="1543516">.</span><span class="ident" id="1543517">next_gc</span>&nbsp;<span class="op" id="1543525">=</span>&nbsp;<span class="ident" id="1543527">memstats</span><span class="op" id="1543535">.</span><span class="ident" id="1543536">heap_alloc</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543551">newbuckets</span>&nbsp;<span class="op" id="1543562">:=</span>&nbsp;<span class="ident" id="1543565">newarray</span><span class="op" id="1543573">(</span><span class="ident" id="1543574">t</span><span class="op" id="1543575">.</span><span class="ident" id="1543576">bucket</span><span class="op" id="1543582">,</span>&nbsp;<span class="builtintype" id="1543584">uintptr</span><span class="op" id="1543591">(</span><span class="num" id="1543592">1</span><span class="op" id="1543593">)</span><span class="op" id="1543594">&lt;&lt;</span><span class="op" id="1543596">(</span><span class="ident" id="1543597">h</span><span class="op" id="1543598">.</span><span class="ident" id="1543599">B</span><span class="op" id="1543600">+</span><span class="num" id="1543601">1</span><span class="op" id="1543602">)</span><span class="op" id="1543603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543606">flags</span>&nbsp;<span class="op" id="1543612">:=</span>&nbsp;<span class="ident" id="1543615">h</span><span class="op" id="1543616">.</span><span class="ident" id="1543617">flags</span>&nbsp;<span class="op" id="1543623">&amp;^</span>&nbsp;<span class="op" id="1543626">(</span><span class="ident" id="1543627">iterator</span>&nbsp;<span class="op" id="1543636">|</span>&nbsp;<span class="ident" id="1543638">oldIterator</span><span class="op" id="1543649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543652">if</span>&nbsp;<span class="ident" id="1543655">h</span><span class="op" id="1543656">.</span><span class="ident" id="1543657">flags</span><span class="op" id="1543662">&amp;</span><span class="ident" id="1543663">iterator</span>&nbsp;<span class="op" id="1543672">!=</span>&nbsp;<span class="num" id="1543675">0</span>&nbsp;<span class="op" id="1543677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543681">flags</span>&nbsp;<span class="op" id="1543687">|=</span>&nbsp;<span class="ident" id="1543690">oldIterator</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543706">//&nbsp;commit&nbsp;the&nbsp;grow&nbsp;(atomic&nbsp;wrt&nbsp;gc)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543742">h</span><span class="op" id="1543743">.</span><span class="ident" id="1543744">B</span><span class="op" id="1543745">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543749">h</span><span class="op" id="1543750">.</span><span class="ident" id="1543751">flags</span>&nbsp;<span class="op" id="1543757">=</span>&nbsp;<span class="ident" id="1543759">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543766">h</span><span class="op" id="1543767">.</span><span class="ident" id="1543768">oldbuckets</span>&nbsp;<span class="op" id="1543779">=</span>&nbsp;<span class="ident" id="1543781">oldbuckets</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543793">h</span><span class="op" id="1543794">.</span><span class="ident" id="1543795">buckets</span>&nbsp;<span class="op" id="1543803">=</span>&nbsp;<span class="ident" id="1543805">newbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543817">h</span><span class="op" id="1543818">.</span><span class="ident" id="1543819">nevacuate</span>&nbsp;<span class="op" id="1543829">=</span>&nbsp;<span class="num" id="1543831">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543835">//&nbsp;the&nbsp;actual&nbsp;copying&nbsp;of&nbsp;the&nbsp;hash&nbsp;table&nbsp;data&nbsp;is&nbsp;done&nbsp;incrementally</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543903">//&nbsp;by&nbsp;growWork()&nbsp;and&nbsp;evacuate().</span><br>
<span class="lineno">750</span><span class="op" id="1543936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1543939">func</span>&nbsp;<span class="ident" id="1543944">growWork</span><span class="op" id="1543952">(</span><span class="ident" id="1543953">t</span>&nbsp;<span class="op" id="1543955">*</span><span class="ident" id="1543956">maptype</span><span class="op" id="1543963">,</span>&nbsp;<span class="ident" id="1543965">h</span>&nbsp;<span class="op" id="1543967">*</span><span class="ident" id="1543968">hmap</span><span class="op" id="1543972">,</span>&nbsp;<span class="ident" id="1543974">bucket</span>&nbsp;<span class="builtintype" id="1543981">uintptr</span><span class="op" id="1543988">)</span>&nbsp;<span class="op" id="1543990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543993">noldbuckets</span>&nbsp;<span class="op" id="1544005">:=</span>&nbsp;<span class="builtintype" id="1544008">uintptr</span><span class="op" id="1544015">(</span><span class="num" id="1544016">1</span><span class="op" id="1544017">)</span>&nbsp;<span class="op" id="1544019">&lt;&lt;</span>&nbsp;<span class="op" id="1544022">(</span><span class="ident" id="1544023">h</span><span class="op" id="1544024">.</span><span class="ident" id="1544025">B</span>&nbsp;<span class="op" id="1544027">-</span>&nbsp;<span class="num" id="1544029">1</span><span class="op" id="1544030">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544034">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;evacuate&nbsp;the&nbsp;oldbucket&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544088">//&nbsp;to&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544125">evacuate</span><span class="op" id="1544133">(</span><span class="ident" id="1544134">t</span><span class="op" id="1544135">,</span>&nbsp;<span class="ident" id="1544137">h</span><span class="op" id="1544138">,</span>&nbsp;<span class="ident" id="1544140">bucket</span><span class="op" id="1544146">&amp;</span><span class="op" id="1544147">(</span><span class="ident" id="1544148">noldbuckets</span><span class="op" id="1544159">-</span><span class="num" id="1544160">1</span><span class="op" id="1544161">)</span><span class="op" id="1544162">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544166">//&nbsp;evacuate&nbsp;one&nbsp;more&nbsp;oldbucket&nbsp;to&nbsp;make&nbsp;progress&nbsp;on&nbsp;growing</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544226">if</span>&nbsp;<span class="ident" id="1544229">h</span><span class="op" id="1544230">.</span><span class="ident" id="1544231">oldbuckets</span>&nbsp;<span class="op" id="1544242">!=</span>&nbsp;<span class="ident" id="1544245">nil</span>&nbsp;<span class="op" id="1544249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544253">evacuate</span><span class="op" id="1544261">(</span><span class="ident" id="1544262">t</span><span class="op" id="1544263">,</span>&nbsp;<span class="ident" id="1544265">h</span><span class="op" id="1544266">,</span>&nbsp;<span class="ident" id="1544268">h</span><span class="op" id="1544269">.</span><span class="ident" id="1544270">nevacuate</span><span class="op" id="1544279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544282">}</span><br>
<span class="lineno"></span><span class="op" id="1544284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="1544287">func</span>&nbsp;<span class="ident" id="1544292">evacuate</span><span class="op" id="1544300">(</span><span class="ident" id="1544301">t</span>&nbsp;<span class="op" id="1544303">*</span><span class="ident" id="1544304">maptype</span><span class="op" id="1544311">,</span>&nbsp;<span class="ident" id="1544313">h</span>&nbsp;<span class="op" id="1544315">*</span><span class="ident" id="1544316">hmap</span><span class="op" id="1544320">,</span>&nbsp;<span class="ident" id="1544322">oldbucket</span>&nbsp;<span class="builtintype" id="1544332">uintptr</span><span class="op" id="1544339">)</span>&nbsp;<span class="op" id="1544341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544344">b</span>&nbsp;<span class="op" id="1544346">:=</span>&nbsp;<span class="op" id="1544349">(</span><span class="op" id="1544350">*</span><span class="ident" id="1544351">bmap</span><span class="op" id="1544355">)</span><span class="op" id="1544356">(</span><span class="ident" id="1544357">add</span><span class="op" id="1544360">(</span><span class="ident" id="1544361">h</span><span class="op" id="1544362">.</span><span class="ident" id="1544363">oldbuckets</span><span class="op" id="1544373">,</span>&nbsp;<span class="ident" id="1544375">oldbucket</span><span class="op" id="1544384">*</span><span class="builtintype" id="1544385">uintptr</span><span class="op" id="1544392">(</span><span class="ident" id="1544393">t</span><span class="op" id="1544394">.</span><span class="ident" id="1544395">bucketsize</span><span class="op" id="1544405">)</span><span class="op" id="1544406">)</span><span class="op" id="1544407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544410">newbit</span>&nbsp;<span class="op" id="1544417">:=</span>&nbsp;<span class="builtintype" id="1544420">uintptr</span><span class="op" id="1544427">(</span><span class="num" id="1544428">1</span><span class="op" id="1544429">)</span>&nbsp;<span class="op" id="1544431">&lt;&lt;</span>&nbsp;<span class="op" id="1544434">(</span><span class="ident" id="1544435">h</span><span class="op" id="1544436">.</span><span class="ident" id="1544437">B</span>&nbsp;<span class="op" id="1544439">-</span>&nbsp;<span class="num" id="1544441">1</span><span class="op" id="1544442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544445">alg</span>&nbsp;<span class="op" id="1544449">:=</span>&nbsp;<span class="ident" id="1544452">goalg</span><span class="op" id="1544457">(</span><span class="ident" id="1544458">t</span><span class="op" id="1544459">.</span><span class="ident" id="1544460">key</span><span class="op" id="1544463">.</span><span class="ident" id="1544464">alg</span><span class="op" id="1544467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544470">if</span>&nbsp;<span class="op" id="1544473">!</span><span class="ident" id="1544474">evacuated</span><span class="op" id="1544483">(</span><span class="ident" id="1544484">b</span><span class="op" id="1544485">)</span>&nbsp;<span class="op" id="1544487">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544491">//&nbsp;TODO:&nbsp;reuse&nbsp;overflow&nbsp;buckets&nbsp;instead&nbsp;of&nbsp;using&nbsp;new&nbsp;ones,&nbsp;if&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544561">//&nbsp;is&nbsp;no&nbsp;iterator&nbsp;using&nbsp;the&nbsp;old&nbsp;buckets.&nbsp;&nbsp;(If&nbsp;!oldIterator.)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544625">x</span>&nbsp;<span class="op" id="1544627">:=</span>&nbsp;<span class="op" id="1544630">(</span><span class="op" id="1544631">*</span><span class="ident" id="1544632">bmap</span><span class="op" id="1544636">)</span><span class="op" id="1544637">(</span><span class="ident" id="1544638">add</span><span class="op" id="1544641">(</span><span class="ident" id="1544642">h</span><span class="op" id="1544643">.</span><span class="ident" id="1544644">buckets</span><span class="op" id="1544651">,</span>&nbsp;<span class="ident" id="1544653">oldbucket</span><span class="op" id="1544662">*</span><span class="builtintype" id="1544663">uintptr</span><span class="op" id="1544670">(</span><span class="ident" id="1544671">t</span><span class="op" id="1544672">.</span><span class="ident" id="1544673">bucketsize</span><span class="op" id="1544683">)</span><span class="op" id="1544684">)</span><span class="op" id="1544685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544689">y</span>&nbsp;<span class="op" id="1544691">:=</span>&nbsp;<span class="op" id="1544694">(</span><span class="op" id="1544695">*</span><span class="ident" id="1544696">bmap</span><span class="op" id="1544700">)</span><span class="op" id="1544701">(</span><span class="ident" id="1544702">add</span><span class="op" id="1544705">(</span><span class="ident" id="1544706">h</span><span class="op" id="1544707">.</span><span class="ident" id="1544708">buckets</span><span class="op" id="1544715">,</span>&nbsp;<span class="op" id="1544717">(</span><span class="ident" id="1544718">oldbucket</span><span class="op" id="1544727">+</span><span class="ident" id="1544728">newbit</span><span class="op" id="1544734">)</span><span class="op" id="1544735">*</span><span class="builtintype" id="1544736">uintptr</span><span class="op" id="1544743">(</span><span class="ident" id="1544744">t</span><span class="op" id="1544745">.</span><span class="ident" id="1544746">bucketsize</span><span class="op" id="1544756">)</span><span class="op" id="1544757">)</span><span class="op" id="1544758">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544762">xi</span>&nbsp;<span class="op" id="1544765">:=</span>&nbsp;<span class="num" id="1544768">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544772">yi</span>&nbsp;<span class="op" id="1544775">:=</span>&nbsp;<span class="num" id="1544778">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544782">xk</span>&nbsp;<span class="op" id="1544785">:=</span>&nbsp;<span class="ident" id="1544788">add</span><span class="op" id="1544791">(</span><span class="ident" id="1544792">unsafe</span><span class="op" id="1544798">.</span><span class="ident" id="1544799">Pointer</span><span class="op" id="1544806">(</span><span class="ident" id="1544807">x</span><span class="op" id="1544808">)</span><span class="op" id="1544809">,</span>&nbsp;<span class="ident" id="1544811">dataOffset</span><span class="op" id="1544821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544825">yk</span>&nbsp;<span class="op" id="1544828">:=</span>&nbsp;<span class="ident" id="1544831">add</span><span class="op" id="1544834">(</span><span class="ident" id="1544835">unsafe</span><span class="op" id="1544841">.</span><span class="ident" id="1544842">Pointer</span><span class="op" id="1544849">(</span><span class="ident" id="1544850">y</span><span class="op" id="1544851">)</span><span class="op" id="1544852">,</span>&nbsp;<span class="ident" id="1544854">dataOffset</span><span class="op" id="1544864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544868">xv</span>&nbsp;<span class="op" id="1544871">:=</span>&nbsp;<span class="ident" id="1544874">add</span><span class="op" id="1544877">(</span><span class="ident" id="1544878">xk</span><span class="op" id="1544880">,</span>&nbsp;<span class="ident" id="1544882">bucketCnt</span><span class="op" id="1544891">*</span><span class="builtintype" id="1544892">uintptr</span><span class="op" id="1544899">(</span><span class="ident" id="1544900">t</span><span class="op" id="1544901">.</span><span class="ident" id="1544902">keysize</span><span class="op" id="1544909">)</span><span class="op" id="1544910">)</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544914">yv</span>&nbsp;<span class="op" id="1544917">:=</span>&nbsp;<span class="ident" id="1544920">add</span><span class="op" id="1544923">(</span><span class="ident" id="1544924">yk</span><span class="op" id="1544926">,</span>&nbsp;<span class="ident" id="1544928">bucketCnt</span><span class="op" id="1544937">*</span><span class="builtintype" id="1544938">uintptr</span><span class="op" id="1544945">(</span><span class="ident" id="1544946">t</span><span class="op" id="1544947">.</span><span class="ident" id="1544948">keysize</span><span class="op" id="1544955">)</span><span class="op" id="1544956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544960">for</span>&nbsp;<span class="op" id="1544964">;</span>&nbsp;<span class="ident" id="1544966">b</span>&nbsp;<span class="op" id="1544968">!=</span>&nbsp;<span class="ident" id="1544971">nil</span><span class="op" id="1544974">;</span>&nbsp;<span class="ident" id="1544976">b</span>&nbsp;<span class="op" id="1544978">=</span>&nbsp;<span class="ident" id="1544980">b</span><span class="op" id="1544981">.</span><span class="ident" id="1544982">overflow</span>&nbsp;<span class="op" id="1544991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544996">k</span>&nbsp;<span class="op" id="1544998">:=</span>&nbsp;<span class="ident" id="1545001">add</span><span class="op" id="1545004">(</span><span class="ident" id="1545005">unsafe</span><span class="op" id="1545011">.</span><span class="ident" id="1545012">Pointer</span><span class="op" id="1545019">(</span><span class="ident" id="1545020">b</span><span class="op" id="1545021">)</span><span class="op" id="1545022">,</span>&nbsp;<span class="ident" id="1545024">dataOffset</span><span class="op" id="1545034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545039">v</span>&nbsp;<span class="op" id="1545041">:=</span>&nbsp;<span class="ident" id="1545044">add</span><span class="op" id="1545047">(</span><span class="ident" id="1545048">k</span><span class="op" id="1545049">,</span>&nbsp;<span class="ident" id="1545051">bucketCnt</span><span class="op" id="1545060">*</span><span class="builtintype" id="1545061">uintptr</span><span class="op" id="1545068">(</span><span class="ident" id="1545069">t</span><span class="op" id="1545070">.</span><span class="ident" id="1545071">keysize</span><span class="op" id="1545078">)</span><span class="op" id="1545079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545084">for</span>&nbsp;<span class="ident" id="1545088">i</span>&nbsp;<span class="op" id="1545090">:=</span>&nbsp;<span class="num" id="1545093">0</span><span class="op" id="1545094">;</span>&nbsp;<span class="ident" id="1545096">i</span>&nbsp;<span class="op" id="1545098">&lt;</span>&nbsp;<span class="ident" id="1545100">bucketCnt</span><span class="op" id="1545109">;</span>&nbsp;<span class="ident" id="1545111">i</span><span class="op" id="1545112">,</span>&nbsp;<span class="ident" id="1545114">k</span><span class="op" id="1545115">,</span>&nbsp;<span class="ident" id="1545117">v</span>&nbsp;<span class="op" id="1545119">=</span>&nbsp;<span class="ident" id="1545121">i</span><span class="op" id="1545122">+</span><span class="num" id="1545123">1</span><span class="op" id="1545124">,</span>&nbsp;<span class="ident" id="1545126">add</span><span class="op" id="1545129">(</span><span class="ident" id="1545130">k</span><span class="op" id="1545131">,</span>&nbsp;<span class="builtintype" id="1545133">uintptr</span><span class="op" id="1545140">(</span><span class="ident" id="1545141">t</span><span class="op" id="1545142">.</span><span class="ident" id="1545143">keysize</span><span class="op" id="1545150">)</span><span class="op" id="1545151">)</span><span class="op" id="1545152">,</span>&nbsp;<span class="ident" id="1545154">add</span><span class="op" id="1545157">(</span><span class="ident" id="1545158">v</span><span class="op" id="1545159">,</span>&nbsp;<span class="builtintype" id="1545161">uintptr</span><span class="op" id="1545168">(</span><span class="ident" id="1545169">t</span><span class="op" id="1545170">.</span><span class="ident" id="1545171">valuesize</span><span class="op" id="1545180">)</span><span class="op" id="1545181">)</span>&nbsp;<span class="op" id="1545183">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545189">top</span>&nbsp;<span class="op" id="1545193">:=</span>&nbsp;<span class="ident" id="1545196">b</span><span class="op" id="1545197">.</span><span class="ident" id="1545198">tophash</span><span class="op" id="1545205">[</span><span class="ident" id="1545206">i</span><span class="op" id="1545207">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545213">if</span>&nbsp;<span class="ident" id="1545216">top</span>&nbsp;<span class="op" id="1545220">==</span>&nbsp;<span class="ident" id="1545223">empty</span>&nbsp;<span class="op" id="1545229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545236">b</span><span class="op" id="1545237">.</span><span class="ident" id="1545238">tophash</span><span class="op" id="1545245">[</span><span class="ident" id="1545246">i</span><span class="op" id="1545247">]</span>&nbsp;<span class="op" id="1545249">=</span>&nbsp;<span class="ident" id="1545251">evacuatedEmpty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545271">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545284">}</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545290">if</span>&nbsp;<span class="ident" id="1545293">top</span>&nbsp;<span class="op" id="1545297">&lt;</span>&nbsp;<span class="ident" id="1545299">minTopHash</span>&nbsp;<span class="op" id="1545310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545317">gothrow</span><span class="op" id="1545324">(</span><span class="string" id="1545325">&#34;bad&nbsp;map&nbsp;state&#34;</span><span class="op" id="1545340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545352">k2</span>&nbsp;<span class="op" id="1545355">:=</span>&nbsp;<span class="ident" id="1545358">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545364">if</span>&nbsp;<span class="ident" id="1545367">t</span><span class="op" id="1545368">.</span><span class="ident" id="1545369">indirectkey</span>&nbsp;<span class="op" id="1545381">{</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545388">k2</span>&nbsp;<span class="op" id="1545391">=</span>&nbsp;<span class="op" id="1545393">*</span><span class="op" id="1545394">(</span><span class="op" id="1545395">(</span><span class="op" id="1545396">*</span><span class="ident" id="1545397">unsafe</span><span class="op" id="1545403">.</span><span class="ident" id="1545404">Pointer</span><span class="op" id="1545411">)</span><span class="op" id="1545412">(</span><span class="ident" id="1545413">k2</span><span class="op" id="1545415">)</span><span class="op" id="1545416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545428">//&nbsp;Compute&nbsp;hash&nbsp;to&nbsp;make&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;(whether&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545497">//&nbsp;to&nbsp;send&nbsp;this&nbsp;key/value&nbsp;to&nbsp;bucket&nbsp;x&nbsp;or&nbsp;bucket&nbsp;y).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545553">hash</span>&nbsp;<span class="op" id="1545558">:=</span>&nbsp;<span class="ident" id="1545561">alg</span><span class="op" id="1545564">.</span><span class="ident" id="1545565">hash</span><span class="op" id="1545569">(</span><span class="ident" id="1545570">k2</span><span class="op" id="1545572">,</span>&nbsp;<span class="builtintype" id="1545574">uintptr</span><span class="op" id="1545581">(</span><span class="ident" id="1545582">t</span><span class="op" id="1545583">.</span><span class="ident" id="1545584">key</span><span class="op" id="1545587">.</span><span class="ident" id="1545588">size</span><span class="op" id="1545592">)</span><span class="op" id="1545593">,</span>&nbsp;<span class="builtintype" id="1545595">uintptr</span><span class="op" id="1545602">(</span><span class="ident" id="1545603">h</span><span class="op" id="1545604">.</span><span class="ident" id="1545605">hash0</span><span class="op" id="1545610">)</span><span class="op" id="1545611">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545617">if</span>&nbsp;<span class="ident" id="1545620">h</span><span class="op" id="1545621">.</span><span class="ident" id="1545622">flags</span><span class="op" id="1545627">&amp;</span><span class="ident" id="1545628">iterator</span>&nbsp;<span class="op" id="1545637">!=</span>&nbsp;<span class="num" id="1545640">0</span>&nbsp;<span class="op" id="1545642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545649">if</span>&nbsp;<span class="op" id="1545652">!</span><span class="ident" id="1545653">alg</span><span class="op" id="1545656">.</span><span class="ident" id="1545657">equal</span><span class="op" id="1545662">(</span><span class="ident" id="1545663">k2</span><span class="op" id="1545665">,</span>&nbsp;<span class="ident" id="1545667">k2</span><span class="op" id="1545669">,</span>&nbsp;<span class="builtintype" id="1545671">uintptr</span><span class="op" id="1545678">(</span><span class="ident" id="1545679">t</span><span class="op" id="1545680">.</span><span class="ident" id="1545681">key</span><span class="op" id="1545684">.</span><span class="ident" id="1545685">size</span><span class="op" id="1545689">)</span><span class="op" id="1545690">)</span>&nbsp;<span class="op" id="1545692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545700">//&nbsp;If&nbsp;key&nbsp;!=&nbsp;key&nbsp;(NaNs),&nbsp;then&nbsp;the&nbsp;hash&nbsp;could&nbsp;be&nbsp;(and&nbsp;probably</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545768">//&nbsp;will&nbsp;be)&nbsp;entirely&nbsp;different&nbsp;from&nbsp;the&nbsp;old&nbsp;hash.&nbsp;&nbsp;Moreover,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545835">//&nbsp;it&nbsp;isn&#39;t&nbsp;reproducible.&nbsp;&nbsp;Reproducibility&nbsp;is&nbsp;required&nbsp;in&nbsp;the</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545903">//&nbsp;presence&nbsp;of&nbsp;iterators,&nbsp;as&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545967">//&nbsp;match&nbsp;whatever&nbsp;decision&nbsp;the&nbsp;iterator&nbsp;made.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546019">//&nbsp;Fortunately,&nbsp;we&nbsp;have&nbsp;the&nbsp;freedom&nbsp;to&nbsp;send&nbsp;these&nbsp;keys&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546087">//&nbsp;way.&nbsp;&nbsp;Also,&nbsp;tophash&nbsp;is&nbsp;meaningless&nbsp;for&nbsp;these&nbsp;kinds&nbsp;of&nbsp;keys.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546156">//&nbsp;We&nbsp;let&nbsp;the&nbsp;low&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;drive&nbsp;the&nbsp;evacuation&nbsp;decision.</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546226">//&nbsp;We&nbsp;recompute&nbsp;a&nbsp;new&nbsp;random&nbsp;tophash&nbsp;for&nbsp;the&nbsp;next&nbsp;level&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546291">//&nbsp;these&nbsp;keys&nbsp;will&nbsp;get&nbsp;evenly&nbsp;distributed&nbsp;across&nbsp;all&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546358">//&nbsp;after&nbsp;multiple&nbsp;grows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546389">if</span>&nbsp;<span class="op" id="1546392">(</span><span class="ident" id="1546393">top</span>&nbsp;<span class="op" id="1546397">&amp;</span>&nbsp;<span class="num" id="1546399">1</span><span class="op" id="1546400">)</span>&nbsp;<span class="op" id="1546402">!=</span>&nbsp;<span class="num" id="1546405">0</span>&nbsp;<span class="op" id="1546407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546416">hash</span>&nbsp;<span class="op" id="1546421">|=</span>&nbsp;<span class="ident" id="1546424">newbit</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546437">}</span>&nbsp;<span class="keyword" id="1546439">else</span>&nbsp;<span class="op" id="1546444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546453">hash</span>&nbsp;<span class="op" id="1546458">&amp;^=</span>&nbsp;<span class="ident" id="1546462">newbit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546483">top</span>&nbsp;<span class="op" id="1546487">=</span>&nbsp;<span class="builtintype" id="1546489">uint8</span><span class="op" id="1546494">(</span><span class="ident" id="1546495">hash</span>&nbsp;<span class="op" id="1546500">&gt;&gt;</span>&nbsp;<span class="op" id="1546503">(</span><span class="ident" id="1546504">ptrSize</span><span class="op" id="1546511">*</span><span class="num" id="1546512">8</span>&nbsp;<span class="op" id="1546514">-</span>&nbsp;<span class="num" id="1546516">8</span><span class="op" id="1546517">)</span><span class="op" id="1546518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546526">if</span>&nbsp;<span class="ident" id="1546529">top</span>&nbsp;<span class="op" id="1546533">&lt;</span>&nbsp;<span class="ident" id="1546535">minTopHash</span>&nbsp;<span class="op" id="1546546">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546555">top</span>&nbsp;<span class="op" id="1546559">+=</span>&nbsp;<span class="ident" id="1546562">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546598">if</span>&nbsp;<span class="op" id="1546601">(</span><span class="ident" id="1546602">hash</span>&nbsp;<span class="op" id="1546607">&amp;</span>&nbsp;<span class="ident" id="1546609">newbit</span><span class="op" id="1546615">)</span>&nbsp;<span class="op" id="1546617">==</span>&nbsp;<span class="num" id="1546620">0</span>&nbsp;<span class="op" id="1546622">{</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546629">b</span><span class="op" id="1546630">.</span><span class="ident" id="1546631">tophash</span><span class="op" id="1546638">[</span><span class="ident" id="1546639">i</span><span class="op" id="1546640">]</span>&nbsp;<span class="op" id="1546642">=</span>&nbsp;<span class="ident" id="1546644">evacuatedX</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546660">if</span>&nbsp;<span class="ident" id="1546663">xi</span>&nbsp;<span class="op" id="1546666">==</span>&nbsp;<span class="ident" id="1546669">bucketCnt</span>&nbsp;<span class="op" id="1546679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546687">if</span>&nbsp;<span class="ident" id="1546690">checkgc</span>&nbsp;<span class="op" id="1546698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546707">memstats</span><span class="op" id="1546715">.</span><span class="ident" id="1546716">next_gc</span>&nbsp;<span class="op" id="1546724">=</span>&nbsp;<span class="ident" id="1546726">memstats</span><span class="op" id="1546734">.</span><span class="ident" id="1546735">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546752">}</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546760">newx</span>&nbsp;<span class="op" id="1546765">:=</span>&nbsp;<span class="op" id="1546768">(</span><span class="op" id="1546769">*</span><span class="ident" id="1546770">bmap</span><span class="op" id="1546774">)</span><span class="op" id="1546775">(</span><span class="ident" id="1546776">newobject</span><span class="op" id="1546785">(</span><span class="ident" id="1546786">t</span><span class="op" id="1546787">.</span><span class="ident" id="1546788">bucket</span><span class="op" id="1546794">)</span><span class="op" id="1546795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546803">x</span><span class="op" id="1546804">.</span><span class="ident" id="1546805">overflow</span>&nbsp;<span class="op" id="1546814">=</span>&nbsp;<span class="ident" id="1546816">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546827">x</span>&nbsp;<span class="op" id="1546829">=</span>&nbsp;<span class="ident" id="1546831">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546842">xi</span>&nbsp;<span class="op" id="1546845">=</span>&nbsp;<span class="num" id="1546847">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546855">xk</span>&nbsp;<span class="op" id="1546858">=</span>&nbsp;<span class="ident" id="1546860">add</span><span class="op" id="1546863">(</span><span class="ident" id="1546864">unsafe</span><span class="op" id="1546870">.</span><span class="ident" id="1546871">Pointer</span><span class="op" id="1546878">(</span><span class="ident" id="1546879">x</span><span class="op" id="1546880">)</span><span class="op" id="1546881">,</span>&nbsp;<span class="ident" id="1546883">dataOffset</span><span class="op" id="1546893">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546901">xv</span>&nbsp;<span class="op" id="1546904">=</span>&nbsp;<span class="ident" id="1546906">add</span><span class="op" id="1546909">(</span><span class="ident" id="1546910">xk</span><span class="op" id="1546912">,</span>&nbsp;<span class="ident" id="1546914">bucketCnt</span><span class="op" id="1546923">*</span><span class="builtintype" id="1546924">uintptr</span><span class="op" id="1546931">(</span><span class="ident" id="1546932">t</span><span class="op" id="1546933">.</span><span class="ident" id="1546934">keysize</span><span class="op" id="1546941">)</span><span class="op" id="1546942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546956">x</span><span class="op" id="1546957">.</span><span class="ident" id="1546958">tophash</span><span class="op" id="1546965">[</span><span class="ident" id="1546966">xi</span><span class="op" id="1546968">]</span>&nbsp;<span class="op" id="1546970">=</span>&nbsp;<span class="ident" id="1546972">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546981">if</span>&nbsp;<span class="ident" id="1546984">t</span><span class="op" id="1546985">.</span><span class="ident" id="1546986">indirectkey</span>&nbsp;<span class="op" id="1546998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547006">*</span><span class="op" id="1547007">(</span><span class="op" id="1547008">*</span><span class="ident" id="1547009">unsafe</span><span class="op" id="1547015">.</span><span class="ident" id="1547016">Pointer</span><span class="op" id="1547023">)</span><span class="op" id="1547024">(</span><span class="ident" id="1547025">xk</span><span class="op" id="1547027">)</span>&nbsp;<span class="op" id="1547029">=</span>&nbsp;<span class="ident" id="1547031">k2</span>&nbsp;<span class="comment" id="1547034">//&nbsp;copy&nbsp;pointer</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547055">}</span>&nbsp;<span class="keyword" id="1547057">else</span>&nbsp;<span class="op" id="1547062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547070">memmove</span><span class="op" id="1547077">(</span><span class="ident" id="1547078">xk</span><span class="op" id="1547080">,</span>&nbsp;<span class="ident" id="1547082">k</span><span class="op" id="1547083">,</span>&nbsp;<span class="builtintype" id="1547085">uintptr</span><span class="op" id="1547092">(</span><span class="ident" id="1547093">t</span><span class="op" id="1547094">.</span><span class="ident" id="1547095">key</span><span class="op" id="1547098">.</span><span class="ident" id="1547099">size</span><span class="op" id="1547103">)</span><span class="op" id="1547104">)</span>&nbsp;<span class="comment" id="1547106">//&nbsp;copy&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547132">if</span>&nbsp;<span class="ident" id="1547135">t</span><span class="op" id="1547136">.</span><span class="ident" id="1547137">indirectvalue</span>&nbsp;<span class="op" id="1547151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547159">*</span><span class="op" id="1547160">(</span><span class="op" id="1547161">*</span><span class="ident" id="1547162">unsafe</span><span class="op" id="1547168">.</span><span class="ident" id="1547169">Pointer</span><span class="op" id="1547176">)</span><span class="op" id="1547177">(</span><span class="ident" id="1547178">xv</span><span class="op" id="1547180">)</span>&nbsp;<span class="op" id="1547182">=</span>&nbsp;<span class="op" id="1547184">*</span><span class="op" id="1547185">(</span><span class="op" id="1547186">*</span><span class="ident" id="1547187">unsafe</span><span class="op" id="1547193">.</span><span class="ident" id="1547194">Pointer</span><span class="op" id="1547201">)</span><span class="op" id="1547202">(</span><span class="ident" id="1547203">v</span><span class="op" id="1547204">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547211">}</span>&nbsp;<span class="keyword" id="1547213">else</span>&nbsp;<span class="op" id="1547218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547226">memmove</span><span class="op" id="1547233">(</span><span class="ident" id="1547234">xv</span><span class="op" id="1547236">,</span>&nbsp;<span class="ident" id="1547238">v</span><span class="op" id="1547239">,</span>&nbsp;<span class="builtintype" id="1547241">uintptr</span><span class="op" id="1547248">(</span><span class="ident" id="1547249">t</span><span class="op" id="1547250">.</span><span class="ident" id="1547251">elem</span><span class="op" id="1547255">.</span><span class="ident" id="1547256">size</span><span class="op" id="1547260">)</span><span class="op" id="1547261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547275">xi</span><span class="op" id="1547277">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547285">xk</span>&nbsp;<span class="op" id="1547288">=</span>&nbsp;<span class="ident" id="1547290">add</span><span class="op" id="1547293">(</span><span class="ident" id="1547294">xk</span><span class="op" id="1547296">,</span>&nbsp;<span class="builtintype" id="1547298">uintptr</span><span class="op" id="1547305">(</span><span class="ident" id="1547306">t</span><span class="op" id="1547307">.</span><span class="ident" id="1547308">keysize</span><span class="op" id="1547315">)</span><span class="op" id="1547316">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547323">xv</span>&nbsp;<span class="op" id="1547326">=</span>&nbsp;<span class="ident" id="1547328">add</span><span class="op" id="1547331">(</span><span class="ident" id="1547332">xv</span><span class="op" id="1547334">,</span>&nbsp;<span class="builtintype" id="1547336">uintptr</span><span class="op" id="1547343">(</span><span class="ident" id="1547344">t</span><span class="op" id="1547345">.</span><span class="ident" id="1547346">valuesize</span><span class="op" id="1547355">)</span><span class="op" id="1547356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547362">}</span>&nbsp;<span class="keyword" id="1547364">else</span>&nbsp;<span class="op" id="1547369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547376">b</span><span class="op" id="1547377">.</span><span class="ident" id="1547378">tophash</span><span class="op" id="1547385">[</span><span class="ident" id="1547386">i</span><span class="op" id="1547387">]</span>&nbsp;<span class="op" id="1547389">=</span>&nbsp;<span class="ident" id="1547391">evacuatedY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547407">if</span>&nbsp;<span class="ident" id="1547410">yi</span>&nbsp;<span class="op" id="1547413">==</span>&nbsp;<span class="ident" id="1547416">bucketCnt</span>&nbsp;<span class="op" id="1547426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547434">if</span>&nbsp;<span class="ident" id="1547437">checkgc</span>&nbsp;<span class="op" id="1547445">{</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547454">memstats</span><span class="op" id="1547462">.</span><span class="ident" id="1547463">next_gc</span>&nbsp;<span class="op" id="1547471">=</span>&nbsp;<span class="ident" id="1547473">memstats</span><span class="op" id="1547481">.</span><span class="ident" id="1547482">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547507">newy</span>&nbsp;<span class="op" id="1547512">:=</span>&nbsp;<span class="op" id="1547515">(</span><span class="op" id="1547516">*</span><span class="ident" id="1547517">bmap</span><span class="op" id="1547521">)</span><span class="op" id="1547522">(</span><span class="ident" id="1547523">newobject</span><span class="op" id="1547532">(</span><span class="ident" id="1547533">t</span><span class="op" id="1547534">.</span><span class="ident" id="1547535">bucket</span><span class="op" id="1547541">)</span><span class="op" id="1547542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547550">y</span><span class="op" id="1547551">.</span><span class="ident" id="1547552">overflow</span>&nbsp;<span class="op" id="1547561">=</span>&nbsp;<span class="ident" id="1547563">newy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547574">y</span>&nbsp;<span class="op" id="1547576">=</span>&nbsp;<span class="ident" id="1547578">newy</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547589">yi</span>&nbsp;<span class="op" id="1547592">=</span>&nbsp;<span class="num" id="1547594">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547602">yk</span>&nbsp;<span class="op" id="1547605">=</span>&nbsp;<span class="ident" id="1547607">add</span><span class="op" id="1547610">(</span><span class="ident" id="1547611">unsafe</span><span class="op" id="1547617">.</span><span class="ident" id="1547618">Pointer</span><span class="op" id="1547625">(</span><span class="ident" id="1547626">y</span><span class="op" id="1547627">)</span><span class="op" id="1547628">,</span>&nbsp;<span class="ident" id="1547630">dataOffset</span><span class="op" id="1547640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547648">yv</span>&nbsp;<span class="op" id="1547651">=</span>&nbsp;<span class="ident" id="1547653">add</span><span class="op" id="1547656">(</span><span class="ident" id="1547657">yk</span><span class="op" id="1547659">,</span>&nbsp;<span class="ident" id="1547661">bucketCnt</span><span class="op" id="1547670">*</span><span class="builtintype" id="1547671">uintptr</span><span class="op" id="1547678">(</span><span class="ident" id="1547679">t</span><span class="op" id="1547680">.</span><span class="ident" id="1547681">keysize</span><span class="op" id="1547688">)</span><span class="op" id="1547689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547703">y</span><span class="op" id="1547704">.</span><span class="ident" id="1547705">tophash</span><span class="op" id="1547712">[</span><span class="ident" id="1547713">yi</span><span class="op" id="1547715">]</span>&nbsp;<span class="op" id="1547717">=</span>&nbsp;<span class="ident" id="1547719">top</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547728">if</span>&nbsp;<span class="ident" id="1547731">t</span><span class="op" id="1547732">.</span><span class="ident" id="1547733">indirectkey</span>&nbsp;<span class="op" id="1547745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547753">*</span><span class="op" id="1547754">(</span><span class="op" id="1547755">*</span><span class="ident" id="1547756">unsafe</span><span class="op" id="1547762">.</span><span class="ident" id="1547763">Pointer</span><span class="op" id="1547770">)</span><span class="op" id="1547771">(</span><span class="ident" id="1547772">yk</span><span class="op" id="1547774">)</span>&nbsp;<span class="op" id="1547776">=</span>&nbsp;<span class="ident" id="1547778">k2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547786">}</span>&nbsp;<span class="keyword" id="1547788">else</span>&nbsp;<span class="op" id="1547793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547801">memmove</span><span class="op" id="1547808">(</span><span class="ident" id="1547809">yk</span><span class="op" id="1547811">,</span>&nbsp;<span class="ident" id="1547813">k</span><span class="op" id="1547814">,</span>&nbsp;<span class="builtintype" id="1547816">uintptr</span><span class="op" id="1547823">(</span><span class="ident" id="1547824">t</span><span class="op" id="1547825">.</span><span class="ident" id="1547826">key</span><span class="op" id="1547829">.</span><span class="ident" id="1547830">size</span><span class="op" id="1547834">)</span><span class="op" id="1547835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547842">}</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547849">if</span>&nbsp;<span class="ident" id="1547852">t</span><span class="op" id="1547853">.</span><span class="ident" id="1547854">indirectvalue</span>&nbsp;<span class="op" id="1547868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547876">*</span><span class="op" id="1547877">(</span><span class="op" id="1547878">*</span><span class="ident" id="1547879">unsafe</span><span class="op" id="1547885">.</span><span class="ident" id="1547886">Pointer</span><span class="op" id="1547893">)</span><span class="op" id="1547894">(</span><span class="ident" id="1547895">yv</span><span class="op" id="1547897">)</span>&nbsp;<span class="op" id="1547899">=</span>&nbsp;<span class="op" id="1547901">*</span><span class="op" id="1547902">(</span><span class="op" id="1547903">*</span><span class="ident" id="1547904">unsafe</span><span class="op" id="1547910">.</span><span class="ident" id="1547911">Pointer</span><span class="op" id="1547918">)</span><span class="op" id="1547919">(</span><span class="ident" id="1547920">v</span><span class="op" id="1547921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547928">}</span>&nbsp;<span class="keyword" id="1547930">else</span>&nbsp;<span class="op" id="1547935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547943">memmove</span><span class="op" id="1547950">(</span><span class="ident" id="1547951">yv</span><span class="op" id="1547953">,</span>&nbsp;<span class="ident" id="1547955">v</span><span class="op" id="1547956">,</span>&nbsp;<span class="builtintype" id="1547958">uintptr</span><span class="op" id="1547965">(</span><span class="ident" id="1547966">t</span><span class="op" id="1547967">.</span><span class="ident" id="1547968">elem</span><span class="op" id="1547972">.</span><span class="ident" id="1547973">size</span><span class="op" id="1547977">)</span><span class="op" id="1547978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547985">}</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547992">yi</span><span class="op" id="1547994">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548002">yk</span>&nbsp;<span class="op" id="1548005">=</span>&nbsp;<span class="ident" id="1548007">add</span><span class="op" id="1548010">(</span><span class="ident" id="1548011">yk</span><span class="op" id="1548013">,</span>&nbsp;<span class="builtintype" id="1548015">uintptr</span><span class="op" id="1548022">(</span><span class="ident" id="1548023">t</span><span class="op" id="1548024">.</span><span class="ident" id="1548025">keysize</span><span class="op" id="1548032">)</span><span class="op" id="1548033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548040">yv</span>&nbsp;<span class="op" id="1548043">=</span>&nbsp;<span class="ident" id="1548045">add</span><span class="op" id="1548048">(</span><span class="ident" id="1548049">yv</span><span class="op" id="1548051">,</span>&nbsp;<span class="builtintype" id="1548053">uintptr</span><span class="op" id="1548060">(</span><span class="ident" id="1548061">t</span><span class="op" id="1548062">.</span><span class="ident" id="1548063">valuesize</span><span class="op" id="1548072">)</span><span class="op" id="1548073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548084">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548092">//&nbsp;Unlink&nbsp;the&nbsp;overflow&nbsp;buckets&nbsp;&amp;&nbsp;clear&nbsp;key/value&nbsp;to&nbsp;help&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548155">if</span>&nbsp;<span class="ident" id="1548158">h</span><span class="op" id="1548159">.</span><span class="ident" id="1548160">flags</span><span class="op" id="1548165">&amp;</span><span class="ident" id="1548166">oldIterator</span>&nbsp;<span class="op" id="1548178">==</span>&nbsp;<span class="num" id="1548181">0</span>&nbsp;<span class="op" id="1548183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548188">b</span>&nbsp;<span class="op" id="1548190">=</span>&nbsp;<span class="op" id="1548192">(</span><span class="op" id="1548193">*</span><span class="ident" id="1548194">bmap</span><span class="op" id="1548198">)</span><span class="op" id="1548199">(</span><span class="ident" id="1548200">add</span><span class="op" id="1548203">(</span><span class="ident" id="1548204">h</span><span class="op" id="1548205">.</span><span class="ident" id="1548206">oldbuckets</span><span class="op" id="1548216">,</span>&nbsp;<span class="ident" id="1548218">oldbucket</span><span class="op" id="1548227">*</span><span class="builtintype" id="1548228">uintptr</span><span class="op" id="1548235">(</span><span class="ident" id="1548236">t</span><span class="op" id="1548237">.</span><span class="ident" id="1548238">bucketsize</span><span class="op" id="1548248">)</span><span class="op" id="1548249">)</span><span class="op" id="1548250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548255">b</span><span class="op" id="1548256">.</span><span class="ident" id="1548257">overflow</span>&nbsp;<span class="op" id="1548266">=</span>&nbsp;<span class="ident" id="1548268">nil</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548275">memclr</span><span class="op" id="1548281">(</span><span class="ident" id="1548282">add</span><span class="op" id="1548285">(</span><span class="ident" id="1548286">unsafe</span><span class="op" id="1548292">.</span><span class="ident" id="1548293">Pointer</span><span class="op" id="1548300">(</span><span class="ident" id="1548301">b</span><span class="op" id="1548302">)</span><span class="op" id="1548303">,</span>&nbsp;<span class="ident" id="1548305">dataOffset</span><span class="op" id="1548315">)</span><span class="op" id="1548316">,</span>&nbsp;<span class="builtintype" id="1548318">uintptr</span><span class="op" id="1548325">(</span><span class="ident" id="1548326">t</span><span class="op" id="1548327">.</span><span class="ident" id="1548328">bucketsize</span><span class="op" id="1548338">)</span><span class="op" id="1548339">-</span><span class="ident" id="1548340">dataOffset</span><span class="op" id="1548350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548361">//&nbsp;Advance&nbsp;evacuation&nbsp;mark</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548389">if</span>&nbsp;<span class="ident" id="1548392">oldbucket</span>&nbsp;<span class="op" id="1548402">==</span>&nbsp;<span class="ident" id="1548405">h</span><span class="op" id="1548406">.</span><span class="ident" id="1548407">nevacuate</span>&nbsp;<span class="op" id="1548417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548421">h</span><span class="op" id="1548422">.</span><span class="ident" id="1548423">nevacuate</span>&nbsp;<span class="op" id="1548433">=</span>&nbsp;<span class="ident" id="1548435">oldbucket</span>&nbsp;<span class="op" id="1548445">+</span>&nbsp;<span class="num" id="1548447">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548451">if</span>&nbsp;<span class="ident" id="1548454">oldbucket</span><span class="op" id="1548463">+</span><span class="num" id="1548464">1</span>&nbsp;<span class="op" id="1548466">==</span>&nbsp;<span class="ident" id="1548469">newbit</span>&nbsp;<span class="op" id="1548476">{</span>&nbsp;<span class="comment" id="1548478">//&nbsp;newbit&nbsp;==&nbsp;#&nbsp;of&nbsp;oldbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548510">//&nbsp;Growing&nbsp;is&nbsp;all&nbsp;done.&nbsp;&nbsp;Free&nbsp;old&nbsp;main&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548566">h</span><span class="op" id="1548567">.</span><span class="ident" id="1548568">oldbuckets</span>&nbsp;<span class="op" id="1548579">=</span>&nbsp;<span class="ident" id="1548581">nil</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548590">}</span><br>
<span class="lineno"></span><span class="op" id="1548592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1548595">func</span>&nbsp;<span class="ident" id="1548600">ismapkey</span><span class="op" id="1548608">(</span><span class="ident" id="1548609">t</span>&nbsp;<span class="op" id="1548611">*</span><span class="ident" id="1548612">_type</span><span class="op" id="1548617">)</span>&nbsp;<span class="builtintype" id="1548619">bool</span>&nbsp;<span class="op" id="1548624">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548627">return</span>&nbsp;<span class="ident" id="1548634">goalg</span><span class="op" id="1548639">(</span><span class="ident" id="1548640">t</span><span class="op" id="1548641">.</span><span class="ident" id="1548642">alg</span><span class="op" id="1548645">)</span><span class="op" id="1548646">.</span><span class="ident" id="1548647">hash</span>&nbsp;<span class="op" id="1548652">!=</span>&nbsp;<span class="ident" id="1548655">nil</span><br>
<span class="lineno"></span><span class="op" id="1548659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1548662">//&nbsp;Reflect&nbsp;stubs.&nbsp;&nbsp;Called&nbsp;from&nbsp;../reflect/asm_*.s</span><br>
<span class="lineno"></span><br>
<span class="lineno">905</span><span class="keyword" id="1548713">func</span>&nbsp;<span class="ident" id="1548718">reflect_makemap</span><span class="op" id="1548733">(</span><span class="ident" id="1548734">t</span>&nbsp;<span class="op" id="1548736">*</span><span class="ident" id="1548737">maptype</span><span class="op" id="1548744">)</span>&nbsp;<span class="op" id="1548746">*</span><span class="ident" id="1548747">hmap</span>&nbsp;<span class="op" id="1548752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548755">return</span>&nbsp;<span class="ident" id="1548762">makemap</span><span class="op" id="1548769">(</span><span class="ident" id="1548770">t</span><span class="op" id="1548771">,</span>&nbsp;<span class="num" id="1548773">0</span><span class="op" id="1548774">)</span><br>
<span class="lineno"></span><span class="op" id="1548776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1548779">func</span>&nbsp;<span class="ident" id="1548784">reflect_mapaccess</span><span class="op" id="1548801">(</span><span class="ident" id="1548802">t</span>&nbsp;<span class="op" id="1548804">*</span><span class="ident" id="1548805">maptype</span><span class="op" id="1548812">,</span>&nbsp;<span class="ident" id="1548814">h</span>&nbsp;<span class="op" id="1548816">*</span><span class="ident" id="1548817">hmap</span><span class="op" id="1548821">,</span>&nbsp;<span class="ident" id="1548823">key</span>&nbsp;<span class="ident" id="1548827">unsafe</span><span class="op" id="1548833">.</span><span class="ident" id="1548834">Pointer</span><span class="op" id="1548841">)</span>&nbsp;<span class="ident" id="1548843">unsafe</span><span class="op" id="1548849">.</span><span class="ident" id="1548850">Pointer</span>&nbsp;<span class="op" id="1548858">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548861">val</span><span class="op" id="1548864">,</span>&nbsp;<span class="ident" id="1548866">ok</span>&nbsp;<span class="op" id="1548869">:=</span>&nbsp;<span class="ident" id="1548872">mapaccess2</span><span class="op" id="1548882">(</span><span class="ident" id="1548883">t</span><span class="op" id="1548884">,</span>&nbsp;<span class="ident" id="1548886">h</span><span class="op" id="1548887">,</span>&nbsp;<span class="ident" id="1548889">key</span><span class="op" id="1548892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548895">if</span>&nbsp;<span class="op" id="1548898">!</span><span class="ident" id="1548899">ok</span>&nbsp;<span class="op" id="1548902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548906">//&nbsp;reflect&nbsp;wants&nbsp;nil&nbsp;for&nbsp;a&nbsp;missing&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548951">val</span>&nbsp;<span class="op" id="1548955">=</span>&nbsp;<span class="ident" id="1548957">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548962">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548965">return</span>&nbsp;<span class="ident" id="1548972">val</span><br>
<span class="lineno"></span><span class="op" id="1548976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1548979">func</span>&nbsp;<span class="ident" id="1548984">reflect_mapassign</span><span class="op" id="1549001">(</span><span class="ident" id="1549002">t</span>&nbsp;<span class="op" id="1549004">*</span><span class="ident" id="1549005">maptype</span><span class="op" id="1549012">,</span>&nbsp;<span class="ident" id="1549014">h</span>&nbsp;<span class="op" id="1549016">*</span><span class="ident" id="1549017">hmap</span><span class="op" id="1549021">,</span>&nbsp;<span class="ident" id="1549023">key</span>&nbsp;<span class="ident" id="1549027">unsafe</span><span class="op" id="1549033">.</span><span class="ident" id="1549034">Pointer</span><span class="op" id="1549041">,</span>&nbsp;<span class="ident" id="1549043">val</span>&nbsp;<span class="ident" id="1549047">unsafe</span><span class="op" id="1549053">.</span><span class="ident" id="1549054">Pointer</span><span class="op" id="1549061">)</span>&nbsp;<span class="op" id="1549063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549066">mapassign1</span><span class="op" id="1549076">(</span><span class="ident" id="1549077">t</span><span class="op" id="1549078">,</span>&nbsp;<span class="ident" id="1549080">h</span><span class="op" id="1549081">,</span>&nbsp;<span class="ident" id="1549083">key</span><span class="op" id="1549086">,</span>&nbsp;<span class="ident" id="1549088">val</span><span class="op" id="1549091">)</span><br>
<span class="lineno">920</span><span class="op" id="1549093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1549096">func</span>&nbsp;<span class="ident" id="1549101">reflect_mapdelete</span><span class="op" id="1549118">(</span><span class="ident" id="1549119">t</span>&nbsp;<span class="op" id="1549121">*</span><span class="ident" id="1549122">maptype</span><span class="op" id="1549129">,</span>&nbsp;<span class="ident" id="1549131">h</span>&nbsp;<span class="op" id="1549133">*</span><span class="ident" id="1549134">hmap</span><span class="op" id="1549138">,</span>&nbsp;<span class="ident" id="1549140">key</span>&nbsp;<span class="ident" id="1549144">unsafe</span><span class="op" id="1549150">.</span><span class="ident" id="1549151">Pointer</span><span class="op" id="1549158">)</span>&nbsp;<span class="op" id="1549160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549163">mapdelete</span><span class="op" id="1549172">(</span><span class="ident" id="1549173">t</span><span class="op" id="1549174">,</span>&nbsp;<span class="ident" id="1549176">h</span><span class="op" id="1549177">,</span>&nbsp;<span class="ident" id="1549179">key</span><span class="op" id="1549182">)</span><br>
<span class="lineno"></span><span class="op" id="1549184">}</span><br>
<span class="lineno">925</span><br>
<span class="lineno"></span><span class="keyword" id="1549187">func</span>&nbsp;<span class="ident" id="1549192">reflect_mapiterinit</span><span class="op" id="1549211">(</span><span class="ident" id="1549212">t</span>&nbsp;<span class="op" id="1549214">*</span><span class="ident" id="1549215">maptype</span><span class="op" id="1549222">,</span>&nbsp;<span class="ident" id="1549224">h</span>&nbsp;<span class="op" id="1549226">*</span><span class="ident" id="1549227">hmap</span><span class="op" id="1549231">)</span>&nbsp;<span class="op" id="1549233">*</span><span class="ident" id="1549234">hiter</span>&nbsp;<span class="op" id="1549240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549243">it</span>&nbsp;<span class="op" id="1549246">:=</span>&nbsp;<span class="builtinfunc" id="1549249">new</span><span class="op" id="1549252">(</span><span class="ident" id="1549253">hiter</span><span class="op" id="1549258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549261">mapiterinit</span><span class="op" id="1549272">(</span><span class="ident" id="1549273">t</span><span class="op" id="1549274">,</span>&nbsp;<span class="ident" id="1549276">h</span><span class="op" id="1549277">,</span>&nbsp;<span class="ident" id="1549279">it</span><span class="op" id="1549281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549284">return</span>&nbsp;<span class="ident" id="1549291">it</span><br>
<span class="lineno">930</span><span class="op" id="1549294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1549297">func</span>&nbsp;<span class="ident" id="1549302">reflect_mapiternext</span><span class="op" id="1549321">(</span><span class="ident" id="1549322">it</span>&nbsp;<span class="op" id="1549325">*</span><span class="ident" id="1549326">hiter</span><span class="op" id="1549331">)</span>&nbsp;<span class="op" id="1549333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549336">mapiternext</span><span class="op" id="1549347">(</span><span class="ident" id="1549348">it</span><span class="op" id="1549350">)</span><br>
<span class="lineno"></span><span class="op" id="1549352">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="keyword" id="1549355">func</span>&nbsp;<span class="ident" id="1549360">reflect_mapiterkey</span><span class="op" id="1549378">(</span><span class="ident" id="1549379">it</span>&nbsp;<span class="op" id="1549382">*</span><span class="ident" id="1549383">hiter</span><span class="op" id="1549388">)</span>&nbsp;<span class="ident" id="1549390">unsafe</span><span class="op" id="1549396">.</span><span class="ident" id="1549397">Pointer</span>&nbsp;<span class="op" id="1549405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549408">return</span>&nbsp;<span class="ident" id="1549415">it</span><span class="op" id="1549417">.</span><span class="ident" id="1549418">key</span><br>
<span class="lineno"></span><span class="op" id="1549422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">940</span><span class="keyword" id="1549425">func</span>&nbsp;<span class="ident" id="1549430">reflect_maplen</span><span class="op" id="1549444">(</span><span class="ident" id="1549445">h</span>&nbsp;<span class="op" id="1549447">*</span><span class="ident" id="1549448">hmap</span><span class="op" id="1549452">)</span>&nbsp;<span class="builtintype" id="1549454">int</span>&nbsp;<span class="op" id="1549458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549461">if</span>&nbsp;<span class="ident" id="1549464">h</span>&nbsp;<span class="op" id="1549466">==</span>&nbsp;<span class="ident" id="1549469">nil</span>&nbsp;<span class="op" id="1549473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549477">return</span>&nbsp;<span class="num" id="1549484">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549490">if</span>&nbsp;<span class="ident" id="1549493">raceenabled</span>&nbsp;<span class="op" id="1549505">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549509">callerpc</span>&nbsp;<span class="op" id="1549518">:=</span>&nbsp;<span class="ident" id="1549521">getcallerpc</span><span class="op" id="1549532">(</span><span class="ident" id="1549533">unsafe</span><span class="op" id="1549539">.</span><span class="ident" id="1549540">Pointer</span><span class="op" id="1549547">(</span><span class="op" id="1549548">&amp;</span><span class="ident" id="1549549">h</span><span class="op" id="1549550">)</span><span class="op" id="1549551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549555">racereadpc</span><span class="op" id="1549565">(</span><span class="ident" id="1549566">unsafe</span><span class="op" id="1549572">.</span><span class="ident" id="1549573">Pointer</span><span class="op" id="1549580">(</span><span class="ident" id="1549581">h</span><span class="op" id="1549582">)</span><span class="op" id="1549583">,</span>&nbsp;<span class="ident" id="1549585">callerpc</span><span class="op" id="1549593">,</span>&nbsp;<span class="ident" id="1549595">funcPC</span><span class="op" id="1549601">(</span><span class="ident" id="1549602">reflect_maplen</span><span class="op" id="1549616">)</span><span class="op" id="1549617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549623">return</span>&nbsp;<span class="ident" id="1549630">h</span><span class="op" id="1549631">.</span><span class="ident" id="1549632">count</span><br>
<span class="lineno"></span><span class="op" id="1549638">}</span><br>
<span class="lineno">950</span><br>
<span class="lineno"></span><span class="keyword" id="1549641">func</span>&nbsp;<span class="ident" id="1549646">reflect_ismapkey</span><span class="op" id="1549662">(</span><span class="ident" id="1549663">t</span>&nbsp;<span class="op" id="1549665">*</span><span class="ident" id="1549666">_type</span><span class="op" id="1549671">)</span>&nbsp;<span class="builtintype" id="1549673">bool</span>&nbsp;<span class="op" id="1549678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549681">return</span>&nbsp;<span class="ident" id="1549688">ismapkey</span><span class="op" id="1549696">(</span><span class="ident" id="1549697">t</span><span class="op" id="1549698">)</span><br>
<span class="lineno"></span><span class="op" id="1549700">}</span>
</div>
</body>
</html>
