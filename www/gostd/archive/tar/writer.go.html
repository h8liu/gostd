<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>archive/tar</h2>
<ul>
<li><a href="/gostd/archive/tar/common.go.html">common.go</a></li>
<li><a href="/gostd/archive/tar/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/archive/tar/reader.go.html">reader.go</a></li>
<li><a href="/gostd/archive/tar/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/archive/tar/stat_atim.go.html">stat_atim.go</a></li>
<li><a href="/gostd/archive/tar/stat_unix.go.html">stat_unix.go</a></li>
<li><a href="/gostd/archive/tar/tar_test.go.html">tar_test.go</a></li>
<li><a href="/gostd/archive/tar/writer.go.html">writer.go</a></li>
<li><a href="/gostd/archive/tar/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6109899">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6109954">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6110008">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6110059">package</span>&nbsp;<span class="ident" id="6110067">tar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6110072">//&nbsp;TODO(dsymonds):</span><br>
<span class="lineno"></span><span class="comment" id="6110091">//&nbsp;-&nbsp;catch&nbsp;more&nbsp;errors&nbsp;(no&nbsp;first&nbsp;header,&nbsp;etc.)</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="6110139">import</span>&nbsp;<span class="op" id="6110146">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6110149">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6110158">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6110168">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6110175">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6110181">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6110187">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6110195">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6110206">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6110217">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="6110224">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6110227">var</span>&nbsp;<span class="op" id="6110231">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110234">ErrWriteTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6110253">=</span>&nbsp;<span class="ident" id="6110255">errors</span><span class="op" id="6110261">.</span><span class="ident" id="6110262">New</span><span class="op" id="6110265">(</span><span class="string" id="6110266">&#34;archive/tar:&nbsp;write&nbsp;too&nbsp;long&#34;</span><span class="op" id="6110295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110298">ErrFieldTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6110317">=</span>&nbsp;<span class="ident" id="6110319">errors</span><span class="op" id="6110325">.</span><span class="ident" id="6110326">New</span><span class="op" id="6110329">(</span><span class="string" id="6110330">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&#34;</span><span class="op" id="6110366">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110369">ErrWriteAfterClose</span>&nbsp;<span class="op" id="6110388">=</span>&nbsp;<span class="ident" id="6110390">errors</span><span class="op" id="6110396">.</span><span class="ident" id="6110397">New</span><span class="op" id="6110400">(</span><span class="string" id="6110401">&#34;archive/tar:&nbsp;write&nbsp;after&nbsp;close&#34;</span><span class="op" id="6110433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110436">errNameTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6110455">=</span>&nbsp;<span class="ident" id="6110457">errors</span><span class="op" id="6110463">.</span><span class="ident" id="6110464">New</span><span class="op" id="6110467">(</span><span class="string" id="6110468">&#34;archive/tar:&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="6110496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110499">errInvalidHeader</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6110518">=</span>&nbsp;<span class="ident" id="6110520">errors</span><span class="op" id="6110526">.</span><span class="ident" id="6110527">New</span><span class="op" id="6110530">(</span><span class="string" id="6110531">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&nbsp;or&nbsp;contains&nbsp;invalid&nbsp;values&#34;</span><span class="op" id="6110594">)</span><br>
<span class="lineno"></span><span class="op" id="6110596">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="comment" id="6110599">//&nbsp;A&nbsp;Writer&nbsp;provides&nbsp;sequential&nbsp;writing&nbsp;of&nbsp;a&nbsp;tar&nbsp;archive&nbsp;in&nbsp;POSIX.1&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="6110675">//&nbsp;A&nbsp;tar&nbsp;archive&nbsp;consists&nbsp;of&nbsp;a&nbsp;sequence&nbsp;of&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="6110725">//&nbsp;Call&nbsp;WriteHeader&nbsp;to&nbsp;begin&nbsp;a&nbsp;new&nbsp;file,&nbsp;and&nbsp;then&nbsp;call&nbsp;Write&nbsp;to&nbsp;supply&nbsp;that&nbsp;file&#39;s&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="6110814">//&nbsp;writing&nbsp;at&nbsp;most&nbsp;hdr.Size&nbsp;bytes&nbsp;in&nbsp;total.</span><br>
<span class="lineno"></span><span class="keyword" id="6110858">type</span>&nbsp;<span class="ident" id="6110863">Writer</span>&nbsp;<span class="keyword" id="6110870">struct</span>&nbsp;<span class="op" id="6110877">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110880">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110891">io</span><span class="op" id="6110893">.</span><span class="ident" id="6110894">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110902">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6110913">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110920">nb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110931">int64</span>&nbsp;<span class="comment" id="6110937">//&nbsp;number&nbsp;of&nbsp;unwritten&nbsp;bytes&nbsp;for&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6110990">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111001">int64</span>&nbsp;<span class="comment" id="6111007">//&nbsp;amount&nbsp;of&nbsp;padding&nbsp;to&nbsp;write&nbsp;after&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111063">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6111074">bool</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111080">usedBinary</span>&nbsp;<span class="builtintype" id="6111091">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6111107">//&nbsp;whether&nbsp;the&nbsp;binary&nbsp;numeric&nbsp;field&nbsp;extension&nbsp;was&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111163">preferPax</span>&nbsp;&nbsp;<span class="builtintype" id="6111174">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6111190">//&nbsp;use&nbsp;pax&nbsp;header&nbsp;instead&nbsp;of&nbsp;binary&nbsp;numeric&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111242">hdrBuff</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6111253">[</span><span class="ident" id="6111254">blockSize</span><span class="op" id="6111263">]</span><span class="builtintype" id="6111264">byte</span>&nbsp;<span class="comment" id="6111269">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;regular&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111332">paxHdrBuff</span>&nbsp;<span class="op" id="6111343">[</span><span class="ident" id="6111344">blockSize</span><span class="op" id="6111353">]</span><span class="builtintype" id="6111354">byte</span>&nbsp;<span class="comment" id="6111359">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span><span class="op" id="6111417">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="6111420">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;Writer&nbsp;writing&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="6111468">func</span>&nbsp;<span class="ident" id="6111473">NewWriter</span><span class="op" id="6111482">(</span><span class="ident" id="6111483">w</span>&nbsp;<span class="ident" id="6111485">io</span><span class="op" id="6111487">.</span><span class="ident" id="6111488">Writer</span><span class="op" id="6111494">)</span>&nbsp;<span class="op" id="6111496">*</span><span class="ident" id="6111497">Writer</span>&nbsp;<span class="op" id="6111504">{</span>&nbsp;<span class="keyword" id="6111506">return</span>&nbsp;<span class="op" id="6111513">&amp;</span><span class="ident" id="6111514">Writer</span><span class="op" id="6111520">{</span><span class="ident" id="6111521">w</span><span class="op" id="6111522">:</span>&nbsp;<span class="ident" id="6111524">w</span><span class="op" id="6111525">}</span>&nbsp;<span class="op" id="6111527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6111530">//&nbsp;Flush&nbsp;finishes&nbsp;writing&nbsp;the&nbsp;current&nbsp;file&nbsp;(optional).</span><br>
<span class="lineno">50</span><span class="keyword" id="6111585">func</span>&nbsp;<span class="op" id="6111590">(</span><span class="ident" id="6111591">tw</span>&nbsp;<span class="op" id="6111594">*</span><span class="ident" id="6111595">Writer</span><span class="op" id="6111601">)</span>&nbsp;<span class="ident" id="6111603">Flush</span><span class="op" id="6111608">(</span><span class="op" id="6111609">)</span>&nbsp;<span class="builtintype" id="6111611">error</span>&nbsp;<span class="op" id="6111617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6111620">if</span>&nbsp;<span class="ident" id="6111623">tw</span><span class="op" id="6111625">.</span><span class="ident" id="6111626">nb</span>&nbsp;<span class="op" id="6111629">&gt;</span>&nbsp;<span class="num" id="6111631">0</span>&nbsp;<span class="op" id="6111633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111637">tw</span><span class="op" id="6111639">.</span><span class="ident" id="6111640">err</span>&nbsp;<span class="op" id="6111644">=</span>&nbsp;<span class="ident" id="6111646">fmt</span><span class="op" id="6111649">.</span><span class="ident" id="6111650">Errorf</span><span class="op" id="6111656">(</span><span class="string" id="6111657">&#34;archive/tar:&nbsp;missed&nbsp;writing&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="6111695">,</span>&nbsp;<span class="ident" id="6111697">tw</span><span class="op" id="6111699">.</span><span class="ident" id="6111700">nb</span><span class="op" id="6111702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6111706">return</span>&nbsp;<span class="ident" id="6111713">tw</span><span class="op" id="6111715">.</span><span class="ident" id="6111716">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6111721">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111725">n</span>&nbsp;<span class="op" id="6111727">:=</span>&nbsp;<span class="ident" id="6111730">tw</span><span class="op" id="6111732">.</span><span class="ident" id="6111733">nb</span>&nbsp;<span class="op" id="6111736">+</span>&nbsp;<span class="ident" id="6111738">tw</span><span class="op" id="6111740">.</span><span class="ident" id="6111741">pad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6111746">for</span>&nbsp;<span class="ident" id="6111750">n</span>&nbsp;<span class="op" id="6111752">&gt;</span>&nbsp;<span class="num" id="6111754">0</span>&nbsp;<span class="op" id="6111756">&amp;&amp;</span>&nbsp;<span class="ident" id="6111759">tw</span><span class="op" id="6111761">.</span><span class="ident" id="6111762">err</span>&nbsp;<span class="op" id="6111766">==</span>&nbsp;<span class="ident" id="6111769">nil</span>&nbsp;<span class="op" id="6111773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111777">nr</span>&nbsp;<span class="op" id="6111780">:=</span>&nbsp;<span class="ident" id="6111783">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6111787">if</span>&nbsp;<span class="ident" id="6111790">nr</span>&nbsp;<span class="op" id="6111793">&gt;</span>&nbsp;<span class="ident" id="6111795">blockSize</span>&nbsp;<span class="op" id="6111805">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111810">nr</span>&nbsp;<span class="op" id="6111813">=</span>&nbsp;<span class="ident" id="6111815">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6111827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6111831">var</span>&nbsp;<span class="ident" id="6111835">nw</span>&nbsp;<span class="builtintype" id="6111838">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111844">nw</span><span class="op" id="6111846">,</span>&nbsp;<span class="ident" id="6111848">tw</span><span class="op" id="6111850">.</span><span class="ident" id="6111851">err</span>&nbsp;<span class="op" id="6111855">=</span>&nbsp;<span class="ident" id="6111857">tw</span><span class="op" id="6111859">.</span><span class="ident" id="6111860">w</span><span class="op" id="6111861">.</span><span class="ident" id="6111862">Write</span><span class="op" id="6111867">(</span><span class="ident" id="6111868">zeroBlock</span><span class="op" id="6111877">[</span><span class="num" id="6111878">0</span><span class="op" id="6111879">:</span><span class="ident" id="6111880">nr</span><span class="op" id="6111882">]</span><span class="op" id="6111883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111887">n</span>&nbsp;<span class="op" id="6111889">-=</span>&nbsp;<span class="ident" id="6111892">int64</span><span class="op" id="6111897">(</span><span class="ident" id="6111898">nw</span><span class="op" id="6111900">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6111903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111906">tw</span><span class="op" id="6111908">.</span><span class="ident" id="6111909">nb</span>&nbsp;<span class="op" id="6111912">=</span>&nbsp;<span class="num" id="6111914">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6111917">tw</span><span class="op" id="6111919">.</span><span class="ident" id="6111920">pad</span>&nbsp;<span class="op" id="6111924">=</span>&nbsp;<span class="num" id="6111926">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6111929">return</span>&nbsp;<span class="ident" id="6111936">tw</span><span class="op" id="6111938">.</span><span class="ident" id="6111939">err</span><br>
<span class="lineno"></span><span class="op" id="6111943">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="6111946">//&nbsp;Write&nbsp;s&nbsp;into&nbsp;b,&nbsp;terminating&nbsp;it&nbsp;with&nbsp;a&nbsp;NUL&nbsp;if&nbsp;there&nbsp;is&nbsp;room.</span><br>
<span class="lineno"></span><span class="comment" id="6112009">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;allowPax&nbsp;is&nbsp;true&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="6112103">func</span>&nbsp;<span class="op" id="6112108">(</span><span class="ident" id="6112109">tw</span>&nbsp;<span class="op" id="6112112">*</span><span class="ident" id="6112113">Writer</span><span class="op" id="6112119">)</span>&nbsp;<span class="ident" id="6112121">cString</span><span class="op" id="6112128">(</span><span class="ident" id="6112129">b</span>&nbsp;<span class="op" id="6112131">[</span><span class="op" id="6112132">]</span><span class="builtintype" id="6112133">byte</span><span class="op" id="6112137">,</span>&nbsp;<span class="ident" id="6112139">s</span>&nbsp;<span class="builtintype" id="6112141">string</span><span class="op" id="6112147">,</span>&nbsp;<span class="ident" id="6112149">allowPax</span>&nbsp;<span class="builtintype" id="6112158">bool</span><span class="op" id="6112162">,</span>&nbsp;<span class="ident" id="6112164">paxKeyword</span>&nbsp;<span class="builtintype" id="6112175">string</span><span class="op" id="6112181">,</span>&nbsp;<span class="ident" id="6112183">paxHeaders</span>&nbsp;<span class="keyword" id="6112194">map</span><span class="op" id="6112197">[</span><span class="builtintype" id="6112198">string</span><span class="op" id="6112204">]</span><span class="builtintype" id="6112205">string</span><span class="op" id="6112211">)</span>&nbsp;<span class="op" id="6112213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6112216">needsPaxHeader</span>&nbsp;<span class="op" id="6112231">:=</span>&nbsp;<span class="ident" id="6112234">allowPax</span>&nbsp;<span class="op" id="6112243">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6112246">len</span><span class="op" id="6112249">(</span><span class="ident" id="6112250">s</span><span class="op" id="6112251">)</span>&nbsp;<span class="op" id="6112253">&gt;</span>&nbsp;<span class="builtinfunc" id="6112255">len</span><span class="op" id="6112258">(</span><span class="ident" id="6112259">b</span><span class="op" id="6112260">)</span>&nbsp;<span class="op" id="6112262">||</span>&nbsp;<span class="op" id="6112265">!</span><span class="ident" id="6112266">isASCII</span><span class="op" id="6112273">(</span><span class="ident" id="6112274">s</span><span class="op" id="6112275">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6112278">if</span>&nbsp;<span class="ident" id="6112281">needsPaxHeader</span>&nbsp;<span class="op" id="6112296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6112300">paxHeaders</span><span class="op" id="6112310">[</span><span class="ident" id="6112311">paxKeyword</span><span class="op" id="6112321">]</span>&nbsp;<span class="op" id="6112323">=</span>&nbsp;<span class="ident" id="6112325">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6112329">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6112337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6112340">if</span>&nbsp;<span class="builtinfunc" id="6112343">len</span><span class="op" id="6112346">(</span><span class="ident" id="6112347">s</span><span class="op" id="6112348">)</span>&nbsp;<span class="op" id="6112350">&gt;</span>&nbsp;<span class="builtinfunc" id="6112352">len</span><span class="op" id="6112355">(</span><span class="ident" id="6112356">b</span><span class="op" id="6112357">)</span>&nbsp;<span class="op" id="6112359">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6112363">if</span>&nbsp;<span class="ident" id="6112366">tw</span><span class="op" id="6112368">.</span><span class="ident" id="6112369">err</span>&nbsp;<span class="op" id="6112373">==</span>&nbsp;<span class="ident" id="6112376">nil</span>&nbsp;<span class="op" id="6112380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6112385">tw</span><span class="op" id="6112387">.</span><span class="ident" id="6112388">err</span>&nbsp;<span class="op" id="6112392">=</span>&nbsp;<span class="ident" id="6112394">ErrFieldTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6112412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6112416">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6112424">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6112427">ascii</span>&nbsp;<span class="op" id="6112433">:=</span>&nbsp;<span class="ident" id="6112436">toASCII</span><span class="op" id="6112443">(</span><span class="ident" id="6112444">s</span><span class="op" id="6112445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6112448">copy</span><span class="op" id="6112452">(</span><span class="ident" id="6112453">b</span><span class="op" id="6112454">,</span>&nbsp;<span class="ident" id="6112456">ascii</span><span class="op" id="6112461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6112464">if</span>&nbsp;<span class="builtinfunc" id="6112467">len</span><span class="op" id="6112470">(</span><span class="ident" id="6112471">ascii</span><span class="op" id="6112476">)</span>&nbsp;<span class="op" id="6112478">&lt;</span>&nbsp;<span class="builtinfunc" id="6112480">len</span><span class="op" id="6112483">(</span><span class="ident" id="6112484">b</span><span class="op" id="6112485">)</span>&nbsp;<span class="op" id="6112487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6112491">b</span><span class="op" id="6112492">[</span><span class="builtinfunc" id="6112493">len</span><span class="op" id="6112496">(</span><span class="ident" id="6112497">ascii</span><span class="op" id="6112502">)</span><span class="op" id="6112503">]</span>&nbsp;<span class="op" id="6112505">=</span>&nbsp;<span class="num" id="6112507">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6112510">}</span><br>
<span class="lineno">90</span><span class="op" id="6112512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6112515">//&nbsp;Encode&nbsp;x&nbsp;as&nbsp;an&nbsp;octal&nbsp;ASCII&nbsp;string&nbsp;and&nbsp;write&nbsp;it&nbsp;into&nbsp;b&nbsp;with&nbsp;leading&nbsp;zeros.</span><br>
<span class="lineno"></span><span class="keyword" id="6112592">func</span>&nbsp;<span class="op" id="6112597">(</span><span class="ident" id="6112598">tw</span>&nbsp;<span class="op" id="6112601">*</span><span class="ident" id="6112602">Writer</span><span class="op" id="6112608">)</span>&nbsp;<span class="ident" id="6112610">octal</span><span class="op" id="6112615">(</span><span class="ident" id="6112616">b</span>&nbsp;<span class="op" id="6112618">[</span><span class="op" id="6112619">]</span><span class="builtintype" id="6112620">byte</span><span class="op" id="6112624">,</span>&nbsp;<span class="ident" id="6112626">x</span>&nbsp;<span class="ident" id="6112628">int64</span><span class="op" id="6112633">)</span>&nbsp;<span class="op" id="6112635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6112638">s</span>&nbsp;<span class="op" id="6112640">:=</span>&nbsp;<span class="ident" id="6112643">strconv</span><span class="op" id="6112650">.</span><span class="ident" id="6112651">FormatInt</span><span class="op" id="6112660">(</span><span class="ident" id="6112661">x</span><span class="op" id="6112662">,</span>&nbsp;<span class="num" id="6112664">8</span><span class="op" id="6112665">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6112668">//&nbsp;leading&nbsp;zeros,&nbsp;but&nbsp;leave&nbsp;room&nbsp;for&nbsp;a&nbsp;NUL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6112713">for</span>&nbsp;<span class="builtinfunc" id="6112717">len</span><span class="op" id="6112720">(</span><span class="ident" id="6112721">s</span><span class="op" id="6112722">)</span><span class="op" id="6112723">+</span><span class="num" id="6112724">1</span>&nbsp;<span class="op" id="6112726">&lt;</span>&nbsp;<span class="builtinfunc" id="6112728">len</span><span class="op" id="6112731">(</span><span class="ident" id="6112732">b</span><span class="op" id="6112733">)</span>&nbsp;<span class="op" id="6112735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6112739">s</span>&nbsp;<span class="op" id="6112741">=</span>&nbsp;<span class="string" id="6112743">&#34;0&#34;</span>&nbsp;<span class="op" id="6112747">+</span>&nbsp;<span class="ident" id="6112749">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6112752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6112755">tw</span><span class="op" id="6112757">.</span><span class="ident" id="6112758">cString</span><span class="op" id="6112765">(</span><span class="ident" id="6112766">b</span><span class="op" id="6112767">,</span>&nbsp;<span class="ident" id="6112769">s</span><span class="op" id="6112770">,</span>&nbsp;<span class="builtintype" id="6112772">false</span><span class="op" id="6112777">,</span>&nbsp;<span class="ident" id="6112779">paxNone</span><span class="op" id="6112786">,</span>&nbsp;<span class="ident" id="6112788">nil</span><span class="op" id="6112791">)</span><br>
<span class="lineno">100</span><span class="op" id="6112793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6112796">//&nbsp;Write&nbsp;x&nbsp;into&nbsp;b,&nbsp;either&nbsp;as&nbsp;octal&nbsp;or&nbsp;as&nbsp;binary&nbsp;(GNUtar/star&nbsp;extension).</span><br>
<span class="lineno"></span><span class="comment" id="6112869">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;writingPax&nbsp;is&nbsp;enabled&nbsp;both&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;the&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="6112995">func</span>&nbsp;<span class="op" id="6113000">(</span><span class="ident" id="6113001">tw</span>&nbsp;<span class="op" id="6113004">*</span><span class="ident" id="6113005">Writer</span><span class="op" id="6113011">)</span>&nbsp;<span class="ident" id="6113013">numeric</span><span class="op" id="6113020">(</span><span class="ident" id="6113021">b</span>&nbsp;<span class="op" id="6113023">[</span><span class="op" id="6113024">]</span><span class="builtintype" id="6113025">byte</span><span class="op" id="6113029">,</span>&nbsp;<span class="ident" id="6113031">x</span>&nbsp;<span class="ident" id="6113033">int64</span><span class="op" id="6113038">,</span>&nbsp;<span class="ident" id="6113040">allowPax</span>&nbsp;<span class="builtintype" id="6113049">bool</span><span class="op" id="6113053">,</span>&nbsp;<span class="ident" id="6113055">paxKeyword</span>&nbsp;<span class="builtintype" id="6113066">string</span><span class="op" id="6113072">,</span>&nbsp;<span class="ident" id="6113074">paxHeaders</span>&nbsp;<span class="keyword" id="6113085">map</span><span class="op" id="6113088">[</span><span class="builtintype" id="6113089">string</span><span class="op" id="6113095">]</span><span class="builtintype" id="6113096">string</span><span class="op" id="6113102">)</span>&nbsp;<span class="op" id="6113104">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6113107">//&nbsp;Try&nbsp;octal&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113128">s</span>&nbsp;<span class="op" id="6113130">:=</span>&nbsp;<span class="ident" id="6113133">strconv</span><span class="op" id="6113140">.</span><span class="ident" id="6113141">FormatInt</span><span class="op" id="6113150">(</span><span class="ident" id="6113151">x</span><span class="op" id="6113152">,</span>&nbsp;<span class="num" id="6113154">8</span><span class="op" id="6113155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113158">if</span>&nbsp;<span class="builtinfunc" id="6113161">len</span><span class="op" id="6113164">(</span><span class="ident" id="6113165">s</span><span class="op" id="6113166">)</span>&nbsp;<span class="op" id="6113168">&lt;</span>&nbsp;<span class="builtinfunc" id="6113170">len</span><span class="op" id="6113173">(</span><span class="ident" id="6113174">b</span><span class="op" id="6113175">)</span>&nbsp;<span class="op" id="6113177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113181">tw</span><span class="op" id="6113183">.</span><span class="ident" id="6113184">octal</span><span class="op" id="6113189">(</span><span class="ident" id="6113190">b</span><span class="op" id="6113191">,</span>&nbsp;<span class="ident" id="6113193">x</span><span class="op" id="6113194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113198">return</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6113206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6113210">//&nbsp;If&nbsp;it&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;octal,&nbsp;and&nbsp;pax&nbsp;is&nbsp;preferred,&nbsp;use&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113282">if</span>&nbsp;<span class="ident" id="6113285">allowPax</span>&nbsp;<span class="op" id="6113294">&amp;&amp;</span>&nbsp;<span class="ident" id="6113297">tw</span><span class="op" id="6113299">.</span><span class="ident" id="6113300">preferPax</span>&nbsp;<span class="op" id="6113310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113314">tw</span><span class="op" id="6113316">.</span><span class="ident" id="6113317">octal</span><span class="op" id="6113322">(</span><span class="ident" id="6113323">b</span><span class="op" id="6113324">,</span>&nbsp;<span class="num" id="6113326">0</span><span class="op" id="6113327">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113331">s</span>&nbsp;<span class="op" id="6113333">:=</span>&nbsp;<span class="ident" id="6113336">strconv</span><span class="op" id="6113343">.</span><span class="ident" id="6113344">FormatInt</span><span class="op" id="6113353">(</span><span class="ident" id="6113354">x</span><span class="op" id="6113355">,</span>&nbsp;<span class="num" id="6113357">10</span><span class="op" id="6113359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113363">paxHeaders</span><span class="op" id="6113373">[</span><span class="ident" id="6113374">paxKeyword</span><span class="op" id="6113384">]</span>&nbsp;<span class="op" id="6113386">=</span>&nbsp;<span class="ident" id="6113388">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113392">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6113400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6113404">//&nbsp;Too&nbsp;big:&nbsp;use&nbsp;binary&nbsp;(big-endian).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113442">tw</span><span class="op" id="6113444">.</span><span class="ident" id="6113445">usedBinary</span>&nbsp;<span class="op" id="6113456">=</span>&nbsp;<span class="builtintype" id="6113458">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113464">for</span>&nbsp;<span class="ident" id="6113468">i</span>&nbsp;<span class="op" id="6113470">:=</span>&nbsp;<span class="builtinfunc" id="6113473">len</span><span class="op" id="6113476">(</span><span class="ident" id="6113477">b</span><span class="op" id="6113478">)</span>&nbsp;<span class="op" id="6113480">-</span>&nbsp;<span class="num" id="6113482">1</span><span class="op" id="6113483">;</span>&nbsp;<span class="ident" id="6113485">x</span>&nbsp;<span class="op" id="6113487">&gt;</span>&nbsp;<span class="num" id="6113489">0</span>&nbsp;<span class="op" id="6113491">&amp;&amp;</span>&nbsp;<span class="ident" id="6113494">i</span>&nbsp;<span class="op" id="6113496">&gt;=</span>&nbsp;<span class="num" id="6113499">0</span><span class="op" id="6113500">;</span>&nbsp;<span class="ident" id="6113502">i</span><span class="op" id="6113503">--</span>&nbsp;<span class="op" id="6113506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113510">b</span><span class="op" id="6113511">[</span><span class="ident" id="6113512">i</span><span class="op" id="6113513">]</span>&nbsp;<span class="op" id="6113515">=</span>&nbsp;<span class="builtintype" id="6113517">byte</span><span class="op" id="6113521">(</span><span class="ident" id="6113522">x</span><span class="op" id="6113523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113527">x</span>&nbsp;<span class="op" id="6113529">&gt;&gt;=</span>&nbsp;<span class="num" id="6113533">8</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6113536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113539">b</span><span class="op" id="6113540">[</span><span class="num" id="6113541">0</span><span class="op" id="6113542">]</span>&nbsp;<span class="op" id="6113544">|=</span>&nbsp;<span class="num" id="6113547">0x80</span>&nbsp;<span class="comment" id="6113552">//&nbsp;highest&nbsp;bit&nbsp;indicates&nbsp;binary&nbsp;format</span><br>
<span class="lineno"></span><span class="op" id="6113591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6113594">var</span>&nbsp;<span class="op" id="6113598">(</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113601">minTime</span>&nbsp;<span class="op" id="6113609">=</span>&nbsp;<span class="ident" id="6113611">time</span><span class="op" id="6113615">.</span><span class="ident" id="6113616">Unix</span><span class="op" id="6113620">(</span><span class="num" id="6113621">0</span><span class="op" id="6113622">,</span>&nbsp;<span class="num" id="6113624">0</span><span class="op" id="6113625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6113628">//&nbsp;There&nbsp;is&nbsp;room&nbsp;for&nbsp;11&nbsp;octal&nbsp;digits&nbsp;(33&nbsp;bits)&nbsp;of&nbsp;mtime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6113686">maxTime</span>&nbsp;<span class="op" id="6113694">=</span>&nbsp;<span class="ident" id="6113696">minTime</span><span class="op" id="6113703">.</span><span class="ident" id="6113704">Add</span><span class="op" id="6113707">(</span><span class="op" id="6113708">(</span><span class="num" id="6113709">1</span><span class="op" id="6113710">&lt;&lt;</span><span class="num" id="6113712">33</span>&nbsp;<span class="op" id="6113715">-</span>&nbsp;<span class="num" id="6113717">1</span><span class="op" id="6113718">)</span>&nbsp;<span class="op" id="6113720">*</span>&nbsp;<span class="ident" id="6113722">time</span><span class="op" id="6113726">.</span><span class="ident" id="6113727">Second</span><span class="op" id="6113733">)</span><br>
<span class="lineno"></span><span class="op" id="6113735">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="comment" id="6113738">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="6113808">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="6113866">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno"></span><span class="keyword" id="6113923">func</span>&nbsp;<span class="op" id="6113928">(</span><span class="ident" id="6113929">tw</span>&nbsp;<span class="op" id="6113932">*</span><span class="ident" id="6113933">Writer</span><span class="op" id="6113939">)</span>&nbsp;<span class="ident" id="6113941">WriteHeader</span><span class="op" id="6113952">(</span><span class="ident" id="6113953">hdr</span>&nbsp;<span class="op" id="6113957">*</span><span class="ident" id="6113958">Header</span><span class="op" id="6113964">)</span>&nbsp;<span class="builtintype" id="6113966">error</span>&nbsp;<span class="op" id="6113972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6113975">return</span>&nbsp;<span class="ident" id="6113982">tw</span><span class="op" id="6113984">.</span><span class="ident" id="6113985">writeHeader</span><span class="op" id="6113996">(</span><span class="ident" id="6113997">hdr</span><span class="op" id="6114000">,</span>&nbsp;<span class="builtintype" id="6114002">true</span><span class="op" id="6114006">)</span><br>
<span class="lineno">140</span><span class="op" id="6114008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6114011">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="6114081">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="6114139">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno">145</span><span class="comment" id="6114196">//&nbsp;As&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;internally&nbsp;by&nbsp;writePax&nbsp;header&nbsp;to&nbsp;allow&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6114269">//&nbsp;suppress&nbsp;writing&nbsp;the&nbsp;pax&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="6114305">func</span>&nbsp;<span class="op" id="6114310">(</span><span class="ident" id="6114311">tw</span>&nbsp;<span class="op" id="6114314">*</span><span class="ident" id="6114315">Writer</span><span class="op" id="6114321">)</span>&nbsp;<span class="ident" id="6114323">writeHeader</span><span class="op" id="6114334">(</span><span class="ident" id="6114335">hdr</span>&nbsp;<span class="op" id="6114339">*</span><span class="ident" id="6114340">Header</span><span class="op" id="6114346">,</span>&nbsp;<span class="ident" id="6114348">allowPax</span>&nbsp;<span class="builtintype" id="6114357">bool</span><span class="op" id="6114361">)</span>&nbsp;<span class="builtintype" id="6114363">error</span>&nbsp;<span class="op" id="6114369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6114372">if</span>&nbsp;<span class="ident" id="6114375">tw</span><span class="op" id="6114377">.</span><span class="ident" id="6114378">closed</span>&nbsp;<span class="op" id="6114385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6114389">return</span>&nbsp;<span class="ident" id="6114396">ErrWriteAfterClose</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6114416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6114419">if</span>&nbsp;<span class="ident" id="6114422">tw</span><span class="op" id="6114424">.</span><span class="ident" id="6114425">err</span>&nbsp;<span class="op" id="6114429">==</span>&nbsp;<span class="ident" id="6114432">nil</span>&nbsp;<span class="op" id="6114436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6114440">tw</span><span class="op" id="6114442">.</span><span class="ident" id="6114443">Flush</span><span class="op" id="6114448">(</span><span class="op" id="6114449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6114452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6114455">if</span>&nbsp;<span class="ident" id="6114458">tw</span><span class="op" id="6114460">.</span><span class="ident" id="6114461">err</span>&nbsp;<span class="op" id="6114465">!=</span>&nbsp;<span class="ident" id="6114468">nil</span>&nbsp;<span class="op" id="6114472">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6114476">return</span>&nbsp;<span class="ident" id="6114483">tw</span><span class="op" id="6114485">.</span><span class="ident" id="6114486">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6114491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6114495">//&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;pax&nbsp;header&nbsp;records,&nbsp;if&nbsp;any&nbsp;are&nbsp;needed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6114551">paxHeaders</span>&nbsp;<span class="op" id="6114562">:=</span>&nbsp;<span class="builtinfunc" id="6114565">make</span><span class="op" id="6114569">(</span><span class="keyword" id="6114570">map</span><span class="op" id="6114573">[</span><span class="builtintype" id="6114574">string</span><span class="op" id="6114580">]</span><span class="builtintype" id="6114581">string</span><span class="op" id="6114587">)</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6114591">//&nbsp;TODO(shanemhansen):&nbsp;we&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;PAX&nbsp;headers&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6114652">//&nbsp;subsecond&nbsp;time&nbsp;resolution,&nbsp;but&nbsp;for&nbsp;now&nbsp;let&#39;s&nbsp;just&nbsp;capture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6114714">//&nbsp;too&nbsp;long&nbsp;fields&nbsp;or&nbsp;non&nbsp;ascii&nbsp;characters</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6114759">var</span>&nbsp;<span class="ident" id="6114763">header</span>&nbsp;<span class="op" id="6114770">[</span><span class="op" id="6114771">]</span><span class="builtintype" id="6114772">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6114779">//&nbsp;We&nbsp;need&nbsp;to&nbsp;select&nbsp;which&nbsp;scratch&nbsp;buffer&nbsp;to&nbsp;use&nbsp;carefully,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6114840">//&nbsp;since&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;recursively&nbsp;to&nbsp;write&nbsp;PAX&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6114906">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;true,&nbsp;this&nbsp;is&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;and&nbsp;we&nbsp;will&nbsp;use&nbsp;hdrBuff.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6114988">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;false,&nbsp;we&nbsp;are&nbsp;being&nbsp;called&nbsp;by&nbsp;writePAXHeader,&nbsp;and&nbsp;hdrBuff&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6115068">//&nbsp;already&nbsp;being&nbsp;used&nbsp;by&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;so&nbsp;we&nbsp;must&nbsp;use&nbsp;paxHdrBuff.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115145">header</span>&nbsp;<span class="op" id="6115152">=</span>&nbsp;<span class="ident" id="6115154">tw</span><span class="op" id="6115156">.</span><span class="ident" id="6115157">hdrBuff</span><span class="op" id="6115164">[</span><span class="op" id="6115165">:</span><span class="op" id="6115166">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6115169">if</span>&nbsp;<span class="op" id="6115172">!</span><span class="ident" id="6115173">allowPax</span>&nbsp;<span class="op" id="6115182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115186">header</span>&nbsp;<span class="op" id="6115193">=</span>&nbsp;<span class="ident" id="6115195">tw</span><span class="op" id="6115197">.</span><span class="ident" id="6115198">paxHdrBuff</span><span class="op" id="6115208">[</span><span class="op" id="6115209">:</span><span class="op" id="6115210">]</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6115213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6115216">copy</span><span class="op" id="6115220">(</span><span class="ident" id="6115221">header</span><span class="op" id="6115227">,</span>&nbsp;<span class="ident" id="6115229">zeroBlock</span><span class="op" id="6115238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115241">s</span>&nbsp;<span class="op" id="6115243">:=</span>&nbsp;<span class="ident" id="6115246">slicer</span><span class="op" id="6115252">(</span><span class="ident" id="6115253">header</span><span class="op" id="6115259">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6115263">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;filename&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115391">pathHeaderBytes</span>&nbsp;<span class="op" id="6115407">:=</span>&nbsp;<span class="ident" id="6115410">s</span><span class="op" id="6115411">.</span><span class="ident" id="6115412">next</span><span class="op" id="6115416">(</span><span class="ident" id="6115417">fileNameSize</span><span class="op" id="6115429">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115433">tw</span><span class="op" id="6115435">.</span><span class="ident" id="6115436">cString</span><span class="op" id="6115443">(</span><span class="ident" id="6115444">pathHeaderBytes</span><span class="op" id="6115459">,</span>&nbsp;<span class="ident" id="6115461">hdr</span><span class="op" id="6115464">.</span><span class="ident" id="6115465">Name</span><span class="op" id="6115469">,</span>&nbsp;<span class="builtintype" id="6115471">true</span><span class="op" id="6115475">,</span>&nbsp;<span class="ident" id="6115477">paxPath</span><span class="op" id="6115484">,</span>&nbsp;<span class="ident" id="6115486">paxHeaders</span><span class="op" id="6115496">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6115500">//&nbsp;Handle&nbsp;out&nbsp;of&nbsp;range&nbsp;ModTime&nbsp;carefully.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6115543">var</span>&nbsp;<span class="ident" id="6115547">modTime</span>&nbsp;<span class="ident" id="6115555">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6115562">if</span>&nbsp;<span class="op" id="6115565">!</span><span class="ident" id="6115566">hdr</span><span class="op" id="6115569">.</span><span class="ident" id="6115570">ModTime</span><span class="op" id="6115577">.</span><span class="ident" id="6115578">Before</span><span class="op" id="6115584">(</span><span class="ident" id="6115585">minTime</span><span class="op" id="6115592">)</span>&nbsp;<span class="op" id="6115594">&amp;&amp;</span>&nbsp;<span class="op" id="6115597">!</span><span class="ident" id="6115598">hdr</span><span class="op" id="6115601">.</span><span class="ident" id="6115602">ModTime</span><span class="op" id="6115609">.</span><span class="ident" id="6115610">After</span><span class="op" id="6115615">(</span><span class="ident" id="6115616">maxTime</span><span class="op" id="6115623">)</span>&nbsp;<span class="op" id="6115625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115629">modTime</span>&nbsp;<span class="op" id="6115637">=</span>&nbsp;<span class="ident" id="6115639">hdr</span><span class="op" id="6115642">.</span><span class="ident" id="6115643">ModTime</span><span class="op" id="6115650">.</span><span class="ident" id="6115651">Unix</span><span class="op" id="6115655">(</span><span class="op" id="6115656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6115659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115663">tw</span><span class="op" id="6115665">.</span><span class="ident" id="6115666">octal</span><span class="op" id="6115671">(</span><span class="ident" id="6115672">s</span><span class="op" id="6115673">.</span><span class="ident" id="6115674">next</span><span class="op" id="6115678">(</span><span class="num" id="6115679">8</span><span class="op" id="6115680">)</span><span class="op" id="6115681">,</span>&nbsp;<span class="ident" id="6115683">hdr</span><span class="op" id="6115686">.</span><span class="ident" id="6115687">Mode</span><span class="op" id="6115691">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6115727">//&nbsp;100:108</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115739">tw</span><span class="op" id="6115741">.</span><span class="ident" id="6115742">numeric</span><span class="op" id="6115749">(</span><span class="ident" id="6115750">s</span><span class="op" id="6115751">.</span><span class="ident" id="6115752">next</span><span class="op" id="6115756">(</span><span class="num" id="6115757">8</span><span class="op" id="6115758">)</span><span class="op" id="6115759">,</span>&nbsp;<span class="ident" id="6115761">int64</span><span class="op" id="6115766">(</span><span class="ident" id="6115767">hdr</span><span class="op" id="6115770">.</span><span class="ident" id="6115771">Uid</span><span class="op" id="6115774">)</span><span class="op" id="6115775">,</span>&nbsp;<span class="builtintype" id="6115777">true</span><span class="op" id="6115781">,</span>&nbsp;<span class="ident" id="6115783">paxUid</span><span class="op" id="6115789">,</span>&nbsp;<span class="ident" id="6115791">paxHeaders</span><span class="op" id="6115801">)</span>&nbsp;<span class="comment" id="6115803">//&nbsp;108:116</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115815">tw</span><span class="op" id="6115817">.</span><span class="ident" id="6115818">numeric</span><span class="op" id="6115825">(</span><span class="ident" id="6115826">s</span><span class="op" id="6115827">.</span><span class="ident" id="6115828">next</span><span class="op" id="6115832">(</span><span class="num" id="6115833">8</span><span class="op" id="6115834">)</span><span class="op" id="6115835">,</span>&nbsp;<span class="ident" id="6115837">int64</span><span class="op" id="6115842">(</span><span class="ident" id="6115843">hdr</span><span class="op" id="6115846">.</span><span class="ident" id="6115847">Gid</span><span class="op" id="6115850">)</span><span class="op" id="6115851">,</span>&nbsp;<span class="builtintype" id="6115853">true</span><span class="op" id="6115857">,</span>&nbsp;<span class="ident" id="6115859">paxGid</span><span class="op" id="6115865">,</span>&nbsp;<span class="ident" id="6115867">paxHeaders</span><span class="op" id="6115877">)</span>&nbsp;<span class="comment" id="6115879">//&nbsp;116:124</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115891">tw</span><span class="op" id="6115893">.</span><span class="ident" id="6115894">numeric</span><span class="op" id="6115901">(</span><span class="ident" id="6115902">s</span><span class="op" id="6115903">.</span><span class="ident" id="6115904">next</span><span class="op" id="6115908">(</span><span class="num" id="6115909">12</span><span class="op" id="6115911">)</span><span class="op" id="6115912">,</span>&nbsp;<span class="ident" id="6115914">hdr</span><span class="op" id="6115917">.</span><span class="ident" id="6115918">Size</span><span class="op" id="6115922">,</span>&nbsp;<span class="builtintype" id="6115924">true</span><span class="op" id="6115928">,</span>&nbsp;<span class="ident" id="6115930">paxSize</span><span class="op" id="6115937">,</span>&nbsp;<span class="ident" id="6115939">paxHeaders</span><span class="op" id="6115949">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6115955">//&nbsp;124:136</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6115967">tw</span><span class="op" id="6115969">.</span><span class="ident" id="6115970">numeric</span><span class="op" id="6115977">(</span><span class="ident" id="6115978">s</span><span class="op" id="6115979">.</span><span class="ident" id="6115980">next</span><span class="op" id="6115984">(</span><span class="num" id="6115985">12</span><span class="op" id="6115987">)</span><span class="op" id="6115988">,</span>&nbsp;<span class="ident" id="6115990">modTime</span><span class="op" id="6115997">,</span>&nbsp;<span class="builtintype" id="6115999">false</span><span class="op" id="6116004">,</span>&nbsp;<span class="ident" id="6116006">paxNone</span><span class="op" id="6116013">,</span>&nbsp;<span class="ident" id="6116015">nil</span><span class="op" id="6116018">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6116031">//&nbsp;136:148&nbsp;---&nbsp;consider&nbsp;using&nbsp;pax&nbsp;for&nbsp;finer&nbsp;granularity</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6116088">s</span><span class="op" id="6116089">.</span><span class="ident" id="6116090">next</span><span class="op" id="6116094">(</span><span class="num" id="6116095">8</span><span class="op" id="6116096">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6116152">//&nbsp;chksum&nbsp;(148:156)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6116173">s</span><span class="op" id="6116174">.</span><span class="ident" id="6116175">next</span><span class="op" id="6116179">(</span><span class="num" id="6116180">1</span><span class="op" id="6116181">)</span><span class="op" id="6116182">[</span><span class="num" id="6116183">0</span><span class="op" id="6116184">]</span>&nbsp;<span class="op" id="6116186">=</span>&nbsp;<span class="ident" id="6116188">hdr</span><span class="op" id="6116191">.</span><span class="ident" id="6116192">Typeflag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6116237">//&nbsp;156:157</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6116250">tw</span><span class="op" id="6116252">.</span><span class="ident" id="6116253">cString</span><span class="op" id="6116260">(</span><span class="ident" id="6116261">s</span><span class="op" id="6116262">.</span><span class="ident" id="6116263">next</span><span class="op" id="6116267">(</span><span class="num" id="6116268">100</span><span class="op" id="6116271">)</span><span class="op" id="6116272">,</span>&nbsp;<span class="ident" id="6116274">hdr</span><span class="op" id="6116277">.</span><span class="ident" id="6116278">Linkname</span><span class="op" id="6116286">,</span>&nbsp;<span class="builtintype" id="6116288">true</span><span class="op" id="6116292">,</span>&nbsp;<span class="ident" id="6116294">paxLinkpath</span><span class="op" id="6116305">,</span>&nbsp;<span class="ident" id="6116307">paxHeaders</span><span class="op" id="6116317">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6116321">copy</span><span class="op" id="6116325">(</span><span class="ident" id="6116326">s</span><span class="op" id="6116327">.</span><span class="ident" id="6116328">next</span><span class="op" id="6116332">(</span><span class="num" id="6116333">8</span><span class="op" id="6116334">)</span><span class="op" id="6116335">,</span>&nbsp;<span class="op" id="6116337">[</span><span class="op" id="6116338">]</span><span class="builtintype" id="6116339">byte</span><span class="op" id="6116343">(</span><span class="string" id="6116344">&#34;ustar\x0000&#34;</span><span class="op" id="6116357">)</span><span class="op" id="6116358">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6116383">//&nbsp;257:265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6116395">tw</span><span class="op" id="6116397">.</span><span class="ident" id="6116398">cString</span><span class="op" id="6116405">(</span><span class="ident" id="6116406">s</span><span class="op" id="6116407">.</span><span class="ident" id="6116408">next</span><span class="op" id="6116412">(</span><span class="num" id="6116413">32</span><span class="op" id="6116415">)</span><span class="op" id="6116416">,</span>&nbsp;<span class="ident" id="6116418">hdr</span><span class="op" id="6116421">.</span><span class="ident" id="6116422">Uname</span><span class="op" id="6116427">,</span>&nbsp;<span class="builtintype" id="6116429">true</span><span class="op" id="6116433">,</span>&nbsp;<span class="ident" id="6116435">paxUname</span><span class="op" id="6116443">,</span>&nbsp;<span class="ident" id="6116445">paxHeaders</span><span class="op" id="6116455">)</span>&nbsp;<span class="comment" id="6116457">//&nbsp;265:297</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6116469">tw</span><span class="op" id="6116471">.</span><span class="ident" id="6116472">cString</span><span class="op" id="6116479">(</span><span class="ident" id="6116480">s</span><span class="op" id="6116481">.</span><span class="ident" id="6116482">next</span><span class="op" id="6116486">(</span><span class="num" id="6116487">32</span><span class="op" id="6116489">)</span><span class="op" id="6116490">,</span>&nbsp;<span class="ident" id="6116492">hdr</span><span class="op" id="6116495">.</span><span class="ident" id="6116496">Gname</span><span class="op" id="6116501">,</span>&nbsp;<span class="builtintype" id="6116503">true</span><span class="op" id="6116507">,</span>&nbsp;<span class="ident" id="6116509">paxGname</span><span class="op" id="6116517">,</span>&nbsp;<span class="ident" id="6116519">paxHeaders</span><span class="op" id="6116529">)</span>&nbsp;<span class="comment" id="6116531">//&nbsp;297:329</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6116543">tw</span><span class="op" id="6116545">.</span><span class="ident" id="6116546">numeric</span><span class="op" id="6116553">(</span><span class="ident" id="6116554">s</span><span class="op" id="6116555">.</span><span class="ident" id="6116556">next</span><span class="op" id="6116560">(</span><span class="num" id="6116561">8</span><span class="op" id="6116562">)</span><span class="op" id="6116563">,</span>&nbsp;<span class="ident" id="6116565">hdr</span><span class="op" id="6116568">.</span><span class="ident" id="6116569">Devmajor</span><span class="op" id="6116577">,</span>&nbsp;<span class="builtintype" id="6116579">false</span><span class="op" id="6116584">,</span>&nbsp;<span class="ident" id="6116586">paxNone</span><span class="op" id="6116593">,</span>&nbsp;<span class="ident" id="6116595">nil</span><span class="op" id="6116598">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6116605">//&nbsp;329:337</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6116617">tw</span><span class="op" id="6116619">.</span><span class="ident" id="6116620">numeric</span><span class="op" id="6116627">(</span><span class="ident" id="6116628">s</span><span class="op" id="6116629">.</span><span class="ident" id="6116630">next</span><span class="op" id="6116634">(</span><span class="num" id="6116635">8</span><span class="op" id="6116636">)</span><span class="op" id="6116637">,</span>&nbsp;<span class="ident" id="6116639">hdr</span><span class="op" id="6116642">.</span><span class="ident" id="6116643">Devminor</span><span class="op" id="6116651">,</span>&nbsp;<span class="builtintype" id="6116653">false</span><span class="op" id="6116658">,</span>&nbsp;<span class="ident" id="6116660">paxNone</span><span class="op" id="6116667">,</span>&nbsp;<span class="ident" id="6116669">nil</span><span class="op" id="6116672">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6116679">//&nbsp;337:345</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6116692">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;prefix&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6116818">prefixHeaderBytes</span>&nbsp;<span class="op" id="6116836">:=</span>&nbsp;<span class="ident" id="6116839">s</span><span class="op" id="6116840">.</span><span class="ident" id="6116841">next</span><span class="op" id="6116845">(</span><span class="num" id="6116846">155</span><span class="op" id="6116849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6116852">tw</span><span class="op" id="6116854">.</span><span class="ident" id="6116855">cString</span><span class="op" id="6116862">(</span><span class="ident" id="6116863">prefixHeaderBytes</span><span class="op" id="6116880">,</span>&nbsp;<span class="string" id="6116882">&#34;&#34;</span><span class="op" id="6116884">,</span>&nbsp;<span class="builtintype" id="6116886">false</span><span class="op" id="6116891">,</span>&nbsp;<span class="ident" id="6116893">paxNone</span><span class="op" id="6116900">,</span>&nbsp;<span class="ident" id="6116902">nil</span><span class="op" id="6116905">)</span>&nbsp;<span class="comment" id="6116907">//&nbsp;345:500&nbsp;&nbsp;prefix</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6116928">//&nbsp;Use&nbsp;the&nbsp;GNU&nbsp;magic&nbsp;instead&nbsp;of&nbsp;POSIX&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;any&nbsp;GNU&nbsp;extensions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6117004">if</span>&nbsp;<span class="ident" id="6117007">tw</span><span class="op" id="6117009">.</span><span class="ident" id="6117010">usedBinary</span>&nbsp;<span class="op" id="6117021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6117025">copy</span><span class="op" id="6117029">(</span><span class="ident" id="6117030">header</span><span class="op" id="6117036">[</span><span class="num" id="6117037">257</span><span class="op" id="6117040">:</span><span class="num" id="6117041">265</span><span class="op" id="6117044">]</span><span class="op" id="6117045">,</span>&nbsp;<span class="op" id="6117047">[</span><span class="op" id="6117048">]</span><span class="builtintype" id="6117049">byte</span><span class="op" id="6117053">(</span><span class="string" id="6117054">&#34;ustar&nbsp;&nbsp;\x00&#34;</span><span class="op" id="6117067">)</span><span class="op" id="6117068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6117071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6117075">_</span><span class="op" id="6117076">,</span>&nbsp;<span class="ident" id="6117078">paxPathUsed</span>&nbsp;<span class="op" id="6117090">:=</span>&nbsp;<span class="ident" id="6117093">paxHeaders</span><span class="op" id="6117103">[</span><span class="ident" id="6117104">paxPath</span><span class="op" id="6117111">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6117114">//&nbsp;try&nbsp;to&nbsp;use&nbsp;a&nbsp;ustar&nbsp;header&nbsp;when&nbsp;only&nbsp;the&nbsp;name&nbsp;is&nbsp;too&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6117175">if</span>&nbsp;<span class="op" id="6117178">!</span><span class="ident" id="6117179">tw</span><span class="op" id="6117181">.</span><span class="ident" id="6117182">preferPax</span>&nbsp;<span class="op" id="6117192">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6117195">len</span><span class="op" id="6117198">(</span><span class="ident" id="6117199">paxHeaders</span><span class="op" id="6117209">)</span>&nbsp;<span class="op" id="6117211">==</span>&nbsp;<span class="num" id="6117214">1</span>&nbsp;<span class="op" id="6117216">&amp;&amp;</span>&nbsp;<span class="ident" id="6117219">paxPathUsed</span>&nbsp;<span class="op" id="6117231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6117235">suffix</span>&nbsp;<span class="op" id="6117242">:=</span>&nbsp;<span class="ident" id="6117245">hdr</span><span class="op" id="6117248">.</span><span class="ident" id="6117249">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6117256">prefix</span>&nbsp;<span class="op" id="6117263">:=</span>&nbsp;<span class="string" id="6117266">&#34;&#34;</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6117271">if</span>&nbsp;<span class="builtinfunc" id="6117274">len</span><span class="op" id="6117277">(</span><span class="ident" id="6117278">hdr</span><span class="op" id="6117281">.</span><span class="ident" id="6117282">Name</span><span class="op" id="6117286">)</span>&nbsp;<span class="op" id="6117288">&gt;</span>&nbsp;<span class="ident" id="6117290">fileNameSize</span>&nbsp;<span class="op" id="6117303">&amp;&amp;</span>&nbsp;<span class="ident" id="6117306">isASCII</span><span class="op" id="6117313">(</span><span class="ident" id="6117314">hdr</span><span class="op" id="6117317">.</span><span class="ident" id="6117318">Name</span><span class="op" id="6117322">)</span>&nbsp;<span class="op" id="6117324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6117329">var</span>&nbsp;<span class="ident" id="6117333">err</span>&nbsp;<span class="builtintype" id="6117337">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6117346">prefix</span><span class="op" id="6117352">,</span>&nbsp;<span class="ident" id="6117354">suffix</span><span class="op" id="6117360">,</span>&nbsp;<span class="ident" id="6117362">err</span>&nbsp;<span class="op" id="6117366">=</span>&nbsp;<span class="ident" id="6117368">tw</span><span class="op" id="6117370">.</span><span class="ident" id="6117371">splitUSTARLongName</span><span class="op" id="6117389">(</span><span class="ident" id="6117390">hdr</span><span class="op" id="6117393">.</span><span class="ident" id="6117394">Name</span><span class="op" id="6117398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6117403">if</span>&nbsp;<span class="ident" id="6117406">err</span>&nbsp;<span class="op" id="6117410">==</span>&nbsp;<span class="ident" id="6117413">nil</span>&nbsp;<span class="op" id="6117417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6117423">//&nbsp;ok&nbsp;we&nbsp;can&nbsp;use&nbsp;a&nbsp;ustar&nbsp;long&nbsp;name&nbsp;instead&nbsp;of&nbsp;pax,&nbsp;now&nbsp;correct&nbsp;the&nbsp;fields</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6117502">//&nbsp;remove&nbsp;the&nbsp;path&nbsp;field&nbsp;from&nbsp;the&nbsp;pax&nbsp;header.&nbsp;this&nbsp;will&nbsp;suppress&nbsp;the&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6117586">delete</span><span class="op" id="6117592">(</span><span class="ident" id="6117593">paxHeaders</span><span class="op" id="6117603">,</span>&nbsp;<span class="ident" id="6117605">paxPath</span><span class="op" id="6117612">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6117619">//&nbsp;update&nbsp;the&nbsp;path&nbsp;fields</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6117649">tw</span><span class="op" id="6117651">.</span><span class="ident" id="6117652">cString</span><span class="op" id="6117659">(</span><span class="ident" id="6117660">pathHeaderBytes</span><span class="op" id="6117675">,</span>&nbsp;<span class="ident" id="6117677">suffix</span><span class="op" id="6117683">,</span>&nbsp;<span class="builtintype" id="6117685">false</span><span class="op" id="6117690">,</span>&nbsp;<span class="ident" id="6117692">paxNone</span><span class="op" id="6117699">,</span>&nbsp;<span class="ident" id="6117701">nil</span><span class="op" id="6117704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6117710">tw</span><span class="op" id="6117712">.</span><span class="ident" id="6117713">cString</span><span class="op" id="6117720">(</span><span class="ident" id="6117721">prefixHeaderBytes</span><span class="op" id="6117738">,</span>&nbsp;<span class="ident" id="6117740">prefix</span><span class="op" id="6117746">,</span>&nbsp;<span class="builtintype" id="6117748">false</span><span class="op" id="6117753">,</span>&nbsp;<span class="ident" id="6117755">paxNone</span><span class="op" id="6117762">,</span>&nbsp;<span class="ident" id="6117764">nil</span><span class="op" id="6117767">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6117774">//&nbsp;Use&nbsp;the&nbsp;ustar&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;ustar&nbsp;long&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6117830">if</span>&nbsp;<span class="builtinfunc" id="6117833">len</span><span class="op" id="6117836">(</span><span class="ident" id="6117837">prefix</span><span class="op" id="6117843">)</span>&nbsp;<span class="op" id="6117845">&gt;</span>&nbsp;<span class="num" id="6117847">0</span>&nbsp;<span class="op" id="6117849">&amp;&amp;</span>&nbsp;<span class="op" id="6117852">!</span><span class="ident" id="6117853">tw</span><span class="op" id="6117855">.</span><span class="ident" id="6117856">usedBinary</span>&nbsp;<span class="op" id="6117867">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6117874">copy</span><span class="op" id="6117878">(</span><span class="ident" id="6117879">header</span><span class="op" id="6117885">[</span><span class="num" id="6117886">257</span><span class="op" id="6117889">:</span><span class="num" id="6117890">265</span><span class="op" id="6117893">]</span><span class="op" id="6117894">,</span>&nbsp;<span class="op" id="6117896">[</span><span class="op" id="6117897">]</span><span class="builtintype" id="6117898">byte</span><span class="op" id="6117902">(</span><span class="string" id="6117903">&#34;ustar\x00&#34;</span><span class="op" id="6117914">)</span><span class="op" id="6117915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6117921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6117926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6117930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6117933">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6117937">//&nbsp;The&nbsp;chksum&nbsp;field&nbsp;is&nbsp;terminated&nbsp;by&nbsp;a&nbsp;NUL&nbsp;and&nbsp;a&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6117994">//&nbsp;This&nbsp;is&nbsp;different&nbsp;from&nbsp;the&nbsp;other&nbsp;octal&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118045">chksum</span><span class="op" id="6118051">,</span>&nbsp;<span class="ident" id="6118053">_</span>&nbsp;<span class="op" id="6118055">:=</span>&nbsp;<span class="ident" id="6118058">checksum</span><span class="op" id="6118066">(</span><span class="ident" id="6118067">header</span><span class="op" id="6118073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118076">tw</span><span class="op" id="6118078">.</span><span class="ident" id="6118079">octal</span><span class="op" id="6118084">(</span><span class="ident" id="6118085">header</span><span class="op" id="6118091">[</span><span class="num" id="6118092">148</span><span class="op" id="6118095">:</span><span class="num" id="6118096">155</span><span class="op" id="6118099">]</span><span class="op" id="6118100">,</span>&nbsp;<span class="ident" id="6118102">chksum</span><span class="op" id="6118108">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118111">header</span><span class="op" id="6118117">[</span><span class="num" id="6118118">155</span><span class="op" id="6118121">]</span>&nbsp;<span class="op" id="6118123">=</span>&nbsp;<span class="string" id="6118125">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6118131">if</span>&nbsp;<span class="ident" id="6118134">tw</span><span class="op" id="6118136">.</span><span class="ident" id="6118137">err</span>&nbsp;<span class="op" id="6118141">!=</span>&nbsp;<span class="ident" id="6118144">nil</span>&nbsp;<span class="op" id="6118148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6118152">//&nbsp;problem&nbsp;with&nbsp;header;&nbsp;probably&nbsp;integer&nbsp;too&nbsp;big&nbsp;for&nbsp;a&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6118216">return</span>&nbsp;<span class="ident" id="6118223">tw</span><span class="op" id="6118225">.</span><span class="ident" id="6118226">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6118231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6118235">if</span>&nbsp;<span class="ident" id="6118238">allowPax</span>&nbsp;<span class="op" id="6118247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6118251">for</span>&nbsp;<span class="ident" id="6118255">k</span><span class="op" id="6118256">,</span>&nbsp;<span class="ident" id="6118258">v</span>&nbsp;<span class="op" id="6118260">:=</span>&nbsp;<span class="keyword" id="6118263">range</span>&nbsp;<span class="ident" id="6118269">hdr</span><span class="op" id="6118272">.</span><span class="ident" id="6118273">Xattrs</span>&nbsp;<span class="op" id="6118280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118285">paxHeaders</span><span class="op" id="6118295">[</span><span class="ident" id="6118296">paxXattr</span><span class="op" id="6118304">+</span><span class="ident" id="6118305">k</span><span class="op" id="6118306">]</span>&nbsp;<span class="op" id="6118308">=</span>&nbsp;<span class="ident" id="6118310">v</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6118314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6118317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6118321">if</span>&nbsp;<span class="builtinfunc" id="6118324">len</span><span class="op" id="6118327">(</span><span class="ident" id="6118328">paxHeaders</span><span class="op" id="6118338">)</span>&nbsp;<span class="op" id="6118340">&gt;</span>&nbsp;<span class="num" id="6118342">0</span>&nbsp;<span class="op" id="6118344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6118348">if</span>&nbsp;<span class="op" id="6118351">!</span><span class="ident" id="6118352">allowPax</span>&nbsp;<span class="op" id="6118361">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6118366">return</span>&nbsp;<span class="ident" id="6118373">errInvalidHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6118392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6118396">if</span>&nbsp;<span class="ident" id="6118399">err</span>&nbsp;<span class="op" id="6118403">:=</span>&nbsp;<span class="ident" id="6118406">tw</span><span class="op" id="6118408">.</span><span class="ident" id="6118409">writePAXHeader</span><span class="op" id="6118423">(</span><span class="ident" id="6118424">hdr</span><span class="op" id="6118427">,</span>&nbsp;<span class="ident" id="6118429">paxHeaders</span><span class="op" id="6118439">)</span><span class="op" id="6118440">;</span>&nbsp;<span class="ident" id="6118442">err</span>&nbsp;<span class="op" id="6118446">!=</span>&nbsp;<span class="ident" id="6118449">nil</span>&nbsp;<span class="op" id="6118453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6118458">return</span>&nbsp;<span class="ident" id="6118465">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6118471">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6118474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118477">tw</span><span class="op" id="6118479">.</span><span class="ident" id="6118480">nb</span>&nbsp;<span class="op" id="6118483">=</span>&nbsp;<span class="ident" id="6118485">int64</span><span class="op" id="6118490">(</span><span class="ident" id="6118491">hdr</span><span class="op" id="6118494">.</span><span class="ident" id="6118495">Size</span><span class="op" id="6118499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118502">tw</span><span class="op" id="6118504">.</span><span class="ident" id="6118505">pad</span>&nbsp;<span class="op" id="6118509">=</span>&nbsp;<span class="op" id="6118511">(</span><span class="ident" id="6118512">blockSize</span>&nbsp;<span class="op" id="6118522">-</span>&nbsp;<span class="op" id="6118524">(</span><span class="ident" id="6118525">tw</span><span class="op" id="6118527">.</span><span class="ident" id="6118528">nb</span>&nbsp;<span class="op" id="6118531">%</span>&nbsp;<span class="ident" id="6118533">blockSize</span><span class="op" id="6118542">)</span><span class="op" id="6118543">)</span>&nbsp;<span class="op" id="6118545">%</span>&nbsp;<span class="ident" id="6118547">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118559">_</span><span class="op" id="6118560">,</span>&nbsp;<span class="ident" id="6118562">tw</span><span class="op" id="6118564">.</span><span class="ident" id="6118565">err</span>&nbsp;<span class="op" id="6118569">=</span>&nbsp;<span class="ident" id="6118571">tw</span><span class="op" id="6118573">.</span><span class="ident" id="6118574">w</span><span class="op" id="6118575">.</span><span class="ident" id="6118576">Write</span><span class="op" id="6118581">(</span><span class="ident" id="6118582">header</span><span class="op" id="6118588">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6118591">return</span>&nbsp;<span class="ident" id="6118598">tw</span><span class="op" id="6118600">.</span><span class="ident" id="6118601">err</span><br>
<span class="lineno"></span><span class="op" id="6118605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6118608">//&nbsp;writeUSTARLongName&nbsp;splits&nbsp;a&nbsp;USTAR&nbsp;long&nbsp;name&nbsp;hdr.Name.</span><br>
<span class="lineno"></span><span class="comment" id="6118665">//&nbsp;name&nbsp;must&nbsp;be&nbsp;&lt;&nbsp;256&nbsp;characters.&nbsp;errNameTooLong&nbsp;is&nbsp;returned</span><br>
<span class="lineno">275</span><span class="comment" id="6118726">//&nbsp;if&nbsp;hdr.Name&nbsp;can&#39;t&nbsp;be&nbsp;split.&nbsp;The&nbsp;splitting&nbsp;heuristic</span><br>
<span class="lineno"></span><span class="comment" id="6118781">//&nbsp;is&nbsp;compatible&nbsp;with&nbsp;gnu&nbsp;tar.</span><br>
<span class="lineno"></span><span class="keyword" id="6118812">func</span>&nbsp;<span class="op" id="6118817">(</span><span class="ident" id="6118818">tw</span>&nbsp;<span class="op" id="6118821">*</span><span class="ident" id="6118822">Writer</span><span class="op" id="6118828">)</span>&nbsp;<span class="ident" id="6118830">splitUSTARLongName</span><span class="op" id="6118848">(</span><span class="ident" id="6118849">name</span>&nbsp;<span class="builtintype" id="6118854">string</span><span class="op" id="6118860">)</span>&nbsp;<span class="op" id="6118862">(</span><span class="ident" id="6118863">prefix</span><span class="op" id="6118869">,</span>&nbsp;<span class="ident" id="6118871">suffix</span>&nbsp;<span class="builtintype" id="6118878">string</span><span class="op" id="6118884">,</span>&nbsp;<span class="ident" id="6118886">err</span>&nbsp;<span class="builtintype" id="6118890">error</span><span class="op" id="6118895">)</span>&nbsp;<span class="op" id="6118897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118900">length</span>&nbsp;<span class="op" id="6118907">:=</span>&nbsp;<span class="builtinfunc" id="6118910">len</span><span class="op" id="6118913">(</span><span class="ident" id="6118914">name</span><span class="op" id="6118918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6118921">if</span>&nbsp;<span class="ident" id="6118924">length</span>&nbsp;<span class="op" id="6118931">&gt;</span>&nbsp;<span class="ident" id="6118933">fileNamePrefixSize</span><span class="op" id="6118951">+</span><span class="num" id="6118952">1</span>&nbsp;<span class="op" id="6118954">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118958">length</span>&nbsp;<span class="op" id="6118965">=</span>&nbsp;<span class="ident" id="6118967">fileNamePrefixSize</span>&nbsp;<span class="op" id="6118986">+</span>&nbsp;<span class="num" id="6118988">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6118991">}</span>&nbsp;<span class="keyword" id="6118993">else</span>&nbsp;<span class="keyword" id="6118998">if</span>&nbsp;<span class="ident" id="6119001">name</span><span class="op" id="6119005">[</span><span class="ident" id="6119006">length</span><span class="op" id="6119012">-</span><span class="num" id="6119013">1</span><span class="op" id="6119014">]</span>&nbsp;<span class="op" id="6119016">==</span>&nbsp;<span class="string" id="6119019">&#39;/&#39;</span>&nbsp;<span class="op" id="6119023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119027">length</span><span class="op" id="6119033">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6119037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119040">i</span>&nbsp;<span class="op" id="6119042">:=</span>&nbsp;<span class="ident" id="6119045">strings</span><span class="op" id="6119052">.</span><span class="ident" id="6119053">LastIndex</span><span class="op" id="6119062">(</span><span class="ident" id="6119063">name</span><span class="op" id="6119067">[</span><span class="op" id="6119068">:</span><span class="ident" id="6119069">length</span><span class="op" id="6119075">]</span><span class="op" id="6119076">,</span>&nbsp;<span class="string" id="6119078">&#34;/&#34;</span><span class="op" id="6119081">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6119084">//&nbsp;nlen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;name&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6119142">//&nbsp;plen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;prefix&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119202">nlen</span>&nbsp;<span class="op" id="6119207">:=</span>&nbsp;<span class="builtinfunc" id="6119210">len</span><span class="op" id="6119213">(</span><span class="ident" id="6119214">name</span><span class="op" id="6119218">)</span>&nbsp;<span class="op" id="6119220">-</span>&nbsp;<span class="ident" id="6119222">i</span>&nbsp;<span class="op" id="6119224">-</span>&nbsp;<span class="num" id="6119226">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119229">plen</span>&nbsp;<span class="op" id="6119234">:=</span>&nbsp;<span class="ident" id="6119237">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6119240">if</span>&nbsp;<span class="ident" id="6119243">i</span>&nbsp;<span class="op" id="6119245">&lt;=</span>&nbsp;<span class="num" id="6119248">0</span>&nbsp;<span class="op" id="6119250">||</span>&nbsp;<span class="ident" id="6119253">nlen</span>&nbsp;<span class="op" id="6119258">&gt;</span>&nbsp;<span class="ident" id="6119260">fileNameSize</span>&nbsp;<span class="op" id="6119273">||</span>&nbsp;<span class="ident" id="6119276">nlen</span>&nbsp;<span class="op" id="6119281">==</span>&nbsp;<span class="num" id="6119284">0</span>&nbsp;<span class="op" id="6119286">||</span>&nbsp;<span class="ident" id="6119289">plen</span>&nbsp;<span class="op" id="6119294">&gt;</span>&nbsp;<span class="ident" id="6119296">fileNamePrefixSize</span>&nbsp;<span class="op" id="6119315">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119319">err</span>&nbsp;<span class="op" id="6119323">=</span>&nbsp;<span class="ident" id="6119325">errNameTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6119342">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6119350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119353">prefix</span><span class="op" id="6119359">,</span>&nbsp;<span class="ident" id="6119361">suffix</span>&nbsp;<span class="op" id="6119368">=</span>&nbsp;<span class="ident" id="6119370">name</span><span class="op" id="6119374">[</span><span class="op" id="6119375">:</span><span class="ident" id="6119376">i</span><span class="op" id="6119377">]</span><span class="op" id="6119378">,</span>&nbsp;<span class="ident" id="6119380">name</span><span class="op" id="6119384">[</span><span class="ident" id="6119385">i</span><span class="op" id="6119386">+</span><span class="num" id="6119387">1</span><span class="op" id="6119388">:</span><span class="op" id="6119389">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6119392">return</span><br>
<span class="lineno">295</span><span class="op" id="6119399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6119402">//&nbsp;writePaxHeader&nbsp;writes&nbsp;an&nbsp;extended&nbsp;pax&nbsp;header&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6119457">//&nbsp;archive.</span><br>
<span class="lineno"></span><span class="keyword" id="6119469">func</span>&nbsp;<span class="op" id="6119474">(</span><span class="ident" id="6119475">tw</span>&nbsp;<span class="op" id="6119478">*</span><span class="ident" id="6119479">Writer</span><span class="op" id="6119485">)</span>&nbsp;<span class="ident" id="6119487">writePAXHeader</span><span class="op" id="6119501">(</span><span class="ident" id="6119502">hdr</span>&nbsp;<span class="op" id="6119506">*</span><span class="ident" id="6119507">Header</span><span class="op" id="6119513">,</span>&nbsp;<span class="ident" id="6119515">paxHeaders</span>&nbsp;<span class="keyword" id="6119526">map</span><span class="op" id="6119529">[</span><span class="builtintype" id="6119530">string</span><span class="op" id="6119536">]</span><span class="builtintype" id="6119537">string</span><span class="op" id="6119543">)</span>&nbsp;<span class="builtintype" id="6119545">error</span>&nbsp;<span class="op" id="6119551">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6119554">//&nbsp;Prepare&nbsp;extended&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119582">ext</span>&nbsp;<span class="op" id="6119586">:=</span>&nbsp;<span class="builtinfunc" id="6119589">new</span><span class="op" id="6119592">(</span><span class="ident" id="6119593">Header</span><span class="op" id="6119599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119602">ext</span><span class="op" id="6119605">.</span><span class="ident" id="6119606">Typeflag</span>&nbsp;<span class="op" id="6119615">=</span>&nbsp;<span class="ident" id="6119617">TypeXHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6119630">//&nbsp;Setting&nbsp;ModTime&nbsp;is&nbsp;required&nbsp;for&nbsp;reader&nbsp;parsing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6119684">//&nbsp;succeed,&nbsp;and&nbsp;seems&nbsp;harmless&nbsp;enough.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119724">ext</span><span class="op" id="6119727">.</span><span class="ident" id="6119728">ModTime</span>&nbsp;<span class="op" id="6119736">=</span>&nbsp;<span class="ident" id="6119738">hdr</span><span class="op" id="6119741">.</span><span class="ident" id="6119742">ModTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6119751">//&nbsp;The&nbsp;spec&nbsp;asks&nbsp;that&nbsp;we&nbsp;namespace&nbsp;our&nbsp;pseudo&nbsp;files</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6119804">//&nbsp;with&nbsp;the&nbsp;current&nbsp;pid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119830">pid</span>&nbsp;<span class="op" id="6119834">:=</span>&nbsp;<span class="ident" id="6119837">os</span><span class="op" id="6119839">.</span><span class="ident" id="6119840">Getpid</span><span class="op" id="6119846">(</span><span class="op" id="6119847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119850">dir</span><span class="op" id="6119853">,</span>&nbsp;<span class="ident" id="6119855">file</span>&nbsp;<span class="op" id="6119860">:=</span>&nbsp;<span class="ident" id="6119863">path</span><span class="op" id="6119867">.</span><span class="ident" id="6119868">Split</span><span class="op" id="6119873">(</span><span class="ident" id="6119874">hdr</span><span class="op" id="6119877">.</span><span class="ident" id="6119878">Name</span><span class="op" id="6119882">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119885">fullName</span>&nbsp;<span class="op" id="6119894">:=</span>&nbsp;<span class="ident" id="6119897">path</span><span class="op" id="6119901">.</span><span class="ident" id="6119902">Join</span><span class="op" id="6119906">(</span><span class="ident" id="6119907">dir</span><span class="op" id="6119910">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119914">fmt</span><span class="op" id="6119917">.</span><span class="ident" id="6119918">Sprintf</span><span class="op" id="6119925">(</span><span class="string" id="6119926">&#34;PaxHeaders.%d&#34;</span><span class="op" id="6119941">,</span>&nbsp;<span class="ident" id="6119943">pid</span><span class="op" id="6119946">)</span><span class="op" id="6119947">,</span>&nbsp;<span class="ident" id="6119949">file</span><span class="op" id="6119953">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119957">ascii</span>&nbsp;<span class="op" id="6119963">:=</span>&nbsp;<span class="ident" id="6119966">toASCII</span><span class="op" id="6119973">(</span><span class="ident" id="6119974">fullName</span><span class="op" id="6119982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6119985">if</span>&nbsp;<span class="builtinfunc" id="6119988">len</span><span class="op" id="6119991">(</span><span class="ident" id="6119992">ascii</span><span class="op" id="6119997">)</span>&nbsp;<span class="op" id="6119999">&gt;</span>&nbsp;<span class="num" id="6120001">100</span>&nbsp;<span class="op" id="6120005">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120009">ascii</span>&nbsp;<span class="op" id="6120015">=</span>&nbsp;<span class="ident" id="6120017">ascii</span><span class="op" id="6120022">[</span><span class="op" id="6120023">:</span><span class="num" id="6120024">100</span><span class="op" id="6120027">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6120030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120033">ext</span><span class="op" id="6120036">.</span><span class="ident" id="6120037">Name</span>&nbsp;<span class="op" id="6120042">=</span>&nbsp;<span class="ident" id="6120044">ascii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6120051">//&nbsp;Construct&nbsp;the&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120074">var</span>&nbsp;<span class="ident" id="6120078">buf</span>&nbsp;<span class="ident" id="6120082">bytes</span><span class="op" id="6120087">.</span><span class="ident" id="6120088">Buffer</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120097">for</span>&nbsp;<span class="ident" id="6120101">k</span><span class="op" id="6120102">,</span>&nbsp;<span class="ident" id="6120104">v</span>&nbsp;<span class="op" id="6120106">:=</span>&nbsp;<span class="keyword" id="6120109">range</span>&nbsp;<span class="ident" id="6120115">paxHeaders</span>&nbsp;<span class="op" id="6120126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120130">fmt</span><span class="op" id="6120133">.</span><span class="ident" id="6120134">Fprint</span><span class="op" id="6120140">(</span><span class="op" id="6120141">&amp;</span><span class="ident" id="6120142">buf</span><span class="op" id="6120145">,</span>&nbsp;<span class="ident" id="6120147">paxHeader</span><span class="op" id="6120156">(</span><span class="ident" id="6120157">k</span><span class="op" id="6120158">+</span><span class="string" id="6120159">&#34;=&#34;</span><span class="op" id="6120162">+</span><span class="ident" id="6120163">v</span><span class="op" id="6120164">)</span><span class="op" id="6120165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6120168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120172">ext</span><span class="op" id="6120175">.</span><span class="ident" id="6120176">Size</span>&nbsp;<span class="op" id="6120181">=</span>&nbsp;<span class="ident" id="6120183">int64</span><span class="op" id="6120188">(</span><span class="builtinfunc" id="6120189">len</span><span class="op" id="6120192">(</span><span class="ident" id="6120193">buf</span><span class="op" id="6120196">.</span><span class="ident" id="6120197">Bytes</span><span class="op" id="6120202">(</span><span class="op" id="6120203">)</span><span class="op" id="6120204">)</span><span class="op" id="6120205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120208">if</span>&nbsp;<span class="ident" id="6120211">err</span>&nbsp;<span class="op" id="6120215">:=</span>&nbsp;<span class="ident" id="6120218">tw</span><span class="op" id="6120220">.</span><span class="ident" id="6120221">writeHeader</span><span class="op" id="6120232">(</span><span class="ident" id="6120233">ext</span><span class="op" id="6120236">,</span>&nbsp;<span class="builtintype" id="6120238">false</span><span class="op" id="6120243">)</span><span class="op" id="6120244">;</span>&nbsp;<span class="ident" id="6120246">err</span>&nbsp;<span class="op" id="6120250">!=</span>&nbsp;<span class="ident" id="6120253">nil</span>&nbsp;<span class="op" id="6120257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120261">return</span>&nbsp;<span class="ident" id="6120268">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6120273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120276">if</span>&nbsp;<span class="ident" id="6120279">_</span><span class="op" id="6120280">,</span>&nbsp;<span class="ident" id="6120282">err</span>&nbsp;<span class="op" id="6120286">:=</span>&nbsp;<span class="ident" id="6120289">tw</span><span class="op" id="6120291">.</span><span class="ident" id="6120292">Write</span><span class="op" id="6120297">(</span><span class="ident" id="6120298">buf</span><span class="op" id="6120301">.</span><span class="ident" id="6120302">Bytes</span><span class="op" id="6120307">(</span><span class="op" id="6120308">)</span><span class="op" id="6120309">)</span><span class="op" id="6120310">;</span>&nbsp;<span class="ident" id="6120312">err</span>&nbsp;<span class="op" id="6120316">!=</span>&nbsp;<span class="ident" id="6120319">nil</span>&nbsp;<span class="op" id="6120323">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120327">return</span>&nbsp;<span class="ident" id="6120334">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6120339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120342">if</span>&nbsp;<span class="ident" id="6120345">err</span>&nbsp;<span class="op" id="6120349">:=</span>&nbsp;<span class="ident" id="6120352">tw</span><span class="op" id="6120354">.</span><span class="ident" id="6120355">Flush</span><span class="op" id="6120360">(</span><span class="op" id="6120361">)</span><span class="op" id="6120362">;</span>&nbsp;<span class="ident" id="6120364">err</span>&nbsp;<span class="op" id="6120368">!=</span>&nbsp;<span class="ident" id="6120371">nil</span>&nbsp;<span class="op" id="6120375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120379">return</span>&nbsp;<span class="ident" id="6120386">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6120391">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120394">return</span>&nbsp;<span class="ident" id="6120401">nil</span><br>
<span class="lineno"></span><span class="op" id="6120405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6120408">//&nbsp;paxHeader&nbsp;formats&nbsp;a&nbsp;single&nbsp;pax&nbsp;record,&nbsp;prefixing&nbsp;it&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="6120491">func</span>&nbsp;<span class="ident" id="6120496">paxHeader</span><span class="op" id="6120505">(</span><span class="ident" id="6120506">msg</span>&nbsp;<span class="builtintype" id="6120510">string</span><span class="op" id="6120516">)</span>&nbsp;<span class="builtintype" id="6120518">string</span>&nbsp;<span class="op" id="6120525">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120528">const</span>&nbsp;<span class="ident" id="6120534">padding</span>&nbsp;<span class="op" id="6120542">=</span>&nbsp;<span class="num" id="6120544">2</span>&nbsp;<span class="comment" id="6120546">//&nbsp;Extra&nbsp;padding&nbsp;for&nbsp;space&nbsp;and&nbsp;newline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120586">size</span>&nbsp;<span class="op" id="6120591">:=</span>&nbsp;<span class="builtinfunc" id="6120594">len</span><span class="op" id="6120597">(</span><span class="ident" id="6120598">msg</span><span class="op" id="6120601">)</span>&nbsp;<span class="op" id="6120603">+</span>&nbsp;<span class="ident" id="6120605">padding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120614">size</span>&nbsp;<span class="op" id="6120619">+=</span>&nbsp;<span class="builtinfunc" id="6120622">len</span><span class="op" id="6120625">(</span><span class="ident" id="6120626">strconv</span><span class="op" id="6120633">.</span><span class="ident" id="6120634">Itoa</span><span class="op" id="6120638">(</span><span class="ident" id="6120639">size</span><span class="op" id="6120643">)</span><span class="op" id="6120644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120647">record</span>&nbsp;<span class="op" id="6120654">:=</span>&nbsp;<span class="ident" id="6120657">fmt</span><span class="op" id="6120660">.</span><span class="ident" id="6120661">Sprintf</span><span class="op" id="6120668">(</span><span class="string" id="6120669">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="6120678">,</span>&nbsp;<span class="ident" id="6120680">size</span><span class="op" id="6120684">,</span>&nbsp;<span class="ident" id="6120686">msg</span><span class="op" id="6120689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120692">if</span>&nbsp;<span class="builtinfunc" id="6120695">len</span><span class="op" id="6120698">(</span><span class="ident" id="6120699">record</span><span class="op" id="6120705">)</span>&nbsp;<span class="op" id="6120707">!=</span>&nbsp;<span class="ident" id="6120710">size</span>&nbsp;<span class="op" id="6120715">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6120719">//&nbsp;Final&nbsp;adjustment&nbsp;if&nbsp;adding&nbsp;size&nbsp;increased</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6120766">//&nbsp;the&nbsp;number&nbsp;of&nbsp;digits&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120800">size</span>&nbsp;<span class="op" id="6120805">=</span>&nbsp;<span class="builtinfunc" id="6120807">len</span><span class="op" id="6120810">(</span><span class="ident" id="6120811">record</span><span class="op" id="6120817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120821">record</span>&nbsp;<span class="op" id="6120828">=</span>&nbsp;<span class="ident" id="6120830">fmt</span><span class="op" id="6120833">.</span><span class="ident" id="6120834">Sprintf</span><span class="op" id="6120841">(</span><span class="string" id="6120842">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="6120851">,</span>&nbsp;<span class="ident" id="6120853">size</span><span class="op" id="6120857">,</span>&nbsp;<span class="ident" id="6120859">msg</span><span class="op" id="6120862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6120865">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120868">return</span>&nbsp;<span class="ident" id="6120875">record</span><br>
<span class="lineno"></span><span class="op" id="6120882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6120885">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;current&nbsp;entry&nbsp;in&nbsp;the&nbsp;tar&nbsp;archive.</span><br>
<span class="lineno"></span><span class="comment" id="6120942">//&nbsp;Write&nbsp;returns&nbsp;the&nbsp;error&nbsp;ErrWriteTooLong&nbsp;if&nbsp;more&nbsp;than</span><br>
<span class="lineno">355</span><span class="comment" id="6120998">//&nbsp;hdr.Size&nbsp;bytes&nbsp;are&nbsp;written&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span><span class="keyword" id="6121047">func</span>&nbsp;<span class="op" id="6121052">(</span><span class="ident" id="6121053">tw</span>&nbsp;<span class="op" id="6121056">*</span><span class="ident" id="6121057">Writer</span><span class="op" id="6121063">)</span>&nbsp;<span class="ident" id="6121065">Write</span><span class="op" id="6121070">(</span><span class="ident" id="6121071">b</span>&nbsp;<span class="op" id="6121073">[</span><span class="op" id="6121074">]</span><span class="builtintype" id="6121075">byte</span><span class="op" id="6121079">)</span>&nbsp;<span class="op" id="6121081">(</span><span class="ident" id="6121082">n</span>&nbsp;<span class="builtintype" id="6121084">int</span><span class="op" id="6121087">,</span>&nbsp;<span class="ident" id="6121089">err</span>&nbsp;<span class="builtintype" id="6121093">error</span><span class="op" id="6121098">)</span>&nbsp;<span class="op" id="6121100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121103">if</span>&nbsp;<span class="ident" id="6121106">tw</span><span class="op" id="6121108">.</span><span class="ident" id="6121109">closed</span>&nbsp;<span class="op" id="6121116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121120">err</span>&nbsp;<span class="op" id="6121124">=</span>&nbsp;<span class="ident" id="6121126">ErrWriteTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121144">return</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6121152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121155">overwrite</span>&nbsp;<span class="op" id="6121165">:=</span>&nbsp;<span class="builtintype" id="6121168">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121175">if</span>&nbsp;<span class="ident" id="6121178">int64</span><span class="op" id="6121183">(</span><span class="builtinfunc" id="6121184">len</span><span class="op" id="6121187">(</span><span class="ident" id="6121188">b</span><span class="op" id="6121189">)</span><span class="op" id="6121190">)</span>&nbsp;<span class="op" id="6121192">&gt;</span>&nbsp;<span class="ident" id="6121194">tw</span><span class="op" id="6121196">.</span><span class="ident" id="6121197">nb</span>&nbsp;<span class="op" id="6121200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121204">b</span>&nbsp;<span class="op" id="6121206">=</span>&nbsp;<span class="ident" id="6121208">b</span><span class="op" id="6121209">[</span><span class="num" id="6121210">0</span><span class="op" id="6121211">:</span><span class="ident" id="6121212">tw</span><span class="op" id="6121214">.</span><span class="ident" id="6121215">nb</span><span class="op" id="6121217">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121221">overwrite</span>&nbsp;<span class="op" id="6121231">=</span>&nbsp;<span class="builtintype" id="6121233">true</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6121239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121242">n</span><span class="op" id="6121243">,</span>&nbsp;<span class="ident" id="6121245">err</span>&nbsp;<span class="op" id="6121249">=</span>&nbsp;<span class="ident" id="6121251">tw</span><span class="op" id="6121253">.</span><span class="ident" id="6121254">w</span><span class="op" id="6121255">.</span><span class="ident" id="6121256">Write</span><span class="op" id="6121261">(</span><span class="ident" id="6121262">b</span><span class="op" id="6121263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121266">tw</span><span class="op" id="6121268">.</span><span class="ident" id="6121269">nb</span>&nbsp;<span class="op" id="6121272">-=</span>&nbsp;<span class="ident" id="6121275">int64</span><span class="op" id="6121280">(</span><span class="ident" id="6121281">n</span><span class="op" id="6121282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121285">if</span>&nbsp;<span class="ident" id="6121288">err</span>&nbsp;<span class="op" id="6121292">==</span>&nbsp;<span class="ident" id="6121295">nil</span>&nbsp;<span class="op" id="6121299">&amp;&amp;</span>&nbsp;<span class="ident" id="6121302">overwrite</span>&nbsp;<span class="op" id="6121312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121316">err</span>&nbsp;<span class="op" id="6121320">=</span>&nbsp;<span class="ident" id="6121322">ErrWriteTooLong</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121340">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6121348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121351">tw</span><span class="op" id="6121353">.</span><span class="ident" id="6121354">err</span>&nbsp;<span class="op" id="6121358">=</span>&nbsp;<span class="ident" id="6121360">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121365">return</span><br>
<span class="lineno"></span><span class="op" id="6121372">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="comment" id="6121375">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;tar&nbsp;archive,&nbsp;flushing&nbsp;any&nbsp;unwritten</span><br>
<span class="lineno"></span><span class="comment" id="6121431">//&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6121465">func</span>&nbsp;<span class="op" id="6121470">(</span><span class="ident" id="6121471">tw</span>&nbsp;<span class="op" id="6121474">*</span><span class="ident" id="6121475">Writer</span><span class="op" id="6121481">)</span>&nbsp;<span class="ident" id="6121483">Close</span><span class="op" id="6121488">(</span><span class="op" id="6121489">)</span>&nbsp;<span class="builtintype" id="6121491">error</span>&nbsp;<span class="op" id="6121497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121500">if</span>&nbsp;<span class="ident" id="6121503">tw</span><span class="op" id="6121505">.</span><span class="ident" id="6121506">err</span>&nbsp;<span class="op" id="6121510">!=</span>&nbsp;<span class="ident" id="6121513">nil</span>&nbsp;<span class="op" id="6121517">||</span>&nbsp;<span class="ident" id="6121520">tw</span><span class="op" id="6121522">.</span><span class="ident" id="6121523">closed</span>&nbsp;<span class="op" id="6121530">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121534">return</span>&nbsp;<span class="ident" id="6121541">tw</span><span class="op" id="6121543">.</span><span class="ident" id="6121544">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6121549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121552">tw</span><span class="op" id="6121554">.</span><span class="ident" id="6121555">Flush</span><span class="op" id="6121560">(</span><span class="op" id="6121561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121564">tw</span><span class="op" id="6121566">.</span><span class="ident" id="6121567">closed</span>&nbsp;<span class="op" id="6121574">=</span>&nbsp;<span class="builtintype" id="6121576">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121582">if</span>&nbsp;<span class="ident" id="6121585">tw</span><span class="op" id="6121587">.</span><span class="ident" id="6121588">err</span>&nbsp;<span class="op" id="6121592">!=</span>&nbsp;<span class="ident" id="6121595">nil</span>&nbsp;<span class="op" id="6121599">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121603">return</span>&nbsp;<span class="ident" id="6121610">tw</span><span class="op" id="6121612">.</span><span class="ident" id="6121613">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6121618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6121622">//&nbsp;trailer:&nbsp;two&nbsp;zero&nbsp;blocks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121651">for</span>&nbsp;<span class="ident" id="6121655">i</span>&nbsp;<span class="op" id="6121657">:=</span>&nbsp;<span class="num" id="6121660">0</span><span class="op" id="6121661">;</span>&nbsp;<span class="ident" id="6121663">i</span>&nbsp;<span class="op" id="6121665">&lt;</span>&nbsp;<span class="num" id="6121667">2</span><span class="op" id="6121668">;</span>&nbsp;<span class="ident" id="6121670">i</span><span class="op" id="6121671">++</span>&nbsp;<span class="op" id="6121674">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121678">_</span><span class="op" id="6121679">,</span>&nbsp;<span class="ident" id="6121681">tw</span><span class="op" id="6121683">.</span><span class="ident" id="6121684">err</span>&nbsp;<span class="op" id="6121688">=</span>&nbsp;<span class="ident" id="6121690">tw</span><span class="op" id="6121692">.</span><span class="ident" id="6121693">w</span><span class="op" id="6121694">.</span><span class="ident" id="6121695">Write</span><span class="op" id="6121700">(</span><span class="ident" id="6121701">zeroBlock</span><span class="op" id="6121710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121714">if</span>&nbsp;<span class="ident" id="6121717">tw</span><span class="op" id="6121719">.</span><span class="ident" id="6121720">err</span>&nbsp;<span class="op" id="6121724">!=</span>&nbsp;<span class="ident" id="6121727">nil</span>&nbsp;<span class="op" id="6121731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121736">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6121744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6121747">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121750">return</span>&nbsp;<span class="ident" id="6121757">tw</span><span class="op" id="6121759">.</span><span class="ident" id="6121760">err</span><br>
<span class="lineno"></span><span class="op" id="6121764">}</span>
</div>
</body>
</html>
