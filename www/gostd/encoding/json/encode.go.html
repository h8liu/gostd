<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/json</h2>
<ul>
<li><a href="/gostd/encoding/json/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/encoding/json/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/json/decode_test.go.html">decode_test.go</a></li>
<li><a href="/gostd/encoding/json/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/json/encode_test.go.html">encode_test.go</a></li>
<li><a href="/gostd/encoding/json/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/json/fold.go.html">fold.go</a></li>
<li><a href="/gostd/encoding/json/fold_test.go.html">fold_test.go</a></li>
<li><a href="/gostd/encoding/json/indent.go.html">indent.go</a></li>
<li><a href="/gostd/encoding/json/scanner.go.html">scanner.go</a></li>
<li><a href="/gostd/encoding/json/scanner_test.go.html">scanner_test.go</a></li>
<li><a href="/gostd/encoding/json/stream.go.html">stream.go</a></li>
<li><a href="/gostd/encoding/json/stream_test.go.html">stream_test.go</a></li>
<li><a href="/gostd/encoding/json/tagkey_test.go.html">tagkey_test.go</a></li>
<li><a href="/gostd/encoding/json/tags.go.html">tags.go</a></li>
<li><a href="/gostd/encoding/json/tags_test.go.html">tags_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5305888">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5305944">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5305998">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5306049">//&nbsp;Package&nbsp;json&nbsp;implements&nbsp;encoding&nbsp;and&nbsp;decoding&nbsp;of&nbsp;JSON&nbsp;objects&nbsp;as&nbsp;defined&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5306128">//&nbsp;RFC&nbsp;4627.&nbsp;The&nbsp;mapping&nbsp;between&nbsp;JSON&nbsp;objects&nbsp;and&nbsp;Go&nbsp;values&nbsp;is&nbsp;described</span><br>
<span class="lineno"></span><span class="comment" id="5306201">//&nbsp;in&nbsp;the&nbsp;documentation&nbsp;for&nbsp;the&nbsp;Marshal&nbsp;and&nbsp;Unmarshal&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="5306266">//</span><br>
<span class="lineno"></span><span class="comment" id="5306269">//&nbsp;See&nbsp;&#34;JSON&nbsp;and&nbsp;Go&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno">10</span><span class="comment" id="5306327">//&nbsp;http://golang.org/doc/articles/json_and_go.html</span><br>
<span class="lineno"></span><span class="keyword" id="5306378">package</span>&nbsp;<span class="ident" id="5306386">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5306392">import</span>&nbsp;<span class="op" id="5306399">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5306402">&#34;bytes&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5306411">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5306423">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5306442">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5306450">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5306461">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5306472">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5306480">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5306491">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5306502">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5306510">&#34;unicode&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5306521">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="5306536">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5306539">//&nbsp;Marshal&nbsp;returns&nbsp;the&nbsp;JSON&nbsp;encoding&nbsp;of&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5306582">//</span><br>
<span class="lineno">30</span><span class="comment" id="5306585">//&nbsp;Marshal&nbsp;traverses&nbsp;the&nbsp;value&nbsp;v&nbsp;recursively.</span><br>
<span class="lineno"></span><span class="comment" id="5306631">//&nbsp;If&nbsp;an&nbsp;encountered&nbsp;value&nbsp;implements&nbsp;the&nbsp;Marshaler&nbsp;interface</span><br>
<span class="lineno"></span><span class="comment" id="5306693">//&nbsp;and&nbsp;is&nbsp;not&nbsp;a&nbsp;nil&nbsp;pointer,&nbsp;Marshal&nbsp;calls&nbsp;its&nbsp;MarshalJSON&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="5306759">//&nbsp;to&nbsp;produce&nbsp;JSON.&nbsp;&nbsp;The&nbsp;nil&nbsp;pointer&nbsp;exception&nbsp;is&nbsp;not&nbsp;strictly&nbsp;necessary</span><br>
<span class="lineno"></span><span class="comment" id="5306832">//&nbsp;but&nbsp;mimics&nbsp;a&nbsp;similar,&nbsp;necessary&nbsp;exception&nbsp;in&nbsp;the&nbsp;behavior&nbsp;of</span><br>
<span class="lineno">35</span><span class="comment" id="5306896">//&nbsp;UnmarshalJSON.</span><br>
<span class="lineno"></span><span class="comment" id="5306914">//</span><br>
<span class="lineno"></span><span class="comment" id="5306917">//&nbsp;Otherwise,&nbsp;Marshal&nbsp;uses&nbsp;the&nbsp;following&nbsp;type-dependent&nbsp;default&nbsp;encodings:</span><br>
<span class="lineno"></span><span class="comment" id="5306992">//</span><br>
<span class="lineno"></span><span class="comment" id="5306995">//&nbsp;Boolean&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;booleans.</span><br>
<span class="lineno">40</span><span class="comment" id="5307038">//</span><br>
<span class="lineno"></span><span class="comment" id="5307041">//&nbsp;Floating&nbsp;point,&nbsp;integer,&nbsp;and&nbsp;Number&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;numbers.</span><br>
<span class="lineno"></span><span class="comment" id="5307111">//</span><br>
<span class="lineno"></span><span class="comment" id="5307114">//&nbsp;String&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;strings&nbsp;coerced&nbsp;to&nbsp;valid&nbsp;UTF-8,</span><br>
<span class="lineno"></span><span class="comment" id="5307178">//&nbsp;replacing&nbsp;invalid&nbsp;bytes&nbsp;with&nbsp;the&nbsp;Unicode&nbsp;replacement&nbsp;rune.</span><br>
<span class="lineno">45</span><span class="comment" id="5307240">//&nbsp;The&nbsp;angle&nbsp;brackets&nbsp;&#34;&lt;&#34;&nbsp;and&nbsp;&#34;&gt;&#34;&nbsp;are&nbsp;escaped&nbsp;to&nbsp;&#34;\u003c&#34;&nbsp;and&nbsp;&#34;\u003e&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5307311">//&nbsp;to&nbsp;keep&nbsp;some&nbsp;browsers&nbsp;from&nbsp;misinterpreting&nbsp;JSON&nbsp;output&nbsp;as&nbsp;HTML.</span><br>
<span class="lineno"></span><span class="comment" id="5307378">//&nbsp;Ampersand&nbsp;&#34;&amp;&#34;&nbsp;is&nbsp;also&nbsp;escaped&nbsp;to&nbsp;&#34;\u0026&#34;&nbsp;for&nbsp;the&nbsp;same&nbsp;reason.</span><br>
<span class="lineno"></span><span class="comment" id="5307444">//</span><br>
<span class="lineno"></span><span class="comment" id="5307447">//&nbsp;Array&nbsp;and&nbsp;slice&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;arrays,&nbsp;except&nbsp;that</span><br>
<span class="lineno">50</span><span class="comment" id="5307508">//&nbsp;[]byte&nbsp;encodes&nbsp;as&nbsp;a&nbsp;base64-encoded&nbsp;string,&nbsp;and&nbsp;a&nbsp;nil&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="5307570">//&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="5307606">//</span><br>
<span class="lineno"></span><span class="comment" id="5307609">//&nbsp;Struct&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;objects.&nbsp;Each&nbsp;exported&nbsp;struct&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="5307677">//&nbsp;becomes&nbsp;a&nbsp;member&nbsp;of&nbsp;the&nbsp;object&nbsp;unless</span><br>
<span class="lineno">55</span><span class="comment" id="5307718">//&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;field&#39;s&nbsp;tag&nbsp;is&nbsp;&#34;-&#34;,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5307752">//&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;field&nbsp;is&nbsp;empty&nbsp;and&nbsp;its&nbsp;tag&nbsp;specifies&nbsp;the&nbsp;&#34;omitempty&#34;&nbsp;option.</span><br>
<span class="lineno"></span><span class="comment" id="5307824">//&nbsp;The&nbsp;empty&nbsp;values&nbsp;are&nbsp;false,&nbsp;0,&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="5307862">//&nbsp;nil&nbsp;pointer&nbsp;or&nbsp;interface&nbsp;value,&nbsp;and&nbsp;any&nbsp;array,&nbsp;slice,&nbsp;map,&nbsp;or&nbsp;string&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5307937">//&nbsp;length&nbsp;zero.&nbsp;The&nbsp;object&#39;s&nbsp;default&nbsp;key&nbsp;string&nbsp;is&nbsp;the&nbsp;struct&nbsp;field&nbsp;name</span><br>
<span class="lineno">60</span><span class="comment" id="5308010">//&nbsp;but&nbsp;can&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;struct&nbsp;field&#39;s&nbsp;tag&nbsp;value.&nbsp;The&nbsp;&#34;json&#34;&nbsp;key&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5308085">//&nbsp;the&nbsp;struct&nbsp;field&#39;s&nbsp;tag&nbsp;value&nbsp;is&nbsp;the&nbsp;key&nbsp;name,&nbsp;followed&nbsp;by&nbsp;an&nbsp;optional&nbsp;comma</span><br>
<span class="lineno"></span><span class="comment" id="5308164">//&nbsp;and&nbsp;options.&nbsp;Examples:</span><br>
<span class="lineno"></span><span class="comment" id="5308190">//</span><br>
<span class="lineno"></span><span class="comment" id="5308193">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;is&nbsp;ignored&nbsp;by&nbsp;this&nbsp;package.</span><br>
<span class="lineno">65</span><span class="comment" id="5308235">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;-&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="5308261">//</span><br>
<span class="lineno"></span><span class="comment" id="5308264">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;myName&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="5308311">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;myName&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="5308342">//</span><br>
<span class="lineno">70</span><span class="comment" id="5308345">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;myName&#34;&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5308395">//&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;field&nbsp;is&nbsp;omitted&nbsp;from&nbsp;the&nbsp;object&nbsp;if&nbsp;its&nbsp;value&nbsp;is&nbsp;empty,</span><br>
<span class="lineno"></span><span class="comment" id="5308463">//&nbsp;&nbsp;&nbsp;//&nbsp;as&nbsp;defined&nbsp;above.</span><br>
<span class="lineno"></span><span class="comment" id="5308489">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;myName,omitempty&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="5308530">//</span><br>
<span class="lineno">75</span><span class="comment" id="5308533">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;Field&#34;&nbsp;(the&nbsp;default),&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="5308597">//&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;field&nbsp;is&nbsp;skipped&nbsp;if&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="5308636">//&nbsp;&nbsp;&nbsp;//&nbsp;Note&nbsp;the&nbsp;leading&nbsp;comma.</span><br>
<span class="lineno"></span><span class="comment" id="5308668">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;,omitempty&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="5308703">//</span><br>
<span class="lineno">80</span><span class="comment" id="5308706">//&nbsp;The&nbsp;&#34;string&#34;&nbsp;option&nbsp;signals&nbsp;that&nbsp;a&nbsp;field&nbsp;is&nbsp;stored&nbsp;as&nbsp;JSON&nbsp;inside&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5308777">//&nbsp;JSON-encoded&nbsp;string.&nbsp;It&nbsp;applies&nbsp;only&nbsp;to&nbsp;fields&nbsp;of&nbsp;string,&nbsp;floating&nbsp;point,</span><br>
<span class="lineno"></span><span class="comment" id="5308854">//&nbsp;or&nbsp;integer&nbsp;types.&nbsp;This&nbsp;extra&nbsp;level&nbsp;of&nbsp;encoding&nbsp;is&nbsp;sometimes&nbsp;used&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5308927">//&nbsp;communicating&nbsp;with&nbsp;JavaScript&nbsp;programs:</span><br>
<span class="lineno"></span><span class="comment" id="5308970">//</span><br>
<span class="lineno">85</span><span class="comment" id="5308973">//&nbsp;&nbsp;&nbsp;&nbsp;Int64String&nbsp;int64&nbsp;`json:&#34;,string&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="5309014">//</span><br>
<span class="lineno"></span><span class="comment" id="5309017">//&nbsp;The&nbsp;key&nbsp;name&nbsp;will&nbsp;be&nbsp;used&nbsp;if&nbsp;it&#39;s&nbsp;a&nbsp;non-empty&nbsp;string&nbsp;consisting&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5309087">//&nbsp;only&nbsp;Unicode&nbsp;letters,&nbsp;digits,&nbsp;dollar&nbsp;signs,&nbsp;percent&nbsp;signs,&nbsp;hyphens,</span><br>
<span class="lineno"></span><span class="comment" id="5309158">//&nbsp;underscores&nbsp;and&nbsp;slashes.</span><br>
<span class="lineno">90</span><span class="comment" id="5309186">//</span><br>
<span class="lineno"></span><span class="comment" id="5309189">//&nbsp;Anonymous&nbsp;struct&nbsp;fields&nbsp;are&nbsp;usually&nbsp;marshaled&nbsp;as&nbsp;if&nbsp;their&nbsp;inner&nbsp;exported&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="5309272">//&nbsp;were&nbsp;fields&nbsp;in&nbsp;the&nbsp;outer&nbsp;struct,&nbsp;subject&nbsp;to&nbsp;the&nbsp;usual&nbsp;Go&nbsp;visibility&nbsp;rules&nbsp;amended</span><br>
<span class="lineno"></span><span class="comment" id="5309357">//&nbsp;as&nbsp;described&nbsp;in&nbsp;the&nbsp;next&nbsp;paragraph.</span><br>
<span class="lineno"></span><span class="comment" id="5309396">//&nbsp;An&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;with&nbsp;a&nbsp;name&nbsp;given&nbsp;in&nbsp;its&nbsp;JSON&nbsp;tag&nbsp;is&nbsp;treated&nbsp;as</span><br>
<span class="lineno">95</span><span class="comment" id="5309473">//&nbsp;having&nbsp;that&nbsp;name,&nbsp;rather&nbsp;than&nbsp;being&nbsp;anonymous.</span><br>
<span class="lineno"></span><span class="comment" id="5309523">//&nbsp;An&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;of&nbsp;interface&nbsp;type&nbsp;is&nbsp;treated&nbsp;the&nbsp;same&nbsp;as&nbsp;having</span><br>
<span class="lineno"></span><span class="comment" id="5309600">//&nbsp;that&nbsp;type&nbsp;as&nbsp;its&nbsp;name,&nbsp;rather&nbsp;than&nbsp;being&nbsp;anonymous.</span><br>
<span class="lineno"></span><span class="comment" id="5309655">//</span><br>
<span class="lineno"></span><span class="comment" id="5309658">//&nbsp;The&nbsp;Go&nbsp;visibility&nbsp;rules&nbsp;for&nbsp;struct&nbsp;fields&nbsp;are&nbsp;amended&nbsp;for&nbsp;JSON&nbsp;when</span><br>
<span class="lineno">100</span><span class="comment" id="5309729">//&nbsp;deciding&nbsp;which&nbsp;field&nbsp;to&nbsp;marshal&nbsp;or&nbsp;unmarshal.&nbsp;If&nbsp;there&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5309791">//&nbsp;multiple&nbsp;fields&nbsp;at&nbsp;the&nbsp;same&nbsp;level,&nbsp;and&nbsp;that&nbsp;level&nbsp;is&nbsp;the&nbsp;least</span><br>
<span class="lineno"></span><span class="comment" id="5309857">//&nbsp;nested&nbsp;(and&nbsp;would&nbsp;therefore&nbsp;be&nbsp;the&nbsp;nesting&nbsp;level&nbsp;selected&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5309925">//&nbsp;usual&nbsp;Go&nbsp;rules),&nbsp;the&nbsp;following&nbsp;extra&nbsp;rules&nbsp;apply:</span><br>
<span class="lineno"></span><span class="comment" id="5309978">//</span><br>
<span class="lineno">105</span><span class="comment" id="5309981">//&nbsp;1)&nbsp;Of&nbsp;those&nbsp;fields,&nbsp;if&nbsp;any&nbsp;are&nbsp;JSON-tagged,&nbsp;only&nbsp;tagged&nbsp;fields&nbsp;are&nbsp;considered,</span><br>
<span class="lineno"></span><span class="comment" id="5310063">//&nbsp;even&nbsp;if&nbsp;there&nbsp;are&nbsp;multiple&nbsp;untagged&nbsp;fields&nbsp;that&nbsp;would&nbsp;otherwise&nbsp;conflict.</span><br>
<span class="lineno"></span><span class="comment" id="5310140">//&nbsp;2)&nbsp;If&nbsp;there&nbsp;is&nbsp;exactly&nbsp;one&nbsp;field&nbsp;(tagged&nbsp;or&nbsp;not&nbsp;according&nbsp;to&nbsp;the&nbsp;first&nbsp;rule),&nbsp;that&nbsp;is&nbsp;selected.</span><br>
<span class="lineno"></span><span class="comment" id="5310239">//&nbsp;3)&nbsp;Otherwise&nbsp;there&nbsp;are&nbsp;multiple&nbsp;fields,&nbsp;and&nbsp;all&nbsp;are&nbsp;ignored;&nbsp;no&nbsp;error&nbsp;occurs.</span><br>
<span class="lineno"></span><span class="comment" id="5310320">//</span><br>
<span class="lineno">110</span><span class="comment" id="5310323">//&nbsp;Handling&nbsp;of&nbsp;anonymous&nbsp;struct&nbsp;fields&nbsp;is&nbsp;new&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span><span class="comment" id="5310380">//&nbsp;Prior&nbsp;to&nbsp;Go&nbsp;1.1,&nbsp;anonymous&nbsp;struct&nbsp;fields&nbsp;were&nbsp;ignored.&nbsp;To&nbsp;force&nbsp;ignoring&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5310459">//&nbsp;an&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;in&nbsp;both&nbsp;current&nbsp;and&nbsp;earlier&nbsp;versions,&nbsp;give&nbsp;the&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="5310541">//&nbsp;a&nbsp;JSON&nbsp;tag&nbsp;of&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="5310563">//</span><br>
<span class="lineno">115</span><span class="comment" id="5310566">//&nbsp;Map&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;objects.</span><br>
<span class="lineno"></span><span class="comment" id="5310604">//&nbsp;The&nbsp;map&#39;s&nbsp;key&nbsp;type&nbsp;must&nbsp;be&nbsp;string;&nbsp;the&nbsp;object&nbsp;keys&nbsp;are&nbsp;used&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="5310676">//&nbsp;as&nbsp;map&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="5310692">//</span><br>
<span class="lineno"></span><span class="comment" id="5310695">//&nbsp;Pointer&nbsp;values&nbsp;encode&nbsp;as&nbsp;the&nbsp;value&nbsp;pointed&nbsp;to.</span><br>
<span class="lineno">120</span><span class="comment" id="5310745">//&nbsp;A&nbsp;nil&nbsp;pointer&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="5310795">//</span><br>
<span class="lineno"></span><span class="comment" id="5310798">//&nbsp;Interface&nbsp;values&nbsp;encode&nbsp;as&nbsp;the&nbsp;value&nbsp;contained&nbsp;in&nbsp;the&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="5310866">//&nbsp;A&nbsp;nil&nbsp;interface&nbsp;value&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="5310924">//</span><br>
<span class="lineno">125</span><span class="comment" id="5310927">//&nbsp;Channel,&nbsp;complex,&nbsp;and&nbsp;function&nbsp;values&nbsp;cannot&nbsp;be&nbsp;encoded&nbsp;in&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="comment" id="5310995">//&nbsp;Attempting&nbsp;to&nbsp;encode&nbsp;such&nbsp;a&nbsp;value&nbsp;causes&nbsp;Marshal&nbsp;to&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="5311057">//&nbsp;an&nbsp;UnsupportedTypeError.</span><br>
<span class="lineno"></span><span class="comment" id="5311085">//</span><br>
<span class="lineno"></span><span class="comment" id="5311088">//&nbsp;JSON&nbsp;cannot&nbsp;represent&nbsp;cyclic&nbsp;data&nbsp;structures&nbsp;and&nbsp;Marshal&nbsp;does&nbsp;not</span><br>
<span class="lineno">130</span><span class="comment" id="5311157">//&nbsp;handle&nbsp;them.&nbsp;&nbsp;Passing&nbsp;cyclic&nbsp;structures&nbsp;to&nbsp;Marshal&nbsp;will&nbsp;result&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5311226">//&nbsp;an&nbsp;infinite&nbsp;recursion.</span><br>
<span class="lineno"></span><span class="comment" id="5311252">//</span><br>
<span class="lineno"></span><span class="keyword" id="5311255">func</span>&nbsp;<span class="ident" id="5311260">Marshal</span><span class="op" id="5311267">(</span><span class="ident" id="5311268">v</span>&nbsp;<span class="keyword" id="5311270">interface</span><span class="op" id="5311279">{</span><span class="op" id="5311280">}</span><span class="op" id="5311281">)</span>&nbsp;<span class="op" id="5311283">(</span><span class="op" id="5311284">[</span><span class="op" id="5311285">]</span><span class="builtintype" id="5311286">byte</span><span class="op" id="5311290">,</span>&nbsp;<span class="builtintype" id="5311292">error</span><span class="op" id="5311297">)</span>&nbsp;<span class="op" id="5311299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5311302">e</span>&nbsp;<span class="op" id="5311304">:=</span>&nbsp;<span class="op" id="5311307">&amp;</span><span class="ident" id="5311308">encodeState</span><span class="op" id="5311319">{</span><span class="op" id="5311320">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5311323">err</span>&nbsp;<span class="op" id="5311327">:=</span>&nbsp;<span class="ident" id="5311330">e</span><span class="op" id="5311331">.</span><span class="ident" id="5311332">marshal</span><span class="op" id="5311339">(</span><span class="ident" id="5311340">v</span><span class="op" id="5311341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311344">if</span>&nbsp;<span class="ident" id="5311347">err</span>&nbsp;<span class="op" id="5311351">!=</span>&nbsp;<span class="ident" id="5311354">nil</span>&nbsp;<span class="op" id="5311358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311362">return</span>&nbsp;<span class="ident" id="5311369">nil</span><span class="op" id="5311372">,</span>&nbsp;<span class="ident" id="5311374">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5311379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311382">return</span>&nbsp;<span class="ident" id="5311389">e</span><span class="op" id="5311390">.</span><span class="ident" id="5311391">Bytes</span><span class="op" id="5311396">(</span><span class="op" id="5311397">)</span><span class="op" id="5311398">,</span>&nbsp;<span class="ident" id="5311400">nil</span><br>
<span class="lineno">140</span><span class="op" id="5311404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5311407">//&nbsp;MarshalIndent&nbsp;is&nbsp;like&nbsp;Marshal&nbsp;but&nbsp;applies&nbsp;Indent&nbsp;to&nbsp;format&nbsp;the&nbsp;output.</span><br>
<span class="lineno"></span><span class="keyword" id="5311481">func</span>&nbsp;<span class="ident" id="5311486">MarshalIndent</span><span class="op" id="5311499">(</span><span class="ident" id="5311500">v</span>&nbsp;<span class="keyword" id="5311502">interface</span><span class="op" id="5311511">{</span><span class="op" id="5311512">}</span><span class="op" id="5311513">,</span>&nbsp;<span class="ident" id="5311515">prefix</span><span class="op" id="5311521">,</span>&nbsp;<span class="ident" id="5311523">indent</span>&nbsp;<span class="builtintype" id="5311530">string</span><span class="op" id="5311536">)</span>&nbsp;<span class="op" id="5311538">(</span><span class="op" id="5311539">[</span><span class="op" id="5311540">]</span><span class="builtintype" id="5311541">byte</span><span class="op" id="5311545">,</span>&nbsp;<span class="builtintype" id="5311547">error</span><span class="op" id="5311552">)</span>&nbsp;<span class="op" id="5311554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5311557">b</span><span class="op" id="5311558">,</span>&nbsp;<span class="ident" id="5311560">err</span>&nbsp;<span class="op" id="5311564">:=</span>&nbsp;<span class="ident" id="5311567">Marshal</span><span class="op" id="5311574">(</span><span class="ident" id="5311575">v</span><span class="op" id="5311576">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311579">if</span>&nbsp;<span class="ident" id="5311582">err</span>&nbsp;<span class="op" id="5311586">!=</span>&nbsp;<span class="ident" id="5311589">nil</span>&nbsp;<span class="op" id="5311593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311597">return</span>&nbsp;<span class="ident" id="5311604">nil</span><span class="op" id="5311607">,</span>&nbsp;<span class="ident" id="5311609">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5311614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311617">var</span>&nbsp;<span class="ident" id="5311621">buf</span>&nbsp;<span class="ident" id="5311625">bytes</span><span class="op" id="5311630">.</span><span class="ident" id="5311631">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5311639">err</span>&nbsp;<span class="op" id="5311643">=</span>&nbsp;<span class="ident" id="5311645">Indent</span><span class="op" id="5311651">(</span><span class="op" id="5311652">&amp;</span><span class="ident" id="5311653">buf</span><span class="op" id="5311656">,</span>&nbsp;<span class="ident" id="5311658">b</span><span class="op" id="5311659">,</span>&nbsp;<span class="ident" id="5311661">prefix</span><span class="op" id="5311667">,</span>&nbsp;<span class="ident" id="5311669">indent</span><span class="op" id="5311675">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311678">if</span>&nbsp;<span class="ident" id="5311681">err</span>&nbsp;<span class="op" id="5311685">!=</span>&nbsp;<span class="ident" id="5311688">nil</span>&nbsp;<span class="op" id="5311692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311696">return</span>&nbsp;<span class="ident" id="5311703">nil</span><span class="op" id="5311706">,</span>&nbsp;<span class="ident" id="5311708">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5311713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311716">return</span>&nbsp;<span class="ident" id="5311723">buf</span><span class="op" id="5311726">.</span><span class="ident" id="5311727">Bytes</span><span class="op" id="5311732">(</span><span class="op" id="5311733">)</span><span class="op" id="5311734">,</span>&nbsp;<span class="ident" id="5311736">nil</span><br>
<span class="lineno"></span><span class="op" id="5311740">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5311743">//&nbsp;HTMLEscape&nbsp;appends&nbsp;to&nbsp;dst&nbsp;the&nbsp;JSON-encoded&nbsp;src&nbsp;with&nbsp;&lt;,&nbsp;&gt;,&nbsp;&amp;,&nbsp;U+2028&nbsp;and&nbsp;U+2029</span><br>
<span class="lineno"></span><span class="comment" id="5311825">//&nbsp;characters&nbsp;inside&nbsp;string&nbsp;literals&nbsp;changed&nbsp;to&nbsp;\u003c,&nbsp;\u003e,&nbsp;\u0026,&nbsp;\u2028,&nbsp;\u2029</span><br>
<span class="lineno"></span><span class="comment" id="5311912">//&nbsp;so&nbsp;that&nbsp;the&nbsp;JSON&nbsp;will&nbsp;be&nbsp;safe&nbsp;to&nbsp;embed&nbsp;inside&nbsp;HTML&nbsp;&lt;script&gt;&nbsp;tags.</span><br>
<span class="lineno"></span><span class="comment" id="5311981">//&nbsp;For&nbsp;historical&nbsp;reasons,&nbsp;web&nbsp;browsers&nbsp;don&#39;t&nbsp;honor&nbsp;standard&nbsp;HTML</span><br>
<span class="lineno">160</span><span class="comment" id="5312047">//&nbsp;escaping&nbsp;within&nbsp;&lt;script&gt;&nbsp;tags,&nbsp;so&nbsp;an&nbsp;alternative&nbsp;JSON&nbsp;encoding&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="5312118">//&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5312130">func</span>&nbsp;<span class="ident" id="5312135">HTMLEscape</span><span class="op" id="5312145">(</span><span class="ident" id="5312146">dst</span>&nbsp;<span class="op" id="5312150">*</span><span class="ident" id="5312151">bytes</span><span class="op" id="5312156">.</span><span class="ident" id="5312157">Buffer</span><span class="op" id="5312163">,</span>&nbsp;<span class="ident" id="5312165">src</span>&nbsp;<span class="op" id="5312169">[</span><span class="op" id="5312170">]</span><span class="builtintype" id="5312171">byte</span><span class="op" id="5312175">)</span>&nbsp;<span class="op" id="5312177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5312180">//&nbsp;The&nbsp;characters&nbsp;can&nbsp;only&nbsp;appear&nbsp;in&nbsp;string&nbsp;literals,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5312235">//&nbsp;so&nbsp;just&nbsp;scan&nbsp;the&nbsp;string&nbsp;one&nbsp;byte&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312283">start</span>&nbsp;<span class="op" id="5312289">:=</span>&nbsp;<span class="num" id="5312292">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5312295">for</span>&nbsp;<span class="ident" id="5312299">i</span><span class="op" id="5312300">,</span>&nbsp;<span class="ident" id="5312302">c</span>&nbsp;<span class="op" id="5312304">:=</span>&nbsp;<span class="keyword" id="5312307">range</span>&nbsp;<span class="ident" id="5312313">src</span>&nbsp;<span class="op" id="5312317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5312321">if</span>&nbsp;<span class="ident" id="5312324">c</span>&nbsp;<span class="op" id="5312326">==</span>&nbsp;<span class="string" id="5312329">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5312333">||</span>&nbsp;<span class="ident" id="5312336">c</span>&nbsp;<span class="op" id="5312338">==</span>&nbsp;<span class="string" id="5312341">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="5312345">||</span>&nbsp;<span class="ident" id="5312348">c</span>&nbsp;<span class="op" id="5312350">==</span>&nbsp;<span class="string" id="5312353">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="5312357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5312362">if</span>&nbsp;<span class="ident" id="5312365">start</span>&nbsp;<span class="op" id="5312371">&lt;</span>&nbsp;<span class="ident" id="5312373">i</span>&nbsp;<span class="op" id="5312375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312381">dst</span><span class="op" id="5312384">.</span><span class="ident" id="5312385">Write</span><span class="op" id="5312390">(</span><span class="ident" id="5312391">src</span><span class="op" id="5312394">[</span><span class="ident" id="5312395">start</span><span class="op" id="5312400">:</span><span class="ident" id="5312401">i</span><span class="op" id="5312402">]</span><span class="op" id="5312403">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5312408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312413">dst</span><span class="op" id="5312416">.</span><span class="ident" id="5312417">WriteString</span><span class="op" id="5312428">(</span><span class="string" id="5312429">`\u00`</span><span class="op" id="5312435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312440">dst</span><span class="op" id="5312443">.</span><span class="ident" id="5312444">WriteByte</span><span class="op" id="5312453">(</span><span class="ident" id="5312454">hex</span><span class="op" id="5312457">[</span><span class="ident" id="5312458">c</span><span class="op" id="5312459">&gt;&gt;</span><span class="num" id="5312461">4</span><span class="op" id="5312462">]</span><span class="op" id="5312463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312468">dst</span><span class="op" id="5312471">.</span><span class="ident" id="5312472">WriteByte</span><span class="op" id="5312481">(</span><span class="ident" id="5312482">hex</span><span class="op" id="5312485">[</span><span class="ident" id="5312486">c</span><span class="op" id="5312487">&amp;</span><span class="num" id="5312488">0xF</span><span class="op" id="5312491">]</span><span class="op" id="5312492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312497">start</span>&nbsp;<span class="op" id="5312503">=</span>&nbsp;<span class="ident" id="5312505">i</span>&nbsp;<span class="op" id="5312507">+</span>&nbsp;<span class="num" id="5312509">1</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5312513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5312517">//&nbsp;Convert&nbsp;U+2028&nbsp;and&nbsp;U+2029&nbsp;(E2&nbsp;80&nbsp;A8&nbsp;and&nbsp;E2&nbsp;80&nbsp;A9).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5312573">if</span>&nbsp;<span class="ident" id="5312576">c</span>&nbsp;<span class="op" id="5312578">==</span>&nbsp;<span class="num" id="5312581">0xE2</span>&nbsp;<span class="op" id="5312586">&amp;&amp;</span>&nbsp;<span class="ident" id="5312589">i</span><span class="op" id="5312590">+</span><span class="num" id="5312591">2</span>&nbsp;<span class="op" id="5312593">&lt;</span>&nbsp;<span class="builtinfunc" id="5312595">len</span><span class="op" id="5312598">(</span><span class="ident" id="5312599">src</span><span class="op" id="5312602">)</span>&nbsp;<span class="op" id="5312604">&amp;&amp;</span>&nbsp;<span class="ident" id="5312607">src</span><span class="op" id="5312610">[</span><span class="ident" id="5312611">i</span><span class="op" id="5312612">+</span><span class="num" id="5312613">1</span><span class="op" id="5312614">]</span>&nbsp;<span class="op" id="5312616">==</span>&nbsp;<span class="num" id="5312619">0x80</span>&nbsp;<span class="op" id="5312624">&amp;&amp;</span>&nbsp;<span class="ident" id="5312627">src</span><span class="op" id="5312630">[</span><span class="ident" id="5312631">i</span><span class="op" id="5312632">+</span><span class="num" id="5312633">2</span><span class="op" id="5312634">]</span><span class="op" id="5312635">&amp;^</span><span class="num" id="5312637">1</span>&nbsp;<span class="op" id="5312639">==</span>&nbsp;<span class="num" id="5312642">0xA8</span>&nbsp;<span class="op" id="5312647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5312652">if</span>&nbsp;<span class="ident" id="5312655">start</span>&nbsp;<span class="op" id="5312661">&lt;</span>&nbsp;<span class="ident" id="5312663">i</span>&nbsp;<span class="op" id="5312665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312671">dst</span><span class="op" id="5312674">.</span><span class="ident" id="5312675">Write</span><span class="op" id="5312680">(</span><span class="ident" id="5312681">src</span><span class="op" id="5312684">[</span><span class="ident" id="5312685">start</span><span class="op" id="5312690">:</span><span class="ident" id="5312691">i</span><span class="op" id="5312692">]</span><span class="op" id="5312693">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5312698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312703">dst</span><span class="op" id="5312706">.</span><span class="ident" id="5312707">WriteString</span><span class="op" id="5312718">(</span><span class="string" id="5312719">`\u202`</span><span class="op" id="5312726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312731">dst</span><span class="op" id="5312734">.</span><span class="ident" id="5312735">WriteByte</span><span class="op" id="5312744">(</span><span class="ident" id="5312745">hex</span><span class="op" id="5312748">[</span><span class="ident" id="5312749">src</span><span class="op" id="5312752">[</span><span class="ident" id="5312753">i</span><span class="op" id="5312754">+</span><span class="num" id="5312755">2</span><span class="op" id="5312756">]</span><span class="op" id="5312757">&amp;</span><span class="num" id="5312758">0xF</span><span class="op" id="5312761">]</span><span class="op" id="5312762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312767">start</span>&nbsp;<span class="op" id="5312773">=</span>&nbsp;<span class="ident" id="5312775">i</span>&nbsp;<span class="op" id="5312777">+</span>&nbsp;<span class="num" id="5312779">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5312783">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5312786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5312789">if</span>&nbsp;<span class="ident" id="5312792">start</span>&nbsp;<span class="op" id="5312798">&lt;</span>&nbsp;<span class="builtinfunc" id="5312800">len</span><span class="op" id="5312803">(</span><span class="ident" id="5312804">src</span><span class="op" id="5312807">)</span>&nbsp;<span class="op" id="5312809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312813">dst</span><span class="op" id="5312816">.</span><span class="ident" id="5312817">Write</span><span class="op" id="5312822">(</span><span class="ident" id="5312823">src</span><span class="op" id="5312826">[</span><span class="ident" id="5312827">start</span><span class="op" id="5312832">:</span><span class="op" id="5312833">]</span><span class="op" id="5312834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5312837">}</span><br>
<span class="lineno"></span><span class="op" id="5312839">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5312842">//&nbsp;Marshaler&nbsp;is&nbsp;the&nbsp;interface&nbsp;implemented&nbsp;by&nbsp;objects&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5312900">//&nbsp;can&nbsp;marshal&nbsp;themselves&nbsp;into&nbsp;valid&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="5312943">type</span>&nbsp;<span class="ident" id="5312948">Marshaler</span>&nbsp;<span class="keyword" id="5312958">interface</span>&nbsp;<span class="op" id="5312968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312971">MarshalJSON</span><span class="op" id="5312982">(</span><span class="op" id="5312983">)</span>&nbsp;<span class="op" id="5312985">(</span><span class="op" id="5312986">[</span><span class="op" id="5312987">]</span><span class="builtintype" id="5312988">byte</span><span class="op" id="5312992">,</span>&nbsp;<span class="builtintype" id="5312994">error</span><span class="op" id="5312999">)</span><br>
<span class="lineno">195</span><span class="op" id="5313001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5313004">//&nbsp;An&nbsp;UnsupportedTypeError&nbsp;is&nbsp;returned&nbsp;by&nbsp;Marshal&nbsp;when&nbsp;attempting</span><br>
<span class="lineno"></span><span class="comment" id="5313070">//&nbsp;to&nbsp;encode&nbsp;an&nbsp;unsupported&nbsp;value&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5313110">type</span>&nbsp;<span class="ident" id="5313115">UnsupportedTypeError</span>&nbsp;<span class="keyword" id="5313136">struct</span>&nbsp;<span class="op" id="5313143">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5313146">Type</span>&nbsp;<span class="ident" id="5313151">reflect</span><span class="op" id="5313158">.</span><span class="ident" id="5313159">Type</span><br>
<span class="lineno"></span><span class="op" id="5313164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5313167">func</span>&nbsp;<span class="op" id="5313172">(</span><span class="ident" id="5313173">e</span>&nbsp;<span class="op" id="5313175">*</span><span class="ident" id="5313176">UnsupportedTypeError</span><span class="op" id="5313196">)</span>&nbsp;<span class="ident" id="5313198">Error</span><span class="op" id="5313203">(</span><span class="op" id="5313204">)</span>&nbsp;<span class="builtintype" id="5313206">string</span>&nbsp;<span class="op" id="5313213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313216">return</span>&nbsp;<span class="string" id="5313223">&#34;json:&nbsp;unsupported&nbsp;type:&nbsp;&#34;</span>&nbsp;<span class="op" id="5313250">+</span>&nbsp;<span class="ident" id="5313252">e</span><span class="op" id="5313253">.</span><span class="ident" id="5313254">Type</span><span class="op" id="5313258">.</span><span class="ident" id="5313259">String</span><span class="op" id="5313265">(</span><span class="op" id="5313266">)</span><br>
<span class="lineno">205</span><span class="op" id="5313268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5313271">type</span>&nbsp;<span class="ident" id="5313276">UnsupportedValueError</span>&nbsp;<span class="keyword" id="5313298">struct</span>&nbsp;<span class="op" id="5313305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5313308">Value</span>&nbsp;<span class="ident" id="5313314">reflect</span><span class="op" id="5313321">.</span><span class="ident" id="5313322">Value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5313329">Str</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5313335">string</span><br>
<span class="lineno">210</span><span class="op" id="5313342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5313345">func</span>&nbsp;<span class="op" id="5313350">(</span><span class="ident" id="5313351">e</span>&nbsp;<span class="op" id="5313353">*</span><span class="ident" id="5313354">UnsupportedValueError</span><span class="op" id="5313375">)</span>&nbsp;<span class="ident" id="5313377">Error</span><span class="op" id="5313382">(</span><span class="op" id="5313383">)</span>&nbsp;<span class="builtintype" id="5313385">string</span>&nbsp;<span class="op" id="5313392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313395">return</span>&nbsp;<span class="string" id="5313402">&#34;json:&nbsp;unsupported&nbsp;value:&nbsp;&#34;</span>&nbsp;<span class="op" id="5313430">+</span>&nbsp;<span class="ident" id="5313432">e</span><span class="op" id="5313433">.</span><span class="ident" id="5313434">Str</span><br>
<span class="lineno"></span><span class="op" id="5313438">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="5313441">//&nbsp;Before&nbsp;Go&nbsp;1.2,&nbsp;an&nbsp;InvalidUTF8Error&nbsp;was&nbsp;returned&nbsp;by&nbsp;Marshal&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5313508">//&nbsp;attempting&nbsp;to&nbsp;encode&nbsp;a&nbsp;string&nbsp;value&nbsp;with&nbsp;invalid&nbsp;UTF-8&nbsp;sequences.</span><br>
<span class="lineno"></span><span class="comment" id="5313577">//&nbsp;As&nbsp;of&nbsp;Go&nbsp;1.2,&nbsp;Marshal&nbsp;instead&nbsp;coerces&nbsp;the&nbsp;string&nbsp;to&nbsp;valid&nbsp;UTF-8&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5313647">//&nbsp;replacing&nbsp;invalid&nbsp;bytes&nbsp;with&nbsp;the&nbsp;Unicode&nbsp;replacement&nbsp;rune&nbsp;U+FFFD.</span><br>
<span class="lineno">220</span><span class="comment" id="5313716">//&nbsp;This&nbsp;error&nbsp;is&nbsp;no&nbsp;longer&nbsp;generated&nbsp;but&nbsp;is&nbsp;kept&nbsp;for&nbsp;backwards&nbsp;compatibility</span><br>
<span class="lineno"></span><span class="comment" id="5313793">//&nbsp;with&nbsp;programs&nbsp;that&nbsp;might&nbsp;mention&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5313833">type</span>&nbsp;<span class="ident" id="5313838">InvalidUTF8Error</span>&nbsp;<span class="keyword" id="5313855">struct</span>&nbsp;<span class="op" id="5313862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5313865">S</span>&nbsp;<span class="builtintype" id="5313867">string</span>&nbsp;<span class="comment" id="5313874">//&nbsp;the&nbsp;whole&nbsp;string&nbsp;value&nbsp;that&nbsp;caused&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span><span class="op" id="5313922">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="5313925">func</span>&nbsp;<span class="op" id="5313930">(</span><span class="ident" id="5313931">e</span>&nbsp;<span class="op" id="5313933">*</span><span class="ident" id="5313934">InvalidUTF8Error</span><span class="op" id="5313950">)</span>&nbsp;<span class="ident" id="5313952">Error</span><span class="op" id="5313957">(</span><span class="op" id="5313958">)</span>&nbsp;<span class="builtintype" id="5313960">string</span>&nbsp;<span class="op" id="5313967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313970">return</span>&nbsp;<span class="string" id="5313977">&#34;json:&nbsp;invalid&nbsp;UTF-8&nbsp;in&nbsp;string:&nbsp;&#34;</span>&nbsp;<span class="op" id="5314011">+</span>&nbsp;<span class="ident" id="5314013">strconv</span><span class="op" id="5314020">.</span><span class="ident" id="5314021">Quote</span><span class="op" id="5314026">(</span><span class="ident" id="5314027">e</span><span class="op" id="5314028">.</span><span class="ident" id="5314029">S</span><span class="op" id="5314030">)</span><br>
<span class="lineno"></span><span class="op" id="5314032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="5314035">type</span>&nbsp;<span class="ident" id="5314040">MarshalerError</span>&nbsp;<span class="keyword" id="5314055">struct</span>&nbsp;<span class="op" id="5314062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314065">Type</span>&nbsp;<span class="ident" id="5314070">reflect</span><span class="op" id="5314077">.</span><span class="ident" id="5314078">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314084">Err</span>&nbsp;&nbsp;<span class="builtintype" id="5314089">error</span><br>
<span class="lineno"></span><span class="op" id="5314095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span><span class="keyword" id="5314098">func</span>&nbsp;<span class="op" id="5314103">(</span><span class="ident" id="5314104">e</span>&nbsp;<span class="op" id="5314106">*</span><span class="ident" id="5314107">MarshalerError</span><span class="op" id="5314121">)</span>&nbsp;<span class="ident" id="5314123">Error</span><span class="op" id="5314128">(</span><span class="op" id="5314129">)</span>&nbsp;<span class="builtintype" id="5314131">string</span>&nbsp;<span class="op" id="5314138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314141">return</span>&nbsp;<span class="string" id="5314148">&#34;json:&nbsp;error&nbsp;calling&nbsp;MarshalJSON&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5314192">+</span>&nbsp;<span class="ident" id="5314194">e</span><span class="op" id="5314195">.</span><span class="ident" id="5314196">Type</span><span class="op" id="5314200">.</span><span class="ident" id="5314201">String</span><span class="op" id="5314207">(</span><span class="op" id="5314208">)</span>&nbsp;<span class="op" id="5314210">+</span>&nbsp;<span class="string" id="5314212">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="5314217">+</span>&nbsp;<span class="ident" id="5314219">e</span><span class="op" id="5314220">.</span><span class="ident" id="5314221">Err</span><span class="op" id="5314224">.</span><span class="ident" id="5314225">Error</span><span class="op" id="5314230">(</span><span class="op" id="5314231">)</span><br>
<span class="lineno"></span><span class="op" id="5314233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5314236">var</span>&nbsp;<span class="ident" id="5314240">hex</span>&nbsp;<span class="op" id="5314244">=</span>&nbsp;<span class="string" id="5314246">&#34;0123456789abcdef&#34;</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="5314266">//&nbsp;An&nbsp;encodeState&nbsp;encodes&nbsp;JSON&nbsp;into&nbsp;a&nbsp;bytes.Buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="5314318">type</span>&nbsp;<span class="ident" id="5314323">encodeState</span>&nbsp;<span class="keyword" id="5314335">struct</span>&nbsp;<span class="op" id="5314342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314345">bytes</span><span class="op" id="5314350">.</span><span class="ident" id="5314351">Buffer</span>&nbsp;<span class="comment" id="5314358">//&nbsp;accumulated&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314381">scratch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5314394">[</span><span class="num" id="5314395">64</span><span class="op" id="5314397">]</span><span class="builtintype" id="5314398">byte</span><br>
<span class="lineno">245</span><span class="op" id="5314403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5314406">var</span>&nbsp;<span class="ident" id="5314410">encodeStatePool</span>&nbsp;<span class="ident" id="5314426">sync</span><span class="op" id="5314430">.</span><span class="ident" id="5314431">Pool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5314437">func</span>&nbsp;<span class="ident" id="5314442">newEncodeState</span><span class="op" id="5314456">(</span><span class="op" id="5314457">)</span>&nbsp;<span class="op" id="5314459">*</span><span class="ident" id="5314460">encodeState</span>&nbsp;<span class="op" id="5314472">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314475">if</span>&nbsp;<span class="ident" id="5314478">v</span>&nbsp;<span class="op" id="5314480">:=</span>&nbsp;<span class="ident" id="5314483">encodeStatePool</span><span class="op" id="5314498">.</span><span class="ident" id="5314499">Get</span><span class="op" id="5314502">(</span><span class="op" id="5314503">)</span><span class="op" id="5314504">;</span>&nbsp;<span class="ident" id="5314506">v</span>&nbsp;<span class="op" id="5314508">!=</span>&nbsp;<span class="ident" id="5314511">nil</span>&nbsp;<span class="op" id="5314515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314519">e</span>&nbsp;<span class="op" id="5314521">:=</span>&nbsp;<span class="ident" id="5314524">v</span><span class="op" id="5314525">.</span><span class="op" id="5314526">(</span><span class="op" id="5314527">*</span><span class="ident" id="5314528">encodeState</span><span class="op" id="5314539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314543">e</span><span class="op" id="5314544">.</span><span class="ident" id="5314545">Reset</span><span class="op" id="5314550">(</span><span class="op" id="5314551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314555">return</span>&nbsp;<span class="ident" id="5314562">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314565">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314568">return</span>&nbsp;<span class="builtinfunc" id="5314575">new</span><span class="op" id="5314578">(</span><span class="ident" id="5314579">encodeState</span><span class="op" id="5314590">)</span><br>
<span class="lineno"></span><span class="op" id="5314592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5314595">func</span>&nbsp;<span class="op" id="5314600">(</span><span class="ident" id="5314601">e</span>&nbsp;<span class="op" id="5314603">*</span><span class="ident" id="5314604">encodeState</span><span class="op" id="5314615">)</span>&nbsp;<span class="ident" id="5314617">marshal</span><span class="op" id="5314624">(</span><span class="ident" id="5314625">v</span>&nbsp;<span class="keyword" id="5314627">interface</span><span class="op" id="5314636">{</span><span class="op" id="5314637">}</span><span class="op" id="5314638">)</span>&nbsp;<span class="op" id="5314640">(</span><span class="ident" id="5314641">err</span>&nbsp;<span class="builtintype" id="5314645">error</span><span class="op" id="5314650">)</span>&nbsp;<span class="op" id="5314652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314655">defer</span>&nbsp;<span class="keyword" id="5314661">func</span><span class="op" id="5314665">(</span><span class="op" id="5314666">)</span>&nbsp;<span class="op" id="5314668">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314672">if</span>&nbsp;<span class="ident" id="5314675">r</span>&nbsp;<span class="op" id="5314677">:=</span>&nbsp;<span class="builtinfunc" id="5314680">recover</span><span class="op" id="5314687">(</span><span class="op" id="5314688">)</span><span class="op" id="5314689">;</span>&nbsp;<span class="ident" id="5314691">r</span>&nbsp;<span class="op" id="5314693">!=</span>&nbsp;<span class="ident" id="5314696">nil</span>&nbsp;<span class="op" id="5314700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314705">if</span>&nbsp;<span class="ident" id="5314708">_</span><span class="op" id="5314709">,</span>&nbsp;<span class="ident" id="5314711">ok</span>&nbsp;<span class="op" id="5314714">:=</span>&nbsp;<span class="ident" id="5314717">r</span><span class="op" id="5314718">.</span><span class="op" id="5314719">(</span><span class="ident" id="5314720">runtime</span><span class="op" id="5314727">.</span><span class="ident" id="5314728">Error</span><span class="op" id="5314733">)</span><span class="op" id="5314734">;</span>&nbsp;<span class="ident" id="5314736">ok</span>&nbsp;<span class="op" id="5314739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5314745">panic</span><span class="op" id="5314750">(</span><span class="ident" id="5314751">r</span><span class="op" id="5314752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314762">if</span>&nbsp;<span class="ident" id="5314765">s</span><span class="op" id="5314766">,</span>&nbsp;<span class="ident" id="5314768">ok</span>&nbsp;<span class="op" id="5314771">:=</span>&nbsp;<span class="ident" id="5314774">r</span><span class="op" id="5314775">.</span><span class="op" id="5314776">(</span><span class="builtintype" id="5314777">string</span><span class="op" id="5314783">)</span><span class="op" id="5314784">;</span>&nbsp;<span class="ident" id="5314786">ok</span>&nbsp;<span class="op" id="5314789">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5314795">panic</span><span class="op" id="5314800">(</span><span class="ident" id="5314801">s</span><span class="op" id="5314802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314812">err</span>&nbsp;<span class="op" id="5314816">=</span>&nbsp;<span class="ident" id="5314818">r</span><span class="op" id="5314819">.</span><span class="op" id="5314820">(</span><span class="builtintype" id="5314821">error</span><span class="op" id="5314826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314833">}</span><span class="op" id="5314834">(</span><span class="op" id="5314835">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314838">e</span><span class="op" id="5314839">.</span><span class="ident" id="5314840">reflectValue</span><span class="op" id="5314852">(</span><span class="ident" id="5314853">reflect</span><span class="op" id="5314860">.</span><span class="ident" id="5314861">ValueOf</span><span class="op" id="5314868">(</span><span class="ident" id="5314869">v</span><span class="op" id="5314870">)</span><span class="op" id="5314871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314874">return</span>&nbsp;<span class="ident" id="5314881">nil</span><br>
<span class="lineno"></span><span class="op" id="5314885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5314888">func</span>&nbsp;<span class="op" id="5314893">(</span><span class="ident" id="5314894">e</span>&nbsp;<span class="op" id="5314896">*</span><span class="ident" id="5314897">encodeState</span><span class="op" id="5314908">)</span>&nbsp;<span class="builtintype" id="5314910">error</span><span class="op" id="5314915">(</span><span class="ident" id="5314916">err</span>&nbsp;<span class="builtintype" id="5314920">error</span><span class="op" id="5314925">)</span>&nbsp;<span class="op" id="5314927">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5314930">panic</span><span class="op" id="5314935">(</span><span class="ident" id="5314936">err</span><span class="op" id="5314939">)</span><br>
<span class="lineno"></span><span class="op" id="5314941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5314944">var</span>&nbsp;<span class="ident" id="5314948">byteSliceType</span>&nbsp;<span class="op" id="5314962">=</span>&nbsp;<span class="ident" id="5314964">reflect</span><span class="op" id="5314971">.</span><span class="ident" id="5314972">TypeOf</span><span class="op" id="5314978">(</span><span class="op" id="5314979">[</span><span class="op" id="5314980">]</span><span class="builtintype" id="5314981">byte</span><span class="op" id="5314985">(</span><span class="ident" id="5314986">nil</span><span class="op" id="5314989">)</span><span class="op" id="5314990">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="keyword" id="5314993">func</span>&nbsp;<span class="ident" id="5314998">isEmptyValue</span><span class="op" id="5315010">(</span><span class="ident" id="5315011">v</span>&nbsp;<span class="ident" id="5315013">reflect</span><span class="op" id="5315020">.</span><span class="ident" id="5315021">Value</span><span class="op" id="5315026">)</span>&nbsp;<span class="builtintype" id="5315028">bool</span>&nbsp;<span class="op" id="5315033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315036">switch</span>&nbsp;<span class="ident" id="5315043">v</span><span class="op" id="5315044">.</span><span class="ident" id="5315045">Kind</span><span class="op" id="5315049">(</span><span class="op" id="5315050">)</span>&nbsp;<span class="op" id="5315052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315055">case</span>&nbsp;<span class="ident" id="5315060">reflect</span><span class="op" id="5315067">.</span><span class="ident" id="5315068">Array</span><span class="op" id="5315073">,</span>&nbsp;<span class="ident" id="5315075">reflect</span><span class="op" id="5315082">.</span><span class="ident" id="5315083">Map</span><span class="op" id="5315086">,</span>&nbsp;<span class="ident" id="5315088">reflect</span><span class="op" id="5315095">.</span><span class="ident" id="5315096">Slice</span><span class="op" id="5315101">,</span>&nbsp;<span class="ident" id="5315103">reflect</span><span class="op" id="5315110">.</span><span class="ident" id="5315111">String</span><span class="op" id="5315117">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315121">return</span>&nbsp;<span class="ident" id="5315128">v</span><span class="op" id="5315129">.</span><span class="ident" id="5315130">Len</span><span class="op" id="5315133">(</span><span class="op" id="5315134">)</span>&nbsp;<span class="op" id="5315136">==</span>&nbsp;<span class="num" id="5315139">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315142">case</span>&nbsp;<span class="ident" id="5315147">reflect</span><span class="op" id="5315154">.</span><span class="ident" id="5315155">Bool</span><span class="op" id="5315159">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315163">return</span>&nbsp;<span class="op" id="5315170">!</span><span class="ident" id="5315171">v</span><span class="op" id="5315172">.</span><span class="ident" id="5315173">Bool</span><span class="op" id="5315177">(</span><span class="op" id="5315178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315181">case</span>&nbsp;<span class="ident" id="5315186">reflect</span><span class="op" id="5315193">.</span><span class="ident" id="5315194">Int</span><span class="op" id="5315197">,</span>&nbsp;<span class="ident" id="5315199">reflect</span><span class="op" id="5315206">.</span><span class="ident" id="5315207">Int8</span><span class="op" id="5315211">,</span>&nbsp;<span class="ident" id="5315213">reflect</span><span class="op" id="5315220">.</span><span class="ident" id="5315221">Int16</span><span class="op" id="5315226">,</span>&nbsp;<span class="ident" id="5315228">reflect</span><span class="op" id="5315235">.</span><span class="ident" id="5315236">Int32</span><span class="op" id="5315241">,</span>&nbsp;<span class="ident" id="5315243">reflect</span><span class="op" id="5315250">.</span><span class="ident" id="5315251">Int64</span><span class="op" id="5315256">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315260">return</span>&nbsp;<span class="ident" id="5315267">v</span><span class="op" id="5315268">.</span><span class="ident" id="5315269">Int</span><span class="op" id="5315272">(</span><span class="op" id="5315273">)</span>&nbsp;<span class="op" id="5315275">==</span>&nbsp;<span class="num" id="5315278">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315281">case</span>&nbsp;<span class="ident" id="5315286">reflect</span><span class="op" id="5315293">.</span><span class="ident" id="5315294">Uint</span><span class="op" id="5315298">,</span>&nbsp;<span class="ident" id="5315300">reflect</span><span class="op" id="5315307">.</span><span class="ident" id="5315308">Uint8</span><span class="op" id="5315313">,</span>&nbsp;<span class="ident" id="5315315">reflect</span><span class="op" id="5315322">.</span><span class="ident" id="5315323">Uint16</span><span class="op" id="5315329">,</span>&nbsp;<span class="ident" id="5315331">reflect</span><span class="op" id="5315338">.</span><span class="ident" id="5315339">Uint32</span><span class="op" id="5315345">,</span>&nbsp;<span class="ident" id="5315347">reflect</span><span class="op" id="5315354">.</span><span class="ident" id="5315355">Uint64</span><span class="op" id="5315361">,</span>&nbsp;<span class="ident" id="5315363">reflect</span><span class="op" id="5315370">.</span><span class="ident" id="5315371">Uintptr</span><span class="op" id="5315378">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315382">return</span>&nbsp;<span class="ident" id="5315389">v</span><span class="op" id="5315390">.</span><span class="ident" id="5315391">Uint</span><span class="op" id="5315395">(</span><span class="op" id="5315396">)</span>&nbsp;<span class="op" id="5315398">==</span>&nbsp;<span class="num" id="5315401">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315404">case</span>&nbsp;<span class="ident" id="5315409">reflect</span><span class="op" id="5315416">.</span><span class="ident" id="5315417">Float32</span><span class="op" id="5315424">,</span>&nbsp;<span class="ident" id="5315426">reflect</span><span class="op" id="5315433">.</span><span class="ident" id="5315434">Float64</span><span class="op" id="5315441">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315445">return</span>&nbsp;<span class="ident" id="5315452">v</span><span class="op" id="5315453">.</span><span class="ident" id="5315454">Float</span><span class="op" id="5315459">(</span><span class="op" id="5315460">)</span>&nbsp;<span class="op" id="5315462">==</span>&nbsp;<span class="num" id="5315465">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315468">case</span>&nbsp;<span class="ident" id="5315473">reflect</span><span class="op" id="5315480">.</span><span class="ident" id="5315481">Interface</span><span class="op" id="5315490">,</span>&nbsp;<span class="ident" id="5315492">reflect</span><span class="op" id="5315499">.</span><span class="ident" id="5315500">Ptr</span><span class="op" id="5315503">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315507">return</span>&nbsp;<span class="ident" id="5315514">v</span><span class="op" id="5315515">.</span><span class="ident" id="5315516">IsNil</span><span class="op" id="5315521">(</span><span class="op" id="5315522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5315525">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315528">return</span>&nbsp;<span class="builtintype" id="5315535">false</span><br>
<span class="lineno"></span><span class="op" id="5315541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5315544">func</span>&nbsp;<span class="op" id="5315549">(</span><span class="ident" id="5315550">e</span>&nbsp;<span class="op" id="5315552">*</span><span class="ident" id="5315553">encodeState</span><span class="op" id="5315564">)</span>&nbsp;<span class="ident" id="5315566">reflectValue</span><span class="op" id="5315578">(</span><span class="ident" id="5315579">v</span>&nbsp;<span class="ident" id="5315581">reflect</span><span class="op" id="5315588">.</span><span class="ident" id="5315589">Value</span><span class="op" id="5315594">)</span>&nbsp;<span class="op" id="5315596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315599">valueEncoder</span><span class="op" id="5315611">(</span><span class="ident" id="5315612">v</span><span class="op" id="5315613">)</span><span class="op" id="5315614">(</span><span class="ident" id="5315615">e</span><span class="op" id="5315616">,</span>&nbsp;<span class="ident" id="5315618">v</span><span class="op" id="5315619">,</span>&nbsp;<span class="builtintype" id="5315621">false</span><span class="op" id="5315626">)</span><br>
<span class="lineno">300</span><span class="op" id="5315628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5315631">type</span>&nbsp;<span class="ident" id="5315636">encoderFunc</span>&nbsp;<span class="keyword" id="5315648">func</span><span class="op" id="5315652">(</span><span class="ident" id="5315653">e</span>&nbsp;<span class="op" id="5315655">*</span><span class="ident" id="5315656">encodeState</span><span class="op" id="5315667">,</span>&nbsp;<span class="ident" id="5315669">v</span>&nbsp;<span class="ident" id="5315671">reflect</span><span class="op" id="5315678">.</span><span class="ident" id="5315679">Value</span><span class="op" id="5315684">,</span>&nbsp;<span class="ident" id="5315686">quoted</span>&nbsp;<span class="builtintype" id="5315693">bool</span><span class="op" id="5315697">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5315700">var</span>&nbsp;<span class="ident" id="5315704">encoderCache</span>&nbsp;<span class="keyword" id="5315717">struct</span>&nbsp;<span class="op" id="5315724">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315727">sync</span><span class="op" id="5315731">.</span><span class="ident" id="5315732">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315741">m</span>&nbsp;<span class="keyword" id="5315743">map</span><span class="op" id="5315746">[</span><span class="ident" id="5315747">reflect</span><span class="op" id="5315754">.</span><span class="ident" id="5315755">Type</span><span class="op" id="5315759">]</span><span class="ident" id="5315760">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5315772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5315775">func</span>&nbsp;<span class="ident" id="5315780">valueEncoder</span><span class="op" id="5315792">(</span><span class="ident" id="5315793">v</span>&nbsp;<span class="ident" id="5315795">reflect</span><span class="op" id="5315802">.</span><span class="ident" id="5315803">Value</span><span class="op" id="5315808">)</span>&nbsp;<span class="ident" id="5315810">encoderFunc</span>&nbsp;<span class="op" id="5315822">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315825">if</span>&nbsp;<span class="op" id="5315828">!</span><span class="ident" id="5315829">v</span><span class="op" id="5315830">.</span><span class="ident" id="5315831">IsValid</span><span class="op" id="5315838">(</span><span class="op" id="5315839">)</span>&nbsp;<span class="op" id="5315841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315845">return</span>&nbsp;<span class="ident" id="5315852">invalidValueEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5315873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315876">return</span>&nbsp;<span class="ident" id="5315883">typeEncoder</span><span class="op" id="5315894">(</span><span class="ident" id="5315895">v</span><span class="op" id="5315896">.</span><span class="ident" id="5315897">Type</span><span class="op" id="5315901">(</span><span class="op" id="5315902">)</span><span class="op" id="5315903">)</span><br>
<span class="lineno"></span><span class="op" id="5315905">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="5315908">func</span>&nbsp;<span class="ident" id="5315913">typeEncoder</span><span class="op" id="5315924">(</span><span class="ident" id="5315925">t</span>&nbsp;<span class="ident" id="5315927">reflect</span><span class="op" id="5315934">.</span><span class="ident" id="5315935">Type</span><span class="op" id="5315939">)</span>&nbsp;<span class="ident" id="5315941">encoderFunc</span>&nbsp;<span class="op" id="5315953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315956">encoderCache</span><span class="op" id="5315968">.</span><span class="ident" id="5315969">RLock</span><span class="op" id="5315974">(</span><span class="op" id="5315975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315978">f</span>&nbsp;<span class="op" id="5315980">:=</span>&nbsp;<span class="ident" id="5315983">encoderCache</span><span class="op" id="5315995">.</span><span class="ident" id="5315996">m</span><span class="op" id="5315997">[</span><span class="ident" id="5315998">t</span><span class="op" id="5315999">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316002">encoderCache</span><span class="op" id="5316014">.</span><span class="ident" id="5316015">RUnlock</span><span class="op" id="5316022">(</span><span class="op" id="5316023">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316026">if</span>&nbsp;<span class="ident" id="5316029">f</span>&nbsp;<span class="op" id="5316031">!=</span>&nbsp;<span class="ident" id="5316034">nil</span>&nbsp;<span class="op" id="5316038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316042">return</span>&nbsp;<span class="ident" id="5316049">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5316052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5316056">//&nbsp;To&nbsp;deal&nbsp;with&nbsp;recursive&nbsp;types,&nbsp;populate&nbsp;the&nbsp;map&nbsp;with&nbsp;an</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5316115">//&nbsp;indirect&nbsp;func&nbsp;before&nbsp;we&nbsp;build&nbsp;it.&nbsp;This&nbsp;type&nbsp;waits&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5316176">//&nbsp;real&nbsp;func&nbsp;(f)&nbsp;to&nbsp;be&nbsp;ready&nbsp;and&nbsp;then&nbsp;calls&nbsp;it.&nbsp;&nbsp;This&nbsp;indirect</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5316240">//&nbsp;func&nbsp;is&nbsp;only&nbsp;used&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316283">encoderCache</span><span class="op" id="5316295">.</span><span class="ident" id="5316296">Lock</span><span class="op" id="5316300">(</span><span class="op" id="5316301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316304">if</span>&nbsp;<span class="ident" id="5316307">encoderCache</span><span class="op" id="5316319">.</span><span class="ident" id="5316320">m</span>&nbsp;<span class="op" id="5316322">==</span>&nbsp;<span class="ident" id="5316325">nil</span>&nbsp;<span class="op" id="5316329">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316333">encoderCache</span><span class="op" id="5316345">.</span><span class="ident" id="5316346">m</span>&nbsp;<span class="op" id="5316348">=</span>&nbsp;<span class="builtinfunc" id="5316350">make</span><span class="op" id="5316354">(</span><span class="keyword" id="5316355">map</span><span class="op" id="5316358">[</span><span class="ident" id="5316359">reflect</span><span class="op" id="5316366">.</span><span class="ident" id="5316367">Type</span><span class="op" id="5316371">]</span><span class="ident" id="5316372">encoderFunc</span><span class="op" id="5316383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5316386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316389">var</span>&nbsp;<span class="ident" id="5316393">wg</span>&nbsp;<span class="ident" id="5316396">sync</span><span class="op" id="5316400">.</span><span class="ident" id="5316401">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316412">wg</span><span class="op" id="5316414">.</span><span class="ident" id="5316415">Add</span><span class="op" id="5316418">(</span><span class="num" id="5316419">1</span><span class="op" id="5316420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316423">encoderCache</span><span class="op" id="5316435">.</span><span class="ident" id="5316436">m</span><span class="op" id="5316437">[</span><span class="ident" id="5316438">t</span><span class="op" id="5316439">]</span>&nbsp;<span class="op" id="5316441">=</span>&nbsp;<span class="keyword" id="5316443">func</span><span class="op" id="5316447">(</span><span class="ident" id="5316448">e</span>&nbsp;<span class="op" id="5316450">*</span><span class="ident" id="5316451">encodeState</span><span class="op" id="5316462">,</span>&nbsp;<span class="ident" id="5316464">v</span>&nbsp;<span class="ident" id="5316466">reflect</span><span class="op" id="5316473">.</span><span class="ident" id="5316474">Value</span><span class="op" id="5316479">,</span>&nbsp;<span class="ident" id="5316481">quoted</span>&nbsp;<span class="builtintype" id="5316488">bool</span><span class="op" id="5316492">)</span>&nbsp;<span class="op" id="5316494">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316498">wg</span><span class="op" id="5316500">.</span><span class="ident" id="5316501">Wait</span><span class="op" id="5316505">(</span><span class="op" id="5316506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316510">f</span><span class="op" id="5316511">(</span><span class="ident" id="5316512">e</span><span class="op" id="5316513">,</span>&nbsp;<span class="ident" id="5316515">v</span><span class="op" id="5316516">,</span>&nbsp;<span class="ident" id="5316518">quoted</span><span class="op" id="5316524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5316527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316530">encoderCache</span><span class="op" id="5316542">.</span><span class="ident" id="5316543">Unlock</span><span class="op" id="5316549">(</span><span class="op" id="5316550">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5316554">//&nbsp;Compute&nbsp;fields&nbsp;without&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5316587">//&nbsp;Might&nbsp;duplicate&nbsp;effort&nbsp;but&nbsp;won&#39;t&nbsp;hold&nbsp;other&nbsp;computations&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316654">f</span>&nbsp;<span class="op" id="5316656">=</span>&nbsp;<span class="ident" id="5316658">newTypeEncoder</span><span class="op" id="5316672">(</span><span class="ident" id="5316673">t</span><span class="op" id="5316674">,</span>&nbsp;<span class="builtintype" id="5316676">true</span><span class="op" id="5316680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316683">wg</span><span class="op" id="5316685">.</span><span class="ident" id="5316686">Done</span><span class="op" id="5316690">(</span><span class="op" id="5316691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316694">encoderCache</span><span class="op" id="5316706">.</span><span class="ident" id="5316707">Lock</span><span class="op" id="5316711">(</span><span class="op" id="5316712">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316715">encoderCache</span><span class="op" id="5316727">.</span><span class="ident" id="5316728">m</span><span class="op" id="5316729">[</span><span class="ident" id="5316730">t</span><span class="op" id="5316731">]</span>&nbsp;<span class="op" id="5316733">=</span>&nbsp;<span class="ident" id="5316735">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316738">encoderCache</span><span class="op" id="5316750">.</span><span class="ident" id="5316751">Unlock</span><span class="op" id="5316757">(</span><span class="op" id="5316758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316761">return</span>&nbsp;<span class="ident" id="5316768">f</span><br>
<span class="lineno"></span><span class="op" id="5316770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="5316773">var</span>&nbsp;<span class="op" id="5316777">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316780">marshalerType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5316798">=</span>&nbsp;<span class="ident" id="5316800">reflect</span><span class="op" id="5316807">.</span><span class="ident" id="5316808">TypeOf</span><span class="op" id="5316814">(</span><span class="builtinfunc" id="5316815">new</span><span class="op" id="5316818">(</span><span class="ident" id="5316819">Marshaler</span><span class="op" id="5316828">)</span><span class="op" id="5316829">)</span><span class="op" id="5316830">.</span><span class="ident" id="5316831">Elem</span><span class="op" id="5316835">(</span><span class="op" id="5316836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316839">textMarshalerType</span>&nbsp;<span class="op" id="5316857">=</span>&nbsp;<span class="ident" id="5316859">reflect</span><span class="op" id="5316866">.</span><span class="ident" id="5316867">TypeOf</span><span class="op" id="5316873">(</span><span class="builtinfunc" id="5316874">new</span><span class="op" id="5316877">(</span><span class="ident" id="5316878">encoding</span><span class="op" id="5316886">.</span><span class="ident" id="5316887">TextMarshaler</span><span class="op" id="5316900">)</span><span class="op" id="5316901">)</span><span class="op" id="5316902">.</span><span class="ident" id="5316903">Elem</span><span class="op" id="5316907">(</span><span class="op" id="5316908">)</span><br>
<span class="lineno"></span><span class="op" id="5316910">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="5316913">//&nbsp;newTypeEncoder&nbsp;constructs&nbsp;an&nbsp;encoderFunc&nbsp;for&nbsp;a&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="5316969">//&nbsp;The&nbsp;returned&nbsp;encoder&nbsp;only&nbsp;checks&nbsp;CanAddr&nbsp;when&nbsp;allowAddr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="5317037">func</span>&nbsp;<span class="ident" id="5317042">newTypeEncoder</span><span class="op" id="5317056">(</span><span class="ident" id="5317057">t</span>&nbsp;<span class="ident" id="5317059">reflect</span><span class="op" id="5317066">.</span><span class="ident" id="5317067">Type</span><span class="op" id="5317071">,</span>&nbsp;<span class="ident" id="5317073">allowAddr</span>&nbsp;<span class="builtintype" id="5317083">bool</span><span class="op" id="5317087">)</span>&nbsp;<span class="ident" id="5317089">encoderFunc</span>&nbsp;<span class="op" id="5317101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317104">if</span>&nbsp;<span class="ident" id="5317107">t</span><span class="op" id="5317108">.</span><span class="ident" id="5317109">Implements</span><span class="op" id="5317119">(</span><span class="ident" id="5317120">marshalerType</span><span class="op" id="5317133">)</span>&nbsp;<span class="op" id="5317135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317139">return</span>&nbsp;<span class="ident" id="5317146">marshalerEncoder</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5317164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317167">if</span>&nbsp;<span class="ident" id="5317170">t</span><span class="op" id="5317171">.</span><span class="ident" id="5317172">Kind</span><span class="op" id="5317176">(</span><span class="op" id="5317177">)</span>&nbsp;<span class="op" id="5317179">!=</span>&nbsp;<span class="ident" id="5317182">reflect</span><span class="op" id="5317189">.</span><span class="ident" id="5317190">Ptr</span>&nbsp;<span class="op" id="5317194">&amp;&amp;</span>&nbsp;<span class="ident" id="5317197">allowAddr</span>&nbsp;<span class="op" id="5317207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317211">if</span>&nbsp;<span class="ident" id="5317214">reflect</span><span class="op" id="5317221">.</span><span class="ident" id="5317222">PtrTo</span><span class="op" id="5317227">(</span><span class="ident" id="5317228">t</span><span class="op" id="5317229">)</span><span class="op" id="5317230">.</span><span class="ident" id="5317231">Implements</span><span class="op" id="5317241">(</span><span class="ident" id="5317242">marshalerType</span><span class="op" id="5317255">)</span>&nbsp;<span class="op" id="5317257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317262">return</span>&nbsp;<span class="ident" id="5317269">newCondAddrEncoder</span><span class="op" id="5317287">(</span><span class="ident" id="5317288">addrMarshalerEncoder</span><span class="op" id="5317308">,</span>&nbsp;<span class="ident" id="5317310">newTypeEncoder</span><span class="op" id="5317324">(</span><span class="ident" id="5317325">t</span><span class="op" id="5317326">,</span>&nbsp;<span class="builtintype" id="5317328">false</span><span class="op" id="5317333">)</span><span class="op" id="5317334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5317338">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5317341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317345">if</span>&nbsp;<span class="ident" id="5317348">t</span><span class="op" id="5317349">.</span><span class="ident" id="5317350">Implements</span><span class="op" id="5317360">(</span><span class="ident" id="5317361">textMarshalerType</span><span class="op" id="5317378">)</span>&nbsp;<span class="op" id="5317380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317384">return</span>&nbsp;<span class="ident" id="5317391">textMarshalerEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5317413">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317416">if</span>&nbsp;<span class="ident" id="5317419">t</span><span class="op" id="5317420">.</span><span class="ident" id="5317421">Kind</span><span class="op" id="5317425">(</span><span class="op" id="5317426">)</span>&nbsp;<span class="op" id="5317428">!=</span>&nbsp;<span class="ident" id="5317431">reflect</span><span class="op" id="5317438">.</span><span class="ident" id="5317439">Ptr</span>&nbsp;<span class="op" id="5317443">&amp;&amp;</span>&nbsp;<span class="ident" id="5317446">allowAddr</span>&nbsp;<span class="op" id="5317456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317460">if</span>&nbsp;<span class="ident" id="5317463">reflect</span><span class="op" id="5317470">.</span><span class="ident" id="5317471">PtrTo</span><span class="op" id="5317476">(</span><span class="ident" id="5317477">t</span><span class="op" id="5317478">)</span><span class="op" id="5317479">.</span><span class="ident" id="5317480">Implements</span><span class="op" id="5317490">(</span><span class="ident" id="5317491">textMarshalerType</span><span class="op" id="5317508">)</span>&nbsp;<span class="op" id="5317510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317515">return</span>&nbsp;<span class="ident" id="5317522">newCondAddrEncoder</span><span class="op" id="5317540">(</span><span class="ident" id="5317541">addrTextMarshalerEncoder</span><span class="op" id="5317565">,</span>&nbsp;<span class="ident" id="5317567">newTypeEncoder</span><span class="op" id="5317581">(</span><span class="ident" id="5317582">t</span><span class="op" id="5317583">,</span>&nbsp;<span class="builtintype" id="5317585">false</span><span class="op" id="5317590">)</span><span class="op" id="5317591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5317595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5317598">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317602">switch</span>&nbsp;<span class="ident" id="5317609">t</span><span class="op" id="5317610">.</span><span class="ident" id="5317611">Kind</span><span class="op" id="5317615">(</span><span class="op" id="5317616">)</span>&nbsp;<span class="op" id="5317618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317621">case</span>&nbsp;<span class="ident" id="5317626">reflect</span><span class="op" id="5317633">.</span><span class="ident" id="5317634">Bool</span><span class="op" id="5317638">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317642">return</span>&nbsp;<span class="ident" id="5317649">boolEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317662">case</span>&nbsp;<span class="ident" id="5317667">reflect</span><span class="op" id="5317674">.</span><span class="ident" id="5317675">Int</span><span class="op" id="5317678">,</span>&nbsp;<span class="ident" id="5317680">reflect</span><span class="op" id="5317687">.</span><span class="ident" id="5317688">Int8</span><span class="op" id="5317692">,</span>&nbsp;<span class="ident" id="5317694">reflect</span><span class="op" id="5317701">.</span><span class="ident" id="5317702">Int16</span><span class="op" id="5317707">,</span>&nbsp;<span class="ident" id="5317709">reflect</span><span class="op" id="5317716">.</span><span class="ident" id="5317717">Int32</span><span class="op" id="5317722">,</span>&nbsp;<span class="ident" id="5317724">reflect</span><span class="op" id="5317731">.</span><span class="ident" id="5317732">Int64</span><span class="op" id="5317737">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317741">return</span>&nbsp;<span class="ident" id="5317748">intEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317760">case</span>&nbsp;<span class="ident" id="5317765">reflect</span><span class="op" id="5317772">.</span><span class="ident" id="5317773">Uint</span><span class="op" id="5317777">,</span>&nbsp;<span class="ident" id="5317779">reflect</span><span class="op" id="5317786">.</span><span class="ident" id="5317787">Uint8</span><span class="op" id="5317792">,</span>&nbsp;<span class="ident" id="5317794">reflect</span><span class="op" id="5317801">.</span><span class="ident" id="5317802">Uint16</span><span class="op" id="5317808">,</span>&nbsp;<span class="ident" id="5317810">reflect</span><span class="op" id="5317817">.</span><span class="ident" id="5317818">Uint32</span><span class="op" id="5317824">,</span>&nbsp;<span class="ident" id="5317826">reflect</span><span class="op" id="5317833">.</span><span class="ident" id="5317834">Uint64</span><span class="op" id="5317840">,</span>&nbsp;<span class="ident" id="5317842">reflect</span><span class="op" id="5317849">.</span><span class="ident" id="5317850">Uintptr</span><span class="op" id="5317857">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317861">return</span>&nbsp;<span class="ident" id="5317868">uintEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317881">case</span>&nbsp;<span class="ident" id="5317886">reflect</span><span class="op" id="5317893">.</span><span class="ident" id="5317894">Float32</span><span class="op" id="5317901">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317905">return</span>&nbsp;<span class="ident" id="5317912">float32Encoder</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317928">case</span>&nbsp;<span class="ident" id="5317933">reflect</span><span class="op" id="5317940">.</span><span class="ident" id="5317941">Float64</span><span class="op" id="5317948">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317952">return</span>&nbsp;<span class="ident" id="5317959">float64Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317975">case</span>&nbsp;<span class="ident" id="5317980">reflect</span><span class="op" id="5317987">.</span><span class="ident" id="5317988">String</span><span class="op" id="5317994">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5317998">return</span>&nbsp;<span class="ident" id="5318005">stringEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318020">case</span>&nbsp;<span class="ident" id="5318025">reflect</span><span class="op" id="5318032">.</span><span class="ident" id="5318033">Interface</span><span class="op" id="5318042">:</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318046">return</span>&nbsp;<span class="ident" id="5318053">interfaceEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318071">case</span>&nbsp;<span class="ident" id="5318076">reflect</span><span class="op" id="5318083">.</span><span class="ident" id="5318084">Struct</span><span class="op" id="5318090">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318094">return</span>&nbsp;<span class="ident" id="5318101">newStructEncoder</span><span class="op" id="5318117">(</span><span class="ident" id="5318118">t</span><span class="op" id="5318119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318122">case</span>&nbsp;<span class="ident" id="5318127">reflect</span><span class="op" id="5318134">.</span><span class="ident" id="5318135">Map</span><span class="op" id="5318138">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318142">return</span>&nbsp;<span class="ident" id="5318149">newMapEncoder</span><span class="op" id="5318162">(</span><span class="ident" id="5318163">t</span><span class="op" id="5318164">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318167">case</span>&nbsp;<span class="ident" id="5318172">reflect</span><span class="op" id="5318179">.</span><span class="ident" id="5318180">Slice</span><span class="op" id="5318185">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318189">return</span>&nbsp;<span class="ident" id="5318196">newSliceEncoder</span><span class="op" id="5318211">(</span><span class="ident" id="5318212">t</span><span class="op" id="5318213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318216">case</span>&nbsp;<span class="ident" id="5318221">reflect</span><span class="op" id="5318228">.</span><span class="ident" id="5318229">Array</span><span class="op" id="5318234">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318238">return</span>&nbsp;<span class="ident" id="5318245">newArrayEncoder</span><span class="op" id="5318260">(</span><span class="ident" id="5318261">t</span><span class="op" id="5318262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318265">case</span>&nbsp;<span class="ident" id="5318270">reflect</span><span class="op" id="5318277">.</span><span class="ident" id="5318278">Ptr</span><span class="op" id="5318281">:</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318285">return</span>&nbsp;<span class="ident" id="5318292">newPtrEncoder</span><span class="op" id="5318305">(</span><span class="ident" id="5318306">t</span><span class="op" id="5318307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318310">default</span><span class="op" id="5318317">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318321">return</span>&nbsp;<span class="ident" id="5318328">unsupportedTypeEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5318352">}</span><br>
<span class="lineno"></span><span class="op" id="5318354">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span><span class="keyword" id="5318357">func</span>&nbsp;<span class="ident" id="5318362">invalidValueEncoder</span><span class="op" id="5318381">(</span><span class="ident" id="5318382">e</span>&nbsp;<span class="op" id="5318384">*</span><span class="ident" id="5318385">encodeState</span><span class="op" id="5318396">,</span>&nbsp;<span class="ident" id="5318398">v</span>&nbsp;<span class="ident" id="5318400">reflect</span><span class="op" id="5318407">.</span><span class="ident" id="5318408">Value</span><span class="op" id="5318413">,</span>&nbsp;<span class="ident" id="5318415">quoted</span>&nbsp;<span class="builtintype" id="5318422">bool</span><span class="op" id="5318426">)</span>&nbsp;<span class="op" id="5318428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5318431">e</span><span class="op" id="5318432">.</span><span class="ident" id="5318433">WriteString</span><span class="op" id="5318444">(</span><span class="string" id="5318445">&#34;null&#34;</span><span class="op" id="5318451">)</span><br>
<span class="lineno"></span><span class="op" id="5318453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="keyword" id="5318456">func</span>&nbsp;<span class="ident" id="5318461">marshalerEncoder</span><span class="op" id="5318477">(</span><span class="ident" id="5318478">e</span>&nbsp;<span class="op" id="5318480">*</span><span class="ident" id="5318481">encodeState</span><span class="op" id="5318492">,</span>&nbsp;<span class="ident" id="5318494">v</span>&nbsp;<span class="ident" id="5318496">reflect</span><span class="op" id="5318503">.</span><span class="ident" id="5318504">Value</span><span class="op" id="5318509">,</span>&nbsp;<span class="ident" id="5318511">quoted</span>&nbsp;<span class="builtintype" id="5318518">bool</span><span class="op" id="5318522">)</span>&nbsp;<span class="op" id="5318524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318527">if</span>&nbsp;<span class="ident" id="5318530">v</span><span class="op" id="5318531">.</span><span class="ident" id="5318532">Kind</span><span class="op" id="5318536">(</span><span class="op" id="5318537">)</span>&nbsp;<span class="op" id="5318539">==</span>&nbsp;<span class="ident" id="5318542">reflect</span><span class="op" id="5318549">.</span><span class="ident" id="5318550">Ptr</span>&nbsp;<span class="op" id="5318554">&amp;&amp;</span>&nbsp;<span class="ident" id="5318557">v</span><span class="op" id="5318558">.</span><span class="ident" id="5318559">IsNil</span><span class="op" id="5318564">(</span><span class="op" id="5318565">)</span>&nbsp;<span class="op" id="5318567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5318571">e</span><span class="op" id="5318572">.</span><span class="ident" id="5318573">WriteString</span><span class="op" id="5318584">(</span><span class="string" id="5318585">&#34;null&#34;</span><span class="op" id="5318591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318595">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5318603">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5318606">m</span>&nbsp;<span class="op" id="5318608">:=</span>&nbsp;<span class="ident" id="5318611">v</span><span class="op" id="5318612">.</span><span class="ident" id="5318613">Interface</span><span class="op" id="5318622">(</span><span class="op" id="5318623">)</span><span class="op" id="5318624">.</span><span class="op" id="5318625">(</span><span class="ident" id="5318626">Marshaler</span><span class="op" id="5318635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5318638">b</span><span class="op" id="5318639">,</span>&nbsp;<span class="ident" id="5318641">err</span>&nbsp;<span class="op" id="5318645">:=</span>&nbsp;<span class="ident" id="5318648">m</span><span class="op" id="5318649">.</span><span class="ident" id="5318650">MarshalJSON</span><span class="op" id="5318661">(</span><span class="op" id="5318662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318665">if</span>&nbsp;<span class="ident" id="5318668">err</span>&nbsp;<span class="op" id="5318672">==</span>&nbsp;<span class="ident" id="5318675">nil</span>&nbsp;<span class="op" id="5318679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5318683">//&nbsp;copy&nbsp;JSON&nbsp;into&nbsp;buffer,&nbsp;checking&nbsp;validity.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5318730">err</span>&nbsp;<span class="op" id="5318734">=</span>&nbsp;<span class="ident" id="5318736">compact</span><span class="op" id="5318743">(</span><span class="op" id="5318744">&amp;</span><span class="ident" id="5318745">e</span><span class="op" id="5318746">.</span><span class="ident" id="5318747">Buffer</span><span class="op" id="5318753">,</span>&nbsp;<span class="ident" id="5318755">b</span><span class="op" id="5318756">,</span>&nbsp;<span class="builtintype" id="5318758">true</span><span class="op" id="5318762">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5318765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318768">if</span>&nbsp;<span class="ident" id="5318771">err</span>&nbsp;<span class="op" id="5318775">!=</span>&nbsp;<span class="ident" id="5318778">nil</span>&nbsp;<span class="op" id="5318782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5318786">e</span><span class="op" id="5318787">.</span><span class="builtintype" id="5318788">error</span><span class="op" id="5318793">(</span><span class="op" id="5318794">&amp;</span><span class="ident" id="5318795">MarshalerError</span><span class="op" id="5318809">{</span><span class="ident" id="5318810">v</span><span class="op" id="5318811">.</span><span class="ident" id="5318812">Type</span><span class="op" id="5318816">(</span><span class="op" id="5318817">)</span><span class="op" id="5318818">,</span>&nbsp;<span class="ident" id="5318820">err</span><span class="op" id="5318823">}</span><span class="op" id="5318824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5318827">}</span><br>
<span class="lineno"></span><span class="op" id="5318829">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="5318832">func</span>&nbsp;<span class="ident" id="5318837">addrMarshalerEncoder</span><span class="op" id="5318857">(</span><span class="ident" id="5318858">e</span>&nbsp;<span class="op" id="5318860">*</span><span class="ident" id="5318861">encodeState</span><span class="op" id="5318872">,</span>&nbsp;<span class="ident" id="5318874">v</span>&nbsp;<span class="ident" id="5318876">reflect</span><span class="op" id="5318883">.</span><span class="ident" id="5318884">Value</span><span class="op" id="5318889">,</span>&nbsp;<span class="ident" id="5318891">quoted</span>&nbsp;<span class="builtintype" id="5318898">bool</span><span class="op" id="5318902">)</span>&nbsp;<span class="op" id="5318904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5318907">va</span>&nbsp;<span class="op" id="5318910">:=</span>&nbsp;<span class="ident" id="5318913">v</span><span class="op" id="5318914">.</span><span class="ident" id="5318915">Addr</span><span class="op" id="5318919">(</span><span class="op" id="5318920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318923">if</span>&nbsp;<span class="ident" id="5318926">va</span><span class="op" id="5318928">.</span><span class="ident" id="5318929">IsNil</span><span class="op" id="5318934">(</span><span class="op" id="5318935">)</span>&nbsp;<span class="op" id="5318937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5318941">e</span><span class="op" id="5318942">.</span><span class="ident" id="5318943">WriteString</span><span class="op" id="5318954">(</span><span class="string" id="5318955">&#34;null&#34;</span><span class="op" id="5318961">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5318965">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5318973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5318976">m</span>&nbsp;<span class="op" id="5318978">:=</span>&nbsp;<span class="ident" id="5318981">va</span><span class="op" id="5318983">.</span><span class="ident" id="5318984">Interface</span><span class="op" id="5318993">(</span><span class="op" id="5318994">)</span><span class="op" id="5318995">.</span><span class="op" id="5318996">(</span><span class="ident" id="5318997">Marshaler</span><span class="op" id="5319006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319009">b</span><span class="op" id="5319010">,</span>&nbsp;<span class="ident" id="5319012">err</span>&nbsp;<span class="op" id="5319016">:=</span>&nbsp;<span class="ident" id="5319019">m</span><span class="op" id="5319020">.</span><span class="ident" id="5319021">MarshalJSON</span><span class="op" id="5319032">(</span><span class="op" id="5319033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5319036">if</span>&nbsp;<span class="ident" id="5319039">err</span>&nbsp;<span class="op" id="5319043">==</span>&nbsp;<span class="ident" id="5319046">nil</span>&nbsp;<span class="op" id="5319050">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5319054">//&nbsp;copy&nbsp;JSON&nbsp;into&nbsp;buffer,&nbsp;checking&nbsp;validity.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319101">err</span>&nbsp;<span class="op" id="5319105">=</span>&nbsp;<span class="ident" id="5319107">compact</span><span class="op" id="5319114">(</span><span class="op" id="5319115">&amp;</span><span class="ident" id="5319116">e</span><span class="op" id="5319117">.</span><span class="ident" id="5319118">Buffer</span><span class="op" id="5319124">,</span>&nbsp;<span class="ident" id="5319126">b</span><span class="op" id="5319127">,</span>&nbsp;<span class="builtintype" id="5319129">true</span><span class="op" id="5319133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5319136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5319139">if</span>&nbsp;<span class="ident" id="5319142">err</span>&nbsp;<span class="op" id="5319146">!=</span>&nbsp;<span class="ident" id="5319149">nil</span>&nbsp;<span class="op" id="5319153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319157">e</span><span class="op" id="5319158">.</span><span class="builtintype" id="5319159">error</span><span class="op" id="5319164">(</span><span class="op" id="5319165">&amp;</span><span class="ident" id="5319166">MarshalerError</span><span class="op" id="5319180">{</span><span class="ident" id="5319181">v</span><span class="op" id="5319182">.</span><span class="ident" id="5319183">Type</span><span class="op" id="5319187">(</span><span class="op" id="5319188">)</span><span class="op" id="5319189">,</span>&nbsp;<span class="ident" id="5319191">err</span><span class="op" id="5319194">}</span><span class="op" id="5319195">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5319198">}</span><br>
<span class="lineno"></span><span class="op" id="5319200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5319203">func</span>&nbsp;<span class="ident" id="5319208">textMarshalerEncoder</span><span class="op" id="5319228">(</span><span class="ident" id="5319229">e</span>&nbsp;<span class="op" id="5319231">*</span><span class="ident" id="5319232">encodeState</span><span class="op" id="5319243">,</span>&nbsp;<span class="ident" id="5319245">v</span>&nbsp;<span class="ident" id="5319247">reflect</span><span class="op" id="5319254">.</span><span class="ident" id="5319255">Value</span><span class="op" id="5319260">,</span>&nbsp;<span class="ident" id="5319262">quoted</span>&nbsp;<span class="builtintype" id="5319269">bool</span><span class="op" id="5319273">)</span>&nbsp;<span class="op" id="5319275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5319278">if</span>&nbsp;<span class="ident" id="5319281">v</span><span class="op" id="5319282">.</span><span class="ident" id="5319283">Kind</span><span class="op" id="5319287">(</span><span class="op" id="5319288">)</span>&nbsp;<span class="op" id="5319290">==</span>&nbsp;<span class="ident" id="5319293">reflect</span><span class="op" id="5319300">.</span><span class="ident" id="5319301">Ptr</span>&nbsp;<span class="op" id="5319305">&amp;&amp;</span>&nbsp;<span class="ident" id="5319308">v</span><span class="op" id="5319309">.</span><span class="ident" id="5319310">IsNil</span><span class="op" id="5319315">(</span><span class="op" id="5319316">)</span>&nbsp;<span class="op" id="5319318">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319322">e</span><span class="op" id="5319323">.</span><span class="ident" id="5319324">WriteString</span><span class="op" id="5319335">(</span><span class="string" id="5319336">&#34;null&#34;</span><span class="op" id="5319342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5319346">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5319354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319357">m</span>&nbsp;<span class="op" id="5319359">:=</span>&nbsp;<span class="ident" id="5319362">v</span><span class="op" id="5319363">.</span><span class="ident" id="5319364">Interface</span><span class="op" id="5319373">(</span><span class="op" id="5319374">)</span><span class="op" id="5319375">.</span><span class="op" id="5319376">(</span><span class="ident" id="5319377">encoding</span><span class="op" id="5319385">.</span><span class="ident" id="5319386">TextMarshaler</span><span class="op" id="5319399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319402">b</span><span class="op" id="5319403">,</span>&nbsp;<span class="ident" id="5319405">err</span>&nbsp;<span class="op" id="5319409">:=</span>&nbsp;<span class="ident" id="5319412">m</span><span class="op" id="5319413">.</span><span class="ident" id="5319414">MarshalText</span><span class="op" id="5319425">(</span><span class="op" id="5319426">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5319429">if</span>&nbsp;<span class="ident" id="5319432">err</span>&nbsp;<span class="op" id="5319436">==</span>&nbsp;<span class="ident" id="5319439">nil</span>&nbsp;<span class="op" id="5319443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319447">_</span><span class="op" id="5319448">,</span>&nbsp;<span class="ident" id="5319450">err</span>&nbsp;<span class="op" id="5319454">=</span>&nbsp;<span class="ident" id="5319456">e</span><span class="op" id="5319457">.</span><span class="ident" id="5319458">stringBytes</span><span class="op" id="5319469">(</span><span class="ident" id="5319470">b</span><span class="op" id="5319471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5319474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5319477">if</span>&nbsp;<span class="ident" id="5319480">err</span>&nbsp;<span class="op" id="5319484">!=</span>&nbsp;<span class="ident" id="5319487">nil</span>&nbsp;<span class="op" id="5319491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319495">e</span><span class="op" id="5319496">.</span><span class="builtintype" id="5319497">error</span><span class="op" id="5319502">(</span><span class="op" id="5319503">&amp;</span><span class="ident" id="5319504">MarshalerError</span><span class="op" id="5319518">{</span><span class="ident" id="5319519">v</span><span class="op" id="5319520">.</span><span class="ident" id="5319521">Type</span><span class="op" id="5319525">(</span><span class="op" id="5319526">)</span><span class="op" id="5319527">,</span>&nbsp;<span class="ident" id="5319529">err</span><span class="op" id="5319532">}</span><span class="op" id="5319533">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5319536">}</span><br>
<span class="lineno"></span><span class="op" id="5319538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5319541">func</span>&nbsp;<span class="ident" id="5319546">addrTextMarshalerEncoder</span><span class="op" id="5319570">(</span><span class="ident" id="5319571">e</span>&nbsp;<span class="op" id="5319573">*</span><span class="ident" id="5319574">encodeState</span><span class="op" id="5319585">,</span>&nbsp;<span class="ident" id="5319587">v</span>&nbsp;<span class="ident" id="5319589">reflect</span><span class="op" id="5319596">.</span><span class="ident" id="5319597">Value</span><span class="op" id="5319602">,</span>&nbsp;<span class="ident" id="5319604">quoted</span>&nbsp;<span class="builtintype" id="5319611">bool</span><span class="op" id="5319615">)</span>&nbsp;<span class="op" id="5319617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319620">va</span>&nbsp;<span class="op" id="5319623">:=</span>&nbsp;<span class="ident" id="5319626">v</span><span class="op" id="5319627">.</span><span class="ident" id="5319628">Addr</span><span class="op" id="5319632">(</span><span class="op" id="5319633">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5319636">if</span>&nbsp;<span class="ident" id="5319639">va</span><span class="op" id="5319641">.</span><span class="ident" id="5319642">IsNil</span><span class="op" id="5319647">(</span><span class="op" id="5319648">)</span>&nbsp;<span class="op" id="5319650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319654">e</span><span class="op" id="5319655">.</span><span class="ident" id="5319656">WriteString</span><span class="op" id="5319667">(</span><span class="string" id="5319668">&#34;null&#34;</span><span class="op" id="5319674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5319678">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5319686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319689">m</span>&nbsp;<span class="op" id="5319691">:=</span>&nbsp;<span class="ident" id="5319694">va</span><span class="op" id="5319696">.</span><span class="ident" id="5319697">Interface</span><span class="op" id="5319706">(</span><span class="op" id="5319707">)</span><span class="op" id="5319708">.</span><span class="op" id="5319709">(</span><span class="ident" id="5319710">encoding</span><span class="op" id="5319718">.</span><span class="ident" id="5319719">TextMarshaler</span><span class="op" id="5319732">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319735">b</span><span class="op" id="5319736">,</span>&nbsp;<span class="ident" id="5319738">err</span>&nbsp;<span class="op" id="5319742">:=</span>&nbsp;<span class="ident" id="5319745">m</span><span class="op" id="5319746">.</span><span class="ident" id="5319747">MarshalText</span><span class="op" id="5319758">(</span><span class="op" id="5319759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5319762">if</span>&nbsp;<span class="ident" id="5319765">err</span>&nbsp;<span class="op" id="5319769">==</span>&nbsp;<span class="ident" id="5319772">nil</span>&nbsp;<span class="op" id="5319776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319780">_</span><span class="op" id="5319781">,</span>&nbsp;<span class="ident" id="5319783">err</span>&nbsp;<span class="op" id="5319787">=</span>&nbsp;<span class="ident" id="5319789">e</span><span class="op" id="5319790">.</span><span class="ident" id="5319791">stringBytes</span><span class="op" id="5319802">(</span><span class="ident" id="5319803">b</span><span class="op" id="5319804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5319807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5319810">if</span>&nbsp;<span class="ident" id="5319813">err</span>&nbsp;<span class="op" id="5319817">!=</span>&nbsp;<span class="ident" id="5319820">nil</span>&nbsp;<span class="op" id="5319824">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319828">e</span><span class="op" id="5319829">.</span><span class="builtintype" id="5319830">error</span><span class="op" id="5319835">(</span><span class="op" id="5319836">&amp;</span><span class="ident" id="5319837">MarshalerError</span><span class="op" id="5319851">{</span><span class="ident" id="5319852">v</span><span class="op" id="5319853">.</span><span class="ident" id="5319854">Type</span><span class="op" id="5319858">(</span><span class="op" id="5319859">)</span><span class="op" id="5319860">,</span>&nbsp;<span class="ident" id="5319862">err</span><span class="op" id="5319865">}</span><span class="op" id="5319866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5319869">}</span><br>
<span class="lineno"></span><span class="op" id="5319871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5319874">func</span>&nbsp;<span class="ident" id="5319879">boolEncoder</span><span class="op" id="5319890">(</span><span class="ident" id="5319891">e</span>&nbsp;<span class="op" id="5319893">*</span><span class="ident" id="5319894">encodeState</span><span class="op" id="5319905">,</span>&nbsp;<span class="ident" id="5319907">v</span>&nbsp;<span class="ident" id="5319909">reflect</span><span class="op" id="5319916">.</span><span class="ident" id="5319917">Value</span><span class="op" id="5319922">,</span>&nbsp;<span class="ident" id="5319924">quoted</span>&nbsp;<span class="builtintype" id="5319931">bool</span><span class="op" id="5319935">)</span>&nbsp;<span class="op" id="5319937">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5319940">if</span>&nbsp;<span class="ident" id="5319943">quoted</span>&nbsp;<span class="op" id="5319950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319954">e</span><span class="op" id="5319955">.</span><span class="ident" id="5319956">WriteByte</span><span class="op" id="5319965">(</span><span class="string" id="5319966">&#39;&#34;&#39;</span><span class="op" id="5319969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5319972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5319975">if</span>&nbsp;<span class="ident" id="5319978">v</span><span class="op" id="5319979">.</span><span class="ident" id="5319980">Bool</span><span class="op" id="5319984">(</span><span class="op" id="5319985">)</span>&nbsp;<span class="op" id="5319987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5319991">e</span><span class="op" id="5319992">.</span><span class="ident" id="5319993">WriteString</span><span class="op" id="5320004">(</span><span class="string" id="5320005">&#34;true&#34;</span><span class="op" id="5320011">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5320014">}</span>&nbsp;<span class="keyword" id="5320016">else</span>&nbsp;<span class="op" id="5320021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320025">e</span><span class="op" id="5320026">.</span><span class="ident" id="5320027">WriteString</span><span class="op" id="5320038">(</span><span class="string" id="5320039">&#34;false&#34;</span><span class="op" id="5320046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5320049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5320052">if</span>&nbsp;<span class="ident" id="5320055">quoted</span>&nbsp;<span class="op" id="5320062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320066">e</span><span class="op" id="5320067">.</span><span class="ident" id="5320068">WriteByte</span><span class="op" id="5320077">(</span><span class="string" id="5320078">&#39;&#34;&#39;</span><span class="op" id="5320081">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5320084">}</span><br>
<span class="lineno"></span><span class="op" id="5320086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5320089">func</span>&nbsp;<span class="ident" id="5320094">intEncoder</span><span class="op" id="5320104">(</span><span class="ident" id="5320105">e</span>&nbsp;<span class="op" id="5320107">*</span><span class="ident" id="5320108">encodeState</span><span class="op" id="5320119">,</span>&nbsp;<span class="ident" id="5320121">v</span>&nbsp;<span class="ident" id="5320123">reflect</span><span class="op" id="5320130">.</span><span class="ident" id="5320131">Value</span><span class="op" id="5320136">,</span>&nbsp;<span class="ident" id="5320138">quoted</span>&nbsp;<span class="builtintype" id="5320145">bool</span><span class="op" id="5320149">)</span>&nbsp;<span class="op" id="5320151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320154">b</span>&nbsp;<span class="op" id="5320156">:=</span>&nbsp;<span class="ident" id="5320159">strconv</span><span class="op" id="5320166">.</span><span class="ident" id="5320167">AppendInt</span><span class="op" id="5320176">(</span><span class="ident" id="5320177">e</span><span class="op" id="5320178">.</span><span class="ident" id="5320179">scratch</span><span class="op" id="5320186">[</span><span class="op" id="5320187">:</span><span class="num" id="5320188">0</span><span class="op" id="5320189">]</span><span class="op" id="5320190">,</span>&nbsp;<span class="ident" id="5320192">v</span><span class="op" id="5320193">.</span><span class="ident" id="5320194">Int</span><span class="op" id="5320197">(</span><span class="op" id="5320198">)</span><span class="op" id="5320199">,</span>&nbsp;<span class="num" id="5320201">10</span><span class="op" id="5320203">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5320206">if</span>&nbsp;<span class="ident" id="5320209">quoted</span>&nbsp;<span class="op" id="5320216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320220">e</span><span class="op" id="5320221">.</span><span class="ident" id="5320222">WriteByte</span><span class="op" id="5320231">(</span><span class="string" id="5320232">&#39;&#34;&#39;</span><span class="op" id="5320235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5320238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320241">e</span><span class="op" id="5320242">.</span><span class="ident" id="5320243">Write</span><span class="op" id="5320248">(</span><span class="ident" id="5320249">b</span><span class="op" id="5320250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5320253">if</span>&nbsp;<span class="ident" id="5320256">quoted</span>&nbsp;<span class="op" id="5320263">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320267">e</span><span class="op" id="5320268">.</span><span class="ident" id="5320269">WriteByte</span><span class="op" id="5320278">(</span><span class="string" id="5320279">&#39;&#34;&#39;</span><span class="op" id="5320282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5320285">}</span><br>
<span class="lineno"></span><span class="op" id="5320287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5320290">func</span>&nbsp;<span class="ident" id="5320295">uintEncoder</span><span class="op" id="5320306">(</span><span class="ident" id="5320307">e</span>&nbsp;<span class="op" id="5320309">*</span><span class="ident" id="5320310">encodeState</span><span class="op" id="5320321">,</span>&nbsp;<span class="ident" id="5320323">v</span>&nbsp;<span class="ident" id="5320325">reflect</span><span class="op" id="5320332">.</span><span class="ident" id="5320333">Value</span><span class="op" id="5320338">,</span>&nbsp;<span class="ident" id="5320340">quoted</span>&nbsp;<span class="builtintype" id="5320347">bool</span><span class="op" id="5320351">)</span>&nbsp;<span class="op" id="5320353">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320356">b</span>&nbsp;<span class="op" id="5320358">:=</span>&nbsp;<span class="ident" id="5320361">strconv</span><span class="op" id="5320368">.</span><span class="ident" id="5320369">AppendUint</span><span class="op" id="5320379">(</span><span class="ident" id="5320380">e</span><span class="op" id="5320381">.</span><span class="ident" id="5320382">scratch</span><span class="op" id="5320389">[</span><span class="op" id="5320390">:</span><span class="num" id="5320391">0</span><span class="op" id="5320392">]</span><span class="op" id="5320393">,</span>&nbsp;<span class="ident" id="5320395">v</span><span class="op" id="5320396">.</span><span class="ident" id="5320397">Uint</span><span class="op" id="5320401">(</span><span class="op" id="5320402">)</span><span class="op" id="5320403">,</span>&nbsp;<span class="num" id="5320405">10</span><span class="op" id="5320407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5320410">if</span>&nbsp;<span class="ident" id="5320413">quoted</span>&nbsp;<span class="op" id="5320420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320424">e</span><span class="op" id="5320425">.</span><span class="ident" id="5320426">WriteByte</span><span class="op" id="5320435">(</span><span class="string" id="5320436">&#39;&#34;&#39;</span><span class="op" id="5320439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5320442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320445">e</span><span class="op" id="5320446">.</span><span class="ident" id="5320447">Write</span><span class="op" id="5320452">(</span><span class="ident" id="5320453">b</span><span class="op" id="5320454">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5320457">if</span>&nbsp;<span class="ident" id="5320460">quoted</span>&nbsp;<span class="op" id="5320467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320471">e</span><span class="op" id="5320472">.</span><span class="ident" id="5320473">WriteByte</span><span class="op" id="5320482">(</span><span class="string" id="5320483">&#39;&#34;&#39;</span><span class="op" id="5320486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5320489">}</span><br>
<span class="lineno"></span><span class="op" id="5320491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="5320494">type</span>&nbsp;<span class="ident" id="5320499">floatEncoder</span>&nbsp;<span class="builtintype" id="5320512">int</span>&nbsp;<span class="comment" id="5320516">//&nbsp;number&nbsp;of&nbsp;bits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5320535">func</span>&nbsp;<span class="op" id="5320540">(</span><span class="ident" id="5320541">bits</span>&nbsp;<span class="ident" id="5320546">floatEncoder</span><span class="op" id="5320558">)</span>&nbsp;<span class="ident" id="5320560">encode</span><span class="op" id="5320566">(</span><span class="ident" id="5320567">e</span>&nbsp;<span class="op" id="5320569">*</span><span class="ident" id="5320570">encodeState</span><span class="op" id="5320581">,</span>&nbsp;<span class="ident" id="5320583">v</span>&nbsp;<span class="ident" id="5320585">reflect</span><span class="op" id="5320592">.</span><span class="ident" id="5320593">Value</span><span class="op" id="5320598">,</span>&nbsp;<span class="ident" id="5320600">quoted</span>&nbsp;<span class="builtintype" id="5320607">bool</span><span class="op" id="5320611">)</span>&nbsp;<span class="op" id="5320613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320616">f</span>&nbsp;<span class="op" id="5320618">:=</span>&nbsp;<span class="ident" id="5320621">v</span><span class="op" id="5320622">.</span><span class="ident" id="5320623">Float</span><span class="op" id="5320628">(</span><span class="op" id="5320629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5320632">if</span>&nbsp;<span class="ident" id="5320635">math</span><span class="op" id="5320639">.</span><span class="ident" id="5320640">IsInf</span><span class="op" id="5320645">(</span><span class="ident" id="5320646">f</span><span class="op" id="5320647">,</span>&nbsp;<span class="num" id="5320649">0</span><span class="op" id="5320650">)</span>&nbsp;<span class="op" id="5320652">||</span>&nbsp;<span class="ident" id="5320655">math</span><span class="op" id="5320659">.</span><span class="ident" id="5320660">IsNaN</span><span class="op" id="5320665">(</span><span class="ident" id="5320666">f</span><span class="op" id="5320667">)</span>&nbsp;<span class="op" id="5320669">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320673">e</span><span class="op" id="5320674">.</span><span class="builtintype" id="5320675">error</span><span class="op" id="5320680">(</span><span class="op" id="5320681">&amp;</span><span class="ident" id="5320682">UnsupportedValueError</span><span class="op" id="5320703">{</span><span class="ident" id="5320704">v</span><span class="op" id="5320705">,</span>&nbsp;<span class="ident" id="5320707">strconv</span><span class="op" id="5320714">.</span><span class="ident" id="5320715">FormatFloat</span><span class="op" id="5320726">(</span><span class="ident" id="5320727">f</span><span class="op" id="5320728">,</span>&nbsp;<span class="string" id="5320730">&#39;g&#39;</span><span class="op" id="5320733">,</span>&nbsp;<span class="op" id="5320735">-</span><span class="num" id="5320736">1</span><span class="op" id="5320737">,</span>&nbsp;<span class="builtintype" id="5320739">int</span><span class="op" id="5320742">(</span><span class="ident" id="5320743">bits</span><span class="op" id="5320747">)</span><span class="op" id="5320748">)</span><span class="op" id="5320749">}</span><span class="op" id="5320750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5320753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320756">b</span>&nbsp;<span class="op" id="5320758">:=</span>&nbsp;<span class="ident" id="5320761">strconv</span><span class="op" id="5320768">.</span><span class="ident" id="5320769">AppendFloat</span><span class="op" id="5320780">(</span><span class="ident" id="5320781">e</span><span class="op" id="5320782">.</span><span class="ident" id="5320783">scratch</span><span class="op" id="5320790">[</span><span class="op" id="5320791">:</span><span class="num" id="5320792">0</span><span class="op" id="5320793">]</span><span class="op" id="5320794">,</span>&nbsp;<span class="ident" id="5320796">f</span><span class="op" id="5320797">,</span>&nbsp;<span class="string" id="5320799">&#39;g&#39;</span><span class="op" id="5320802">,</span>&nbsp;<span class="op" id="5320804">-</span><span class="num" id="5320805">1</span><span class="op" id="5320806">,</span>&nbsp;<span class="builtintype" id="5320808">int</span><span class="op" id="5320811">(</span><span class="ident" id="5320812">bits</span><span class="op" id="5320816">)</span><span class="op" id="5320817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5320820">if</span>&nbsp;<span class="ident" id="5320823">quoted</span>&nbsp;<span class="op" id="5320830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320834">e</span><span class="op" id="5320835">.</span><span class="ident" id="5320836">WriteByte</span><span class="op" id="5320845">(</span><span class="string" id="5320846">&#39;&#34;&#39;</span><span class="op" id="5320849">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5320852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320855">e</span><span class="op" id="5320856">.</span><span class="ident" id="5320857">Write</span><span class="op" id="5320862">(</span><span class="ident" id="5320863">b</span><span class="op" id="5320864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5320867">if</span>&nbsp;<span class="ident" id="5320870">quoted</span>&nbsp;<span class="op" id="5320877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320881">e</span><span class="op" id="5320882">.</span><span class="ident" id="5320883">WriteByte</span><span class="op" id="5320892">(</span><span class="string" id="5320893">&#39;&#34;&#39;</span><span class="op" id="5320896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5320899">}</span><br>
<span class="lineno">525</span><span class="op" id="5320901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5320904">var</span>&nbsp;<span class="op" id="5320908">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320911">float32Encoder</span>&nbsp;<span class="op" id="5320926">=</span>&nbsp;<span class="op" id="5320928">(</span><span class="ident" id="5320929">floatEncoder</span><span class="op" id="5320941">(</span><span class="num" id="5320942">32</span><span class="op" id="5320944">)</span><span class="op" id="5320945">)</span><span class="op" id="5320946">.</span><span class="ident" id="5320947">encode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5320955">float64Encoder</span>&nbsp;<span class="op" id="5320970">=</span>&nbsp;<span class="op" id="5320972">(</span><span class="ident" id="5320973">floatEncoder</span><span class="op" id="5320985">(</span><span class="num" id="5320986">64</span><span class="op" id="5320988">)</span><span class="op" id="5320989">)</span><span class="op" id="5320990">.</span><span class="ident" id="5320991">encode</span><br>
<span class="lineno">530</span><span class="op" id="5320998">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5321001">func</span>&nbsp;<span class="ident" id="5321006">stringEncoder</span><span class="op" id="5321019">(</span><span class="ident" id="5321020">e</span>&nbsp;<span class="op" id="5321022">*</span><span class="ident" id="5321023">encodeState</span><span class="op" id="5321034">,</span>&nbsp;<span class="ident" id="5321036">v</span>&nbsp;<span class="ident" id="5321038">reflect</span><span class="op" id="5321045">.</span><span class="ident" id="5321046">Value</span><span class="op" id="5321051">,</span>&nbsp;<span class="ident" id="5321053">quoted</span>&nbsp;<span class="builtintype" id="5321060">bool</span><span class="op" id="5321064">)</span>&nbsp;<span class="op" id="5321066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5321069">if</span>&nbsp;<span class="ident" id="5321072">v</span><span class="op" id="5321073">.</span><span class="ident" id="5321074">Type</span><span class="op" id="5321078">(</span><span class="op" id="5321079">)</span>&nbsp;<span class="op" id="5321081">==</span>&nbsp;<span class="ident" id="5321084">numberType</span>&nbsp;<span class="op" id="5321095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321099">numStr</span>&nbsp;<span class="op" id="5321106">:=</span>&nbsp;<span class="ident" id="5321109">v</span><span class="op" id="5321110">.</span><span class="ident" id="5321111">String</span><span class="op" id="5321117">(</span><span class="op" id="5321118">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5321122">if</span>&nbsp;<span class="ident" id="5321125">numStr</span>&nbsp;<span class="op" id="5321132">==</span>&nbsp;<span class="string" id="5321135">&#34;&#34;</span>&nbsp;<span class="op" id="5321138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321143">numStr</span>&nbsp;<span class="op" id="5321150">=</span>&nbsp;<span class="string" id="5321152">&#34;0&#34;</span>&nbsp;<span class="comment" id="5321156">//&nbsp;Number&#39;s&nbsp;zero-val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5321179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321183">e</span><span class="op" id="5321184">.</span><span class="ident" id="5321185">WriteString</span><span class="op" id="5321196">(</span><span class="ident" id="5321197">numStr</span><span class="op" id="5321203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5321207">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5321215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5321218">if</span>&nbsp;<span class="ident" id="5321221">quoted</span>&nbsp;<span class="op" id="5321228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321232">sb</span><span class="op" id="5321234">,</span>&nbsp;<span class="ident" id="5321236">err</span>&nbsp;<span class="op" id="5321240">:=</span>&nbsp;<span class="ident" id="5321243">Marshal</span><span class="op" id="5321250">(</span><span class="ident" id="5321251">v</span><span class="op" id="5321252">.</span><span class="ident" id="5321253">String</span><span class="op" id="5321259">(</span><span class="op" id="5321260">)</span><span class="op" id="5321261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5321265">if</span>&nbsp;<span class="ident" id="5321268">err</span>&nbsp;<span class="op" id="5321272">!=</span>&nbsp;<span class="ident" id="5321275">nil</span>&nbsp;<span class="op" id="5321279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321284">e</span><span class="op" id="5321285">.</span><span class="builtintype" id="5321286">error</span><span class="op" id="5321291">(</span><span class="ident" id="5321292">err</span><span class="op" id="5321295">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5321299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321303">e</span><span class="op" id="5321304">.</span><span class="builtintype" id="5321305">string</span><span class="op" id="5321311">(</span><span class="builtintype" id="5321312">string</span><span class="op" id="5321318">(</span><span class="ident" id="5321319">sb</span><span class="op" id="5321321">)</span><span class="op" id="5321322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5321325">}</span>&nbsp;<span class="keyword" id="5321327">else</span>&nbsp;<span class="op" id="5321332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321336">e</span><span class="op" id="5321337">.</span><span class="builtintype" id="5321338">string</span><span class="op" id="5321344">(</span><span class="ident" id="5321345">v</span><span class="op" id="5321346">.</span><span class="ident" id="5321347">String</span><span class="op" id="5321353">(</span><span class="op" id="5321354">)</span><span class="op" id="5321355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5321358">}</span><br>
<span class="lineno">550</span><span class="op" id="5321360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5321363">func</span>&nbsp;<span class="ident" id="5321368">interfaceEncoder</span><span class="op" id="5321384">(</span><span class="ident" id="5321385">e</span>&nbsp;<span class="op" id="5321387">*</span><span class="ident" id="5321388">encodeState</span><span class="op" id="5321399">,</span>&nbsp;<span class="ident" id="5321401">v</span>&nbsp;<span class="ident" id="5321403">reflect</span><span class="op" id="5321410">.</span><span class="ident" id="5321411">Value</span><span class="op" id="5321416">,</span>&nbsp;<span class="ident" id="5321418">quoted</span>&nbsp;<span class="builtintype" id="5321425">bool</span><span class="op" id="5321429">)</span>&nbsp;<span class="op" id="5321431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5321434">if</span>&nbsp;<span class="ident" id="5321437">v</span><span class="op" id="5321438">.</span><span class="ident" id="5321439">IsNil</span><span class="op" id="5321444">(</span><span class="op" id="5321445">)</span>&nbsp;<span class="op" id="5321447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321451">e</span><span class="op" id="5321452">.</span><span class="ident" id="5321453">WriteString</span><span class="op" id="5321464">(</span><span class="string" id="5321465">&#34;null&#34;</span><span class="op" id="5321471">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5321475">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5321483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321486">e</span><span class="op" id="5321487">.</span><span class="ident" id="5321488">reflectValue</span><span class="op" id="5321500">(</span><span class="ident" id="5321501">v</span><span class="op" id="5321502">.</span><span class="ident" id="5321503">Elem</span><span class="op" id="5321507">(</span><span class="op" id="5321508">)</span><span class="op" id="5321509">)</span><br>
<span class="lineno"></span><span class="op" id="5321511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span><span class="keyword" id="5321514">func</span>&nbsp;<span class="ident" id="5321519">unsupportedTypeEncoder</span><span class="op" id="5321541">(</span><span class="ident" id="5321542">e</span>&nbsp;<span class="op" id="5321544">*</span><span class="ident" id="5321545">encodeState</span><span class="op" id="5321556">,</span>&nbsp;<span class="ident" id="5321558">v</span>&nbsp;<span class="ident" id="5321560">reflect</span><span class="op" id="5321567">.</span><span class="ident" id="5321568">Value</span><span class="op" id="5321573">,</span>&nbsp;<span class="ident" id="5321575">quoted</span>&nbsp;<span class="builtintype" id="5321582">bool</span><span class="op" id="5321586">)</span>&nbsp;<span class="op" id="5321588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321591">e</span><span class="op" id="5321592">.</span><span class="builtintype" id="5321593">error</span><span class="op" id="5321598">(</span><span class="op" id="5321599">&amp;</span><span class="ident" id="5321600">UnsupportedTypeError</span><span class="op" id="5321620">{</span><span class="ident" id="5321621">v</span><span class="op" id="5321622">.</span><span class="ident" id="5321623">Type</span><span class="op" id="5321627">(</span><span class="op" id="5321628">)</span><span class="op" id="5321629">}</span><span class="op" id="5321630">)</span><br>
<span class="lineno"></span><span class="op" id="5321632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5321635">type</span>&nbsp;<span class="ident" id="5321640">structEncoder</span>&nbsp;<span class="keyword" id="5321654">struct</span>&nbsp;<span class="op" id="5321661">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321664">fields</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5321674">[</span><span class="op" id="5321675">]</span><span class="ident" id="5321676">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321683">fieldEncs</span>&nbsp;<span class="op" id="5321693">[</span><span class="op" id="5321694">]</span><span class="ident" id="5321695">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5321707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5321710">func</span>&nbsp;<span class="op" id="5321715">(</span><span class="ident" id="5321716">se</span>&nbsp;<span class="op" id="5321719">*</span><span class="ident" id="5321720">structEncoder</span><span class="op" id="5321733">)</span>&nbsp;<span class="ident" id="5321735">encode</span><span class="op" id="5321741">(</span><span class="ident" id="5321742">e</span>&nbsp;<span class="op" id="5321744">*</span><span class="ident" id="5321745">encodeState</span><span class="op" id="5321756">,</span>&nbsp;<span class="ident" id="5321758">v</span>&nbsp;<span class="ident" id="5321760">reflect</span><span class="op" id="5321767">.</span><span class="ident" id="5321768">Value</span><span class="op" id="5321773">,</span>&nbsp;<span class="ident" id="5321775">quoted</span>&nbsp;<span class="builtintype" id="5321782">bool</span><span class="op" id="5321786">)</span>&nbsp;<span class="op" id="5321788">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321791">e</span><span class="op" id="5321792">.</span><span class="ident" id="5321793">WriteByte</span><span class="op" id="5321802">(</span><span class="string" id="5321803">&#39;{&#39;</span><span class="op" id="5321806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321809">first</span>&nbsp;<span class="op" id="5321815">:=</span>&nbsp;<span class="builtintype" id="5321818">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5321824">for</span>&nbsp;<span class="ident" id="5321828">i</span><span class="op" id="5321829">,</span>&nbsp;<span class="ident" id="5321831">f</span>&nbsp;<span class="op" id="5321833">:=</span>&nbsp;<span class="keyword" id="5321836">range</span>&nbsp;<span class="ident" id="5321842">se</span><span class="op" id="5321844">.</span><span class="ident" id="5321845">fields</span>&nbsp;<span class="op" id="5321852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321856">fv</span>&nbsp;<span class="op" id="5321859">:=</span>&nbsp;<span class="ident" id="5321862">fieldByIndex</span><span class="op" id="5321874">(</span><span class="ident" id="5321875">v</span><span class="op" id="5321876">,</span>&nbsp;<span class="ident" id="5321878">f</span><span class="op" id="5321879">.</span><span class="ident" id="5321880">index</span><span class="op" id="5321885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5321889">if</span>&nbsp;<span class="op" id="5321892">!</span><span class="ident" id="5321893">fv</span><span class="op" id="5321895">.</span><span class="ident" id="5321896">IsValid</span><span class="op" id="5321903">(</span><span class="op" id="5321904">)</span>&nbsp;<span class="op" id="5321906">||</span>&nbsp;<span class="ident" id="5321909">f</span><span class="op" id="5321910">.</span><span class="ident" id="5321911">omitEmpty</span>&nbsp;<span class="op" id="5321921">&amp;&amp;</span>&nbsp;<span class="ident" id="5321924">isEmptyValue</span><span class="op" id="5321936">(</span><span class="ident" id="5321937">fv</span><span class="op" id="5321939">)</span>&nbsp;<span class="op" id="5321941">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5321946">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5321957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5321961">if</span>&nbsp;<span class="ident" id="5321964">first</span>&nbsp;<span class="op" id="5321970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5321975">first</span>&nbsp;<span class="op" id="5321981">=</span>&nbsp;<span class="builtintype" id="5321983">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5321991">}</span>&nbsp;<span class="keyword" id="5321993">else</span>&nbsp;<span class="op" id="5321998">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322003">e</span><span class="op" id="5322004">.</span><span class="ident" id="5322005">WriteByte</span><span class="op" id="5322014">(</span><span class="string" id="5322015">&#39;,&#39;</span><span class="op" id="5322018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5322022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322026">e</span><span class="op" id="5322027">.</span><span class="builtintype" id="5322028">string</span><span class="op" id="5322034">(</span><span class="ident" id="5322035">f</span><span class="op" id="5322036">.</span><span class="ident" id="5322037">name</span><span class="op" id="5322041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322045">e</span><span class="op" id="5322046">.</span><span class="ident" id="5322047">WriteByte</span><span class="op" id="5322056">(</span><span class="string" id="5322057">&#39;:&#39;</span><span class="op" id="5322060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322064">se</span><span class="op" id="5322066">.</span><span class="ident" id="5322067">fieldEncs</span><span class="op" id="5322076">[</span><span class="ident" id="5322077">i</span><span class="op" id="5322078">]</span><span class="op" id="5322079">(</span><span class="ident" id="5322080">e</span><span class="op" id="5322081">,</span>&nbsp;<span class="ident" id="5322083">fv</span><span class="op" id="5322085">,</span>&nbsp;<span class="ident" id="5322087">f</span><span class="op" id="5322088">.</span><span class="ident" id="5322089">quoted</span><span class="op" id="5322095">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5322098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322101">e</span><span class="op" id="5322102">.</span><span class="ident" id="5322103">WriteByte</span><span class="op" id="5322112">(</span><span class="string" id="5322113">&#39;}&#39;</span><span class="op" id="5322116">)</span><br>
<span class="lineno"></span><span class="op" id="5322118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5322121">func</span>&nbsp;<span class="ident" id="5322126">newStructEncoder</span><span class="op" id="5322142">(</span><span class="ident" id="5322143">t</span>&nbsp;<span class="ident" id="5322145">reflect</span><span class="op" id="5322152">.</span><span class="ident" id="5322153">Type</span><span class="op" id="5322157">)</span>&nbsp;<span class="ident" id="5322159">encoderFunc</span>&nbsp;<span class="op" id="5322171">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322174">fields</span>&nbsp;<span class="op" id="5322181">:=</span>&nbsp;<span class="ident" id="5322184">cachedTypeFields</span><span class="op" id="5322200">(</span><span class="ident" id="5322201">t</span><span class="op" id="5322202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322205">se</span>&nbsp;<span class="op" id="5322208">:=</span>&nbsp;<span class="op" id="5322211">&amp;</span><span class="ident" id="5322212">structEncoder</span><span class="op" id="5322225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322229">fields</span><span class="op" id="5322235">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5322240">fields</span><span class="op" id="5322246">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322250">fieldEncs</span><span class="op" id="5322259">:</span>&nbsp;<span class="builtinfunc" id="5322261">make</span><span class="op" id="5322265">(</span><span class="op" id="5322266">[</span><span class="op" id="5322267">]</span><span class="ident" id="5322268">encoderFunc</span><span class="op" id="5322279">,</span>&nbsp;<span class="builtinfunc" id="5322281">len</span><span class="op" id="5322284">(</span><span class="ident" id="5322285">fields</span><span class="op" id="5322291">)</span><span class="op" id="5322292">)</span><span class="op" id="5322293">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5322296">}</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5322299">for</span>&nbsp;<span class="ident" id="5322303">i</span><span class="op" id="5322304">,</span>&nbsp;<span class="ident" id="5322306">f</span>&nbsp;<span class="op" id="5322308">:=</span>&nbsp;<span class="keyword" id="5322311">range</span>&nbsp;<span class="ident" id="5322317">fields</span>&nbsp;<span class="op" id="5322324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322328">se</span><span class="op" id="5322330">.</span><span class="ident" id="5322331">fieldEncs</span><span class="op" id="5322340">[</span><span class="ident" id="5322341">i</span><span class="op" id="5322342">]</span>&nbsp;<span class="op" id="5322344">=</span>&nbsp;<span class="ident" id="5322346">typeEncoder</span><span class="op" id="5322357">(</span><span class="ident" id="5322358">typeByIndex</span><span class="op" id="5322369">(</span><span class="ident" id="5322370">t</span><span class="op" id="5322371">,</span>&nbsp;<span class="ident" id="5322373">f</span><span class="op" id="5322374">.</span><span class="ident" id="5322375">index</span><span class="op" id="5322380">)</span><span class="op" id="5322381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5322384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5322387">return</span>&nbsp;<span class="ident" id="5322394">se</span><span class="op" id="5322396">.</span><span class="ident" id="5322397">encode</span><br>
<span class="lineno"></span><span class="op" id="5322404">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="5322407">type</span>&nbsp;<span class="ident" id="5322412">mapEncoder</span>&nbsp;<span class="keyword" id="5322423">struct</span>&nbsp;<span class="op" id="5322430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322433">elemEnc</span>&nbsp;<span class="ident" id="5322441">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5322453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">605</span><span class="keyword" id="5322456">func</span>&nbsp;<span class="op" id="5322461">(</span><span class="ident" id="5322462">me</span>&nbsp;<span class="op" id="5322465">*</span><span class="ident" id="5322466">mapEncoder</span><span class="op" id="5322476">)</span>&nbsp;<span class="ident" id="5322478">encode</span><span class="op" id="5322484">(</span><span class="ident" id="5322485">e</span>&nbsp;<span class="op" id="5322487">*</span><span class="ident" id="5322488">encodeState</span><span class="op" id="5322499">,</span>&nbsp;<span class="ident" id="5322501">v</span>&nbsp;<span class="ident" id="5322503">reflect</span><span class="op" id="5322510">.</span><span class="ident" id="5322511">Value</span><span class="op" id="5322516">,</span>&nbsp;<span class="ident" id="5322518">_</span>&nbsp;<span class="builtintype" id="5322520">bool</span><span class="op" id="5322524">)</span>&nbsp;<span class="op" id="5322526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5322529">if</span>&nbsp;<span class="ident" id="5322532">v</span><span class="op" id="5322533">.</span><span class="ident" id="5322534">IsNil</span><span class="op" id="5322539">(</span><span class="op" id="5322540">)</span>&nbsp;<span class="op" id="5322542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322546">e</span><span class="op" id="5322547">.</span><span class="ident" id="5322548">WriteString</span><span class="op" id="5322559">(</span><span class="string" id="5322560">&#34;null&#34;</span><span class="op" id="5322566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5322570">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5322578">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322581">e</span><span class="op" id="5322582">.</span><span class="ident" id="5322583">WriteByte</span><span class="op" id="5322592">(</span><span class="string" id="5322593">&#39;{&#39;</span><span class="op" id="5322596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5322599">var</span>&nbsp;<span class="ident" id="5322603">sv</span>&nbsp;<span class="ident" id="5322606">stringValues</span>&nbsp;<span class="op" id="5322619">=</span>&nbsp;<span class="ident" id="5322621">v</span><span class="op" id="5322622">.</span><span class="ident" id="5322623">MapKeys</span><span class="op" id="5322630">(</span><span class="op" id="5322631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322634">sort</span><span class="op" id="5322638">.</span><span class="ident" id="5322639">Sort</span><span class="op" id="5322643">(</span><span class="ident" id="5322644">sv</span><span class="op" id="5322646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5322649">for</span>&nbsp;<span class="ident" id="5322653">i</span><span class="op" id="5322654">,</span>&nbsp;<span class="ident" id="5322656">k</span>&nbsp;<span class="op" id="5322658">:=</span>&nbsp;<span class="keyword" id="5322661">range</span>&nbsp;<span class="ident" id="5322667">sv</span>&nbsp;<span class="op" id="5322670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5322674">if</span>&nbsp;<span class="ident" id="5322677">i</span>&nbsp;<span class="op" id="5322679">&gt;</span>&nbsp;<span class="num" id="5322681">0</span>&nbsp;<span class="op" id="5322683">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322688">e</span><span class="op" id="5322689">.</span><span class="ident" id="5322690">WriteByte</span><span class="op" id="5322699">(</span><span class="string" id="5322700">&#39;,&#39;</span><span class="op" id="5322703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5322707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322711">e</span><span class="op" id="5322712">.</span><span class="builtintype" id="5322713">string</span><span class="op" id="5322719">(</span><span class="ident" id="5322720">k</span><span class="op" id="5322721">.</span><span class="ident" id="5322722">String</span><span class="op" id="5322728">(</span><span class="op" id="5322729">)</span><span class="op" id="5322730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322734">e</span><span class="op" id="5322735">.</span><span class="ident" id="5322736">WriteByte</span><span class="op" id="5322745">(</span><span class="string" id="5322746">&#39;:&#39;</span><span class="op" id="5322749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322753">me</span><span class="op" id="5322755">.</span><span class="ident" id="5322756">elemEnc</span><span class="op" id="5322763">(</span><span class="ident" id="5322764">e</span><span class="op" id="5322765">,</span>&nbsp;<span class="ident" id="5322767">v</span><span class="op" id="5322768">.</span><span class="ident" id="5322769">MapIndex</span><span class="op" id="5322777">(</span><span class="ident" id="5322778">k</span><span class="op" id="5322779">)</span><span class="op" id="5322780">,</span>&nbsp;<span class="builtintype" id="5322782">false</span><span class="op" id="5322787">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5322790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322793">e</span><span class="op" id="5322794">.</span><span class="ident" id="5322795">WriteByte</span><span class="op" id="5322804">(</span><span class="string" id="5322805">&#39;}&#39;</span><span class="op" id="5322808">)</span><br>
<span class="lineno"></span><span class="op" id="5322810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5322813">func</span>&nbsp;<span class="ident" id="5322818">newMapEncoder</span><span class="op" id="5322831">(</span><span class="ident" id="5322832">t</span>&nbsp;<span class="ident" id="5322834">reflect</span><span class="op" id="5322841">.</span><span class="ident" id="5322842">Type</span><span class="op" id="5322846">)</span>&nbsp;<span class="ident" id="5322848">encoderFunc</span>&nbsp;<span class="op" id="5322860">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5322863">if</span>&nbsp;<span class="ident" id="5322866">t</span><span class="op" id="5322867">.</span><span class="ident" id="5322868">Key</span><span class="op" id="5322871">(</span><span class="op" id="5322872">)</span><span class="op" id="5322873">.</span><span class="ident" id="5322874">Kind</span><span class="op" id="5322878">(</span><span class="op" id="5322879">)</span>&nbsp;<span class="op" id="5322881">!=</span>&nbsp;<span class="ident" id="5322884">reflect</span><span class="op" id="5322891">.</span><span class="ident" id="5322892">String</span>&nbsp;<span class="op" id="5322899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5322903">return</span>&nbsp;<span class="ident" id="5322910">unsupportedTypeEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5322934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5322937">me</span>&nbsp;<span class="op" id="5322940">:=</span>&nbsp;<span class="op" id="5322943">&amp;</span><span class="ident" id="5322944">mapEncoder</span><span class="op" id="5322954">{</span><span class="ident" id="5322955">typeEncoder</span><span class="op" id="5322966">(</span><span class="ident" id="5322967">t</span><span class="op" id="5322968">.</span><span class="ident" id="5322969">Elem</span><span class="op" id="5322973">(</span><span class="op" id="5322974">)</span><span class="op" id="5322975">)</span><span class="op" id="5322976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5322979">return</span>&nbsp;<span class="ident" id="5322986">me</span><span class="op" id="5322988">.</span><span class="ident" id="5322989">encode</span><br>
<span class="lineno">630</span><span class="op" id="5322996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5322999">func</span>&nbsp;<span class="ident" id="5323004">encodeByteSlice</span><span class="op" id="5323019">(</span><span class="ident" id="5323020">e</span>&nbsp;<span class="op" id="5323022">*</span><span class="ident" id="5323023">encodeState</span><span class="op" id="5323034">,</span>&nbsp;<span class="ident" id="5323036">v</span>&nbsp;<span class="ident" id="5323038">reflect</span><span class="op" id="5323045">.</span><span class="ident" id="5323046">Value</span><span class="op" id="5323051">,</span>&nbsp;<span class="ident" id="5323053">_</span>&nbsp;<span class="builtintype" id="5323055">bool</span><span class="op" id="5323059">)</span>&nbsp;<span class="op" id="5323061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5323064">if</span>&nbsp;<span class="ident" id="5323067">v</span><span class="op" id="5323068">.</span><span class="ident" id="5323069">IsNil</span><span class="op" id="5323074">(</span><span class="op" id="5323075">)</span>&nbsp;<span class="op" id="5323077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5323081">e</span><span class="op" id="5323082">.</span><span class="ident" id="5323083">WriteString</span><span class="op" id="5323094">(</span><span class="string" id="5323095">&#34;null&#34;</span><span class="op" id="5323101">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5323105">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5323113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5323116">s</span>&nbsp;<span class="op" id="5323118">:=</span>&nbsp;<span class="ident" id="5323121">v</span><span class="op" id="5323122">.</span><span class="ident" id="5323123">Bytes</span><span class="op" id="5323128">(</span><span class="op" id="5323129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5323132">e</span><span class="op" id="5323133">.</span><span class="ident" id="5323134">WriteByte</span><span class="op" id="5323143">(</span><span class="string" id="5323144">&#39;&#34;&#39;</span><span class="op" id="5323147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5323150">if</span>&nbsp;<span class="builtinfunc" id="5323153">len</span><span class="op" id="5323156">(</span><span class="ident" id="5323157">s</span><span class="op" id="5323158">)</span>&nbsp;<span class="op" id="5323160">&lt;</span>&nbsp;<span class="num" id="5323162">1024</span>&nbsp;<span class="op" id="5323167">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5323171">//&nbsp;for&nbsp;small&nbsp;buffers,&nbsp;using&nbsp;Encode&nbsp;directly&nbsp;is&nbsp;much&nbsp;faster.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5323233">dst</span>&nbsp;<span class="op" id="5323237">:=</span>&nbsp;<span class="builtinfunc" id="5323240">make</span><span class="op" id="5323244">(</span><span class="op" id="5323245">[</span><span class="op" id="5323246">]</span><span class="builtintype" id="5323247">byte</span><span class="op" id="5323251">,</span>&nbsp;<span class="ident" id="5323253">base64</span><span class="op" id="5323259">.</span><span class="ident" id="5323260">StdEncoding</span><span class="op" id="5323271">.</span><span class="ident" id="5323272">EncodedLen</span><span class="op" id="5323282">(</span><span class="builtinfunc" id="5323283">len</span><span class="op" id="5323286">(</span><span class="ident" id="5323287">s</span><span class="op" id="5323288">)</span><span class="op" id="5323289">)</span><span class="op" id="5323290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5323294">base64</span><span class="op" id="5323300">.</span><span class="ident" id="5323301">StdEncoding</span><span class="op" id="5323312">.</span><span class="ident" id="5323313">Encode</span><span class="op" id="5323319">(</span><span class="ident" id="5323320">dst</span><span class="op" id="5323323">,</span>&nbsp;<span class="ident" id="5323325">s</span><span class="op" id="5323326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5323330">e</span><span class="op" id="5323331">.</span><span class="ident" id="5323332">Write</span><span class="op" id="5323337">(</span><span class="ident" id="5323338">dst</span><span class="op" id="5323341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5323344">}</span>&nbsp;<span class="keyword" id="5323346">else</span>&nbsp;<span class="op" id="5323351">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5323355">//&nbsp;for&nbsp;large&nbsp;buffers,&nbsp;avoid&nbsp;unnecessary&nbsp;extra&nbsp;temporary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5323413">//&nbsp;buffer&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5323432">enc</span>&nbsp;<span class="op" id="5323436">:=</span>&nbsp;<span class="ident" id="5323439">base64</span><span class="op" id="5323445">.</span><span class="ident" id="5323446">NewEncoder</span><span class="op" id="5323456">(</span><span class="ident" id="5323457">base64</span><span class="op" id="5323463">.</span><span class="ident" id="5323464">StdEncoding</span><span class="op" id="5323475">,</span>&nbsp;<span class="ident" id="5323477">e</span><span class="op" id="5323478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5323482">enc</span><span class="op" id="5323485">.</span><span class="ident" id="5323486">Write</span><span class="op" id="5323491">(</span><span class="ident" id="5323492">s</span><span class="op" id="5323493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5323497">enc</span><span class="op" id="5323500">.</span><span class="ident" id="5323501">Close</span><span class="op" id="5323506">(</span><span class="op" id="5323507">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5323510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5323513">e</span><span class="op" id="5323514">.</span><span class="ident" id="5323515">WriteByte</span><span class="op" id="5323524">(</span><span class="string" id="5323525">&#39;&#34;&#39;</span><span class="op" id="5323528">)</span><br>
<span class="lineno"></span><span class="op" id="5323530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5323533">//&nbsp;sliceEncoder&nbsp;just&nbsp;wraps&nbsp;an&nbsp;arrayEncoder,&nbsp;checking&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;value&nbsp;isn&#39;t&nbsp;nil.</span><br>
<span class="lineno">655</span><span class="keyword" id="5323620">type</span>&nbsp;<span class="ident" id="5323625">sliceEncoder</span>&nbsp;<span class="keyword" id="5323638">struct</span>&nbsp;<span class="op" id="5323645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5323648">arrayEnc</span>&nbsp;<span class="ident" id="5323657">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5323669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5323672">func</span>&nbsp;<span class="op" id="5323677">(</span><span class="ident" id="5323678">se</span>&nbsp;<span class="op" id="5323681">*</span><span class="ident" id="5323682">sliceEncoder</span><span class="op" id="5323694">)</span>&nbsp;<span class="ident" id="5323696">encode</span><span class="op" id="5323702">(</span><span class="ident" id="5323703">e</span>&nbsp;<span class="op" id="5323705">*</span><span class="ident" id="5323706">encodeState</span><span class="op" id="5323717">,</span>&nbsp;<span class="ident" id="5323719">v</span>&nbsp;<span class="ident" id="5323721">reflect</span><span class="op" id="5323728">.</span><span class="ident" id="5323729">Value</span><span class="op" id="5323734">,</span>&nbsp;<span class="ident" id="5323736">_</span>&nbsp;<span class="builtintype" id="5323738">bool</span><span class="op" id="5323742">)</span>&nbsp;<span class="op" id="5323744">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5323747">if</span>&nbsp;<span class="ident" id="5323750">v</span><span class="op" id="5323751">.</span><span class="ident" id="5323752">IsNil</span><span class="op" id="5323757">(</span><span class="op" id="5323758">)</span>&nbsp;<span class="op" id="5323760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5323764">e</span><span class="op" id="5323765">.</span><span class="ident" id="5323766">WriteString</span><span class="op" id="5323777">(</span><span class="string" id="5323778">&#34;null&#34;</span><span class="op" id="5323784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5323788">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5323796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5323799">se</span><span class="op" id="5323801">.</span><span class="ident" id="5323802">arrayEnc</span><span class="op" id="5323810">(</span><span class="ident" id="5323811">e</span><span class="op" id="5323812">,</span>&nbsp;<span class="ident" id="5323814">v</span><span class="op" id="5323815">,</span>&nbsp;<span class="builtintype" id="5323817">false</span><span class="op" id="5323822">)</span><br>
<span class="lineno">665</span><span class="op" id="5323824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5323827">func</span>&nbsp;<span class="ident" id="5323832">newSliceEncoder</span><span class="op" id="5323847">(</span><span class="ident" id="5323848">t</span>&nbsp;<span class="ident" id="5323850">reflect</span><span class="op" id="5323857">.</span><span class="ident" id="5323858">Type</span><span class="op" id="5323862">)</span>&nbsp;<span class="ident" id="5323864">encoderFunc</span>&nbsp;<span class="op" id="5323876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5323879">//&nbsp;Byte&nbsp;slices&nbsp;get&nbsp;special&nbsp;treatment;&nbsp;arrays&nbsp;don&#39;t.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5323932">if</span>&nbsp;<span class="ident" id="5323935">t</span><span class="op" id="5323936">.</span><span class="ident" id="5323937">Elem</span><span class="op" id="5323941">(</span><span class="op" id="5323942">)</span><span class="op" id="5323943">.</span><span class="ident" id="5323944">Kind</span><span class="op" id="5323948">(</span><span class="op" id="5323949">)</span>&nbsp;<span class="op" id="5323951">==</span>&nbsp;<span class="ident" id="5323954">reflect</span><span class="op" id="5323961">.</span><span class="ident" id="5323962">Uint8</span>&nbsp;<span class="op" id="5323968">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5323972">return</span>&nbsp;<span class="ident" id="5323979">encodeByteSlice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5323996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5323999">enc</span>&nbsp;<span class="op" id="5324003">:=</span>&nbsp;<span class="op" id="5324006">&amp;</span><span class="ident" id="5324007">sliceEncoder</span><span class="op" id="5324019">{</span><span class="ident" id="5324020">newArrayEncoder</span><span class="op" id="5324035">(</span><span class="ident" id="5324036">t</span><span class="op" id="5324037">)</span><span class="op" id="5324038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5324041">return</span>&nbsp;<span class="ident" id="5324048">enc</span><span class="op" id="5324051">.</span><span class="ident" id="5324052">encode</span><br>
<span class="lineno"></span><span class="op" id="5324059">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="keyword" id="5324062">type</span>&nbsp;<span class="ident" id="5324067">arrayEncoder</span>&nbsp;<span class="keyword" id="5324080">struct</span>&nbsp;<span class="op" id="5324087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5324090">elemEnc</span>&nbsp;<span class="ident" id="5324098">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5324110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="keyword" id="5324113">func</span>&nbsp;<span class="op" id="5324118">(</span><span class="ident" id="5324119">ae</span>&nbsp;<span class="op" id="5324122">*</span><span class="ident" id="5324123">arrayEncoder</span><span class="op" id="5324135">)</span>&nbsp;<span class="ident" id="5324137">encode</span><span class="op" id="5324143">(</span><span class="ident" id="5324144">e</span>&nbsp;<span class="op" id="5324146">*</span><span class="ident" id="5324147">encodeState</span><span class="op" id="5324158">,</span>&nbsp;<span class="ident" id="5324160">v</span>&nbsp;<span class="ident" id="5324162">reflect</span><span class="op" id="5324169">.</span><span class="ident" id="5324170">Value</span><span class="op" id="5324175">,</span>&nbsp;<span class="ident" id="5324177">_</span>&nbsp;<span class="builtintype" id="5324179">bool</span><span class="op" id="5324183">)</span>&nbsp;<span class="op" id="5324185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5324188">e</span><span class="op" id="5324189">.</span><span class="ident" id="5324190">WriteByte</span><span class="op" id="5324199">(</span><span class="string" id="5324200">&#39;[&#39;</span><span class="op" id="5324203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5324206">n</span>&nbsp;<span class="op" id="5324208">:=</span>&nbsp;<span class="ident" id="5324211">v</span><span class="op" id="5324212">.</span><span class="ident" id="5324213">Len</span><span class="op" id="5324216">(</span><span class="op" id="5324217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5324220">for</span>&nbsp;<span class="ident" id="5324224">i</span>&nbsp;<span class="op" id="5324226">:=</span>&nbsp;<span class="num" id="5324229">0</span><span class="op" id="5324230">;</span>&nbsp;<span class="ident" id="5324232">i</span>&nbsp;<span class="op" id="5324234">&lt;</span>&nbsp;<span class="ident" id="5324236">n</span><span class="op" id="5324237">;</span>&nbsp;<span class="ident" id="5324239">i</span><span class="op" id="5324240">++</span>&nbsp;<span class="op" id="5324243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5324247">if</span>&nbsp;<span class="ident" id="5324250">i</span>&nbsp;<span class="op" id="5324252">&gt;</span>&nbsp;<span class="num" id="5324254">0</span>&nbsp;<span class="op" id="5324256">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5324261">e</span><span class="op" id="5324262">.</span><span class="ident" id="5324263">WriteByte</span><span class="op" id="5324272">(</span><span class="string" id="5324273">&#39;,&#39;</span><span class="op" id="5324276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5324280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5324284">ae</span><span class="op" id="5324286">.</span><span class="ident" id="5324287">elemEnc</span><span class="op" id="5324294">(</span><span class="ident" id="5324295">e</span><span class="op" id="5324296">,</span>&nbsp;<span class="ident" id="5324298">v</span><span class="op" id="5324299">.</span><span class="ident" id="5324300">Index</span><span class="op" id="5324305">(</span><span class="ident" id="5324306">i</span><span class="op" id="5324307">)</span><span class="op" id="5324308">,</span>&nbsp;<span class="builtintype" id="5324310">false</span><span class="op" id="5324315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5324318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5324321">e</span><span class="op" id="5324322">.</span><span class="ident" id="5324323">WriteByte</span><span class="op" id="5324332">(</span><span class="string" id="5324333">&#39;]&#39;</span><span class="op" id="5324336">)</span><br>
<span class="lineno">690</span><span class="op" id="5324338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5324341">func</span>&nbsp;<span class="ident" id="5324346">newArrayEncoder</span><span class="op" id="5324361">(</span><span class="ident" id="5324362">t</span>&nbsp;<span class="ident" id="5324364">reflect</span><span class="op" id="5324371">.</span><span class="ident" id="5324372">Type</span><span class="op" id="5324376">)</span>&nbsp;<span class="ident" id="5324378">encoderFunc</span>&nbsp;<span class="op" id="5324390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5324393">enc</span>&nbsp;<span class="op" id="5324397">:=</span>&nbsp;<span class="op" id="5324400">&amp;</span><span class="ident" id="5324401">arrayEncoder</span><span class="op" id="5324413">{</span><span class="ident" id="5324414">typeEncoder</span><span class="op" id="5324425">(</span><span class="ident" id="5324426">t</span><span class="op" id="5324427">.</span><span class="ident" id="5324428">Elem</span><span class="op" id="5324432">(</span><span class="op" id="5324433">)</span><span class="op" id="5324434">)</span><span class="op" id="5324435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5324438">return</span>&nbsp;<span class="ident" id="5324445">enc</span><span class="op" id="5324448">.</span><span class="ident" id="5324449">encode</span><br>
<span class="lineno">695</span><span class="op" id="5324456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5324459">type</span>&nbsp;<span class="ident" id="5324464">ptrEncoder</span>&nbsp;<span class="keyword" id="5324475">struct</span>&nbsp;<span class="op" id="5324482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5324485">elemEnc</span>&nbsp;<span class="ident" id="5324493">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5324505">}</span><br>
<span class="lineno">700</span><br>
<span class="lineno"></span><span class="keyword" id="5324508">func</span>&nbsp;<span class="op" id="5324513">(</span><span class="ident" id="5324514">pe</span>&nbsp;<span class="op" id="5324517">*</span><span class="ident" id="5324518">ptrEncoder</span><span class="op" id="5324528">)</span>&nbsp;<span class="ident" id="5324530">encode</span><span class="op" id="5324536">(</span><span class="ident" id="5324537">e</span>&nbsp;<span class="op" id="5324539">*</span><span class="ident" id="5324540">encodeState</span><span class="op" id="5324551">,</span>&nbsp;<span class="ident" id="5324553">v</span>&nbsp;<span class="ident" id="5324555">reflect</span><span class="op" id="5324562">.</span><span class="ident" id="5324563">Value</span><span class="op" id="5324568">,</span>&nbsp;<span class="ident" id="5324570">quoted</span>&nbsp;<span class="builtintype" id="5324577">bool</span><span class="op" id="5324581">)</span>&nbsp;<span class="op" id="5324583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5324586">if</span>&nbsp;<span class="ident" id="5324589">v</span><span class="op" id="5324590">.</span><span class="ident" id="5324591">IsNil</span><span class="op" id="5324596">(</span><span class="op" id="5324597">)</span>&nbsp;<span class="op" id="5324599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5324603">e</span><span class="op" id="5324604">.</span><span class="ident" id="5324605">WriteString</span><span class="op" id="5324616">(</span><span class="string" id="5324617">&#34;null&#34;</span><span class="op" id="5324623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5324627">return</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5324635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5324638">pe</span><span class="op" id="5324640">.</span><span class="ident" id="5324641">elemEnc</span><span class="op" id="5324648">(</span><span class="ident" id="5324649">e</span><span class="op" id="5324650">,</span>&nbsp;<span class="ident" id="5324652">v</span><span class="op" id="5324653">.</span><span class="ident" id="5324654">Elem</span><span class="op" id="5324658">(</span><span class="op" id="5324659">)</span><span class="op" id="5324660">,</span>&nbsp;<span class="ident" id="5324662">quoted</span><span class="op" id="5324668">)</span><br>
<span class="lineno"></span><span class="op" id="5324670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5324673">func</span>&nbsp;<span class="ident" id="5324678">newPtrEncoder</span><span class="op" id="5324691">(</span><span class="ident" id="5324692">t</span>&nbsp;<span class="ident" id="5324694">reflect</span><span class="op" id="5324701">.</span><span class="ident" id="5324702">Type</span><span class="op" id="5324706">)</span>&nbsp;<span class="ident" id="5324708">encoderFunc</span>&nbsp;<span class="op" id="5324720">{</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5324723">enc</span>&nbsp;<span class="op" id="5324727">:=</span>&nbsp;<span class="op" id="5324730">&amp;</span><span class="ident" id="5324731">ptrEncoder</span><span class="op" id="5324741">{</span><span class="ident" id="5324742">typeEncoder</span><span class="op" id="5324753">(</span><span class="ident" id="5324754">t</span><span class="op" id="5324755">.</span><span class="ident" id="5324756">Elem</span><span class="op" id="5324760">(</span><span class="op" id="5324761">)</span><span class="op" id="5324762">)</span><span class="op" id="5324763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5324766">return</span>&nbsp;<span class="ident" id="5324773">enc</span><span class="op" id="5324776">.</span><span class="ident" id="5324777">encode</span><br>
<span class="lineno"></span><span class="op" id="5324784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5324787">type</span>&nbsp;<span class="ident" id="5324792">condAddrEncoder</span>&nbsp;<span class="keyword" id="5324808">struct</span>&nbsp;<span class="op" id="5324815">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5324818">canAddrEnc</span><span class="op" id="5324828">,</span>&nbsp;<span class="ident" id="5324830">elseEnc</span>&nbsp;<span class="ident" id="5324838">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5324850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5324853">func</span>&nbsp;<span class="op" id="5324858">(</span><span class="ident" id="5324859">ce</span>&nbsp;<span class="op" id="5324862">*</span><span class="ident" id="5324863">condAddrEncoder</span><span class="op" id="5324878">)</span>&nbsp;<span class="ident" id="5324880">encode</span><span class="op" id="5324886">(</span><span class="ident" id="5324887">e</span>&nbsp;<span class="op" id="5324889">*</span><span class="ident" id="5324890">encodeState</span><span class="op" id="5324901">,</span>&nbsp;<span class="ident" id="5324903">v</span>&nbsp;<span class="ident" id="5324905">reflect</span><span class="op" id="5324912">.</span><span class="ident" id="5324913">Value</span><span class="op" id="5324918">,</span>&nbsp;<span class="ident" id="5324920">quoted</span>&nbsp;<span class="builtintype" id="5324927">bool</span><span class="op" id="5324931">)</span>&nbsp;<span class="op" id="5324933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5324936">if</span>&nbsp;<span class="ident" id="5324939">v</span><span class="op" id="5324940">.</span><span class="ident" id="5324941">CanAddr</span><span class="op" id="5324948">(</span><span class="op" id="5324949">)</span>&nbsp;<span class="op" id="5324951">{</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5324955">ce</span><span class="op" id="5324957">.</span><span class="ident" id="5324958">canAddrEnc</span><span class="op" id="5324968">(</span><span class="ident" id="5324969">e</span><span class="op" id="5324970">,</span>&nbsp;<span class="ident" id="5324972">v</span><span class="op" id="5324973">,</span>&nbsp;<span class="ident" id="5324975">quoted</span><span class="op" id="5324981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5324984">}</span>&nbsp;<span class="keyword" id="5324986">else</span>&nbsp;<span class="op" id="5324991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5324995">ce</span><span class="op" id="5324997">.</span><span class="ident" id="5324998">elseEnc</span><span class="op" id="5325005">(</span><span class="ident" id="5325006">e</span><span class="op" id="5325007">,</span>&nbsp;<span class="ident" id="5325009">v</span><span class="op" id="5325010">,</span>&nbsp;<span class="ident" id="5325012">quoted</span><span class="op" id="5325018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5325021">}</span><br>
<span class="lineno"></span><span class="op" id="5325023">}</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="5325026">//&nbsp;newCondAddrEncoder&nbsp;returns&nbsp;an&nbsp;encoder&nbsp;that&nbsp;checks&nbsp;whether&nbsp;its&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5325097">//&nbsp;CanAddr&nbsp;and&nbsp;delegates&nbsp;to&nbsp;canAddrEnc&nbsp;if&nbsp;so,&nbsp;else&nbsp;to&nbsp;elseEnc.</span><br>
<span class="lineno"></span><span class="keyword" id="5325160">func</span>&nbsp;<span class="ident" id="5325165">newCondAddrEncoder</span><span class="op" id="5325183">(</span><span class="ident" id="5325184">canAddrEnc</span><span class="op" id="5325194">,</span>&nbsp;<span class="ident" id="5325196">elseEnc</span>&nbsp;<span class="ident" id="5325204">encoderFunc</span><span class="op" id="5325215">)</span>&nbsp;<span class="ident" id="5325217">encoderFunc</span>&nbsp;<span class="op" id="5325229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5325232">enc</span>&nbsp;<span class="op" id="5325236">:=</span>&nbsp;<span class="op" id="5325239">&amp;</span><span class="ident" id="5325240">condAddrEncoder</span><span class="op" id="5325255">{</span><span class="ident" id="5325256">canAddrEnc</span><span class="op" id="5325266">:</span>&nbsp;<span class="ident" id="5325268">canAddrEnc</span><span class="op" id="5325278">,</span>&nbsp;<span class="ident" id="5325280">elseEnc</span><span class="op" id="5325287">:</span>&nbsp;<span class="ident" id="5325289">elseEnc</span><span class="op" id="5325296">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325299">return</span>&nbsp;<span class="ident" id="5325306">enc</span><span class="op" id="5325309">.</span><span class="ident" id="5325310">encode</span><br>
<span class="lineno"></span><span class="op" id="5325317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5325320">func</span>&nbsp;<span class="ident" id="5325325">isValidTag</span><span class="op" id="5325335">(</span><span class="ident" id="5325336">s</span>&nbsp;<span class="builtintype" id="5325338">string</span><span class="op" id="5325344">)</span>&nbsp;<span class="builtintype" id="5325346">bool</span>&nbsp;<span class="op" id="5325351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325354">if</span>&nbsp;<span class="ident" id="5325357">s</span>&nbsp;<span class="op" id="5325359">==</span>&nbsp;<span class="string" id="5325362">&#34;&#34;</span>&nbsp;<span class="op" id="5325365">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325369">return</span>&nbsp;<span class="builtintype" id="5325376">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5325383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325386">for</span>&nbsp;<span class="ident" id="5325390">_</span><span class="op" id="5325391">,</span>&nbsp;<span class="ident" id="5325393">c</span>&nbsp;<span class="op" id="5325395">:=</span>&nbsp;<span class="keyword" id="5325398">range</span>&nbsp;<span class="ident" id="5325404">s</span>&nbsp;<span class="op" id="5325406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325410">switch</span>&nbsp;<span class="op" id="5325417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325421">case</span>&nbsp;<span class="ident" id="5325426">strings</span><span class="op" id="5325433">.</span><span class="ident" id="5325434">ContainsRune</span><span class="op" id="5325446">(</span><span class="string" id="5325447">&#34;!#$%&amp;()*+-./:&lt;=&gt;?@[]^_{|}~&nbsp;&#34;</span><span class="op" id="5325476">,</span>&nbsp;<span class="ident" id="5325478">c</span><span class="op" id="5325479">)</span><span class="op" id="5325480">:</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5325485">//&nbsp;Backslash&nbsp;and&nbsp;quote&nbsp;chars&nbsp;are&nbsp;reserved,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5325535">//&nbsp;otherwise&nbsp;any&nbsp;punctuation&nbsp;chars&nbsp;are&nbsp;allowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5325585">//&nbsp;in&nbsp;a&nbsp;tag&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325605">default</span><span class="op" id="5325612">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325617">if</span>&nbsp;<span class="op" id="5325620">!</span><span class="ident" id="5325621">unicode</span><span class="op" id="5325628">.</span><span class="ident" id="5325629">IsLetter</span><span class="op" id="5325637">(</span><span class="ident" id="5325638">c</span><span class="op" id="5325639">)</span>&nbsp;<span class="op" id="5325641">&amp;&amp;</span>&nbsp;<span class="op" id="5325644">!</span><span class="ident" id="5325645">unicode</span><span class="op" id="5325652">.</span><span class="ident" id="5325653">IsDigit</span><span class="op" id="5325660">(</span><span class="ident" id="5325661">c</span><span class="op" id="5325662">)</span>&nbsp;<span class="op" id="5325664">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325670">return</span>&nbsp;<span class="builtintype" id="5325677">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5325686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5325690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5325693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325696">return</span>&nbsp;<span class="builtintype" id="5325703">true</span><br>
<span class="lineno">750</span><span class="op" id="5325708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5325711">func</span>&nbsp;<span class="ident" id="5325716">fieldByIndex</span><span class="op" id="5325728">(</span><span class="ident" id="5325729">v</span>&nbsp;<span class="ident" id="5325731">reflect</span><span class="op" id="5325738">.</span><span class="ident" id="5325739">Value</span><span class="op" id="5325744">,</span>&nbsp;<span class="ident" id="5325746">index</span>&nbsp;<span class="op" id="5325752">[</span><span class="op" id="5325753">]</span><span class="builtintype" id="5325754">int</span><span class="op" id="5325757">)</span>&nbsp;<span class="ident" id="5325759">reflect</span><span class="op" id="5325766">.</span><span class="ident" id="5325767">Value</span>&nbsp;<span class="op" id="5325773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325776">for</span>&nbsp;<span class="ident" id="5325780">_</span><span class="op" id="5325781">,</span>&nbsp;<span class="ident" id="5325783">i</span>&nbsp;<span class="op" id="5325785">:=</span>&nbsp;<span class="keyword" id="5325788">range</span>&nbsp;<span class="ident" id="5325794">index</span>&nbsp;<span class="op" id="5325800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325804">if</span>&nbsp;<span class="ident" id="5325807">v</span><span class="op" id="5325808">.</span><span class="ident" id="5325809">Kind</span><span class="op" id="5325813">(</span><span class="op" id="5325814">)</span>&nbsp;<span class="op" id="5325816">==</span>&nbsp;<span class="ident" id="5325819">reflect</span><span class="op" id="5325826">.</span><span class="ident" id="5325827">Ptr</span>&nbsp;<span class="op" id="5325831">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325836">if</span>&nbsp;<span class="ident" id="5325839">v</span><span class="op" id="5325840">.</span><span class="ident" id="5325841">IsNil</span><span class="op" id="5325846">(</span><span class="op" id="5325847">)</span>&nbsp;<span class="op" id="5325849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325855">return</span>&nbsp;<span class="ident" id="5325862">reflect</span><span class="op" id="5325869">.</span><span class="ident" id="5325870">Value</span><span class="op" id="5325875">{</span><span class="op" id="5325876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5325881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5325886">v</span>&nbsp;<span class="op" id="5325888">=</span>&nbsp;<span class="ident" id="5325890">v</span><span class="op" id="5325891">.</span><span class="ident" id="5325892">Elem</span><span class="op" id="5325896">(</span><span class="op" id="5325897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5325901">}</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5325905">v</span>&nbsp;<span class="op" id="5325907">=</span>&nbsp;<span class="ident" id="5325909">v</span><span class="op" id="5325910">.</span><span class="ident" id="5325911">Field</span><span class="op" id="5325916">(</span><span class="ident" id="5325917">i</span><span class="op" id="5325918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5325921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325924">return</span>&nbsp;<span class="ident" id="5325931">v</span><br>
<span class="lineno"></span><span class="op" id="5325933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="5325936">func</span>&nbsp;<span class="ident" id="5325941">typeByIndex</span><span class="op" id="5325952">(</span><span class="ident" id="5325953">t</span>&nbsp;<span class="ident" id="5325955">reflect</span><span class="op" id="5325962">.</span><span class="ident" id="5325963">Type</span><span class="op" id="5325967">,</span>&nbsp;<span class="ident" id="5325969">index</span>&nbsp;<span class="op" id="5325975">[</span><span class="op" id="5325976">]</span><span class="builtintype" id="5325977">int</span><span class="op" id="5325980">)</span>&nbsp;<span class="ident" id="5325982">reflect</span><span class="op" id="5325989">.</span><span class="ident" id="5325990">Type</span>&nbsp;<span class="op" id="5325995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5325998">for</span>&nbsp;<span class="ident" id="5326002">_</span><span class="op" id="5326003">,</span>&nbsp;<span class="ident" id="5326005">i</span>&nbsp;<span class="op" id="5326007">:=</span>&nbsp;<span class="keyword" id="5326010">range</span>&nbsp;<span class="ident" id="5326016">index</span>&nbsp;<span class="op" id="5326022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5326026">if</span>&nbsp;<span class="ident" id="5326029">t</span><span class="op" id="5326030">.</span><span class="ident" id="5326031">Kind</span><span class="op" id="5326035">(</span><span class="op" id="5326036">)</span>&nbsp;<span class="op" id="5326038">==</span>&nbsp;<span class="ident" id="5326041">reflect</span><span class="op" id="5326048">.</span><span class="ident" id="5326049">Ptr</span>&nbsp;<span class="op" id="5326053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5326058">t</span>&nbsp;<span class="op" id="5326060">=</span>&nbsp;<span class="ident" id="5326062">t</span><span class="op" id="5326063">.</span><span class="ident" id="5326064">Elem</span><span class="op" id="5326068">(</span><span class="op" id="5326069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5326073">}</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5326077">t</span>&nbsp;<span class="op" id="5326079">=</span>&nbsp;<span class="ident" id="5326081">t</span><span class="op" id="5326082">.</span><span class="ident" id="5326083">Field</span><span class="op" id="5326088">(</span><span class="ident" id="5326089">i</span><span class="op" id="5326090">)</span><span class="op" id="5326091">.</span><span class="ident" id="5326092">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5326098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5326101">return</span>&nbsp;<span class="ident" id="5326108">t</span><br>
<span class="lineno"></span><span class="op" id="5326110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">775</span><span class="comment" id="5326113">//&nbsp;stringValues&nbsp;is&nbsp;a&nbsp;slice&nbsp;of&nbsp;reflect.Value&nbsp;holding&nbsp;*reflect.StringValue.</span><br>
<span class="lineno"></span><span class="comment" id="5326187">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;methods&nbsp;to&nbsp;sort&nbsp;by&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="5326235">type</span>&nbsp;<span class="ident" id="5326240">stringValues</span>&nbsp;<span class="op" id="5326253">[</span><span class="op" id="5326254">]</span><span class="ident" id="5326255">reflect</span><span class="op" id="5326262">.</span><span class="ident" id="5326263">Value</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5326270">func</span>&nbsp;<span class="op" id="5326275">(</span><span class="ident" id="5326276">sv</span>&nbsp;<span class="ident" id="5326279">stringValues</span><span class="op" id="5326291">)</span>&nbsp;<span class="ident" id="5326293">Len</span><span class="op" id="5326296">(</span><span class="op" id="5326297">)</span>&nbsp;<span class="builtintype" id="5326299">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5326313">{</span>&nbsp;<span class="keyword" id="5326315">return</span>&nbsp;<span class="builtinfunc" id="5326322">len</span><span class="op" id="5326325">(</span><span class="ident" id="5326326">sv</span><span class="op" id="5326328">)</span>&nbsp;<span class="op" id="5326330">}</span><br>
<span class="lineno">780</span><span class="keyword" id="5326332">func</span>&nbsp;<span class="op" id="5326337">(</span><span class="ident" id="5326338">sv</span>&nbsp;<span class="ident" id="5326341">stringValues</span><span class="op" id="5326353">)</span>&nbsp;<span class="ident" id="5326355">Swap</span><span class="op" id="5326359">(</span><span class="ident" id="5326360">i</span><span class="op" id="5326361">,</span>&nbsp;<span class="ident" id="5326363">j</span>&nbsp;<span class="builtintype" id="5326365">int</span><span class="op" id="5326368">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5326375">{</span>&nbsp;<span class="ident" id="5326377">sv</span><span class="op" id="5326379">[</span><span class="ident" id="5326380">i</span><span class="op" id="5326381">]</span><span class="op" id="5326382">,</span>&nbsp;<span class="ident" id="5326384">sv</span><span class="op" id="5326386">[</span><span class="ident" id="5326387">j</span><span class="op" id="5326388">]</span>&nbsp;<span class="op" id="5326390">=</span>&nbsp;<span class="ident" id="5326392">sv</span><span class="op" id="5326394">[</span><span class="ident" id="5326395">j</span><span class="op" id="5326396">]</span><span class="op" id="5326397">,</span>&nbsp;<span class="ident" id="5326399">sv</span><span class="op" id="5326401">[</span><span class="ident" id="5326402">i</span><span class="op" id="5326403">]</span>&nbsp;<span class="op" id="5326405">}</span><br>
<span class="lineno"></span><span class="keyword" id="5326407">func</span>&nbsp;<span class="op" id="5326412">(</span><span class="ident" id="5326413">sv</span>&nbsp;<span class="ident" id="5326416">stringValues</span><span class="op" id="5326428">)</span>&nbsp;<span class="ident" id="5326430">Less</span><span class="op" id="5326434">(</span><span class="ident" id="5326435">i</span><span class="op" id="5326436">,</span>&nbsp;<span class="ident" id="5326438">j</span>&nbsp;<span class="builtintype" id="5326440">int</span><span class="op" id="5326443">)</span>&nbsp;<span class="builtintype" id="5326445">bool</span>&nbsp;<span class="op" id="5326450">{</span>&nbsp;<span class="keyword" id="5326452">return</span>&nbsp;<span class="ident" id="5326459">sv</span><span class="op" id="5326461">.</span><span class="ident" id="5326462">get</span><span class="op" id="5326465">(</span><span class="ident" id="5326466">i</span><span class="op" id="5326467">)</span>&nbsp;<span class="op" id="5326469">&lt;</span>&nbsp;<span class="ident" id="5326471">sv</span><span class="op" id="5326473">.</span><span class="ident" id="5326474">get</span><span class="op" id="5326477">(</span><span class="ident" id="5326478">j</span><span class="op" id="5326479">)</span>&nbsp;<span class="op" id="5326481">}</span><br>
<span class="lineno"></span><span class="keyword" id="5326483">func</span>&nbsp;<span class="op" id="5326488">(</span><span class="ident" id="5326489">sv</span>&nbsp;<span class="ident" id="5326492">stringValues</span><span class="op" id="5326504">)</span>&nbsp;<span class="ident" id="5326506">get</span><span class="op" id="5326509">(</span><span class="ident" id="5326510">i</span>&nbsp;<span class="builtintype" id="5326512">int</span><span class="op" id="5326515">)</span>&nbsp;<span class="builtintype" id="5326517">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5326526">{</span>&nbsp;<span class="keyword" id="5326528">return</span>&nbsp;<span class="ident" id="5326535">sv</span><span class="op" id="5326537">[</span><span class="ident" id="5326538">i</span><span class="op" id="5326539">]</span><span class="op" id="5326540">.</span><span class="ident" id="5326541">String</span><span class="op" id="5326547">(</span><span class="op" id="5326548">)</span>&nbsp;<span class="op" id="5326550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5326553">//&nbsp;NOTE:&nbsp;keep&nbsp;in&nbsp;sync&nbsp;with&nbsp;stringBytes&nbsp;below.</span><br>
<span class="lineno">785</span><span class="keyword" id="5326599">func</span>&nbsp;<span class="op" id="5326604">(</span><span class="ident" id="5326605">e</span>&nbsp;<span class="op" id="5326607">*</span><span class="ident" id="5326608">encodeState</span><span class="op" id="5326619">)</span>&nbsp;<span class="builtintype" id="5326621">string</span><span class="op" id="5326627">(</span><span class="ident" id="5326628">s</span>&nbsp;<span class="builtintype" id="5326630">string</span><span class="op" id="5326636">)</span>&nbsp;<span class="op" id="5326638">(</span><span class="builtintype" id="5326639">int</span><span class="op" id="5326642">,</span>&nbsp;<span class="builtintype" id="5326644">error</span><span class="op" id="5326649">)</span>&nbsp;<span class="op" id="5326651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5326654">len0</span>&nbsp;<span class="op" id="5326659">:=</span>&nbsp;<span class="ident" id="5326662">e</span><span class="op" id="5326663">.</span><span class="ident" id="5326664">Len</span><span class="op" id="5326667">(</span><span class="op" id="5326668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5326671">e</span><span class="op" id="5326672">.</span><span class="ident" id="5326673">WriteByte</span><span class="op" id="5326682">(</span><span class="string" id="5326683">&#39;&#34;&#39;</span><span class="op" id="5326686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5326689">start</span>&nbsp;<span class="op" id="5326695">:=</span>&nbsp;<span class="num" id="5326698">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5326701">for</span>&nbsp;<span class="ident" id="5326705">i</span>&nbsp;<span class="op" id="5326707">:=</span>&nbsp;<span class="num" id="5326710">0</span><span class="op" id="5326711">;</span>&nbsp;<span class="ident" id="5326713">i</span>&nbsp;<span class="op" id="5326715">&lt;</span>&nbsp;<span class="builtinfunc" id="5326717">len</span><span class="op" id="5326720">(</span><span class="ident" id="5326721">s</span><span class="op" id="5326722">)</span><span class="op" id="5326723">;</span>&nbsp;<span class="op" id="5326725">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5326729">if</span>&nbsp;<span class="ident" id="5326732">b</span>&nbsp;<span class="op" id="5326734">:=</span>&nbsp;<span class="ident" id="5326737">s</span><span class="op" id="5326738">[</span><span class="ident" id="5326739">i</span><span class="op" id="5326740">]</span><span class="op" id="5326741">;</span>&nbsp;<span class="ident" id="5326743">b</span>&nbsp;<span class="op" id="5326745">&lt;</span>&nbsp;<span class="ident" id="5326747">utf8</span><span class="op" id="5326751">.</span><span class="ident" id="5326752">RuneSelf</span>&nbsp;<span class="op" id="5326761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5326766">if</span>&nbsp;<span class="num" id="5326769">0x20</span>&nbsp;<span class="op" id="5326774">&lt;=</span>&nbsp;<span class="ident" id="5326777">b</span>&nbsp;<span class="op" id="5326779">&amp;&amp;</span>&nbsp;<span class="ident" id="5326782">b</span>&nbsp;<span class="op" id="5326784">!=</span>&nbsp;<span class="string" id="5326787">&#39;\\&#39;</span>&nbsp;<span class="op" id="5326792">&amp;&amp;</span>&nbsp;<span class="ident" id="5326795">b</span>&nbsp;<span class="op" id="5326797">!=</span>&nbsp;<span class="string" id="5326800">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5326804">&amp;&amp;</span>&nbsp;<span class="ident" id="5326807">b</span>&nbsp;<span class="op" id="5326809">!=</span>&nbsp;<span class="string" id="5326812">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5326816">&amp;&amp;</span>&nbsp;<span class="ident" id="5326819">b</span>&nbsp;<span class="op" id="5326821">!=</span>&nbsp;<span class="string" id="5326824">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="5326828">&amp;&amp;</span>&nbsp;<span class="ident" id="5326831">b</span>&nbsp;<span class="op" id="5326833">!=</span>&nbsp;<span class="string" id="5326836">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="5326840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5326846">i</span><span class="op" id="5326847">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5326854">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5326866">}</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5326871">if</span>&nbsp;<span class="ident" id="5326874">start</span>&nbsp;<span class="op" id="5326880">&lt;</span>&nbsp;<span class="ident" id="5326882">i</span>&nbsp;<span class="op" id="5326884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5326890">e</span><span class="op" id="5326891">.</span><span class="ident" id="5326892">WriteString</span><span class="op" id="5326903">(</span><span class="ident" id="5326904">s</span><span class="op" id="5326905">[</span><span class="ident" id="5326906">start</span><span class="op" id="5326911">:</span><span class="ident" id="5326912">i</span><span class="op" id="5326913">]</span><span class="op" id="5326914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5326919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5326924">switch</span>&nbsp;<span class="ident" id="5326931">b</span>&nbsp;<span class="op" id="5326933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5326938">case</span>&nbsp;<span class="string" id="5326943">&#39;\\&#39;</span><span class="op" id="5326947">,</span>&nbsp;<span class="string" id="5326949">&#39;&#34;&#39;</span><span class="op" id="5326952">:</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5326958">e</span><span class="op" id="5326959">.</span><span class="ident" id="5326960">WriteByte</span><span class="op" id="5326969">(</span><span class="string" id="5326970">&#39;\\&#39;</span><span class="op" id="5326974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5326980">e</span><span class="op" id="5326981">.</span><span class="ident" id="5326982">WriteByte</span><span class="op" id="5326991">(</span><span class="ident" id="5326992">b</span><span class="op" id="5326993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5326998">case</span>&nbsp;<span class="string" id="5327003">&#39;\n&#39;</span><span class="op" id="5327007">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327013">e</span><span class="op" id="5327014">.</span><span class="ident" id="5327015">WriteByte</span><span class="op" id="5327024">(</span><span class="string" id="5327025">&#39;\\&#39;</span><span class="op" id="5327029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327035">e</span><span class="op" id="5327036">.</span><span class="ident" id="5327037">WriteByte</span><span class="op" id="5327046">(</span><span class="string" id="5327047">&#39;n&#39;</span><span class="op" id="5327050">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5327055">case</span>&nbsp;<span class="string" id="5327060">&#39;\r&#39;</span><span class="op" id="5327064">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327070">e</span><span class="op" id="5327071">.</span><span class="ident" id="5327072">WriteByte</span><span class="op" id="5327081">(</span><span class="string" id="5327082">&#39;\\&#39;</span><span class="op" id="5327086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327092">e</span><span class="op" id="5327093">.</span><span class="ident" id="5327094">WriteByte</span><span class="op" id="5327103">(</span><span class="string" id="5327104">&#39;r&#39;</span><span class="op" id="5327107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5327112">case</span>&nbsp;<span class="string" id="5327117">&#39;\t&#39;</span><span class="op" id="5327121">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327127">e</span><span class="op" id="5327128">.</span><span class="ident" id="5327129">WriteByte</span><span class="op" id="5327138">(</span><span class="string" id="5327139">&#39;\\&#39;</span><span class="op" id="5327143">)</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327149">e</span><span class="op" id="5327150">.</span><span class="ident" id="5327151">WriteByte</span><span class="op" id="5327160">(</span><span class="string" id="5327161">&#39;t&#39;</span><span class="op" id="5327164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5327169">default</span><span class="op" id="5327176">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5327182">//&nbsp;This&nbsp;encodes&nbsp;bytes&nbsp;&lt;&nbsp;0x20&nbsp;except&nbsp;for&nbsp;\n&nbsp;and&nbsp;\r,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5327237">//&nbsp;as&nbsp;well&nbsp;as&nbsp;&lt;,&nbsp;&gt;&nbsp;and&nbsp;&amp;.&nbsp;The&nbsp;latter&nbsp;are&nbsp;escaped&nbsp;because&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5327303">//&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;when&nbsp;user-controlled&nbsp;strings</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5327366">//&nbsp;are&nbsp;rendered&nbsp;into&nbsp;JSON&nbsp;and&nbsp;served&nbsp;to&nbsp;some&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327425">e</span><span class="op" id="5327426">.</span><span class="ident" id="5327427">WriteString</span><span class="op" id="5327438">(</span><span class="string" id="5327439">`\u00`</span><span class="op" id="5327445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327451">e</span><span class="op" id="5327452">.</span><span class="ident" id="5327453">WriteByte</span><span class="op" id="5327462">(</span><span class="ident" id="5327463">hex</span><span class="op" id="5327466">[</span><span class="ident" id="5327467">b</span><span class="op" id="5327468">&gt;&gt;</span><span class="num" id="5327470">4</span><span class="op" id="5327471">]</span><span class="op" id="5327472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327478">e</span><span class="op" id="5327479">.</span><span class="ident" id="5327480">WriteByte</span><span class="op" id="5327489">(</span><span class="ident" id="5327490">hex</span><span class="op" id="5327493">[</span><span class="ident" id="5327494">b</span><span class="op" id="5327495">&amp;</span><span class="num" id="5327496">0xF</span><span class="op" id="5327499">]</span><span class="op" id="5327500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5327505">}</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327510">i</span><span class="op" id="5327511">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327517">start</span>&nbsp;<span class="op" id="5327523">=</span>&nbsp;<span class="ident" id="5327525">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5327530">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5327541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327545">c</span><span class="op" id="5327546">,</span>&nbsp;<span class="ident" id="5327548">size</span>&nbsp;<span class="op" id="5327553">:=</span>&nbsp;<span class="ident" id="5327556">utf8</span><span class="op" id="5327560">.</span><span class="ident" id="5327561">DecodeRuneInString</span><span class="op" id="5327579">(</span><span class="ident" id="5327580">s</span><span class="op" id="5327581">[</span><span class="ident" id="5327582">i</span><span class="op" id="5327583">:</span><span class="op" id="5327584">]</span><span class="op" id="5327585">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5327589">if</span>&nbsp;<span class="ident" id="5327592">c</span>&nbsp;<span class="op" id="5327594">==</span>&nbsp;<span class="ident" id="5327597">utf8</span><span class="op" id="5327601">.</span><span class="ident" id="5327602">RuneError</span>&nbsp;<span class="op" id="5327612">&amp;&amp;</span>&nbsp;<span class="ident" id="5327615">size</span>&nbsp;<span class="op" id="5327620">==</span>&nbsp;<span class="num" id="5327623">1</span>&nbsp;<span class="op" id="5327625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5327630">if</span>&nbsp;<span class="ident" id="5327633">start</span>&nbsp;<span class="op" id="5327639">&lt;</span>&nbsp;<span class="ident" id="5327641">i</span>&nbsp;<span class="op" id="5327643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327649">e</span><span class="op" id="5327650">.</span><span class="ident" id="5327651">WriteString</span><span class="op" id="5327662">(</span><span class="ident" id="5327663">s</span><span class="op" id="5327664">[</span><span class="ident" id="5327665">start</span><span class="op" id="5327670">:</span><span class="ident" id="5327671">i</span><span class="op" id="5327672">]</span><span class="op" id="5327673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5327678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327683">e</span><span class="op" id="5327684">.</span><span class="ident" id="5327685">WriteString</span><span class="op" id="5327696">(</span><span class="string" id="5327697">`\ufffd`</span><span class="op" id="5327705">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327710">i</span>&nbsp;<span class="op" id="5327712">+=</span>&nbsp;<span class="ident" id="5327715">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5327723">start</span>&nbsp;<span class="op" id="5327729">=</span>&nbsp;<span class="ident" id="5327731">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5327736">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5327747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5327751">//&nbsp;U+2028&nbsp;is&nbsp;LINE&nbsp;SEPARATOR.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5327782">//&nbsp;U+2029&nbsp;is&nbsp;PARAGRAPH&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5327818">//&nbsp;They&nbsp;are&nbsp;both&nbsp;technically&nbsp;valid&nbsp;characters&nbsp;in&nbsp;JSON&nbsp;strings,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5327883">//&nbsp;but&nbsp;don&#39;t&nbsp;work&nbsp;in&nbsp;JSONP,&nbsp;which&nbsp;has&nbsp;to&nbsp;be&nbsp;evaluated&nbsp;as&nbsp;JavaScript,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5327954">//&nbsp;and&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;there.&nbsp;It&nbsp;is&nbsp;valid&nbsp;JSON&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5328017">//&nbsp;escape&nbsp;them,&nbsp;so&nbsp;we&nbsp;do&nbsp;so&nbsp;unconditionally.</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5328064">//&nbsp;See&nbsp;http://timelessrepo.com/json-isnt-a-javascript-subset&nbsp;for&nbsp;discussion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5328143">if</span>&nbsp;<span class="ident" id="5328146">c</span>&nbsp;<span class="op" id="5328148">==</span>&nbsp;<span class="string" id="5328151">&#39;\u2028&#39;</span>&nbsp;<span class="op" id="5328160">||</span>&nbsp;<span class="ident" id="5328163">c</span>&nbsp;<span class="op" id="5328165">==</span>&nbsp;<span class="string" id="5328168">&#39;\u2029&#39;</span>&nbsp;<span class="op" id="5328177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5328182">if</span>&nbsp;<span class="ident" id="5328185">start</span>&nbsp;<span class="op" id="5328191">&lt;</span>&nbsp;<span class="ident" id="5328193">i</span>&nbsp;<span class="op" id="5328195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328201">e</span><span class="op" id="5328202">.</span><span class="ident" id="5328203">WriteString</span><span class="op" id="5328214">(</span><span class="ident" id="5328215">s</span><span class="op" id="5328216">[</span><span class="ident" id="5328217">start</span><span class="op" id="5328222">:</span><span class="ident" id="5328223">i</span><span class="op" id="5328224">]</span><span class="op" id="5328225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5328230">}</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328235">e</span><span class="op" id="5328236">.</span><span class="ident" id="5328237">WriteString</span><span class="op" id="5328248">(</span><span class="string" id="5328249">`\u202`</span><span class="op" id="5328256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328261">e</span><span class="op" id="5328262">.</span><span class="ident" id="5328263">WriteByte</span><span class="op" id="5328272">(</span><span class="ident" id="5328273">hex</span><span class="op" id="5328276">[</span><span class="ident" id="5328277">c</span><span class="op" id="5328278">&amp;</span><span class="num" id="5328279">0xF</span><span class="op" id="5328282">]</span><span class="op" id="5328283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328288">i</span>&nbsp;<span class="op" id="5328290">+=</span>&nbsp;<span class="ident" id="5328293">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328301">start</span>&nbsp;<span class="op" id="5328307">=</span>&nbsp;<span class="ident" id="5328309">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5328314">continue</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5328325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328329">i</span>&nbsp;<span class="op" id="5328331">+=</span>&nbsp;<span class="ident" id="5328334">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5328340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5328343">if</span>&nbsp;<span class="ident" id="5328346">start</span>&nbsp;<span class="op" id="5328352">&lt;</span>&nbsp;<span class="builtinfunc" id="5328354">len</span><span class="op" id="5328357">(</span><span class="ident" id="5328358">s</span><span class="op" id="5328359">)</span>&nbsp;<span class="op" id="5328361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328365">e</span><span class="op" id="5328366">.</span><span class="ident" id="5328367">WriteString</span><span class="op" id="5328378">(</span><span class="ident" id="5328379">s</span><span class="op" id="5328380">[</span><span class="ident" id="5328381">start</span><span class="op" id="5328386">:</span><span class="op" id="5328387">]</span><span class="op" id="5328388">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5328391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328394">e</span><span class="op" id="5328395">.</span><span class="ident" id="5328396">WriteByte</span><span class="op" id="5328405">(</span><span class="string" id="5328406">&#39;&#34;&#39;</span><span class="op" id="5328409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5328412">return</span>&nbsp;<span class="ident" id="5328419">e</span><span class="op" id="5328420">.</span><span class="ident" id="5328421">Len</span><span class="op" id="5328424">(</span><span class="op" id="5328425">)</span>&nbsp;<span class="op" id="5328427">-</span>&nbsp;<span class="ident" id="5328429">len0</span><span class="op" id="5328433">,</span>&nbsp;<span class="ident" id="5328435">nil</span><br>
<span class="lineno"></span><span class="op" id="5328439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span><span class="comment" id="5328442">//&nbsp;NOTE:&nbsp;keep&nbsp;in&nbsp;sync&nbsp;with&nbsp;string&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="5328483">func</span>&nbsp;<span class="op" id="5328488">(</span><span class="ident" id="5328489">e</span>&nbsp;<span class="op" id="5328491">*</span><span class="ident" id="5328492">encodeState</span><span class="op" id="5328503">)</span>&nbsp;<span class="ident" id="5328505">stringBytes</span><span class="op" id="5328516">(</span><span class="ident" id="5328517">s</span>&nbsp;<span class="op" id="5328519">[</span><span class="op" id="5328520">]</span><span class="builtintype" id="5328521">byte</span><span class="op" id="5328525">)</span>&nbsp;<span class="op" id="5328527">(</span><span class="builtintype" id="5328528">int</span><span class="op" id="5328531">,</span>&nbsp;<span class="builtintype" id="5328533">error</span><span class="op" id="5328538">)</span>&nbsp;<span class="op" id="5328540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328543">len0</span>&nbsp;<span class="op" id="5328548">:=</span>&nbsp;<span class="ident" id="5328551">e</span><span class="op" id="5328552">.</span><span class="ident" id="5328553">Len</span><span class="op" id="5328556">(</span><span class="op" id="5328557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328560">e</span><span class="op" id="5328561">.</span><span class="ident" id="5328562">WriteByte</span><span class="op" id="5328571">(</span><span class="string" id="5328572">&#39;&#34;&#39;</span><span class="op" id="5328575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328578">start</span>&nbsp;<span class="op" id="5328584">:=</span>&nbsp;<span class="num" id="5328587">0</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5328590">for</span>&nbsp;<span class="ident" id="5328594">i</span>&nbsp;<span class="op" id="5328596">:=</span>&nbsp;<span class="num" id="5328599">0</span><span class="op" id="5328600">;</span>&nbsp;<span class="ident" id="5328602">i</span>&nbsp;<span class="op" id="5328604">&lt;</span>&nbsp;<span class="builtinfunc" id="5328606">len</span><span class="op" id="5328609">(</span><span class="ident" id="5328610">s</span><span class="op" id="5328611">)</span><span class="op" id="5328612">;</span>&nbsp;<span class="op" id="5328614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5328618">if</span>&nbsp;<span class="ident" id="5328621">b</span>&nbsp;<span class="op" id="5328623">:=</span>&nbsp;<span class="ident" id="5328626">s</span><span class="op" id="5328627">[</span><span class="ident" id="5328628">i</span><span class="op" id="5328629">]</span><span class="op" id="5328630">;</span>&nbsp;<span class="ident" id="5328632">b</span>&nbsp;<span class="op" id="5328634">&lt;</span>&nbsp;<span class="ident" id="5328636">utf8</span><span class="op" id="5328640">.</span><span class="ident" id="5328641">RuneSelf</span>&nbsp;<span class="op" id="5328650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5328655">if</span>&nbsp;<span class="num" id="5328658">0x20</span>&nbsp;<span class="op" id="5328663">&lt;=</span>&nbsp;<span class="ident" id="5328666">b</span>&nbsp;<span class="op" id="5328668">&amp;&amp;</span>&nbsp;<span class="ident" id="5328671">b</span>&nbsp;<span class="op" id="5328673">!=</span>&nbsp;<span class="string" id="5328676">&#39;\\&#39;</span>&nbsp;<span class="op" id="5328681">&amp;&amp;</span>&nbsp;<span class="ident" id="5328684">b</span>&nbsp;<span class="op" id="5328686">!=</span>&nbsp;<span class="string" id="5328689">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5328693">&amp;&amp;</span>&nbsp;<span class="ident" id="5328696">b</span>&nbsp;<span class="op" id="5328698">!=</span>&nbsp;<span class="string" id="5328701">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5328705">&amp;&amp;</span>&nbsp;<span class="ident" id="5328708">b</span>&nbsp;<span class="op" id="5328710">!=</span>&nbsp;<span class="string" id="5328713">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="5328717">&amp;&amp;</span>&nbsp;<span class="ident" id="5328720">b</span>&nbsp;<span class="op" id="5328722">!=</span>&nbsp;<span class="string" id="5328725">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="5328729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328735">i</span><span class="op" id="5328736">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5328743">continue</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5328755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5328760">if</span>&nbsp;<span class="ident" id="5328763">start</span>&nbsp;<span class="op" id="5328769">&lt;</span>&nbsp;<span class="ident" id="5328771">i</span>&nbsp;<span class="op" id="5328773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328779">e</span><span class="op" id="5328780">.</span><span class="ident" id="5328781">Write</span><span class="op" id="5328786">(</span><span class="ident" id="5328787">s</span><span class="op" id="5328788">[</span><span class="ident" id="5328789">start</span><span class="op" id="5328794">:</span><span class="ident" id="5328795">i</span><span class="op" id="5328796">]</span><span class="op" id="5328797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5328802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5328807">switch</span>&nbsp;<span class="ident" id="5328814">b</span>&nbsp;<span class="op" id="5328816">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5328821">case</span>&nbsp;<span class="string" id="5328826">&#39;\\&#39;</span><span class="op" id="5328830">,</span>&nbsp;<span class="string" id="5328832">&#39;&#34;&#39;</span><span class="op" id="5328835">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328841">e</span><span class="op" id="5328842">.</span><span class="ident" id="5328843">WriteByte</span><span class="op" id="5328852">(</span><span class="string" id="5328853">&#39;\\&#39;</span><span class="op" id="5328857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328863">e</span><span class="op" id="5328864">.</span><span class="ident" id="5328865">WriteByte</span><span class="op" id="5328874">(</span><span class="ident" id="5328875">b</span><span class="op" id="5328876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5328881">case</span>&nbsp;<span class="string" id="5328886">&#39;\n&#39;</span><span class="op" id="5328890">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328896">e</span><span class="op" id="5328897">.</span><span class="ident" id="5328898">WriteByte</span><span class="op" id="5328907">(</span><span class="string" id="5328908">&#39;\\&#39;</span><span class="op" id="5328912">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328918">e</span><span class="op" id="5328919">.</span><span class="ident" id="5328920">WriteByte</span><span class="op" id="5328929">(</span><span class="string" id="5328930">&#39;n&#39;</span><span class="op" id="5328933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5328938">case</span>&nbsp;<span class="string" id="5328943">&#39;\r&#39;</span><span class="op" id="5328947">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328953">e</span><span class="op" id="5328954">.</span><span class="ident" id="5328955">WriteByte</span><span class="op" id="5328964">(</span><span class="string" id="5328965">&#39;\\&#39;</span><span class="op" id="5328969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5328975">e</span><span class="op" id="5328976">.</span><span class="ident" id="5328977">WriteByte</span><span class="op" id="5328986">(</span><span class="string" id="5328987">&#39;r&#39;</span><span class="op" id="5328990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5328995">case</span>&nbsp;<span class="string" id="5329000">&#39;\t&#39;</span><span class="op" id="5329004">:</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5329010">e</span><span class="op" id="5329011">.</span><span class="ident" id="5329012">WriteByte</span><span class="op" id="5329021">(</span><span class="string" id="5329022">&#39;\\&#39;</span><span class="op" id="5329026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5329032">e</span><span class="op" id="5329033">.</span><span class="ident" id="5329034">WriteByte</span><span class="op" id="5329043">(</span><span class="string" id="5329044">&#39;t&#39;</span><span class="op" id="5329047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5329052">default</span><span class="op" id="5329059">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5329065">//&nbsp;This&nbsp;encodes&nbsp;bytes&nbsp;&lt;&nbsp;0x20&nbsp;except&nbsp;for&nbsp;\n&nbsp;and&nbsp;\r,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5329120">//&nbsp;as&nbsp;well&nbsp;as&nbsp;&lt;,&nbsp;&gt;,&nbsp;and&nbsp;&amp;.&nbsp;The&nbsp;latter&nbsp;are&nbsp;escaped&nbsp;because&nbsp;they</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5329187">//&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;when&nbsp;user-controlled&nbsp;strings</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5329250">//&nbsp;are&nbsp;rendered&nbsp;into&nbsp;JSON&nbsp;and&nbsp;served&nbsp;to&nbsp;some&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5329309">e</span><span class="op" id="5329310">.</span><span class="ident" id="5329311">WriteString</span><span class="op" id="5329322">(</span><span class="string" id="5329323">`\u00`</span><span class="op" id="5329329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5329335">e</span><span class="op" id="5329336">.</span><span class="ident" id="5329337">WriteByte</span><span class="op" id="5329346">(</span><span class="ident" id="5329347">hex</span><span class="op" id="5329350">[</span><span class="ident" id="5329351">b</span><span class="op" id="5329352">&gt;&gt;</span><span class="num" id="5329354">4</span><span class="op" id="5329355">]</span><span class="op" id="5329356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5329362">e</span><span class="op" id="5329363">.</span><span class="ident" id="5329364">WriteByte</span><span class="op" id="5329373">(</span><span class="ident" id="5329374">hex</span><span class="op" id="5329377">[</span><span class="ident" id="5329378">b</span><span class="op" id="5329379">&amp;</span><span class="num" id="5329380">0xF</span><span class="op" id="5329383">]</span><span class="op" id="5329384">)</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5329389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5329394">i</span><span class="op" id="5329395">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5329401">start</span>&nbsp;<span class="op" id="5329407">=</span>&nbsp;<span class="ident" id="5329409">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5329414">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5329425">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5329429">c</span><span class="op" id="5329430">,</span>&nbsp;<span class="ident" id="5329432">size</span>&nbsp;<span class="op" id="5329437">:=</span>&nbsp;<span class="ident" id="5329440">utf8</span><span class="op" id="5329444">.</span><span class="ident" id="5329445">DecodeRune</span><span class="op" id="5329455">(</span><span class="ident" id="5329456">s</span><span class="op" id="5329457">[</span><span class="ident" id="5329458">i</span><span class="op" id="5329459">:</span><span class="op" id="5329460">]</span><span class="op" id="5329461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5329465">if</span>&nbsp;<span class="ident" id="5329468">c</span>&nbsp;<span class="op" id="5329470">==</span>&nbsp;<span class="ident" id="5329473">utf8</span><span class="op" id="5329477">.</span><span class="ident" id="5329478">RuneError</span>&nbsp;<span class="op" id="5329488">&amp;&amp;</span>&nbsp;<span class="ident" id="5329491">size</span>&nbsp;<span class="op" id="5329496">==</span>&nbsp;<span class="num" id="5329499">1</span>&nbsp;<span class="op" id="5329501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5329506">if</span>&nbsp;<span class="ident" id="5329509">start</span>&nbsp;<span class="op" id="5329515">&lt;</span>&nbsp;<span class="ident" id="5329517">i</span>&nbsp;<span class="op" id="5329519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5329525">e</span><span class="op" id="5329526">.</span><span class="ident" id="5329527">Write</span><span class="op" id="5329532">(</span><span class="ident" id="5329533">s</span><span class="op" id="5329534">[</span><span class="ident" id="5329535">start</span><span class="op" id="5329540">:</span><span class="ident" id="5329541">i</span><span class="op" id="5329542">]</span><span class="op" id="5329543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5329548">}</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5329553">e</span><span class="op" id="5329554">.</span><span class="ident" id="5329555">WriteString</span><span class="op" id="5329566">(</span><span class="string" id="5329567">`\ufffd`</span><span class="op" id="5329575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5329580">i</span>&nbsp;<span class="op" id="5329582">+=</span>&nbsp;<span class="ident" id="5329585">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5329593">start</span>&nbsp;<span class="op" id="5329599">=</span>&nbsp;<span class="ident" id="5329601">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5329606">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5329617">}</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5329621">//&nbsp;U+2028&nbsp;is&nbsp;LINE&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5329652">//&nbsp;U+2029&nbsp;is&nbsp;PARAGRAPH&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5329688">//&nbsp;They&nbsp;are&nbsp;both&nbsp;technically&nbsp;valid&nbsp;characters&nbsp;in&nbsp;JSON&nbsp;strings,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5329753">//&nbsp;but&nbsp;don&#39;t&nbsp;work&nbsp;in&nbsp;JSONP,&nbsp;which&nbsp;has&nbsp;to&nbsp;be&nbsp;evaluated&nbsp;as&nbsp;JavaScript,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5329824">//&nbsp;and&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;there.&nbsp;It&nbsp;is&nbsp;valid&nbsp;JSON&nbsp;to</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5329887">//&nbsp;escape&nbsp;them,&nbsp;so&nbsp;we&nbsp;do&nbsp;so&nbsp;unconditionally.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5329934">//&nbsp;See&nbsp;http://timelessrepo.com/json-isnt-a-javascript-subset&nbsp;for&nbsp;discussion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5330013">if</span>&nbsp;<span class="ident" id="5330016">c</span>&nbsp;<span class="op" id="5330018">==</span>&nbsp;<span class="string" id="5330021">&#39;\u2028&#39;</span>&nbsp;<span class="op" id="5330030">||</span>&nbsp;<span class="ident" id="5330033">c</span>&nbsp;<span class="op" id="5330035">==</span>&nbsp;<span class="string" id="5330038">&#39;\u2029&#39;</span>&nbsp;<span class="op" id="5330047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5330052">if</span>&nbsp;<span class="ident" id="5330055">start</span>&nbsp;<span class="op" id="5330061">&lt;</span>&nbsp;<span class="ident" id="5330063">i</span>&nbsp;<span class="op" id="5330065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330071">e</span><span class="op" id="5330072">.</span><span class="ident" id="5330073">Write</span><span class="op" id="5330078">(</span><span class="ident" id="5330079">s</span><span class="op" id="5330080">[</span><span class="ident" id="5330081">start</span><span class="op" id="5330086">:</span><span class="ident" id="5330087">i</span><span class="op" id="5330088">]</span><span class="op" id="5330089">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5330094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330099">e</span><span class="op" id="5330100">.</span><span class="ident" id="5330101">WriteString</span><span class="op" id="5330112">(</span><span class="string" id="5330113">`\u202`</span><span class="op" id="5330120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330125">e</span><span class="op" id="5330126">.</span><span class="ident" id="5330127">WriteByte</span><span class="op" id="5330136">(</span><span class="ident" id="5330137">hex</span><span class="op" id="5330140">[</span><span class="ident" id="5330141">c</span><span class="op" id="5330142">&amp;</span><span class="num" id="5330143">0xF</span><span class="op" id="5330146">]</span><span class="op" id="5330147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330152">i</span>&nbsp;<span class="op" id="5330154">+=</span>&nbsp;<span class="ident" id="5330157">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330165">start</span>&nbsp;<span class="op" id="5330171">=</span>&nbsp;<span class="ident" id="5330173">i</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5330178">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5330189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330193">i</span>&nbsp;<span class="op" id="5330195">+=</span>&nbsp;<span class="ident" id="5330198">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5330204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5330207">if</span>&nbsp;<span class="ident" id="5330210">start</span>&nbsp;<span class="op" id="5330216">&lt;</span>&nbsp;<span class="builtinfunc" id="5330218">len</span><span class="op" id="5330221">(</span><span class="ident" id="5330222">s</span><span class="op" id="5330223">)</span>&nbsp;<span class="op" id="5330225">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330229">e</span><span class="op" id="5330230">.</span><span class="ident" id="5330231">Write</span><span class="op" id="5330236">(</span><span class="ident" id="5330237">s</span><span class="op" id="5330238">[</span><span class="ident" id="5330239">start</span><span class="op" id="5330244">:</span><span class="op" id="5330245">]</span><span class="op" id="5330246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5330249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330252">e</span><span class="op" id="5330253">.</span><span class="ident" id="5330254">WriteByte</span><span class="op" id="5330263">(</span><span class="string" id="5330264">&#39;&#34;&#39;</span><span class="op" id="5330267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5330270">return</span>&nbsp;<span class="ident" id="5330277">e</span><span class="op" id="5330278">.</span><span class="ident" id="5330279">Len</span><span class="op" id="5330282">(</span><span class="op" id="5330283">)</span>&nbsp;<span class="op" id="5330285">-</span>&nbsp;<span class="ident" id="5330287">len0</span><span class="op" id="5330291">,</span>&nbsp;<span class="ident" id="5330293">nil</span><br>
<span class="lineno"></span><span class="op" id="5330297">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="comment" id="5330300">//&nbsp;A&nbsp;field&nbsp;represents&nbsp;a&nbsp;single&nbsp;field&nbsp;found&nbsp;in&nbsp;a&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="5330356">type</span>&nbsp;<span class="ident" id="5330361">field</span>&nbsp;<span class="keyword" id="5330367">struct</span>&nbsp;<span class="op" id="5330374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330377">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5330387">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330395">nameBytes</span>&nbsp;<span class="op" id="5330405">[</span><span class="op" id="5330406">]</span><span class="builtintype" id="5330407">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5330428">//&nbsp;[]byte(name)</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330445">equalFold</span>&nbsp;<span class="keyword" id="5330455">func</span><span class="op" id="5330459">(</span><span class="ident" id="5330460">s</span><span class="op" id="5330461">,</span>&nbsp;<span class="ident" id="5330463">t</span>&nbsp;<span class="op" id="5330465">[</span><span class="op" id="5330466">]</span><span class="builtintype" id="5330467">byte</span><span class="op" id="5330471">)</span>&nbsp;<span class="builtintype" id="5330473">bool</span>&nbsp;<span class="comment" id="5330478">//&nbsp;bytes.EqualFold&nbsp;or&nbsp;equivalent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330513">tag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5330523">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330529">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5330539">[</span><span class="op" id="5330540">]</span><span class="builtintype" id="5330541">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330546">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5330556">reflect</span><span class="op" id="5330563">.</span><span class="ident" id="5330564">Type</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330570">omitEmpty</span>&nbsp;<span class="builtintype" id="5330580">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330586">quoted</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5330596">bool</span><br>
<span class="lineno"></span><span class="op" id="5330601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5330604">func</span>&nbsp;<span class="ident" id="5330609">fillField</span><span class="op" id="5330618">(</span><span class="ident" id="5330619">f</span>&nbsp;<span class="ident" id="5330621">field</span><span class="op" id="5330626">)</span>&nbsp;<span class="ident" id="5330628">field</span>&nbsp;<span class="op" id="5330634">{</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330637">f</span><span class="op" id="5330638">.</span><span class="ident" id="5330639">nameBytes</span>&nbsp;<span class="op" id="5330649">=</span>&nbsp;<span class="op" id="5330651">[</span><span class="op" id="5330652">]</span><span class="builtintype" id="5330653">byte</span><span class="op" id="5330657">(</span><span class="ident" id="5330658">f</span><span class="op" id="5330659">.</span><span class="ident" id="5330660">name</span><span class="op" id="5330664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5330667">f</span><span class="op" id="5330668">.</span><span class="ident" id="5330669">equalFold</span>&nbsp;<span class="op" id="5330679">=</span>&nbsp;<span class="ident" id="5330681">foldFunc</span><span class="op" id="5330689">(</span><span class="ident" id="5330690">f</span><span class="op" id="5330691">.</span><span class="ident" id="5330692">nameBytes</span><span class="op" id="5330701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5330704">return</span>&nbsp;<span class="ident" id="5330711">f</span><br>
<span class="lineno"></span><span class="op" id="5330713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">955</span><span class="comment" id="5330716">//&nbsp;byName&nbsp;sorts&nbsp;field&nbsp;by&nbsp;name,&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;depth,</span><br>
<span class="lineno"></span><span class="comment" id="5330773">//&nbsp;then&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;&#34;name&nbsp;came&nbsp;from&nbsp;json&nbsp;tag&#34;,&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="5330832">//&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="keyword" id="5330870">type</span>&nbsp;<span class="ident" id="5330875">byName</span>&nbsp;<span class="op" id="5330882">[</span><span class="op" id="5330883">]</span><span class="ident" id="5330884">field</span><br>
<span class="lineno"></span><br>
<span class="lineno">960</span><span class="keyword" id="5330891">func</span>&nbsp;<span class="op" id="5330896">(</span><span class="ident" id="5330897">x</span>&nbsp;<span class="ident" id="5330899">byName</span><span class="op" id="5330905">)</span>&nbsp;<span class="ident" id="5330907">Len</span><span class="op" id="5330910">(</span><span class="op" id="5330911">)</span>&nbsp;<span class="builtintype" id="5330913">int</span>&nbsp;<span class="op" id="5330917">{</span>&nbsp;<span class="keyword" id="5330919">return</span>&nbsp;<span class="builtinfunc" id="5330926">len</span><span class="op" id="5330929">(</span><span class="ident" id="5330930">x</span><span class="op" id="5330931">)</span>&nbsp;<span class="op" id="5330933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5330936">func</span>&nbsp;<span class="op" id="5330941">(</span><span class="ident" id="5330942">x</span>&nbsp;<span class="ident" id="5330944">byName</span><span class="op" id="5330950">)</span>&nbsp;<span class="ident" id="5330952">Swap</span><span class="op" id="5330956">(</span><span class="ident" id="5330957">i</span><span class="op" id="5330958">,</span>&nbsp;<span class="ident" id="5330960">j</span>&nbsp;<span class="builtintype" id="5330962">int</span><span class="op" id="5330965">)</span>&nbsp;<span class="op" id="5330967">{</span>&nbsp;<span class="ident" id="5330969">x</span><span class="op" id="5330970">[</span><span class="ident" id="5330971">i</span><span class="op" id="5330972">]</span><span class="op" id="5330973">,</span>&nbsp;<span class="ident" id="5330975">x</span><span class="op" id="5330976">[</span><span class="ident" id="5330977">j</span><span class="op" id="5330978">]</span>&nbsp;<span class="op" id="5330980">=</span>&nbsp;<span class="ident" id="5330982">x</span><span class="op" id="5330983">[</span><span class="ident" id="5330984">j</span><span class="op" id="5330985">]</span><span class="op" id="5330986">,</span>&nbsp;<span class="ident" id="5330988">x</span><span class="op" id="5330989">[</span><span class="ident" id="5330990">i</span><span class="op" id="5330991">]</span>&nbsp;<span class="op" id="5330993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5330996">func</span>&nbsp;<span class="op" id="5331001">(</span><span class="ident" id="5331002">x</span>&nbsp;<span class="ident" id="5331004">byName</span><span class="op" id="5331010">)</span>&nbsp;<span class="ident" id="5331012">Less</span><span class="op" id="5331016">(</span><span class="ident" id="5331017">i</span><span class="op" id="5331018">,</span>&nbsp;<span class="ident" id="5331020">j</span>&nbsp;<span class="builtintype" id="5331022">int</span><span class="op" id="5331025">)</span>&nbsp;<span class="builtintype" id="5331027">bool</span>&nbsp;<span class="op" id="5331032">{</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5331035">if</span>&nbsp;<span class="ident" id="5331038">x</span><span class="op" id="5331039">[</span><span class="ident" id="5331040">i</span><span class="op" id="5331041">]</span><span class="op" id="5331042">.</span><span class="ident" id="5331043">name</span>&nbsp;<span class="op" id="5331048">!=</span>&nbsp;<span class="ident" id="5331051">x</span><span class="op" id="5331052">[</span><span class="ident" id="5331053">j</span><span class="op" id="5331054">]</span><span class="op" id="5331055">.</span><span class="ident" id="5331056">name</span>&nbsp;<span class="op" id="5331061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5331065">return</span>&nbsp;<span class="ident" id="5331072">x</span><span class="op" id="5331073">[</span><span class="ident" id="5331074">i</span><span class="op" id="5331075">]</span><span class="op" id="5331076">.</span><span class="ident" id="5331077">name</span>&nbsp;<span class="op" id="5331082">&lt;</span>&nbsp;<span class="ident" id="5331084">x</span><span class="op" id="5331085">[</span><span class="ident" id="5331086">j</span><span class="op" id="5331087">]</span><span class="op" id="5331088">.</span><span class="ident" id="5331089">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5331095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5331098">if</span>&nbsp;<span class="builtinfunc" id="5331101">len</span><span class="op" id="5331104">(</span><span class="ident" id="5331105">x</span><span class="op" id="5331106">[</span><span class="ident" id="5331107">i</span><span class="op" id="5331108">]</span><span class="op" id="5331109">.</span><span class="ident" id="5331110">index</span><span class="op" id="5331115">)</span>&nbsp;<span class="op" id="5331117">!=</span>&nbsp;<span class="builtinfunc" id="5331120">len</span><span class="op" id="5331123">(</span><span class="ident" id="5331124">x</span><span class="op" id="5331125">[</span><span class="ident" id="5331126">j</span><span class="op" id="5331127">]</span><span class="op" id="5331128">.</span><span class="ident" id="5331129">index</span><span class="op" id="5331134">)</span>&nbsp;<span class="op" id="5331136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5331140">return</span>&nbsp;<span class="builtinfunc" id="5331147">len</span><span class="op" id="5331150">(</span><span class="ident" id="5331151">x</span><span class="op" id="5331152">[</span><span class="ident" id="5331153">i</span><span class="op" id="5331154">]</span><span class="op" id="5331155">.</span><span class="ident" id="5331156">index</span><span class="op" id="5331161">)</span>&nbsp;<span class="op" id="5331163">&lt;</span>&nbsp;<span class="builtinfunc" id="5331165">len</span><span class="op" id="5331168">(</span><span class="ident" id="5331169">x</span><span class="op" id="5331170">[</span><span class="ident" id="5331171">j</span><span class="op" id="5331172">]</span><span class="op" id="5331173">.</span><span class="ident" id="5331174">index</span><span class="op" id="5331179">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5331182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5331185">if</span>&nbsp;<span class="ident" id="5331188">x</span><span class="op" id="5331189">[</span><span class="ident" id="5331190">i</span><span class="op" id="5331191">]</span><span class="op" id="5331192">.</span><span class="ident" id="5331193">tag</span>&nbsp;<span class="op" id="5331197">!=</span>&nbsp;<span class="ident" id="5331200">x</span><span class="op" id="5331201">[</span><span class="ident" id="5331202">j</span><span class="op" id="5331203">]</span><span class="op" id="5331204">.</span><span class="ident" id="5331205">tag</span>&nbsp;<span class="op" id="5331209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5331213">return</span>&nbsp;<span class="ident" id="5331220">x</span><span class="op" id="5331221">[</span><span class="ident" id="5331222">i</span><span class="op" id="5331223">]</span><span class="op" id="5331224">.</span><span class="ident" id="5331225">tag</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5331230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5331233">return</span>&nbsp;<span class="ident" id="5331240">byIndex</span><span class="op" id="5331247">(</span><span class="ident" id="5331248">x</span><span class="op" id="5331249">)</span><span class="op" id="5331250">.</span><span class="ident" id="5331251">Less</span><span class="op" id="5331255">(</span><span class="ident" id="5331256">i</span><span class="op" id="5331257">,</span>&nbsp;<span class="ident" id="5331259">j</span><span class="op" id="5331260">)</span><br>
<span class="lineno">975</span><span class="op" id="5331262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5331265">//&nbsp;byIndex&nbsp;sorts&nbsp;field&nbsp;by&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="keyword" id="5331307">type</span>&nbsp;<span class="ident" id="5331312">byIndex</span>&nbsp;<span class="op" id="5331320">[</span><span class="op" id="5331321">]</span><span class="ident" id="5331322">field</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="5331329">func</span>&nbsp;<span class="op" id="5331334">(</span><span class="ident" id="5331335">x</span>&nbsp;<span class="ident" id="5331337">byIndex</span><span class="op" id="5331344">)</span>&nbsp;<span class="ident" id="5331346">Len</span><span class="op" id="5331349">(</span><span class="op" id="5331350">)</span>&nbsp;<span class="builtintype" id="5331352">int</span>&nbsp;<span class="op" id="5331356">{</span>&nbsp;<span class="keyword" id="5331358">return</span>&nbsp;<span class="builtinfunc" id="5331365">len</span><span class="op" id="5331368">(</span><span class="ident" id="5331369">x</span><span class="op" id="5331370">)</span>&nbsp;<span class="op" id="5331372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5331375">func</span>&nbsp;<span class="op" id="5331380">(</span><span class="ident" id="5331381">x</span>&nbsp;<span class="ident" id="5331383">byIndex</span><span class="op" id="5331390">)</span>&nbsp;<span class="ident" id="5331392">Swap</span><span class="op" id="5331396">(</span><span class="ident" id="5331397">i</span><span class="op" id="5331398">,</span>&nbsp;<span class="ident" id="5331400">j</span>&nbsp;<span class="builtintype" id="5331402">int</span><span class="op" id="5331405">)</span>&nbsp;<span class="op" id="5331407">{</span>&nbsp;<span class="ident" id="5331409">x</span><span class="op" id="5331410">[</span><span class="ident" id="5331411">i</span><span class="op" id="5331412">]</span><span class="op" id="5331413">,</span>&nbsp;<span class="ident" id="5331415">x</span><span class="op" id="5331416">[</span><span class="ident" id="5331417">j</span><span class="op" id="5331418">]</span>&nbsp;<span class="op" id="5331420">=</span>&nbsp;<span class="ident" id="5331422">x</span><span class="op" id="5331423">[</span><span class="ident" id="5331424">j</span><span class="op" id="5331425">]</span><span class="op" id="5331426">,</span>&nbsp;<span class="ident" id="5331428">x</span><span class="op" id="5331429">[</span><span class="ident" id="5331430">i</span><span class="op" id="5331431">]</span>&nbsp;<span class="op" id="5331433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5331436">func</span>&nbsp;<span class="op" id="5331441">(</span><span class="ident" id="5331442">x</span>&nbsp;<span class="ident" id="5331444">byIndex</span><span class="op" id="5331451">)</span>&nbsp;<span class="ident" id="5331453">Less</span><span class="op" id="5331457">(</span><span class="ident" id="5331458">i</span><span class="op" id="5331459">,</span>&nbsp;<span class="ident" id="5331461">j</span>&nbsp;<span class="builtintype" id="5331463">int</span><span class="op" id="5331466">)</span>&nbsp;<span class="builtintype" id="5331468">bool</span>&nbsp;<span class="op" id="5331473">{</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5331476">for</span>&nbsp;<span class="ident" id="5331480">k</span><span class="op" id="5331481">,</span>&nbsp;<span class="ident" id="5331483">xik</span>&nbsp;<span class="op" id="5331487">:=</span>&nbsp;<span class="keyword" id="5331490">range</span>&nbsp;<span class="ident" id="5331496">x</span><span class="op" id="5331497">[</span><span class="ident" id="5331498">i</span><span class="op" id="5331499">]</span><span class="op" id="5331500">.</span><span class="ident" id="5331501">index</span>&nbsp;<span class="op" id="5331507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5331511">if</span>&nbsp;<span class="ident" id="5331514">k</span>&nbsp;<span class="op" id="5331516">&gt;=</span>&nbsp;<span class="builtinfunc" id="5331519">len</span><span class="op" id="5331522">(</span><span class="ident" id="5331523">x</span><span class="op" id="5331524">[</span><span class="ident" id="5331525">j</span><span class="op" id="5331526">]</span><span class="op" id="5331527">.</span><span class="ident" id="5331528">index</span><span class="op" id="5331533">)</span>&nbsp;<span class="op" id="5331535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5331540">return</span>&nbsp;<span class="builtintype" id="5331547">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5331555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5331559">if</span>&nbsp;<span class="ident" id="5331562">xik</span>&nbsp;<span class="op" id="5331566">!=</span>&nbsp;<span class="ident" id="5331569">x</span><span class="op" id="5331570">[</span><span class="ident" id="5331571">j</span><span class="op" id="5331572">]</span><span class="op" id="5331573">.</span><span class="ident" id="5331574">index</span><span class="op" id="5331579">[</span><span class="ident" id="5331580">k</span><span class="op" id="5331581">]</span>&nbsp;<span class="op" id="5331583">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5331588">return</span>&nbsp;<span class="ident" id="5331595">xik</span>&nbsp;<span class="op" id="5331599">&lt;</span>&nbsp;<span class="ident" id="5331601">x</span><span class="op" id="5331602">[</span><span class="ident" id="5331603">j</span><span class="op" id="5331604">]</span><span class="op" id="5331605">.</span><span class="ident" id="5331606">index</span><span class="op" id="5331611">[</span><span class="ident" id="5331612">k</span><span class="op" id="5331613">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5331617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5331620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5331623">return</span>&nbsp;<span class="builtinfunc" id="5331630">len</span><span class="op" id="5331633">(</span><span class="ident" id="5331634">x</span><span class="op" id="5331635">[</span><span class="ident" id="5331636">i</span><span class="op" id="5331637">]</span><span class="op" id="5331638">.</span><span class="ident" id="5331639">index</span><span class="op" id="5331644">)</span>&nbsp;<span class="op" id="5331646">&lt;</span>&nbsp;<span class="builtinfunc" id="5331648">len</span><span class="op" id="5331651">(</span><span class="ident" id="5331652">x</span><span class="op" id="5331653">[</span><span class="ident" id="5331654">j</span><span class="op" id="5331655">]</span><span class="op" id="5331656">.</span><span class="ident" id="5331657">index</span><span class="op" id="5331662">)</span><br>
<span class="lineno"></span><span class="op" id="5331664">}</span><br>
<span class="lineno">995</span><br>
<span class="lineno"></span><span class="comment" id="5331667">//&nbsp;typeFields&nbsp;returns&nbsp;a&nbsp;list&nbsp;of&nbsp;fields&nbsp;that&nbsp;JSON&nbsp;should&nbsp;recognize&nbsp;for&nbsp;the&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="5331753">//&nbsp;The&nbsp;algorithm&nbsp;is&nbsp;breadth-first&nbsp;search&nbsp;over&nbsp;the&nbsp;set&nbsp;of&nbsp;structs&nbsp;to&nbsp;include&nbsp;-&nbsp;the&nbsp;top&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="5331846">//&nbsp;and&nbsp;then&nbsp;any&nbsp;reachable&nbsp;anonymous&nbsp;structs.</span><br>
<span class="lineno"></span><span class="keyword" id="5331891">func</span>&nbsp;<span class="ident" id="5331896">typeFields</span><span class="op" id="5331906">(</span><span class="ident" id="5331907">t</span>&nbsp;<span class="ident" id="5331909">reflect</span><span class="op" id="5331916">.</span><span class="ident" id="5331917">Type</span><span class="op" id="5331921">)</span>&nbsp;<span class="op" id="5331923">[</span><span class="op" id="5331924">]</span><span class="ident" id="5331925">field</span>&nbsp;<span class="op" id="5331931">{</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5331934">//&nbsp;Anonymous&nbsp;fields&nbsp;to&nbsp;explore&nbsp;at&nbsp;the&nbsp;current&nbsp;level&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5332001">current</span>&nbsp;<span class="op" id="5332009">:=</span>&nbsp;<span class="op" id="5332012">[</span><span class="op" id="5332013">]</span><span class="ident" id="5332014">field</span><span class="op" id="5332019">{</span><span class="op" id="5332020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5332023">next</span>&nbsp;<span class="op" id="5332028">:=</span>&nbsp;<span class="op" id="5332031">[</span><span class="op" id="5332032">]</span><span class="ident" id="5332033">field</span><span class="op" id="5332038">{</span><span class="op" id="5332039">{</span><span class="ident" id="5332040">typ</span><span class="op" id="5332043">:</span>&nbsp;<span class="ident" id="5332045">t</span><span class="op" id="5332046">}</span><span class="op" id="5332047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5332051">//&nbsp;Count&nbsp;of&nbsp;queued&nbsp;names&nbsp;for&nbsp;current&nbsp;level&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5332109">count</span>&nbsp;<span class="op" id="5332115">:=</span>&nbsp;<span class="keyword" id="5332118">map</span><span class="op" id="5332121">[</span><span class="ident" id="5332122">reflect</span><span class="op" id="5332129">.</span><span class="ident" id="5332130">Type</span><span class="op" id="5332134">]</span><span class="builtintype" id="5332135">int</span><span class="op" id="5332138">{</span><span class="op" id="5332139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5332142">nextCount</span>&nbsp;<span class="op" id="5332152">:=</span>&nbsp;<span class="keyword" id="5332155">map</span><span class="op" id="5332158">[</span><span class="ident" id="5332159">reflect</span><span class="op" id="5332166">.</span><span class="ident" id="5332167">Type</span><span class="op" id="5332171">]</span><span class="builtintype" id="5332172">int</span><span class="op" id="5332175">{</span><span class="op" id="5332176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5332180">//&nbsp;Types&nbsp;already&nbsp;visited&nbsp;at&nbsp;an&nbsp;earlier&nbsp;level.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5332227">visited</span>&nbsp;<span class="op" id="5332235">:=</span>&nbsp;<span class="keyword" id="5332238">map</span><span class="op" id="5332241">[</span><span class="ident" id="5332242">reflect</span><span class="op" id="5332249">.</span><span class="ident" id="5332250">Type</span><span class="op" id="5332254">]</span><span class="builtintype" id="5332255">bool</span><span class="op" id="5332259">{</span><span class="op" id="5332260">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5332264">//&nbsp;Fields&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5332282">var</span>&nbsp;<span class="ident" id="5332286">fields</span>&nbsp;<span class="op" id="5332293">[</span><span class="op" id="5332294">]</span><span class="ident" id="5332295">field</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5332303">for</span>&nbsp;<span class="builtinfunc" id="5332307">len</span><span class="op" id="5332310">(</span><span class="ident" id="5332311">next</span><span class="op" id="5332315">)</span>&nbsp;<span class="op" id="5332317">&gt;</span>&nbsp;<span class="num" id="5332319">0</span>&nbsp;<span class="op" id="5332321">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5332325">current</span><span class="op" id="5332332">,</span>&nbsp;<span class="ident" id="5332334">next</span>&nbsp;<span class="op" id="5332339">=</span>&nbsp;<span class="ident" id="5332341">next</span><span class="op" id="5332345">,</span>&nbsp;<span class="ident" id="5332347">current</span><span class="op" id="5332354">[</span><span class="op" id="5332355">:</span><span class="num" id="5332356">0</span><span class="op" id="5332357">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5332361">count</span><span class="op" id="5332366">,</span>&nbsp;<span class="ident" id="5332368">nextCount</span>&nbsp;<span class="op" id="5332378">=</span>&nbsp;<span class="ident" id="5332380">nextCount</span><span class="op" id="5332389">,</span>&nbsp;<span class="keyword" id="5332391">map</span><span class="op" id="5332394">[</span><span class="ident" id="5332395">reflect</span><span class="op" id="5332402">.</span><span class="ident" id="5332403">Type</span><span class="op" id="5332407">]</span><span class="builtintype" id="5332408">int</span><span class="op" id="5332411">{</span><span class="op" id="5332412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5332417">for</span>&nbsp;<span class="ident" id="5332421">_</span><span class="op" id="5332422">,</span>&nbsp;<span class="ident" id="5332424">f</span>&nbsp;<span class="op" id="5332426">:=</span>&nbsp;<span class="keyword" id="5332429">range</span>&nbsp;<span class="ident" id="5332435">current</span>&nbsp;<span class="op" id="5332443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5332448">if</span>&nbsp;<span class="ident" id="5332451">visited</span><span class="op" id="5332458">[</span><span class="ident" id="5332459">f</span><span class="op" id="5332460">.</span><span class="ident" id="5332461">typ</span><span class="op" id="5332464">]</span>&nbsp;<span class="op" id="5332466">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5332472">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5332484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5332489">visited</span><span class="op" id="5332496">[</span><span class="ident" id="5332497">f</span><span class="op" id="5332498">.</span><span class="ident" id="5332499">typ</span><span class="op" id="5332502">]</span>&nbsp;<span class="op" id="5332504">=</span>&nbsp;<span class="builtintype" id="5332506">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5332515">//&nbsp;Scan&nbsp;f.typ&nbsp;for&nbsp;fields&nbsp;to&nbsp;include.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5332555">for</span>&nbsp;<span class="ident" id="5332559">i</span>&nbsp;<span class="op" id="5332561">:=</span>&nbsp;<span class="num" id="5332564">0</span><span class="op" id="5332565">;</span>&nbsp;<span class="ident" id="5332567">i</span>&nbsp;<span class="op" id="5332569">&lt;</span>&nbsp;<span class="ident" id="5332571">f</span><span class="op" id="5332572">.</span><span class="ident" id="5332573">typ</span><span class="op" id="5332576">.</span><span class="ident" id="5332577">NumField</span><span class="op" id="5332585">(</span><span class="op" id="5332586">)</span><span class="op" id="5332587">;</span>&nbsp;<span class="ident" id="5332589">i</span><span class="op" id="5332590">++</span>&nbsp;<span class="op" id="5332593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5332599">sf</span>&nbsp;<span class="op" id="5332602">:=</span>&nbsp;<span class="ident" id="5332605">f</span><span class="op" id="5332606">.</span><span class="ident" id="5332607">typ</span><span class="op" id="5332610">.</span><span class="ident" id="5332611">Field</span><span class="op" id="5332616">(</span><span class="ident" id="5332617">i</span><span class="op" id="5332618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5332624">if</span>&nbsp;<span class="ident" id="5332627">sf</span><span class="op" id="5332629">.</span><span class="ident" id="5332630">PkgPath</span>&nbsp;<span class="op" id="5332638">!=</span>&nbsp;<span class="string" id="5332641">&#34;&#34;</span>&nbsp;<span class="op" id="5332644">{</span>&nbsp;<span class="comment" id="5332646">//&nbsp;unexported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5332665">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5332678">}</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5332684">tag</span>&nbsp;<span class="op" id="5332688">:=</span>&nbsp;<span class="ident" id="5332691">sf</span><span class="op" id="5332693">.</span><span class="ident" id="5332694">Tag</span><span class="op" id="5332697">.</span><span class="ident" id="5332698">Get</span><span class="op" id="5332701">(</span><span class="string" id="5332702">&#34;json&#34;</span><span class="op" id="5332708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5332714">if</span>&nbsp;<span class="ident" id="5332717">tag</span>&nbsp;<span class="op" id="5332721">==</span>&nbsp;<span class="string" id="5332724">&#34;-&#34;</span>&nbsp;<span class="op" id="5332728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5332735">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5332748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5332754">name</span><span class="op" id="5332758">,</span>&nbsp;<span class="ident" id="5332760">opts</span>&nbsp;<span class="op" id="5332765">:=</span>&nbsp;<span class="ident" id="5332768">parseTag</span><span class="op" id="5332776">(</span><span class="ident" id="5332777">tag</span><span class="op" id="5332780">)</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5332786">if</span>&nbsp;<span class="op" id="5332789">!</span><span class="ident" id="5332790">isValidTag</span><span class="op" id="5332800">(</span><span class="ident" id="5332801">name</span><span class="op" id="5332805">)</span>&nbsp;<span class="op" id="5332807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5332814">name</span>&nbsp;<span class="op" id="5332819">=</span>&nbsp;<span class="string" id="5332821">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5332828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5332834">index</span>&nbsp;<span class="op" id="5332840">:=</span>&nbsp;<span class="builtinfunc" id="5332843">make</span><span class="op" id="5332847">(</span><span class="op" id="5332848">[</span><span class="op" id="5332849">]</span><span class="builtintype" id="5332850">int</span><span class="op" id="5332853">,</span>&nbsp;<span class="builtinfunc" id="5332855">len</span><span class="op" id="5332858">(</span><span class="ident" id="5332859">f</span><span class="op" id="5332860">.</span><span class="ident" id="5332861">index</span><span class="op" id="5332866">)</span><span class="op" id="5332867">+</span><span class="num" id="5332868">1</span><span class="op" id="5332869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5332875">copy</span><span class="op" id="5332879">(</span><span class="ident" id="5332880">index</span><span class="op" id="5332885">,</span>&nbsp;<span class="ident" id="5332887">f</span><span class="op" id="5332888">.</span><span class="ident" id="5332889">index</span><span class="op" id="5332894">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5332900">index</span><span class="op" id="5332905">[</span><span class="builtinfunc" id="5332906">len</span><span class="op" id="5332909">(</span><span class="ident" id="5332910">f</span><span class="op" id="5332911">.</span><span class="ident" id="5332912">index</span><span class="op" id="5332917">)</span><span class="op" id="5332918">]</span>&nbsp;<span class="op" id="5332920">=</span>&nbsp;<span class="ident" id="5332922">i</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5332929">ft</span>&nbsp;<span class="op" id="5332932">:=</span>&nbsp;<span class="ident" id="5332935">sf</span><span class="op" id="5332937">.</span><span class="ident" id="5332938">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5332947">if</span>&nbsp;<span class="ident" id="5332950">ft</span><span class="op" id="5332952">.</span><span class="ident" id="5332953">Name</span><span class="op" id="5332957">(</span><span class="op" id="5332958">)</span>&nbsp;<span class="op" id="5332960">==</span>&nbsp;<span class="string" id="5332963">&#34;&#34;</span>&nbsp;<span class="op" id="5332966">&amp;&amp;</span>&nbsp;<span class="ident" id="5332969">ft</span><span class="op" id="5332971">.</span><span class="ident" id="5332972">Kind</span><span class="op" id="5332976">(</span><span class="op" id="5332977">)</span>&nbsp;<span class="op" id="5332979">==</span>&nbsp;<span class="ident" id="5332982">reflect</span><span class="op" id="5332989">.</span><span class="ident" id="5332990">Ptr</span>&nbsp;<span class="op" id="5332994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5333001">//&nbsp;Follow&nbsp;pointer.</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5333025">ft</span>&nbsp;<span class="op" id="5333028">=</span>&nbsp;<span class="ident" id="5333030">ft</span><span class="op" id="5333032">.</span><span class="ident" id="5333033">Elem</span><span class="op" id="5333037">(</span><span class="op" id="5333038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5333044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5333051">//&nbsp;Record&nbsp;found&nbsp;field&nbsp;and&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5333097">if</span>&nbsp;<span class="ident" id="5333100">name</span>&nbsp;<span class="op" id="5333105">!=</span>&nbsp;<span class="string" id="5333108">&#34;&#34;</span>&nbsp;<span class="op" id="5333111">||</span>&nbsp;<span class="op" id="5333114">!</span><span class="ident" id="5333115">sf</span><span class="op" id="5333117">.</span><span class="ident" id="5333118">Anonymous</span>&nbsp;<span class="op" id="5333128">||</span>&nbsp;<span class="ident" id="5333131">ft</span><span class="op" id="5333133">.</span><span class="ident" id="5333134">Kind</span><span class="op" id="5333138">(</span><span class="op" id="5333139">)</span>&nbsp;<span class="op" id="5333141">!=</span>&nbsp;<span class="ident" id="5333144">reflect</span><span class="op" id="5333151">.</span><span class="ident" id="5333152">Struct</span>&nbsp;<span class="op" id="5333159">{</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5333166">tagged</span>&nbsp;<span class="op" id="5333173">:=</span>&nbsp;<span class="ident" id="5333176">name</span>&nbsp;<span class="op" id="5333181">!=</span>&nbsp;<span class="string" id="5333184">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5333192">if</span>&nbsp;<span class="ident" id="5333195">name</span>&nbsp;<span class="op" id="5333200">==</span>&nbsp;<span class="string" id="5333203">&#34;&#34;</span>&nbsp;<span class="op" id="5333206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5333214">name</span>&nbsp;<span class="op" id="5333219">=</span>&nbsp;<span class="ident" id="5333221">sf</span><span class="op" id="5333223">.</span><span class="ident" id="5333224">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5333234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5333241">fields</span>&nbsp;<span class="op" id="5333248">=</span>&nbsp;<span class="builtinfunc" id="5333250">append</span><span class="op" id="5333256">(</span><span class="ident" id="5333257">fields</span><span class="op" id="5333263">,</span>&nbsp;<span class="ident" id="5333265">fillField</span><span class="op" id="5333274">(</span><span class="ident" id="5333275">field</span><span class="op" id="5333280">{</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5333288">name</span><span class="op" id="5333292">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5333299">name</span><span class="op" id="5333303">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5333311">tag</span><span class="op" id="5333314">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5333322">tagged</span><span class="op" id="5333328">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5333336">index</span><span class="op" id="5333341">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5333347">index</span><span class="op" id="5333352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5333360">typ</span><span class="op" id="5333363">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5333371">ft</span><span class="op" id="5333373">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5333381">omitEmpty</span><span class="op" id="5333390">:</span>&nbsp;<span class="ident" id="5333392">opts</span><span class="op" id="5333396">.</span><span class="ident" id="5333397">Contains</span><span class="op" id="5333405">(</span><span class="string" id="5333406">&#34;omitempty&#34;</span><span class="op" id="5333417">)</span><span class="op" id="5333418">,</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5333426">quoted</span><span class="op" id="5333432">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5333437">opts</span><span class="op" id="5333441">.</span><span class="ident" id="5333442">Contains</span><span class="op" id="5333450">(</span><span class="string" id="5333451">&#34;string&#34;</span><span class="op" id="5333459">)</span><span class="op" id="5333460">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5333467">}</span><span class="op" id="5333468">)</span><span class="op" id="5333469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5333476">if</span>&nbsp;<span class="ident" id="5333479">count</span><span class="op" id="5333484">[</span><span class="ident" id="5333485">f</span><span class="op" id="5333486">.</span><span class="ident" id="5333487">typ</span><span class="op" id="5333490">]</span>&nbsp;<span class="op" id="5333492">&gt;</span>&nbsp;<span class="num" id="5333494">1</span>&nbsp;<span class="op" id="5333496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5333504">//&nbsp;If&nbsp;there&nbsp;were&nbsp;multiple&nbsp;instances,&nbsp;add&nbsp;a&nbsp;second,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5333561">//&nbsp;so&nbsp;that&nbsp;the&nbsp;annihilation&nbsp;code&nbsp;will&nbsp;see&nbsp;a&nbsp;duplicate.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5333622">//&nbsp;It&nbsp;only&nbsp;cares&nbsp;about&nbsp;the&nbsp;distinction&nbsp;between&nbsp;1&nbsp;or&nbsp;2,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5333683">//&nbsp;so&nbsp;don&#39;t&nbsp;bother&nbsp;generating&nbsp;any&nbsp;more&nbsp;copies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5333736">fields</span>&nbsp;<span class="op" id="5333743">=</span>&nbsp;<span class="builtinfunc" id="5333745">append</span><span class="op" id="5333751">(</span><span class="ident" id="5333752">fields</span><span class="op" id="5333758">,</span>&nbsp;<span class="ident" id="5333760">fields</span><span class="op" id="5333766">[</span><span class="builtinfunc" id="5333767">len</span><span class="op" id="5333770">(</span><span class="ident" id="5333771">fields</span><span class="op" id="5333777">)</span><span class="op" id="5333778">-</span><span class="num" id="5333779">1</span><span class="op" id="5333780">]</span><span class="op" id="5333781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5333788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5333795">continue</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5333808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5333815">//&nbsp;Record&nbsp;new&nbsp;anonymous&nbsp;struct&nbsp;to&nbsp;explore&nbsp;in&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5333876">nextCount</span><span class="op" id="5333885">[</span><span class="ident" id="5333886">ft</span><span class="op" id="5333888">]</span><span class="op" id="5333889">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5333896">if</span>&nbsp;<span class="ident" id="5333899">nextCount</span><span class="op" id="5333908">[</span><span class="ident" id="5333909">ft</span><span class="op" id="5333911">]</span>&nbsp;<span class="op" id="5333913">==</span>&nbsp;<span class="num" id="5333916">1</span>&nbsp;<span class="op" id="5333918">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5333925">next</span>&nbsp;<span class="op" id="5333930">=</span>&nbsp;<span class="builtinfunc" id="5333932">append</span><span class="op" id="5333938">(</span><span class="ident" id="5333939">next</span><span class="op" id="5333943">,</span>&nbsp;<span class="ident" id="5333945">fillField</span><span class="op" id="5333954">(</span><span class="ident" id="5333955">field</span><span class="op" id="5333960">{</span><span class="ident" id="5333961">name</span><span class="op" id="5333965">:</span>&nbsp;<span class="ident" id="5333967">ft</span><span class="op" id="5333969">.</span><span class="ident" id="5333970">Name</span><span class="op" id="5333974">(</span><span class="op" id="5333975">)</span><span class="op" id="5333976">,</span>&nbsp;<span class="ident" id="5333978">index</span><span class="op" id="5333983">:</span>&nbsp;<span class="ident" id="5333985">index</span><span class="op" id="5333990">,</span>&nbsp;<span class="ident" id="5333992">typ</span><span class="op" id="5333995">:</span>&nbsp;<span class="ident" id="5333997">ft</span><span class="op" id="5333999">}</span><span class="op" id="5334000">)</span><span class="op" id="5334001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5334007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5334012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5334016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5334019">}</span><br>
<span class="lineno">1080</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334023">sort</span><span class="op" id="5334027">.</span><span class="ident" id="5334028">Sort</span><span class="op" id="5334032">(</span><span class="ident" id="5334033">byName</span><span class="op" id="5334039">(</span><span class="ident" id="5334040">fields</span><span class="op" id="5334046">)</span><span class="op" id="5334047">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5334051">//&nbsp;Delete&nbsp;all&nbsp;fields&nbsp;that&nbsp;are&nbsp;hidden&nbsp;by&nbsp;the&nbsp;Go&nbsp;rules&nbsp;for&nbsp;embedded&nbsp;fields,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5334126">//&nbsp;except&nbsp;that&nbsp;fields&nbsp;with&nbsp;JSON&nbsp;tags&nbsp;are&nbsp;promoted.</span><br>
<span class="lineno">1085</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5334179">//&nbsp;The&nbsp;fields&nbsp;are&nbsp;sorted&nbsp;in&nbsp;primary&nbsp;order&nbsp;of&nbsp;name,&nbsp;secondary&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5334247">//&nbsp;of&nbsp;field&nbsp;index&nbsp;length.&nbsp;Loop&nbsp;over&nbsp;names;&nbsp;for&nbsp;each&nbsp;name,&nbsp;delete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5334313">//&nbsp;hidden&nbsp;fields&nbsp;by&nbsp;choosing&nbsp;the&nbsp;one&nbsp;dominant&nbsp;field&nbsp;that&nbsp;survives.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334381">out</span>&nbsp;<span class="op" id="5334385">:=</span>&nbsp;<span class="ident" id="5334388">fields</span><span class="op" id="5334394">[</span><span class="op" id="5334395">:</span><span class="num" id="5334396">0</span><span class="op" id="5334397">]</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5334400">for</span>&nbsp;<span class="ident" id="5334404">advance</span><span class="op" id="5334411">,</span>&nbsp;<span class="ident" id="5334413">i</span>&nbsp;<span class="op" id="5334415">:=</span>&nbsp;<span class="num" id="5334418">0</span><span class="op" id="5334419">,</span>&nbsp;<span class="num" id="5334421">0</span><span class="op" id="5334422">;</span>&nbsp;<span class="ident" id="5334424">i</span>&nbsp;<span class="op" id="5334426">&lt;</span>&nbsp;<span class="builtinfunc" id="5334428">len</span><span class="op" id="5334431">(</span><span class="ident" id="5334432">fields</span><span class="op" id="5334438">)</span><span class="op" id="5334439">;</span>&nbsp;<span class="ident" id="5334441">i</span>&nbsp;<span class="op" id="5334443">+=</span>&nbsp;<span class="ident" id="5334446">advance</span>&nbsp;<span class="op" id="5334454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5334458">//&nbsp;One&nbsp;iteration&nbsp;per&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5334487">//&nbsp;Find&nbsp;the&nbsp;sequence&nbsp;of&nbsp;fields&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;this&nbsp;first&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334555">fi</span>&nbsp;<span class="op" id="5334558">:=</span>&nbsp;<span class="ident" id="5334561">fields</span><span class="op" id="5334567">[</span><span class="ident" id="5334568">i</span><span class="op" id="5334569">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334573">name</span>&nbsp;<span class="op" id="5334578">:=</span>&nbsp;<span class="ident" id="5334581">fi</span><span class="op" id="5334583">.</span><span class="ident" id="5334584">name</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5334591">for</span>&nbsp;<span class="ident" id="5334595">advance</span>&nbsp;<span class="op" id="5334603">=</span>&nbsp;<span class="num" id="5334605">1</span><span class="op" id="5334606">;</span>&nbsp;<span class="ident" id="5334608">i</span><span class="op" id="5334609">+</span><span class="ident" id="5334610">advance</span>&nbsp;<span class="op" id="5334618">&lt;</span>&nbsp;<span class="builtinfunc" id="5334620">len</span><span class="op" id="5334623">(</span><span class="ident" id="5334624">fields</span><span class="op" id="5334630">)</span><span class="op" id="5334631">;</span>&nbsp;<span class="ident" id="5334633">advance</span><span class="op" id="5334640">++</span>&nbsp;<span class="op" id="5334643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334648">fj</span>&nbsp;<span class="op" id="5334651">:=</span>&nbsp;<span class="ident" id="5334654">fields</span><span class="op" id="5334660">[</span><span class="ident" id="5334661">i</span><span class="op" id="5334662">+</span><span class="ident" id="5334663">advance</span><span class="op" id="5334670">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5334675">if</span>&nbsp;<span class="ident" id="5334678">fj</span><span class="op" id="5334680">.</span><span class="ident" id="5334681">name</span>&nbsp;<span class="op" id="5334686">!=</span>&nbsp;<span class="ident" id="5334689">name</span>&nbsp;<span class="op" id="5334694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5334700">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5334709">}</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5334713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5334717">if</span>&nbsp;<span class="ident" id="5334720">advance</span>&nbsp;<span class="op" id="5334728">==</span>&nbsp;<span class="num" id="5334731">1</span>&nbsp;<span class="op" id="5334733">{</span>&nbsp;<span class="comment" id="5334735">//&nbsp;Only&nbsp;one&nbsp;field&nbsp;with&nbsp;this&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334771">out</span>&nbsp;<span class="op" id="5334775">=</span>&nbsp;<span class="builtinfunc" id="5334777">append</span><span class="op" id="5334783">(</span><span class="ident" id="5334784">out</span><span class="op" id="5334787">,</span>&nbsp;<span class="ident" id="5334789">fi</span><span class="op" id="5334791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5334796">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5334807">}</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334811">dominant</span><span class="op" id="5334819">,</span>&nbsp;<span class="ident" id="5334821">ok</span>&nbsp;<span class="op" id="5334824">:=</span>&nbsp;<span class="ident" id="5334827">dominantField</span><span class="op" id="5334840">(</span><span class="ident" id="5334841">fields</span><span class="op" id="5334847">[</span><span class="ident" id="5334848">i</span>&nbsp;<span class="op" id="5334850">:</span>&nbsp;<span class="ident" id="5334852">i</span><span class="op" id="5334853">+</span><span class="ident" id="5334854">advance</span><span class="op" id="5334861">]</span><span class="op" id="5334862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5334866">if</span>&nbsp;<span class="ident" id="5334869">ok</span>&nbsp;<span class="op" id="5334872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334877">out</span>&nbsp;<span class="op" id="5334881">=</span>&nbsp;<span class="builtinfunc" id="5334883">append</span><span class="op" id="5334889">(</span><span class="ident" id="5334890">out</span><span class="op" id="5334893">,</span>&nbsp;<span class="ident" id="5334895">dominant</span><span class="op" id="5334903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5334907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5334910">}</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334914">fields</span>&nbsp;<span class="op" id="5334921">=</span>&nbsp;<span class="ident" id="5334923">out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334928">sort</span><span class="op" id="5334932">.</span><span class="ident" id="5334933">Sort</span><span class="op" id="5334937">(</span><span class="ident" id="5334938">byIndex</span><span class="op" id="5334945">(</span><span class="ident" id="5334946">fields</span><span class="op" id="5334952">)</span><span class="op" id="5334953">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5334957">return</span>&nbsp;<span class="ident" id="5334964">fields</span><br>
<span class="lineno">1115</span><span class="op" id="5334971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5334974">//&nbsp;dominantField&nbsp;looks&nbsp;through&nbsp;the&nbsp;fields,&nbsp;all&nbsp;of&nbsp;which&nbsp;are&nbsp;known&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5335043">//&nbsp;have&nbsp;the&nbsp;same&nbsp;name,&nbsp;to&nbsp;find&nbsp;the&nbsp;single&nbsp;field&nbsp;that&nbsp;dominates&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5335110">//&nbsp;others&nbsp;using&nbsp;Go&#39;s&nbsp;embedding&nbsp;rules,&nbsp;modified&nbsp;by&nbsp;the&nbsp;presence&nbsp;of</span><br>
<span class="lineno">1120</span><span class="comment" id="5335176">//&nbsp;JSON&nbsp;tags.&nbsp;If&nbsp;there&nbsp;are&nbsp;multiple&nbsp;top-level&nbsp;fields,&nbsp;the&nbsp;boolean</span><br>
<span class="lineno"></span><span class="comment" id="5335242">//&nbsp;will&nbsp;be&nbsp;false:&nbsp;This&nbsp;condition&nbsp;is&nbsp;an&nbsp;error&nbsp;in&nbsp;Go&nbsp;and&nbsp;we&nbsp;skip&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="5335309">//&nbsp;the&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="5335324">func</span>&nbsp;<span class="ident" id="5335329">dominantField</span><span class="op" id="5335342">(</span><span class="ident" id="5335343">fields</span>&nbsp;<span class="op" id="5335350">[</span><span class="op" id="5335351">]</span><span class="ident" id="5335352">field</span><span class="op" id="5335357">)</span>&nbsp;<span class="op" id="5335359">(</span><span class="ident" id="5335360">field</span><span class="op" id="5335365">,</span>&nbsp;<span class="builtintype" id="5335367">bool</span><span class="op" id="5335371">)</span>&nbsp;<span class="op" id="5335373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5335376">//&nbsp;The&nbsp;fields&nbsp;are&nbsp;sorted&nbsp;in&nbsp;increasing&nbsp;index-length&nbsp;order.&nbsp;The&nbsp;winner</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5335447">//&nbsp;must&nbsp;therefore&nbsp;be&nbsp;one&nbsp;with&nbsp;the&nbsp;shortest&nbsp;index&nbsp;length.&nbsp;Drop&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5335514">//&nbsp;longer&nbsp;entries,&nbsp;which&nbsp;is&nbsp;easy:&nbsp;just&nbsp;truncate&nbsp;the&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5335574">length</span>&nbsp;<span class="op" id="5335581">:=</span>&nbsp;<span class="builtinfunc" id="5335584">len</span><span class="op" id="5335587">(</span><span class="ident" id="5335588">fields</span><span class="op" id="5335594">[</span><span class="num" id="5335595">0</span><span class="op" id="5335596">]</span><span class="op" id="5335597">.</span><span class="ident" id="5335598">index</span><span class="op" id="5335603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5335606">tagged</span>&nbsp;<span class="op" id="5335613">:=</span>&nbsp;<span class="op" id="5335616">-</span><span class="num" id="5335617">1</span>&nbsp;<span class="comment" id="5335619">//&nbsp;Index&nbsp;of&nbsp;first&nbsp;tagged&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5335652">for</span>&nbsp;<span class="ident" id="5335656">i</span><span class="op" id="5335657">,</span>&nbsp;<span class="ident" id="5335659">f</span>&nbsp;<span class="op" id="5335661">:=</span>&nbsp;<span class="keyword" id="5335664">range</span>&nbsp;<span class="ident" id="5335670">fields</span>&nbsp;<span class="op" id="5335677">{</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5335681">if</span>&nbsp;<span class="builtinfunc" id="5335684">len</span><span class="op" id="5335687">(</span><span class="ident" id="5335688">f</span><span class="op" id="5335689">.</span><span class="ident" id="5335690">index</span><span class="op" id="5335695">)</span>&nbsp;<span class="op" id="5335697">&gt;</span>&nbsp;<span class="ident" id="5335699">length</span>&nbsp;<span class="op" id="5335706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5335711">fields</span>&nbsp;<span class="op" id="5335718">=</span>&nbsp;<span class="ident" id="5335720">fields</span><span class="op" id="5335726">[</span><span class="op" id="5335727">:</span><span class="ident" id="5335728">i</span><span class="op" id="5335729">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5335734">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5335742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5335746">if</span>&nbsp;<span class="ident" id="5335749">f</span><span class="op" id="5335750">.</span><span class="ident" id="5335751">tag</span>&nbsp;<span class="op" id="5335755">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5335760">if</span>&nbsp;<span class="ident" id="5335763">tagged</span>&nbsp;<span class="op" id="5335770">&gt;=</span>&nbsp;<span class="num" id="5335773">0</span>&nbsp;<span class="op" id="5335775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5335781">//&nbsp;Multiple&nbsp;tagged&nbsp;fields&nbsp;at&nbsp;the&nbsp;same&nbsp;level:&nbsp;conflict.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5335840">//&nbsp;Return&nbsp;no&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5335864">return</span>&nbsp;<span class="ident" id="5335871">field</span><span class="op" id="5335876">{</span><span class="op" id="5335877">}</span><span class="op" id="5335878">,</span>&nbsp;<span class="builtintype" id="5335880">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5335889">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5335894">tagged</span>&nbsp;<span class="op" id="5335901">=</span>&nbsp;<span class="ident" id="5335903">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5335907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5335910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5335913">if</span>&nbsp;<span class="ident" id="5335916">tagged</span>&nbsp;<span class="op" id="5335923">&gt;=</span>&nbsp;<span class="num" id="5335926">0</span>&nbsp;<span class="op" id="5335928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5335932">return</span>&nbsp;<span class="ident" id="5335939">fields</span><span class="op" id="5335945">[</span><span class="ident" id="5335946">tagged</span><span class="op" id="5335952">]</span><span class="op" id="5335953">,</span>&nbsp;<span class="builtintype" id="5335955">true</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5335961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5335964">//&nbsp;All&nbsp;remaining&nbsp;fields&nbsp;have&nbsp;the&nbsp;same&nbsp;length.&nbsp;If&nbsp;there&#39;s&nbsp;more&nbsp;than&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5336037">//&nbsp;we&nbsp;have&nbsp;a&nbsp;conflict&nbsp;(two&nbsp;fields&nbsp;named&nbsp;&#34;X&#34;&nbsp;at&nbsp;the&nbsp;same&nbsp;level)&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5336108">//&nbsp;return&nbsp;no&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5336129">if</span>&nbsp;<span class="builtinfunc" id="5336132">len</span><span class="op" id="5336135">(</span><span class="ident" id="5336136">fields</span><span class="op" id="5336142">)</span>&nbsp;<span class="op" id="5336144">&gt;</span>&nbsp;<span class="num" id="5336146">1</span>&nbsp;<span class="op" id="5336148">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5336152">return</span>&nbsp;<span class="ident" id="5336159">field</span><span class="op" id="5336164">{</span><span class="op" id="5336165">}</span><span class="op" id="5336166">,</span>&nbsp;<span class="builtintype" id="5336168">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5336175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5336178">return</span>&nbsp;<span class="ident" id="5336185">fields</span><span class="op" id="5336191">[</span><span class="num" id="5336192">0</span><span class="op" id="5336193">]</span><span class="op" id="5336194">,</span>&nbsp;<span class="builtintype" id="5336196">true</span><br>
<span class="lineno"></span><span class="op" id="5336201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1155</span><span class="keyword" id="5336204">var</span>&nbsp;<span class="ident" id="5336208">fieldCache</span>&nbsp;<span class="keyword" id="5336219">struct</span>&nbsp;<span class="op" id="5336226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5336229">sync</span><span class="op" id="5336233">.</span><span class="ident" id="5336234">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5336243">m</span>&nbsp;<span class="keyword" id="5336245">map</span><span class="op" id="5336248">[</span><span class="ident" id="5336249">reflect</span><span class="op" id="5336256">.</span><span class="ident" id="5336257">Type</span><span class="op" id="5336261">]</span><span class="op" id="5336262">[</span><span class="op" id="5336263">]</span><span class="ident" id="5336264">field</span><br>
<span class="lineno"></span><span class="op" id="5336270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1160</span><span class="comment" id="5336273">//&nbsp;cachedTypeFields&nbsp;is&nbsp;like&nbsp;typeFields&nbsp;but&nbsp;uses&nbsp;a&nbsp;cache&nbsp;to&nbsp;avoid&nbsp;repeated&nbsp;work.</span><br>
<span class="lineno"></span><span class="keyword" id="5336353">func</span>&nbsp;<span class="ident" id="5336358">cachedTypeFields</span><span class="op" id="5336374">(</span><span class="ident" id="5336375">t</span>&nbsp;<span class="ident" id="5336377">reflect</span><span class="op" id="5336384">.</span><span class="ident" id="5336385">Type</span><span class="op" id="5336389">)</span>&nbsp;<span class="op" id="5336391">[</span><span class="op" id="5336392">]</span><span class="ident" id="5336393">field</span>&nbsp;<span class="op" id="5336399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5336402">fieldCache</span><span class="op" id="5336412">.</span><span class="ident" id="5336413">RLock</span><span class="op" id="5336418">(</span><span class="op" id="5336419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5336422">f</span>&nbsp;<span class="op" id="5336424">:=</span>&nbsp;<span class="ident" id="5336427">fieldCache</span><span class="op" id="5336437">.</span><span class="ident" id="5336438">m</span><span class="op" id="5336439">[</span><span class="ident" id="5336440">t</span><span class="op" id="5336441">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5336444">fieldCache</span><span class="op" id="5336454">.</span><span class="ident" id="5336455">RUnlock</span><span class="op" id="5336462">(</span><span class="op" id="5336463">)</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5336466">if</span>&nbsp;<span class="ident" id="5336469">f</span>&nbsp;<span class="op" id="5336471">!=</span>&nbsp;<span class="ident" id="5336474">nil</span>&nbsp;<span class="op" id="5336478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5336482">return</span>&nbsp;<span class="ident" id="5336489">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5336492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5336496">//&nbsp;Compute&nbsp;fields&nbsp;without&nbsp;lock.</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5336529">//&nbsp;Might&nbsp;duplicate&nbsp;effort&nbsp;but&nbsp;won&#39;t&nbsp;hold&nbsp;other&nbsp;computations&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5336596">f</span>&nbsp;<span class="op" id="5336598">=</span>&nbsp;<span class="ident" id="5336600">typeFields</span><span class="op" id="5336610">(</span><span class="ident" id="5336611">t</span><span class="op" id="5336612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5336615">if</span>&nbsp;<span class="ident" id="5336618">f</span>&nbsp;<span class="op" id="5336620">==</span>&nbsp;<span class="ident" id="5336623">nil</span>&nbsp;<span class="op" id="5336627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5336631">f</span>&nbsp;<span class="op" id="5336633">=</span>&nbsp;<span class="op" id="5336635">[</span><span class="op" id="5336636">]</span><span class="ident" id="5336637">field</span><span class="op" id="5336642">{</span><span class="op" id="5336643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5336646">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5336650">fieldCache</span><span class="op" id="5336660">.</span><span class="ident" id="5336661">Lock</span><span class="op" id="5336665">(</span><span class="op" id="5336666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5336669">if</span>&nbsp;<span class="ident" id="5336672">fieldCache</span><span class="op" id="5336682">.</span><span class="ident" id="5336683">m</span>&nbsp;<span class="op" id="5336685">==</span>&nbsp;<span class="ident" id="5336688">nil</span>&nbsp;<span class="op" id="5336692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5336696">fieldCache</span><span class="op" id="5336706">.</span><span class="ident" id="5336707">m</span>&nbsp;<span class="op" id="5336709">=</span>&nbsp;<span class="keyword" id="5336711">map</span><span class="op" id="5336714">[</span><span class="ident" id="5336715">reflect</span><span class="op" id="5336722">.</span><span class="ident" id="5336723">Type</span><span class="op" id="5336727">]</span><span class="op" id="5336728">[</span><span class="op" id="5336729">]</span><span class="ident" id="5336730">field</span><span class="op" id="5336735">{</span><span class="op" id="5336736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5336739">}</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5336742">fieldCache</span><span class="op" id="5336752">.</span><span class="ident" id="5336753">m</span><span class="op" id="5336754">[</span><span class="ident" id="5336755">t</span><span class="op" id="5336756">]</span>&nbsp;<span class="op" id="5336758">=</span>&nbsp;<span class="ident" id="5336760">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5336763">fieldCache</span><span class="op" id="5336773">.</span><span class="ident" id="5336774">Unlock</span><span class="op" id="5336780">(</span><span class="op" id="5336781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5336784">return</span>&nbsp;<span class="ident" id="5336791">f</span><br>
<span class="lineno"></span><span class="op" id="5336793">}</span>
</div>
</body>
</html>
