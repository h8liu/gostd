<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/bzip2</h2>
<ul>
<li><a href="/gostd/compress/bzip2/bit_reader.go.html">bit_reader.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2.go.html" class="current">bzip2.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2_test.go.html">bzip2_test.go</a></li>
<li><a href="/gostd/compress/bzip2/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/compress/bzip2/move_to_front.go.html">move_to_front.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4808830">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4808885">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4808939">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4808990">//&nbsp;Package&nbsp;bzip2&nbsp;implements&nbsp;bzip2&nbsp;decompression.</span><br>
<span class="lineno"></span><span class="keyword" id="4809039">package</span>&nbsp;<span class="ident" id="4809047">bzip2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4809054">import</span>&nbsp;<span class="string" id="4809061">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="4809067">//&nbsp;There&#39;s&nbsp;no&nbsp;RFC&nbsp;for&nbsp;bzip2.&nbsp;I&nbsp;used&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for&nbsp;reference&nbsp;and&nbsp;a&nbsp;lot</span><br>
<span class="lineno"></span><span class="comment" id="4809146">//&nbsp;of&nbsp;guessing:&nbsp;http://en.wikipedia.org/wiki/Bzip2</span><br>
<span class="lineno"></span><span class="comment" id="4809197">//&nbsp;The&nbsp;source&nbsp;code&nbsp;to&nbsp;pyflate&nbsp;was&nbsp;useful&nbsp;for&nbsp;debugging:</span><br>
<span class="lineno"></span><span class="comment" id="4809253">//&nbsp;http://www.paul.sladen.org/projects/pyflate</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="4809301">//&nbsp;A&nbsp;StructuralError&nbsp;is&nbsp;returned&nbsp;when&nbsp;the&nbsp;bzip2&nbsp;data&nbsp;is&nbsp;found&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4809369">//&nbsp;syntactically&nbsp;invalid.</span><br>
<span class="lineno"></span><span class="keyword" id="4809395">type</span>&nbsp;<span class="ident" id="4809400">StructuralError</span>&nbsp;<span class="builtintype" id="4809416">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4809424">func</span>&nbsp;<span class="op" id="4809429">(</span><span class="ident" id="4809430">s</span>&nbsp;<span class="ident" id="4809432">StructuralError</span><span class="op" id="4809447">)</span>&nbsp;<span class="ident" id="4809449">Error</span><span class="op" id="4809454">(</span><span class="op" id="4809455">)</span>&nbsp;<span class="builtintype" id="4809457">string</span>&nbsp;<span class="op" id="4809464">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4809467">return</span>&nbsp;<span class="string" id="4809474">&#34;bzip2&nbsp;data&nbsp;invalid:&nbsp;&#34;</span>&nbsp;<span class="op" id="4809497">+</span>&nbsp;<span class="builtintype" id="4809499">string</span><span class="op" id="4809505">(</span><span class="ident" id="4809506">s</span><span class="op" id="4809507">)</span><br>
<span class="lineno"></span><span class="op" id="4809509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4809512">//&nbsp;A&nbsp;reader&nbsp;decompresses&nbsp;bzip2&nbsp;compressed&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4809560">type</span>&nbsp;<span class="ident" id="4809565">reader</span>&nbsp;<span class="keyword" id="4809572">struct</span>&nbsp;<span class="op" id="4809579">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4809582">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4809595">bitReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4809606">fileCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4809619">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4809627">blockCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4809640">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4809648">wantBlockCRC</span>&nbsp;<span class="builtintype" id="4809661">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4809669">setupDone</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4809682">bool</span>&nbsp;<span class="comment" id="4809687">//&nbsp;true&nbsp;if&nbsp;we&nbsp;have&nbsp;parsed&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4809732">blockSize</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4809745">int</span>&nbsp;&nbsp;<span class="comment" id="4809750">//&nbsp;blockSize&nbsp;in&nbsp;bytes,&nbsp;i.e.&nbsp;900&nbsp;*&nbsp;1024.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4809791">eof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4809804">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4809810">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4809823">[</span><span class="op" id="4809824">]</span><span class="builtintype" id="4809825">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4809833">//&nbsp;stores&nbsp;Burrows-Wheeler&nbsp;transformed&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4809878">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4809891">[</span><span class="num" id="4809892">256</span><span class="op" id="4809895">]</span><span class="builtintype" id="4809896">uint</span>&nbsp;<span class="comment" id="4809901">//&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;for&nbsp;the&nbsp;inverse&nbsp;BWT.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4809940">tt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4809953">[</span><span class="op" id="4809954">]</span><span class="builtintype" id="4809955">uint32</span>&nbsp;&nbsp;<span class="comment" id="4809963">//&nbsp;mirrors&nbsp;the&nbsp;`tt&#39;&nbsp;array&nbsp;in&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;and&nbsp;contains&nbsp;the&nbsp;P&nbsp;array&nbsp;in&nbsp;the&nbsp;upper&nbsp;24&nbsp;bits.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4810057">tPos</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4810070">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4810080">//&nbsp;Index&nbsp;of&nbsp;the&nbsp;next&nbsp;output&nbsp;byte&nbsp;in&nbsp;tt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4810122">preRLE</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4810134">[</span><span class="op" id="4810135">]</span><span class="builtintype" id="4810136">uint32</span>&nbsp;<span class="comment" id="4810143">//&nbsp;contains&nbsp;the&nbsp;RLE&nbsp;data&nbsp;still&nbsp;to&nbsp;be&nbsp;processed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4810192">preRLEUsed</span>&nbsp;&nbsp;<span class="builtintype" id="4810204">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4810213">//&nbsp;number&nbsp;of&nbsp;entries&nbsp;of&nbsp;preRLE&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4810251">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4810263">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4810272">//&nbsp;the&nbsp;last&nbsp;byte&nbsp;value&nbsp;seen.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4810302">byteRepeats</span>&nbsp;<span class="builtintype" id="4810314">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4810323">//&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;lastByte&nbsp;seen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4810367">repeats</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4810379">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4810388">//&nbsp;the&nbsp;number&nbsp;of&nbsp;copies&nbsp;of&nbsp;lastByte&nbsp;to&nbsp;output.</span><br>
<span class="lineno"></span><span class="op" id="4810435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4810438">//&nbsp;NewReader&nbsp;returns&nbsp;an&nbsp;io.Reader&nbsp;which&nbsp;decompresses&nbsp;bzip2&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">45</span><span class="comment" id="4810510">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="4810557">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="4810619">func</span>&nbsp;<span class="ident" id="4810624">NewReader</span><span class="op" id="4810633">(</span><span class="ident" id="4810634">r</span>&nbsp;<span class="ident" id="4810636">io</span><span class="op" id="4810638">.</span><span class="ident" id="4810639">Reader</span><span class="op" id="4810645">)</span>&nbsp;<span class="ident" id="4810647">io</span><span class="op" id="4810649">.</span><span class="ident" id="4810650">Reader</span>&nbsp;<span class="op" id="4810657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4810660">bz2</span>&nbsp;<span class="op" id="4810664">:=</span>&nbsp;<span class="builtinfunc" id="4810667">new</span><span class="op" id="4810670">(</span><span class="ident" id="4810671">reader</span><span class="op" id="4810677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4810680">bz2</span><span class="op" id="4810683">.</span><span class="ident" id="4810684">br</span>&nbsp;<span class="op" id="4810687">=</span>&nbsp;<span class="ident" id="4810689">newBitReader</span><span class="op" id="4810701">(</span><span class="ident" id="4810702">r</span><span class="op" id="4810703">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4810706">return</span>&nbsp;<span class="ident" id="4810713">bz2</span><br>
<span class="lineno"></span><span class="op" id="4810717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4810720">const</span>&nbsp;<span class="ident" id="4810726">bzip2FileMagic</span>&nbsp;<span class="op" id="4810741">=</span>&nbsp;<span class="num" id="4810743">0x425a</span>&nbsp;<span class="comment" id="4810750">//&nbsp;&#34;BZ&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="4810758">const</span>&nbsp;<span class="ident" id="4810764">bzip2BlockMagic</span>&nbsp;<span class="op" id="4810780">=</span>&nbsp;<span class="num" id="4810782">0x314159265359</span><br>
<span class="lineno">55</span><span class="keyword" id="4810797">const</span>&nbsp;<span class="ident" id="4810803">bzip2FinalMagic</span>&nbsp;<span class="op" id="4810819">=</span>&nbsp;<span class="num" id="4810821">0x177245385090</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4810837">//&nbsp;setup&nbsp;parses&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="4810871">func</span>&nbsp;<span class="op" id="4810876">(</span><span class="ident" id="4810877">bz2</span>&nbsp;<span class="op" id="4810881">*</span><span class="ident" id="4810882">reader</span><span class="op" id="4810888">)</span>&nbsp;<span class="ident" id="4810890">setup</span><span class="op" id="4810895">(</span><span class="ident" id="4810896">needMagic</span>&nbsp;<span class="builtintype" id="4810906">bool</span><span class="op" id="4810910">)</span>&nbsp;<span class="builtintype" id="4810912">error</span>&nbsp;<span class="op" id="4810918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4810921">br</span>&nbsp;<span class="op" id="4810924">:=</span>&nbsp;<span class="op" id="4810927">&amp;</span><span class="ident" id="4810928">bz2</span><span class="op" id="4810931">.</span><span class="ident" id="4810932">br</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4810937">if</span>&nbsp;<span class="ident" id="4810940">needMagic</span>&nbsp;<span class="op" id="4810950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4810954">magic</span>&nbsp;<span class="op" id="4810960">:=</span>&nbsp;<span class="ident" id="4810963">br</span><span class="op" id="4810965">.</span><span class="ident" id="4810966">ReadBits</span><span class="op" id="4810974">(</span><span class="num" id="4810975">16</span><span class="op" id="4810977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4810981">if</span>&nbsp;<span class="ident" id="4810984">magic</span>&nbsp;<span class="op" id="4810990">!=</span>&nbsp;<span class="ident" id="4810993">bzip2FileMagic</span>&nbsp;<span class="op" id="4811008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811013">return</span>&nbsp;<span class="ident" id="4811020">StructuralError</span><span class="op" id="4811035">(</span><span class="string" id="4811036">&#34;bad&nbsp;magic&nbsp;value&#34;</span><span class="op" id="4811053">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4811057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4811060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811064">t</span>&nbsp;<span class="op" id="4811066">:=</span>&nbsp;<span class="ident" id="4811069">br</span><span class="op" id="4811071">.</span><span class="ident" id="4811072">ReadBits</span><span class="op" id="4811080">(</span><span class="num" id="4811081">8</span><span class="op" id="4811082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811085">if</span>&nbsp;<span class="ident" id="4811088">t</span>&nbsp;<span class="op" id="4811090">!=</span>&nbsp;<span class="string" id="4811093">&#39;h&#39;</span>&nbsp;<span class="op" id="4811097">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811101">return</span>&nbsp;<span class="ident" id="4811108">StructuralError</span><span class="op" id="4811123">(</span><span class="string" id="4811124">&#34;non-Huffman&nbsp;entropy&nbsp;encoding&#34;</span><span class="op" id="4811154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4811157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811161">level</span>&nbsp;<span class="op" id="4811167">:=</span>&nbsp;<span class="ident" id="4811170">br</span><span class="op" id="4811172">.</span><span class="ident" id="4811173">ReadBits</span><span class="op" id="4811181">(</span><span class="num" id="4811182">8</span><span class="op" id="4811183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811186">if</span>&nbsp;<span class="ident" id="4811189">level</span>&nbsp;<span class="op" id="4811195">&lt;</span>&nbsp;<span class="string" id="4811197">&#39;1&#39;</span>&nbsp;<span class="op" id="4811201">||</span>&nbsp;<span class="ident" id="4811204">level</span>&nbsp;<span class="op" id="4811210">&gt;</span>&nbsp;<span class="string" id="4811212">&#39;9&#39;</span>&nbsp;<span class="op" id="4811216">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811220">return</span>&nbsp;<span class="ident" id="4811227">StructuralError</span><span class="op" id="4811242">(</span><span class="string" id="4811243">&#34;invalid&nbsp;compression&nbsp;level&#34;</span><span class="op" id="4811270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4811273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811277">bz2</span><span class="op" id="4811280">.</span><span class="ident" id="4811281">fileCRC</span>&nbsp;<span class="op" id="4811289">=</span>&nbsp;<span class="num" id="4811291">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811294">bz2</span><span class="op" id="4811297">.</span><span class="ident" id="4811298">blockSize</span>&nbsp;<span class="op" id="4811308">=</span>&nbsp;<span class="num" id="4811310">100</span>&nbsp;<span class="op" id="4811314">*</span>&nbsp;<span class="num" id="4811316">1024</span>&nbsp;<span class="op" id="4811321">*</span>&nbsp;<span class="op" id="4811323">(</span><span class="builtintype" id="4811324">int</span><span class="op" id="4811327">(</span><span class="ident" id="4811328">level</span><span class="op" id="4811333">)</span>&nbsp;<span class="op" id="4811335">-</span>&nbsp;<span class="string" id="4811337">&#39;0&#39;</span><span class="op" id="4811340">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811343">if</span>&nbsp;<span class="ident" id="4811346">bz2</span><span class="op" id="4811349">.</span><span class="ident" id="4811350">blockSize</span>&nbsp;<span class="op" id="4811360">&gt;</span>&nbsp;<span class="builtinfunc" id="4811362">len</span><span class="op" id="4811365">(</span><span class="ident" id="4811366">bz2</span><span class="op" id="4811369">.</span><span class="ident" id="4811370">tt</span><span class="op" id="4811372">)</span>&nbsp;<span class="op" id="4811374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811378">bz2</span><span class="op" id="4811381">.</span><span class="ident" id="4811382">tt</span>&nbsp;<span class="op" id="4811385">=</span>&nbsp;<span class="builtinfunc" id="4811387">make</span><span class="op" id="4811391">(</span><span class="op" id="4811392">[</span><span class="op" id="4811393">]</span><span class="builtintype" id="4811394">uint32</span><span class="op" id="4811400">,</span>&nbsp;<span class="ident" id="4811402">bz2</span><span class="op" id="4811405">.</span><span class="ident" id="4811406">blockSize</span><span class="op" id="4811415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4811418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811421">return</span>&nbsp;<span class="ident" id="4811428">nil</span><br>
<span class="lineno"></span><span class="op" id="4811432">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="4811435">func</span>&nbsp;<span class="op" id="4811440">(</span><span class="ident" id="4811441">bz2</span>&nbsp;<span class="op" id="4811445">*</span><span class="ident" id="4811446">reader</span><span class="op" id="4811452">)</span>&nbsp;<span class="ident" id="4811454">Read</span><span class="op" id="4811458">(</span><span class="ident" id="4811459">buf</span>&nbsp;<span class="op" id="4811463">[</span><span class="op" id="4811464">]</span><span class="builtintype" id="4811465">byte</span><span class="op" id="4811469">)</span>&nbsp;<span class="op" id="4811471">(</span><span class="ident" id="4811472">n</span>&nbsp;<span class="builtintype" id="4811474">int</span><span class="op" id="4811477">,</span>&nbsp;<span class="ident" id="4811479">err</span>&nbsp;<span class="builtintype" id="4811483">error</span><span class="op" id="4811488">)</span>&nbsp;<span class="op" id="4811490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811493">if</span>&nbsp;<span class="ident" id="4811496">bz2</span><span class="op" id="4811499">.</span><span class="ident" id="4811500">eof</span>&nbsp;<span class="op" id="4811504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811508">return</span>&nbsp;<span class="num" id="4811515">0</span><span class="op" id="4811516">,</span>&nbsp;<span class="ident" id="4811518">io</span><span class="op" id="4811520">.</span><span class="ident" id="4811521">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4811526">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811530">if</span>&nbsp;<span class="op" id="4811533">!</span><span class="ident" id="4811534">bz2</span><span class="op" id="4811537">.</span><span class="ident" id="4811538">setupDone</span>&nbsp;<span class="op" id="4811548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811552">err</span>&nbsp;<span class="op" id="4811556">=</span>&nbsp;<span class="ident" id="4811558">bz2</span><span class="op" id="4811561">.</span><span class="ident" id="4811562">setup</span><span class="op" id="4811567">(</span><span class="builtintype" id="4811568">true</span><span class="op" id="4811572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811576">brErr</span>&nbsp;<span class="op" id="4811582">:=</span>&nbsp;<span class="ident" id="4811585">bz2</span><span class="op" id="4811588">.</span><span class="ident" id="4811589">br</span><span class="op" id="4811591">.</span><span class="ident" id="4811592">Err</span><span class="op" id="4811595">(</span><span class="op" id="4811596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811600">if</span>&nbsp;<span class="ident" id="4811603">brErr</span>&nbsp;<span class="op" id="4811609">!=</span>&nbsp;<span class="ident" id="4811612">nil</span>&nbsp;<span class="op" id="4811616">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811621">err</span>&nbsp;<span class="op" id="4811625">=</span>&nbsp;<span class="ident" id="4811627">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4811635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811639">if</span>&nbsp;<span class="ident" id="4811642">err</span>&nbsp;<span class="op" id="4811646">!=</span>&nbsp;<span class="ident" id="4811649">nil</span>&nbsp;<span class="op" id="4811653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811658">return</span>&nbsp;<span class="num" id="4811665">0</span><span class="op" id="4811666">,</span>&nbsp;<span class="ident" id="4811668">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4811674">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811678">bz2</span><span class="op" id="4811681">.</span><span class="ident" id="4811682">setupDone</span>&nbsp;<span class="op" id="4811692">=</span>&nbsp;<span class="builtintype" id="4811694">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4811700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811704">n</span><span class="op" id="4811705">,</span>&nbsp;<span class="ident" id="4811707">err</span>&nbsp;<span class="op" id="4811711">=</span>&nbsp;<span class="ident" id="4811713">bz2</span><span class="op" id="4811716">.</span><span class="ident" id="4811717">read</span><span class="op" id="4811721">(</span><span class="ident" id="4811722">buf</span><span class="op" id="4811725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811728">brErr</span>&nbsp;<span class="op" id="4811734">:=</span>&nbsp;<span class="ident" id="4811737">bz2</span><span class="op" id="4811740">.</span><span class="ident" id="4811741">br</span><span class="op" id="4811743">.</span><span class="ident" id="4811744">Err</span><span class="op" id="4811747">(</span><span class="op" id="4811748">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811751">if</span>&nbsp;<span class="ident" id="4811754">brErr</span>&nbsp;<span class="op" id="4811760">!=</span>&nbsp;<span class="ident" id="4811763">nil</span>&nbsp;<span class="op" id="4811767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811771">err</span>&nbsp;<span class="op" id="4811775">=</span>&nbsp;<span class="ident" id="4811777">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4811784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811787">return</span><br>
<span class="lineno"></span><span class="op" id="4811794">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="4811797">func</span>&nbsp;<span class="op" id="4811802">(</span><span class="ident" id="4811803">bz2</span>&nbsp;<span class="op" id="4811807">*</span><span class="ident" id="4811808">reader</span><span class="op" id="4811814">)</span>&nbsp;<span class="ident" id="4811816">readFromBlock</span><span class="op" id="4811829">(</span><span class="ident" id="4811830">buf</span>&nbsp;<span class="op" id="4811834">[</span><span class="op" id="4811835">]</span><span class="builtintype" id="4811836">byte</span><span class="op" id="4811840">)</span>&nbsp;<span class="builtintype" id="4811842">int</span>&nbsp;<span class="op" id="4811846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4811849">//&nbsp;bzip2&nbsp;is&nbsp;a&nbsp;block&nbsp;based&nbsp;compressor,&nbsp;except&nbsp;that&nbsp;it&nbsp;has&nbsp;a&nbsp;run-length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4811920">//&nbsp;preprocessing&nbsp;step.&nbsp;The&nbsp;block&nbsp;based&nbsp;nature&nbsp;means&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4811985">//&nbsp;preallocate&nbsp;fixed-size&nbsp;buffers&nbsp;and&nbsp;reuse&nbsp;them.&nbsp;However,&nbsp;the&nbsp;RLE</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812053">//&nbsp;preprocessing&nbsp;would&nbsp;require&nbsp;allocating&nbsp;huge&nbsp;buffers&nbsp;to&nbsp;store&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812122">//&nbsp;maximum&nbsp;expansion.&nbsp;Thus&nbsp;we&nbsp;process&nbsp;blocks&nbsp;all&nbsp;at&nbsp;once,&nbsp;except&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812192">//&nbsp;the&nbsp;RLE&nbsp;which&nbsp;we&nbsp;decompress&nbsp;as&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812237">n</span>&nbsp;<span class="op" id="4812239">:=</span>&nbsp;<span class="num" id="4812242">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4812245">for</span>&nbsp;<span class="op" id="4812249">(</span><span class="ident" id="4812250">bz2</span><span class="op" id="4812253">.</span><span class="ident" id="4812254">repeats</span>&nbsp;<span class="op" id="4812262">&gt;</span>&nbsp;<span class="num" id="4812264">0</span>&nbsp;<span class="op" id="4812266">||</span>&nbsp;<span class="ident" id="4812269">bz2</span><span class="op" id="4812272">.</span><span class="ident" id="4812273">preRLEUsed</span>&nbsp;<span class="op" id="4812284">&lt;</span>&nbsp;<span class="builtinfunc" id="4812286">len</span><span class="op" id="4812289">(</span><span class="ident" id="4812290">bz2</span><span class="op" id="4812293">.</span><span class="ident" id="4812294">preRLE</span><span class="op" id="4812300">)</span><span class="op" id="4812301">)</span>&nbsp;<span class="op" id="4812303">&amp;&amp;</span>&nbsp;<span class="ident" id="4812306">n</span>&nbsp;<span class="op" id="4812308">&lt;</span>&nbsp;<span class="builtinfunc" id="4812310">len</span><span class="op" id="4812313">(</span><span class="ident" id="4812314">buf</span><span class="op" id="4812317">)</span>&nbsp;<span class="op" id="4812319">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812323">//&nbsp;We&nbsp;have&nbsp;RLE&nbsp;data&nbsp;pending.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812355">//&nbsp;The&nbsp;run-length&nbsp;encoding&nbsp;works&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812401">//&nbsp;Any&nbsp;sequence&nbsp;of&nbsp;four&nbsp;equal&nbsp;bytes&nbsp;is&nbsp;followed&nbsp;by&nbsp;a&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812463">//&nbsp;byte&nbsp;which&nbsp;contains&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;that&nbsp;byte&nbsp;to</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812526">//&nbsp;include.&nbsp;(The&nbsp;number&nbsp;of&nbsp;repeats&nbsp;can&nbsp;be&nbsp;zero.)&nbsp;Because&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812592">//&nbsp;decompressing&nbsp;on-demand&nbsp;our&nbsp;state&nbsp;is&nbsp;kept&nbsp;in&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812653">//&nbsp;object.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4812667">if</span>&nbsp;<span class="ident" id="4812670">bz2</span><span class="op" id="4812673">.</span><span class="ident" id="4812674">repeats</span>&nbsp;<span class="op" id="4812682">&gt;</span>&nbsp;<span class="num" id="4812684">0</span>&nbsp;<span class="op" id="4812686">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812691">buf</span><span class="op" id="4812694">[</span><span class="ident" id="4812695">n</span><span class="op" id="4812696">]</span>&nbsp;<span class="op" id="4812698">=</span>&nbsp;<span class="builtintype" id="4812700">byte</span><span class="op" id="4812704">(</span><span class="ident" id="4812705">bz2</span><span class="op" id="4812708">.</span><span class="ident" id="4812709">lastByte</span><span class="op" id="4812717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812722">n</span><span class="op" id="4812723">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812729">bz2</span><span class="op" id="4812732">.</span><span class="ident" id="4812733">repeats</span><span class="op" id="4812740">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4812746">if</span>&nbsp;<span class="ident" id="4812749">bz2</span><span class="op" id="4812752">.</span><span class="ident" id="4812753">repeats</span>&nbsp;<span class="op" id="4812761">==</span>&nbsp;<span class="num" id="4812764">0</span>&nbsp;<span class="op" id="4812766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812772">bz2</span><span class="op" id="4812775">.</span><span class="ident" id="4812776">lastByte</span>&nbsp;<span class="op" id="4812785">=</span>&nbsp;<span class="op" id="4812787">-</span><span class="num" id="4812788">1</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4812793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4812798">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4812809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812814">bz2</span><span class="op" id="4812817">.</span><span class="ident" id="4812818">tPos</span>&nbsp;<span class="op" id="4812823">=</span>&nbsp;<span class="ident" id="4812825">bz2</span><span class="op" id="4812828">.</span><span class="ident" id="4812829">preRLE</span><span class="op" id="4812835">[</span><span class="ident" id="4812836">bz2</span><span class="op" id="4812839">.</span><span class="ident" id="4812840">tPos</span><span class="op" id="4812844">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812848">b</span>&nbsp;<span class="op" id="4812850">:=</span>&nbsp;<span class="builtintype" id="4812853">byte</span><span class="op" id="4812857">(</span><span class="ident" id="4812858">bz2</span><span class="op" id="4812861">.</span><span class="ident" id="4812862">tPos</span><span class="op" id="4812866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812870">bz2</span><span class="op" id="4812873">.</span><span class="ident" id="4812874">tPos</span>&nbsp;<span class="op" id="4812879">&gt;&gt;=</span>&nbsp;<span class="num" id="4812883">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812887">bz2</span><span class="op" id="4812890">.</span><span class="ident" id="4812891">preRLEUsed</span><span class="op" id="4812901">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4812907">if</span>&nbsp;<span class="ident" id="4812910">bz2</span><span class="op" id="4812913">.</span><span class="ident" id="4812914">byteRepeats</span>&nbsp;<span class="op" id="4812926">==</span>&nbsp;<span class="num" id="4812929">3</span>&nbsp;<span class="op" id="4812931">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812936">bz2</span><span class="op" id="4812939">.</span><span class="ident" id="4812940">repeats</span>&nbsp;<span class="op" id="4812948">=</span>&nbsp;<span class="builtintype" id="4812950">uint</span><span class="op" id="4812954">(</span><span class="ident" id="4812955">b</span><span class="op" id="4812956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812961">bz2</span><span class="op" id="4812964">.</span><span class="ident" id="4812965">byteRepeats</span>&nbsp;<span class="op" id="4812977">=</span>&nbsp;<span class="num" id="4812979">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4812984">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4812995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813000">if</span>&nbsp;<span class="ident" id="4813003">bz2</span><span class="op" id="4813006">.</span><span class="ident" id="4813007">lastByte</span>&nbsp;<span class="op" id="4813016">==</span>&nbsp;<span class="builtintype" id="4813019">int</span><span class="op" id="4813022">(</span><span class="ident" id="4813023">b</span><span class="op" id="4813024">)</span>&nbsp;<span class="op" id="4813026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813031">bz2</span><span class="op" id="4813034">.</span><span class="ident" id="4813035">byteRepeats</span><span class="op" id="4813046">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4813051">}</span>&nbsp;<span class="keyword" id="4813053">else</span>&nbsp;<span class="op" id="4813058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813063">bz2</span><span class="op" id="4813066">.</span><span class="ident" id="4813067">byteRepeats</span>&nbsp;<span class="op" id="4813079">=</span>&nbsp;<span class="num" id="4813081">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4813085">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813089">bz2</span><span class="op" id="4813092">.</span><span class="ident" id="4813093">lastByte</span>&nbsp;<span class="op" id="4813102">=</span>&nbsp;<span class="builtintype" id="4813104">int</span><span class="op" id="4813107">(</span><span class="ident" id="4813108">b</span><span class="op" id="4813109">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813114">buf</span><span class="op" id="4813117">[</span><span class="ident" id="4813118">n</span><span class="op" id="4813119">]</span>&nbsp;<span class="op" id="4813121">=</span>&nbsp;<span class="ident" id="4813123">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813127">n</span><span class="op" id="4813128">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4813132">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813136">return</span>&nbsp;<span class="ident" id="4813143">n</span><br>
<span class="lineno"></span><span class="op" id="4813145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4813148">func</span>&nbsp;<span class="op" id="4813153">(</span><span class="ident" id="4813154">bz2</span>&nbsp;<span class="op" id="4813158">*</span><span class="ident" id="4813159">reader</span><span class="op" id="4813165">)</span>&nbsp;<span class="ident" id="4813167">read</span><span class="op" id="4813171">(</span><span class="ident" id="4813172">buf</span>&nbsp;<span class="op" id="4813176">[</span><span class="op" id="4813177">]</span><span class="builtintype" id="4813178">byte</span><span class="op" id="4813182">)</span>&nbsp;<span class="op" id="4813184">(</span><span class="builtintype" id="4813185">int</span><span class="op" id="4813188">,</span>&nbsp;<span class="builtintype" id="4813190">error</span><span class="op" id="4813195">)</span>&nbsp;<span class="op" id="4813197">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813200">for</span>&nbsp;<span class="op" id="4813204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813208">n</span>&nbsp;<span class="op" id="4813210">:=</span>&nbsp;<span class="ident" id="4813213">bz2</span><span class="op" id="4813216">.</span><span class="ident" id="4813217">readFromBlock</span><span class="op" id="4813230">(</span><span class="ident" id="4813231">buf</span><span class="op" id="4813234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813238">if</span>&nbsp;<span class="ident" id="4813241">n</span>&nbsp;<span class="op" id="4813243">&gt;</span>&nbsp;<span class="num" id="4813245">0</span>&nbsp;<span class="op" id="4813247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813252">bz2</span><span class="op" id="4813255">.</span><span class="ident" id="4813256">blockCRC</span>&nbsp;<span class="op" id="4813265">=</span>&nbsp;<span class="ident" id="4813267">updateCRC</span><span class="op" id="4813276">(</span><span class="ident" id="4813277">bz2</span><span class="op" id="4813280">.</span><span class="ident" id="4813281">blockCRC</span><span class="op" id="4813289">,</span>&nbsp;<span class="ident" id="4813291">buf</span><span class="op" id="4813294">[</span><span class="op" id="4813295">:</span><span class="ident" id="4813296">n</span><span class="op" id="4813297">]</span><span class="op" id="4813298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813303">return</span>&nbsp;<span class="ident" id="4813310">n</span><span class="op" id="4813311">,</span>&nbsp;<span class="ident" id="4813313">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4813319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813324">//&nbsp;End&nbsp;of&nbsp;block.&nbsp;Check&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813354">if</span>&nbsp;<span class="ident" id="4813357">bz2</span><span class="op" id="4813360">.</span><span class="ident" id="4813361">blockCRC</span>&nbsp;<span class="op" id="4813370">!=</span>&nbsp;<span class="ident" id="4813373">bz2</span><span class="op" id="4813376">.</span><span class="ident" id="4813377">wantBlockCRC</span>&nbsp;<span class="op" id="4813390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813395">bz2</span><span class="op" id="4813398">.</span><span class="ident" id="4813399">br</span><span class="op" id="4813401">.</span><span class="ident" id="4813402">err</span>&nbsp;<span class="op" id="4813406">=</span>&nbsp;<span class="ident" id="4813408">StructuralError</span><span class="op" id="4813423">(</span><span class="string" id="4813424">&#34;block&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="4813449">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813454">return</span>&nbsp;<span class="num" id="4813461">0</span><span class="op" id="4813462">,</span>&nbsp;<span class="ident" id="4813464">bz2</span><span class="op" id="4813467">.</span><span class="ident" id="4813468">br</span><span class="op" id="4813470">.</span><span class="ident" id="4813471">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4813477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813482">//&nbsp;Find&nbsp;next&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813504">br</span>&nbsp;<span class="op" id="4813507">:=</span>&nbsp;<span class="op" id="4813510">&amp;</span><span class="ident" id="4813511">bz2</span><span class="op" id="4813514">.</span><span class="ident" id="4813515">br</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813520">switch</span>&nbsp;<span class="ident" id="4813527">br</span><span class="op" id="4813529">.</span><span class="ident" id="4813530">ReadBits64</span><span class="op" id="4813540">(</span><span class="num" id="4813541">48</span><span class="op" id="4813543">)</span>&nbsp;<span class="op" id="4813545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813549">default</span><span class="op" id="4813556">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813561">return</span>&nbsp;<span class="num" id="4813568">0</span><span class="op" id="4813569">,</span>&nbsp;<span class="ident" id="4813571">StructuralError</span><span class="op" id="4813586">(</span><span class="string" id="4813587">&#34;bad&nbsp;magic&nbsp;value&nbsp;found&#34;</span><span class="op" id="4813610">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813615">case</span>&nbsp;<span class="ident" id="4813620">bzip2BlockMagic</span><span class="op" id="4813635">:</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813640">//&nbsp;Start&nbsp;of&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813662">err</span>&nbsp;<span class="op" id="4813666">:=</span>&nbsp;<span class="ident" id="4813669">bz2</span><span class="op" id="4813672">.</span><span class="ident" id="4813673">readBlock</span><span class="op" id="4813682">(</span><span class="op" id="4813683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813688">if</span>&nbsp;<span class="ident" id="4813691">err</span>&nbsp;<span class="op" id="4813695">!=</span>&nbsp;<span class="ident" id="4813698">nil</span>&nbsp;<span class="op" id="4813702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813708">return</span>&nbsp;<span class="num" id="4813715">0</span><span class="op" id="4813716">,</span>&nbsp;<span class="ident" id="4813718">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4813725">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813730">case</span>&nbsp;<span class="ident" id="4813735">bzip2FinalMagic</span><span class="op" id="4813750">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813755">//&nbsp;Check&nbsp;end-of-file&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813784">wantFileCRC</span>&nbsp;<span class="op" id="4813796">:=</span>&nbsp;<span class="builtintype" id="4813799">uint32</span><span class="op" id="4813805">(</span><span class="ident" id="4813806">br</span><span class="op" id="4813808">.</span><span class="ident" id="4813809">ReadBits64</span><span class="op" id="4813819">(</span><span class="num" id="4813820">32</span><span class="op" id="4813822">)</span><span class="op" id="4813823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813828">if</span>&nbsp;<span class="ident" id="4813831">br</span><span class="op" id="4813833">.</span><span class="ident" id="4813834">err</span>&nbsp;<span class="op" id="4813838">!=</span>&nbsp;<span class="ident" id="4813841">nil</span>&nbsp;<span class="op" id="4813845">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813851">return</span>&nbsp;<span class="num" id="4813858">0</span><span class="op" id="4813859">,</span>&nbsp;<span class="ident" id="4813861">br</span><span class="op" id="4813863">.</span><span class="ident" id="4813864">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4813871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813876">if</span>&nbsp;<span class="ident" id="4813879">bz2</span><span class="op" id="4813882">.</span><span class="ident" id="4813883">fileCRC</span>&nbsp;<span class="op" id="4813891">!=</span>&nbsp;<span class="ident" id="4813894">wantFileCRC</span>&nbsp;<span class="op" id="4813906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813912">br</span><span class="op" id="4813914">.</span><span class="ident" id="4813915">err</span>&nbsp;<span class="op" id="4813919">=</span>&nbsp;<span class="ident" id="4813921">StructuralError</span><span class="op" id="4813936">(</span><span class="string" id="4813937">&#34;file&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="4813961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4813967">return</span>&nbsp;<span class="num" id="4813974">0</span><span class="op" id="4813975">,</span>&nbsp;<span class="ident" id="4813977">br</span><span class="op" id="4813979">.</span><span class="ident" id="4813980">err</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4813987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813993">//&nbsp;Skip&nbsp;ahead&nbsp;to&nbsp;byte&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4814028">//&nbsp;Is&nbsp;there&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;to&nbsp;this&nbsp;one?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4814076">//&nbsp;It&nbsp;would&nbsp;start&nbsp;with&nbsp;BZ.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814106">if</span>&nbsp;<span class="ident" id="4814109">br</span><span class="op" id="4814111">.</span><span class="ident" id="4814112">bits</span><span class="op" id="4814116">%</span><span class="num" id="4814117">8</span>&nbsp;<span class="op" id="4814119">!=</span>&nbsp;<span class="num" id="4814122">0</span>&nbsp;<span class="op" id="4814124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814130">br</span><span class="op" id="4814132">.</span><span class="ident" id="4814133">ReadBits</span><span class="op" id="4814141">(</span><span class="ident" id="4814142">br</span><span class="op" id="4814144">.</span><span class="ident" id="4814145">bits</span>&nbsp;<span class="op" id="4814150">%</span>&nbsp;<span class="num" id="4814152">8</span><span class="op" id="4814153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4814158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814163">b</span><span class="op" id="4814164">,</span>&nbsp;<span class="ident" id="4814166">err</span>&nbsp;<span class="op" id="4814170">:=</span>&nbsp;<span class="ident" id="4814173">br</span><span class="op" id="4814175">.</span><span class="ident" id="4814176">r</span><span class="op" id="4814177">.</span><span class="ident" id="4814178">ReadByte</span><span class="op" id="4814186">(</span><span class="op" id="4814187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814192">if</span>&nbsp;<span class="ident" id="4814195">err</span>&nbsp;<span class="op" id="4814199">==</span>&nbsp;<span class="ident" id="4814202">io</span><span class="op" id="4814204">.</span><span class="ident" id="4814205">EOF</span>&nbsp;<span class="op" id="4814209">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814215">br</span><span class="op" id="4814217">.</span><span class="ident" id="4814218">err</span>&nbsp;<span class="op" id="4814222">=</span>&nbsp;<span class="ident" id="4814224">io</span><span class="op" id="4814226">.</span><span class="ident" id="4814227">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814235">bz2</span><span class="op" id="4814238">.</span><span class="ident" id="4814239">eof</span>&nbsp;<span class="op" id="4814243">=</span>&nbsp;<span class="builtintype" id="4814245">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814254">return</span>&nbsp;<span class="num" id="4814261">0</span><span class="op" id="4814262">,</span>&nbsp;<span class="ident" id="4814264">io</span><span class="op" id="4814266">.</span><span class="ident" id="4814267">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4814274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814279">if</span>&nbsp;<span class="ident" id="4814282">err</span>&nbsp;<span class="op" id="4814286">!=</span>&nbsp;<span class="ident" id="4814289">nil</span>&nbsp;<span class="op" id="4814293">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814299">br</span><span class="op" id="4814301">.</span><span class="ident" id="4814302">err</span>&nbsp;<span class="op" id="4814306">=</span>&nbsp;<span class="ident" id="4814308">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814316">return</span>&nbsp;<span class="num" id="4814323">0</span><span class="op" id="4814324">,</span>&nbsp;<span class="ident" id="4814326">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4814333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814338">z</span><span class="op" id="4814339">,</span>&nbsp;<span class="ident" id="4814341">err</span>&nbsp;<span class="op" id="4814345">:=</span>&nbsp;<span class="ident" id="4814348">br</span><span class="op" id="4814350">.</span><span class="ident" id="4814351">r</span><span class="op" id="4814352">.</span><span class="ident" id="4814353">ReadByte</span><span class="op" id="4814361">(</span><span class="op" id="4814362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814367">if</span>&nbsp;<span class="ident" id="4814370">err</span>&nbsp;<span class="op" id="4814374">!=</span>&nbsp;<span class="ident" id="4814377">nil</span>&nbsp;<span class="op" id="4814381">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814387">if</span>&nbsp;<span class="ident" id="4814390">err</span>&nbsp;<span class="op" id="4814394">==</span>&nbsp;<span class="ident" id="4814397">io</span><span class="op" id="4814399">.</span><span class="ident" id="4814400">EOF</span>&nbsp;<span class="op" id="4814404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814411">err</span>&nbsp;<span class="op" id="4814415">=</span>&nbsp;<span class="ident" id="4814417">io</span><span class="op" id="4814419">.</span><span class="ident" id="4814420">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4814441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814447">br</span><span class="op" id="4814449">.</span><span class="ident" id="4814450">err</span>&nbsp;<span class="op" id="4814454">=</span>&nbsp;<span class="ident" id="4814456">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814464">return</span>&nbsp;<span class="num" id="4814471">0</span><span class="op" id="4814472">,</span>&nbsp;<span class="ident" id="4814474">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4814481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814486">if</span>&nbsp;<span class="ident" id="4814489">b</span>&nbsp;<span class="op" id="4814491">!=</span>&nbsp;<span class="string" id="4814494">&#39;B&#39;</span>&nbsp;<span class="op" id="4814498">||</span>&nbsp;<span class="ident" id="4814501">z</span>&nbsp;<span class="op" id="4814503">!=</span>&nbsp;<span class="string" id="4814506">&#39;Z&#39;</span>&nbsp;<span class="op" id="4814510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814516">return</span>&nbsp;<span class="num" id="4814523">0</span><span class="op" id="4814524">,</span>&nbsp;<span class="ident" id="4814526">StructuralError</span><span class="op" id="4814541">(</span><span class="string" id="4814542">&#34;bad&nbsp;magic&nbsp;value&nbsp;in&nbsp;continuation&nbsp;file&#34;</span><span class="op" id="4814580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4814585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814590">if</span>&nbsp;<span class="ident" id="4814593">err</span>&nbsp;<span class="op" id="4814597">:=</span>&nbsp;<span class="ident" id="4814600">bz2</span><span class="op" id="4814603">.</span><span class="ident" id="4814604">setup</span><span class="op" id="4814609">(</span><span class="builtintype" id="4814610">false</span><span class="op" id="4814615">)</span><span class="op" id="4814616">;</span>&nbsp;<span class="ident" id="4814618">err</span>&nbsp;<span class="op" id="4814622">!=</span>&nbsp;<span class="ident" id="4814625">nil</span>&nbsp;<span class="op" id="4814629">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814635">return</span>&nbsp;<span class="num" id="4814642">0</span><span class="op" id="4814643">,</span>&nbsp;<span class="ident" id="4814645">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4814652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4814656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4814659">}</span><br>
<span class="lineno"></span><span class="op" id="4814661">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="4814664">//&nbsp;readBlock&nbsp;reads&nbsp;a&nbsp;bzip2&nbsp;block.&nbsp;The&nbsp;magic&nbsp;number&nbsp;should&nbsp;already&nbsp;have&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span><span class="keyword" id="4814750">func</span>&nbsp;<span class="op" id="4814755">(</span><span class="ident" id="4814756">bz2</span>&nbsp;<span class="op" id="4814760">*</span><span class="ident" id="4814761">reader</span><span class="op" id="4814767">)</span>&nbsp;<span class="ident" id="4814769">readBlock</span><span class="op" id="4814778">(</span><span class="op" id="4814779">)</span>&nbsp;<span class="op" id="4814781">(</span><span class="ident" id="4814782">err</span>&nbsp;<span class="builtintype" id="4814786">error</span><span class="op" id="4814791">)</span>&nbsp;<span class="op" id="4814793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814796">br</span>&nbsp;<span class="op" id="4814799">:=</span>&nbsp;<span class="op" id="4814802">&amp;</span><span class="ident" id="4814803">bz2</span><span class="op" id="4814806">.</span><span class="ident" id="4814807">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814811">bz2</span><span class="op" id="4814814">.</span><span class="ident" id="4814815">wantBlockCRC</span>&nbsp;<span class="op" id="4814828">=</span>&nbsp;<span class="builtintype" id="4814830">uint32</span><span class="op" id="4814836">(</span><span class="ident" id="4814837">br</span><span class="op" id="4814839">.</span><span class="ident" id="4814840">ReadBits64</span><span class="op" id="4814850">(</span><span class="num" id="4814851">32</span><span class="op" id="4814853">)</span><span class="op" id="4814854">)</span>&nbsp;<span class="comment" id="4814856">//&nbsp;skip&nbsp;checksum.&nbsp;TODO:&nbsp;check&nbsp;it&nbsp;if&nbsp;we&nbsp;can&nbsp;figure&nbsp;out&nbsp;what&nbsp;it&nbsp;is.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814923">bz2</span><span class="op" id="4814926">.</span><span class="ident" id="4814927">blockCRC</span>&nbsp;<span class="op" id="4814936">=</span>&nbsp;<span class="num" id="4814938">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814941">bz2</span><span class="op" id="4814944">.</span><span class="ident" id="4814945">fileCRC</span>&nbsp;<span class="op" id="4814953">=</span>&nbsp;<span class="op" id="4814955">(</span><span class="ident" id="4814956">bz2</span><span class="op" id="4814959">.</span><span class="ident" id="4814960">fileCRC</span><span class="op" id="4814967">&lt;&lt;</span><span class="num" id="4814969">1</span>&nbsp;<span class="op" id="4814971">|</span>&nbsp;<span class="ident" id="4814973">bz2</span><span class="op" id="4814976">.</span><span class="ident" id="4814977">fileCRC</span><span class="op" id="4814984">&gt;&gt;</span><span class="num" id="4814986">31</span><span class="op" id="4814988">)</span>&nbsp;<span class="op" id="4814990">^</span>&nbsp;<span class="ident" id="4814992">bz2</span><span class="op" id="4814995">.</span><span class="ident" id="4814996">wantBlockCRC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815010">randomized</span>&nbsp;<span class="op" id="4815021">:=</span>&nbsp;<span class="ident" id="4815024">br</span><span class="op" id="4815026">.</span><span class="ident" id="4815027">ReadBits</span><span class="op" id="4815035">(</span><span class="num" id="4815036">1</span><span class="op" id="4815037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815040">if</span>&nbsp;<span class="ident" id="4815043">randomized</span>&nbsp;<span class="op" id="4815054">!=</span>&nbsp;<span class="num" id="4815057">0</span>&nbsp;<span class="op" id="4815059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815063">return</span>&nbsp;<span class="ident" id="4815070">StructuralError</span><span class="op" id="4815085">(</span><span class="string" id="4815086">&#34;deprecated&nbsp;randomized&nbsp;files&#34;</span><span class="op" id="4815115">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815121">origPtr</span>&nbsp;<span class="op" id="4815129">:=</span>&nbsp;<span class="builtintype" id="4815132">uint</span><span class="op" id="4815136">(</span><span class="ident" id="4815137">br</span><span class="op" id="4815139">.</span><span class="ident" id="4815140">ReadBits</span><span class="op" id="4815148">(</span><span class="num" id="4815149">24</span><span class="op" id="4815151">)</span><span class="op" id="4815152">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4815156">//&nbsp;If&nbsp;not&nbsp;every&nbsp;byte&nbsp;value&nbsp;is&nbsp;used&nbsp;in&nbsp;the&nbsp;block&nbsp;(i.e.,&nbsp;it&#39;s&nbsp;text)&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4815228">//&nbsp;the&nbsp;symbol&nbsp;set&nbsp;is&nbsp;reduced.&nbsp;The&nbsp;symbols&nbsp;used&nbsp;are&nbsp;stored&nbsp;as&nbsp;a</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4815292">//&nbsp;two-level,&nbsp;16x16&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815321">symbolRangeUsedBitmap</span>&nbsp;<span class="op" id="4815343">:=</span>&nbsp;<span class="ident" id="4815346">br</span><span class="op" id="4815348">.</span><span class="ident" id="4815349">ReadBits</span><span class="op" id="4815357">(</span><span class="num" id="4815358">16</span><span class="op" id="4815360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815363">symbolPresent</span>&nbsp;<span class="op" id="4815377">:=</span>&nbsp;<span class="builtinfunc" id="4815380">make</span><span class="op" id="4815384">(</span><span class="op" id="4815385">[</span><span class="op" id="4815386">]</span><span class="builtintype" id="4815387">bool</span><span class="op" id="4815391">,</span>&nbsp;<span class="num" id="4815393">256</span><span class="op" id="4815396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815399">numSymbols</span>&nbsp;<span class="op" id="4815410">:=</span>&nbsp;<span class="num" id="4815413">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815416">for</span>&nbsp;<span class="ident" id="4815420">symRange</span>&nbsp;<span class="op" id="4815429">:=</span>&nbsp;<span class="builtintype" id="4815432">uint</span><span class="op" id="4815436">(</span><span class="num" id="4815437">0</span><span class="op" id="4815438">)</span><span class="op" id="4815439">;</span>&nbsp;<span class="ident" id="4815441">symRange</span>&nbsp;<span class="op" id="4815450">&lt;</span>&nbsp;<span class="num" id="4815452">16</span><span class="op" id="4815454">;</span>&nbsp;<span class="ident" id="4815456">symRange</span><span class="op" id="4815464">++</span>&nbsp;<span class="op" id="4815467">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815471">if</span>&nbsp;<span class="ident" id="4815474">symbolRangeUsedBitmap</span><span class="op" id="4815495">&amp;</span><span class="op" id="4815496">(</span><span class="num" id="4815497">1</span><span class="op" id="4815498">&lt;&lt;</span><span class="op" id="4815500">(</span><span class="num" id="4815501">15</span><span class="op" id="4815503">-</span><span class="ident" id="4815504">symRange</span><span class="op" id="4815512">)</span><span class="op" id="4815513">)</span>&nbsp;<span class="op" id="4815515">!=</span>&nbsp;<span class="num" id="4815518">0</span>&nbsp;<span class="op" id="4815520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815525">bits</span>&nbsp;<span class="op" id="4815530">:=</span>&nbsp;<span class="ident" id="4815533">br</span><span class="op" id="4815535">.</span><span class="ident" id="4815536">ReadBits</span><span class="op" id="4815544">(</span><span class="num" id="4815545">16</span><span class="op" id="4815547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815552">for</span>&nbsp;<span class="ident" id="4815556">symbol</span>&nbsp;<span class="op" id="4815563">:=</span>&nbsp;<span class="builtintype" id="4815566">uint</span><span class="op" id="4815570">(</span><span class="num" id="4815571">0</span><span class="op" id="4815572">)</span><span class="op" id="4815573">;</span>&nbsp;<span class="ident" id="4815575">symbol</span>&nbsp;<span class="op" id="4815582">&lt;</span>&nbsp;<span class="num" id="4815584">16</span><span class="op" id="4815586">;</span>&nbsp;<span class="ident" id="4815588">symbol</span><span class="op" id="4815594">++</span>&nbsp;<span class="op" id="4815597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815603">if</span>&nbsp;<span class="ident" id="4815606">bits</span><span class="op" id="4815610">&amp;</span><span class="op" id="4815611">(</span><span class="num" id="4815612">1</span><span class="op" id="4815613">&lt;&lt;</span><span class="op" id="4815615">(</span><span class="num" id="4815616">15</span><span class="op" id="4815618">-</span><span class="ident" id="4815619">symbol</span><span class="op" id="4815625">)</span><span class="op" id="4815626">)</span>&nbsp;<span class="op" id="4815628">!=</span>&nbsp;<span class="num" id="4815631">0</span>&nbsp;<span class="op" id="4815633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815640">symbolPresent</span><span class="op" id="4815653">[</span><span class="num" id="4815654">16</span><span class="op" id="4815656">*</span><span class="ident" id="4815657">symRange</span><span class="op" id="4815665">+</span><span class="ident" id="4815666">symbol</span><span class="op" id="4815672">]</span>&nbsp;<span class="op" id="4815674">=</span>&nbsp;<span class="builtintype" id="4815676">true</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815686">numSymbols</span><span class="op" id="4815696">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815715">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815719">if</span>&nbsp;<span class="ident" id="4815722">numSymbols</span>&nbsp;<span class="op" id="4815733">==</span>&nbsp;<span class="num" id="4815736">0</span>&nbsp;<span class="op" id="4815738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4815742">//&nbsp;There&nbsp;must&nbsp;be&nbsp;an&nbsp;EOF&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815776">return</span>&nbsp;<span class="ident" id="4815783">StructuralError</span><span class="op" id="4815798">(</span><span class="string" id="4815799">&#34;no&nbsp;symbols&nbsp;in&nbsp;input&#34;</span><span class="op" id="4815820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815823">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4815827">//&nbsp;A&nbsp;block&nbsp;uses&nbsp;between&nbsp;two&nbsp;and&nbsp;six&nbsp;different&nbsp;Huffman&nbsp;trees.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815889">numHuffmanTrees</span>&nbsp;<span class="op" id="4815905">:=</span>&nbsp;<span class="ident" id="4815908">br</span><span class="op" id="4815910">.</span><span class="ident" id="4815911">ReadBits</span><span class="op" id="4815919">(</span><span class="num" id="4815920">3</span><span class="op" id="4815921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815924">if</span>&nbsp;<span class="ident" id="4815927">numHuffmanTrees</span>&nbsp;<span class="op" id="4815943">&lt;</span>&nbsp;<span class="num" id="4815945">2</span>&nbsp;<span class="op" id="4815947">||</span>&nbsp;<span class="ident" id="4815950">numHuffmanTrees</span>&nbsp;<span class="op" id="4815966">&gt;</span>&nbsp;<span class="num" id="4815968">6</span>&nbsp;<span class="op" id="4815970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815974">return</span>&nbsp;<span class="ident" id="4815981">StructuralError</span><span class="op" id="4815996">(</span><span class="string" id="4815997">&#34;invalid&nbsp;number&nbsp;of&nbsp;Huffman&nbsp;trees&#34;</span><span class="op" id="4816030">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4816037">//&nbsp;The&nbsp;Huffman&nbsp;tree&nbsp;can&nbsp;switch&nbsp;every&nbsp;50&nbsp;symbols&nbsp;so&nbsp;there&#39;s&nbsp;a&nbsp;list&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4816107">//&nbsp;tree&nbsp;indexes&nbsp;telling&nbsp;us&nbsp;which&nbsp;tree&nbsp;to&nbsp;use&nbsp;for&nbsp;each&nbsp;50&nbsp;symbol&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816179">numSelectors</span>&nbsp;<span class="op" id="4816192">:=</span>&nbsp;<span class="ident" id="4816195">br</span><span class="op" id="4816197">.</span><span class="ident" id="4816198">ReadBits</span><span class="op" id="4816206">(</span><span class="num" id="4816207">15</span><span class="op" id="4816209">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816212">treeIndexes</span>&nbsp;<span class="op" id="4816224">:=</span>&nbsp;<span class="builtinfunc" id="4816227">make</span><span class="op" id="4816231">(</span><span class="op" id="4816232">[</span><span class="op" id="4816233">]</span><span class="builtintype" id="4816234">uint8</span><span class="op" id="4816239">,</span>&nbsp;<span class="ident" id="4816241">numSelectors</span><span class="op" id="4816253">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4816257">//&nbsp;The&nbsp;tree&nbsp;indexes&nbsp;are&nbsp;move-to-front&nbsp;transformed&nbsp;and&nbsp;stored&nbsp;as&nbsp;unary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4816328">//&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816341">mtfTreeDecoder</span>&nbsp;<span class="op" id="4816356">:=</span>&nbsp;<span class="ident" id="4816359">newMTFDecoderWithRange</span><span class="op" id="4816381">(</span><span class="ident" id="4816382">numHuffmanTrees</span><span class="op" id="4816397">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816400">for</span>&nbsp;<span class="ident" id="4816404">i</span>&nbsp;<span class="op" id="4816406">:=</span>&nbsp;<span class="keyword" id="4816409">range</span>&nbsp;<span class="ident" id="4816415">treeIndexes</span>&nbsp;<span class="op" id="4816427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816431">c</span>&nbsp;<span class="op" id="4816433">:=</span>&nbsp;<span class="num" id="4816436">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816440">for</span>&nbsp;<span class="op" id="4816444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816449">inc</span>&nbsp;<span class="op" id="4816453">:=</span>&nbsp;<span class="ident" id="4816456">br</span><span class="op" id="4816458">.</span><span class="ident" id="4816459">ReadBits</span><span class="op" id="4816467">(</span><span class="num" id="4816468">1</span><span class="op" id="4816469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816474">if</span>&nbsp;<span class="ident" id="4816477">inc</span>&nbsp;<span class="op" id="4816481">==</span>&nbsp;<span class="num" id="4816484">0</span>&nbsp;<span class="op" id="4816486">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816492">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816506">c</span><span class="op" id="4816507">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816516">if</span>&nbsp;<span class="ident" id="4816519">c</span>&nbsp;<span class="op" id="4816521">&gt;=</span>&nbsp;<span class="ident" id="4816524">numHuffmanTrees</span>&nbsp;<span class="op" id="4816540">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816545">return</span>&nbsp;<span class="ident" id="4816552">StructuralError</span><span class="op" id="4816567">(</span><span class="string" id="4816568">&#34;tree&nbsp;index&nbsp;too&nbsp;large&#34;</span><span class="op" id="4816590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816598">treeIndexes</span><span class="op" id="4816609">[</span><span class="ident" id="4816610">i</span><span class="op" id="4816611">]</span>&nbsp;<span class="op" id="4816613">=</span>&nbsp;<span class="builtintype" id="4816615">uint8</span><span class="op" id="4816620">(</span><span class="ident" id="4816621">mtfTreeDecoder</span><span class="op" id="4816635">.</span><span class="ident" id="4816636">Decode</span><span class="op" id="4816642">(</span><span class="ident" id="4816643">c</span><span class="op" id="4816644">)</span><span class="op" id="4816645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4816652">//&nbsp;The&nbsp;list&nbsp;of&nbsp;symbols&nbsp;for&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;taken&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4816722">//&nbsp;the&nbsp;previously&nbsp;decoded&nbsp;symbol&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816764">symbols</span>&nbsp;<span class="op" id="4816772">:=</span>&nbsp;<span class="builtinfunc" id="4816775">make</span><span class="op" id="4816779">(</span><span class="op" id="4816780">[</span><span class="op" id="4816781">]</span><span class="builtintype" id="4816782">byte</span><span class="op" id="4816786">,</span>&nbsp;<span class="ident" id="4816788">numSymbols</span><span class="op" id="4816798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816801">nextSymbol</span>&nbsp;<span class="op" id="4816812">:=</span>&nbsp;<span class="num" id="4816815">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816818">for</span>&nbsp;<span class="ident" id="4816822">i</span>&nbsp;<span class="op" id="4816824">:=</span>&nbsp;<span class="num" id="4816827">0</span><span class="op" id="4816828">;</span>&nbsp;<span class="ident" id="4816830">i</span>&nbsp;<span class="op" id="4816832">&lt;</span>&nbsp;<span class="num" id="4816834">256</span><span class="op" id="4816837">;</span>&nbsp;<span class="ident" id="4816839">i</span><span class="op" id="4816840">++</span>&nbsp;<span class="op" id="4816843">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816847">if</span>&nbsp;<span class="ident" id="4816850">symbolPresent</span><span class="op" id="4816863">[</span><span class="ident" id="4816864">i</span><span class="op" id="4816865">]</span>&nbsp;<span class="op" id="4816867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816872">symbols</span><span class="op" id="4816879">[</span><span class="ident" id="4816880">nextSymbol</span><span class="op" id="4816890">]</span>&nbsp;<span class="op" id="4816892">=</span>&nbsp;<span class="builtintype" id="4816894">byte</span><span class="op" id="4816898">(</span><span class="ident" id="4816899">i</span><span class="op" id="4816900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816905">nextSymbol</span><span class="op" id="4816915">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816923">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816926">mtf</span>&nbsp;<span class="op" id="4816930">:=</span>&nbsp;<span class="ident" id="4816933">newMTFDecoder</span><span class="op" id="4816946">(</span><span class="ident" id="4816947">symbols</span><span class="op" id="4816954">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816958">numSymbols</span>&nbsp;<span class="op" id="4816969">+=</span>&nbsp;<span class="num" id="4816972">2</span>&nbsp;<span class="comment" id="4816974">//&nbsp;to&nbsp;account&nbsp;for&nbsp;RUNA&nbsp;and&nbsp;RUNB&nbsp;symbols</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817015">huffmanTrees</span>&nbsp;<span class="op" id="4817028">:=</span>&nbsp;<span class="builtinfunc" id="4817031">make</span><span class="op" id="4817035">(</span><span class="op" id="4817036">[</span><span class="op" id="4817037">]</span><span class="ident" id="4817038">huffmanTree</span><span class="op" id="4817049">,</span>&nbsp;<span class="ident" id="4817051">numHuffmanTrees</span><span class="op" id="4817066">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4817070">//&nbsp;Now&nbsp;we&nbsp;decode&nbsp;the&nbsp;arrays&nbsp;of&nbsp;code-lengths&nbsp;for&nbsp;each&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817130">lengths</span>&nbsp;<span class="op" id="4817138">:=</span>&nbsp;<span class="builtinfunc" id="4817141">make</span><span class="op" id="4817145">(</span><span class="op" id="4817146">[</span><span class="op" id="4817147">]</span><span class="builtintype" id="4817148">uint8</span><span class="op" id="4817153">,</span>&nbsp;<span class="ident" id="4817155">numSymbols</span><span class="op" id="4817165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817168">for</span>&nbsp;<span class="ident" id="4817172">i</span>&nbsp;<span class="op" id="4817174">:=</span>&nbsp;<span class="keyword" id="4817177">range</span>&nbsp;<span class="ident" id="4817183">huffmanTrees</span>&nbsp;<span class="op" id="4817196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4817200">//&nbsp;The&nbsp;code&nbsp;lengths&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;from&nbsp;a&nbsp;5-bit&nbsp;base&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817265">length</span>&nbsp;<span class="op" id="4817272">:=</span>&nbsp;<span class="ident" id="4817275">br</span><span class="op" id="4817277">.</span><span class="ident" id="4817278">ReadBits</span><span class="op" id="4817286">(</span><span class="num" id="4817287">5</span><span class="op" id="4817288">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817292">for</span>&nbsp;<span class="ident" id="4817296">j</span>&nbsp;<span class="op" id="4817298">:=</span>&nbsp;<span class="keyword" id="4817301">range</span>&nbsp;<span class="ident" id="4817307">lengths</span>&nbsp;<span class="op" id="4817315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817320">for</span>&nbsp;<span class="op" id="4817324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817330">if</span>&nbsp;<span class="op" id="4817333">!</span><span class="ident" id="4817334">br</span><span class="op" id="4817336">.</span><span class="ident" id="4817337">ReadBit</span><span class="op" id="4817344">(</span><span class="op" id="4817345">)</span>&nbsp;<span class="op" id="4817347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817354">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817364">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817370">if</span>&nbsp;<span class="ident" id="4817373">br</span><span class="op" id="4817375">.</span><span class="ident" id="4817376">ReadBit</span><span class="op" id="4817383">(</span><span class="op" id="4817384">)</span>&nbsp;<span class="op" id="4817386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817393">length</span><span class="op" id="4817399">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817406">}</span>&nbsp;<span class="keyword" id="4817408">else</span>&nbsp;<span class="op" id="4817413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817420">length</span><span class="op" id="4817426">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817433">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817443">if</span>&nbsp;<span class="ident" id="4817446">length</span>&nbsp;<span class="op" id="4817453">&lt;</span>&nbsp;<span class="num" id="4817455">0</span>&nbsp;<span class="op" id="4817457">||</span>&nbsp;<span class="ident" id="4817460">length</span>&nbsp;<span class="op" id="4817467">&gt;</span>&nbsp;<span class="num" id="4817469">20</span>&nbsp;<span class="op" id="4817472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817478">return</span>&nbsp;<span class="ident" id="4817485">StructuralError</span><span class="op" id="4817500">(</span><span class="string" id="4817501">&#34;Huffman&nbsp;length&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="4817530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817540">lengths</span><span class="op" id="4817547">[</span><span class="ident" id="4817548">j</span><span class="op" id="4817549">]</span>&nbsp;<span class="op" id="4817551">=</span>&nbsp;<span class="builtintype" id="4817553">uint8</span><span class="op" id="4817558">(</span><span class="ident" id="4817559">length</span><span class="op" id="4817565">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817573">huffmanTrees</span><span class="op" id="4817585">[</span><span class="ident" id="4817586">i</span><span class="op" id="4817587">]</span><span class="op" id="4817588">,</span>&nbsp;<span class="ident" id="4817590">err</span>&nbsp;<span class="op" id="4817594">=</span>&nbsp;<span class="ident" id="4817596">newHuffmanTree</span><span class="op" id="4817610">(</span><span class="ident" id="4817611">lengths</span><span class="op" id="4817618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817622">if</span>&nbsp;<span class="ident" id="4817625">err</span>&nbsp;<span class="op" id="4817629">!=</span>&nbsp;<span class="ident" id="4817632">nil</span>&nbsp;<span class="op" id="4817636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817641">return</span>&nbsp;<span class="ident" id="4817648">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817654">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817661">selectorIndex</span>&nbsp;<span class="op" id="4817675">:=</span>&nbsp;<span class="num" id="4817678">1</span>&nbsp;<span class="comment" id="4817680">//&nbsp;the&nbsp;next&nbsp;tree&nbsp;index&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817711">if</span>&nbsp;<span class="builtinfunc" id="4817714">len</span><span class="op" id="4817717">(</span><span class="ident" id="4817718">treeIndexes</span><span class="op" id="4817729">)</span>&nbsp;<span class="op" id="4817731">==</span>&nbsp;<span class="num" id="4817734">0</span>&nbsp;<span class="op" id="4817736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817740">return</span>&nbsp;<span class="ident" id="4817747">StructuralError</span><span class="op" id="4817762">(</span><span class="string" id="4817763">&#34;no&nbsp;tree&nbsp;selectors&nbsp;given&#34;</span><span class="op" id="4817788">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817794">if</span>&nbsp;<span class="builtintype" id="4817797">int</span><span class="op" id="4817800">(</span><span class="ident" id="4817801">treeIndexes</span><span class="op" id="4817812">[</span><span class="num" id="4817813">0</span><span class="op" id="4817814">]</span><span class="op" id="4817815">)</span>&nbsp;<span class="op" id="4817817">&gt;=</span>&nbsp;<span class="builtinfunc" id="4817820">len</span><span class="op" id="4817823">(</span><span class="ident" id="4817824">huffmanTrees</span><span class="op" id="4817836">)</span>&nbsp;<span class="op" id="4817838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817842">return</span>&nbsp;<span class="ident" id="4817849">StructuralError</span><span class="op" id="4817864">(</span><span class="string" id="4817865">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="4817893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817899">currentHuffmanTree</span>&nbsp;<span class="op" id="4817918">:=</span>&nbsp;<span class="ident" id="4817921">huffmanTrees</span><span class="op" id="4817933">[</span><span class="ident" id="4817934">treeIndexes</span><span class="op" id="4817945">[</span><span class="num" id="4817946">0</span><span class="op" id="4817947">]</span><span class="op" id="4817948">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817951">bufIndex</span>&nbsp;<span class="op" id="4817960">:=</span>&nbsp;<span class="num" id="4817963">0</span>&nbsp;<span class="comment" id="4817965">//&nbsp;indexes&nbsp;bz2.buf,&nbsp;the&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4818005">//&nbsp;The&nbsp;output&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;run-length&nbsp;encoded&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4818077">//&nbsp;we&nbsp;merge&nbsp;the&nbsp;decoding&nbsp;into&nbsp;the&nbsp;Huffman&nbsp;parsing&nbsp;loop.&nbsp;These&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4818144">//&nbsp;variables&nbsp;accumulate&nbsp;the&nbsp;repeat&nbsp;count.&nbsp;See&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4818214">//&nbsp;details.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818227">repeat</span>&nbsp;<span class="op" id="4818234">:=</span>&nbsp;<span class="num" id="4818237">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818240">repeat_power</span>&nbsp;<span class="op" id="4818253">:=</span>&nbsp;<span class="num" id="4818256">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4818260">//&nbsp;The&nbsp;`C&#39;&nbsp;array&nbsp;(used&nbsp;by&nbsp;the&nbsp;inverse&nbsp;BWT)&nbsp;needs&nbsp;to&nbsp;be&nbsp;zero&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818334">for</span>&nbsp;<span class="ident" id="4818338">i</span>&nbsp;<span class="op" id="4818340">:=</span>&nbsp;<span class="keyword" id="4818343">range</span>&nbsp;<span class="ident" id="4818349">bz2</span><span class="op" id="4818352">.</span><span class="ident" id="4818353">c</span>&nbsp;<span class="op" id="4818355">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818359">bz2</span><span class="op" id="4818362">.</span><span class="ident" id="4818363">c</span><span class="op" id="4818364">[</span><span class="ident" id="4818365">i</span><span class="op" id="4818366">]</span>&nbsp;<span class="op" id="4818368">=</span>&nbsp;<span class="num" id="4818370">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818377">decoded</span>&nbsp;<span class="op" id="4818385">:=</span>&nbsp;<span class="num" id="4818388">0</span>&nbsp;<span class="comment" id="4818390">//&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;symbols&nbsp;decoded&nbsp;by&nbsp;the&nbsp;current&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818452">for</span>&nbsp;<span class="op" id="4818456">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818460">if</span>&nbsp;<span class="ident" id="4818463">decoded</span>&nbsp;<span class="op" id="4818471">==</span>&nbsp;<span class="num" id="4818474">50</span>&nbsp;<span class="op" id="4818477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818482">if</span>&nbsp;<span class="ident" id="4818485">selectorIndex</span>&nbsp;<span class="op" id="4818499">&gt;=</span>&nbsp;<span class="ident" id="4818502">numSelectors</span>&nbsp;<span class="op" id="4818515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818521">return</span>&nbsp;<span class="ident" id="4818528">StructuralError</span><span class="op" id="4818543">(</span><span class="string" id="4818544">&#34;insufficient&nbsp;selector&nbsp;indices&nbsp;for&nbsp;number&nbsp;of&nbsp;symbols&#34;</span><span class="op" id="4818597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818607">if</span>&nbsp;<span class="builtintype" id="4818610">int</span><span class="op" id="4818613">(</span><span class="ident" id="4818614">treeIndexes</span><span class="op" id="4818625">[</span><span class="ident" id="4818626">selectorIndex</span><span class="op" id="4818639">]</span><span class="op" id="4818640">)</span>&nbsp;<span class="op" id="4818642">&gt;=</span>&nbsp;<span class="builtinfunc" id="4818645">len</span><span class="op" id="4818648">(</span><span class="ident" id="4818649">huffmanTrees</span><span class="op" id="4818661">)</span>&nbsp;<span class="op" id="4818663">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818669">return</span>&nbsp;<span class="ident" id="4818676">StructuralError</span><span class="op" id="4818691">(</span><span class="string" id="4818692">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="4818720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818730">currentHuffmanTree</span>&nbsp;<span class="op" id="4818749">=</span>&nbsp;<span class="ident" id="4818751">huffmanTrees</span><span class="op" id="4818763">[</span><span class="ident" id="4818764">treeIndexes</span><span class="op" id="4818775">[</span><span class="ident" id="4818776">selectorIndex</span><span class="op" id="4818789">]</span><span class="op" id="4818790">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818795">selectorIndex</span><span class="op" id="4818808">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818814">decoded</span>&nbsp;<span class="op" id="4818822">=</span>&nbsp;<span class="num" id="4818824">0</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818833">v</span>&nbsp;<span class="op" id="4818835">:=</span>&nbsp;<span class="ident" id="4818838">currentHuffmanTree</span><span class="op" id="4818856">.</span><span class="ident" id="4818857">Decode</span><span class="op" id="4818863">(</span><span class="ident" id="4818864">br</span><span class="op" id="4818866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818870">decoded</span><span class="op" id="4818877">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818883">if</span>&nbsp;<span class="ident" id="4818886">v</span>&nbsp;<span class="op" id="4818888">&lt;</span>&nbsp;<span class="num" id="4818890">2</span>&nbsp;<span class="op" id="4818892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4818897">//&nbsp;This&nbsp;is&nbsp;either&nbsp;the&nbsp;RUNA&nbsp;or&nbsp;RUNB&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818943">if</span>&nbsp;<span class="ident" id="4818946">repeat</span>&nbsp;<span class="op" id="4818953">==</span>&nbsp;<span class="num" id="4818956">0</span>&nbsp;<span class="op" id="4818958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818964">repeat_power</span>&nbsp;<span class="op" id="4818977">=</span>&nbsp;<span class="num" id="4818979">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818984">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818989">repeat</span>&nbsp;<span class="op" id="4818996">+=</span>&nbsp;<span class="ident" id="4818999">repeat_power</span>&nbsp;<span class="op" id="4819012">&lt;&lt;</span>&nbsp;<span class="ident" id="4819015">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819020">repeat_power</span>&nbsp;<span class="op" id="4819033">&lt;&lt;=</span>&nbsp;<span class="num" id="4819037">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4819043">//&nbsp;This&nbsp;limit&nbsp;of&nbsp;2&nbsp;million&nbsp;comes&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4819101">//&nbsp;code.&nbsp;It&nbsp;prevents&nbsp;repeat&nbsp;from&nbsp;overflowing.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819150">if</span>&nbsp;<span class="ident" id="4819153">repeat</span>&nbsp;<span class="op" id="4819160">&gt;</span>&nbsp;<span class="num" id="4819162">2</span><span class="op" id="4819163">*</span><span class="num" id="4819164">1024</span><span class="op" id="4819168">*</span><span class="num" id="4819169">1024</span>&nbsp;<span class="op" id="4819174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819180">return</span>&nbsp;<span class="ident" id="4819187">StructuralError</span><span class="op" id="4819202">(</span><span class="string" id="4819203">&#34;repeat&nbsp;count&nbsp;too&nbsp;large&#34;</span><span class="op" id="4819227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4819232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819237">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4819248">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819253">if</span>&nbsp;<span class="ident" id="4819256">repeat</span>&nbsp;<span class="op" id="4819263">&gt;</span>&nbsp;<span class="num" id="4819265">0</span>&nbsp;<span class="op" id="4819267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4819272">//&nbsp;We&nbsp;have&nbsp;decoded&nbsp;a&nbsp;complete&nbsp;run-length&nbsp;so&nbsp;we&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4819330">//&nbsp;replicate&nbsp;the&nbsp;last&nbsp;output&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819370">if</span>&nbsp;<span class="ident" id="4819373">repeat</span>&nbsp;<span class="op" id="4819380">&gt;</span>&nbsp;<span class="ident" id="4819382">bz2</span><span class="op" id="4819385">.</span><span class="ident" id="4819386">blockSize</span><span class="op" id="4819395">-</span><span class="ident" id="4819396">bufIndex</span>&nbsp;<span class="op" id="4819405">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819411">return</span>&nbsp;<span class="ident" id="4819418">StructuralError</span><span class="op" id="4819433">(</span><span class="string" id="4819434">&#34;repeats&nbsp;past&nbsp;end&nbsp;of&nbsp;block&#34;</span><span class="op" id="4819461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4819466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819471">for</span>&nbsp;<span class="ident" id="4819475">i</span>&nbsp;<span class="op" id="4819477">:=</span>&nbsp;<span class="num" id="4819480">0</span><span class="op" id="4819481">;</span>&nbsp;<span class="ident" id="4819483">i</span>&nbsp;<span class="op" id="4819485">&lt;</span>&nbsp;<span class="ident" id="4819487">repeat</span><span class="op" id="4819493">;</span>&nbsp;<span class="ident" id="4819495">i</span><span class="op" id="4819496">++</span>&nbsp;<span class="op" id="4819499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819505">b</span>&nbsp;<span class="op" id="4819507">:=</span>&nbsp;<span class="builtintype" id="4819510">byte</span><span class="op" id="4819514">(</span><span class="ident" id="4819515">mtf</span><span class="op" id="4819518">.</span><span class="ident" id="4819519">First</span><span class="op" id="4819524">(</span><span class="op" id="4819525">)</span><span class="op" id="4819526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819532">bz2</span><span class="op" id="4819535">.</span><span class="ident" id="4819536">tt</span><span class="op" id="4819538">[</span><span class="ident" id="4819539">bufIndex</span><span class="op" id="4819547">]</span>&nbsp;<span class="op" id="4819549">=</span>&nbsp;<span class="builtintype" id="4819551">uint32</span><span class="op" id="4819557">(</span><span class="ident" id="4819558">b</span><span class="op" id="4819559">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819565">bz2</span><span class="op" id="4819568">.</span><span class="ident" id="4819569">c</span><span class="op" id="4819570">[</span><span class="ident" id="4819571">b</span><span class="op" id="4819572">]</span><span class="op" id="4819573">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819580">bufIndex</span><span class="op" id="4819588">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4819594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819599">repeat</span>&nbsp;<span class="op" id="4819606">=</span>&nbsp;<span class="num" id="4819608">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4819612">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819617">if</span>&nbsp;<span class="builtintype" id="4819620">int</span><span class="op" id="4819623">(</span><span class="ident" id="4819624">v</span><span class="op" id="4819625">)</span>&nbsp;<span class="op" id="4819627">==</span>&nbsp;<span class="ident" id="4819630">numSymbols</span><span class="op" id="4819640">-</span><span class="num" id="4819641">1</span>&nbsp;<span class="op" id="4819643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4819648">//&nbsp;This&nbsp;is&nbsp;the&nbsp;EOF&nbsp;symbol.&nbsp;Because&nbsp;it&#39;s&nbsp;always&nbsp;at&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4819705">//&nbsp;end&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;list,&nbsp;and&nbsp;never&nbsp;gets&nbsp;moved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4819763">//&nbsp;to&nbsp;the&nbsp;front,&nbsp;it&nbsp;has&nbsp;this&nbsp;unique&nbsp;value.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819809">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4819817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4819822">//&nbsp;Since&nbsp;two&nbsp;metasymbols&nbsp;(RUNA&nbsp;and&nbsp;RUNB)&nbsp;have&nbsp;values&nbsp;0&nbsp;and&nbsp;1,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4819886">//&nbsp;one&nbsp;would&nbsp;expect&nbsp;|v-2|&nbsp;to&nbsp;be&nbsp;passed&nbsp;to&nbsp;the&nbsp;MTF&nbsp;decoder.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4819947">//&nbsp;However,&nbsp;the&nbsp;front&nbsp;of&nbsp;the&nbsp;MTF&nbsp;list&nbsp;is&nbsp;never&nbsp;referenced&nbsp;as&nbsp;0,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4820013">//&nbsp;it&#39;s&nbsp;always&nbsp;referenced&nbsp;with&nbsp;a&nbsp;run-length&nbsp;of&nbsp;1.&nbsp;Thus&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4820072">//&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;encoded&nbsp;and&nbsp;we&nbsp;have&nbsp;|v-1|&nbsp;in&nbsp;the&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4820134">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820145">b</span>&nbsp;<span class="op" id="4820147">:=</span>&nbsp;<span class="builtintype" id="4820150">byte</span><span class="op" id="4820154">(</span><span class="ident" id="4820155">mtf</span><span class="op" id="4820158">.</span><span class="ident" id="4820159">Decode</span><span class="op" id="4820165">(</span><span class="builtintype" id="4820166">int</span><span class="op" id="4820169">(</span><span class="ident" id="4820170">v</span>&nbsp;<span class="op" id="4820172">-</span>&nbsp;<span class="num" id="4820174">1</span><span class="op" id="4820175">)</span><span class="op" id="4820176">)</span><span class="op" id="4820177">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4820181">if</span>&nbsp;<span class="ident" id="4820184">bufIndex</span>&nbsp;<span class="op" id="4820193">&gt;=</span>&nbsp;<span class="ident" id="4820196">bz2</span><span class="op" id="4820199">.</span><span class="ident" id="4820200">blockSize</span>&nbsp;<span class="op" id="4820210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4820215">return</span>&nbsp;<span class="ident" id="4820222">StructuralError</span><span class="op" id="4820237">(</span><span class="string" id="4820238">&#34;data&nbsp;exceeds&nbsp;block&nbsp;size&#34;</span><span class="op" id="4820263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4820267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820271">bz2</span><span class="op" id="4820274">.</span><span class="ident" id="4820275">tt</span><span class="op" id="4820277">[</span><span class="ident" id="4820278">bufIndex</span><span class="op" id="4820286">]</span>&nbsp;<span class="op" id="4820288">=</span>&nbsp;<span class="builtintype" id="4820290">uint32</span><span class="op" id="4820296">(</span><span class="ident" id="4820297">b</span><span class="op" id="4820298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820302">bz2</span><span class="op" id="4820305">.</span><span class="ident" id="4820306">c</span><span class="op" id="4820307">[</span><span class="ident" id="4820308">b</span><span class="op" id="4820309">]</span><span class="op" id="4820310">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820315">bufIndex</span><span class="op" id="4820323">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4820327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4820331">if</span>&nbsp;<span class="ident" id="4820334">origPtr</span>&nbsp;<span class="op" id="4820342">&gt;=</span>&nbsp;<span class="builtintype" id="4820345">uint</span><span class="op" id="4820349">(</span><span class="ident" id="4820350">bufIndex</span><span class="op" id="4820358">)</span>&nbsp;<span class="op" id="4820360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4820364">return</span>&nbsp;<span class="ident" id="4820371">StructuralError</span><span class="op" id="4820386">(</span><span class="string" id="4820387">&#34;origPtr&nbsp;out&nbsp;of&nbsp;bounds&#34;</span><span class="op" id="4820410">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4820413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4820417">//&nbsp;We&nbsp;have&nbsp;completed&nbsp;the&nbsp;entropy&nbsp;decoding.&nbsp;Now&nbsp;we&nbsp;can&nbsp;perform&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4820484">//&nbsp;inverse&nbsp;BWT&nbsp;and&nbsp;setup&nbsp;the&nbsp;RLE&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820526">bz2</span><span class="op" id="4820529">.</span><span class="ident" id="4820530">preRLE</span>&nbsp;<span class="op" id="4820537">=</span>&nbsp;<span class="ident" id="4820539">bz2</span><span class="op" id="4820542">.</span><span class="ident" id="4820543">tt</span><span class="op" id="4820545">[</span><span class="op" id="4820546">:</span><span class="ident" id="4820547">bufIndex</span><span class="op" id="4820555">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820558">bz2</span><span class="op" id="4820561">.</span><span class="ident" id="4820562">preRLEUsed</span>&nbsp;<span class="op" id="4820573">=</span>&nbsp;<span class="num" id="4820575">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820578">bz2</span><span class="op" id="4820581">.</span><span class="ident" id="4820582">tPos</span>&nbsp;<span class="op" id="4820587">=</span>&nbsp;<span class="ident" id="4820589">inverseBWT</span><span class="op" id="4820599">(</span><span class="ident" id="4820600">bz2</span><span class="op" id="4820603">.</span><span class="ident" id="4820604">preRLE</span><span class="op" id="4820610">,</span>&nbsp;<span class="ident" id="4820612">origPtr</span><span class="op" id="4820619">,</span>&nbsp;<span class="ident" id="4820621">bz2</span><span class="op" id="4820624">.</span><span class="ident" id="4820625">c</span><span class="op" id="4820626">[</span><span class="op" id="4820627">:</span><span class="op" id="4820628">]</span><span class="op" id="4820629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820632">bz2</span><span class="op" id="4820635">.</span><span class="ident" id="4820636">lastByte</span>&nbsp;<span class="op" id="4820645">=</span>&nbsp;<span class="op" id="4820647">-</span><span class="num" id="4820648">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820651">bz2</span><span class="op" id="4820654">.</span><span class="ident" id="4820655">byteRepeats</span>&nbsp;<span class="op" id="4820667">=</span>&nbsp;<span class="num" id="4820669">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820672">bz2</span><span class="op" id="4820675">.</span><span class="ident" id="4820676">repeats</span>&nbsp;<span class="op" id="4820684">=</span>&nbsp;<span class="num" id="4820686">0</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4820690">return</span>&nbsp;<span class="ident" id="4820697">nil</span><br>
<span class="lineno"></span><span class="op" id="4820701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4820704">//&nbsp;inverseBWT&nbsp;implements&nbsp;the&nbsp;inverse&nbsp;Burrows-Wheeler&nbsp;transform&nbsp;as&nbsp;described&nbsp;in</span><br>
<span class="lineno">450</span><span class="comment" id="4820783">//&nbsp;http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-124.pdf,&nbsp;section&nbsp;4.2.</span><br>
<span class="lineno"></span><span class="comment" id="4820860">//&nbsp;In&nbsp;that&nbsp;document,&nbsp;origPtr&nbsp;is&nbsp;called&nbsp;`I&#39;&nbsp;and&nbsp;c&nbsp;is&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4820936">//&nbsp;first&nbsp;pass&nbsp;over&nbsp;the&nbsp;data.&nbsp;It&#39;s&nbsp;an&nbsp;argument&nbsp;here&nbsp;because&nbsp;we&nbsp;merge&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="4821014">//&nbsp;pass&nbsp;with&nbsp;the&nbsp;Huffman&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="comment" id="4821049">//</span><br>
<span class="lineno">455</span><span class="comment" id="4821052">//&nbsp;This&nbsp;also&nbsp;implements&nbsp;the&nbsp;`single&nbsp;array&#39;&nbsp;method&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="4821129">//&nbsp;which&nbsp;leaves&nbsp;the&nbsp;output,&nbsp;still&nbsp;shuffled,&nbsp;in&nbsp;the&nbsp;bottom&nbsp;8&nbsp;bits&nbsp;of&nbsp;tt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4821209">//&nbsp;index&nbsp;of&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;top&nbsp;24-bits.&nbsp;The&nbsp;index&nbsp;of&nbsp;the&nbsp;first&nbsp;byte&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4821286">//&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="4821299">func</span>&nbsp;<span class="ident" id="4821304">inverseBWT</span><span class="op" id="4821314">(</span><span class="ident" id="4821315">tt</span>&nbsp;<span class="op" id="4821318">[</span><span class="op" id="4821319">]</span><span class="builtintype" id="4821320">uint32</span><span class="op" id="4821326">,</span>&nbsp;<span class="ident" id="4821328">origPtr</span>&nbsp;<span class="builtintype" id="4821336">uint</span><span class="op" id="4821340">,</span>&nbsp;<span class="ident" id="4821342">c</span>&nbsp;<span class="op" id="4821344">[</span><span class="op" id="4821345">]</span><span class="builtintype" id="4821346">uint</span><span class="op" id="4821350">)</span>&nbsp;<span class="builtintype" id="4821352">uint32</span>&nbsp;<span class="op" id="4821359">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821362">sum</span>&nbsp;<span class="op" id="4821366">:=</span>&nbsp;<span class="builtintype" id="4821369">uint</span><span class="op" id="4821373">(</span><span class="num" id="4821374">0</span><span class="op" id="4821375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821378">for</span>&nbsp;<span class="ident" id="4821382">i</span>&nbsp;<span class="op" id="4821384">:=</span>&nbsp;<span class="num" id="4821387">0</span><span class="op" id="4821388">;</span>&nbsp;<span class="ident" id="4821390">i</span>&nbsp;<span class="op" id="4821392">&lt;</span>&nbsp;<span class="num" id="4821394">256</span><span class="op" id="4821397">;</span>&nbsp;<span class="ident" id="4821399">i</span><span class="op" id="4821400">++</span>&nbsp;<span class="op" id="4821403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821407">sum</span>&nbsp;<span class="op" id="4821411">+=</span>&nbsp;<span class="ident" id="4821414">c</span><span class="op" id="4821415">[</span><span class="ident" id="4821416">i</span><span class="op" id="4821417">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821421">c</span><span class="op" id="4821422">[</span><span class="ident" id="4821423">i</span><span class="op" id="4821424">]</span>&nbsp;<span class="op" id="4821426">=</span>&nbsp;<span class="ident" id="4821428">sum</span>&nbsp;<span class="op" id="4821432">-</span>&nbsp;<span class="ident" id="4821434">c</span><span class="op" id="4821435">[</span><span class="ident" id="4821436">i</span><span class="op" id="4821437">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4821440">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821444">for</span>&nbsp;<span class="ident" id="4821448">i</span>&nbsp;<span class="op" id="4821450">:=</span>&nbsp;<span class="keyword" id="4821453">range</span>&nbsp;<span class="ident" id="4821459">tt</span>&nbsp;<span class="op" id="4821462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821466">b</span>&nbsp;<span class="op" id="4821468">:=</span>&nbsp;<span class="ident" id="4821471">tt</span><span class="op" id="4821473">[</span><span class="ident" id="4821474">i</span><span class="op" id="4821475">]</span>&nbsp;<span class="op" id="4821477">&amp;</span>&nbsp;<span class="num" id="4821479">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821486">tt</span><span class="op" id="4821488">[</span><span class="ident" id="4821489">c</span><span class="op" id="4821490">[</span><span class="ident" id="4821491">b</span><span class="op" id="4821492">]</span><span class="op" id="4821493">]</span>&nbsp;<span class="op" id="4821495">|=</span>&nbsp;<span class="builtintype" id="4821498">uint32</span><span class="op" id="4821504">(</span><span class="ident" id="4821505">i</span><span class="op" id="4821506">)</span>&nbsp;<span class="op" id="4821508">&lt;&lt;</span>&nbsp;<span class="num" id="4821511">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821515">c</span><span class="op" id="4821516">[</span><span class="ident" id="4821517">b</span><span class="op" id="4821518">]</span><span class="op" id="4821519">++</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4821523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821527">return</span>&nbsp;<span class="ident" id="4821534">tt</span><span class="op" id="4821536">[</span><span class="ident" id="4821537">origPtr</span><span class="op" id="4821544">]</span>&nbsp;<span class="op" id="4821546">&gt;&gt;</span>&nbsp;<span class="num" id="4821549">8</span><br>
<span class="lineno"></span><span class="op" id="4821551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span><span class="comment" id="4821554">//&nbsp;This&nbsp;is&nbsp;a&nbsp;standard&nbsp;CRC32&nbsp;like&nbsp;in&nbsp;hash/crc32&nbsp;except&nbsp;that&nbsp;all&nbsp;the&nbsp;shifts&nbsp;are&nbsp;reversed,</span><br>
<span class="lineno"></span><span class="comment" id="4821642">//&nbsp;causing&nbsp;the&nbsp;bits&nbsp;in&nbsp;the&nbsp;input&nbsp;to&nbsp;be&nbsp;processed&nbsp;in&nbsp;the&nbsp;reverse&nbsp;of&nbsp;the&nbsp;usual&nbsp;order.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4821727">var</span>&nbsp;<span class="ident" id="4821731">crctab</span>&nbsp;<span class="op" id="4821738">[</span><span class="num" id="4821739">256</span><span class="op" id="4821742">]</span><span class="builtintype" id="4821743">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span><span class="keyword" id="4821751">func</span>&nbsp;<span class="ident" id="4821756">init</span><span class="op" id="4821760">(</span><span class="op" id="4821761">)</span>&nbsp;<span class="op" id="4821763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821766">const</span>&nbsp;<span class="ident" id="4821772">poly</span>&nbsp;<span class="op" id="4821777">=</span>&nbsp;<span class="num" id="4821779">0x04C11DB7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821791">for</span>&nbsp;<span class="ident" id="4821795">i</span>&nbsp;<span class="op" id="4821797">:=</span>&nbsp;<span class="keyword" id="4821800">range</span>&nbsp;<span class="ident" id="4821806">crctab</span>&nbsp;<span class="op" id="4821813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821817">crc</span>&nbsp;<span class="op" id="4821821">:=</span>&nbsp;<span class="builtintype" id="4821824">uint32</span><span class="op" id="4821830">(</span><span class="ident" id="4821831">i</span><span class="op" id="4821832">)</span>&nbsp;<span class="op" id="4821834">&lt;&lt;</span>&nbsp;<span class="num" id="4821837">24</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821842">for</span>&nbsp;<span class="ident" id="4821846">j</span>&nbsp;<span class="op" id="4821848">:=</span>&nbsp;<span class="num" id="4821851">0</span><span class="op" id="4821852">;</span>&nbsp;<span class="ident" id="4821854">j</span>&nbsp;<span class="op" id="4821856">&lt;</span>&nbsp;<span class="num" id="4821858">8</span><span class="op" id="4821859">;</span>&nbsp;<span class="ident" id="4821861">j</span><span class="op" id="4821862">++</span>&nbsp;<span class="op" id="4821865">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821870">if</span>&nbsp;<span class="ident" id="4821873">crc</span><span class="op" id="4821876">&amp;</span><span class="num" id="4821877">0x80000000</span>&nbsp;<span class="op" id="4821888">!=</span>&nbsp;<span class="num" id="4821891">0</span>&nbsp;<span class="op" id="4821893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821899">crc</span>&nbsp;<span class="op" id="4821903">=</span>&nbsp;<span class="op" id="4821905">(</span><span class="ident" id="4821906">crc</span>&nbsp;<span class="op" id="4821910">&lt;&lt;</span>&nbsp;<span class="num" id="4821913">1</span><span class="op" id="4821914">)</span>&nbsp;<span class="op" id="4821916">^</span>&nbsp;<span class="ident" id="4821918">poly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4821926">}</span>&nbsp;<span class="keyword" id="4821928">else</span>&nbsp;<span class="op" id="4821933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821939">crc</span>&nbsp;<span class="op" id="4821943">&lt;&lt;=</span>&nbsp;<span class="num" id="4821947">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4821952">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4821956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821960">crctab</span><span class="op" id="4821966">[</span><span class="ident" id="4821967">i</span><span class="op" id="4821968">]</span>&nbsp;<span class="op" id="4821970">=</span>&nbsp;<span class="ident" id="4821972">crc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4821977">}</span><br>
<span class="lineno"></span><span class="op" id="4821979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="4821982">//&nbsp;updateCRC&nbsp;updates&nbsp;the&nbsp;crc&nbsp;value&nbsp;to&nbsp;incorporate&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4822047">//&nbsp;The&nbsp;initial&nbsp;value&nbsp;is&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="4822074">func</span>&nbsp;<span class="ident" id="4822079">updateCRC</span><span class="op" id="4822088">(</span><span class="ident" id="4822089">val</span>&nbsp;<span class="builtintype" id="4822093">uint32</span><span class="op" id="4822099">,</span>&nbsp;<span class="ident" id="4822101">b</span>&nbsp;<span class="op" id="4822103">[</span><span class="op" id="4822104">]</span><span class="builtintype" id="4822105">byte</span><span class="op" id="4822109">)</span>&nbsp;<span class="builtintype" id="4822111">uint32</span>&nbsp;<span class="op" id="4822118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822121">crc</span>&nbsp;<span class="op" id="4822125">:=</span>&nbsp;<span class="op" id="4822128">^</span><span class="ident" id="4822129">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4822134">for</span>&nbsp;<span class="ident" id="4822138">_</span><span class="op" id="4822139">,</span>&nbsp;<span class="ident" id="4822141">v</span>&nbsp;<span class="op" id="4822143">:=</span>&nbsp;<span class="keyword" id="4822146">range</span>&nbsp;<span class="ident" id="4822152">b</span>&nbsp;<span class="op" id="4822154">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822158">crc</span>&nbsp;<span class="op" id="4822162">=</span>&nbsp;<span class="ident" id="4822164">crctab</span><span class="op" id="4822170">[</span><span class="builtintype" id="4822171">byte</span><span class="op" id="4822175">(</span><span class="ident" id="4822176">crc</span><span class="op" id="4822179">&gt;&gt;</span><span class="num" id="4822181">24</span><span class="op" id="4822183">)</span><span class="op" id="4822184">^</span><span class="ident" id="4822185">v</span><span class="op" id="4822186">]</span>&nbsp;<span class="op" id="4822188">^</span>&nbsp;<span class="op" id="4822190">(</span><span class="ident" id="4822191">crc</span>&nbsp;<span class="op" id="4822195">&lt;&lt;</span>&nbsp;<span class="num" id="4822198">8</span><span class="op" id="4822199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4822202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4822205">return</span>&nbsp;<span class="op" id="4822212">^</span><span class="ident" id="4822213">crc</span><br>
<span class="lineno"></span><span class="op" id="4822217">}</span>
</div>
</body>
</html>
