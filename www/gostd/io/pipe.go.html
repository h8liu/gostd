<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>io</h2>
<ul>
<li><a href="/gostd/io/io.go.html">io.go</a></li>
<li><a href="/gostd/io/io_test.go.html">io_test.go</a></li>
<li><a href="/gostd/io/multi.go.html">multi.go</a></li>
<li><a href="/gostd/io/multi_test.go.html">multi_test.go</a></li>
<li><a href="/gostd/io/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/io/pipe_test.go.html">pipe_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1357005">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1357060">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1357114">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1357165">//&nbsp;Pipe&nbsp;adapter&nbsp;to&nbsp;connect&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Reader</span><br>
<span class="lineno"></span><span class="comment" id="1357220">//&nbsp;with&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1357258">package</span>&nbsp;<span class="ident" id="1357266">io</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1357270">import</span>&nbsp;<span class="op" id="1357277">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1357280">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1357290">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="1357297">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="1357300">//&nbsp;ErrClosedPipe&nbsp;is&nbsp;the&nbsp;error&nbsp;used&nbsp;for&nbsp;read&nbsp;or&nbsp;write&nbsp;operations&nbsp;on&nbsp;a&nbsp;closed&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1357382">var</span>&nbsp;<span class="ident" id="1357386">ErrClosedPipe</span>&nbsp;<span class="op" id="1357400">=</span>&nbsp;<span class="ident" id="1357402">errors</span><span class="op" id="1357408">.</span><span class="ident" id="1357409">New</span><span class="op" id="1357412">(</span><span class="string" id="1357413">&#34;io:&nbsp;read/write&nbsp;on&nbsp;closed&nbsp;pipe&#34;</span><span class="op" id="1357444">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1357447">type</span>&nbsp;<span class="ident" id="1357452">pipeResult</span>&nbsp;<span class="keyword" id="1357463">struct</span>&nbsp;<span class="op" id="1357470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1357473">n</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1357477">int</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1357482">err</span>&nbsp;<span class="builtintype" id="1357486">error</span><br>
<span class="lineno"></span><span class="op" id="1357492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1357495">//&nbsp;A&nbsp;pipe&nbsp;is&nbsp;the&nbsp;shared&nbsp;pipe&nbsp;structure&nbsp;underlying&nbsp;PipeReader&nbsp;and&nbsp;PipeWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="1357572">type</span>&nbsp;<span class="ident" id="1357577">pipe</span>&nbsp;<span class="keyword" id="1357582">struct</span>&nbsp;<span class="op" id="1357589">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1357592">rl</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1357598">sync</span><span class="op" id="1357602">.</span><span class="ident" id="1357603">Mutex</span>&nbsp;<span class="comment" id="1357609">//&nbsp;gates&nbsp;readers&nbsp;one&nbsp;at&nbsp;a&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1357641">wl</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1357647">sync</span><span class="op" id="1357651">.</span><span class="ident" id="1357652">Mutex</span>&nbsp;<span class="comment" id="1357658">//&nbsp;gates&nbsp;writers&nbsp;one&nbsp;at&nbsp;a&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1357690">l</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1357696">sync</span><span class="op" id="1357700">.</span><span class="ident" id="1357701">Mutex</span>&nbsp;<span class="comment" id="1357707">//&nbsp;protects&nbsp;remaining&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1357737">data</span>&nbsp;&nbsp;<span class="op" id="1357743">[</span><span class="op" id="1357744">]</span><span class="builtintype" id="1357745">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1357754">//&nbsp;data&nbsp;remaining&nbsp;in&nbsp;pending&nbsp;write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1357790">rwait</span>&nbsp;<span class="ident" id="1357796">sync</span><span class="op" id="1357800">.</span><span class="ident" id="1357801">Cond</span>&nbsp;&nbsp;<span class="comment" id="1357807">//&nbsp;waiting&nbsp;reader</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1357826">wwait</span>&nbsp;<span class="ident" id="1357832">sync</span><span class="op" id="1357836">.</span><span class="ident" id="1357837">Cond</span>&nbsp;&nbsp;<span class="comment" id="1357843">//&nbsp;waiting&nbsp;writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1357862">rerr</span>&nbsp;&nbsp;<span class="builtintype" id="1357868">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1357879">//&nbsp;if&nbsp;reader&nbsp;closed,&nbsp;error&nbsp;to&nbsp;give&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1357922">werr</span>&nbsp;&nbsp;<span class="builtintype" id="1357928">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1357939">//&nbsp;if&nbsp;writer&nbsp;closed,&nbsp;error&nbsp;to&nbsp;give&nbsp;reads</span><br>
<span class="lineno"></span><span class="op" id="1357980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="1357983">func</span>&nbsp;<span class="op" id="1357988">(</span><span class="ident" id="1357989">p</span>&nbsp;<span class="op" id="1357991">*</span><span class="ident" id="1357992">pipe</span><span class="op" id="1357996">)</span>&nbsp;<span class="ident" id="1357998">read</span><span class="op" id="1358002">(</span><span class="ident" id="1358003">b</span>&nbsp;<span class="op" id="1358005">[</span><span class="op" id="1358006">]</span><span class="builtintype" id="1358007">byte</span><span class="op" id="1358011">)</span>&nbsp;<span class="op" id="1358013">(</span><span class="ident" id="1358014">n</span>&nbsp;<span class="builtintype" id="1358016">int</span><span class="op" id="1358019">,</span>&nbsp;<span class="ident" id="1358021">err</span>&nbsp;<span class="builtintype" id="1358025">error</span><span class="op" id="1358030">)</span>&nbsp;<span class="op" id="1358032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1358035">//&nbsp;One&nbsp;reader&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358061">p</span><span class="op" id="1358062">.</span><span class="ident" id="1358063">rl</span><span class="op" id="1358065">.</span><span class="ident" id="1358066">Lock</span><span class="op" id="1358070">(</span><span class="op" id="1358071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358074">defer</span>&nbsp;<span class="ident" id="1358080">p</span><span class="op" id="1358081">.</span><span class="ident" id="1358082">rl</span><span class="op" id="1358084">.</span><span class="ident" id="1358085">Unlock</span><span class="op" id="1358091">(</span><span class="op" id="1358092">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358096">p</span><span class="op" id="1358097">.</span><span class="ident" id="1358098">l</span><span class="op" id="1358099">.</span><span class="ident" id="1358100">Lock</span><span class="op" id="1358104">(</span><span class="op" id="1358105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358108">defer</span>&nbsp;<span class="ident" id="1358114">p</span><span class="op" id="1358115">.</span><span class="ident" id="1358116">l</span><span class="op" id="1358117">.</span><span class="ident" id="1358118">Unlock</span><span class="op" id="1358124">(</span><span class="op" id="1358125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358128">for</span>&nbsp;<span class="op" id="1358132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358136">if</span>&nbsp;<span class="ident" id="1358139">p</span><span class="op" id="1358140">.</span><span class="ident" id="1358141">rerr</span>&nbsp;<span class="op" id="1358146">!=</span>&nbsp;<span class="ident" id="1358149">nil</span>&nbsp;<span class="op" id="1358153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358158">return</span>&nbsp;<span class="num" id="1358165">0</span><span class="op" id="1358166">,</span>&nbsp;<span class="ident" id="1358168">ErrClosedPipe</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1358184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358188">if</span>&nbsp;<span class="ident" id="1358191">p</span><span class="op" id="1358192">.</span><span class="ident" id="1358193">data</span>&nbsp;<span class="op" id="1358198">!=</span>&nbsp;<span class="ident" id="1358201">nil</span>&nbsp;<span class="op" id="1358205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358210">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1358218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358222">if</span>&nbsp;<span class="ident" id="1358225">p</span><span class="op" id="1358226">.</span><span class="ident" id="1358227">werr</span>&nbsp;<span class="op" id="1358232">!=</span>&nbsp;<span class="ident" id="1358235">nil</span>&nbsp;<span class="op" id="1358239">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358244">return</span>&nbsp;<span class="num" id="1358251">0</span><span class="op" id="1358252">,</span>&nbsp;<span class="ident" id="1358254">p</span><span class="op" id="1358255">.</span><span class="ident" id="1358256">werr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1358263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358267">p</span><span class="op" id="1358268">.</span><span class="ident" id="1358269">rwait</span><span class="op" id="1358274">.</span><span class="ident" id="1358275">Wait</span><span class="op" id="1358279">(</span><span class="op" id="1358280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1358283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358286">n</span>&nbsp;<span class="op" id="1358288">=</span>&nbsp;<span class="builtinfunc" id="1358290">copy</span><span class="op" id="1358294">(</span><span class="ident" id="1358295">b</span><span class="op" id="1358296">,</span>&nbsp;<span class="ident" id="1358298">p</span><span class="op" id="1358299">.</span><span class="ident" id="1358300">data</span><span class="op" id="1358304">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358307">p</span><span class="op" id="1358308">.</span><span class="ident" id="1358309">data</span>&nbsp;<span class="op" id="1358314">=</span>&nbsp;<span class="ident" id="1358316">p</span><span class="op" id="1358317">.</span><span class="ident" id="1358318">data</span><span class="op" id="1358322">[</span><span class="ident" id="1358323">n</span><span class="op" id="1358324">:</span><span class="op" id="1358325">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358328">if</span>&nbsp;<span class="builtinfunc" id="1358331">len</span><span class="op" id="1358334">(</span><span class="ident" id="1358335">p</span><span class="op" id="1358336">.</span><span class="ident" id="1358337">data</span><span class="op" id="1358341">)</span>&nbsp;<span class="op" id="1358343">==</span>&nbsp;<span class="num" id="1358346">0</span>&nbsp;<span class="op" id="1358348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358352">p</span><span class="op" id="1358353">.</span><span class="ident" id="1358354">data</span>&nbsp;<span class="op" id="1358359">=</span>&nbsp;<span class="ident" id="1358361">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358367">p</span><span class="op" id="1358368">.</span><span class="ident" id="1358369">wwait</span><span class="op" id="1358374">.</span><span class="ident" id="1358375">Signal</span><span class="op" id="1358381">(</span><span class="op" id="1358382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1358385">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358388">return</span><br>
<span class="lineno"></span><span class="op" id="1358395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1358398">var</span>&nbsp;<span class="ident" id="1358402">zero</span>&nbsp;<span class="op" id="1358407">[</span><span class="num" id="1358408">0</span><span class="op" id="1358409">]</span><span class="builtintype" id="1358410">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="1358416">func</span>&nbsp;<span class="op" id="1358421">(</span><span class="ident" id="1358422">p</span>&nbsp;<span class="op" id="1358424">*</span><span class="ident" id="1358425">pipe</span><span class="op" id="1358429">)</span>&nbsp;<span class="ident" id="1358431">write</span><span class="op" id="1358436">(</span><span class="ident" id="1358437">b</span>&nbsp;<span class="op" id="1358439">[</span><span class="op" id="1358440">]</span><span class="builtintype" id="1358441">byte</span><span class="op" id="1358445">)</span>&nbsp;<span class="op" id="1358447">(</span><span class="ident" id="1358448">n</span>&nbsp;<span class="builtintype" id="1358450">int</span><span class="op" id="1358453">,</span>&nbsp;<span class="ident" id="1358455">err</span>&nbsp;<span class="builtintype" id="1358459">error</span><span class="op" id="1358464">)</span>&nbsp;<span class="op" id="1358466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1358469">//&nbsp;pipe&nbsp;uses&nbsp;nil&nbsp;to&nbsp;mean&nbsp;not&nbsp;available</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358509">if</span>&nbsp;<span class="ident" id="1358512">b</span>&nbsp;<span class="op" id="1358514">==</span>&nbsp;<span class="ident" id="1358517">nil</span>&nbsp;<span class="op" id="1358521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358525">b</span>&nbsp;<span class="op" id="1358527">=</span>&nbsp;<span class="ident" id="1358529">zero</span><span class="op" id="1358533">[</span><span class="op" id="1358534">:</span><span class="op" id="1358535">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1358538">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1358542">//&nbsp;One&nbsp;writer&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358568">p</span><span class="op" id="1358569">.</span><span class="ident" id="1358570">wl</span><span class="op" id="1358572">.</span><span class="ident" id="1358573">Lock</span><span class="op" id="1358577">(</span><span class="op" id="1358578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358581">defer</span>&nbsp;<span class="ident" id="1358587">p</span><span class="op" id="1358588">.</span><span class="ident" id="1358589">wl</span><span class="op" id="1358591">.</span><span class="ident" id="1358592">Unlock</span><span class="op" id="1358598">(</span><span class="op" id="1358599">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358603">p</span><span class="op" id="1358604">.</span><span class="ident" id="1358605">l</span><span class="op" id="1358606">.</span><span class="ident" id="1358607">Lock</span><span class="op" id="1358611">(</span><span class="op" id="1358612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358615">defer</span>&nbsp;<span class="ident" id="1358621">p</span><span class="op" id="1358622">.</span><span class="ident" id="1358623">l</span><span class="op" id="1358624">.</span><span class="ident" id="1358625">Unlock</span><span class="op" id="1358631">(</span><span class="op" id="1358632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358635">if</span>&nbsp;<span class="ident" id="1358638">p</span><span class="op" id="1358639">.</span><span class="ident" id="1358640">werr</span>&nbsp;<span class="op" id="1358645">!=</span>&nbsp;<span class="ident" id="1358648">nil</span>&nbsp;<span class="op" id="1358652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358656">err</span>&nbsp;<span class="op" id="1358660">=</span>&nbsp;<span class="ident" id="1358662">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358678">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1358686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358689">p</span><span class="op" id="1358690">.</span><span class="ident" id="1358691">data</span>&nbsp;<span class="op" id="1358696">=</span>&nbsp;<span class="ident" id="1358698">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358701">p</span><span class="op" id="1358702">.</span><span class="ident" id="1358703">rwait</span><span class="op" id="1358708">.</span><span class="ident" id="1358709">Signal</span><span class="op" id="1358715">(</span><span class="op" id="1358716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358719">for</span>&nbsp;<span class="op" id="1358723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358727">if</span>&nbsp;<span class="ident" id="1358730">p</span><span class="op" id="1358731">.</span><span class="ident" id="1358732">data</span>&nbsp;<span class="op" id="1358737">==</span>&nbsp;<span class="ident" id="1358740">nil</span>&nbsp;<span class="op" id="1358744">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358749">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1358757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358761">if</span>&nbsp;<span class="ident" id="1358764">p</span><span class="op" id="1358765">.</span><span class="ident" id="1358766">rerr</span>&nbsp;<span class="op" id="1358771">!=</span>&nbsp;<span class="ident" id="1358774">nil</span>&nbsp;<span class="op" id="1358778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358783">err</span>&nbsp;<span class="op" id="1358787">=</span>&nbsp;<span class="ident" id="1358789">p</span><span class="op" id="1358790">.</span><span class="ident" id="1358791">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358799">break</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1358807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358811">if</span>&nbsp;<span class="ident" id="1358814">p</span><span class="op" id="1358815">.</span><span class="ident" id="1358816">werr</span>&nbsp;<span class="op" id="1358821">!=</span>&nbsp;<span class="ident" id="1358824">nil</span>&nbsp;<span class="op" id="1358828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358833">err</span>&nbsp;<span class="op" id="1358837">=</span>&nbsp;<span class="ident" id="1358839">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1358855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358859">p</span><span class="op" id="1358860">.</span><span class="ident" id="1358861">wwait</span><span class="op" id="1358866">.</span><span class="ident" id="1358867">Wait</span><span class="op" id="1358871">(</span><span class="op" id="1358872">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1358875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358878">n</span>&nbsp;<span class="op" id="1358880">=</span>&nbsp;<span class="builtinfunc" id="1358882">len</span><span class="op" id="1358885">(</span><span class="ident" id="1358886">b</span><span class="op" id="1358887">)</span>&nbsp;<span class="op" id="1358889">-</span>&nbsp;<span class="builtinfunc" id="1358891">len</span><span class="op" id="1358894">(</span><span class="ident" id="1358895">p</span><span class="op" id="1358896">.</span><span class="ident" id="1358897">data</span><span class="op" id="1358901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1358904">p</span><span class="op" id="1358905">.</span><span class="ident" id="1358906">data</span>&nbsp;<span class="op" id="1358911">=</span>&nbsp;<span class="ident" id="1358913">nil</span>&nbsp;<span class="comment" id="1358917">//&nbsp;in&nbsp;case&nbsp;of&nbsp;rerr&nbsp;or&nbsp;werr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358945">return</span><br>
<span class="lineno"></span><span class="op" id="1358952">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="1358955">func</span>&nbsp;<span class="op" id="1358960">(</span><span class="ident" id="1358961">p</span>&nbsp;<span class="op" id="1358963">*</span><span class="ident" id="1358964">pipe</span><span class="op" id="1358968">)</span>&nbsp;<span class="ident" id="1358970">rclose</span><span class="op" id="1358976">(</span><span class="ident" id="1358977">err</span>&nbsp;<span class="builtintype" id="1358981">error</span><span class="op" id="1358986">)</span>&nbsp;<span class="op" id="1358988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1358991">if</span>&nbsp;<span class="ident" id="1358994">err</span>&nbsp;<span class="op" id="1358998">==</span>&nbsp;<span class="ident" id="1359001">nil</span>&nbsp;<span class="op" id="1359005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1359009">err</span>&nbsp;<span class="op" id="1359013">=</span>&nbsp;<span class="ident" id="1359015">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1359030">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1359033">p</span><span class="op" id="1359034">.</span><span class="ident" id="1359035">l</span><span class="op" id="1359036">.</span><span class="ident" id="1359037">Lock</span><span class="op" id="1359041">(</span><span class="op" id="1359042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1359045">defer</span>&nbsp;<span class="ident" id="1359051">p</span><span class="op" id="1359052">.</span><span class="ident" id="1359053">l</span><span class="op" id="1359054">.</span><span class="ident" id="1359055">Unlock</span><span class="op" id="1359061">(</span><span class="op" id="1359062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1359065">p</span><span class="op" id="1359066">.</span><span class="ident" id="1359067">rerr</span>&nbsp;<span class="op" id="1359072">=</span>&nbsp;<span class="ident" id="1359074">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1359079">p</span><span class="op" id="1359080">.</span><span class="ident" id="1359081">rwait</span><span class="op" id="1359086">.</span><span class="ident" id="1359087">Signal</span><span class="op" id="1359093">(</span><span class="op" id="1359094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1359097">p</span><span class="op" id="1359098">.</span><span class="ident" id="1359099">wwait</span><span class="op" id="1359104">.</span><span class="ident" id="1359105">Signal</span><span class="op" id="1359111">(</span><span class="op" id="1359112">)</span><br>
<span class="lineno">110</span><span class="op" id="1359114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1359117">func</span>&nbsp;<span class="op" id="1359122">(</span><span class="ident" id="1359123">p</span>&nbsp;<span class="op" id="1359125">*</span><span class="ident" id="1359126">pipe</span><span class="op" id="1359130">)</span>&nbsp;<span class="ident" id="1359132">wclose</span><span class="op" id="1359138">(</span><span class="ident" id="1359139">err</span>&nbsp;<span class="builtintype" id="1359143">error</span><span class="op" id="1359148">)</span>&nbsp;<span class="op" id="1359150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1359153">if</span>&nbsp;<span class="ident" id="1359156">err</span>&nbsp;<span class="op" id="1359160">==</span>&nbsp;<span class="ident" id="1359163">nil</span>&nbsp;<span class="op" id="1359167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1359171">err</span>&nbsp;<span class="op" id="1359175">=</span>&nbsp;<span class="ident" id="1359177">EOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1359182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1359185">p</span><span class="op" id="1359186">.</span><span class="ident" id="1359187">l</span><span class="op" id="1359188">.</span><span class="ident" id="1359189">Lock</span><span class="op" id="1359193">(</span><span class="op" id="1359194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1359197">defer</span>&nbsp;<span class="ident" id="1359203">p</span><span class="op" id="1359204">.</span><span class="ident" id="1359205">l</span><span class="op" id="1359206">.</span><span class="ident" id="1359207">Unlock</span><span class="op" id="1359213">(</span><span class="op" id="1359214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1359217">p</span><span class="op" id="1359218">.</span><span class="ident" id="1359219">werr</span>&nbsp;<span class="op" id="1359224">=</span>&nbsp;<span class="ident" id="1359226">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1359231">p</span><span class="op" id="1359232">.</span><span class="ident" id="1359233">rwait</span><span class="op" id="1359238">.</span><span class="ident" id="1359239">Signal</span><span class="op" id="1359245">(</span><span class="op" id="1359246">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1359249">p</span><span class="op" id="1359250">.</span><span class="ident" id="1359251">wwait</span><span class="op" id="1359256">.</span><span class="ident" id="1359257">Signal</span><span class="op" id="1359263">(</span><span class="op" id="1359264">)</span><br>
<span class="lineno"></span><span class="op" id="1359266">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1359269">//&nbsp;A&nbsp;PipeReader&nbsp;is&nbsp;the&nbsp;read&nbsp;half&nbsp;of&nbsp;a&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1359313">type</span>&nbsp;<span class="ident" id="1359318">PipeReader</span>&nbsp;<span class="keyword" id="1359329">struct</span>&nbsp;<span class="op" id="1359336">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1359339">p</span>&nbsp;<span class="op" id="1359341">*</span><span class="ident" id="1359342">pipe</span><br>
<span class="lineno"></span><span class="op" id="1359347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1359350">//&nbsp;Read&nbsp;implements&nbsp;the&nbsp;standard&nbsp;Read&nbsp;interface:</span><br>
<span class="lineno"></span><span class="comment" id="1359398">//&nbsp;it&nbsp;reads&nbsp;data&nbsp;from&nbsp;the&nbsp;pipe,&nbsp;blocking&nbsp;until&nbsp;a&nbsp;writer</span><br>
<span class="lineno">130</span><span class="comment" id="1359454">//&nbsp;arrives&nbsp;or&nbsp;the&nbsp;write&nbsp;end&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="1359493">//&nbsp;If&nbsp;the&nbsp;write&nbsp;end&nbsp;is&nbsp;closed&nbsp;with&nbsp;an&nbsp;error,&nbsp;that&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1359552">//&nbsp;returned&nbsp;as&nbsp;err;&nbsp;otherwise&nbsp;err&nbsp;is&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="1359594">func</span>&nbsp;<span class="op" id="1359599">(</span><span class="ident" id="1359600">r</span>&nbsp;<span class="op" id="1359602">*</span><span class="ident" id="1359603">PipeReader</span><span class="op" id="1359613">)</span>&nbsp;<span class="ident" id="1359615">Read</span><span class="op" id="1359619">(</span><span class="ident" id="1359620">data</span>&nbsp;<span class="op" id="1359625">[</span><span class="op" id="1359626">]</span><span class="builtintype" id="1359627">byte</span><span class="op" id="1359631">)</span>&nbsp;<span class="op" id="1359633">(</span><span class="ident" id="1359634">n</span>&nbsp;<span class="builtintype" id="1359636">int</span><span class="op" id="1359639">,</span>&nbsp;<span class="ident" id="1359641">err</span>&nbsp;<span class="builtintype" id="1359645">error</span><span class="op" id="1359650">)</span>&nbsp;<span class="op" id="1359652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1359655">return</span>&nbsp;<span class="ident" id="1359662">r</span><span class="op" id="1359663">.</span><span class="ident" id="1359664">p</span><span class="op" id="1359665">.</span><span class="ident" id="1359666">read</span><span class="op" id="1359670">(</span><span class="ident" id="1359671">data</span><span class="op" id="1359675">)</span><br>
<span class="lineno">135</span><span class="op" id="1359677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1359680">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;reader;&nbsp;subsequent&nbsp;writes&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1359733">//&nbsp;write&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;the&nbsp;error&nbsp;ErrClosedPipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1359796">func</span>&nbsp;<span class="op" id="1359801">(</span><span class="ident" id="1359802">r</span>&nbsp;<span class="op" id="1359804">*</span><span class="ident" id="1359805">PipeReader</span><span class="op" id="1359815">)</span>&nbsp;<span class="ident" id="1359817">Close</span><span class="op" id="1359822">(</span><span class="op" id="1359823">)</span>&nbsp;<span class="builtintype" id="1359825">error</span>&nbsp;<span class="op" id="1359831">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1359834">return</span>&nbsp;<span class="ident" id="1359841">r</span><span class="op" id="1359842">.</span><span class="ident" id="1359843">CloseWithError</span><span class="op" id="1359857">(</span><span class="ident" id="1359858">nil</span><span class="op" id="1359861">)</span><br>
<span class="lineno"></span><span class="op" id="1359863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1359866">//&nbsp;CloseWithError&nbsp;closes&nbsp;the&nbsp;reader;&nbsp;subsequent&nbsp;writes</span><br>
<span class="lineno"></span><span class="comment" id="1359921">//&nbsp;to&nbsp;the&nbsp;write&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;the&nbsp;error&nbsp;err.</span><br>
<span class="lineno">145</span><span class="keyword" id="1359981">func</span>&nbsp;<span class="op" id="1359986">(</span><span class="ident" id="1359987">r</span>&nbsp;<span class="op" id="1359989">*</span><span class="ident" id="1359990">PipeReader</span><span class="op" id="1360000">)</span>&nbsp;<span class="ident" id="1360002">CloseWithError</span><span class="op" id="1360016">(</span><span class="ident" id="1360017">err</span>&nbsp;<span class="builtintype" id="1360021">error</span><span class="op" id="1360026">)</span>&nbsp;<span class="builtintype" id="1360028">error</span>&nbsp;<span class="op" id="1360034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1360037">r</span><span class="op" id="1360038">.</span><span class="ident" id="1360039">p</span><span class="op" id="1360040">.</span><span class="ident" id="1360041">rclose</span><span class="op" id="1360047">(</span><span class="ident" id="1360048">err</span><span class="op" id="1360051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1360054">return</span>&nbsp;<span class="ident" id="1360061">nil</span><br>
<span class="lineno"></span><span class="op" id="1360065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1360068">//&nbsp;A&nbsp;PipeWriter&nbsp;is&nbsp;the&nbsp;write&nbsp;half&nbsp;of&nbsp;a&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1360113">type</span>&nbsp;<span class="ident" id="1360118">PipeWriter</span>&nbsp;<span class="keyword" id="1360129">struct</span>&nbsp;<span class="op" id="1360136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1360139">p</span>&nbsp;<span class="op" id="1360141">*</span><span class="ident" id="1360142">pipe</span><br>
<span class="lineno"></span><span class="op" id="1360147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="1360150">//&nbsp;Write&nbsp;implements&nbsp;the&nbsp;standard&nbsp;Write&nbsp;interface:</span><br>
<span class="lineno"></span><span class="comment" id="1360200">//&nbsp;it&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;pipe,&nbsp;blocking&nbsp;until&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1360254">//&nbsp;have&nbsp;consumed&nbsp;all&nbsp;the&nbsp;data&nbsp;or&nbsp;the&nbsp;read&nbsp;end&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="1360311">//&nbsp;If&nbsp;the&nbsp;read&nbsp;end&nbsp;is&nbsp;closed&nbsp;with&nbsp;an&nbsp;error,&nbsp;that&nbsp;err&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1360367">//&nbsp;returned&nbsp;as&nbsp;err;&nbsp;otherwise&nbsp;err&nbsp;is&nbsp;ErrClosedPipe.</span><br>
<span class="lineno">160</span><span class="keyword" id="1360419">func</span>&nbsp;<span class="op" id="1360424">(</span><span class="ident" id="1360425">w</span>&nbsp;<span class="op" id="1360427">*</span><span class="ident" id="1360428">PipeWriter</span><span class="op" id="1360438">)</span>&nbsp;<span class="ident" id="1360440">Write</span><span class="op" id="1360445">(</span><span class="ident" id="1360446">data</span>&nbsp;<span class="op" id="1360451">[</span><span class="op" id="1360452">]</span><span class="builtintype" id="1360453">byte</span><span class="op" id="1360457">)</span>&nbsp;<span class="op" id="1360459">(</span><span class="ident" id="1360460">n</span>&nbsp;<span class="builtintype" id="1360462">int</span><span class="op" id="1360465">,</span>&nbsp;<span class="ident" id="1360467">err</span>&nbsp;<span class="builtintype" id="1360471">error</span><span class="op" id="1360476">)</span>&nbsp;<span class="op" id="1360478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1360481">return</span>&nbsp;<span class="ident" id="1360488">w</span><span class="op" id="1360489">.</span><span class="ident" id="1360490">p</span><span class="op" id="1360491">.</span><span class="ident" id="1360492">write</span><span class="op" id="1360497">(</span><span class="ident" id="1360498">data</span><span class="op" id="1360502">)</span><br>
<span class="lineno"></span><span class="op" id="1360504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1360507">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;writer;&nbsp;subsequent&nbsp;reads&nbsp;from&nbsp;the</span><br>
<span class="lineno">165</span><span class="comment" id="1360561">//&nbsp;read&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;no&nbsp;bytes&nbsp;and&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="1360616">func</span>&nbsp;<span class="op" id="1360621">(</span><span class="ident" id="1360622">w</span>&nbsp;<span class="op" id="1360624">*</span><span class="ident" id="1360625">PipeWriter</span><span class="op" id="1360635">)</span>&nbsp;<span class="ident" id="1360637">Close</span><span class="op" id="1360642">(</span><span class="op" id="1360643">)</span>&nbsp;<span class="builtintype" id="1360645">error</span>&nbsp;<span class="op" id="1360651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1360654">return</span>&nbsp;<span class="ident" id="1360661">w</span><span class="op" id="1360662">.</span><span class="ident" id="1360663">CloseWithError</span><span class="op" id="1360677">(</span><span class="ident" id="1360678">nil</span><span class="op" id="1360681">)</span><br>
<span class="lineno"></span><span class="op" id="1360683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="1360686">//&nbsp;CloseWithError&nbsp;closes&nbsp;the&nbsp;writer;&nbsp;subsequent&nbsp;reads&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1360749">//&nbsp;read&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;no&nbsp;bytes&nbsp;and&nbsp;the&nbsp;error&nbsp;err.</span><br>
<span class="lineno"></span><span class="keyword" id="1360814">func</span>&nbsp;<span class="op" id="1360819">(</span><span class="ident" id="1360820">w</span>&nbsp;<span class="op" id="1360822">*</span><span class="ident" id="1360823">PipeWriter</span><span class="op" id="1360833">)</span>&nbsp;<span class="ident" id="1360835">CloseWithError</span><span class="op" id="1360849">(</span><span class="ident" id="1360850">err</span>&nbsp;<span class="builtintype" id="1360854">error</span><span class="op" id="1360859">)</span>&nbsp;<span class="builtintype" id="1360861">error</span>&nbsp;<span class="op" id="1360867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1360870">w</span><span class="op" id="1360871">.</span><span class="ident" id="1360872">p</span><span class="op" id="1360873">.</span><span class="ident" id="1360874">wclose</span><span class="op" id="1360880">(</span><span class="ident" id="1360881">err</span><span class="op" id="1360884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1360887">return</span>&nbsp;<span class="ident" id="1360894">nil</span><br>
<span class="lineno">175</span><span class="op" id="1360898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1360901">//&nbsp;Pipe&nbsp;creates&nbsp;a&nbsp;synchronous&nbsp;in-memory&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="1360947">//&nbsp;It&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;connect&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Reader</span><br>
<span class="lineno"></span><span class="comment" id="1361004">//&nbsp;with&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno">180</span><span class="comment" id="1361041">//&nbsp;Reads&nbsp;on&nbsp;one&nbsp;end&nbsp;are&nbsp;matched&nbsp;with&nbsp;writes&nbsp;on&nbsp;the&nbsp;other,</span><br>
<span class="lineno"></span><span class="comment" id="1361099">//&nbsp;copying&nbsp;data&nbsp;directly&nbsp;between&nbsp;the&nbsp;two;&nbsp;there&nbsp;is&nbsp;no&nbsp;internal&nbsp;buffering.</span><br>
<span class="lineno"></span><span class="comment" id="1361173">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;Read&nbsp;and&nbsp;Write&nbsp;in&nbsp;parallel&nbsp;with&nbsp;each&nbsp;other&nbsp;or&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1361246">//&nbsp;Close.&nbsp;Close&nbsp;will&nbsp;complete&nbsp;once&nbsp;pending&nbsp;I/O&nbsp;is&nbsp;done.&nbsp;Parallel&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1361320">//&nbsp;Read,&nbsp;and&nbsp;parallel&nbsp;calls&nbsp;to&nbsp;Write,&nbsp;are&nbsp;also&nbsp;safe:</span><br>
<span class="lineno">185</span><span class="comment" id="1361373">//&nbsp;the&nbsp;individual&nbsp;calls&nbsp;will&nbsp;be&nbsp;gated&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="keyword" id="1361425">func</span>&nbsp;<span class="ident" id="1361430">Pipe</span><span class="op" id="1361434">(</span><span class="op" id="1361435">)</span>&nbsp;<span class="op" id="1361437">(</span><span class="op" id="1361438">*</span><span class="ident" id="1361439">PipeReader</span><span class="op" id="1361449">,</span>&nbsp;<span class="op" id="1361451">*</span><span class="ident" id="1361452">PipeWriter</span><span class="op" id="1361462">)</span>&nbsp;<span class="op" id="1361464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361467">p</span>&nbsp;<span class="op" id="1361469">:=</span>&nbsp;<span class="builtinfunc" id="1361472">new</span><span class="op" id="1361475">(</span><span class="ident" id="1361476">pipe</span><span class="op" id="1361480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361483">p</span><span class="op" id="1361484">.</span><span class="ident" id="1361485">rwait</span><span class="op" id="1361490">.</span><span class="ident" id="1361491">L</span>&nbsp;<span class="op" id="1361493">=</span>&nbsp;<span class="op" id="1361495">&amp;</span><span class="ident" id="1361496">p</span><span class="op" id="1361497">.</span><span class="ident" id="1361498">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361501">p</span><span class="op" id="1361502">.</span><span class="ident" id="1361503">wwait</span><span class="op" id="1361508">.</span><span class="ident" id="1361509">L</span>&nbsp;<span class="op" id="1361511">=</span>&nbsp;<span class="op" id="1361513">&amp;</span><span class="ident" id="1361514">p</span><span class="op" id="1361515">.</span><span class="ident" id="1361516">l</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361519">r</span>&nbsp;<span class="op" id="1361521">:=</span>&nbsp;<span class="op" id="1361524">&amp;</span><span class="ident" id="1361525">PipeReader</span><span class="op" id="1361535">{</span><span class="ident" id="1361536">p</span><span class="op" id="1361537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1361540">w</span>&nbsp;<span class="op" id="1361542">:=</span>&nbsp;<span class="op" id="1361545">&amp;</span><span class="ident" id="1361546">PipeWriter</span><span class="op" id="1361556">{</span><span class="ident" id="1361557">p</span><span class="op" id="1361558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1361561">return</span>&nbsp;<span class="ident" id="1361568">r</span><span class="op" id="1361569">,</span>&nbsp;<span class="ident" id="1361571">w</span><br>
<span class="lineno"></span><span class="op" id="1361573">}</span>
</div>
</body>
</html>
