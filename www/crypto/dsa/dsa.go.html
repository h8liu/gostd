<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;Package&nbsp;dsa&nbsp;implements&nbsp;the&nbsp;Digital&nbsp;Signature&nbsp;Algorithm,&nbsp;as&nbsp;defined&nbsp;in&nbsp;FIPS&nbsp;186-3.</span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">dsa</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Parameters&nbsp;represents&nbsp;the&nbsp;domain&nbsp;parameters&nbsp;for&nbsp;a&nbsp;key.&nbsp;These&nbsp;parameters&nbsp;can</span><br>
<span class="lineno">15</span><span class="comment">//&nbsp;be&nbsp;shared&nbsp;across&nbsp;many&nbsp;keys.&nbsp;The&nbsp;bit&nbsp;length&nbsp;of&nbsp;Q&nbsp;must&nbsp;be&nbsp;a&nbsp;multiple&nbsp;of&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">Parameters</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">P</span><span class="op">,</span>&nbsp;<span class="ident">Q</span><span class="op">,</span>&nbsp;<span class="ident">G</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment">//&nbsp;PublicKey&nbsp;represents&nbsp;a&nbsp;DSA&nbsp;public&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">PublicKey</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Parameters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Y</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;PrivateKey&nbsp;represents&nbsp;a&nbsp;DSA&nbsp;private&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">PrivateKey</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">PublicKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">X</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><br>
<span class="lineno">30</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ErrInvalidPublicKey&nbsp;results&nbsp;when&nbsp;a&nbsp;public&nbsp;key&nbsp;is&nbsp;not&nbsp;usable&nbsp;by&nbsp;this&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;FIPS&nbsp;is&nbsp;quite&nbsp;strict&nbsp;about&nbsp;the&nbsp;format&nbsp;of&nbsp;DSA&nbsp;keys,&nbsp;but&nbsp;other&nbsp;code&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;less&nbsp;so.&nbsp;Thus,&nbsp;when&nbsp;using&nbsp;keys&nbsp;which&nbsp;may&nbsp;have&nbsp;been&nbsp;generated&nbsp;by&nbsp;other&nbsp;code,</span><br>
<span class="lineno">35</span><span class="comment">//&nbsp;this&nbsp;error&nbsp;must&nbsp;be&nbsp;handled.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">ErrInvalidPublicKey</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;crypto/dsa:&nbsp;invalid&nbsp;public&nbsp;key&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ParameterSizes&nbsp;is&nbsp;a&nbsp;enumeration&nbsp;of&nbsp;the&nbsp;acceptable&nbsp;bit&nbsp;lengths&nbsp;of&nbsp;the&nbsp;primes</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;in&nbsp;a&nbsp;set&nbsp;of&nbsp;DSA&nbsp;parameters.&nbsp;See&nbsp;FIPS&nbsp;186-3,&nbsp;section&nbsp;4.2.</span><br>
<span class="lineno">40</span><span class="keyword">type</span>&nbsp;<span class="ident">ParameterSizes</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">L1024N160</span>&nbsp;<span class="ident">ParameterSizes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">L2048N224</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">L2048N256</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">L3072N256</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;numMRTests&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;Miller-Rabin&nbsp;primality&nbsp;tests&nbsp;that&nbsp;we&nbsp;perform.&nbsp;We</span><br>
<span class="lineno">50</span><span class="comment">//&nbsp;pick&nbsp;the&nbsp;largest&nbsp;recommended&nbsp;number&nbsp;from&nbsp;table&nbsp;C.1&nbsp;of&nbsp;FIPS&nbsp;186-3.</span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="ident">numMRTests</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;GenerateParameters&nbsp;puts&nbsp;a&nbsp;random,&nbsp;valid&nbsp;set&nbsp;of&nbsp;DSA&nbsp;parameters&nbsp;into&nbsp;params.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;This&nbsp;function&nbsp;takes&nbsp;many&nbsp;seconds,&nbsp;even&nbsp;on&nbsp;fast&nbsp;machines.</span><br>
<span class="lineno">55</span><span class="keyword">func</span>&nbsp;<span class="ident">GenerateParameters</span><span class="op">(</span><span class="ident">params</span>&nbsp;<span class="op">*</span><span class="ident">Parameters</span><span class="op">,</span>&nbsp;<span class="ident">rand</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span><span class="op">,</span>&nbsp;<span class="ident">sizes</span>&nbsp;<span class="ident">ParameterSizes</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;function&nbsp;doesn&#39;t&nbsp;follow&nbsp;FIPS&nbsp;186-3&nbsp;exactly&nbsp;in&nbsp;that&nbsp;it&nbsp;doesn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;use&nbsp;a&nbsp;verification&nbsp;seed&nbsp;to&nbsp;generate&nbsp;the&nbsp;primes.&nbsp;The&nbsp;verification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;seed&nbsp;doesn&#39;t&nbsp;appear&nbsp;to&nbsp;be&nbsp;exported&nbsp;or&nbsp;used&nbsp;by&nbsp;other&nbsp;code&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;omitting&nbsp;it&nbsp;makes&nbsp;the&nbsp;code&nbsp;cleaner.</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">L</span><span class="op">,</span>&nbsp;<span class="ident">N</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">sizes</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">L1024N160</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">L</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1024</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">N</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">L2048N224</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">L</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2048</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">N</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">224</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">L2048N256</span><span class="op">:</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">L</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2048</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">N</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">256</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">L3072N256</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">L</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">3072</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">N</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">256</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;crypto/dsa:&nbsp;invalid&nbsp;ParameterSizes&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">qBytes</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">N</span><span class="op">/</span><span class="num">8</span><span class="op">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pBytes</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">L</span><span class="op">/</span><span class="num">8</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rem</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">one</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">one</span><span class="op">.</span><span class="ident">SetInt64</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident">GeneratePrimes</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadFull</span><span class="op">(</span><span class="ident">rand</span><span class="op">,</span>&nbsp;<span class="ident">qBytes</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">qBytes</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">qBytes</span><span class="op">)</span><span class="op">-</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">qBytes</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="num">0x80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">.</span><span class="ident">SetBytes</span><span class="op">(</span><span class="ident">qBytes</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">q</span><span class="op">.</span><span class="ident">ProbablyPrime</span><span class="op">(</span><span class="ident">numMRTests</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">4</span><span class="op">*</span><span class="ident">L</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadFull</span><span class="op">(</span><span class="ident">rand</span><span class="op">,</span>&nbsp;<span class="ident">pBytes</span><span class="op">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pBytes</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">pBytes</span><span class="op">)</span><span class="op">-</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pBytes</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="num">0x80</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span><span class="op">.</span><span class="ident">SetBytes</span><span class="op">(</span><span class="ident">pBytes</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rem</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">q</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rem</span><span class="op">.</span><span class="ident">Sub</span><span class="op">(</span><span class="ident">rem</span><span class="op">,</span>&nbsp;<span class="ident">one</span><span class="op">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span><span class="op">.</span><span class="ident">Sub</span><span class="op">(</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">rem</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">BitLen</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">L</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">p</span><span class="op">.</span><span class="ident">ProbablyPrime</span><span class="op">(</span><span class="ident">numMRTests</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">params</span><span class="op">.</span><span class="ident">P</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">p</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">params</span><span class="op">.</span><span class="ident">Q</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span>&nbsp;<span class="ident">GeneratePrimes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">.</span><span class="ident">SetInt64</span><span class="op">(</span><span class="num">2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pm1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Sub</span><span class="op">(</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">one</span><span class="op">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Div</span><span class="op">(</span><span class="ident">pm1</span><span class="op">,</span>&nbsp;<span class="ident">q</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">Exp</span><span class="op">(</span><span class="ident">h</span><span class="op">,</span>&nbsp;<span class="ident">e</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">g</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">one</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="ident">h</span><span class="op">,</span>&nbsp;<span class="ident">one</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">params</span><span class="op">.</span><span class="ident">G</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">g</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;GenerateKey&nbsp;generates&nbsp;a&nbsp;public&amp;private&nbsp;key&nbsp;pair.&nbsp;The&nbsp;Parameters&nbsp;of&nbsp;the</span><br>
<span class="lineno">150</span><span class="comment">//&nbsp;PrivateKey&nbsp;must&nbsp;already&nbsp;be&nbsp;valid&nbsp;(see&nbsp;GenerateParameters).</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">GenerateKey</span><span class="op">(</span><span class="ident">priv</span>&nbsp;<span class="op">*</span><span class="ident">PrivateKey</span><span class="op">,</span>&nbsp;<span class="ident">rand</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">P</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Q</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">G</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;crypto/dsa:&nbsp;parameters&nbsp;not&nbsp;set&nbsp;up&nbsp;before&nbsp;generating&nbsp;key&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xBytes</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Q</span><span class="op">.</span><span class="ident">BitLen</span><span class="op">(</span><span class="op">)</span><span class="op">/</span><span class="num">8</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadFull</span><span class="op">(</span><span class="ident">rand</span><span class="op">,</span>&nbsp;<span class="ident">xBytes</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span><span class="op">.</span><span class="ident">SetBytes</span><span class="op">(</span><span class="ident">xBytes</span><span class="op">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">Sign</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">Q</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span><span class="op">.</span><span class="ident">X</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span><span class="op">.</span><span class="ident">Y</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span><span class="op">.</span><span class="ident">Y</span><span class="op">.</span><span class="ident">Exp</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">G</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">P</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;fermatInverse&nbsp;calculates&nbsp;the&nbsp;inverse&nbsp;of&nbsp;k&nbsp;in&nbsp;GF(P)&nbsp;using&nbsp;Fermat&#39;s&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;This&nbsp;has&nbsp;better&nbsp;constant-time&nbsp;properties&nbsp;than&nbsp;Euclid&#39;s&nbsp;method&nbsp;(implemented</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;in&nbsp;math/big.Int.ModInverse)&nbsp;although&nbsp;math/big&nbsp;itself&nbsp;isn&#39;t&nbsp;strictly</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;constant-time&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;perfect.</span><br>
<span class="lineno">180</span><span class="keyword">func</span>&nbsp;<span class="ident">fermatInverse</span><span class="op">(</span><span class="ident">k</span><span class="op">,</span>&nbsp;<span class="ident">P</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">two</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">big</span><span class="op">.</span><span class="ident">NewInt</span><span class="op">(</span><span class="num">2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pMinus2</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Sub</span><span class="op">(</span><span class="ident">P</span><span class="op">,</span>&nbsp;<span class="ident">two</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Exp</span><span class="op">(</span><span class="ident">k</span><span class="op">,</span>&nbsp;<span class="ident">pMinus2</span><span class="op">,</span>&nbsp;<span class="ident">P</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Sign&nbsp;signs&nbsp;an&nbsp;arbitrary&nbsp;length&nbsp;hash&nbsp;(which&nbsp;should&nbsp;be&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;a</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;larger&nbsp;message)&nbsp;using&nbsp;the&nbsp;private&nbsp;key,&nbsp;priv.&nbsp;It&nbsp;returns&nbsp;the&nbsp;signature&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;pair&nbsp;of&nbsp;integers.&nbsp;The&nbsp;security&nbsp;of&nbsp;the&nbsp;private&nbsp;key&nbsp;depends&nbsp;on&nbsp;the&nbsp;entropy&nbsp;of</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;rand.</span><br>
<span class="lineno">190</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Note&nbsp;that&nbsp;FIPS&nbsp;186-3&nbsp;section&nbsp;4.6&nbsp;specifies&nbsp;that&nbsp;the&nbsp;hash&nbsp;should&nbsp;be&nbsp;truncated</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;to&nbsp;the&nbsp;byte-length&nbsp;of&nbsp;the&nbsp;subgroup.&nbsp;This&nbsp;function&nbsp;does&nbsp;not&nbsp;perform&nbsp;that</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;truncation&nbsp;itself.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">Sign</span><span class="op">(</span><span class="ident">rand</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span><span class="op">,</span>&nbsp;<span class="ident">priv</span>&nbsp;<span class="op">*</span><span class="ident">PrivateKey</span><span class="op">,</span>&nbsp;<span class="ident">hash</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;FIPS&nbsp;186-3,&nbsp;section&nbsp;4.6</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Q</span><span class="op">.</span><span class="ident">BitLen</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">&amp;</span><span class="num">7</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ErrInvalidPublicKey</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">k</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadFull</span><span class="op">(</span><span class="ident">rand</span><span class="op">,</span>&nbsp;<span class="ident">buf</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">k</span><span class="op">.</span><span class="ident">SetBytes</span><span class="op">(</span><span class="ident">buf</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">k</span><span class="op">.</span><span class="ident">Sign</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">k</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">Q</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">kInv</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">fermatInverse</span><span class="op">(</span><span class="ident">k</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Q</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Exp</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">G</span><span class="op">,</span>&nbsp;<span class="ident">k</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">P</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Q</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Sign</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">k</span><span class="op">.</span><span class="ident">SetBytes</span><span class="op">(</span><span class="ident">hash</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">X</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Q</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">kInv</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Q</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">Sign</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Verify&nbsp;verifies&nbsp;the&nbsp;signature&nbsp;in&nbsp;r,&nbsp;s&nbsp;of&nbsp;hash&nbsp;using&nbsp;the&nbsp;public&nbsp;key,&nbsp;pub.&nbsp;It</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;reports&nbsp;whether&nbsp;the&nbsp;signature&nbsp;is&nbsp;valid.</span><br>
<span class="lineno">245</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Note&nbsp;that&nbsp;FIPS&nbsp;186-3&nbsp;section&nbsp;4.6&nbsp;specifies&nbsp;that&nbsp;the&nbsp;hash&nbsp;should&nbsp;be&nbsp;truncated</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;to&nbsp;the&nbsp;byte-length&nbsp;of&nbsp;the&nbsp;subgroup.&nbsp;This&nbsp;function&nbsp;does&nbsp;not&nbsp;perform&nbsp;that</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;truncation&nbsp;itself.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">Verify</span><span class="op">(</span><span class="ident">pub</span>&nbsp;<span class="op">*</span><span class="ident">PublicKey</span><span class="op">,</span>&nbsp;<span class="ident">hash</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;FIPS&nbsp;186-3,&nbsp;section&nbsp;4.7</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Sign</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">pub</span><span class="op">.</span><span class="ident">Q</span><span class="op">)</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">Sign</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">pub</span><span class="op">.</span><span class="ident">Q</span><span class="op">)</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">ModInverse</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">pub</span><span class="op">.</span><span class="ident">Q</span><span class="op">)</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">pub</span><span class="op">.</span><span class="ident">Q</span><span class="op">.</span><span class="ident">BitLen</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">&amp;</span><span class="num">7</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">SetBytes</span><span class="op">(</span><span class="ident">hash</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u1</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">u1</span><span class="op">,</span>&nbsp;<span class="ident">pub</span><span class="op">.</span><span class="ident">Q</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u2</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">w</span><span class="op">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u2</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">u2</span><span class="op">,</span>&nbsp;<span class="ident">pub</span><span class="op">.</span><span class="ident">Q</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">u1</span><span class="op">.</span><span class="ident">Exp</span><span class="op">(</span><span class="ident">pub</span><span class="op">.</span><span class="ident">G</span><span class="op">,</span>&nbsp;<span class="ident">u1</span><span class="op">,</span>&nbsp;<span class="ident">pub</span><span class="op">.</span><span class="ident">P</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u2</span><span class="op">.</span><span class="ident">Exp</span><span class="op">(</span><span class="ident">pub</span><span class="op">.</span><span class="ident">Y</span><span class="op">,</span>&nbsp;<span class="ident">u2</span><span class="op">,</span>&nbsp;<span class="ident">pub</span><span class="op">.</span><span class="ident">P</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">v</span><span class="op">,</span>&nbsp;<span class="ident">u2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">v</span><span class="op">,</span>&nbsp;<span class="ident">pub</span><span class="op">.</span><span class="ident">P</span><span class="op">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">v</span><span class="op">,</span>&nbsp;<span class="ident">pub</span><span class="op">.</span><span class="ident">Q</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
