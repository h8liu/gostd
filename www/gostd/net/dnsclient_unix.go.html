<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3574695">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3574750">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3574804">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3574855">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3574920">//&nbsp;DNS&nbsp;client:&nbsp;see&nbsp;RFC&nbsp;1035.</span><br>
<span class="lineno"></span><span class="comment" id="3574949">//&nbsp;Has&nbsp;to&nbsp;be&nbsp;linked&nbsp;into&nbsp;package&nbsp;net&nbsp;for&nbsp;Dial.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3574997">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span><span class="comment" id="3575011">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;potentially&nbsp;handle&nbsp;many&nbsp;outstanding&nbsp;lookups&nbsp;faster.</span><br>
<span class="lineno"></span><span class="comment" id="3575072">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;have&nbsp;a&nbsp;small&nbsp;cache.</span><br>
<span class="lineno"></span><span class="comment" id="3575101">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;UDP&nbsp;source&nbsp;port&nbsp;(net.Dial&nbsp;should&nbsp;do&nbsp;that&nbsp;for&nbsp;us).</span><br>
<span class="lineno"></span><span class="comment" id="3575161">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3575185">package</span>&nbsp;<span class="ident" id="3575193">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3575198">import</span>&nbsp;<span class="op" id="3575205">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3575208">&#34;errors&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3575218">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3575224">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3575237">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3575243">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3575251">&#34;time&#34;</span><br>
<span class="lineno">25</span><span class="op" id="3575258">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3575261">//&nbsp;A&nbsp;dnsConn&nbsp;represents&nbsp;a&nbsp;DNS&nbsp;transport&nbsp;endpoint.</span><br>
<span class="lineno"></span><span class="keyword" id="3575311">type</span>&nbsp;<span class="ident" id="3575316">dnsConn</span>&nbsp;<span class="keyword" id="3575324">interface</span>&nbsp;<span class="op" id="3575334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3575337">Conn</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3575344">//&nbsp;readDNSResponse&nbsp;reads&nbsp;a&nbsp;DNS&nbsp;response&nbsp;message&nbsp;from&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3575406">//&nbsp;transport&nbsp;endpoint&nbsp;and&nbsp;returns&nbsp;the&nbsp;received&nbsp;DNS&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3575467">//&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3575480">readDNSResponse</span><span class="op" id="3575495">(</span><span class="op" id="3575496">)</span>&nbsp;<span class="op" id="3575498">(</span><span class="op" id="3575499">*</span><span class="ident" id="3575500">dnsMsg</span><span class="op" id="3575506">,</span>&nbsp;<span class="builtintype" id="3575508">error</span><span class="op" id="3575513">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3575517">//&nbsp;writeDNSQuery&nbsp;writes&nbsp;a&nbsp;DNS&nbsp;query&nbsp;message&nbsp;to&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3575573">//&nbsp;connection&nbsp;endpoint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3575598">writeDNSQuery</span><span class="op" id="3575611">(</span><span class="op" id="3575612">*</span><span class="ident" id="3575613">dnsMsg</span><span class="op" id="3575619">)</span>&nbsp;<span class="builtintype" id="3575621">error</span><br>
<span class="lineno"></span><span class="op" id="3575627">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3575630">func</span>&nbsp;<span class="op" id="3575635">(</span><span class="ident" id="3575636">c</span>&nbsp;<span class="op" id="3575638">*</span><span class="ident" id="3575639">UDPConn</span><span class="op" id="3575646">)</span>&nbsp;<span class="ident" id="3575648">readDNSResponse</span><span class="op" id="3575663">(</span><span class="op" id="3575664">)</span>&nbsp;<span class="op" id="3575666">(</span><span class="op" id="3575667">*</span><span class="ident" id="3575668">dnsMsg</span><span class="op" id="3575674">,</span>&nbsp;<span class="builtintype" id="3575676">error</span><span class="op" id="3575681">)</span>&nbsp;<span class="op" id="3575683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3575686">b</span>&nbsp;<span class="op" id="3575688">:=</span>&nbsp;<span class="builtinfunc" id="3575691">make</span><span class="op" id="3575695">(</span><span class="op" id="3575696">[</span><span class="op" id="3575697">]</span><span class="builtintype" id="3575698">byte</span><span class="op" id="3575702">,</span>&nbsp;<span class="num" id="3575704">512</span><span class="op" id="3575707">)</span>&nbsp;<span class="comment" id="3575709">//&nbsp;see&nbsp;RFC&nbsp;1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3575726">n</span><span class="op" id="3575727">,</span>&nbsp;<span class="ident" id="3575729">err</span>&nbsp;<span class="op" id="3575733">:=</span>&nbsp;<span class="ident" id="3575736">c</span><span class="op" id="3575737">.</span><span class="ident" id="3575738">Read</span><span class="op" id="3575742">(</span><span class="ident" id="3575743">b</span><span class="op" id="3575744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3575747">if</span>&nbsp;<span class="ident" id="3575750">err</span>&nbsp;<span class="op" id="3575754">!=</span>&nbsp;<span class="ident" id="3575757">nil</span>&nbsp;<span class="op" id="3575761">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3575765">return</span>&nbsp;<span class="ident" id="3575772">nil</span><span class="op" id="3575775">,</span>&nbsp;<span class="ident" id="3575777">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3575782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3575785">msg</span>&nbsp;<span class="op" id="3575789">:=</span>&nbsp;<span class="op" id="3575792">&amp;</span><span class="ident" id="3575793">dnsMsg</span><span class="op" id="3575799">{</span><span class="op" id="3575800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3575803">if</span>&nbsp;<span class="op" id="3575806">!</span><span class="ident" id="3575807">msg</span><span class="op" id="3575810">.</span><span class="ident" id="3575811">Unpack</span><span class="op" id="3575817">(</span><span class="ident" id="3575818">b</span><span class="op" id="3575819">[</span><span class="op" id="3575820">:</span><span class="ident" id="3575821">n</span><span class="op" id="3575822">]</span><span class="op" id="3575823">)</span>&nbsp;<span class="op" id="3575825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3575829">return</span>&nbsp;<span class="ident" id="3575836">nil</span><span class="op" id="3575839">,</span>&nbsp;<span class="ident" id="3575841">errors</span><span class="op" id="3575847">.</span><span class="ident" id="3575848">New</span><span class="op" id="3575851">(</span><span class="string" id="3575852">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3575882">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3575885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3575888">return</span>&nbsp;<span class="ident" id="3575895">msg</span><span class="op" id="3575898">,</span>&nbsp;<span class="ident" id="3575900">nil</span><br>
<span class="lineno"></span><span class="op" id="3575904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3575907">func</span>&nbsp;<span class="op" id="3575912">(</span><span class="ident" id="3575913">c</span>&nbsp;<span class="op" id="3575915">*</span><span class="ident" id="3575916">UDPConn</span><span class="op" id="3575923">)</span>&nbsp;<span class="ident" id="3575925">writeDNSQuery</span><span class="op" id="3575938">(</span><span class="ident" id="3575939">msg</span>&nbsp;<span class="op" id="3575943">*</span><span class="ident" id="3575944">dnsMsg</span><span class="op" id="3575950">)</span>&nbsp;<span class="builtintype" id="3575952">error</span>&nbsp;<span class="op" id="3575958">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3575961">b</span><span class="op" id="3575962">,</span>&nbsp;<span class="ident" id="3575964">ok</span>&nbsp;<span class="op" id="3575967">:=</span>&nbsp;<span class="ident" id="3575970">msg</span><span class="op" id="3575973">.</span><span class="ident" id="3575974">Pack</span><span class="op" id="3575978">(</span><span class="op" id="3575979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3575982">if</span>&nbsp;<span class="op" id="3575985">!</span><span class="ident" id="3575986">ok</span>&nbsp;<span class="op" id="3575989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3575993">return</span>&nbsp;<span class="ident" id="3576000">errors</span><span class="op" id="3576006">.</span><span class="ident" id="3576007">New</span><span class="op" id="3576010">(</span><span class="string" id="3576011">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3576039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3576042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576045">if</span>&nbsp;<span class="ident" id="3576048">_</span><span class="op" id="3576049">,</span>&nbsp;<span class="ident" id="3576051">err</span>&nbsp;<span class="op" id="3576055">:=</span>&nbsp;<span class="ident" id="3576058">c</span><span class="op" id="3576059">.</span><span class="ident" id="3576060">Write</span><span class="op" id="3576065">(</span><span class="ident" id="3576066">b</span><span class="op" id="3576067">)</span><span class="op" id="3576068">;</span>&nbsp;<span class="ident" id="3576070">err</span>&nbsp;<span class="op" id="3576074">!=</span>&nbsp;<span class="ident" id="3576077">nil</span>&nbsp;<span class="op" id="3576081">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576085">return</span>&nbsp;<span class="ident" id="3576092">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3576097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576100">return</span>&nbsp;<span class="ident" id="3576107">nil</span><br>
<span class="lineno"></span><span class="op" id="3576111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="3576114">func</span>&nbsp;<span class="op" id="3576119">(</span><span class="ident" id="3576120">c</span>&nbsp;<span class="op" id="3576122">*</span><span class="ident" id="3576123">TCPConn</span><span class="op" id="3576130">)</span>&nbsp;<span class="ident" id="3576132">readDNSResponse</span><span class="op" id="3576147">(</span><span class="op" id="3576148">)</span>&nbsp;<span class="op" id="3576150">(</span><span class="op" id="3576151">*</span><span class="ident" id="3576152">dnsMsg</span><span class="op" id="3576158">,</span>&nbsp;<span class="builtintype" id="3576160">error</span><span class="op" id="3576165">)</span>&nbsp;<span class="op" id="3576167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576170">b</span>&nbsp;<span class="op" id="3576172">:=</span>&nbsp;<span class="builtinfunc" id="3576175">make</span><span class="op" id="3576179">(</span><span class="op" id="3576180">[</span><span class="op" id="3576181">]</span><span class="builtintype" id="3576182">byte</span><span class="op" id="3576186">,</span>&nbsp;<span class="num" id="3576188">1280</span><span class="op" id="3576192">)</span>&nbsp;<span class="comment" id="3576194">//&nbsp;1280&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;initial&nbsp;size&nbsp;for&nbsp;IP&nbsp;over&nbsp;Ethernet,&nbsp;see&nbsp;RFC&nbsp;4035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576267">if</span>&nbsp;<span class="ident" id="3576270">_</span><span class="op" id="3576271">,</span>&nbsp;<span class="ident" id="3576273">err</span>&nbsp;<span class="op" id="3576277">:=</span>&nbsp;<span class="ident" id="3576280">io</span><span class="op" id="3576282">.</span><span class="ident" id="3576283">ReadFull</span><span class="op" id="3576291">(</span><span class="ident" id="3576292">c</span><span class="op" id="3576293">,</span>&nbsp;<span class="ident" id="3576295">b</span><span class="op" id="3576296">[</span><span class="op" id="3576297">:</span><span class="num" id="3576298">2</span><span class="op" id="3576299">]</span><span class="op" id="3576300">)</span><span class="op" id="3576301">;</span>&nbsp;<span class="ident" id="3576303">err</span>&nbsp;<span class="op" id="3576307">!=</span>&nbsp;<span class="ident" id="3576310">nil</span>&nbsp;<span class="op" id="3576314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576318">return</span>&nbsp;<span class="ident" id="3576325">nil</span><span class="op" id="3576328">,</span>&nbsp;<span class="ident" id="3576330">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3576335">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576338">l</span>&nbsp;<span class="op" id="3576340">:=</span>&nbsp;<span class="builtintype" id="3576343">int</span><span class="op" id="3576346">(</span><span class="ident" id="3576347">b</span><span class="op" id="3576348">[</span><span class="num" id="3576349">0</span><span class="op" id="3576350">]</span><span class="op" id="3576351">)</span><span class="op" id="3576352">&lt;&lt;</span><span class="num" id="3576354">8</span>&nbsp;<span class="op" id="3576356">|</span>&nbsp;<span class="builtintype" id="3576358">int</span><span class="op" id="3576361">(</span><span class="ident" id="3576362">b</span><span class="op" id="3576363">[</span><span class="num" id="3576364">1</span><span class="op" id="3576365">]</span><span class="op" id="3576366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576369">if</span>&nbsp;<span class="ident" id="3576372">l</span>&nbsp;<span class="op" id="3576374">&gt;</span>&nbsp;<span class="builtinfunc" id="3576376">len</span><span class="op" id="3576379">(</span><span class="ident" id="3576380">b</span><span class="op" id="3576381">)</span>&nbsp;<span class="op" id="3576383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576387">b</span>&nbsp;<span class="op" id="3576389">=</span>&nbsp;<span class="builtinfunc" id="3576391">make</span><span class="op" id="3576395">(</span><span class="op" id="3576396">[</span><span class="op" id="3576397">]</span><span class="builtintype" id="3576398">byte</span><span class="op" id="3576402">,</span>&nbsp;<span class="ident" id="3576404">l</span><span class="op" id="3576405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3576408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576411">n</span><span class="op" id="3576412">,</span>&nbsp;<span class="ident" id="3576414">err</span>&nbsp;<span class="op" id="3576418">:=</span>&nbsp;<span class="ident" id="3576421">io</span><span class="op" id="3576423">.</span><span class="ident" id="3576424">ReadFull</span><span class="op" id="3576432">(</span><span class="ident" id="3576433">c</span><span class="op" id="3576434">,</span>&nbsp;<span class="ident" id="3576436">b</span><span class="op" id="3576437">[</span><span class="op" id="3576438">:</span><span class="ident" id="3576439">l</span><span class="op" id="3576440">]</span><span class="op" id="3576441">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576444">if</span>&nbsp;<span class="ident" id="3576447">err</span>&nbsp;<span class="op" id="3576451">!=</span>&nbsp;<span class="ident" id="3576454">nil</span>&nbsp;<span class="op" id="3576458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576462">return</span>&nbsp;<span class="ident" id="3576469">nil</span><span class="op" id="3576472">,</span>&nbsp;<span class="ident" id="3576474">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3576479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576482">msg</span>&nbsp;<span class="op" id="3576486">:=</span>&nbsp;<span class="op" id="3576489">&amp;</span><span class="ident" id="3576490">dnsMsg</span><span class="op" id="3576496">{</span><span class="op" id="3576497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576500">if</span>&nbsp;<span class="op" id="3576503">!</span><span class="ident" id="3576504">msg</span><span class="op" id="3576507">.</span><span class="ident" id="3576508">Unpack</span><span class="op" id="3576514">(</span><span class="ident" id="3576515">b</span><span class="op" id="3576516">[</span><span class="op" id="3576517">:</span><span class="ident" id="3576518">n</span><span class="op" id="3576519">]</span><span class="op" id="3576520">)</span>&nbsp;<span class="op" id="3576522">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576526">return</span>&nbsp;<span class="ident" id="3576533">nil</span><span class="op" id="3576536">,</span>&nbsp;<span class="ident" id="3576538">errors</span><span class="op" id="3576544">.</span><span class="ident" id="3576545">New</span><span class="op" id="3576548">(</span><span class="string" id="3576549">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3576579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3576582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576585">return</span>&nbsp;<span class="ident" id="3576592">msg</span><span class="op" id="3576595">,</span>&nbsp;<span class="ident" id="3576597">nil</span><br>
<span class="lineno"></span><span class="op" id="3576601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="3576604">func</span>&nbsp;<span class="op" id="3576609">(</span><span class="ident" id="3576610">c</span>&nbsp;<span class="op" id="3576612">*</span><span class="ident" id="3576613">TCPConn</span><span class="op" id="3576620">)</span>&nbsp;<span class="ident" id="3576622">writeDNSQuery</span><span class="op" id="3576635">(</span><span class="ident" id="3576636">msg</span>&nbsp;<span class="op" id="3576640">*</span><span class="ident" id="3576641">dnsMsg</span><span class="op" id="3576647">)</span>&nbsp;<span class="builtintype" id="3576649">error</span>&nbsp;<span class="op" id="3576655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576658">b</span><span class="op" id="3576659">,</span>&nbsp;<span class="ident" id="3576661">ok</span>&nbsp;<span class="op" id="3576664">:=</span>&nbsp;<span class="ident" id="3576667">msg</span><span class="op" id="3576670">.</span><span class="ident" id="3576671">Pack</span><span class="op" id="3576675">(</span><span class="op" id="3576676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576679">if</span>&nbsp;<span class="op" id="3576682">!</span><span class="ident" id="3576683">ok</span>&nbsp;<span class="op" id="3576686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576690">return</span>&nbsp;<span class="ident" id="3576697">errors</span><span class="op" id="3576703">.</span><span class="ident" id="3576704">New</span><span class="op" id="3576707">(</span><span class="string" id="3576708">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3576736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3576739">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576742">l</span>&nbsp;<span class="op" id="3576744">:=</span>&nbsp;<span class="builtintype" id="3576747">uint16</span><span class="op" id="3576753">(</span><span class="builtinfunc" id="3576754">len</span><span class="op" id="3576757">(</span><span class="ident" id="3576758">b</span><span class="op" id="3576759">)</span><span class="op" id="3576760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576763">b</span>&nbsp;<span class="op" id="3576765">=</span>&nbsp;<span class="builtinfunc" id="3576767">append</span><span class="op" id="3576773">(</span><span class="op" id="3576774">[</span><span class="op" id="3576775">]</span><span class="builtintype" id="3576776">byte</span><span class="op" id="3576780">{</span><span class="builtintype" id="3576781">byte</span><span class="op" id="3576785">(</span><span class="ident" id="3576786">l</span>&nbsp;<span class="op" id="3576788">&gt;&gt;</span>&nbsp;<span class="num" id="3576791">8</span><span class="op" id="3576792">)</span><span class="op" id="3576793">,</span>&nbsp;<span class="builtintype" id="3576795">byte</span><span class="op" id="3576799">(</span><span class="ident" id="3576800">l</span><span class="op" id="3576801">)</span><span class="op" id="3576802">}</span><span class="op" id="3576803">,</span>&nbsp;<span class="ident" id="3576805">b</span><span class="op" id="3576806">...</span><span class="op" id="3576809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576812">if</span>&nbsp;<span class="ident" id="3576815">_</span><span class="op" id="3576816">,</span>&nbsp;<span class="ident" id="3576818">err</span>&nbsp;<span class="op" id="3576822">:=</span>&nbsp;<span class="ident" id="3576825">c</span><span class="op" id="3576826">.</span><span class="ident" id="3576827">Write</span><span class="op" id="3576832">(</span><span class="ident" id="3576833">b</span><span class="op" id="3576834">)</span><span class="op" id="3576835">;</span>&nbsp;<span class="ident" id="3576837">err</span>&nbsp;<span class="op" id="3576841">!=</span>&nbsp;<span class="ident" id="3576844">nil</span>&nbsp;<span class="op" id="3576848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576852">return</span>&nbsp;<span class="ident" id="3576859">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3576864">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576867">return</span>&nbsp;<span class="ident" id="3576874">nil</span><br>
<span class="lineno"></span><span class="op" id="3576878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3576881">func</span>&nbsp;<span class="op" id="3576886">(</span><span class="ident" id="3576887">d</span>&nbsp;<span class="op" id="3576889">*</span><span class="ident" id="3576890">Dialer</span><span class="op" id="3576896">)</span>&nbsp;<span class="ident" id="3576898">dialDNS</span><span class="op" id="3576905">(</span><span class="ident" id="3576906">network</span><span class="op" id="3576913">,</span>&nbsp;<span class="ident" id="3576915">server</span>&nbsp;<span class="builtintype" id="3576922">string</span><span class="op" id="3576928">)</span>&nbsp;<span class="op" id="3576930">(</span><span class="ident" id="3576931">dnsConn</span><span class="op" id="3576938">,</span>&nbsp;<span class="builtintype" id="3576940">error</span><span class="op" id="3576945">)</span>&nbsp;<span class="op" id="3576947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576950">switch</span>&nbsp;<span class="ident" id="3576957">network</span>&nbsp;<span class="op" id="3576965">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576968">case</span>&nbsp;<span class="string" id="3576973">&#34;tcp&#34;</span><span class="op" id="3576978">,</span>&nbsp;<span class="string" id="3576980">&#34;tcp4&#34;</span><span class="op" id="3576986">,</span>&nbsp;<span class="string" id="3576988">&#34;tcp6&#34;</span><span class="op" id="3576994">,</span>&nbsp;<span class="string" id="3576996">&#34;udp&#34;</span><span class="op" id="3577001">,</span>&nbsp;<span class="string" id="3577003">&#34;udp4&#34;</span><span class="op" id="3577009">,</span>&nbsp;<span class="string" id="3577011">&#34;udp6&#34;</span><span class="op" id="3577017">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577020">default</span><span class="op" id="3577027">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577031">return</span>&nbsp;<span class="ident" id="3577038">nil</span><span class="op" id="3577041">,</span>&nbsp;<span class="ident" id="3577043">UnknownNetworkError</span><span class="op" id="3577062">(</span><span class="ident" id="3577063">network</span><span class="op" id="3577070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3577073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3577076">//&nbsp;Calling&nbsp;Dial&nbsp;here&nbsp;is&nbsp;scary&nbsp;--&nbsp;we&nbsp;have&nbsp;to&nbsp;be&nbsp;sure&nbsp;not&nbsp;to</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3577136">//&nbsp;dial&nbsp;a&nbsp;name&nbsp;that&nbsp;will&nbsp;require&nbsp;a&nbsp;DNS&nbsp;lookup,&nbsp;or&nbsp;Dial&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3577197">//&nbsp;call&nbsp;back&nbsp;here&nbsp;to&nbsp;translate&nbsp;it.&nbsp;The&nbsp;DNS&nbsp;config&nbsp;parser&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3577259">//&nbsp;already&nbsp;checked&nbsp;that&nbsp;all&nbsp;the&nbsp;cfg.servers[i]&nbsp;are&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3577314">//&nbsp;addresses,&nbsp;which&nbsp;Dial&nbsp;will&nbsp;use&nbsp;without&nbsp;a&nbsp;DNS&nbsp;lookup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577371">c</span><span class="op" id="3577372">,</span>&nbsp;<span class="ident" id="3577374">err</span>&nbsp;<span class="op" id="3577378">:=</span>&nbsp;<span class="ident" id="3577381">d</span><span class="op" id="3577382">.</span><span class="ident" id="3577383">Dial</span><span class="op" id="3577387">(</span><span class="ident" id="3577388">network</span><span class="op" id="3577395">,</span>&nbsp;<span class="ident" id="3577397">server</span><span class="op" id="3577403">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577406">if</span>&nbsp;<span class="ident" id="3577409">err</span>&nbsp;<span class="op" id="3577413">!=</span>&nbsp;<span class="ident" id="3577416">nil</span>&nbsp;<span class="op" id="3577420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577424">return</span>&nbsp;<span class="ident" id="3577431">nil</span><span class="op" id="3577434">,</span>&nbsp;<span class="ident" id="3577436">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3577441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577444">switch</span>&nbsp;<span class="ident" id="3577451">network</span>&nbsp;<span class="op" id="3577459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577462">case</span>&nbsp;<span class="string" id="3577467">&#34;tcp&#34;</span><span class="op" id="3577472">,</span>&nbsp;<span class="string" id="3577474">&#34;tcp4&#34;</span><span class="op" id="3577480">,</span>&nbsp;<span class="string" id="3577482">&#34;tcp6&#34;</span><span class="op" id="3577488">:</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577492">return</span>&nbsp;<span class="ident" id="3577499">c</span><span class="op" id="3577500">.</span><span class="op" id="3577501">(</span><span class="op" id="3577502">*</span><span class="ident" id="3577503">TCPConn</span><span class="op" id="3577510">)</span><span class="op" id="3577511">,</span>&nbsp;<span class="ident" id="3577513">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577518">case</span>&nbsp;<span class="string" id="3577523">&#34;udp&#34;</span><span class="op" id="3577528">,</span>&nbsp;<span class="string" id="3577530">&#34;udp4&#34;</span><span class="op" id="3577536">,</span>&nbsp;<span class="string" id="3577538">&#34;udp6&#34;</span><span class="op" id="3577544">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577548">return</span>&nbsp;<span class="ident" id="3577555">c</span><span class="op" id="3577556">.</span><span class="op" id="3577557">(</span><span class="op" id="3577558">*</span><span class="ident" id="3577559">UDPConn</span><span class="op" id="3577566">)</span><span class="op" id="3577567">,</span>&nbsp;<span class="ident" id="3577569">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3577574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3577577">panic</span><span class="op" id="3577582">(</span><span class="string" id="3577583">&#34;unreachable&#34;</span><span class="op" id="3577596">)</span><br>
<span class="lineno">120</span><span class="op" id="3577598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3577601">//&nbsp;exchange&nbsp;sends&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;connection&nbsp;and&nbsp;hopes&nbsp;for&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3577671">func</span>&nbsp;<span class="ident" id="3577676">exchange</span><span class="op" id="3577684">(</span><span class="ident" id="3577685">server</span><span class="op" id="3577691">,</span>&nbsp;<span class="ident" id="3577693">name</span>&nbsp;<span class="builtintype" id="3577698">string</span><span class="op" id="3577704">,</span>&nbsp;<span class="ident" id="3577706">qtype</span>&nbsp;<span class="builtintype" id="3577712">uint16</span><span class="op" id="3577718">,</span>&nbsp;<span class="ident" id="3577720">timeout</span>&nbsp;<span class="ident" id="3577728">time</span><span class="op" id="3577732">.</span><span class="ident" id="3577733">Duration</span><span class="op" id="3577741">)</span>&nbsp;<span class="op" id="3577743">(</span><span class="op" id="3577744">*</span><span class="ident" id="3577745">dnsMsg</span><span class="op" id="3577751">,</span>&nbsp;<span class="builtintype" id="3577753">error</span><span class="op" id="3577758">)</span>&nbsp;<span class="op" id="3577760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577763">d</span>&nbsp;<span class="op" id="3577765">:=</span>&nbsp;<span class="ident" id="3577768">Dialer</span><span class="op" id="3577774">{</span><span class="ident" id="3577775">Timeout</span><span class="op" id="3577782">:</span>&nbsp;<span class="ident" id="3577784">timeout</span><span class="op" id="3577791">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577794">out</span>&nbsp;<span class="op" id="3577798">:=</span>&nbsp;<span class="ident" id="3577801">dnsMsg</span><span class="op" id="3577807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577811">dnsMsgHdr</span><span class="op" id="3577820">:</span>&nbsp;<span class="ident" id="3577822">dnsMsgHdr</span><span class="op" id="3577831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577836">recursion_desired</span><span class="op" id="3577853">:</span>&nbsp;<span class="builtintype" id="3577855">true</span><span class="op" id="3577859">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3577863">}</span><span class="op" id="3577864">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577868">question</span><span class="op" id="3577876">:</span>&nbsp;<span class="op" id="3577878">[</span><span class="op" id="3577879">]</span><span class="ident" id="3577880">dnsQuestion</span><span class="op" id="3577891">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3577896">{</span><span class="ident" id="3577897">name</span><span class="op" id="3577901">,</span>&nbsp;<span class="ident" id="3577903">qtype</span><span class="op" id="3577908">,</span>&nbsp;<span class="ident" id="3577910">dnsClassINET</span><span class="op" id="3577922">}</span><span class="op" id="3577923">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3577927">}</span><span class="op" id="3577928">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3577931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577934">for</span>&nbsp;<span class="ident" id="3577938">_</span><span class="op" id="3577939">,</span>&nbsp;<span class="ident" id="3577941">network</span>&nbsp;<span class="op" id="3577949">:=</span>&nbsp;<span class="keyword" id="3577952">range</span>&nbsp;<span class="op" id="3577958">[</span><span class="op" id="3577959">]</span><span class="builtintype" id="3577960">string</span><span class="op" id="3577966">{</span><span class="string" id="3577967">&#34;udp&#34;</span><span class="op" id="3577972">,</span>&nbsp;<span class="string" id="3577974">&#34;tcp&#34;</span><span class="op" id="3577979">}</span>&nbsp;<span class="op" id="3577981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577985">c</span><span class="op" id="3577986">,</span>&nbsp;<span class="ident" id="3577988">err</span>&nbsp;<span class="op" id="3577992">:=</span>&nbsp;<span class="ident" id="3577995">d</span><span class="op" id="3577996">.</span><span class="ident" id="3577997">dialDNS</span><span class="op" id="3578004">(</span><span class="ident" id="3578005">network</span><span class="op" id="3578012">,</span>&nbsp;<span class="ident" id="3578014">server</span><span class="op" id="3578020">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578024">if</span>&nbsp;<span class="ident" id="3578027">err</span>&nbsp;<span class="op" id="3578031">!=</span>&nbsp;<span class="ident" id="3578034">nil</span>&nbsp;<span class="op" id="3578038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578043">return</span>&nbsp;<span class="ident" id="3578050">nil</span><span class="op" id="3578053">,</span>&nbsp;<span class="ident" id="3578055">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3578061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578065">defer</span>&nbsp;<span class="ident" id="3578071">c</span><span class="op" id="3578072">.</span><span class="ident" id="3578073">Close</span><span class="op" id="3578078">(</span><span class="op" id="3578079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578083">if</span>&nbsp;<span class="ident" id="3578086">timeout</span>&nbsp;<span class="op" id="3578094">&gt;</span>&nbsp;<span class="num" id="3578096">0</span>&nbsp;<span class="op" id="3578098">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3578103">c</span><span class="op" id="3578104">.</span><span class="ident" id="3578105">SetDeadline</span><span class="op" id="3578116">(</span><span class="ident" id="3578117">time</span><span class="op" id="3578121">.</span><span class="ident" id="3578122">Now</span><span class="op" id="3578125">(</span><span class="op" id="3578126">)</span><span class="op" id="3578127">.</span><span class="ident" id="3578128">Add</span><span class="op" id="3578131">(</span><span class="ident" id="3578132">timeout</span><span class="op" id="3578139">)</span><span class="op" id="3578140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3578144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3578148">out</span><span class="op" id="3578151">.</span><span class="ident" id="3578152">id</span>&nbsp;<span class="op" id="3578155">=</span>&nbsp;<span class="builtintype" id="3578157">uint16</span><span class="op" id="3578163">(</span><span class="ident" id="3578164">rand</span><span class="op" id="3578168">.</span><span class="ident" id="3578169">Int</span><span class="op" id="3578172">(</span><span class="op" id="3578173">)</span><span class="op" id="3578174">)</span>&nbsp;<span class="op" id="3578176">^</span>&nbsp;<span class="builtintype" id="3578178">uint16</span><span class="op" id="3578184">(</span><span class="ident" id="3578185">time</span><span class="op" id="3578189">.</span><span class="ident" id="3578190">Now</span><span class="op" id="3578193">(</span><span class="op" id="3578194">)</span><span class="op" id="3578195">.</span><span class="ident" id="3578196">UnixNano</span><span class="op" id="3578204">(</span><span class="op" id="3578205">)</span><span class="op" id="3578206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578210">if</span>&nbsp;<span class="ident" id="3578213">err</span>&nbsp;<span class="op" id="3578217">:=</span>&nbsp;<span class="ident" id="3578220">c</span><span class="op" id="3578221">.</span><span class="ident" id="3578222">writeDNSQuery</span><span class="op" id="3578235">(</span><span class="op" id="3578236">&amp;</span><span class="ident" id="3578237">out</span><span class="op" id="3578240">)</span><span class="op" id="3578241">;</span>&nbsp;<span class="ident" id="3578243">err</span>&nbsp;<span class="op" id="3578247">!=</span>&nbsp;<span class="ident" id="3578250">nil</span>&nbsp;<span class="op" id="3578254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578259">return</span>&nbsp;<span class="ident" id="3578266">nil</span><span class="op" id="3578269">,</span>&nbsp;<span class="ident" id="3578271">err</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3578277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3578281">in</span><span class="op" id="3578283">,</span>&nbsp;<span class="ident" id="3578285">err</span>&nbsp;<span class="op" id="3578289">:=</span>&nbsp;<span class="ident" id="3578292">c</span><span class="op" id="3578293">.</span><span class="ident" id="3578294">readDNSResponse</span><span class="op" id="3578309">(</span><span class="op" id="3578310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578314">if</span>&nbsp;<span class="ident" id="3578317">err</span>&nbsp;<span class="op" id="3578321">!=</span>&nbsp;<span class="ident" id="3578324">nil</span>&nbsp;<span class="op" id="3578328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578333">return</span>&nbsp;<span class="ident" id="3578340">nil</span><span class="op" id="3578343">,</span>&nbsp;<span class="ident" id="3578345">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3578351">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578355">if</span>&nbsp;<span class="ident" id="3578358">in</span><span class="op" id="3578360">.</span><span class="ident" id="3578361">id</span>&nbsp;<span class="op" id="3578364">!=</span>&nbsp;<span class="ident" id="3578367">out</span><span class="op" id="3578370">.</span><span class="ident" id="3578371">id</span>&nbsp;<span class="op" id="3578374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578379">return</span>&nbsp;<span class="ident" id="3578386">nil</span><span class="op" id="3578389">,</span>&nbsp;<span class="ident" id="3578391">errors</span><span class="op" id="3578397">.</span><span class="ident" id="3578398">New</span><span class="op" id="3578401">(</span><span class="string" id="3578402">&#34;DNS&nbsp;message&nbsp;ID&nbsp;mismatch&#34;</span><span class="op" id="3578427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3578431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578435">if</span>&nbsp;<span class="ident" id="3578438">in</span><span class="op" id="3578440">.</span><span class="ident" id="3578441">truncated</span>&nbsp;<span class="op" id="3578451">{</span>&nbsp;<span class="comment" id="3578453">//&nbsp;see&nbsp;RFC&nbsp;5966</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578472">continue</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3578483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578487">return</span>&nbsp;<span class="ident" id="3578494">in</span><span class="op" id="3578496">,</span>&nbsp;<span class="ident" id="3578498">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3578503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578506">return</span>&nbsp;<span class="ident" id="3578513">nil</span><span class="op" id="3578516">,</span>&nbsp;<span class="ident" id="3578518">errors</span><span class="op" id="3578524">.</span><span class="ident" id="3578525">New</span><span class="op" id="3578528">(</span><span class="string" id="3578529">&#34;no&nbsp;answer&nbsp;from&nbsp;DNS&nbsp;server&#34;</span><span class="op" id="3578556">)</span><br>
<span class="lineno"></span><span class="op" id="3578558">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="3578561">//&nbsp;Do&nbsp;a&nbsp;lookup&nbsp;for&nbsp;a&nbsp;single&nbsp;name,&nbsp;which&nbsp;must&nbsp;be&nbsp;rooted</span><br>
<span class="lineno"></span><span class="comment" id="3578616">//&nbsp;(otherwise&nbsp;answer&nbsp;will&nbsp;not&nbsp;find&nbsp;the&nbsp;answers).</span><br>
<span class="lineno"></span><span class="keyword" id="3578665">func</span>&nbsp;<span class="ident" id="3578670">tryOneName</span><span class="op" id="3578680">(</span><span class="ident" id="3578681">cfg</span>&nbsp;<span class="op" id="3578685">*</span><span class="ident" id="3578686">dnsConfig</span><span class="op" id="3578695">,</span>&nbsp;<span class="ident" id="3578697">name</span>&nbsp;<span class="builtintype" id="3578702">string</span><span class="op" id="3578708">,</span>&nbsp;<span class="ident" id="3578710">qtype</span>&nbsp;<span class="builtintype" id="3578716">uint16</span><span class="op" id="3578722">)</span>&nbsp;<span class="op" id="3578724">(</span><span class="builtintype" id="3578725">string</span><span class="op" id="3578731">,</span>&nbsp;<span class="op" id="3578733">[</span><span class="op" id="3578734">]</span><span class="ident" id="3578735">dnsRR</span><span class="op" id="3578740">,</span>&nbsp;<span class="builtintype" id="3578742">error</span><span class="op" id="3578747">)</span>&nbsp;<span class="op" id="3578749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578752">if</span>&nbsp;<span class="builtinfunc" id="3578755">len</span><span class="op" id="3578758">(</span><span class="ident" id="3578759">cfg</span><span class="op" id="3578762">.</span><span class="ident" id="3578763">servers</span><span class="op" id="3578770">)</span>&nbsp;<span class="op" id="3578772">==</span>&nbsp;<span class="num" id="3578775">0</span>&nbsp;<span class="op" id="3578777">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578781">return</span>&nbsp;<span class="string" id="3578788">&#34;&#34;</span><span class="op" id="3578790">,</span>&nbsp;<span class="ident" id="3578792">nil</span><span class="op" id="3578795">,</span>&nbsp;<span class="op" id="3578797">&amp;</span><span class="ident" id="3578798">DNSError</span><span class="op" id="3578806">{</span><span class="ident" id="3578807">Err</span><span class="op" id="3578810">:</span>&nbsp;<span class="string" id="3578812">&#34;no&nbsp;DNS&nbsp;servers&#34;</span><span class="op" id="3578828">,</span>&nbsp;<span class="ident" id="3578830">Name</span><span class="op" id="3578834">:</span>&nbsp;<span class="ident" id="3578836">name</span><span class="op" id="3578840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3578843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578846">if</span>&nbsp;<span class="builtinfunc" id="3578849">len</span><span class="op" id="3578852">(</span><span class="ident" id="3578853">name</span><span class="op" id="3578857">)</span>&nbsp;<span class="op" id="3578859">&gt;=</span>&nbsp;<span class="num" id="3578862">256</span>&nbsp;<span class="op" id="3578866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578870">return</span>&nbsp;<span class="string" id="3578877">&#34;&#34;</span><span class="op" id="3578879">,</span>&nbsp;<span class="ident" id="3578881">nil</span><span class="op" id="3578884">,</span>&nbsp;<span class="op" id="3578886">&amp;</span><span class="ident" id="3578887">DNSError</span><span class="op" id="3578895">{</span><span class="ident" id="3578896">Err</span><span class="op" id="3578899">:</span>&nbsp;<span class="string" id="3578901">&#34;DNS&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="3578920">,</span>&nbsp;<span class="ident" id="3578922">Name</span><span class="op" id="3578926">:</span>&nbsp;<span class="ident" id="3578928">name</span><span class="op" id="3578932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3578935">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3578938">timeout</span>&nbsp;<span class="op" id="3578946">:=</span>&nbsp;<span class="ident" id="3578949">time</span><span class="op" id="3578953">.</span><span class="ident" id="3578954">Duration</span><span class="op" id="3578962">(</span><span class="ident" id="3578963">cfg</span><span class="op" id="3578966">.</span><span class="ident" id="3578967">timeout</span><span class="op" id="3578974">)</span>&nbsp;<span class="op" id="3578976">*</span>&nbsp;<span class="ident" id="3578978">time</span><span class="op" id="3578982">.</span><span class="ident" id="3578983">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578991">var</span>&nbsp;<span class="ident" id="3578995">lastErr</span>&nbsp;<span class="builtintype" id="3579003">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579010">for</span>&nbsp;<span class="ident" id="3579014">i</span>&nbsp;<span class="op" id="3579016">:=</span>&nbsp;<span class="num" id="3579019">0</span><span class="op" id="3579020">;</span>&nbsp;<span class="ident" id="3579022">i</span>&nbsp;<span class="op" id="3579024">&lt;</span>&nbsp;<span class="ident" id="3579026">cfg</span><span class="op" id="3579029">.</span><span class="ident" id="3579030">attempts</span><span class="op" id="3579038">;</span>&nbsp;<span class="ident" id="3579040">i</span><span class="op" id="3579041">++</span>&nbsp;<span class="op" id="3579044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579048">for</span>&nbsp;<span class="ident" id="3579052">_</span><span class="op" id="3579053">,</span>&nbsp;<span class="ident" id="3579055">server</span>&nbsp;<span class="op" id="3579062">:=</span>&nbsp;<span class="keyword" id="3579065">range</span>&nbsp;<span class="ident" id="3579071">cfg</span><span class="op" id="3579074">.</span><span class="ident" id="3579075">servers</span>&nbsp;<span class="op" id="3579083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579088">server</span>&nbsp;<span class="op" id="3579095">=</span>&nbsp;<span class="ident" id="3579097">JoinHostPort</span><span class="op" id="3579109">(</span><span class="ident" id="3579110">server</span><span class="op" id="3579116">,</span>&nbsp;<span class="string" id="3579118">&#34;53&#34;</span><span class="op" id="3579122">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579127">msg</span><span class="op" id="3579130">,</span>&nbsp;<span class="ident" id="3579132">err</span>&nbsp;<span class="op" id="3579136">:=</span>&nbsp;<span class="ident" id="3579139">exchange</span><span class="op" id="3579147">(</span><span class="ident" id="3579148">server</span><span class="op" id="3579154">,</span>&nbsp;<span class="ident" id="3579156">name</span><span class="op" id="3579160">,</span>&nbsp;<span class="ident" id="3579162">qtype</span><span class="op" id="3579167">,</span>&nbsp;<span class="ident" id="3579169">timeout</span><span class="op" id="3579176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579181">if</span>&nbsp;<span class="ident" id="3579184">err</span>&nbsp;<span class="op" id="3579188">!=</span>&nbsp;<span class="ident" id="3579191">nil</span>&nbsp;<span class="op" id="3579195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579201">lastErr</span>&nbsp;<span class="op" id="3579209">=</span>&nbsp;<span class="op" id="3579211">&amp;</span><span class="ident" id="3579212">DNSError</span><span class="op" id="3579220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579227">Err</span><span class="op" id="3579230">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579235">err</span><span class="op" id="3579238">.</span><span class="ident" id="3579239">Error</span><span class="op" id="3579244">(</span><span class="op" id="3579245">)</span><span class="op" id="3579246">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579253">Name</span><span class="op" id="3579257">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3579261">name</span><span class="op" id="3579265">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579272">Server</span><span class="op" id="3579278">:</span>&nbsp;<span class="ident" id="3579280">server</span><span class="op" id="3579286">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3579292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579298">if</span>&nbsp;<span class="ident" id="3579301">nerr</span><span class="op" id="3579305">,</span>&nbsp;<span class="ident" id="3579307">ok</span>&nbsp;<span class="op" id="3579310">:=</span>&nbsp;<span class="ident" id="3579313">err</span><span class="op" id="3579316">.</span><span class="op" id="3579317">(</span><span class="ident" id="3579318">Error</span><span class="op" id="3579323">)</span><span class="op" id="3579324">;</span>&nbsp;<span class="ident" id="3579326">ok</span>&nbsp;<span class="op" id="3579329">&amp;&amp;</span>&nbsp;<span class="ident" id="3579332">nerr</span><span class="op" id="3579336">.</span><span class="ident" id="3579337">Timeout</span><span class="op" id="3579344">(</span><span class="op" id="3579345">)</span>&nbsp;<span class="op" id="3579347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579354">lastErr</span><span class="op" id="3579361">.</span><span class="op" id="3579362">(</span><span class="op" id="3579363">*</span><span class="ident" id="3579364">DNSError</span><span class="op" id="3579372">)</span><span class="op" id="3579373">.</span><span class="ident" id="3579374">IsTimeout</span>&nbsp;<span class="op" id="3579384">=</span>&nbsp;<span class="builtintype" id="3579386">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3579395">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579401">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3579413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579418">cname</span><span class="op" id="3579423">,</span>&nbsp;<span class="ident" id="3579425">addrs</span><span class="op" id="3579430">,</span>&nbsp;<span class="ident" id="3579432">err</span>&nbsp;<span class="op" id="3579436">:=</span>&nbsp;<span class="ident" id="3579439">answer</span><span class="op" id="3579445">(</span><span class="ident" id="3579446">name</span><span class="op" id="3579450">,</span>&nbsp;<span class="ident" id="3579452">server</span><span class="op" id="3579458">,</span>&nbsp;<span class="ident" id="3579460">msg</span><span class="op" id="3579463">,</span>&nbsp;<span class="ident" id="3579465">qtype</span><span class="op" id="3579470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579475">if</span>&nbsp;<span class="ident" id="3579478">err</span>&nbsp;<span class="op" id="3579482">==</span>&nbsp;<span class="ident" id="3579485">nil</span>&nbsp;<span class="op" id="3579489">||</span>&nbsp;<span class="ident" id="3579492">err</span><span class="op" id="3579495">.</span><span class="op" id="3579496">(</span><span class="op" id="3579497">*</span><span class="ident" id="3579498">DNSError</span><span class="op" id="3579506">)</span><span class="op" id="3579507">.</span><span class="ident" id="3579508">Err</span>&nbsp;<span class="op" id="3579512">==</span>&nbsp;<span class="ident" id="3579515">noSuchHost</span>&nbsp;<span class="op" id="3579526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579532">return</span>&nbsp;<span class="ident" id="3579539">cname</span><span class="op" id="3579544">,</span>&nbsp;<span class="ident" id="3579546">addrs</span><span class="op" id="3579551">,</span>&nbsp;<span class="ident" id="3579553">err</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3579560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579565">lastErr</span>&nbsp;<span class="op" id="3579573">=</span>&nbsp;<span class="ident" id="3579575">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3579581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3579584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579587">return</span>&nbsp;<span class="string" id="3579594">&#34;&#34;</span><span class="op" id="3579596">,</span>&nbsp;<span class="ident" id="3579598">nil</span><span class="op" id="3579601">,</span>&nbsp;<span class="ident" id="3579603">lastErr</span><br>
<span class="lineno">195</span><span class="op" id="3579611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3579614">func</span>&nbsp;<span class="ident" id="3579619">convertRR_A</span><span class="op" id="3579630">(</span><span class="ident" id="3579631">records</span>&nbsp;<span class="op" id="3579639">[</span><span class="op" id="3579640">]</span><span class="ident" id="3579641">dnsRR</span><span class="op" id="3579646">)</span>&nbsp;<span class="op" id="3579648">[</span><span class="op" id="3579649">]</span><span class="ident" id="3579650">IP</span>&nbsp;<span class="op" id="3579653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579656">addrs</span>&nbsp;<span class="op" id="3579662">:=</span>&nbsp;<span class="builtinfunc" id="3579665">make</span><span class="op" id="3579669">(</span><span class="op" id="3579670">[</span><span class="op" id="3579671">]</span><span class="ident" id="3579672">IP</span><span class="op" id="3579674">,</span>&nbsp;<span class="builtinfunc" id="3579676">len</span><span class="op" id="3579679">(</span><span class="ident" id="3579680">records</span><span class="op" id="3579687">)</span><span class="op" id="3579688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579691">for</span>&nbsp;<span class="ident" id="3579695">i</span><span class="op" id="3579696">,</span>&nbsp;<span class="ident" id="3579698">rr</span>&nbsp;<span class="op" id="3579701">:=</span>&nbsp;<span class="keyword" id="3579704">range</span>&nbsp;<span class="ident" id="3579710">records</span>&nbsp;<span class="op" id="3579718">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579722">a</span>&nbsp;<span class="op" id="3579724">:=</span>&nbsp;<span class="ident" id="3579727">rr</span><span class="op" id="3579729">.</span><span class="op" id="3579730">(</span><span class="op" id="3579731">*</span><span class="ident" id="3579732">dnsRR_A</span><span class="op" id="3579739">)</span><span class="op" id="3579740">.</span><span class="ident" id="3579741">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579745">addrs</span><span class="op" id="3579750">[</span><span class="ident" id="3579751">i</span><span class="op" id="3579752">]</span>&nbsp;<span class="op" id="3579754">=</span>&nbsp;<span class="ident" id="3579756">IPv4</span><span class="op" id="3579760">(</span><span class="builtintype" id="3579761">byte</span><span class="op" id="3579765">(</span><span class="ident" id="3579766">a</span><span class="op" id="3579767">&gt;&gt;</span><span class="num" id="3579769">24</span><span class="op" id="3579771">)</span><span class="op" id="3579772">,</span>&nbsp;<span class="builtintype" id="3579774">byte</span><span class="op" id="3579778">(</span><span class="ident" id="3579779">a</span><span class="op" id="3579780">&gt;&gt;</span><span class="num" id="3579782">16</span><span class="op" id="3579784">)</span><span class="op" id="3579785">,</span>&nbsp;<span class="builtintype" id="3579787">byte</span><span class="op" id="3579791">(</span><span class="ident" id="3579792">a</span><span class="op" id="3579793">&gt;&gt;</span><span class="num" id="3579795">8</span><span class="op" id="3579796">)</span><span class="op" id="3579797">,</span>&nbsp;<span class="builtintype" id="3579799">byte</span><span class="op" id="3579803">(</span><span class="ident" id="3579804">a</span><span class="op" id="3579805">)</span><span class="op" id="3579806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3579809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579812">return</span>&nbsp;<span class="ident" id="3579819">addrs</span><br>
<span class="lineno"></span><span class="op" id="3579825">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="3579828">func</span>&nbsp;<span class="ident" id="3579833">convertRR_AAAA</span><span class="op" id="3579847">(</span><span class="ident" id="3579848">records</span>&nbsp;<span class="op" id="3579856">[</span><span class="op" id="3579857">]</span><span class="ident" id="3579858">dnsRR</span><span class="op" id="3579863">)</span>&nbsp;<span class="op" id="3579865">[</span><span class="op" id="3579866">]</span><span class="ident" id="3579867">IP</span>&nbsp;<span class="op" id="3579870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579873">addrs</span>&nbsp;<span class="op" id="3579879">:=</span>&nbsp;<span class="builtinfunc" id="3579882">make</span><span class="op" id="3579886">(</span><span class="op" id="3579887">[</span><span class="op" id="3579888">]</span><span class="ident" id="3579889">IP</span><span class="op" id="3579891">,</span>&nbsp;<span class="builtinfunc" id="3579893">len</span><span class="op" id="3579896">(</span><span class="ident" id="3579897">records</span><span class="op" id="3579904">)</span><span class="op" id="3579905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579908">for</span>&nbsp;<span class="ident" id="3579912">i</span><span class="op" id="3579913">,</span>&nbsp;<span class="ident" id="3579915">rr</span>&nbsp;<span class="op" id="3579918">:=</span>&nbsp;<span class="keyword" id="3579921">range</span>&nbsp;<span class="ident" id="3579927">records</span>&nbsp;<span class="op" id="3579935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579939">a</span>&nbsp;<span class="op" id="3579941">:=</span>&nbsp;<span class="builtinfunc" id="3579944">make</span><span class="op" id="3579948">(</span><span class="ident" id="3579949">IP</span><span class="op" id="3579951">,</span>&nbsp;<span class="ident" id="3579953">IPv6len</span><span class="op" id="3579960">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3579964">copy</span><span class="op" id="3579968">(</span><span class="ident" id="3579969">a</span><span class="op" id="3579970">,</span>&nbsp;<span class="ident" id="3579972">rr</span><span class="op" id="3579974">.</span><span class="op" id="3579975">(</span><span class="op" id="3579976">*</span><span class="ident" id="3579977">dnsRR_AAAA</span><span class="op" id="3579987">)</span><span class="op" id="3579988">.</span><span class="ident" id="3579989">AAAA</span><span class="op" id="3579993">[</span><span class="op" id="3579994">:</span><span class="op" id="3579995">]</span><span class="op" id="3579996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580000">addrs</span><span class="op" id="3580005">[</span><span class="ident" id="3580006">i</span><span class="op" id="3580007">]</span>&nbsp;<span class="op" id="3580009">=</span>&nbsp;<span class="ident" id="3580011">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3580014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3580017">return</span>&nbsp;<span class="ident" id="3580024">addrs</span><br>
<span class="lineno"></span><span class="op" id="3580030">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="3580033">var</span>&nbsp;<span class="ident" id="3580037">cfg</span>&nbsp;<span class="keyword" id="3580041">struct</span>&nbsp;<span class="op" id="3580048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580051">ch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580061">chan</span>&nbsp;<span class="keyword" id="3580066">struct</span><span class="op" id="3580072">{</span><span class="op" id="3580073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580076">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580086">sync</span><span class="op" id="3580090">.</span><span class="ident" id="3580091">RWMutex</span>&nbsp;<span class="comment" id="3580099">//&nbsp;protects&nbsp;dnsConfig&nbsp;and&nbsp;dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580133">dnsConfig</span>&nbsp;<span class="op" id="3580143">*</span><span class="ident" id="3580144">dnsConfig</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580155">dnserr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3580165">error</span><br>
<span class="lineno"></span><span class="op" id="3580171">}</span><br>
<span class="lineno"></span><span class="keyword" id="3580173">var</span>&nbsp;<span class="ident" id="3580177">onceLoadConfig</span>&nbsp;<span class="ident" id="3580192">sync</span><span class="op" id="3580196">.</span><span class="ident" id="3580197">Once</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3580203">//&nbsp;Assume&nbsp;dns&nbsp;config&nbsp;file&nbsp;is&nbsp;/etc/resolv.conf&nbsp;here</span><br>
<span class="lineno">225</span><span class="keyword" id="3580254">func</span>&nbsp;<span class="ident" id="3580259">loadDefaultConfig</span><span class="op" id="3580276">(</span><span class="op" id="3580277">)</span>&nbsp;<span class="op" id="3580279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580282">loadConfig</span><span class="op" id="3580292">(</span><span class="string" id="3580293">&#34;/etc/resolv.conf&#34;</span><span class="op" id="3580311">,</span>&nbsp;<span class="num" id="3580313">5</span><span class="op" id="3580314">*</span><span class="ident" id="3580315">time</span><span class="op" id="3580319">.</span><span class="ident" id="3580320">Second</span><span class="op" id="3580326">,</span>&nbsp;<span class="ident" id="3580328">nil</span><span class="op" id="3580331">)</span><br>
<span class="lineno"></span><span class="op" id="3580333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3580336">func</span>&nbsp;<span class="ident" id="3580341">loadConfig</span><span class="op" id="3580351">(</span><span class="ident" id="3580352">resolvConfPath</span>&nbsp;<span class="builtintype" id="3580367">string</span><span class="op" id="3580373">,</span>&nbsp;<span class="ident" id="3580375">reloadTime</span>&nbsp;<span class="ident" id="3580386">time</span><span class="op" id="3580390">.</span><span class="ident" id="3580391">Duration</span><span class="op" id="3580399">,</span>&nbsp;<span class="ident" id="3580401">quit</span>&nbsp;<span class="op" id="3580406">&lt;-</span><span class="keyword" id="3580408">chan</span>&nbsp;<span class="keyword" id="3580413">chan</span>&nbsp;<span class="keyword" id="3580418">struct</span><span class="op" id="3580424">{</span><span class="op" id="3580425">}</span><span class="op" id="3580426">)</span>&nbsp;<span class="op" id="3580428">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3580431">var</span>&nbsp;<span class="ident" id="3580435">mtime</span>&nbsp;<span class="ident" id="3580441">time</span><span class="op" id="3580445">.</span><span class="ident" id="3580446">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580452">cfg</span><span class="op" id="3580455">.</span><span class="ident" id="3580456">ch</span>&nbsp;<span class="op" id="3580459">=</span>&nbsp;<span class="builtinfunc" id="3580461">make</span><span class="op" id="3580465">(</span><span class="keyword" id="3580466">chan</span>&nbsp;<span class="keyword" id="3580471">struct</span><span class="op" id="3580477">{</span><span class="op" id="3580478">}</span><span class="op" id="3580479">,</span>&nbsp;<span class="num" id="3580481">1</span><span class="op" id="3580482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3580485">if</span>&nbsp;<span class="ident" id="3580488">fi</span><span class="op" id="3580490">,</span>&nbsp;<span class="ident" id="3580492">err</span>&nbsp;<span class="op" id="3580496">:=</span>&nbsp;<span class="ident" id="3580499">os</span><span class="op" id="3580501">.</span><span class="ident" id="3580502">Stat</span><span class="op" id="3580506">(</span><span class="ident" id="3580507">resolvConfPath</span><span class="op" id="3580521">)</span><span class="op" id="3580522">;</span>&nbsp;<span class="ident" id="3580524">err</span>&nbsp;<span class="op" id="3580528">!=</span>&nbsp;<span class="ident" id="3580531">nil</span>&nbsp;<span class="op" id="3580535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580539">cfg</span><span class="op" id="3580542">.</span><span class="ident" id="3580543">dnserr</span>&nbsp;<span class="op" id="3580550">=</span>&nbsp;<span class="ident" id="3580552">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3580557">}</span>&nbsp;<span class="keyword" id="3580559">else</span>&nbsp;<span class="op" id="3580564">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580568">mtime</span>&nbsp;<span class="op" id="3580574">=</span>&nbsp;<span class="ident" id="3580576">fi</span><span class="op" id="3580578">.</span><span class="ident" id="3580579">ModTime</span><span class="op" id="3580586">(</span><span class="op" id="3580587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580591">cfg</span><span class="op" id="3580594">.</span><span class="ident" id="3580595">dnsConfig</span><span class="op" id="3580604">,</span>&nbsp;<span class="ident" id="3580606">cfg</span><span class="op" id="3580609">.</span><span class="ident" id="3580610">dnserr</span>&nbsp;<span class="op" id="3580617">=</span>&nbsp;<span class="ident" id="3580619">dnsReadConfig</span><span class="op" id="3580632">(</span><span class="ident" id="3580633">resolvConfPath</span><span class="op" id="3580647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3580650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3580653">go</span>&nbsp;<span class="keyword" id="3580656">func</span><span class="op" id="3580660">(</span><span class="op" id="3580661">)</span>&nbsp;<span class="op" id="3580663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3580667">for</span>&nbsp;<span class="op" id="3580671">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580676">time</span><span class="op" id="3580680">.</span><span class="ident" id="3580681">Sleep</span><span class="op" id="3580686">(</span><span class="ident" id="3580687">reloadTime</span><span class="op" id="3580697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3580702">select</span>&nbsp;<span class="op" id="3580709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3580714">case</span>&nbsp;<span class="ident" id="3580719">qresp</span>&nbsp;<span class="op" id="3580725">:=</span>&nbsp;<span class="op" id="3580728">&lt;-</span><span class="ident" id="3580730">quit</span><span class="op" id="3580734">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580740">qresp</span>&nbsp;<span class="op" id="3580746">&lt;-</span>&nbsp;<span class="keyword" id="3580749">struct</span><span class="op" id="3580755">{</span><span class="op" id="3580756">}</span><span class="op" id="3580757">{</span><span class="op" id="3580758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3580764">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3580774">case</span>&nbsp;<span class="op" id="3580779">&lt;-</span><span class="ident" id="3580781">cfg</span><span class="op" id="3580784">.</span><span class="ident" id="3580785">ch</span><span class="op" id="3580787">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3580792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3580798">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580850">fi</span><span class="op" id="3580852">,</span>&nbsp;<span class="ident" id="3580854">err</span>&nbsp;<span class="op" id="3580858">:=</span>&nbsp;<span class="ident" id="3580861">os</span><span class="op" id="3580863">.</span><span class="ident" id="3580864">Stat</span><span class="op" id="3580868">(</span><span class="ident" id="3580869">resolvConfPath</span><span class="op" id="3580883">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3580888">if</span>&nbsp;<span class="ident" id="3580891">err</span>&nbsp;<span class="op" id="3580895">!=</span>&nbsp;<span class="ident" id="3580898">nil</span>&nbsp;<span class="op" id="3580902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3580908">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3580920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3580925">//&nbsp;If&nbsp;the&nbsp;resolv.conf&nbsp;mtime&nbsp;didn&#39;t&nbsp;change,&nbsp;do&nbsp;not&nbsp;reload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580985">m</span>&nbsp;<span class="op" id="3580987">:=</span>&nbsp;<span class="ident" id="3580990">fi</span><span class="op" id="3580992">.</span><span class="ident" id="3580993">ModTime</span><span class="op" id="3581000">(</span><span class="op" id="3581001">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3581006">if</span>&nbsp;<span class="ident" id="3581009">m</span><span class="op" id="3581010">.</span><span class="ident" id="3581011">Equal</span><span class="op" id="3581016">(</span><span class="ident" id="3581017">mtime</span><span class="op" id="3581022">)</span>&nbsp;<span class="op" id="3581024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3581030">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3581042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581047">mtime</span>&nbsp;<span class="op" id="3581053">=</span>&nbsp;<span class="ident" id="3581055">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581060">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581112">ncfg</span><span class="op" id="3581116">,</span>&nbsp;<span class="ident" id="3581118">err</span>&nbsp;<span class="op" id="3581122">:=</span>&nbsp;<span class="ident" id="3581125">dnsReadConfig</span><span class="op" id="3581138">(</span><span class="ident" id="3581139">resolvConfPath</span><span class="op" id="3581153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3581158">if</span>&nbsp;<span class="ident" id="3581161">err</span>&nbsp;<span class="op" id="3581165">!=</span>&nbsp;<span class="ident" id="3581168">nil</span>&nbsp;<span class="op" id="3581172">||</span>&nbsp;<span class="builtinfunc" id="3581175">len</span><span class="op" id="3581178">(</span><span class="ident" id="3581179">ncfg</span><span class="op" id="3581183">.</span><span class="ident" id="3581184">servers</span><span class="op" id="3581191">)</span>&nbsp;<span class="op" id="3581193">==</span>&nbsp;<span class="num" id="3581196">0</span>&nbsp;<span class="op" id="3581198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3581204">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3581216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581221">cfg</span><span class="op" id="3581224">.</span><span class="ident" id="3581225">mu</span><span class="op" id="3581227">.</span><span class="ident" id="3581228">Lock</span><span class="op" id="3581232">(</span><span class="op" id="3581233">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581238">cfg</span><span class="op" id="3581241">.</span><span class="ident" id="3581242">dnsConfig</span>&nbsp;<span class="op" id="3581252">=</span>&nbsp;<span class="ident" id="3581254">ncfg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581262">cfg</span><span class="op" id="3581265">.</span><span class="ident" id="3581266">dnserr</span>&nbsp;<span class="op" id="3581273">=</span>&nbsp;<span class="ident" id="3581275">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581282">cfg</span><span class="op" id="3581285">.</span><span class="ident" id="3581286">mu</span><span class="op" id="3581288">.</span><span class="ident" id="3581289">Unlock</span><span class="op" id="3581295">(</span><span class="op" id="3581296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3581300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3581303">}</span><span class="op" id="3581304">(</span><span class="op" id="3581305">)</span><br>
<span class="lineno">270</span><span class="op" id="3581307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3581310">func</span>&nbsp;<span class="ident" id="3581315">lookup</span><span class="op" id="3581321">(</span><span class="ident" id="3581322">name</span>&nbsp;<span class="builtintype" id="3581327">string</span><span class="op" id="3581333">,</span>&nbsp;<span class="ident" id="3581335">qtype</span>&nbsp;<span class="builtintype" id="3581341">uint16</span><span class="op" id="3581347">)</span>&nbsp;<span class="op" id="3581349">(</span><span class="ident" id="3581350">cname</span>&nbsp;<span class="builtintype" id="3581356">string</span><span class="op" id="3581362">,</span>&nbsp;<span class="ident" id="3581364">addrs</span>&nbsp;<span class="op" id="3581370">[</span><span class="op" id="3581371">]</span><span class="ident" id="3581372">dnsRR</span><span class="op" id="3581377">,</span>&nbsp;<span class="ident" id="3581379">err</span>&nbsp;<span class="builtintype" id="3581383">error</span><span class="op" id="3581388">)</span>&nbsp;<span class="op" id="3581390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3581393">if</span>&nbsp;<span class="op" id="3581396">!</span><span class="ident" id="3581397">isDomainName</span><span class="op" id="3581409">(</span><span class="ident" id="3581410">name</span><span class="op" id="3581414">)</span>&nbsp;<span class="op" id="3581416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3581420">return</span>&nbsp;<span class="ident" id="3581427">name</span><span class="op" id="3581431">,</span>&nbsp;<span class="ident" id="3581433">nil</span><span class="op" id="3581436">,</span>&nbsp;<span class="op" id="3581438">&amp;</span><span class="ident" id="3581439">DNSError</span><span class="op" id="3581447">{</span><span class="ident" id="3581448">Err</span><span class="op" id="3581451">:</span>&nbsp;<span class="string" id="3581453">&#34;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="3581474">,</span>&nbsp;<span class="ident" id="3581476">Name</span><span class="op" id="3581480">:</span>&nbsp;<span class="ident" id="3581482">name</span><span class="op" id="3581486">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3581489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581492">onceLoadConfig</span><span class="op" id="3581506">.</span><span class="ident" id="3581507">Do</span><span class="op" id="3581509">(</span><span class="ident" id="3581510">loadDefaultConfig</span><span class="op" id="3581527">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3581531">select</span>&nbsp;<span class="op" id="3581538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3581541">case</span>&nbsp;<span class="ident" id="3581546">cfg</span><span class="op" id="3581549">.</span><span class="ident" id="3581550">ch</span>&nbsp;<span class="op" id="3581553">&lt;-</span>&nbsp;<span class="keyword" id="3581556">struct</span><span class="op" id="3581562">{</span><span class="op" id="3581563">}</span><span class="op" id="3581564">{</span><span class="op" id="3581565">}</span><span class="op" id="3581566">:</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3581569">default</span><span class="op" id="3581576">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3581579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581583">cfg</span><span class="op" id="3581586">.</span><span class="ident" id="3581587">mu</span><span class="op" id="3581589">.</span><span class="ident" id="3581590">RLock</span><span class="op" id="3581595">(</span><span class="op" id="3581596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3581599">defer</span>&nbsp;<span class="ident" id="3581605">cfg</span><span class="op" id="3581608">.</span><span class="ident" id="3581609">mu</span><span class="op" id="3581611">.</span><span class="ident" id="3581612">RUnlock</span><span class="op" id="3581619">(</span><span class="op" id="3581620">)</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3581624">if</span>&nbsp;<span class="ident" id="3581627">cfg</span><span class="op" id="3581630">.</span><span class="ident" id="3581631">dnserr</span>&nbsp;<span class="op" id="3581638">!=</span>&nbsp;<span class="ident" id="3581641">nil</span>&nbsp;<span class="op" id="3581645">||</span>&nbsp;<span class="ident" id="3581648">cfg</span><span class="op" id="3581651">.</span><span class="ident" id="3581652">dnsConfig</span>&nbsp;<span class="op" id="3581662">==</span>&nbsp;<span class="ident" id="3581665">nil</span>&nbsp;<span class="op" id="3581669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581673">err</span>&nbsp;<span class="op" id="3581677">=</span>&nbsp;<span class="ident" id="3581679">cfg</span><span class="op" id="3581682">.</span><span class="ident" id="3581683">dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3581692">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3581700">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581703">//&nbsp;If&nbsp;name&nbsp;is&nbsp;rooted&nbsp;(trailing&nbsp;dot)&nbsp;or&nbsp;has&nbsp;enough&nbsp;dots,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581760">//&nbsp;try&nbsp;it&nbsp;by&nbsp;itself&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581788">rooted</span>&nbsp;<span class="op" id="3581795">:=</span>&nbsp;<span class="builtinfunc" id="3581798">len</span><span class="op" id="3581801">(</span><span class="ident" id="3581802">name</span><span class="op" id="3581806">)</span>&nbsp;<span class="op" id="3581808">&gt;</span>&nbsp;<span class="num" id="3581810">0</span>&nbsp;<span class="op" id="3581812">&amp;&amp;</span>&nbsp;<span class="ident" id="3581815">name</span><span class="op" id="3581819">[</span><span class="builtinfunc" id="3581820">len</span><span class="op" id="3581823">(</span><span class="ident" id="3581824">name</span><span class="op" id="3581828">)</span><span class="op" id="3581829">-</span><span class="num" id="3581830">1</span><span class="op" id="3581831">]</span>&nbsp;<span class="op" id="3581833">==</span>&nbsp;<span class="string" id="3581836">&#39;.&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3581841">if</span>&nbsp;<span class="ident" id="3581844">rooted</span>&nbsp;<span class="op" id="3581851">||</span>&nbsp;<span class="ident" id="3581854">count</span><span class="op" id="3581859">(</span><span class="ident" id="3581860">name</span><span class="op" id="3581864">,</span>&nbsp;<span class="string" id="3581866">&#39;.&#39;</span><span class="op" id="3581869">)</span>&nbsp;<span class="op" id="3581871">&gt;=</span>&nbsp;<span class="ident" id="3581874">cfg</span><span class="op" id="3581877">.</span><span class="ident" id="3581878">dnsConfig</span><span class="op" id="3581887">.</span><span class="ident" id="3581888">ndots</span>&nbsp;<span class="op" id="3581894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581898">rname</span>&nbsp;<span class="op" id="3581904">:=</span>&nbsp;<span class="ident" id="3581907">name</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3581914">if</span>&nbsp;<span class="op" id="3581917">!</span><span class="ident" id="3581918">rooted</span>&nbsp;<span class="op" id="3581925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581930">rname</span>&nbsp;<span class="op" id="3581936">+=</span>&nbsp;<span class="string" id="3581939">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3581945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581949">//&nbsp;Can&nbsp;try&nbsp;as&nbsp;ordinary&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581980">cname</span><span class="op" id="3581985">,</span>&nbsp;<span class="ident" id="3581987">addrs</span><span class="op" id="3581992">,</span>&nbsp;<span class="ident" id="3581994">err</span>&nbsp;<span class="op" id="3581998">=</span>&nbsp;<span class="ident" id="3582000">tryOneName</span><span class="op" id="3582010">(</span><span class="ident" id="3582011">cfg</span><span class="op" id="3582014">.</span><span class="ident" id="3582015">dnsConfig</span><span class="op" id="3582024">,</span>&nbsp;<span class="ident" id="3582026">rname</span><span class="op" id="3582031">,</span>&nbsp;<span class="ident" id="3582033">qtype</span><span class="op" id="3582038">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582042">if</span>&nbsp;<span class="ident" id="3582045">rooted</span>&nbsp;<span class="op" id="3582052">||</span>&nbsp;<span class="ident" id="3582055">err</span>&nbsp;<span class="op" id="3582059">==</span>&nbsp;<span class="ident" id="3582062">nil</span>&nbsp;<span class="op" id="3582066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582071">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3582080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3582083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3582087">//&nbsp;Otherwise,&nbsp;try&nbsp;suffixes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582116">for</span>&nbsp;<span class="ident" id="3582120">i</span>&nbsp;<span class="op" id="3582122">:=</span>&nbsp;<span class="num" id="3582125">0</span><span class="op" id="3582126">;</span>&nbsp;<span class="ident" id="3582128">i</span>&nbsp;<span class="op" id="3582130">&lt;</span>&nbsp;<span class="builtinfunc" id="3582132">len</span><span class="op" id="3582135">(</span><span class="ident" id="3582136">cfg</span><span class="op" id="3582139">.</span><span class="ident" id="3582140">dnsConfig</span><span class="op" id="3582149">.</span><span class="ident" id="3582150">search</span><span class="op" id="3582156">)</span><span class="op" id="3582157">;</span>&nbsp;<span class="ident" id="3582159">i</span><span class="op" id="3582160">++</span>&nbsp;<span class="op" id="3582163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3582167">rname</span>&nbsp;<span class="op" id="3582173">:=</span>&nbsp;<span class="ident" id="3582176">name</span>&nbsp;<span class="op" id="3582181">+</span>&nbsp;<span class="string" id="3582183">&#34;.&#34;</span>&nbsp;<span class="op" id="3582187">+</span>&nbsp;<span class="ident" id="3582189">cfg</span><span class="op" id="3582192">.</span><span class="ident" id="3582193">dnsConfig</span><span class="op" id="3582202">.</span><span class="ident" id="3582203">search</span><span class="op" id="3582209">[</span><span class="ident" id="3582210">i</span><span class="op" id="3582211">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582215">if</span>&nbsp;<span class="ident" id="3582218">rname</span><span class="op" id="3582223">[</span><span class="builtinfunc" id="3582224">len</span><span class="op" id="3582227">(</span><span class="ident" id="3582228">rname</span><span class="op" id="3582233">)</span><span class="op" id="3582234">-</span><span class="num" id="3582235">1</span><span class="op" id="3582236">]</span>&nbsp;<span class="op" id="3582238">!=</span>&nbsp;<span class="string" id="3582241">&#39;.&#39;</span>&nbsp;<span class="op" id="3582245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3582250">rname</span>&nbsp;<span class="op" id="3582256">+=</span>&nbsp;<span class="string" id="3582259">&#34;.&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3582265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3582269">cname</span><span class="op" id="3582274">,</span>&nbsp;<span class="ident" id="3582276">addrs</span><span class="op" id="3582281">,</span>&nbsp;<span class="ident" id="3582283">err</span>&nbsp;<span class="op" id="3582287">=</span>&nbsp;<span class="ident" id="3582289">tryOneName</span><span class="op" id="3582299">(</span><span class="ident" id="3582300">cfg</span><span class="op" id="3582303">.</span><span class="ident" id="3582304">dnsConfig</span><span class="op" id="3582313">,</span>&nbsp;<span class="ident" id="3582315">rname</span><span class="op" id="3582320">,</span>&nbsp;<span class="ident" id="3582322">qtype</span><span class="op" id="3582327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582331">if</span>&nbsp;<span class="ident" id="3582334">err</span>&nbsp;<span class="op" id="3582338">==</span>&nbsp;<span class="ident" id="3582341">nil</span>&nbsp;<span class="op" id="3582345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582350">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3582359">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3582362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3582366">//&nbsp;Last&nbsp;ditch&nbsp;effort:&nbsp;try&nbsp;unsuffixed&nbsp;only&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3582432">//&nbsp;that&nbsp;is,&nbsp;name&nbsp;is&nbsp;not&nbsp;rooted&nbsp;and&nbsp;has&nbsp;less&nbsp;than&nbsp;ndots&nbsp;dots.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582494">if</span>&nbsp;<span class="ident" id="3582497">count</span><span class="op" id="3582502">(</span><span class="ident" id="3582503">name</span><span class="op" id="3582507">,</span>&nbsp;<span class="string" id="3582509">&#39;.&#39;</span><span class="op" id="3582512">)</span>&nbsp;<span class="op" id="3582514">&lt;</span>&nbsp;<span class="ident" id="3582516">cfg</span><span class="op" id="3582519">.</span><span class="ident" id="3582520">dnsConfig</span><span class="op" id="3582529">.</span><span class="ident" id="3582530">ndots</span>&nbsp;<span class="op" id="3582536">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3582540">cname</span><span class="op" id="3582545">,</span>&nbsp;<span class="ident" id="3582547">addrs</span><span class="op" id="3582552">,</span>&nbsp;<span class="ident" id="3582554">err</span>&nbsp;<span class="op" id="3582558">=</span>&nbsp;<span class="ident" id="3582560">tryOneName</span><span class="op" id="3582570">(</span><span class="ident" id="3582571">cfg</span><span class="op" id="3582574">.</span><span class="ident" id="3582575">dnsConfig</span><span class="op" id="3582584">,</span>&nbsp;<span class="ident" id="3582586">name</span><span class="op" id="3582590">+</span><span class="string" id="3582591">&#34;.&#34;</span><span class="op" id="3582594">,</span>&nbsp;<span class="ident" id="3582596">qtype</span><span class="op" id="3582601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582605">if</span>&nbsp;<span class="ident" id="3582608">err</span>&nbsp;<span class="op" id="3582612">==</span>&nbsp;<span class="ident" id="3582615">nil</span>&nbsp;<span class="op" id="3582619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582624">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3582633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3582636">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582640">if</span>&nbsp;<span class="ident" id="3582643">e</span><span class="op" id="3582644">,</span>&nbsp;<span class="ident" id="3582646">ok</span>&nbsp;<span class="op" id="3582649">:=</span>&nbsp;<span class="ident" id="3582652">err</span><span class="op" id="3582655">.</span><span class="op" id="3582656">(</span><span class="op" id="3582657">*</span><span class="ident" id="3582658">DNSError</span><span class="op" id="3582666">)</span><span class="op" id="3582667">;</span>&nbsp;<span class="ident" id="3582669">ok</span>&nbsp;<span class="op" id="3582672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3582676">//&nbsp;Show&nbsp;original&nbsp;name&nbsp;passed&nbsp;to&nbsp;lookup,&nbsp;not&nbsp;suffixed&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3582736">//&nbsp;In&nbsp;general&nbsp;we&nbsp;might&nbsp;have&nbsp;tried&nbsp;many&nbsp;suffixes;&nbsp;showing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3582795">//&nbsp;just&nbsp;one&nbsp;is&nbsp;misleading.&nbsp;See&nbsp;also&nbsp;golang.org/issue/6324.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3582856">e</span><span class="op" id="3582857">.</span><span class="ident" id="3582858">Name</span>&nbsp;<span class="op" id="3582863">=</span>&nbsp;<span class="ident" id="3582865">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3582871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582874">return</span><br>
<span class="lineno"></span><span class="op" id="3582881">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="3582884">//&nbsp;goLookupHost&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupHost.</span><br>
<span class="lineno"></span><span class="comment" id="3582947">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3583007">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3583071">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3583132">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">340</span><span class="comment" id="3583195">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3583207">func</span>&nbsp;<span class="ident" id="3583212">goLookupHost</span><span class="op" id="3583224">(</span><span class="ident" id="3583225">name</span>&nbsp;<span class="builtintype" id="3583230">string</span><span class="op" id="3583236">)</span>&nbsp;<span class="op" id="3583238">(</span><span class="ident" id="3583239">addrs</span>&nbsp;<span class="op" id="3583245">[</span><span class="op" id="3583246">]</span><span class="builtintype" id="3583247">string</span><span class="op" id="3583253">,</span>&nbsp;<span class="ident" id="3583255">err</span>&nbsp;<span class="builtintype" id="3583259">error</span><span class="op" id="3583264">)</span>&nbsp;<span class="op" id="3583266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3583269">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;they&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3583316">addrs</span>&nbsp;<span class="op" id="3583322">=</span>&nbsp;<span class="ident" id="3583324">lookupStaticHost</span><span class="op" id="3583340">(</span><span class="ident" id="3583341">name</span><span class="op" id="3583345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3583348">if</span>&nbsp;<span class="builtinfunc" id="3583351">len</span><span class="op" id="3583354">(</span><span class="ident" id="3583355">addrs</span><span class="op" id="3583360">)</span>&nbsp;<span class="op" id="3583362">&gt;</span>&nbsp;<span class="num" id="3583364">0</span>&nbsp;<span class="op" id="3583366">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3583370">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3583378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3583381">ips</span><span class="op" id="3583384">,</span>&nbsp;<span class="ident" id="3583386">err</span>&nbsp;<span class="op" id="3583390">:=</span>&nbsp;<span class="ident" id="3583393">goLookupIP</span><span class="op" id="3583403">(</span><span class="ident" id="3583404">name</span><span class="op" id="3583408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3583411">if</span>&nbsp;<span class="ident" id="3583414">err</span>&nbsp;<span class="op" id="3583418">!=</span>&nbsp;<span class="ident" id="3583421">nil</span>&nbsp;<span class="op" id="3583425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3583429">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3583437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3583440">addrs</span>&nbsp;<span class="op" id="3583446">=</span>&nbsp;<span class="builtinfunc" id="3583448">make</span><span class="op" id="3583452">(</span><span class="op" id="3583453">[</span><span class="op" id="3583454">]</span><span class="builtintype" id="3583455">string</span><span class="op" id="3583461">,</span>&nbsp;<span class="num" id="3583463">0</span><span class="op" id="3583464">,</span>&nbsp;<span class="builtinfunc" id="3583466">len</span><span class="op" id="3583469">(</span><span class="ident" id="3583470">ips</span><span class="op" id="3583473">)</span><span class="op" id="3583474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3583477">for</span>&nbsp;<span class="ident" id="3583481">_</span><span class="op" id="3583482">,</span>&nbsp;<span class="ident" id="3583484">ip</span>&nbsp;<span class="op" id="3583487">:=</span>&nbsp;<span class="keyword" id="3583490">range</span>&nbsp;<span class="ident" id="3583496">ips</span>&nbsp;<span class="op" id="3583500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3583504">addrs</span>&nbsp;<span class="op" id="3583510">=</span>&nbsp;<span class="builtinfunc" id="3583512">append</span><span class="op" id="3583518">(</span><span class="ident" id="3583519">addrs</span><span class="op" id="3583524">,</span>&nbsp;<span class="ident" id="3583526">ip</span><span class="op" id="3583528">.</span><span class="ident" id="3583529">String</span><span class="op" id="3583535">(</span><span class="op" id="3583536">)</span><span class="op" id="3583537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3583540">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3583543">return</span><br>
<span class="lineno"></span><span class="op" id="3583550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3583553">//&nbsp;goLookupIP&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupIP.</span><br>
<span class="lineno"></span><span class="comment" id="3583612">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno">360</span><span class="comment" id="3583670">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3583732">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3583793">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="3583856">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3583868">func</span>&nbsp;<span class="ident" id="3583873">goLookupIP</span><span class="op" id="3583883">(</span><span class="ident" id="3583884">name</span>&nbsp;<span class="builtintype" id="3583889">string</span><span class="op" id="3583895">)</span>&nbsp;<span class="op" id="3583897">(</span><span class="ident" id="3583898">addrs</span>&nbsp;<span class="op" id="3583904">[</span><span class="op" id="3583905">]</span><span class="ident" id="3583906">IP</span><span class="op" id="3583908">,</span>&nbsp;<span class="ident" id="3583910">err</span>&nbsp;<span class="builtintype" id="3583914">error</span><span class="op" id="3583919">)</span>&nbsp;<span class="op" id="3583921">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3583924">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3583969">haddrs</span>&nbsp;<span class="op" id="3583976">:=</span>&nbsp;<span class="ident" id="3583979">lookupStaticHost</span><span class="op" id="3583995">(</span><span class="ident" id="3583996">name</span><span class="op" id="3584000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584003">if</span>&nbsp;<span class="builtinfunc" id="3584006">len</span><span class="op" id="3584009">(</span><span class="ident" id="3584010">haddrs</span><span class="op" id="3584016">)</span>&nbsp;<span class="op" id="3584018">&gt;</span>&nbsp;<span class="num" id="3584020">0</span>&nbsp;<span class="op" id="3584022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584026">for</span>&nbsp;<span class="ident" id="3584030">_</span><span class="op" id="3584031">,</span>&nbsp;<span class="ident" id="3584033">haddr</span>&nbsp;<span class="op" id="3584039">:=</span>&nbsp;<span class="keyword" id="3584042">range</span>&nbsp;<span class="ident" id="3584048">haddrs</span>&nbsp;<span class="op" id="3584055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584060">if</span>&nbsp;<span class="ident" id="3584063">ip</span>&nbsp;<span class="op" id="3584066">:=</span>&nbsp;<span class="ident" id="3584069">ParseIP</span><span class="op" id="3584076">(</span><span class="ident" id="3584077">haddr</span><span class="op" id="3584082">)</span><span class="op" id="3584083">;</span>&nbsp;<span class="ident" id="3584085">ip</span>&nbsp;<span class="op" id="3584088">!=</span>&nbsp;<span class="ident" id="3584091">nil</span>&nbsp;<span class="op" id="3584095">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584101">addrs</span>&nbsp;<span class="op" id="3584107">=</span>&nbsp;<span class="builtinfunc" id="3584109">append</span><span class="op" id="3584115">(</span><span class="ident" id="3584116">addrs</span><span class="op" id="3584121">,</span>&nbsp;<span class="ident" id="3584123">ip</span><span class="op" id="3584125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3584130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3584134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584138">if</span>&nbsp;<span class="builtinfunc" id="3584141">len</span><span class="op" id="3584144">(</span><span class="ident" id="3584145">addrs</span><span class="op" id="3584150">)</span>&nbsp;<span class="op" id="3584152">&gt;</span>&nbsp;<span class="num" id="3584154">0</span>&nbsp;<span class="op" id="3584156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584161">return</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3584170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3584173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584176">type</span>&nbsp;<span class="ident" id="3584181">racer</span>&nbsp;<span class="keyword" id="3584187">struct</span>&nbsp;<span class="op" id="3584194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584198">qtype</span>&nbsp;<span class="builtintype" id="3584204">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584213">rrs</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3584219">[</span><span class="op" id="3584220">]</span><span class="ident" id="3584221">dnsRR</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3584229">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3584236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584239">lane</span>&nbsp;<span class="op" id="3584244">:=</span>&nbsp;<span class="builtinfunc" id="3584247">make</span><span class="op" id="3584251">(</span><span class="keyword" id="3584252">chan</span>&nbsp;<span class="ident" id="3584257">racer</span><span class="op" id="3584262">,</span>&nbsp;<span class="num" id="3584264">1</span><span class="op" id="3584265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584268">qtypes</span>&nbsp;<span class="op" id="3584275">:=</span>&nbsp;<span class="op" id="3584278">[</span><span class="op" id="3584279">...</span><span class="op" id="3584282">]</span><span class="builtintype" id="3584283">uint16</span><span class="op" id="3584289">{</span><span class="ident" id="3584290">dnsTypeA</span><span class="op" id="3584298">,</span>&nbsp;<span class="ident" id="3584300">dnsTypeAAAA</span><span class="op" id="3584311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584314">for</span>&nbsp;<span class="ident" id="3584318">_</span><span class="op" id="3584319">,</span>&nbsp;<span class="ident" id="3584321">qtype</span>&nbsp;<span class="op" id="3584327">:=</span>&nbsp;<span class="keyword" id="3584330">range</span>&nbsp;<span class="ident" id="3584336">qtypes</span>&nbsp;<span class="op" id="3584343">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584347">go</span>&nbsp;<span class="keyword" id="3584350">func</span><span class="op" id="3584354">(</span><span class="ident" id="3584355">qtype</span>&nbsp;<span class="builtintype" id="3584361">uint16</span><span class="op" id="3584367">)</span>&nbsp;<span class="op" id="3584369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584374">_</span><span class="op" id="3584375">,</span>&nbsp;<span class="ident" id="3584377">rrs</span><span class="op" id="3584380">,</span>&nbsp;<span class="ident" id="3584382">err</span>&nbsp;<span class="op" id="3584386">:=</span>&nbsp;<span class="ident" id="3584389">lookup</span><span class="op" id="3584395">(</span><span class="ident" id="3584396">name</span><span class="op" id="3584400">,</span>&nbsp;<span class="ident" id="3584402">qtype</span><span class="op" id="3584407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584412">lane</span>&nbsp;<span class="op" id="3584417">&lt;-</span>&nbsp;<span class="ident" id="3584420">racer</span><span class="op" id="3584425">{</span><span class="ident" id="3584426">qtype</span><span class="op" id="3584431">,</span>&nbsp;<span class="ident" id="3584433">rrs</span><span class="op" id="3584436">,</span>&nbsp;<span class="ident" id="3584438">err</span><span class="op" id="3584441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3584445">}</span><span class="op" id="3584446">(</span><span class="ident" id="3584447">qtype</span><span class="op" id="3584452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3584455">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584458">var</span>&nbsp;<span class="ident" id="3584462">lastErr</span>&nbsp;<span class="builtintype" id="3584470">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584477">for</span>&nbsp;<span class="keyword" id="3584481">range</span>&nbsp;<span class="ident" id="3584487">qtypes</span>&nbsp;<span class="op" id="3584494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584498">racer</span>&nbsp;<span class="op" id="3584504">:=</span>&nbsp;<span class="op" id="3584507">&lt;-</span><span class="ident" id="3584509">lane</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584516">if</span>&nbsp;<span class="ident" id="3584519">racer</span><span class="op" id="3584524">.</span><span class="builtintype" id="3584525">error</span>&nbsp;<span class="op" id="3584531">!=</span>&nbsp;<span class="ident" id="3584534">nil</span>&nbsp;<span class="op" id="3584538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584543">lastErr</span>&nbsp;<span class="op" id="3584551">=</span>&nbsp;<span class="ident" id="3584553">racer</span><span class="op" id="3584558">.</span><span class="builtintype" id="3584559">error</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584568">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3584579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584583">switch</span>&nbsp;<span class="ident" id="3584590">racer</span><span class="op" id="3584595">.</span><span class="ident" id="3584596">qtype</span>&nbsp;<span class="op" id="3584602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584606">case</span>&nbsp;<span class="ident" id="3584611">dnsTypeA</span><span class="op" id="3584619">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584624">addrs</span>&nbsp;<span class="op" id="3584630">=</span>&nbsp;<span class="builtinfunc" id="3584632">append</span><span class="op" id="3584638">(</span><span class="ident" id="3584639">addrs</span><span class="op" id="3584644">,</span>&nbsp;<span class="ident" id="3584646">convertRR_A</span><span class="op" id="3584657">(</span><span class="ident" id="3584658">racer</span><span class="op" id="3584663">.</span><span class="ident" id="3584664">rrs</span><span class="op" id="3584667">)</span><span class="op" id="3584668">...</span><span class="op" id="3584671">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584675">case</span>&nbsp;<span class="ident" id="3584680">dnsTypeAAAA</span><span class="op" id="3584691">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584696">addrs</span>&nbsp;<span class="op" id="3584702">=</span>&nbsp;<span class="builtinfunc" id="3584704">append</span><span class="op" id="3584710">(</span><span class="ident" id="3584711">addrs</span><span class="op" id="3584716">,</span>&nbsp;<span class="ident" id="3584718">convertRR_AAAA</span><span class="op" id="3584732">(</span><span class="ident" id="3584733">racer</span><span class="op" id="3584738">.</span><span class="ident" id="3584739">rrs</span><span class="op" id="3584742">)</span><span class="op" id="3584743">...</span><span class="op" id="3584746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3584750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3584753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584756">if</span>&nbsp;<span class="builtinfunc" id="3584759">len</span><span class="op" id="3584762">(</span><span class="ident" id="3584763">addrs</span><span class="op" id="3584768">)</span>&nbsp;<span class="op" id="3584770">==</span>&nbsp;<span class="num" id="3584773">0</span>&nbsp;<span class="op" id="3584775">&amp;&amp;</span>&nbsp;<span class="ident" id="3584778">lastErr</span>&nbsp;<span class="op" id="3584786">!=</span>&nbsp;<span class="ident" id="3584789">nil</span>&nbsp;<span class="op" id="3584793">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584797">return</span>&nbsp;<span class="ident" id="3584804">nil</span><span class="op" id="3584807">,</span>&nbsp;<span class="ident" id="3584809">lastErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3584818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584821">return</span>&nbsp;<span class="ident" id="3584828">addrs</span><span class="op" id="3584833">,</span>&nbsp;<span class="ident" id="3584835">nil</span><br>
<span class="lineno"></span><span class="op" id="3584839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="3584842">//&nbsp;goLookupCNAME&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupCNAME.</span><br>
<span class="lineno"></span><span class="comment" id="3584907">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3584968">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3585033">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3585094">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">415</span><span class="comment" id="3585157">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3585169">func</span>&nbsp;<span class="ident" id="3585174">goLookupCNAME</span><span class="op" id="3585187">(</span><span class="ident" id="3585188">name</span>&nbsp;<span class="builtintype" id="3585193">string</span><span class="op" id="3585199">)</span>&nbsp;<span class="op" id="3585201">(</span><span class="ident" id="3585202">cname</span>&nbsp;<span class="builtintype" id="3585208">string</span><span class="op" id="3585214">,</span>&nbsp;<span class="ident" id="3585216">err</span>&nbsp;<span class="builtintype" id="3585220">error</span><span class="op" id="3585225">)</span>&nbsp;<span class="op" id="3585227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3585230">_</span><span class="op" id="3585231">,</span>&nbsp;<span class="ident" id="3585233">rr</span><span class="op" id="3585235">,</span>&nbsp;<span class="ident" id="3585237">err</span>&nbsp;<span class="op" id="3585241">:=</span>&nbsp;<span class="ident" id="3585244">lookup</span><span class="op" id="3585250">(</span><span class="ident" id="3585251">name</span><span class="op" id="3585255">,</span>&nbsp;<span class="ident" id="3585257">dnsTypeCNAME</span><span class="op" id="3585269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585272">if</span>&nbsp;<span class="ident" id="3585275">err</span>&nbsp;<span class="op" id="3585279">!=</span>&nbsp;<span class="ident" id="3585282">nil</span>&nbsp;<span class="op" id="3585286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585290">return</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3585298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3585301">cname</span>&nbsp;<span class="op" id="3585307">=</span>&nbsp;<span class="ident" id="3585309">rr</span><span class="op" id="3585311">[</span><span class="num" id="3585312">0</span><span class="op" id="3585313">]</span><span class="op" id="3585314">.</span><span class="op" id="3585315">(</span><span class="op" id="3585316">*</span><span class="ident" id="3585317">dnsRR_CNAME</span><span class="op" id="3585328">)</span><span class="op" id="3585329">.</span><span class="ident" id="3585330">Cname</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585337">return</span><br>
<span class="lineno"></span><span class="op" id="3585344">}</span>
</div>
</body>
</html>
