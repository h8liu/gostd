<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html" class="current">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4550345">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4550400">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4550454">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4550505">package</span>&nbsp;<span class="ident" id="4550513">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4550518">import</span>&nbsp;<span class="op" id="4550525">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4550528">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4550537">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4550547">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4550563">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4550577">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4550594">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4550609">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4550619">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4550626">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4550632">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4550639">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="4550649">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4550652">type</span>&nbsp;<span class="ident" id="4550657">clientHandshakeState</span>&nbsp;<span class="keyword" id="4550678">struct</span>&nbsp;<span class="op" id="4550685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550688">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4550701">*</span><span class="ident" id="4550702">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550708">serverHello</span>&nbsp;&nbsp;<span class="op" id="4550721">*</span><span class="ident" id="4550722">serverHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550738">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4550751">*</span><span class="ident" id="4550752">clientHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550768">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4550781">*</span><span class="ident" id="4550782">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550795">finishedHash</span>&nbsp;<span class="ident" id="4550808">finishedHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550822">masterSecret</span>&nbsp;<span class="op" id="4550835">[</span><span class="op" id="4550836">]</span><span class="builtintype" id="4550837">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550843">session</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4550856">*</span><span class="ident" id="4550857">ClientSessionState</span><br>
<span class="lineno"></span><span class="op" id="4550876">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="4550879">func</span>&nbsp;<span class="op" id="4550884">(</span><span class="ident" id="4550885">c</span>&nbsp;<span class="op" id="4550887">*</span><span class="ident" id="4550888">Conn</span><span class="op" id="4550892">)</span>&nbsp;<span class="ident" id="4550894">clientHandshake</span><span class="op" id="4550909">(</span><span class="op" id="4550910">)</span>&nbsp;<span class="builtintype" id="4550912">error</span>&nbsp;<span class="op" id="4550918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550921">if</span>&nbsp;<span class="ident" id="4550924">c</span><span class="op" id="4550925">.</span><span class="ident" id="4550926">config</span>&nbsp;<span class="op" id="4550933">==</span>&nbsp;<span class="ident" id="4550936">nil</span>&nbsp;<span class="op" id="4550940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550944">c</span><span class="op" id="4550945">.</span><span class="ident" id="4550946">config</span>&nbsp;<span class="op" id="4550953">=</span>&nbsp;<span class="ident" id="4550955">defaultConfig</span><span class="op" id="4550968">(</span><span class="op" id="4550969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4550972">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550976">if</span>&nbsp;<span class="builtinfunc" id="4550979">len</span><span class="op" id="4550982">(</span><span class="ident" id="4550983">c</span><span class="op" id="4550984">.</span><span class="ident" id="4550985">config</span><span class="op" id="4550991">.</span><span class="ident" id="4550992">ServerName</span><span class="op" id="4551002">)</span>&nbsp;<span class="op" id="4551004">==</span>&nbsp;<span class="num" id="4551007">0</span>&nbsp;<span class="op" id="4551009">&amp;&amp;</span>&nbsp;<span class="op" id="4551012">!</span><span class="ident" id="4551013">c</span><span class="op" id="4551014">.</span><span class="ident" id="4551015">config</span><span class="op" id="4551021">.</span><span class="ident" id="4551022">InsecureSkipVerify</span>&nbsp;<span class="op" id="4551041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551045">return</span>&nbsp;<span class="ident" id="4551052">errors</span><span class="op" id="4551058">.</span><span class="ident" id="4551059">New</span><span class="op" id="4551062">(</span><span class="string" id="4551063">&#34;tls:&nbsp;either&nbsp;ServerName&nbsp;or&nbsp;InsecureSkipVerify&nbsp;must&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;tls.Config&#34;</span><span class="op" id="4551145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551152">nextProtosLength</span>&nbsp;<span class="op" id="4551169">:=</span>&nbsp;<span class="num" id="4551172">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551175">for</span>&nbsp;<span class="ident" id="4551179">_</span><span class="op" id="4551180">,</span>&nbsp;<span class="ident" id="4551182">proto</span>&nbsp;<span class="op" id="4551188">:=</span>&nbsp;<span class="keyword" id="4551191">range</span>&nbsp;<span class="ident" id="4551197">c</span><span class="op" id="4551198">.</span><span class="ident" id="4551199">config</span><span class="op" id="4551205">.</span><span class="ident" id="4551206">NextProtos</span>&nbsp;<span class="op" id="4551217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551221">if</span>&nbsp;<span class="ident" id="4551224">l</span>&nbsp;<span class="op" id="4551226">:=</span>&nbsp;<span class="builtinfunc" id="4551229">len</span><span class="op" id="4551232">(</span><span class="ident" id="4551233">proto</span><span class="op" id="4551238">)</span><span class="op" id="4551239">;</span>&nbsp;<span class="ident" id="4551241">l</span>&nbsp;<span class="op" id="4551243">==</span>&nbsp;<span class="num" id="4551246">0</span>&nbsp;<span class="op" id="4551248">||</span>&nbsp;<span class="ident" id="4551251">l</span>&nbsp;<span class="op" id="4551253">&gt;</span>&nbsp;<span class="num" id="4551255">255</span>&nbsp;<span class="op" id="4551259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551264">return</span>&nbsp;<span class="ident" id="4551271">errors</span><span class="op" id="4551277">.</span><span class="ident" id="4551278">New</span><span class="op" id="4551281">(</span><span class="string" id="4551282">&#34;tls:&nbsp;invalid&nbsp;NextProtos&nbsp;value&#34;</span><span class="op" id="4551313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551317">}</span>&nbsp;<span class="keyword" id="4551319">else</span>&nbsp;<span class="op" id="4551324">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551329">nextProtosLength</span>&nbsp;<span class="op" id="4551346">+=</span>&nbsp;<span class="num" id="4551349">1</span>&nbsp;<span class="op" id="4551351">+</span>&nbsp;<span class="ident" id="4551353">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551363">if</span>&nbsp;<span class="ident" id="4551366">nextProtosLength</span>&nbsp;<span class="op" id="4551383">&gt;</span>&nbsp;<span class="num" id="4551385">0xffff</span>&nbsp;<span class="op" id="4551392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551396">return</span>&nbsp;<span class="ident" id="4551403">errors</span><span class="op" id="4551409">.</span><span class="ident" id="4551410">New</span><span class="op" id="4551413">(</span><span class="string" id="4551414">&#34;tls:&nbsp;NextProtos&nbsp;values&nbsp;too&nbsp;large&#34;</span><span class="op" id="4551448">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551455">hello</span>&nbsp;<span class="op" id="4551461">:=</span>&nbsp;<span class="op" id="4551464">&amp;</span><span class="ident" id="4551465">clientHelloMsg</span><span class="op" id="4551479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551483">vers</span><span class="op" id="4551487">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4551504">c</span><span class="op" id="4551505">.</span><span class="ident" id="4551506">config</span><span class="op" id="4551512">.</span><span class="ident" id="4551513">maxVersion</span><span class="op" id="4551523">(</span><span class="op" id="4551524">)</span><span class="op" id="4551525">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551529">compressionMethods</span><span class="op" id="4551547">:</span>&nbsp;&nbsp;<span class="op" id="4551550">[</span><span class="op" id="4551551">]</span><span class="builtintype" id="4551552">uint8</span><span class="op" id="4551557">{</span><span class="ident" id="4551558">compressionNone</span><span class="op" id="4551573">}</span><span class="op" id="4551574">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551578">random</span><span class="op" id="4551584">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4551599">make</span><span class="op" id="4551603">(</span><span class="op" id="4551604">[</span><span class="op" id="4551605">]</span><span class="builtintype" id="4551606">byte</span><span class="op" id="4551610">,</span>&nbsp;<span class="num" id="4551612">32</span><span class="op" id="4551614">)</span><span class="op" id="4551615">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551619">ocspStapling</span><span class="op" id="4551631">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4551640">true</span><span class="op" id="4551644">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551648">serverName</span><span class="op" id="4551658">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4551669">c</span><span class="op" id="4551670">.</span><span class="ident" id="4551671">config</span><span class="op" id="4551677">.</span><span class="ident" id="4551678">ServerName</span><span class="op" id="4551688">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551692">supportedCurves</span><span class="op" id="4551707">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4551713">c</span><span class="op" id="4551714">.</span><span class="ident" id="4551715">config</span><span class="op" id="4551721">.</span><span class="ident" id="4551722">curvePreferences</span><span class="op" id="4551738">(</span><span class="op" id="4551739">)</span><span class="op" id="4551740">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551744">supportedPoints</span><span class="op" id="4551759">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4551765">[</span><span class="op" id="4551766">]</span><span class="builtintype" id="4551767">uint8</span><span class="op" id="4551772">{</span><span class="ident" id="4551773">pointFormatUncompressed</span><span class="op" id="4551796">}</span><span class="op" id="4551797">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551801">nextProtoNeg</span><span class="op" id="4551813">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4551822">len</span><span class="op" id="4551825">(</span><span class="ident" id="4551826">c</span><span class="op" id="4551827">.</span><span class="ident" id="4551828">config</span><span class="op" id="4551834">.</span><span class="ident" id="4551835">NextProtos</span><span class="op" id="4551845">)</span>&nbsp;<span class="op" id="4551847">&gt;</span>&nbsp;<span class="num" id="4551849">0</span><span class="op" id="4551850">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551854">secureRenegotiation</span><span class="op" id="4551873">:</span>&nbsp;<span class="builtintype" id="4551875">true</span><span class="op" id="4551879">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551883">alpnProtocols</span><span class="op" id="4551896">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4551904">c</span><span class="op" id="4551905">.</span><span class="ident" id="4551906">config</span><span class="op" id="4551912">.</span><span class="ident" id="4551913">NextProtos</span><span class="op" id="4551923">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551930">possibleCipherSuites</span>&nbsp;<span class="op" id="4551951">:=</span>&nbsp;<span class="ident" id="4551954">c</span><span class="op" id="4551955">.</span><span class="ident" id="4551956">config</span><span class="op" id="4551962">.</span><span class="ident" id="4551963">cipherSuites</span><span class="op" id="4551975">(</span><span class="op" id="4551976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551979">hello</span><span class="op" id="4551984">.</span><span class="ident" id="4551985">cipherSuites</span>&nbsp;<span class="op" id="4551998">=</span>&nbsp;<span class="builtinfunc" id="4552000">make</span><span class="op" id="4552004">(</span><span class="op" id="4552005">[</span><span class="op" id="4552006">]</span><span class="builtintype" id="4552007">uint16</span><span class="op" id="4552013">,</span>&nbsp;<span class="num" id="4552015">0</span><span class="op" id="4552016">,</span>&nbsp;<span class="builtinfunc" id="4552018">len</span><span class="op" id="4552021">(</span><span class="ident" id="4552022">possibleCipherSuites</span><span class="op" id="4552042">)</span><span class="op" id="4552043">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4552046">NextCipherSuite</span><span class="op" id="4552061">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552064">for</span>&nbsp;<span class="ident" id="4552068">_</span><span class="op" id="4552069">,</span>&nbsp;<span class="ident" id="4552071">suiteId</span>&nbsp;<span class="op" id="4552079">:=</span>&nbsp;<span class="keyword" id="4552082">range</span>&nbsp;<span class="ident" id="4552088">possibleCipherSuites</span>&nbsp;<span class="op" id="4552109">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552113">for</span>&nbsp;<span class="ident" id="4552117">_</span><span class="op" id="4552118">,</span>&nbsp;<span class="ident" id="4552120">suite</span>&nbsp;<span class="op" id="4552126">:=</span>&nbsp;<span class="keyword" id="4552129">range</span>&nbsp;<span class="ident" id="4552135">cipherSuites</span>&nbsp;<span class="op" id="4552148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552153">if</span>&nbsp;<span class="ident" id="4552156">suite</span><span class="op" id="4552161">.</span><span class="ident" id="4552162">id</span>&nbsp;<span class="op" id="4552165">!=</span>&nbsp;<span class="ident" id="4552168">suiteId</span>&nbsp;<span class="op" id="4552176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552182">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4552194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4552199">//&nbsp;Don&#39;t&nbsp;advertise&nbsp;TLS&nbsp;1.2-only&nbsp;cipher&nbsp;suites&nbsp;unless</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4552255">//&nbsp;we&#39;re&nbsp;attempting&nbsp;TLS&nbsp;1.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552287">if</span>&nbsp;<span class="ident" id="4552290">hello</span><span class="op" id="4552295">.</span><span class="ident" id="4552296">vers</span>&nbsp;<span class="op" id="4552301">&lt;</span>&nbsp;<span class="ident" id="4552303">VersionTLS12</span>&nbsp;<span class="op" id="4552316">&amp;&amp;</span>&nbsp;<span class="ident" id="4552319">suite</span><span class="op" id="4552324">.</span><span class="ident" id="4552325">flags</span><span class="op" id="4552330">&amp;</span><span class="ident" id="4552331">suiteTLS12</span>&nbsp;<span class="op" id="4552342">!=</span>&nbsp;<span class="num" id="4552345">0</span>&nbsp;<span class="op" id="4552347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552353">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4552365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552370">hello</span><span class="op" id="4552375">.</span><span class="ident" id="4552376">cipherSuites</span>&nbsp;<span class="op" id="4552389">=</span>&nbsp;<span class="builtinfunc" id="4552391">append</span><span class="op" id="4552397">(</span><span class="ident" id="4552398">hello</span><span class="op" id="4552403">.</span><span class="ident" id="4552404">cipherSuites</span><span class="op" id="4552416">,</span>&nbsp;<span class="ident" id="4552418">suiteId</span><span class="op" id="4552425">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552430">continue</span>&nbsp;<span class="ident" id="4552439">NextCipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4552457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4552460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552464">_</span><span class="op" id="4552465">,</span>&nbsp;<span class="ident" id="4552467">err</span>&nbsp;<span class="op" id="4552471">:=</span>&nbsp;<span class="ident" id="4552474">io</span><span class="op" id="4552476">.</span><span class="ident" id="4552477">ReadFull</span><span class="op" id="4552485">(</span><span class="ident" id="4552486">c</span><span class="op" id="4552487">.</span><span class="ident" id="4552488">config</span><span class="op" id="4552494">.</span><span class="ident" id="4552495">rand</span><span class="op" id="4552499">(</span><span class="op" id="4552500">)</span><span class="op" id="4552501">,</span>&nbsp;<span class="ident" id="4552503">hello</span><span class="op" id="4552508">.</span><span class="ident" id="4552509">random</span><span class="op" id="4552515">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552518">if</span>&nbsp;<span class="ident" id="4552521">err</span>&nbsp;<span class="op" id="4552525">!=</span>&nbsp;<span class="ident" id="4552528">nil</span>&nbsp;<span class="op" id="4552532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552536">c</span><span class="op" id="4552537">.</span><span class="ident" id="4552538">sendAlert</span><span class="op" id="4552547">(</span><span class="ident" id="4552548">alertInternalError</span><span class="op" id="4552566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552570">return</span>&nbsp;<span class="ident" id="4552577">errors</span><span class="op" id="4552583">.</span><span class="ident" id="4552584">New</span><span class="op" id="4552587">(</span><span class="string" id="4552588">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="4552618">+</span>&nbsp;<span class="ident" id="4552620">err</span><span class="op" id="4552623">.</span><span class="ident" id="4552624">Error</span><span class="op" id="4552629">(</span><span class="op" id="4552630">)</span><span class="op" id="4552631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4552634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552638">if</span>&nbsp;<span class="ident" id="4552641">hello</span><span class="op" id="4552646">.</span><span class="ident" id="4552647">vers</span>&nbsp;<span class="op" id="4552652">&gt;=</span>&nbsp;<span class="ident" id="4552655">VersionTLS12</span>&nbsp;<span class="op" id="4552668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552672">hello</span><span class="op" id="4552677">.</span><span class="ident" id="4552678">signatureAndHashes</span>&nbsp;<span class="op" id="4552697">=</span>&nbsp;<span class="ident" id="4552699">supportedSKXSignatureAlgorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4552732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552736">var</span>&nbsp;<span class="ident" id="4552740">session</span>&nbsp;<span class="op" id="4552748">*</span><span class="ident" id="4552749">ClientSessionState</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552769">var</span>&nbsp;<span class="ident" id="4552773">cacheKey</span>&nbsp;<span class="builtintype" id="4552782">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552790">sessionCache</span>&nbsp;<span class="op" id="4552803">:=</span>&nbsp;<span class="ident" id="4552806">c</span><span class="op" id="4552807">.</span><span class="ident" id="4552808">config</span><span class="op" id="4552814">.</span><span class="ident" id="4552815">ClientSessionCache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552835">if</span>&nbsp;<span class="ident" id="4552838">c</span><span class="op" id="4552839">.</span><span class="ident" id="4552840">config</span><span class="op" id="4552846">.</span><span class="ident" id="4552847">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4552870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552874">sessionCache</span>&nbsp;<span class="op" id="4552887">=</span>&nbsp;<span class="ident" id="4552889">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4552894">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552898">if</span>&nbsp;<span class="ident" id="4552901">sessionCache</span>&nbsp;<span class="op" id="4552914">!=</span>&nbsp;<span class="ident" id="4552917">nil</span>&nbsp;<span class="op" id="4552921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552925">hello</span><span class="op" id="4552930">.</span><span class="ident" id="4552931">ticketSupported</span>&nbsp;<span class="op" id="4552947">=</span>&nbsp;<span class="builtintype" id="4552949">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4552957">//&nbsp;Try&nbsp;to&nbsp;resume&nbsp;a&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;session,&nbsp;if</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4553016">//&nbsp;available.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553032">cacheKey</span>&nbsp;<span class="op" id="4553041">=</span>&nbsp;<span class="ident" id="4553043">clientSessionCacheKey</span><span class="op" id="4553064">(</span><span class="ident" id="4553065">c</span><span class="op" id="4553066">.</span><span class="ident" id="4553067">conn</span><span class="op" id="4553071">.</span><span class="ident" id="4553072">RemoteAddr</span><span class="op" id="4553082">(</span><span class="op" id="4553083">)</span><span class="op" id="4553084">,</span>&nbsp;<span class="ident" id="4553086">c</span><span class="op" id="4553087">.</span><span class="ident" id="4553088">config</span><span class="op" id="4553094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553098">candidateSession</span><span class="op" id="4553114">,</span>&nbsp;<span class="ident" id="4553116">ok</span>&nbsp;<span class="op" id="4553119">:=</span>&nbsp;<span class="ident" id="4553122">sessionCache</span><span class="op" id="4553134">.</span><span class="ident" id="4553135">Get</span><span class="op" id="4553138">(</span><span class="ident" id="4553139">cacheKey</span><span class="op" id="4553147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553151">if</span>&nbsp;<span class="ident" id="4553154">ok</span>&nbsp;<span class="op" id="4553157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4553162">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;ciphersuite/version&nbsp;used&nbsp;for&nbsp;the</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4553216">//&nbsp;previous&nbsp;session&nbsp;are&nbsp;still&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553256">cipherSuiteOk</span>&nbsp;<span class="op" id="4553270">:=</span>&nbsp;<span class="builtintype" id="4553273">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553282">for</span>&nbsp;<span class="ident" id="4553286">_</span><span class="op" id="4553287">,</span>&nbsp;<span class="ident" id="4553289">id</span>&nbsp;<span class="op" id="4553292">:=</span>&nbsp;<span class="keyword" id="4553295">range</span>&nbsp;<span class="ident" id="4553301">hello</span><span class="op" id="4553306">.</span><span class="ident" id="4553307">cipherSuites</span>&nbsp;<span class="op" id="4553320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553326">if</span>&nbsp;<span class="ident" id="4553329">id</span>&nbsp;<span class="op" id="4553332">==</span>&nbsp;<span class="ident" id="4553335">candidateSession</span><span class="op" id="4553351">.</span><span class="ident" id="4553352">cipherSuite</span>&nbsp;<span class="op" id="4553364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553371">cipherSuiteOk</span>&nbsp;<span class="op" id="4553385">=</span>&nbsp;<span class="builtintype" id="4553387">true</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553397">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4553407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4553412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553418">versOk</span>&nbsp;<span class="op" id="4553425">:=</span>&nbsp;<span class="ident" id="4553428">candidateSession</span><span class="op" id="4553444">.</span><span class="ident" id="4553445">vers</span>&nbsp;<span class="op" id="4553450">&gt;=</span>&nbsp;<span class="ident" id="4553453">c</span><span class="op" id="4553454">.</span><span class="ident" id="4553455">config</span><span class="op" id="4553461">.</span><span class="ident" id="4553462">minVersion</span><span class="op" id="4553472">(</span><span class="op" id="4553473">)</span>&nbsp;<span class="op" id="4553475">&amp;&amp;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553482">candidateSession</span><span class="op" id="4553498">.</span><span class="ident" id="4553499">vers</span>&nbsp;<span class="op" id="4553504">&lt;=</span>&nbsp;<span class="ident" id="4553507">c</span><span class="op" id="4553508">.</span><span class="ident" id="4553509">config</span><span class="op" id="4553515">.</span><span class="ident" id="4553516">maxVersion</span><span class="op" id="4553526">(</span><span class="op" id="4553527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553532">if</span>&nbsp;<span class="ident" id="4553535">versOk</span>&nbsp;<span class="op" id="4553542">&amp;&amp;</span>&nbsp;<span class="ident" id="4553545">cipherSuiteOk</span>&nbsp;<span class="op" id="4553559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553565">session</span>&nbsp;<span class="op" id="4553573">=</span>&nbsp;<span class="ident" id="4553575">candidateSession</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4553595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4553599">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4553602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553606">if</span>&nbsp;<span class="ident" id="4553609">session</span>&nbsp;<span class="op" id="4553617">!=</span>&nbsp;<span class="ident" id="4553620">nil</span>&nbsp;<span class="op" id="4553624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553628">hello</span><span class="op" id="4553633">.</span><span class="ident" id="4553634">sessionTicket</span>&nbsp;<span class="op" id="4553648">=</span>&nbsp;<span class="ident" id="4553650">session</span><span class="op" id="4553657">.</span><span class="ident" id="4553658">sessionTicket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4553674">//&nbsp;A&nbsp;random&nbsp;session&nbsp;ID&nbsp;is&nbsp;used&nbsp;to&nbsp;detect&nbsp;when&nbsp;the</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4553726">//&nbsp;server&nbsp;accepted&nbsp;the&nbsp;ticket&nbsp;and&nbsp;is&nbsp;resuming&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4553784">//&nbsp;(see&nbsp;RFC&nbsp;5077).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553805">hello</span><span class="op" id="4553810">.</span><span class="ident" id="4553811">sessionId</span>&nbsp;<span class="op" id="4553821">=</span>&nbsp;<span class="builtinfunc" id="4553823">make</span><span class="op" id="4553827">(</span><span class="op" id="4553828">[</span><span class="op" id="4553829">]</span><span class="builtintype" id="4553830">byte</span><span class="op" id="4553834">,</span>&nbsp;<span class="num" id="4553836">16</span><span class="op" id="4553838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553842">if</span>&nbsp;<span class="ident" id="4553845">_</span><span class="op" id="4553846">,</span>&nbsp;<span class="ident" id="4553848">err</span>&nbsp;<span class="op" id="4553852">:=</span>&nbsp;<span class="ident" id="4553855">io</span><span class="op" id="4553857">.</span><span class="ident" id="4553858">ReadFull</span><span class="op" id="4553866">(</span><span class="ident" id="4553867">c</span><span class="op" id="4553868">.</span><span class="ident" id="4553869">config</span><span class="op" id="4553875">.</span><span class="ident" id="4553876">rand</span><span class="op" id="4553880">(</span><span class="op" id="4553881">)</span><span class="op" id="4553882">,</span>&nbsp;<span class="ident" id="4553884">hello</span><span class="op" id="4553889">.</span><span class="ident" id="4553890">sessionId</span><span class="op" id="4553899">)</span><span class="op" id="4553900">;</span>&nbsp;<span class="ident" id="4553902">err</span>&nbsp;<span class="op" id="4553906">!=</span>&nbsp;<span class="ident" id="4553909">nil</span>&nbsp;<span class="op" id="4553913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553918">c</span><span class="op" id="4553919">.</span><span class="ident" id="4553920">sendAlert</span><span class="op" id="4553929">(</span><span class="ident" id="4553930">alertInternalError</span><span class="op" id="4553948">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553953">return</span>&nbsp;<span class="ident" id="4553960">errors</span><span class="op" id="4553966">.</span><span class="ident" id="4553967">New</span><span class="op" id="4553970">(</span><span class="string" id="4553971">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="4554001">+</span>&nbsp;<span class="ident" id="4554003">err</span><span class="op" id="4554006">.</span><span class="ident" id="4554007">Error</span><span class="op" id="4554012">(</span><span class="op" id="4554013">)</span><span class="op" id="4554014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4554018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4554021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554025">c</span><span class="op" id="4554026">.</span><span class="ident" id="4554027">writeRecord</span><span class="op" id="4554038">(</span><span class="ident" id="4554039">recordTypeHandshake</span><span class="op" id="4554058">,</span>&nbsp;<span class="ident" id="4554060">hello</span><span class="op" id="4554065">.</span><span class="ident" id="4554066">marshal</span><span class="op" id="4554073">(</span><span class="op" id="4554074">)</span><span class="op" id="4554075">)</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554079">msg</span><span class="op" id="4554082">,</span>&nbsp;<span class="ident" id="4554084">err</span>&nbsp;<span class="op" id="4554088">:=</span>&nbsp;<span class="ident" id="4554091">c</span><span class="op" id="4554092">.</span><span class="ident" id="4554093">readHandshake</span><span class="op" id="4554106">(</span><span class="op" id="4554107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554110">if</span>&nbsp;<span class="ident" id="4554113">err</span>&nbsp;<span class="op" id="4554117">!=</span>&nbsp;<span class="ident" id="4554120">nil</span>&nbsp;<span class="op" id="4554124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554128">return</span>&nbsp;<span class="ident" id="4554135">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4554140">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554143">serverHello</span><span class="op" id="4554154">,</span>&nbsp;<span class="ident" id="4554156">ok</span>&nbsp;<span class="op" id="4554159">:=</span>&nbsp;<span class="ident" id="4554162">msg</span><span class="op" id="4554165">.</span><span class="op" id="4554166">(</span><span class="op" id="4554167">*</span><span class="ident" id="4554168">serverHelloMsg</span><span class="op" id="4554182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554185">if</span>&nbsp;<span class="op" id="4554188">!</span><span class="ident" id="4554189">ok</span>&nbsp;<span class="op" id="4554192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554196">c</span><span class="op" id="4554197">.</span><span class="ident" id="4554198">sendAlert</span><span class="op" id="4554207">(</span><span class="ident" id="4554208">alertUnexpectedMessage</span><span class="op" id="4554230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554234">return</span>&nbsp;<span class="ident" id="4554241">unexpectedMessageError</span><span class="op" id="4554263">(</span><span class="ident" id="4554264">serverHello</span><span class="op" id="4554275">,</span>&nbsp;<span class="ident" id="4554277">msg</span><span class="op" id="4554280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4554283">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554287">vers</span><span class="op" id="4554291">,</span>&nbsp;<span class="ident" id="4554293">ok</span>&nbsp;<span class="op" id="4554296">:=</span>&nbsp;<span class="ident" id="4554299">c</span><span class="op" id="4554300">.</span><span class="ident" id="4554301">config</span><span class="op" id="4554307">.</span><span class="ident" id="4554308">mutualVersion</span><span class="op" id="4554321">(</span><span class="ident" id="4554322">serverHello</span><span class="op" id="4554333">.</span><span class="ident" id="4554334">vers</span><span class="op" id="4554338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554341">if</span>&nbsp;<span class="op" id="4554344">!</span><span class="ident" id="4554345">ok</span>&nbsp;<span class="op" id="4554348">||</span>&nbsp;<span class="ident" id="4554351">vers</span>&nbsp;<span class="op" id="4554356">&lt;</span>&nbsp;<span class="ident" id="4554358">VersionTLS10</span>&nbsp;<span class="op" id="4554371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4554375">//&nbsp;TLS&nbsp;1.0&nbsp;is&nbsp;the&nbsp;minimum&nbsp;version&nbsp;supported&nbsp;as&nbsp;a&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554434">c</span><span class="op" id="4554435">.</span><span class="ident" id="4554436">sendAlert</span><span class="op" id="4554445">(</span><span class="ident" id="4554446">alertProtocolVersion</span><span class="op" id="4554466">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554470">return</span>&nbsp;<span class="ident" id="4554477">fmt</span><span class="op" id="4554480">.</span><span class="ident" id="4554481">Errorf</span><span class="op" id="4554487">(</span><span class="string" id="4554488">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;protocol&nbsp;version&nbsp;%x&#34;</span><span class="op" id="4554542">,</span>&nbsp;<span class="ident" id="4554544">serverHello</span><span class="op" id="4554555">.</span><span class="ident" id="4554556">vers</span><span class="op" id="4554560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4554563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554566">c</span><span class="op" id="4554567">.</span><span class="ident" id="4554568">vers</span>&nbsp;<span class="op" id="4554573">=</span>&nbsp;<span class="ident" id="4554575">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554581">c</span><span class="op" id="4554582">.</span><span class="ident" id="4554583">haveVers</span>&nbsp;<span class="op" id="4554592">=</span>&nbsp;<span class="builtintype" id="4554594">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554601">suite</span>&nbsp;<span class="op" id="4554607">:=</span>&nbsp;<span class="ident" id="4554610">mutualCipherSuite</span><span class="op" id="4554627">(</span><span class="ident" id="4554628">c</span><span class="op" id="4554629">.</span><span class="ident" id="4554630">config</span><span class="op" id="4554636">.</span><span class="ident" id="4554637">cipherSuites</span><span class="op" id="4554649">(</span><span class="op" id="4554650">)</span><span class="op" id="4554651">,</span>&nbsp;<span class="ident" id="4554653">serverHello</span><span class="op" id="4554664">.</span><span class="ident" id="4554665">cipherSuite</span><span class="op" id="4554676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554679">if</span>&nbsp;<span class="ident" id="4554682">suite</span>&nbsp;<span class="op" id="4554688">==</span>&nbsp;<span class="ident" id="4554691">nil</span>&nbsp;<span class="op" id="4554695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554699">c</span><span class="op" id="4554700">.</span><span class="ident" id="4554701">sendAlert</span><span class="op" id="4554710">(</span><span class="ident" id="4554711">alertHandshakeFailure</span><span class="op" id="4554732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554736">return</span>&nbsp;<span class="ident" id="4554743">fmt</span><span class="op" id="4554746">.</span><span class="ident" id="4554747">Errorf</span><span class="op" id="4554753">(</span><span class="string" id="4554754">&#34;tls:&nbsp;server&nbsp;selected&nbsp;an&nbsp;unsupported&nbsp;cipher&nbsp;suite&#34;</span><span class="op" id="4554804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4554807">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554811">hs</span>&nbsp;<span class="op" id="4554814">:=</span>&nbsp;<span class="op" id="4554817">&amp;</span><span class="ident" id="4554818">clientHandshakeState</span><span class="op" id="4554838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554842">c</span><span class="op" id="4554843">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4554856">c</span><span class="op" id="4554857">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554861">serverHello</span><span class="op" id="4554872">:</span>&nbsp;&nbsp;<span class="ident" id="4554875">serverHello</span><span class="op" id="4554886">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554890">hello</span><span class="op" id="4554895">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4554904">hello</span><span class="op" id="4554909">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554913">suite</span><span class="op" id="4554918">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4554927">suite</span><span class="op" id="4554932">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554936">finishedHash</span><span class="op" id="4554948">:</span>&nbsp;<span class="ident" id="4554950">newFinishedHash</span><span class="op" id="4554965">(</span><span class="ident" id="4554966">c</span><span class="op" id="4554967">.</span><span class="ident" id="4554968">vers</span><span class="op" id="4554972">)</span><span class="op" id="4554973">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554977">session</span><span class="op" id="4554984">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4554991">session</span><span class="op" id="4554998">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555005">hs</span><span class="op" id="4555007">.</span><span class="ident" id="4555008">finishedHash</span><span class="op" id="4555020">.</span><span class="ident" id="4555021">Write</span><span class="op" id="4555026">(</span><span class="ident" id="4555027">hs</span><span class="op" id="4555029">.</span><span class="ident" id="4555030">hello</span><span class="op" id="4555035">.</span><span class="ident" id="4555036">marshal</span><span class="op" id="4555043">(</span><span class="op" id="4555044">)</span><span class="op" id="4555045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555048">hs</span><span class="op" id="4555050">.</span><span class="ident" id="4555051">finishedHash</span><span class="op" id="4555063">.</span><span class="ident" id="4555064">Write</span><span class="op" id="4555069">(</span><span class="ident" id="4555070">hs</span><span class="op" id="4555072">.</span><span class="ident" id="4555073">serverHello</span><span class="op" id="4555084">.</span><span class="ident" id="4555085">marshal</span><span class="op" id="4555092">(</span><span class="op" id="4555093">)</span><span class="op" id="4555094">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555098">isResume</span><span class="op" id="4555106">,</span>&nbsp;<span class="ident" id="4555108">err</span>&nbsp;<span class="op" id="4555112">:=</span>&nbsp;<span class="ident" id="4555115">hs</span><span class="op" id="4555117">.</span><span class="ident" id="4555118">processServerHello</span><span class="op" id="4555136">(</span><span class="op" id="4555137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555140">if</span>&nbsp;<span class="ident" id="4555143">err</span>&nbsp;<span class="op" id="4555147">!=</span>&nbsp;<span class="ident" id="4555150">nil</span>&nbsp;<span class="op" id="4555154">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555158">return</span>&nbsp;<span class="ident" id="4555165">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555174">if</span>&nbsp;<span class="ident" id="4555177">isResume</span>&nbsp;<span class="op" id="4555186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555190">if</span>&nbsp;<span class="ident" id="4555193">err</span>&nbsp;<span class="op" id="4555197">:=</span>&nbsp;<span class="ident" id="4555200">hs</span><span class="op" id="4555202">.</span><span class="ident" id="4555203">establishKeys</span><span class="op" id="4555216">(</span><span class="op" id="4555217">)</span><span class="op" id="4555218">;</span>&nbsp;<span class="ident" id="4555220">err</span>&nbsp;<span class="op" id="4555224">!=</span>&nbsp;<span class="ident" id="4555227">nil</span>&nbsp;<span class="op" id="4555231">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555236">return</span>&nbsp;<span class="ident" id="4555243">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555253">if</span>&nbsp;<span class="ident" id="4555256">err</span>&nbsp;<span class="op" id="4555260">:=</span>&nbsp;<span class="ident" id="4555263">hs</span><span class="op" id="4555265">.</span><span class="ident" id="4555266">readSessionTicket</span><span class="op" id="4555283">(</span><span class="op" id="4555284">)</span><span class="op" id="4555285">;</span>&nbsp;<span class="ident" id="4555287">err</span>&nbsp;<span class="op" id="4555291">!=</span>&nbsp;<span class="ident" id="4555294">nil</span>&nbsp;<span class="op" id="4555298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555303">return</span>&nbsp;<span class="ident" id="4555310">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555316">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555320">if</span>&nbsp;<span class="ident" id="4555323">err</span>&nbsp;<span class="op" id="4555327">:=</span>&nbsp;<span class="ident" id="4555330">hs</span><span class="op" id="4555332">.</span><span class="ident" id="4555333">readFinished</span><span class="op" id="4555345">(</span><span class="ident" id="4555346">c</span><span class="op" id="4555347">.</span><span class="ident" id="4555348">firstFinished</span><span class="op" id="4555361">[</span><span class="op" id="4555362">:</span><span class="op" id="4555363">]</span><span class="op" id="4555364">)</span><span class="op" id="4555365">;</span>&nbsp;<span class="ident" id="4555367">err</span>&nbsp;<span class="op" id="4555371">!=</span>&nbsp;<span class="ident" id="4555374">nil</span>&nbsp;<span class="op" id="4555378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555383">return</span>&nbsp;<span class="ident" id="4555390">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555400">if</span>&nbsp;<span class="ident" id="4555403">err</span>&nbsp;<span class="op" id="4555407">:=</span>&nbsp;<span class="ident" id="4555410">hs</span><span class="op" id="4555412">.</span><span class="ident" id="4555413">sendFinished</span><span class="op" id="4555425">(</span><span class="ident" id="4555426">nil</span><span class="op" id="4555429">)</span><span class="op" id="4555430">;</span>&nbsp;<span class="ident" id="4555432">err</span>&nbsp;<span class="op" id="4555436">!=</span>&nbsp;<span class="ident" id="4555439">nil</span>&nbsp;<span class="op" id="4555443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555448">return</span>&nbsp;<span class="ident" id="4555455">err</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555464">}</span>&nbsp;<span class="keyword" id="4555466">else</span>&nbsp;<span class="op" id="4555471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555475">if</span>&nbsp;<span class="ident" id="4555478">err</span>&nbsp;<span class="op" id="4555482">:=</span>&nbsp;<span class="ident" id="4555485">hs</span><span class="op" id="4555487">.</span><span class="ident" id="4555488">doFullHandshake</span><span class="op" id="4555503">(</span><span class="op" id="4555504">)</span><span class="op" id="4555505">;</span>&nbsp;<span class="ident" id="4555507">err</span>&nbsp;<span class="op" id="4555511">!=</span>&nbsp;<span class="ident" id="4555514">nil</span>&nbsp;<span class="op" id="4555518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555523">return</span>&nbsp;<span class="ident" id="4555530">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555536">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555540">if</span>&nbsp;<span class="ident" id="4555543">err</span>&nbsp;<span class="op" id="4555547">:=</span>&nbsp;<span class="ident" id="4555550">hs</span><span class="op" id="4555552">.</span><span class="ident" id="4555553">establishKeys</span><span class="op" id="4555566">(</span><span class="op" id="4555567">)</span><span class="op" id="4555568">;</span>&nbsp;<span class="ident" id="4555570">err</span>&nbsp;<span class="op" id="4555574">!=</span>&nbsp;<span class="ident" id="4555577">nil</span>&nbsp;<span class="op" id="4555581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555586">return</span>&nbsp;<span class="ident" id="4555593">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555603">if</span>&nbsp;<span class="ident" id="4555606">err</span>&nbsp;<span class="op" id="4555610">:=</span>&nbsp;<span class="ident" id="4555613">hs</span><span class="op" id="4555615">.</span><span class="ident" id="4555616">sendFinished</span><span class="op" id="4555628">(</span><span class="ident" id="4555629">c</span><span class="op" id="4555630">.</span><span class="ident" id="4555631">firstFinished</span><span class="op" id="4555644">[</span><span class="op" id="4555645">:</span><span class="op" id="4555646">]</span><span class="op" id="4555647">)</span><span class="op" id="4555648">;</span>&nbsp;<span class="ident" id="4555650">err</span>&nbsp;<span class="op" id="4555654">!=</span>&nbsp;<span class="ident" id="4555657">nil</span>&nbsp;<span class="op" id="4555661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555666">return</span>&nbsp;<span class="ident" id="4555673">err</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555683">if</span>&nbsp;<span class="ident" id="4555686">err</span>&nbsp;<span class="op" id="4555690">:=</span>&nbsp;<span class="ident" id="4555693">hs</span><span class="op" id="4555695">.</span><span class="ident" id="4555696">readSessionTicket</span><span class="op" id="4555713">(</span><span class="op" id="4555714">)</span><span class="op" id="4555715">;</span>&nbsp;<span class="ident" id="4555717">err</span>&nbsp;<span class="op" id="4555721">!=</span>&nbsp;<span class="ident" id="4555724">nil</span>&nbsp;<span class="op" id="4555728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555733">return</span>&nbsp;<span class="ident" id="4555740">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555750">if</span>&nbsp;<span class="ident" id="4555753">err</span>&nbsp;<span class="op" id="4555757">:=</span>&nbsp;<span class="ident" id="4555760">hs</span><span class="op" id="4555762">.</span><span class="ident" id="4555763">readFinished</span><span class="op" id="4555775">(</span><span class="ident" id="4555776">nil</span><span class="op" id="4555779">)</span><span class="op" id="4555780">;</span>&nbsp;<span class="ident" id="4555782">err</span>&nbsp;<span class="op" id="4555786">!=</span>&nbsp;<span class="ident" id="4555789">nil</span>&nbsp;<span class="op" id="4555793">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555798">return</span>&nbsp;<span class="ident" id="4555805">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555818">if</span>&nbsp;<span class="ident" id="4555821">sessionCache</span>&nbsp;<span class="op" id="4555834">!=</span>&nbsp;<span class="ident" id="4555837">nil</span>&nbsp;<span class="op" id="4555841">&amp;&amp;</span>&nbsp;<span class="ident" id="4555844">hs</span><span class="op" id="4555846">.</span><span class="ident" id="4555847">session</span>&nbsp;<span class="op" id="4555855">!=</span>&nbsp;<span class="ident" id="4555858">nil</span>&nbsp;<span class="op" id="4555862">&amp;&amp;</span>&nbsp;<span class="ident" id="4555865">session</span>&nbsp;<span class="op" id="4555873">!=</span>&nbsp;<span class="ident" id="4555876">hs</span><span class="op" id="4555878">.</span><span class="ident" id="4555879">session</span>&nbsp;<span class="op" id="4555887">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555891">sessionCache</span><span class="op" id="4555903">.</span><span class="ident" id="4555904">Put</span><span class="op" id="4555907">(</span><span class="ident" id="4555908">cacheKey</span><span class="op" id="4555916">,</span>&nbsp;<span class="ident" id="4555918">hs</span><span class="op" id="4555920">.</span><span class="ident" id="4555921">session</span><span class="op" id="4555928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555935">c</span><span class="op" id="4555936">.</span><span class="ident" id="4555937">didResume</span>&nbsp;<span class="op" id="4555947">=</span>&nbsp;<span class="ident" id="4555949">isResume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555959">c</span><span class="op" id="4555960">.</span><span class="ident" id="4555961">handshakeComplete</span>&nbsp;<span class="op" id="4555979">=</span>&nbsp;<span class="builtintype" id="4555981">true</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555987">c</span><span class="op" id="4555988">.</span><span class="ident" id="4555989">cipherSuite</span>&nbsp;<span class="op" id="4556001">=</span>&nbsp;<span class="ident" id="4556003">suite</span><span class="op" id="4556008">.</span><span class="ident" id="4556009">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556013">return</span>&nbsp;<span class="ident" id="4556020">nil</span><br>
<span class="lineno"></span><span class="op" id="4556024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4556027">func</span>&nbsp;<span class="op" id="4556032">(</span><span class="ident" id="4556033">hs</span>&nbsp;<span class="op" id="4556036">*</span><span class="ident" id="4556037">clientHandshakeState</span><span class="op" id="4556057">)</span>&nbsp;<span class="ident" id="4556059">doFullHandshake</span><span class="op" id="4556074">(</span><span class="op" id="4556075">)</span>&nbsp;<span class="builtintype" id="4556077">error</span>&nbsp;<span class="op" id="4556083">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556086">c</span>&nbsp;<span class="op" id="4556088">:=</span>&nbsp;<span class="ident" id="4556091">hs</span><span class="op" id="4556093">.</span><span class="ident" id="4556094">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556098">msg</span><span class="op" id="4556101">,</span>&nbsp;<span class="ident" id="4556103">err</span>&nbsp;<span class="op" id="4556107">:=</span>&nbsp;<span class="ident" id="4556110">c</span><span class="op" id="4556111">.</span><span class="ident" id="4556112">readHandshake</span><span class="op" id="4556125">(</span><span class="op" id="4556126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556129">if</span>&nbsp;<span class="ident" id="4556132">err</span>&nbsp;<span class="op" id="4556136">!=</span>&nbsp;<span class="ident" id="4556139">nil</span>&nbsp;<span class="op" id="4556143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556147">return</span>&nbsp;<span class="ident" id="4556154">err</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4556159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556162">certMsg</span><span class="op" id="4556169">,</span>&nbsp;<span class="ident" id="4556171">ok</span>&nbsp;<span class="op" id="4556174">:=</span>&nbsp;<span class="ident" id="4556177">msg</span><span class="op" id="4556180">.</span><span class="op" id="4556181">(</span><span class="op" id="4556182">*</span><span class="ident" id="4556183">certificateMsg</span><span class="op" id="4556197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556200">if</span>&nbsp;<span class="op" id="4556203">!</span><span class="ident" id="4556204">ok</span>&nbsp;<span class="op" id="4556207">||</span>&nbsp;<span class="builtinfunc" id="4556210">len</span><span class="op" id="4556213">(</span><span class="ident" id="4556214">certMsg</span><span class="op" id="4556221">.</span><span class="ident" id="4556222">certificates</span><span class="op" id="4556234">)</span>&nbsp;<span class="op" id="4556236">==</span>&nbsp;<span class="num" id="4556239">0</span>&nbsp;<span class="op" id="4556241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556245">c</span><span class="op" id="4556246">.</span><span class="ident" id="4556247">sendAlert</span><span class="op" id="4556256">(</span><span class="ident" id="4556257">alertUnexpectedMessage</span><span class="op" id="4556279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556283">return</span>&nbsp;<span class="ident" id="4556290">unexpectedMessageError</span><span class="op" id="4556312">(</span><span class="ident" id="4556313">certMsg</span><span class="op" id="4556320">,</span>&nbsp;<span class="ident" id="4556322">msg</span><span class="op" id="4556325">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4556328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556331">hs</span><span class="op" id="4556333">.</span><span class="ident" id="4556334">finishedHash</span><span class="op" id="4556346">.</span><span class="ident" id="4556347">Write</span><span class="op" id="4556352">(</span><span class="ident" id="4556353">certMsg</span><span class="op" id="4556360">.</span><span class="ident" id="4556361">marshal</span><span class="op" id="4556368">(</span><span class="op" id="4556369">)</span><span class="op" id="4556370">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556374">certs</span>&nbsp;<span class="op" id="4556380">:=</span>&nbsp;<span class="builtinfunc" id="4556383">make</span><span class="op" id="4556387">(</span><span class="op" id="4556388">[</span><span class="op" id="4556389">]</span><span class="op" id="4556390">*</span><span class="ident" id="4556391">x509</span><span class="op" id="4556395">.</span><span class="ident" id="4556396">Certificate</span><span class="op" id="4556407">,</span>&nbsp;<span class="builtinfunc" id="4556409">len</span><span class="op" id="4556412">(</span><span class="ident" id="4556413">certMsg</span><span class="op" id="4556420">.</span><span class="ident" id="4556421">certificates</span><span class="op" id="4556433">)</span><span class="op" id="4556434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556437">for</span>&nbsp;<span class="ident" id="4556441">i</span><span class="op" id="4556442">,</span>&nbsp;<span class="ident" id="4556444">asn1Data</span>&nbsp;<span class="op" id="4556453">:=</span>&nbsp;<span class="keyword" id="4556456">range</span>&nbsp;<span class="ident" id="4556462">certMsg</span><span class="op" id="4556469">.</span><span class="ident" id="4556470">certificates</span>&nbsp;<span class="op" id="4556483">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556487">cert</span><span class="op" id="4556491">,</span>&nbsp;<span class="ident" id="4556493">err</span>&nbsp;<span class="op" id="4556497">:=</span>&nbsp;<span class="ident" id="4556500">x509</span><span class="op" id="4556504">.</span><span class="ident" id="4556505">ParseCertificate</span><span class="op" id="4556521">(</span><span class="ident" id="4556522">asn1Data</span><span class="op" id="4556530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556534">if</span>&nbsp;<span class="ident" id="4556537">err</span>&nbsp;<span class="op" id="4556541">!=</span>&nbsp;<span class="ident" id="4556544">nil</span>&nbsp;<span class="op" id="4556548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556553">c</span><span class="op" id="4556554">.</span><span class="ident" id="4556555">sendAlert</span><span class="op" id="4556564">(</span><span class="ident" id="4556565">alertBadCertificate</span><span class="op" id="4556584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556589">return</span>&nbsp;<span class="ident" id="4556596">errors</span><span class="op" id="4556602">.</span><span class="ident" id="4556603">New</span><span class="op" id="4556606">(</span><span class="string" id="4556607">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;from&nbsp;server:&nbsp;&#34;</span>&nbsp;<span class="op" id="4556656">+</span>&nbsp;<span class="ident" id="4556658">err</span><span class="op" id="4556661">.</span><span class="ident" id="4556662">Error</span><span class="op" id="4556667">(</span><span class="op" id="4556668">)</span><span class="op" id="4556669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4556673">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556677">certs</span><span class="op" id="4556682">[</span><span class="ident" id="4556683">i</span><span class="op" id="4556684">]</span>&nbsp;<span class="op" id="4556686">=</span>&nbsp;<span class="ident" id="4556688">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4556694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556698">if</span>&nbsp;<span class="op" id="4556701">!</span><span class="ident" id="4556702">c</span><span class="op" id="4556703">.</span><span class="ident" id="4556704">config</span><span class="op" id="4556710">.</span><span class="ident" id="4556711">InsecureSkipVerify</span>&nbsp;<span class="op" id="4556730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556734">opts</span>&nbsp;<span class="op" id="4556739">:=</span>&nbsp;<span class="ident" id="4556742">x509</span><span class="op" id="4556746">.</span><span class="ident" id="4556747">VerifyOptions</span><span class="op" id="4556760">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556765">Roots</span><span class="op" id="4556770">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4556780">c</span><span class="op" id="4556781">.</span><span class="ident" id="4556782">config</span><span class="op" id="4556788">.</span><span class="ident" id="4556789">RootCAs</span><span class="op" id="4556796">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556801">CurrentTime</span><span class="op" id="4556812">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4556816">c</span><span class="op" id="4556817">.</span><span class="ident" id="4556818">config</span><span class="op" id="4556824">.</span><span class="ident" id="4556825">time</span><span class="op" id="4556829">(</span><span class="op" id="4556830">)</span><span class="op" id="4556831">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556836">DNSName</span><span class="op" id="4556843">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4556851">c</span><span class="op" id="4556852">.</span><span class="ident" id="4556853">config</span><span class="op" id="4556859">.</span><span class="ident" id="4556860">ServerName</span><span class="op" id="4556870">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556875">Intermediates</span><span class="op" id="4556888">:</span>&nbsp;<span class="ident" id="4556890">x509</span><span class="op" id="4556894">.</span><span class="ident" id="4556895">NewCertPool</span><span class="op" id="4556906">(</span><span class="op" id="4556907">)</span><span class="op" id="4556908">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4556912">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556917">for</span>&nbsp;<span class="ident" id="4556921">i</span><span class="op" id="4556922">,</span>&nbsp;<span class="ident" id="4556924">cert</span>&nbsp;<span class="op" id="4556929">:=</span>&nbsp;<span class="keyword" id="4556932">range</span>&nbsp;<span class="ident" id="4556938">certs</span>&nbsp;<span class="op" id="4556944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556949">if</span>&nbsp;<span class="ident" id="4556952">i</span>&nbsp;<span class="op" id="4556954">==</span>&nbsp;<span class="num" id="4556957">0</span>&nbsp;<span class="op" id="4556959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556965">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4556977">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556982">opts</span><span class="op" id="4556986">.</span><span class="ident" id="4556987">Intermediates</span><span class="op" id="4557000">.</span><span class="ident" id="4557001">AddCert</span><span class="op" id="4557008">(</span><span class="ident" id="4557009">cert</span><span class="op" id="4557013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557021">c</span><span class="op" id="4557022">.</span><span class="ident" id="4557023">verifiedChains</span><span class="op" id="4557037">,</span>&nbsp;<span class="ident" id="4557039">err</span>&nbsp;<span class="op" id="4557043">=</span>&nbsp;<span class="ident" id="4557045">certs</span><span class="op" id="4557050">[</span><span class="num" id="4557051">0</span><span class="op" id="4557052">]</span><span class="op" id="4557053">.</span><span class="ident" id="4557054">Verify</span><span class="op" id="4557060">(</span><span class="ident" id="4557061">opts</span><span class="op" id="4557065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557069">if</span>&nbsp;<span class="ident" id="4557072">err</span>&nbsp;<span class="op" id="4557076">!=</span>&nbsp;<span class="ident" id="4557079">nil</span>&nbsp;<span class="op" id="4557083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557088">c</span><span class="op" id="4557089">.</span><span class="ident" id="4557090">sendAlert</span><span class="op" id="4557099">(</span><span class="ident" id="4557100">alertBadCertificate</span><span class="op" id="4557119">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557124">return</span>&nbsp;<span class="ident" id="4557131">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557144">switch</span>&nbsp;<span class="ident" id="4557151">certs</span><span class="op" id="4557156">[</span><span class="num" id="4557157">0</span><span class="op" id="4557158">]</span><span class="op" id="4557159">.</span><span class="ident" id="4557160">PublicKey</span><span class="op" id="4557169">.</span><span class="op" id="4557170">(</span><span class="keyword" id="4557171">type</span><span class="op" id="4557175">)</span>&nbsp;<span class="op" id="4557177">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557180">case</span>&nbsp;<span class="op" id="4557185">*</span><span class="ident" id="4557186">rsa</span><span class="op" id="4557189">.</span><span class="ident" id="4557190">PublicKey</span><span class="op" id="4557199">,</span>&nbsp;<span class="op" id="4557201">*</span><span class="ident" id="4557202">ecdsa</span><span class="op" id="4557207">.</span><span class="ident" id="4557208">PublicKey</span><span class="op" id="4557217">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557221">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557228">default</span><span class="op" id="4557235">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557239">c</span><span class="op" id="4557240">.</span><span class="ident" id="4557241">sendAlert</span><span class="op" id="4557250">(</span><span class="ident" id="4557251">alertUnsupportedCertificate</span><span class="op" id="4557278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557282">return</span>&nbsp;<span class="ident" id="4557289">fmt</span><span class="op" id="4557292">.</span><span class="ident" id="4557293">Errorf</span><span class="op" id="4557299">(</span><span class="string" id="4557300">&#34;tls:&nbsp;server&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;type&nbsp;of&nbsp;public&nbsp;key:&nbsp;%T&#34;</span><span class="op" id="4557374">,</span>&nbsp;<span class="ident" id="4557376">certs</span><span class="op" id="4557381">[</span><span class="num" id="4557382">0</span><span class="op" id="4557383">]</span><span class="op" id="4557384">.</span><span class="ident" id="4557385">PublicKey</span><span class="op" id="4557394">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557401">c</span><span class="op" id="4557402">.</span><span class="ident" id="4557403">peerCertificates</span>&nbsp;<span class="op" id="4557420">=</span>&nbsp;<span class="ident" id="4557422">certs</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557430">if</span>&nbsp;<span class="ident" id="4557433">hs</span><span class="op" id="4557435">.</span><span class="ident" id="4557436">serverHello</span><span class="op" id="4557447">.</span><span class="ident" id="4557448">ocspStapling</span>&nbsp;<span class="op" id="4557461">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557465">msg</span><span class="op" id="4557468">,</span>&nbsp;<span class="ident" id="4557470">err</span>&nbsp;<span class="op" id="4557474">=</span>&nbsp;<span class="ident" id="4557476">c</span><span class="op" id="4557477">.</span><span class="ident" id="4557478">readHandshake</span><span class="op" id="4557491">(</span><span class="op" id="4557492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557496">if</span>&nbsp;<span class="ident" id="4557499">err</span>&nbsp;<span class="op" id="4557503">!=</span>&nbsp;<span class="ident" id="4557506">nil</span>&nbsp;<span class="op" id="4557510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557515">return</span>&nbsp;<span class="ident" id="4557522">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557532">cs</span><span class="op" id="4557534">,</span>&nbsp;<span class="ident" id="4557536">ok</span>&nbsp;<span class="op" id="4557539">:=</span>&nbsp;<span class="ident" id="4557542">msg</span><span class="op" id="4557545">.</span><span class="op" id="4557546">(</span><span class="op" id="4557547">*</span><span class="ident" id="4557548">certificateStatusMsg</span><span class="op" id="4557568">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557572">if</span>&nbsp;<span class="op" id="4557575">!</span><span class="ident" id="4557576">ok</span>&nbsp;<span class="op" id="4557579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557584">c</span><span class="op" id="4557585">.</span><span class="ident" id="4557586">sendAlert</span><span class="op" id="4557595">(</span><span class="ident" id="4557596">alertUnexpectedMessage</span><span class="op" id="4557618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557623">return</span>&nbsp;<span class="ident" id="4557630">unexpectedMessageError</span><span class="op" id="4557652">(</span><span class="ident" id="4557653">cs</span><span class="op" id="4557655">,</span>&nbsp;<span class="ident" id="4557657">msg</span><span class="op" id="4557660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557668">hs</span><span class="op" id="4557670">.</span><span class="ident" id="4557671">finishedHash</span><span class="op" id="4557683">.</span><span class="ident" id="4557684">Write</span><span class="op" id="4557689">(</span><span class="ident" id="4557690">cs</span><span class="op" id="4557692">.</span><span class="ident" id="4557693">marshal</span><span class="op" id="4557700">(</span><span class="op" id="4557701">)</span><span class="op" id="4557702">)</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557707">if</span>&nbsp;<span class="ident" id="4557710">cs</span><span class="op" id="4557712">.</span><span class="ident" id="4557713">statusType</span>&nbsp;<span class="op" id="4557724">==</span>&nbsp;<span class="ident" id="4557727">statusTypeOCSP</span>&nbsp;<span class="op" id="4557742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557747">c</span><span class="op" id="4557748">.</span><span class="ident" id="4557749">ocspResponse</span>&nbsp;<span class="op" id="4557762">=</span>&nbsp;<span class="ident" id="4557764">cs</span><span class="op" id="4557766">.</span><span class="ident" id="4557767">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557781">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557785">msg</span><span class="op" id="4557788">,</span>&nbsp;<span class="ident" id="4557790">err</span>&nbsp;<span class="op" id="4557794">=</span>&nbsp;<span class="ident" id="4557796">c</span><span class="op" id="4557797">.</span><span class="ident" id="4557798">readHandshake</span><span class="op" id="4557811">(</span><span class="op" id="4557812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557815">if</span>&nbsp;<span class="ident" id="4557818">err</span>&nbsp;<span class="op" id="4557822">!=</span>&nbsp;<span class="ident" id="4557825">nil</span>&nbsp;<span class="op" id="4557829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557833">return</span>&nbsp;<span class="ident" id="4557840">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557845">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557849">keyAgreement</span>&nbsp;<span class="op" id="4557862">:=</span>&nbsp;<span class="ident" id="4557865">hs</span><span class="op" id="4557867">.</span><span class="ident" id="4557868">suite</span><span class="op" id="4557873">.</span><span class="ident" id="4557874">ka</span><span class="op" id="4557876">(</span><span class="ident" id="4557877">c</span><span class="op" id="4557878">.</span><span class="ident" id="4557879">vers</span><span class="op" id="4557883">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557887">skx</span><span class="op" id="4557890">,</span>&nbsp;<span class="ident" id="4557892">ok</span>&nbsp;<span class="op" id="4557895">:=</span>&nbsp;<span class="ident" id="4557898">msg</span><span class="op" id="4557901">.</span><span class="op" id="4557902">(</span><span class="op" id="4557903">*</span><span class="ident" id="4557904">serverKeyExchangeMsg</span><span class="op" id="4557924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557927">if</span>&nbsp;<span class="ident" id="4557930">ok</span>&nbsp;<span class="op" id="4557933">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557937">hs</span><span class="op" id="4557939">.</span><span class="ident" id="4557940">finishedHash</span><span class="op" id="4557952">.</span><span class="ident" id="4557953">Write</span><span class="op" id="4557958">(</span><span class="ident" id="4557959">skx</span><span class="op" id="4557962">.</span><span class="ident" id="4557963">marshal</span><span class="op" id="4557970">(</span><span class="op" id="4557971">)</span><span class="op" id="4557972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557976">err</span>&nbsp;<span class="op" id="4557980">=</span>&nbsp;<span class="ident" id="4557982">keyAgreement</span><span class="op" id="4557994">.</span><span class="ident" id="4557995">processServerKeyExchange</span><span class="op" id="4558019">(</span><span class="ident" id="4558020">c</span><span class="op" id="4558021">.</span><span class="ident" id="4558022">config</span><span class="op" id="4558028">,</span>&nbsp;<span class="ident" id="4558030">hs</span><span class="op" id="4558032">.</span><span class="ident" id="4558033">hello</span><span class="op" id="4558038">,</span>&nbsp;<span class="ident" id="4558040">hs</span><span class="op" id="4558042">.</span><span class="ident" id="4558043">serverHello</span><span class="op" id="4558054">,</span>&nbsp;<span class="ident" id="4558056">certs</span><span class="op" id="4558061">[</span><span class="num" id="4558062">0</span><span class="op" id="4558063">]</span><span class="op" id="4558064">,</span>&nbsp;<span class="ident" id="4558066">skx</span><span class="op" id="4558069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558073">if</span>&nbsp;<span class="ident" id="4558076">err</span>&nbsp;<span class="op" id="4558080">!=</span>&nbsp;<span class="ident" id="4558083">nil</span>&nbsp;<span class="op" id="4558087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558092">c</span><span class="op" id="4558093">.</span><span class="ident" id="4558094">sendAlert</span><span class="op" id="4558103">(</span><span class="ident" id="4558104">alertUnexpectedMessage</span><span class="op" id="4558126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558131">return</span>&nbsp;<span class="ident" id="4558138">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4558144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558149">msg</span><span class="op" id="4558152">,</span>&nbsp;<span class="ident" id="4558154">err</span>&nbsp;<span class="op" id="4558158">=</span>&nbsp;<span class="ident" id="4558160">c</span><span class="op" id="4558161">.</span><span class="ident" id="4558162">readHandshake</span><span class="op" id="4558175">(</span><span class="op" id="4558176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558180">if</span>&nbsp;<span class="ident" id="4558183">err</span>&nbsp;<span class="op" id="4558187">!=</span>&nbsp;<span class="ident" id="4558190">nil</span>&nbsp;<span class="op" id="4558194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558199">return</span>&nbsp;<span class="ident" id="4558206">err</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4558212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4558215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558219">var</span>&nbsp;<span class="ident" id="4558223">chainToSend</span>&nbsp;<span class="op" id="4558235">*</span><span class="ident" id="4558236">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558249">var</span>&nbsp;<span class="ident" id="4558253">certRequested</span>&nbsp;<span class="builtintype" id="4558267">bool</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558273">certReq</span><span class="op" id="4558280">,</span>&nbsp;<span class="ident" id="4558282">ok</span>&nbsp;<span class="op" id="4558285">:=</span>&nbsp;<span class="ident" id="4558288">msg</span><span class="op" id="4558291">.</span><span class="op" id="4558292">(</span><span class="op" id="4558293">*</span><span class="ident" id="4558294">certificateRequestMsg</span><span class="op" id="4558315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558318">if</span>&nbsp;<span class="ident" id="4558321">ok</span>&nbsp;<span class="op" id="4558324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558328">certRequested</span>&nbsp;<span class="op" id="4558342">=</span>&nbsp;<span class="builtintype" id="4558344">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4558352">//&nbsp;RFC&nbsp;4346&nbsp;on&nbsp;the&nbsp;certificateAuthorities&nbsp;field:</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4558403">//&nbsp;A&nbsp;list&nbsp;of&nbsp;the&nbsp;distinguished&nbsp;names&nbsp;of&nbsp;acceptable&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4558468">//&nbsp;authorities.&nbsp;These&nbsp;distinguished&nbsp;names&nbsp;may&nbsp;specify&nbsp;a&nbsp;desired</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4558534">//&nbsp;distinguished&nbsp;name&nbsp;for&nbsp;a&nbsp;root&nbsp;CA&nbsp;or&nbsp;for&nbsp;a&nbsp;subordinate&nbsp;CA;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4558597">//&nbsp;thus,&nbsp;this&nbsp;message&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;describe&nbsp;both&nbsp;known&nbsp;roots</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4558662">//&nbsp;and&nbsp;a&nbsp;desired&nbsp;authorization&nbsp;space.&nbsp;If&nbsp;the</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4558709">//&nbsp;certificate_authorities&nbsp;list&nbsp;is&nbsp;empty&nbsp;then&nbsp;the&nbsp;client&nbsp;MAY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4558772">//&nbsp;send&nbsp;any&nbsp;certificate&nbsp;of&nbsp;the&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4558817">//&nbsp;ClientCertificateType,&nbsp;unless&nbsp;there&nbsp;is&nbsp;some&nbsp;external</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4558875">//&nbsp;arrangement&nbsp;to&nbsp;the&nbsp;contrary.</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558910">hs</span><span class="op" id="4558912">.</span><span class="ident" id="4558913">finishedHash</span><span class="op" id="4558925">.</span><span class="ident" id="4558926">Write</span><span class="op" id="4558931">(</span><span class="ident" id="4558932">certReq</span><span class="op" id="4558939">.</span><span class="ident" id="4558940">marshal</span><span class="op" id="4558947">(</span><span class="op" id="4558948">)</span><span class="op" id="4558949">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558954">var</span>&nbsp;<span class="ident" id="4558958">rsaAvail</span><span class="op" id="4558966">,</span>&nbsp;<span class="ident" id="4558968">ecdsaAvail</span>&nbsp;<span class="builtintype" id="4558979">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558986">for</span>&nbsp;<span class="ident" id="4558990">_</span><span class="op" id="4558991">,</span>&nbsp;<span class="ident" id="4558993">certType</span>&nbsp;<span class="op" id="4559002">:=</span>&nbsp;<span class="keyword" id="4559005">range</span>&nbsp;<span class="ident" id="4559011">certReq</span><span class="op" id="4559018">.</span><span class="ident" id="4559019">certificateTypes</span>&nbsp;<span class="op" id="4559036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559041">switch</span>&nbsp;<span class="ident" id="4559048">certType</span>&nbsp;<span class="op" id="4559057">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559062">case</span>&nbsp;<span class="ident" id="4559067">certTypeRSASign</span><span class="op" id="4559082">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559088">rsaAvail</span>&nbsp;<span class="op" id="4559097">=</span>&nbsp;<span class="builtintype" id="4559099">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559107">case</span>&nbsp;<span class="ident" id="4559112">certTypeECDSASign</span><span class="op" id="4559129">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559135">ecdsaAvail</span>&nbsp;<span class="op" id="4559146">=</span>&nbsp;<span class="builtintype" id="4559148">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4559156">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4559160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4559165">//&nbsp;We&nbsp;need&nbsp;to&nbsp;search&nbsp;our&nbsp;list&nbsp;of&nbsp;client&nbsp;certs&nbsp;for&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4559221">//&nbsp;where&nbsp;SignatureAlgorithm&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;the&nbsp;server&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4559287">//&nbsp;Issuer&nbsp;is&nbsp;in&nbsp;certReq.certificateAuthorities</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559335">findCert</span><span class="op" id="4559343">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559347">for</span>&nbsp;<span class="ident" id="4559351">i</span><span class="op" id="4559352">,</span>&nbsp;<span class="ident" id="4559354">chain</span>&nbsp;<span class="op" id="4559360">:=</span>&nbsp;<span class="keyword" id="4559363">range</span>&nbsp;<span class="ident" id="4559369">c</span><span class="op" id="4559370">.</span><span class="ident" id="4559371">config</span><span class="op" id="4559377">.</span><span class="ident" id="4559378">Certificates</span>&nbsp;<span class="op" id="4559391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559396">if</span>&nbsp;<span class="op" id="4559399">!</span><span class="ident" id="4559400">rsaAvail</span>&nbsp;<span class="op" id="4559409">&amp;&amp;</span>&nbsp;<span class="op" id="4559412">!</span><span class="ident" id="4559413">ecdsaAvail</span>&nbsp;<span class="op" id="4559424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559430">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4559442">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559448">for</span>&nbsp;<span class="ident" id="4559452">j</span><span class="op" id="4559453">,</span>&nbsp;<span class="ident" id="4559455">cert</span>&nbsp;<span class="op" id="4559460">:=</span>&nbsp;<span class="keyword" id="4559463">range</span>&nbsp;<span class="ident" id="4559469">chain</span><span class="op" id="4559474">.</span><span class="ident" id="4559475">Certificate</span>&nbsp;<span class="op" id="4559487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559493">x509Cert</span>&nbsp;<span class="op" id="4559502">:=</span>&nbsp;<span class="ident" id="4559505">chain</span><span class="op" id="4559510">.</span><span class="ident" id="4559511">Leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4559520">//&nbsp;parse&nbsp;the&nbsp;certificate&nbsp;if&nbsp;this&nbsp;isn&#39;t&nbsp;the&nbsp;leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4559572">//&nbsp;node,&nbsp;or&nbsp;if&nbsp;chain.Leaf&nbsp;was&nbsp;nil</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559610">if</span>&nbsp;<span class="ident" id="4559613">j</span>&nbsp;<span class="op" id="4559615">!=</span>&nbsp;<span class="num" id="4559618">0</span>&nbsp;<span class="op" id="4559620">||</span>&nbsp;<span class="ident" id="4559623">x509Cert</span>&nbsp;<span class="op" id="4559632">==</span>&nbsp;<span class="ident" id="4559635">nil</span>&nbsp;<span class="op" id="4559639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559646">if</span>&nbsp;<span class="ident" id="4559649">x509Cert</span><span class="op" id="4559657">,</span>&nbsp;<span class="ident" id="4559659">err</span>&nbsp;<span class="op" id="4559663">=</span>&nbsp;<span class="ident" id="4559665">x509</span><span class="op" id="4559669">.</span><span class="ident" id="4559670">ParseCertificate</span><span class="op" id="4559686">(</span><span class="ident" id="4559687">cert</span><span class="op" id="4559691">)</span><span class="op" id="4559692">;</span>&nbsp;<span class="ident" id="4559694">err</span>&nbsp;<span class="op" id="4559698">!=</span>&nbsp;<span class="ident" id="4559701">nil</span>&nbsp;<span class="op" id="4559705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559713">c</span><span class="op" id="4559714">.</span><span class="ident" id="4559715">sendAlert</span><span class="op" id="4559724">(</span><span class="ident" id="4559725">alertInternalError</span><span class="op" id="4559743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559751">return</span>&nbsp;<span class="ident" id="4559758">errors</span><span class="op" id="4559764">.</span><span class="ident" id="4559765">New</span><span class="op" id="4559768">(</span><span class="string" id="4559769">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate&nbsp;#&#34;</span>&nbsp;<span class="op" id="4559813">+</span>&nbsp;<span class="ident" id="4559815">strconv</span><span class="op" id="4559822">.</span><span class="ident" id="4559823">Itoa</span><span class="op" id="4559827">(</span><span class="ident" id="4559828">i</span><span class="op" id="4559829">)</span>&nbsp;<span class="op" id="4559831">+</span>&nbsp;<span class="string" id="4559833">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="4559838">+</span>&nbsp;<span class="ident" id="4559840">err</span><span class="op" id="4559843">.</span><span class="ident" id="4559844">Error</span><span class="op" id="4559849">(</span><span class="op" id="4559850">)</span><span class="op" id="4559851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4559858">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4559864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559871">switch</span>&nbsp;<span class="op" id="4559878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559884">case</span>&nbsp;<span class="ident" id="4559889">rsaAvail</span>&nbsp;<span class="op" id="4559898">&amp;&amp;</span>&nbsp;<span class="ident" id="4559901">x509Cert</span><span class="op" id="4559909">.</span><span class="ident" id="4559910">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="4559929">==</span>&nbsp;<span class="ident" id="4559932">x509</span><span class="op" id="4559936">.</span><span class="ident" id="4559937">RSA</span><span class="op" id="4559940">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559946">case</span>&nbsp;<span class="ident" id="4559951">ecdsaAvail</span>&nbsp;<span class="op" id="4559962">&amp;&amp;</span>&nbsp;<span class="ident" id="4559965">x509Cert</span><span class="op" id="4559973">.</span><span class="ident" id="4559974">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="4559993">==</span>&nbsp;<span class="ident" id="4559996">x509</span><span class="op" id="4560000">.</span><span class="ident" id="4560001">ECDSA</span><span class="op" id="4560006">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560012">default</span><span class="op" id="4560019">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560026">continue</span>&nbsp;<span class="ident" id="4560035">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560055">if</span>&nbsp;<span class="builtinfunc" id="4560058">len</span><span class="op" id="4560061">(</span><span class="ident" id="4560062">certReq</span><span class="op" id="4560069">.</span><span class="ident" id="4560070">certificateAuthorities</span><span class="op" id="4560092">)</span>&nbsp;<span class="op" id="4560094">==</span>&nbsp;<span class="num" id="4560097">0</span>&nbsp;<span class="op" id="4560099">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4560106">//&nbsp;they&nbsp;gave&nbsp;us&nbsp;an&nbsp;empty&nbsp;list,&nbsp;so&nbsp;just&nbsp;take&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4560159">//&nbsp;first&nbsp;cert&nbsp;from&nbsp;c.config.Certificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560205">chainToSend</span>&nbsp;<span class="op" id="4560217">=</span>&nbsp;<span class="op" id="4560219">&amp;</span><span class="ident" id="4560220">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560231">break</span>&nbsp;<span class="ident" id="4560237">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560250">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560257">for</span>&nbsp;<span class="ident" id="4560261">_</span><span class="op" id="4560262">,</span>&nbsp;<span class="ident" id="4560264">ca</span>&nbsp;<span class="op" id="4560267">:=</span>&nbsp;<span class="keyword" id="4560270">range</span>&nbsp;<span class="ident" id="4560276">certReq</span><span class="op" id="4560283">.</span><span class="ident" id="4560284">certificateAuthorities</span>&nbsp;<span class="op" id="4560307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560314">if</span>&nbsp;<span class="ident" id="4560317">bytes</span><span class="op" id="4560322">.</span><span class="ident" id="4560323">Equal</span><span class="op" id="4560328">(</span><span class="ident" id="4560329">x509Cert</span><span class="op" id="4560337">.</span><span class="ident" id="4560338">RawIssuer</span><span class="op" id="4560347">,</span>&nbsp;<span class="ident" id="4560349">ca</span><span class="op" id="4560351">)</span>&nbsp;<span class="op" id="4560353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560361">chainToSend</span>&nbsp;<span class="op" id="4560373">=</span>&nbsp;<span class="op" id="4560375">&amp;</span><span class="ident" id="4560376">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560388">break</span>&nbsp;<span class="ident" id="4560394">findCert</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560428">msg</span><span class="op" id="4560431">,</span>&nbsp;<span class="ident" id="4560433">err</span>&nbsp;<span class="op" id="4560437">=</span>&nbsp;<span class="ident" id="4560439">c</span><span class="op" id="4560440">.</span><span class="ident" id="4560441">readHandshake</span><span class="op" id="4560454">(</span><span class="op" id="4560455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560459">if</span>&nbsp;<span class="ident" id="4560462">err</span>&nbsp;<span class="op" id="4560466">!=</span>&nbsp;<span class="ident" id="4560469">nil</span>&nbsp;<span class="op" id="4560473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560478">return</span>&nbsp;<span class="ident" id="4560485">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560494">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560498">shd</span><span class="op" id="4560501">,</span>&nbsp;<span class="ident" id="4560503">ok</span>&nbsp;<span class="op" id="4560506">:=</span>&nbsp;<span class="ident" id="4560509">msg</span><span class="op" id="4560512">.</span><span class="op" id="4560513">(</span><span class="op" id="4560514">*</span><span class="ident" id="4560515">serverHelloDoneMsg</span><span class="op" id="4560533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560536">if</span>&nbsp;<span class="op" id="4560539">!</span><span class="ident" id="4560540">ok</span>&nbsp;<span class="op" id="4560543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560547">c</span><span class="op" id="4560548">.</span><span class="ident" id="4560549">sendAlert</span><span class="op" id="4560558">(</span><span class="ident" id="4560559">alertUnexpectedMessage</span><span class="op" id="4560581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560585">return</span>&nbsp;<span class="ident" id="4560592">unexpectedMessageError</span><span class="op" id="4560614">(</span><span class="ident" id="4560615">shd</span><span class="op" id="4560618">,</span>&nbsp;<span class="ident" id="4560620">msg</span><span class="op" id="4560623">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560629">hs</span><span class="op" id="4560631">.</span><span class="ident" id="4560632">finishedHash</span><span class="op" id="4560644">.</span><span class="ident" id="4560645">Write</span><span class="op" id="4560650">(</span><span class="ident" id="4560651">shd</span><span class="op" id="4560654">.</span><span class="ident" id="4560655">marshal</span><span class="op" id="4560662">(</span><span class="op" id="4560663">)</span><span class="op" id="4560664">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4560668">//&nbsp;If&nbsp;the&nbsp;server&nbsp;requested&nbsp;a&nbsp;certificate&nbsp;then&nbsp;we&nbsp;have&nbsp;to&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4560733">//&nbsp;Certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4560801">//&nbsp;certificate&nbsp;to&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560826">if</span>&nbsp;<span class="ident" id="4560829">certRequested</span>&nbsp;<span class="op" id="4560843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560847">certMsg</span>&nbsp;<span class="op" id="4560855">=</span>&nbsp;<span class="builtinfunc" id="4560857">new</span><span class="op" id="4560860">(</span><span class="ident" id="4560861">certificateMsg</span><span class="op" id="4560875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560879">if</span>&nbsp;<span class="ident" id="4560882">chainToSend</span>&nbsp;<span class="op" id="4560894">!=</span>&nbsp;<span class="ident" id="4560897">nil</span>&nbsp;<span class="op" id="4560901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560906">certMsg</span><span class="op" id="4560913">.</span><span class="ident" id="4560914">certificates</span>&nbsp;<span class="op" id="4560927">=</span>&nbsp;<span class="ident" id="4560929">chainToSend</span><span class="op" id="4560940">.</span><span class="ident" id="4560941">Certificate</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560959">hs</span><span class="op" id="4560961">.</span><span class="ident" id="4560962">finishedHash</span><span class="op" id="4560974">.</span><span class="ident" id="4560975">Write</span><span class="op" id="4560980">(</span><span class="ident" id="4560981">certMsg</span><span class="op" id="4560988">.</span><span class="ident" id="4560989">marshal</span><span class="op" id="4560996">(</span><span class="op" id="4560997">)</span><span class="op" id="4560998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561002">c</span><span class="op" id="4561003">.</span><span class="ident" id="4561004">writeRecord</span><span class="op" id="4561015">(</span><span class="ident" id="4561016">recordTypeHandshake</span><span class="op" id="4561035">,</span>&nbsp;<span class="ident" id="4561037">certMsg</span><span class="op" id="4561044">.</span><span class="ident" id="4561045">marshal</span><span class="op" id="4561052">(</span><span class="op" id="4561053">)</span><span class="op" id="4561054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4561057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561061">preMasterSecret</span><span class="op" id="4561076">,</span>&nbsp;<span class="ident" id="4561078">ckx</span><span class="op" id="4561081">,</span>&nbsp;<span class="ident" id="4561083">err</span>&nbsp;<span class="op" id="4561087">:=</span>&nbsp;<span class="ident" id="4561090">keyAgreement</span><span class="op" id="4561102">.</span><span class="ident" id="4561103">generateClientKeyExchange</span><span class="op" id="4561128">(</span><span class="ident" id="4561129">c</span><span class="op" id="4561130">.</span><span class="ident" id="4561131">config</span><span class="op" id="4561137">,</span>&nbsp;<span class="ident" id="4561139">hs</span><span class="op" id="4561141">.</span><span class="ident" id="4561142">hello</span><span class="op" id="4561147">,</span>&nbsp;<span class="ident" id="4561149">certs</span><span class="op" id="4561154">[</span><span class="num" id="4561155">0</span><span class="op" id="4561156">]</span><span class="op" id="4561157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561160">if</span>&nbsp;<span class="ident" id="4561163">err</span>&nbsp;<span class="op" id="4561167">!=</span>&nbsp;<span class="ident" id="4561170">nil</span>&nbsp;<span class="op" id="4561174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561178">c</span><span class="op" id="4561179">.</span><span class="ident" id="4561180">sendAlert</span><span class="op" id="4561189">(</span><span class="ident" id="4561190">alertInternalError</span><span class="op" id="4561208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561212">return</span>&nbsp;<span class="ident" id="4561219">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4561224">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561227">if</span>&nbsp;<span class="ident" id="4561230">ckx</span>&nbsp;<span class="op" id="4561234">!=</span>&nbsp;<span class="ident" id="4561237">nil</span>&nbsp;<span class="op" id="4561241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561245">hs</span><span class="op" id="4561247">.</span><span class="ident" id="4561248">finishedHash</span><span class="op" id="4561260">.</span><span class="ident" id="4561261">Write</span><span class="op" id="4561266">(</span><span class="ident" id="4561267">ckx</span><span class="op" id="4561270">.</span><span class="ident" id="4561271">marshal</span><span class="op" id="4561278">(</span><span class="op" id="4561279">)</span><span class="op" id="4561280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561284">c</span><span class="op" id="4561285">.</span><span class="ident" id="4561286">writeRecord</span><span class="op" id="4561297">(</span><span class="ident" id="4561298">recordTypeHandshake</span><span class="op" id="4561317">,</span>&nbsp;<span class="ident" id="4561319">ckx</span><span class="op" id="4561322">.</span><span class="ident" id="4561323">marshal</span><span class="op" id="4561330">(</span><span class="op" id="4561331">)</span><span class="op" id="4561332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4561335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561339">if</span>&nbsp;<span class="ident" id="4561342">chainToSend</span>&nbsp;<span class="op" id="4561354">!=</span>&nbsp;<span class="ident" id="4561357">nil</span>&nbsp;<span class="op" id="4561361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561365">var</span>&nbsp;<span class="ident" id="4561369">signed</span>&nbsp;<span class="op" id="4561376">[</span><span class="op" id="4561377">]</span><span class="builtintype" id="4561378">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561385">certVerify</span>&nbsp;<span class="op" id="4561396">:=</span>&nbsp;<span class="op" id="4561399">&amp;</span><span class="ident" id="4561400">certificateVerifyMsg</span><span class="op" id="4561420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561425">hasSignatureAndHash</span><span class="op" id="4561444">:</span>&nbsp;<span class="ident" id="4561446">c</span><span class="op" id="4561447">.</span><span class="ident" id="4561448">vers</span>&nbsp;<span class="op" id="4561453">&gt;=</span>&nbsp;<span class="ident" id="4561456">VersionTLS12</span><span class="op" id="4561468">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4561472">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561477">key</span><span class="op" id="4561480">,</span>&nbsp;<span class="ident" id="4561482">ok</span>&nbsp;<span class="op" id="4561485">:=</span>&nbsp;<span class="ident" id="4561488">chainToSend</span><span class="op" id="4561499">.</span><span class="ident" id="4561500">PrivateKey</span><span class="op" id="4561510">.</span><span class="op" id="4561511">(</span><span class="ident" id="4561512">crypto</span><span class="op" id="4561518">.</span><span class="ident" id="4561519">Signer</span><span class="op" id="4561525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561529">if</span>&nbsp;<span class="op" id="4561532">!</span><span class="ident" id="4561533">ok</span>&nbsp;<span class="op" id="4561536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561541">c</span><span class="op" id="4561542">.</span><span class="ident" id="4561543">sendAlert</span><span class="op" id="4561552">(</span><span class="ident" id="4561553">alertInternalError</span><span class="op" id="4561571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561576">return</span>&nbsp;<span class="ident" id="4561583">fmt</span><span class="op" id="4561586">.</span><span class="ident" id="4561587">Errorf</span><span class="op" id="4561593">(</span><span class="string" id="4561594">&#34;tls:&nbsp;client&nbsp;certificate&nbsp;private&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&nbsp;does&nbsp;not&nbsp;implement&nbsp;crypto.Signer&#34;</span><span class="op" id="4561675">,</span>&nbsp;<span class="ident" id="4561677">chainToSend</span><span class="op" id="4561688">.</span><span class="ident" id="4561689">PrivateKey</span><span class="op" id="4561699">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4561703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561707">switch</span>&nbsp;<span class="ident" id="4561714">key</span><span class="op" id="4561717">.</span><span class="ident" id="4561718">Public</span><span class="op" id="4561724">(</span><span class="op" id="4561725">)</span><span class="op" id="4561726">.</span><span class="op" id="4561727">(</span><span class="keyword" id="4561728">type</span><span class="op" id="4561732">)</span>&nbsp;<span class="op" id="4561734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561738">case</span>&nbsp;<span class="op" id="4561743">*</span><span class="ident" id="4561744">ecdsa</span><span class="op" id="4561749">.</span><span class="ident" id="4561750">PublicKey</span><span class="op" id="4561759">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561764">digest</span><span class="op" id="4561770">,</span>&nbsp;<span class="ident" id="4561772">hashFunc</span><span class="op" id="4561780">,</span>&nbsp;<span class="ident" id="4561782">hashId</span>&nbsp;<span class="op" id="4561789">:=</span>&nbsp;<span class="ident" id="4561792">hs</span><span class="op" id="4561794">.</span><span class="ident" id="4561795">finishedHash</span><span class="op" id="4561807">.</span><span class="ident" id="4561808">hashForClientCertificate</span><span class="op" id="4561832">(</span><span class="ident" id="4561833">signatureECDSA</span><span class="op" id="4561847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561852">signed</span><span class="op" id="4561858">,</span>&nbsp;<span class="ident" id="4561860">err</span>&nbsp;<span class="op" id="4561864">=</span>&nbsp;<span class="ident" id="4561866">key</span><span class="op" id="4561869">.</span><span class="ident" id="4561870">Sign</span><span class="op" id="4561874">(</span><span class="ident" id="4561875">c</span><span class="op" id="4561876">.</span><span class="ident" id="4561877">config</span><span class="op" id="4561883">.</span><span class="ident" id="4561884">rand</span><span class="op" id="4561888">(</span><span class="op" id="4561889">)</span><span class="op" id="4561890">,</span>&nbsp;<span class="ident" id="4561892">digest</span><span class="op" id="4561898">,</span>&nbsp;<span class="ident" id="4561900">hashFunc</span><span class="op" id="4561908">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561913">certVerify</span><span class="op" id="4561923">.</span><span class="ident" id="4561924">signatureAndHash</span><span class="op" id="4561940">.</span><span class="ident" id="4561941">signature</span>&nbsp;<span class="op" id="4561951">=</span>&nbsp;<span class="ident" id="4561953">signatureECDSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561971">certVerify</span><span class="op" id="4561981">.</span><span class="ident" id="4561982">signatureAndHash</span><span class="op" id="4561998">.</span><span class="ident" id="4561999">hash</span>&nbsp;<span class="op" id="4562004">=</span>&nbsp;<span class="ident" id="4562006">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562015">case</span>&nbsp;<span class="op" id="4562020">*</span><span class="ident" id="4562021">rsa</span><span class="op" id="4562024">.</span><span class="ident" id="4562025">PublicKey</span><span class="op" id="4562034">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562039">digest</span><span class="op" id="4562045">,</span>&nbsp;<span class="ident" id="4562047">hashFunc</span><span class="op" id="4562055">,</span>&nbsp;<span class="ident" id="4562057">hashId</span>&nbsp;<span class="op" id="4562064">:=</span>&nbsp;<span class="ident" id="4562067">hs</span><span class="op" id="4562069">.</span><span class="ident" id="4562070">finishedHash</span><span class="op" id="4562082">.</span><span class="ident" id="4562083">hashForClientCertificate</span><span class="op" id="4562107">(</span><span class="ident" id="4562108">signatureRSA</span><span class="op" id="4562120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562125">signed</span><span class="op" id="4562131">,</span>&nbsp;<span class="ident" id="4562133">err</span>&nbsp;<span class="op" id="4562137">=</span>&nbsp;<span class="ident" id="4562139">key</span><span class="op" id="4562142">.</span><span class="ident" id="4562143">Sign</span><span class="op" id="4562147">(</span><span class="ident" id="4562148">c</span><span class="op" id="4562149">.</span><span class="ident" id="4562150">config</span><span class="op" id="4562156">.</span><span class="ident" id="4562157">rand</span><span class="op" id="4562161">(</span><span class="op" id="4562162">)</span><span class="op" id="4562163">,</span>&nbsp;<span class="ident" id="4562165">digest</span><span class="op" id="4562171">,</span>&nbsp;<span class="ident" id="4562173">hashFunc</span><span class="op" id="4562181">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562186">certVerify</span><span class="op" id="4562196">.</span><span class="ident" id="4562197">signatureAndHash</span><span class="op" id="4562213">.</span><span class="ident" id="4562214">signature</span>&nbsp;<span class="op" id="4562224">=</span>&nbsp;<span class="ident" id="4562226">signatureRSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562242">certVerify</span><span class="op" id="4562252">.</span><span class="ident" id="4562253">signatureAndHash</span><span class="op" id="4562269">.</span><span class="ident" id="4562270">hash</span>&nbsp;<span class="op" id="4562275">=</span>&nbsp;<span class="ident" id="4562277">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562286">default</span><span class="op" id="4562293">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562298">err</span>&nbsp;<span class="op" id="4562302">=</span>&nbsp;<span class="ident" id="4562304">fmt</span><span class="op" id="4562307">.</span><span class="ident" id="4562308">Errorf</span><span class="op" id="4562314">(</span><span class="string" id="4562315">&#34;tls:&nbsp;unknown&nbsp;client&nbsp;certificate&nbsp;key&nbsp;type:&nbsp;%T&#34;</span><span class="op" id="4562361">,</span>&nbsp;<span class="ident" id="4562363">key</span><span class="op" id="4562366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4562370">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562374">if</span>&nbsp;<span class="ident" id="4562377">err</span>&nbsp;<span class="op" id="4562381">!=</span>&nbsp;<span class="ident" id="4562384">nil</span>&nbsp;<span class="op" id="4562388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562393">c</span><span class="op" id="4562394">.</span><span class="ident" id="4562395">sendAlert</span><span class="op" id="4562404">(</span><span class="ident" id="4562405">alertInternalError</span><span class="op" id="4562423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562428">return</span>&nbsp;<span class="ident" id="4562435">errors</span><span class="op" id="4562441">.</span><span class="ident" id="4562442">New</span><span class="op" id="4562445">(</span><span class="string" id="4562446">&#34;tls:&nbsp;failed&nbsp;to&nbsp;sign&nbsp;handshake&nbsp;with&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4562504">+</span>&nbsp;<span class="ident" id="4562506">err</span><span class="op" id="4562509">.</span><span class="ident" id="4562510">Error</span><span class="op" id="4562515">(</span><span class="op" id="4562516">)</span><span class="op" id="4562517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4562521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562525">certVerify</span><span class="op" id="4562535">.</span><span class="ident" id="4562536">signature</span>&nbsp;<span class="op" id="4562546">=</span>&nbsp;<span class="ident" id="4562548">signed</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562558">hs</span><span class="op" id="4562560">.</span><span class="ident" id="4562561">finishedHash</span><span class="op" id="4562573">.</span><span class="ident" id="4562574">Write</span><span class="op" id="4562579">(</span><span class="ident" id="4562580">certVerify</span><span class="op" id="4562590">.</span><span class="ident" id="4562591">marshal</span><span class="op" id="4562598">(</span><span class="op" id="4562599">)</span><span class="op" id="4562600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562604">c</span><span class="op" id="4562605">.</span><span class="ident" id="4562606">writeRecord</span><span class="op" id="4562617">(</span><span class="ident" id="4562618">recordTypeHandshake</span><span class="op" id="4562637">,</span>&nbsp;<span class="ident" id="4562639">certVerify</span><span class="op" id="4562649">.</span><span class="ident" id="4562650">marshal</span><span class="op" id="4562657">(</span><span class="op" id="4562658">)</span><span class="op" id="4562659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4562662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562666">hs</span><span class="op" id="4562668">.</span><span class="ident" id="4562669">masterSecret</span>&nbsp;<span class="op" id="4562682">=</span>&nbsp;<span class="ident" id="4562684">masterFromPreMasterSecret</span><span class="op" id="4562709">(</span><span class="ident" id="4562710">c</span><span class="op" id="4562711">.</span><span class="ident" id="4562712">vers</span><span class="op" id="4562716">,</span>&nbsp;<span class="ident" id="4562718">preMasterSecret</span><span class="op" id="4562733">,</span>&nbsp;<span class="ident" id="4562735">hs</span><span class="op" id="4562737">.</span><span class="ident" id="4562738">hello</span><span class="op" id="4562743">.</span><span class="ident" id="4562744">random</span><span class="op" id="4562750">,</span>&nbsp;<span class="ident" id="4562752">hs</span><span class="op" id="4562754">.</span><span class="ident" id="4562755">serverHello</span><span class="op" id="4562766">.</span><span class="ident" id="4562767">random</span><span class="op" id="4562773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562776">return</span>&nbsp;<span class="ident" id="4562783">nil</span><br>
<span class="lineno"></span><span class="op" id="4562787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4562790">func</span>&nbsp;<span class="op" id="4562795">(</span><span class="ident" id="4562796">hs</span>&nbsp;<span class="op" id="4562799">*</span><span class="ident" id="4562800">clientHandshakeState</span><span class="op" id="4562820">)</span>&nbsp;<span class="ident" id="4562822">establishKeys</span><span class="op" id="4562835">(</span><span class="op" id="4562836">)</span>&nbsp;<span class="builtintype" id="4562838">error</span>&nbsp;<span class="op" id="4562844">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562847">c</span>&nbsp;<span class="op" id="4562849">:=</span>&nbsp;<span class="ident" id="4562852">hs</span><span class="op" id="4562854">.</span><span class="ident" id="4562855">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562859">clientMAC</span><span class="op" id="4562868">,</span>&nbsp;<span class="ident" id="4562870">serverMAC</span><span class="op" id="4562879">,</span>&nbsp;<span class="ident" id="4562881">clientKey</span><span class="op" id="4562890">,</span>&nbsp;<span class="ident" id="4562892">serverKey</span><span class="op" id="4562901">,</span>&nbsp;<span class="ident" id="4562903">clientIV</span><span class="op" id="4562911">,</span>&nbsp;<span class="ident" id="4562913">serverIV</span>&nbsp;<span class="op" id="4562922">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562927">keysFromMasterSecret</span><span class="op" id="4562947">(</span><span class="ident" id="4562948">c</span><span class="op" id="4562949">.</span><span class="ident" id="4562950">vers</span><span class="op" id="4562954">,</span>&nbsp;<span class="ident" id="4562956">hs</span><span class="op" id="4562958">.</span><span class="ident" id="4562959">masterSecret</span><span class="op" id="4562971">,</span>&nbsp;<span class="ident" id="4562973">hs</span><span class="op" id="4562975">.</span><span class="ident" id="4562976">hello</span><span class="op" id="4562981">.</span><span class="ident" id="4562982">random</span><span class="op" id="4562988">,</span>&nbsp;<span class="ident" id="4562990">hs</span><span class="op" id="4562992">.</span><span class="ident" id="4562993">serverHello</span><span class="op" id="4563004">.</span><span class="ident" id="4563005">random</span><span class="op" id="4563011">,</span>&nbsp;<span class="ident" id="4563013">hs</span><span class="op" id="4563015">.</span><span class="ident" id="4563016">suite</span><span class="op" id="4563021">.</span><span class="ident" id="4563022">macLen</span><span class="op" id="4563028">,</span>&nbsp;<span class="ident" id="4563030">hs</span><span class="op" id="4563032">.</span><span class="ident" id="4563033">suite</span><span class="op" id="4563038">.</span><span class="ident" id="4563039">keyLen</span><span class="op" id="4563045">,</span>&nbsp;<span class="ident" id="4563047">hs</span><span class="op" id="4563049">.</span><span class="ident" id="4563050">suite</span><span class="op" id="4563055">.</span><span class="ident" id="4563056">ivLen</span><span class="op" id="4563061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4563064">var</span>&nbsp;<span class="ident" id="4563068">clientCipher</span><span class="op" id="4563080">,</span>&nbsp;<span class="ident" id="4563082">serverCipher</span>&nbsp;<span class="keyword" id="4563095">interface</span><span class="op" id="4563104">{</span><span class="op" id="4563105">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4563108">var</span>&nbsp;<span class="ident" id="4563112">clientHash</span><span class="op" id="4563122">,</span>&nbsp;<span class="ident" id="4563124">serverHash</span>&nbsp;<span class="ident" id="4563135">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4563148">if</span>&nbsp;<span class="ident" id="4563151">hs</span><span class="op" id="4563153">.</span><span class="ident" id="4563154">suite</span><span class="op" id="4563159">.</span><span class="ident" id="4563160">cipher</span>&nbsp;<span class="op" id="4563167">!=</span>&nbsp;<span class="ident" id="4563170">nil</span>&nbsp;<span class="op" id="4563174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563178">clientCipher</span>&nbsp;<span class="op" id="4563191">=</span>&nbsp;<span class="ident" id="4563193">hs</span><span class="op" id="4563195">.</span><span class="ident" id="4563196">suite</span><span class="op" id="4563201">.</span><span class="ident" id="4563202">cipher</span><span class="op" id="4563208">(</span><span class="ident" id="4563209">clientKey</span><span class="op" id="4563218">,</span>&nbsp;<span class="ident" id="4563220">clientIV</span><span class="op" id="4563228">,</span>&nbsp;<span class="builtintype" id="4563230">false</span>&nbsp;<span class="comment" id="4563236">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4563257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563261">clientHash</span>&nbsp;<span class="op" id="4563272">=</span>&nbsp;<span class="ident" id="4563274">hs</span><span class="op" id="4563276">.</span><span class="ident" id="4563277">suite</span><span class="op" id="4563282">.</span><span class="ident" id="4563283">mac</span><span class="op" id="4563286">(</span><span class="ident" id="4563287">c</span><span class="op" id="4563288">.</span><span class="ident" id="4563289">vers</span><span class="op" id="4563293">,</span>&nbsp;<span class="ident" id="4563295">clientMAC</span><span class="op" id="4563304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563308">serverCipher</span>&nbsp;<span class="op" id="4563321">=</span>&nbsp;<span class="ident" id="4563323">hs</span><span class="op" id="4563325">.</span><span class="ident" id="4563326">suite</span><span class="op" id="4563331">.</span><span class="ident" id="4563332">cipher</span><span class="op" id="4563338">(</span><span class="ident" id="4563339">serverKey</span><span class="op" id="4563348">,</span>&nbsp;<span class="ident" id="4563350">serverIV</span><span class="op" id="4563358">,</span>&nbsp;<span class="builtintype" id="4563360">true</span>&nbsp;<span class="comment" id="4563365">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4563382">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563386">serverHash</span>&nbsp;<span class="op" id="4563397">=</span>&nbsp;<span class="ident" id="4563399">hs</span><span class="op" id="4563401">.</span><span class="ident" id="4563402">suite</span><span class="op" id="4563407">.</span><span class="ident" id="4563408">mac</span><span class="op" id="4563411">(</span><span class="ident" id="4563412">c</span><span class="op" id="4563413">.</span><span class="ident" id="4563414">vers</span><span class="op" id="4563418">,</span>&nbsp;<span class="ident" id="4563420">serverMAC</span><span class="op" id="4563429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4563432">}</span>&nbsp;<span class="keyword" id="4563434">else</span>&nbsp;<span class="op" id="4563439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563443">clientCipher</span>&nbsp;<span class="op" id="4563456">=</span>&nbsp;<span class="ident" id="4563458">hs</span><span class="op" id="4563460">.</span><span class="ident" id="4563461">suite</span><span class="op" id="4563466">.</span><span class="ident" id="4563467">aead</span><span class="op" id="4563471">(</span><span class="ident" id="4563472">clientKey</span><span class="op" id="4563481">,</span>&nbsp;<span class="ident" id="4563483">clientIV</span><span class="op" id="4563491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563495">serverCipher</span>&nbsp;<span class="op" id="4563508">=</span>&nbsp;<span class="ident" id="4563510">hs</span><span class="op" id="4563512">.</span><span class="ident" id="4563513">suite</span><span class="op" id="4563518">.</span><span class="ident" id="4563519">aead</span><span class="op" id="4563523">(</span><span class="ident" id="4563524">serverKey</span><span class="op" id="4563533">,</span>&nbsp;<span class="ident" id="4563535">serverIV</span><span class="op" id="4563543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4563546">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563550">c</span><span class="op" id="4563551">.</span><span class="ident" id="4563552">in</span><span class="op" id="4563554">.</span><span class="ident" id="4563555">prepareCipherSpec</span><span class="op" id="4563572">(</span><span class="ident" id="4563573">c</span><span class="op" id="4563574">.</span><span class="ident" id="4563575">vers</span><span class="op" id="4563579">,</span>&nbsp;<span class="ident" id="4563581">serverCipher</span><span class="op" id="4563593">,</span>&nbsp;<span class="ident" id="4563595">serverHash</span><span class="op" id="4563605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563608">c</span><span class="op" id="4563609">.</span><span class="ident" id="4563610">out</span><span class="op" id="4563613">.</span><span class="ident" id="4563614">prepareCipherSpec</span><span class="op" id="4563631">(</span><span class="ident" id="4563632">c</span><span class="op" id="4563633">.</span><span class="ident" id="4563634">vers</span><span class="op" id="4563638">,</span>&nbsp;<span class="ident" id="4563640">clientCipher</span><span class="op" id="4563652">,</span>&nbsp;<span class="ident" id="4563654">clientHash</span><span class="op" id="4563664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4563667">return</span>&nbsp;<span class="ident" id="4563674">nil</span><br>
<span class="lineno"></span><span class="op" id="4563678">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="4563681">func</span>&nbsp;<span class="op" id="4563686">(</span><span class="ident" id="4563687">hs</span>&nbsp;<span class="op" id="4563690">*</span><span class="ident" id="4563691">clientHandshakeState</span><span class="op" id="4563711">)</span>&nbsp;<span class="ident" id="4563713">serverResumedSession</span><span class="op" id="4563733">(</span><span class="op" id="4563734">)</span>&nbsp;<span class="builtintype" id="4563736">bool</span>&nbsp;<span class="op" id="4563741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4563744">//&nbsp;If&nbsp;the&nbsp;server&nbsp;responded&nbsp;with&nbsp;the&nbsp;same&nbsp;sessionId&nbsp;then&nbsp;it&nbsp;means&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4563814">//&nbsp;sessionTicket&nbsp;is&nbsp;being&nbsp;used&nbsp;to&nbsp;resume&nbsp;a&nbsp;TLS&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4563871">return</span>&nbsp;<span class="ident" id="4563878">hs</span><span class="op" id="4563880">.</span><span class="ident" id="4563881">session</span>&nbsp;<span class="op" id="4563889">!=</span>&nbsp;<span class="ident" id="4563892">nil</span>&nbsp;<span class="op" id="4563896">&amp;&amp;</span>&nbsp;<span class="ident" id="4563899">hs</span><span class="op" id="4563901">.</span><span class="ident" id="4563902">hello</span><span class="op" id="4563907">.</span><span class="ident" id="4563908">sessionId</span>&nbsp;<span class="op" id="4563918">!=</span>&nbsp;<span class="ident" id="4563921">nil</span>&nbsp;<span class="op" id="4563925">&amp;&amp;</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563930">bytes</span><span class="op" id="4563935">.</span><span class="ident" id="4563936">Equal</span><span class="op" id="4563941">(</span><span class="ident" id="4563942">hs</span><span class="op" id="4563944">.</span><span class="ident" id="4563945">serverHello</span><span class="op" id="4563956">.</span><span class="ident" id="4563957">sessionId</span><span class="op" id="4563966">,</span>&nbsp;<span class="ident" id="4563968">hs</span><span class="op" id="4563970">.</span><span class="ident" id="4563971">hello</span><span class="op" id="4563976">.</span><span class="ident" id="4563977">sessionId</span><span class="op" id="4563986">)</span><br>
<span class="lineno"></span><span class="op" id="4563988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4563991">func</span>&nbsp;<span class="op" id="4563996">(</span><span class="ident" id="4563997">hs</span>&nbsp;<span class="op" id="4564000">*</span><span class="ident" id="4564001">clientHandshakeState</span><span class="op" id="4564021">)</span>&nbsp;<span class="ident" id="4564023">processServerHello</span><span class="op" id="4564041">(</span><span class="op" id="4564042">)</span>&nbsp;<span class="op" id="4564044">(</span><span class="builtintype" id="4564045">bool</span><span class="op" id="4564049">,</span>&nbsp;<span class="builtintype" id="4564051">error</span><span class="op" id="4564056">)</span>&nbsp;<span class="op" id="4564058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4564061">c</span>&nbsp;<span class="op" id="4564063">:=</span>&nbsp;<span class="ident" id="4564066">hs</span><span class="op" id="4564068">.</span><span class="ident" id="4564069">c</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564073">if</span>&nbsp;<span class="ident" id="4564076">hs</span><span class="op" id="4564078">.</span><span class="ident" id="4564079">serverHello</span><span class="op" id="4564090">.</span><span class="ident" id="4564091">compressionMethod</span>&nbsp;<span class="op" id="4564109">!=</span>&nbsp;<span class="ident" id="4564112">compressionNone</span>&nbsp;<span class="op" id="4564128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4564132">c</span><span class="op" id="4564133">.</span><span class="ident" id="4564134">sendAlert</span><span class="op" id="4564143">(</span><span class="ident" id="4564144">alertUnexpectedMessage</span><span class="op" id="4564166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564170">return</span>&nbsp;<span class="builtintype" id="4564177">false</span><span class="op" id="4564182">,</span>&nbsp;<span class="ident" id="4564184">errors</span><span class="op" id="4564190">.</span><span class="ident" id="4564191">New</span><span class="op" id="4564194">(</span><span class="string" id="4564195">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;compression&nbsp;format&#34;</span><span class="op" id="4564248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4564251">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4564255">clientDidNPN</span>&nbsp;<span class="op" id="4564268">:=</span>&nbsp;<span class="ident" id="4564271">hs</span><span class="op" id="4564273">.</span><span class="ident" id="4564274">hello</span><span class="op" id="4564279">.</span><span class="ident" id="4564280">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4564294">clientDidALPN</span>&nbsp;<span class="op" id="4564308">:=</span>&nbsp;<span class="builtinfunc" id="4564311">len</span><span class="op" id="4564314">(</span><span class="ident" id="4564315">hs</span><span class="op" id="4564317">.</span><span class="ident" id="4564318">hello</span><span class="op" id="4564323">.</span><span class="ident" id="4564324">alpnProtocols</span><span class="op" id="4564337">)</span>&nbsp;<span class="op" id="4564339">&gt;</span>&nbsp;<span class="num" id="4564341">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4564344">serverHasNPN</span>&nbsp;<span class="op" id="4564357">:=</span>&nbsp;<span class="ident" id="4564360">hs</span><span class="op" id="4564362">.</span><span class="ident" id="4564363">serverHello</span><span class="op" id="4564374">.</span><span class="ident" id="4564375">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4564389">serverHasALPN</span>&nbsp;<span class="op" id="4564403">:=</span>&nbsp;<span class="builtinfunc" id="4564406">len</span><span class="op" id="4564409">(</span><span class="ident" id="4564410">hs</span><span class="op" id="4564412">.</span><span class="ident" id="4564413">serverHello</span><span class="op" id="4564424">.</span><span class="ident" id="4564425">alpnProtocol</span><span class="op" id="4564437">)</span>&nbsp;<span class="op" id="4564439">&gt;</span>&nbsp;<span class="num" id="4564441">0</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564445">if</span>&nbsp;<span class="op" id="4564448">!</span><span class="ident" id="4564449">clientDidNPN</span>&nbsp;<span class="op" id="4564462">&amp;&amp;</span>&nbsp;<span class="ident" id="4564465">serverHasNPN</span>&nbsp;<span class="op" id="4564478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4564482">c</span><span class="op" id="4564483">.</span><span class="ident" id="4564484">sendAlert</span><span class="op" id="4564493">(</span><span class="ident" id="4564494">alertHandshakeFailure</span><span class="op" id="4564515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564519">return</span>&nbsp;<span class="builtintype" id="4564526">false</span><span class="op" id="4564531">,</span>&nbsp;<span class="ident" id="4564533">errors</span><span class="op" id="4564539">.</span><span class="ident" id="4564540">New</span><span class="op" id="4564543">(</span><span class="string" id="4564544">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;NPN&nbsp;extension&#34;</span><span class="op" id="4564589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4564592">}</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564596">if</span>&nbsp;<span class="op" id="4564599">!</span><span class="ident" id="4564600">clientDidALPN</span>&nbsp;<span class="op" id="4564614">&amp;&amp;</span>&nbsp;<span class="ident" id="4564617">serverHasALPN</span>&nbsp;<span class="op" id="4564631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4564635">c</span><span class="op" id="4564636">.</span><span class="ident" id="4564637">sendAlert</span><span class="op" id="4564646">(</span><span class="ident" id="4564647">alertHandshakeFailure</span><span class="op" id="4564668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564672">return</span>&nbsp;<span class="builtintype" id="4564679">false</span><span class="op" id="4564684">,</span>&nbsp;<span class="ident" id="4564686">errors</span><span class="op" id="4564692">.</span><span class="ident" id="4564693">New</span><span class="op" id="4564696">(</span><span class="string" id="4564697">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;ALPN&nbsp;extension&#34;</span><span class="op" id="4564743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4564746">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564750">if</span>&nbsp;<span class="ident" id="4564753">serverHasNPN</span>&nbsp;<span class="op" id="4564766">&amp;&amp;</span>&nbsp;<span class="ident" id="4564769">serverHasALPN</span>&nbsp;<span class="op" id="4564783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4564787">c</span><span class="op" id="4564788">.</span><span class="ident" id="4564789">sendAlert</span><span class="op" id="4564798">(</span><span class="ident" id="4564799">alertHandshakeFailure</span><span class="op" id="4564820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564824">return</span>&nbsp;<span class="builtintype" id="4564831">false</span><span class="op" id="4564836">,</span>&nbsp;<span class="ident" id="4564838">errors</span><span class="op" id="4564844">.</span><span class="ident" id="4564845">New</span><span class="op" id="4564848">(</span><span class="string" id="4564849">&#34;server&nbsp;advertised&nbsp;both&nbsp;NPN&nbsp;and&nbsp;ALPN&nbsp;extensions&#34;</span><span class="op" id="4564897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4564900">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564904">if</span>&nbsp;<span class="ident" id="4564907">serverHasALPN</span>&nbsp;<span class="op" id="4564921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4564925">c</span><span class="op" id="4564926">.</span><span class="ident" id="4564927">clientProtocol</span>&nbsp;<span class="op" id="4564942">=</span>&nbsp;<span class="ident" id="4564944">hs</span><span class="op" id="4564946">.</span><span class="ident" id="4564947">serverHello</span><span class="op" id="4564958">.</span><span class="ident" id="4564959">alpnProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4564974">c</span><span class="op" id="4564975">.</span><span class="ident" id="4564976">clientProtocolFallback</span>&nbsp;<span class="op" id="4564999">=</span>&nbsp;<span class="builtintype" id="4565001">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4565008">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4565012">if</span>&nbsp;<span class="ident" id="4565015">hs</span><span class="op" id="4565017">.</span><span class="ident" id="4565018">serverResumedSession</span><span class="op" id="4565038">(</span><span class="op" id="4565039">)</span>&nbsp;<span class="op" id="4565041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4565045">//&nbsp;Restore&nbsp;masterSecret&nbsp;and&nbsp;peerCerts&nbsp;from&nbsp;previous&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4565105">hs</span><span class="op" id="4565107">.</span><span class="ident" id="4565108">masterSecret</span>&nbsp;<span class="op" id="4565121">=</span>&nbsp;<span class="ident" id="4565123">hs</span><span class="op" id="4565125">.</span><span class="ident" id="4565126">session</span><span class="op" id="4565133">.</span><span class="ident" id="4565134">masterSecret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4565149">c</span><span class="op" id="4565150">.</span><span class="ident" id="4565151">peerCertificates</span>&nbsp;<span class="op" id="4565168">=</span>&nbsp;<span class="ident" id="4565170">hs</span><span class="op" id="4565172">.</span><span class="ident" id="4565173">session</span><span class="op" id="4565180">.</span><span class="ident" id="4565181">serverCertificates</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4565202">return</span>&nbsp;<span class="builtintype" id="4565209">true</span><span class="op" id="4565213">,</span>&nbsp;<span class="ident" id="4565215">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4565220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4565223">return</span>&nbsp;<span class="builtintype" id="4565230">false</span><span class="op" id="4565235">,</span>&nbsp;<span class="ident" id="4565237">nil</span><br>
<span class="lineno"></span><span class="op" id="4565241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="4565244">func</span>&nbsp;<span class="op" id="4565249">(</span><span class="ident" id="4565250">hs</span>&nbsp;<span class="op" id="4565253">*</span><span class="ident" id="4565254">clientHandshakeState</span><span class="op" id="4565274">)</span>&nbsp;<span class="ident" id="4565276">readFinished</span><span class="op" id="4565288">(</span><span class="ident" id="4565289">out</span>&nbsp;<span class="op" id="4565293">[</span><span class="op" id="4565294">]</span><span class="builtintype" id="4565295">byte</span><span class="op" id="4565299">)</span>&nbsp;<span class="builtintype" id="4565301">error</span>&nbsp;<span class="op" id="4565307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4565310">c</span>&nbsp;<span class="op" id="4565312">:=</span>&nbsp;<span class="ident" id="4565315">hs</span><span class="op" id="4565317">.</span><span class="ident" id="4565318">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4565322">c</span><span class="op" id="4565323">.</span><span class="ident" id="4565324">readRecord</span><span class="op" id="4565334">(</span><span class="ident" id="4565335">recordTypeChangeCipherSpec</span><span class="op" id="4565361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4565364">if</span>&nbsp;<span class="ident" id="4565367">err</span>&nbsp;<span class="op" id="4565371">:=</span>&nbsp;<span class="ident" id="4565374">c</span><span class="op" id="4565375">.</span><span class="ident" id="4565376">in</span><span class="op" id="4565378">.</span><span class="builtintype" id="4565379">error</span><span class="op" id="4565384">(</span><span class="op" id="4565385">)</span><span class="op" id="4565386">;</span>&nbsp;<span class="ident" id="4565388">err</span>&nbsp;<span class="op" id="4565392">!=</span>&nbsp;<span class="ident" id="4565395">nil</span>&nbsp;<span class="op" id="4565399">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4565403">return</span>&nbsp;<span class="ident" id="4565410">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4565415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4565419">msg</span><span class="op" id="4565422">,</span>&nbsp;<span class="ident" id="4565424">err</span>&nbsp;<span class="op" id="4565428">:=</span>&nbsp;<span class="ident" id="4565431">c</span><span class="op" id="4565432">.</span><span class="ident" id="4565433">readHandshake</span><span class="op" id="4565446">(</span><span class="op" id="4565447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4565450">if</span>&nbsp;<span class="ident" id="4565453">err</span>&nbsp;<span class="op" id="4565457">!=</span>&nbsp;<span class="ident" id="4565460">nil</span>&nbsp;<span class="op" id="4565464">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4565468">return</span>&nbsp;<span class="ident" id="4565475">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4565480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4565483">serverFinished</span><span class="op" id="4565497">,</span>&nbsp;<span class="ident" id="4565499">ok</span>&nbsp;<span class="op" id="4565502">:=</span>&nbsp;<span class="ident" id="4565505">msg</span><span class="op" id="4565508">.</span><span class="op" id="4565509">(</span><span class="op" id="4565510">*</span><span class="ident" id="4565511">finishedMsg</span><span class="op" id="4565522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4565525">if</span>&nbsp;<span class="op" id="4565528">!</span><span class="ident" id="4565529">ok</span>&nbsp;<span class="op" id="4565532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4565536">c</span><span class="op" id="4565537">.</span><span class="ident" id="4565538">sendAlert</span><span class="op" id="4565547">(</span><span class="ident" id="4565548">alertUnexpectedMessage</span><span class="op" id="4565570">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4565574">return</span>&nbsp;<span class="ident" id="4565581">unexpectedMessageError</span><span class="op" id="4565603">(</span><span class="ident" id="4565604">serverFinished</span><span class="op" id="4565618">,</span>&nbsp;<span class="ident" id="4565620">msg</span><span class="op" id="4565623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4565626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4565630">verify</span>&nbsp;<span class="op" id="4565637">:=</span>&nbsp;<span class="ident" id="4565640">hs</span><span class="op" id="4565642">.</span><span class="ident" id="4565643">finishedHash</span><span class="op" id="4565655">.</span><span class="ident" id="4565656">serverSum</span><span class="op" id="4565665">(</span><span class="ident" id="4565666">hs</span><span class="op" id="4565668">.</span><span class="ident" id="4565669">masterSecret</span><span class="op" id="4565681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4565684">if</span>&nbsp;<span class="builtinfunc" id="4565687">len</span><span class="op" id="4565690">(</span><span class="ident" id="4565691">verify</span><span class="op" id="4565697">)</span>&nbsp;<span class="op" id="4565699">!=</span>&nbsp;<span class="builtinfunc" id="4565702">len</span><span class="op" id="4565705">(</span><span class="ident" id="4565706">serverFinished</span><span class="op" id="4565720">.</span><span class="ident" id="4565721">verifyData</span><span class="op" id="4565731">)</span>&nbsp;<span class="op" id="4565733">||</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4565738">subtle</span><span class="op" id="4565744">.</span><span class="ident" id="4565745">ConstantTimeCompare</span><span class="op" id="4565764">(</span><span class="ident" id="4565765">verify</span><span class="op" id="4565771">,</span>&nbsp;<span class="ident" id="4565773">serverFinished</span><span class="op" id="4565787">.</span><span class="ident" id="4565788">verifyData</span><span class="op" id="4565798">)</span>&nbsp;<span class="op" id="4565800">!=</span>&nbsp;<span class="num" id="4565803">1</span>&nbsp;<span class="op" id="4565805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4565809">c</span><span class="op" id="4565810">.</span><span class="ident" id="4565811">sendAlert</span><span class="op" id="4565820">(</span><span class="ident" id="4565821">alertHandshakeFailure</span><span class="op" id="4565842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4565846">return</span>&nbsp;<span class="ident" id="4565853">errors</span><span class="op" id="4565859">.</span><span class="ident" id="4565860">New</span><span class="op" id="4565863">(</span><span class="string" id="4565864">&#34;tls:&nbsp;server&#39;s&nbsp;Finished&nbsp;message&nbsp;was&nbsp;incorrect&#34;</span><span class="op" id="4565910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4565913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4565916">hs</span><span class="op" id="4565918">.</span><span class="ident" id="4565919">finishedHash</span><span class="op" id="4565931">.</span><span class="ident" id="4565932">Write</span><span class="op" id="4565937">(</span><span class="ident" id="4565938">serverFinished</span><span class="op" id="4565952">.</span><span class="ident" id="4565953">marshal</span><span class="op" id="4565960">(</span><span class="op" id="4565961">)</span><span class="op" id="4565962">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4565965">copy</span><span class="op" id="4565969">(</span><span class="ident" id="4565970">out</span><span class="op" id="4565973">,</span>&nbsp;<span class="ident" id="4565975">verify</span><span class="op" id="4565981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4565984">return</span>&nbsp;<span class="ident" id="4565991">nil</span><br>
<span class="lineno"></span><span class="op" id="4565995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4565998">func</span>&nbsp;<span class="op" id="4566003">(</span><span class="ident" id="4566004">hs</span>&nbsp;<span class="op" id="4566007">*</span><span class="ident" id="4566008">clientHandshakeState</span><span class="op" id="4566028">)</span>&nbsp;<span class="ident" id="4566030">readSessionTicket</span><span class="op" id="4566047">(</span><span class="op" id="4566048">)</span>&nbsp;<span class="builtintype" id="4566050">error</span>&nbsp;<span class="op" id="4566056">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566059">if</span>&nbsp;<span class="op" id="4566062">!</span><span class="ident" id="4566063">hs</span><span class="op" id="4566065">.</span><span class="ident" id="4566066">serverHello</span><span class="op" id="4566077">.</span><span class="ident" id="4566078">ticketSupported</span>&nbsp;<span class="op" id="4566094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566098">return</span>&nbsp;<span class="ident" id="4566105">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4566110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566114">c</span>&nbsp;<span class="op" id="4566116">:=</span>&nbsp;<span class="ident" id="4566119">hs</span><span class="op" id="4566121">.</span><span class="ident" id="4566122">c</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566125">msg</span><span class="op" id="4566128">,</span>&nbsp;<span class="ident" id="4566130">err</span>&nbsp;<span class="op" id="4566134">:=</span>&nbsp;<span class="ident" id="4566137">c</span><span class="op" id="4566138">.</span><span class="ident" id="4566139">readHandshake</span><span class="op" id="4566152">(</span><span class="op" id="4566153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566156">if</span>&nbsp;<span class="ident" id="4566159">err</span>&nbsp;<span class="op" id="4566163">!=</span>&nbsp;<span class="ident" id="4566166">nil</span>&nbsp;<span class="op" id="4566170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566174">return</span>&nbsp;<span class="ident" id="4566181">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4566186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566189">sessionTicketMsg</span><span class="op" id="4566205">,</span>&nbsp;<span class="ident" id="4566207">ok</span>&nbsp;<span class="op" id="4566210">:=</span>&nbsp;<span class="ident" id="4566213">msg</span><span class="op" id="4566216">.</span><span class="op" id="4566217">(</span><span class="op" id="4566218">*</span><span class="ident" id="4566219">newSessionTicketMsg</span><span class="op" id="4566238">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566241">if</span>&nbsp;<span class="op" id="4566244">!</span><span class="ident" id="4566245">ok</span>&nbsp;<span class="op" id="4566248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566252">c</span><span class="op" id="4566253">.</span><span class="ident" id="4566254">sendAlert</span><span class="op" id="4566263">(</span><span class="ident" id="4566264">alertUnexpectedMessage</span><span class="op" id="4566286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566290">return</span>&nbsp;<span class="ident" id="4566297">unexpectedMessageError</span><span class="op" id="4566319">(</span><span class="ident" id="4566320">sessionTicketMsg</span><span class="op" id="4566336">,</span>&nbsp;<span class="ident" id="4566338">msg</span><span class="op" id="4566341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4566344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566347">hs</span><span class="op" id="4566349">.</span><span class="ident" id="4566350">finishedHash</span><span class="op" id="4566362">.</span><span class="ident" id="4566363">Write</span><span class="op" id="4566368">(</span><span class="ident" id="4566369">sessionTicketMsg</span><span class="op" id="4566385">.</span><span class="ident" id="4566386">marshal</span><span class="op" id="4566393">(</span><span class="op" id="4566394">)</span><span class="op" id="4566395">)</span><br>
<span class="lineno">580</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566399">hs</span><span class="op" id="4566401">.</span><span class="ident" id="4566402">session</span>&nbsp;<span class="op" id="4566410">=</span>&nbsp;<span class="op" id="4566412">&amp;</span><span class="ident" id="4566413">ClientSessionState</span><span class="op" id="4566431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566435">sessionTicket</span><span class="op" id="4566448">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4566455">sessionTicketMsg</span><span class="op" id="4566471">.</span><span class="ident" id="4566472">ticket</span><span class="op" id="4566478">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566482">vers</span><span class="op" id="4566486">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4566502">c</span><span class="op" id="4566503">.</span><span class="ident" id="4566504">vers</span><span class="op" id="4566508">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566512">cipherSuite</span><span class="op" id="4566523">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4566532">hs</span><span class="op" id="4566534">.</span><span class="ident" id="4566535">suite</span><span class="op" id="4566540">.</span><span class="ident" id="4566541">id</span><span class="op" id="4566543">,</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566547">masterSecret</span><span class="op" id="4566559">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4566567">hs</span><span class="op" id="4566569">.</span><span class="ident" id="4566570">masterSecret</span><span class="op" id="4566582">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566586">serverCertificates</span><span class="op" id="4566604">:</span>&nbsp;<span class="ident" id="4566606">c</span><span class="op" id="4566607">.</span><span class="ident" id="4566608">peerCertificates</span><span class="op" id="4566624">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4566627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566631">return</span>&nbsp;<span class="ident" id="4566638">nil</span><br>
<span class="lineno">590</span><span class="op" id="4566642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4566645">func</span>&nbsp;<span class="op" id="4566650">(</span><span class="ident" id="4566651">hs</span>&nbsp;<span class="op" id="4566654">*</span><span class="ident" id="4566655">clientHandshakeState</span><span class="op" id="4566675">)</span>&nbsp;<span class="ident" id="4566677">sendFinished</span><span class="op" id="4566689">(</span><span class="ident" id="4566690">out</span>&nbsp;<span class="op" id="4566694">[</span><span class="op" id="4566695">]</span><span class="builtintype" id="4566696">byte</span><span class="op" id="4566700">)</span>&nbsp;<span class="builtintype" id="4566702">error</span>&nbsp;<span class="op" id="4566708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566711">c</span>&nbsp;<span class="op" id="4566713">:=</span>&nbsp;<span class="ident" id="4566716">hs</span><span class="op" id="4566718">.</span><span class="ident" id="4566719">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566723">c</span><span class="op" id="4566724">.</span><span class="ident" id="4566725">writeRecord</span><span class="op" id="4566736">(</span><span class="ident" id="4566737">recordTypeChangeCipherSpec</span><span class="op" id="4566763">,</span>&nbsp;<span class="op" id="4566765">[</span><span class="op" id="4566766">]</span><span class="builtintype" id="4566767">byte</span><span class="op" id="4566771">{</span><span class="num" id="4566772">1</span><span class="op" id="4566773">}</span><span class="op" id="4566774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566777">if</span>&nbsp;<span class="ident" id="4566780">hs</span><span class="op" id="4566782">.</span><span class="ident" id="4566783">serverHello</span><span class="op" id="4566794">.</span><span class="ident" id="4566795">nextProtoNeg</span>&nbsp;<span class="op" id="4566808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566812">nextProto</span>&nbsp;<span class="op" id="4566822">:=</span>&nbsp;<span class="builtinfunc" id="4566825">new</span><span class="op" id="4566828">(</span><span class="ident" id="4566829">nextProtoMsg</span><span class="op" id="4566841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566845">proto</span><span class="op" id="4566850">,</span>&nbsp;<span class="ident" id="4566852">fallback</span>&nbsp;<span class="op" id="4566861">:=</span>&nbsp;<span class="ident" id="4566864">mutualProtocol</span><span class="op" id="4566878">(</span><span class="ident" id="4566879">c</span><span class="op" id="4566880">.</span><span class="ident" id="4566881">config</span><span class="op" id="4566887">.</span><span class="ident" id="4566888">NextProtos</span><span class="op" id="4566898">,</span>&nbsp;<span class="ident" id="4566900">hs</span><span class="op" id="4566902">.</span><span class="ident" id="4566903">serverHello</span><span class="op" id="4566914">.</span><span class="ident" id="4566915">nextProtos</span><span class="op" id="4566925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566929">nextProto</span><span class="op" id="4566938">.</span><span class="ident" id="4566939">proto</span>&nbsp;<span class="op" id="4566945">=</span>&nbsp;<span class="ident" id="4566947">proto</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566955">c</span><span class="op" id="4566956">.</span><span class="ident" id="4566957">clientProtocol</span>&nbsp;<span class="op" id="4566972">=</span>&nbsp;<span class="ident" id="4566974">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566982">c</span><span class="op" id="4566983">.</span><span class="ident" id="4566984">clientProtocolFallback</span>&nbsp;<span class="op" id="4567007">=</span>&nbsp;<span class="ident" id="4567009">fallback</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4567021">hs</span><span class="op" id="4567023">.</span><span class="ident" id="4567024">finishedHash</span><span class="op" id="4567036">.</span><span class="ident" id="4567037">Write</span><span class="op" id="4567042">(</span><span class="ident" id="4567043">nextProto</span><span class="op" id="4567052">.</span><span class="ident" id="4567053">marshal</span><span class="op" id="4567060">(</span><span class="op" id="4567061">)</span><span class="op" id="4567062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4567066">c</span><span class="op" id="4567067">.</span><span class="ident" id="4567068">writeRecord</span><span class="op" id="4567079">(</span><span class="ident" id="4567080">recordTypeHandshake</span><span class="op" id="4567099">,</span>&nbsp;<span class="ident" id="4567101">nextProto</span><span class="op" id="4567110">.</span><span class="ident" id="4567111">marshal</span><span class="op" id="4567118">(</span><span class="op" id="4567119">)</span><span class="op" id="4567120">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4567123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4567127">finished</span>&nbsp;<span class="op" id="4567136">:=</span>&nbsp;<span class="builtinfunc" id="4567139">new</span><span class="op" id="4567142">(</span><span class="ident" id="4567143">finishedMsg</span><span class="op" id="4567154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4567157">finished</span><span class="op" id="4567165">.</span><span class="ident" id="4567166">verifyData</span>&nbsp;<span class="op" id="4567177">=</span>&nbsp;<span class="ident" id="4567179">hs</span><span class="op" id="4567181">.</span><span class="ident" id="4567182">finishedHash</span><span class="op" id="4567194">.</span><span class="ident" id="4567195">clientSum</span><span class="op" id="4567204">(</span><span class="ident" id="4567205">hs</span><span class="op" id="4567207">.</span><span class="ident" id="4567208">masterSecret</span><span class="op" id="4567220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4567223">hs</span><span class="op" id="4567225">.</span><span class="ident" id="4567226">finishedHash</span><span class="op" id="4567238">.</span><span class="ident" id="4567239">Write</span><span class="op" id="4567244">(</span><span class="ident" id="4567245">finished</span><span class="op" id="4567253">.</span><span class="ident" id="4567254">marshal</span><span class="op" id="4567261">(</span><span class="op" id="4567262">)</span><span class="op" id="4567263">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4567266">c</span><span class="op" id="4567267">.</span><span class="ident" id="4567268">writeRecord</span><span class="op" id="4567279">(</span><span class="ident" id="4567280">recordTypeHandshake</span><span class="op" id="4567299">,</span>&nbsp;<span class="ident" id="4567301">finished</span><span class="op" id="4567309">.</span><span class="ident" id="4567310">marshal</span><span class="op" id="4567317">(</span><span class="op" id="4567318">)</span><span class="op" id="4567319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4567322">copy</span><span class="op" id="4567326">(</span><span class="ident" id="4567327">out</span><span class="op" id="4567330">,</span>&nbsp;<span class="ident" id="4567332">finished</span><span class="op" id="4567340">.</span><span class="ident" id="4567341">verifyData</span><span class="op" id="4567351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4567354">return</span>&nbsp;<span class="ident" id="4567361">nil</span><br>
<span class="lineno"></span><span class="op" id="4567365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="comment" id="4567368">//&nbsp;clientSessionCacheKey&nbsp;returns&nbsp;a&nbsp;key&nbsp;used&nbsp;to&nbsp;cache&nbsp;sessionTickets&nbsp;that&nbsp;could</span><br>
<span class="lineno"></span><span class="comment" id="4567447">//&nbsp;be&nbsp;used&nbsp;to&nbsp;resume&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;sessions&nbsp;with&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="4567518">func</span>&nbsp;<span class="ident" id="4567523">clientSessionCacheKey</span><span class="op" id="4567544">(</span><span class="ident" id="4567545">serverAddr</span>&nbsp;<span class="ident" id="4567556">net</span><span class="op" id="4567559">.</span><span class="ident" id="4567560">Addr</span><span class="op" id="4567564">,</span>&nbsp;<span class="ident" id="4567566">config</span>&nbsp;<span class="op" id="4567573">*</span><span class="ident" id="4567574">Config</span><span class="op" id="4567580">)</span>&nbsp;<span class="builtintype" id="4567582">string</span>&nbsp;<span class="op" id="4567589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4567592">if</span>&nbsp;<span class="builtinfunc" id="4567595">len</span><span class="op" id="4567598">(</span><span class="ident" id="4567599">config</span><span class="op" id="4567605">.</span><span class="ident" id="4567606">ServerName</span><span class="op" id="4567616">)</span>&nbsp;<span class="op" id="4567618">&gt;</span>&nbsp;<span class="num" id="4567620">0</span>&nbsp;<span class="op" id="4567622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4567626">return</span>&nbsp;<span class="ident" id="4567633">config</span><span class="op" id="4567639">.</span><span class="ident" id="4567640">ServerName</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4567652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4567655">return</span>&nbsp;<span class="ident" id="4567662">serverAddr</span><span class="op" id="4567672">.</span><span class="ident" id="4567673">String</span><span class="op" id="4567679">(</span><span class="op" id="4567680">)</span><br>
<span class="lineno"></span><span class="op" id="4567682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4567685">//&nbsp;mutualProtocol&nbsp;finds&nbsp;the&nbsp;mutual&nbsp;Next&nbsp;Protocol&nbsp;Negotiation&nbsp;or&nbsp;ALPN&nbsp;protocol</span><br>
<span class="lineno">625</span><span class="comment" id="4567763">//&nbsp;given&nbsp;list&nbsp;of&nbsp;possible&nbsp;protocols&nbsp;and&nbsp;a&nbsp;list&nbsp;of&nbsp;the&nbsp;preference&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="4567839">//&nbsp;first&nbsp;list&nbsp;must&nbsp;not&nbsp;be&nbsp;empty.&nbsp;It&nbsp;returns&nbsp;the&nbsp;resulting&nbsp;protocol&nbsp;and&nbsp;flag</span><br>
<span class="lineno"></span><span class="comment" id="4567915">//&nbsp;indicating&nbsp;if&nbsp;the&nbsp;fallback&nbsp;case&nbsp;was&nbsp;reached.</span><br>
<span class="lineno"></span><span class="keyword" id="4567963">func</span>&nbsp;<span class="ident" id="4567968">mutualProtocol</span><span class="op" id="4567982">(</span><span class="ident" id="4567983">protos</span><span class="op" id="4567989">,</span>&nbsp;<span class="ident" id="4567991">preferenceProtos</span>&nbsp;<span class="op" id="4568008">[</span><span class="op" id="4568009">]</span><span class="builtintype" id="4568010">string</span><span class="op" id="4568016">)</span>&nbsp;<span class="op" id="4568018">(</span><span class="builtintype" id="4568019">string</span><span class="op" id="4568025">,</span>&nbsp;<span class="builtintype" id="4568027">bool</span><span class="op" id="4568031">)</span>&nbsp;<span class="op" id="4568033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4568036">for</span>&nbsp;<span class="ident" id="4568040">_</span><span class="op" id="4568041">,</span>&nbsp;<span class="ident" id="4568043">s</span>&nbsp;<span class="op" id="4568045">:=</span>&nbsp;<span class="keyword" id="4568048">range</span>&nbsp;<span class="ident" id="4568054">preferenceProtos</span>&nbsp;<span class="op" id="4568071">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4568075">for</span>&nbsp;<span class="ident" id="4568079">_</span><span class="op" id="4568080">,</span>&nbsp;<span class="ident" id="4568082">c</span>&nbsp;<span class="op" id="4568084">:=</span>&nbsp;<span class="keyword" id="4568087">range</span>&nbsp;<span class="ident" id="4568093">protos</span>&nbsp;<span class="op" id="4568100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4568105">if</span>&nbsp;<span class="ident" id="4568108">s</span>&nbsp;<span class="op" id="4568110">==</span>&nbsp;<span class="ident" id="4568113">c</span>&nbsp;<span class="op" id="4568115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4568121">return</span>&nbsp;<span class="ident" id="4568128">s</span><span class="op" id="4568129">,</span>&nbsp;<span class="builtintype" id="4568131">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4568140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4568144">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4568147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4568151">return</span>&nbsp;<span class="ident" id="4568158">protos</span><span class="op" id="4568164">[</span><span class="num" id="4568165">0</span><span class="op" id="4568166">]</span><span class="op" id="4568167">,</span>&nbsp;<span class="builtintype" id="4568169">true</span><br>
<span class="lineno"></span><span class="op" id="4568174">}</span>
</div>
</body>
</html>
