<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4410481">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4410536">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4410590">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4410641">package</span>&nbsp;<span class="ident" id="4410649">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4410659">import</span>&nbsp;<span class="op" id="4410666">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4410669">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4410678">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4410685">&#34;html&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4410693">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4410699">&#34;text/template&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4410716">&#34;text/template/parse&#34;</span><br>
<span class="lineno"></span><span class="op" id="4410738">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="4410741">//&nbsp;escapeTemplate&nbsp;rewrites&nbsp;the&nbsp;named&nbsp;template,&nbsp;which&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4410802">//&nbsp;associated&nbsp;with&nbsp;t,&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;the&nbsp;output&nbsp;of&nbsp;any&nbsp;of&nbsp;the&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="4410873">//&nbsp;templates&nbsp;is&nbsp;properly&nbsp;escaped.&nbsp;&nbsp;If&nbsp;no&nbsp;error&nbsp;is&nbsp;returned,&nbsp;then&nbsp;the&nbsp;named&nbsp;templates&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4410963">//&nbsp;been&nbsp;modified.&nbsp;&nbsp;Otherwise&nbsp;the&nbsp;named&nbsp;templates&nbsp;have&nbsp;been&nbsp;rendered</span><br>
<span class="lineno">20</span><span class="comment" id="4411031">//&nbsp;unusable.</span><br>
<span class="lineno"></span><span class="keyword" id="4411044">func</span>&nbsp;<span class="ident" id="4411049">escapeTemplate</span><span class="op" id="4411063">(</span><span class="ident" id="4411064">tmpl</span>&nbsp;<span class="op" id="4411069">*</span><span class="ident" id="4411070">Template</span><span class="op" id="4411078">,</span>&nbsp;<span class="ident" id="4411080">node</span>&nbsp;<span class="ident" id="4411085">parse</span><span class="op" id="4411090">.</span><span class="ident" id="4411091">Node</span><span class="op" id="4411095">,</span>&nbsp;<span class="ident" id="4411097">name</span>&nbsp;<span class="builtintype" id="4411102">string</span><span class="op" id="4411108">)</span>&nbsp;<span class="builtintype" id="4411110">error</span>&nbsp;<span class="op" id="4411116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411119">e</span>&nbsp;<span class="op" id="4411121">:=</span>&nbsp;<span class="ident" id="4411124">newEscaper</span><span class="op" id="4411134">(</span><span class="ident" id="4411135">tmpl</span><span class="op" id="4411139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411142">c</span><span class="op" id="4411143">,</span>&nbsp;<span class="ident" id="4411145">_</span>&nbsp;<span class="op" id="4411147">:=</span>&nbsp;<span class="ident" id="4411150">e</span><span class="op" id="4411151">.</span><span class="ident" id="4411152">escapeTree</span><span class="op" id="4411162">(</span><span class="ident" id="4411163">context</span><span class="op" id="4411170">{</span><span class="op" id="4411171">}</span><span class="op" id="4411172">,</span>&nbsp;<span class="ident" id="4411174">node</span><span class="op" id="4411178">,</span>&nbsp;<span class="ident" id="4411180">name</span><span class="op" id="4411184">,</span>&nbsp;<span class="num" id="4411186">0</span><span class="op" id="4411187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411190">var</span>&nbsp;<span class="ident" id="4411194">err</span>&nbsp;<span class="builtintype" id="4411198">error</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411205">if</span>&nbsp;<span class="ident" id="4411208">c</span><span class="op" id="4411209">.</span><span class="ident" id="4411210">err</span>&nbsp;<span class="op" id="4411214">!=</span>&nbsp;<span class="ident" id="4411217">nil</span>&nbsp;<span class="op" id="4411221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411225">err</span><span class="op" id="4411228">,</span>&nbsp;<span class="ident" id="4411230">c</span><span class="op" id="4411231">.</span><span class="ident" id="4411232">err</span><span class="op" id="4411235">.</span><span class="ident" id="4411236">Name</span>&nbsp;<span class="op" id="4411241">=</span>&nbsp;<span class="ident" id="4411243">c</span><span class="op" id="4411244">.</span><span class="ident" id="4411245">err</span><span class="op" id="4411248">,</span>&nbsp;<span class="ident" id="4411250">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4411256">}</span>&nbsp;<span class="keyword" id="4411258">else</span>&nbsp;<span class="keyword" id="4411263">if</span>&nbsp;<span class="ident" id="4411266">c</span><span class="op" id="4411267">.</span><span class="ident" id="4411268">state</span>&nbsp;<span class="op" id="4411274">!=</span>&nbsp;<span class="ident" id="4411277">stateText</span>&nbsp;<span class="op" id="4411287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411291">err</span>&nbsp;<span class="op" id="4411295">=</span>&nbsp;<span class="op" id="4411297">&amp;</span><span class="ident" id="4411298">Error</span><span class="op" id="4411303">{</span><span class="ident" id="4411304">ErrEndContext</span><span class="op" id="4411317">,</span>&nbsp;<span class="ident" id="4411319">nil</span><span class="op" id="4411322">,</span>&nbsp;<span class="ident" id="4411324">name</span><span class="op" id="4411328">,</span>&nbsp;<span class="num" id="4411330">0</span><span class="op" id="4411331">,</span>&nbsp;<span class="ident" id="4411333">fmt</span><span class="op" id="4411336">.</span><span class="ident" id="4411337">Sprintf</span><span class="op" id="4411344">(</span><span class="string" id="4411345">&#34;ends&nbsp;in&nbsp;a&nbsp;non-text&nbsp;context:&nbsp;%v&#34;</span><span class="op" id="4411377">,</span>&nbsp;<span class="ident" id="4411379">c</span><span class="op" id="4411380">)</span><span class="op" id="4411381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4411384">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411387">if</span>&nbsp;<span class="ident" id="4411390">err</span>&nbsp;<span class="op" id="4411394">!=</span>&nbsp;<span class="ident" id="4411397">nil</span>&nbsp;<span class="op" id="4411401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4411405">//&nbsp;Prevent&nbsp;execution&nbsp;of&nbsp;unsafe&nbsp;templates.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411449">if</span>&nbsp;<span class="ident" id="4411452">t</span>&nbsp;<span class="op" id="4411454">:=</span>&nbsp;<span class="ident" id="4411457">tmpl</span><span class="op" id="4411461">.</span><span class="ident" id="4411462">set</span><span class="op" id="4411465">[</span><span class="ident" id="4411466">name</span><span class="op" id="4411470">]</span><span class="op" id="4411471">;</span>&nbsp;<span class="ident" id="4411473">t</span>&nbsp;<span class="op" id="4411475">!=</span>&nbsp;<span class="ident" id="4411478">nil</span>&nbsp;<span class="op" id="4411482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411487">t</span><span class="op" id="4411488">.</span><span class="ident" id="4411489">escapeErr</span>&nbsp;<span class="op" id="4411499">=</span>&nbsp;<span class="ident" id="4411501">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411508">t</span><span class="op" id="4411509">.</span><span class="ident" id="4411510">text</span><span class="op" id="4411514">.</span><span class="ident" id="4411515">Tree</span>&nbsp;<span class="op" id="4411520">=</span>&nbsp;<span class="ident" id="4411522">nil</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411529">t</span><span class="op" id="4411530">.</span><span class="ident" id="4411531">Tree</span>&nbsp;<span class="op" id="4411536">=</span>&nbsp;<span class="ident" id="4411538">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4411544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411548">return</span>&nbsp;<span class="ident" id="4411555">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4411560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411563">e</span><span class="op" id="4411564">.</span><span class="ident" id="4411565">commit</span><span class="op" id="4411571">(</span><span class="op" id="4411572">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411575">if</span>&nbsp;<span class="ident" id="4411578">t</span>&nbsp;<span class="op" id="4411580">:=</span>&nbsp;<span class="ident" id="4411583">tmpl</span><span class="op" id="4411587">.</span><span class="ident" id="4411588">set</span><span class="op" id="4411591">[</span><span class="ident" id="4411592">name</span><span class="op" id="4411596">]</span><span class="op" id="4411597">;</span>&nbsp;<span class="ident" id="4411599">t</span>&nbsp;<span class="op" id="4411601">!=</span>&nbsp;<span class="ident" id="4411604">nil</span>&nbsp;<span class="op" id="4411608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411612">t</span><span class="op" id="4411613">.</span><span class="ident" id="4411614">escapeErr</span>&nbsp;<span class="op" id="4411624">=</span>&nbsp;<span class="ident" id="4411626">escapeOK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411637">t</span><span class="op" id="4411638">.</span><span class="ident" id="4411639">Tree</span>&nbsp;<span class="op" id="4411644">=</span>&nbsp;<span class="ident" id="4411646">t</span><span class="op" id="4411647">.</span><span class="ident" id="4411648">text</span><span class="op" id="4411652">.</span><span class="ident" id="4411653">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4411659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411662">return</span>&nbsp;<span class="ident" id="4411669">nil</span><br>
<span class="lineno">45</span><span class="op" id="4411673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4411676">//&nbsp;funcMap&nbsp;maps&nbsp;command&nbsp;names&nbsp;to&nbsp;functions&nbsp;that&nbsp;render&nbsp;their&nbsp;inputs&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="4411750">var</span>&nbsp;<span class="ident" id="4411754">funcMap</span>&nbsp;<span class="op" id="4411762">=</span>&nbsp;<span class="ident" id="4411764">template</span><span class="op" id="4411772">.</span><span class="ident" id="4411773">FuncMap</span><span class="op" id="4411780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4411783">&#34;html_template_attrescaper&#34;</span><span class="op" id="4411810">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4411816">attrEscaper</span><span class="op" id="4411827">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4411830">&#34;html_template_commentescaper&#34;</span><span class="op" id="4411860">:</span>&nbsp;&nbsp;<span class="ident" id="4411863">commentEscaper</span><span class="op" id="4411877">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4411880">&#34;html_template_cssescaper&#34;</span><span class="op" id="4411906">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4411913">cssEscaper</span><span class="op" id="4411923">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4411926">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="4411956">:</span>&nbsp;&nbsp;<span class="ident" id="4411959">cssValueFilter</span><span class="op" id="4411973">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4411976">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="4412006">:</span>&nbsp;&nbsp;<span class="ident" id="4412009">htmlNameFilter</span><span class="op" id="4412023">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4412026">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4412053">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4412059">htmlEscaper</span><span class="op" id="4412070">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4412073">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="4412104">:</span>&nbsp;<span class="ident" id="4412106">jsRegexpEscaper</span><span class="op" id="4412121">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4412124">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="4412152">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4412157">jsStrEscaper</span><span class="op" id="4412169">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4412172">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="4412200">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4412205">jsValEscaper</span><span class="op" id="4412217">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4412220">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4412250">:</span>&nbsp;&nbsp;<span class="ident" id="4412253">htmlNospaceEscaper</span><span class="op" id="4412271">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4412274">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="4412303">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4412307">rcdataEscaper</span><span class="op" id="4412320">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4412323">&#34;html_template_urlescaper&#34;</span><span class="op" id="4412349">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4412356">urlEscaper</span><span class="op" id="4412366">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4412369">&#34;html_template_urlfilter&#34;</span><span class="op" id="4412394">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4412402">urlFilter</span><span class="op" id="4412411">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4412414">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4412443">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4412447">urlNormalizer</span><span class="op" id="4412460">,</span><br>
<span class="lineno"></span><span class="op" id="4412462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4412465">//&nbsp;equivEscapers&nbsp;matches&nbsp;contextual&nbsp;escapers&nbsp;to&nbsp;equivalent&nbsp;template&nbsp;builtins.</span><br>
<span class="lineno"></span><span class="keyword" id="4412543">var</span>&nbsp;<span class="ident" id="4412547">equivEscapers</span>&nbsp;<span class="op" id="4412561">=</span>&nbsp;<span class="keyword" id="4412563">map</span><span class="op" id="4412566">[</span><span class="builtintype" id="4412567">string</span><span class="op" id="4412573">]</span><span class="builtintype" id="4412574">string</span><span class="op" id="4412580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4412583">&#34;html_template_attrescaper&#34;</span><span class="op" id="4412610">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4412615">&#34;html&#34;</span><span class="op" id="4412621">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4412624">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4412651">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4412656">&#34;html&#34;</span><span class="op" id="4412662">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4412665">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4412695">:</span>&nbsp;<span class="string" id="4412697">&#34;html&#34;</span><span class="op" id="4412703">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4412706">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="4412735">:</span>&nbsp;&nbsp;<span class="string" id="4412738">&#34;html&#34;</span><span class="op" id="4412744">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4412747">&#34;html_template_urlescaper&#34;</span><span class="op" id="4412773">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4412779">&#34;urlquery&#34;</span><span class="op" id="4412789">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4412792">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4412821">:</span>&nbsp;&nbsp;<span class="string" id="4412824">&#34;urlquery&#34;</span><span class="op" id="4412834">,</span><br>
<span class="lineno"></span><span class="op" id="4412836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="4412839">//&nbsp;escaper&nbsp;collects&nbsp;type&nbsp;inferences&nbsp;about&nbsp;templates&nbsp;and&nbsp;changes&nbsp;needed&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span><span class="comment" id="4412918">//&nbsp;templates&nbsp;injection&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="4412947">type</span>&nbsp;<span class="ident" id="4412952">escaper</span>&nbsp;<span class="keyword" id="4412960">struct</span>&nbsp;<span class="op" id="4412967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4412970">tmpl</span>&nbsp;<span class="op" id="4412975">*</span><span class="ident" id="4412976">Template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4412986">//&nbsp;output[templateName]&nbsp;is&nbsp;the&nbsp;output&nbsp;context&nbsp;for&nbsp;a&nbsp;templateName&nbsp;that</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4413057">//&nbsp;has&nbsp;been&nbsp;mangled&nbsp;to&nbsp;include&nbsp;its&nbsp;input&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413108">output</span>&nbsp;<span class="keyword" id="4413115">map</span><span class="op" id="4413118">[</span><span class="builtintype" id="4413119">string</span><span class="op" id="4413125">]</span><span class="ident" id="4413126">context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4413135">//&nbsp;derived[c.mangle(name)]&nbsp;maps&nbsp;to&nbsp;a&nbsp;template&nbsp;derived&nbsp;from&nbsp;the&nbsp;template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4413208">//&nbsp;named&nbsp;name&nbsp;templateName&nbsp;for&nbsp;the&nbsp;start&nbsp;context&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413261">derived</span>&nbsp;<span class="keyword" id="4413269">map</span><span class="op" id="4413272">[</span><span class="builtintype" id="4413273">string</span><span class="op" id="4413279">]</span><span class="op" id="4413280">*</span><span class="ident" id="4413281">template</span><span class="op" id="4413289">.</span><span class="ident" id="4413290">Template</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4413300">//&nbsp;called[templateName]&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;called&nbsp;mangled&nbsp;template&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413368">called</span>&nbsp;<span class="keyword" id="4413375">map</span><span class="op" id="4413378">[</span><span class="builtintype" id="4413379">string</span><span class="op" id="4413385">]</span><span class="builtintype" id="4413386">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4413392">//&nbsp;xxxNodeEdits&nbsp;are&nbsp;the&nbsp;accumulated&nbsp;edits&nbsp;to&nbsp;apply&nbsp;during&nbsp;commit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4413459">//&nbsp;Such&nbsp;edits&nbsp;are&nbsp;not&nbsp;applied&nbsp;immediately&nbsp;in&nbsp;case&nbsp;a&nbsp;template&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4413525">//&nbsp;executes&nbsp;a&nbsp;given&nbsp;template&nbsp;in&nbsp;different&nbsp;escaping&nbsp;contexts.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413587">actionNodeEdits</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="4413605">map</span><span class="op" id="4413608">[</span><span class="op" id="4413609">*</span><span class="ident" id="4413610">parse</span><span class="op" id="4413615">.</span><span class="ident" id="4413616">ActionNode</span><span class="op" id="4413626">]</span><span class="op" id="4413627">[</span><span class="op" id="4413628">]</span><span class="builtintype" id="4413629">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413637">templateNodeEdits</span>&nbsp;<span class="keyword" id="4413655">map</span><span class="op" id="4413658">[</span><span class="op" id="4413659">*</span><span class="ident" id="4413660">parse</span><span class="op" id="4413665">.</span><span class="ident" id="4413666">TemplateNode</span><span class="op" id="4413678">]</span><span class="builtintype" id="4413679">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413687">textNodeEdits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4413705">map</span><span class="op" id="4413708">[</span><span class="op" id="4413709">*</span><span class="ident" id="4413710">parse</span><span class="op" id="4413715">.</span><span class="ident" id="4413716">TextNode</span><span class="op" id="4413724">]</span><span class="op" id="4413725">[</span><span class="op" id="4413726">]</span><span class="builtintype" id="4413727">byte</span><br>
<span class="lineno"></span><span class="op" id="4413732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4413735">//&nbsp;newEscaper&nbsp;creates&nbsp;a&nbsp;blank&nbsp;escaper&nbsp;for&nbsp;the&nbsp;given&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="4413792">func</span>&nbsp;<span class="ident" id="4413797">newEscaper</span><span class="op" id="4413807">(</span><span class="ident" id="4413808">t</span>&nbsp;<span class="op" id="4413810">*</span><span class="ident" id="4413811">Template</span><span class="op" id="4413819">)</span>&nbsp;<span class="op" id="4413821">*</span><span class="ident" id="4413822">escaper</span>&nbsp;<span class="op" id="4413830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4413833">return</span>&nbsp;<span class="op" id="4413840">&amp;</span><span class="ident" id="4413841">escaper</span><span class="op" id="4413848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413852">t</span><span class="op" id="4413853">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4413857">map</span><span class="op" id="4413860">[</span><span class="builtintype" id="4413861">string</span><span class="op" id="4413867">]</span><span class="ident" id="4413868">context</span><span class="op" id="4413875">{</span><span class="op" id="4413876">}</span><span class="op" id="4413877">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4413881">map</span><span class="op" id="4413884">[</span><span class="builtintype" id="4413885">string</span><span class="op" id="4413891">]</span><span class="op" id="4413892">*</span><span class="ident" id="4413893">template</span><span class="op" id="4413901">.</span><span class="ident" id="4413902">Template</span><span class="op" id="4413910">{</span><span class="op" id="4413911">}</span><span class="op" id="4413912">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4413916">map</span><span class="op" id="4413919">[</span><span class="builtintype" id="4413920">string</span><span class="op" id="4413926">]</span><span class="builtintype" id="4413927">bool</span><span class="op" id="4413931">{</span><span class="op" id="4413932">}</span><span class="op" id="4413933">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4413937">map</span><span class="op" id="4413940">[</span><span class="op" id="4413941">*</span><span class="ident" id="4413942">parse</span><span class="op" id="4413947">.</span><span class="ident" id="4413948">ActionNode</span><span class="op" id="4413958">]</span><span class="op" id="4413959">[</span><span class="op" id="4413960">]</span><span class="builtintype" id="4413961">string</span><span class="op" id="4413967">{</span><span class="op" id="4413968">}</span><span class="op" id="4413969">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4413973">map</span><span class="op" id="4413976">[</span><span class="op" id="4413977">*</span><span class="ident" id="4413978">parse</span><span class="op" id="4413983">.</span><span class="ident" id="4413984">TemplateNode</span><span class="op" id="4413996">]</span><span class="builtintype" id="4413997">string</span><span class="op" id="4414003">{</span><span class="op" id="4414004">}</span><span class="op" id="4414005">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414009">map</span><span class="op" id="4414012">[</span><span class="op" id="4414013">*</span><span class="ident" id="4414014">parse</span><span class="op" id="4414019">.</span><span class="ident" id="4414020">TextNode</span><span class="op" id="4414028">]</span><span class="op" id="4414029">[</span><span class="op" id="4414030">]</span><span class="builtintype" id="4414031">byte</span><span class="op" id="4414035">{</span><span class="op" id="4414036">}</span><span class="op" id="4414037">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4414040">}</span><br>
<span class="lineno"></span><span class="op" id="4414042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4414045">//&nbsp;filterFailsafe&nbsp;is&nbsp;an&nbsp;innocuous&nbsp;word&nbsp;that&nbsp;is&nbsp;emitted&nbsp;in&nbsp;place&nbsp;of&nbsp;unsafe&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="4414126">//&nbsp;by&nbsp;sanitizer&nbsp;functions.&nbsp;It&nbsp;is&nbsp;not&nbsp;a&nbsp;keyword&nbsp;in&nbsp;any&nbsp;programming&nbsp;language,</span><br>
<span class="lineno">110</span><span class="comment" id="4414202">//&nbsp;contains&nbsp;no&nbsp;special&nbsp;characters,&nbsp;is&nbsp;not&nbsp;empty,&nbsp;and&nbsp;when&nbsp;it&nbsp;appears&nbsp;in&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="4414281">//&nbsp;it&nbsp;is&nbsp;distinct&nbsp;enough&nbsp;that&nbsp;a&nbsp;developer&nbsp;can&nbsp;find&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;problem</span><br>
<span class="lineno"></span><span class="comment" id="4414358">//&nbsp;via&nbsp;a&nbsp;search&nbsp;engine.</span><br>
<span class="lineno"></span><span class="keyword" id="4414382">const</span>&nbsp;<span class="ident" id="4414388">filterFailsafe</span>&nbsp;<span class="op" id="4414403">=</span>&nbsp;<span class="string" id="4414405">&#34;ZgotmplZ&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="4414417">//&nbsp;escape&nbsp;escapes&nbsp;a&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4414452">func</span>&nbsp;<span class="op" id="4414457">(</span><span class="ident" id="4414458">e</span>&nbsp;<span class="op" id="4414460">*</span><span class="ident" id="4414461">escaper</span><span class="op" id="4414468">)</span>&nbsp;<span class="ident" id="4414470">escape</span><span class="op" id="4414476">(</span><span class="ident" id="4414477">c</span>&nbsp;<span class="ident" id="4414479">context</span><span class="op" id="4414486">,</span>&nbsp;<span class="ident" id="4414488">n</span>&nbsp;<span class="ident" id="4414490">parse</span><span class="op" id="4414495">.</span><span class="ident" id="4414496">Node</span><span class="op" id="4414500">)</span>&nbsp;<span class="ident" id="4414502">context</span>&nbsp;<span class="op" id="4414510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414513">switch</span>&nbsp;<span class="ident" id="4414520">n</span>&nbsp;<span class="op" id="4414522">:=</span>&nbsp;<span class="ident" id="4414525">n</span><span class="op" id="4414526">.</span><span class="op" id="4414527">(</span><span class="keyword" id="4414528">type</span><span class="op" id="4414532">)</span>&nbsp;<span class="op" id="4414534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414537">case</span>&nbsp;<span class="op" id="4414542">*</span><span class="ident" id="4414543">parse</span><span class="op" id="4414548">.</span><span class="ident" id="4414549">ActionNode</span><span class="op" id="4414559">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414563">return</span>&nbsp;<span class="ident" id="4414570">e</span><span class="op" id="4414571">.</span><span class="ident" id="4414572">escapeAction</span><span class="op" id="4414584">(</span><span class="ident" id="4414585">c</span><span class="op" id="4414586">,</span>&nbsp;<span class="ident" id="4414588">n</span><span class="op" id="4414589">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414592">case</span>&nbsp;<span class="op" id="4414597">*</span><span class="ident" id="4414598">parse</span><span class="op" id="4414603">.</span><span class="ident" id="4414604">IfNode</span><span class="op" id="4414610">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414614">return</span>&nbsp;<span class="ident" id="4414621">e</span><span class="op" id="4414622">.</span><span class="ident" id="4414623">escapeBranch</span><span class="op" id="4414635">(</span><span class="ident" id="4414636">c</span><span class="op" id="4414637">,</span>&nbsp;<span class="op" id="4414639">&amp;</span><span class="ident" id="4414640">n</span><span class="op" id="4414641">.</span><span class="ident" id="4414642">BranchNode</span><span class="op" id="4414652">,</span>&nbsp;<span class="string" id="4414654">&#34;if&#34;</span><span class="op" id="4414658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414661">case</span>&nbsp;<span class="op" id="4414666">*</span><span class="ident" id="4414667">parse</span><span class="op" id="4414672">.</span><span class="ident" id="4414673">ListNode</span><span class="op" id="4414681">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414685">return</span>&nbsp;<span class="ident" id="4414692">e</span><span class="op" id="4414693">.</span><span class="ident" id="4414694">escapeList</span><span class="op" id="4414704">(</span><span class="ident" id="4414705">c</span><span class="op" id="4414706">,</span>&nbsp;<span class="ident" id="4414708">n</span><span class="op" id="4414709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414712">case</span>&nbsp;<span class="op" id="4414717">*</span><span class="ident" id="4414718">parse</span><span class="op" id="4414723">.</span><span class="ident" id="4414724">RangeNode</span><span class="op" id="4414733">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414737">return</span>&nbsp;<span class="ident" id="4414744">e</span><span class="op" id="4414745">.</span><span class="ident" id="4414746">escapeBranch</span><span class="op" id="4414758">(</span><span class="ident" id="4414759">c</span><span class="op" id="4414760">,</span>&nbsp;<span class="op" id="4414762">&amp;</span><span class="ident" id="4414763">n</span><span class="op" id="4414764">.</span><span class="ident" id="4414765">BranchNode</span><span class="op" id="4414775">,</span>&nbsp;<span class="string" id="4414777">&#34;range&#34;</span><span class="op" id="4414784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414787">case</span>&nbsp;<span class="op" id="4414792">*</span><span class="ident" id="4414793">parse</span><span class="op" id="4414798">.</span><span class="ident" id="4414799">TemplateNode</span><span class="op" id="4414811">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414815">return</span>&nbsp;<span class="ident" id="4414822">e</span><span class="op" id="4414823">.</span><span class="ident" id="4414824">escapeTemplate</span><span class="op" id="4414838">(</span><span class="ident" id="4414839">c</span><span class="op" id="4414840">,</span>&nbsp;<span class="ident" id="4414842">n</span><span class="op" id="4414843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414846">case</span>&nbsp;<span class="op" id="4414851">*</span><span class="ident" id="4414852">parse</span><span class="op" id="4414857">.</span><span class="ident" id="4414858">TextNode</span><span class="op" id="4414866">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414870">return</span>&nbsp;<span class="ident" id="4414877">e</span><span class="op" id="4414878">.</span><span class="ident" id="4414879">escapeText</span><span class="op" id="4414889">(</span><span class="ident" id="4414890">c</span><span class="op" id="4414891">,</span>&nbsp;<span class="ident" id="4414893">n</span><span class="op" id="4414894">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414897">case</span>&nbsp;<span class="op" id="4414902">*</span><span class="ident" id="4414903">parse</span><span class="op" id="4414908">.</span><span class="ident" id="4414909">WithNode</span><span class="op" id="4414917">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414921">return</span>&nbsp;<span class="ident" id="4414928">e</span><span class="op" id="4414929">.</span><span class="ident" id="4414930">escapeBranch</span><span class="op" id="4414942">(</span><span class="ident" id="4414943">c</span><span class="op" id="4414944">,</span>&nbsp;<span class="op" id="4414946">&amp;</span><span class="ident" id="4414947">n</span><span class="op" id="4414948">.</span><span class="ident" id="4414949">BranchNode</span><span class="op" id="4414959">,</span>&nbsp;<span class="string" id="4414961">&#34;with&#34;</span><span class="op" id="4414967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4414970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4414973">panic</span><span class="op" id="4414978">(</span><span class="string" id="4414979">&#34;escaping&nbsp;&#34;</span>&nbsp;<span class="op" id="4414991">+</span>&nbsp;<span class="ident" id="4414993">n</span><span class="op" id="4414994">.</span><span class="ident" id="4414995">String</span><span class="op" id="4415001">(</span><span class="op" id="4415002">)</span>&nbsp;<span class="op" id="4415004">+</span>&nbsp;<span class="string" id="4415006">&#34;&nbsp;is&nbsp;unimplemented&#34;</span><span class="op" id="4415025">)</span><br>
<span class="lineno"></span><span class="op" id="4415027">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="comment" id="4415030">//&nbsp;escapeAction&nbsp;escapes&nbsp;an&nbsp;action&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4415079">func</span>&nbsp;<span class="op" id="4415084">(</span><span class="ident" id="4415085">e</span>&nbsp;<span class="op" id="4415087">*</span><span class="ident" id="4415088">escaper</span><span class="op" id="4415095">)</span>&nbsp;<span class="ident" id="4415097">escapeAction</span><span class="op" id="4415109">(</span><span class="ident" id="4415110">c</span>&nbsp;<span class="ident" id="4415112">context</span><span class="op" id="4415119">,</span>&nbsp;<span class="ident" id="4415121">n</span>&nbsp;<span class="op" id="4415123">*</span><span class="ident" id="4415124">parse</span><span class="op" id="4415129">.</span><span class="ident" id="4415130">ActionNode</span><span class="op" id="4415140">)</span>&nbsp;<span class="ident" id="4415142">context</span>&nbsp;<span class="op" id="4415150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415153">if</span>&nbsp;<span class="builtinfunc" id="4415156">len</span><span class="op" id="4415159">(</span><span class="ident" id="4415160">n</span><span class="op" id="4415161">.</span><span class="ident" id="4415162">Pipe</span><span class="op" id="4415166">.</span><span class="ident" id="4415167">Decl</span><span class="op" id="4415171">)</span>&nbsp;<span class="op" id="4415173">!=</span>&nbsp;<span class="num" id="4415176">0</span>&nbsp;<span class="op" id="4415178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4415182">//&nbsp;A&nbsp;local&nbsp;variable&nbsp;assignment,&nbsp;not&nbsp;an&nbsp;interpolation.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415238">return</span>&nbsp;<span class="ident" id="4415245">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4415248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415251">c</span>&nbsp;<span class="op" id="4415253">=</span>&nbsp;<span class="ident" id="4415255">nudge</span><span class="op" id="4415260">(</span><span class="ident" id="4415261">c</span><span class="op" id="4415262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415265">s</span>&nbsp;<span class="op" id="4415267">:=</span>&nbsp;<span class="builtinfunc" id="4415270">make</span><span class="op" id="4415274">(</span><span class="op" id="4415275">[</span><span class="op" id="4415276">]</span><span class="builtintype" id="4415277">string</span><span class="op" id="4415283">,</span>&nbsp;<span class="num" id="4415285">0</span><span class="op" id="4415286">,</span>&nbsp;<span class="num" id="4415288">3</span><span class="op" id="4415289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415292">switch</span>&nbsp;<span class="ident" id="4415299">c</span><span class="op" id="4415300">.</span><span class="ident" id="4415301">state</span>&nbsp;<span class="op" id="4415307">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415310">case</span>&nbsp;<span class="ident" id="4415315">stateError</span><span class="op" id="4415325">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415329">return</span>&nbsp;<span class="ident" id="4415336">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415339">case</span>&nbsp;<span class="ident" id="4415344">stateURL</span><span class="op" id="4415352">,</span>&nbsp;<span class="ident" id="4415354">stateCSSDqStr</span><span class="op" id="4415367">,</span>&nbsp;<span class="ident" id="4415369">stateCSSSqStr</span><span class="op" id="4415382">,</span>&nbsp;<span class="ident" id="4415384">stateCSSDqURL</span><span class="op" id="4415397">,</span>&nbsp;<span class="ident" id="4415399">stateCSSSqURL</span><span class="op" id="4415412">,</span>&nbsp;<span class="ident" id="4415414">stateCSSURL</span><span class="op" id="4415425">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415429">switch</span>&nbsp;<span class="ident" id="4415436">c</span><span class="op" id="4415437">.</span><span class="ident" id="4415438">urlPart</span>&nbsp;<span class="op" id="4415446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415450">case</span>&nbsp;<span class="ident" id="4415455">urlPartNone</span><span class="op" id="4415466">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415471">s</span>&nbsp;<span class="op" id="4415473">=</span>&nbsp;<span class="builtinfunc" id="4415475">append</span><span class="op" id="4415481">(</span><span class="ident" id="4415482">s</span><span class="op" id="4415483">,</span>&nbsp;<span class="string" id="4415485">&#34;html_template_urlfilter&#34;</span><span class="op" id="4415510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415515">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415529">case</span>&nbsp;<span class="ident" id="4415534">urlPartPreQuery</span><span class="op" id="4415549">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415554">switch</span>&nbsp;<span class="ident" id="4415561">c</span><span class="op" id="4415562">.</span><span class="ident" id="4415563">state</span>&nbsp;<span class="op" id="4415569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415574">case</span>&nbsp;<span class="ident" id="4415579">stateCSSDqStr</span><span class="op" id="4415592">,</span>&nbsp;<span class="ident" id="4415594">stateCSSSqStr</span><span class="op" id="4415607">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415613">s</span>&nbsp;<span class="op" id="4415615">=</span>&nbsp;<span class="builtinfunc" id="4415617">append</span><span class="op" id="4415623">(</span><span class="ident" id="4415624">s</span><span class="op" id="4415625">,</span>&nbsp;<span class="string" id="4415627">&#34;html_template_cssescaper&#34;</span><span class="op" id="4415653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415658">default</span><span class="op" id="4415665">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415671">s</span>&nbsp;<span class="op" id="4415673">=</span>&nbsp;<span class="builtinfunc" id="4415675">append</span><span class="op" id="4415681">(</span><span class="ident" id="4415682">s</span><span class="op" id="4415683">,</span>&nbsp;<span class="string" id="4415685">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4415714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4415719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415723">case</span>&nbsp;<span class="ident" id="4415728">urlPartQueryOrFrag</span><span class="op" id="4415746">:</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415751">s</span>&nbsp;<span class="op" id="4415753">=</span>&nbsp;<span class="builtinfunc" id="4415755">append</span><span class="op" id="4415761">(</span><span class="ident" id="4415762">s</span><span class="op" id="4415763">,</span>&nbsp;<span class="string" id="4415765">&#34;html_template_urlescaper&#34;</span><span class="op" id="4415791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415795">case</span>&nbsp;<span class="ident" id="4415800">urlPartUnknown</span><span class="op" id="4415814">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415819">return</span>&nbsp;<span class="ident" id="4415826">context</span><span class="op" id="4415833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415839">state</span><span class="op" id="4415844">:</span>&nbsp;<span class="ident" id="4415846">stateError</span><span class="op" id="4415856">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415862">err</span><span class="op" id="4415865">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4415869">errorf</span><span class="op" id="4415875">(</span><span class="ident" id="4415876">ErrAmbigContext</span><span class="op" id="4415891">,</span>&nbsp;<span class="ident" id="4415893">n</span><span class="op" id="4415894">,</span>&nbsp;<span class="ident" id="4415896">n</span><span class="op" id="4415897">.</span><span class="ident" id="4415898">Line</span><span class="op" id="4415902">,</span>&nbsp;<span class="string" id="4415904">&#34;%s&nbsp;appears&nbsp;in&nbsp;an&nbsp;ambiguous&nbsp;URL&nbsp;context&#34;</span><span class="op" id="4415944">,</span>&nbsp;<span class="ident" id="4415946">n</span><span class="op" id="4415947">)</span><span class="op" id="4415948">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4415953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415957">default</span><span class="op" id="4415964">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4415969">panic</span><span class="op" id="4415974">(</span><span class="ident" id="4415975">c</span><span class="op" id="4415976">.</span><span class="ident" id="4415977">urlPart</span><span class="op" id="4415984">.</span><span class="ident" id="4415985">String</span><span class="op" id="4415991">(</span><span class="op" id="4415992">)</span><span class="op" id="4415993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4415997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416000">case</span>&nbsp;<span class="ident" id="4416005">stateJS</span><span class="op" id="4416012">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416016">s</span>&nbsp;<span class="op" id="4416018">=</span>&nbsp;<span class="builtinfunc" id="4416020">append</span><span class="op" id="4416026">(</span><span class="ident" id="4416027">s</span><span class="op" id="4416028">,</span>&nbsp;<span class="string" id="4416030">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="4416058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4416062">//&nbsp;A&nbsp;slash&nbsp;after&nbsp;a&nbsp;value&nbsp;starts&nbsp;a&nbsp;div&nbsp;operator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416112">c</span><span class="op" id="4416113">.</span><span class="ident" id="4416114">jsCtx</span>&nbsp;<span class="op" id="4416120">=</span>&nbsp;<span class="ident" id="4416122">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416134">case</span>&nbsp;<span class="ident" id="4416139">stateJSDqStr</span><span class="op" id="4416151">,</span>&nbsp;<span class="ident" id="4416153">stateJSSqStr</span><span class="op" id="4416165">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416169">s</span>&nbsp;<span class="op" id="4416171">=</span>&nbsp;<span class="builtinfunc" id="4416173">append</span><span class="op" id="4416179">(</span><span class="ident" id="4416180">s</span><span class="op" id="4416181">,</span>&nbsp;<span class="string" id="4416183">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="4416211">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416214">case</span>&nbsp;<span class="ident" id="4416219">stateJSRegexp</span><span class="op" id="4416232">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416236">s</span>&nbsp;<span class="op" id="4416238">=</span>&nbsp;<span class="builtinfunc" id="4416240">append</span><span class="op" id="4416246">(</span><span class="ident" id="4416247">s</span><span class="op" id="4416248">,</span>&nbsp;<span class="string" id="4416250">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="4416281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416284">case</span>&nbsp;<span class="ident" id="4416289">stateCSS</span><span class="op" id="4416297">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416301">s</span>&nbsp;<span class="op" id="4416303">=</span>&nbsp;<span class="builtinfunc" id="4416305">append</span><span class="op" id="4416311">(</span><span class="ident" id="4416312">s</span><span class="op" id="4416313">,</span>&nbsp;<span class="string" id="4416315">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="4416345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416348">case</span>&nbsp;<span class="ident" id="4416353">stateText</span><span class="op" id="4416362">:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416366">s</span>&nbsp;<span class="op" id="4416368">=</span>&nbsp;<span class="builtinfunc" id="4416370">append</span><span class="op" id="4416376">(</span><span class="ident" id="4416377">s</span><span class="op" id="4416378">,</span>&nbsp;<span class="string" id="4416380">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4416407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416410">case</span>&nbsp;<span class="ident" id="4416415">stateRCDATA</span><span class="op" id="4416426">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416430">s</span>&nbsp;<span class="op" id="4416432">=</span>&nbsp;<span class="builtinfunc" id="4416434">append</span><span class="op" id="4416440">(</span><span class="ident" id="4416441">s</span><span class="op" id="4416442">,</span>&nbsp;<span class="string" id="4416444">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="4416473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416476">case</span>&nbsp;<span class="ident" id="4416481">stateAttr</span><span class="op" id="4416490">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4416494">//&nbsp;Handled&nbsp;below&nbsp;in&nbsp;delim&nbsp;check.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416528">case</span>&nbsp;<span class="ident" id="4416533">stateAttrName</span><span class="op" id="4416546">,</span>&nbsp;<span class="ident" id="4416548">stateTag</span><span class="op" id="4416556">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416560">c</span><span class="op" id="4416561">.</span><span class="ident" id="4416562">state</span>&nbsp;<span class="op" id="4416568">=</span>&nbsp;<span class="ident" id="4416570">stateAttrName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416586">s</span>&nbsp;<span class="op" id="4416588">=</span>&nbsp;<span class="builtinfunc" id="4416590">append</span><span class="op" id="4416596">(</span><span class="ident" id="4416597">s</span><span class="op" id="4416598">,</span>&nbsp;<span class="string" id="4416600">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="4416630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416633">default</span><span class="op" id="4416640">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416644">if</span>&nbsp;<span class="ident" id="4416647">isComment</span><span class="op" id="4416656">(</span><span class="ident" id="4416657">c</span><span class="op" id="4416658">.</span><span class="ident" id="4416659">state</span><span class="op" id="4416664">)</span>&nbsp;<span class="op" id="4416666">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416671">s</span>&nbsp;<span class="op" id="4416673">=</span>&nbsp;<span class="builtinfunc" id="4416675">append</span><span class="op" id="4416681">(</span><span class="ident" id="4416682">s</span><span class="op" id="4416683">,</span>&nbsp;<span class="string" id="4416685">&#34;html_template_commentescaper&#34;</span><span class="op" id="4416715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4416719">}</span>&nbsp;<span class="keyword" id="4416721">else</span>&nbsp;<span class="op" id="4416726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4416731">panic</span><span class="op" id="4416736">(</span><span class="string" id="4416737">&#34;unexpected&nbsp;state&nbsp;&#34;</span>&nbsp;<span class="op" id="4416757">+</span>&nbsp;<span class="ident" id="4416759">c</span><span class="op" id="4416760">.</span><span class="ident" id="4416761">state</span><span class="op" id="4416766">.</span><span class="ident" id="4416767">String</span><span class="op" id="4416773">(</span><span class="op" id="4416774">)</span><span class="op" id="4416775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4416779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4416782">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416785">switch</span>&nbsp;<span class="ident" id="4416792">c</span><span class="op" id="4416793">.</span><span class="ident" id="4416794">delim</span>&nbsp;<span class="op" id="4416800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416803">case</span>&nbsp;<span class="ident" id="4416808">delimNone</span><span class="op" id="4416817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4416821">//&nbsp;No&nbsp;extra-escaping&nbsp;needed&nbsp;for&nbsp;raw&nbsp;text&nbsp;content.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416872">case</span>&nbsp;<span class="ident" id="4416877">delimSpaceOrTagEnd</span><span class="op" id="4416895">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416899">s</span>&nbsp;<span class="op" id="4416901">=</span>&nbsp;<span class="builtinfunc" id="4416903">append</span><span class="op" id="4416909">(</span><span class="ident" id="4416910">s</span><span class="op" id="4416911">,</span>&nbsp;<span class="string" id="4416913">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4416943">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416946">default</span><span class="op" id="4416953">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416957">s</span>&nbsp;<span class="op" id="4416959">=</span>&nbsp;<span class="builtinfunc" id="4416961">append</span><span class="op" id="4416967">(</span><span class="ident" id="4416968">s</span><span class="op" id="4416969">,</span>&nbsp;<span class="string" id="4416971">&#34;html_template_attrescaper&#34;</span><span class="op" id="4416998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4417001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417004">e</span><span class="op" id="4417005">.</span><span class="ident" id="4417006">editActionNode</span><span class="op" id="4417020">(</span><span class="ident" id="4417021">n</span><span class="op" id="4417022">,</span>&nbsp;<span class="ident" id="4417024">s</span><span class="op" id="4417025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417028">return</span>&nbsp;<span class="ident" id="4417035">c</span><br>
<span class="lineno">205</span><span class="op" id="4417037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4417040">//&nbsp;allIdents&nbsp;returns&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;identifiers&nbsp;under&nbsp;the&nbsp;Ident&nbsp;field&nbsp;of&nbsp;the&nbsp;node,</span><br>
<span class="lineno"></span><span class="comment" id="4417125">//&nbsp;which&nbsp;might&nbsp;be&nbsp;a&nbsp;singleton&nbsp;(Identifier)&nbsp;or&nbsp;a&nbsp;slice&nbsp;(Field).</span><br>
<span class="lineno"></span><span class="keyword" id="4417188">func</span>&nbsp;<span class="ident" id="4417193">allIdents</span><span class="op" id="4417202">(</span><span class="ident" id="4417203">node</span>&nbsp;<span class="ident" id="4417208">parse</span><span class="op" id="4417213">.</span><span class="ident" id="4417214">Node</span><span class="op" id="4417218">)</span>&nbsp;<span class="op" id="4417220">[</span><span class="op" id="4417221">]</span><span class="builtintype" id="4417222">string</span>&nbsp;<span class="op" id="4417229">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417232">switch</span>&nbsp;<span class="ident" id="4417239">node</span>&nbsp;<span class="op" id="4417244">:=</span>&nbsp;<span class="ident" id="4417247">node</span><span class="op" id="4417251">.</span><span class="op" id="4417252">(</span><span class="keyword" id="4417253">type</span><span class="op" id="4417257">)</span>&nbsp;<span class="op" id="4417259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417262">case</span>&nbsp;<span class="op" id="4417267">*</span><span class="ident" id="4417268">parse</span><span class="op" id="4417273">.</span><span class="ident" id="4417274">IdentifierNode</span><span class="op" id="4417288">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417292">return</span>&nbsp;<span class="op" id="4417299">[</span><span class="op" id="4417300">]</span><span class="builtintype" id="4417301">string</span><span class="op" id="4417307">{</span><span class="ident" id="4417308">node</span><span class="op" id="4417312">.</span><span class="ident" id="4417313">Ident</span><span class="op" id="4417318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417321">case</span>&nbsp;<span class="op" id="4417326">*</span><span class="ident" id="4417327">parse</span><span class="op" id="4417332">.</span><span class="ident" id="4417333">FieldNode</span><span class="op" id="4417342">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417346">return</span>&nbsp;<span class="ident" id="4417353">node</span><span class="op" id="4417357">.</span><span class="ident" id="4417358">Ident</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4417365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4417368">panic</span><span class="op" id="4417373">(</span><span class="string" id="4417374">&#34;unidentified&nbsp;node&nbsp;type&nbsp;in&nbsp;allIdents&#34;</span><span class="op" id="4417411">)</span><br>
<span class="lineno"></span><span class="op" id="4417413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4417416">//&nbsp;ensurePipelineContains&nbsp;ensures&nbsp;that&nbsp;the&nbsp;pipeline&nbsp;has&nbsp;commands&nbsp;with</span><br>
<span class="lineno">220</span><span class="comment" id="4417486">//&nbsp;the&nbsp;identifiers&nbsp;in&nbsp;s&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="4417520">//&nbsp;If&nbsp;the&nbsp;pipeline&nbsp;already&nbsp;has&nbsp;some&nbsp;of&nbsp;the&nbsp;sanitizers,&nbsp;do&nbsp;not&nbsp;interfere.</span><br>
<span class="lineno"></span><span class="comment" id="4417593">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;p&nbsp;is&nbsp;(.X&nbsp;|&nbsp;html)&nbsp;and&nbsp;s&nbsp;is&nbsp;[&#34;escapeJSVal&#34;,&nbsp;&#34;html&#34;]&nbsp;then&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="4417670">//&nbsp;has&nbsp;one&nbsp;matching,&nbsp;&#34;html&#34;,&nbsp;and&nbsp;one&nbsp;to&nbsp;insert,&nbsp;&#34;escapeJSVal&#34;,&nbsp;to&nbsp;produce</span><br>
<span class="lineno"></span><span class="comment" id="4417744">//&nbsp;(.X&nbsp;|&nbsp;escapeJSVal&nbsp;|&nbsp;html).</span><br>
<span class="lineno">225</span><span class="keyword" id="4417774">func</span>&nbsp;<span class="ident" id="4417779">ensurePipelineContains</span><span class="op" id="4417801">(</span><span class="ident" id="4417802">p</span>&nbsp;<span class="op" id="4417804">*</span><span class="ident" id="4417805">parse</span><span class="op" id="4417810">.</span><span class="ident" id="4417811">PipeNode</span><span class="op" id="4417819">,</span>&nbsp;<span class="ident" id="4417821">s</span>&nbsp;<span class="op" id="4417823">[</span><span class="op" id="4417824">]</span><span class="builtintype" id="4417825">string</span><span class="op" id="4417831">)</span>&nbsp;<span class="op" id="4417833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417836">if</span>&nbsp;<span class="builtinfunc" id="4417839">len</span><span class="op" id="4417842">(</span><span class="ident" id="4417843">s</span><span class="op" id="4417844">)</span>&nbsp;<span class="op" id="4417846">==</span>&nbsp;<span class="num" id="4417849">0</span>&nbsp;<span class="op" id="4417851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417855">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4417863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417866">n</span>&nbsp;<span class="op" id="4417868">:=</span>&nbsp;<span class="builtinfunc" id="4417871">len</span><span class="op" id="4417874">(</span><span class="ident" id="4417875">p</span><span class="op" id="4417876">.</span><span class="ident" id="4417877">Cmds</span><span class="op" id="4417881">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4417884">//&nbsp;Find&nbsp;the&nbsp;identifiers&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;chain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417942">idents</span>&nbsp;<span class="op" id="4417949">:=</span>&nbsp;<span class="ident" id="4417952">p</span><span class="op" id="4417953">.</span><span class="ident" id="4417954">Cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417960">for</span>&nbsp;<span class="ident" id="4417964">i</span>&nbsp;<span class="op" id="4417966">:=</span>&nbsp;<span class="ident" id="4417969">n</span>&nbsp;<span class="op" id="4417971">-</span>&nbsp;<span class="num" id="4417973">1</span><span class="op" id="4417974">;</span>&nbsp;<span class="ident" id="4417976">i</span>&nbsp;<span class="op" id="4417978">&gt;=</span>&nbsp;<span class="num" id="4417981">0</span><span class="op" id="4417982">;</span>&nbsp;<span class="ident" id="4417984">i</span><span class="op" id="4417985">--</span>&nbsp;<span class="op" id="4417988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417992">if</span>&nbsp;<span class="ident" id="4417995">cmd</span>&nbsp;<span class="op" id="4417999">:=</span>&nbsp;<span class="ident" id="4418002">p</span><span class="op" id="4418003">.</span><span class="ident" id="4418004">Cmds</span><span class="op" id="4418008">[</span><span class="ident" id="4418009">i</span><span class="op" id="4418010">]</span><span class="op" id="4418011">;</span>&nbsp;<span class="builtinfunc" id="4418013">len</span><span class="op" id="4418016">(</span><span class="ident" id="4418017">cmd</span><span class="op" id="4418020">.</span><span class="ident" id="4418021">Args</span><span class="op" id="4418025">)</span>&nbsp;<span class="op" id="4418027">!=</span>&nbsp;<span class="num" id="4418030">0</span>&nbsp;<span class="op" id="4418032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418037">if</span>&nbsp;<span class="ident" id="4418040">_</span><span class="op" id="4418041">,</span>&nbsp;<span class="ident" id="4418043">ok</span>&nbsp;<span class="op" id="4418046">:=</span>&nbsp;<span class="ident" id="4418049">cmd</span><span class="op" id="4418052">.</span><span class="ident" id="4418053">Args</span><span class="op" id="4418057">[</span><span class="num" id="4418058">0</span><span class="op" id="4418059">]</span><span class="op" id="4418060">.</span><span class="op" id="4418061">(</span><span class="op" id="4418062">*</span><span class="ident" id="4418063">parse</span><span class="op" id="4418068">.</span><span class="ident" id="4418069">IdentifierNode</span><span class="op" id="4418083">)</span><span class="op" id="4418084">;</span>&nbsp;<span class="ident" id="4418086">ok</span>&nbsp;<span class="op" id="4418089">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418095">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418115">idents</span>&nbsp;<span class="op" id="4418122">=</span>&nbsp;<span class="ident" id="4418124">p</span><span class="op" id="4418125">.</span><span class="ident" id="4418126">Cmds</span><span class="op" id="4418130">[</span><span class="ident" id="4418131">i</span><span class="op" id="4418132">+</span><span class="num" id="4418133">1</span><span class="op" id="4418134">:</span><span class="op" id="4418135">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418138">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418141">dups</span>&nbsp;<span class="op" id="4418146">:=</span>&nbsp;<span class="num" id="4418149">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418152">for</span>&nbsp;<span class="ident" id="4418156">_</span><span class="op" id="4418157">,</span>&nbsp;<span class="ident" id="4418159">idNode</span>&nbsp;<span class="op" id="4418166">:=</span>&nbsp;<span class="keyword" id="4418169">range</span>&nbsp;<span class="ident" id="4418175">idents</span>&nbsp;<span class="op" id="4418182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418186">for</span>&nbsp;<span class="ident" id="4418190">_</span><span class="op" id="4418191">,</span>&nbsp;<span class="ident" id="4418193">ident</span>&nbsp;<span class="op" id="4418199">:=</span>&nbsp;<span class="keyword" id="4418202">range</span>&nbsp;<span class="ident" id="4418208">allIdents</span><span class="op" id="4418217">(</span><span class="ident" id="4418218">idNode</span><span class="op" id="4418224">.</span><span class="ident" id="4418225">Args</span><span class="op" id="4418229">[</span><span class="num" id="4418230">0</span><span class="op" id="4418231">]</span><span class="op" id="4418232">)</span>&nbsp;<span class="op" id="4418234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418239">if</span>&nbsp;<span class="ident" id="4418242">escFnsEq</span><span class="op" id="4418250">(</span><span class="ident" id="4418251">s</span><span class="op" id="4418252">[</span><span class="ident" id="4418253">dups</span><span class="op" id="4418257">]</span><span class="op" id="4418258">,</span>&nbsp;<span class="ident" id="4418260">ident</span><span class="op" id="4418265">)</span>&nbsp;<span class="op" id="4418267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418273">dups</span><span class="op" id="4418277">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418284">if</span>&nbsp;<span class="ident" id="4418287">dups</span>&nbsp;<span class="op" id="4418292">==</span>&nbsp;<span class="builtinfunc" id="4418295">len</span><span class="op" id="4418298">(</span><span class="ident" id="4418299">s</span><span class="op" id="4418300">)</span>&nbsp;<span class="op" id="4418302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418309">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418329">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418335">newCmds</span>&nbsp;<span class="op" id="4418343">:=</span>&nbsp;<span class="builtinfunc" id="4418346">make</span><span class="op" id="4418350">(</span><span class="op" id="4418351">[</span><span class="op" id="4418352">]</span><span class="op" id="4418353">*</span><span class="ident" id="4418354">parse</span><span class="op" id="4418359">.</span><span class="ident" id="4418360">CommandNode</span><span class="op" id="4418371">,</span>&nbsp;<span class="ident" id="4418373">n</span><span class="op" id="4418374">-</span><span class="builtinfunc" id="4418375">len</span><span class="op" id="4418378">(</span><span class="ident" id="4418379">idents</span><span class="op" id="4418385">)</span><span class="op" id="4418386">,</span>&nbsp;<span class="ident" id="4418388">n</span><span class="op" id="4418389">+</span><span class="builtinfunc" id="4418390">len</span><span class="op" id="4418393">(</span><span class="ident" id="4418394">s</span><span class="op" id="4418395">)</span><span class="op" id="4418396">-</span><span class="ident" id="4418397">dups</span><span class="op" id="4418401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4418404">copy</span><span class="op" id="4418408">(</span><span class="ident" id="4418409">newCmds</span><span class="op" id="4418416">,</span>&nbsp;<span class="ident" id="4418418">p</span><span class="op" id="4418419">.</span><span class="ident" id="4418420">Cmds</span><span class="op" id="4418424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4418427">//&nbsp;Merge&nbsp;existing&nbsp;identifier&nbsp;commands&nbsp;with&nbsp;the&nbsp;sanitizers&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418494">for</span>&nbsp;<span class="ident" id="4418498">_</span><span class="op" id="4418499">,</span>&nbsp;<span class="ident" id="4418501">idNode</span>&nbsp;<span class="op" id="4418508">:=</span>&nbsp;<span class="keyword" id="4418511">range</span>&nbsp;<span class="ident" id="4418517">idents</span>&nbsp;<span class="op" id="4418524">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418528">pos</span>&nbsp;<span class="op" id="4418532">:=</span>&nbsp;<span class="ident" id="4418535">idNode</span><span class="op" id="4418541">.</span><span class="ident" id="4418542">Args</span><span class="op" id="4418546">[</span><span class="num" id="4418547">0</span><span class="op" id="4418548">]</span><span class="op" id="4418549">.</span><span class="ident" id="4418550">Position</span><span class="op" id="4418558">(</span><span class="op" id="4418559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418563">for</span>&nbsp;<span class="ident" id="4418567">_</span><span class="op" id="4418568">,</span>&nbsp;<span class="ident" id="4418570">ident</span>&nbsp;<span class="op" id="4418576">:=</span>&nbsp;<span class="keyword" id="4418579">range</span>&nbsp;<span class="ident" id="4418585">allIdents</span><span class="op" id="4418594">(</span><span class="ident" id="4418595">idNode</span><span class="op" id="4418601">.</span><span class="ident" id="4418602">Args</span><span class="op" id="4418606">[</span><span class="num" id="4418607">0</span><span class="op" id="4418608">]</span><span class="op" id="4418609">)</span>&nbsp;<span class="op" id="4418611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418616">i</span>&nbsp;<span class="op" id="4418618">:=</span>&nbsp;<span class="ident" id="4418621">indexOfStr</span><span class="op" id="4418631">(</span><span class="ident" id="4418632">ident</span><span class="op" id="4418637">,</span>&nbsp;<span class="ident" id="4418639">s</span><span class="op" id="4418640">,</span>&nbsp;<span class="ident" id="4418642">escFnsEq</span><span class="op" id="4418650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418655">if</span>&nbsp;<span class="ident" id="4418658">i</span>&nbsp;<span class="op" id="4418660">!=</span>&nbsp;<span class="op" id="4418663">-</span><span class="num" id="4418664">1</span>&nbsp;<span class="op" id="4418666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418672">for</span>&nbsp;<span class="ident" id="4418676">_</span><span class="op" id="4418677">,</span>&nbsp;<span class="ident" id="4418679">name</span>&nbsp;<span class="op" id="4418684">:=</span>&nbsp;<span class="keyword" id="4418687">range</span>&nbsp;<span class="ident" id="4418693">s</span><span class="op" id="4418694">[</span><span class="op" id="4418695">:</span><span class="ident" id="4418696">i</span><span class="op" id="4418697">]</span>&nbsp;<span class="op" id="4418699">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418706">newCmds</span>&nbsp;<span class="op" id="4418714">=</span>&nbsp;<span class="ident" id="4418716">appendCmd</span><span class="op" id="4418725">(</span><span class="ident" id="4418726">newCmds</span><span class="op" id="4418733">,</span>&nbsp;<span class="ident" id="4418735">newIdentCmd</span><span class="op" id="4418746">(</span><span class="ident" id="4418747">name</span><span class="op" id="4418751">,</span>&nbsp;<span class="ident" id="4418753">pos</span><span class="op" id="4418756">)</span><span class="op" id="4418757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418769">s</span>&nbsp;<span class="op" id="4418771">=</span>&nbsp;<span class="ident" id="4418773">s</span><span class="op" id="4418774">[</span><span class="ident" id="4418775">i</span><span class="op" id="4418776">+</span><span class="num" id="4418777">1</span><span class="op" id="4418778">:</span><span class="op" id="4418779">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418788">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418792">newCmds</span>&nbsp;<span class="op" id="4418800">=</span>&nbsp;<span class="ident" id="4418802">appendCmd</span><span class="op" id="4418811">(</span><span class="ident" id="4418812">newCmds</span><span class="op" id="4418819">,</span>&nbsp;<span class="ident" id="4418821">idNode</span><span class="op" id="4418827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4418833">//&nbsp;Create&nbsp;any&nbsp;remaining&nbsp;sanitizers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418870">for</span>&nbsp;<span class="ident" id="4418874">_</span><span class="op" id="4418875">,</span>&nbsp;<span class="ident" id="4418877">name</span>&nbsp;<span class="op" id="4418882">:=</span>&nbsp;<span class="keyword" id="4418885">range</span>&nbsp;<span class="ident" id="4418891">s</span>&nbsp;<span class="op" id="4418893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418897">newCmds</span>&nbsp;<span class="op" id="4418905">=</span>&nbsp;<span class="ident" id="4418907">appendCmd</span><span class="op" id="4418916">(</span><span class="ident" id="4418917">newCmds</span><span class="op" id="4418924">,</span>&nbsp;<span class="ident" id="4418926">newIdentCmd</span><span class="op" id="4418937">(</span><span class="ident" id="4418938">name</span><span class="op" id="4418942">,</span>&nbsp;<span class="ident" id="4418944">p</span><span class="op" id="4418945">.</span><span class="ident" id="4418946">Position</span><span class="op" id="4418954">(</span><span class="op" id="4418955">)</span><span class="op" id="4418956">)</span><span class="op" id="4418957">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418963">p</span><span class="op" id="4418964">.</span><span class="ident" id="4418965">Cmds</span>&nbsp;<span class="op" id="4418970">=</span>&nbsp;<span class="ident" id="4418972">newCmds</span><br>
<span class="lineno"></span><span class="op" id="4418980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4418983">//&nbsp;redundantFuncs[a][b]&nbsp;implies&nbsp;that&nbsp;funcMap[b](funcMap[a](x))&nbsp;==&nbsp;funcMap[a](x)</span><br>
<span class="lineno">275</span><span class="comment" id="4419063">//&nbsp;for&nbsp;all&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword" id="4419077">var</span>&nbsp;<span class="ident" id="4419081">redundantFuncs</span>&nbsp;<span class="op" id="4419096">=</span>&nbsp;<span class="keyword" id="4419098">map</span><span class="op" id="4419101">[</span><span class="builtintype" id="4419102">string</span><span class="op" id="4419108">]</span><span class="keyword" id="4419109">map</span><span class="op" id="4419112">[</span><span class="builtintype" id="4419113">string</span><span class="op" id="4419119">]</span><span class="builtintype" id="4419120">bool</span><span class="op" id="4419124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4419127">&#34;html_template_commentescaper&#34;</span><span class="op" id="4419157">:</span>&nbsp;<span class="op" id="4419159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4419163">&#34;html_template_attrescaper&#34;</span><span class="op" id="4419190">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4419195">true</span><span class="op" id="4419199">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4419203">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4419233">:</span>&nbsp;<span class="ident" id="4419235">true</span><span class="op" id="4419239">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4419243">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4419270">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4419275">true</span><span class="op" id="4419279">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4419282">}</span><span class="op" id="4419283">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4419286">&#34;html_template_cssescaper&#34;</span><span class="op" id="4419312">:</span>&nbsp;<span class="op" id="4419314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4419318">&#34;html_template_attrescaper&#34;</span><span class="op" id="4419345">:</span>&nbsp;<span class="ident" id="4419347">true</span><span class="op" id="4419351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4419354">}</span><span class="op" id="4419355">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4419358">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="4419389">:</span>&nbsp;<span class="op" id="4419391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4419395">&#34;html_template_attrescaper&#34;</span><span class="op" id="4419422">:</span>&nbsp;<span class="ident" id="4419424">true</span><span class="op" id="4419428">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4419431">}</span><span class="op" id="4419432">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4419435">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="4419463">:</span>&nbsp;<span class="op" id="4419465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4419469">&#34;html_template_attrescaper&#34;</span><span class="op" id="4419496">:</span>&nbsp;<span class="ident" id="4419498">true</span><span class="op" id="4419502">,</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4419505">}</span><span class="op" id="4419506">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4419509">&#34;html_template_urlescaper&#34;</span><span class="op" id="4419535">:</span>&nbsp;<span class="op" id="4419537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4419541">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4419570">:</span>&nbsp;<span class="ident" id="4419572">true</span><span class="op" id="4419576">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4419579">}</span><span class="op" id="4419580">,</span><br>
<span class="lineno"></span><span class="op" id="4419582">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="4419585">//&nbsp;appendCmd&nbsp;appends&nbsp;the&nbsp;given&nbsp;command&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;pipeline</span><br>
<span class="lineno"></span><span class="comment" id="4419659">//&nbsp;unless&nbsp;it&nbsp;is&nbsp;redundant&nbsp;with&nbsp;the&nbsp;last&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="4419708">func</span>&nbsp;<span class="ident" id="4419713">appendCmd</span><span class="op" id="4419722">(</span><span class="ident" id="4419723">cmds</span>&nbsp;<span class="op" id="4419728">[</span><span class="op" id="4419729">]</span><span class="op" id="4419730">*</span><span class="ident" id="4419731">parse</span><span class="op" id="4419736">.</span><span class="ident" id="4419737">CommandNode</span><span class="op" id="4419748">,</span>&nbsp;<span class="ident" id="4419750">cmd</span>&nbsp;<span class="op" id="4419754">*</span><span class="ident" id="4419755">parse</span><span class="op" id="4419760">.</span><span class="ident" id="4419761">CommandNode</span><span class="op" id="4419772">)</span>&nbsp;<span class="op" id="4419774">[</span><span class="op" id="4419775">]</span><span class="op" id="4419776">*</span><span class="ident" id="4419777">parse</span><span class="op" id="4419782">.</span><span class="ident" id="4419783">CommandNode</span>&nbsp;<span class="op" id="4419795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4419798">if</span>&nbsp;<span class="ident" id="4419801">n</span>&nbsp;<span class="op" id="4419803">:=</span>&nbsp;<span class="builtinfunc" id="4419806">len</span><span class="op" id="4419809">(</span><span class="ident" id="4419810">cmds</span><span class="op" id="4419814">)</span><span class="op" id="4419815">;</span>&nbsp;<span class="ident" id="4419817">n</span>&nbsp;<span class="op" id="4419819">!=</span>&nbsp;<span class="num" id="4419822">0</span>&nbsp;<span class="op" id="4419824">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4419828">last</span><span class="op" id="4419832">,</span>&nbsp;<span class="ident" id="4419834">ok</span>&nbsp;<span class="op" id="4419837">:=</span>&nbsp;<span class="ident" id="4419840">cmds</span><span class="op" id="4419844">[</span><span class="ident" id="4419845">n</span><span class="op" id="4419846">-</span><span class="num" id="4419847">1</span><span class="op" id="4419848">]</span><span class="op" id="4419849">.</span><span class="ident" id="4419850">Args</span><span class="op" id="4419854">[</span><span class="num" id="4419855">0</span><span class="op" id="4419856">]</span><span class="op" id="4419857">.</span><span class="op" id="4419858">(</span><span class="op" id="4419859">*</span><span class="ident" id="4419860">parse</span><span class="op" id="4419865">.</span><span class="ident" id="4419866">IdentifierNode</span><span class="op" id="4419880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4419884">next</span><span class="op" id="4419888">,</span>&nbsp;<span class="ident" id="4419890">_</span>&nbsp;<span class="op" id="4419892">:=</span>&nbsp;<span class="ident" id="4419895">cmd</span><span class="op" id="4419898">.</span><span class="ident" id="4419899">Args</span><span class="op" id="4419903">[</span><span class="num" id="4419904">0</span><span class="op" id="4419905">]</span><span class="op" id="4419906">.</span><span class="op" id="4419907">(</span><span class="op" id="4419908">*</span><span class="ident" id="4419909">parse</span><span class="op" id="4419914">.</span><span class="ident" id="4419915">IdentifierNode</span><span class="op" id="4419929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4419933">if</span>&nbsp;<span class="ident" id="4419936">ok</span>&nbsp;<span class="op" id="4419939">&amp;&amp;</span>&nbsp;<span class="ident" id="4419942">redundantFuncs</span><span class="op" id="4419956">[</span><span class="ident" id="4419957">last</span><span class="op" id="4419961">.</span><span class="ident" id="4419962">Ident</span><span class="op" id="4419967">]</span><span class="op" id="4419968">[</span><span class="ident" id="4419969">next</span><span class="op" id="4419973">.</span><span class="ident" id="4419974">Ident</span><span class="op" id="4419979">]</span>&nbsp;<span class="op" id="4419981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4419986">return</span>&nbsp;<span class="ident" id="4419993">cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4420000">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4420003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420006">return</span>&nbsp;<span class="builtinfunc" id="4420013">append</span><span class="op" id="4420019">(</span><span class="ident" id="4420020">cmds</span><span class="op" id="4420024">,</span>&nbsp;<span class="ident" id="4420026">cmd</span><span class="op" id="4420029">)</span><br>
<span class="lineno"></span><span class="op" id="4420031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4420034">//&nbsp;indexOfStr&nbsp;is&nbsp;the&nbsp;first&nbsp;i&nbsp;such&nbsp;that&nbsp;eq(s,&nbsp;strs[i])&nbsp;or&nbsp;-1&nbsp;if&nbsp;s&nbsp;was&nbsp;not&nbsp;found.</span><br>
<span class="lineno">310</span><span class="keyword" id="4420114">func</span>&nbsp;<span class="ident" id="4420119">indexOfStr</span><span class="op" id="4420129">(</span><span class="ident" id="4420130">s</span>&nbsp;<span class="builtintype" id="4420132">string</span><span class="op" id="4420138">,</span>&nbsp;<span class="ident" id="4420140">strs</span>&nbsp;<span class="op" id="4420145">[</span><span class="op" id="4420146">]</span><span class="builtintype" id="4420147">string</span><span class="op" id="4420153">,</span>&nbsp;<span class="ident" id="4420155">eq</span>&nbsp;<span class="keyword" id="4420158">func</span><span class="op" id="4420162">(</span><span class="ident" id="4420163">a</span><span class="op" id="4420164">,</span>&nbsp;<span class="ident" id="4420166">b</span>&nbsp;<span class="builtintype" id="4420168">string</span><span class="op" id="4420174">)</span>&nbsp;<span class="builtintype" id="4420176">bool</span><span class="op" id="4420180">)</span>&nbsp;<span class="builtintype" id="4420182">int</span>&nbsp;<span class="op" id="4420186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420189">for</span>&nbsp;<span class="ident" id="4420193">i</span><span class="op" id="4420194">,</span>&nbsp;<span class="ident" id="4420196">t</span>&nbsp;<span class="op" id="4420198">:=</span>&nbsp;<span class="keyword" id="4420201">range</span>&nbsp;<span class="ident" id="4420207">strs</span>&nbsp;<span class="op" id="4420212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420216">if</span>&nbsp;<span class="ident" id="4420219">eq</span><span class="op" id="4420221">(</span><span class="ident" id="4420222">s</span><span class="op" id="4420223">,</span>&nbsp;<span class="ident" id="4420225">t</span><span class="op" id="4420226">)</span>&nbsp;<span class="op" id="4420228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420233">return</span>&nbsp;<span class="ident" id="4420240">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4420244">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4420247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420250">return</span>&nbsp;<span class="op" id="4420257">-</span><span class="num" id="4420258">1</span><br>
<span class="lineno"></span><span class="op" id="4420260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4420263">//&nbsp;escFnsEq&nbsp;reports&nbsp;whether&nbsp;the&nbsp;two&nbsp;escaping&nbsp;functions&nbsp;are&nbsp;equivalent.</span><br>
<span class="lineno">320</span><span class="keyword" id="4420334">func</span>&nbsp;<span class="ident" id="4420339">escFnsEq</span><span class="op" id="4420347">(</span><span class="ident" id="4420348">a</span><span class="op" id="4420349">,</span>&nbsp;<span class="ident" id="4420351">b</span>&nbsp;<span class="builtintype" id="4420353">string</span><span class="op" id="4420359">)</span>&nbsp;<span class="builtintype" id="4420361">bool</span>&nbsp;<span class="op" id="4420366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420369">if</span>&nbsp;<span class="ident" id="4420372">e</span>&nbsp;<span class="op" id="4420374">:=</span>&nbsp;<span class="ident" id="4420377">equivEscapers</span><span class="op" id="4420390">[</span><span class="ident" id="4420391">a</span><span class="op" id="4420392">]</span><span class="op" id="4420393">;</span>&nbsp;<span class="ident" id="4420395">e</span>&nbsp;<span class="op" id="4420397">!=</span>&nbsp;<span class="string" id="4420400">&#34;&#34;</span>&nbsp;<span class="op" id="4420403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4420407">a</span>&nbsp;<span class="op" id="4420409">=</span>&nbsp;<span class="ident" id="4420411">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4420414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420417">if</span>&nbsp;<span class="ident" id="4420420">e</span>&nbsp;<span class="op" id="4420422">:=</span>&nbsp;<span class="ident" id="4420425">equivEscapers</span><span class="op" id="4420438">[</span><span class="ident" id="4420439">b</span><span class="op" id="4420440">]</span><span class="op" id="4420441">;</span>&nbsp;<span class="ident" id="4420443">e</span>&nbsp;<span class="op" id="4420445">!=</span>&nbsp;<span class="string" id="4420448">&#34;&#34;</span>&nbsp;<span class="op" id="4420451">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4420455">b</span>&nbsp;<span class="op" id="4420457">=</span>&nbsp;<span class="ident" id="4420459">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4420462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420465">return</span>&nbsp;<span class="ident" id="4420472">a</span>&nbsp;<span class="op" id="4420474">==</span>&nbsp;<span class="ident" id="4420477">b</span><br>
<span class="lineno"></span><span class="op" id="4420479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="4420482">//&nbsp;newIdentCmd&nbsp;produces&nbsp;a&nbsp;command&nbsp;containing&nbsp;a&nbsp;single&nbsp;identifier&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4420553">func</span>&nbsp;<span class="ident" id="4420558">newIdentCmd</span><span class="op" id="4420569">(</span><span class="ident" id="4420570">identifier</span>&nbsp;<span class="builtintype" id="4420581">string</span><span class="op" id="4420587">,</span>&nbsp;<span class="ident" id="4420589">pos</span>&nbsp;<span class="ident" id="4420593">parse</span><span class="op" id="4420598">.</span><span class="ident" id="4420599">Pos</span><span class="op" id="4420602">)</span>&nbsp;<span class="op" id="4420604">*</span><span class="ident" id="4420605">parse</span><span class="op" id="4420610">.</span><span class="ident" id="4420611">CommandNode</span>&nbsp;<span class="op" id="4420623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420626">return</span>&nbsp;<span class="op" id="4420633">&amp;</span><span class="ident" id="4420634">parse</span><span class="op" id="4420639">.</span><span class="ident" id="4420640">CommandNode</span><span class="op" id="4420651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4420655">NodeType</span><span class="op" id="4420663">:</span>&nbsp;<span class="ident" id="4420665">parse</span><span class="op" id="4420670">.</span><span class="ident" id="4420671">NodeCommand</span><span class="op" id="4420682">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4420686">Args</span><span class="op" id="4420690">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4420696">[</span><span class="op" id="4420697">]</span><span class="ident" id="4420698">parse</span><span class="op" id="4420703">.</span><span class="ident" id="4420704">Node</span><span class="op" id="4420708">{</span><span class="ident" id="4420709">parse</span><span class="op" id="4420714">.</span><span class="ident" id="4420715">NewIdentifier</span><span class="op" id="4420728">(</span><span class="ident" id="4420729">identifier</span><span class="op" id="4420739">)</span><span class="op" id="4420740">.</span><span class="ident" id="4420741">SetTree</span><span class="op" id="4420748">(</span><span class="ident" id="4420749">nil</span><span class="op" id="4420752">)</span><span class="op" id="4420753">.</span><span class="ident" id="4420754">SetPos</span><span class="op" id="4420760">(</span><span class="ident" id="4420761">pos</span><span class="op" id="4420764">)</span><span class="op" id="4420765">}</span><span class="op" id="4420766">,</span>&nbsp;<span class="comment" id="4420768">//&nbsp;TODO:&nbsp;SetTree.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4420787">}</span><br>
<span class="lineno"></span><span class="op" id="4420789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4420792">//&nbsp;nudge&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;would&nbsp;result&nbsp;from&nbsp;following&nbsp;empty&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4420867">//&nbsp;transitions&nbsp;from&nbsp;the&nbsp;input&nbsp;context.</span><br>
<span class="lineno">340</span><span class="comment" id="4420906">//&nbsp;For&nbsp;example,&nbsp;parsing:</span><br>
<span class="lineno"></span><span class="comment" id="4420931">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=`</span><br>
<span class="lineno"></span><span class="comment" id="4420949">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateBeforeValue,&nbsp;attrURL},&nbsp;but&nbsp;parsing&nbsp;one&nbsp;extra&nbsp;rune:</span><br>
<span class="lineno"></span><span class="comment" id="4421028">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=x`</span><br>
<span class="lineno"></span><span class="comment" id="4421047">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateURL,&nbsp;delimSpaceOrTagEnd,&nbsp;...}.</span><br>
<span class="lineno">345</span><span class="comment" id="4421106">//&nbsp;There&nbsp;are&nbsp;two&nbsp;transitions&nbsp;that&nbsp;happen&nbsp;when&nbsp;the&nbsp;&#39;x&#39;&nbsp;is&nbsp;seen:</span><br>
<span class="lineno"></span><span class="comment" id="4421169">//&nbsp;(1)&nbsp;Transition&nbsp;from&nbsp;a&nbsp;before-value&nbsp;state&nbsp;to&nbsp;a&nbsp;start-of-value&nbsp;state&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="4421247">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consuming&nbsp;any&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="4421279">//&nbsp;(2)&nbsp;Consume&nbsp;&#39;x&#39;&nbsp;and&nbsp;transition&nbsp;past&nbsp;the&nbsp;first&nbsp;value&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="4421345">//&nbsp;In&nbsp;this&nbsp;case,&nbsp;nudging&nbsp;produces&nbsp;the&nbsp;context&nbsp;after&nbsp;(1)&nbsp;happens.</span><br>
<span class="lineno">350</span><span class="keyword" id="4421410">func</span>&nbsp;<span class="ident" id="4421415">nudge</span><span class="op" id="4421420">(</span><span class="ident" id="4421421">c</span>&nbsp;<span class="ident" id="4421423">context</span><span class="op" id="4421430">)</span>&nbsp;<span class="ident" id="4421432">context</span>&nbsp;<span class="op" id="4421440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4421443">switch</span>&nbsp;<span class="ident" id="4421450">c</span><span class="op" id="4421451">.</span><span class="ident" id="4421452">state</span>&nbsp;<span class="op" id="4421458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4421461">case</span>&nbsp;<span class="ident" id="4421466">stateTag</span><span class="op" id="4421474">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4421478">//&nbsp;In&nbsp;`&lt;foo&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;should&nbsp;emit&nbsp;an&nbsp;attribute.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4421537">c</span><span class="op" id="4421538">.</span><span class="ident" id="4421539">state</span>&nbsp;<span class="op" id="4421545">=</span>&nbsp;<span class="ident" id="4421547">stateAttrName</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4421562">case</span>&nbsp;<span class="ident" id="4421567">stateBeforeValue</span><span class="op" id="4421583">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4421587">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar={{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;undelimited&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4421649">c</span><span class="op" id="4421650">.</span><span class="ident" id="4421651">state</span><span class="op" id="4421656">,</span>&nbsp;<span class="ident" id="4421658">c</span><span class="op" id="4421659">.</span><span class="ident" id="4421660">delim</span><span class="op" id="4421665">,</span>&nbsp;<span class="ident" id="4421667">c</span><span class="op" id="4421668">.</span><span class="ident" id="4421669">attr</span>&nbsp;<span class="op" id="4421674">=</span>&nbsp;<span class="ident" id="4421676">attrStartStates</span><span class="op" id="4421691">[</span><span class="ident" id="4421692">c</span><span class="op" id="4421693">.</span><span class="ident" id="4421694">attr</span><span class="op" id="4421698">]</span><span class="op" id="4421699">,</span>&nbsp;<span class="ident" id="4421701">delimSpaceOrTagEnd</span><span class="op" id="4421719">,</span>&nbsp;<span class="ident" id="4421721">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4421731">case</span>&nbsp;<span class="ident" id="4421736">stateAfterName</span><span class="op" id="4421750">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4421754">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;attribute&nbsp;name.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4421813">c</span><span class="op" id="4421814">.</span><span class="ident" id="4421815">state</span><span class="op" id="4421820">,</span>&nbsp;<span class="ident" id="4421822">c</span><span class="op" id="4421823">.</span><span class="ident" id="4421824">attr</span>&nbsp;<span class="op" id="4421829">=</span>&nbsp;<span class="ident" id="4421831">stateAttrName</span><span class="op" id="4421844">,</span>&nbsp;<span class="ident" id="4421846">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4421856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4421859">return</span>&nbsp;<span class="ident" id="4421866">c</span><br>
<span class="lineno"></span><span class="op" id="4421868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="4421871">//&nbsp;join&nbsp;joins&nbsp;the&nbsp;two&nbsp;contexts&nbsp;of&nbsp;a&nbsp;branch&nbsp;template&nbsp;node.&nbsp;The&nbsp;result&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4421946">//&nbsp;error&nbsp;context&nbsp;if&nbsp;either&nbsp;of&nbsp;the&nbsp;input&nbsp;contexts&nbsp;are&nbsp;error&nbsp;contexts,&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4422025">//&nbsp;the&nbsp;input&nbsp;contexts&nbsp;differ.</span><br>
<span class="lineno"></span><span class="keyword" id="4422055">func</span>&nbsp;<span class="ident" id="4422060">join</span><span class="op" id="4422064">(</span><span class="ident" id="4422065">a</span><span class="op" id="4422066">,</span>&nbsp;<span class="ident" id="4422068">b</span>&nbsp;<span class="ident" id="4422070">context</span><span class="op" id="4422077">,</span>&nbsp;<span class="ident" id="4422079">node</span>&nbsp;<span class="ident" id="4422084">parse</span><span class="op" id="4422089">.</span><span class="ident" id="4422090">Node</span><span class="op" id="4422094">,</span>&nbsp;<span class="ident" id="4422096">nodeName</span>&nbsp;<span class="builtintype" id="4422105">string</span><span class="op" id="4422111">)</span>&nbsp;<span class="ident" id="4422113">context</span>&nbsp;<span class="op" id="4422121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4422124">if</span>&nbsp;<span class="ident" id="4422127">a</span><span class="op" id="4422128">.</span><span class="ident" id="4422129">state</span>&nbsp;<span class="op" id="4422135">==</span>&nbsp;<span class="ident" id="4422138">stateError</span>&nbsp;<span class="op" id="4422149">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4422153">return</span>&nbsp;<span class="ident" id="4422160">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4422163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4422166">if</span>&nbsp;<span class="ident" id="4422169">b</span><span class="op" id="4422170">.</span><span class="ident" id="4422171">state</span>&nbsp;<span class="op" id="4422177">==</span>&nbsp;<span class="ident" id="4422180">stateError</span>&nbsp;<span class="op" id="4422191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4422195">return</span>&nbsp;<span class="ident" id="4422202">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4422205">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4422208">if</span>&nbsp;<span class="ident" id="4422211">a</span><span class="op" id="4422212">.</span><span class="ident" id="4422213">eq</span><span class="op" id="4422215">(</span><span class="ident" id="4422216">b</span><span class="op" id="4422217">)</span>&nbsp;<span class="op" id="4422219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4422223">return</span>&nbsp;<span class="ident" id="4422230">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4422233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4422237">c</span>&nbsp;<span class="op" id="4422239">:=</span>&nbsp;<span class="ident" id="4422242">a</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4422245">c</span><span class="op" id="4422246">.</span><span class="ident" id="4422247">urlPart</span>&nbsp;<span class="op" id="4422255">=</span>&nbsp;<span class="ident" id="4422257">b</span><span class="op" id="4422258">.</span><span class="ident" id="4422259">urlPart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4422268">if</span>&nbsp;<span class="ident" id="4422271">c</span><span class="op" id="4422272">.</span><span class="ident" id="4422273">eq</span><span class="op" id="4422275">(</span><span class="ident" id="4422276">b</span><span class="op" id="4422277">)</span>&nbsp;<span class="op" id="4422279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4422283">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;urlPart.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4422325">c</span><span class="op" id="4422326">.</span><span class="ident" id="4422327">urlPart</span>&nbsp;<span class="op" id="4422335">=</span>&nbsp;<span class="ident" id="4422337">urlPartUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4422354">return</span>&nbsp;<span class="ident" id="4422361">c</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4422364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4422368">c</span>&nbsp;<span class="op" id="4422370">=</span>&nbsp;<span class="ident" id="4422372">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4422375">c</span><span class="op" id="4422376">.</span><span class="ident" id="4422377">jsCtx</span>&nbsp;<span class="op" id="4422383">=</span>&nbsp;<span class="ident" id="4422385">b</span><span class="op" id="4422386">.</span><span class="ident" id="4422387">jsCtx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4422394">if</span>&nbsp;<span class="ident" id="4422397">c</span><span class="op" id="4422398">.</span><span class="ident" id="4422399">eq</span><span class="op" id="4422401">(</span><span class="ident" id="4422402">b</span><span class="op" id="4422403">)</span>&nbsp;<span class="op" id="4422405">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4422409">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;jsCtx.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4422449">c</span><span class="op" id="4422450">.</span><span class="ident" id="4422451">jsCtx</span>&nbsp;<span class="op" id="4422457">=</span>&nbsp;<span class="ident" id="4422459">jsCtxUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4422474">return</span>&nbsp;<span class="ident" id="4422481">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4422484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4422488">//&nbsp;Allow&nbsp;a&nbsp;nudged&nbsp;context&nbsp;to&nbsp;join&nbsp;with&nbsp;an&nbsp;unnudged&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4422545">//&nbsp;This&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4422565">//&nbsp;&nbsp;&nbsp;&lt;p&nbsp;title={{if&nbsp;.C}}{{.}}{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4422602">//&nbsp;ends&nbsp;in&nbsp;an&nbsp;unquoted&nbsp;value&nbsp;state&nbsp;even&nbsp;though&nbsp;the&nbsp;else&nbsp;branch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4422666">//&nbsp;ends&nbsp;in&nbsp;stateBeforeValue.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4422696">if</span>&nbsp;<span class="ident" id="4422699">c</span><span class="op" id="4422700">,</span>&nbsp;<span class="ident" id="4422702">d</span>&nbsp;<span class="op" id="4422704">:=</span>&nbsp;<span class="ident" id="4422707">nudge</span><span class="op" id="4422712">(</span><span class="ident" id="4422713">a</span><span class="op" id="4422714">)</span><span class="op" id="4422715">,</span>&nbsp;<span class="ident" id="4422717">nudge</span><span class="op" id="4422722">(</span><span class="ident" id="4422723">b</span><span class="op" id="4422724">)</span><span class="op" id="4422725">;</span>&nbsp;<span class="op" id="4422727">!</span><span class="op" id="4422728">(</span><span class="ident" id="4422729">c</span><span class="op" id="4422730">.</span><span class="ident" id="4422731">eq</span><span class="op" id="4422733">(</span><span class="ident" id="4422734">a</span><span class="op" id="4422735">)</span>&nbsp;<span class="op" id="4422737">&amp;&amp;</span>&nbsp;<span class="ident" id="4422740">d</span><span class="op" id="4422741">.</span><span class="ident" id="4422742">eq</span><span class="op" id="4422744">(</span><span class="ident" id="4422745">b</span><span class="op" id="4422746">)</span><span class="op" id="4422747">)</span>&nbsp;<span class="op" id="4422749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4422753">if</span>&nbsp;<span class="ident" id="4422756">e</span>&nbsp;<span class="op" id="4422758">:=</span>&nbsp;<span class="ident" id="4422761">join</span><span class="op" id="4422765">(</span><span class="ident" id="4422766">c</span><span class="op" id="4422767">,</span>&nbsp;<span class="ident" id="4422769">d</span><span class="op" id="4422770">,</span>&nbsp;<span class="ident" id="4422772">node</span><span class="op" id="4422776">,</span>&nbsp;<span class="ident" id="4422778">nodeName</span><span class="op" id="4422786">)</span><span class="op" id="4422787">;</span>&nbsp;<span class="ident" id="4422789">e</span><span class="op" id="4422790">.</span><span class="ident" id="4422791">state</span>&nbsp;<span class="op" id="4422797">!=</span>&nbsp;<span class="ident" id="4422800">stateError</span>&nbsp;<span class="op" id="4422811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4422816">return</span>&nbsp;<span class="ident" id="4422823">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4422827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4422830">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4422834">return</span>&nbsp;<span class="ident" id="4422841">context</span><span class="op" id="4422848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4422852">state</span><span class="op" id="4422857">:</span>&nbsp;<span class="ident" id="4422859">stateError</span><span class="op" id="4422869">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4422873">err</span><span class="op" id="4422876">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4422880">errorf</span><span class="op" id="4422886">(</span><span class="ident" id="4422887">ErrBranchEnd</span><span class="op" id="4422899">,</span>&nbsp;<span class="ident" id="4422901">node</span><span class="op" id="4422905">,</span>&nbsp;<span class="num" id="4422907">0</span><span class="op" id="4422908">,</span>&nbsp;<span class="string" id="4422910">&#34;{{%s}}&nbsp;branches&nbsp;end&nbsp;in&nbsp;different&nbsp;contexts:&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="4422961">,</span>&nbsp;<span class="ident" id="4422963">nodeName</span><span class="op" id="4422971">,</span>&nbsp;<span class="ident" id="4422973">a</span><span class="op" id="4422974">,</span>&nbsp;<span class="ident" id="4422976">b</span><span class="op" id="4422977">)</span><span class="op" id="4422978">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4422981">}</span><br>
<span class="lineno">410</span><span class="op" id="4422983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4422986">//&nbsp;escapeBranch&nbsp;escapes&nbsp;a&nbsp;branch&nbsp;template&nbsp;node:&nbsp;&#34;if&#34;,&nbsp;&#34;range&#34;&nbsp;and&nbsp;&#34;with&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4423060">func</span>&nbsp;<span class="op" id="4423065">(</span><span class="ident" id="4423066">e</span>&nbsp;<span class="op" id="4423068">*</span><span class="ident" id="4423069">escaper</span><span class="op" id="4423076">)</span>&nbsp;<span class="ident" id="4423078">escapeBranch</span><span class="op" id="4423090">(</span><span class="ident" id="4423091">c</span>&nbsp;<span class="ident" id="4423093">context</span><span class="op" id="4423100">,</span>&nbsp;<span class="ident" id="4423102">n</span>&nbsp;<span class="op" id="4423104">*</span><span class="ident" id="4423105">parse</span><span class="op" id="4423110">.</span><span class="ident" id="4423111">BranchNode</span><span class="op" id="4423121">,</span>&nbsp;<span class="ident" id="4423123">nodeName</span>&nbsp;<span class="builtintype" id="4423132">string</span><span class="op" id="4423138">)</span>&nbsp;<span class="ident" id="4423140">context</span>&nbsp;<span class="op" id="4423148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4423151">c0</span>&nbsp;<span class="op" id="4423154">:=</span>&nbsp;<span class="ident" id="4423157">e</span><span class="op" id="4423158">.</span><span class="ident" id="4423159">escapeList</span><span class="op" id="4423169">(</span><span class="ident" id="4423170">c</span><span class="op" id="4423171">,</span>&nbsp;<span class="ident" id="4423173">n</span><span class="op" id="4423174">.</span><span class="ident" id="4423175">List</span><span class="op" id="4423179">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4423182">if</span>&nbsp;<span class="ident" id="4423185">nodeName</span>&nbsp;<span class="op" id="4423194">==</span>&nbsp;<span class="string" id="4423197">&#34;range&#34;</span>&nbsp;<span class="op" id="4423205">&amp;&amp;</span>&nbsp;<span class="ident" id="4423208">c0</span><span class="op" id="4423210">.</span><span class="ident" id="4423211">state</span>&nbsp;<span class="op" id="4423217">!=</span>&nbsp;<span class="ident" id="4423220">stateError</span>&nbsp;<span class="op" id="4423231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4423235">//&nbsp;The&nbsp;&#34;true&#34;&nbsp;branch&nbsp;of&nbsp;a&nbsp;&#34;range&#34;&nbsp;node&nbsp;can&nbsp;execute&nbsp;multiple&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4423304">//&nbsp;We&nbsp;check&nbsp;that&nbsp;executing&nbsp;n.List&nbsp;once&nbsp;results&nbsp;in&nbsp;the&nbsp;same&nbsp;context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4423373">//&nbsp;as&nbsp;executing&nbsp;n.List&nbsp;twice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4423405">c1</span><span class="op" id="4423407">,</span>&nbsp;<span class="ident" id="4423409">_</span>&nbsp;<span class="op" id="4423411">:=</span>&nbsp;<span class="ident" id="4423414">e</span><span class="op" id="4423415">.</span><span class="ident" id="4423416">escapeListConditionally</span><span class="op" id="4423439">(</span><span class="ident" id="4423440">c0</span><span class="op" id="4423442">,</span>&nbsp;<span class="ident" id="4423444">n</span><span class="op" id="4423445">.</span><span class="ident" id="4423446">List</span><span class="op" id="4423450">,</span>&nbsp;<span class="ident" id="4423452">nil</span><span class="op" id="4423455">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4423459">c0</span>&nbsp;<span class="op" id="4423462">=</span>&nbsp;<span class="ident" id="4423464">join</span><span class="op" id="4423468">(</span><span class="ident" id="4423469">c0</span><span class="op" id="4423471">,</span>&nbsp;<span class="ident" id="4423473">c1</span><span class="op" id="4423475">,</span>&nbsp;<span class="ident" id="4423477">n</span><span class="op" id="4423478">,</span>&nbsp;<span class="ident" id="4423480">nodeName</span><span class="op" id="4423488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4423492">if</span>&nbsp;<span class="ident" id="4423495">c0</span><span class="op" id="4423497">.</span><span class="ident" id="4423498">state</span>&nbsp;<span class="op" id="4423504">==</span>&nbsp;<span class="ident" id="4423507">stateError</span>&nbsp;<span class="op" id="4423518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4423523">//&nbsp;Make&nbsp;clear&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;problem&nbsp;on&nbsp;loop&nbsp;re-entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4423580">//&nbsp;since&nbsp;developers&nbsp;tend&nbsp;to&nbsp;overlook&nbsp;that&nbsp;branch&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4423637">//&nbsp;debugging&nbsp;templates.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4423664">c0</span><span class="op" id="4423666">.</span><span class="ident" id="4423667">err</span><span class="op" id="4423670">.</span><span class="ident" id="4423671">Line</span>&nbsp;<span class="op" id="4423676">=</span>&nbsp;<span class="ident" id="4423678">n</span><span class="op" id="4423679">.</span><span class="ident" id="4423680">Line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4423688">c0</span><span class="op" id="4423690">.</span><span class="ident" id="4423691">err</span><span class="op" id="4423694">.</span><span class="ident" id="4423695">Description</span>&nbsp;<span class="op" id="4423707">=</span>&nbsp;<span class="string" id="4423709">&#34;on&nbsp;range&nbsp;loop&nbsp;re-entry:&nbsp;&#34;</span>&nbsp;<span class="op" id="4423736">+</span>&nbsp;<span class="ident" id="4423738">c0</span><span class="op" id="4423740">.</span><span class="ident" id="4423741">err</span><span class="op" id="4423744">.</span><span class="ident" id="4423745">Description</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4423760">return</span>&nbsp;<span class="ident" id="4423767">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4423772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4423775">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4423778">c1</span>&nbsp;<span class="op" id="4423781">:=</span>&nbsp;<span class="ident" id="4423784">e</span><span class="op" id="4423785">.</span><span class="ident" id="4423786">escapeList</span><span class="op" id="4423796">(</span><span class="ident" id="4423797">c</span><span class="op" id="4423798">,</span>&nbsp;<span class="ident" id="4423800">n</span><span class="op" id="4423801">.</span><span class="ident" id="4423802">ElseList</span><span class="op" id="4423810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4423813">return</span>&nbsp;<span class="ident" id="4423820">join</span><span class="op" id="4423824">(</span><span class="ident" id="4423825">c0</span><span class="op" id="4423827">,</span>&nbsp;<span class="ident" id="4423829">c1</span><span class="op" id="4423831">,</span>&nbsp;<span class="ident" id="4423833">n</span><span class="op" id="4423834">,</span>&nbsp;<span class="ident" id="4423836">nodeName</span><span class="op" id="4423844">)</span><br>
<span class="lineno"></span><span class="op" id="4423846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4423849">//&nbsp;escapeList&nbsp;escapes&nbsp;a&nbsp;list&nbsp;template&nbsp;node.</span><br>
<span class="lineno">435</span><span class="keyword" id="4423893">func</span>&nbsp;<span class="op" id="4423898">(</span><span class="ident" id="4423899">e</span>&nbsp;<span class="op" id="4423901">*</span><span class="ident" id="4423902">escaper</span><span class="op" id="4423909">)</span>&nbsp;<span class="ident" id="4423911">escapeList</span><span class="op" id="4423921">(</span><span class="ident" id="4423922">c</span>&nbsp;<span class="ident" id="4423924">context</span><span class="op" id="4423931">,</span>&nbsp;<span class="ident" id="4423933">n</span>&nbsp;<span class="op" id="4423935">*</span><span class="ident" id="4423936">parse</span><span class="op" id="4423941">.</span><span class="ident" id="4423942">ListNode</span><span class="op" id="4423950">)</span>&nbsp;<span class="ident" id="4423952">context</span>&nbsp;<span class="op" id="4423960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4423963">if</span>&nbsp;<span class="ident" id="4423966">n</span>&nbsp;<span class="op" id="4423968">==</span>&nbsp;<span class="ident" id="4423971">nil</span>&nbsp;<span class="op" id="4423975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4423979">return</span>&nbsp;<span class="ident" id="4423986">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4423989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4423992">for</span>&nbsp;<span class="ident" id="4423996">_</span><span class="op" id="4423997">,</span>&nbsp;<span class="ident" id="4423999">m</span>&nbsp;<span class="op" id="4424001">:=</span>&nbsp;<span class="keyword" id="4424004">range</span>&nbsp;<span class="ident" id="4424010">n</span><span class="op" id="4424011">.</span><span class="ident" id="4424012">Nodes</span>&nbsp;<span class="op" id="4424018">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4424022">c</span>&nbsp;<span class="op" id="4424024">=</span>&nbsp;<span class="ident" id="4424026">e</span><span class="op" id="4424027">.</span><span class="ident" id="4424028">escape</span><span class="op" id="4424034">(</span><span class="ident" id="4424035">c</span><span class="op" id="4424036">,</span>&nbsp;<span class="ident" id="4424038">m</span><span class="op" id="4424039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4424042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4424045">return</span>&nbsp;<span class="ident" id="4424052">c</span><br>
<span class="lineno"></span><span class="op" id="4424054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="4424057">//&nbsp;escapeListConditionally&nbsp;escapes&nbsp;a&nbsp;list&nbsp;node&nbsp;but&nbsp;only&nbsp;preserves&nbsp;edits&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4424133">//&nbsp;inferences&nbsp;in&nbsp;e&nbsp;if&nbsp;the&nbsp;inferences&nbsp;and&nbsp;output&nbsp;context&nbsp;satisfy&nbsp;filter.</span><br>
<span class="lineno"></span><span class="comment" id="4424205">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;an&nbsp;output&nbsp;context,&nbsp;and&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;filter</span><br>
<span class="lineno"></span><span class="comment" id="4424285">//&nbsp;which&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;whether&nbsp;e&nbsp;was&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="4424332">func</span>&nbsp;<span class="op" id="4424337">(</span><span class="ident" id="4424338">e</span>&nbsp;<span class="op" id="4424340">*</span><span class="ident" id="4424341">escaper</span><span class="op" id="4424348">)</span>&nbsp;<span class="ident" id="4424350">escapeListConditionally</span><span class="op" id="4424373">(</span><span class="ident" id="4424374">c</span>&nbsp;<span class="ident" id="4424376">context</span><span class="op" id="4424383">,</span>&nbsp;<span class="ident" id="4424385">n</span>&nbsp;<span class="op" id="4424387">*</span><span class="ident" id="4424388">parse</span><span class="op" id="4424393">.</span><span class="ident" id="4424394">ListNode</span><span class="op" id="4424402">,</span>&nbsp;<span class="ident" id="4424404">filter</span>&nbsp;<span class="keyword" id="4424411">func</span><span class="op" id="4424415">(</span><span class="op" id="4424416">*</span><span class="ident" id="4424417">escaper</span><span class="op" id="4424424">,</span>&nbsp;<span class="ident" id="4424426">context</span><span class="op" id="4424433">)</span>&nbsp;<span class="builtintype" id="4424435">bool</span><span class="op" id="4424439">)</span>&nbsp;<span class="op" id="4424441">(</span><span class="ident" id="4424442">context</span><span class="op" id="4424449">,</span>&nbsp;<span class="builtintype" id="4424451">bool</span><span class="op" id="4424455">)</span>&nbsp;<span class="op" id="4424457">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4424460">e1</span>&nbsp;<span class="op" id="4424463">:=</span>&nbsp;<span class="ident" id="4424466">newEscaper</span><span class="op" id="4424476">(</span><span class="ident" id="4424477">e</span><span class="op" id="4424478">.</span><span class="ident" id="4424479">tmpl</span><span class="op" id="4424483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4424486">//&nbsp;Make&nbsp;type&nbsp;inferences&nbsp;available&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4424527">for</span>&nbsp;<span class="ident" id="4424531">k</span><span class="op" id="4424532">,</span>&nbsp;<span class="ident" id="4424534">v</span>&nbsp;<span class="op" id="4424536">:=</span>&nbsp;<span class="keyword" id="4424539">range</span>&nbsp;<span class="ident" id="4424545">e</span><span class="op" id="4424546">.</span><span class="ident" id="4424547">output</span>&nbsp;<span class="op" id="4424554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4424558">e1</span><span class="op" id="4424560">.</span><span class="ident" id="4424561">output</span><span class="op" id="4424567">[</span><span class="ident" id="4424568">k</span><span class="op" id="4424569">]</span>&nbsp;<span class="op" id="4424571">=</span>&nbsp;<span class="ident" id="4424573">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4424576">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4424579">c</span>&nbsp;<span class="op" id="4424581">=</span>&nbsp;<span class="ident" id="4424583">e1</span><span class="op" id="4424585">.</span><span class="ident" id="4424586">escapeList</span><span class="op" id="4424596">(</span><span class="ident" id="4424597">c</span><span class="op" id="4424598">,</span>&nbsp;<span class="ident" id="4424600">n</span><span class="op" id="4424601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4424604">ok</span>&nbsp;<span class="op" id="4424607">:=</span>&nbsp;<span class="ident" id="4424610">filter</span>&nbsp;<span class="op" id="4424617">!=</span>&nbsp;<span class="ident" id="4424620">nil</span>&nbsp;<span class="op" id="4424624">&amp;&amp;</span>&nbsp;<span class="ident" id="4424627">filter</span><span class="op" id="4424633">(</span><span class="ident" id="4424634">e1</span><span class="op" id="4424636">,</span>&nbsp;<span class="ident" id="4424638">c</span><span class="op" id="4424639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4424642">if</span>&nbsp;<span class="ident" id="4424645">ok</span>&nbsp;<span class="op" id="4424648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4424652">//&nbsp;Copy&nbsp;inferences&nbsp;and&nbsp;edits&nbsp;from&nbsp;e1&nbsp;back&nbsp;into&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4424704">for</span>&nbsp;<span class="ident" id="4424708">k</span><span class="op" id="4424709">,</span>&nbsp;<span class="ident" id="4424711">v</span>&nbsp;<span class="op" id="4424713">:=</span>&nbsp;<span class="keyword" id="4424716">range</span>&nbsp;<span class="ident" id="4424722">e1</span><span class="op" id="4424724">.</span><span class="ident" id="4424725">output</span>&nbsp;<span class="op" id="4424732">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4424737">e</span><span class="op" id="4424738">.</span><span class="ident" id="4424739">output</span><span class="op" id="4424745">[</span><span class="ident" id="4424746">k</span><span class="op" id="4424747">]</span>&nbsp;<span class="op" id="4424749">=</span>&nbsp;<span class="ident" id="4424751">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4424755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4424759">for</span>&nbsp;<span class="ident" id="4424763">k</span><span class="op" id="4424764">,</span>&nbsp;<span class="ident" id="4424766">v</span>&nbsp;<span class="op" id="4424768">:=</span>&nbsp;<span class="keyword" id="4424771">range</span>&nbsp;<span class="ident" id="4424777">e1</span><span class="op" id="4424779">.</span><span class="ident" id="4424780">derived</span>&nbsp;<span class="op" id="4424788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4424793">e</span><span class="op" id="4424794">.</span><span class="ident" id="4424795">derived</span><span class="op" id="4424802">[</span><span class="ident" id="4424803">k</span><span class="op" id="4424804">]</span>&nbsp;<span class="op" id="4424806">=</span>&nbsp;<span class="ident" id="4424808">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4424812">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4424816">for</span>&nbsp;<span class="ident" id="4424820">k</span><span class="op" id="4424821">,</span>&nbsp;<span class="ident" id="4424823">v</span>&nbsp;<span class="op" id="4424825">:=</span>&nbsp;<span class="keyword" id="4424828">range</span>&nbsp;<span class="ident" id="4424834">e1</span><span class="op" id="4424836">.</span><span class="ident" id="4424837">called</span>&nbsp;<span class="op" id="4424844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4424849">e</span><span class="op" id="4424850">.</span><span class="ident" id="4424851">called</span><span class="op" id="4424857">[</span><span class="ident" id="4424858">k</span><span class="op" id="4424859">]</span>&nbsp;<span class="op" id="4424861">=</span>&nbsp;<span class="ident" id="4424863">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4424867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4424871">for</span>&nbsp;<span class="ident" id="4424875">k</span><span class="op" id="4424876">,</span>&nbsp;<span class="ident" id="4424878">v</span>&nbsp;<span class="op" id="4424880">:=</span>&nbsp;<span class="keyword" id="4424883">range</span>&nbsp;<span class="ident" id="4424889">e1</span><span class="op" id="4424891">.</span><span class="ident" id="4424892">actionNodeEdits</span>&nbsp;<span class="op" id="4424908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4424913">e</span><span class="op" id="4424914">.</span><span class="ident" id="4424915">editActionNode</span><span class="op" id="4424929">(</span><span class="ident" id="4424930">k</span><span class="op" id="4424931">,</span>&nbsp;<span class="ident" id="4424933">v</span><span class="op" id="4424934">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4424938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4424942">for</span>&nbsp;<span class="ident" id="4424946">k</span><span class="op" id="4424947">,</span>&nbsp;<span class="ident" id="4424949">v</span>&nbsp;<span class="op" id="4424951">:=</span>&nbsp;<span class="keyword" id="4424954">range</span>&nbsp;<span class="ident" id="4424960">e1</span><span class="op" id="4424962">.</span><span class="ident" id="4424963">templateNodeEdits</span>&nbsp;<span class="op" id="4424981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4424986">e</span><span class="op" id="4424987">.</span><span class="ident" id="4424988">editTemplateNode</span><span class="op" id="4425004">(</span><span class="ident" id="4425005">k</span><span class="op" id="4425006">,</span>&nbsp;<span class="ident" id="4425008">v</span><span class="op" id="4425009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4425013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4425017">for</span>&nbsp;<span class="ident" id="4425021">k</span><span class="op" id="4425022">,</span>&nbsp;<span class="ident" id="4425024">v</span>&nbsp;<span class="op" id="4425026">:=</span>&nbsp;<span class="keyword" id="4425029">range</span>&nbsp;<span class="ident" id="4425035">e1</span><span class="op" id="4425037">.</span><span class="ident" id="4425038">textNodeEdits</span>&nbsp;<span class="op" id="4425052">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4425057">e</span><span class="op" id="4425058">.</span><span class="ident" id="4425059">editTextNode</span><span class="op" id="4425071">(</span><span class="ident" id="4425072">k</span><span class="op" id="4425073">,</span>&nbsp;<span class="ident" id="4425075">v</span><span class="op" id="4425076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4425080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4425083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4425086">return</span>&nbsp;<span class="ident" id="4425093">c</span><span class="op" id="4425094">,</span>&nbsp;<span class="ident" id="4425096">ok</span><br>
<span class="lineno"></span><span class="op" id="4425099">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="4425102">//&nbsp;escapeTemplate&nbsp;escapes&nbsp;a&nbsp;{{template}}&nbsp;call&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4425154">func</span>&nbsp;<span class="op" id="4425159">(</span><span class="ident" id="4425160">e</span>&nbsp;<span class="op" id="4425162">*</span><span class="ident" id="4425163">escaper</span><span class="op" id="4425170">)</span>&nbsp;<span class="ident" id="4425172">escapeTemplate</span><span class="op" id="4425186">(</span><span class="ident" id="4425187">c</span>&nbsp;<span class="ident" id="4425189">context</span><span class="op" id="4425196">,</span>&nbsp;<span class="ident" id="4425198">n</span>&nbsp;<span class="op" id="4425200">*</span><span class="ident" id="4425201">parse</span><span class="op" id="4425206">.</span><span class="ident" id="4425207">TemplateNode</span><span class="op" id="4425219">)</span>&nbsp;<span class="ident" id="4425221">context</span>&nbsp;<span class="op" id="4425229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4425232">c</span><span class="op" id="4425233">,</span>&nbsp;<span class="ident" id="4425235">name</span>&nbsp;<span class="op" id="4425240">:=</span>&nbsp;<span class="ident" id="4425243">e</span><span class="op" id="4425244">.</span><span class="ident" id="4425245">escapeTree</span><span class="op" id="4425255">(</span><span class="ident" id="4425256">c</span><span class="op" id="4425257">,</span>&nbsp;<span class="ident" id="4425259">n</span><span class="op" id="4425260">,</span>&nbsp;<span class="ident" id="4425262">n</span><span class="op" id="4425263">.</span><span class="ident" id="4425264">Name</span><span class="op" id="4425268">,</span>&nbsp;<span class="ident" id="4425270">n</span><span class="op" id="4425271">.</span><span class="ident" id="4425272">Line</span><span class="op" id="4425276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4425279">if</span>&nbsp;<span class="ident" id="4425282">name</span>&nbsp;<span class="op" id="4425287">!=</span>&nbsp;<span class="ident" id="4425290">n</span><span class="op" id="4425291">.</span><span class="ident" id="4425292">Name</span>&nbsp;<span class="op" id="4425297">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4425301">e</span><span class="op" id="4425302">.</span><span class="ident" id="4425303">editTemplateNode</span><span class="op" id="4425319">(</span><span class="ident" id="4425320">n</span><span class="op" id="4425321">,</span>&nbsp;<span class="ident" id="4425323">name</span><span class="op" id="4425327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4425330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4425333">return</span>&nbsp;<span class="ident" id="4425340">c</span><br>
<span class="lineno"></span><span class="op" id="4425342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="comment" id="4425345">//&nbsp;escapeTree&nbsp;escapes&nbsp;the&nbsp;named&nbsp;template&nbsp;starting&nbsp;in&nbsp;the&nbsp;given&nbsp;context&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="4425419">//&nbsp;necessary&nbsp;and&nbsp;returns&nbsp;its&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="4425464">func</span>&nbsp;<span class="op" id="4425469">(</span><span class="ident" id="4425470">e</span>&nbsp;<span class="op" id="4425472">*</span><span class="ident" id="4425473">escaper</span><span class="op" id="4425480">)</span>&nbsp;<span class="ident" id="4425482">escapeTree</span><span class="op" id="4425492">(</span><span class="ident" id="4425493">c</span>&nbsp;<span class="ident" id="4425495">context</span><span class="op" id="4425502">,</span>&nbsp;<span class="ident" id="4425504">node</span>&nbsp;<span class="ident" id="4425509">parse</span><span class="op" id="4425514">.</span><span class="ident" id="4425515">Node</span><span class="op" id="4425519">,</span>&nbsp;<span class="ident" id="4425521">name</span>&nbsp;<span class="builtintype" id="4425526">string</span><span class="op" id="4425532">,</span>&nbsp;<span class="ident" id="4425534">line</span>&nbsp;<span class="builtintype" id="4425539">int</span><span class="op" id="4425542">)</span>&nbsp;<span class="op" id="4425544">(</span><span class="ident" id="4425545">context</span><span class="op" id="4425552">,</span>&nbsp;<span class="builtintype" id="4425554">string</span><span class="op" id="4425560">)</span>&nbsp;<span class="op" id="4425562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4425565">//&nbsp;Mangle&nbsp;the&nbsp;template&nbsp;name&nbsp;with&nbsp;the&nbsp;input&nbsp;context&nbsp;to&nbsp;produce&nbsp;a&nbsp;reliable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4425639">//&nbsp;identifier.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4425655">dname</span>&nbsp;<span class="op" id="4425661">:=</span>&nbsp;<span class="ident" id="4425664">c</span><span class="op" id="4425665">.</span><span class="ident" id="4425666">mangle</span><span class="op" id="4425672">(</span><span class="ident" id="4425673">name</span><span class="op" id="4425677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4425680">e</span><span class="op" id="4425681">.</span><span class="ident" id="4425682">called</span><span class="op" id="4425688">[</span><span class="ident" id="4425689">dname</span><span class="op" id="4425694">]</span>&nbsp;<span class="op" id="4425696">=</span>&nbsp;<span class="ident" id="4425698">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4425704">if</span>&nbsp;<span class="ident" id="4425707">out</span><span class="op" id="4425710">,</span>&nbsp;<span class="ident" id="4425712">ok</span>&nbsp;<span class="op" id="4425715">:=</span>&nbsp;<span class="ident" id="4425718">e</span><span class="op" id="4425719">.</span><span class="ident" id="4425720">output</span><span class="op" id="4425726">[</span><span class="ident" id="4425727">dname</span><span class="op" id="4425732">]</span><span class="op" id="4425733">;</span>&nbsp;<span class="ident" id="4425735">ok</span>&nbsp;<span class="op" id="4425738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4425742">//&nbsp;Already&nbsp;escaped.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4425764">return</span>&nbsp;<span class="ident" id="4425771">out</span><span class="op" id="4425774">,</span>&nbsp;<span class="ident" id="4425776">dname</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4425783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4425786">t</span>&nbsp;<span class="op" id="4425788">:=</span>&nbsp;<span class="ident" id="4425791">e</span><span class="op" id="4425792">.</span><span class="ident" id="4425793">template</span><span class="op" id="4425801">(</span><span class="ident" id="4425802">name</span><span class="op" id="4425806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4425809">if</span>&nbsp;<span class="ident" id="4425812">t</span>&nbsp;<span class="op" id="4425814">==</span>&nbsp;<span class="ident" id="4425817">nil</span>&nbsp;<span class="op" id="4425821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4425825">//&nbsp;Two&nbsp;cases:&nbsp;The&nbsp;template&nbsp;exists&nbsp;but&nbsp;is&nbsp;empty,&nbsp;or&nbsp;has&nbsp;never&nbsp;been&nbsp;mentioned&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4425906">//&nbsp;all.&nbsp;Distinguish&nbsp;the&nbsp;cases&nbsp;in&nbsp;the&nbsp;error&nbsp;messages.</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4425961">if</span>&nbsp;<span class="ident" id="4425964">e</span><span class="op" id="4425965">.</span><span class="ident" id="4425966">tmpl</span><span class="op" id="4425970">.</span><span class="ident" id="4425971">set</span><span class="op" id="4425974">[</span><span class="ident" id="4425975">name</span><span class="op" id="4425979">]</span>&nbsp;<span class="op" id="4425981">!=</span>&nbsp;<span class="ident" id="4425984">nil</span>&nbsp;<span class="op" id="4425988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4425993">return</span>&nbsp;<span class="ident" id="4426000">context</span><span class="op" id="4426007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4426013">state</span><span class="op" id="4426018">:</span>&nbsp;<span class="ident" id="4426020">stateError</span><span class="op" id="4426030">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4426036">err</span><span class="op" id="4426039">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4426043">errorf</span><span class="op" id="4426049">(</span><span class="ident" id="4426050">ErrNoSuchTemplate</span><span class="op" id="4426067">,</span>&nbsp;<span class="ident" id="4426069">node</span><span class="op" id="4426073">,</span>&nbsp;<span class="ident" id="4426075">line</span><span class="op" id="4426079">,</span>&nbsp;<span class="string" id="4426081">&#34;%q&nbsp;is&nbsp;an&nbsp;incomplete&nbsp;or&nbsp;empty&nbsp;template&#34;</span><span class="op" id="4426120">,</span>&nbsp;<span class="ident" id="4426122">name</span><span class="op" id="4426126">)</span><span class="op" id="4426127">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4426132">}</span><span class="op" id="4426133">,</span>&nbsp;<span class="ident" id="4426135">dname</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4426143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4426147">return</span>&nbsp;<span class="ident" id="4426154">context</span><span class="op" id="4426161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4426166">state</span><span class="op" id="4426171">:</span>&nbsp;<span class="ident" id="4426173">stateError</span><span class="op" id="4426183">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4426188">err</span><span class="op" id="4426191">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4426195">errorf</span><span class="op" id="4426201">(</span><span class="ident" id="4426202">ErrNoSuchTemplate</span><span class="op" id="4426219">,</span>&nbsp;<span class="ident" id="4426221">node</span><span class="op" id="4426225">,</span>&nbsp;<span class="ident" id="4426227">line</span><span class="op" id="4426231">,</span>&nbsp;<span class="string" id="4426233">&#34;no&nbsp;such&nbsp;template&nbsp;%q&#34;</span><span class="op" id="4426254">,</span>&nbsp;<span class="ident" id="4426256">name</span><span class="op" id="4426260">)</span><span class="op" id="4426261">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4426265">}</span><span class="op" id="4426266">,</span>&nbsp;<span class="ident" id="4426268">dname</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4426275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4426278">if</span>&nbsp;<span class="ident" id="4426281">dname</span>&nbsp;<span class="op" id="4426287">!=</span>&nbsp;<span class="ident" id="4426290">name</span>&nbsp;<span class="op" id="4426295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4426299">//&nbsp;Use&nbsp;any&nbsp;template&nbsp;derived&nbsp;during&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;escapeTemplate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4426370">//&nbsp;with&nbsp;different&nbsp;top&nbsp;level&nbsp;templates,&nbsp;or&nbsp;clone&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4426434">dt</span>&nbsp;<span class="op" id="4426437">:=</span>&nbsp;<span class="ident" id="4426440">e</span><span class="op" id="4426441">.</span><span class="ident" id="4426442">template</span><span class="op" id="4426450">(</span><span class="ident" id="4426451">dname</span><span class="op" id="4426456">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4426460">if</span>&nbsp;<span class="ident" id="4426463">dt</span>&nbsp;<span class="op" id="4426466">==</span>&nbsp;<span class="ident" id="4426469">nil</span>&nbsp;<span class="op" id="4426473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4426478">dt</span>&nbsp;<span class="op" id="4426481">=</span>&nbsp;<span class="ident" id="4426483">template</span><span class="op" id="4426491">.</span><span class="ident" id="4426492">New</span><span class="op" id="4426495">(</span><span class="ident" id="4426496">dname</span><span class="op" id="4426501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4426506">dt</span><span class="op" id="4426508">.</span><span class="ident" id="4426509">Tree</span>&nbsp;<span class="op" id="4426514">=</span>&nbsp;<span class="op" id="4426516">&amp;</span><span class="ident" id="4426517">parse</span><span class="op" id="4426522">.</span><span class="ident" id="4426523">Tree</span><span class="op" id="4426527">{</span><span class="ident" id="4426528">Name</span><span class="op" id="4426532">:</span>&nbsp;<span class="ident" id="4426534">dname</span><span class="op" id="4426539">,</span>&nbsp;<span class="ident" id="4426541">Root</span><span class="op" id="4426545">:</span>&nbsp;<span class="ident" id="4426547">t</span><span class="op" id="4426548">.</span><span class="ident" id="4426549">Root</span><span class="op" id="4426553">.</span><span class="ident" id="4426554">CopyList</span><span class="op" id="4426562">(</span><span class="op" id="4426563">)</span><span class="op" id="4426564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4426569">e</span><span class="op" id="4426570">.</span><span class="ident" id="4426571">derived</span><span class="op" id="4426578">[</span><span class="ident" id="4426579">dname</span><span class="op" id="4426584">]</span>&nbsp;<span class="op" id="4426586">=</span>&nbsp;<span class="ident" id="4426588">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4426593">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4426597">t</span>&nbsp;<span class="op" id="4426599">=</span>&nbsp;<span class="ident" id="4426601">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4426605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4426608">return</span>&nbsp;<span class="ident" id="4426615">e</span><span class="op" id="4426616">.</span><span class="ident" id="4426617">computeOutCtx</span><span class="op" id="4426630">(</span><span class="ident" id="4426631">c</span><span class="op" id="4426632">,</span>&nbsp;<span class="ident" id="4426634">t</span><span class="op" id="4426635">)</span><span class="op" id="4426636">,</span>&nbsp;<span class="ident" id="4426638">dname</span><br>
<span class="lineno"></span><span class="op" id="4426644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="comment" id="4426647">//&nbsp;computeOutCtx&nbsp;takes&nbsp;a&nbsp;template&nbsp;and&nbsp;its&nbsp;start&nbsp;context&nbsp;and&nbsp;computes&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="4426727">//&nbsp;context&nbsp;while&nbsp;storing&nbsp;any&nbsp;inferences&nbsp;in&nbsp;e.</span><br>
<span class="lineno"></span><span class="keyword" id="4426773">func</span>&nbsp;<span class="op" id="4426778">(</span><span class="ident" id="4426779">e</span>&nbsp;<span class="op" id="4426781">*</span><span class="ident" id="4426782">escaper</span><span class="op" id="4426789">)</span>&nbsp;<span class="ident" id="4426791">computeOutCtx</span><span class="op" id="4426804">(</span><span class="ident" id="4426805">c</span>&nbsp;<span class="ident" id="4426807">context</span><span class="op" id="4426814">,</span>&nbsp;<span class="ident" id="4426816">t</span>&nbsp;<span class="op" id="4426818">*</span><span class="ident" id="4426819">template</span><span class="op" id="4426827">.</span><span class="ident" id="4426828">Template</span><span class="op" id="4426836">)</span>&nbsp;<span class="ident" id="4426838">context</span>&nbsp;<span class="op" id="4426846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4426849">//&nbsp;Propagate&nbsp;context&nbsp;over&nbsp;the&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4426886">c1</span><span class="op" id="4426888">,</span>&nbsp;<span class="ident" id="4426890">ok</span>&nbsp;<span class="op" id="4426893">:=</span>&nbsp;<span class="ident" id="4426896">e</span><span class="op" id="4426897">.</span><span class="ident" id="4426898">escapeTemplateBody</span><span class="op" id="4426916">(</span><span class="ident" id="4426917">c</span><span class="op" id="4426918">,</span>&nbsp;<span class="ident" id="4426920">t</span><span class="op" id="4426921">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4426924">if</span>&nbsp;<span class="op" id="4426927">!</span><span class="ident" id="4426928">ok</span>&nbsp;<span class="op" id="4426931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4426935">//&nbsp;Look&nbsp;for&nbsp;a&nbsp;fixed&nbsp;point&nbsp;by&nbsp;assuming&nbsp;c1&nbsp;as&nbsp;the&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4427001">if</span>&nbsp;<span class="ident" id="4427004">c2</span><span class="op" id="4427006">,</span>&nbsp;<span class="ident" id="4427008">ok2</span>&nbsp;<span class="op" id="4427012">:=</span>&nbsp;<span class="ident" id="4427015">e</span><span class="op" id="4427016">.</span><span class="ident" id="4427017">escapeTemplateBody</span><span class="op" id="4427035">(</span><span class="ident" id="4427036">c1</span><span class="op" id="4427038">,</span>&nbsp;<span class="ident" id="4427040">t</span><span class="op" id="4427041">)</span><span class="op" id="4427042">;</span>&nbsp;<span class="ident" id="4427044">ok2</span>&nbsp;<span class="op" id="4427048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4427053">c1</span><span class="op" id="4427055">,</span>&nbsp;<span class="ident" id="4427057">ok</span>&nbsp;<span class="op" id="4427060">=</span>&nbsp;<span class="ident" id="4427062">c2</span><span class="op" id="4427064">,</span>&nbsp;<span class="ident" id="4427066">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4427073">}</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4427077">//&nbsp;Use&nbsp;c1&nbsp;as&nbsp;the&nbsp;error&nbsp;context&nbsp;if&nbsp;neither&nbsp;assumption&nbsp;worked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4427139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4427142">if</span>&nbsp;<span class="op" id="4427145">!</span><span class="ident" id="4427146">ok</span>&nbsp;<span class="op" id="4427149">&amp;&amp;</span>&nbsp;<span class="ident" id="4427152">c1</span><span class="op" id="4427154">.</span><span class="ident" id="4427155">state</span>&nbsp;<span class="op" id="4427161">!=</span>&nbsp;<span class="ident" id="4427164">stateError</span>&nbsp;<span class="op" id="4427175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4427179">return</span>&nbsp;<span class="ident" id="4427186">context</span><span class="op" id="4427193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4427198">state</span><span class="op" id="4427203">:</span>&nbsp;<span class="ident" id="4427205">stateError</span><span class="op" id="4427215">,</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4427220">err</span><span class="op" id="4427223">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4427227">errorf</span><span class="op" id="4427233">(</span><span class="ident" id="4427234">ErrOutputContext</span><span class="op" id="4427250">,</span>&nbsp;<span class="ident" id="4427252">t</span><span class="op" id="4427253">.</span><span class="ident" id="4427254">Tree</span><span class="op" id="4427258">.</span><span class="ident" id="4427259">Root</span><span class="op" id="4427263">,</span>&nbsp;<span class="num" id="4427265">0</span><span class="op" id="4427266">,</span>&nbsp;<span class="string" id="4427268">&#34;cannot&nbsp;compute&nbsp;output&nbsp;context&nbsp;for&nbsp;template&nbsp;%s&#34;</span><span class="op" id="4427315">,</span>&nbsp;<span class="ident" id="4427317">t</span><span class="op" id="4427318">.</span><span class="ident" id="4427319">Name</span><span class="op" id="4427323">(</span><span class="op" id="4427324">)</span><span class="op" id="4427325">)</span><span class="op" id="4427326">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4427330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4427333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4427336">return</span>&nbsp;<span class="ident" id="4427343">c1</span><br>
<span class="lineno"></span><span class="op" id="4427346">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="4427349">//&nbsp;escapeTemplateBody&nbsp;escapes&nbsp;the&nbsp;given&nbsp;template&nbsp;assuming&nbsp;the&nbsp;given&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="4427424">//&nbsp;context,&nbsp;and&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;the&nbsp;output&nbsp;context&nbsp;and&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4427501">//&nbsp;assumption&nbsp;was&nbsp;correct.</span><br>
<span class="lineno"></span><span class="keyword" id="4427528">func</span>&nbsp;<span class="op" id="4427533">(</span><span class="ident" id="4427534">e</span>&nbsp;<span class="op" id="4427536">*</span><span class="ident" id="4427537">escaper</span><span class="op" id="4427544">)</span>&nbsp;<span class="ident" id="4427546">escapeTemplateBody</span><span class="op" id="4427564">(</span><span class="ident" id="4427565">c</span>&nbsp;<span class="ident" id="4427567">context</span><span class="op" id="4427574">,</span>&nbsp;<span class="ident" id="4427576">t</span>&nbsp;<span class="op" id="4427578">*</span><span class="ident" id="4427579">template</span><span class="op" id="4427587">.</span><span class="ident" id="4427588">Template</span><span class="op" id="4427596">)</span>&nbsp;<span class="op" id="4427598">(</span><span class="ident" id="4427599">context</span><span class="op" id="4427606">,</span>&nbsp;<span class="builtintype" id="4427608">bool</span><span class="op" id="4427612">)</span>&nbsp;<span class="op" id="4427614">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4427617">filter</span>&nbsp;<span class="op" id="4427624">:=</span>&nbsp;<span class="keyword" id="4427627">func</span><span class="op" id="4427631">(</span><span class="ident" id="4427632">e1</span>&nbsp;<span class="op" id="4427635">*</span><span class="ident" id="4427636">escaper</span><span class="op" id="4427643">,</span>&nbsp;<span class="ident" id="4427645">c1</span>&nbsp;<span class="ident" id="4427648">context</span><span class="op" id="4427655">)</span>&nbsp;<span class="builtintype" id="4427657">bool</span>&nbsp;<span class="op" id="4427662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4427666">if</span>&nbsp;<span class="ident" id="4427669">c1</span><span class="op" id="4427671">.</span><span class="ident" id="4427672">state</span>&nbsp;<span class="op" id="4427678">==</span>&nbsp;<span class="ident" id="4427681">stateError</span>&nbsp;<span class="op" id="4427692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4427697">//&nbsp;Do&nbsp;not&nbsp;update&nbsp;the&nbsp;input&nbsp;escaper,&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4427739">return</span>&nbsp;<span class="ident" id="4427746">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4427754">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4427758">if</span>&nbsp;<span class="op" id="4427761">!</span><span class="ident" id="4427762">e1</span><span class="op" id="4427764">.</span><span class="ident" id="4427765">called</span><span class="op" id="4427771">[</span><span class="ident" id="4427772">t</span><span class="op" id="4427773">.</span><span class="ident" id="4427774">Name</span><span class="op" id="4427778">(</span><span class="op" id="4427779">)</span><span class="op" id="4427780">]</span>&nbsp;<span class="op" id="4427782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4427787">//&nbsp;If&nbsp;t&nbsp;is&nbsp;not&nbsp;recursively&nbsp;called,&nbsp;then&nbsp;c1&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4427839">//&nbsp;accurate&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4427870">return</span>&nbsp;<span class="ident" id="4427877">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4427884">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4427888">//&nbsp;c1&nbsp;is&nbsp;accurate&nbsp;if&nbsp;it&nbsp;matches&nbsp;our&nbsp;assumed&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4427950">return</span>&nbsp;<span class="ident" id="4427957">c</span><span class="op" id="4427958">.</span><span class="ident" id="4427959">eq</span><span class="op" id="4427961">(</span><span class="ident" id="4427962">c1</span><span class="op" id="4427964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4427967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4427970">//&nbsp;We&nbsp;need&nbsp;to&nbsp;assume&nbsp;an&nbsp;output&nbsp;context&nbsp;so&nbsp;that&nbsp;recursive&nbsp;template&nbsp;calls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4428043">//&nbsp;take&nbsp;the&nbsp;fast&nbsp;path&nbsp;out&nbsp;of&nbsp;escapeTree&nbsp;instead&nbsp;of&nbsp;infinitely&nbsp;recursing.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4428117">//&nbsp;Naively&nbsp;assuming&nbsp;that&nbsp;the&nbsp;input&nbsp;context&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4428187">//&nbsp;works&nbsp;&gt;90%&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4428215">e</span><span class="op" id="4428216">.</span><span class="ident" id="4428217">output</span><span class="op" id="4428223">[</span><span class="ident" id="4428224">t</span><span class="op" id="4428225">.</span><span class="ident" id="4428226">Name</span><span class="op" id="4428230">(</span><span class="op" id="4428231">)</span><span class="op" id="4428232">]</span>&nbsp;<span class="op" id="4428234">=</span>&nbsp;<span class="ident" id="4428236">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4428239">return</span>&nbsp;<span class="ident" id="4428246">e</span><span class="op" id="4428247">.</span><span class="ident" id="4428248">escapeListConditionally</span><span class="op" id="4428271">(</span><span class="ident" id="4428272">c</span><span class="op" id="4428273">,</span>&nbsp;<span class="ident" id="4428275">t</span><span class="op" id="4428276">.</span><span class="ident" id="4428277">Tree</span><span class="op" id="4428281">.</span><span class="ident" id="4428282">Root</span><span class="op" id="4428286">,</span>&nbsp;<span class="ident" id="4428288">filter</span><span class="op" id="4428294">)</span><br>
<span class="lineno"></span><span class="op" id="4428296">}</span><br>
<span class="lineno">575</span><br>
<span class="lineno"></span><span class="comment" id="4428299">//&nbsp;delimEnds&nbsp;maps&nbsp;each&nbsp;delim&nbsp;to&nbsp;a&nbsp;string&nbsp;of&nbsp;characters&nbsp;that&nbsp;terminate&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="4428373">var</span>&nbsp;<span class="ident" id="4428377">delimEnds</span>&nbsp;<span class="op" id="4428387">=</span>&nbsp;<span class="op" id="4428389">[</span><span class="op" id="4428390">...</span><span class="op" id="4428393">]</span><span class="builtintype" id="4428394">string</span><span class="op" id="4428400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4428403">delimDoubleQuote</span><span class="op" id="4428419">:</span>&nbsp;<span class="string" id="4428421">`&#34;`</span><span class="op" id="4428424">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4428427">delimSingleQuote</span><span class="op" id="4428443">:</span>&nbsp;<span class="string" id="4428445">&#34;&#39;&#34;</span><span class="op" id="4428448">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4428451">//&nbsp;Determined&nbsp;empirically&nbsp;by&nbsp;running&nbsp;the&nbsp;below&nbsp;in&nbsp;various&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4428520">//&nbsp;var&nbsp;div&nbsp;=&nbsp;document.createElement(&#34;DIV&#34;);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4428565">//&nbsp;for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;0x10000;&nbsp;++i)&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4428605">//&nbsp;&nbsp;&nbsp;div.innerHTML&nbsp;=&nbsp;&#34;&lt;span&nbsp;title=x&#34;&nbsp;+&nbsp;String.fromCharCode(i)&nbsp;+&nbsp;&#34;-bar&gt;&#34;;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4428679">//&nbsp;&nbsp;&nbsp;if&nbsp;(div.getElementsByTagName(&#34;SPAN&#34;)[0].title.indexOf(&#34;bar&#34;)&nbsp;&lt;&nbsp;0)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4428751">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.write(&#34;&lt;p&gt;U+&#34;&nbsp;+&nbsp;i.toString(16));</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4428801">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4428807">delimSpaceOrTagEnd</span><span class="op" id="4428825">:</span>&nbsp;<span class="string" id="4428827">&#34;&nbsp;\t\n\f\r&gt;&#34;</span><span class="op" id="4428839">,</span><br>
<span class="lineno"></span><span class="op" id="4428841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="keyword" id="4428844">var</span>&nbsp;<span class="ident" id="4428848">doctypeBytes</span>&nbsp;<span class="op" id="4428861">=</span>&nbsp;<span class="op" id="4428863">[</span><span class="op" id="4428864">]</span><span class="builtintype" id="4428865">byte</span><span class="op" id="4428869">(</span><span class="string" id="4428870">&#34;&lt;!DOCTYPE&#34;</span><span class="op" id="4428881">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4428884">//&nbsp;escapeText&nbsp;escapes&nbsp;a&nbsp;text&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4428928">func</span>&nbsp;<span class="op" id="4428933">(</span><span class="ident" id="4428934">e</span>&nbsp;<span class="op" id="4428936">*</span><span class="ident" id="4428937">escaper</span><span class="op" id="4428944">)</span>&nbsp;<span class="ident" id="4428946">escapeText</span><span class="op" id="4428956">(</span><span class="ident" id="4428957">c</span>&nbsp;<span class="ident" id="4428959">context</span><span class="op" id="4428966">,</span>&nbsp;<span class="ident" id="4428968">n</span>&nbsp;<span class="op" id="4428970">*</span><span class="ident" id="4428971">parse</span><span class="op" id="4428976">.</span><span class="ident" id="4428977">TextNode</span><span class="op" id="4428985">)</span>&nbsp;<span class="ident" id="4428987">context</span>&nbsp;<span class="op" id="4428995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4428998">s</span><span class="op" id="4428999">,</span>&nbsp;<span class="ident" id="4429001">written</span><span class="op" id="4429008">,</span>&nbsp;<span class="ident" id="4429010">i</span><span class="op" id="4429011">,</span>&nbsp;<span class="ident" id="4429013">b</span>&nbsp;<span class="op" id="4429015">:=</span>&nbsp;<span class="ident" id="4429018">n</span><span class="op" id="4429019">.</span><span class="ident" id="4429020">Text</span><span class="op" id="4429024">,</span>&nbsp;<span class="num" id="4429026">0</span><span class="op" id="4429027">,</span>&nbsp;<span class="num" id="4429029">0</span><span class="op" id="4429030">,</span>&nbsp;<span class="builtinfunc" id="4429032">new</span><span class="op" id="4429035">(</span><span class="ident" id="4429036">bytes</span><span class="op" id="4429041">.</span><span class="ident" id="4429042">Buffer</span><span class="op" id="4429048">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4429051">for</span>&nbsp;<span class="ident" id="4429055">i</span>&nbsp;<span class="op" id="4429057">!=</span>&nbsp;<span class="builtinfunc" id="4429060">len</span><span class="op" id="4429063">(</span><span class="ident" id="4429064">s</span><span class="op" id="4429065">)</span>&nbsp;<span class="op" id="4429067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4429071">c1</span><span class="op" id="4429073">,</span>&nbsp;<span class="ident" id="4429075">nread</span>&nbsp;<span class="op" id="4429081">:=</span>&nbsp;<span class="ident" id="4429084">contextAfterText</span><span class="op" id="4429100">(</span><span class="ident" id="4429101">c</span><span class="op" id="4429102">,</span>&nbsp;<span class="ident" id="4429104">s</span><span class="op" id="4429105">[</span><span class="ident" id="4429106">i</span><span class="op" id="4429107">:</span><span class="op" id="4429108">]</span><span class="op" id="4429109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4429113">i1</span>&nbsp;<span class="op" id="4429116">:=</span>&nbsp;<span class="ident" id="4429119">i</span>&nbsp;<span class="op" id="4429121">+</span>&nbsp;<span class="ident" id="4429123">nread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4429131">if</span>&nbsp;<span class="ident" id="4429134">c</span><span class="op" id="4429135">.</span><span class="ident" id="4429136">state</span>&nbsp;<span class="op" id="4429142">==</span>&nbsp;<span class="ident" id="4429145">stateText</span>&nbsp;<span class="op" id="4429155">||</span>&nbsp;<span class="ident" id="4429158">c</span><span class="op" id="4429159">.</span><span class="ident" id="4429160">state</span>&nbsp;<span class="op" id="4429166">==</span>&nbsp;<span class="ident" id="4429169">stateRCDATA</span>&nbsp;<span class="op" id="4429181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4429186">end</span>&nbsp;<span class="op" id="4429190">:=</span>&nbsp;<span class="ident" id="4429193">i1</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4429199">if</span>&nbsp;<span class="ident" id="4429202">c1</span><span class="op" id="4429204">.</span><span class="ident" id="4429205">state</span>&nbsp;<span class="op" id="4429211">!=</span>&nbsp;<span class="ident" id="4429214">c</span><span class="op" id="4429215">.</span><span class="ident" id="4429216">state</span>&nbsp;<span class="op" id="4429222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4429228">for</span>&nbsp;<span class="ident" id="4429232">j</span>&nbsp;<span class="op" id="4429234">:=</span>&nbsp;<span class="ident" id="4429237">end</span>&nbsp;<span class="op" id="4429241">-</span>&nbsp;<span class="num" id="4429243">1</span><span class="op" id="4429244">;</span>&nbsp;<span class="ident" id="4429246">j</span>&nbsp;<span class="op" id="4429248">&gt;=</span>&nbsp;<span class="ident" id="4429251">i</span><span class="op" id="4429252">;</span>&nbsp;<span class="ident" id="4429254">j</span><span class="op" id="4429255">--</span>&nbsp;<span class="op" id="4429258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4429265">if</span>&nbsp;<span class="ident" id="4429268">s</span><span class="op" id="4429269">[</span><span class="ident" id="4429270">j</span><span class="op" id="4429271">]</span>&nbsp;<span class="op" id="4429273">==</span>&nbsp;<span class="string" id="4429276">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="4429280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4429288">end</span>&nbsp;<span class="op" id="4429292">=</span>&nbsp;<span class="ident" id="4429294">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4429302">break</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4429313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4429319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4429324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4429329">for</span>&nbsp;<span class="ident" id="4429333">j</span>&nbsp;<span class="op" id="4429335">:=</span>&nbsp;<span class="ident" id="4429338">i</span><span class="op" id="4429339">;</span>&nbsp;<span class="ident" id="4429341">j</span>&nbsp;<span class="op" id="4429343">&lt;</span>&nbsp;<span class="ident" id="4429345">end</span><span class="op" id="4429348">;</span>&nbsp;<span class="ident" id="4429350">j</span><span class="op" id="4429351">++</span>&nbsp;<span class="op" id="4429354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4429360">if</span>&nbsp;<span class="ident" id="4429363">s</span><span class="op" id="4429364">[</span><span class="ident" id="4429365">j</span><span class="op" id="4429366">]</span>&nbsp;<span class="op" id="4429368">==</span>&nbsp;<span class="string" id="4429371">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="4429375">&amp;&amp;</span>&nbsp;<span class="op" id="4429378">!</span><span class="ident" id="4429379">bytes</span><span class="op" id="4429384">.</span><span class="ident" id="4429385">HasPrefix</span><span class="op" id="4429394">(</span><span class="ident" id="4429395">bytes</span><span class="op" id="4429400">.</span><span class="ident" id="4429401">ToUpper</span><span class="op" id="4429408">(</span><span class="ident" id="4429409">s</span><span class="op" id="4429410">[</span><span class="ident" id="4429411">j</span><span class="op" id="4429412">:</span><span class="op" id="4429413">]</span><span class="op" id="4429414">)</span><span class="op" id="4429415">,</span>&nbsp;<span class="ident" id="4429417">doctypeBytes</span><span class="op" id="4429429">)</span>&nbsp;<span class="op" id="4429431">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4429438">b</span><span class="op" id="4429439">.</span><span class="ident" id="4429440">Write</span><span class="op" id="4429445">(</span><span class="ident" id="4429446">s</span><span class="op" id="4429447">[</span><span class="ident" id="4429448">written</span><span class="op" id="4429455">:</span><span class="ident" id="4429456">j</span><span class="op" id="4429457">]</span><span class="op" id="4429458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4429465">b</span><span class="op" id="4429466">.</span><span class="ident" id="4429467">WriteString</span><span class="op" id="4429478">(</span><span class="string" id="4429479">&#34;&amp;lt;&#34;</span><span class="op" id="4429485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4429492">written</span>&nbsp;<span class="op" id="4429500">=</span>&nbsp;<span class="ident" id="4429502">j</span>&nbsp;<span class="op" id="4429504">+</span>&nbsp;<span class="num" id="4429506">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4429512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4429517">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4429521">}</span>&nbsp;<span class="keyword" id="4429523">else</span>&nbsp;<span class="keyword" id="4429528">if</span>&nbsp;<span class="ident" id="4429531">isComment</span><span class="op" id="4429540">(</span><span class="ident" id="4429541">c</span><span class="op" id="4429542">.</span><span class="ident" id="4429543">state</span><span class="op" id="4429548">)</span>&nbsp;<span class="op" id="4429550">&amp;&amp;</span>&nbsp;<span class="ident" id="4429553">c</span><span class="op" id="4429554">.</span><span class="ident" id="4429555">delim</span>&nbsp;<span class="op" id="4429561">==</span>&nbsp;<span class="ident" id="4429564">delimNone</span>&nbsp;<span class="op" id="4429574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4429579">switch</span>&nbsp;<span class="ident" id="4429586">c</span><span class="op" id="4429587">.</span><span class="ident" id="4429588">state</span>&nbsp;<span class="op" id="4429594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4429599">case</span>&nbsp;<span class="ident" id="4429604">stateJSBlockCmt</span><span class="op" id="4429619">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4429625">//&nbsp;http://es5.github.com/#x7.4:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4429661">//&nbsp;&#34;Comments&nbsp;behave&nbsp;like&nbsp;white&nbsp;space&nbsp;and&nbsp;are</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4429710">//&nbsp;discarded&nbsp;except&nbsp;that,&nbsp;if&nbsp;a&nbsp;MultiLineComment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4429762">//&nbsp;contains&nbsp;a&nbsp;line&nbsp;terminator&nbsp;character,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4429812">//&nbsp;the&nbsp;entire&nbsp;comment&nbsp;is&nbsp;considered&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4429860">//&nbsp;LineTerminator&nbsp;for&nbsp;purposes&nbsp;of&nbsp;parsing&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4429909">//&nbsp;the&nbsp;syntactic&nbsp;grammar.&#34;</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4429940">if</span>&nbsp;<span class="ident" id="4429943">bytes</span><span class="op" id="4429948">.</span><span class="ident" id="4429949">IndexAny</span><span class="op" id="4429957">(</span><span class="ident" id="4429958">s</span><span class="op" id="4429959">[</span><span class="ident" id="4429960">written</span><span class="op" id="4429967">:</span><span class="ident" id="4429968">i1</span><span class="op" id="4429970">]</span><span class="op" id="4429971">,</span>&nbsp;<span class="string" id="4429973">&#34;\n\r\u2028\u2029&#34;</span><span class="op" id="4429991">)</span>&nbsp;<span class="op" id="4429993">!=</span>&nbsp;<span class="op" id="4429996">-</span><span class="num" id="4429997">1</span>&nbsp;<span class="op" id="4429999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4430006">b</span><span class="op" id="4430007">.</span><span class="ident" id="4430008">WriteByte</span><span class="op" id="4430017">(</span><span class="string" id="4430018">&#39;\n&#39;</span><span class="op" id="4430022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4430028">}</span>&nbsp;<span class="keyword" id="4430030">else</span>&nbsp;<span class="op" id="4430035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4430042">b</span><span class="op" id="4430043">.</span><span class="ident" id="4430044">WriteByte</span><span class="op" id="4430053">(</span><span class="string" id="4430054">&#39;&nbsp;&#39;</span><span class="op" id="4430057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4430063">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4430068">case</span>&nbsp;<span class="ident" id="4430073">stateCSSBlockCmt</span><span class="op" id="4430089">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4430095">b</span><span class="op" id="4430096">.</span><span class="ident" id="4430097">WriteByte</span><span class="op" id="4430106">(</span><span class="string" id="4430107">&#39;&nbsp;&#39;</span><span class="op" id="4430110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4430115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4430120">written</span>&nbsp;<span class="op" id="4430128">=</span>&nbsp;<span class="ident" id="4430130">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4430135">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4430139">if</span>&nbsp;<span class="ident" id="4430142">c</span><span class="op" id="4430143">.</span><span class="ident" id="4430144">state</span>&nbsp;<span class="op" id="4430150">!=</span>&nbsp;<span class="ident" id="4430153">c1</span><span class="op" id="4430155">.</span><span class="ident" id="4430156">state</span>&nbsp;<span class="op" id="4430162">&amp;&amp;</span>&nbsp;<span class="ident" id="4430165">isComment</span><span class="op" id="4430174">(</span><span class="ident" id="4430175">c1</span><span class="op" id="4430177">.</span><span class="ident" id="4430178">state</span><span class="op" id="4430183">)</span>&nbsp;<span class="op" id="4430185">&amp;&amp;</span>&nbsp;<span class="ident" id="4430188">c1</span><span class="op" id="4430190">.</span><span class="ident" id="4430191">delim</span>&nbsp;<span class="op" id="4430197">==</span>&nbsp;<span class="ident" id="4430200">delimNone</span>&nbsp;<span class="op" id="4430210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4430215">//&nbsp;Preserve&nbsp;the&nbsp;portion&nbsp;between&nbsp;written&nbsp;and&nbsp;the&nbsp;comment&nbsp;start.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4430281">cs</span>&nbsp;<span class="op" id="4430284">:=</span>&nbsp;<span class="ident" id="4430287">i1</span>&nbsp;<span class="op" id="4430290">-</span>&nbsp;<span class="num" id="4430292">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4430297">if</span>&nbsp;<span class="ident" id="4430300">c1</span><span class="op" id="4430302">.</span><span class="ident" id="4430303">state</span>&nbsp;<span class="op" id="4430309">==</span>&nbsp;<span class="ident" id="4430312">stateHTMLCmt</span>&nbsp;<span class="op" id="4430325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4430331">//&nbsp;&#34;&lt;!--&#34;&nbsp;instead&nbsp;of&nbsp;&#34;/*&#34;&nbsp;or&nbsp;&#34;//&#34;</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4430369">cs</span>&nbsp;<span class="op" id="4430372">-=</span>&nbsp;<span class="num" id="4430375">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4430380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4430385">b</span><span class="op" id="4430386">.</span><span class="ident" id="4430387">Write</span><span class="op" id="4430392">(</span><span class="ident" id="4430393">s</span><span class="op" id="4430394">[</span><span class="ident" id="4430395">written</span><span class="op" id="4430402">:</span><span class="ident" id="4430403">cs</span><span class="op" id="4430405">]</span><span class="op" id="4430406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4430411">written</span>&nbsp;<span class="op" id="4430419">=</span>&nbsp;<span class="ident" id="4430421">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4430426">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4430430">if</span>&nbsp;<span class="ident" id="4430433">i</span>&nbsp;<span class="op" id="4430435">==</span>&nbsp;<span class="ident" id="4430438">i1</span>&nbsp;<span class="op" id="4430441">&amp;&amp;</span>&nbsp;<span class="ident" id="4430444">c</span><span class="op" id="4430445">.</span><span class="ident" id="4430446">state</span>&nbsp;<span class="op" id="4430452">==</span>&nbsp;<span class="ident" id="4430455">c1</span><span class="op" id="4430457">.</span><span class="ident" id="4430458">state</span>&nbsp;<span class="op" id="4430464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4430469">panic</span><span class="op" id="4430474">(</span><span class="ident" id="4430475">fmt</span><span class="op" id="4430478">.</span><span class="ident" id="4430479">Sprintf</span><span class="op" id="4430486">(</span><span class="string" id="4430487">&#34;infinite&nbsp;loop&nbsp;from&nbsp;%v&nbsp;to&nbsp;%v&nbsp;on&nbsp;%q..%q&#34;</span><span class="op" id="4430526">,</span>&nbsp;<span class="ident" id="4430528">c</span><span class="op" id="4430529">,</span>&nbsp;<span class="ident" id="4430531">c1</span><span class="op" id="4430533">,</span>&nbsp;<span class="ident" id="4430535">s</span><span class="op" id="4430536">[</span><span class="op" id="4430537">:</span><span class="ident" id="4430538">i</span><span class="op" id="4430539">]</span><span class="op" id="4430540">,</span>&nbsp;<span class="ident" id="4430542">s</span><span class="op" id="4430543">[</span><span class="ident" id="4430544">i</span><span class="op" id="4430545">:</span><span class="op" id="4430546">]</span><span class="op" id="4430547">)</span><span class="op" id="4430548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4430552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4430556">c</span><span class="op" id="4430557">,</span>&nbsp;<span class="ident" id="4430559">i</span>&nbsp;<span class="op" id="4430561">=</span>&nbsp;<span class="ident" id="4430563">c1</span><span class="op" id="4430565">,</span>&nbsp;<span class="ident" id="4430567">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4430571">}</span><br>
<span class="lineno">650</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4430575">if</span>&nbsp;<span class="ident" id="4430578">written</span>&nbsp;<span class="op" id="4430586">!=</span>&nbsp;<span class="num" id="4430589">0</span>&nbsp;<span class="op" id="4430591">&amp;&amp;</span>&nbsp;<span class="ident" id="4430594">c</span><span class="op" id="4430595">.</span><span class="ident" id="4430596">state</span>&nbsp;<span class="op" id="4430602">!=</span>&nbsp;<span class="ident" id="4430605">stateError</span>&nbsp;<span class="op" id="4430616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4430620">if</span>&nbsp;<span class="op" id="4430623">!</span><span class="ident" id="4430624">isComment</span><span class="op" id="4430633">(</span><span class="ident" id="4430634">c</span><span class="op" id="4430635">.</span><span class="ident" id="4430636">state</span><span class="op" id="4430641">)</span>&nbsp;<span class="op" id="4430643">||</span>&nbsp;<span class="ident" id="4430646">c</span><span class="op" id="4430647">.</span><span class="ident" id="4430648">delim</span>&nbsp;<span class="op" id="4430654">!=</span>&nbsp;<span class="ident" id="4430657">delimNone</span>&nbsp;<span class="op" id="4430667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4430672">b</span><span class="op" id="4430673">.</span><span class="ident" id="4430674">Write</span><span class="op" id="4430679">(</span><span class="ident" id="4430680">n</span><span class="op" id="4430681">.</span><span class="ident" id="4430682">Text</span><span class="op" id="4430686">[</span><span class="ident" id="4430687">written</span><span class="op" id="4430694">:</span><span class="op" id="4430695">]</span><span class="op" id="4430696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4430700">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4430704">e</span><span class="op" id="4430705">.</span><span class="ident" id="4430706">editTextNode</span><span class="op" id="4430718">(</span><span class="ident" id="4430719">n</span><span class="op" id="4430720">,</span>&nbsp;<span class="ident" id="4430722">b</span><span class="op" id="4430723">.</span><span class="ident" id="4430724">Bytes</span><span class="op" id="4430729">(</span><span class="op" id="4430730">)</span><span class="op" id="4430731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4430734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4430737">return</span>&nbsp;<span class="ident" id="4430744">c</span><br>
<span class="lineno"></span><span class="op" id="4430746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span><span class="comment" id="4430749">//&nbsp;contextAfterText&nbsp;starts&nbsp;in&nbsp;context&nbsp;c,&nbsp;consumes&nbsp;some&nbsp;tokens&nbsp;from&nbsp;the&nbsp;front&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4430829">//&nbsp;s,&nbsp;then&nbsp;returns&nbsp;the&nbsp;context&nbsp;after&nbsp;those&nbsp;tokens&nbsp;and&nbsp;the&nbsp;unprocessed&nbsp;suffix.</span><br>
<span class="lineno"></span><span class="keyword" id="4430907">func</span>&nbsp;<span class="ident" id="4430912">contextAfterText</span><span class="op" id="4430928">(</span><span class="ident" id="4430929">c</span>&nbsp;<span class="ident" id="4430931">context</span><span class="op" id="4430938">,</span>&nbsp;<span class="ident" id="4430940">s</span>&nbsp;<span class="op" id="4430942">[</span><span class="op" id="4430943">]</span><span class="builtintype" id="4430944">byte</span><span class="op" id="4430948">)</span>&nbsp;<span class="op" id="4430950">(</span><span class="ident" id="4430951">context</span><span class="op" id="4430958">,</span>&nbsp;<span class="builtintype" id="4430960">int</span><span class="op" id="4430963">)</span>&nbsp;<span class="op" id="4430965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4430968">if</span>&nbsp;<span class="ident" id="4430971">c</span><span class="op" id="4430972">.</span><span class="ident" id="4430973">delim</span>&nbsp;<span class="op" id="4430979">==</span>&nbsp;<span class="ident" id="4430982">delimNone</span>&nbsp;<span class="op" id="4430992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4430996">c1</span><span class="op" id="4430998">,</span>&nbsp;<span class="ident" id="4431000">i</span>&nbsp;<span class="op" id="4431002">:=</span>&nbsp;<span class="ident" id="4431005">tSpecialTagEnd</span><span class="op" id="4431019">(</span><span class="ident" id="4431020">c</span><span class="op" id="4431021">,</span>&nbsp;<span class="ident" id="4431023">s</span><span class="op" id="4431024">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4431028">if</span>&nbsp;<span class="ident" id="4431031">i</span>&nbsp;<span class="op" id="4431033">==</span>&nbsp;<span class="num" id="4431036">0</span>&nbsp;<span class="op" id="4431038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4431043">//&nbsp;A&nbsp;special&nbsp;end&nbsp;tag&nbsp;(`&lt;/script&gt;`)&nbsp;has&nbsp;been&nbsp;seen&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4431099">//&nbsp;all&nbsp;content&nbsp;preceding&nbsp;it&nbsp;has&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4431149">return</span>&nbsp;<span class="ident" id="4431156">c1</span><span class="op" id="4431158">,</span>&nbsp;<span class="num" id="4431160">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4431164">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4431168">//&nbsp;Consider&nbsp;all&nbsp;content&nbsp;up&nbsp;to&nbsp;any&nbsp;end&nbsp;tag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4431213">return</span>&nbsp;<span class="ident" id="4431220">transitionFunc</span><span class="op" id="4431234">[</span><span class="ident" id="4431235">c</span><span class="op" id="4431236">.</span><span class="ident" id="4431237">state</span><span class="op" id="4431242">]</span><span class="op" id="4431243">(</span><span class="ident" id="4431244">c</span><span class="op" id="4431245">,</span>&nbsp;<span class="ident" id="4431247">s</span><span class="op" id="4431248">[</span><span class="op" id="4431249">:</span><span class="ident" id="4431250">i</span><span class="op" id="4431251">]</span><span class="op" id="4431252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4431255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4431259">i</span>&nbsp;<span class="op" id="4431261">:=</span>&nbsp;<span class="ident" id="4431264">bytes</span><span class="op" id="4431269">.</span><span class="ident" id="4431270">IndexAny</span><span class="op" id="4431278">(</span><span class="ident" id="4431279">s</span><span class="op" id="4431280">,</span>&nbsp;<span class="ident" id="4431282">delimEnds</span><span class="op" id="4431291">[</span><span class="ident" id="4431292">c</span><span class="op" id="4431293">.</span><span class="ident" id="4431294">delim</span><span class="op" id="4431299">]</span><span class="op" id="4431300">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4431303">if</span>&nbsp;<span class="ident" id="4431306">i</span>&nbsp;<span class="op" id="4431308">==</span>&nbsp;<span class="op" id="4431311">-</span><span class="num" id="4431312">1</span>&nbsp;<span class="op" id="4431314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4431318">i</span>&nbsp;<span class="op" id="4431320">=</span>&nbsp;<span class="builtinfunc" id="4431322">len</span><span class="op" id="4431325">(</span><span class="ident" id="4431326">s</span><span class="op" id="4431327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4431330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4431333">if</span>&nbsp;<span class="ident" id="4431336">c</span><span class="op" id="4431337">.</span><span class="ident" id="4431338">delim</span>&nbsp;<span class="op" id="4431344">==</span>&nbsp;<span class="ident" id="4431347">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="4431366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4431370">//&nbsp;http://www.w3.org/TR/html5/syntax.html#attribute-value-(unquoted)-state</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4431447">//&nbsp;lists&nbsp;the&nbsp;runes&nbsp;below&nbsp;as&nbsp;error&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4431495">//&nbsp;Error&nbsp;out&nbsp;because&nbsp;HTML&nbsp;parsers&nbsp;may&nbsp;differ&nbsp;on&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4431553">//&nbsp;&#34;&lt;a&nbsp;id=&nbsp;onclick=f(&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;id&#39;s&nbsp;or&nbsp;onclick&#39;s&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4431619">//&nbsp;&#34;&lt;a&nbsp;class=`foo&nbsp;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;a&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4431669">//&nbsp;&#34;&lt;a&nbsp;style=font:&#39;Arial&#39;&#34;&nbsp;needs&nbsp;open-quote&nbsp;fixup.</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4431722">//&nbsp;IE&nbsp;treats&nbsp;&#39;`&#39;&nbsp;as&nbsp;a&nbsp;quotation&nbsp;character.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4431767">if</span>&nbsp;<span class="ident" id="4431770">j</span>&nbsp;<span class="op" id="4431772">:=</span>&nbsp;<span class="ident" id="4431775">bytes</span><span class="op" id="4431780">.</span><span class="ident" id="4431781">IndexAny</span><span class="op" id="4431789">(</span><span class="ident" id="4431790">s</span><span class="op" id="4431791">[</span><span class="op" id="4431792">:</span><span class="ident" id="4431793">i</span><span class="op" id="4431794">]</span><span class="op" id="4431795">,</span>&nbsp;<span class="string" id="4431797">&#34;\&#34;&#39;&lt;=`&#34;</span><span class="op" id="4431805">)</span><span class="op" id="4431806">;</span>&nbsp;<span class="ident" id="4431808">j</span>&nbsp;<span class="op" id="4431810">&gt;=</span>&nbsp;<span class="num" id="4431813">0</span>&nbsp;<span class="op" id="4431815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4431820">return</span>&nbsp;<span class="ident" id="4431827">context</span><span class="op" id="4431834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4431840">state</span><span class="op" id="4431845">:</span>&nbsp;<span class="ident" id="4431847">stateError</span><span class="op" id="4431857">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4431863">err</span><span class="op" id="4431866">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4431870">errorf</span><span class="op" id="4431876">(</span><span class="ident" id="4431877">ErrBadHTML</span><span class="op" id="4431887">,</span>&nbsp;<span class="ident" id="4431889">nil</span><span class="op" id="4431892">,</span>&nbsp;<span class="num" id="4431894">0</span><span class="op" id="4431895">,</span>&nbsp;<span class="string" id="4431897">&#34;%q&nbsp;in&nbsp;unquoted&nbsp;attr:&nbsp;%q&#34;</span><span class="op" id="4431922">,</span>&nbsp;<span class="ident" id="4431924">s</span><span class="op" id="4431925">[</span><span class="ident" id="4431926">j</span><span class="op" id="4431927">:</span><span class="ident" id="4431928">j</span><span class="op" id="4431929">+</span><span class="num" id="4431930">1</span><span class="op" id="4431931">]</span><span class="op" id="4431932">,</span>&nbsp;<span class="ident" id="4431934">s</span><span class="op" id="4431935">[</span><span class="op" id="4431936">:</span><span class="ident" id="4431937">i</span><span class="op" id="4431938">]</span><span class="op" id="4431939">)</span><span class="op" id="4431940">,</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4431945">}</span><span class="op" id="4431946">,</span>&nbsp;<span class="builtinfunc" id="4431948">len</span><span class="op" id="4431951">(</span><span class="ident" id="4431952">s</span><span class="op" id="4431953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4431957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4431960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4431963">if</span>&nbsp;<span class="ident" id="4431966">i</span>&nbsp;<span class="op" id="4431968">==</span>&nbsp;<span class="builtinfunc" id="4431971">len</span><span class="op" id="4431974">(</span><span class="ident" id="4431975">s</span><span class="op" id="4431976">)</span>&nbsp;<span class="op" id="4431978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4431982">//&nbsp;Remain&nbsp;inside&nbsp;the&nbsp;attribute.</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4432016">//&nbsp;Decode&nbsp;the&nbsp;value&nbsp;so&nbsp;non-HTML&nbsp;rules&nbsp;can&nbsp;easily&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4432074">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button&nbsp;onclick=&#34;alert(&amp;quot;Hi!&amp;quot;)&#34;&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4432125">//&nbsp;without&nbsp;having&nbsp;to&nbsp;entity&nbsp;decode&nbsp;token&nbsp;boundaries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4432180">for</span>&nbsp;<span class="ident" id="4432184">u</span>&nbsp;<span class="op" id="4432186">:=</span>&nbsp;<span class="op" id="4432189">[</span><span class="op" id="4432190">]</span><span class="builtintype" id="4432191">byte</span><span class="op" id="4432195">(</span><span class="ident" id="4432196">html</span><span class="op" id="4432200">.</span><span class="ident" id="4432201">UnescapeString</span><span class="op" id="4432215">(</span><span class="builtintype" id="4432216">string</span><span class="op" id="4432222">(</span><span class="ident" id="4432223">s</span><span class="op" id="4432224">)</span><span class="op" id="4432225">)</span><span class="op" id="4432226">)</span><span class="op" id="4432227">;</span>&nbsp;<span class="builtinfunc" id="4432229">len</span><span class="op" id="4432232">(</span><span class="ident" id="4432233">u</span><span class="op" id="4432234">)</span>&nbsp;<span class="op" id="4432236">!=</span>&nbsp;<span class="num" id="4432239">0</span><span class="op" id="4432240">;</span>&nbsp;<span class="op" id="4432242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4432247">c1</span><span class="op" id="4432249">,</span>&nbsp;<span class="ident" id="4432251">i1</span>&nbsp;<span class="op" id="4432254">:=</span>&nbsp;<span class="ident" id="4432257">transitionFunc</span><span class="op" id="4432271">[</span><span class="ident" id="4432272">c</span><span class="op" id="4432273">.</span><span class="ident" id="4432274">state</span><span class="op" id="4432279">]</span><span class="op" id="4432280">(</span><span class="ident" id="4432281">c</span><span class="op" id="4432282">,</span>&nbsp;<span class="ident" id="4432284">u</span><span class="op" id="4432285">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4432290">c</span><span class="op" id="4432291">,</span>&nbsp;<span class="ident" id="4432293">u</span>&nbsp;<span class="op" id="4432295">=</span>&nbsp;<span class="ident" id="4432297">c1</span><span class="op" id="4432299">,</span>&nbsp;<span class="ident" id="4432301">u</span><span class="op" id="4432302">[</span><span class="ident" id="4432303">i1</span><span class="op" id="4432305">:</span><span class="op" id="4432306">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4432310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4432314">return</span>&nbsp;<span class="ident" id="4432321">c</span><span class="op" id="4432322">,</span>&nbsp;<span class="builtinfunc" id="4432324">len</span><span class="op" id="4432327">(</span><span class="ident" id="4432328">s</span><span class="op" id="4432329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4432332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4432335">if</span>&nbsp;<span class="ident" id="4432338">c</span><span class="op" id="4432339">.</span><span class="ident" id="4432340">delim</span>&nbsp;<span class="op" id="4432346">!=</span>&nbsp;<span class="ident" id="4432349">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="4432368">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4432372">//&nbsp;Consume&nbsp;any&nbsp;quote.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4432396">i</span><span class="op" id="4432397">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4432401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4432404">//&nbsp;On&nbsp;exiting&nbsp;an&nbsp;attribute,&nbsp;we&nbsp;discard&nbsp;all&nbsp;state&nbsp;information</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4432466">//&nbsp;except&nbsp;the&nbsp;state&nbsp;and&nbsp;element.</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4432500">return</span>&nbsp;<span class="ident" id="4432507">context</span><span class="op" id="4432514">{</span><span class="ident" id="4432515">state</span><span class="op" id="4432520">:</span>&nbsp;<span class="ident" id="4432522">stateTag</span><span class="op" id="4432530">,</span>&nbsp;<span class="ident" id="4432532">element</span><span class="op" id="4432539">:</span>&nbsp;<span class="ident" id="4432541">c</span><span class="op" id="4432542">.</span><span class="ident" id="4432543">element</span><span class="op" id="4432550">}</span><span class="op" id="4432551">,</span>&nbsp;<span class="ident" id="4432553">i</span><br>
<span class="lineno"></span><span class="op" id="4432555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4432558">//&nbsp;editActionNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;an&nbsp;action&nbsp;pipeline&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="4432633">func</span>&nbsp;<span class="op" id="4432638">(</span><span class="ident" id="4432639">e</span>&nbsp;<span class="op" id="4432641">*</span><span class="ident" id="4432642">escaper</span><span class="op" id="4432649">)</span>&nbsp;<span class="ident" id="4432651">editActionNode</span><span class="op" id="4432665">(</span><span class="ident" id="4432666">n</span>&nbsp;<span class="op" id="4432668">*</span><span class="ident" id="4432669">parse</span><span class="op" id="4432674">.</span><span class="ident" id="4432675">ActionNode</span><span class="op" id="4432685">,</span>&nbsp;<span class="ident" id="4432687">cmds</span>&nbsp;<span class="op" id="4432692">[</span><span class="op" id="4432693">]</span><span class="builtintype" id="4432694">string</span><span class="op" id="4432700">)</span>&nbsp;<span class="op" id="4432702">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4432705">if</span>&nbsp;<span class="ident" id="4432708">_</span><span class="op" id="4432709">,</span>&nbsp;<span class="ident" id="4432711">ok</span>&nbsp;<span class="op" id="4432714">:=</span>&nbsp;<span class="ident" id="4432717">e</span><span class="op" id="4432718">.</span><span class="ident" id="4432719">actionNodeEdits</span><span class="op" id="4432734">[</span><span class="ident" id="4432735">n</span><span class="op" id="4432736">]</span><span class="op" id="4432737">;</span>&nbsp;<span class="ident" id="4432739">ok</span>&nbsp;<span class="op" id="4432742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4432746">panic</span><span class="op" id="4432751">(</span><span class="ident" id="4432752">fmt</span><span class="op" id="4432755">.</span><span class="ident" id="4432756">Sprintf</span><span class="op" id="4432763">(</span><span class="string" id="4432764">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="4432798">,</span>&nbsp;<span class="ident" id="4432800">n</span><span class="op" id="4432801">)</span><span class="op" id="4432802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4432805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4432808">e</span><span class="op" id="4432809">.</span><span class="ident" id="4432810">actionNodeEdits</span><span class="op" id="4432825">[</span><span class="ident" id="4432826">n</span><span class="op" id="4432827">]</span>&nbsp;<span class="op" id="4432829">=</span>&nbsp;<span class="ident" id="4432831">cmds</span><br>
<span class="lineno"></span><span class="op" id="4432836">}</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span><span class="comment" id="4432839">//&nbsp;editTemplateNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;{{template}}&nbsp;callee&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="4432919">func</span>&nbsp;<span class="op" id="4432924">(</span><span class="ident" id="4432925">e</span>&nbsp;<span class="op" id="4432927">*</span><span class="ident" id="4432928">escaper</span><span class="op" id="4432935">)</span>&nbsp;<span class="ident" id="4432937">editTemplateNode</span><span class="op" id="4432953">(</span><span class="ident" id="4432954">n</span>&nbsp;<span class="op" id="4432956">*</span><span class="ident" id="4432957">parse</span><span class="op" id="4432962">.</span><span class="ident" id="4432963">TemplateNode</span><span class="op" id="4432975">,</span>&nbsp;<span class="ident" id="4432977">callee</span>&nbsp;<span class="builtintype" id="4432984">string</span><span class="op" id="4432990">)</span>&nbsp;<span class="op" id="4432992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4432995">if</span>&nbsp;<span class="ident" id="4432998">_</span><span class="op" id="4432999">,</span>&nbsp;<span class="ident" id="4433001">ok</span>&nbsp;<span class="op" id="4433004">:=</span>&nbsp;<span class="ident" id="4433007">e</span><span class="op" id="4433008">.</span><span class="ident" id="4433009">templateNodeEdits</span><span class="op" id="4433026">[</span><span class="ident" id="4433027">n</span><span class="op" id="4433028">]</span><span class="op" id="4433029">;</span>&nbsp;<span class="ident" id="4433031">ok</span>&nbsp;<span class="op" id="4433034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4433038">panic</span><span class="op" id="4433043">(</span><span class="ident" id="4433044">fmt</span><span class="op" id="4433047">.</span><span class="ident" id="4433048">Sprintf</span><span class="op" id="4433055">(</span><span class="string" id="4433056">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="4433090">,</span>&nbsp;<span class="ident" id="4433092">n</span><span class="op" id="4433093">)</span><span class="op" id="4433094">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4433097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4433100">e</span><span class="op" id="4433101">.</span><span class="ident" id="4433102">templateNodeEdits</span><span class="op" id="4433119">[</span><span class="ident" id="4433120">n</span><span class="op" id="4433121">]</span>&nbsp;<span class="op" id="4433123">=</span>&nbsp;<span class="ident" id="4433125">callee</span><br>
<span class="lineno"></span><span class="op" id="4433132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4433135">//&nbsp;editTextNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;text&nbsp;node&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno">730</span><span class="keyword" id="4433201">func</span>&nbsp;<span class="op" id="4433206">(</span><span class="ident" id="4433207">e</span>&nbsp;<span class="op" id="4433209">*</span><span class="ident" id="4433210">escaper</span><span class="op" id="4433217">)</span>&nbsp;<span class="ident" id="4433219">editTextNode</span><span class="op" id="4433231">(</span><span class="ident" id="4433232">n</span>&nbsp;<span class="op" id="4433234">*</span><span class="ident" id="4433235">parse</span><span class="op" id="4433240">.</span><span class="ident" id="4433241">TextNode</span><span class="op" id="4433249">,</span>&nbsp;<span class="ident" id="4433251">text</span>&nbsp;<span class="op" id="4433256">[</span><span class="op" id="4433257">]</span><span class="builtintype" id="4433258">byte</span><span class="op" id="4433262">)</span>&nbsp;<span class="op" id="4433264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4433267">if</span>&nbsp;<span class="ident" id="4433270">_</span><span class="op" id="4433271">,</span>&nbsp;<span class="ident" id="4433273">ok</span>&nbsp;<span class="op" id="4433276">:=</span>&nbsp;<span class="ident" id="4433279">e</span><span class="op" id="4433280">.</span><span class="ident" id="4433281">textNodeEdits</span><span class="op" id="4433294">[</span><span class="ident" id="4433295">n</span><span class="op" id="4433296">]</span><span class="op" id="4433297">;</span>&nbsp;<span class="ident" id="4433299">ok</span>&nbsp;<span class="op" id="4433302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4433306">panic</span><span class="op" id="4433311">(</span><span class="ident" id="4433312">fmt</span><span class="op" id="4433315">.</span><span class="ident" id="4433316">Sprintf</span><span class="op" id="4433323">(</span><span class="string" id="4433324">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="4433358">,</span>&nbsp;<span class="ident" id="4433360">n</span><span class="op" id="4433361">)</span><span class="op" id="4433362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4433365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4433368">e</span><span class="op" id="4433369">.</span><span class="ident" id="4433370">textNodeEdits</span><span class="op" id="4433383">[</span><span class="ident" id="4433384">n</span><span class="op" id="4433385">]</span>&nbsp;<span class="op" id="4433387">=</span>&nbsp;<span class="ident" id="4433389">text</span><br>
<span class="lineno">735</span><span class="op" id="4433394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4433397">//&nbsp;commit&nbsp;applies&nbsp;changes&nbsp;to&nbsp;actions&nbsp;and&nbsp;template&nbsp;calls&nbsp;needed&nbsp;to&nbsp;contextually</span><br>
<span class="lineno"></span><span class="comment" id="4433476">//&nbsp;autoescape&nbsp;content&nbsp;and&nbsp;adds&nbsp;any&nbsp;derived&nbsp;templates&nbsp;to&nbsp;the&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="4433541">func</span>&nbsp;<span class="op" id="4433546">(</span><span class="ident" id="4433547">e</span>&nbsp;<span class="op" id="4433549">*</span><span class="ident" id="4433550">escaper</span><span class="op" id="4433557">)</span>&nbsp;<span class="ident" id="4433559">commit</span><span class="op" id="4433565">(</span><span class="op" id="4433566">)</span>&nbsp;<span class="op" id="4433568">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4433571">for</span>&nbsp;<span class="ident" id="4433575">name</span>&nbsp;<span class="op" id="4433580">:=</span>&nbsp;<span class="keyword" id="4433583">range</span>&nbsp;<span class="ident" id="4433589">e</span><span class="op" id="4433590">.</span><span class="ident" id="4433591">output</span>&nbsp;<span class="op" id="4433598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4433602">e</span><span class="op" id="4433603">.</span><span class="ident" id="4433604">template</span><span class="op" id="4433612">(</span><span class="ident" id="4433613">name</span><span class="op" id="4433617">)</span><span class="op" id="4433618">.</span><span class="ident" id="4433619">Funcs</span><span class="op" id="4433624">(</span><span class="ident" id="4433625">funcMap</span><span class="op" id="4433632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4433635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4433638">for</span>&nbsp;<span class="ident" id="4433642">_</span><span class="op" id="4433643">,</span>&nbsp;<span class="ident" id="4433645">t</span>&nbsp;<span class="op" id="4433647">:=</span>&nbsp;<span class="keyword" id="4433650">range</span>&nbsp;<span class="ident" id="4433656">e</span><span class="op" id="4433657">.</span><span class="ident" id="4433658">derived</span>&nbsp;<span class="op" id="4433666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4433670">if</span>&nbsp;<span class="ident" id="4433673">_</span><span class="op" id="4433674">,</span>&nbsp;<span class="ident" id="4433676">err</span>&nbsp;<span class="op" id="4433680">:=</span>&nbsp;<span class="ident" id="4433683">e</span><span class="op" id="4433684">.</span><span class="ident" id="4433685">tmpl</span><span class="op" id="4433689">.</span><span class="ident" id="4433690">text</span><span class="op" id="4433694">.</span><span class="ident" id="4433695">AddParseTree</span><span class="op" id="4433707">(</span><span class="ident" id="4433708">t</span><span class="op" id="4433709">.</span><span class="ident" id="4433710">Name</span><span class="op" id="4433714">(</span><span class="op" id="4433715">)</span><span class="op" id="4433716">,</span>&nbsp;<span class="ident" id="4433718">t</span><span class="op" id="4433719">.</span><span class="ident" id="4433720">Tree</span><span class="op" id="4433724">)</span><span class="op" id="4433725">;</span>&nbsp;<span class="ident" id="4433727">err</span>&nbsp;<span class="op" id="4433731">!=</span>&nbsp;<span class="ident" id="4433734">nil</span>&nbsp;<span class="op" id="4433738">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4433743">panic</span><span class="op" id="4433748">(</span><span class="string" id="4433749">&#34;error&nbsp;adding&nbsp;derived&nbsp;template&#34;</span><span class="op" id="4433780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4433784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4433787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4433790">for</span>&nbsp;<span class="ident" id="4433794">n</span><span class="op" id="4433795">,</span>&nbsp;<span class="ident" id="4433797">s</span>&nbsp;<span class="op" id="4433799">:=</span>&nbsp;<span class="keyword" id="4433802">range</span>&nbsp;<span class="ident" id="4433808">e</span><span class="op" id="4433809">.</span><span class="ident" id="4433810">actionNodeEdits</span>&nbsp;<span class="op" id="4433826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4433830">ensurePipelineContains</span><span class="op" id="4433852">(</span><span class="ident" id="4433853">n</span><span class="op" id="4433854">.</span><span class="ident" id="4433855">Pipe</span><span class="op" id="4433859">,</span>&nbsp;<span class="ident" id="4433861">s</span><span class="op" id="4433862">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4433865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4433868">for</span>&nbsp;<span class="ident" id="4433872">n</span><span class="op" id="4433873">,</span>&nbsp;<span class="ident" id="4433875">name</span>&nbsp;<span class="op" id="4433880">:=</span>&nbsp;<span class="keyword" id="4433883">range</span>&nbsp;<span class="ident" id="4433889">e</span><span class="op" id="4433890">.</span><span class="ident" id="4433891">templateNodeEdits</span>&nbsp;<span class="op" id="4433909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4433913">n</span><span class="op" id="4433914">.</span><span class="ident" id="4433915">Name</span>&nbsp;<span class="op" id="4433920">=</span>&nbsp;<span class="ident" id="4433922">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4433928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4433931">for</span>&nbsp;<span class="ident" id="4433935">n</span><span class="op" id="4433936">,</span>&nbsp;<span class="ident" id="4433938">s</span>&nbsp;<span class="op" id="4433940">:=</span>&nbsp;<span class="keyword" id="4433943">range</span>&nbsp;<span class="ident" id="4433949">e</span><span class="op" id="4433950">.</span><span class="ident" id="4433951">textNodeEdits</span>&nbsp;<span class="op" id="4433965">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4433969">n</span><span class="op" id="4433970">.</span><span class="ident" id="4433971">Text</span>&nbsp;<span class="op" id="4433976">=</span>&nbsp;<span class="ident" id="4433978">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4433981">}</span><br>
<span class="lineno"></span><span class="op" id="4433983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4433986">//&nbsp;template&nbsp;returns&nbsp;the&nbsp;named&nbsp;template&nbsp;given&nbsp;a&nbsp;mangled&nbsp;template&nbsp;name.</span><br>
<span class="lineno">760</span><span class="keyword" id="4434056">func</span>&nbsp;<span class="op" id="4434061">(</span><span class="ident" id="4434062">e</span>&nbsp;<span class="op" id="4434064">*</span><span class="ident" id="4434065">escaper</span><span class="op" id="4434072">)</span>&nbsp;<span class="ident" id="4434074">template</span><span class="op" id="4434082">(</span><span class="ident" id="4434083">name</span>&nbsp;<span class="builtintype" id="4434088">string</span><span class="op" id="4434094">)</span>&nbsp;<span class="op" id="4434096">*</span><span class="ident" id="4434097">template</span><span class="op" id="4434105">.</span><span class="ident" id="4434106">Template</span>&nbsp;<span class="op" id="4434115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4434118">t</span>&nbsp;<span class="op" id="4434120">:=</span>&nbsp;<span class="ident" id="4434123">e</span><span class="op" id="4434124">.</span><span class="ident" id="4434125">tmpl</span><span class="op" id="4434129">.</span><span class="ident" id="4434130">text</span><span class="op" id="4434134">.</span><span class="ident" id="4434135">Lookup</span><span class="op" id="4434141">(</span><span class="ident" id="4434142">name</span><span class="op" id="4434146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4434149">if</span>&nbsp;<span class="ident" id="4434152">t</span>&nbsp;<span class="op" id="4434154">==</span>&nbsp;<span class="ident" id="4434157">nil</span>&nbsp;<span class="op" id="4434161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4434165">t</span>&nbsp;<span class="op" id="4434167">=</span>&nbsp;<span class="ident" id="4434169">e</span><span class="op" id="4434170">.</span><span class="ident" id="4434171">derived</span><span class="op" id="4434178">[</span><span class="ident" id="4434179">name</span><span class="op" id="4434183">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4434186">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4434189">return</span>&nbsp;<span class="ident" id="4434196">t</span><br>
<span class="lineno"></span><span class="op" id="4434198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4434201">//&nbsp;Forwarding&nbsp;functions&nbsp;so&nbsp;that&nbsp;clients&nbsp;need&nbsp;only&nbsp;import&nbsp;this&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4434271">//&nbsp;to&nbsp;reach&nbsp;the&nbsp;general&nbsp;escaping&nbsp;functions&nbsp;of&nbsp;text/template.</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="4434333">//&nbsp;HTMLEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="4434413">func</span>&nbsp;<span class="ident" id="4434418">HTMLEscape</span><span class="op" id="4434428">(</span><span class="ident" id="4434429">w</span>&nbsp;<span class="ident" id="4434431">io</span><span class="op" id="4434433">.</span><span class="ident" id="4434434">Writer</span><span class="op" id="4434440">,</span>&nbsp;<span class="ident" id="4434442">b</span>&nbsp;<span class="op" id="4434444">[</span><span class="op" id="4434445">]</span><span class="builtintype" id="4434446">byte</span><span class="op" id="4434450">)</span>&nbsp;<span class="op" id="4434452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4434455">template</span><span class="op" id="4434463">.</span><span class="ident" id="4434464">HTMLEscape</span><span class="op" id="4434474">(</span><span class="ident" id="4434475">w</span><span class="op" id="4434476">,</span>&nbsp;<span class="ident" id="4434478">b</span><span class="op" id="4434479">)</span><br>
<span class="lineno"></span><span class="op" id="4434481">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="comment" id="4434484">//&nbsp;HTMLEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="4434566">func</span>&nbsp;<span class="ident" id="4434571">HTMLEscapeString</span><span class="op" id="4434587">(</span><span class="ident" id="4434588">s</span>&nbsp;<span class="builtintype" id="4434590">string</span><span class="op" id="4434596">)</span>&nbsp;<span class="builtintype" id="4434598">string</span>&nbsp;<span class="op" id="4434605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4434608">return</span>&nbsp;<span class="ident" id="4434615">template</span><span class="op" id="4434623">.</span><span class="ident" id="4434624">HTMLEscapeString</span><span class="op" id="4434640">(</span><span class="ident" id="4434641">s</span><span class="op" id="4434642">)</span><br>
<span class="lineno"></span><span class="op" id="4434644">}</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span><span class="comment" id="4434647">//&nbsp;HTMLEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="4434713">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="4434749">func</span>&nbsp;<span class="ident" id="4434754">HTMLEscaper</span><span class="op" id="4434765">(</span><span class="ident" id="4434766">args</span>&nbsp;<span class="op" id="4434771">...</span><span class="keyword" id="4434774">interface</span><span class="op" id="4434783">{</span><span class="op" id="4434784">}</span><span class="op" id="4434785">)</span>&nbsp;<span class="builtintype" id="4434787">string</span>&nbsp;<span class="op" id="4434794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4434797">return</span>&nbsp;<span class="ident" id="4434804">template</span><span class="op" id="4434812">.</span><span class="ident" id="4434813">HTMLEscaper</span><span class="op" id="4434824">(</span><span class="ident" id="4434825">args</span><span class="op" id="4434829">...</span><span class="op" id="4434832">)</span><br>
<span class="lineno">785</span><span class="op" id="4434834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4434837">//&nbsp;JSEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="4434921">func</span>&nbsp;<span class="ident" id="4434926">JSEscape</span><span class="op" id="4434934">(</span><span class="ident" id="4434935">w</span>&nbsp;<span class="ident" id="4434937">io</span><span class="op" id="4434939">.</span><span class="ident" id="4434940">Writer</span><span class="op" id="4434946">,</span>&nbsp;<span class="ident" id="4434948">b</span>&nbsp;<span class="op" id="4434950">[</span><span class="op" id="4434951">]</span><span class="builtintype" id="4434952">byte</span><span class="op" id="4434956">)</span>&nbsp;<span class="op" id="4434958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4434961">template</span><span class="op" id="4434969">.</span><span class="ident" id="4434970">JSEscape</span><span class="op" id="4434978">(</span><span class="ident" id="4434979">w</span><span class="op" id="4434980">,</span>&nbsp;<span class="ident" id="4434982">b</span><span class="op" id="4434983">)</span><br>
<span class="lineno">790</span><span class="op" id="4434985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4434988">//&nbsp;JSEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="4435074">func</span>&nbsp;<span class="ident" id="4435079">JSEscapeString</span><span class="op" id="4435093">(</span><span class="ident" id="4435094">s</span>&nbsp;<span class="builtintype" id="4435096">string</span><span class="op" id="4435102">)</span>&nbsp;<span class="builtintype" id="4435104">string</span>&nbsp;<span class="op" id="4435111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4435114">return</span>&nbsp;<span class="ident" id="4435121">template</span><span class="op" id="4435129">.</span><span class="ident" id="4435130">JSEscapeString</span><span class="op" id="4435144">(</span><span class="ident" id="4435145">s</span><span class="op" id="4435146">)</span><br>
<span class="lineno">795</span><span class="op" id="4435148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4435151">//&nbsp;JSEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="4435221">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="4435257">func</span>&nbsp;<span class="ident" id="4435262">JSEscaper</span><span class="op" id="4435271">(</span><span class="ident" id="4435272">args</span>&nbsp;<span class="op" id="4435277">...</span><span class="keyword" id="4435280">interface</span><span class="op" id="4435289">{</span><span class="op" id="4435290">}</span><span class="op" id="4435291">)</span>&nbsp;<span class="builtintype" id="4435293">string</span>&nbsp;<span class="op" id="4435300">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4435303">return</span>&nbsp;<span class="ident" id="4435310">template</span><span class="op" id="4435318">.</span><span class="ident" id="4435319">JSEscaper</span><span class="op" id="4435328">(</span><span class="ident" id="4435329">args</span><span class="op" id="4435333">...</span><span class="op" id="4435336">)</span><br>
<span class="lineno"></span><span class="op" id="4435338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4435341">//&nbsp;URLQueryEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;value&nbsp;of&nbsp;the&nbsp;textual&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4435419">//&nbsp;its&nbsp;arguments&nbsp;in&nbsp;a&nbsp;form&nbsp;suitable&nbsp;for&nbsp;embedding&nbsp;in&nbsp;a&nbsp;URL&nbsp;query.</span><br>
<span class="lineno">805</span><span class="keyword" id="4435485">func</span>&nbsp;<span class="ident" id="4435490">URLQueryEscaper</span><span class="op" id="4435505">(</span><span class="ident" id="4435506">args</span>&nbsp;<span class="op" id="4435511">...</span><span class="keyword" id="4435514">interface</span><span class="op" id="4435523">{</span><span class="op" id="4435524">}</span><span class="op" id="4435525">)</span>&nbsp;<span class="builtintype" id="4435527">string</span>&nbsp;<span class="op" id="4435534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4435537">return</span>&nbsp;<span class="ident" id="4435544">template</span><span class="op" id="4435552">.</span><span class="ident" id="4435553">URLQueryEscaper</span><span class="op" id="4435568">(</span><span class="ident" id="4435569">args</span><span class="op" id="4435573">...</span><span class="op" id="4435576">)</span><br>
<span class="lineno"></span><span class="op" id="4435578">}</span>
</div>
</body>
</html>
