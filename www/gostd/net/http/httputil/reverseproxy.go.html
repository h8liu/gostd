<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html" class="current">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6196084">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6196139">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6196193">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6196244">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6196275">package</span>&nbsp;<span class="ident" id="6196283">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6196293">import</span>&nbsp;<span class="op" id="6196300">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6196303">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6196309">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6196316">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6196323">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6196335">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6196346">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6196357">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6196365">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6196372">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6196375">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6196448">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="6196474">var</span>&nbsp;<span class="ident" id="6196478">onExitFlushLoop</span>&nbsp;<span class="keyword" id="6196494">func</span><span class="op" id="6196498">(</span><span class="op" id="6196499">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6196502">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="6196572">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6196637">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="6196648">type</span>&nbsp;<span class="ident" id="6196653">ReverseProxy</span>&nbsp;<span class="keyword" id="6196666">struct</span>&nbsp;<span class="op" id="6196673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6196676">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6196723">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6196769">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6196818">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6196862">Director</span>&nbsp;<span class="keyword" id="6196871">func</span><span class="op" id="6196875">(</span><span class="op" id="6196876">*</span><span class="ident" id="6196877">http</span><span class="op" id="6196881">.</span><span class="ident" id="6196882">Request</span><span class="op" id="6196889">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6196893">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6196943">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6196986">Transport</span>&nbsp;<span class="ident" id="6196996">http</span><span class="op" id="6197000">.</span><span class="ident" id="6197001">RoundTripper</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6197016">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6197063">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6197108">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6197127">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6197170">FlushInterval</span>&nbsp;<span class="ident" id="6197184">time</span><span class="op" id="6197188">.</span><span class="ident" id="6197189">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6197200">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6197253">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6197306">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6197366">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6197387">ErrorLog</span>&nbsp;<span class="op" id="6197396">*</span><span class="ident" id="6197397">log</span><span class="op" id="6197400">.</span><span class="ident" id="6197401">Logger</span><br>
<span class="lineno"></span><span class="op" id="6197408">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6197411">func</span>&nbsp;<span class="ident" id="6197416">singleJoiningSlash</span><span class="op" id="6197434">(</span><span class="ident" id="6197435">a</span><span class="op" id="6197436">,</span>&nbsp;<span class="ident" id="6197438">b</span>&nbsp;<span class="builtintype" id="6197440">string</span><span class="op" id="6197446">)</span>&nbsp;<span class="builtintype" id="6197448">string</span>&nbsp;<span class="op" id="6197455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6197458">aslash</span>&nbsp;<span class="op" id="6197465">:=</span>&nbsp;<span class="ident" id="6197468">strings</span><span class="op" id="6197475">.</span><span class="ident" id="6197476">HasSuffix</span><span class="op" id="6197485">(</span><span class="ident" id="6197486">a</span><span class="op" id="6197487">,</span>&nbsp;<span class="string" id="6197489">&#34;/&#34;</span><span class="op" id="6197492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6197495">bslash</span>&nbsp;<span class="op" id="6197502">:=</span>&nbsp;<span class="ident" id="6197505">strings</span><span class="op" id="6197512">.</span><span class="ident" id="6197513">HasPrefix</span><span class="op" id="6197522">(</span><span class="ident" id="6197523">b</span><span class="op" id="6197524">,</span>&nbsp;<span class="string" id="6197526">&#34;/&#34;</span><span class="op" id="6197529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6197532">switch</span>&nbsp;<span class="op" id="6197539">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6197542">case</span>&nbsp;<span class="ident" id="6197547">aslash</span>&nbsp;<span class="op" id="6197554">&amp;&amp;</span>&nbsp;<span class="ident" id="6197557">bslash</span><span class="op" id="6197563">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6197567">return</span>&nbsp;<span class="ident" id="6197574">a</span>&nbsp;<span class="op" id="6197576">+</span>&nbsp;<span class="ident" id="6197578">b</span><span class="op" id="6197579">[</span><span class="num" id="6197580">1</span><span class="op" id="6197581">:</span><span class="op" id="6197582">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6197585">case</span>&nbsp;<span class="op" id="6197590">!</span><span class="ident" id="6197591">aslash</span>&nbsp;<span class="op" id="6197598">&amp;&amp;</span>&nbsp;<span class="op" id="6197601">!</span><span class="ident" id="6197602">bslash</span><span class="op" id="6197608">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6197612">return</span>&nbsp;<span class="ident" id="6197619">a</span>&nbsp;<span class="op" id="6197621">+</span>&nbsp;<span class="string" id="6197623">&#34;/&#34;</span>&nbsp;<span class="op" id="6197627">+</span>&nbsp;<span class="ident" id="6197629">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6197632">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6197635">return</span>&nbsp;<span class="ident" id="6197642">a</span>&nbsp;<span class="op" id="6197644">+</span>&nbsp;<span class="ident" id="6197646">b</span><br>
<span class="lineno"></span><span class="op" id="6197648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6197651">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="6197721">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="6197791">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="6197860">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="6197905">func</span>&nbsp;<span class="ident" id="6197910">NewSingleHostReverseProxy</span><span class="op" id="6197935">(</span><span class="ident" id="6197936">target</span>&nbsp;<span class="op" id="6197943">*</span><span class="ident" id="6197944">url</span><span class="op" id="6197947">.</span><span class="ident" id="6197948">URL</span><span class="op" id="6197951">)</span>&nbsp;<span class="op" id="6197953">*</span><span class="ident" id="6197954">ReverseProxy</span>&nbsp;<span class="op" id="6197967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6197970">targetQuery</span>&nbsp;<span class="op" id="6197982">:=</span>&nbsp;<span class="ident" id="6197985">target</span><span class="op" id="6197991">.</span><span class="ident" id="6197992">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6198002">director</span>&nbsp;<span class="op" id="6198011">:=</span>&nbsp;<span class="keyword" id="6198014">func</span><span class="op" id="6198018">(</span><span class="ident" id="6198019">req</span>&nbsp;<span class="op" id="6198023">*</span><span class="ident" id="6198024">http</span><span class="op" id="6198028">.</span><span class="ident" id="6198029">Request</span><span class="op" id="6198036">)</span>&nbsp;<span class="op" id="6198038">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6198042">req</span><span class="op" id="6198045">.</span><span class="ident" id="6198046">URL</span><span class="op" id="6198049">.</span><span class="ident" id="6198050">Scheme</span>&nbsp;<span class="op" id="6198057">=</span>&nbsp;<span class="ident" id="6198059">target</span><span class="op" id="6198065">.</span><span class="ident" id="6198066">Scheme</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6198075">req</span><span class="op" id="6198078">.</span><span class="ident" id="6198079">URL</span><span class="op" id="6198082">.</span><span class="ident" id="6198083">Host</span>&nbsp;<span class="op" id="6198088">=</span>&nbsp;<span class="ident" id="6198090">target</span><span class="op" id="6198096">.</span><span class="ident" id="6198097">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6198104">req</span><span class="op" id="6198107">.</span><span class="ident" id="6198108">URL</span><span class="op" id="6198111">.</span><span class="ident" id="6198112">Path</span>&nbsp;<span class="op" id="6198117">=</span>&nbsp;<span class="ident" id="6198119">singleJoiningSlash</span><span class="op" id="6198137">(</span><span class="ident" id="6198138">target</span><span class="op" id="6198144">.</span><span class="ident" id="6198145">Path</span><span class="op" id="6198149">,</span>&nbsp;<span class="ident" id="6198151">req</span><span class="op" id="6198154">.</span><span class="ident" id="6198155">URL</span><span class="op" id="6198158">.</span><span class="ident" id="6198159">Path</span><span class="op" id="6198163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6198167">if</span>&nbsp;<span class="ident" id="6198170">targetQuery</span>&nbsp;<span class="op" id="6198182">==</span>&nbsp;<span class="string" id="6198185">&#34;&#34;</span>&nbsp;<span class="op" id="6198188">||</span>&nbsp;<span class="ident" id="6198191">req</span><span class="op" id="6198194">.</span><span class="ident" id="6198195">URL</span><span class="op" id="6198198">.</span><span class="ident" id="6198199">RawQuery</span>&nbsp;<span class="op" id="6198208">==</span>&nbsp;<span class="string" id="6198211">&#34;&#34;</span>&nbsp;<span class="op" id="6198214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6198219">req</span><span class="op" id="6198222">.</span><span class="ident" id="6198223">URL</span><span class="op" id="6198226">.</span><span class="ident" id="6198227">RawQuery</span>&nbsp;<span class="op" id="6198236">=</span>&nbsp;<span class="ident" id="6198238">targetQuery</span>&nbsp;<span class="op" id="6198250">+</span>&nbsp;<span class="ident" id="6198252">req</span><span class="op" id="6198255">.</span><span class="ident" id="6198256">URL</span><span class="op" id="6198259">.</span><span class="ident" id="6198260">RawQuery</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6198271">}</span>&nbsp;<span class="keyword" id="6198273">else</span>&nbsp;<span class="op" id="6198278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6198283">req</span><span class="op" id="6198286">.</span><span class="ident" id="6198287">URL</span><span class="op" id="6198290">.</span><span class="ident" id="6198291">RawQuery</span>&nbsp;<span class="op" id="6198300">=</span>&nbsp;<span class="ident" id="6198302">targetQuery</span>&nbsp;<span class="op" id="6198314">+</span>&nbsp;<span class="string" id="6198316">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="6198320">+</span>&nbsp;<span class="ident" id="6198322">req</span><span class="op" id="6198325">.</span><span class="ident" id="6198326">URL</span><span class="op" id="6198329">.</span><span class="ident" id="6198330">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6198341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6198344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6198347">return</span>&nbsp;<span class="op" id="6198354">&amp;</span><span class="ident" id="6198355">ReverseProxy</span><span class="op" id="6198367">{</span><span class="ident" id="6198368">Director</span><span class="op" id="6198376">:</span>&nbsp;<span class="ident" id="6198378">director</span><span class="op" id="6198386">}</span><br>
<span class="lineno">80</span><span class="op" id="6198388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6198391">func</span>&nbsp;<span class="ident" id="6198396">copyHeader</span><span class="op" id="6198406">(</span><span class="ident" id="6198407">dst</span><span class="op" id="6198410">,</span>&nbsp;<span class="ident" id="6198412">src</span>&nbsp;<span class="ident" id="6198416">http</span><span class="op" id="6198420">.</span><span class="ident" id="6198421">Header</span><span class="op" id="6198427">)</span>&nbsp;<span class="op" id="6198429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6198432">for</span>&nbsp;<span class="ident" id="6198436">k</span><span class="op" id="6198437">,</span>&nbsp;<span class="ident" id="6198439">vv</span>&nbsp;<span class="op" id="6198442">:=</span>&nbsp;<span class="keyword" id="6198445">range</span>&nbsp;<span class="ident" id="6198451">src</span>&nbsp;<span class="op" id="6198455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6198459">for</span>&nbsp;<span class="ident" id="6198463">_</span><span class="op" id="6198464">,</span>&nbsp;<span class="ident" id="6198466">v</span>&nbsp;<span class="op" id="6198468">:=</span>&nbsp;<span class="keyword" id="6198471">range</span>&nbsp;<span class="ident" id="6198477">vv</span>&nbsp;<span class="op" id="6198480">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6198485">dst</span><span class="op" id="6198488">.</span><span class="ident" id="6198489">Add</span><span class="op" id="6198492">(</span><span class="ident" id="6198493">k</span><span class="op" id="6198494">,</span>&nbsp;<span class="ident" id="6198496">v</span><span class="op" id="6198497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6198501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6198504">}</span><br>
<span class="lineno"></span><span class="op" id="6198506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="6198509">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="6198576">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="6198634">var</span>&nbsp;<span class="ident" id="6198638">hopHeaders</span>&nbsp;<span class="op" id="6198649">=</span>&nbsp;<span class="op" id="6198651">[</span><span class="op" id="6198652">]</span><span class="builtintype" id="6198653">string</span><span class="op" id="6198659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6198662">&#34;Connection&#34;</span><span class="op" id="6198674">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6198677">&#34;Keep-Alive&#34;</span><span class="op" id="6198689">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6198692">&#34;Proxy-Authenticate&#34;</span><span class="op" id="6198712">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6198715">&#34;Proxy-Authorization&#34;</span><span class="op" id="6198736">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6198739">&#34;Te&#34;</span><span class="op" id="6198743">,</span>&nbsp;<span class="comment" id="6198745">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6198779">&#34;Trailers&#34;</span><span class="op" id="6198789">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6198792">&#34;Transfer-Encoding&#34;</span><span class="op" id="6198811">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6198814">&#34;Upgrade&#34;</span><span class="op" id="6198823">,</span><br>
<span class="lineno"></span><span class="op" id="6198825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6198828">func</span>&nbsp;<span class="op" id="6198833">(</span><span class="ident" id="6198834">p</span>&nbsp;<span class="op" id="6198836">*</span><span class="ident" id="6198837">ReverseProxy</span><span class="op" id="6198849">)</span>&nbsp;<span class="ident" id="6198851">ServeHTTP</span><span class="op" id="6198860">(</span><span class="ident" id="6198861">rw</span>&nbsp;<span class="ident" id="6198864">http</span><span class="op" id="6198868">.</span><span class="ident" id="6198869">ResponseWriter</span><span class="op" id="6198883">,</span>&nbsp;<span class="ident" id="6198885">req</span>&nbsp;<span class="op" id="6198889">*</span><span class="ident" id="6198890">http</span><span class="op" id="6198894">.</span><span class="ident" id="6198895">Request</span><span class="op" id="6198902">)</span>&nbsp;<span class="op" id="6198904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6198907">transport</span>&nbsp;<span class="op" id="6198917">:=</span>&nbsp;<span class="ident" id="6198920">p</span><span class="op" id="6198921">.</span><span class="ident" id="6198922">Transport</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6198933">if</span>&nbsp;<span class="ident" id="6198936">transport</span>&nbsp;<span class="op" id="6198946">==</span>&nbsp;<span class="builtintype" id="6198949">nil</span>&nbsp;<span class="op" id="6198953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6198957">transport</span>&nbsp;<span class="op" id="6198967">=</span>&nbsp;<span class="ident" id="6198969">http</span><span class="op" id="6198973">.</span><span class="ident" id="6198974">DefaultTransport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6198992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6198996">outreq</span>&nbsp;<span class="op" id="6199003">:=</span>&nbsp;<span class="builtinfunc" id="6199006">new</span><span class="op" id="6199009">(</span><span class="ident" id="6199010">http</span><span class="op" id="6199014">.</span><span class="ident" id="6199015">Request</span><span class="op" id="6199022">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6199025">*</span><span class="ident" id="6199026">outreq</span>&nbsp;<span class="op" id="6199033">=</span>&nbsp;<span class="op" id="6199035">*</span><span class="ident" id="6199036">req</span>&nbsp;<span class="comment" id="6199040">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6199087">p</span><span class="op" id="6199088">.</span><span class="ident" id="6199089">Director</span><span class="op" id="6199097">(</span><span class="ident" id="6199098">outreq</span><span class="op" id="6199104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6199107">outreq</span><span class="op" id="6199113">.</span><span class="ident" id="6199114">Proto</span>&nbsp;<span class="op" id="6199120">=</span>&nbsp;<span class="string" id="6199122">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6199134">outreq</span><span class="op" id="6199140">.</span><span class="ident" id="6199141">ProtoMajor</span>&nbsp;<span class="op" id="6199152">=</span>&nbsp;<span class="num" id="6199154">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6199157">outreq</span><span class="op" id="6199163">.</span><span class="ident" id="6199164">ProtoMinor</span>&nbsp;<span class="op" id="6199175">=</span>&nbsp;<span class="num" id="6199177">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6199180">outreq</span><span class="op" id="6199186">.</span><span class="ident" id="6199187">Close</span>&nbsp;<span class="op" id="6199193">=</span>&nbsp;<span class="builtintype" id="6199195">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6199203">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6199261">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6199320">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6199384">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6199443">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6199494">copiedHeaders</span>&nbsp;<span class="op" id="6199508">:=</span>&nbsp;<span class="builtintype" id="6199511">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6199518">for</span>&nbsp;<span class="ident" id="6199522">_</span><span class="op" id="6199523">,</span>&nbsp;<span class="ident" id="6199525">h</span>&nbsp;<span class="op" id="6199527">:=</span>&nbsp;<span class="keyword" id="6199530">range</span>&nbsp;<span class="ident" id="6199536">hopHeaders</span>&nbsp;<span class="op" id="6199547">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6199551">if</span>&nbsp;<span class="ident" id="6199554">outreq</span><span class="op" id="6199560">.</span><span class="ident" id="6199561">Header</span><span class="op" id="6199567">.</span><span class="ident" id="6199568">Get</span><span class="op" id="6199571">(</span><span class="ident" id="6199572">h</span><span class="op" id="6199573">)</span>&nbsp;<span class="op" id="6199575">!=</span>&nbsp;<span class="string" id="6199578">&#34;&#34;</span>&nbsp;<span class="op" id="6199581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6199586">if</span>&nbsp;<span class="op" id="6199589">!</span><span class="ident" id="6199590">copiedHeaders</span>&nbsp;<span class="op" id="6199604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6199610">outreq</span><span class="op" id="6199616">.</span><span class="ident" id="6199617">Header</span>&nbsp;<span class="op" id="6199624">=</span>&nbsp;<span class="builtinfunc" id="6199626">make</span><span class="op" id="6199630">(</span><span class="ident" id="6199631">http</span><span class="op" id="6199635">.</span><span class="ident" id="6199636">Header</span><span class="op" id="6199642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6199648">copyHeader</span><span class="op" id="6199658">(</span><span class="ident" id="6199659">outreq</span><span class="op" id="6199665">.</span><span class="ident" id="6199666">Header</span><span class="op" id="6199672">,</span>&nbsp;<span class="ident" id="6199674">req</span><span class="op" id="6199677">.</span><span class="ident" id="6199678">Header</span><span class="op" id="6199684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6199690">copiedHeaders</span>&nbsp;<span class="op" id="6199704">=</span>&nbsp;<span class="builtintype" id="6199706">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6199714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6199719">outreq</span><span class="op" id="6199725">.</span><span class="ident" id="6199726">Header</span><span class="op" id="6199732">.</span><span class="ident" id="6199733">Del</span><span class="op" id="6199736">(</span><span class="ident" id="6199737">h</span><span class="op" id="6199738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6199742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6199745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6199749">if</span>&nbsp;<span class="ident" id="6199752">clientIP</span><span class="op" id="6199760">,</span>&nbsp;<span class="ident" id="6199762">_</span><span class="op" id="6199763">,</span>&nbsp;<span class="ident" id="6199765">err</span>&nbsp;<span class="op" id="6199769">:=</span>&nbsp;<span class="ident" id="6199772">net</span><span class="op" id="6199775">.</span><span class="ident" id="6199776">SplitHostPort</span><span class="op" id="6199789">(</span><span class="ident" id="6199790">req</span><span class="op" id="6199793">.</span><span class="ident" id="6199794">RemoteAddr</span><span class="op" id="6199804">)</span><span class="op" id="6199805">;</span>&nbsp;<span class="ident" id="6199807">err</span>&nbsp;<span class="op" id="6199811">==</span>&nbsp;<span class="builtintype" id="6199814">nil</span>&nbsp;<span class="op" id="6199818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6199822">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6199869">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6199919">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6199975">if</span>&nbsp;<span class="ident" id="6199978">prior</span><span class="op" id="6199983">,</span>&nbsp;<span class="ident" id="6199985">ok</span>&nbsp;<span class="op" id="6199988">:=</span>&nbsp;<span class="ident" id="6199991">outreq</span><span class="op" id="6199997">.</span><span class="ident" id="6199998">Header</span><span class="op" id="6200004">[</span><span class="string" id="6200005">&#34;X-Forwarded-For&#34;</span><span class="op" id="6200022">]</span><span class="op" id="6200023">;</span>&nbsp;<span class="ident" id="6200025">ok</span>&nbsp;<span class="op" id="6200028">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200033">clientIP</span>&nbsp;<span class="op" id="6200042">=</span>&nbsp;<span class="ident" id="6200044">strings</span><span class="op" id="6200051">.</span><span class="ident" id="6200052">Join</span><span class="op" id="6200056">(</span><span class="ident" id="6200057">prior</span><span class="op" id="6200062">,</span>&nbsp;<span class="string" id="6200064">&#34;,&nbsp;&#34;</span><span class="op" id="6200068">)</span>&nbsp;<span class="op" id="6200070">+</span>&nbsp;<span class="string" id="6200072">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="6200077">+</span>&nbsp;<span class="ident" id="6200079">clientIP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6200090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200094">outreq</span><span class="op" id="6200100">.</span><span class="ident" id="6200101">Header</span><span class="op" id="6200107">.</span><span class="ident" id="6200108">Set</span><span class="op" id="6200111">(</span><span class="string" id="6200112">&#34;X-Forwarded-For&#34;</span><span class="op" id="6200129">,</span>&nbsp;<span class="ident" id="6200131">clientIP</span><span class="op" id="6200139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6200142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200146">res</span><span class="op" id="6200149">,</span>&nbsp;<span class="ident" id="6200151">err</span>&nbsp;<span class="op" id="6200155">:=</span>&nbsp;<span class="ident" id="6200158">transport</span><span class="op" id="6200167">.</span><span class="ident" id="6200168">RoundTrip</span><span class="op" id="6200177">(</span><span class="ident" id="6200178">outreq</span><span class="op" id="6200184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6200187">if</span>&nbsp;<span class="ident" id="6200190">err</span>&nbsp;<span class="op" id="6200194">!=</span>&nbsp;<span class="builtintype" id="6200197">nil</span>&nbsp;<span class="op" id="6200201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200205">p</span><span class="op" id="6200206">.</span><span class="ident" id="6200207">logf</span><span class="op" id="6200211">(</span><span class="string" id="6200212">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6200235">,</span>&nbsp;<span class="ident" id="6200237">err</span><span class="op" id="6200240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200244">rw</span><span class="op" id="6200246">.</span><span class="ident" id="6200247">WriteHeader</span><span class="op" id="6200258">(</span><span class="ident" id="6200259">http</span><span class="op" id="6200263">.</span><span class="ident" id="6200264">StatusInternalServerError</span><span class="op" id="6200289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6200293">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6200301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6200304">defer</span>&nbsp;<span class="ident" id="6200310">res</span><span class="op" id="6200313">.</span><span class="ident" id="6200314">Body</span><span class="op" id="6200318">.</span><span class="ident" id="6200319">Close</span><span class="op" id="6200324">(</span><span class="op" id="6200325">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6200329">for</span>&nbsp;<span class="ident" id="6200333">_</span><span class="op" id="6200334">,</span>&nbsp;<span class="ident" id="6200336">h</span>&nbsp;<span class="op" id="6200338">:=</span>&nbsp;<span class="keyword" id="6200341">range</span>&nbsp;<span class="ident" id="6200347">hopHeaders</span>&nbsp;<span class="op" id="6200358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200362">res</span><span class="op" id="6200365">.</span><span class="ident" id="6200366">Header</span><span class="op" id="6200372">.</span><span class="ident" id="6200373">Del</span><span class="op" id="6200376">(</span><span class="ident" id="6200377">h</span><span class="op" id="6200378">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6200381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200385">copyHeader</span><span class="op" id="6200395">(</span><span class="ident" id="6200396">rw</span><span class="op" id="6200398">.</span><span class="ident" id="6200399">Header</span><span class="op" id="6200405">(</span><span class="op" id="6200406">)</span><span class="op" id="6200407">,</span>&nbsp;<span class="ident" id="6200409">res</span><span class="op" id="6200412">.</span><span class="ident" id="6200413">Header</span><span class="op" id="6200419">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200423">rw</span><span class="op" id="6200425">.</span><span class="ident" id="6200426">WriteHeader</span><span class="op" id="6200437">(</span><span class="ident" id="6200438">res</span><span class="op" id="6200441">.</span><span class="ident" id="6200442">StatusCode</span><span class="op" id="6200452">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200455">p</span><span class="op" id="6200456">.</span><span class="ident" id="6200457">copyResponse</span><span class="op" id="6200469">(</span><span class="ident" id="6200470">rw</span><span class="op" id="6200472">,</span>&nbsp;<span class="ident" id="6200474">res</span><span class="op" id="6200477">.</span><span class="ident" id="6200478">Body</span><span class="op" id="6200482">)</span><br>
<span class="lineno"></span><span class="op" id="6200484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6200487">func</span>&nbsp;<span class="op" id="6200492">(</span><span class="ident" id="6200493">p</span>&nbsp;<span class="op" id="6200495">*</span><span class="ident" id="6200496">ReverseProxy</span><span class="op" id="6200508">)</span>&nbsp;<span class="ident" id="6200510">copyResponse</span><span class="op" id="6200522">(</span><span class="ident" id="6200523">dst</span>&nbsp;<span class="ident" id="6200527">io</span><span class="op" id="6200529">.</span><span class="ident" id="6200530">Writer</span><span class="op" id="6200536">,</span>&nbsp;<span class="ident" id="6200538">src</span>&nbsp;<span class="ident" id="6200542">io</span><span class="op" id="6200544">.</span><span class="ident" id="6200545">Reader</span><span class="op" id="6200551">)</span>&nbsp;<span class="op" id="6200553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6200556">if</span>&nbsp;<span class="ident" id="6200559">p</span><span class="op" id="6200560">.</span><span class="ident" id="6200561">FlushInterval</span>&nbsp;<span class="op" id="6200575">!=</span>&nbsp;<span class="num" id="6200578">0</span>&nbsp;<span class="op" id="6200580">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6200584">if</span>&nbsp;<span class="ident" id="6200587">wf</span><span class="op" id="6200589">,</span>&nbsp;<span class="ident" id="6200591">ok</span>&nbsp;<span class="op" id="6200594">:=</span>&nbsp;<span class="ident" id="6200597">dst</span><span class="op" id="6200600">.</span><span class="op" id="6200601">(</span><span class="ident" id="6200602">writeFlusher</span><span class="op" id="6200614">)</span><span class="op" id="6200615">;</span>&nbsp;<span class="ident" id="6200617">ok</span>&nbsp;<span class="op" id="6200620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200625">mlw</span>&nbsp;<span class="op" id="6200629">:=</span>&nbsp;<span class="op" id="6200632">&amp;</span><span class="ident" id="6200633">maxLatencyWriter</span><span class="op" id="6200649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200655">dst</span><span class="op" id="6200658">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200664">wf</span><span class="op" id="6200666">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200672">latency</span><span class="op" id="6200679">:</span>&nbsp;<span class="ident" id="6200681">p</span><span class="op" id="6200682">.</span><span class="ident" id="6200683">FlushInterval</span><span class="op" id="6200696">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200702">done</span><span class="op" id="6200706">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6200711">make</span><span class="op" id="6200715">(</span><span class="keyword" id="6200716">chan</span>&nbsp;<span class="builtintype" id="6200721">bool</span><span class="op" id="6200725">)</span><span class="op" id="6200726">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6200731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6200736">go</span>&nbsp;<span class="ident" id="6200739">mlw</span><span class="op" id="6200742">.</span><span class="ident" id="6200743">flushLoop</span><span class="op" id="6200752">(</span><span class="op" id="6200753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6200758">defer</span>&nbsp;<span class="ident" id="6200764">mlw</span><span class="op" id="6200767">.</span><span class="ident" id="6200768">stop</span><span class="op" id="6200772">(</span><span class="op" id="6200773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200778">dst</span>&nbsp;<span class="op" id="6200782">=</span>&nbsp;<span class="ident" id="6200784">mlw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6200790">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6200793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200797">io</span><span class="op" id="6200799">.</span><span class="ident" id="6200800">Copy</span><span class="op" id="6200804">(</span><span class="ident" id="6200805">dst</span><span class="op" id="6200808">,</span>&nbsp;<span class="ident" id="6200810">src</span><span class="op" id="6200813">)</span><br>
<span class="lineno"></span><span class="op" id="6200815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6200818">func</span>&nbsp;<span class="op" id="6200823">(</span><span class="ident" id="6200824">p</span>&nbsp;<span class="op" id="6200826">*</span><span class="ident" id="6200827">ReverseProxy</span><span class="op" id="6200839">)</span>&nbsp;<span class="ident" id="6200841">logf</span><span class="op" id="6200845">(</span><span class="ident" id="6200846">format</span>&nbsp;<span class="builtintype" id="6200853">string</span><span class="op" id="6200859">,</span>&nbsp;<span class="ident" id="6200861">args</span>&nbsp;<span class="op" id="6200866">...</span><span class="keyword" id="6200869">interface</span><span class="op" id="6200878">{</span><span class="op" id="6200879">}</span><span class="op" id="6200880">)</span>&nbsp;<span class="op" id="6200882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6200885">if</span>&nbsp;<span class="ident" id="6200888">p</span><span class="op" id="6200889">.</span><span class="ident" id="6200890">ErrorLog</span>&nbsp;<span class="op" id="6200899">!=</span>&nbsp;<span class="builtintype" id="6200902">nil</span>&nbsp;<span class="op" id="6200906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200910">p</span><span class="op" id="6200911">.</span><span class="ident" id="6200912">ErrorLog</span><span class="op" id="6200920">.</span><span class="ident" id="6200921">Printf</span><span class="op" id="6200927">(</span><span class="ident" id="6200928">format</span><span class="op" id="6200934">,</span>&nbsp;<span class="ident" id="6200936">args</span><span class="op" id="6200940">...</span><span class="op" id="6200943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6200946">}</span>&nbsp;<span class="keyword" id="6200948">else</span>&nbsp;<span class="op" id="6200953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6200957">log</span><span class="op" id="6200960">.</span><span class="ident" id="6200961">Printf</span><span class="op" id="6200967">(</span><span class="ident" id="6200968">format</span><span class="op" id="6200974">,</span>&nbsp;<span class="ident" id="6200976">args</span><span class="op" id="6200980">...</span><span class="op" id="6200983">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6200986">}</span><br>
<span class="lineno"></span><span class="op" id="6200988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6200991">type</span>&nbsp;<span class="ident" id="6200996">writeFlusher</span>&nbsp;<span class="keyword" id="6201009">interface</span>&nbsp;<span class="op" id="6201019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6201022">io</span><span class="op" id="6201024">.</span><span class="ident" id="6201025">Writer</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6201033">http</span><span class="op" id="6201037">.</span><span class="ident" id="6201038">Flusher</span><br>
<span class="lineno"></span><span class="op" id="6201046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6201049">type</span>&nbsp;<span class="ident" id="6201054">maxLatencyWriter</span>&nbsp;<span class="keyword" id="6201071">struct</span>&nbsp;<span class="op" id="6201078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6201081">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6201089">writeFlusher</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6201103">latency</span>&nbsp;<span class="ident" id="6201111">time</span><span class="op" id="6201115">.</span><span class="ident" id="6201116">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6201127">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6201132">sync</span><span class="op" id="6201136">.</span><span class="ident" id="6201137">Mutex</span>&nbsp;<span class="comment" id="6201143">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6201170">done</span>&nbsp;<span class="keyword" id="6201175">chan</span>&nbsp;<span class="builtintype" id="6201180">bool</span><br>
<span class="lineno"></span><span class="op" id="6201185">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="6201188">func</span>&nbsp;<span class="op" id="6201193">(</span><span class="ident" id="6201194">m</span>&nbsp;<span class="op" id="6201196">*</span><span class="ident" id="6201197">maxLatencyWriter</span><span class="op" id="6201213">)</span>&nbsp;<span class="ident" id="6201215">Write</span><span class="op" id="6201220">(</span><span class="ident" id="6201221">p</span>&nbsp;<span class="op" id="6201223">[</span><span class="op" id="6201224">]</span><span class="builtintype" id="6201225">byte</span><span class="op" id="6201229">)</span>&nbsp;<span class="op" id="6201231">(</span><span class="builtintype" id="6201232">int</span><span class="op" id="6201235">,</span>&nbsp;<span class="builtintype" id="6201237">error</span><span class="op" id="6201242">)</span>&nbsp;<span class="op" id="6201244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6201247">m</span><span class="op" id="6201248">.</span><span class="ident" id="6201249">lk</span><span class="op" id="6201251">.</span><span class="ident" id="6201252">Lock</span><span class="op" id="6201256">(</span><span class="op" id="6201257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6201260">defer</span>&nbsp;<span class="ident" id="6201266">m</span><span class="op" id="6201267">.</span><span class="ident" id="6201268">lk</span><span class="op" id="6201270">.</span><span class="ident" id="6201271">Unlock</span><span class="op" id="6201277">(</span><span class="op" id="6201278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6201281">return</span>&nbsp;<span class="ident" id="6201288">m</span><span class="op" id="6201289">.</span><span class="ident" id="6201290">dst</span><span class="op" id="6201293">.</span><span class="ident" id="6201294">Write</span><span class="op" id="6201299">(</span><span class="ident" id="6201300">p</span><span class="op" id="6201301">)</span><br>
<span class="lineno">205</span><span class="op" id="6201303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6201306">func</span>&nbsp;<span class="op" id="6201311">(</span><span class="ident" id="6201312">m</span>&nbsp;<span class="op" id="6201314">*</span><span class="ident" id="6201315">maxLatencyWriter</span><span class="op" id="6201331">)</span>&nbsp;<span class="ident" id="6201333">flushLoop</span><span class="op" id="6201342">(</span><span class="op" id="6201343">)</span>&nbsp;<span class="op" id="6201345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6201348">t</span>&nbsp;<span class="op" id="6201350">:=</span>&nbsp;<span class="ident" id="6201353">time</span><span class="op" id="6201357">.</span><span class="ident" id="6201358">NewTicker</span><span class="op" id="6201367">(</span><span class="ident" id="6201368">m</span><span class="op" id="6201369">.</span><span class="ident" id="6201370">latency</span><span class="op" id="6201377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6201380">defer</span>&nbsp;<span class="ident" id="6201386">t</span><span class="op" id="6201387">.</span><span class="ident" id="6201388">Stop</span><span class="op" id="6201392">(</span><span class="op" id="6201393">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6201396">for</span>&nbsp;<span class="op" id="6201400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6201404">select</span>&nbsp;<span class="op" id="6201411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6201415">case</span>&nbsp;<span class="op" id="6201420">&lt;-</span><span class="ident" id="6201422">m</span><span class="op" id="6201423">.</span><span class="ident" id="6201424">done</span><span class="op" id="6201428">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6201433">if</span>&nbsp;<span class="ident" id="6201436">onExitFlushLoop</span>&nbsp;<span class="op" id="6201452">!=</span>&nbsp;<span class="builtintype" id="6201455">nil</span>&nbsp;<span class="op" id="6201459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6201465">onExitFlushLoop</span><span class="op" id="6201480">(</span><span class="op" id="6201481">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6201486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6201491">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6201500">case</span>&nbsp;<span class="op" id="6201505">&lt;-</span><span class="ident" id="6201507">t</span><span class="op" id="6201508">.</span><span class="ident" id="6201509">C</span><span class="op" id="6201510">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6201515">m</span><span class="op" id="6201516">.</span><span class="ident" id="6201517">lk</span><span class="op" id="6201519">.</span><span class="ident" id="6201520">Lock</span><span class="op" id="6201524">(</span><span class="op" id="6201525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6201530">m</span><span class="op" id="6201531">.</span><span class="ident" id="6201532">dst</span><span class="op" id="6201535">.</span><span class="ident" id="6201536">Flush</span><span class="op" id="6201541">(</span><span class="op" id="6201542">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6201547">m</span><span class="op" id="6201548">.</span><span class="ident" id="6201549">lk</span><span class="op" id="6201551">.</span><span class="ident" id="6201552">Unlock</span><span class="op" id="6201558">(</span><span class="op" id="6201559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6201563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6201566">}</span><br>
<span class="lineno"></span><span class="op" id="6201568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="6201571">func</span>&nbsp;<span class="op" id="6201576">(</span><span class="ident" id="6201577">m</span>&nbsp;<span class="op" id="6201579">*</span><span class="ident" id="6201580">maxLatencyWriter</span><span class="op" id="6201596">)</span>&nbsp;<span class="ident" id="6201598">stop</span><span class="op" id="6201602">(</span><span class="op" id="6201603">)</span>&nbsp;<span class="op" id="6201605">{</span>&nbsp;<span class="ident" id="6201607">m</span><span class="op" id="6201608">.</span><span class="ident" id="6201609">done</span>&nbsp;<span class="op" id="6201614">&lt;-</span>&nbsp;<span class="builtintype" id="6201617">true</span>&nbsp;<span class="op" id="6201622">}</span>
</div>
</body>
</html>
