<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6047038">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6047093">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6047147">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6047198">//&nbsp;Package&nbsp;jpeg&nbsp;implements&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;decoder&nbsp;and&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="comment" id="6047259">//</span><br>
<span class="lineno"></span><span class="comment" id="6047262">//&nbsp;JPEG&nbsp;is&nbsp;defined&nbsp;in&nbsp;ITU-T&nbsp;T.81:&nbsp;http://www.w3.org/Graphics/JPEG/itu-t81.pdf.</span><br>
<span class="lineno"></span><span class="keyword" id="6047341">package</span>&nbsp;<span class="ident" id="6047349">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="6047355">import</span>&nbsp;<span class="op" id="6047362">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6047365">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6047374">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6047389">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6047394">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="6047397">//&nbsp;TODO(nigeltao):&nbsp;fix&nbsp;up&nbsp;the&nbsp;doc&nbsp;comment&nbsp;style&nbsp;so&nbsp;that&nbsp;sentences&nbsp;start&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="6047474">//&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;or&nbsp;function&nbsp;that&nbsp;they&nbsp;annotate.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6047531">//&nbsp;A&nbsp;FormatError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;JPEG.</span><br>
<span class="lineno">20</span><span class="keyword" id="6047592">type</span>&nbsp;<span class="ident" id="6047597">FormatError</span>&nbsp;<span class="builtintype" id="6047609">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6047617">func</span>&nbsp;<span class="op" id="6047622">(</span><span class="ident" id="6047623">e</span>&nbsp;<span class="ident" id="6047625">FormatError</span><span class="op" id="6047636">)</span>&nbsp;<span class="ident" id="6047638">Error</span><span class="op" id="6047643">(</span><span class="op" id="6047644">)</span>&nbsp;<span class="builtintype" id="6047646">string</span>&nbsp;<span class="op" id="6047653">{</span>&nbsp;<span class="keyword" id="6047655">return</span>&nbsp;<span class="string" id="6047662">&#34;invalid&nbsp;JPEG&nbsp;format:&nbsp;&#34;</span>&nbsp;<span class="op" id="6047686">+</span>&nbsp;<span class="builtintype" id="6047688">string</span><span class="op" id="6047694">(</span><span class="ident" id="6047695">e</span><span class="op" id="6047696">)</span>&nbsp;<span class="op" id="6047698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6047701">//&nbsp;An&nbsp;UnsupportedError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;uses&nbsp;a&nbsp;valid&nbsp;but&nbsp;unimplemented&nbsp;JPEG&nbsp;feature.</span><br>
<span class="lineno">25</span><span class="keyword" id="6047792">type</span>&nbsp;<span class="ident" id="6047797">UnsupportedError</span>&nbsp;<span class="builtintype" id="6047814">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6047822">func</span>&nbsp;<span class="op" id="6047827">(</span><span class="ident" id="6047828">e</span>&nbsp;<span class="ident" id="6047830">UnsupportedError</span><span class="op" id="6047846">)</span>&nbsp;<span class="ident" id="6047848">Error</span><span class="op" id="6047853">(</span><span class="op" id="6047854">)</span>&nbsp;<span class="builtintype" id="6047856">string</span>&nbsp;<span class="op" id="6047863">{</span>&nbsp;<span class="keyword" id="6047865">return</span>&nbsp;<span class="string" id="6047872">&#34;unsupported&nbsp;JPEG&nbsp;feature:&nbsp;&#34;</span>&nbsp;<span class="op" id="6047901">+</span>&nbsp;<span class="builtintype" id="6047903">string</span><span class="op" id="6047909">(</span><span class="ident" id="6047910">e</span><span class="op" id="6047911">)</span>&nbsp;<span class="op" id="6047913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6047916">//&nbsp;Component&nbsp;specification,&nbsp;specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno">30</span><span class="keyword" id="6047972">type</span>&nbsp;<span class="ident" id="6047977">component</span>&nbsp;<span class="keyword" id="6047987">struct</span>&nbsp;<span class="op" id="6047994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047997">h</span>&nbsp;&nbsp;<span class="builtintype" id="6048000">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="6048006">//&nbsp;Horizontal&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048038">v</span>&nbsp;&nbsp;<span class="builtintype" id="6048041">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="6048047">//&nbsp;Vertical&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048077">c</span>&nbsp;&nbsp;<span class="builtintype" id="6048080">uint8</span>&nbsp;<span class="comment" id="6048086">//&nbsp;Component&nbsp;identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048112">tq</span>&nbsp;<span class="builtintype" id="6048115">uint8</span>&nbsp;<span class="comment" id="6048121">//&nbsp;Quantization&nbsp;table&nbsp;destination&nbsp;selector.</span><br>
<span class="lineno">35</span><span class="op" id="6048165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6048168">const</span>&nbsp;<span class="op" id="6048174">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048177">dcTable</span>&nbsp;<span class="op" id="6048185">=</span>&nbsp;<span class="num" id="6048187">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048190">acTable</span>&nbsp;<span class="op" id="6048198">=</span>&nbsp;<span class="num" id="6048200">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048203">maxTc</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6048211">=</span>&nbsp;<span class="num" id="6048213">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048216">maxTh</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6048224">=</span>&nbsp;<span class="num" id="6048226">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048229">maxTq</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6048237">=</span>&nbsp;<span class="num" id="6048239">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6048243">//&nbsp;A&nbsp;grayscale&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;a&nbsp;Y&nbsp;component.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048294">nGrayComponent</span>&nbsp;<span class="op" id="6048309">=</span>&nbsp;<span class="num" id="6048311">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6048314">//&nbsp;A&nbsp;color&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;Y,&nbsp;Cb&nbsp;and&nbsp;Cr&nbsp;components.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048366">nColorComponent</span>&nbsp;<span class="op" id="6048382">=</span>&nbsp;<span class="num" id="6048384">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6048388">//&nbsp;We&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;and&nbsp;4:2:0&nbsp;downsampling,&nbsp;and&nbsp;therefore&nbsp;the</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6048470">//&nbsp;number&nbsp;of&nbsp;luma&nbsp;samples&nbsp;per&nbsp;chroma&nbsp;sample&nbsp;is&nbsp;at&nbsp;most&nbsp;2&nbsp;in&nbsp;the&nbsp;horizontal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6048546">//&nbsp;and&nbsp;2&nbsp;in&nbsp;the&nbsp;vertical&nbsp;direction.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048583">maxH</span>&nbsp;<span class="op" id="6048588">=</span>&nbsp;<span class="num" id="6048590">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048593">maxV</span>&nbsp;<span class="op" id="6048598">=</span>&nbsp;<span class="num" id="6048600">2</span><br>
<span class="lineno"></span><span class="op" id="6048602">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="6048605">const</span>&nbsp;<span class="op" id="6048611">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048614">soiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6048626">=</span>&nbsp;<span class="num" id="6048628">0xd8</span>&nbsp;<span class="comment" id="6048633">//&nbsp;Start&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048653">eoiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6048665">=</span>&nbsp;<span class="num" id="6048667">0xd9</span>&nbsp;<span class="comment" id="6048672">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048690">sof0Marker</span>&nbsp;&nbsp;<span class="op" id="6048702">=</span>&nbsp;<span class="num" id="6048704">0xc0</span>&nbsp;<span class="comment" id="6048709">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Baseline).</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048740">sof2Marker</span>&nbsp;&nbsp;<span class="op" id="6048752">=</span>&nbsp;<span class="num" id="6048754">0xc2</span>&nbsp;<span class="comment" id="6048759">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Progressive).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048793">dhtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6048805">=</span>&nbsp;<span class="num" id="6048807">0xc4</span>&nbsp;<span class="comment" id="6048812">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048838">dqtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6048850">=</span>&nbsp;<span class="num" id="6048852">0xdb</span>&nbsp;<span class="comment" id="6048857">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048888">sosMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6048900">=</span>&nbsp;<span class="num" id="6048902">0xda</span>&nbsp;<span class="comment" id="6048907">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048926">driMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6048938">=</span>&nbsp;<span class="num" id="6048940">0xdd</span>&nbsp;<span class="comment" id="6048945">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048974">rst0Marker</span>&nbsp;&nbsp;<span class="op" id="6048986">=</span>&nbsp;<span class="num" id="6048988">0xd0</span>&nbsp;<span class="comment" id="6048993">//&nbsp;ReSTart&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049010">rst7Marker</span>&nbsp;&nbsp;<span class="op" id="6049022">=</span>&nbsp;<span class="num" id="6049024">0xd7</span>&nbsp;<span class="comment" id="6049029">//&nbsp;ReSTart&nbsp;(7).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049046">app0Marker</span>&nbsp;&nbsp;<span class="op" id="6049058">=</span>&nbsp;<span class="num" id="6049060">0xe0</span>&nbsp;<span class="comment" id="6049065">//&nbsp;APPlication&nbsp;specific&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049095">app15Marker</span>&nbsp;<span class="op" id="6049107">=</span>&nbsp;<span class="num" id="6049109">0xef</span>&nbsp;<span class="comment" id="6049114">//&nbsp;APPlication&nbsp;specific&nbsp;(15).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049145">comMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6049157">=</span>&nbsp;<span class="num" id="6049159">0xfe</span>&nbsp;<span class="comment" id="6049164">//&nbsp;COMment.</span><br>
<span class="lineno">70</span><span class="op" id="6049176">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6049179">//&nbsp;unzig&nbsp;maps&nbsp;from&nbsp;the&nbsp;zig-zag&nbsp;ordering&nbsp;to&nbsp;the&nbsp;natural&nbsp;ordering.&nbsp;For&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="6049257">//&nbsp;unzig[3]&nbsp;is&nbsp;the&nbsp;column&nbsp;and&nbsp;row&nbsp;of&nbsp;the&nbsp;fourth&nbsp;element&nbsp;in&nbsp;zig-zag&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="6049335">//&nbsp;value&nbsp;is&nbsp;16,&nbsp;which&nbsp;means&nbsp;first&nbsp;column&nbsp;(16%8&nbsp;==&nbsp;0)&nbsp;and&nbsp;third&nbsp;row&nbsp;(16/8&nbsp;==&nbsp;2).</span><br>
<span class="lineno">75</span><span class="keyword" id="6049415">var</span>&nbsp;<span class="ident" id="6049419">unzig</span>&nbsp;<span class="op" id="6049425">=</span>&nbsp;<span class="op" id="6049427">[</span><span class="ident" id="6049428">blockSize</span><span class="op" id="6049437">]</span><span class="builtintype" id="6049438">int</span><span class="op" id="6049441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6049444">0</span><span class="op" id="6049445">,</span>&nbsp;<span class="num" id="6049447">1</span><span class="op" id="6049448">,</span>&nbsp;<span class="num" id="6049450">8</span><span class="op" id="6049451">,</span>&nbsp;<span class="num" id="6049453">16</span><span class="op" id="6049455">,</span>&nbsp;<span class="num" id="6049457">9</span><span class="op" id="6049458">,</span>&nbsp;<span class="num" id="6049460">2</span><span class="op" id="6049461">,</span>&nbsp;<span class="num" id="6049463">3</span><span class="op" id="6049464">,</span>&nbsp;<span class="num" id="6049466">10</span><span class="op" id="6049468">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6049471">17</span><span class="op" id="6049473">,</span>&nbsp;<span class="num" id="6049475">24</span><span class="op" id="6049477">,</span>&nbsp;<span class="num" id="6049479">32</span><span class="op" id="6049481">,</span>&nbsp;<span class="num" id="6049483">25</span><span class="op" id="6049485">,</span>&nbsp;<span class="num" id="6049487">18</span><span class="op" id="6049489">,</span>&nbsp;<span class="num" id="6049491">11</span><span class="op" id="6049493">,</span>&nbsp;<span class="num" id="6049495">4</span><span class="op" id="6049496">,</span>&nbsp;<span class="num" id="6049498">5</span><span class="op" id="6049499">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6049502">12</span><span class="op" id="6049504">,</span>&nbsp;<span class="num" id="6049506">19</span><span class="op" id="6049508">,</span>&nbsp;<span class="num" id="6049510">26</span><span class="op" id="6049512">,</span>&nbsp;<span class="num" id="6049514">33</span><span class="op" id="6049516">,</span>&nbsp;<span class="num" id="6049518">40</span><span class="op" id="6049520">,</span>&nbsp;<span class="num" id="6049522">48</span><span class="op" id="6049524">,</span>&nbsp;<span class="num" id="6049526">41</span><span class="op" id="6049528">,</span>&nbsp;<span class="num" id="6049530">34</span><span class="op" id="6049532">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6049535">27</span><span class="op" id="6049537">,</span>&nbsp;<span class="num" id="6049539">20</span><span class="op" id="6049541">,</span>&nbsp;<span class="num" id="6049543">13</span><span class="op" id="6049545">,</span>&nbsp;<span class="num" id="6049547">6</span><span class="op" id="6049548">,</span>&nbsp;<span class="num" id="6049550">7</span><span class="op" id="6049551">,</span>&nbsp;<span class="num" id="6049553">14</span><span class="op" id="6049555">,</span>&nbsp;<span class="num" id="6049557">21</span><span class="op" id="6049559">,</span>&nbsp;<span class="num" id="6049561">28</span><span class="op" id="6049563">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6049566">35</span><span class="op" id="6049568">,</span>&nbsp;<span class="num" id="6049570">42</span><span class="op" id="6049572">,</span>&nbsp;<span class="num" id="6049574">49</span><span class="op" id="6049576">,</span>&nbsp;<span class="num" id="6049578">56</span><span class="op" id="6049580">,</span>&nbsp;<span class="num" id="6049582">57</span><span class="op" id="6049584">,</span>&nbsp;<span class="num" id="6049586">50</span><span class="op" id="6049588">,</span>&nbsp;<span class="num" id="6049590">43</span><span class="op" id="6049592">,</span>&nbsp;<span class="num" id="6049594">36</span><span class="op" id="6049596">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6049599">29</span><span class="op" id="6049601">,</span>&nbsp;<span class="num" id="6049603">22</span><span class="op" id="6049605">,</span>&nbsp;<span class="num" id="6049607">15</span><span class="op" id="6049609">,</span>&nbsp;<span class="num" id="6049611">23</span><span class="op" id="6049613">,</span>&nbsp;<span class="num" id="6049615">30</span><span class="op" id="6049617">,</span>&nbsp;<span class="num" id="6049619">37</span><span class="op" id="6049621">,</span>&nbsp;<span class="num" id="6049623">44</span><span class="op" id="6049625">,</span>&nbsp;<span class="num" id="6049627">51</span><span class="op" id="6049629">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6049632">58</span><span class="op" id="6049634">,</span>&nbsp;<span class="num" id="6049636">59</span><span class="op" id="6049638">,</span>&nbsp;<span class="num" id="6049640">52</span><span class="op" id="6049642">,</span>&nbsp;<span class="num" id="6049644">45</span><span class="op" id="6049646">,</span>&nbsp;<span class="num" id="6049648">38</span><span class="op" id="6049650">,</span>&nbsp;<span class="num" id="6049652">31</span><span class="op" id="6049654">,</span>&nbsp;<span class="num" id="6049656">39</span><span class="op" id="6049658">,</span>&nbsp;<span class="num" id="6049660">46</span><span class="op" id="6049662">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6049665">53</span><span class="op" id="6049667">,</span>&nbsp;<span class="num" id="6049669">60</span><span class="op" id="6049671">,</span>&nbsp;<span class="num" id="6049673">61</span><span class="op" id="6049675">,</span>&nbsp;<span class="num" id="6049677">54</span><span class="op" id="6049679">,</span>&nbsp;<span class="num" id="6049681">47</span><span class="op" id="6049683">,</span>&nbsp;<span class="num" id="6049685">55</span><span class="op" id="6049687">,</span>&nbsp;<span class="num" id="6049689">62</span><span class="op" id="6049691">,</span>&nbsp;<span class="num" id="6049693">63</span><span class="op" id="6049695">,</span><br>
<span class="lineno"></span><span class="op" id="6049697">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="6049700">//&nbsp;Reader&nbsp;is&nbsp;deprecated.</span><br>
<span class="lineno"></span><span class="keyword" id="6049725">type</span>&nbsp;<span class="ident" id="6049730">Reader</span>&nbsp;<span class="keyword" id="6049737">interface</span>&nbsp;<span class="op" id="6049747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049750">io</span><span class="op" id="6049752">.</span><span class="ident" id="6049753">ByteReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049765">io</span><span class="op" id="6049767">.</span><span class="ident" id="6049768">Reader</span><br>
<span class="lineno">90</span><span class="op" id="6049775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6049778">//&nbsp;bits&nbsp;holds&nbsp;the&nbsp;unprocessed&nbsp;bits&nbsp;that&nbsp;have&nbsp;been&nbsp;taken&nbsp;from&nbsp;the&nbsp;byte-stream.</span><br>
<span class="lineno"></span><span class="comment" id="6049856">//&nbsp;The&nbsp;n&nbsp;least&nbsp;significant&nbsp;bits&nbsp;of&nbsp;a&nbsp;form&nbsp;the&nbsp;unread&nbsp;bits,&nbsp;to&nbsp;be&nbsp;read&nbsp;in&nbsp;MSB&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6049936">//&nbsp;LSB&nbsp;order.</span><br>
<span class="lineno">95</span><span class="keyword" id="6049950">type</span>&nbsp;<span class="ident" id="6049955">bits</span>&nbsp;<span class="keyword" id="6049960">struct</span>&nbsp;<span class="op" id="6049967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049970">a</span>&nbsp;<span class="builtintype" id="6049972">uint32</span>&nbsp;<span class="comment" id="6049979">//&nbsp;accumulator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049996">m</span>&nbsp;<span class="builtintype" id="6049998">uint32</span>&nbsp;<span class="comment" id="6050005">//&nbsp;mask.&nbsp;m==1&lt;&lt;(n-1)&nbsp;when&nbsp;n&gt;0,&nbsp;with&nbsp;m==0&nbsp;when&nbsp;n==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050058">n</span>&nbsp;<span class="builtintype" id="6050060">int32</span>&nbsp;&nbsp;<span class="comment" id="6050067">//&nbsp;the&nbsp;number&nbsp;of&nbsp;unread&nbsp;bits&nbsp;in&nbsp;a.</span><br>
<span class="lineno"></span><span class="op" id="6050102">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="6050105">type</span>&nbsp;<span class="ident" id="6050110">decoder</span>&nbsp;<span class="keyword" id="6050118">struct</span>&nbsp;<span class="op" id="6050125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050128">r</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6050133">io</span><span class="op" id="6050135">.</span><span class="ident" id="6050136">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050144">bits</span>&nbsp;<span class="ident" id="6050149">bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050155">//&nbsp;bytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;buffer,&nbsp;similar&nbsp;to&nbsp;a&nbsp;bufio.Reader,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050225">//&nbsp;has&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;unread&nbsp;more&nbsp;than&nbsp;1&nbsp;byte,&nbsp;due&nbsp;to&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050294">//&nbsp;Byte&nbsp;stuffing&nbsp;is&nbsp;specified&nbsp;in&nbsp;section&nbsp;F.1.2.3.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050345">bytes</span>&nbsp;<span class="keyword" id="6050351">struct</span>&nbsp;<span class="op" id="6050358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050362">//&nbsp;buf[i:j]&nbsp;are&nbsp;the&nbsp;buffered&nbsp;bytes&nbsp;read&nbsp;from&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050424">//&nbsp;io.Reader&nbsp;that&nbsp;haven&#39;t&nbsp;yet&nbsp;been&nbsp;passed&nbsp;further&nbsp;on.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050480">buf</span>&nbsp;&nbsp;<span class="op" id="6050485">[</span><span class="num" id="6050486">4096</span><span class="op" id="6050490">]</span><span class="builtintype" id="6050491">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050498">i</span><span class="op" id="6050499">,</span>&nbsp;<span class="ident" id="6050501">j</span>&nbsp;<span class="builtintype" id="6050503">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050509">//&nbsp;nUnreadable&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;back&nbsp;up&nbsp;i&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050568">//&nbsp;overshooting.&nbsp;It&nbsp;can&nbsp;be&nbsp;0,&nbsp;1&nbsp;or&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050608">nUnreadable</span>&nbsp;<span class="builtintype" id="6050620">int</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050628">width</span><span class="op" id="6050633">,</span>&nbsp;<span class="ident" id="6050635">height</span>&nbsp;<span class="builtintype" id="6050642">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050647">img1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6050661">*</span><span class="ident" id="6050662">image</span><span class="op" id="6050667">.</span><span class="ident" id="6050668">Gray</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050674">img3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6050688">*</span><span class="ident" id="6050689">image</span><span class="op" id="6050694">.</span><span class="ident" id="6050695">YCbCr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050702">ri</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6050716">int</span>&nbsp;<span class="comment" id="6050720">//&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050742">nComp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6050756">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050761">progressive</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6050775">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050781">eobRun</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6050795">uint16</span>&nbsp;<span class="comment" id="6050802">//&nbsp;End-of-Band&nbsp;run,&nbsp;specified&nbsp;in&nbsp;section&nbsp;G.1.2.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050853">comp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6050867">[</span><span class="ident" id="6050868">nColorComponent</span><span class="op" id="6050883">]</span><span class="ident" id="6050884">component</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050895">progCoeffs</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6050909">[</span><span class="ident" id="6050910">nColorComponent</span><span class="op" id="6050925">]</span><span class="op" id="6050926">[</span><span class="op" id="6050927">]</span><span class="ident" id="6050928">block</span>&nbsp;<span class="comment" id="6050934">//&nbsp;Saved&nbsp;state&nbsp;between&nbsp;progressive-mode&nbsp;scans.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050982">huff</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6050996">[</span><span class="ident" id="6050997">maxTc</span>&nbsp;<span class="op" id="6051003">+</span>&nbsp;<span class="num" id="6051005">1</span><span class="op" id="6051006">]</span><span class="op" id="6051007">[</span><span class="ident" id="6051008">maxTh</span>&nbsp;<span class="op" id="6051014">+</span>&nbsp;<span class="num" id="6051016">1</span><span class="op" id="6051017">]</span><span class="ident" id="6051018">huffman</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051027">quant</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6051041">[</span><span class="ident" id="6051042">maxTq</span>&nbsp;<span class="op" id="6051048">+</span>&nbsp;<span class="num" id="6051050">1</span><span class="op" id="6051051">]</span><span class="ident" id="6051052">block</span>&nbsp;<span class="comment" id="6051058">//&nbsp;Quantization&nbsp;tables,&nbsp;in&nbsp;zig-zag&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051101">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6051115">[</span><span class="ident" id="6051116">blockSize</span>&nbsp;<span class="op" id="6051126">+</span>&nbsp;<span class="num" id="6051128">1</span><span class="op" id="6051129">]</span><span class="builtintype" id="6051130">byte</span><br>
<span class="lineno"></span><span class="op" id="6051135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="6051138">//&nbsp;fill&nbsp;fills&nbsp;up&nbsp;the&nbsp;d.bytes.buf&nbsp;buffer&nbsp;from&nbsp;the&nbsp;underlying&nbsp;io.Reader.&nbsp;It</span><br>
<span class="lineno"></span><span class="comment" id="6051212">//&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;there&nbsp;are&nbsp;no&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;d.bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="6051280">func</span>&nbsp;<span class="op" id="6051285">(</span><span class="ident" id="6051286">d</span>&nbsp;<span class="op" id="6051288">*</span><span class="ident" id="6051289">decoder</span><span class="op" id="6051296">)</span>&nbsp;<span class="ident" id="6051298">fill</span><span class="op" id="6051302">(</span><span class="op" id="6051303">)</span>&nbsp;<span class="builtintype" id="6051305">error</span>&nbsp;<span class="op" id="6051311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051314">if</span>&nbsp;<span class="ident" id="6051317">d</span><span class="op" id="6051318">.</span><span class="ident" id="6051319">bytes</span><span class="op" id="6051324">.</span><span class="ident" id="6051325">i</span>&nbsp;<span class="op" id="6051327">!=</span>&nbsp;<span class="ident" id="6051330">d</span><span class="op" id="6051331">.</span><span class="ident" id="6051332">bytes</span><span class="op" id="6051337">.</span><span class="ident" id="6051338">j</span>&nbsp;<span class="op" id="6051340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6051344">panic</span><span class="op" id="6051349">(</span><span class="string" id="6051350">&#34;jpeg:&nbsp;fill&nbsp;called&nbsp;when&nbsp;unread&nbsp;bytes&nbsp;exist&#34;</span><span class="op" id="6051393">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6051399">//&nbsp;Move&nbsp;the&nbsp;last&nbsp;2&nbsp;bytes&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer,&nbsp;in&nbsp;case&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6051469">//&nbsp;to&nbsp;call&nbsp;unreadByteStuffedByte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051504">if</span>&nbsp;<span class="ident" id="6051507">d</span><span class="op" id="6051508">.</span><span class="ident" id="6051509">bytes</span><span class="op" id="6051514">.</span><span class="ident" id="6051515">j</span>&nbsp;<span class="op" id="6051517">&gt;</span>&nbsp;<span class="num" id="6051519">2</span>&nbsp;<span class="op" id="6051521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051525">d</span><span class="op" id="6051526">.</span><span class="ident" id="6051527">bytes</span><span class="op" id="6051532">.</span><span class="ident" id="6051533">buf</span><span class="op" id="6051536">[</span><span class="num" id="6051537">0</span><span class="op" id="6051538">]</span>&nbsp;<span class="op" id="6051540">=</span>&nbsp;<span class="ident" id="6051542">d</span><span class="op" id="6051543">.</span><span class="ident" id="6051544">bytes</span><span class="op" id="6051549">.</span><span class="ident" id="6051550">buf</span><span class="op" id="6051553">[</span><span class="ident" id="6051554">d</span><span class="op" id="6051555">.</span><span class="ident" id="6051556">bytes</span><span class="op" id="6051561">.</span><span class="ident" id="6051562">j</span><span class="op" id="6051563">-</span><span class="num" id="6051564">2</span><span class="op" id="6051565">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051569">d</span><span class="op" id="6051570">.</span><span class="ident" id="6051571">bytes</span><span class="op" id="6051576">.</span><span class="ident" id="6051577">buf</span><span class="op" id="6051580">[</span><span class="num" id="6051581">1</span><span class="op" id="6051582">]</span>&nbsp;<span class="op" id="6051584">=</span>&nbsp;<span class="ident" id="6051586">d</span><span class="op" id="6051587">.</span><span class="ident" id="6051588">bytes</span><span class="op" id="6051593">.</span><span class="ident" id="6051594">buf</span><span class="op" id="6051597">[</span><span class="ident" id="6051598">d</span><span class="op" id="6051599">.</span><span class="ident" id="6051600">bytes</span><span class="op" id="6051605">.</span><span class="ident" id="6051606">j</span><span class="op" id="6051607">-</span><span class="num" id="6051608">1</span><span class="op" id="6051609">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051613">d</span><span class="op" id="6051614">.</span><span class="ident" id="6051615">bytes</span><span class="op" id="6051620">.</span><span class="ident" id="6051621">i</span><span class="op" id="6051622">,</span>&nbsp;<span class="ident" id="6051624">d</span><span class="op" id="6051625">.</span><span class="ident" id="6051626">bytes</span><span class="op" id="6051631">.</span><span class="ident" id="6051632">j</span>&nbsp;<span class="op" id="6051634">=</span>&nbsp;<span class="num" id="6051636">2</span><span class="op" id="6051637">,</span>&nbsp;<span class="num" id="6051639">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6051645">//&nbsp;Fill&nbsp;in&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051681">n</span><span class="op" id="6051682">,</span>&nbsp;<span class="ident" id="6051684">err</span>&nbsp;<span class="op" id="6051688">:=</span>&nbsp;<span class="ident" id="6051691">d</span><span class="op" id="6051692">.</span><span class="ident" id="6051693">r</span><span class="op" id="6051694">.</span><span class="ident" id="6051695">Read</span><span class="op" id="6051699">(</span><span class="ident" id="6051700">d</span><span class="op" id="6051701">.</span><span class="ident" id="6051702">bytes</span><span class="op" id="6051707">.</span><span class="ident" id="6051708">buf</span><span class="op" id="6051711">[</span><span class="ident" id="6051712">d</span><span class="op" id="6051713">.</span><span class="ident" id="6051714">bytes</span><span class="op" id="6051719">.</span><span class="ident" id="6051720">j</span><span class="op" id="6051721">:</span><span class="op" id="6051722">]</span><span class="op" id="6051723">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051726">d</span><span class="op" id="6051727">.</span><span class="ident" id="6051728">bytes</span><span class="op" id="6051733">.</span><span class="ident" id="6051734">j</span>&nbsp;<span class="op" id="6051736">+=</span>&nbsp;<span class="ident" id="6051739">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051742">if</span>&nbsp;<span class="ident" id="6051745">n</span>&nbsp;<span class="op" id="6051747">&gt;</span>&nbsp;<span class="num" id="6051749">0</span>&nbsp;<span class="op" id="6051751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051755">err</span>&nbsp;<span class="op" id="6051759">=</span>&nbsp;<span class="ident" id="6051761">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051769">return</span>&nbsp;<span class="ident" id="6051776">err</span><br>
<span class="lineno">150</span><span class="op" id="6051780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6051783">//&nbsp;unreadByteStuffedByte&nbsp;undoes&nbsp;the&nbsp;most&nbsp;recent&nbsp;readByteStuffedByte&nbsp;call,</span><br>
<span class="lineno"></span><span class="comment" id="6051857">//&nbsp;giving&nbsp;a&nbsp;byte&nbsp;of&nbsp;data&nbsp;back&nbsp;from&nbsp;d.bits&nbsp;to&nbsp;d.bytes.&nbsp;The&nbsp;Huffman&nbsp;look-up&nbsp;table</span><br>
<span class="lineno"></span><span class="comment" id="6051937">//&nbsp;requires&nbsp;at&nbsp;least&nbsp;8&nbsp;bits&nbsp;for&nbsp;look-up,&nbsp;which&nbsp;means&nbsp;that&nbsp;Huffman&nbsp;decoding&nbsp;can</span><br>
<span class="lineno">155</span><span class="comment" id="6052016">//&nbsp;sometimes&nbsp;overshoot&nbsp;and&nbsp;read&nbsp;one&nbsp;or&nbsp;two&nbsp;too&nbsp;many&nbsp;bytes.&nbsp;Two-byte&nbsp;overshoot</span><br>
<span class="lineno"></span><span class="comment" id="6052094">//&nbsp;can&nbsp;happen&nbsp;when&nbsp;expecting&nbsp;to&nbsp;read&nbsp;a&nbsp;0xff&nbsp;0x00&nbsp;byte-stuffed&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="6052162">func</span>&nbsp;<span class="op" id="6052167">(</span><span class="ident" id="6052168">d</span>&nbsp;<span class="op" id="6052170">*</span><span class="ident" id="6052171">decoder</span><span class="op" id="6052178">)</span>&nbsp;<span class="ident" id="6052180">unreadByteStuffedByte</span><span class="op" id="6052201">(</span><span class="op" id="6052202">)</span>&nbsp;<span class="op" id="6052204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052207">if</span>&nbsp;<span class="ident" id="6052210">d</span><span class="op" id="6052211">.</span><span class="ident" id="6052212">bytes</span><span class="op" id="6052217">.</span><span class="ident" id="6052218">nUnreadable</span>&nbsp;<span class="op" id="6052230">==</span>&nbsp;<span class="num" id="6052233">0</span>&nbsp;<span class="op" id="6052235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6052239">panic</span><span class="op" id="6052244">(</span><span class="string" id="6052245">&#34;jpeg:&nbsp;unreadByteStuffedByte&nbsp;call&nbsp;cannot&nbsp;be&nbsp;fulfilled&#34;</span><span class="op" id="6052299">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052305">d</span><span class="op" id="6052306">.</span><span class="ident" id="6052307">bytes</span><span class="op" id="6052312">.</span><span class="ident" id="6052313">i</span>&nbsp;<span class="op" id="6052315">-=</span>&nbsp;<span class="ident" id="6052318">d</span><span class="op" id="6052319">.</span><span class="ident" id="6052320">bytes</span><span class="op" id="6052325">.</span><span class="ident" id="6052326">nUnreadable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052339">d</span><span class="op" id="6052340">.</span><span class="ident" id="6052341">bytes</span><span class="op" id="6052346">.</span><span class="ident" id="6052347">nUnreadable</span>&nbsp;<span class="op" id="6052359">=</span>&nbsp;<span class="num" id="6052361">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052364">if</span>&nbsp;<span class="ident" id="6052367">d</span><span class="op" id="6052368">.</span><span class="ident" id="6052369">bits</span><span class="op" id="6052373">.</span><span class="ident" id="6052374">n</span>&nbsp;<span class="op" id="6052376">&gt;=</span>&nbsp;<span class="num" id="6052379">8</span>&nbsp;<span class="op" id="6052381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052385">d</span><span class="op" id="6052386">.</span><span class="ident" id="6052387">bits</span><span class="op" id="6052391">.</span><span class="ident" id="6052392">a</span>&nbsp;<span class="op" id="6052394">&gt;&gt;=</span>&nbsp;<span class="num" id="6052398">8</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052402">d</span><span class="op" id="6052403">.</span><span class="ident" id="6052404">bits</span><span class="op" id="6052408">.</span><span class="ident" id="6052409">n</span>&nbsp;<span class="op" id="6052411">-=</span>&nbsp;<span class="num" id="6052414">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052418">d</span><span class="op" id="6052419">.</span><span class="ident" id="6052420">bits</span><span class="op" id="6052424">.</span><span class="ident" id="6052425">m</span>&nbsp;<span class="op" id="6052427">&gt;&gt;=</span>&nbsp;<span class="num" id="6052431">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052434">}</span><br>
<span class="lineno"></span><span class="op" id="6052436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="6052439">//&nbsp;readByte&nbsp;returns&nbsp;the&nbsp;next&nbsp;byte,&nbsp;whether&nbsp;buffered&nbsp;or&nbsp;not&nbsp;buffered.&nbsp;It&nbsp;does</span><br>
<span class="lineno"></span><span class="comment" id="6052516">//&nbsp;not&nbsp;care&nbsp;about&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="6052549">func</span>&nbsp;<span class="op" id="6052554">(</span><span class="ident" id="6052555">d</span>&nbsp;<span class="op" id="6052557">*</span><span class="ident" id="6052558">decoder</span><span class="op" id="6052565">)</span>&nbsp;<span class="ident" id="6052567">readByte</span><span class="op" id="6052575">(</span><span class="op" id="6052576">)</span>&nbsp;<span class="op" id="6052578">(</span><span class="ident" id="6052579">x</span>&nbsp;<span class="builtintype" id="6052581">byte</span><span class="op" id="6052585">,</span>&nbsp;<span class="ident" id="6052587">err</span>&nbsp;<span class="builtintype" id="6052591">error</span><span class="op" id="6052596">)</span>&nbsp;<span class="op" id="6052598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052601">for</span>&nbsp;<span class="ident" id="6052605">d</span><span class="op" id="6052606">.</span><span class="ident" id="6052607">bytes</span><span class="op" id="6052612">.</span><span class="ident" id="6052613">i</span>&nbsp;<span class="op" id="6052615">==</span>&nbsp;<span class="ident" id="6052618">d</span><span class="op" id="6052619">.</span><span class="ident" id="6052620">bytes</span><span class="op" id="6052625">.</span><span class="ident" id="6052626">j</span>&nbsp;<span class="op" id="6052628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052632">if</span>&nbsp;<span class="ident" id="6052635">err</span>&nbsp;<span class="op" id="6052639">=</span>&nbsp;<span class="ident" id="6052641">d</span><span class="op" id="6052642">.</span><span class="ident" id="6052643">fill</span><span class="op" id="6052647">(</span><span class="op" id="6052648">)</span><span class="op" id="6052649">;</span>&nbsp;<span class="ident" id="6052651">err</span>&nbsp;<span class="op" id="6052655">!=</span>&nbsp;<span class="ident" id="6052658">nil</span>&nbsp;<span class="op" id="6052662">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052667">return</span>&nbsp;<span class="num" id="6052674">0</span><span class="op" id="6052675">,</span>&nbsp;<span class="ident" id="6052677">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052689">x</span>&nbsp;<span class="op" id="6052691">=</span>&nbsp;<span class="ident" id="6052693">d</span><span class="op" id="6052694">.</span><span class="ident" id="6052695">bytes</span><span class="op" id="6052700">.</span><span class="ident" id="6052701">buf</span><span class="op" id="6052704">[</span><span class="ident" id="6052705">d</span><span class="op" id="6052706">.</span><span class="ident" id="6052707">bytes</span><span class="op" id="6052712">.</span><span class="ident" id="6052713">i</span><span class="op" id="6052714">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052717">d</span><span class="op" id="6052718">.</span><span class="ident" id="6052719">bytes</span><span class="op" id="6052724">.</span><span class="ident" id="6052725">i</span><span class="op" id="6052726">++</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052730">d</span><span class="op" id="6052731">.</span><span class="ident" id="6052732">bytes</span><span class="op" id="6052737">.</span><span class="ident" id="6052738">nUnreadable</span>&nbsp;<span class="op" id="6052750">=</span>&nbsp;<span class="num" id="6052752">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052755">return</span>&nbsp;<span class="ident" id="6052762">x</span><span class="op" id="6052763">,</span>&nbsp;<span class="ident" id="6052765">nil</span><br>
<span class="lineno"></span><span class="op" id="6052769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6052772">//&nbsp;errMissingFF00&nbsp;means&nbsp;that&nbsp;readByteStuffedByte&nbsp;encountered&nbsp;an&nbsp;0xff&nbsp;byte&nbsp;(a</span><br>
<span class="lineno">185</span><span class="comment" id="6052849">//&nbsp;marker&nbsp;byte)&nbsp;that&nbsp;wasn&#39;t&nbsp;the&nbsp;expected&nbsp;byte-stuffed&nbsp;sequence&nbsp;0xff,&nbsp;0x00.</span><br>
<span class="lineno"></span><span class="keyword" id="6052924">var</span>&nbsp;<span class="ident" id="6052928">errMissingFF00</span>&nbsp;<span class="op" id="6052943">=</span>&nbsp;<span class="ident" id="6052945">FormatError</span><span class="op" id="6052956">(</span><span class="string" id="6052957">&#34;missing&nbsp;0xff00&nbsp;sequence&#34;</span><span class="op" id="6052982">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6052985">//&nbsp;readByteStuffedByte&nbsp;is&nbsp;like&nbsp;readByte&nbsp;but&nbsp;is&nbsp;for&nbsp;byte-stuffed&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6053063">func</span>&nbsp;<span class="op" id="6053068">(</span><span class="ident" id="6053069">d</span>&nbsp;<span class="op" id="6053071">*</span><span class="ident" id="6053072">decoder</span><span class="op" id="6053079">)</span>&nbsp;<span class="ident" id="6053081">readByteStuffedByte</span><span class="op" id="6053100">(</span><span class="op" id="6053101">)</span>&nbsp;<span class="op" id="6053103">(</span><span class="ident" id="6053104">x</span>&nbsp;<span class="builtintype" id="6053106">byte</span><span class="op" id="6053110">,</span>&nbsp;<span class="ident" id="6053112">err</span>&nbsp;<span class="builtintype" id="6053116">error</span><span class="op" id="6053121">)</span>&nbsp;<span class="op" id="6053123">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053126">//&nbsp;Take&nbsp;the&nbsp;fast&nbsp;path&nbsp;if&nbsp;d.bytes.buf&nbsp;contains&nbsp;at&nbsp;least&nbsp;two&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053193">if</span>&nbsp;<span class="ident" id="6053196">d</span><span class="op" id="6053197">.</span><span class="ident" id="6053198">bytes</span><span class="op" id="6053203">.</span><span class="ident" id="6053204">i</span><span class="op" id="6053205">+</span><span class="num" id="6053206">2</span>&nbsp;<span class="op" id="6053208">&lt;=</span>&nbsp;<span class="ident" id="6053211">d</span><span class="op" id="6053212">.</span><span class="ident" id="6053213">bytes</span><span class="op" id="6053218">.</span><span class="ident" id="6053219">j</span>&nbsp;<span class="op" id="6053221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053225">x</span>&nbsp;<span class="op" id="6053227">=</span>&nbsp;<span class="ident" id="6053229">d</span><span class="op" id="6053230">.</span><span class="ident" id="6053231">bytes</span><span class="op" id="6053236">.</span><span class="ident" id="6053237">buf</span><span class="op" id="6053240">[</span><span class="ident" id="6053241">d</span><span class="op" id="6053242">.</span><span class="ident" id="6053243">bytes</span><span class="op" id="6053248">.</span><span class="ident" id="6053249">i</span><span class="op" id="6053250">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053254">d</span><span class="op" id="6053255">.</span><span class="ident" id="6053256">bytes</span><span class="op" id="6053261">.</span><span class="ident" id="6053262">i</span><span class="op" id="6053263">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053268">d</span><span class="op" id="6053269">.</span><span class="ident" id="6053270">bytes</span><span class="op" id="6053275">.</span><span class="ident" id="6053276">nUnreadable</span>&nbsp;<span class="op" id="6053288">=</span>&nbsp;<span class="num" id="6053290">1</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053294">if</span>&nbsp;<span class="ident" id="6053297">x</span>&nbsp;<span class="op" id="6053299">!=</span>&nbsp;<span class="num" id="6053302">0xff</span>&nbsp;<span class="op" id="6053307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053312">return</span>&nbsp;<span class="ident" id="6053319">x</span><span class="op" id="6053320">,</span>&nbsp;<span class="ident" id="6053322">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053332">if</span>&nbsp;<span class="ident" id="6053335">d</span><span class="op" id="6053336">.</span><span class="ident" id="6053337">bytes</span><span class="op" id="6053342">.</span><span class="ident" id="6053343">buf</span><span class="op" id="6053346">[</span><span class="ident" id="6053347">d</span><span class="op" id="6053348">.</span><span class="ident" id="6053349">bytes</span><span class="op" id="6053354">.</span><span class="ident" id="6053355">i</span><span class="op" id="6053356">]</span>&nbsp;<span class="op" id="6053358">!=</span>&nbsp;<span class="num" id="6053361">0x00</span>&nbsp;<span class="op" id="6053366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053371">return</span>&nbsp;<span class="num" id="6053378">0</span><span class="op" id="6053379">,</span>&nbsp;<span class="ident" id="6053381">errMissingFF00</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053402">d</span><span class="op" id="6053403">.</span><span class="ident" id="6053404">bytes</span><span class="op" id="6053409">.</span><span class="ident" id="6053410">i</span><span class="op" id="6053411">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053416">d</span><span class="op" id="6053417">.</span><span class="ident" id="6053418">bytes</span><span class="op" id="6053423">.</span><span class="ident" id="6053424">nUnreadable</span>&nbsp;<span class="op" id="6053436">=</span>&nbsp;<span class="num" id="6053438">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053442">return</span>&nbsp;<span class="num" id="6053449">0xff</span><span class="op" id="6053453">,</span>&nbsp;<span class="ident" id="6053455">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053460">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053464">x</span><span class="op" id="6053465">,</span>&nbsp;<span class="ident" id="6053467">err</span>&nbsp;<span class="op" id="6053471">=</span>&nbsp;<span class="ident" id="6053473">d</span><span class="op" id="6053474">.</span><span class="ident" id="6053475">readByte</span><span class="op" id="6053483">(</span><span class="op" id="6053484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053487">if</span>&nbsp;<span class="ident" id="6053490">err</span>&nbsp;<span class="op" id="6053494">!=</span>&nbsp;<span class="ident" id="6053497">nil</span>&nbsp;<span class="op" id="6053501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053505">return</span>&nbsp;<span class="num" id="6053512">0</span><span class="op" id="6053513">,</span>&nbsp;<span class="ident" id="6053515">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053520">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053523">if</span>&nbsp;<span class="ident" id="6053526">x</span>&nbsp;<span class="op" id="6053528">!=</span>&nbsp;<span class="num" id="6053531">0xff</span>&nbsp;<span class="op" id="6053536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053540">d</span><span class="op" id="6053541">.</span><span class="ident" id="6053542">bytes</span><span class="op" id="6053547">.</span><span class="ident" id="6053548">nUnreadable</span>&nbsp;<span class="op" id="6053560">=</span>&nbsp;<span class="num" id="6053562">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053566">return</span>&nbsp;<span class="ident" id="6053573">x</span><span class="op" id="6053574">,</span>&nbsp;<span class="ident" id="6053576">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053585">x</span><span class="op" id="6053586">,</span>&nbsp;<span class="ident" id="6053588">err</span>&nbsp;<span class="op" id="6053592">=</span>&nbsp;<span class="ident" id="6053594">d</span><span class="op" id="6053595">.</span><span class="ident" id="6053596">readByte</span><span class="op" id="6053604">(</span><span class="op" id="6053605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053608">if</span>&nbsp;<span class="ident" id="6053611">err</span>&nbsp;<span class="op" id="6053615">!=</span>&nbsp;<span class="ident" id="6053618">nil</span>&nbsp;<span class="op" id="6053622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053626">d</span><span class="op" id="6053627">.</span><span class="ident" id="6053628">bytes</span><span class="op" id="6053633">.</span><span class="ident" id="6053634">nUnreadable</span>&nbsp;<span class="op" id="6053646">=</span>&nbsp;<span class="num" id="6053648">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053652">return</span>&nbsp;<span class="num" id="6053659">0</span><span class="op" id="6053660">,</span>&nbsp;<span class="ident" id="6053662">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053667">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053670">d</span><span class="op" id="6053671">.</span><span class="ident" id="6053672">bytes</span><span class="op" id="6053677">.</span><span class="ident" id="6053678">nUnreadable</span>&nbsp;<span class="op" id="6053690">=</span>&nbsp;<span class="num" id="6053692">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053695">if</span>&nbsp;<span class="ident" id="6053698">x</span>&nbsp;<span class="op" id="6053700">!=</span>&nbsp;<span class="num" id="6053703">0x00</span>&nbsp;<span class="op" id="6053708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053712">return</span>&nbsp;<span class="num" id="6053719">0</span><span class="op" id="6053720">,</span>&nbsp;<span class="ident" id="6053722">errMissingFF00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053741">return</span>&nbsp;<span class="num" id="6053748">0xff</span><span class="op" id="6053752">,</span>&nbsp;<span class="ident" id="6053754">nil</span><br>
<span class="lineno">225</span><span class="op" id="6053758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6053761">//&nbsp;readFull&nbsp;reads&nbsp;exactly&nbsp;len(p)&nbsp;bytes&nbsp;into&nbsp;p.&nbsp;It&nbsp;does&nbsp;not&nbsp;care&nbsp;about&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="6053836">//&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="6053849">func</span>&nbsp;<span class="op" id="6053854">(</span><span class="ident" id="6053855">d</span>&nbsp;<span class="op" id="6053857">*</span><span class="ident" id="6053858">decoder</span><span class="op" id="6053865">)</span>&nbsp;<span class="ident" id="6053867">readFull</span><span class="op" id="6053875">(</span><span class="ident" id="6053876">p</span>&nbsp;<span class="op" id="6053878">[</span><span class="op" id="6053879">]</span><span class="builtintype" id="6053880">byte</span><span class="op" id="6053884">)</span>&nbsp;<span class="builtintype" id="6053886">error</span>&nbsp;<span class="op" id="6053892">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053895">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053934">if</span>&nbsp;<span class="ident" id="6053937">d</span><span class="op" id="6053938">.</span><span class="ident" id="6053939">bytes</span><span class="op" id="6053944">.</span><span class="ident" id="6053945">nUnreadable</span>&nbsp;<span class="op" id="6053957">!=</span>&nbsp;<span class="num" id="6053960">0</span>&nbsp;<span class="op" id="6053962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053966">if</span>&nbsp;<span class="ident" id="6053969">d</span><span class="op" id="6053970">.</span><span class="ident" id="6053971">bits</span><span class="op" id="6053975">.</span><span class="ident" id="6053976">n</span>&nbsp;<span class="op" id="6053978">&gt;=</span>&nbsp;<span class="num" id="6053981">8</span>&nbsp;<span class="op" id="6053983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053988">d</span><span class="op" id="6053989">.</span><span class="ident" id="6053990">unreadByteStuffedByte</span><span class="op" id="6054011">(</span><span class="op" id="6054012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054016">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054020">d</span><span class="op" id="6054021">.</span><span class="ident" id="6054022">bytes</span><span class="op" id="6054027">.</span><span class="ident" id="6054028">nUnreadable</span>&nbsp;<span class="op" id="6054040">=</span>&nbsp;<span class="num" id="6054042">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054049">for</span>&nbsp;<span class="op" id="6054053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054057">n</span>&nbsp;<span class="op" id="6054059">:=</span>&nbsp;<span class="builtinfunc" id="6054062">copy</span><span class="op" id="6054066">(</span><span class="ident" id="6054067">p</span><span class="op" id="6054068">,</span>&nbsp;<span class="ident" id="6054070">d</span><span class="op" id="6054071">.</span><span class="ident" id="6054072">bytes</span><span class="op" id="6054077">.</span><span class="ident" id="6054078">buf</span><span class="op" id="6054081">[</span><span class="ident" id="6054082">d</span><span class="op" id="6054083">.</span><span class="ident" id="6054084">bytes</span><span class="op" id="6054089">.</span><span class="ident" id="6054090">i</span><span class="op" id="6054091">:</span><span class="ident" id="6054092">d</span><span class="op" id="6054093">.</span><span class="ident" id="6054094">bytes</span><span class="op" id="6054099">.</span><span class="ident" id="6054100">j</span><span class="op" id="6054101">]</span><span class="op" id="6054102">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054106">p</span>&nbsp;<span class="op" id="6054108">=</span>&nbsp;<span class="ident" id="6054110">p</span><span class="op" id="6054111">[</span><span class="ident" id="6054112">n</span><span class="op" id="6054113">:</span><span class="op" id="6054114">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054118">d</span><span class="op" id="6054119">.</span><span class="ident" id="6054120">bytes</span><span class="op" id="6054125">.</span><span class="ident" id="6054126">i</span>&nbsp;<span class="op" id="6054128">+=</span>&nbsp;<span class="ident" id="6054131">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054135">if</span>&nbsp;<span class="builtinfunc" id="6054138">len</span><span class="op" id="6054141">(</span><span class="ident" id="6054142">p</span><span class="op" id="6054143">)</span>&nbsp;<span class="op" id="6054145">==</span>&nbsp;<span class="num" id="6054148">0</span>&nbsp;<span class="op" id="6054150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054155">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054163">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054167">if</span>&nbsp;<span class="ident" id="6054170">err</span>&nbsp;<span class="op" id="6054174">:=</span>&nbsp;<span class="ident" id="6054177">d</span><span class="op" id="6054178">.</span><span class="ident" id="6054179">fill</span><span class="op" id="6054183">(</span><span class="op" id="6054184">)</span><span class="op" id="6054185">;</span>&nbsp;<span class="ident" id="6054187">err</span>&nbsp;<span class="op" id="6054191">!=</span>&nbsp;<span class="ident" id="6054194">nil</span>&nbsp;<span class="op" id="6054198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054203">if</span>&nbsp;<span class="ident" id="6054206">err</span>&nbsp;<span class="op" id="6054210">==</span>&nbsp;<span class="ident" id="6054213">io</span><span class="op" id="6054215">.</span><span class="ident" id="6054216">EOF</span>&nbsp;<span class="op" id="6054220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054226">err</span>&nbsp;<span class="op" id="6054230">=</span>&nbsp;<span class="ident" id="6054232">io</span><span class="op" id="6054234">.</span><span class="ident" id="6054235">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054260">return</span>&nbsp;<span class="ident" id="6054267">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054279">return</span>&nbsp;<span class="ident" id="6054286">nil</span><br>
<span class="lineno"></span><span class="op" id="6054290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="6054293">//&nbsp;ignore&nbsp;ignores&nbsp;the&nbsp;next&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="6054329">func</span>&nbsp;<span class="op" id="6054334">(</span><span class="ident" id="6054335">d</span>&nbsp;<span class="op" id="6054337">*</span><span class="ident" id="6054338">decoder</span><span class="op" id="6054345">)</span>&nbsp;<span class="ident" id="6054347">ignore</span><span class="op" id="6054353">(</span><span class="ident" id="6054354">n</span>&nbsp;<span class="builtintype" id="6054356">int</span><span class="op" id="6054359">)</span>&nbsp;<span class="builtintype" id="6054361">error</span>&nbsp;<span class="op" id="6054367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6054370">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054409">if</span>&nbsp;<span class="ident" id="6054412">d</span><span class="op" id="6054413">.</span><span class="ident" id="6054414">bytes</span><span class="op" id="6054419">.</span><span class="ident" id="6054420">nUnreadable</span>&nbsp;<span class="op" id="6054432">!=</span>&nbsp;<span class="num" id="6054435">0</span>&nbsp;<span class="op" id="6054437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054441">if</span>&nbsp;<span class="ident" id="6054444">d</span><span class="op" id="6054445">.</span><span class="ident" id="6054446">bits</span><span class="op" id="6054450">.</span><span class="ident" id="6054451">n</span>&nbsp;<span class="op" id="6054453">&gt;=</span>&nbsp;<span class="num" id="6054456">8</span>&nbsp;<span class="op" id="6054458">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054463">d</span><span class="op" id="6054464">.</span><span class="ident" id="6054465">unreadByteStuffedByte</span><span class="op" id="6054486">(</span><span class="op" id="6054487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054495">d</span><span class="op" id="6054496">.</span><span class="ident" id="6054497">bytes</span><span class="op" id="6054502">.</span><span class="ident" id="6054503">nUnreadable</span>&nbsp;<span class="op" id="6054515">=</span>&nbsp;<span class="num" id="6054517">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054524">for</span>&nbsp;<span class="op" id="6054528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054532">m</span>&nbsp;<span class="op" id="6054534">:=</span>&nbsp;<span class="ident" id="6054537">d</span><span class="op" id="6054538">.</span><span class="ident" id="6054539">bytes</span><span class="op" id="6054544">.</span><span class="ident" id="6054545">j</span>&nbsp;<span class="op" id="6054547">-</span>&nbsp;<span class="ident" id="6054549">d</span><span class="op" id="6054550">.</span><span class="ident" id="6054551">bytes</span><span class="op" id="6054556">.</span><span class="ident" id="6054557">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054561">if</span>&nbsp;<span class="ident" id="6054564">m</span>&nbsp;<span class="op" id="6054566">&gt;</span>&nbsp;<span class="ident" id="6054568">n</span>&nbsp;<span class="op" id="6054570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054575">m</span>&nbsp;<span class="op" id="6054577">=</span>&nbsp;<span class="ident" id="6054579">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054583">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054587">d</span><span class="op" id="6054588">.</span><span class="ident" id="6054589">bytes</span><span class="op" id="6054594">.</span><span class="ident" id="6054595">i</span>&nbsp;<span class="op" id="6054597">+=</span>&nbsp;<span class="ident" id="6054600">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054604">n</span>&nbsp;<span class="op" id="6054606">-=</span>&nbsp;<span class="ident" id="6054609">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054613">if</span>&nbsp;<span class="ident" id="6054616">n</span>&nbsp;<span class="op" id="6054618">==</span>&nbsp;<span class="num" id="6054621">0</span>&nbsp;<span class="op" id="6054623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054628">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054636">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054640">if</span>&nbsp;<span class="ident" id="6054643">err</span>&nbsp;<span class="op" id="6054647">:=</span>&nbsp;<span class="ident" id="6054650">d</span><span class="op" id="6054651">.</span><span class="ident" id="6054652">fill</span><span class="op" id="6054656">(</span><span class="op" id="6054657">)</span><span class="op" id="6054658">;</span>&nbsp;<span class="ident" id="6054660">err</span>&nbsp;<span class="op" id="6054664">!=</span>&nbsp;<span class="ident" id="6054667">nil</span>&nbsp;<span class="op" id="6054671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054676">if</span>&nbsp;<span class="ident" id="6054679">err</span>&nbsp;<span class="op" id="6054683">==</span>&nbsp;<span class="ident" id="6054686">io</span><span class="op" id="6054688">.</span><span class="ident" id="6054689">EOF</span>&nbsp;<span class="op" id="6054693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054699">err</span>&nbsp;<span class="op" id="6054703">=</span>&nbsp;<span class="ident" id="6054705">io</span><span class="op" id="6054707">.</span><span class="ident" id="6054708">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054733">return</span>&nbsp;<span class="ident" id="6054740">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054752">return</span>&nbsp;<span class="ident" id="6054759">nil</span><br>
<span class="lineno"></span><span class="op" id="6054763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="6054766">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno"></span><span class="keyword" id="6054797">func</span>&nbsp;<span class="op" id="6054802">(</span><span class="ident" id="6054803">d</span>&nbsp;<span class="op" id="6054805">*</span><span class="ident" id="6054806">decoder</span><span class="op" id="6054813">)</span>&nbsp;<span class="ident" id="6054815">processSOF</span><span class="op" id="6054825">(</span><span class="ident" id="6054826">n</span>&nbsp;<span class="builtintype" id="6054828">int</span><span class="op" id="6054831">)</span>&nbsp;<span class="builtintype" id="6054833">error</span>&nbsp;<span class="op" id="6054839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054842">switch</span>&nbsp;<span class="ident" id="6054849">n</span>&nbsp;<span class="op" id="6054851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054854">case</span>&nbsp;<span class="num" id="6054859">6</span>&nbsp;<span class="op" id="6054861">+</span>&nbsp;<span class="num" id="6054863">3</span><span class="op" id="6054864">*</span><span class="ident" id="6054865">nGrayComponent</span><span class="op" id="6054879">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054883">d</span><span class="op" id="6054884">.</span><span class="ident" id="6054885">nComp</span>&nbsp;<span class="op" id="6054891">=</span>&nbsp;<span class="ident" id="6054893">nGrayComponent</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054909">case</span>&nbsp;<span class="num" id="6054914">6</span>&nbsp;<span class="op" id="6054916">+</span>&nbsp;<span class="num" id="6054918">3</span><span class="op" id="6054919">*</span><span class="ident" id="6054920">nColorComponent</span><span class="op" id="6054935">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054939">d</span><span class="op" id="6054940">.</span><span class="ident" id="6054941">nComp</span>&nbsp;<span class="op" id="6054947">=</span>&nbsp;<span class="ident" id="6054949">nColorComponent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054966">default</span><span class="op" id="6054973">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054977">return</span>&nbsp;<span class="ident" id="6054984">UnsupportedError</span><span class="op" id="6055000">(</span><span class="string" id="6055001">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6055023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055026">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055029">if</span>&nbsp;<span class="ident" id="6055032">err</span>&nbsp;<span class="op" id="6055036">:=</span>&nbsp;<span class="ident" id="6055039">d</span><span class="op" id="6055040">.</span><span class="ident" id="6055041">readFull</span><span class="op" id="6055049">(</span><span class="ident" id="6055050">d</span><span class="op" id="6055051">.</span><span class="ident" id="6055052">tmp</span><span class="op" id="6055055">[</span><span class="op" id="6055056">:</span><span class="ident" id="6055057">n</span><span class="op" id="6055058">]</span><span class="op" id="6055059">)</span><span class="op" id="6055060">;</span>&nbsp;<span class="ident" id="6055062">err</span>&nbsp;<span class="op" id="6055066">!=</span>&nbsp;<span class="ident" id="6055069">nil</span>&nbsp;<span class="op" id="6055073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055077">return</span>&nbsp;<span class="ident" id="6055084">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055092">//&nbsp;We&nbsp;only&nbsp;support&nbsp;8-bit&nbsp;precision.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055129">if</span>&nbsp;<span class="ident" id="6055132">d</span><span class="op" id="6055133">.</span><span class="ident" id="6055134">tmp</span><span class="op" id="6055137">[</span><span class="num" id="6055138">0</span><span class="op" id="6055139">]</span>&nbsp;<span class="op" id="6055141">!=</span>&nbsp;<span class="num" id="6055144">8</span>&nbsp;<span class="op" id="6055146">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055150">return</span>&nbsp;<span class="ident" id="6055157">UnsupportedError</span><span class="op" id="6055173">(</span><span class="string" id="6055174">&#34;precision&#34;</span><span class="op" id="6055185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055191">d</span><span class="op" id="6055192">.</span><span class="ident" id="6055193">height</span>&nbsp;<span class="op" id="6055200">=</span>&nbsp;<span class="builtintype" id="6055202">int</span><span class="op" id="6055205">(</span><span class="ident" id="6055206">d</span><span class="op" id="6055207">.</span><span class="ident" id="6055208">tmp</span><span class="op" id="6055211">[</span><span class="num" id="6055212">1</span><span class="op" id="6055213">]</span><span class="op" id="6055214">)</span><span class="op" id="6055215">&lt;&lt;</span><span class="num" id="6055217">8</span>&nbsp;<span class="op" id="6055219">+</span>&nbsp;<span class="builtintype" id="6055221">int</span><span class="op" id="6055224">(</span><span class="ident" id="6055225">d</span><span class="op" id="6055226">.</span><span class="ident" id="6055227">tmp</span><span class="op" id="6055230">[</span><span class="num" id="6055231">2</span><span class="op" id="6055232">]</span><span class="op" id="6055233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055236">d</span><span class="op" id="6055237">.</span><span class="ident" id="6055238">width</span>&nbsp;<span class="op" id="6055244">=</span>&nbsp;<span class="builtintype" id="6055246">int</span><span class="op" id="6055249">(</span><span class="ident" id="6055250">d</span><span class="op" id="6055251">.</span><span class="ident" id="6055252">tmp</span><span class="op" id="6055255">[</span><span class="num" id="6055256">3</span><span class="op" id="6055257">]</span><span class="op" id="6055258">)</span><span class="op" id="6055259">&lt;&lt;</span><span class="num" id="6055261">8</span>&nbsp;<span class="op" id="6055263">+</span>&nbsp;<span class="builtintype" id="6055265">int</span><span class="op" id="6055268">(</span><span class="ident" id="6055269">d</span><span class="op" id="6055270">.</span><span class="ident" id="6055271">tmp</span><span class="op" id="6055274">[</span><span class="num" id="6055275">4</span><span class="op" id="6055276">]</span><span class="op" id="6055277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055280">if</span>&nbsp;<span class="builtintype" id="6055283">int</span><span class="op" id="6055286">(</span><span class="ident" id="6055287">d</span><span class="op" id="6055288">.</span><span class="ident" id="6055289">tmp</span><span class="op" id="6055292">[</span><span class="num" id="6055293">5</span><span class="op" id="6055294">]</span><span class="op" id="6055295">)</span>&nbsp;<span class="op" id="6055297">!=</span>&nbsp;<span class="ident" id="6055300">d</span><span class="op" id="6055301">.</span><span class="ident" id="6055302">nComp</span>&nbsp;<span class="op" id="6055308">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055312">return</span>&nbsp;<span class="ident" id="6055319">UnsupportedError</span><span class="op" id="6055335">(</span><span class="string" id="6055336">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;image&nbsp;components&#34;</span><span class="op" id="6055378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055384">for</span>&nbsp;<span class="ident" id="6055388">i</span>&nbsp;<span class="op" id="6055390">:=</span>&nbsp;<span class="num" id="6055393">0</span><span class="op" id="6055394">;</span>&nbsp;<span class="ident" id="6055396">i</span>&nbsp;<span class="op" id="6055398">&lt;</span>&nbsp;<span class="ident" id="6055400">d</span><span class="op" id="6055401">.</span><span class="ident" id="6055402">nComp</span><span class="op" id="6055407">;</span>&nbsp;<span class="ident" id="6055409">i</span><span class="op" id="6055410">++</span>&nbsp;<span class="op" id="6055413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055417">d</span><span class="op" id="6055418">.</span><span class="ident" id="6055419">comp</span><span class="op" id="6055423">[</span><span class="ident" id="6055424">i</span><span class="op" id="6055425">]</span><span class="op" id="6055426">.</span><span class="ident" id="6055427">c</span>&nbsp;<span class="op" id="6055429">=</span>&nbsp;<span class="ident" id="6055431">d</span><span class="op" id="6055432">.</span><span class="ident" id="6055433">tmp</span><span class="op" id="6055436">[</span><span class="num" id="6055437">6</span><span class="op" id="6055438">+</span><span class="num" id="6055439">3</span><span class="op" id="6055440">*</span><span class="ident" id="6055441">i</span><span class="op" id="6055442">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055446">d</span><span class="op" id="6055447">.</span><span class="ident" id="6055448">comp</span><span class="op" id="6055452">[</span><span class="ident" id="6055453">i</span><span class="op" id="6055454">]</span><span class="op" id="6055455">.</span><span class="ident" id="6055456">tq</span>&nbsp;<span class="op" id="6055459">=</span>&nbsp;<span class="ident" id="6055461">d</span><span class="op" id="6055462">.</span><span class="ident" id="6055463">tmp</span><span class="op" id="6055466">[</span><span class="num" id="6055467">8</span><span class="op" id="6055468">+</span><span class="num" id="6055469">3</span><span class="op" id="6055470">*</span><span class="ident" id="6055471">i</span><span class="op" id="6055472">]</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055476">if</span>&nbsp;<span class="ident" id="6055479">d</span><span class="op" id="6055480">.</span><span class="ident" id="6055481">nComp</span>&nbsp;<span class="op" id="6055487">==</span>&nbsp;<span class="ident" id="6055490">nGrayComponent</span>&nbsp;<span class="op" id="6055505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055510">//&nbsp;If&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;one&nbsp;component,&nbsp;section&nbsp;A.2&nbsp;says&nbsp;&#34;this&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055584">//&nbsp;is&nbsp;non-interleaved&nbsp;by&nbsp;definition&#34;&nbsp;and&nbsp;section&nbsp;A.2.2&nbsp;says&nbsp;&#34;[in&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055657">//&nbsp;case...]&nbsp;the&nbsp;order&nbsp;of&nbsp;data&nbsp;units&nbsp;within&nbsp;a&nbsp;scan&nbsp;shall&nbsp;be&nbsp;left-to-right</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055733">//&nbsp;and&nbsp;top-to-bottom...&nbsp;regardless&nbsp;of&nbsp;the&nbsp;values&nbsp;of&nbsp;H_1&nbsp;and&nbsp;V_1&#34;.&nbsp;Section</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055810">//&nbsp;4.8.2&nbsp;also&nbsp;says&nbsp;&#34;[for&nbsp;non-interleaved&nbsp;data],&nbsp;the&nbsp;MCU&nbsp;is&nbsp;defined&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055886">//&nbsp;one&nbsp;data&nbsp;unit&#34;.&nbsp;Similarly,&nbsp;section&nbsp;A.1.1&nbsp;explains&nbsp;that&nbsp;it&nbsp;is&nbsp;the&nbsp;ratio</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055963">//&nbsp;of&nbsp;H_i&nbsp;to&nbsp;max_j(H_j)&nbsp;that&nbsp;matters,&nbsp;and&nbsp;similarly&nbsp;for&nbsp;V.&nbsp;For&nbsp;grayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056039">//&nbsp;images,&nbsp;H_1&nbsp;is&nbsp;the&nbsp;maximum&nbsp;H_j&nbsp;for&nbsp;all&nbsp;components&nbsp;j,&nbsp;so&nbsp;that&nbsp;ratio&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056115">//&nbsp;always&nbsp;1.&nbsp;The&nbsp;component&#39;s&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;effectively&nbsp;always&nbsp;(1,&nbsp;1):&nbsp;even&nbsp;if</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056192">//&nbsp;the&nbsp;nominal&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;(2,&nbsp;1),&nbsp;a&nbsp;20x5&nbsp;image&nbsp;is&nbsp;encoded&nbsp;in&nbsp;three&nbsp;8x8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056265">//&nbsp;MCUs,&nbsp;not&nbsp;two&nbsp;16x8&nbsp;MCUs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056296">d</span><span class="op" id="6056297">.</span><span class="ident" id="6056298">comp</span><span class="op" id="6056302">[</span><span class="ident" id="6056303">i</span><span class="op" id="6056304">]</span><span class="op" id="6056305">.</span><span class="ident" id="6056306">h</span>&nbsp;<span class="op" id="6056308">=</span>&nbsp;<span class="num" id="6056310">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056315">d</span><span class="op" id="6056316">.</span><span class="ident" id="6056317">comp</span><span class="op" id="6056321">[</span><span class="ident" id="6056322">i</span><span class="op" id="6056323">]</span><span class="op" id="6056324">.</span><span class="ident" id="6056325">v</span>&nbsp;<span class="op" id="6056327">=</span>&nbsp;<span class="num" id="6056329">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056334">continue</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056349">hv</span>&nbsp;<span class="op" id="6056352">:=</span>&nbsp;<span class="ident" id="6056355">d</span><span class="op" id="6056356">.</span><span class="ident" id="6056357">tmp</span><span class="op" id="6056360">[</span><span class="num" id="6056361">7</span><span class="op" id="6056362">+</span><span class="num" id="6056363">3</span><span class="op" id="6056364">*</span><span class="ident" id="6056365">i</span><span class="op" id="6056366">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056370">d</span><span class="op" id="6056371">.</span><span class="ident" id="6056372">comp</span><span class="op" id="6056376">[</span><span class="ident" id="6056377">i</span><span class="op" id="6056378">]</span><span class="op" id="6056379">.</span><span class="ident" id="6056380">h</span>&nbsp;<span class="op" id="6056382">=</span>&nbsp;<span class="builtintype" id="6056384">int</span><span class="op" id="6056387">(</span><span class="ident" id="6056388">hv</span>&nbsp;<span class="op" id="6056391">&gt;&gt;</span>&nbsp;<span class="num" id="6056394">4</span><span class="op" id="6056395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056399">d</span><span class="op" id="6056400">.</span><span class="ident" id="6056401">comp</span><span class="op" id="6056405">[</span><span class="ident" id="6056406">i</span><span class="op" id="6056407">]</span><span class="op" id="6056408">.</span><span class="ident" id="6056409">v</span>&nbsp;<span class="op" id="6056411">=</span>&nbsp;<span class="builtintype" id="6056413">int</span><span class="op" id="6056416">(</span><span class="ident" id="6056417">hv</span>&nbsp;<span class="op" id="6056420">&amp;</span>&nbsp;<span class="num" id="6056422">0x0f</span><span class="op" id="6056426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056430">//&nbsp;For&nbsp;color&nbsp;images,&nbsp;we&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;or&nbsp;4:2:0&nbsp;chroma</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056505">//&nbsp;downsampling&nbsp;ratios.&nbsp;This&nbsp;implies&nbsp;that&nbsp;the&nbsp;(h,&nbsp;v)&nbsp;values&nbsp;for&nbsp;the&nbsp;Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056577">//&nbsp;component&nbsp;are&nbsp;either&nbsp;(1,&nbsp;1),&nbsp;(1,&nbsp;2),&nbsp;(2,&nbsp;1)&nbsp;or&nbsp;(2,&nbsp;2),&nbsp;and&nbsp;the&nbsp;(h,&nbsp;v)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056652">//&nbsp;values&nbsp;for&nbsp;the&nbsp;Cr&nbsp;and&nbsp;Cb&nbsp;components&nbsp;must&nbsp;be&nbsp;(1,&nbsp;1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056709">if</span>&nbsp;<span class="ident" id="6056712">i</span>&nbsp;<span class="op" id="6056714">==</span>&nbsp;<span class="num" id="6056717">0</span>&nbsp;<span class="op" id="6056719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056724">if</span>&nbsp;<span class="ident" id="6056727">hv</span>&nbsp;<span class="op" id="6056730">!=</span>&nbsp;<span class="num" id="6056733">0x11</span>&nbsp;<span class="op" id="6056738">&amp;&amp;</span>&nbsp;<span class="ident" id="6056741">hv</span>&nbsp;<span class="op" id="6056744">!=</span>&nbsp;<span class="num" id="6056747">0x21</span>&nbsp;<span class="op" id="6056752">&amp;&amp;</span>&nbsp;<span class="ident" id="6056755">hv</span>&nbsp;<span class="op" id="6056758">!=</span>&nbsp;<span class="num" id="6056761">0x22</span>&nbsp;<span class="op" id="6056766">&amp;&amp;</span>&nbsp;<span class="ident" id="6056769">hv</span>&nbsp;<span class="op" id="6056772">!=</span>&nbsp;<span class="num" id="6056775">0x12</span>&nbsp;<span class="op" id="6056780">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056786">return</span>&nbsp;<span class="ident" id="6056793">UnsupportedError</span><span class="op" id="6056809">(</span><span class="string" id="6056810">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="6056840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056849">}</span>&nbsp;<span class="keyword" id="6056851">else</span>&nbsp;<span class="keyword" id="6056856">if</span>&nbsp;<span class="ident" id="6056859">hv</span>&nbsp;<span class="op" id="6056862">!=</span>&nbsp;<span class="num" id="6056865">0x11</span>&nbsp;<span class="op" id="6056870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056875">return</span>&nbsp;<span class="ident" id="6056882">UnsupportedError</span><span class="op" id="6056898">(</span><span class="string" id="6056899">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="6056929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056933">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056939">return</span>&nbsp;<span class="ident" id="6056946">nil</span><br>
<span class="lineno"></span><span class="op" id="6056950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6056953">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.1.</span><br>
<span class="lineno">345</span><span class="keyword" id="6056986">func</span>&nbsp;<span class="op" id="6056991">(</span><span class="ident" id="6056992">d</span>&nbsp;<span class="op" id="6056994">*</span><span class="ident" id="6056995">decoder</span><span class="op" id="6057002">)</span>&nbsp;<span class="ident" id="6057004">processDQT</span><span class="op" id="6057014">(</span><span class="ident" id="6057015">n</span>&nbsp;<span class="builtintype" id="6057017">int</span><span class="op" id="6057020">)</span>&nbsp;<span class="builtintype" id="6057022">error</span>&nbsp;<span class="op" id="6057028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057031">const</span>&nbsp;<span class="ident" id="6057037">qtLength</span>&nbsp;<span class="op" id="6057046">=</span>&nbsp;<span class="num" id="6057048">1</span>&nbsp;<span class="op" id="6057050">+</span>&nbsp;<span class="ident" id="6057052">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057063">for</span>&nbsp;<span class="op" id="6057067">;</span>&nbsp;<span class="ident" id="6057069">n</span>&nbsp;<span class="op" id="6057071">&gt;=</span>&nbsp;<span class="ident" id="6057074">qtLength</span><span class="op" id="6057082">;</span>&nbsp;<span class="ident" id="6057084">n</span>&nbsp;<span class="op" id="6057086">-=</span>&nbsp;<span class="ident" id="6057089">qtLength</span>&nbsp;<span class="op" id="6057098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057102">if</span>&nbsp;<span class="ident" id="6057105">err</span>&nbsp;<span class="op" id="6057109">:=</span>&nbsp;<span class="ident" id="6057112">d</span><span class="op" id="6057113">.</span><span class="ident" id="6057114">readFull</span><span class="op" id="6057122">(</span><span class="ident" id="6057123">d</span><span class="op" id="6057124">.</span><span class="ident" id="6057125">tmp</span><span class="op" id="6057128">[</span><span class="op" id="6057129">:</span><span class="ident" id="6057130">qtLength</span><span class="op" id="6057138">]</span><span class="op" id="6057139">)</span><span class="op" id="6057140">;</span>&nbsp;<span class="ident" id="6057142">err</span>&nbsp;<span class="op" id="6057146">!=</span>&nbsp;<span class="ident" id="6057149">nil</span>&nbsp;<span class="op" id="6057153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057158">return</span>&nbsp;<span class="ident" id="6057165">err</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057175">pq</span>&nbsp;<span class="op" id="6057178">:=</span>&nbsp;<span class="ident" id="6057181">d</span><span class="op" id="6057182">.</span><span class="ident" id="6057183">tmp</span><span class="op" id="6057186">[</span><span class="num" id="6057187">0</span><span class="op" id="6057188">]</span>&nbsp;<span class="op" id="6057190">&gt;&gt;</span>&nbsp;<span class="num" id="6057193">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057197">if</span>&nbsp;<span class="ident" id="6057200">pq</span>&nbsp;<span class="op" id="6057203">!=</span>&nbsp;<span class="num" id="6057206">0</span>&nbsp;<span class="op" id="6057208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057213">return</span>&nbsp;<span class="ident" id="6057220">UnsupportedError</span><span class="op" id="6057236">(</span><span class="string" id="6057237">&#34;bad&nbsp;Pq&nbsp;value&#34;</span><span class="op" id="6057251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057255">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057259">tq</span>&nbsp;<span class="op" id="6057262">:=</span>&nbsp;<span class="ident" id="6057265">d</span><span class="op" id="6057266">.</span><span class="ident" id="6057267">tmp</span><span class="op" id="6057270">[</span><span class="num" id="6057271">0</span><span class="op" id="6057272">]</span>&nbsp;<span class="op" id="6057274">&amp;</span>&nbsp;<span class="num" id="6057276">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057283">if</span>&nbsp;<span class="ident" id="6057286">tq</span>&nbsp;<span class="op" id="6057289">&gt;</span>&nbsp;<span class="ident" id="6057291">maxTq</span>&nbsp;<span class="op" id="6057297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057302">return</span>&nbsp;<span class="ident" id="6057309">FormatError</span><span class="op" id="6057320">(</span><span class="string" id="6057321">&#34;bad&nbsp;Tq&nbsp;value&#34;</span><span class="op" id="6057335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057343">for</span>&nbsp;<span class="ident" id="6057347">i</span>&nbsp;<span class="op" id="6057349">:=</span>&nbsp;<span class="keyword" id="6057352">range</span>&nbsp;<span class="ident" id="6057358">d</span><span class="op" id="6057359">.</span><span class="ident" id="6057360">quant</span><span class="op" id="6057365">[</span><span class="ident" id="6057366">tq</span><span class="op" id="6057368">]</span>&nbsp;<span class="op" id="6057370">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057375">d</span><span class="op" id="6057376">.</span><span class="ident" id="6057377">quant</span><span class="op" id="6057382">[</span><span class="ident" id="6057383">tq</span><span class="op" id="6057385">]</span><span class="op" id="6057386">[</span><span class="ident" id="6057387">i</span><span class="op" id="6057388">]</span>&nbsp;<span class="op" id="6057390">=</span>&nbsp;<span class="builtintype" id="6057392">int32</span><span class="op" id="6057397">(</span><span class="ident" id="6057398">d</span><span class="op" id="6057399">.</span><span class="ident" id="6057400">tmp</span><span class="op" id="6057403">[</span><span class="ident" id="6057404">i</span><span class="op" id="6057405">+</span><span class="num" id="6057406">1</span><span class="op" id="6057407">]</span><span class="op" id="6057408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057418">if</span>&nbsp;<span class="ident" id="6057421">n</span>&nbsp;<span class="op" id="6057423">!=</span>&nbsp;<span class="num" id="6057426">0</span>&nbsp;<span class="op" id="6057428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057432">return</span>&nbsp;<span class="ident" id="6057439">FormatError</span><span class="op" id="6057450">(</span><span class="string" id="6057451">&#34;DQT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6057473">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057479">return</span>&nbsp;<span class="ident" id="6057486">nil</span><br>
<span class="lineno"></span><span class="op" id="6057490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6057493">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.4.</span><br>
<span class="lineno">370</span><span class="keyword" id="6057526">func</span>&nbsp;<span class="op" id="6057531">(</span><span class="ident" id="6057532">d</span>&nbsp;<span class="op" id="6057534">*</span><span class="ident" id="6057535">decoder</span><span class="op" id="6057542">)</span>&nbsp;<span class="ident" id="6057544">processDRI</span><span class="op" id="6057554">(</span><span class="ident" id="6057555">n</span>&nbsp;<span class="builtintype" id="6057557">int</span><span class="op" id="6057560">)</span>&nbsp;<span class="builtintype" id="6057562">error</span>&nbsp;<span class="op" id="6057568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057571">if</span>&nbsp;<span class="ident" id="6057574">n</span>&nbsp;<span class="op" id="6057576">!=</span>&nbsp;<span class="num" id="6057579">2</span>&nbsp;<span class="op" id="6057581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057585">return</span>&nbsp;<span class="ident" id="6057592">FormatError</span><span class="op" id="6057603">(</span><span class="string" id="6057604">&#34;DRI&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6057626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057632">if</span>&nbsp;<span class="ident" id="6057635">err</span>&nbsp;<span class="op" id="6057639">:=</span>&nbsp;<span class="ident" id="6057642">d</span><span class="op" id="6057643">.</span><span class="ident" id="6057644">readFull</span><span class="op" id="6057652">(</span><span class="ident" id="6057653">d</span><span class="op" id="6057654">.</span><span class="ident" id="6057655">tmp</span><span class="op" id="6057658">[</span><span class="op" id="6057659">:</span><span class="num" id="6057660">2</span><span class="op" id="6057661">]</span><span class="op" id="6057662">)</span><span class="op" id="6057663">;</span>&nbsp;<span class="ident" id="6057665">err</span>&nbsp;<span class="op" id="6057669">!=</span>&nbsp;<span class="ident" id="6057672">nil</span>&nbsp;<span class="op" id="6057676">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057680">return</span>&nbsp;<span class="ident" id="6057687">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057695">d</span><span class="op" id="6057696">.</span><span class="ident" id="6057697">ri</span>&nbsp;<span class="op" id="6057700">=</span>&nbsp;<span class="builtintype" id="6057702">int</span><span class="op" id="6057705">(</span><span class="ident" id="6057706">d</span><span class="op" id="6057707">.</span><span class="ident" id="6057708">tmp</span><span class="op" id="6057711">[</span><span class="num" id="6057712">0</span><span class="op" id="6057713">]</span><span class="op" id="6057714">)</span><span class="op" id="6057715">&lt;&lt;</span><span class="num" id="6057717">8</span>&nbsp;<span class="op" id="6057719">+</span>&nbsp;<span class="builtintype" id="6057721">int</span><span class="op" id="6057724">(</span><span class="ident" id="6057725">d</span><span class="op" id="6057726">.</span><span class="ident" id="6057727">tmp</span><span class="op" id="6057730">[</span><span class="num" id="6057731">1</span><span class="op" id="6057732">]</span><span class="op" id="6057733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057736">return</span>&nbsp;<span class="ident" id="6057743">nil</span><br>
<span class="lineno"></span><span class="op" id="6057747">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="6057750">//&nbsp;decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="6057820">func</span>&nbsp;<span class="op" id="6057825">(</span><span class="ident" id="6057826">d</span>&nbsp;<span class="op" id="6057828">*</span><span class="ident" id="6057829">decoder</span><span class="op" id="6057836">)</span>&nbsp;<span class="ident" id="6057838">decode</span><span class="op" id="6057844">(</span><span class="ident" id="6057845">r</span>&nbsp;<span class="ident" id="6057847">io</span><span class="op" id="6057849">.</span><span class="ident" id="6057850">Reader</span><span class="op" id="6057856">,</span>&nbsp;<span class="ident" id="6057858">configOnly</span>&nbsp;<span class="builtintype" id="6057869">bool</span><span class="op" id="6057873">)</span>&nbsp;<span class="op" id="6057875">(</span><span class="ident" id="6057876">image</span><span class="op" id="6057881">.</span><span class="ident" id="6057882">Image</span><span class="op" id="6057887">,</span>&nbsp;<span class="builtintype" id="6057889">error</span><span class="op" id="6057894">)</span>&nbsp;<span class="op" id="6057896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057899">d</span><span class="op" id="6057900">.</span><span class="ident" id="6057901">r</span>&nbsp;<span class="op" id="6057903">=</span>&nbsp;<span class="ident" id="6057905">r</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6057909">//&nbsp;Check&nbsp;for&nbsp;the&nbsp;Start&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057950">if</span>&nbsp;<span class="ident" id="6057953">err</span>&nbsp;<span class="op" id="6057957">:=</span>&nbsp;<span class="ident" id="6057960">d</span><span class="op" id="6057961">.</span><span class="ident" id="6057962">readFull</span><span class="op" id="6057970">(</span><span class="ident" id="6057971">d</span><span class="op" id="6057972">.</span><span class="ident" id="6057973">tmp</span><span class="op" id="6057976">[</span><span class="op" id="6057977">:</span><span class="num" id="6057978">2</span><span class="op" id="6057979">]</span><span class="op" id="6057980">)</span><span class="op" id="6057981">;</span>&nbsp;<span class="ident" id="6057983">err</span>&nbsp;<span class="op" id="6057987">!=</span>&nbsp;<span class="ident" id="6057990">nil</span>&nbsp;<span class="op" id="6057994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057998">return</span>&nbsp;<span class="ident" id="6058005">nil</span><span class="op" id="6058008">,</span>&nbsp;<span class="ident" id="6058010">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058018">if</span>&nbsp;<span class="ident" id="6058021">d</span><span class="op" id="6058022">.</span><span class="ident" id="6058023">tmp</span><span class="op" id="6058026">[</span><span class="num" id="6058027">0</span><span class="op" id="6058028">]</span>&nbsp;<span class="op" id="6058030">!=</span>&nbsp;<span class="num" id="6058033">0xff</span>&nbsp;<span class="op" id="6058038">||</span>&nbsp;<span class="ident" id="6058041">d</span><span class="op" id="6058042">.</span><span class="ident" id="6058043">tmp</span><span class="op" id="6058046">[</span><span class="num" id="6058047">1</span><span class="op" id="6058048">]</span>&nbsp;<span class="op" id="6058050">!=</span>&nbsp;<span class="ident" id="6058053">soiMarker</span>&nbsp;<span class="op" id="6058063">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058067">return</span>&nbsp;<span class="ident" id="6058074">nil</span><span class="op" id="6058077">,</span>&nbsp;<span class="ident" id="6058079">FormatError</span><span class="op" id="6058090">(</span><span class="string" id="6058091">&#34;missing&nbsp;SOI&nbsp;marker&#34;</span><span class="op" id="6058111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6058118">//&nbsp;Process&nbsp;the&nbsp;remaining&nbsp;segments&nbsp;until&nbsp;the&nbsp;End&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058184">for</span>&nbsp;<span class="op" id="6058188">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058192">err</span>&nbsp;<span class="op" id="6058196">:=</span>&nbsp;<span class="ident" id="6058199">d</span><span class="op" id="6058200">.</span><span class="ident" id="6058201">readFull</span><span class="op" id="6058209">(</span><span class="ident" id="6058210">d</span><span class="op" id="6058211">.</span><span class="ident" id="6058212">tmp</span><span class="op" id="6058215">[</span><span class="op" id="6058216">:</span><span class="num" id="6058217">2</span><span class="op" id="6058218">]</span><span class="op" id="6058219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058223">if</span>&nbsp;<span class="ident" id="6058226">err</span>&nbsp;<span class="op" id="6058230">!=</span>&nbsp;<span class="ident" id="6058233">nil</span>&nbsp;<span class="op" id="6058237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058242">return</span>&nbsp;<span class="ident" id="6058249">nil</span><span class="op" id="6058252">,</span>&nbsp;<span class="ident" id="6058254">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058264">for</span>&nbsp;<span class="ident" id="6058268">d</span><span class="op" id="6058269">.</span><span class="ident" id="6058270">tmp</span><span class="op" id="6058273">[</span><span class="num" id="6058274">0</span><span class="op" id="6058275">]</span>&nbsp;<span class="op" id="6058277">!=</span>&nbsp;<span class="num" id="6058280">0xff</span>&nbsp;<span class="op" id="6058285">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6058290">//&nbsp;Strictly&nbsp;speaking,&nbsp;this&nbsp;is&nbsp;a&nbsp;format&nbsp;error.&nbsp;However,&nbsp;libjpeg&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6058359">//&nbsp;liberal&nbsp;in&nbsp;what&nbsp;it&nbsp;accepts.&nbsp;As&nbsp;of&nbsp;version&nbsp;9,&nbsp;next_marker&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6058425">//&nbsp;jdmarker.c&nbsp;treats&nbsp;this&nbsp;as&nbsp;a&nbsp;warning&nbsp;(JWRN_EXTRANEOUS_DATA)&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6058494">//&nbsp;continues&nbsp;to&nbsp;decode&nbsp;the&nbsp;stream.&nbsp;Even&nbsp;before&nbsp;next_marker&nbsp;sees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6058561">//&nbsp;extraneous&nbsp;data,&nbsp;jpeg_fill_bit_buffer&nbsp;in&nbsp;jdhuff.c&nbsp;reads&nbsp;as&nbsp;many</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6058631">//&nbsp;bytes&nbsp;as&nbsp;it&nbsp;can,&nbsp;possibly&nbsp;past&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;scan&#39;s&nbsp;data.&nbsp;It</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6058697">//&nbsp;effectively&nbsp;puts&nbsp;back&nbsp;any&nbsp;markers&nbsp;that&nbsp;it&nbsp;overscanned&nbsp;(e.g.&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6058766">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker),&nbsp;but&nbsp;it&nbsp;does&nbsp;not&nbsp;put&nbsp;back&nbsp;non-marker&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6058838">//&nbsp;and&nbsp;thus&nbsp;it&nbsp;can&nbsp;silently&nbsp;ignore&nbsp;a&nbsp;small&nbsp;number&nbsp;of&nbsp;extraneous</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6058905">//&nbsp;non-marker&nbsp;bytes&nbsp;before&nbsp;next_marker&nbsp;has&nbsp;a&nbsp;chance&nbsp;to&nbsp;see&nbsp;them&nbsp;(and</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6058977">//&nbsp;print&nbsp;a&nbsp;warning).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059001">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059007">//&nbsp;We&nbsp;are&nbsp;therefore&nbsp;also&nbsp;liberal&nbsp;in&nbsp;what&nbsp;we&nbsp;accept.&nbsp;Extraneous&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059078">//&nbsp;is&nbsp;silently&nbsp;ignored.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059105">//</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059111">//&nbsp;This&nbsp;is&nbsp;similar&nbsp;to,&nbsp;but&nbsp;not&nbsp;exactly&nbsp;the&nbsp;same&nbsp;as,&nbsp;the&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059178">//&nbsp;mechanism&nbsp;within&nbsp;a&nbsp;scan&nbsp;(the&nbsp;RST[0-7]&nbsp;markers).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059232">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059238">//&nbsp;Note&nbsp;that&nbsp;extraneous&nbsp;0xff&nbsp;bytes&nbsp;in&nbsp;e.g.&nbsp;SOS&nbsp;data&nbsp;are&nbsp;escaped&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059308">//&nbsp;&#34;\xff\x00&#34;,&nbsp;and&nbsp;so&nbsp;are&nbsp;detected&nbsp;a&nbsp;little&nbsp;further&nbsp;down&nbsp;below.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059375">d</span><span class="op" id="6059376">.</span><span class="ident" id="6059377">tmp</span><span class="op" id="6059380">[</span><span class="num" id="6059381">0</span><span class="op" id="6059382">]</span>&nbsp;<span class="op" id="6059384">=</span>&nbsp;<span class="ident" id="6059386">d</span><span class="op" id="6059387">.</span><span class="ident" id="6059388">tmp</span><span class="op" id="6059391">[</span><span class="num" id="6059392">1</span><span class="op" id="6059393">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059398">d</span><span class="op" id="6059399">.</span><span class="ident" id="6059400">tmp</span><span class="op" id="6059403">[</span><span class="num" id="6059404">1</span><span class="op" id="6059405">]</span><span class="op" id="6059406">,</span>&nbsp;<span class="ident" id="6059408">err</span>&nbsp;<span class="op" id="6059412">=</span>&nbsp;<span class="ident" id="6059414">d</span><span class="op" id="6059415">.</span><span class="ident" id="6059416">readByte</span><span class="op" id="6059424">(</span><span class="op" id="6059425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059430">if</span>&nbsp;<span class="ident" id="6059433">err</span>&nbsp;<span class="op" id="6059437">!=</span>&nbsp;<span class="ident" id="6059440">nil</span>&nbsp;<span class="op" id="6059444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059450">return</span>&nbsp;<span class="ident" id="6059457">nil</span><span class="op" id="6059460">,</span>&nbsp;<span class="ident" id="6059462">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059469">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059477">marker</span>&nbsp;<span class="op" id="6059484">:=</span>&nbsp;<span class="ident" id="6059487">d</span><span class="op" id="6059488">.</span><span class="ident" id="6059489">tmp</span><span class="op" id="6059492">[</span><span class="num" id="6059493">1</span><span class="op" id="6059494">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059498">if</span>&nbsp;<span class="ident" id="6059501">marker</span>&nbsp;<span class="op" id="6059508">==</span>&nbsp;<span class="num" id="6059511">0</span>&nbsp;<span class="op" id="6059513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059518">//&nbsp;Treat&nbsp;&#34;\xff\x00&#34;&nbsp;as&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059561">continue</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059576">for</span>&nbsp;<span class="ident" id="6059580">marker</span>&nbsp;<span class="op" id="6059587">==</span>&nbsp;<span class="num" id="6059590">0xff</span>&nbsp;<span class="op" id="6059595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059600">//&nbsp;Section&nbsp;B.1.1.2&nbsp;says,&nbsp;&#34;Any&nbsp;marker&nbsp;may&nbsp;optionally&nbsp;be&nbsp;preceded&nbsp;by&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059674">//&nbsp;number&nbsp;of&nbsp;fill&nbsp;bytes,&nbsp;which&nbsp;are&nbsp;bytes&nbsp;assigned&nbsp;code&nbsp;X&#39;FF&#39;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059740">marker</span><span class="op" id="6059746">,</span>&nbsp;<span class="ident" id="6059748">err</span>&nbsp;<span class="op" id="6059752">=</span>&nbsp;<span class="ident" id="6059754">d</span><span class="op" id="6059755">.</span><span class="ident" id="6059756">readByte</span><span class="op" id="6059764">(</span><span class="op" id="6059765">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059770">if</span>&nbsp;<span class="ident" id="6059773">err</span>&nbsp;<span class="op" id="6059777">!=</span>&nbsp;<span class="ident" id="6059780">nil</span>&nbsp;<span class="op" id="6059784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059790">return</span>&nbsp;<span class="ident" id="6059797">nil</span><span class="op" id="6059800">,</span>&nbsp;<span class="ident" id="6059802">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059817">if</span>&nbsp;<span class="ident" id="6059820">marker</span>&nbsp;<span class="op" id="6059827">==</span>&nbsp;<span class="ident" id="6059830">eoiMarker</span>&nbsp;<span class="op" id="6059840">{</span>&nbsp;<span class="comment" id="6059842">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059862">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059874">if</span>&nbsp;<span class="ident" id="6059877">rst0Marker</span>&nbsp;<span class="op" id="6059888">&lt;=</span>&nbsp;<span class="ident" id="6059891">marker</span>&nbsp;<span class="op" id="6059898">&amp;&amp;</span>&nbsp;<span class="ident" id="6059901">marker</span>&nbsp;<span class="op" id="6059908">&lt;=</span>&nbsp;<span class="ident" id="6059911">rst7Marker</span>&nbsp;<span class="op" id="6059922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059927">//&nbsp;Figures&nbsp;B.2&nbsp;and&nbsp;B.16&nbsp;of&nbsp;the&nbsp;specification&nbsp;suggest&nbsp;that&nbsp;restart&nbsp;markers&nbsp;should</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6060011">//&nbsp;only&nbsp;occur&nbsp;between&nbsp;Entropy&nbsp;Coded&nbsp;Segments&nbsp;and&nbsp;not&nbsp;after&nbsp;the&nbsp;final&nbsp;ECS.</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6060088">//&nbsp;However,&nbsp;some&nbsp;encoders&nbsp;may&nbsp;generate&nbsp;incorrect&nbsp;JPEGs&nbsp;with&nbsp;a&nbsp;final&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6060167">//&nbsp;marker.&nbsp;That&nbsp;restart&nbsp;marker&nbsp;will&nbsp;be&nbsp;seen&nbsp;here&nbsp;instead&nbsp;of&nbsp;inside&nbsp;the&nbsp;processSOS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6060252">//&nbsp;method,&nbsp;and&nbsp;is&nbsp;ignored&nbsp;as&nbsp;a&nbsp;harmless&nbsp;error.&nbsp;Restart&nbsp;markers&nbsp;have&nbsp;no&nbsp;extra&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6060338">//&nbsp;so&nbsp;we&nbsp;check&nbsp;for&nbsp;this&nbsp;before&nbsp;we&nbsp;read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060414">continue</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6060425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6060430">//&nbsp;Read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.&nbsp;The&nbsp;value&nbsp;includes&nbsp;the&nbsp;2&nbsp;bytes&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6060513">//&nbsp;length&nbsp;itself,&nbsp;so&nbsp;we&nbsp;subtract&nbsp;2&nbsp;to&nbsp;get&nbsp;the&nbsp;number&nbsp;of&nbsp;remaining&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060588">if</span>&nbsp;<span class="ident" id="6060591">err</span>&nbsp;<span class="op" id="6060595">=</span>&nbsp;<span class="ident" id="6060597">d</span><span class="op" id="6060598">.</span><span class="ident" id="6060599">readFull</span><span class="op" id="6060607">(</span><span class="ident" id="6060608">d</span><span class="op" id="6060609">.</span><span class="ident" id="6060610">tmp</span><span class="op" id="6060613">[</span><span class="op" id="6060614">:</span><span class="num" id="6060615">2</span><span class="op" id="6060616">]</span><span class="op" id="6060617">)</span><span class="op" id="6060618">;</span>&nbsp;<span class="ident" id="6060620">err</span>&nbsp;<span class="op" id="6060624">!=</span>&nbsp;<span class="ident" id="6060627">nil</span>&nbsp;<span class="op" id="6060631">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060636">return</span>&nbsp;<span class="ident" id="6060643">nil</span><span class="op" id="6060646">,</span>&nbsp;<span class="ident" id="6060648">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6060654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060658">n</span>&nbsp;<span class="op" id="6060660">:=</span>&nbsp;<span class="builtintype" id="6060663">int</span><span class="op" id="6060666">(</span><span class="ident" id="6060667">d</span><span class="op" id="6060668">.</span><span class="ident" id="6060669">tmp</span><span class="op" id="6060672">[</span><span class="num" id="6060673">0</span><span class="op" id="6060674">]</span><span class="op" id="6060675">)</span><span class="op" id="6060676">&lt;&lt;</span><span class="num" id="6060678">8</span>&nbsp;<span class="op" id="6060680">+</span>&nbsp;<span class="builtintype" id="6060682">int</span><span class="op" id="6060685">(</span><span class="ident" id="6060686">d</span><span class="op" id="6060687">.</span><span class="ident" id="6060688">tmp</span><span class="op" id="6060691">[</span><span class="num" id="6060692">1</span><span class="op" id="6060693">]</span><span class="op" id="6060694">)</span>&nbsp;<span class="op" id="6060696">-</span>&nbsp;<span class="num" id="6060698">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060702">if</span>&nbsp;<span class="ident" id="6060705">n</span>&nbsp;<span class="op" id="6060707">&lt;</span>&nbsp;<span class="num" id="6060709">0</span>&nbsp;<span class="op" id="6060711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060716">return</span>&nbsp;<span class="ident" id="6060723">nil</span><span class="op" id="6060726">,</span>&nbsp;<span class="ident" id="6060728">FormatError</span><span class="op" id="6060739">(</span><span class="string" id="6060740">&#34;short&nbsp;segment&nbsp;length&#34;</span><span class="op" id="6060762">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6060766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060771">switch</span>&nbsp;<span class="op" id="6060778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060782">case</span>&nbsp;<span class="ident" id="6060787">marker</span>&nbsp;<span class="op" id="6060794">==</span>&nbsp;<span class="ident" id="6060797">sof0Marker</span>&nbsp;<span class="op" id="6060808">||</span>&nbsp;<span class="ident" id="6060811">marker</span>&nbsp;<span class="op" id="6060818">==</span>&nbsp;<span class="ident" id="6060821">sof2Marker</span><span class="op" id="6060831">:</span>&nbsp;<span class="comment" id="6060833">//&nbsp;Start&nbsp;Of&nbsp;Frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060855">d</span><span class="op" id="6060856">.</span><span class="ident" id="6060857">progressive</span>&nbsp;<span class="op" id="6060869">=</span>&nbsp;<span class="ident" id="6060871">marker</span>&nbsp;<span class="op" id="6060878">==</span>&nbsp;<span class="ident" id="6060881">sof2Marker</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060895">err</span>&nbsp;<span class="op" id="6060899">=</span>&nbsp;<span class="ident" id="6060901">d</span><span class="op" id="6060902">.</span><span class="ident" id="6060903">processSOF</span><span class="op" id="6060913">(</span><span class="ident" id="6060914">n</span><span class="op" id="6060915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060920">if</span>&nbsp;<span class="ident" id="6060923">configOnly</span>&nbsp;<span class="op" id="6060934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060940">return</span>&nbsp;<span class="ident" id="6060947">nil</span><span class="op" id="6060950">,</span>&nbsp;<span class="ident" id="6060952">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6060959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060963">case</span>&nbsp;<span class="ident" id="6060968">marker</span>&nbsp;<span class="op" id="6060975">==</span>&nbsp;<span class="ident" id="6060978">dhtMarker</span><span class="op" id="6060987">:</span>&nbsp;<span class="comment" id="6060989">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061017">err</span>&nbsp;<span class="op" id="6061021">=</span>&nbsp;<span class="ident" id="6061023">d</span><span class="op" id="6061024">.</span><span class="ident" id="6061025">processDHT</span><span class="op" id="6061035">(</span><span class="ident" id="6061036">n</span><span class="op" id="6061037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061041">case</span>&nbsp;<span class="ident" id="6061046">marker</span>&nbsp;<span class="op" id="6061053">==</span>&nbsp;<span class="ident" id="6061056">dqtMarker</span><span class="op" id="6061065">:</span>&nbsp;<span class="comment" id="6061067">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061100">err</span>&nbsp;<span class="op" id="6061104">=</span>&nbsp;<span class="ident" id="6061106">d</span><span class="op" id="6061107">.</span><span class="ident" id="6061108">processDQT</span><span class="op" id="6061118">(</span><span class="ident" id="6061119">n</span><span class="op" id="6061120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061124">case</span>&nbsp;<span class="ident" id="6061129">marker</span>&nbsp;<span class="op" id="6061136">==</span>&nbsp;<span class="ident" id="6061139">sosMarker</span><span class="op" id="6061148">:</span>&nbsp;<span class="comment" id="6061150">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061171">err</span>&nbsp;<span class="op" id="6061175">=</span>&nbsp;<span class="ident" id="6061177">d</span><span class="op" id="6061178">.</span><span class="ident" id="6061179">processSOS</span><span class="op" id="6061189">(</span><span class="ident" id="6061190">n</span><span class="op" id="6061191">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061195">case</span>&nbsp;<span class="ident" id="6061200">marker</span>&nbsp;<span class="op" id="6061207">==</span>&nbsp;<span class="ident" id="6061210">driMarker</span><span class="op" id="6061219">:</span>&nbsp;<span class="comment" id="6061221">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061252">err</span>&nbsp;<span class="op" id="6061256">=</span>&nbsp;<span class="ident" id="6061258">d</span><span class="op" id="6061259">.</span><span class="ident" id="6061260">processDRI</span><span class="op" id="6061270">(</span><span class="ident" id="6061271">n</span><span class="op" id="6061272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061276">case</span>&nbsp;<span class="ident" id="6061281">app0Marker</span>&nbsp;<span class="op" id="6061292">&lt;=</span>&nbsp;<span class="ident" id="6061295">marker</span>&nbsp;<span class="op" id="6061302">&amp;&amp;</span>&nbsp;<span class="ident" id="6061305">marker</span>&nbsp;<span class="op" id="6061312">&lt;=</span>&nbsp;<span class="ident" id="6061315">app15Marker</span>&nbsp;<span class="op" id="6061327">||</span>&nbsp;<span class="ident" id="6061330">marker</span>&nbsp;<span class="op" id="6061337">==</span>&nbsp;<span class="ident" id="6061340">comMarker</span><span class="op" id="6061349">:</span>&nbsp;<span class="comment" id="6061351">//&nbsp;APPlication&nbsp;specific,&nbsp;or&nbsp;COMment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061391">err</span>&nbsp;<span class="op" id="6061395">=</span>&nbsp;<span class="ident" id="6061397">d</span><span class="op" id="6061398">.</span><span class="ident" id="6061399">ignore</span><span class="op" id="6061405">(</span><span class="ident" id="6061406">n</span><span class="op" id="6061407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061411">default</span><span class="op" id="6061418">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061423">err</span>&nbsp;<span class="op" id="6061427">=</span>&nbsp;<span class="ident" id="6061429">UnsupportedError</span><span class="op" id="6061445">(</span><span class="string" id="6061446">&#34;unknown&nbsp;marker&#34;</span><span class="op" id="6061462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6061466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061470">if</span>&nbsp;<span class="ident" id="6061473">err</span>&nbsp;<span class="op" id="6061477">!=</span>&nbsp;<span class="ident" id="6061480">nil</span>&nbsp;<span class="op" id="6061484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061489">return</span>&nbsp;<span class="ident" id="6061496">nil</span><span class="op" id="6061499">,</span>&nbsp;<span class="ident" id="6061501">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6061507">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6061510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061513">if</span>&nbsp;<span class="ident" id="6061516">d</span><span class="op" id="6061517">.</span><span class="ident" id="6061518">img1</span>&nbsp;<span class="op" id="6061523">!=</span>&nbsp;<span class="ident" id="6061526">nil</span>&nbsp;<span class="op" id="6061530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061534">return</span>&nbsp;<span class="ident" id="6061541">d</span><span class="op" id="6061542">.</span><span class="ident" id="6061543">img1</span><span class="op" id="6061547">,</span>&nbsp;<span class="ident" id="6061549">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6061554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061557">if</span>&nbsp;<span class="ident" id="6061560">d</span><span class="op" id="6061561">.</span><span class="ident" id="6061562">img3</span>&nbsp;<span class="op" id="6061567">!=</span>&nbsp;<span class="ident" id="6061570">nil</span>&nbsp;<span class="op" id="6061574">{</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061578">return</span>&nbsp;<span class="ident" id="6061585">d</span><span class="op" id="6061586">.</span><span class="ident" id="6061587">img3</span><span class="op" id="6061591">,</span>&nbsp;<span class="ident" id="6061593">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6061598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061601">return</span>&nbsp;<span class="ident" id="6061608">nil</span><span class="op" id="6061611">,</span>&nbsp;<span class="ident" id="6061613">FormatError</span><span class="op" id="6061624">(</span><span class="string" id="6061625">&#34;missing&nbsp;SOS&nbsp;marker&#34;</span><span class="op" id="6061645">)</span><br>
<span class="lineno"></span><span class="op" id="6061647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="6061650">//&nbsp;Decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="6061720">func</span>&nbsp;<span class="ident" id="6061725">Decode</span><span class="op" id="6061731">(</span><span class="ident" id="6061732">r</span>&nbsp;<span class="ident" id="6061734">io</span><span class="op" id="6061736">.</span><span class="ident" id="6061737">Reader</span><span class="op" id="6061743">)</span>&nbsp;<span class="op" id="6061745">(</span><span class="ident" id="6061746">image</span><span class="op" id="6061751">.</span><span class="ident" id="6061752">Image</span><span class="op" id="6061757">,</span>&nbsp;<span class="builtintype" id="6061759">error</span><span class="op" id="6061764">)</span>&nbsp;<span class="op" id="6061766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061769">var</span>&nbsp;<span class="ident" id="6061773">d</span>&nbsp;<span class="ident" id="6061775">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061784">return</span>&nbsp;<span class="ident" id="6061791">d</span><span class="op" id="6061792">.</span><span class="ident" id="6061793">decode</span><span class="op" id="6061799">(</span><span class="ident" id="6061800">r</span><span class="op" id="6061801">,</span>&nbsp;<span class="builtintype" id="6061803">false</span><span class="op" id="6061808">)</span><br>
<span class="lineno"></span><span class="op" id="6061810">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="comment" id="6061813">//&nbsp;DecodeConfig&nbsp;returns&nbsp;the&nbsp;color&nbsp;model&nbsp;and&nbsp;dimensions&nbsp;of&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="6061892">//&nbsp;decoding&nbsp;the&nbsp;entire&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="6061922">func</span>&nbsp;<span class="ident" id="6061927">DecodeConfig</span><span class="op" id="6061939">(</span><span class="ident" id="6061940">r</span>&nbsp;<span class="ident" id="6061942">io</span><span class="op" id="6061944">.</span><span class="ident" id="6061945">Reader</span><span class="op" id="6061951">)</span>&nbsp;<span class="op" id="6061953">(</span><span class="ident" id="6061954">image</span><span class="op" id="6061959">.</span><span class="ident" id="6061960">Config</span><span class="op" id="6061966">,</span>&nbsp;<span class="builtintype" id="6061968">error</span><span class="op" id="6061973">)</span>&nbsp;<span class="op" id="6061975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061978">var</span>&nbsp;<span class="ident" id="6061982">d</span>&nbsp;<span class="ident" id="6061984">decoder</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061993">if</span>&nbsp;<span class="ident" id="6061996">_</span><span class="op" id="6061997">,</span>&nbsp;<span class="ident" id="6061999">err</span>&nbsp;<span class="op" id="6062003">:=</span>&nbsp;<span class="ident" id="6062006">d</span><span class="op" id="6062007">.</span><span class="ident" id="6062008">decode</span><span class="op" id="6062014">(</span><span class="ident" id="6062015">r</span><span class="op" id="6062016">,</span>&nbsp;<span class="builtintype" id="6062018">true</span><span class="op" id="6062022">)</span><span class="op" id="6062023">;</span>&nbsp;<span class="ident" id="6062025">err</span>&nbsp;<span class="op" id="6062029">!=</span>&nbsp;<span class="ident" id="6062032">nil</span>&nbsp;<span class="op" id="6062036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6062040">return</span>&nbsp;<span class="ident" id="6062047">image</span><span class="op" id="6062052">.</span><span class="ident" id="6062053">Config</span><span class="op" id="6062059">{</span><span class="op" id="6062060">}</span><span class="op" id="6062061">,</span>&nbsp;<span class="ident" id="6062063">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6062068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6062071">switch</span>&nbsp;<span class="ident" id="6062078">d</span><span class="op" id="6062079">.</span><span class="ident" id="6062080">nComp</span>&nbsp;<span class="op" id="6062086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6062089">case</span>&nbsp;<span class="ident" id="6062094">nGrayComponent</span><span class="op" id="6062108">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6062112">return</span>&nbsp;<span class="ident" id="6062119">image</span><span class="op" id="6062124">.</span><span class="ident" id="6062125">Config</span><span class="op" id="6062131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6062136">ColorModel</span><span class="op" id="6062146">:</span>&nbsp;<span class="ident" id="6062148">color</span><span class="op" id="6062153">.</span><span class="ident" id="6062154">GrayModel</span><span class="op" id="6062163">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6062168">Width</span><span class="op" id="6062173">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6062180">d</span><span class="op" id="6062181">.</span><span class="ident" id="6062182">width</span><span class="op" id="6062187">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6062192">Height</span><span class="op" id="6062198">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6062204">d</span><span class="op" id="6062205">.</span><span class="ident" id="6062206">height</span><span class="op" id="6062212">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6062216">}</span><span class="op" id="6062217">,</span>&nbsp;<span class="ident" id="6062219">nil</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6062224">case</span>&nbsp;<span class="ident" id="6062229">nColorComponent</span><span class="op" id="6062244">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6062248">return</span>&nbsp;<span class="ident" id="6062255">image</span><span class="op" id="6062260">.</span><span class="ident" id="6062261">Config</span><span class="op" id="6062267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6062272">ColorModel</span><span class="op" id="6062282">:</span>&nbsp;<span class="ident" id="6062284">color</span><span class="op" id="6062289">.</span><span class="ident" id="6062290">YCbCrModel</span><span class="op" id="6062300">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6062305">Width</span><span class="op" id="6062310">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6062317">d</span><span class="op" id="6062318">.</span><span class="ident" id="6062319">width</span><span class="op" id="6062324">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6062329">Height</span><span class="op" id="6062335">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6062341">d</span><span class="op" id="6062342">.</span><span class="ident" id="6062343">height</span><span class="op" id="6062349">,</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6062353">}</span><span class="op" id="6062354">,</span>&nbsp;<span class="ident" id="6062356">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6062361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6062364">return</span>&nbsp;<span class="ident" id="6062371">image</span><span class="op" id="6062376">.</span><span class="ident" id="6062377">Config</span><span class="op" id="6062383">{</span><span class="op" id="6062384">}</span><span class="op" id="6062385">,</span>&nbsp;<span class="ident" id="6062387">FormatError</span><span class="op" id="6062398">(</span><span class="string" id="6062399">&#34;missing&nbsp;SOF&nbsp;marker&#34;</span><span class="op" id="6062419">)</span><br>
<span class="lineno"></span><span class="op" id="6062421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">525</span><span class="keyword" id="6062424">func</span>&nbsp;<span class="ident" id="6062429">init</span><span class="op" id="6062433">(</span><span class="op" id="6062434">)</span>&nbsp;<span class="op" id="6062436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6062439">image</span><span class="op" id="6062444">.</span><span class="ident" id="6062445">RegisterFormat</span><span class="op" id="6062459">(</span><span class="string" id="6062460">&#34;jpeg&#34;</span><span class="op" id="6062466">,</span>&nbsp;<span class="string" id="6062468">&#34;\xff\xd8&#34;</span><span class="op" id="6062478">,</span>&nbsp;<span class="ident" id="6062480">Decode</span><span class="op" id="6062486">,</span>&nbsp;<span class="ident" id="6062488">DecodeConfig</span><span class="op" id="6062500">)</span><br>
<span class="lineno"></span><span class="op" id="6062502">}</span>
</div>
</body>
</html>
