<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html" class="current">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6398809">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6398864">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6398918">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6398969">//&nbsp;Package&nbsp;fcgi&nbsp;implements&nbsp;the&nbsp;FastCGI&nbsp;protocol.</span><br>
<span class="lineno"></span><span class="comment" id="6399018">//&nbsp;Currently&nbsp;only&nbsp;the&nbsp;responder&nbsp;role&nbsp;is&nbsp;supported.</span><br>
<span class="lineno"></span><span class="comment" id="6399069">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;defined&nbsp;at&nbsp;http://www.fastcgi.com/drupal/node/6?q=node/22</span><br>
<span class="lineno"></span><span class="keyword" id="6399146">package</span>&nbsp;<span class="ident" id="6399154">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="6399160">//&nbsp;This&nbsp;file&nbsp;defines&nbsp;the&nbsp;raw&nbsp;protocol&nbsp;and&nbsp;some&nbsp;utilities&nbsp;used&nbsp;by&nbsp;the&nbsp;child&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6399239">//&nbsp;the&nbsp;host.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6399253">import</span>&nbsp;<span class="op" id="6399260">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6399263">&#34;bufio&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6399272">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6399281">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6399300">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6399310">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6399316">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="6399323">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6399326">//&nbsp;recType&nbsp;is&nbsp;a&nbsp;record&nbsp;type,&nbsp;as&nbsp;defined&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="6399369">//&nbsp;http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S8</span><br>
<span class="lineno"></span><span class="keyword" id="6399424">type</span>&nbsp;<span class="ident" id="6399429">recType</span>&nbsp;<span class="builtintype" id="6399437">uint8</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6399444">const</span>&nbsp;<span class="op" id="6399450">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399453">typeBeginRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399473">recType</span>&nbsp;<span class="op" id="6399481">=</span>&nbsp;<span class="num" id="6399483">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399486">typeAbortRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399506">recType</span>&nbsp;<span class="op" id="6399514">=</span>&nbsp;<span class="num" id="6399516">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399519">typeEndRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399539">recType</span>&nbsp;<span class="op" id="6399547">=</span>&nbsp;<span class="num" id="6399549">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399552">typeParams</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399572">recType</span>&nbsp;<span class="op" id="6399580">=</span>&nbsp;<span class="num" id="6399582">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399585">typeStdin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399605">recType</span>&nbsp;<span class="op" id="6399613">=</span>&nbsp;<span class="num" id="6399615">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399618">typeStdout</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399638">recType</span>&nbsp;<span class="op" id="6399646">=</span>&nbsp;<span class="num" id="6399648">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399651">typeStderr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399671">recType</span>&nbsp;<span class="op" id="6399679">=</span>&nbsp;<span class="num" id="6399681">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399684">typeData</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399704">recType</span>&nbsp;<span class="op" id="6399712">=</span>&nbsp;<span class="num" id="6399714">8</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399717">typeGetValues</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399737">recType</span>&nbsp;<span class="op" id="6399745">=</span>&nbsp;<span class="num" id="6399747">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399750">typeGetValuesResult</span>&nbsp;<span class="ident" id="6399770">recType</span>&nbsp;<span class="op" id="6399778">=</span>&nbsp;<span class="num" id="6399780">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399784">typeUnknownType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399804">recType</span>&nbsp;<span class="op" id="6399812">=</span>&nbsp;<span class="num" id="6399814">11</span><br>
<span class="lineno"></span><span class="op" id="6399817">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="6399820">//&nbsp;keep&nbsp;the&nbsp;connection&nbsp;between&nbsp;web-server&nbsp;and&nbsp;responder&nbsp;open&nbsp;after&nbsp;request</span><br>
<span class="lineno"></span><span class="keyword" id="6399895">const</span>&nbsp;<span class="ident" id="6399901">flagKeepConn</span>&nbsp;<span class="op" id="6399914">=</span>&nbsp;<span class="num" id="6399916">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6399919">const</span>&nbsp;<span class="op" id="6399925">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399928">maxWrite</span>&nbsp;<span class="op" id="6399937">=</span>&nbsp;<span class="num" id="6399939">65535</span>&nbsp;<span class="comment" id="6399945">//&nbsp;maximum&nbsp;record&nbsp;body</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399969">maxPad</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6399978">=</span>&nbsp;<span class="num" id="6399980">255</span><br>
<span class="lineno"></span><span class="op" id="6399984">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6399987">const</span>&nbsp;<span class="op" id="6399993">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6399996">roleResponder</span>&nbsp;<span class="op" id="6400010">=</span>&nbsp;<span class="ident" id="6400012">iota</span>&nbsp;<span class="op" id="6400017">+</span>&nbsp;<span class="num" id="6400019">1</span>&nbsp;<span class="comment" id="6400021">//&nbsp;only&nbsp;Responders&nbsp;are&nbsp;implemented.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400058">roleAuthorizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400074">roleFilter</span><br>
<span class="lineno"></span><span class="op" id="6400085">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6400088">const</span>&nbsp;<span class="op" id="6400094">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400097">statusRequestComplete</span>&nbsp;<span class="op" id="6400119">=</span>&nbsp;<span class="ident" id="6400121">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400127">statusCantMultiplex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400148">statusOverloaded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400166">statusUnknownRole</span><br>
<span class="lineno"></span><span class="op" id="6400184">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6400187">const</span>&nbsp;<span class="ident" id="6400193">headerLen</span>&nbsp;<span class="op" id="6400203">=</span>&nbsp;<span class="num" id="6400205">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6400208">type</span>&nbsp;<span class="ident" id="6400213">header</span>&nbsp;<span class="keyword" id="6400220">struct</span>&nbsp;<span class="op" id="6400227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400230">Version</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6400244">uint8</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400251">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400265">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400274">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6400288">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400296">ContentLength</span>&nbsp;<span class="builtintype" id="6400310">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400318">PaddingLength</span>&nbsp;<span class="builtintype" id="6400332">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400339">Reserved</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6400353">uint8</span><br>
<span class="lineno">70</span><span class="op" id="6400359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6400362">type</span>&nbsp;<span class="ident" id="6400367">beginRequest</span>&nbsp;<span class="keyword" id="6400380">struct</span>&nbsp;<span class="op" id="6400387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400390">role</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6400399">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400407">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6400416">uint8</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400423">reserved</span>&nbsp;<span class="op" id="6400432">[</span><span class="num" id="6400433">5</span><span class="op" id="6400434">]</span><span class="builtintype" id="6400435">uint8</span><br>
<span class="lineno"></span><span class="op" id="6400441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6400444">func</span>&nbsp;<span class="op" id="6400449">(</span><span class="ident" id="6400450">br</span>&nbsp;<span class="op" id="6400453">*</span><span class="ident" id="6400454">beginRequest</span><span class="op" id="6400466">)</span>&nbsp;<span class="ident" id="6400468">read</span><span class="op" id="6400472">(</span><span class="ident" id="6400473">content</span>&nbsp;<span class="op" id="6400481">[</span><span class="op" id="6400482">]</span><span class="builtintype" id="6400483">byte</span><span class="op" id="6400487">)</span>&nbsp;<span class="builtintype" id="6400489">error</span>&nbsp;<span class="op" id="6400495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6400498">if</span>&nbsp;<span class="builtinfunc" id="6400501">len</span><span class="op" id="6400504">(</span><span class="ident" id="6400505">content</span><span class="op" id="6400512">)</span>&nbsp;<span class="op" id="6400514">!=</span>&nbsp;<span class="num" id="6400517">8</span>&nbsp;<span class="op" id="6400519">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6400523">return</span>&nbsp;<span class="ident" id="6400530">errors</span><span class="op" id="6400536">.</span><span class="ident" id="6400537">New</span><span class="op" id="6400540">(</span><span class="string" id="6400541">&#34;fcgi:&nbsp;invalid&nbsp;begin&nbsp;request&nbsp;record&#34;</span><span class="op" id="6400577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6400580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400583">br</span><span class="op" id="6400585">.</span><span class="ident" id="6400586">role</span>&nbsp;<span class="op" id="6400591">=</span>&nbsp;<span class="ident" id="6400593">binary</span><span class="op" id="6400599">.</span><span class="ident" id="6400600">BigEndian</span><span class="op" id="6400609">.</span><span class="ident" id="6400610">Uint16</span><span class="op" id="6400616">(</span><span class="ident" id="6400617">content</span><span class="op" id="6400624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400627">br</span><span class="op" id="6400629">.</span><span class="ident" id="6400630">flags</span>&nbsp;<span class="op" id="6400636">=</span>&nbsp;<span class="ident" id="6400638">content</span><span class="op" id="6400645">[</span><span class="num" id="6400646">2</span><span class="op" id="6400647">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6400650">return</span>&nbsp;<span class="ident" id="6400657">nil</span><br>
<span class="lineno">85</span><span class="op" id="6400661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6400664">//&nbsp;for&nbsp;padding&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;allocate&nbsp;all&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="6400721">//&nbsp;not&nbsp;synchronized&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;care&nbsp;what&nbsp;the&nbsp;contents&nbsp;are</span><br>
<span class="lineno"></span><span class="keyword" id="6400785">var</span>&nbsp;<span class="ident" id="6400789">pad</span>&nbsp;<span class="op" id="6400793">[</span><span class="ident" id="6400794">maxPad</span><span class="op" id="6400800">]</span><span class="builtintype" id="6400801">byte</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="6400807">func</span>&nbsp;<span class="op" id="6400812">(</span><span class="ident" id="6400813">h</span>&nbsp;<span class="op" id="6400815">*</span><span class="ident" id="6400816">header</span><span class="op" id="6400822">)</span>&nbsp;<span class="ident" id="6400824">init</span><span class="op" id="6400828">(</span><span class="ident" id="6400829">recType</span>&nbsp;<span class="ident" id="6400837">recType</span><span class="op" id="6400844">,</span>&nbsp;<span class="ident" id="6400846">reqId</span>&nbsp;<span class="builtintype" id="6400852">uint16</span><span class="op" id="6400858">,</span>&nbsp;<span class="ident" id="6400860">contentLength</span>&nbsp;<span class="builtintype" id="6400874">int</span><span class="op" id="6400877">)</span>&nbsp;<span class="op" id="6400879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400882">h</span><span class="op" id="6400883">.</span><span class="ident" id="6400884">Version</span>&nbsp;<span class="op" id="6400892">=</span>&nbsp;<span class="num" id="6400894">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400897">h</span><span class="op" id="6400898">.</span><span class="ident" id="6400899">Type</span>&nbsp;<span class="op" id="6400904">=</span>&nbsp;<span class="ident" id="6400906">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400915">h</span><span class="op" id="6400916">.</span><span class="ident" id="6400917">Id</span>&nbsp;<span class="op" id="6400920">=</span>&nbsp;<span class="ident" id="6400922">reqId</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400929">h</span><span class="op" id="6400930">.</span><span class="ident" id="6400931">ContentLength</span>&nbsp;<span class="op" id="6400945">=</span>&nbsp;<span class="builtintype" id="6400947">uint16</span><span class="op" id="6400953">(</span><span class="ident" id="6400954">contentLength</span><span class="op" id="6400967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400970">h</span><span class="op" id="6400971">.</span><span class="ident" id="6400972">PaddingLength</span>&nbsp;<span class="op" id="6400986">=</span>&nbsp;<span class="builtintype" id="6400988">uint8</span><span class="op" id="6400993">(</span><span class="op" id="6400994">-</span><span class="ident" id="6400995">contentLength</span>&nbsp;<span class="op" id="6401009">&amp;</span>&nbsp;<span class="num" id="6401011">7</span><span class="op" id="6401012">)</span><br>
<span class="lineno"></span><span class="op" id="6401014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6401017">//&nbsp;conn&nbsp;sends&nbsp;records&nbsp;over&nbsp;rwc</span><br>
<span class="lineno">100</span><span class="keyword" id="6401048">type</span>&nbsp;<span class="ident" id="6401053">conn</span>&nbsp;<span class="keyword" id="6401058">struct</span>&nbsp;<span class="op" id="6401065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401068">mutex</span>&nbsp;<span class="ident" id="6401074">sync</span><span class="op" id="6401078">.</span><span class="ident" id="6401079">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401086">rwc</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6401092">io</span><span class="op" id="6401094">.</span><span class="ident" id="6401095">ReadWriteCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6401113">//&nbsp;to&nbsp;avoid&nbsp;allocations</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401138">buf</span>&nbsp;<span class="ident" id="6401142">bytes</span><span class="op" id="6401147">.</span><span class="ident" id="6401148">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401156">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6401160">header</span><br>
<span class="lineno"></span><span class="op" id="6401167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6401170">func</span>&nbsp;<span class="ident" id="6401175">newConn</span><span class="op" id="6401182">(</span><span class="ident" id="6401183">rwc</span>&nbsp;<span class="ident" id="6401187">io</span><span class="op" id="6401189">.</span><span class="ident" id="6401190">ReadWriteCloser</span><span class="op" id="6401205">)</span>&nbsp;<span class="op" id="6401207">*</span><span class="ident" id="6401208">conn</span>&nbsp;<span class="op" id="6401213">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401216">return</span>&nbsp;<span class="op" id="6401223">&amp;</span><span class="ident" id="6401224">conn</span><span class="op" id="6401228">{</span><span class="ident" id="6401229">rwc</span><span class="op" id="6401232">:</span>&nbsp;<span class="ident" id="6401234">rwc</span><span class="op" id="6401237">}</span><br>
<span class="lineno"></span><span class="op" id="6401239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6401242">func</span>&nbsp;<span class="op" id="6401247">(</span><span class="ident" id="6401248">c</span>&nbsp;<span class="op" id="6401250">*</span><span class="ident" id="6401251">conn</span><span class="op" id="6401255">)</span>&nbsp;<span class="ident" id="6401257">Close</span><span class="op" id="6401262">(</span><span class="op" id="6401263">)</span>&nbsp;<span class="builtintype" id="6401265">error</span>&nbsp;<span class="op" id="6401271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401274">c</span><span class="op" id="6401275">.</span><span class="ident" id="6401276">mutex</span><span class="op" id="6401281">.</span><span class="ident" id="6401282">Lock</span><span class="op" id="6401286">(</span><span class="op" id="6401287">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401290">defer</span>&nbsp;<span class="ident" id="6401296">c</span><span class="op" id="6401297">.</span><span class="ident" id="6401298">mutex</span><span class="op" id="6401303">.</span><span class="ident" id="6401304">Unlock</span><span class="op" id="6401310">(</span><span class="op" id="6401311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401314">return</span>&nbsp;<span class="ident" id="6401321">c</span><span class="op" id="6401322">.</span><span class="ident" id="6401323">rwc</span><span class="op" id="6401326">.</span><span class="ident" id="6401327">Close</span><span class="op" id="6401332">(</span><span class="op" id="6401333">)</span><br>
<span class="lineno"></span><span class="op" id="6401335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6401338">type</span>&nbsp;<span class="ident" id="6401343">record</span>&nbsp;<span class="keyword" id="6401350">struct</span>&nbsp;<span class="op" id="6401357">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401360">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6401364">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401372">buf</span>&nbsp;<span class="op" id="6401376">[</span><span class="ident" id="6401377">maxWrite</span>&nbsp;<span class="op" id="6401386">+</span>&nbsp;<span class="ident" id="6401388">maxPad</span><span class="op" id="6401394">]</span><span class="builtintype" id="6401395">byte</span><br>
<span class="lineno"></span><span class="op" id="6401400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6401403">func</span>&nbsp;<span class="op" id="6401408">(</span><span class="ident" id="6401409">rec</span>&nbsp;<span class="op" id="6401413">*</span><span class="ident" id="6401414">record</span><span class="op" id="6401420">)</span>&nbsp;<span class="ident" id="6401422">read</span><span class="op" id="6401426">(</span><span class="ident" id="6401427">r</span>&nbsp;<span class="ident" id="6401429">io</span><span class="op" id="6401431">.</span><span class="ident" id="6401432">Reader</span><span class="op" id="6401438">)</span>&nbsp;<span class="op" id="6401440">(</span><span class="ident" id="6401441">err</span>&nbsp;<span class="builtintype" id="6401445">error</span><span class="op" id="6401450">)</span>&nbsp;<span class="op" id="6401452">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401455">if</span>&nbsp;<span class="ident" id="6401458">err</span>&nbsp;<span class="op" id="6401462">=</span>&nbsp;<span class="ident" id="6401464">binary</span><span class="op" id="6401470">.</span><span class="ident" id="6401471">Read</span><span class="op" id="6401475">(</span><span class="ident" id="6401476">r</span><span class="op" id="6401477">,</span>&nbsp;<span class="ident" id="6401479">binary</span><span class="op" id="6401485">.</span><span class="ident" id="6401486">BigEndian</span><span class="op" id="6401495">,</span>&nbsp;<span class="op" id="6401497">&amp;</span><span class="ident" id="6401498">rec</span><span class="op" id="6401501">.</span><span class="ident" id="6401502">h</span><span class="op" id="6401503">)</span><span class="op" id="6401504">;</span>&nbsp;<span class="ident" id="6401506">err</span>&nbsp;<span class="op" id="6401510">!=</span>&nbsp;<span class="ident" id="6401513">nil</span>&nbsp;<span class="op" id="6401517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401521">return</span>&nbsp;<span class="ident" id="6401528">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6401533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401536">if</span>&nbsp;<span class="ident" id="6401539">rec</span><span class="op" id="6401542">.</span><span class="ident" id="6401543">h</span><span class="op" id="6401544">.</span><span class="ident" id="6401545">Version</span>&nbsp;<span class="op" id="6401553">!=</span>&nbsp;<span class="num" id="6401556">1</span>&nbsp;<span class="op" id="6401558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401562">return</span>&nbsp;<span class="ident" id="6401569">errors</span><span class="op" id="6401575">.</span><span class="ident" id="6401576">New</span><span class="op" id="6401579">(</span><span class="string" id="6401580">&#34;fcgi:&nbsp;invalid&nbsp;header&nbsp;version&#34;</span><span class="op" id="6401610">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6401613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401616">n</span>&nbsp;<span class="op" id="6401618">:=</span>&nbsp;<span class="builtintype" id="6401621">int</span><span class="op" id="6401624">(</span><span class="ident" id="6401625">rec</span><span class="op" id="6401628">.</span><span class="ident" id="6401629">h</span><span class="op" id="6401630">.</span><span class="ident" id="6401631">ContentLength</span><span class="op" id="6401644">)</span>&nbsp;<span class="op" id="6401646">+</span>&nbsp;<span class="builtintype" id="6401648">int</span><span class="op" id="6401651">(</span><span class="ident" id="6401652">rec</span><span class="op" id="6401655">.</span><span class="ident" id="6401656">h</span><span class="op" id="6401657">.</span><span class="ident" id="6401658">PaddingLength</span><span class="op" id="6401671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401674">if</span>&nbsp;<span class="ident" id="6401677">_</span><span class="op" id="6401678">,</span>&nbsp;<span class="ident" id="6401680">err</span>&nbsp;<span class="op" id="6401684">=</span>&nbsp;<span class="ident" id="6401686">io</span><span class="op" id="6401688">.</span><span class="ident" id="6401689">ReadFull</span><span class="op" id="6401697">(</span><span class="ident" id="6401698">r</span><span class="op" id="6401699">,</span>&nbsp;<span class="ident" id="6401701">rec</span><span class="op" id="6401704">.</span><span class="ident" id="6401705">buf</span><span class="op" id="6401708">[</span><span class="op" id="6401709">:</span><span class="ident" id="6401710">n</span><span class="op" id="6401711">]</span><span class="op" id="6401712">)</span><span class="op" id="6401713">;</span>&nbsp;<span class="ident" id="6401715">err</span>&nbsp;<span class="op" id="6401719">!=</span>&nbsp;<span class="ident" id="6401722">nil</span>&nbsp;<span class="op" id="6401726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401730">return</span>&nbsp;<span class="ident" id="6401737">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6401742">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401745">return</span>&nbsp;<span class="ident" id="6401752">nil</span><br>
<span class="lineno"></span><span class="op" id="6401756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6401759">func</span>&nbsp;<span class="op" id="6401764">(</span><span class="ident" id="6401765">r</span>&nbsp;<span class="op" id="6401767">*</span><span class="ident" id="6401768">record</span><span class="op" id="6401774">)</span>&nbsp;<span class="ident" id="6401776">content</span><span class="op" id="6401783">(</span><span class="op" id="6401784">)</span>&nbsp;<span class="op" id="6401786">[</span><span class="op" id="6401787">]</span><span class="builtintype" id="6401788">byte</span>&nbsp;<span class="op" id="6401793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401796">return</span>&nbsp;<span class="ident" id="6401803">r</span><span class="op" id="6401804">.</span><span class="ident" id="6401805">buf</span><span class="op" id="6401808">[</span><span class="op" id="6401809">:</span><span class="ident" id="6401810">r</span><span class="op" id="6401811">.</span><span class="ident" id="6401812">h</span><span class="op" id="6401813">.</span><span class="ident" id="6401814">ContentLength</span><span class="op" id="6401827">]</span><br>
<span class="lineno">140</span><span class="op" id="6401829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6401832">//&nbsp;writeRecord&nbsp;writes&nbsp;and&nbsp;sends&nbsp;a&nbsp;single&nbsp;record.</span><br>
<span class="lineno"></span><span class="keyword" id="6401881">func</span>&nbsp;<span class="op" id="6401886">(</span><span class="ident" id="6401887">c</span>&nbsp;<span class="op" id="6401889">*</span><span class="ident" id="6401890">conn</span><span class="op" id="6401894">)</span>&nbsp;<span class="ident" id="6401896">writeRecord</span><span class="op" id="6401907">(</span><span class="ident" id="6401908">recType</span>&nbsp;<span class="ident" id="6401916">recType</span><span class="op" id="6401923">,</span>&nbsp;<span class="ident" id="6401925">reqId</span>&nbsp;<span class="builtintype" id="6401931">uint16</span><span class="op" id="6401937">,</span>&nbsp;<span class="ident" id="6401939">b</span>&nbsp;<span class="op" id="6401941">[</span><span class="op" id="6401942">]</span><span class="builtintype" id="6401943">byte</span><span class="op" id="6401947">)</span>&nbsp;<span class="builtintype" id="6401949">error</span>&nbsp;<span class="op" id="6401955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401958">c</span><span class="op" id="6401959">.</span><span class="ident" id="6401960">mutex</span><span class="op" id="6401965">.</span><span class="ident" id="6401966">Lock</span><span class="op" id="6401970">(</span><span class="op" id="6401971">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401974">defer</span>&nbsp;<span class="ident" id="6401980">c</span><span class="op" id="6401981">.</span><span class="ident" id="6401982">mutex</span><span class="op" id="6401987">.</span><span class="ident" id="6401988">Unlock</span><span class="op" id="6401994">(</span><span class="op" id="6401995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401998">c</span><span class="op" id="6401999">.</span><span class="ident" id="6402000">buf</span><span class="op" id="6402003">.</span><span class="ident" id="6402004">Reset</span><span class="op" id="6402009">(</span><span class="op" id="6402010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402013">c</span><span class="op" id="6402014">.</span><span class="ident" id="6402015">h</span><span class="op" id="6402016">.</span><span class="ident" id="6402017">init</span><span class="op" id="6402021">(</span><span class="ident" id="6402022">recType</span><span class="op" id="6402029">,</span>&nbsp;<span class="ident" id="6402031">reqId</span><span class="op" id="6402036">,</span>&nbsp;<span class="builtinfunc" id="6402038">len</span><span class="op" id="6402041">(</span><span class="ident" id="6402042">b</span><span class="op" id="6402043">)</span><span class="op" id="6402044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6402047">if</span>&nbsp;<span class="ident" id="6402050">err</span>&nbsp;<span class="op" id="6402054">:=</span>&nbsp;<span class="ident" id="6402057">binary</span><span class="op" id="6402063">.</span><span class="ident" id="6402064">Write</span><span class="op" id="6402069">(</span><span class="op" id="6402070">&amp;</span><span class="ident" id="6402071">c</span><span class="op" id="6402072">.</span><span class="ident" id="6402073">buf</span><span class="op" id="6402076">,</span>&nbsp;<span class="ident" id="6402078">binary</span><span class="op" id="6402084">.</span><span class="ident" id="6402085">BigEndian</span><span class="op" id="6402094">,</span>&nbsp;<span class="ident" id="6402096">c</span><span class="op" id="6402097">.</span><span class="ident" id="6402098">h</span><span class="op" id="6402099">)</span><span class="op" id="6402100">;</span>&nbsp;<span class="ident" id="6402102">err</span>&nbsp;<span class="op" id="6402106">!=</span>&nbsp;<span class="ident" id="6402109">nil</span>&nbsp;<span class="op" id="6402113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6402117">return</span>&nbsp;<span class="ident" id="6402124">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6402129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6402132">if</span>&nbsp;<span class="ident" id="6402135">_</span><span class="op" id="6402136">,</span>&nbsp;<span class="ident" id="6402138">err</span>&nbsp;<span class="op" id="6402142">:=</span>&nbsp;<span class="ident" id="6402145">c</span><span class="op" id="6402146">.</span><span class="ident" id="6402147">buf</span><span class="op" id="6402150">.</span><span class="ident" id="6402151">Write</span><span class="op" id="6402156">(</span><span class="ident" id="6402157">b</span><span class="op" id="6402158">)</span><span class="op" id="6402159">;</span>&nbsp;<span class="ident" id="6402161">err</span>&nbsp;<span class="op" id="6402165">!=</span>&nbsp;<span class="ident" id="6402168">nil</span>&nbsp;<span class="op" id="6402172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6402176">return</span>&nbsp;<span class="ident" id="6402183">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6402188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6402191">if</span>&nbsp;<span class="ident" id="6402194">_</span><span class="op" id="6402195">,</span>&nbsp;<span class="ident" id="6402197">err</span>&nbsp;<span class="op" id="6402201">:=</span>&nbsp;<span class="ident" id="6402204">c</span><span class="op" id="6402205">.</span><span class="ident" id="6402206">buf</span><span class="op" id="6402209">.</span><span class="ident" id="6402210">Write</span><span class="op" id="6402215">(</span><span class="ident" id="6402216">pad</span><span class="op" id="6402219">[</span><span class="op" id="6402220">:</span><span class="ident" id="6402221">c</span><span class="op" id="6402222">.</span><span class="ident" id="6402223">h</span><span class="op" id="6402224">.</span><span class="ident" id="6402225">PaddingLength</span><span class="op" id="6402238">]</span><span class="op" id="6402239">)</span><span class="op" id="6402240">;</span>&nbsp;<span class="ident" id="6402242">err</span>&nbsp;<span class="op" id="6402246">!=</span>&nbsp;<span class="ident" id="6402249">nil</span>&nbsp;<span class="op" id="6402253">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6402257">return</span>&nbsp;<span class="ident" id="6402264">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6402269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402272">_</span><span class="op" id="6402273">,</span>&nbsp;<span class="ident" id="6402275">err</span>&nbsp;<span class="op" id="6402279">:=</span>&nbsp;<span class="ident" id="6402282">c</span><span class="op" id="6402283">.</span><span class="ident" id="6402284">rwc</span><span class="op" id="6402287">.</span><span class="ident" id="6402288">Write</span><span class="op" id="6402293">(</span><span class="ident" id="6402294">c</span><span class="op" id="6402295">.</span><span class="ident" id="6402296">buf</span><span class="op" id="6402299">.</span><span class="ident" id="6402300">Bytes</span><span class="op" id="6402305">(</span><span class="op" id="6402306">)</span><span class="op" id="6402307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6402310">return</span>&nbsp;<span class="ident" id="6402317">err</span><br>
<span class="lineno"></span><span class="op" id="6402321">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="keyword" id="6402324">func</span>&nbsp;<span class="op" id="6402329">(</span><span class="ident" id="6402330">c</span>&nbsp;<span class="op" id="6402332">*</span><span class="ident" id="6402333">conn</span><span class="op" id="6402337">)</span>&nbsp;<span class="ident" id="6402339">writeBeginRequest</span><span class="op" id="6402356">(</span><span class="ident" id="6402357">reqId</span>&nbsp;<span class="builtintype" id="6402363">uint16</span><span class="op" id="6402369">,</span>&nbsp;<span class="ident" id="6402371">role</span>&nbsp;<span class="builtintype" id="6402376">uint16</span><span class="op" id="6402382">,</span>&nbsp;<span class="ident" id="6402384">flags</span>&nbsp;<span class="builtintype" id="6402390">uint8</span><span class="op" id="6402395">)</span>&nbsp;<span class="builtintype" id="6402397">error</span>&nbsp;<span class="op" id="6402403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402406">b</span>&nbsp;<span class="op" id="6402408">:=</span>&nbsp;<span class="op" id="6402411">[</span><span class="num" id="6402412">8</span><span class="op" id="6402413">]</span><span class="builtintype" id="6402414">byte</span><span class="op" id="6402418">{</span><span class="builtintype" id="6402419">byte</span><span class="op" id="6402423">(</span><span class="ident" id="6402424">role</span>&nbsp;<span class="op" id="6402429">&gt;&gt;</span>&nbsp;<span class="num" id="6402432">8</span><span class="op" id="6402433">)</span><span class="op" id="6402434">,</span>&nbsp;<span class="builtintype" id="6402436">byte</span><span class="op" id="6402440">(</span><span class="ident" id="6402441">role</span><span class="op" id="6402445">)</span><span class="op" id="6402446">,</span>&nbsp;<span class="ident" id="6402448">flags</span><span class="op" id="6402453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6402456">return</span>&nbsp;<span class="ident" id="6402463">c</span><span class="op" id="6402464">.</span><span class="ident" id="6402465">writeRecord</span><span class="op" id="6402476">(</span><span class="ident" id="6402477">typeBeginRequest</span><span class="op" id="6402493">,</span>&nbsp;<span class="ident" id="6402495">reqId</span><span class="op" id="6402500">,</span>&nbsp;<span class="ident" id="6402502">b</span><span class="op" id="6402503">[</span><span class="op" id="6402504">:</span><span class="op" id="6402505">]</span><span class="op" id="6402506">)</span><br>
<span class="lineno"></span><span class="op" id="6402508">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="6402511">func</span>&nbsp;<span class="op" id="6402516">(</span><span class="ident" id="6402517">c</span>&nbsp;<span class="op" id="6402519">*</span><span class="ident" id="6402520">conn</span><span class="op" id="6402524">)</span>&nbsp;<span class="ident" id="6402526">writeEndRequest</span><span class="op" id="6402541">(</span><span class="ident" id="6402542">reqId</span>&nbsp;<span class="builtintype" id="6402548">uint16</span><span class="op" id="6402554">,</span>&nbsp;<span class="ident" id="6402556">appStatus</span>&nbsp;<span class="builtintype" id="6402566">int</span><span class="op" id="6402569">,</span>&nbsp;<span class="ident" id="6402571">protocolStatus</span>&nbsp;<span class="builtintype" id="6402586">uint8</span><span class="op" id="6402591">)</span>&nbsp;<span class="builtintype" id="6402593">error</span>&nbsp;<span class="op" id="6402599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402602">b</span>&nbsp;<span class="op" id="6402604">:=</span>&nbsp;<span class="builtinfunc" id="6402607">make</span><span class="op" id="6402611">(</span><span class="op" id="6402612">[</span><span class="op" id="6402613">]</span><span class="builtintype" id="6402614">byte</span><span class="op" id="6402618">,</span>&nbsp;<span class="num" id="6402620">8</span><span class="op" id="6402621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402624">binary</span><span class="op" id="6402630">.</span><span class="ident" id="6402631">BigEndian</span><span class="op" id="6402640">.</span><span class="ident" id="6402641">PutUint32</span><span class="op" id="6402650">(</span><span class="ident" id="6402651">b</span><span class="op" id="6402652">,</span>&nbsp;<span class="builtintype" id="6402654">uint32</span><span class="op" id="6402660">(</span><span class="ident" id="6402661">appStatus</span><span class="op" id="6402670">)</span><span class="op" id="6402671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402674">b</span><span class="op" id="6402675">[</span><span class="num" id="6402676">4</span><span class="op" id="6402677">]</span>&nbsp;<span class="op" id="6402679">=</span>&nbsp;<span class="ident" id="6402681">protocolStatus</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6402697">return</span>&nbsp;<span class="ident" id="6402704">c</span><span class="op" id="6402705">.</span><span class="ident" id="6402706">writeRecord</span><span class="op" id="6402717">(</span><span class="ident" id="6402718">typeEndRequest</span><span class="op" id="6402732">,</span>&nbsp;<span class="ident" id="6402734">reqId</span><span class="op" id="6402739">,</span>&nbsp;<span class="ident" id="6402741">b</span><span class="op" id="6402742">)</span><br>
<span class="lineno"></span><span class="op" id="6402744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6402747">func</span>&nbsp;<span class="op" id="6402752">(</span><span class="ident" id="6402753">c</span>&nbsp;<span class="op" id="6402755">*</span><span class="ident" id="6402756">conn</span><span class="op" id="6402760">)</span>&nbsp;<span class="ident" id="6402762">writePairs</span><span class="op" id="6402772">(</span><span class="ident" id="6402773">recType</span>&nbsp;<span class="ident" id="6402781">recType</span><span class="op" id="6402788">,</span>&nbsp;<span class="ident" id="6402790">reqId</span>&nbsp;<span class="builtintype" id="6402796">uint16</span><span class="op" id="6402802">,</span>&nbsp;<span class="ident" id="6402804">pairs</span>&nbsp;<span class="keyword" id="6402810">map</span><span class="op" id="6402813">[</span><span class="builtintype" id="6402814">string</span><span class="op" id="6402820">]</span><span class="builtintype" id="6402821">string</span><span class="op" id="6402827">)</span>&nbsp;<span class="builtintype" id="6402829">error</span>&nbsp;<span class="op" id="6402835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402838">w</span>&nbsp;<span class="op" id="6402840">:=</span>&nbsp;<span class="ident" id="6402843">newWriter</span><span class="op" id="6402852">(</span><span class="ident" id="6402853">c</span><span class="op" id="6402854">,</span>&nbsp;<span class="ident" id="6402856">recType</span><span class="op" id="6402863">,</span>&nbsp;<span class="ident" id="6402865">reqId</span><span class="op" id="6402870">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402873">b</span>&nbsp;<span class="op" id="6402875">:=</span>&nbsp;<span class="builtinfunc" id="6402878">make</span><span class="op" id="6402882">(</span><span class="op" id="6402883">[</span><span class="op" id="6402884">]</span><span class="builtintype" id="6402885">byte</span><span class="op" id="6402889">,</span>&nbsp;<span class="num" id="6402891">8</span><span class="op" id="6402892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6402895">for</span>&nbsp;<span class="ident" id="6402899">k</span><span class="op" id="6402900">,</span>&nbsp;<span class="ident" id="6402902">v</span>&nbsp;<span class="op" id="6402904">:=</span>&nbsp;<span class="keyword" id="6402907">range</span>&nbsp;<span class="ident" id="6402913">pairs</span>&nbsp;<span class="op" id="6402919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402923">n</span>&nbsp;<span class="op" id="6402925">:=</span>&nbsp;<span class="ident" id="6402928">encodeSize</span><span class="op" id="6402938">(</span><span class="ident" id="6402939">b</span><span class="op" id="6402940">,</span>&nbsp;<span class="builtintype" id="6402942">uint32</span><span class="op" id="6402948">(</span><span class="builtinfunc" id="6402949">len</span><span class="op" id="6402952">(</span><span class="ident" id="6402953">k</span><span class="op" id="6402954">)</span><span class="op" id="6402955">)</span><span class="op" id="6402956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402960">n</span>&nbsp;<span class="op" id="6402962">+=</span>&nbsp;<span class="ident" id="6402965">encodeSize</span><span class="op" id="6402975">(</span><span class="ident" id="6402976">b</span><span class="op" id="6402977">[</span><span class="ident" id="6402978">n</span><span class="op" id="6402979">:</span><span class="op" id="6402980">]</span><span class="op" id="6402981">,</span>&nbsp;<span class="builtintype" id="6402983">uint32</span><span class="op" id="6402989">(</span><span class="builtinfunc" id="6402990">len</span><span class="op" id="6402993">(</span><span class="ident" id="6402994">v</span><span class="op" id="6402995">)</span><span class="op" id="6402996">)</span><span class="op" id="6402997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403001">if</span>&nbsp;<span class="ident" id="6403004">_</span><span class="op" id="6403005">,</span>&nbsp;<span class="ident" id="6403007">err</span>&nbsp;<span class="op" id="6403011">:=</span>&nbsp;<span class="ident" id="6403014">w</span><span class="op" id="6403015">.</span><span class="ident" id="6403016">Write</span><span class="op" id="6403021">(</span><span class="ident" id="6403022">b</span><span class="op" id="6403023">[</span><span class="op" id="6403024">:</span><span class="ident" id="6403025">n</span><span class="op" id="6403026">]</span><span class="op" id="6403027">)</span><span class="op" id="6403028">;</span>&nbsp;<span class="ident" id="6403030">err</span>&nbsp;<span class="op" id="6403034">!=</span>&nbsp;<span class="ident" id="6403037">nil</span>&nbsp;<span class="op" id="6403041">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403046">return</span>&nbsp;<span class="ident" id="6403053">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403063">if</span>&nbsp;<span class="ident" id="6403066">_</span><span class="op" id="6403067">,</span>&nbsp;<span class="ident" id="6403069">err</span>&nbsp;<span class="op" id="6403073">:=</span>&nbsp;<span class="ident" id="6403076">w</span><span class="op" id="6403077">.</span><span class="ident" id="6403078">WriteString</span><span class="op" id="6403089">(</span><span class="ident" id="6403090">k</span><span class="op" id="6403091">)</span><span class="op" id="6403092">;</span>&nbsp;<span class="ident" id="6403094">err</span>&nbsp;<span class="op" id="6403098">!=</span>&nbsp;<span class="ident" id="6403101">nil</span>&nbsp;<span class="op" id="6403105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403110">return</span>&nbsp;<span class="ident" id="6403117">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403123">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403127">if</span>&nbsp;<span class="ident" id="6403130">_</span><span class="op" id="6403131">,</span>&nbsp;<span class="ident" id="6403133">err</span>&nbsp;<span class="op" id="6403137">:=</span>&nbsp;<span class="ident" id="6403140">w</span><span class="op" id="6403141">.</span><span class="ident" id="6403142">WriteString</span><span class="op" id="6403153">(</span><span class="ident" id="6403154">v</span><span class="op" id="6403155">)</span><span class="op" id="6403156">;</span>&nbsp;<span class="ident" id="6403158">err</span>&nbsp;<span class="op" id="6403162">!=</span>&nbsp;<span class="ident" id="6403165">nil</span>&nbsp;<span class="op" id="6403169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403174">return</span>&nbsp;<span class="ident" id="6403181">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403193">w</span><span class="op" id="6403194">.</span><span class="ident" id="6403195">Close</span><span class="op" id="6403200">(</span><span class="op" id="6403201">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403204">return</span>&nbsp;<span class="ident" id="6403211">nil</span><br>
<span class="lineno"></span><span class="op" id="6403215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6403218">func</span>&nbsp;<span class="ident" id="6403223">readSize</span><span class="op" id="6403231">(</span><span class="ident" id="6403232">s</span>&nbsp;<span class="op" id="6403234">[</span><span class="op" id="6403235">]</span><span class="builtintype" id="6403236">byte</span><span class="op" id="6403240">)</span>&nbsp;<span class="op" id="6403242">(</span><span class="builtintype" id="6403243">uint32</span><span class="op" id="6403249">,</span>&nbsp;<span class="builtintype" id="6403251">int</span><span class="op" id="6403254">)</span>&nbsp;<span class="op" id="6403256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403259">if</span>&nbsp;<span class="builtinfunc" id="6403262">len</span><span class="op" id="6403265">(</span><span class="ident" id="6403266">s</span><span class="op" id="6403267">)</span>&nbsp;<span class="op" id="6403269">==</span>&nbsp;<span class="num" id="6403272">0</span>&nbsp;<span class="op" id="6403274">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403278">return</span>&nbsp;<span class="num" id="6403285">0</span><span class="op" id="6403286">,</span>&nbsp;<span class="num" id="6403288">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403294">size</span><span class="op" id="6403298">,</span>&nbsp;<span class="ident" id="6403300">n</span>&nbsp;<span class="op" id="6403302">:=</span>&nbsp;<span class="builtintype" id="6403305">uint32</span><span class="op" id="6403311">(</span><span class="ident" id="6403312">s</span><span class="op" id="6403313">[</span><span class="num" id="6403314">0</span><span class="op" id="6403315">]</span><span class="op" id="6403316">)</span><span class="op" id="6403317">,</span>&nbsp;<span class="num" id="6403319">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403322">if</span>&nbsp;<span class="ident" id="6403325">size</span><span class="op" id="6403329">&amp;</span><span class="op" id="6403330">(</span><span class="num" id="6403331">1</span><span class="op" id="6403332">&lt;&lt;</span><span class="num" id="6403334">7</span><span class="op" id="6403335">)</span>&nbsp;<span class="op" id="6403337">!=</span>&nbsp;<span class="num" id="6403340">0</span>&nbsp;<span class="op" id="6403342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403346">if</span>&nbsp;<span class="builtinfunc" id="6403349">len</span><span class="op" id="6403352">(</span><span class="ident" id="6403353">s</span><span class="op" id="6403354">)</span>&nbsp;<span class="op" id="6403356">&lt;</span>&nbsp;<span class="num" id="6403358">4</span>&nbsp;<span class="op" id="6403360">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403365">return</span>&nbsp;<span class="num" id="6403372">0</span><span class="op" id="6403373">,</span>&nbsp;<span class="num" id="6403375">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403383">n</span>&nbsp;<span class="op" id="6403385">=</span>&nbsp;<span class="num" id="6403387">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403391">size</span>&nbsp;<span class="op" id="6403396">=</span>&nbsp;<span class="ident" id="6403398">binary</span><span class="op" id="6403404">.</span><span class="ident" id="6403405">BigEndian</span><span class="op" id="6403414">.</span><span class="ident" id="6403415">Uint32</span><span class="op" id="6403421">(</span><span class="ident" id="6403422">s</span><span class="op" id="6403423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403427">size</span>&nbsp;<span class="op" id="6403432">&amp;^=</span>&nbsp;<span class="num" id="6403436">1</span>&nbsp;<span class="op" id="6403438">&lt;&lt;</span>&nbsp;<span class="num" id="6403441">31</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403448">return</span>&nbsp;<span class="ident" id="6403455">size</span><span class="op" id="6403459">,</span>&nbsp;<span class="ident" id="6403461">n</span><br>
<span class="lineno"></span><span class="op" id="6403463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6403466">func</span>&nbsp;<span class="ident" id="6403471">readString</span><span class="op" id="6403481">(</span><span class="ident" id="6403482">s</span>&nbsp;<span class="op" id="6403484">[</span><span class="op" id="6403485">]</span><span class="builtintype" id="6403486">byte</span><span class="op" id="6403490">,</span>&nbsp;<span class="ident" id="6403492">size</span>&nbsp;<span class="builtintype" id="6403497">uint32</span><span class="op" id="6403503">)</span>&nbsp;<span class="builtintype" id="6403505">string</span>&nbsp;<span class="op" id="6403512">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403515">if</span>&nbsp;<span class="ident" id="6403518">size</span>&nbsp;<span class="op" id="6403523">&gt;</span>&nbsp;<span class="builtintype" id="6403525">uint32</span><span class="op" id="6403531">(</span><span class="builtinfunc" id="6403532">len</span><span class="op" id="6403535">(</span><span class="ident" id="6403536">s</span><span class="op" id="6403537">)</span><span class="op" id="6403538">)</span>&nbsp;<span class="op" id="6403540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403544">return</span>&nbsp;<span class="string" id="6403551">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403558">return</span>&nbsp;<span class="builtintype" id="6403565">string</span><span class="op" id="6403571">(</span><span class="ident" id="6403572">s</span><span class="op" id="6403573">[</span><span class="op" id="6403574">:</span><span class="ident" id="6403575">size</span><span class="op" id="6403579">]</span><span class="op" id="6403580">)</span><br>
<span class="lineno"></span><span class="op" id="6403582">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6403585">func</span>&nbsp;<span class="ident" id="6403590">encodeSize</span><span class="op" id="6403600">(</span><span class="ident" id="6403601">b</span>&nbsp;<span class="op" id="6403603">[</span><span class="op" id="6403604">]</span><span class="builtintype" id="6403605">byte</span><span class="op" id="6403609">,</span>&nbsp;<span class="ident" id="6403611">size</span>&nbsp;<span class="builtintype" id="6403616">uint32</span><span class="op" id="6403622">)</span>&nbsp;<span class="builtintype" id="6403624">int</span>&nbsp;<span class="op" id="6403628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403631">if</span>&nbsp;<span class="ident" id="6403634">size</span>&nbsp;<span class="op" id="6403639">&gt;</span>&nbsp;<span class="num" id="6403641">127</span>&nbsp;<span class="op" id="6403645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403649">size</span>&nbsp;<span class="op" id="6403654">|=</span>&nbsp;<span class="num" id="6403657">1</span>&nbsp;<span class="op" id="6403659">&lt;&lt;</span>&nbsp;<span class="num" id="6403662">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403667">binary</span><span class="op" id="6403673">.</span><span class="ident" id="6403674">BigEndian</span><span class="op" id="6403683">.</span><span class="ident" id="6403684">PutUint32</span><span class="op" id="6403693">(</span><span class="ident" id="6403694">b</span><span class="op" id="6403695">,</span>&nbsp;<span class="ident" id="6403697">size</span><span class="op" id="6403701">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403705">return</span>&nbsp;<span class="num" id="6403712">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403718">b</span><span class="op" id="6403719">[</span><span class="num" id="6403720">0</span><span class="op" id="6403721">]</span>&nbsp;<span class="op" id="6403723">=</span>&nbsp;<span class="builtintype" id="6403725">byte</span><span class="op" id="6403729">(</span><span class="ident" id="6403730">size</span><span class="op" id="6403734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403737">return</span>&nbsp;<span class="num" id="6403744">1</span><br>
<span class="lineno"></span><span class="op" id="6403746">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="6403749">//&nbsp;bufWriter&nbsp;encapsulates&nbsp;bufio.Writer&nbsp;but&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;stream&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6403831">//&nbsp;Closed.</span><br>
<span class="lineno"></span><span class="keyword" id="6403842">type</span>&nbsp;<span class="ident" id="6403847">bufWriter</span>&nbsp;<span class="keyword" id="6403857">struct</span>&nbsp;<span class="op" id="6403864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403867">closer</span>&nbsp;<span class="ident" id="6403874">io</span><span class="op" id="6403876">.</span><span class="ident" id="6403877">Closer</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403885">*</span><span class="ident" id="6403886">bufio</span><span class="op" id="6403891">.</span><span class="ident" id="6403892">Writer</span><br>
<span class="lineno"></span><span class="op" id="6403899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6403902">func</span>&nbsp;<span class="op" id="6403907">(</span><span class="ident" id="6403908">w</span>&nbsp;<span class="op" id="6403910">*</span><span class="ident" id="6403911">bufWriter</span><span class="op" id="6403920">)</span>&nbsp;<span class="ident" id="6403922">Close</span><span class="op" id="6403927">(</span><span class="op" id="6403928">)</span>&nbsp;<span class="builtintype" id="6403930">error</span>&nbsp;<span class="op" id="6403936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403939">if</span>&nbsp;<span class="ident" id="6403942">err</span>&nbsp;<span class="op" id="6403946">:=</span>&nbsp;<span class="ident" id="6403949">w</span><span class="op" id="6403950">.</span><span class="ident" id="6403951">Writer</span><span class="op" id="6403957">.</span><span class="ident" id="6403958">Flush</span><span class="op" id="6403963">(</span><span class="op" id="6403964">)</span><span class="op" id="6403965">;</span>&nbsp;<span class="ident" id="6403967">err</span>&nbsp;<span class="op" id="6403971">!=</span>&nbsp;<span class="ident" id="6403974">nil</span>&nbsp;<span class="op" id="6403978">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403982">w</span><span class="op" id="6403983">.</span><span class="ident" id="6403984">closer</span><span class="op" id="6403990">.</span><span class="ident" id="6403991">Close</span><span class="op" id="6403996">(</span><span class="op" id="6403997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404001">return</span>&nbsp;<span class="ident" id="6404008">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6404013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404016">return</span>&nbsp;<span class="ident" id="6404023">w</span><span class="op" id="6404024">.</span><span class="ident" id="6404025">closer</span><span class="op" id="6404031">.</span><span class="ident" id="6404032">Close</span><span class="op" id="6404037">(</span><span class="op" id="6404038">)</span><br>
<span class="lineno"></span><span class="op" id="6404040">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword" id="6404043">func</span>&nbsp;<span class="ident" id="6404048">newWriter</span><span class="op" id="6404057">(</span><span class="ident" id="6404058">c</span>&nbsp;<span class="op" id="6404060">*</span><span class="ident" id="6404061">conn</span><span class="op" id="6404065">,</span>&nbsp;<span class="ident" id="6404067">recType</span>&nbsp;<span class="ident" id="6404075">recType</span><span class="op" id="6404082">,</span>&nbsp;<span class="ident" id="6404084">reqId</span>&nbsp;<span class="builtintype" id="6404090">uint16</span><span class="op" id="6404096">)</span>&nbsp;<span class="op" id="6404098">*</span><span class="ident" id="6404099">bufWriter</span>&nbsp;<span class="op" id="6404109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404112">s</span>&nbsp;<span class="op" id="6404114">:=</span>&nbsp;<span class="op" id="6404117">&amp;</span><span class="ident" id="6404118">streamWriter</span><span class="op" id="6404130">{</span><span class="ident" id="6404131">c</span><span class="op" id="6404132">:</span>&nbsp;<span class="ident" id="6404134">c</span><span class="op" id="6404135">,</span>&nbsp;<span class="ident" id="6404137">recType</span><span class="op" id="6404144">:</span>&nbsp;<span class="ident" id="6404146">recType</span><span class="op" id="6404153">,</span>&nbsp;<span class="ident" id="6404155">reqId</span><span class="op" id="6404160">:</span>&nbsp;<span class="ident" id="6404162">reqId</span><span class="op" id="6404167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404170">w</span>&nbsp;<span class="op" id="6404172">:=</span>&nbsp;<span class="ident" id="6404175">bufio</span><span class="op" id="6404180">.</span><span class="ident" id="6404181">NewWriterSize</span><span class="op" id="6404194">(</span><span class="ident" id="6404195">s</span><span class="op" id="6404196">,</span>&nbsp;<span class="ident" id="6404198">maxWrite</span><span class="op" id="6404206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404209">return</span>&nbsp;<span class="op" id="6404216">&amp;</span><span class="ident" id="6404217">bufWriter</span><span class="op" id="6404226">{</span><span class="ident" id="6404227">s</span><span class="op" id="6404228">,</span>&nbsp;<span class="ident" id="6404230">w</span><span class="op" id="6404231">}</span><br>
<span class="lineno">245</span><span class="op" id="6404233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6404236">//&nbsp;streamWriter&nbsp;abstracts&nbsp;out&nbsp;the&nbsp;separation&nbsp;of&nbsp;a&nbsp;stream&nbsp;into&nbsp;discrete&nbsp;records.</span><br>
<span class="lineno"></span><span class="comment" id="6404316">//&nbsp;It&nbsp;only&nbsp;writes&nbsp;maxWrite&nbsp;bytes&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="6404360">type</span>&nbsp;<span class="ident" id="6404365">streamWriter</span>&nbsp;<span class="keyword" id="6404378">struct</span>&nbsp;<span class="op" id="6404385">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404388">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6404396">*</span><span class="ident" id="6404397">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404403">recType</span>&nbsp;<span class="ident" id="6404411">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404420">reqId</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6404428">uint16</span><br>
<span class="lineno"></span><span class="op" id="6404435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="6404438">func</span>&nbsp;<span class="op" id="6404443">(</span><span class="ident" id="6404444">w</span>&nbsp;<span class="op" id="6404446">*</span><span class="ident" id="6404447">streamWriter</span><span class="op" id="6404459">)</span>&nbsp;<span class="ident" id="6404461">Write</span><span class="op" id="6404466">(</span><span class="ident" id="6404467">p</span>&nbsp;<span class="op" id="6404469">[</span><span class="op" id="6404470">]</span><span class="builtintype" id="6404471">byte</span><span class="op" id="6404475">)</span>&nbsp;<span class="op" id="6404477">(</span><span class="builtintype" id="6404478">int</span><span class="op" id="6404481">,</span>&nbsp;<span class="builtintype" id="6404483">error</span><span class="op" id="6404488">)</span>&nbsp;<span class="op" id="6404490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404493">nn</span>&nbsp;<span class="op" id="6404496">:=</span>&nbsp;<span class="num" id="6404499">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404502">for</span>&nbsp;<span class="builtinfunc" id="6404506">len</span><span class="op" id="6404509">(</span><span class="ident" id="6404510">p</span><span class="op" id="6404511">)</span>&nbsp;<span class="op" id="6404513">&gt;</span>&nbsp;<span class="num" id="6404515">0</span>&nbsp;<span class="op" id="6404517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404521">n</span>&nbsp;<span class="op" id="6404523">:=</span>&nbsp;<span class="builtinfunc" id="6404526">len</span><span class="op" id="6404529">(</span><span class="ident" id="6404530">p</span><span class="op" id="6404531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404535">if</span>&nbsp;<span class="ident" id="6404538">n</span>&nbsp;<span class="op" id="6404540">&gt;</span>&nbsp;<span class="ident" id="6404542">maxWrite</span>&nbsp;<span class="op" id="6404551">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404556">n</span>&nbsp;<span class="op" id="6404558">=</span>&nbsp;<span class="ident" id="6404560">maxWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6404571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404575">if</span>&nbsp;<span class="ident" id="6404578">err</span>&nbsp;<span class="op" id="6404582">:=</span>&nbsp;<span class="ident" id="6404585">w</span><span class="op" id="6404586">.</span><span class="ident" id="6404587">c</span><span class="op" id="6404588">.</span><span class="ident" id="6404589">writeRecord</span><span class="op" id="6404600">(</span><span class="ident" id="6404601">w</span><span class="op" id="6404602">.</span><span class="ident" id="6404603">recType</span><span class="op" id="6404610">,</span>&nbsp;<span class="ident" id="6404612">w</span><span class="op" id="6404613">.</span><span class="ident" id="6404614">reqId</span><span class="op" id="6404619">,</span>&nbsp;<span class="ident" id="6404621">p</span><span class="op" id="6404622">[</span><span class="op" id="6404623">:</span><span class="ident" id="6404624">n</span><span class="op" id="6404625">]</span><span class="op" id="6404626">)</span><span class="op" id="6404627">;</span>&nbsp;<span class="ident" id="6404629">err</span>&nbsp;<span class="op" id="6404633">!=</span>&nbsp;<span class="ident" id="6404636">nil</span>&nbsp;<span class="op" id="6404640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404645">return</span>&nbsp;<span class="ident" id="6404652">nn</span><span class="op" id="6404654">,</span>&nbsp;<span class="ident" id="6404656">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6404662">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404666">nn</span>&nbsp;<span class="op" id="6404669">+=</span>&nbsp;<span class="ident" id="6404672">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404676">p</span>&nbsp;<span class="op" id="6404678">=</span>&nbsp;<span class="ident" id="6404680">p</span><span class="op" id="6404681">[</span><span class="ident" id="6404682">n</span><span class="op" id="6404683">:</span><span class="op" id="6404684">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6404687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404690">return</span>&nbsp;<span class="ident" id="6404697">nn</span><span class="op" id="6404699">,</span>&nbsp;<span class="ident" id="6404701">nil</span><br>
<span class="lineno"></span><span class="op" id="6404705">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="6404708">func</span>&nbsp;<span class="op" id="6404713">(</span><span class="ident" id="6404714">w</span>&nbsp;<span class="op" id="6404716">*</span><span class="ident" id="6404717">streamWriter</span><span class="op" id="6404729">)</span>&nbsp;<span class="ident" id="6404731">Close</span><span class="op" id="6404736">(</span><span class="op" id="6404737">)</span>&nbsp;<span class="builtintype" id="6404739">error</span>&nbsp;<span class="op" id="6404745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6404748">//&nbsp;send&nbsp;empty&nbsp;record&nbsp;to&nbsp;close&nbsp;the&nbsp;stream</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404790">return</span>&nbsp;<span class="ident" id="6404797">w</span><span class="op" id="6404798">.</span><span class="ident" id="6404799">c</span><span class="op" id="6404800">.</span><span class="ident" id="6404801">writeRecord</span><span class="op" id="6404812">(</span><span class="ident" id="6404813">w</span><span class="op" id="6404814">.</span><span class="ident" id="6404815">recType</span><span class="op" id="6404822">,</span>&nbsp;<span class="ident" id="6404824">w</span><span class="op" id="6404825">.</span><span class="ident" id="6404826">reqId</span><span class="op" id="6404831">,</span>&nbsp;<span class="ident" id="6404833">nil</span><span class="op" id="6404836">)</span><br>
<span class="lineno"></span><span class="op" id="6404838">}</span>
</div>
</body>
</html>
