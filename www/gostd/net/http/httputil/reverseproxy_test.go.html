<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7190764">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7190819">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7190873">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7190924">//&nbsp;Reverse&nbsp;proxy&nbsp;tests.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7190949">package</span>&nbsp;<span class="ident" id="7190957">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7190967">import</span>&nbsp;<span class="op" id="7190974">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7190977">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7190990">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7191002">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7191023">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7191034">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7191045">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7191056">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7191063">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7191066">const</span>&nbsp;<span class="ident" id="7191072">fakeHopHeader</span>&nbsp;<span class="op" id="7191086">=</span>&nbsp;<span class="string" id="7191088">&#34;X-Fake-Hop-Header-For-Test&#34;</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7191118">func</span>&nbsp;<span class="ident" id="7191123">init</span><span class="op" id="7191127">(</span><span class="op" id="7191128">)</span>&nbsp;<span class="op" id="7191130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7191133">hopHeaders</span>&nbsp;<span class="op" id="7191144">=</span>&nbsp;<span class="builtinfunc" id="7191146">append</span><span class="op" id="7191152">(</span><span class="ident" id="7191153">hopHeaders</span><span class="op" id="7191163">,</span>&nbsp;<span class="ident" id="7191165">fakeHopHeader</span><span class="op" id="7191178">)</span><br>
<span class="lineno"></span><span class="op" id="7191180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="7191183">func</span>&nbsp;<span class="ident" id="7191188">TestReverseProxy</span><span class="op" id="7191204">(</span><span class="ident" id="7191205">t</span>&nbsp;<span class="op" id="7191207">*</span><span class="ident" id="7191208">testing</span><span class="op" id="7191215">.</span><span class="ident" id="7191216">T</span><span class="op" id="7191217">)</span>&nbsp;<span class="op" id="7191219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7191222">const</span>&nbsp;<span class="ident" id="7191228">backendResponse</span>&nbsp;<span class="op" id="7191244">=</span>&nbsp;<span class="string" id="7191246">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7191266">const</span>&nbsp;<span class="ident" id="7191272">backendStatus</span>&nbsp;<span class="op" id="7191286">=</span>&nbsp;<span class="num" id="7191288">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7191293">backend</span>&nbsp;<span class="op" id="7191301">:=</span>&nbsp;<span class="ident" id="7191304">httptest</span><span class="op" id="7191312">.</span><span class="ident" id="7191313">NewServer</span><span class="op" id="7191322">(</span><span class="ident" id="7191323">http</span><span class="op" id="7191327">.</span><span class="ident" id="7191328">HandlerFunc</span><span class="op" id="7191339">(</span><span class="keyword" id="7191340">func</span><span class="op" id="7191344">(</span><span class="ident" id="7191345">w</span>&nbsp;<span class="ident" id="7191347">http</span><span class="op" id="7191351">.</span><span class="ident" id="7191352">ResponseWriter</span><span class="op" id="7191366">,</span>&nbsp;<span class="ident" id="7191368">r</span>&nbsp;<span class="op" id="7191370">*</span><span class="ident" id="7191371">http</span><span class="op" id="7191375">.</span><span class="ident" id="7191376">Request</span><span class="op" id="7191383">)</span>&nbsp;<span class="op" id="7191385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7191389">if</span>&nbsp;<span class="builtinfunc" id="7191392">len</span><span class="op" id="7191395">(</span><span class="ident" id="7191396">r</span><span class="op" id="7191397">.</span><span class="ident" id="7191398">TransferEncoding</span><span class="op" id="7191414">)</span>&nbsp;<span class="op" id="7191416">&gt;</span>&nbsp;<span class="num" id="7191418">0</span>&nbsp;<span class="op" id="7191420">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7191425">t</span><span class="op" id="7191426">.</span><span class="ident" id="7191427">Errorf</span><span class="op" id="7191433">(</span><span class="string" id="7191434">&#34;backend&nbsp;got&nbsp;unexpected&nbsp;TransferEncoding:&nbsp;%v&#34;</span><span class="op" id="7191479">,</span>&nbsp;<span class="ident" id="7191481">r</span><span class="op" id="7191482">.</span><span class="ident" id="7191483">TransferEncoding</span><span class="op" id="7191499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7191503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7191507">if</span>&nbsp;<span class="ident" id="7191510">r</span><span class="op" id="7191511">.</span><span class="ident" id="7191512">Header</span><span class="op" id="7191518">.</span><span class="ident" id="7191519">Get</span><span class="op" id="7191522">(</span><span class="string" id="7191523">&#34;X-Forwarded-For&#34;</span><span class="op" id="7191540">)</span>&nbsp;<span class="op" id="7191542">==</span>&nbsp;<span class="string" id="7191545">&#34;&#34;</span>&nbsp;<span class="op" id="7191548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7191553">t</span><span class="op" id="7191554">.</span><span class="ident" id="7191555">Errorf</span><span class="op" id="7191561">(</span><span class="string" id="7191562">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7191597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7191601">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7191605">if</span>&nbsp;<span class="ident" id="7191608">c</span>&nbsp;<span class="op" id="7191610">:=</span>&nbsp;<span class="ident" id="7191613">r</span><span class="op" id="7191614">.</span><span class="ident" id="7191615">Header</span><span class="op" id="7191621">.</span><span class="ident" id="7191622">Get</span><span class="op" id="7191625">(</span><span class="string" id="7191626">&#34;Connection&#34;</span><span class="op" id="7191638">)</span><span class="op" id="7191639">;</span>&nbsp;<span class="ident" id="7191641">c</span>&nbsp;<span class="op" id="7191643">!=</span>&nbsp;<span class="string" id="7191646">&#34;&#34;</span>&nbsp;<span class="op" id="7191649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7191654">t</span><span class="op" id="7191655">.</span><span class="ident" id="7191656">Errorf</span><span class="op" id="7191662">(</span><span class="string" id="7191663">&#34;handler&nbsp;got&nbsp;Connection&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7191703">,</span>&nbsp;<span class="ident" id="7191705">c</span><span class="op" id="7191706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7191710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7191714">if</span>&nbsp;<span class="ident" id="7191717">c</span>&nbsp;<span class="op" id="7191719">:=</span>&nbsp;<span class="ident" id="7191722">r</span><span class="op" id="7191723">.</span><span class="ident" id="7191724">Header</span><span class="op" id="7191730">.</span><span class="ident" id="7191731">Get</span><span class="op" id="7191734">(</span><span class="string" id="7191735">&#34;Upgrade&#34;</span><span class="op" id="7191744">)</span><span class="op" id="7191745">;</span>&nbsp;<span class="ident" id="7191747">c</span>&nbsp;<span class="op" id="7191749">!=</span>&nbsp;<span class="string" id="7191752">&#34;&#34;</span>&nbsp;<span class="op" id="7191755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7191760">t</span><span class="op" id="7191761">.</span><span class="ident" id="7191762">Errorf</span><span class="op" id="7191768">(</span><span class="string" id="7191769">&#34;handler&nbsp;got&nbsp;Upgrade&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7191806">,</span>&nbsp;<span class="ident" id="7191808">c</span><span class="op" id="7191809">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7191813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7191817">if</span>&nbsp;<span class="ident" id="7191820">g</span><span class="op" id="7191821">,</span>&nbsp;<span class="ident" id="7191823">e</span>&nbsp;<span class="op" id="7191825">:=</span>&nbsp;<span class="ident" id="7191828">r</span><span class="op" id="7191829">.</span><span class="ident" id="7191830">Host</span><span class="op" id="7191834">,</span>&nbsp;<span class="string" id="7191836">&#34;some-name&#34;</span><span class="op" id="7191847">;</span>&nbsp;<span class="ident" id="7191849">g</span>&nbsp;<span class="op" id="7191851">!=</span>&nbsp;<span class="ident" id="7191854">e</span>&nbsp;<span class="op" id="7191856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7191861">t</span><span class="op" id="7191862">.</span><span class="ident" id="7191863">Errorf</span><span class="op" id="7191869">(</span><span class="string" id="7191870">&#34;backend&nbsp;got&nbsp;Host&nbsp;header&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7191907">,</span>&nbsp;<span class="ident" id="7191909">g</span><span class="op" id="7191910">,</span>&nbsp;<span class="ident" id="7191912">e</span><span class="op" id="7191913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7191917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7191921">w</span><span class="op" id="7191922">.</span><span class="ident" id="7191923">Header</span><span class="op" id="7191929">(</span><span class="op" id="7191930">)</span><span class="op" id="7191931">.</span><span class="ident" id="7191932">Set</span><span class="op" id="7191935">(</span><span class="string" id="7191936">&#34;X-Foo&#34;</span><span class="op" id="7191943">,</span>&nbsp;<span class="string" id="7191945">&#34;bar&#34;</span><span class="op" id="7191950">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7191954">w</span><span class="op" id="7191955">.</span><span class="ident" id="7191956">Header</span><span class="op" id="7191962">(</span><span class="op" id="7191963">)</span><span class="op" id="7191964">.</span><span class="ident" id="7191965">Set</span><span class="op" id="7191968">(</span><span class="string" id="7191969">&#34;Upgrade&#34;</span><span class="op" id="7191978">,</span>&nbsp;<span class="string" id="7191980">&#34;foo&#34;</span><span class="op" id="7191985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7191989">w</span><span class="op" id="7191990">.</span><span class="ident" id="7191991">Header</span><span class="op" id="7191997">(</span><span class="op" id="7191998">)</span><span class="op" id="7191999">.</span><span class="ident" id="7192000">Set</span><span class="op" id="7192003">(</span><span class="ident" id="7192004">fakeHopHeader</span><span class="op" id="7192017">,</span>&nbsp;<span class="string" id="7192019">&#34;foo&#34;</span><span class="op" id="7192024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192028">w</span><span class="op" id="7192029">.</span><span class="ident" id="7192030">Header</span><span class="op" id="7192036">(</span><span class="op" id="7192037">)</span><span class="op" id="7192038">.</span><span class="ident" id="7192039">Add</span><span class="op" id="7192042">(</span><span class="string" id="7192043">&#34;X-Multi-Value&#34;</span><span class="op" id="7192058">,</span>&nbsp;<span class="string" id="7192060">&#34;foo&#34;</span><span class="op" id="7192065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192069">w</span><span class="op" id="7192070">.</span><span class="ident" id="7192071">Header</span><span class="op" id="7192077">(</span><span class="op" id="7192078">)</span><span class="op" id="7192079">.</span><span class="ident" id="7192080">Add</span><span class="op" id="7192083">(</span><span class="string" id="7192084">&#34;X-Multi-Value&#34;</span><span class="op" id="7192099">,</span>&nbsp;<span class="string" id="7192101">&#34;bar&#34;</span><span class="op" id="7192106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192110">http</span><span class="op" id="7192114">.</span><span class="ident" id="7192115">SetCookie</span><span class="op" id="7192124">(</span><span class="ident" id="7192125">w</span><span class="op" id="7192126">,</span>&nbsp;<span class="op" id="7192128">&amp;</span><span class="ident" id="7192129">http</span><span class="op" id="7192133">.</span><span class="ident" id="7192134">Cookie</span><span class="op" id="7192140">{</span><span class="ident" id="7192141">Name</span><span class="op" id="7192145">:</span>&nbsp;<span class="string" id="7192147">&#34;flavor&#34;</span><span class="op" id="7192155">,</span>&nbsp;<span class="ident" id="7192157">Value</span><span class="op" id="7192162">:</span>&nbsp;<span class="string" id="7192164">&#34;chocolateChip&#34;</span><span class="op" id="7192179">}</span><span class="op" id="7192180">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192184">w</span><span class="op" id="7192185">.</span><span class="ident" id="7192186">WriteHeader</span><span class="op" id="7192197">(</span><span class="ident" id="7192198">backendStatus</span><span class="op" id="7192211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192215">w</span><span class="op" id="7192216">.</span><span class="ident" id="7192217">Write</span><span class="op" id="7192222">(</span><span class="op" id="7192223">[</span><span class="op" id="7192224">]</span><span class="builtintype" id="7192225">byte</span><span class="op" id="7192229">(</span><span class="ident" id="7192230">backendResponse</span><span class="op" id="7192245">)</span><span class="op" id="7192246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7192249">}</span><span class="op" id="7192250">)</span><span class="op" id="7192251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7192254">defer</span>&nbsp;<span class="ident" id="7192260">backend</span><span class="op" id="7192267">.</span><span class="ident" id="7192268">Close</span><span class="op" id="7192273">(</span><span class="op" id="7192274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192277">backendURL</span><span class="op" id="7192287">,</span>&nbsp;<span class="ident" id="7192289">err</span>&nbsp;<span class="op" id="7192293">:=</span>&nbsp;<span class="ident" id="7192296">url</span><span class="op" id="7192299">.</span><span class="ident" id="7192300">Parse</span><span class="op" id="7192305">(</span><span class="ident" id="7192306">backend</span><span class="op" id="7192313">.</span><span class="ident" id="7192314">URL</span><span class="op" id="7192317">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7192320">if</span>&nbsp;<span class="ident" id="7192323">err</span>&nbsp;<span class="op" id="7192327">!=</span>&nbsp;<span class="ident" id="7192330">nil</span>&nbsp;<span class="op" id="7192334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192338">t</span><span class="op" id="7192339">.</span><span class="ident" id="7192340">Fatal</span><span class="op" id="7192345">(</span><span class="ident" id="7192346">err</span><span class="op" id="7192349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7192352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192355">proxyHandler</span>&nbsp;<span class="op" id="7192368">:=</span>&nbsp;<span class="ident" id="7192371">NewSingleHostReverseProxy</span><span class="op" id="7192396">(</span><span class="ident" id="7192397">backendURL</span><span class="op" id="7192407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192410">frontend</span>&nbsp;<span class="op" id="7192419">:=</span>&nbsp;<span class="ident" id="7192422">httptest</span><span class="op" id="7192430">.</span><span class="ident" id="7192431">NewServer</span><span class="op" id="7192440">(</span><span class="ident" id="7192441">proxyHandler</span><span class="op" id="7192453">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7192456">defer</span>&nbsp;<span class="ident" id="7192462">frontend</span><span class="op" id="7192470">.</span><span class="ident" id="7192471">Close</span><span class="op" id="7192476">(</span><span class="op" id="7192477">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192481">getReq</span><span class="op" id="7192487">,</span>&nbsp;<span class="ident" id="7192489">_</span>&nbsp;<span class="op" id="7192491">:=</span>&nbsp;<span class="ident" id="7192494">http</span><span class="op" id="7192498">.</span><span class="ident" id="7192499">NewRequest</span><span class="op" id="7192509">(</span><span class="string" id="7192510">&#34;GET&#34;</span><span class="op" id="7192515">,</span>&nbsp;<span class="ident" id="7192517">frontend</span><span class="op" id="7192525">.</span><span class="ident" id="7192526">URL</span><span class="op" id="7192529">,</span>&nbsp;<span class="ident" id="7192531">nil</span><span class="op" id="7192534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192537">getReq</span><span class="op" id="7192543">.</span><span class="ident" id="7192544">Host</span>&nbsp;<span class="op" id="7192549">=</span>&nbsp;<span class="string" id="7192551">&#34;some-name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192564">getReq</span><span class="op" id="7192570">.</span><span class="ident" id="7192571">Header</span><span class="op" id="7192577">.</span><span class="ident" id="7192578">Set</span><span class="op" id="7192581">(</span><span class="string" id="7192582">&#34;Connection&#34;</span><span class="op" id="7192594">,</span>&nbsp;<span class="string" id="7192596">&#34;close&#34;</span><span class="op" id="7192603">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192606">getReq</span><span class="op" id="7192612">.</span><span class="ident" id="7192613">Header</span><span class="op" id="7192619">.</span><span class="ident" id="7192620">Set</span><span class="op" id="7192623">(</span><span class="string" id="7192624">&#34;Upgrade&#34;</span><span class="op" id="7192633">,</span>&nbsp;<span class="string" id="7192635">&#34;foo&#34;</span><span class="op" id="7192640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192643">getReq</span><span class="op" id="7192649">.</span><span class="ident" id="7192650">Close</span>&nbsp;<span class="op" id="7192656">=</span>&nbsp;<span class="builtintype" id="7192658">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192664">res</span><span class="op" id="7192667">,</span>&nbsp;<span class="ident" id="7192669">err</span>&nbsp;<span class="op" id="7192673">:=</span>&nbsp;<span class="ident" id="7192676">http</span><span class="op" id="7192680">.</span><span class="ident" id="7192681">DefaultClient</span><span class="op" id="7192694">.</span><span class="ident" id="7192695">Do</span><span class="op" id="7192697">(</span><span class="ident" id="7192698">getReq</span><span class="op" id="7192704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7192707">if</span>&nbsp;<span class="ident" id="7192710">err</span>&nbsp;<span class="op" id="7192714">!=</span>&nbsp;<span class="ident" id="7192717">nil</span>&nbsp;<span class="op" id="7192721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192725">t</span><span class="op" id="7192726">.</span><span class="ident" id="7192727">Fatalf</span><span class="op" id="7192733">(</span><span class="string" id="7192734">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7192743">,</span>&nbsp;<span class="ident" id="7192745">err</span><span class="op" id="7192748">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7192751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7192754">if</span>&nbsp;<span class="ident" id="7192757">g</span><span class="op" id="7192758">,</span>&nbsp;<span class="ident" id="7192760">e</span>&nbsp;<span class="op" id="7192762">:=</span>&nbsp;<span class="ident" id="7192765">res</span><span class="op" id="7192768">.</span><span class="ident" id="7192769">StatusCode</span><span class="op" id="7192779">,</span>&nbsp;<span class="ident" id="7192781">backendStatus</span><span class="op" id="7192794">;</span>&nbsp;<span class="ident" id="7192796">g</span>&nbsp;<span class="op" id="7192798">!=</span>&nbsp;<span class="ident" id="7192801">e</span>&nbsp;<span class="op" id="7192803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192807">t</span><span class="op" id="7192808">.</span><span class="ident" id="7192809">Errorf</span><span class="op" id="7192815">(</span><span class="string" id="7192816">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7192852">,</span>&nbsp;<span class="ident" id="7192854">g</span><span class="op" id="7192855">,</span>&nbsp;<span class="ident" id="7192857">e</span><span class="op" id="7192858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7192861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7192864">if</span>&nbsp;<span class="ident" id="7192867">g</span><span class="op" id="7192868">,</span>&nbsp;<span class="ident" id="7192870">e</span>&nbsp;<span class="op" id="7192872">:=</span>&nbsp;<span class="ident" id="7192875">res</span><span class="op" id="7192878">.</span><span class="ident" id="7192879">Header</span><span class="op" id="7192885">.</span><span class="ident" id="7192886">Get</span><span class="op" id="7192889">(</span><span class="string" id="7192890">&#34;X-Foo&#34;</span><span class="op" id="7192897">)</span><span class="op" id="7192898">,</span>&nbsp;<span class="string" id="7192900">&#34;bar&#34;</span><span class="op" id="7192905">;</span>&nbsp;<span class="ident" id="7192907">g</span>&nbsp;<span class="op" id="7192909">!=</span>&nbsp;<span class="ident" id="7192912">e</span>&nbsp;<span class="op" id="7192914">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7192918">t</span><span class="op" id="7192919">.</span><span class="ident" id="7192920">Errorf</span><span class="op" id="7192926">(</span><span class="string" id="7192927">&#34;got&nbsp;X-Foo&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7192954">,</span>&nbsp;<span class="ident" id="7192956">g</span><span class="op" id="7192957">,</span>&nbsp;<span class="ident" id="7192959">e</span><span class="op" id="7192960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7192963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7192966">if</span>&nbsp;<span class="ident" id="7192969">c</span>&nbsp;<span class="op" id="7192971">:=</span>&nbsp;<span class="ident" id="7192974">res</span><span class="op" id="7192977">.</span><span class="ident" id="7192978">Header</span><span class="op" id="7192984">.</span><span class="ident" id="7192985">Get</span><span class="op" id="7192988">(</span><span class="ident" id="7192989">fakeHopHeader</span><span class="op" id="7193002">)</span><span class="op" id="7193003">;</span>&nbsp;<span class="ident" id="7193005">c</span>&nbsp;<span class="op" id="7193007">!=</span>&nbsp;<span class="string" id="7193010">&#34;&#34;</span>&nbsp;<span class="op" id="7193013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7193017">t</span><span class="op" id="7193018">.</span><span class="ident" id="7193019">Errorf</span><span class="op" id="7193025">(</span><span class="string" id="7193026">&#34;got&nbsp;%s&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7193050">,</span>&nbsp;<span class="ident" id="7193052">fakeHopHeader</span><span class="op" id="7193065">,</span>&nbsp;<span class="ident" id="7193067">c</span><span class="op" id="7193068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7193071">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7193074">if</span>&nbsp;<span class="ident" id="7193077">g</span><span class="op" id="7193078">,</span>&nbsp;<span class="ident" id="7193080">e</span>&nbsp;<span class="op" id="7193082">:=</span>&nbsp;<span class="builtinfunc" id="7193085">len</span><span class="op" id="7193088">(</span><span class="ident" id="7193089">res</span><span class="op" id="7193092">.</span><span class="ident" id="7193093">Header</span><span class="op" id="7193099">[</span><span class="string" id="7193100">&#34;X-Multi-Value&#34;</span><span class="op" id="7193115">]</span><span class="op" id="7193116">)</span><span class="op" id="7193117">,</span>&nbsp;<span class="num" id="7193119">2</span><span class="op" id="7193120">;</span>&nbsp;<span class="ident" id="7193122">g</span>&nbsp;<span class="op" id="7193124">!=</span>&nbsp;<span class="ident" id="7193127">e</span>&nbsp;<span class="op" id="7193129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7193133">t</span><span class="op" id="7193134">.</span><span class="ident" id="7193135">Errorf</span><span class="op" id="7193141">(</span><span class="string" id="7193142">&#34;got&nbsp;%d&nbsp;X-Multi-Value&nbsp;header&nbsp;values;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7193191">,</span>&nbsp;<span class="ident" id="7193193">g</span><span class="op" id="7193194">,</span>&nbsp;<span class="ident" id="7193196">e</span><span class="op" id="7193197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7193200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7193203">if</span>&nbsp;<span class="ident" id="7193206">g</span><span class="op" id="7193207">,</span>&nbsp;<span class="ident" id="7193209">e</span>&nbsp;<span class="op" id="7193211">:=</span>&nbsp;<span class="builtinfunc" id="7193214">len</span><span class="op" id="7193217">(</span><span class="ident" id="7193218">res</span><span class="op" id="7193221">.</span><span class="ident" id="7193222">Header</span><span class="op" id="7193228">[</span><span class="string" id="7193229">&#34;Set-Cookie&#34;</span><span class="op" id="7193241">]</span><span class="op" id="7193242">)</span><span class="op" id="7193243">,</span>&nbsp;<span class="num" id="7193245">1</span><span class="op" id="7193246">;</span>&nbsp;<span class="ident" id="7193248">g</span>&nbsp;<span class="op" id="7193250">!=</span>&nbsp;<span class="ident" id="7193253">e</span>&nbsp;<span class="op" id="7193255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7193259">t</span><span class="op" id="7193260">.</span><span class="ident" id="7193261">Fatalf</span><span class="op" id="7193267">(</span><span class="string" id="7193268">&#34;got&nbsp;%d&nbsp;SetCookies,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7193296">,</span>&nbsp;<span class="ident" id="7193298">g</span><span class="op" id="7193299">,</span>&nbsp;<span class="ident" id="7193301">e</span><span class="op" id="7193302">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7193305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7193308">if</span>&nbsp;<span class="ident" id="7193311">cookie</span>&nbsp;<span class="op" id="7193318">:=</span>&nbsp;<span class="ident" id="7193321">res</span><span class="op" id="7193324">.</span><span class="ident" id="7193325">Cookies</span><span class="op" id="7193332">(</span><span class="op" id="7193333">)</span><span class="op" id="7193334">[</span><span class="num" id="7193335">0</span><span class="op" id="7193336">]</span><span class="op" id="7193337">;</span>&nbsp;<span class="ident" id="7193339">cookie</span><span class="op" id="7193345">.</span><span class="ident" id="7193346">Name</span>&nbsp;<span class="op" id="7193351">!=</span>&nbsp;<span class="string" id="7193354">&#34;flavor&#34;</span>&nbsp;<span class="op" id="7193363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7193367">t</span><span class="op" id="7193368">.</span><span class="ident" id="7193369">Errorf</span><span class="op" id="7193375">(</span><span class="string" id="7193376">&#34;unexpected&nbsp;cookie&nbsp;%q&#34;</span><span class="op" id="7193398">,</span>&nbsp;<span class="ident" id="7193400">cookie</span><span class="op" id="7193406">.</span><span class="ident" id="7193407">Name</span><span class="op" id="7193411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7193414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7193417">bodyBytes</span><span class="op" id="7193426">,</span>&nbsp;<span class="ident" id="7193428">_</span>&nbsp;<span class="op" id="7193430">:=</span>&nbsp;<span class="ident" id="7193433">ioutil</span><span class="op" id="7193439">.</span><span class="ident" id="7193440">ReadAll</span><span class="op" id="7193447">(</span><span class="ident" id="7193448">res</span><span class="op" id="7193451">.</span><span class="ident" id="7193452">Body</span><span class="op" id="7193456">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7193459">if</span>&nbsp;<span class="ident" id="7193462">g</span><span class="op" id="7193463">,</span>&nbsp;<span class="ident" id="7193465">e</span>&nbsp;<span class="op" id="7193467">:=</span>&nbsp;<span class="builtintype" id="7193470">string</span><span class="op" id="7193476">(</span><span class="ident" id="7193477">bodyBytes</span><span class="op" id="7193486">)</span><span class="op" id="7193487">,</span>&nbsp;<span class="ident" id="7193489">backendResponse</span><span class="op" id="7193504">;</span>&nbsp;<span class="ident" id="7193506">g</span>&nbsp;<span class="op" id="7193508">!=</span>&nbsp;<span class="ident" id="7193511">e</span>&nbsp;<span class="op" id="7193513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7193517">t</span><span class="op" id="7193518">.</span><span class="ident" id="7193519">Errorf</span><span class="op" id="7193525">(</span><span class="string" id="7193526">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7193552">,</span>&nbsp;<span class="ident" id="7193554">g</span><span class="op" id="7193555">,</span>&nbsp;<span class="ident" id="7193557">e</span><span class="op" id="7193558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7193561">}</span><br>
<span class="lineno"></span><span class="op" id="7193563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7193566">func</span>&nbsp;<span class="ident" id="7193571">TestXForwardedFor</span><span class="op" id="7193588">(</span><span class="ident" id="7193589">t</span>&nbsp;<span class="op" id="7193591">*</span><span class="ident" id="7193592">testing</span><span class="op" id="7193599">.</span><span class="ident" id="7193600">T</span><span class="op" id="7193601">)</span>&nbsp;<span class="op" id="7193603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7193606">const</span>&nbsp;<span class="ident" id="7193612">prevForwardedFor</span>&nbsp;<span class="op" id="7193629">=</span>&nbsp;<span class="string" id="7193631">&#34;client&nbsp;ip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7193644">const</span>&nbsp;<span class="ident" id="7193650">backendResponse</span>&nbsp;<span class="op" id="7193666">=</span>&nbsp;<span class="string" id="7193668">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7193688">const</span>&nbsp;<span class="ident" id="7193694">backendStatus</span>&nbsp;<span class="op" id="7193708">=</span>&nbsp;<span class="num" id="7193710">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7193715">backend</span>&nbsp;<span class="op" id="7193723">:=</span>&nbsp;<span class="ident" id="7193726">httptest</span><span class="op" id="7193734">.</span><span class="ident" id="7193735">NewServer</span><span class="op" id="7193744">(</span><span class="ident" id="7193745">http</span><span class="op" id="7193749">.</span><span class="ident" id="7193750">HandlerFunc</span><span class="op" id="7193761">(</span><span class="keyword" id="7193762">func</span><span class="op" id="7193766">(</span><span class="ident" id="7193767">w</span>&nbsp;<span class="ident" id="7193769">http</span><span class="op" id="7193773">.</span><span class="ident" id="7193774">ResponseWriter</span><span class="op" id="7193788">,</span>&nbsp;<span class="ident" id="7193790">r</span>&nbsp;<span class="op" id="7193792">*</span><span class="ident" id="7193793">http</span><span class="op" id="7193797">.</span><span class="ident" id="7193798">Request</span><span class="op" id="7193805">)</span>&nbsp;<span class="op" id="7193807">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7193811">if</span>&nbsp;<span class="ident" id="7193814">r</span><span class="op" id="7193815">.</span><span class="ident" id="7193816">Header</span><span class="op" id="7193822">.</span><span class="ident" id="7193823">Get</span><span class="op" id="7193826">(</span><span class="string" id="7193827">&#34;X-Forwarded-For&#34;</span><span class="op" id="7193844">)</span>&nbsp;<span class="op" id="7193846">==</span>&nbsp;<span class="string" id="7193849">&#34;&#34;</span>&nbsp;<span class="op" id="7193852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7193857">t</span><span class="op" id="7193858">.</span><span class="ident" id="7193859">Errorf</span><span class="op" id="7193865">(</span><span class="string" id="7193866">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7193901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7193905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7193909">if</span>&nbsp;<span class="op" id="7193912">!</span><span class="ident" id="7193913">strings</span><span class="op" id="7193920">.</span><span class="ident" id="7193921">Contains</span><span class="op" id="7193929">(</span><span class="ident" id="7193930">r</span><span class="op" id="7193931">.</span><span class="ident" id="7193932">Header</span><span class="op" id="7193938">.</span><span class="ident" id="7193939">Get</span><span class="op" id="7193942">(</span><span class="string" id="7193943">&#34;X-Forwarded-For&#34;</span><span class="op" id="7193960">)</span><span class="op" id="7193961">,</span>&nbsp;<span class="ident" id="7193963">prevForwardedFor</span><span class="op" id="7193979">)</span>&nbsp;<span class="op" id="7193981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7193986">t</span><span class="op" id="7193987">.</span><span class="ident" id="7193988">Errorf</span><span class="op" id="7193994">(</span><span class="string" id="7193995">&#34;X-Forwarded-For&nbsp;didn&#39;t&nbsp;contain&nbsp;prior&nbsp;data&#34;</span><span class="op" id="7194038">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7194042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194046">w</span><span class="op" id="7194047">.</span><span class="ident" id="7194048">WriteHeader</span><span class="op" id="7194059">(</span><span class="ident" id="7194060">backendStatus</span><span class="op" id="7194073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194077">w</span><span class="op" id="7194078">.</span><span class="ident" id="7194079">Write</span><span class="op" id="7194084">(</span><span class="op" id="7194085">[</span><span class="op" id="7194086">]</span><span class="builtintype" id="7194087">byte</span><span class="op" id="7194091">(</span><span class="ident" id="7194092">backendResponse</span><span class="op" id="7194107">)</span><span class="op" id="7194108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7194111">}</span><span class="op" id="7194112">)</span><span class="op" id="7194113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7194116">defer</span>&nbsp;<span class="ident" id="7194122">backend</span><span class="op" id="7194129">.</span><span class="ident" id="7194130">Close</span><span class="op" id="7194135">(</span><span class="op" id="7194136">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194139">backendURL</span><span class="op" id="7194149">,</span>&nbsp;<span class="ident" id="7194151">err</span>&nbsp;<span class="op" id="7194155">:=</span>&nbsp;<span class="ident" id="7194158">url</span><span class="op" id="7194161">.</span><span class="ident" id="7194162">Parse</span><span class="op" id="7194167">(</span><span class="ident" id="7194168">backend</span><span class="op" id="7194175">.</span><span class="ident" id="7194176">URL</span><span class="op" id="7194179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7194182">if</span>&nbsp;<span class="ident" id="7194185">err</span>&nbsp;<span class="op" id="7194189">!=</span>&nbsp;<span class="ident" id="7194192">nil</span>&nbsp;<span class="op" id="7194196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194200">t</span><span class="op" id="7194201">.</span><span class="ident" id="7194202">Fatal</span><span class="op" id="7194207">(</span><span class="ident" id="7194208">err</span><span class="op" id="7194211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7194214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194217">proxyHandler</span>&nbsp;<span class="op" id="7194230">:=</span>&nbsp;<span class="ident" id="7194233">NewSingleHostReverseProxy</span><span class="op" id="7194258">(</span><span class="ident" id="7194259">backendURL</span><span class="op" id="7194269">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194272">frontend</span>&nbsp;<span class="op" id="7194281">:=</span>&nbsp;<span class="ident" id="7194284">httptest</span><span class="op" id="7194292">.</span><span class="ident" id="7194293">NewServer</span><span class="op" id="7194302">(</span><span class="ident" id="7194303">proxyHandler</span><span class="op" id="7194315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7194318">defer</span>&nbsp;<span class="ident" id="7194324">frontend</span><span class="op" id="7194332">.</span><span class="ident" id="7194333">Close</span><span class="op" id="7194338">(</span><span class="op" id="7194339">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194343">getReq</span><span class="op" id="7194349">,</span>&nbsp;<span class="ident" id="7194351">_</span>&nbsp;<span class="op" id="7194353">:=</span>&nbsp;<span class="ident" id="7194356">http</span><span class="op" id="7194360">.</span><span class="ident" id="7194361">NewRequest</span><span class="op" id="7194371">(</span><span class="string" id="7194372">&#34;GET&#34;</span><span class="op" id="7194377">,</span>&nbsp;<span class="ident" id="7194379">frontend</span><span class="op" id="7194387">.</span><span class="ident" id="7194388">URL</span><span class="op" id="7194391">,</span>&nbsp;<span class="ident" id="7194393">nil</span><span class="op" id="7194396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194399">getReq</span><span class="op" id="7194405">.</span><span class="ident" id="7194406">Host</span>&nbsp;<span class="op" id="7194411">=</span>&nbsp;<span class="string" id="7194413">&#34;some-name&#34;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194426">getReq</span><span class="op" id="7194432">.</span><span class="ident" id="7194433">Header</span><span class="op" id="7194439">.</span><span class="ident" id="7194440">Set</span><span class="op" id="7194443">(</span><span class="string" id="7194444">&#34;Connection&#34;</span><span class="op" id="7194456">,</span>&nbsp;<span class="string" id="7194458">&#34;close&#34;</span><span class="op" id="7194465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194468">getReq</span><span class="op" id="7194474">.</span><span class="ident" id="7194475">Header</span><span class="op" id="7194481">.</span><span class="ident" id="7194482">Set</span><span class="op" id="7194485">(</span><span class="string" id="7194486">&#34;X-Forwarded-For&#34;</span><span class="op" id="7194503">,</span>&nbsp;<span class="ident" id="7194505">prevForwardedFor</span><span class="op" id="7194521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194524">getReq</span><span class="op" id="7194530">.</span><span class="ident" id="7194531">Close</span>&nbsp;<span class="op" id="7194537">=</span>&nbsp;<span class="builtintype" id="7194539">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194545">res</span><span class="op" id="7194548">,</span>&nbsp;<span class="ident" id="7194550">err</span>&nbsp;<span class="op" id="7194554">:=</span>&nbsp;<span class="ident" id="7194557">http</span><span class="op" id="7194561">.</span><span class="ident" id="7194562">DefaultClient</span><span class="op" id="7194575">.</span><span class="ident" id="7194576">Do</span><span class="op" id="7194578">(</span><span class="ident" id="7194579">getReq</span><span class="op" id="7194585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7194588">if</span>&nbsp;<span class="ident" id="7194591">err</span>&nbsp;<span class="op" id="7194595">!=</span>&nbsp;<span class="ident" id="7194598">nil</span>&nbsp;<span class="op" id="7194602">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194606">t</span><span class="op" id="7194607">.</span><span class="ident" id="7194608">Fatalf</span><span class="op" id="7194614">(</span><span class="string" id="7194615">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7194624">,</span>&nbsp;<span class="ident" id="7194626">err</span><span class="op" id="7194629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7194632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7194635">if</span>&nbsp;<span class="ident" id="7194638">g</span><span class="op" id="7194639">,</span>&nbsp;<span class="ident" id="7194641">e</span>&nbsp;<span class="op" id="7194643">:=</span>&nbsp;<span class="ident" id="7194646">res</span><span class="op" id="7194649">.</span><span class="ident" id="7194650">StatusCode</span><span class="op" id="7194660">,</span>&nbsp;<span class="ident" id="7194662">backendStatus</span><span class="op" id="7194675">;</span>&nbsp;<span class="ident" id="7194677">g</span>&nbsp;<span class="op" id="7194679">!=</span>&nbsp;<span class="ident" id="7194682">e</span>&nbsp;<span class="op" id="7194684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194688">t</span><span class="op" id="7194689">.</span><span class="ident" id="7194690">Errorf</span><span class="op" id="7194696">(</span><span class="string" id="7194697">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7194733">,</span>&nbsp;<span class="ident" id="7194735">g</span><span class="op" id="7194736">,</span>&nbsp;<span class="ident" id="7194738">e</span><span class="op" id="7194739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7194742">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194745">bodyBytes</span><span class="op" id="7194754">,</span>&nbsp;<span class="ident" id="7194756">_</span>&nbsp;<span class="op" id="7194758">:=</span>&nbsp;<span class="ident" id="7194761">ioutil</span><span class="op" id="7194767">.</span><span class="ident" id="7194768">ReadAll</span><span class="op" id="7194775">(</span><span class="ident" id="7194776">res</span><span class="op" id="7194779">.</span><span class="ident" id="7194780">Body</span><span class="op" id="7194784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7194787">if</span>&nbsp;<span class="ident" id="7194790">g</span><span class="op" id="7194791">,</span>&nbsp;<span class="ident" id="7194793">e</span>&nbsp;<span class="op" id="7194795">:=</span>&nbsp;<span class="builtintype" id="7194798">string</span><span class="op" id="7194804">(</span><span class="ident" id="7194805">bodyBytes</span><span class="op" id="7194814">)</span><span class="op" id="7194815">,</span>&nbsp;<span class="ident" id="7194817">backendResponse</span><span class="op" id="7194832">;</span>&nbsp;<span class="ident" id="7194834">g</span>&nbsp;<span class="op" id="7194836">!=</span>&nbsp;<span class="ident" id="7194839">e</span>&nbsp;<span class="op" id="7194841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194845">t</span><span class="op" id="7194846">.</span><span class="ident" id="7194847">Errorf</span><span class="op" id="7194853">(</span><span class="string" id="7194854">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7194880">,</span>&nbsp;<span class="ident" id="7194882">g</span><span class="op" id="7194883">,</span>&nbsp;<span class="ident" id="7194885">e</span><span class="op" id="7194886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7194889">}</span><br>
<span class="lineno"></span><span class="op" id="7194891">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="7194894">var</span>&nbsp;<span class="ident" id="7194898">proxyQueryTests</span>&nbsp;<span class="op" id="7194914">=</span>&nbsp;<span class="op" id="7194916">[</span><span class="op" id="7194917">]</span><span class="keyword" id="7194918">struct</span>&nbsp;<span class="op" id="7194925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194928">baseSuffix</span>&nbsp;<span class="builtintype" id="7194939">string</span>&nbsp;<span class="comment" id="7194946">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;backend&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7194979">reqSuffix</span>&nbsp;&nbsp;<span class="builtintype" id="7194990">string</span>&nbsp;<span class="comment" id="7194997">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;frontend&#39;s&nbsp;request&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7195041">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7195052">string</span>&nbsp;<span class="comment" id="7195059">//&nbsp;what&nbsp;backend&nbsp;should&nbsp;see&nbsp;for&nbsp;final&nbsp;request&nbsp;URL&nbsp;(without&nbsp;?)</span><br>
<span class="lineno">140</span><span class="op" id="7195120">}</span><span class="op" id="7195121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7195124">{</span><span class="string" id="7195125">&#34;&#34;</span><span class="op" id="7195127">,</span>&nbsp;<span class="string" id="7195129">&#34;&#34;</span><span class="op" id="7195131">,</span>&nbsp;<span class="string" id="7195133">&#34;&#34;</span><span class="op" id="7195135">}</span><span class="op" id="7195136">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7195139">{</span><span class="string" id="7195140">&#34;?sta=tic&#34;</span><span class="op" id="7195150">,</span>&nbsp;<span class="string" id="7195152">&#34;?us=er&#34;</span><span class="op" id="7195160">,</span>&nbsp;<span class="string" id="7195162">&#34;sta=tic&amp;us=er&#34;</span><span class="op" id="7195177">}</span><span class="op" id="7195178">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7195181">{</span><span class="string" id="7195182">&#34;&#34;</span><span class="op" id="7195184">,</span>&nbsp;<span class="string" id="7195186">&#34;?us=er&#34;</span><span class="op" id="7195194">,</span>&nbsp;<span class="string" id="7195196">&#34;us=er&#34;</span><span class="op" id="7195203">}</span><span class="op" id="7195204">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7195207">{</span><span class="string" id="7195208">&#34;?sta=tic&#34;</span><span class="op" id="7195218">,</span>&nbsp;<span class="string" id="7195220">&#34;&#34;</span><span class="op" id="7195222">,</span>&nbsp;<span class="string" id="7195224">&#34;sta=tic&#34;</span><span class="op" id="7195233">}</span><span class="op" id="7195234">,</span><br>
<span class="lineno">145</span><span class="op" id="7195236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7195239">func</span>&nbsp;<span class="ident" id="7195244">TestReverseProxyQuery</span><span class="op" id="7195265">(</span><span class="ident" id="7195266">t</span>&nbsp;<span class="op" id="7195268">*</span><span class="ident" id="7195269">testing</span><span class="op" id="7195276">.</span><span class="ident" id="7195277">T</span><span class="op" id="7195278">)</span>&nbsp;<span class="op" id="7195280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7195283">backend</span>&nbsp;<span class="op" id="7195291">:=</span>&nbsp;<span class="ident" id="7195294">httptest</span><span class="op" id="7195302">.</span><span class="ident" id="7195303">NewServer</span><span class="op" id="7195312">(</span><span class="ident" id="7195313">http</span><span class="op" id="7195317">.</span><span class="ident" id="7195318">HandlerFunc</span><span class="op" id="7195329">(</span><span class="keyword" id="7195330">func</span><span class="op" id="7195334">(</span><span class="ident" id="7195335">w</span>&nbsp;<span class="ident" id="7195337">http</span><span class="op" id="7195341">.</span><span class="ident" id="7195342">ResponseWriter</span><span class="op" id="7195356">,</span>&nbsp;<span class="ident" id="7195358">r</span>&nbsp;<span class="op" id="7195360">*</span><span class="ident" id="7195361">http</span><span class="op" id="7195365">.</span><span class="ident" id="7195366">Request</span><span class="op" id="7195373">)</span>&nbsp;<span class="op" id="7195375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7195379">w</span><span class="op" id="7195380">.</span><span class="ident" id="7195381">Header</span><span class="op" id="7195387">(</span><span class="op" id="7195388">)</span><span class="op" id="7195389">.</span><span class="ident" id="7195390">Set</span><span class="op" id="7195393">(</span><span class="string" id="7195394">&#34;X-Got-Query&#34;</span><span class="op" id="7195407">,</span>&nbsp;<span class="ident" id="7195409">r</span><span class="op" id="7195410">.</span><span class="ident" id="7195411">URL</span><span class="op" id="7195414">.</span><span class="ident" id="7195415">RawQuery</span><span class="op" id="7195423">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7195427">w</span><span class="op" id="7195428">.</span><span class="ident" id="7195429">Write</span><span class="op" id="7195434">(</span><span class="op" id="7195435">[</span><span class="op" id="7195436">]</span><span class="builtintype" id="7195437">byte</span><span class="op" id="7195441">(</span><span class="string" id="7195442">&#34;hi&#34;</span><span class="op" id="7195446">)</span><span class="op" id="7195447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7195450">}</span><span class="op" id="7195451">)</span><span class="op" id="7195452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7195455">defer</span>&nbsp;<span class="ident" id="7195461">backend</span><span class="op" id="7195468">.</span><span class="ident" id="7195469">Close</span><span class="op" id="7195474">(</span><span class="op" id="7195475">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7195479">for</span>&nbsp;<span class="ident" id="7195483">i</span><span class="op" id="7195484">,</span>&nbsp;<span class="ident" id="7195486">tt</span>&nbsp;<span class="op" id="7195489">:=</span>&nbsp;<span class="keyword" id="7195492">range</span>&nbsp;<span class="ident" id="7195498">proxyQueryTests</span>&nbsp;<span class="op" id="7195514">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7195518">backendURL</span><span class="op" id="7195528">,</span>&nbsp;<span class="ident" id="7195530">err</span>&nbsp;<span class="op" id="7195534">:=</span>&nbsp;<span class="ident" id="7195537">url</span><span class="op" id="7195540">.</span><span class="ident" id="7195541">Parse</span><span class="op" id="7195546">(</span><span class="ident" id="7195547">backend</span><span class="op" id="7195554">.</span><span class="ident" id="7195555">URL</span>&nbsp;<span class="op" id="7195559">+</span>&nbsp;<span class="ident" id="7195561">tt</span><span class="op" id="7195563">.</span><span class="ident" id="7195564">baseSuffix</span><span class="op" id="7195574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7195578">if</span>&nbsp;<span class="ident" id="7195581">err</span>&nbsp;<span class="op" id="7195585">!=</span>&nbsp;<span class="ident" id="7195588">nil</span>&nbsp;<span class="op" id="7195592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7195597">t</span><span class="op" id="7195598">.</span><span class="ident" id="7195599">Fatal</span><span class="op" id="7195604">(</span><span class="ident" id="7195605">err</span><span class="op" id="7195608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7195612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7195616">frontend</span>&nbsp;<span class="op" id="7195625">:=</span>&nbsp;<span class="ident" id="7195628">httptest</span><span class="op" id="7195636">.</span><span class="ident" id="7195637">NewServer</span><span class="op" id="7195646">(</span><span class="ident" id="7195647">NewSingleHostReverseProxy</span><span class="op" id="7195672">(</span><span class="ident" id="7195673">backendURL</span><span class="op" id="7195683">)</span><span class="op" id="7195684">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7195688">req</span><span class="op" id="7195691">,</span>&nbsp;<span class="ident" id="7195693">_</span>&nbsp;<span class="op" id="7195695">:=</span>&nbsp;<span class="ident" id="7195698">http</span><span class="op" id="7195702">.</span><span class="ident" id="7195703">NewRequest</span><span class="op" id="7195713">(</span><span class="string" id="7195714">&#34;GET&#34;</span><span class="op" id="7195719">,</span>&nbsp;<span class="ident" id="7195721">frontend</span><span class="op" id="7195729">.</span><span class="ident" id="7195730">URL</span><span class="op" id="7195733">+</span><span class="ident" id="7195734">tt</span><span class="op" id="7195736">.</span><span class="ident" id="7195737">reqSuffix</span><span class="op" id="7195746">,</span>&nbsp;<span class="ident" id="7195748">nil</span><span class="op" id="7195751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7195755">req</span><span class="op" id="7195758">.</span><span class="ident" id="7195759">Close</span>&nbsp;<span class="op" id="7195765">=</span>&nbsp;<span class="builtintype" id="7195767">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7195774">res</span><span class="op" id="7195777">,</span>&nbsp;<span class="ident" id="7195779">err</span>&nbsp;<span class="op" id="7195783">:=</span>&nbsp;<span class="ident" id="7195786">http</span><span class="op" id="7195790">.</span><span class="ident" id="7195791">DefaultClient</span><span class="op" id="7195804">.</span><span class="ident" id="7195805">Do</span><span class="op" id="7195807">(</span><span class="ident" id="7195808">req</span><span class="op" id="7195811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7195815">if</span>&nbsp;<span class="ident" id="7195818">err</span>&nbsp;<span class="op" id="7195822">!=</span>&nbsp;<span class="ident" id="7195825">nil</span>&nbsp;<span class="op" id="7195829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7195834">t</span><span class="op" id="7195835">.</span><span class="ident" id="7195836">Fatalf</span><span class="op" id="7195842">(</span><span class="string" id="7195843">&#34;%d.&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="7195856">,</span>&nbsp;<span class="ident" id="7195858">i</span><span class="op" id="7195859">,</span>&nbsp;<span class="ident" id="7195861">err</span><span class="op" id="7195864">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7195868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7195872">if</span>&nbsp;<span class="ident" id="7195875">g</span><span class="op" id="7195876">,</span>&nbsp;<span class="ident" id="7195878">e</span>&nbsp;<span class="op" id="7195880">:=</span>&nbsp;<span class="ident" id="7195883">res</span><span class="op" id="7195886">.</span><span class="ident" id="7195887">Header</span><span class="op" id="7195893">.</span><span class="ident" id="7195894">Get</span><span class="op" id="7195897">(</span><span class="string" id="7195898">&#34;X-Got-Query&#34;</span><span class="op" id="7195911">)</span><span class="op" id="7195912">,</span>&nbsp;<span class="ident" id="7195914">tt</span><span class="op" id="7195916">.</span><span class="ident" id="7195917">want</span><span class="op" id="7195921">;</span>&nbsp;<span class="ident" id="7195923">g</span>&nbsp;<span class="op" id="7195925">!=</span>&nbsp;<span class="ident" id="7195928">e</span>&nbsp;<span class="op" id="7195930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7195935">t</span><span class="op" id="7195936">.</span><span class="ident" id="7195937">Errorf</span><span class="op" id="7195943">(</span><span class="string" id="7195944">&#34;%d.&nbsp;got&nbsp;query&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7195975">,</span>&nbsp;<span class="ident" id="7195977">i</span><span class="op" id="7195978">,</span>&nbsp;<span class="ident" id="7195980">g</span><span class="op" id="7195981">,</span>&nbsp;<span class="ident" id="7195983">e</span><span class="op" id="7195984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7195988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7195992">res</span><span class="op" id="7195995">.</span><span class="ident" id="7195996">Body</span><span class="op" id="7196000">.</span><span class="ident" id="7196001">Close</span><span class="op" id="7196006">(</span><span class="op" id="7196007">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7196011">frontend</span><span class="op" id="7196019">.</span><span class="ident" id="7196020">Close</span><span class="op" id="7196025">(</span><span class="op" id="7196026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7196029">}</span><br>
<span class="lineno"></span><span class="op" id="7196031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7196034">func</span>&nbsp;<span class="ident" id="7196039">TestReverseProxyFlushInterval</span><span class="op" id="7196068">(</span><span class="ident" id="7196069">t</span>&nbsp;<span class="op" id="7196071">*</span><span class="ident" id="7196072">testing</span><span class="op" id="7196079">.</span><span class="ident" id="7196080">T</span><span class="op" id="7196081">)</span>&nbsp;<span class="op" id="7196083">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7196086">const</span>&nbsp;<span class="ident" id="7196092">expected</span>&nbsp;<span class="op" id="7196101">=</span>&nbsp;<span class="string" id="7196103">&#34;hi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7196109">backend</span>&nbsp;<span class="op" id="7196117">:=</span>&nbsp;<span class="ident" id="7196120">httptest</span><span class="op" id="7196128">.</span><span class="ident" id="7196129">NewServer</span><span class="op" id="7196138">(</span><span class="ident" id="7196139">http</span><span class="op" id="7196143">.</span><span class="ident" id="7196144">HandlerFunc</span><span class="op" id="7196155">(</span><span class="keyword" id="7196156">func</span><span class="op" id="7196160">(</span><span class="ident" id="7196161">w</span>&nbsp;<span class="ident" id="7196163">http</span><span class="op" id="7196167">.</span><span class="ident" id="7196168">ResponseWriter</span><span class="op" id="7196182">,</span>&nbsp;<span class="ident" id="7196184">r</span>&nbsp;<span class="op" id="7196186">*</span><span class="ident" id="7196187">http</span><span class="op" id="7196191">.</span><span class="ident" id="7196192">Request</span><span class="op" id="7196199">)</span>&nbsp;<span class="op" id="7196201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7196205">w</span><span class="op" id="7196206">.</span><span class="ident" id="7196207">Write</span><span class="op" id="7196212">(</span><span class="op" id="7196213">[</span><span class="op" id="7196214">]</span><span class="builtintype" id="7196215">byte</span><span class="op" id="7196219">(</span><span class="ident" id="7196220">expected</span><span class="op" id="7196228">)</span><span class="op" id="7196229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7196232">}</span><span class="op" id="7196233">)</span><span class="op" id="7196234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7196237">defer</span>&nbsp;<span class="ident" id="7196243">backend</span><span class="op" id="7196250">.</span><span class="ident" id="7196251">Close</span><span class="op" id="7196256">(</span><span class="op" id="7196257">)</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7196261">backendURL</span><span class="op" id="7196271">,</span>&nbsp;<span class="ident" id="7196273">err</span>&nbsp;<span class="op" id="7196277">:=</span>&nbsp;<span class="ident" id="7196280">url</span><span class="op" id="7196283">.</span><span class="ident" id="7196284">Parse</span><span class="op" id="7196289">(</span><span class="ident" id="7196290">backend</span><span class="op" id="7196297">.</span><span class="ident" id="7196298">URL</span><span class="op" id="7196301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7196304">if</span>&nbsp;<span class="ident" id="7196307">err</span>&nbsp;<span class="op" id="7196311">!=</span>&nbsp;<span class="ident" id="7196314">nil</span>&nbsp;<span class="op" id="7196318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7196322">t</span><span class="op" id="7196323">.</span><span class="ident" id="7196324">Fatal</span><span class="op" id="7196329">(</span><span class="ident" id="7196330">err</span><span class="op" id="7196333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7196336">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7196340">proxyHandler</span>&nbsp;<span class="op" id="7196353">:=</span>&nbsp;<span class="ident" id="7196356">NewSingleHostReverseProxy</span><span class="op" id="7196381">(</span><span class="ident" id="7196382">backendURL</span><span class="op" id="7196392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7196395">proxyHandler</span><span class="op" id="7196407">.</span><span class="ident" id="7196408">FlushInterval</span>&nbsp;<span class="op" id="7196422">=</span>&nbsp;<span class="ident" id="7196424">time</span><span class="op" id="7196428">.</span><span class="ident" id="7196429">Microsecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7196443">done</span>&nbsp;<span class="op" id="7196448">:=</span>&nbsp;<span class="builtinfunc" id="7196451">make</span><span class="op" id="7196455">(</span><span class="keyword" id="7196456">chan</span>&nbsp;<span class="builtintype" id="7196461">bool</span><span class="op" id="7196465">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7196468">onExitFlushLoop</span>&nbsp;<span class="op" id="7196484">=</span>&nbsp;<span class="keyword" id="7196486">func</span><span class="op" id="7196490">(</span><span class="op" id="7196491">)</span>&nbsp;<span class="op" id="7196493">{</span>&nbsp;<span class="ident" id="7196495">done</span>&nbsp;<span class="op" id="7196500">&lt;-</span>&nbsp;<span class="builtintype" id="7196503">true</span>&nbsp;<span class="op" id="7196508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7196511">defer</span>&nbsp;<span class="keyword" id="7196517">func</span><span class="op" id="7196521">(</span><span class="op" id="7196522">)</span>&nbsp;<span class="op" id="7196524">{</span>&nbsp;<span class="ident" id="7196526">onExitFlushLoop</span>&nbsp;<span class="op" id="7196542">=</span>&nbsp;<span class="ident" id="7196544">nil</span>&nbsp;<span class="op" id="7196548">}</span><span class="op" id="7196549">(</span><span class="op" id="7196550">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7196554">frontend</span>&nbsp;<span class="op" id="7196563">:=</span>&nbsp;<span class="ident" id="7196566">httptest</span><span class="op" id="7196574">.</span><span class="ident" id="7196575">NewServer</span><span class="op" id="7196584">(</span><span class="ident" id="7196585">proxyHandler</span><span class="op" id="7196597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7196600">defer</span>&nbsp;<span class="ident" id="7196606">frontend</span><span class="op" id="7196614">.</span><span class="ident" id="7196615">Close</span><span class="op" id="7196620">(</span><span class="op" id="7196621">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7196625">req</span><span class="op" id="7196628">,</span>&nbsp;<span class="ident" id="7196630">_</span>&nbsp;<span class="op" id="7196632">:=</span>&nbsp;<span class="ident" id="7196635">http</span><span class="op" id="7196639">.</span><span class="ident" id="7196640">NewRequest</span><span class="op" id="7196650">(</span><span class="string" id="7196651">&#34;GET&#34;</span><span class="op" id="7196656">,</span>&nbsp;<span class="ident" id="7196658">frontend</span><span class="op" id="7196666">.</span><span class="ident" id="7196667">URL</span><span class="op" id="7196670">,</span>&nbsp;<span class="ident" id="7196672">nil</span><span class="op" id="7196675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7196678">req</span><span class="op" id="7196681">.</span><span class="ident" id="7196682">Close</span>&nbsp;<span class="op" id="7196688">=</span>&nbsp;<span class="builtintype" id="7196690">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7196696">res</span><span class="op" id="7196699">,</span>&nbsp;<span class="ident" id="7196701">err</span>&nbsp;<span class="op" id="7196705">:=</span>&nbsp;<span class="ident" id="7196708">http</span><span class="op" id="7196712">.</span><span class="ident" id="7196713">DefaultClient</span><span class="op" id="7196726">.</span><span class="ident" id="7196727">Do</span><span class="op" id="7196729">(</span><span class="ident" id="7196730">req</span><span class="op" id="7196733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7196736">if</span>&nbsp;<span class="ident" id="7196739">err</span>&nbsp;<span class="op" id="7196743">!=</span>&nbsp;<span class="ident" id="7196746">nil</span>&nbsp;<span class="op" id="7196750">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7196754">t</span><span class="op" id="7196755">.</span><span class="ident" id="7196756">Fatalf</span><span class="op" id="7196762">(</span><span class="string" id="7196763">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7196772">,</span>&nbsp;<span class="ident" id="7196774">err</span><span class="op" id="7196777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7196780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7196783">defer</span>&nbsp;<span class="ident" id="7196789">res</span><span class="op" id="7196792">.</span><span class="ident" id="7196793">Body</span><span class="op" id="7196797">.</span><span class="ident" id="7196798">Close</span><span class="op" id="7196803">(</span><span class="op" id="7196804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7196807">if</span>&nbsp;<span class="ident" id="7196810">bodyBytes</span><span class="op" id="7196819">,</span>&nbsp;<span class="ident" id="7196821">_</span>&nbsp;<span class="op" id="7196823">:=</span>&nbsp;<span class="ident" id="7196826">ioutil</span><span class="op" id="7196832">.</span><span class="ident" id="7196833">ReadAll</span><span class="op" id="7196840">(</span><span class="ident" id="7196841">res</span><span class="op" id="7196844">.</span><span class="ident" id="7196845">Body</span><span class="op" id="7196849">)</span><span class="op" id="7196850">;</span>&nbsp;<span class="builtintype" id="7196852">string</span><span class="op" id="7196858">(</span><span class="ident" id="7196859">bodyBytes</span><span class="op" id="7196868">)</span>&nbsp;<span class="op" id="7196870">!=</span>&nbsp;<span class="ident" id="7196873">expected</span>&nbsp;<span class="op" id="7196882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7196886">t</span><span class="op" id="7196887">.</span><span class="ident" id="7196888">Errorf</span><span class="op" id="7196894">(</span><span class="string" id="7196895">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7196921">,</span>&nbsp;<span class="ident" id="7196923">bodyBytes</span><span class="op" id="7196932">,</span>&nbsp;<span class="ident" id="7196934">expected</span><span class="op" id="7196942">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7196945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7196949">select</span>&nbsp;<span class="op" id="7196956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7196959">case</span>&nbsp;<span class="op" id="7196964">&lt;-</span><span class="ident" id="7196966">done</span><span class="op" id="7196970">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7196974">//&nbsp;OK</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7196981">case</span>&nbsp;<span class="op" id="7196986">&lt;-</span><span class="ident" id="7196988">time</span><span class="op" id="7196992">.</span><span class="ident" id="7196993">After</span><span class="op" id="7196998">(</span><span class="num" id="7196999">5</span>&nbsp;<span class="op" id="7197001">*</span>&nbsp;<span class="ident" id="7197003">time</span><span class="op" id="7197007">.</span><span class="ident" id="7197008">Second</span><span class="op" id="7197014">)</span><span class="op" id="7197015">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7197019">t</span><span class="op" id="7197020">.</span><span class="ident" id="7197021">Error</span><span class="op" id="7197026">(</span><span class="string" id="7197027">&#34;maxLatencyWriter&nbsp;flushLoop()&nbsp;never&nbsp;exited&#34;</span><span class="op" id="7197070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7197073">}</span><br>
<span class="lineno"></span><span class="op" id="7197075">}</span>
</div>
</body>
</html>
