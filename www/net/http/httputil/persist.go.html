<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5526130">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5526185">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5526239">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5526290">package</span>&nbsp;<span class="ident" id="5526298">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5526308">import</span>&nbsp;<span class="op" id="5526315">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5526318">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5526327">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5526337">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5526343">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5526350">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5526362">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5526379">&#34;sync&#34;</span><br>
<span class="lineno">15</span><span class="op" id="5526386">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5526389">var</span>&nbsp;<span class="op" id="5526393">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526396">ErrPersistEOF</span>&nbsp;<span class="op" id="5526410">=</span>&nbsp;<span class="op" id="5526412">&amp;</span><span class="ident" id="5526413"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5526417">.</span><span class="ident" id="5526418">ProtocolError</span><span class="op" id="5526431">{</span><span class="ident" id="5526432">ErrorString</span><span class="op" id="5526443">:</span>&nbsp;<span class="string" id="5526445">&#34;persistent&nbsp;connection&nbsp;closed&#34;</span><span class="op" id="5526475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526478">ErrClosed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5526492">=</span>&nbsp;<span class="op" id="5526494">&amp;</span><span class="ident" id="5526495"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5526499">.</span><span class="ident" id="5526500">ProtocolError</span><span class="op" id="5526513">{</span><span class="ident" id="5526514">ErrorString</span><span class="op" id="5526525">:</span>&nbsp;<span class="string" id="5526527">&#34;connection&nbsp;closed&nbsp;by&nbsp;user&#34;</span><span class="op" id="5526554">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526557">ErrPipeline</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5526571">=</span>&nbsp;<span class="op" id="5526573">&amp;</span><span class="ident" id="5526574"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5526578">.</span><span class="ident" id="5526579">ProtocolError</span><span class="op" id="5526592">{</span><span class="ident" id="5526593">ErrorString</span><span class="op" id="5526604">:</span>&nbsp;<span class="string" id="5526606">&#34;pipeline&nbsp;error&#34;</span><span class="op" id="5526622">}</span><br>
<span class="lineno"></span><span class="op" id="5526624">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5526627">//&nbsp;This&nbsp;is&nbsp;an&nbsp;API&nbsp;usage&nbsp;error&nbsp;-&nbsp;the&nbsp;local&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="5526685">//&nbsp;ErrPersistEOF&nbsp;(above)&nbsp;reports&nbsp;that&nbsp;the&nbsp;remote&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno">25</span><span class="keyword" id="5526750">var</span>&nbsp;<span class="ident" id="5526754">errClosed</span>&nbsp;<span class="op" id="5526764">=</span>&nbsp;<span class="ident" id="5526766"><a href="/net/http/httputil/persist.go.html#5526327">errors</a></span><span class="op" id="5526772">.</span><span class="ident" id="5526773">New</span><span class="op" id="5526776">(</span><span class="string" id="5526777">&#34;i/o&nbsp;operation&nbsp;on&nbsp;closed&nbsp;connection&#34;</span><span class="op" id="5526813">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5526816">//&nbsp;A&nbsp;ServerConn&nbsp;reads&nbsp;requests&nbsp;and&nbsp;sends&nbsp;responses&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="5526886">//&nbsp;connection,&nbsp;until&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic&nbsp;commands&nbsp;an&nbsp;end.&nbsp;ServerConn</span><br>
<span class="lineno"></span><span class="comment" id="5526960">//&nbsp;also&nbsp;allows&nbsp;hijacking&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;by&nbsp;calling&nbsp;Hijack</span><br>
<span class="lineno">30</span><span class="comment" id="5527029">//&nbsp;to&nbsp;regain&nbsp;control&nbsp;over&nbsp;the&nbsp;connection.&nbsp;ServerConn&nbsp;supports&nbsp;pipe-lining,</span><br>
<span class="lineno"></span><span class="comment" id="5527104">//&nbsp;i.e.&nbsp;requests&nbsp;can&nbsp;be&nbsp;read&nbsp;out&nbsp;of&nbsp;sync&nbsp;(but&nbsp;in&nbsp;the&nbsp;same&nbsp;order)&nbsp;while&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5527179">//&nbsp;respective&nbsp;responses&nbsp;are&nbsp;sent.</span><br>
<span class="lineno"></span><span class="comment" id="5527213">//</span><br>
<span class="lineno"></span><span class="comment" id="5527216">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno">35</span><span class="comment" id="5527291">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5527319">type</span>&nbsp;<span class="ident" id="5527324">ServerConn</span>&nbsp;<span class="keyword" id="5527335">struct</span>&nbsp;<span class="op" id="5527342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527345">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5527361"><a href="/net/http/httputil/persist.go.html#5526379">sync</a></span><span class="op" id="5527365">.</span><span class="ident" id="5527366">Mutex</span>&nbsp;<span class="comment" id="5527372">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527417">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5527433"><a href="/net/http/httputil/persist.go.html#5526343">net</a></span><span class="op" id="5527436">.</span><span class="ident" id="5527437">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527443">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5527459">*</span><span class="ident" id="5527460"><a href="/net/http/httputil/persist.go.html#5526318">bufio</a></span><span class="op" id="5527465">.</span><span class="ident" id="5527466">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527474">re</span><span class="op" id="5527476">,</span>&nbsp;<span class="ident" id="5527478">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5527490">error</span>&nbsp;<span class="comment" id="5527496">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527518">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5527534"><a href="/net/http/httputil/persist.go.html#5526337">io</a></span><span class="op" id="5527536">.</span><span class="ident" id="5527537">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527549">nread</span><span class="op" id="5527554">,</span>&nbsp;<span class="ident" id="5527556">nwritten</span>&nbsp;<span class="builtintype" id="5527565">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527570">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5527586">map</span><span class="op" id="5527589">[</span><span class="op" id="5527590">*</span><span class="ident" id="5527591"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5527595">.</span><span class="ident" id="5527596">Request</span><span class="op" id="5527603">]</span><span class="builtintype" id="5527604">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527611">pipe</span>&nbsp;<span class="ident" id="5527616"><a href="/net/http/httputil/persist.go.html#5526362">textproto</a></span><span class="op" id="5527625">.</span><span class="ident" id="5527626">Pipeline</span><br>
<span class="lineno"></span><span class="op" id="5527635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5527638">//&nbsp;NewServerConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServerConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="5527715">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno">50</span><span class="comment" id="5527763">//</span><br>
<span class="lineno"></span><span class="comment" id="5527766">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno"></span><span class="comment" id="5527841">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5527869">func</span>&nbsp;<span class="ident" id="5527874">NewServerConn</span><span class="op" id="5527887">(</span><span class="ident" id="5527888">c</span>&nbsp;<span class="ident" id="5527890"><a href="/net/http/httputil/persist.go.html#5526343">net</a></span><span class="op" id="5527893">.</span><span class="ident" id="5527894">Conn</span><span class="op" id="5527898">,</span>&nbsp;<span class="ident" id="5527900">r</span>&nbsp;<span class="op" id="5527902">*</span><span class="ident" id="5527903"><a href="/net/http/httputil/persist.go.html#5526318">bufio</a></span><span class="op" id="5527908">.</span><span class="ident" id="5527909">Reader</span><span class="op" id="5527915">)</span>&nbsp;<span class="op" id="5527917">*</span><span class="ident" id="5527918"><a href="/net/http/httputil/persist.go.html#5527324">ServerConn</a></span>&nbsp;<span class="op" id="5527929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5527932">if</span>&nbsp;<span class="ident" id="5527935"><a href="/net/http/httputil/persist.go.html#5527900">r</a></span>&nbsp;<span class="op" id="5527937">==</span>&nbsp;<span class="ident" id="5527940">nil</span>&nbsp;<span class="op" id="5527944">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527948"><a href="/net/http/httputil/persist.go.html#5527900">r</a></span>&nbsp;<span class="op" id="5527950">=</span>&nbsp;<span class="ident" id="5527952"><a href="/net/http/httputil/persist.go.html#5526318">bufio</a></span><span class="op" id="5527957">.</span><span class="ident" id="5527958">NewReader</span><span class="op" id="5527967">(</span><span class="ident" id="5527968"><a href="/net/http/httputil/persist.go.html#5527888">c</a></span><span class="op" id="5527969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5527972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5527975">return</span>&nbsp;<span class="op" id="5527982">&amp;</span><span class="ident" id="5527983"><a href="/net/http/httputil/persist.go.html#5527324">ServerConn</a></span><span class="op" id="5527993">{</span><span class="ident" id="5527994">c</span><span class="op" id="5527995">:</span>&nbsp;<span class="ident" id="5527997"><a href="/net/http/httputil/persist.go.html#5527888">c</a></span><span class="op" id="5527998">,</span>&nbsp;<span class="ident" id="5528000">r</span><span class="op" id="5528001">:</span>&nbsp;<span class="ident" id="5528003"><a href="/net/http/httputil/persist.go.html#5527900">r</a></span><span class="op" id="5528004">,</span>&nbsp;<span class="ident" id="5528006">pipereq</span><span class="op" id="5528013">:</span>&nbsp;<span class="builtinfunc" id="5528015">make</span><span class="op" id="5528019">(</span><span class="keyword" id="5528020">map</span><span class="op" id="5528023">[</span><span class="op" id="5528024">*</span><span class="ident" id="5528025"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5528029">.</span><span class="ident" id="5528030">Request</span><span class="op" id="5528037">]</span><span class="builtintype" id="5528038">uint</span><span class="op" id="5528042">)</span><span class="op" id="5528043">}</span><br>
<span class="lineno"></span><span class="op" id="5528045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="5528048">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ServerConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="5528128">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5528204">//&nbsp;called&nbsp;before&nbsp;Read&nbsp;has&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive&nbsp;logic.&nbsp;The&nbsp;user</span><br>
<span class="lineno"></span><span class="comment" id="5528281">//&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="5528343">func</span>&nbsp;<span class="op" id="5528348">(</span><span class="ident" id="5528349">sc</span>&nbsp;<span class="op" id="5528352">*</span><span class="ident" id="5528353"><a href="/net/http/httputil/persist.go.html#5527324">ServerConn</a></span><span class="op" id="5528363">)</span>&nbsp;<span class="ident" id="5528365">Hijack</span><span class="op" id="5528371">(</span><span class="op" id="5528372">)</span>&nbsp;<span class="op" id="5528374">(</span><span class="ident" id="5528375">c</span>&nbsp;<span class="ident" id="5528377"><a href="/net/http/httputil/persist.go.html#5526343">net</a></span><span class="op" id="5528380">.</span><span class="ident" id="5528381">Conn</span><span class="op" id="5528385">,</span>&nbsp;<span class="ident" id="5528387">r</span>&nbsp;<span class="op" id="5528389">*</span><span class="ident" id="5528390"><a href="/net/http/httputil/persist.go.html#5526318">bufio</a></span><span class="op" id="5528395">.</span><span class="ident" id="5528396">Reader</span><span class="op" id="5528402">)</span>&nbsp;<span class="op" id="5528404">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528407"><a href="/net/http/httputil/persist.go.html#5528349">sc</a></span><span class="op" id="5528409">.</span><span class="ident" id="5528410">lk</span><span class="op" id="5528412">.</span><span class="ident" id="5528413">Lock</span><span class="op" id="5528417">(</span><span class="op" id="5528418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5528421">defer</span>&nbsp;<span class="ident" id="5528427"><a href="/net/http/httputil/persist.go.html#5528349">sc</a></span><span class="op" id="5528429">.</span><span class="ident" id="5528430">lk</span><span class="op" id="5528432">.</span><span class="ident" id="5528433">Unlock</span><span class="op" id="5528439">(</span><span class="op" id="5528440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528443"><a href="/net/http/httputil/persist.go.html#5528375">c</a></span>&nbsp;<span class="op" id="5528445">=</span>&nbsp;<span class="ident" id="5528447"><a href="/net/http/httputil/persist.go.html#5528349">sc</a></span><span class="op" id="5528449">.</span><span class="ident" id="5528450">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528453"><a href="/net/http/httputil/persist.go.html#5528387">r</a></span>&nbsp;<span class="op" id="5528455">=</span>&nbsp;<span class="ident" id="5528457"><a href="/net/http/httputil/persist.go.html#5528349">sc</a></span><span class="op" id="5528459">.</span><span class="ident" id="5528460">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528463"><a href="/net/http/httputil/persist.go.html#5528349">sc</a></span><span class="op" id="5528465">.</span><span class="ident" id="5528466">c</span>&nbsp;<span class="op" id="5528468">=</span>&nbsp;<span class="ident" id="5528470">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528475"><a href="/net/http/httputil/persist.go.html#5528349">sc</a></span><span class="op" id="5528477">.</span><span class="ident" id="5528478">r</span>&nbsp;<span class="op" id="5528480">=</span>&nbsp;<span class="ident" id="5528482">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5528487">return</span><br>
<span class="lineno"></span><span class="op" id="5528494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5528497">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">75</span><span class="keyword" id="5528566">func</span>&nbsp;<span class="op" id="5528571">(</span><span class="ident" id="5528572">sc</span>&nbsp;<span class="op" id="5528575">*</span><span class="ident" id="5528576"><a href="/net/http/httputil/persist.go.html#5527324">ServerConn</a></span><span class="op" id="5528586">)</span>&nbsp;<span class="ident" id="5528588">Close</span><span class="op" id="5528593">(</span><span class="op" id="5528594">)</span>&nbsp;<span class="builtintype" id="5528596">error</span>&nbsp;<span class="op" id="5528602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528605">c</span><span class="op" id="5528606">,</span>&nbsp;<span class="ident" id="5528608">_</span>&nbsp;<span class="op" id="5528610">:=</span>&nbsp;<span class="ident" id="5528613"><a href="/net/http/httputil/persist.go.html#5528572">sc</a></span><span class="op" id="5528615">.</span><span class="ident" id="5528616">Hijack</span><span class="op" id="5528622">(</span><span class="op" id="5528623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5528626">if</span>&nbsp;<span class="ident" id="5528629"><a href="/net/http/httputil/persist.go.html#5528605">c</a></span>&nbsp;<span class="op" id="5528631">!=</span>&nbsp;<span class="ident" id="5528634">nil</span>&nbsp;<span class="op" id="5528638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5528642">return</span>&nbsp;<span class="ident" id="5528649"><a href="/net/http/httputil/persist.go.html#5528605">c</a></span><span class="op" id="5528650">.</span><span class="ident" id="5528651">Close</span><span class="op" id="5528656">(</span><span class="op" id="5528657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5528660">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5528663">return</span>&nbsp;<span class="ident" id="5528670">nil</span><br>
<span class="lineno"></span><span class="op" id="5528674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5528677">//&nbsp;Read&nbsp;returns&nbsp;the&nbsp;next&nbsp;request&nbsp;on&nbsp;the&nbsp;wire.&nbsp;An&nbsp;ErrPersistEOF&nbsp;is&nbsp;returned&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="5528755">//&nbsp;it&nbsp;is&nbsp;gracefully&nbsp;determined&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;requests&nbsp;(e.g.&nbsp;after&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="5528834">//&nbsp;first&nbsp;request&nbsp;on&nbsp;an&nbsp;HTTP/1.0&nbsp;connection,&nbsp;or&nbsp;after&nbsp;a&nbsp;Connection:close&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5528911">//&nbsp;HTTP/1.1&nbsp;connection).</span><br>
<span class="lineno"></span><span class="keyword" id="5528936">func</span>&nbsp;<span class="op" id="5528941">(</span><span class="ident" id="5528942">sc</span>&nbsp;<span class="op" id="5528945">*</span><span class="ident" id="5528946"><a href="/net/http/httputil/persist.go.html#5527324">ServerConn</a></span><span class="op" id="5528956">)</span>&nbsp;<span class="ident" id="5528958">Read</span><span class="op" id="5528962">(</span><span class="op" id="5528963">)</span>&nbsp;<span class="op" id="5528965">(</span><span class="ident" id="5528966">req</span>&nbsp;<span class="op" id="5528970">*</span><span class="ident" id="5528971"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5528975">.</span><span class="ident" id="5528976">Request</span><span class="op" id="5528983">,</span>&nbsp;<span class="ident" id="5528985">err</span>&nbsp;<span class="builtintype" id="5528989">error</span><span class="op" id="5528994">)</span>&nbsp;<span class="op" id="5528996">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5529000">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Reads&nbsp;and&nbsp;Writes</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529049">id</span>&nbsp;<span class="op" id="5529052">:=</span>&nbsp;<span class="ident" id="5529055"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529057">.</span><span class="ident" id="5529058">pipe</span><span class="op" id="5529062">.</span><span class="ident" id="5529063">Next</span><span class="op" id="5529067">(</span><span class="op" id="5529068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529071"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529073">.</span><span class="ident" id="5529074">pipe</span><span class="op" id="5529078">.</span><span class="ident" id="5529079">StartRequest</span><span class="op" id="5529091">(</span><span class="ident" id="5529092"><a href="/net/http/httputil/persist.go.html#5529049">id</a></span><span class="op" id="5529094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529097">defer</span>&nbsp;<span class="keyword" id="5529103">func</span><span class="op" id="5529107">(</span><span class="op" id="5529108">)</span>&nbsp;<span class="op" id="5529110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529114"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529116">.</span><span class="ident" id="5529117">pipe</span><span class="op" id="5529121">.</span><span class="ident" id="5529122">EndRequest</span><span class="op" id="5529132">(</span><span class="ident" id="5529133"><a href="/net/http/httputil/persist.go.html#5529049">id</a></span><span class="op" id="5529135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529139">if</span>&nbsp;<span class="ident" id="5529142"><a href="/net/http/httputil/persist.go.html#5528966">req</a></span>&nbsp;<span class="op" id="5529146">==</span>&nbsp;<span class="ident" id="5529149">nil</span>&nbsp;<span class="op" id="5529153">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529158"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529160">.</span><span class="ident" id="5529161">pipe</span><span class="op" id="5529165">.</span><span class="ident" id="5529166">StartResponse</span><span class="op" id="5529179">(</span><span class="ident" id="5529180"><a href="/net/http/httputil/persist.go.html#5529049">id</a></span><span class="op" id="5529182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529187"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529189">.</span><span class="ident" id="5529190">pipe</span><span class="op" id="5529194">.</span><span class="ident" id="5529195">EndResponse</span><span class="op" id="5529206">(</span><span class="ident" id="5529207"><a href="/net/http/httputil/persist.go.html#5529049">id</a></span><span class="op" id="5529209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5529213">}</span>&nbsp;<span class="keyword" id="5529215">else</span>&nbsp;<span class="op" id="5529220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5529225">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529272"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529274">.</span><span class="ident" id="5529275">lk</span><span class="op" id="5529277">.</span><span class="ident" id="5529278">Lock</span><span class="op" id="5529282">(</span><span class="op" id="5529283">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529288"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529290">.</span><span class="ident" id="5529291">pipereq</span><span class="op" id="5529298">[</span><span class="ident" id="5529299"><a href="/net/http/httputil/persist.go.html#5528966">req</a></span><span class="op" id="5529302">]</span>&nbsp;<span class="op" id="5529304">=</span>&nbsp;<span class="ident" id="5529306"><a href="/net/http/httputil/persist.go.html#5529049">id</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529312"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529314">.</span><span class="ident" id="5529315">lk</span><span class="op" id="5529317">.</span><span class="ident" id="5529318">Unlock</span><span class="op" id="5529324">(</span><span class="op" id="5529325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5529329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5529332">}</span><span class="op" id="5529333">(</span><span class="op" id="5529334">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529338"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529340">.</span><span class="ident" id="5529341">lk</span><span class="op" id="5529343">.</span><span class="ident" id="5529344">Lock</span><span class="op" id="5529348">(</span><span class="op" id="5529349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529352">if</span>&nbsp;<span class="ident" id="5529355"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529357">.</span><span class="ident" id="5529358">we</span>&nbsp;<span class="op" id="5529361">!=</span>&nbsp;<span class="ident" id="5529364">nil</span>&nbsp;<span class="op" id="5529368">{</span>&nbsp;<span class="comment" id="5529370">//&nbsp;no&nbsp;point&nbsp;receiving&nbsp;if&nbsp;write-side&nbsp;broken&nbsp;or&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529425">defer</span>&nbsp;<span class="ident" id="5529431"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529433">.</span><span class="ident" id="5529434">lk</span><span class="op" id="5529436">.</span><span class="ident" id="5529437">Unlock</span><span class="op" id="5529443">(</span><span class="op" id="5529444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529448">return</span>&nbsp;<span class="ident" id="5529455">nil</span><span class="op" id="5529458">,</span>&nbsp;<span class="ident" id="5529460"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529462">.</span><span class="ident" id="5529463">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5529467">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529470">if</span>&nbsp;<span class="ident" id="5529473"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529475">.</span><span class="ident" id="5529476">re</span>&nbsp;<span class="op" id="5529479">!=</span>&nbsp;<span class="ident" id="5529482">nil</span>&nbsp;<span class="op" id="5529486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529490">defer</span>&nbsp;<span class="ident" id="5529496"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529498">.</span><span class="ident" id="5529499">lk</span><span class="op" id="5529501">.</span><span class="ident" id="5529502">Unlock</span><span class="op" id="5529508">(</span><span class="op" id="5529509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529513">return</span>&nbsp;<span class="ident" id="5529520">nil</span><span class="op" id="5529523">,</span>&nbsp;<span class="ident" id="5529525"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529527">.</span><span class="ident" id="5529528">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5529532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529535">if</span>&nbsp;<span class="ident" id="5529538"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529540">.</span><span class="ident" id="5529541">r</span>&nbsp;<span class="op" id="5529543">==</span>&nbsp;<span class="ident" id="5529546">nil</span>&nbsp;<span class="op" id="5529550">{</span>&nbsp;<span class="comment" id="5529552">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529599">defer</span>&nbsp;<span class="ident" id="5529605"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529607">.</span><span class="ident" id="5529608">lk</span><span class="op" id="5529610">.</span><span class="ident" id="5529611">Unlock</span><span class="op" id="5529617">(</span><span class="op" id="5529618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529622">return</span>&nbsp;<span class="ident" id="5529629">nil</span><span class="op" id="5529632">,</span>&nbsp;<span class="ident" id="5529634"><a href="/net/http/httputil/persist.go.html#5526754">errClosed</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5529645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529648">r</span>&nbsp;<span class="op" id="5529650">:=</span>&nbsp;<span class="ident" id="5529653"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529655">.</span><span class="ident" id="5529656">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529659">lastbody</span>&nbsp;<span class="op" id="5529668">:=</span>&nbsp;<span class="ident" id="5529671"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529673">.</span><span class="ident" id="5529674">lastbody</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529684"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529686">.</span><span class="ident" id="5529687">lastbody</span>&nbsp;<span class="op" id="5529696">=</span>&nbsp;<span class="ident" id="5529698">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529703"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5529705">.</span><span class="ident" id="5529706">lk</span><span class="op" id="5529708">.</span><span class="ident" id="5529709">Unlock</span><span class="op" id="5529715">(</span><span class="op" id="5529716">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5529720">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529796">if</span>&nbsp;<span class="ident" id="5529799"><a href="/net/http/httputil/persist.go.html#5529659">lastbody</a></span>&nbsp;<span class="op" id="5529808">!=</span>&nbsp;<span class="ident" id="5529811">nil</span>&nbsp;<span class="op" id="5529815">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5529819">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5529885">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5529943">//&nbsp;returned.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529958"><a href="/net/http/httputil/persist.go.html#5528985">err</a></span>&nbsp;<span class="op" id="5529962">=</span>&nbsp;<span class="ident" id="5529964"><a href="/net/http/httputil/persist.go.html#5529659">lastbody</a></span><span class="op" id="5529972">.</span><span class="ident" id="5529973">Close</span><span class="op" id="5529978">(</span><span class="op" id="5529979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529983">if</span>&nbsp;<span class="ident" id="5529986"><a href="/net/http/httputil/persist.go.html#5528985">err</a></span>&nbsp;<span class="op" id="5529990">!=</span>&nbsp;<span class="ident" id="5529993">nil</span>&nbsp;<span class="op" id="5529997">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530002"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5530004">.</span><span class="ident" id="5530005">lk</span><span class="op" id="5530007">.</span><span class="ident" id="5530008">Lock</span><span class="op" id="5530012">(</span><span class="op" id="5530013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530018">defer</span>&nbsp;<span class="ident" id="5530024"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5530026">.</span><span class="ident" id="5530027">lk</span><span class="op" id="5530029">.</span><span class="ident" id="5530030">Unlock</span><span class="op" id="5530036">(</span><span class="op" id="5530037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530042"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5530044">.</span><span class="ident" id="5530045">re</span>&nbsp;<span class="op" id="5530048">=</span>&nbsp;<span class="ident" id="5530050"><a href="/net/http/httputil/persist.go.html#5528985">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530057">return</span>&nbsp;<span class="ident" id="5530064">nil</span><span class="op" id="5530067">,</span>&nbsp;<span class="ident" id="5530069"><a href="/net/http/httputil/persist.go.html#5528985">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5530075">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5530078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530082"><a href="/net/http/httputil/persist.go.html#5528966">req</a></span><span class="op" id="5530085">,</span>&nbsp;<span class="ident" id="5530087"><a href="/net/http/httputil/persist.go.html#5528985">err</a></span>&nbsp;<span class="op" id="5530091">=</span>&nbsp;<span class="ident" id="5530093"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5530097">.</span><span class="ident" id="5530098">ReadRequest</span><span class="op" id="5530109">(</span><span class="ident" id="5530110"><a href="/net/http/httputil/persist.go.html#5529648">r</a></span><span class="op" id="5530111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530114"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5530116">.</span><span class="ident" id="5530117">lk</span><span class="op" id="5530119">.</span><span class="ident" id="5530120">Lock</span><span class="op" id="5530124">(</span><span class="op" id="5530125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530128">defer</span>&nbsp;<span class="ident" id="5530134"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5530136">.</span><span class="ident" id="5530137">lk</span><span class="op" id="5530139">.</span><span class="ident" id="5530140">Unlock</span><span class="op" id="5530146">(</span><span class="op" id="5530147">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530150">if</span>&nbsp;<span class="ident" id="5530153"><a href="/net/http/httputil/persist.go.html#5528985">err</a></span>&nbsp;<span class="op" id="5530157">!=</span>&nbsp;<span class="ident" id="5530160">nil</span>&nbsp;<span class="op" id="5530164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530168">if</span>&nbsp;<span class="ident" id="5530171"><a href="/net/http/httputil/persist.go.html#5528985">err</a></span>&nbsp;<span class="op" id="5530175">==</span>&nbsp;<span class="ident" id="5530178"><a href="/net/http/httputil/persist.go.html#5526337">io</a></span><span class="op" id="5530180">.</span><span class="ident" id="5530181">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="5530198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5530203">//&nbsp;A&nbsp;close&nbsp;from&nbsp;the&nbsp;opposing&nbsp;client&nbsp;is&nbsp;treated&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5530258">//&nbsp;graceful&nbsp;close,&nbsp;even&nbsp;if&nbsp;there&nbsp;was&nbsp;some&nbsp;unparse-able</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5530316">//&nbsp;data&nbsp;before&nbsp;the&nbsp;close.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530345"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5530347">.</span><span class="ident" id="5530348">re</span>&nbsp;<span class="op" id="5530351">=</span>&nbsp;<span class="ident" id="5530353"><a href="/net/http/httputil/persist.go.html#5526396">ErrPersistEOF</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530370">return</span>&nbsp;<span class="ident" id="5530377">nil</span><span class="op" id="5530380">,</span>&nbsp;<span class="ident" id="5530382"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5530384">.</span><span class="ident" id="5530385">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5530390">}</span>&nbsp;<span class="keyword" id="5530392">else</span>&nbsp;<span class="op" id="5530397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530402"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5530404">.</span><span class="ident" id="5530405">re</span>&nbsp;<span class="op" id="5530408">=</span>&nbsp;<span class="ident" id="5530410"><a href="/net/http/httputil/persist.go.html#5528985">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530417">return</span>&nbsp;<span class="ident" id="5530424"><a href="/net/http/httputil/persist.go.html#5528966">req</a></span><span class="op" id="5530427">,</span>&nbsp;<span class="ident" id="5530429"><a href="/net/http/httputil/persist.go.html#5528985">err</a></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5530435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5530438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530441"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5530443">.</span><span class="ident" id="5530444">lastbody</span>&nbsp;<span class="op" id="5530453">=</span>&nbsp;<span class="ident" id="5530455"><a href="/net/http/httputil/persist.go.html#5528966">req</a></span><span class="op" id="5530458">.</span><span class="ident" id="5530459">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530465"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5530467">.</span><span class="ident" id="5530468">nread</span><span class="op" id="5530473">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530477">if</span>&nbsp;<span class="ident" id="5530480"><a href="/net/http/httputil/persist.go.html#5528966">req</a></span><span class="op" id="5530483">.</span><span class="ident" id="5530484">Close</span>&nbsp;<span class="op" id="5530490">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530494"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5530496">.</span><span class="ident" id="5530497">re</span>&nbsp;<span class="op" id="5530500">=</span>&nbsp;<span class="ident" id="5530502"><a href="/net/http/httputil/persist.go.html#5526396">ErrPersistEOF</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530518">return</span>&nbsp;<span class="ident" id="5530525"><a href="/net/http/httputil/persist.go.html#5528966">req</a></span><span class="op" id="5530528">,</span>&nbsp;<span class="ident" id="5530530"><a href="/net/http/httputil/persist.go.html#5528942">sc</a></span><span class="op" id="5530532">.</span><span class="ident" id="5530533">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5530537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530540">return</span>&nbsp;<span class="ident" id="5530547"><a href="/net/http/httputil/persist.go.html#5528966">req</a></span><span class="op" id="5530550">,</span>&nbsp;<span class="ident" id="5530552"><a href="/net/http/httputil/persist.go.html#5528985">err</a></span><br>
<span class="lineno"></span><span class="op" id="5530556">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="5530559">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5530612">//&nbsp;that&nbsp;have&nbsp;been&nbsp;received&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5530658">func</span>&nbsp;<span class="op" id="5530663">(</span><span class="ident" id="5530664">sc</span>&nbsp;<span class="op" id="5530667">*</span><span class="ident" id="5530668"><a href="/net/http/httputil/persist.go.html#5527324">ServerConn</a></span><span class="op" id="5530678">)</span>&nbsp;<span class="ident" id="5530680">Pending</span><span class="op" id="5530687">(</span><span class="op" id="5530688">)</span>&nbsp;<span class="builtintype" id="5530690">int</span>&nbsp;<span class="op" id="5530694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530697"><a href="/net/http/httputil/persist.go.html#5530664">sc</a></span><span class="op" id="5530699">.</span><span class="ident" id="5530700">lk</span><span class="op" id="5530702">.</span><span class="ident" id="5530703">Lock</span><span class="op" id="5530707">(</span><span class="op" id="5530708">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530711">defer</span>&nbsp;<span class="ident" id="5530717"><a href="/net/http/httputil/persist.go.html#5530664">sc</a></span><span class="op" id="5530719">.</span><span class="ident" id="5530720">lk</span><span class="op" id="5530722">.</span><span class="ident" id="5530723">Unlock</span><span class="op" id="5530729">(</span><span class="op" id="5530730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530733">return</span>&nbsp;<span class="ident" id="5530740"><a href="/net/http/httputil/persist.go.html#5530664">sc</a></span><span class="op" id="5530742">.</span><span class="ident" id="5530743">nread</span>&nbsp;<span class="op" id="5530749">-</span>&nbsp;<span class="ident" id="5530751"><a href="/net/http/httputil/persist.go.html#5530664">sc</a></span><span class="op" id="5530753">.</span><span class="ident" id="5530754">nwritten</span><br>
<span class="lineno"></span><span class="op" id="5530763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5530766">//&nbsp;Write&nbsp;writes&nbsp;resp&nbsp;in&nbsp;response&nbsp;to&nbsp;req.&nbsp;To&nbsp;close&nbsp;the&nbsp;connection&nbsp;gracefully,&nbsp;set&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="5530851">//&nbsp;Response.Close&nbsp;field&nbsp;to&nbsp;true.&nbsp;Write&nbsp;should&nbsp;be&nbsp;considered&nbsp;operational&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="5530929">//&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,&nbsp;regardless&nbsp;of&nbsp;any&nbsp;errors&nbsp;returned&nbsp;on&nbsp;the&nbsp;Read&nbsp;side.</span><br>
<span class="lineno"></span><span class="keyword" id="5531005">func</span>&nbsp;<span class="op" id="5531010">(</span><span class="ident" id="5531011">sc</span>&nbsp;<span class="op" id="5531014">*</span><span class="ident" id="5531015"><a href="/net/http/httputil/persist.go.html#5527324">ServerConn</a></span><span class="op" id="5531025">)</span>&nbsp;<span class="ident" id="5531027">Write</span><span class="op" id="5531032">(</span><span class="ident" id="5531033">req</span>&nbsp;<span class="op" id="5531037">*</span><span class="ident" id="5531038"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5531042">.</span><span class="ident" id="5531043">Request</span><span class="op" id="5531050">,</span>&nbsp;<span class="ident" id="5531052">resp</span>&nbsp;<span class="op" id="5531057">*</span><span class="ident" id="5531058"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5531062">.</span><span class="ident" id="5531063">Response</span><span class="op" id="5531071">)</span>&nbsp;<span class="builtintype" id="5531073">error</span>&nbsp;<span class="op" id="5531079">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5531083">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531142"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531144">.</span><span class="ident" id="5531145">lk</span><span class="op" id="5531147">.</span><span class="ident" id="5531148">Lock</span><span class="op" id="5531152">(</span><span class="op" id="5531153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531156">id</span><span class="op" id="5531158">,</span>&nbsp;<span class="ident" id="5531160">ok</span>&nbsp;<span class="op" id="5531163">:=</span>&nbsp;<span class="ident" id="5531166"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531168">.</span><span class="ident" id="5531169">pipereq</span><span class="op" id="5531176">[</span><span class="ident" id="5531177"><a href="/net/http/httputil/persist.go.html#5531033">req</a></span><span class="op" id="5531180">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5531183">delete</span><span class="op" id="5531189">(</span><span class="ident" id="5531190"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531192">.</span><span class="ident" id="5531193">pipereq</span><span class="op" id="5531200">,</span>&nbsp;<span class="ident" id="5531202"><a href="/net/http/httputil/persist.go.html#5531033">req</a></span><span class="op" id="5531205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531208">if</span>&nbsp;<span class="op" id="5531211">!</span><span class="ident" id="5531212"><a href="/net/http/httputil/persist.go.html#5531160">ok</a></span>&nbsp;<span class="op" id="5531215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531219"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531221">.</span><span class="ident" id="5531222">lk</span><span class="op" id="5531224">.</span><span class="ident" id="5531225">Unlock</span><span class="op" id="5531231">(</span><span class="op" id="5531232">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531236">return</span>&nbsp;<span class="ident" id="5531243"><a href="/net/http/httputil/persist.go.html#5526557">ErrPipeline</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5531256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531259"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531261">.</span><span class="ident" id="5531262">lk</span><span class="op" id="5531264">.</span><span class="ident" id="5531265">Unlock</span><span class="op" id="5531271">(</span><span class="op" id="5531272">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5531276">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531302"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531304">.</span><span class="ident" id="5531305">pipe</span><span class="op" id="5531309">.</span><span class="ident" id="5531310">StartResponse</span><span class="op" id="5531323">(</span><span class="ident" id="5531324"><a href="/net/http/httputil/persist.go.html#5531156">id</a></span><span class="op" id="5531326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531329">defer</span>&nbsp;<span class="ident" id="5531335"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531337">.</span><span class="ident" id="5531338">pipe</span><span class="op" id="5531342">.</span><span class="ident" id="5531343">EndResponse</span><span class="op" id="5531354">(</span><span class="ident" id="5531355"><a href="/net/http/httputil/persist.go.html#5531156">id</a></span><span class="op" id="5531357">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531361"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531363">.</span><span class="ident" id="5531364">lk</span><span class="op" id="5531366">.</span><span class="ident" id="5531367">Lock</span><span class="op" id="5531371">(</span><span class="op" id="5531372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531375">if</span>&nbsp;<span class="ident" id="5531378"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531380">.</span><span class="ident" id="5531381">we</span>&nbsp;<span class="op" id="5531384">!=</span>&nbsp;<span class="ident" id="5531387">nil</span>&nbsp;<span class="op" id="5531391">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531395">defer</span>&nbsp;<span class="ident" id="5531401"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531403">.</span><span class="ident" id="5531404">lk</span><span class="op" id="5531406">.</span><span class="ident" id="5531407">Unlock</span><span class="op" id="5531413">(</span><span class="op" id="5531414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531418">return</span>&nbsp;<span class="ident" id="5531425"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531427">.</span><span class="ident" id="5531428">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5531432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531435">if</span>&nbsp;<span class="ident" id="5531438"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531440">.</span><span class="ident" id="5531441">c</span>&nbsp;<span class="op" id="5531443">==</span>&nbsp;<span class="ident" id="5531446">nil</span>&nbsp;<span class="op" id="5531450">{</span>&nbsp;<span class="comment" id="5531452">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531499">defer</span>&nbsp;<span class="ident" id="5531505"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531507">.</span><span class="ident" id="5531508">lk</span><span class="op" id="5531510">.</span><span class="ident" id="5531511">Unlock</span><span class="op" id="5531517">(</span><span class="op" id="5531518">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531522">return</span>&nbsp;<span class="ident" id="5531529"><a href="/net/http/httputil/persist.go.html#5526478">ErrClosed</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5531540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531543">c</span>&nbsp;<span class="op" id="5531545">:=</span>&nbsp;<span class="ident" id="5531548"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531550">.</span><span class="ident" id="5531551">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531554">if</span>&nbsp;<span class="ident" id="5531557"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531559">.</span><span class="ident" id="5531560">nread</span>&nbsp;<span class="op" id="5531566">&lt;=</span>&nbsp;<span class="ident" id="5531569"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531571">.</span><span class="ident" id="5531572">nwritten</span>&nbsp;<span class="op" id="5531581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531585">defer</span>&nbsp;<span class="ident" id="5531591"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531593">.</span><span class="ident" id="5531594">lk</span><span class="op" id="5531596">.</span><span class="ident" id="5531597">Unlock</span><span class="op" id="5531603">(</span><span class="op" id="5531604">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531608">return</span>&nbsp;<span class="ident" id="5531615"><a href="/net/http/httputil/persist.go.html#5526327">errors</a></span><span class="op" id="5531621">.</span><span class="ident" id="5531622">New</span><span class="op" id="5531625">(</span><span class="string" id="5531626">&#34;persist&nbsp;server&nbsp;pipe&nbsp;count&#34;</span><span class="op" id="5531653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5531656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531659">if</span>&nbsp;<span class="ident" id="5531662"><a href="/net/http/httputil/persist.go.html#5531052">resp</a></span><span class="op" id="5531666">.</span><span class="ident" id="5531667">Close</span>&nbsp;<span class="op" id="5531673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5531677">//&nbsp;After&nbsp;signaling&nbsp;a&nbsp;keep-alive&nbsp;close,&nbsp;any&nbsp;pipelined&nbsp;unread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5531739">//&nbsp;requests&nbsp;will&nbsp;be&nbsp;lost.&nbsp;It&nbsp;is&nbsp;up&nbsp;to&nbsp;the&nbsp;user&nbsp;to&nbsp;drain&nbsp;them</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5531802">//&nbsp;before&nbsp;signaling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531825"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531827">.</span><span class="ident" id="5531828">re</span>&nbsp;<span class="op" id="5531831">=</span>&nbsp;<span class="ident" id="5531833"><a href="/net/http/httputil/persist.go.html#5526396">ErrPersistEOF</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5531848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531851"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531853">.</span><span class="ident" id="5531854">lk</span><span class="op" id="5531856">.</span><span class="ident" id="5531857">Unlock</span><span class="op" id="5531863">(</span><span class="op" id="5531864">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531868">err</span>&nbsp;<span class="op" id="5531872">:=</span>&nbsp;<span class="ident" id="5531875"><a href="/net/http/httputil/persist.go.html#5531052">resp</a></span><span class="op" id="5531879">.</span><span class="ident" id="5531880">Write</span><span class="op" id="5531885">(</span><span class="ident" id="5531886"><a href="/net/http/httputil/persist.go.html#5531543">c</a></span><span class="op" id="5531887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531890"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531892">.</span><span class="ident" id="5531893">lk</span><span class="op" id="5531895">.</span><span class="ident" id="5531896">Lock</span><span class="op" id="5531900">(</span><span class="op" id="5531901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531904">defer</span>&nbsp;<span class="ident" id="5531910"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531912">.</span><span class="ident" id="5531913">lk</span><span class="op" id="5531915">.</span><span class="ident" id="5531916">Unlock</span><span class="op" id="5531922">(</span><span class="op" id="5531923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531926">if</span>&nbsp;<span class="ident" id="5531929"><a href="/net/http/httputil/persist.go.html#5531868">err</a></span>&nbsp;<span class="op" id="5531933">!=</span>&nbsp;<span class="ident" id="5531936">nil</span>&nbsp;<span class="op" id="5531940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531944"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531946">.</span><span class="ident" id="5531947">we</span>&nbsp;<span class="op" id="5531950">=</span>&nbsp;<span class="ident" id="5531952"><a href="/net/http/httputil/persist.go.html#5531868">err</a></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531958">return</span>&nbsp;<span class="ident" id="5531965"><a href="/net/http/httputil/persist.go.html#5531868">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5531970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5531973"><a href="/net/http/httputil/persist.go.html#5531011">sc</a></span><span class="op" id="5531975">.</span><span class="ident" id="5531976">nwritten</span><span class="op" id="5531984">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5531989">return</span>&nbsp;<span class="ident" id="5531996">nil</span><br>
<span class="lineno">220</span><span class="op" id="5532000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5532003">//&nbsp;A&nbsp;ClientConn&nbsp;sends&nbsp;request&nbsp;and&nbsp;receives&nbsp;headers&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="5532073">//&nbsp;connection,&nbsp;while&nbsp;respecting&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic.&nbsp;ClientConn</span><br>
<span class="lineno"></span><span class="comment" id="5532142">//&nbsp;supports&nbsp;hijacking&nbsp;the&nbsp;connection&nbsp;calling&nbsp;Hijack&nbsp;to</span><br>
<span class="lineno">225</span><span class="comment" id="5532197">//&nbsp;regain&nbsp;control&nbsp;of&nbsp;the&nbsp;underlying&nbsp;net.Conn&nbsp;and&nbsp;deal&nbsp;with&nbsp;it&nbsp;as&nbsp;desired.</span><br>
<span class="lineno"></span><span class="comment" id="5532271">//</span><br>
<span class="lineno"></span><span class="comment" id="5532274">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="5532342">//&nbsp;Client&nbsp;or&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5532390">type</span>&nbsp;<span class="ident" id="5532395">ClientConn</span>&nbsp;<span class="keyword" id="5532406">struct</span>&nbsp;<span class="op" id="5532413">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5532416">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5532432"><a href="/net/http/httputil/persist.go.html#5526379">sync</a></span><span class="op" id="5532436">.</span><span class="ident" id="5532437">Mutex</span>&nbsp;<span class="comment" id="5532443">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5532488">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5532504"><a href="/net/http/httputil/persist.go.html#5526343">net</a></span><span class="op" id="5532507">.</span><span class="ident" id="5532508">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5532514">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5532530">*</span><span class="ident" id="5532531"><a href="/net/http/httputil/persist.go.html#5526318">bufio</a></span><span class="op" id="5532536">.</span><span class="ident" id="5532537">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5532545">re</span><span class="op" id="5532547">,</span>&nbsp;<span class="ident" id="5532549">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5532561">error</span>&nbsp;<span class="comment" id="5532567">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5532589">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5532605"><a href="/net/http/httputil/persist.go.html#5526337">io</a></span><span class="op" id="5532607">.</span><span class="ident" id="5532608">ReadCloser</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5532620">nread</span><span class="op" id="5532625">,</span>&nbsp;<span class="ident" id="5532627">nwritten</span>&nbsp;<span class="builtintype" id="5532636">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5532641">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5532657">map</span><span class="op" id="5532660">[</span><span class="op" id="5532661">*</span><span class="ident" id="5532662"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5532666">.</span><span class="ident" id="5532667">Request</span><span class="op" id="5532674">]</span><span class="builtintype" id="5532675">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5532682">pipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5532691"><a href="/net/http/httputil/persist.go.html#5526362">textproto</a></span><span class="op" id="5532700">.</span><span class="ident" id="5532701">Pipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5532711">writeReq</span>&nbsp;<span class="keyword" id="5532720">func</span><span class="op" id="5532724">(</span><span class="op" id="5532725">*</span><span class="ident" id="5532726"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5532730">.</span><span class="ident" id="5532731">Request</span><span class="op" id="5532738">,</span>&nbsp;<span class="ident" id="5532740"><a href="/net/http/httputil/persist.go.html#5526337">io</a></span><span class="op" id="5532742">.</span><span class="ident" id="5532743">Writer</span><span class="op" id="5532749">)</span>&nbsp;<span class="builtintype" id="5532751">error</span><br>
<span class="lineno">240</span><span class="op" id="5532757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5532760">//&nbsp;NewClientConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ClientConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="5532838">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno"></span><span class="comment" id="5532886">//</span><br>
<span class="lineno">245</span><span class="comment" id="5532889">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;use&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5532959">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5532997">func</span>&nbsp;<span class="ident" id="5533002">NewClientConn</span><span class="op" id="5533015">(</span><span class="ident" id="5533016">c</span>&nbsp;<span class="ident" id="5533018"><a href="/net/http/httputil/persist.go.html#5526343">net</a></span><span class="op" id="5533021">.</span><span class="ident" id="5533022">Conn</span><span class="op" id="5533026">,</span>&nbsp;<span class="ident" id="5533028">r</span>&nbsp;<span class="op" id="5533030">*</span><span class="ident" id="5533031"><a href="/net/http/httputil/persist.go.html#5526318">bufio</a></span><span class="op" id="5533036">.</span><span class="ident" id="5533037">Reader</span><span class="op" id="5533043">)</span>&nbsp;<span class="op" id="5533045">*</span><span class="ident" id="5533046"><a href="/net/http/httputil/persist.go.html#5532395">ClientConn</a></span>&nbsp;<span class="op" id="5533057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5533060">if</span>&nbsp;<span class="ident" id="5533063"><a href="/net/http/httputil/persist.go.html#5533028">r</a></span>&nbsp;<span class="op" id="5533065">==</span>&nbsp;<span class="ident" id="5533068">nil</span>&nbsp;<span class="op" id="5533072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5533076"><a href="/net/http/httputil/persist.go.html#5533028">r</a></span>&nbsp;<span class="op" id="5533078">=</span>&nbsp;<span class="ident" id="5533080"><a href="/net/http/httputil/persist.go.html#5526318">bufio</a></span><span class="op" id="5533085">.</span><span class="ident" id="5533086">NewReader</span><span class="op" id="5533095">(</span><span class="ident" id="5533096"><a href="/net/http/httputil/persist.go.html#5533016">c</a></span><span class="op" id="5533097">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5533100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5533103">return</span>&nbsp;<span class="op" id="5533110">&amp;</span><span class="ident" id="5533111"><a href="/net/http/httputil/persist.go.html#5532395">ClientConn</a></span><span class="op" id="5533121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5533125">c</span><span class="op" id="5533126">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5533135"><a href="/net/http/httputil/persist.go.html#5533016">c</a></span><span class="op" id="5533136">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5533140">r</span><span class="op" id="5533141">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5533150"><a href="/net/http/httputil/persist.go.html#5533028">r</a></span><span class="op" id="5533151">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5533155">pipereq</span><span class="op" id="5533162">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5533165">make</span><span class="op" id="5533169">(</span><span class="keyword" id="5533170">map</span><span class="op" id="5533173">[</span><span class="op" id="5533174">*</span><span class="ident" id="5533175"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5533179">.</span><span class="ident" id="5533180">Request</span><span class="op" id="5533187">]</span><span class="builtintype" id="5533188">uint</span><span class="op" id="5533192">)</span><span class="op" id="5533193">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5533197">writeReq</span><span class="op" id="5533205">:</span>&nbsp;<span class="op" id="5533207">(</span><span class="op" id="5533208">*</span><span class="ident" id="5533209"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5533213">.</span><span class="ident" id="5533214">Request</span><span class="op" id="5533221">)</span><span class="op" id="5533222">.</span><span class="ident" id="5533223">Write</span><span class="op" id="5533228">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5533231">}</span><br>
<span class="lineno"></span><span class="op" id="5533233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5533236">//&nbsp;NewProxyClientConn&nbsp;works&nbsp;like&nbsp;NewClientConn&nbsp;but&nbsp;writes&nbsp;Requests</span><br>
<span class="lineno">260</span><span class="comment" id="5533303">//&nbsp;using&nbsp;Request&#39;s&nbsp;WriteProxy&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="5533341">//</span><br>
<span class="lineno"></span><span class="comment" id="5533344">//&nbsp;New&nbsp;code&nbsp;should&nbsp;not&nbsp;use&nbsp;NewProxyClientConn.&nbsp;See&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5533405">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="5533451">func</span>&nbsp;<span class="ident" id="5533456">NewProxyClientConn</span><span class="op" id="5533474">(</span><span class="ident" id="5533475">c</span>&nbsp;<span class="ident" id="5533477"><a href="/net/http/httputil/persist.go.html#5526343">net</a></span><span class="op" id="5533480">.</span><span class="ident" id="5533481">Conn</span><span class="op" id="5533485">,</span>&nbsp;<span class="ident" id="5533487">r</span>&nbsp;<span class="op" id="5533489">*</span><span class="ident" id="5533490"><a href="/net/http/httputil/persist.go.html#5526318">bufio</a></span><span class="op" id="5533495">.</span><span class="ident" id="5533496">Reader</span><span class="op" id="5533502">)</span>&nbsp;<span class="op" id="5533504">*</span><span class="ident" id="5533505"><a href="/net/http/httputil/persist.go.html#5532395">ClientConn</a></span>&nbsp;<span class="op" id="5533516">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5533519">cc</span>&nbsp;<span class="op" id="5533522">:=</span>&nbsp;<span class="ident" id="5533525"><a href="/net/http/httputil/persist.go.html#5533002">NewClientConn</a></span><span class="op" id="5533538">(</span><span class="ident" id="5533539"><a href="/net/http/httputil/persist.go.html#5533475">c</a></span><span class="op" id="5533540">,</span>&nbsp;<span class="ident" id="5533542"><a href="/net/http/httputil/persist.go.html#5533487">r</a></span><span class="op" id="5533543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5533546"><a href="/net/http/httputil/persist.go.html#5533519">cc</a></span><span class="op" id="5533548">.</span><span class="ident" id="5533549">writeReq</span>&nbsp;<span class="op" id="5533558">=</span>&nbsp;<span class="op" id="5533560">(</span><span class="op" id="5533561">*</span><span class="ident" id="5533562"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5533566">.</span><span class="ident" id="5533567">Request</span><span class="op" id="5533574">)</span><span class="op" id="5533575">.</span><span class="ident" id="5533576">WriteProxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5533588">return</span>&nbsp;<span class="ident" id="5533595"><a href="/net/http/httputil/persist.go.html#5533519">cc</a></span><br>
<span class="lineno"></span><span class="op" id="5533598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="5533601">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ClientConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="5533681">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5533757">//&nbsp;called&nbsp;before&nbsp;the&nbsp;user&nbsp;or&nbsp;Read&nbsp;have&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive</span><br>
<span class="lineno"></span><span class="comment" id="5533831">//&nbsp;logic.&nbsp;The&nbsp;user&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="5533909">func</span>&nbsp;<span class="op" id="5533914">(</span><span class="ident" id="5533915">cc</span>&nbsp;<span class="op" id="5533918">*</span><span class="ident" id="5533919"><a href="/net/http/httputil/persist.go.html#5532395">ClientConn</a></span><span class="op" id="5533929">)</span>&nbsp;<span class="ident" id="5533931">Hijack</span><span class="op" id="5533937">(</span><span class="op" id="5533938">)</span>&nbsp;<span class="op" id="5533940">(</span><span class="ident" id="5533941">c</span>&nbsp;<span class="ident" id="5533943"><a href="/net/http/httputil/persist.go.html#5526343">net</a></span><span class="op" id="5533946">.</span><span class="ident" id="5533947">Conn</span><span class="op" id="5533951">,</span>&nbsp;<span class="ident" id="5533953">r</span>&nbsp;<span class="op" id="5533955">*</span><span class="ident" id="5533956"><a href="/net/http/httputil/persist.go.html#5526318">bufio</a></span><span class="op" id="5533961">.</span><span class="ident" id="5533962">Reader</span><span class="op" id="5533968">)</span>&nbsp;<span class="op" id="5533970">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5533973"><a href="/net/http/httputil/persist.go.html#5533915">cc</a></span><span class="op" id="5533975">.</span><span class="ident" id="5533976">lk</span><span class="op" id="5533978">.</span><span class="ident" id="5533979">Lock</span><span class="op" id="5533983">(</span><span class="op" id="5533984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5533987">defer</span>&nbsp;<span class="ident" id="5533993"><a href="/net/http/httputil/persist.go.html#5533915">cc</a></span><span class="op" id="5533995">.</span><span class="ident" id="5533996">lk</span><span class="op" id="5533998">.</span><span class="ident" id="5533999">Unlock</span><span class="op" id="5534005">(</span><span class="op" id="5534006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534009"><a href="/net/http/httputil/persist.go.html#5533941">c</a></span>&nbsp;<span class="op" id="5534011">=</span>&nbsp;<span class="ident" id="5534013"><a href="/net/http/httputil/persist.go.html#5533915">cc</a></span><span class="op" id="5534015">.</span><span class="ident" id="5534016">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534019"><a href="/net/http/httputil/persist.go.html#5533953">r</a></span>&nbsp;<span class="op" id="5534021">=</span>&nbsp;<span class="ident" id="5534023"><a href="/net/http/httputil/persist.go.html#5533915">cc</a></span><span class="op" id="5534025">.</span><span class="ident" id="5534026">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534029"><a href="/net/http/httputil/persist.go.html#5533915">cc</a></span><span class="op" id="5534031">.</span><span class="ident" id="5534032">c</span>&nbsp;<span class="op" id="5534034">=</span>&nbsp;<span class="ident" id="5534036">nil</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534041"><a href="/net/http/httputil/persist.go.html#5533915">cc</a></span><span class="op" id="5534043">.</span><span class="ident" id="5534044">r</span>&nbsp;<span class="op" id="5534046">=</span>&nbsp;<span class="ident" id="5534048">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534053">return</span><br>
<span class="lineno"></span><span class="op" id="5534060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5534063">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">285</span><span class="keyword" id="5534132">func</span>&nbsp;<span class="op" id="5534137">(</span><span class="ident" id="5534138">cc</span>&nbsp;<span class="op" id="5534141">*</span><span class="ident" id="5534142"><a href="/net/http/httputil/persist.go.html#5532395">ClientConn</a></span><span class="op" id="5534152">)</span>&nbsp;<span class="ident" id="5534154">Close</span><span class="op" id="5534159">(</span><span class="op" id="5534160">)</span>&nbsp;<span class="builtintype" id="5534162">error</span>&nbsp;<span class="op" id="5534168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534171">c</span><span class="op" id="5534172">,</span>&nbsp;<span class="ident" id="5534174">_</span>&nbsp;<span class="op" id="5534176">:=</span>&nbsp;<span class="ident" id="5534179"><a href="/net/http/httputil/persist.go.html#5534138">cc</a></span><span class="op" id="5534181">.</span><span class="ident" id="5534182">Hijack</span><span class="op" id="5534188">(</span><span class="op" id="5534189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534192">if</span>&nbsp;<span class="ident" id="5534195"><a href="/net/http/httputil/persist.go.html#5534171">c</a></span>&nbsp;<span class="op" id="5534197">!=</span>&nbsp;<span class="ident" id="5534200">nil</span>&nbsp;<span class="op" id="5534204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534208">return</span>&nbsp;<span class="ident" id="5534215"><a href="/net/http/httputil/persist.go.html#5534171">c</a></span><span class="op" id="5534216">.</span><span class="ident" id="5534217">Close</span><span class="op" id="5534222">(</span><span class="op" id="5534223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5534226">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534229">return</span>&nbsp;<span class="ident" id="5534236">nil</span><br>
<span class="lineno"></span><span class="op" id="5534240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5534243">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;request.&nbsp;An&nbsp;ErrPersistEOF&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5534323">//&nbsp;has&nbsp;been&nbsp;closed&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;keepalive&nbsp;sense.&nbsp;If&nbsp;req.Close&nbsp;equals&nbsp;true,&nbsp;the</span><br>
<span class="lineno">295</span><span class="comment" id="5534400">//&nbsp;keepalive&nbsp;connection&nbsp;is&nbsp;logically&nbsp;closed&nbsp;after&nbsp;this&nbsp;request&nbsp;and&nbsp;the&nbsp;opposing</span><br>
<span class="lineno"></span><span class="comment" id="5534480">//&nbsp;server&nbsp;is&nbsp;informed.&nbsp;An&nbsp;ErrUnexpectedEOF&nbsp;indicates&nbsp;the&nbsp;remote&nbsp;closed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5534555">//&nbsp;underlying&nbsp;TCP&nbsp;connection,&nbsp;which&nbsp;is&nbsp;usually&nbsp;considered&nbsp;as&nbsp;graceful&nbsp;close.</span><br>
<span class="lineno"></span><span class="keyword" id="5534632">func</span>&nbsp;<span class="op" id="5534637">(</span><span class="ident" id="5534638">cc</span>&nbsp;<span class="op" id="5534641">*</span><span class="ident" id="5534642"><a href="/net/http/httputil/persist.go.html#5532395">ClientConn</a></span><span class="op" id="5534652">)</span>&nbsp;<span class="ident" id="5534654">Write</span><span class="op" id="5534659">(</span><span class="ident" id="5534660">req</span>&nbsp;<span class="op" id="5534664">*</span><span class="ident" id="5534665"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5534669">.</span><span class="ident" id="5534670">Request</span><span class="op" id="5534677">)</span>&nbsp;<span class="op" id="5534679">(</span><span class="ident" id="5534680">err</span>&nbsp;<span class="builtintype" id="5534684">error</span><span class="op" id="5534689">)</span>&nbsp;<span class="op" id="5534691">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5534695">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534734">id</span>&nbsp;<span class="op" id="5534737">:=</span>&nbsp;<span class="ident" id="5534740"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5534742">.</span><span class="ident" id="5534743">pipe</span><span class="op" id="5534747">.</span><span class="ident" id="5534748">Next</span><span class="op" id="5534752">(</span><span class="op" id="5534753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534756"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5534758">.</span><span class="ident" id="5534759">pipe</span><span class="op" id="5534763">.</span><span class="ident" id="5534764">StartRequest</span><span class="op" id="5534776">(</span><span class="ident" id="5534777"><a href="/net/http/httputil/persist.go.html#5534734">id</a></span><span class="op" id="5534779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534782">defer</span>&nbsp;<span class="keyword" id="5534788">func</span><span class="op" id="5534792">(</span><span class="op" id="5534793">)</span>&nbsp;<span class="op" id="5534795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534799"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5534801">.</span><span class="ident" id="5534802">pipe</span><span class="op" id="5534806">.</span><span class="ident" id="5534807">EndRequest</span><span class="op" id="5534817">(</span><span class="ident" id="5534818"><a href="/net/http/httputil/persist.go.html#5534734">id</a></span><span class="op" id="5534820">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5534824">if</span>&nbsp;<span class="ident" id="5534827"><a href="/net/http/httputil/persist.go.html#5534680">err</a></span>&nbsp;<span class="op" id="5534831">!=</span>&nbsp;<span class="ident" id="5534834">nil</span>&nbsp;<span class="op" id="5534838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534843"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5534845">.</span><span class="ident" id="5534846">pipe</span><span class="op" id="5534850">.</span><span class="ident" id="5534851">StartResponse</span><span class="op" id="5534864">(</span><span class="ident" id="5534865"><a href="/net/http/httputil/persist.go.html#5534734">id</a></span><span class="op" id="5534867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534872"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5534874">.</span><span class="ident" id="5534875">pipe</span><span class="op" id="5534879">.</span><span class="ident" id="5534880">EndResponse</span><span class="op" id="5534891">(</span><span class="ident" id="5534892"><a href="/net/http/httputil/persist.go.html#5534734">id</a></span><span class="op" id="5534894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5534898">}</span>&nbsp;<span class="keyword" id="5534900">else</span>&nbsp;<span class="op" id="5534905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5534910">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534957"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5534959">.</span><span class="ident" id="5534960">lk</span><span class="op" id="5534962">.</span><span class="ident" id="5534963">Lock</span><span class="op" id="5534967">(</span><span class="op" id="5534968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534973"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5534975">.</span><span class="ident" id="5534976">pipereq</span><span class="op" id="5534983">[</span><span class="ident" id="5534984"><a href="/net/http/httputil/persist.go.html#5534660">req</a></span><span class="op" id="5534987">]</span>&nbsp;<span class="op" id="5534989">=</span>&nbsp;<span class="ident" id="5534991"><a href="/net/http/httputil/persist.go.html#5534734">id</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5534997"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5534999">.</span><span class="ident" id="5535000">lk</span><span class="op" id="5535002">.</span><span class="ident" id="5535003">Unlock</span><span class="op" id="5535009">(</span><span class="op" id="5535010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5535014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5535017">}</span><span class="op" id="5535018">(</span><span class="op" id="5535019">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535023"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535025">.</span><span class="ident" id="5535026">lk</span><span class="op" id="5535028">.</span><span class="ident" id="5535029">Lock</span><span class="op" id="5535033">(</span><span class="op" id="5535034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535037">if</span>&nbsp;<span class="ident" id="5535040"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535042">.</span><span class="ident" id="5535043">re</span>&nbsp;<span class="op" id="5535046">!=</span>&nbsp;<span class="ident" id="5535049">nil</span>&nbsp;<span class="op" id="5535053">{</span>&nbsp;<span class="comment" id="5535055">//&nbsp;no&nbsp;point&nbsp;sending&nbsp;if&nbsp;read-side&nbsp;closed&nbsp;or&nbsp;broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535107">defer</span>&nbsp;<span class="ident" id="5535113"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535115">.</span><span class="ident" id="5535116">lk</span><span class="op" id="5535118">.</span><span class="ident" id="5535119">Unlock</span><span class="op" id="5535125">(</span><span class="op" id="5535126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535130">return</span>&nbsp;<span class="ident" id="5535137"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535139">.</span><span class="ident" id="5535140">re</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5535144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535147">if</span>&nbsp;<span class="ident" id="5535150"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535152">.</span><span class="ident" id="5535153">we</span>&nbsp;<span class="op" id="5535156">!=</span>&nbsp;<span class="ident" id="5535159">nil</span>&nbsp;<span class="op" id="5535163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535167">defer</span>&nbsp;<span class="ident" id="5535173"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535175">.</span><span class="ident" id="5535176">lk</span><span class="op" id="5535178">.</span><span class="ident" id="5535179">Unlock</span><span class="op" id="5535185">(</span><span class="op" id="5535186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535190">return</span>&nbsp;<span class="ident" id="5535197"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535199">.</span><span class="ident" id="5535200">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5535204">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535207">if</span>&nbsp;<span class="ident" id="5535210"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535212">.</span><span class="ident" id="5535213">c</span>&nbsp;<span class="op" id="5535215">==</span>&nbsp;<span class="ident" id="5535218">nil</span>&nbsp;<span class="op" id="5535222">{</span>&nbsp;<span class="comment" id="5535224">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535271">defer</span>&nbsp;<span class="ident" id="5535277"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535279">.</span><span class="ident" id="5535280">lk</span><span class="op" id="5535282">.</span><span class="ident" id="5535283">Unlock</span><span class="op" id="5535289">(</span><span class="op" id="5535290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535294">return</span>&nbsp;<span class="ident" id="5535301"><a href="/net/http/httputil/persist.go.html#5526754">errClosed</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5535312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535315">c</span>&nbsp;<span class="op" id="5535317">:=</span>&nbsp;<span class="ident" id="5535320"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535322">.</span><span class="ident" id="5535323">c</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535326">if</span>&nbsp;<span class="ident" id="5535329"><a href="/net/http/httputil/persist.go.html#5534660">req</a></span><span class="op" id="5535332">.</span><span class="ident" id="5535333">Close</span>&nbsp;<span class="op" id="5535339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5535343">//&nbsp;We&nbsp;write&nbsp;the&nbsp;EOF&nbsp;to&nbsp;the&nbsp;write-side&nbsp;error,&nbsp;because&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5535404">//&nbsp;still&nbsp;might&nbsp;be&nbsp;some&nbsp;pipelined&nbsp;reads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535445"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535447">.</span><span class="ident" id="5535448">we</span>&nbsp;<span class="op" id="5535451">=</span>&nbsp;<span class="ident" id="5535453"><a href="/net/http/httputil/persist.go.html#5526396">ErrPersistEOF</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5535468">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535471"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535473">.</span><span class="ident" id="5535474">lk</span><span class="op" id="5535476">.</span><span class="ident" id="5535477">Unlock</span><span class="op" id="5535483">(</span><span class="op" id="5535484">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535488"><a href="/net/http/httputil/persist.go.html#5534680">err</a></span>&nbsp;<span class="op" id="5535492">=</span>&nbsp;<span class="ident" id="5535494"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535496">.</span><span class="ident" id="5535497">writeReq</span><span class="op" id="5535505">(</span><span class="ident" id="5535506"><a href="/net/http/httputil/persist.go.html#5534660">req</a></span><span class="op" id="5535509">,</span>&nbsp;<span class="ident" id="5535511"><a href="/net/http/httputil/persist.go.html#5535315">c</a></span><span class="op" id="5535512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535515"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535517">.</span><span class="ident" id="5535518">lk</span><span class="op" id="5535520">.</span><span class="ident" id="5535521">Lock</span><span class="op" id="5535525">(</span><span class="op" id="5535526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535529">defer</span>&nbsp;<span class="ident" id="5535535"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535537">.</span><span class="ident" id="5535538">lk</span><span class="op" id="5535540">.</span><span class="ident" id="5535541">Unlock</span><span class="op" id="5535547">(</span><span class="op" id="5535548">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535551">if</span>&nbsp;<span class="ident" id="5535554"><a href="/net/http/httputil/persist.go.html#5534680">err</a></span>&nbsp;<span class="op" id="5535558">!=</span>&nbsp;<span class="ident" id="5535561">nil</span>&nbsp;<span class="op" id="5535565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535569"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535571">.</span><span class="ident" id="5535572">we</span>&nbsp;<span class="op" id="5535575">=</span>&nbsp;<span class="ident" id="5535577"><a href="/net/http/httputil/persist.go.html#5534680">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535583">return</span>&nbsp;<span class="ident" id="5535590"><a href="/net/http/httputil/persist.go.html#5534680">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5535595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535598"><a href="/net/http/httputil/persist.go.html#5534638">cc</a></span><span class="op" id="5535600">.</span><span class="ident" id="5535601">nwritten</span><span class="op" id="5535609">++</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535614">return</span>&nbsp;<span class="ident" id="5535621">nil</span><br>
<span class="lineno"></span><span class="op" id="5535625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5535628">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno">350</span><span class="comment" id="5535681">//&nbsp;that&nbsp;have&nbsp;been&nbsp;sent&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5535723">func</span>&nbsp;<span class="op" id="5535728">(</span><span class="ident" id="5535729">cc</span>&nbsp;<span class="op" id="5535732">*</span><span class="ident" id="5535733"><a href="/net/http/httputil/persist.go.html#5532395">ClientConn</a></span><span class="op" id="5535743">)</span>&nbsp;<span class="ident" id="5535745">Pending</span><span class="op" id="5535752">(</span><span class="op" id="5535753">)</span>&nbsp;<span class="builtintype" id="5535755">int</span>&nbsp;<span class="op" id="5535759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5535762"><a href="/net/http/httputil/persist.go.html#5535729">cc</a></span><span class="op" id="5535764">.</span><span class="ident" id="5535765">lk</span><span class="op" id="5535767">.</span><span class="ident" id="5535768">Lock</span><span class="op" id="5535772">(</span><span class="op" id="5535773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535776">defer</span>&nbsp;<span class="ident" id="5535782"><a href="/net/http/httputil/persist.go.html#5535729">cc</a></span><span class="op" id="5535784">.</span><span class="ident" id="5535785">lk</span><span class="op" id="5535787">.</span><span class="ident" id="5535788">Unlock</span><span class="op" id="5535794">(</span><span class="op" id="5535795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5535798">return</span>&nbsp;<span class="ident" id="5535805"><a href="/net/http/httputil/persist.go.html#5535729">cc</a></span><span class="op" id="5535807">.</span><span class="ident" id="5535808">nwritten</span>&nbsp;<span class="op" id="5535817">-</span>&nbsp;<span class="ident" id="5535819"><a href="/net/http/httputil/persist.go.html#5535729">cc</a></span><span class="op" id="5535821">.</span><span class="ident" id="5535822">nread</span><br>
<span class="lineno">355</span><span class="op" id="5535828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5535831">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;next&nbsp;response&nbsp;from&nbsp;the&nbsp;wire.&nbsp;A&nbsp;valid&nbsp;response&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5535904">//&nbsp;returned&nbsp;together&nbsp;with&nbsp;an&nbsp;ErrPersistEOF,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;remote</span><br>
<span class="lineno"></span><span class="comment" id="5535976">//&nbsp;requested&nbsp;that&nbsp;this&nbsp;be&nbsp;the&nbsp;last&nbsp;request&nbsp;serviced.&nbsp;Read&nbsp;can&nbsp;be&nbsp;called</span><br>
<span class="lineno">360</span><span class="comment" id="5536048">//&nbsp;concurrently&nbsp;with&nbsp;Write,&nbsp;but&nbsp;not&nbsp;with&nbsp;another&nbsp;Read.</span><br>
<span class="lineno"></span><span class="keyword" id="5536103">func</span>&nbsp;<span class="op" id="5536108">(</span><span class="ident" id="5536109">cc</span>&nbsp;<span class="op" id="5536112">*</span><span class="ident" id="5536113"><a href="/net/http/httputil/persist.go.html#5532395">ClientConn</a></span><span class="op" id="5536123">)</span>&nbsp;<span class="ident" id="5536125">Read</span><span class="op" id="5536129">(</span><span class="ident" id="5536130">req</span>&nbsp;<span class="op" id="5536134">*</span><span class="ident" id="5536135"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5536139">.</span><span class="ident" id="5536140">Request</span><span class="op" id="5536147">)</span>&nbsp;<span class="op" id="5536149">(</span><span class="ident" id="5536150">resp</span>&nbsp;<span class="op" id="5536155">*</span><span class="ident" id="5536156"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5536160">.</span><span class="ident" id="5536161">Response</span><span class="op" id="5536169">,</span>&nbsp;<span class="ident" id="5536171">err</span>&nbsp;<span class="builtintype" id="5536175">error</span><span class="op" id="5536180">)</span>&nbsp;<span class="op" id="5536182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5536185">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536244"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536246">.</span><span class="ident" id="5536247">lk</span><span class="op" id="5536249">.</span><span class="ident" id="5536250">Lock</span><span class="op" id="5536254">(</span><span class="op" id="5536255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536258">id</span><span class="op" id="5536260">,</span>&nbsp;<span class="ident" id="5536262">ok</span>&nbsp;<span class="op" id="5536265">:=</span>&nbsp;<span class="ident" id="5536268"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536270">.</span><span class="ident" id="5536271">pipereq</span><span class="op" id="5536278">[</span><span class="ident" id="5536279"><a href="/net/http/httputil/persist.go.html#5536130">req</a></span><span class="op" id="5536282">]</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5536285">delete</span><span class="op" id="5536291">(</span><span class="ident" id="5536292"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536294">.</span><span class="ident" id="5536295">pipereq</span><span class="op" id="5536302">,</span>&nbsp;<span class="ident" id="5536304"><a href="/net/http/httputil/persist.go.html#5536130">req</a></span><span class="op" id="5536307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536310">if</span>&nbsp;<span class="op" id="5536313">!</span><span class="ident" id="5536314"><a href="/net/http/httputil/persist.go.html#5536262">ok</a></span>&nbsp;<span class="op" id="5536317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536321"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536323">.</span><span class="ident" id="5536324">lk</span><span class="op" id="5536326">.</span><span class="ident" id="5536327">Unlock</span><span class="op" id="5536333">(</span><span class="op" id="5536334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536338">return</span>&nbsp;<span class="ident" id="5536345">nil</span><span class="op" id="5536348">,</span>&nbsp;<span class="ident" id="5536350"><a href="/net/http/httputil/persist.go.html#5526557">ErrPipeline</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5536363">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536366"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536368">.</span><span class="ident" id="5536369">lk</span><span class="op" id="5536371">.</span><span class="ident" id="5536372">Unlock</span><span class="op" id="5536378">(</span><span class="op" id="5536379">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5536383">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536409"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536411">.</span><span class="ident" id="5536412">pipe</span><span class="op" id="5536416">.</span><span class="ident" id="5536417">StartResponse</span><span class="op" id="5536430">(</span><span class="ident" id="5536431"><a href="/net/http/httputil/persist.go.html#5536258">id</a></span><span class="op" id="5536433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536436">defer</span>&nbsp;<span class="ident" id="5536442"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536444">.</span><span class="ident" id="5536445">pipe</span><span class="op" id="5536449">.</span><span class="ident" id="5536450">EndResponse</span><span class="op" id="5536461">(</span><span class="ident" id="5536462"><a href="/net/http/httputil/persist.go.html#5536258">id</a></span><span class="op" id="5536464">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536468"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536470">.</span><span class="ident" id="5536471">lk</span><span class="op" id="5536473">.</span><span class="ident" id="5536474">Lock</span><span class="op" id="5536478">(</span><span class="op" id="5536479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536482">if</span>&nbsp;<span class="ident" id="5536485"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536487">.</span><span class="ident" id="5536488">re</span>&nbsp;<span class="op" id="5536491">!=</span>&nbsp;<span class="ident" id="5536494">nil</span>&nbsp;<span class="op" id="5536498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536502">defer</span>&nbsp;<span class="ident" id="5536508"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536510">.</span><span class="ident" id="5536511">lk</span><span class="op" id="5536513">.</span><span class="ident" id="5536514">Unlock</span><span class="op" id="5536520">(</span><span class="op" id="5536521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536525">return</span>&nbsp;<span class="ident" id="5536532">nil</span><span class="op" id="5536535">,</span>&nbsp;<span class="ident" id="5536537"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536539">.</span><span class="ident" id="5536540">re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5536544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536547">if</span>&nbsp;<span class="ident" id="5536550"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536552">.</span><span class="ident" id="5536553">r</span>&nbsp;<span class="op" id="5536555">==</span>&nbsp;<span class="ident" id="5536558">nil</span>&nbsp;<span class="op" id="5536562">{</span>&nbsp;<span class="comment" id="5536564">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536611">defer</span>&nbsp;<span class="ident" id="5536617"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536619">.</span><span class="ident" id="5536620">lk</span><span class="op" id="5536622">.</span><span class="ident" id="5536623">Unlock</span><span class="op" id="5536629">(</span><span class="op" id="5536630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536634">return</span>&nbsp;<span class="ident" id="5536641">nil</span><span class="op" id="5536644">,</span>&nbsp;<span class="ident" id="5536646"><a href="/net/http/httputil/persist.go.html#5526754">errClosed</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5536657">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536660">r</span>&nbsp;<span class="op" id="5536662">:=</span>&nbsp;<span class="ident" id="5536665"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536667">.</span><span class="ident" id="5536668">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536671">lastbody</span>&nbsp;<span class="op" id="5536680">:=</span>&nbsp;<span class="ident" id="5536683"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536685">.</span><span class="ident" id="5536686">lastbody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536696"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536698">.</span><span class="ident" id="5536699">lastbody</span>&nbsp;<span class="op" id="5536708">=</span>&nbsp;<span class="ident" id="5536710">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536715"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5536717">.</span><span class="ident" id="5536718">lk</span><span class="op" id="5536720">.</span><span class="ident" id="5536721">Unlock</span><span class="op" id="5536727">(</span><span class="op" id="5536728">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5536732">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536808">if</span>&nbsp;<span class="ident" id="5536811"><a href="/net/http/httputil/persist.go.html#5536671">lastbody</a></span>&nbsp;<span class="op" id="5536820">!=</span>&nbsp;<span class="ident" id="5536823">nil</span>&nbsp;<span class="op" id="5536827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5536831">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5536897">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5536955">//&nbsp;returned.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5536970"><a href="/net/http/httputil/persist.go.html#5536171">err</a></span>&nbsp;<span class="op" id="5536974">=</span>&nbsp;<span class="ident" id="5536976"><a href="/net/http/httputil/persist.go.html#5536671">lastbody</a></span><span class="op" id="5536984">.</span><span class="ident" id="5536985">Close</span><span class="op" id="5536990">(</span><span class="op" id="5536991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5536995">if</span>&nbsp;<span class="ident" id="5536998"><a href="/net/http/httputil/persist.go.html#5536171">err</a></span>&nbsp;<span class="op" id="5537002">!=</span>&nbsp;<span class="ident" id="5537005">nil</span>&nbsp;<span class="op" id="5537009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537014"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5537016">.</span><span class="ident" id="5537017">lk</span><span class="op" id="5537019">.</span><span class="ident" id="5537020">Lock</span><span class="op" id="5537024">(</span><span class="op" id="5537025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537030">defer</span>&nbsp;<span class="ident" id="5537036"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5537038">.</span><span class="ident" id="5537039">lk</span><span class="op" id="5537041">.</span><span class="ident" id="5537042">Unlock</span><span class="op" id="5537048">(</span><span class="op" id="5537049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537054"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5537056">.</span><span class="ident" id="5537057">re</span>&nbsp;<span class="op" id="5537060">=</span>&nbsp;<span class="ident" id="5537062"><a href="/net/http/httputil/persist.go.html#5536171">err</a></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537069">return</span>&nbsp;<span class="ident" id="5537076">nil</span><span class="op" id="5537079">,</span>&nbsp;<span class="ident" id="5537081"><a href="/net/http/httputil/persist.go.html#5536171">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5537087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5537090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537094"><a href="/net/http/httputil/persist.go.html#5536150">resp</a></span><span class="op" id="5537098">,</span>&nbsp;<span class="ident" id="5537100"><a href="/net/http/httputil/persist.go.html#5536171">err</a></span>&nbsp;<span class="op" id="5537104">=</span>&nbsp;<span class="ident" id="5537106"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5537110">.</span><span class="ident" id="5537111">ReadResponse</span><span class="op" id="5537123">(</span><span class="ident" id="5537124"><a href="/net/http/httputil/persist.go.html#5536660">r</a></span><span class="op" id="5537125">,</span>&nbsp;<span class="ident" id="5537127"><a href="/net/http/httputil/persist.go.html#5536130">req</a></span><span class="op" id="5537130">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537133"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5537135">.</span><span class="ident" id="5537136">lk</span><span class="op" id="5537138">.</span><span class="ident" id="5537139">Lock</span><span class="op" id="5537143">(</span><span class="op" id="5537144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537147">defer</span>&nbsp;<span class="ident" id="5537153"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5537155">.</span><span class="ident" id="5537156">lk</span><span class="op" id="5537158">.</span><span class="ident" id="5537159">Unlock</span><span class="op" id="5537165">(</span><span class="op" id="5537166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537169">if</span>&nbsp;<span class="ident" id="5537172"><a href="/net/http/httputil/persist.go.html#5536171">err</a></span>&nbsp;<span class="op" id="5537176">!=</span>&nbsp;<span class="ident" id="5537179">nil</span>&nbsp;<span class="op" id="5537183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537187"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5537189">.</span><span class="ident" id="5537190">re</span>&nbsp;<span class="op" id="5537193">=</span>&nbsp;<span class="ident" id="5537195"><a href="/net/http/httputil/persist.go.html#5536171">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537201">return</span>&nbsp;<span class="ident" id="5537208"><a href="/net/http/httputil/persist.go.html#5536150">resp</a></span><span class="op" id="5537212">,</span>&nbsp;<span class="ident" id="5537214"><a href="/net/http/httputil/persist.go.html#5536171">err</a></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5537219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537222"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5537224">.</span><span class="ident" id="5537225">lastbody</span>&nbsp;<span class="op" id="5537234">=</span>&nbsp;<span class="ident" id="5537236"><a href="/net/http/httputil/persist.go.html#5536150">resp</a></span><span class="op" id="5537240">.</span><span class="ident" id="5537241">Body</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537248"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5537250">.</span><span class="ident" id="5537251">nread</span><span class="op" id="5537256">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537261">if</span>&nbsp;<span class="ident" id="5537264"><a href="/net/http/httputil/persist.go.html#5536150">resp</a></span><span class="op" id="5537268">.</span><span class="ident" id="5537269">Close</span>&nbsp;<span class="op" id="5537275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537279"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5537281">.</span><span class="ident" id="5537282">re</span>&nbsp;<span class="op" id="5537285">=</span>&nbsp;<span class="ident" id="5537287"><a href="/net/http/httputil/persist.go.html#5526396">ErrPersistEOF</a></span>&nbsp;<span class="comment" id="5537301">//&nbsp;don&#39;t&nbsp;send&nbsp;any&nbsp;more&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537335">return</span>&nbsp;<span class="ident" id="5537342"><a href="/net/http/httputil/persist.go.html#5536150">resp</a></span><span class="op" id="5537346">,</span>&nbsp;<span class="ident" id="5537348"><a href="/net/http/httputil/persist.go.html#5536109">cc</a></span><span class="op" id="5537350">.</span><span class="ident" id="5537351">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5537355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537358">return</span>&nbsp;<span class="ident" id="5537365"><a href="/net/http/httputil/persist.go.html#5536150">resp</a></span><span class="op" id="5537369">,</span>&nbsp;<span class="ident" id="5537371"><a href="/net/http/httputil/persist.go.html#5536171">err</a></span><br>
<span class="lineno">420</span><span class="op" id="5537375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5537378">//&nbsp;Do&nbsp;is&nbsp;convenience&nbsp;method&nbsp;that&nbsp;writes&nbsp;a&nbsp;request&nbsp;and&nbsp;reads&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="5537450">func</span>&nbsp;<span class="op" id="5537455">(</span><span class="ident" id="5537456">cc</span>&nbsp;<span class="op" id="5537459">*</span><span class="ident" id="5537460"><a href="/net/http/httputil/persist.go.html#5532395">ClientConn</a></span><span class="op" id="5537470">)</span>&nbsp;<span class="ident" id="5537472">Do</span><span class="op" id="5537474">(</span><span class="ident" id="5537475">req</span>&nbsp;<span class="op" id="5537479">*</span><span class="ident" id="5537480"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5537484">.</span><span class="ident" id="5537485">Request</span><span class="op" id="5537492">)</span>&nbsp;<span class="op" id="5537494">(</span><span class="ident" id="5537495">resp</span>&nbsp;<span class="op" id="5537500">*</span><span class="ident" id="5537501"><a href="/net/http/httputil/persist.go.html#5526350">http</a></span><span class="op" id="5537505">.</span><span class="ident" id="5537506">Response</span><span class="op" id="5537514">,</span>&nbsp;<span class="ident" id="5537516">err</span>&nbsp;<span class="builtintype" id="5537520">error</span><span class="op" id="5537525">)</span>&nbsp;<span class="op" id="5537527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5537530"><a href="/net/http/httputil/persist.go.html#5537516">err</a></span>&nbsp;<span class="op" id="5537534">=</span>&nbsp;<span class="ident" id="5537536"><a href="/net/http/httputil/persist.go.html#5537456">cc</a></span><span class="op" id="5537538">.</span><span class="ident" id="5537539">Write</span><span class="op" id="5537544">(</span><span class="ident" id="5537545"><a href="/net/http/httputil/persist.go.html#5537475">req</a></span><span class="op" id="5537548">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537551">if</span>&nbsp;<span class="ident" id="5537554"><a href="/net/http/httputil/persist.go.html#5537516">err</a></span>&nbsp;<span class="op" id="5537558">!=</span>&nbsp;<span class="ident" id="5537561">nil</span>&nbsp;<span class="op" id="5537565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537569">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5537577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5537580">return</span>&nbsp;<span class="ident" id="5537587"><a href="/net/http/httputil/persist.go.html#5537456">cc</a></span><span class="op" id="5537589">.</span><span class="ident" id="5537590">Read</span><span class="op" id="5537594">(</span><span class="ident" id="5537595"><a href="/net/http/httputil/persist.go.html#5537475">req</a></span><span class="op" id="5537598">)</span><br>
<span class="lineno"></span><span class="op" id="5537600">}</span>
</div>
</body>
</html>
