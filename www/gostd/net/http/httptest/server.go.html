<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httptest</h2>
<ul>
<li><a href="/gostd/net/http/httptest/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder.go.html">recorder.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder_test.go.html">recorder_test.go</a></li>
<li><a href="/gostd/net/http/httptest/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/http/httptest/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6023815">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6023870">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6023924">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6023975">//&nbsp;Implementation&nbsp;of&nbsp;Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6024004">package</span>&nbsp;<span class="ident" id="6024012">httptest</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6024022">import</span>&nbsp;<span class="op" id="6024029">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6024032">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6024046">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6024054">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6024061">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6024068">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6024080">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6024086">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="6024093">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6024096">//&nbsp;A&nbsp;Server&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;server&nbsp;listening&nbsp;on&nbsp;a&nbsp;system-chosen&nbsp;port&nbsp;on&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="6024167">//&nbsp;local&nbsp;loopback&nbsp;interface,&nbsp;for&nbsp;use&nbsp;in&nbsp;end-to-end&nbsp;HTTP&nbsp;tests.</span><br>
<span class="lineno"></span><span class="keyword" id="6024230">type</span>&nbsp;<span class="ident" id="6024235">Server</span>&nbsp;<span class="keyword" id="6024242">struct</span>&nbsp;<span class="op" id="6024249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024252">URL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6024261">string</span>&nbsp;<span class="comment" id="6024268">//&nbsp;base&nbsp;URL&nbsp;of&nbsp;form&nbsp;http://ipaddr:port&nbsp;with&nbsp;no&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024331">Listener</span>&nbsp;<span class="ident" id="6024340">net</span><span class="op" id="6024343">.</span><span class="ident" id="6024344">Listener</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6024355">//&nbsp;TLS&nbsp;is&nbsp;the&nbsp;optional&nbsp;TLS&nbsp;configuration,&nbsp;populated&nbsp;with&nbsp;a&nbsp;new&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6024426">//&nbsp;after&nbsp;TLS&nbsp;is&nbsp;started.&nbsp;If&nbsp;set&nbsp;on&nbsp;an&nbsp;unstarted&nbsp;server&nbsp;before&nbsp;StartTLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6024498">//&nbsp;is&nbsp;called,&nbsp;existing&nbsp;fields&nbsp;are&nbsp;copied&nbsp;into&nbsp;the&nbsp;new&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024561">TLS</span>&nbsp;<span class="op" id="6024565">*</span><span class="ident" id="6024566">tls</span><span class="op" id="6024569">.</span><span class="ident" id="6024570">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6024579">//&nbsp;Config&nbsp;may&nbsp;be&nbsp;changed&nbsp;after&nbsp;calling&nbsp;NewUnstartedServer&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6024642">//&nbsp;before&nbsp;Start&nbsp;or&nbsp;StartTLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024672">Config</span>&nbsp;<span class="op" id="6024679">*</span><span class="ident" id="6024680">http</span><span class="op" id="6024684">.</span><span class="ident" id="6024685">Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6024694">//&nbsp;wg&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;HTTP&nbsp;requests&nbsp;on&nbsp;this&nbsp;server.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6024764">//&nbsp;Close&nbsp;blocks&nbsp;until&nbsp;all&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024814">wg</span>&nbsp;<span class="ident" id="6024817">sync</span><span class="op" id="6024821">.</span><span class="ident" id="6024822">WaitGroup</span><br>
<span class="lineno"></span><span class="op" id="6024832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6024835">//&nbsp;historyListener&nbsp;keeps&nbsp;track&nbsp;of&nbsp;all&nbsp;connections&nbsp;that&nbsp;it&#39;s&nbsp;ever</span><br>
<span class="lineno">40</span><span class="comment" id="6024900">//&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="6024913">type</span>&nbsp;<span class="ident" id="6024918">historyListener</span>&nbsp;<span class="keyword" id="6024934">struct</span>&nbsp;<span class="op" id="6024941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024944">net</span><span class="op" id="6024947">.</span><span class="ident" id="6024948">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024958">sync</span><span class="op" id="6024962">.</span><span class="ident" id="6024963">Mutex</span>&nbsp;<span class="comment" id="6024969">//&nbsp;protects&nbsp;history</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024990">history</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6025001">[</span><span class="op" id="6025002">]</span><span class="ident" id="6025003">net</span><span class="op" id="6025006">.</span><span class="ident" id="6025007">Conn</span><br>
<span class="lineno">45</span><span class="op" id="6025012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6025015">func</span>&nbsp;<span class="op" id="6025020">(</span><span class="ident" id="6025021">hs</span>&nbsp;<span class="op" id="6025024">*</span><span class="ident" id="6025025">historyListener</span><span class="op" id="6025040">)</span>&nbsp;<span class="ident" id="6025042">Accept</span><span class="op" id="6025048">(</span><span class="op" id="6025049">)</span>&nbsp;<span class="op" id="6025051">(</span><span class="ident" id="6025052">c</span>&nbsp;<span class="ident" id="6025054">net</span><span class="op" id="6025057">.</span><span class="ident" id="6025058">Conn</span><span class="op" id="6025062">,</span>&nbsp;<span class="ident" id="6025064">err</span>&nbsp;<span class="builtintype" id="6025068">error</span><span class="op" id="6025073">)</span>&nbsp;<span class="op" id="6025075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025078">c</span><span class="op" id="6025079">,</span>&nbsp;<span class="ident" id="6025081">err</span>&nbsp;<span class="op" id="6025085">=</span>&nbsp;<span class="ident" id="6025087">hs</span><span class="op" id="6025089">.</span><span class="ident" id="6025090">Listener</span><span class="op" id="6025098">.</span><span class="ident" id="6025099">Accept</span><span class="op" id="6025105">(</span><span class="op" id="6025106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025109">if</span>&nbsp;<span class="ident" id="6025112">err</span>&nbsp;<span class="op" id="6025116">==</span>&nbsp;<span class="builtintype" id="6025119">nil</span>&nbsp;<span class="op" id="6025123">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025127">hs</span><span class="op" id="6025129">.</span><span class="ident" id="6025130">Lock</span><span class="op" id="6025134">(</span><span class="op" id="6025135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025139">hs</span><span class="op" id="6025141">.</span><span class="ident" id="6025142">history</span>&nbsp;<span class="op" id="6025150">=</span>&nbsp;<span class="builtinfunc" id="6025152">append</span><span class="op" id="6025158">(</span><span class="ident" id="6025159">hs</span><span class="op" id="6025161">.</span><span class="ident" id="6025162">history</span><span class="op" id="6025169">,</span>&nbsp;<span class="ident" id="6025171">c</span><span class="op" id="6025172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025176">hs</span><span class="op" id="6025178">.</span><span class="ident" id="6025179">Unlock</span><span class="op" id="6025185">(</span><span class="op" id="6025186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6025189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025192">return</span><br>
<span class="lineno">55</span><span class="op" id="6025199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6025202">func</span>&nbsp;<span class="ident" id="6025207">newLocalListener</span><span class="op" id="6025223">(</span><span class="op" id="6025224">)</span>&nbsp;<span class="ident" id="6025226">net</span><span class="op" id="6025229">.</span><span class="ident" id="6025230">Listener</span>&nbsp;<span class="op" id="6025239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025242">if</span>&nbsp;<span class="op" id="6025245">*</span><span class="ident" id="6025246">serve</span>&nbsp;<span class="op" id="6025252">!=</span>&nbsp;<span class="string" id="6025255">&#34;&#34;</span>&nbsp;<span class="op" id="6025258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025262">l</span><span class="op" id="6025263">,</span>&nbsp;<span class="ident" id="6025265">err</span>&nbsp;<span class="op" id="6025269">:=</span>&nbsp;<span class="ident" id="6025272">net</span><span class="op" id="6025275">.</span><span class="ident" id="6025276">Listen</span><span class="op" id="6025282">(</span><span class="string" id="6025283">&#34;tcp&#34;</span><span class="op" id="6025288">,</span>&nbsp;<span class="op" id="6025290">*</span><span class="ident" id="6025291">serve</span><span class="op" id="6025296">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025300">if</span>&nbsp;<span class="ident" id="6025303">err</span>&nbsp;<span class="op" id="6025307">!=</span>&nbsp;<span class="builtintype" id="6025310">nil</span>&nbsp;<span class="op" id="6025314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6025319">panic</span><span class="op" id="6025324">(</span><span class="ident" id="6025325">fmt</span><span class="op" id="6025328">.</span><span class="ident" id="6025329">Sprintf</span><span class="op" id="6025336">(</span><span class="string" id="6025337">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;%v:&nbsp;%v&#34;</span><span class="op" id="6025375">,</span>&nbsp;<span class="op" id="6025377">*</span><span class="ident" id="6025378">serve</span><span class="op" id="6025383">,</span>&nbsp;<span class="ident" id="6025385">err</span><span class="op" id="6025388">)</span><span class="op" id="6025389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6025393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025397">return</span>&nbsp;<span class="ident" id="6025404">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6025407">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025410">l</span><span class="op" id="6025411">,</span>&nbsp;<span class="ident" id="6025413">err</span>&nbsp;<span class="op" id="6025417">:=</span>&nbsp;<span class="ident" id="6025420">net</span><span class="op" id="6025423">.</span><span class="ident" id="6025424">Listen</span><span class="op" id="6025430">(</span><span class="string" id="6025431">&#34;tcp&#34;</span><span class="op" id="6025436">,</span>&nbsp;<span class="string" id="6025438">&#34;127.0.0.1:0&#34;</span><span class="op" id="6025451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025454">if</span>&nbsp;<span class="ident" id="6025457">err</span>&nbsp;<span class="op" id="6025461">!=</span>&nbsp;<span class="builtintype" id="6025464">nil</span>&nbsp;<span class="op" id="6025468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025472">if</span>&nbsp;<span class="ident" id="6025475">l</span><span class="op" id="6025476">,</span>&nbsp;<span class="ident" id="6025478">err</span>&nbsp;<span class="op" id="6025482">=</span>&nbsp;<span class="ident" id="6025484">net</span><span class="op" id="6025487">.</span><span class="ident" id="6025488">Listen</span><span class="op" id="6025494">(</span><span class="string" id="6025495">&#34;tcp6&#34;</span><span class="op" id="6025501">,</span>&nbsp;<span class="string" id="6025503">&#34;[::1]:0&#34;</span><span class="op" id="6025512">)</span><span class="op" id="6025513">;</span>&nbsp;<span class="ident" id="6025515">err</span>&nbsp;<span class="op" id="6025519">!=</span>&nbsp;<span class="builtintype" id="6025522">nil</span>&nbsp;<span class="op" id="6025526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6025531">panic</span><span class="op" id="6025536">(</span><span class="ident" id="6025537">fmt</span><span class="op" id="6025540">.</span><span class="ident" id="6025541">Sprintf</span><span class="op" id="6025548">(</span><span class="string" id="6025549">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;a&nbsp;port:&nbsp;%v&#34;</span><span class="op" id="6025591">,</span>&nbsp;<span class="ident" id="6025593">err</span><span class="op" id="6025596">)</span><span class="op" id="6025597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6025601">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6025604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025607">return</span>&nbsp;<span class="ident" id="6025614">l</span><br>
<span class="lineno"></span><span class="op" id="6025616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6025619">//&nbsp;When&nbsp;debugging&nbsp;a&nbsp;particular&nbsp;http&nbsp;server-based&nbsp;test,</span><br>
<span class="lineno">75</span><span class="comment" id="6025674">//&nbsp;this&nbsp;flag&nbsp;lets&nbsp;you&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="6025700">//&nbsp;&nbsp;&nbsp;&nbsp;go&nbsp;test&nbsp;-run=BrokenTest&nbsp;-httptest.serve=127.0.0.1:8000</span><br>
<span class="lineno"></span><span class="comment" id="6025758">//&nbsp;to&nbsp;start&nbsp;the&nbsp;broken&nbsp;server&nbsp;so&nbsp;you&nbsp;can&nbsp;interact&nbsp;with&nbsp;it&nbsp;manually.</span><br>
<span class="lineno"></span><span class="keyword" id="6025826">var</span>&nbsp;<span class="ident" id="6025830">serve</span>&nbsp;<span class="op" id="6025836">=</span>&nbsp;<span class="ident" id="6025838">flag</span><span class="op" id="6025842">.</span><span class="ident" id="6025843">String</span><span class="op" id="6025849">(</span><span class="string" id="6025850">&#34;httptest.serve&#34;</span><span class="op" id="6025866">,</span>&nbsp;<span class="string" id="6025868">&#34;&#34;</span><span class="op" id="6025870">,</span>&nbsp;<span class="string" id="6025872">&#34;if&nbsp;non-empty,&nbsp;httptest.NewServer&nbsp;serves&nbsp;on&nbsp;this&nbsp;address&nbsp;and&nbsp;blocks&#34;</span><span class="op" id="6025940">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="6025943">//&nbsp;NewServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="6025989">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="6026053">func</span>&nbsp;<span class="ident" id="6026058">NewServer</span><span class="op" id="6026067">(</span><span class="ident" id="6026068">handler</span>&nbsp;<span class="ident" id="6026076">http</span><span class="op" id="6026080">.</span><span class="ident" id="6026081">Handler</span><span class="op" id="6026088">)</span>&nbsp;<span class="op" id="6026090">*</span><span class="ident" id="6026091">Server</span>&nbsp;<span class="op" id="6026098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026101">ts</span>&nbsp;<span class="op" id="6026104">:=</span>&nbsp;<span class="ident" id="6026107">NewUnstartedServer</span><span class="op" id="6026125">(</span><span class="ident" id="6026126">handler</span><span class="op" id="6026133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026136">ts</span><span class="op" id="6026138">.</span><span class="ident" id="6026139">Start</span><span class="op" id="6026144">(</span><span class="op" id="6026145">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6026148">return</span>&nbsp;<span class="ident" id="6026155">ts</span><br>
<span class="lineno"></span><span class="op" id="6026158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6026161">//&nbsp;NewUnstartedServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;but&nbsp;doesn&#39;t&nbsp;start&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="6026226">//</span><br>
<span class="lineno">90</span><span class="comment" id="6026229">//&nbsp;After&nbsp;changing&nbsp;its&nbsp;configuration,&nbsp;the&nbsp;caller&nbsp;should&nbsp;call&nbsp;Start&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6026298">//&nbsp;StartTLS.</span><br>
<span class="lineno"></span><span class="comment" id="6026311">//</span><br>
<span class="lineno"></span><span class="comment" id="6026314">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="6026378">func</span>&nbsp;<span class="ident" id="6026383">NewUnstartedServer</span><span class="op" id="6026401">(</span><span class="ident" id="6026402">handler</span>&nbsp;<span class="ident" id="6026410">http</span><span class="op" id="6026414">.</span><span class="ident" id="6026415">Handler</span><span class="op" id="6026422">)</span>&nbsp;<span class="op" id="6026424">*</span><span class="ident" id="6026425">Server</span>&nbsp;<span class="op" id="6026432">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6026435">return</span>&nbsp;<span class="op" id="6026442">&amp;</span><span class="ident" id="6026443">Server</span><span class="op" id="6026449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026453">Listener</span><span class="op" id="6026461">:</span>&nbsp;<span class="ident" id="6026463">newLocalListener</span><span class="op" id="6026479">(</span><span class="op" id="6026480">)</span><span class="op" id="6026481">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026485">Config</span><span class="op" id="6026491">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6026495">&amp;</span><span class="ident" id="6026496">http</span><span class="op" id="6026500">.</span><span class="ident" id="6026501">Server</span><span class="op" id="6026507">{</span><span class="ident" id="6026508">Handler</span><span class="op" id="6026515">:</span>&nbsp;<span class="ident" id="6026517">handler</span><span class="op" id="6026524">}</span><span class="op" id="6026525">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6026528">}</span><br>
<span class="lineno"></span><span class="op" id="6026530">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="6026533">//&nbsp;Start&nbsp;starts&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="6026583">func</span>&nbsp;<span class="op" id="6026588">(</span><span class="ident" id="6026589">s</span>&nbsp;<span class="op" id="6026591">*</span><span class="ident" id="6026592">Server</span><span class="op" id="6026598">)</span>&nbsp;<span class="ident" id="6026600">Start</span><span class="op" id="6026605">(</span><span class="op" id="6026606">)</span>&nbsp;<span class="op" id="6026608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6026611">if</span>&nbsp;<span class="ident" id="6026614">s</span><span class="op" id="6026615">.</span><span class="ident" id="6026616">URL</span>&nbsp;<span class="op" id="6026620">!=</span>&nbsp;<span class="string" id="6026623">&#34;&#34;</span>&nbsp;<span class="op" id="6026626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6026630">panic</span><span class="op" id="6026635">(</span><span class="string" id="6026636">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="6026660">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6026663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026666">s</span><span class="op" id="6026667">.</span><span class="ident" id="6026668">Listener</span>&nbsp;<span class="op" id="6026677">=</span>&nbsp;<span class="op" id="6026679">&amp;</span><span class="ident" id="6026680">historyListener</span><span class="op" id="6026695">{</span><span class="ident" id="6026696">Listener</span><span class="op" id="6026704">:</span>&nbsp;<span class="ident" id="6026706">s</span><span class="op" id="6026707">.</span><span class="ident" id="6026708">Listener</span><span class="op" id="6026716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026719">s</span><span class="op" id="6026720">.</span><span class="ident" id="6026721">URL</span>&nbsp;<span class="op" id="6026725">=</span>&nbsp;<span class="string" id="6026727">&#34;http://&#34;</span>&nbsp;<span class="op" id="6026737">+</span>&nbsp;<span class="ident" id="6026739">s</span><span class="op" id="6026740">.</span><span class="ident" id="6026741">Listener</span><span class="op" id="6026749">.</span><span class="ident" id="6026750">Addr</span><span class="op" id="6026754">(</span><span class="op" id="6026755">)</span><span class="op" id="6026756">.</span><span class="ident" id="6026757">String</span><span class="op" id="6026763">(</span><span class="op" id="6026764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026767">s</span><span class="op" id="6026768">.</span><span class="ident" id="6026769">wrapHandler</span><span class="op" id="6026780">(</span><span class="op" id="6026781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6026784">go</span>&nbsp;<span class="ident" id="6026787">s</span><span class="op" id="6026788">.</span><span class="ident" id="6026789">Config</span><span class="op" id="6026795">.</span><span class="ident" id="6026796">Serve</span><span class="op" id="6026801">(</span><span class="ident" id="6026802">s</span><span class="op" id="6026803">.</span><span class="ident" id="6026804">Listener</span><span class="op" id="6026812">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6026815">if</span>&nbsp;<span class="op" id="6026818">*</span><span class="ident" id="6026819">serve</span>&nbsp;<span class="op" id="6026825">!=</span>&nbsp;<span class="string" id="6026828">&#34;&#34;</span>&nbsp;<span class="op" id="6026831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026835">fmt</span><span class="op" id="6026838">.</span><span class="ident" id="6026839">Fprintln</span><span class="op" id="6026847">(</span><span class="ident" id="6026848">os</span><span class="op" id="6026850">.</span><span class="ident" id="6026851">Stderr</span><span class="op" id="6026857">,</span>&nbsp;<span class="string" id="6026859">&#34;httptest:&nbsp;serving&nbsp;on&#34;</span><span class="op" id="6026881">,</span>&nbsp;<span class="ident" id="6026883">s</span><span class="op" id="6026884">.</span><span class="ident" id="6026885">URL</span><span class="op" id="6026888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6026892">select</span>&nbsp;<span class="op" id="6026899">{</span><span class="op" id="6026900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6026903">}</span><br>
<span class="lineno"></span><span class="op" id="6026905">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="6026908">//&nbsp;StartTLS&nbsp;starts&nbsp;TLS&nbsp;on&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="6026968">func</span>&nbsp;<span class="op" id="6026973">(</span><span class="ident" id="6026974">s</span>&nbsp;<span class="op" id="6026976">*</span><span class="ident" id="6026977">Server</span><span class="op" id="6026983">)</span>&nbsp;<span class="ident" id="6026985">StartTLS</span><span class="op" id="6026993">(</span><span class="op" id="6026994">)</span>&nbsp;<span class="op" id="6026996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6026999">if</span>&nbsp;<span class="ident" id="6027002">s</span><span class="op" id="6027003">.</span><span class="ident" id="6027004">URL</span>&nbsp;<span class="op" id="6027008">!=</span>&nbsp;<span class="string" id="6027011">&#34;&#34;</span>&nbsp;<span class="op" id="6027014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6027018">panic</span><span class="op" id="6027023">(</span><span class="string" id="6027024">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="6027048">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6027051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027054">cert</span><span class="op" id="6027058">,</span>&nbsp;<span class="ident" id="6027060">err</span>&nbsp;<span class="op" id="6027064">:=</span>&nbsp;<span class="ident" id="6027067">tls</span><span class="op" id="6027070">.</span><span class="ident" id="6027071">X509KeyPair</span><span class="op" id="6027082">(</span><span class="ident" id="6027083">localhostCert</span><span class="op" id="6027096">,</span>&nbsp;<span class="ident" id="6027098">localhostKey</span><span class="op" id="6027110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6027113">if</span>&nbsp;<span class="ident" id="6027116">err</span>&nbsp;<span class="op" id="6027120">!=</span>&nbsp;<span class="builtintype" id="6027123">nil</span>&nbsp;<span class="op" id="6027127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6027131">panic</span><span class="op" id="6027136">(</span><span class="ident" id="6027137">fmt</span><span class="op" id="6027140">.</span><span class="ident" id="6027141">Sprintf</span><span class="op" id="6027148">(</span><span class="string" id="6027149">&#34;httptest:&nbsp;NewTLSServer:&nbsp;%v&#34;</span><span class="op" id="6027177">,</span>&nbsp;<span class="ident" id="6027179">err</span><span class="op" id="6027182">)</span><span class="op" id="6027183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6027186">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027190">existingConfig</span>&nbsp;<span class="op" id="6027205">:=</span>&nbsp;<span class="ident" id="6027208">s</span><span class="op" id="6027209">.</span><span class="ident" id="6027210">TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027215">s</span><span class="op" id="6027216">.</span><span class="ident" id="6027217">TLS</span>&nbsp;<span class="op" id="6027221">=</span>&nbsp;<span class="builtinfunc" id="6027223">new</span><span class="op" id="6027226">(</span><span class="ident" id="6027227">tls</span><span class="op" id="6027230">.</span><span class="ident" id="6027231">Config</span><span class="op" id="6027237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6027240">if</span>&nbsp;<span class="ident" id="6027243">existingConfig</span>&nbsp;<span class="op" id="6027258">!=</span>&nbsp;<span class="builtintype" id="6027261">nil</span>&nbsp;<span class="op" id="6027265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6027269">*</span><span class="ident" id="6027270">s</span><span class="op" id="6027271">.</span><span class="ident" id="6027272">TLS</span>&nbsp;<span class="op" id="6027276">=</span>&nbsp;<span class="op" id="6027278">*</span><span class="ident" id="6027279">existingConfig</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6027295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6027298">if</span>&nbsp;<span class="ident" id="6027301">s</span><span class="op" id="6027302">.</span><span class="ident" id="6027303">TLS</span><span class="op" id="6027306">.</span><span class="ident" id="6027307">NextProtos</span>&nbsp;<span class="op" id="6027318">==</span>&nbsp;<span class="builtintype" id="6027321">nil</span>&nbsp;<span class="op" id="6027325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027329">s</span><span class="op" id="6027330">.</span><span class="ident" id="6027331">TLS</span><span class="op" id="6027334">.</span><span class="ident" id="6027335">NextProtos</span>&nbsp;<span class="op" id="6027346">=</span>&nbsp;<span class="op" id="6027348">[</span><span class="op" id="6027349">]</span><span class="builtintype" id="6027350">string</span><span class="op" id="6027356">{</span><span class="string" id="6027357">&#34;http/1.1&#34;</span><span class="op" id="6027367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6027370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6027373">if</span>&nbsp;<span class="builtinfunc" id="6027376">len</span><span class="op" id="6027379">(</span><span class="ident" id="6027380">s</span><span class="op" id="6027381">.</span><span class="ident" id="6027382">TLS</span><span class="op" id="6027385">.</span><span class="ident" id="6027386">Certificates</span><span class="op" id="6027398">)</span>&nbsp;<span class="op" id="6027400">==</span>&nbsp;<span class="num" id="6027403">0</span>&nbsp;<span class="op" id="6027405">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027409">s</span><span class="op" id="6027410">.</span><span class="ident" id="6027411">TLS</span><span class="op" id="6027414">.</span><span class="ident" id="6027415">Certificates</span>&nbsp;<span class="op" id="6027428">=</span>&nbsp;<span class="op" id="6027430">[</span><span class="op" id="6027431">]</span><span class="ident" id="6027432">tls</span><span class="op" id="6027435">.</span><span class="ident" id="6027436">Certificate</span><span class="op" id="6027447">{</span><span class="ident" id="6027448">cert</span><span class="op" id="6027452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6027455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027458">tlsListener</span>&nbsp;<span class="op" id="6027470">:=</span>&nbsp;<span class="ident" id="6027473">tls</span><span class="op" id="6027476">.</span><span class="ident" id="6027477">NewListener</span><span class="op" id="6027488">(</span><span class="ident" id="6027489">s</span><span class="op" id="6027490">.</span><span class="ident" id="6027491">Listener</span><span class="op" id="6027499">,</span>&nbsp;<span class="ident" id="6027501">s</span><span class="op" id="6027502">.</span><span class="ident" id="6027503">TLS</span><span class="op" id="6027506">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027510">s</span><span class="op" id="6027511">.</span><span class="ident" id="6027512">Listener</span>&nbsp;<span class="op" id="6027521">=</span>&nbsp;<span class="op" id="6027523">&amp;</span><span class="ident" id="6027524">historyListener</span><span class="op" id="6027539">{</span><span class="ident" id="6027540">Listener</span><span class="op" id="6027548">:</span>&nbsp;<span class="ident" id="6027550">tlsListener</span><span class="op" id="6027561">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027564">s</span><span class="op" id="6027565">.</span><span class="ident" id="6027566">URL</span>&nbsp;<span class="op" id="6027570">=</span>&nbsp;<span class="string" id="6027572">&#34;https://&#34;</span>&nbsp;<span class="op" id="6027583">+</span>&nbsp;<span class="ident" id="6027585">s</span><span class="op" id="6027586">.</span><span class="ident" id="6027587">Listener</span><span class="op" id="6027595">.</span><span class="ident" id="6027596">Addr</span><span class="op" id="6027600">(</span><span class="op" id="6027601">)</span><span class="op" id="6027602">.</span><span class="ident" id="6027603">String</span><span class="op" id="6027609">(</span><span class="op" id="6027610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027613">s</span><span class="op" id="6027614">.</span><span class="ident" id="6027615">wrapHandler</span><span class="op" id="6027626">(</span><span class="op" id="6027627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6027630">go</span>&nbsp;<span class="ident" id="6027633">s</span><span class="op" id="6027634">.</span><span class="ident" id="6027635">Config</span><span class="op" id="6027641">.</span><span class="ident" id="6027642">Serve</span><span class="op" id="6027647">(</span><span class="ident" id="6027648">s</span><span class="op" id="6027649">.</span><span class="ident" id="6027650">Listener</span><span class="op" id="6027658">)</span><br>
<span class="lineno"></span><span class="op" id="6027660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6027663">func</span>&nbsp;<span class="op" id="6027668">(</span><span class="ident" id="6027669">s</span>&nbsp;<span class="op" id="6027671">*</span><span class="ident" id="6027672">Server</span><span class="op" id="6027678">)</span>&nbsp;<span class="ident" id="6027680">wrapHandler</span><span class="op" id="6027691">(</span><span class="op" id="6027692">)</span>&nbsp;<span class="op" id="6027694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027697">h</span>&nbsp;<span class="op" id="6027699">:=</span>&nbsp;<span class="ident" id="6027702">s</span><span class="op" id="6027703">.</span><span class="ident" id="6027704">Config</span><span class="op" id="6027710">.</span><span class="ident" id="6027711">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6027720">if</span>&nbsp;<span class="ident" id="6027723">h</span>&nbsp;<span class="op" id="6027725">==</span>&nbsp;<span class="builtintype" id="6027728">nil</span>&nbsp;<span class="op" id="6027732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027736">h</span>&nbsp;<span class="op" id="6027738">=</span>&nbsp;<span class="ident" id="6027740">http</span><span class="op" id="6027744">.</span><span class="ident" id="6027745">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6027762">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027765">s</span><span class="op" id="6027766">.</span><span class="ident" id="6027767">Config</span><span class="op" id="6027773">.</span><span class="ident" id="6027774">Handler</span>&nbsp;<span class="op" id="6027782">=</span>&nbsp;<span class="op" id="6027784">&amp;</span><span class="ident" id="6027785">waitGroupHandler</span><span class="op" id="6027801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027805">s</span><span class="op" id="6027806">:</span>&nbsp;<span class="ident" id="6027808">s</span><span class="op" id="6027809">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027813">h</span><span class="op" id="6027814">:</span>&nbsp;<span class="ident" id="6027816">h</span><span class="op" id="6027817">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6027820">}</span><br>
<span class="lineno"></span><span class="op" id="6027822">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="6027825">//&nbsp;NewTLSServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;using&nbsp;TLS.</span><br>
<span class="lineno"></span><span class="comment" id="6027884">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="6027948">func</span>&nbsp;<span class="ident" id="6027953">NewTLSServer</span><span class="op" id="6027965">(</span><span class="ident" id="6027966">handler</span>&nbsp;<span class="ident" id="6027974">http</span><span class="op" id="6027978">.</span><span class="ident" id="6027979">Handler</span><span class="op" id="6027986">)</span>&nbsp;<span class="op" id="6027988">*</span><span class="ident" id="6027989">Server</span>&nbsp;<span class="op" id="6027996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027999">ts</span>&nbsp;<span class="op" id="6028002">:=</span>&nbsp;<span class="ident" id="6028005">NewUnstartedServer</span><span class="op" id="6028023">(</span><span class="ident" id="6028024">handler</span><span class="op" id="6028031">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028034">ts</span><span class="op" id="6028036">.</span><span class="ident" id="6028037">StartTLS</span><span class="op" id="6028045">(</span><span class="op" id="6028046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028049">return</span>&nbsp;<span class="ident" id="6028056">ts</span><br>
<span class="lineno"></span><span class="op" id="6028059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6028062">//&nbsp;Close&nbsp;shuts&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;blocks&nbsp;until&nbsp;all&nbsp;outstanding</span><br>
<span class="lineno">165</span><span class="comment" id="6028126">//&nbsp;requests&nbsp;on&nbsp;this&nbsp;server&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="6028169">func</span>&nbsp;<span class="op" id="6028174">(</span><span class="ident" id="6028175">s</span>&nbsp;<span class="op" id="6028177">*</span><span class="ident" id="6028178">Server</span><span class="op" id="6028184">)</span>&nbsp;<span class="ident" id="6028186">Close</span><span class="op" id="6028191">(</span><span class="op" id="6028192">)</span>&nbsp;<span class="op" id="6028194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028197">s</span><span class="op" id="6028198">.</span><span class="ident" id="6028199">Listener</span><span class="op" id="6028207">.</span><span class="ident" id="6028208">Close</span><span class="op" id="6028213">(</span><span class="op" id="6028214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028217">s</span><span class="op" id="6028218">.</span><span class="ident" id="6028219">wg</span><span class="op" id="6028221">.</span><span class="ident" id="6028222">Wait</span><span class="op" id="6028226">(</span><span class="op" id="6028227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028230">s</span><span class="op" id="6028231">.</span><span class="ident" id="6028232">CloseClientConnections</span><span class="op" id="6028254">(</span><span class="op" id="6028255">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028258">if</span>&nbsp;<span class="ident" id="6028261">t</span><span class="op" id="6028262">,</span>&nbsp;<span class="ident" id="6028264">ok</span>&nbsp;<span class="op" id="6028267">:=</span>&nbsp;<span class="ident" id="6028270">http</span><span class="op" id="6028274">.</span><span class="ident" id="6028275">DefaultTransport</span><span class="op" id="6028291">.</span><span class="op" id="6028292">(</span><span class="op" id="6028293">*</span><span class="ident" id="6028294">http</span><span class="op" id="6028298">.</span><span class="ident" id="6028299">Transport</span><span class="op" id="6028308">)</span><span class="op" id="6028309">;</span>&nbsp;<span class="ident" id="6028311">ok</span>&nbsp;<span class="op" id="6028314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028318">t</span><span class="op" id="6028319">.</span><span class="ident" id="6028320">CloseIdleConnections</span><span class="op" id="6028340">(</span><span class="op" id="6028341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6028344">}</span><br>
<span class="lineno"></span><span class="op" id="6028346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="6028349">//&nbsp;CloseClientConnections&nbsp;closes&nbsp;any&nbsp;currently&nbsp;open&nbsp;HTTP&nbsp;connections</span><br>
<span class="lineno"></span><span class="comment" id="6028418">//&nbsp;to&nbsp;the&nbsp;test&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="6028441">func</span>&nbsp;<span class="op" id="6028446">(</span><span class="ident" id="6028447">s</span>&nbsp;<span class="op" id="6028449">*</span><span class="ident" id="6028450">Server</span><span class="op" id="6028456">)</span>&nbsp;<span class="ident" id="6028458">CloseClientConnections</span><span class="op" id="6028480">(</span><span class="op" id="6028481">)</span>&nbsp;<span class="op" id="6028483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028486">hl</span><span class="op" id="6028488">,</span>&nbsp;<span class="ident" id="6028490">ok</span>&nbsp;<span class="op" id="6028493">:=</span>&nbsp;<span class="ident" id="6028496">s</span><span class="op" id="6028497">.</span><span class="ident" id="6028498">Listener</span><span class="op" id="6028506">.</span><span class="op" id="6028507">(</span><span class="op" id="6028508">*</span><span class="ident" id="6028509">historyListener</span><span class="op" id="6028524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028527">if</span>&nbsp;<span class="op" id="6028530">!</span><span class="ident" id="6028531">ok</span>&nbsp;<span class="op" id="6028534">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028538">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6028546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028549">hl</span><span class="op" id="6028551">.</span><span class="ident" id="6028552">Lock</span><span class="op" id="6028556">(</span><span class="op" id="6028557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028560">for</span>&nbsp;<span class="ident" id="6028564">_</span><span class="op" id="6028565">,</span>&nbsp;<span class="ident" id="6028567">conn</span>&nbsp;<span class="op" id="6028572">:=</span>&nbsp;<span class="keyword" id="6028575">range</span>&nbsp;<span class="ident" id="6028581">hl</span><span class="op" id="6028583">.</span><span class="ident" id="6028584">history</span>&nbsp;<span class="op" id="6028592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028596">conn</span><span class="op" id="6028600">.</span><span class="ident" id="6028601">Close</span><span class="op" id="6028606">(</span><span class="op" id="6028607">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6028610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028613">hl</span><span class="op" id="6028615">.</span><span class="ident" id="6028616">Unlock</span><span class="op" id="6028622">(</span><span class="op" id="6028623">)</span><br>
<span class="lineno"></span><span class="op" id="6028625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6028628">//&nbsp;waitGroupHandler&nbsp;wraps&nbsp;a&nbsp;handler,&nbsp;incrementing&nbsp;and&nbsp;decrementing&nbsp;a</span><br>
<span class="lineno">190</span><span class="comment" id="6028697">//&nbsp;sync.WaitGroup&nbsp;on&nbsp;each&nbsp;request,&nbsp;to&nbsp;enable&nbsp;Server.Close&nbsp;to&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="6028764">//&nbsp;until&nbsp;outstanding&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="6028808">type</span>&nbsp;<span class="ident" id="6028813">waitGroupHandler</span>&nbsp;<span class="keyword" id="6028830">struct</span>&nbsp;<span class="op" id="6028837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028840">s</span>&nbsp;<span class="op" id="6028842">*</span><span class="ident" id="6028843">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028851">h</span>&nbsp;<span class="ident" id="6028853">http</span><span class="op" id="6028857">.</span><span class="ident" id="6028858">Handler</span>&nbsp;<span class="comment" id="6028866">//&nbsp;non-nil</span><br>
<span class="lineno">195</span><span class="op" id="6028877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6028880">func</span>&nbsp;<span class="op" id="6028885">(</span><span class="ident" id="6028886">h</span>&nbsp;<span class="op" id="6028888">*</span><span class="ident" id="6028889">waitGroupHandler</span><span class="op" id="6028905">)</span>&nbsp;<span class="ident" id="6028907">ServeHTTP</span><span class="op" id="6028916">(</span><span class="ident" id="6028917">w</span>&nbsp;<span class="ident" id="6028919">http</span><span class="op" id="6028923">.</span><span class="ident" id="6028924">ResponseWriter</span><span class="op" id="6028938">,</span>&nbsp;<span class="ident" id="6028940">r</span>&nbsp;<span class="op" id="6028942">*</span><span class="ident" id="6028943">http</span><span class="op" id="6028947">.</span><span class="ident" id="6028948">Request</span><span class="op" id="6028955">)</span>&nbsp;<span class="op" id="6028957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028960">h</span><span class="op" id="6028961">.</span><span class="ident" id="6028962">s</span><span class="op" id="6028963">.</span><span class="ident" id="6028964">wg</span><span class="op" id="6028966">.</span><span class="ident" id="6028967">Add</span><span class="op" id="6028970">(</span><span class="num" id="6028971">1</span><span class="op" id="6028972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028975">defer</span>&nbsp;<span class="ident" id="6028981">h</span><span class="op" id="6028982">.</span><span class="ident" id="6028983">s</span><span class="op" id="6028984">.</span><span class="ident" id="6028985">wg</span><span class="op" id="6028987">.</span><span class="ident" id="6028988">Done</span><span class="op" id="6028992">(</span><span class="op" id="6028993">)</span>&nbsp;<span class="comment" id="6028995">//&nbsp;a&nbsp;defer,&nbsp;in&nbsp;case&nbsp;ServeHTTP&nbsp;below&nbsp;panics</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6029039">h</span><span class="op" id="6029040">.</span><span class="ident" id="6029041">h</span><span class="op" id="6029042">.</span><span class="ident" id="6029043">ServeHTTP</span><span class="op" id="6029052">(</span><span class="ident" id="6029053">w</span><span class="op" id="6029054">,</span>&nbsp;<span class="ident" id="6029056">r</span><span class="op" id="6029057">)</span><br>
<span class="lineno"></span><span class="op" id="6029059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6029062">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno"></span><span class="comment" id="6029118">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno">205</span><span class="comment" id="6029191">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="6029210">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="6029244">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="6029380">var</span>&nbsp;<span class="ident" id="6029384">localhostCert</span>&nbsp;<span class="op" id="6029398">=</span>&nbsp;<span class="op" id="6029400">[</span><span class="op" id="6029401">]</span><span class="builtintype" id="6029402">byte</span><span class="op" id="6029406">(</span><span class="string" id="6029407">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno">210</span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno"></span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno">215</span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="6029978">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6029981">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno">220</span><span class="keyword" id="6030035">var</span>&nbsp;<span class="ident" id="6030039">localhostKey</span>&nbsp;<span class="op" id="6030052">=</span>&nbsp;<span class="op" id="6030054">[</span><span class="op" id="6030055">]</span><span class="builtintype" id="6030056">byte</span><span class="op" id="6030060">(</span><span class="string" id="6030061">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno"></span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno">225</span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="6030559">)</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
