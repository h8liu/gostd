<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html" class="current">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1655333">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1655388">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1655442">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1655493">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;runtime&nbsp;support&nbsp;for&nbsp;signal&nbsp;handling.</span><br>
<span class="lineno"></span><span class="comment" id="1655554">//</span><br>
<span class="lineno"></span><span class="comment" id="1655557">//&nbsp;Most&nbsp;synchronization&nbsp;primitives&nbsp;are&nbsp;not&nbsp;available&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="1655615">//&nbsp;the&nbsp;signal&nbsp;handler&nbsp;(it&nbsp;cannot&nbsp;block,&nbsp;allocate&nbsp;memory,&nbsp;or&nbsp;use&nbsp;locks)</span><br>
<span class="lineno"></span><span class="comment" id="1655686">//&nbsp;so&nbsp;the&nbsp;handler&nbsp;communicates&nbsp;with&nbsp;a&nbsp;processing&nbsp;goroutine</span><br>
<span class="lineno">10</span><span class="comment" id="1655745">//&nbsp;via&nbsp;struct&nbsp;sig,&nbsp;below.</span><br>
<span class="lineno"></span><span class="comment" id="1655771">//</span><br>
<span class="lineno"></span><span class="comment" id="1655774">//&nbsp;sigsend&nbsp;is&nbsp;called&nbsp;by&nbsp;the&nbsp;signal&nbsp;handler&nbsp;to&nbsp;queue&nbsp;a&nbsp;new&nbsp;signal.</span><br>
<span class="lineno"></span><span class="comment" id="1655840">//&nbsp;signal_recv&nbsp;is&nbsp;called&nbsp;by&nbsp;the&nbsp;Go&nbsp;program&nbsp;to&nbsp;receive&nbsp;a&nbsp;newly&nbsp;queued&nbsp;signal.</span><br>
<span class="lineno"></span><span class="comment" id="1655917">//&nbsp;Synchronization&nbsp;between&nbsp;sigsend&nbsp;and&nbsp;signal_recv&nbsp;is&nbsp;based&nbsp;on&nbsp;the&nbsp;sig.state</span><br>
<span class="lineno">15</span><span class="comment" id="1655994">//&nbsp;variable.&nbsp;&nbsp;It&nbsp;can&nbsp;be&nbsp;in&nbsp;3&nbsp;states:&nbsp;sigIdle,&nbsp;sigReceiving&nbsp;and&nbsp;sigSending.</span><br>
<span class="lineno"></span><span class="comment" id="1656069">//&nbsp;sigReceiving&nbsp;means&nbsp;that&nbsp;signal_recv&nbsp;is&nbsp;blocked&nbsp;on&nbsp;sig.Note&nbsp;and&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="1656148">//&nbsp;new&nbsp;pending&nbsp;signals.</span><br>
<span class="lineno"></span><span class="comment" id="1656172">//&nbsp;sigSending&nbsp;means&nbsp;that&nbsp;sig.mask&nbsp;*may*&nbsp;contain&nbsp;new&nbsp;pending&nbsp;signals,</span><br>
<span class="lineno"></span><span class="comment" id="1656241">//&nbsp;signal_recv&nbsp;can&#39;t&nbsp;be&nbsp;blocked&nbsp;in&nbsp;this&nbsp;state.</span><br>
<span class="lineno">20</span><span class="comment" id="1656288">//&nbsp;sigIdle&nbsp;means&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;new&nbsp;pending&nbsp;signals&nbsp;and&nbsp;signal_recv&nbsp;is&nbsp;not&nbsp;blocked.</span><br>
<span class="lineno"></span><span class="comment" id="1656375">//&nbsp;Transitions&nbsp;between&nbsp;states&nbsp;are&nbsp;done&nbsp;atomically&nbsp;with&nbsp;CAS.</span><br>
<span class="lineno"></span><span class="comment" id="1656435">//&nbsp;When&nbsp;signal_recv&nbsp;is&nbsp;unblocked,&nbsp;it&nbsp;resets&nbsp;sig.Note&nbsp;and&nbsp;rechecks&nbsp;sig.mask.</span><br>
<span class="lineno"></span><span class="comment" id="1656511">//&nbsp;If&nbsp;several&nbsp;sigsends&nbsp;and&nbsp;signal_recv&nbsp;execute&nbsp;concurrently,&nbsp;it&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1656587">//&nbsp;unnecessary&nbsp;rechecks&nbsp;of&nbsp;sig.mask,&nbsp;but&nbsp;it&nbsp;cannot&nbsp;lead&nbsp;to&nbsp;missed&nbsp;signals</span><br>
<span class="lineno">25</span><span class="comment" id="1656661">//&nbsp;nor&nbsp;deadlocks.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1656680">package</span>&nbsp;<span class="ident" id="1656688">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1656697">import</span>&nbsp;<span class="string" id="1656704">&#34;unsafe&#34;</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="1656714">var</span>&nbsp;<span class="ident" id="1656718">sig</span>&nbsp;<span class="keyword" id="1656722">struct</span>&nbsp;<span class="op" id="1656729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656732">note</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1656739">note</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656745">mask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1656752">[</span><span class="op" id="1656753">(</span><span class="ident" id="1656754">_NSIG</span>&nbsp;<span class="op" id="1656760">+</span>&nbsp;<span class="num" id="1656762">31</span><span class="op" id="1656764">)</span>&nbsp;<span class="op" id="1656766">/</span>&nbsp;<span class="num" id="1656768">32</span><span class="op" id="1656770">]</span><span class="builtintype" id="1656771">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656779">wanted</span>&nbsp;<span class="op" id="1656786">[</span><span class="op" id="1656787">(</span><span class="ident" id="1656788">_NSIG</span>&nbsp;<span class="op" id="1656794">+</span>&nbsp;<span class="num" id="1656796">31</span><span class="op" id="1656798">)</span>&nbsp;<span class="op" id="1656800">/</span>&nbsp;<span class="num" id="1656802">32</span><span class="op" id="1656804">]</span><span class="builtintype" id="1656805">uint32</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656813">recv</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1656820">[</span><span class="op" id="1656821">(</span><span class="ident" id="1656822">_NSIG</span>&nbsp;<span class="op" id="1656828">+</span>&nbsp;<span class="num" id="1656830">31</span><span class="op" id="1656832">)</span>&nbsp;<span class="op" id="1656834">/</span>&nbsp;<span class="num" id="1656836">32</span><span class="op" id="1656838">]</span><span class="builtintype" id="1656839">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656847">state</span>&nbsp;&nbsp;<span class="builtintype" id="1656854">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656862">inuse</span>&nbsp;&nbsp;<span class="builtintype" id="1656869">bool</span><br>
<span class="lineno"></span><span class="op" id="1656874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="1656877">const</span>&nbsp;<span class="op" id="1656883">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656886">sigIdle</span>&nbsp;<span class="op" id="1656894">=</span>&nbsp;<span class="ident" id="1656896">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656902">sigReceiving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656916">sigSending</span><br>
<span class="lineno"></span><span class="op" id="1656927">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="1656930">//&nbsp;Called&nbsp;from&nbsp;sighandler&nbsp;to&nbsp;send&nbsp;a&nbsp;signal&nbsp;back&nbsp;out&nbsp;of&nbsp;the&nbsp;signal&nbsp;handling&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1657013">//&nbsp;Reports&nbsp;whether&nbsp;the&nbsp;signal&nbsp;was&nbsp;sent.&nbsp;If&nbsp;not,&nbsp;the&nbsp;caller&nbsp;typically&nbsp;crashes&nbsp;the&nbsp;program.</span><br>
<span class="lineno"></span><span class="keyword" id="1657103">func</span>&nbsp;<span class="ident" id="1657108">sigsend</span><span class="op" id="1657115">(</span><span class="ident" id="1657116">s</span>&nbsp;<span class="builtintype" id="1657118">int32</span><span class="op" id="1657123">)</span>&nbsp;<span class="builtintype" id="1657125">bool</span>&nbsp;<span class="op" id="1657130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657133">bit</span>&nbsp;<span class="op" id="1657137">:=</span>&nbsp;<span class="builtintype" id="1657140">uint32</span><span class="op" id="1657146">(</span><span class="num" id="1657147">1</span><span class="op" id="1657148">)</span>&nbsp;<span class="op" id="1657150">&lt;&lt;</span>&nbsp;<span class="builtintype" id="1657153">uint</span><span class="op" id="1657157">(</span><span class="ident" id="1657158">s</span><span class="op" id="1657159">&amp;</span><span class="num" id="1657160">31</span><span class="op" id="1657162">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657165">if</span>&nbsp;<span class="op" id="1657168">!</span><span class="ident" id="1657169">sig</span><span class="op" id="1657172">.</span><span class="ident" id="1657173">inuse</span>&nbsp;<span class="op" id="1657179">||</span>&nbsp;<span class="ident" id="1657182">s</span>&nbsp;<span class="op" id="1657184">&lt;</span>&nbsp;<span class="num" id="1657186">0</span>&nbsp;<span class="op" id="1657188">||</span>&nbsp;<span class="builtintype" id="1657191">int</span><span class="op" id="1657194">(</span><span class="ident" id="1657195">s</span><span class="op" id="1657196">)</span>&nbsp;<span class="op" id="1657198">&gt;=</span>&nbsp;<span class="num" id="1657201">32</span><span class="op" id="1657203">*</span><span class="builtinfunc" id="1657204">len</span><span class="op" id="1657207">(</span><span class="ident" id="1657208">sig</span><span class="op" id="1657211">.</span><span class="ident" id="1657212">wanted</span><span class="op" id="1657218">)</span>&nbsp;<span class="op" id="1657220">||</span>&nbsp;<span class="ident" id="1657223">sig</span><span class="op" id="1657226">.</span><span class="ident" id="1657227">wanted</span><span class="op" id="1657233">[</span><span class="ident" id="1657234">s</span><span class="op" id="1657235">/</span><span class="num" id="1657236">32</span><span class="op" id="1657238">]</span><span class="op" id="1657239">&amp;</span><span class="ident" id="1657240">bit</span>&nbsp;<span class="op" id="1657244">==</span>&nbsp;<span class="num" id="1657247">0</span>&nbsp;<span class="op" id="1657249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657253">return</span>&nbsp;<span class="builtintype" id="1657260">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1657271">//&nbsp;Add&nbsp;signal&nbsp;to&nbsp;outgoing&nbsp;queue.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657305">for</span>&nbsp;<span class="op" id="1657309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657313">mask</span>&nbsp;<span class="op" id="1657318">:=</span>&nbsp;<span class="ident" id="1657321">sig</span><span class="op" id="1657324">.</span><span class="ident" id="1657325">mask</span><span class="op" id="1657329">[</span><span class="ident" id="1657330">s</span><span class="op" id="1657331">/</span><span class="num" id="1657332">32</span><span class="op" id="1657334">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657338">if</span>&nbsp;<span class="ident" id="1657341">mask</span><span class="op" id="1657345">&amp;</span><span class="ident" id="1657346">bit</span>&nbsp;<span class="op" id="1657350">!=</span>&nbsp;<span class="num" id="1657353">0</span>&nbsp;<span class="op" id="1657355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657360">return</span>&nbsp;<span class="builtintype" id="1657367">true</span>&nbsp;<span class="comment" id="1657372">//&nbsp;signal&nbsp;already&nbsp;in&nbsp;queue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657401">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657405">if</span>&nbsp;<span class="ident" id="1657408">cas</span><span class="op" id="1657411">(</span><span class="op" id="1657412">&amp;</span><span class="ident" id="1657413">sig</span><span class="op" id="1657416">.</span><span class="ident" id="1657417">mask</span><span class="op" id="1657421">[</span><span class="ident" id="1657422">s</span><span class="op" id="1657423">/</span><span class="num" id="1657424">32</span><span class="op" id="1657426">]</span><span class="op" id="1657427">,</span>&nbsp;<span class="ident" id="1657429">mask</span><span class="op" id="1657433">,</span>&nbsp;<span class="ident" id="1657435">mask</span><span class="op" id="1657439">|</span><span class="ident" id="1657440">bit</span><span class="op" id="1657443">)</span>&nbsp;<span class="op" id="1657445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657450">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1657465">//&nbsp;Notify&nbsp;receiver&nbsp;that&nbsp;queue&nbsp;has&nbsp;new&nbsp;bit.</span><br>
<span class="lineno"></span><span class="ident" id="1657508">Send</span><span class="op" id="1657512">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657515">for</span>&nbsp;<span class="op" id="1657519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657523">switch</span>&nbsp;<span class="ident" id="1657530">atomicload</span><span class="op" id="1657540">(</span><span class="op" id="1657541">&amp;</span><span class="ident" id="1657542">sig</span><span class="op" id="1657545">.</span><span class="ident" id="1657546">state</span><span class="op" id="1657551">)</span>&nbsp;<span class="op" id="1657553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657557">default</span><span class="op" id="1657564">:</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657569">gothrow</span><span class="op" id="1657576">(</span><span class="string" id="1657577">&#34;sigsend:&nbsp;inconsistent&nbsp;state&#34;</span><span class="op" id="1657606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657610">case</span>&nbsp;<span class="ident" id="1657615">sigIdle</span><span class="op" id="1657622">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657627">if</span>&nbsp;<span class="ident" id="1657630">cas</span><span class="op" id="1657633">(</span><span class="op" id="1657634">&amp;</span><span class="ident" id="1657635">sig</span><span class="op" id="1657638">.</span><span class="ident" id="1657639">state</span><span class="op" id="1657644">,</span>&nbsp;<span class="ident" id="1657646">sigIdle</span><span class="op" id="1657653">,</span>&nbsp;<span class="ident" id="1657655">sigSending</span><span class="op" id="1657665">)</span>&nbsp;<span class="op" id="1657667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657673">break</span>&nbsp;<span class="ident" id="1657679">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657687">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657691">case</span>&nbsp;<span class="ident" id="1657696">sigSending</span><span class="op" id="1657706">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1657711">//&nbsp;notification&nbsp;already&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657746">break</span>&nbsp;<span class="ident" id="1657752">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657759">case</span>&nbsp;<span class="ident" id="1657764">sigReceiving</span><span class="op" id="1657776">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657781">if</span>&nbsp;<span class="ident" id="1657784">cas</span><span class="op" id="1657787">(</span><span class="op" id="1657788">&amp;</span><span class="ident" id="1657789">sig</span><span class="op" id="1657792">.</span><span class="ident" id="1657793">state</span><span class="op" id="1657798">,</span>&nbsp;<span class="ident" id="1657800">sigReceiving</span><span class="op" id="1657812">,</span>&nbsp;<span class="ident" id="1657814">sigIdle</span><span class="op" id="1657821">)</span>&nbsp;<span class="op" id="1657823">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657829">notewakeup</span><span class="op" id="1657839">(</span><span class="op" id="1657840">&amp;</span><span class="ident" id="1657841">sig</span><span class="op" id="1657844">.</span><span class="ident" id="1657845">note</span><span class="op" id="1657849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657855">break</span>&nbsp;<span class="ident" id="1657861">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657876">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657880">return</span>&nbsp;<span class="builtintype" id="1657887">true</span><br>
<span class="lineno"></span><span class="op" id="1657892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1657895">//&nbsp;Called&nbsp;to&nbsp;receive&nbsp;the&nbsp;next&nbsp;queued&nbsp;signal.</span><br>
<span class="lineno">90</span><span class="comment" id="1657940">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1657998">func</span>&nbsp;<span class="ident" id="1658003">signal_recv</span><span class="op" id="1658014">(</span><span class="op" id="1658015">)</span>&nbsp;<span class="builtintype" id="1658017">uint32</span>&nbsp;<span class="op" id="1658024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658027">for</span>&nbsp;<span class="op" id="1658031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1658035">//&nbsp;Serve&nbsp;any&nbsp;signals&nbsp;from&nbsp;local&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658075">for</span>&nbsp;<span class="ident" id="1658079">i</span>&nbsp;<span class="op" id="1658081">:=</span>&nbsp;<span class="builtintype" id="1658084">uint32</span><span class="op" id="1658090">(</span><span class="num" id="1658091">0</span><span class="op" id="1658092">)</span><span class="op" id="1658093">;</span>&nbsp;<span class="ident" id="1658095">i</span>&nbsp;<span class="op" id="1658097">&lt;</span>&nbsp;<span class="ident" id="1658099">_NSIG</span><span class="op" id="1658104">;</span>&nbsp;<span class="ident" id="1658106">i</span><span class="op" id="1658107">++</span>&nbsp;<span class="op" id="1658110">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658115">if</span>&nbsp;<span class="ident" id="1658118">sig</span><span class="op" id="1658121">.</span><span class="ident" id="1658122">recv</span><span class="op" id="1658126">[</span><span class="ident" id="1658127">i</span><span class="op" id="1658128">/</span><span class="num" id="1658129">32</span><span class="op" id="1658131">]</span><span class="op" id="1658132">&amp;</span><span class="op" id="1658133">(</span><span class="num" id="1658134">1</span><span class="op" id="1658135">&lt;&lt;</span><span class="op" id="1658137">(</span><span class="ident" id="1658138">i</span><span class="op" id="1658139">&amp;</span><span class="num" id="1658140">31</span><span class="op" id="1658142">)</span><span class="op" id="1658143">)</span>&nbsp;<span class="op" id="1658145">!=</span>&nbsp;<span class="num" id="1658148">0</span>&nbsp;<span class="op" id="1658150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658156">sig</span><span class="op" id="1658159">.</span><span class="ident" id="1658160">recv</span><span class="op" id="1658164">[</span><span class="ident" id="1658165">i</span><span class="op" id="1658166">/</span><span class="num" id="1658167">32</span><span class="op" id="1658169">]</span>&nbsp;<span class="op" id="1658171">&amp;^=</span>&nbsp;<span class="num" id="1658175">1</span>&nbsp;<span class="op" id="1658177">&lt;&lt;</span>&nbsp;<span class="op" id="1658180">(</span><span class="ident" id="1658181">i</span>&nbsp;<span class="op" id="1658183">&amp;</span>&nbsp;<span class="num" id="1658185">31</span><span class="op" id="1658187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658193">return</span>&nbsp;<span class="ident" id="1658200">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658209">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1658214">//&nbsp;Wait&nbsp;for&nbsp;updates&nbsp;to&nbsp;be&nbsp;available&nbsp;from&nbsp;signal&nbsp;sender.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658271">Receive</span><span class="op" id="1658278">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658282">for</span>&nbsp;<span class="op" id="1658286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658291">switch</span>&nbsp;<span class="ident" id="1658298">atomicload</span><span class="op" id="1658308">(</span><span class="op" id="1658309">&amp;</span><span class="ident" id="1658310">sig</span><span class="op" id="1658313">.</span><span class="ident" id="1658314">state</span><span class="op" id="1658319">)</span>&nbsp;<span class="op" id="1658321">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658326">default</span><span class="op" id="1658333">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658339">gothrow</span><span class="op" id="1658346">(</span><span class="string" id="1658347">&#34;signal_recv:&nbsp;inconsistent&nbsp;state&#34;</span><span class="op" id="1658380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658385">case</span>&nbsp;<span class="ident" id="1658390">sigIdle</span><span class="op" id="1658397">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658403">if</span>&nbsp;<span class="ident" id="1658406">cas</span><span class="op" id="1658409">(</span><span class="op" id="1658410">&amp;</span><span class="ident" id="1658411">sig</span><span class="op" id="1658414">.</span><span class="ident" id="1658415">state</span><span class="op" id="1658420">,</span>&nbsp;<span class="ident" id="1658422">sigIdle</span><span class="op" id="1658429">,</span>&nbsp;<span class="ident" id="1658431">sigReceiving</span><span class="op" id="1658443">)</span>&nbsp;<span class="op" id="1658445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658452">notetsleepg</span><span class="op" id="1658463">(</span><span class="op" id="1658464">&amp;</span><span class="ident" id="1658465">sig</span><span class="op" id="1658468">.</span><span class="ident" id="1658469">note</span><span class="op" id="1658473">,</span>&nbsp;<span class="op" id="1658475">-</span><span class="num" id="1658476">1</span><span class="op" id="1658477">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658484">noteclear</span><span class="op" id="1658493">(</span><span class="op" id="1658494">&amp;</span><span class="ident" id="1658495">sig</span><span class="op" id="1658498">.</span><span class="ident" id="1658499">note</span><span class="op" id="1658503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658510">break</span>&nbsp;<span class="ident" id="1658516">Receive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658533">case</span>&nbsp;<span class="ident" id="1658538">sigSending</span><span class="op" id="1658548">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658554">if</span>&nbsp;<span class="ident" id="1658557">cas</span><span class="op" id="1658560">(</span><span class="op" id="1658561">&amp;</span><span class="ident" id="1658562">sig</span><span class="op" id="1658565">.</span><span class="ident" id="1658566">state</span><span class="op" id="1658571">,</span>&nbsp;<span class="ident" id="1658573">sigSending</span><span class="op" id="1658583">,</span>&nbsp;<span class="ident" id="1658585">sigIdle</span><span class="op" id="1658592">)</span>&nbsp;<span class="op" id="1658594">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658601">break</span>&nbsp;<span class="ident" id="1658607">Receive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1658633">//&nbsp;Incorporate&nbsp;updates&nbsp;from&nbsp;sender&nbsp;into&nbsp;local&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658687">for</span>&nbsp;<span class="ident" id="1658691">i</span>&nbsp;<span class="op" id="1658693">:=</span>&nbsp;<span class="keyword" id="1658696">range</span>&nbsp;<span class="ident" id="1658702">sig</span><span class="op" id="1658705">.</span><span class="ident" id="1658706">mask</span>&nbsp;<span class="op" id="1658711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658716">sig</span><span class="op" id="1658719">.</span><span class="ident" id="1658720">recv</span><span class="op" id="1658724">[</span><span class="ident" id="1658725">i</span><span class="op" id="1658726">]</span>&nbsp;<span class="op" id="1658728">=</span>&nbsp;<span class="ident" id="1658730">xchg</span><span class="op" id="1658734">(</span><span class="op" id="1658735">&amp;</span><span class="ident" id="1658736">sig</span><span class="op" id="1658739">.</span><span class="ident" id="1658740">mask</span><span class="op" id="1658744">[</span><span class="ident" id="1658745">i</span><span class="op" id="1658746">]</span><span class="op" id="1658747">,</span>&nbsp;<span class="num" id="1658749">0</span><span class="op" id="1658750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658757">}</span><br>
<span class="lineno">125</span><span class="op" id="1658759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1658762">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1658820">func</span>&nbsp;<span class="ident" id="1658825">signal_enable</span><span class="op" id="1658838">(</span><span class="ident" id="1658839">s</span>&nbsp;<span class="builtintype" id="1658841">uint32</span><span class="op" id="1658847">)</span>&nbsp;<span class="op" id="1658849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658852">if</span>&nbsp;<span class="op" id="1658855">!</span><span class="ident" id="1658856">sig</span><span class="op" id="1658859">.</span><span class="ident" id="1658860">inuse</span>&nbsp;<span class="op" id="1658866">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1658870">//&nbsp;The&nbsp;first&nbsp;call&nbsp;to&nbsp;signal_enable&nbsp;is&nbsp;for&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1658917">//&nbsp;to&nbsp;use&nbsp;for&nbsp;initialization.&nbsp;&nbsp;It&nbsp;does&nbsp;not&nbsp;pass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1658967">//&nbsp;signal&nbsp;information&nbsp;in&nbsp;m.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658997">sig</span><span class="op" id="1659000">.</span><span class="ident" id="1659001">inuse</span>&nbsp;<span class="op" id="1659007">=</span>&nbsp;<span class="builtintype" id="1659009">true</span>&nbsp;<span class="comment" id="1659014">//&nbsp;enable&nbsp;reception&nbsp;of&nbsp;signals;&nbsp;cannot&nbsp;disable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659063">noteclear</span><span class="op" id="1659072">(</span><span class="op" id="1659073">&amp;</span><span class="ident" id="1659074">sig</span><span class="op" id="1659077">.</span><span class="ident" id="1659078">note</span><span class="op" id="1659082">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659086">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659098">if</span>&nbsp;<span class="builtintype" id="1659101">int</span><span class="op" id="1659104">(</span><span class="ident" id="1659105">s</span><span class="op" id="1659106">)</span>&nbsp;<span class="op" id="1659108">&gt;=</span>&nbsp;<span class="builtinfunc" id="1659111">len</span><span class="op" id="1659114">(</span><span class="ident" id="1659115">sig</span><span class="op" id="1659118">.</span><span class="ident" id="1659119">wanted</span><span class="op" id="1659125">)</span><span class="op" id="1659126">*</span><span class="num" id="1659127">32</span>&nbsp;<span class="op" id="1659130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659134">return</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659145">sig</span><span class="op" id="1659148">.</span><span class="ident" id="1659149">wanted</span><span class="op" id="1659155">[</span><span class="ident" id="1659156">s</span><span class="op" id="1659157">/</span><span class="num" id="1659158">32</span><span class="op" id="1659160">]</span>&nbsp;<span class="op" id="1659162">|=</span>&nbsp;<span class="num" id="1659165">1</span>&nbsp;<span class="op" id="1659167">&lt;&lt;</span>&nbsp;<span class="op" id="1659170">(</span><span class="ident" id="1659171">s</span>&nbsp;<span class="op" id="1659173">&amp;</span>&nbsp;<span class="num" id="1659175">31</span><span class="op" id="1659177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659180">sigenable_go</span><span class="op" id="1659192">(</span><span class="ident" id="1659193">s</span><span class="op" id="1659194">)</span><br>
<span class="lineno"></span><span class="op" id="1659196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="1659199">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1659257">func</span>&nbsp;<span class="ident" id="1659262">signal_disable</span><span class="op" id="1659276">(</span><span class="ident" id="1659277">s</span>&nbsp;<span class="builtintype" id="1659279">uint32</span><span class="op" id="1659285">)</span>&nbsp;<span class="op" id="1659287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659290">if</span>&nbsp;<span class="builtintype" id="1659293">int</span><span class="op" id="1659296">(</span><span class="ident" id="1659297">s</span><span class="op" id="1659298">)</span>&nbsp;<span class="op" id="1659300">&gt;=</span>&nbsp;<span class="builtinfunc" id="1659303">len</span><span class="op" id="1659306">(</span><span class="ident" id="1659307">sig</span><span class="op" id="1659310">.</span><span class="ident" id="1659311">wanted</span><span class="op" id="1659317">)</span><span class="op" id="1659318">*</span><span class="num" id="1659319">32</span>&nbsp;<span class="op" id="1659322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659326">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659334">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659337">sig</span><span class="op" id="1659340">.</span><span class="ident" id="1659341">wanted</span><span class="op" id="1659347">[</span><span class="ident" id="1659348">s</span><span class="op" id="1659349">/</span><span class="num" id="1659350">32</span><span class="op" id="1659352">]</span>&nbsp;<span class="op" id="1659354">&amp;^=</span>&nbsp;<span class="num" id="1659358">1</span>&nbsp;<span class="op" id="1659360">&lt;&lt;</span>&nbsp;<span class="op" id="1659363">(</span><span class="ident" id="1659364">s</span>&nbsp;<span class="op" id="1659366">&amp;</span>&nbsp;<span class="num" id="1659368">31</span><span class="op" id="1659370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659373">sigdisable_go</span><span class="op" id="1659386">(</span><span class="ident" id="1659387">s</span><span class="op" id="1659388">)</span><br>
<span class="lineno"></span><span class="op" id="1659390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1659393">//&nbsp;This&nbsp;runs&nbsp;on&nbsp;a&nbsp;foreign&nbsp;stack,&nbsp;without&nbsp;an&nbsp;m&nbsp;or&nbsp;a&nbsp;g.&nbsp;&nbsp;No&nbsp;stack&nbsp;split.</span><br>
<span class="lineno">155</span><span class="comment" id="1659464">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1659477">func</span>&nbsp;<span class="ident" id="1659482">badsignal</span><span class="op" id="1659491">(</span><span class="ident" id="1659492">sig</span>&nbsp;<span class="builtintype" id="1659496">uintptr</span><span class="op" id="1659503">)</span>&nbsp;<span class="op" id="1659505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659508">cgocallback</span><span class="op" id="1659519">(</span><span class="ident" id="1659520">unsafe</span><span class="op" id="1659526">.</span><span class="ident" id="1659527">Pointer</span><span class="op" id="1659534">(</span><span class="ident" id="1659535">funcPC</span><span class="op" id="1659541">(</span><span class="ident" id="1659542">sigsend</span><span class="op" id="1659549">)</span><span class="op" id="1659550">)</span><span class="op" id="1659551">,</span>&nbsp;<span class="ident" id="1659553">noescape</span><span class="op" id="1659561">(</span><span class="ident" id="1659562">unsafe</span><span class="op" id="1659568">.</span><span class="ident" id="1659569">Pointer</span><span class="op" id="1659576">(</span><span class="op" id="1659577">&amp;</span><span class="ident" id="1659578">sig</span><span class="op" id="1659581">)</span><span class="op" id="1659582">)</span><span class="op" id="1659583">,</span>&nbsp;<span class="ident" id="1659585">unsafe</span><span class="op" id="1659591">.</span><span class="ident" id="1659592">Sizeof</span><span class="op" id="1659598">(</span><span class="ident" id="1659599">sig</span><span class="op" id="1659602">)</span><span class="op" id="1659603">)</span><br>
<span class="lineno"></span><span class="op" id="1659605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="1659608">func</span>&nbsp;<span class="ident" id="1659613">sigenable_m</span><span class="op" id="1659624">(</span><span class="op" id="1659625">)</span><br>
<span class="lineno"></span><span class="keyword" id="1659627">func</span>&nbsp;<span class="ident" id="1659632">sigdisable_m</span><span class="op" id="1659644">(</span><span class="op" id="1659645">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1659648">func</span>&nbsp;<span class="ident" id="1659653">sigenable_go</span><span class="op" id="1659665">(</span><span class="ident" id="1659666">s</span>&nbsp;<span class="builtintype" id="1659668">uint32</span><span class="op" id="1659674">)</span>&nbsp;<span class="op" id="1659676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659679">g</span>&nbsp;<span class="op" id="1659681">:=</span>&nbsp;<span class="ident" id="1659684">getg</span><span class="op" id="1659688">(</span><span class="op" id="1659689">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659692">g</span><span class="op" id="1659693">.</span><span class="ident" id="1659694">m</span><span class="op" id="1659695">.</span><span class="ident" id="1659696">scalararg</span><span class="op" id="1659705">[</span><span class="num" id="1659706">0</span><span class="op" id="1659707">]</span>&nbsp;<span class="op" id="1659709">=</span>&nbsp;<span class="builtintype" id="1659711">uintptr</span><span class="op" id="1659718">(</span><span class="ident" id="1659719">s</span><span class="op" id="1659720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659723">onM</span><span class="op" id="1659726">(</span><span class="ident" id="1659727">sigenable_m</span><span class="op" id="1659738">)</span><br>
<span class="lineno"></span><span class="op" id="1659740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1659743">func</span>&nbsp;<span class="ident" id="1659748">sigdisable_go</span><span class="op" id="1659761">(</span><span class="ident" id="1659762">s</span>&nbsp;<span class="builtintype" id="1659764">uint32</span><span class="op" id="1659770">)</span>&nbsp;<span class="op" id="1659772">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659775">g</span>&nbsp;<span class="op" id="1659777">:=</span>&nbsp;<span class="ident" id="1659780">getg</span><span class="op" id="1659784">(</span><span class="op" id="1659785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659788">g</span><span class="op" id="1659789">.</span><span class="ident" id="1659790">m</span><span class="op" id="1659791">.</span><span class="ident" id="1659792">scalararg</span><span class="op" id="1659801">[</span><span class="num" id="1659802">0</span><span class="op" id="1659803">]</span>&nbsp;<span class="op" id="1659805">=</span>&nbsp;<span class="builtintype" id="1659807">uintptr</span><span class="op" id="1659814">(</span><span class="ident" id="1659815">s</span><span class="op" id="1659816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659819">onM</span><span class="op" id="1659822">(</span><span class="ident" id="1659823">sigdisable_m</span><span class="op" id="1659835">)</span><br>
<span class="lineno"></span><span class="op" id="1659837">}</span>
</div>
</body>
</html>
