<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1848711">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1848766">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1848820">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1848871">package</span>&nbsp;<span class="ident" id="1848879">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1848885">import</span>&nbsp;<span class="op" id="1848892">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1848895">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1848910">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1848919">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1848922">//&nbsp;An&nbsp;RWMutex&nbsp;is&nbsp;a&nbsp;reader/writer&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1848978">//&nbsp;The&nbsp;lock&nbsp;can&nbsp;be&nbsp;held&nbsp;by&nbsp;an&nbsp;arbitrary&nbsp;number&nbsp;of&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1849036">//&nbsp;or&nbsp;a&nbsp;single&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="comment" id="1849059">//&nbsp;RWMutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other</span><br>
<span class="lineno"></span><span class="comment" id="1849104">//&nbsp;structures;&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;RWMutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1849151">//&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1849173">type</span>&nbsp;<span class="ident" id="1849178">RWMutex</span>&nbsp;<span class="keyword" id="1849186">struct</span>&nbsp;<span class="op" id="1849193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849196">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1849208"><a href="/sync/mutex.go.html#1837076">Mutex</a></span>&nbsp;&nbsp;<span class="comment" id="1849215">//&nbsp;held&nbsp;if&nbsp;there&nbsp;are&nbsp;pending&nbsp;writers</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849253">writerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1849265">uint32</span>&nbsp;<span class="comment" id="1849272">//&nbsp;semaphore&nbsp;for&nbsp;writers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849329">readerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1849341">uint32</span>&nbsp;<span class="comment" id="1849348">//&nbsp;semaphore&nbsp;for&nbsp;readers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849405">readerCount</span>&nbsp;<span class="builtintype" id="1849417">int32</span>&nbsp;&nbsp;<span class="comment" id="1849424">//&nbsp;number&nbsp;of&nbsp;pending&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849454">readerWait</span>&nbsp;&nbsp;<span class="builtintype" id="1849466">int32</span>&nbsp;&nbsp;<span class="comment" id="1849473">//&nbsp;number&nbsp;of&nbsp;departing&nbsp;readers</span><br>
<span class="lineno"></span><span class="op" id="1849504">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1849507">const</span>&nbsp;<span class="ident" id="1849513">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1849531">=</span>&nbsp;<span class="num" id="1849533">1</span>&nbsp;<span class="op" id="1849535">&lt;&lt;</span>&nbsp;<span class="num" id="1849538">30</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1849542">//&nbsp;RLock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="keyword" id="1849573">func</span>&nbsp;<span class="op" id="1849578">(</span><span class="ident" id="1849579">rw</span>&nbsp;<span class="op" id="1849582">*</span><span class="ident" id="1849583"><a href="/sync/rwmutex.go.html#1849178">RWMutex</a></span><span class="op" id="1849590">)</span>&nbsp;<span class="ident" id="1849592">RLock</span><span class="op" id="1849597">(</span><span class="op" id="1849598">)</span>&nbsp;<span class="op" id="1849600">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1849603">if</span>&nbsp;<span class="ident" id="1849606"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1849618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849622">_</span>&nbsp;<span class="op" id="1849624">=</span>&nbsp;<span class="ident" id="1849626"><a href="/sync/rwmutex.go.html#1849579">rw</a></span><span class="op" id="1849628">.</span><span class="ident" id="1849629">w</span><span class="op" id="1849630">.</span><span class="ident" id="1849631">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849639"><a href="/sync/race0.go.html#1847321">raceDisable</a></span><span class="op" id="1849650">(</span><span class="op" id="1849651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1849654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1849657">if</span>&nbsp;<span class="ident" id="1849660"><a href="/sync/rwmutex.go.html#1848895">atomic</a></span><span class="op" id="1849666">.</span><span class="ident" id="1849667">AddInt32</span><span class="op" id="1849675">(</span><span class="op" id="1849676">&amp;</span><span class="ident" id="1849677"><a href="/sync/rwmutex.go.html#1849579">rw</a></span><span class="op" id="1849679">.</span><span class="ident" id="1849680">readerCount</span><span class="op" id="1849691">,</span>&nbsp;<span class="num" id="1849693">1</span><span class="op" id="1849694">)</span>&nbsp;<span class="op" id="1849696">&lt;</span>&nbsp;<span class="num" id="1849698">0</span>&nbsp;<span class="op" id="1849700">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1849704">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending,&nbsp;wait&nbsp;for&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849743"><a href="/sync/runtime.go.html#1847861">runtime_Semacquire</a></span><span class="op" id="1849761">(</span><span class="op" id="1849762">&amp;</span><span class="ident" id="1849763"><a href="/sync/rwmutex.go.html#1849579">rw</a></span><span class="op" id="1849765">.</span><span class="ident" id="1849766">readerSem</span><span class="op" id="1849775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1849778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1849781">if</span>&nbsp;<span class="ident" id="1849784"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1849796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849800"><a href="/sync/race0.go.html#1847345">raceEnable</a></span><span class="op" id="1849810">(</span><span class="op" id="1849811">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849815"><a href="/sync/race0.go.html#1847187">raceAcquire</a></span><span class="op" id="1849826">(</span><span class="ident" id="1849827"><a href="/sync/rwmutex.go.html#1848910">unsafe</a></span><span class="op" id="1849833">.</span><span class="ident" id="1849834">Pointer</span><span class="op" id="1849841">(</span><span class="op" id="1849842">&amp;</span><span class="ident" id="1849843"><a href="/sync/rwmutex.go.html#1849579">rw</a></span><span class="op" id="1849845">.</span><span class="ident" id="1849846">readerSem</span><span class="op" id="1849855">)</span><span class="op" id="1849856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1849859">}</span><br>
<span class="lineno"></span><span class="op" id="1849861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1849864">//&nbsp;RUnlock&nbsp;undoes&nbsp;a&nbsp;single&nbsp;RLock&nbsp;call;</span><br>
<span class="lineno">45</span><span class="comment" id="1849903">//&nbsp;it&nbsp;does&nbsp;not&nbsp;affect&nbsp;other&nbsp;simultaneous&nbsp;readers.</span><br>
<span class="lineno"></span><span class="comment" id="1849953">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is&nbsp;not&nbsp;locked&nbsp;for&nbsp;reading</span><br>
<span class="lineno"></span><span class="comment" id="1850011">//&nbsp;on&nbsp;entry&nbsp;to&nbsp;RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1850035">func</span>&nbsp;<span class="op" id="1850040">(</span><span class="ident" id="1850041">rw</span>&nbsp;<span class="op" id="1850044">*</span><span class="ident" id="1850045"><a href="/sync/rwmutex.go.html#1849178">RWMutex</a></span><span class="op" id="1850052">)</span>&nbsp;<span class="ident" id="1850054">RUnlock</span><span class="op" id="1850061">(</span><span class="op" id="1850062">)</span>&nbsp;<span class="op" id="1850064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850067">if</span>&nbsp;<span class="ident" id="1850070"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1850082">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850086">_</span>&nbsp;<span class="op" id="1850088">=</span>&nbsp;<span class="ident" id="1850090"><a href="/sync/rwmutex.go.html#1850041">rw</a></span><span class="op" id="1850092">.</span><span class="ident" id="1850093">w</span><span class="op" id="1850094">.</span><span class="ident" id="1850095">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850103"><a href="/sync/race0.go.html#1847273">raceReleaseMerge</a></span><span class="op" id="1850119">(</span><span class="ident" id="1850120"><a href="/sync/rwmutex.go.html#1848910">unsafe</a></span><span class="op" id="1850126">.</span><span class="ident" id="1850127">Pointer</span><span class="op" id="1850134">(</span><span class="op" id="1850135">&amp;</span><span class="ident" id="1850136"><a href="/sync/rwmutex.go.html#1850041">rw</a></span><span class="op" id="1850138">.</span><span class="ident" id="1850139">writerSem</span><span class="op" id="1850148">)</span><span class="op" id="1850149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850153"><a href="/sync/race0.go.html#1847321">raceDisable</a></span><span class="op" id="1850164">(</span><span class="op" id="1850165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1850168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850171">if</span>&nbsp;<span class="ident" id="1850174">r</span>&nbsp;<span class="op" id="1850176">:=</span>&nbsp;<span class="ident" id="1850179"><a href="/sync/rwmutex.go.html#1848895">atomic</a></span><span class="op" id="1850185">.</span><span class="ident" id="1850186">AddInt32</span><span class="op" id="1850194">(</span><span class="op" id="1850195">&amp;</span><span class="ident" id="1850196"><a href="/sync/rwmutex.go.html#1850041">rw</a></span><span class="op" id="1850198">.</span><span class="ident" id="1850199">readerCount</span><span class="op" id="1850210">,</span>&nbsp;<span class="op" id="1850212">-</span><span class="num" id="1850213">1</span><span class="op" id="1850214">)</span><span class="op" id="1850215">;</span>&nbsp;<span class="ident" id="1850217"><a href="/sync/rwmutex.go.html#1850174">r</a></span>&nbsp;<span class="op" id="1850219">&lt;</span>&nbsp;<span class="num" id="1850221">0</span>&nbsp;<span class="op" id="1850223">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850227">if</span>&nbsp;<span class="ident" id="1850230"><a href="/sync/rwmutex.go.html#1850174">r</a></span><span class="op" id="1850231">+</span><span class="num" id="1850232">1</span>&nbsp;<span class="op" id="1850234">==</span>&nbsp;<span class="num" id="1850237">0</span>&nbsp;<span class="op" id="1850239">||</span>&nbsp;<span class="ident" id="1850242"><a href="/sync/rwmutex.go.html#1850174">r</a></span><span class="op" id="1850243">+</span><span class="num" id="1850244">1</span>&nbsp;<span class="op" id="1850246">==</span>&nbsp;<span class="op" id="1850249">-</span><span class="ident" id="1850250"><a href="/sync/rwmutex.go.html#1849513">rwmutexMaxReaders</a></span>&nbsp;<span class="op" id="1850268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850273"><a href="/sync/race0.go.html#1847345">raceEnable</a></span><span class="op" id="1850283">(</span><span class="op" id="1850284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1850289">panic</span><span class="op" id="1850294">(</span><span class="string" id="1850295">&#34;sync:&nbsp;RUnlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1850330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1850334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1850338">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850364">if</span>&nbsp;<span class="ident" id="1850367"><a href="/sync/rwmutex.go.html#1848895">atomic</a></span><span class="op" id="1850373">.</span><span class="ident" id="1850374">AddInt32</span><span class="op" id="1850382">(</span><span class="op" id="1850383">&amp;</span><span class="ident" id="1850384"><a href="/sync/rwmutex.go.html#1850041">rw</a></span><span class="op" id="1850386">.</span><span class="ident" id="1850387">readerWait</span><span class="op" id="1850397">,</span>&nbsp;<span class="op" id="1850399">-</span><span class="num" id="1850400">1</span><span class="op" id="1850401">)</span>&nbsp;<span class="op" id="1850403">==</span>&nbsp;<span class="num" id="1850406">0</span>&nbsp;<span class="op" id="1850408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1850413">//&nbsp;The&nbsp;last&nbsp;reader&nbsp;unblocks&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850456"><a href="/sync/runtime.go.html#1848127">runtime_Semrelease</a></span><span class="op" id="1850474">(</span><span class="op" id="1850475">&amp;</span><span class="ident" id="1850476"><a href="/sync/rwmutex.go.html#1850041">rw</a></span><span class="op" id="1850478">.</span><span class="ident" id="1850479">writerSem</span><span class="op" id="1850488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1850492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1850495">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850498">if</span>&nbsp;<span class="ident" id="1850501"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1850513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850517"><a href="/sync/race0.go.html#1847345">raceEnable</a></span><span class="op" id="1850527">(</span><span class="op" id="1850528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1850531">}</span><br>
<span class="lineno"></span><span class="op" id="1850533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="1850536">//&nbsp;Lock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="1850566">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;locked&nbsp;for&nbsp;reading&nbsp;or&nbsp;writing,</span><br>
<span class="lineno"></span><span class="comment" id="1850623">//&nbsp;Lock&nbsp;blocks&nbsp;until&nbsp;the&nbsp;lock&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="comment" id="1850667">//&nbsp;To&nbsp;ensure&nbsp;that&nbsp;the&nbsp;lock&nbsp;eventually&nbsp;becomes&nbsp;available,</span><br>
<span class="lineno"></span><span class="comment" id="1850724">//&nbsp;a&nbsp;blocked&nbsp;Lock&nbsp;call&nbsp;excludes&nbsp;new&nbsp;readers&nbsp;from&nbsp;acquiring</span><br>
<span class="lineno">75</span><span class="comment" id="1850783">//&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1850796">func</span>&nbsp;<span class="op" id="1850801">(</span><span class="ident" id="1850802">rw</span>&nbsp;<span class="op" id="1850805">*</span><span class="ident" id="1850806"><a href="/sync/rwmutex.go.html#1849178">RWMutex</a></span><span class="op" id="1850813">)</span>&nbsp;<span class="ident" id="1850815">Lock</span><span class="op" id="1850819">(</span><span class="op" id="1850820">)</span>&nbsp;<span class="op" id="1850822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850825">if</span>&nbsp;<span class="ident" id="1850828"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1850840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850844">_</span>&nbsp;<span class="op" id="1850846">=</span>&nbsp;<span class="ident" id="1850848"><a href="/sync/rwmutex.go.html#1850802">rw</a></span><span class="op" id="1850850">.</span><span class="ident" id="1850851">w</span><span class="op" id="1850852">.</span><span class="ident" id="1850853">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850861"><a href="/sync/race0.go.html#1847321">raceDisable</a></span><span class="op" id="1850872">(</span><span class="op" id="1850873">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1850876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1850879">//&nbsp;First,&nbsp;resolve&nbsp;competition&nbsp;with&nbsp;other&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850930"><a href="/sync/rwmutex.go.html#1850802">rw</a></span><span class="op" id="1850932">.</span><span class="ident" id="1850933">w</span><span class="op" id="1850934">.</span><span class="ident" id="1850935">Lock</span><span class="op" id="1850939">(</span><span class="op" id="1850940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1850943">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;a&nbsp;pending&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850994">r</span>&nbsp;<span class="op" id="1850996">:=</span>&nbsp;<span class="ident" id="1850999"><a href="/sync/rwmutex.go.html#1848895">atomic</a></span><span class="op" id="1851005">.</span><span class="ident" id="1851006">AddInt32</span><span class="op" id="1851014">(</span><span class="op" id="1851015">&amp;</span><span class="ident" id="1851016"><a href="/sync/rwmutex.go.html#1850802">rw</a></span><span class="op" id="1851018">.</span><span class="ident" id="1851019">readerCount</span><span class="op" id="1851030">,</span>&nbsp;<span class="op" id="1851032">-</span><span class="ident" id="1851033"><a href="/sync/rwmutex.go.html#1849513">rwmutexMaxReaders</a></span><span class="op" id="1851050">)</span>&nbsp;<span class="op" id="1851052">+</span>&nbsp;<span class="ident" id="1851054"><a href="/sync/rwmutex.go.html#1849513">rwmutexMaxReaders</a></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1851073">//&nbsp;Wait&nbsp;for&nbsp;active&nbsp;readers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851102">if</span>&nbsp;<span class="ident" id="1851105"><a href="/sync/rwmutex.go.html#1850994">r</a></span>&nbsp;<span class="op" id="1851107">!=</span>&nbsp;<span class="num" id="1851110">0</span>&nbsp;<span class="op" id="1851112">&amp;&amp;</span>&nbsp;<span class="ident" id="1851115"><a href="/sync/rwmutex.go.html#1848895">atomic</a></span><span class="op" id="1851121">.</span><span class="ident" id="1851122">AddInt32</span><span class="op" id="1851130">(</span><span class="op" id="1851131">&amp;</span><span class="ident" id="1851132"><a href="/sync/rwmutex.go.html#1850802">rw</a></span><span class="op" id="1851134">.</span><span class="ident" id="1851135">readerWait</span><span class="op" id="1851145">,</span>&nbsp;<span class="ident" id="1851147"><a href="/sync/rwmutex.go.html#1850994">r</a></span><span class="op" id="1851148">)</span>&nbsp;<span class="op" id="1851150">!=</span>&nbsp;<span class="num" id="1851153">0</span>&nbsp;<span class="op" id="1851155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851159"><a href="/sync/runtime.go.html#1847861">runtime_Semacquire</a></span><span class="op" id="1851177">(</span><span class="op" id="1851178">&amp;</span><span class="ident" id="1851179"><a href="/sync/rwmutex.go.html#1850802">rw</a></span><span class="op" id="1851181">.</span><span class="ident" id="1851182">writerSem</span><span class="op" id="1851191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1851194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851197">if</span>&nbsp;<span class="ident" id="1851200"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1851212">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851216"><a href="/sync/race0.go.html#1847345">raceEnable</a></span><span class="op" id="1851226">(</span><span class="op" id="1851227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851231"><a href="/sync/race0.go.html#1847187">raceAcquire</a></span><span class="op" id="1851242">(</span><span class="ident" id="1851243"><a href="/sync/rwmutex.go.html#1848910">unsafe</a></span><span class="op" id="1851249">.</span><span class="ident" id="1851250">Pointer</span><span class="op" id="1851257">(</span><span class="op" id="1851258">&amp;</span><span class="ident" id="1851259"><a href="/sync/rwmutex.go.html#1850802">rw</a></span><span class="op" id="1851261">.</span><span class="ident" id="1851262">readerSem</span><span class="op" id="1851271">)</span><span class="op" id="1851272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851276"><a href="/sync/race0.go.html#1847187">raceAcquire</a></span><span class="op" id="1851287">(</span><span class="ident" id="1851288"><a href="/sync/rwmutex.go.html#1848910">unsafe</a></span><span class="op" id="1851294">.</span><span class="ident" id="1851295">Pointer</span><span class="op" id="1851302">(</span><span class="op" id="1851303">&amp;</span><span class="ident" id="1851304"><a href="/sync/rwmutex.go.html#1850802">rw</a></span><span class="op" id="1851306">.</span><span class="ident" id="1851307">writerSem</span><span class="op" id="1851316">)</span><span class="op" id="1851317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1851320">}</span><br>
<span class="lineno"></span><span class="op" id="1851322">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="1851325">//&nbsp;Unlock&nbsp;unlocks&nbsp;rw&nbsp;for&nbsp;writing.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1851392">//&nbsp;not&nbsp;locked&nbsp;for&nbsp;writing&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1851438">//</span><br>
<span class="lineno"></span><span class="comment" id="1851441">//&nbsp;As&nbsp;with&nbsp;Mutexes,&nbsp;a&nbsp;locked&nbsp;RWMutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular</span><br>
<span class="lineno">100</span><span class="comment" id="1851514">//&nbsp;goroutine.&nbsp;&nbsp;One&nbsp;goroutine&nbsp;may&nbsp;RLock&nbsp;(Lock)&nbsp;an&nbsp;RWMutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1851580">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;RUnlock&nbsp;(Unlock)&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1851637">func</span>&nbsp;<span class="op" id="1851642">(</span><span class="ident" id="1851643">rw</span>&nbsp;<span class="op" id="1851646">*</span><span class="ident" id="1851647"><a href="/sync/rwmutex.go.html#1849178">RWMutex</a></span><span class="op" id="1851654">)</span>&nbsp;<span class="ident" id="1851656">Unlock</span><span class="op" id="1851662">(</span><span class="op" id="1851663">)</span>&nbsp;<span class="op" id="1851665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851668">if</span>&nbsp;<span class="ident" id="1851671"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1851683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851687">_</span>&nbsp;<span class="op" id="1851689">=</span>&nbsp;<span class="ident" id="1851691"><a href="/sync/rwmutex.go.html#1851643">rw</a></span><span class="op" id="1851693">.</span><span class="ident" id="1851694">w</span><span class="op" id="1851695">.</span><span class="ident" id="1851696">state</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851704"><a href="/sync/race0.go.html#1847230">raceRelease</a></span><span class="op" id="1851715">(</span><span class="ident" id="1851716"><a href="/sync/rwmutex.go.html#1848910">unsafe</a></span><span class="op" id="1851722">.</span><span class="ident" id="1851723">Pointer</span><span class="op" id="1851730">(</span><span class="op" id="1851731">&amp;</span><span class="ident" id="1851732"><a href="/sync/rwmutex.go.html#1851643">rw</a></span><span class="op" id="1851734">.</span><span class="ident" id="1851735">readerSem</span><span class="op" id="1851744">)</span><span class="op" id="1851745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851749"><a href="/sync/race0.go.html#1847230">raceRelease</a></span><span class="op" id="1851760">(</span><span class="ident" id="1851761"><a href="/sync/rwmutex.go.html#1848910">unsafe</a></span><span class="op" id="1851767">.</span><span class="ident" id="1851768">Pointer</span><span class="op" id="1851775">(</span><span class="op" id="1851776">&amp;</span><span class="ident" id="1851777"><a href="/sync/rwmutex.go.html#1851643">rw</a></span><span class="op" id="1851779">.</span><span class="ident" id="1851780">writerSem</span><span class="op" id="1851789">)</span><span class="op" id="1851790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851794"><a href="/sync/race0.go.html#1847321">raceDisable</a></span><span class="op" id="1851805">(</span><span class="op" id="1851806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1851809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1851813">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;no&nbsp;active&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851864">r</span>&nbsp;<span class="op" id="1851866">:=</span>&nbsp;<span class="ident" id="1851869"><a href="/sync/rwmutex.go.html#1848895">atomic</a></span><span class="op" id="1851875">.</span><span class="ident" id="1851876">AddInt32</span><span class="op" id="1851884">(</span><span class="op" id="1851885">&amp;</span><span class="ident" id="1851886"><a href="/sync/rwmutex.go.html#1851643">rw</a></span><span class="op" id="1851888">.</span><span class="ident" id="1851889">readerCount</span><span class="op" id="1851900">,</span>&nbsp;<span class="ident" id="1851902"><a href="/sync/rwmutex.go.html#1849513">rwmutexMaxReaders</a></span><span class="op" id="1851919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851922">if</span>&nbsp;<span class="ident" id="1851925"><a href="/sync/rwmutex.go.html#1851864">r</a></span>&nbsp;<span class="op" id="1851927">&gt;=</span>&nbsp;<span class="ident" id="1851930"><a href="/sync/rwmutex.go.html#1849513">rwmutexMaxReaders</a></span>&nbsp;<span class="op" id="1851948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851952"><a href="/sync/race0.go.html#1847345">raceEnable</a></span><span class="op" id="1851962">(</span><span class="op" id="1851963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1851967">panic</span><span class="op" id="1851972">(</span><span class="string" id="1851973">&#34;sync:&nbsp;Unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1852007">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1852010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1852013">//&nbsp;Unblock&nbsp;blocked&nbsp;readers,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1852050">for</span>&nbsp;<span class="ident" id="1852054">i</span>&nbsp;<span class="op" id="1852056">:=</span>&nbsp;<span class="num" id="1852059">0</span><span class="op" id="1852060">;</span>&nbsp;<span class="ident" id="1852062"><a href="/sync/rwmutex.go.html#1852054">i</a></span>&nbsp;<span class="op" id="1852064">&lt;</span>&nbsp;<span class="builtintype" id="1852066">int</span><span class="op" id="1852069">(</span><span class="ident" id="1852070"><a href="/sync/rwmutex.go.html#1851864">r</a></span><span class="op" id="1852071">)</span><span class="op" id="1852072">;</span>&nbsp;<span class="ident" id="1852074"><a href="/sync/rwmutex.go.html#1852054">i</a></span><span class="op" id="1852075">++</span>&nbsp;<span class="op" id="1852078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1852082"><a href="/sync/runtime.go.html#1848127">runtime_Semrelease</a></span><span class="op" id="1852100">(</span><span class="op" id="1852101">&amp;</span><span class="ident" id="1852102"><a href="/sync/rwmutex.go.html#1851643">rw</a></span><span class="op" id="1852104">.</span><span class="ident" id="1852105">readerSem</span><span class="op" id="1852114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1852117">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1852120">//&nbsp;Allow&nbsp;other&nbsp;writers&nbsp;to&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1852156"><a href="/sync/rwmutex.go.html#1851643">rw</a></span><span class="op" id="1852158">.</span><span class="ident" id="1852159">w</span><span class="op" id="1852160">.</span><span class="ident" id="1852161">Unlock</span><span class="op" id="1852167">(</span><span class="op" id="1852168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1852171">if</span>&nbsp;<span class="ident" id="1852174"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1852186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1852190"><a href="/sync/race0.go.html#1847345">raceEnable</a></span><span class="op" id="1852200">(</span><span class="op" id="1852201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1852204">}</span><br>
<span class="lineno">125</span><span class="op" id="1852206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1852209">//&nbsp;RLocker&nbsp;returns&nbsp;a&nbsp;Locker&nbsp;interface&nbsp;that&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1852263">//&nbsp;the&nbsp;Lock&nbsp;and&nbsp;Unlock&nbsp;methods&nbsp;by&nbsp;calling&nbsp;rw.RLock&nbsp;and&nbsp;rw.RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1852330">func</span>&nbsp;<span class="op" id="1852335">(</span><span class="ident" id="1852336">rw</span>&nbsp;<span class="op" id="1852339">*</span><span class="ident" id="1852340"><a href="/sync/rwmutex.go.html#1849178">RWMutex</a></span><span class="op" id="1852347">)</span>&nbsp;<span class="ident" id="1852349">RLocker</span><span class="op" id="1852356">(</span><span class="op" id="1852357">)</span>&nbsp;<span class="ident" id="1852359"><a href="/sync/mutex.go.html#1837192">Locker</a></span>&nbsp;<span class="op" id="1852366">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1852369">return</span>&nbsp;<span class="op" id="1852376">(</span><span class="op" id="1852377">*</span><span class="ident" id="1852378"><a href="/sync/rwmutex.go.html#1852399">rlocker</a></span><span class="op" id="1852385">)</span><span class="op" id="1852386">(</span><span class="ident" id="1852387"><a href="/sync/rwmutex.go.html#1852336">rw</a></span><span class="op" id="1852389">)</span><br>
<span class="lineno"></span><span class="op" id="1852391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1852394">type</span>&nbsp;<span class="ident" id="1852399">rlocker</span>&nbsp;<span class="ident" id="1852407"><a href="/sync/rwmutex.go.html#1849178">RWMutex</a></span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="1852416">func</span>&nbsp;<span class="op" id="1852421">(</span><span class="ident" id="1852422">r</span>&nbsp;<span class="op" id="1852424">*</span><span class="ident" id="1852425"><a href="/sync/rwmutex.go.html#1852399">rlocker</a></span><span class="op" id="1852432">)</span>&nbsp;<span class="ident" id="1852434">Lock</span><span class="op" id="1852438">(</span><span class="op" id="1852439">)</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1852443">{</span>&nbsp;<span class="op" id="1852445">(</span><span class="op" id="1852446">*</span><span class="ident" id="1852447"><a href="/sync/rwmutex.go.html#1849178">RWMutex</a></span><span class="op" id="1852454">)</span><span class="op" id="1852455">(</span><span class="ident" id="1852456"><a href="/sync/rwmutex.go.html#1852422">r</a></span><span class="op" id="1852457">)</span><span class="op" id="1852458">.</span><span class="ident" id="1852459">RLock</span><span class="op" id="1852464">(</span><span class="op" id="1852465">)</span>&nbsp;<span class="op" id="1852467">}</span><br>
<span class="lineno"></span><span class="keyword" id="1852469">func</span>&nbsp;<span class="op" id="1852474">(</span><span class="ident" id="1852475">r</span>&nbsp;<span class="op" id="1852477">*</span><span class="ident" id="1852478"><a href="/sync/rwmutex.go.html#1852399">rlocker</a></span><span class="op" id="1852485">)</span>&nbsp;<span class="ident" id="1852487">Unlock</span><span class="op" id="1852493">(</span><span class="op" id="1852494">)</span>&nbsp;<span class="op" id="1852496">{</span>&nbsp;<span class="op" id="1852498">(</span><span class="op" id="1852499">*</span><span class="ident" id="1852500"><a href="/sync/rwmutex.go.html#1849178">RWMutex</a></span><span class="op" id="1852507">)</span><span class="op" id="1852508">(</span><span class="ident" id="1852509"><a href="/sync/rwmutex.go.html#1852475">r</a></span><span class="op" id="1852510">)</span><span class="op" id="1852511">.</span><span class="ident" id="1852512">RUnlock</span><span class="op" id="1852519">(</span><span class="op" id="1852520">)</span>&nbsp;<span class="op" id="1852522">}</span>
</div>
</body>
</html>
