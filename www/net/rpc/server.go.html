<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3071703">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3071758">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3071812">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3071863">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspPackage&nbsp;rpc&nbsp;provides&nbsp;access&nbsp;to&nbsp;the&nbsp;exported&nbsp;methods&nbsp;of&nbsp;an&nbsp;object&nbsp;across&nbsp;a<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspnetwork&nbsp;or&nbsp;other&nbsp;I/O&nbsp;connection.&nbsp;&nbsp;A&nbsp;server&nbsp;registers&nbsp;an&nbsp;object,&nbsp;making&nbsp;it&nbsp;visible<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspas&nbsp;a&nbsp;service&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;After&nbsp;registration,&nbsp;exported<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspmethods&nbsp;of&nbsp;the&nbsp;object&nbsp;will&nbsp;be&nbsp;accessible&nbsp;remotely.&nbsp;&nbsp;A&nbsp;server&nbsp;may&nbsp;register&nbsp;multiple<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;(services)&nbsp;of&nbsp;different&nbsp;types&nbsp;but&nbsp;it&nbsp;is&nbsp;an&nbsp;error&nbsp;to&nbsp;register&nbsp;multiple<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;of&nbsp;the&nbsp;same&nbsp;type.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspOnly&nbsp;methods&nbsp;that&nbsp;satisfy&nbsp;these&nbsp;criteria&nbsp;will&nbsp;be&nbsp;made&nbsp;available&nbsp;for&nbsp;remote&nbsp;access;<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspother&nbsp;methods&nbsp;will&nbsp;be&nbsp;ignored:<br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;is&nbsp;exported.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;exported&nbsp;(or&nbsp;builtin)&nbsp;types.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&#39;s&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;return&nbsp;type&nbsp;error.<br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspIn&nbsp;effect,&nbsp;the&nbsp;method&nbsp;must&nbsp;look&nbsp;schematically&nbsp;like<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*T)&nbsp;MethodName(argType&nbsp;T1,&nbsp;replyType&nbsp;*T2)&nbsp;error<br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbspwhere&nbsp;T,&nbsp;T1&nbsp;and&nbsp;T2&nbsp;can&nbsp;be&nbsp;marshaled&nbsp;by&nbsp;encoding/gob.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThese&nbsp;requirements&nbsp;apply&nbsp;even&nbsp;if&nbsp;a&nbsp;different&nbsp;codec&nbsp;is&nbsp;used.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp(In&nbsp;the&nbsp;future,&nbsp;these&nbsp;requirements&nbsp;may&nbsp;soften&nbsp;for&nbsp;custom&nbsp;codecs.)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;first&nbsp;argument&nbsp;represents&nbsp;the&nbsp;arguments&nbsp;provided&nbsp;by&nbsp;the&nbsp;caller;&nbsp;the<br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbspsecond&nbsp;argument&nbsp;represents&nbsp;the&nbsp;result&nbsp;parameters&nbsp;to&nbsp;be&nbsp;returned&nbsp;to&nbsp;the&nbsp;caller.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;return&nbsp;value,&nbsp;if&nbsp;non-nil,&nbsp;is&nbsp;passed&nbsp;back&nbsp;as&nbsp;a&nbsp;string&nbsp;that&nbsp;the&nbsp;client<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspsees&nbsp;as&nbsp;if&nbsp;created&nbsp;by&nbsp;errors.New.&nbsp;&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;returned,&nbsp;the&nbsp;reply&nbsp;parameter<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspwill&nbsp;not&nbsp;be&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;client.<br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;may&nbsp;handle&nbsp;requests&nbsp;on&nbsp;a&nbsp;single&nbsp;connection&nbsp;by&nbsp;calling&nbsp;ServeConn.&nbsp;&nbsp;More<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptypically&nbsp;it&nbsp;will&nbsp;create&nbsp;a&nbsp;network&nbsp;listener&nbsp;and&nbsp;call&nbsp;Accept&nbsp;or,&nbsp;for&nbsp;an&nbsp;HTTP<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplistener,&nbsp;HandleHTTP&nbsp;and&nbsp;http.Serve.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;client&nbsp;wishing&nbsp;to&nbsp;use&nbsp;the&nbsp;service&nbsp;establishes&nbsp;a&nbsp;connection&nbsp;and&nbsp;then&nbsp;invokes<br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbspNewClient&nbsp;on&nbsp;the&nbsp;connection.&nbsp;&nbsp;The&nbsp;convenience&nbsp;function&nbsp;Dial&nbsp;(DialHTTP)&nbsp;performs<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;steps&nbsp;for&nbsp;a&nbsp;raw&nbsp;network&nbsp;connection&nbsp;(an&nbsp;HTTP&nbsp;connection).&nbsp;&nbsp;The&nbsp;resulting<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspClient&nbsp;object&nbsp;has&nbsp;two&nbsp;methods,&nbsp;Call&nbsp;and&nbsp;Go,&nbsp;that&nbsp;specify&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspcall,&nbsp;a&nbsp;pointer&nbsp;containing&nbsp;the&nbsp;arguments,&nbsp;and&nbsp;a&nbsp;pointer&nbsp;to&nbsp;receive&nbsp;the&nbsp;result<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspparameters.<br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;Call&nbsp;method&nbsp;waits&nbsp;for&nbsp;the&nbsp;remote&nbsp;call&nbsp;to&nbsp;complete&nbsp;while&nbsp;the&nbsp;Go&nbsp;method<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplaunches&nbsp;the&nbsp;call&nbsp;asynchronously&nbsp;and&nbsp;signals&nbsp;completion&nbsp;using&nbsp;the&nbsp;Call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspstructure&#39;s&nbsp;Done&nbsp;channel.<br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbspUnless&nbsp;an&nbsp;explicit&nbsp;codec&nbsp;is&nbsp;set&nbsp;up,&nbsp;package&nbsp;encoding/gob&nbsp;is&nbsp;used&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptransport&nbsp;the&nbsp;data.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspHere&nbsp;is&nbsp;a&nbsp;simple&nbsp;example.&nbsp;&nbsp;A&nbsp;server&nbsp;wishes&nbsp;to&nbsp;export&nbsp;an&nbsp;object&nbsp;of&nbsp;type&nbsp;Arith:<br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;server<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Args&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspA,&nbsp;B&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Quotient&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspQuo,&nbsp;Rem&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Arith&nbsp;int<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Multiply(args&nbsp;*Args,&nbsp;reply&nbsp;*int)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp*reply&nbsp;=&nbsp;args.A&nbsp;*&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Divide(args&nbsp;*Args,&nbsp;quo&nbsp;*Quotient)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;args.B&nbsp;==&nbsp;0&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;errors.New(&#34;divide&nbsp;by&nbsp;zero&#34;)<br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Quo&nbsp;=&nbsp;args.A&nbsp;/&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Rem&nbsp;=&nbsp;args.A&nbsp;%&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;calls&nbsp;(for&nbsp;HTTP&nbsp;service):<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsparith&nbsp;:=&nbsp;new(Arith)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.Register(arith)<br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.HandleHTTP()<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspl,&nbsp;e&nbsp;:=&nbsp;net.Listen(&#34;tcp&#34;,&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;e&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;listen&nbsp;error:&#34;,&nbsp;e)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;http.Serve(l,&nbsp;nil)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspAt&nbsp;this&nbsp;point,&nbsp;clients&nbsp;can&nbsp;see&nbsp;a&nbsp;service&nbsp;&#34;Arith&#34;&nbsp;with&nbsp;methods&nbsp;&#34;Arith.Multiply&#34;&nbsp;and<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&#34;Arith.Divide&#34;.&nbsp;&nbsp;To&nbsp;invoke&nbsp;one,&nbsp;a&nbsp;client&nbsp;first&nbsp;dials&nbsp;the&nbsp;server:<br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspclient,&nbsp;err&nbsp;:=&nbsp;rpc.DialHTTP(&#34;tcp&#34;,&nbsp;serverAddress&nbsp;+&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;dialing:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbspThen&nbsp;it&nbsp;can&nbsp;make&nbsp;a&nbsp;remote&nbsp;call:<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Synchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspargs&nbsp;:=&nbsp;&amp;server.Args{7,8}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspvar&nbsp;reply&nbsp;int<br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;client.Call(&#34;Arith.Multiply&#34;,&nbsp;args,&nbsp;&amp;reply)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;arith&nbsp;error:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfmt.Printf(&#34;Arith:&nbsp;%d*%d=%d&#34;,&nbsp;args.A,&nbsp;args.B,&nbsp;reply)<br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspor<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Asynchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquotient&nbsp;:=&nbsp;new(Quotient)<br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspdivCall&nbsp;:=&nbsp;client.Go(&#34;Arith.Divide&#34;,&nbsp;args,&nbsp;quotient,&nbsp;nil)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreplyCall&nbsp;:=&nbsp;&lt;-divCall.Done&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;will&nbsp;be&nbsp;equal&nbsp;to&nbsp;divCall<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;check&nbsp;errors,&nbsp;print,&nbsp;etc.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;server&nbsp;implementation&nbsp;will&nbsp;often&nbsp;provide&nbsp;a&nbsp;simple,&nbsp;type-safe&nbsp;wrapper&nbsp;for&nbsp;the<br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbspclient.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="3075692">package</span>&nbsp;<span class="ident" id="3075700">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3075705">import</span>&nbsp;<span class="op" id="3075712">(</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3075715">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3075724">&#34;encoding/gob&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3075740">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3075750">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3075756">&#34;log&#34;</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3075763">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3075770">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3075782">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3075793">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3075804">&#34;sync&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3075812">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3075823">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="3075838">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3075841">const</span>&nbsp;<span class="op" id="3075847">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3075850">//&nbsp;Defaults&nbsp;used&nbsp;by&nbsp;HandleHTTP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075882">DefaultRPCPath</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3075899">=</span>&nbsp;<span class="string" id="3075901">&#34;/_goRPC_&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075913">DefaultDebugPath</span>&nbsp;<span class="op" id="3075930">=</span>&nbsp;<span class="string" id="3075932">&#34;/debug/rpc&#34;</span><br>
<span class="lineno"></span><span class="op" id="3075945">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="3075948">//&nbsp;Precompute&nbsp;the&nbsp;reflect&nbsp;type&nbsp;for&nbsp;error.&nbsp;&nbsp;Can&#39;t&nbsp;use&nbsp;error&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="3076016">//&nbsp;because&nbsp;Typeof&nbsp;takes&nbsp;an&nbsp;empty&nbsp;interface&nbsp;value.&nbsp;&nbsp;This&nbsp;is&nbsp;annoying.</span><br>
<span class="lineno"></span><span class="keyword" id="3076085">var</span>&nbsp;<span class="ident" id="3076089">typeOfError</span>&nbsp;<span class="op" id="3076101">=</span>&nbsp;<span class="ident" id="3076103">reflect</span><span class="op" id="3076110">.</span><span class="ident" id="3076111">TypeOf</span><span class="op" id="3076117">(</span><span class="op" id="3076118">(</span><span class="op" id="3076119">*</span><span class="builtintype" id="3076120">error</span><span class="op" id="3076125">)</span><span class="op" id="3076126">(</span><span class="ident" id="3076127">nil</span><span class="op" id="3076130">)</span><span class="op" id="3076131">)</span><span class="op" id="3076132">.</span><span class="ident" id="3076133">Elem</span><span class="op" id="3076137">(</span><span class="op" id="3076138">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3076141">type</span>&nbsp;<span class="ident" id="3076146">methodType</span>&nbsp;<span class="keyword" id="3076157">struct</span>&nbsp;<span class="op" id="3076164">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076167">sync</span><span class="op" id="3076171">.</span><span class="ident" id="3076172">Mutex</span>&nbsp;<span class="comment" id="3076178">//&nbsp;protects&nbsp;counters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076200">method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3076211">reflect</span><span class="op" id="3076218">.</span><span class="ident" id="3076219">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076227">ArgType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3076238">reflect</span><span class="op" id="3076245">.</span><span class="ident" id="3076246">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076252">ReplyType</span>&nbsp;&nbsp;<span class="ident" id="3076263">reflect</span><span class="op" id="3076270">.</span><span class="ident" id="3076271">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076277">numCalls</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3076288">uint</span><br>
<span class="lineno">155</span><span class="op" id="3076293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3076296">type</span>&nbsp;<span class="ident" id="3076301">service</span>&nbsp;<span class="keyword" id="3076309">struct</span>&nbsp;<span class="op" id="3076316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076319">name</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3076326">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3076349">//&nbsp;name&nbsp;of&nbsp;service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076369">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3076376">reflect</span><span class="op" id="3076383">.</span><span class="ident" id="3076384">Value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3076399">//&nbsp;receiver&nbsp;of&nbsp;methods&nbsp;for&nbsp;the&nbsp;service</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076439">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3076446">reflect</span><span class="op" id="3076453">.</span><span class="ident" id="3076454">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3076469">//&nbsp;type&nbsp;of&nbsp;the&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076494">method</span>&nbsp;<span class="keyword" id="3076501">map</span><span class="op" id="3076504">[</span><span class="builtintype" id="3076505">string</span><span class="op" id="3076511">]</span><span class="op" id="3076512">*</span><span class="ident" id="3076513">methodType</span>&nbsp;<span class="comment" id="3076524">//&nbsp;registered&nbsp;methods</span><br>
<span class="lineno"></span><span class="op" id="3076546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3076549">//&nbsp;Request&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;call.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno">165</span><span class="comment" id="3076626">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno"></span><span class="comment" id="3076696">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="3076716">type</span>&nbsp;<span class="ident" id="3076721">Request</span>&nbsp;<span class="keyword" id="3076729">struct</span>&nbsp;<span class="op" id="3076736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076739">ServiceMethod</span>&nbsp;<span class="builtintype" id="3076753">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3076762">//&nbsp;format:&nbsp;&#34;Service.Method&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076791">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3076805">uint64</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3076814">//&nbsp;sequence&nbsp;number&nbsp;chosen&nbsp;by&nbsp;client</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076851">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3076865">*</span><span class="ident" id="3076866">Request</span>&nbsp;<span class="comment" id="3076874">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="3076901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3076904">//&nbsp;Response&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;return.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno"></span><span class="comment" id="3076984">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno">175</span><span class="comment" id="3077054">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="3077074">type</span>&nbsp;<span class="ident" id="3077079">Response</span>&nbsp;<span class="keyword" id="3077088">struct</span>&nbsp;<span class="op" id="3077095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077098">ServiceMethod</span>&nbsp;<span class="builtintype" id="3077112">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3077122">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077153">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3077167">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3077177">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077208">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3077222">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3077232">//&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077251">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3077265">*</span><span class="ident" id="3077266">Response</span>&nbsp;<span class="comment" id="3077275">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="3077302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3077305">//&nbsp;Server&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="3077341">type</span>&nbsp;<span class="ident" id="3077346">Server</span>&nbsp;<span class="keyword" id="3077353">struct</span>&nbsp;<span class="op" id="3077360">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077363">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3077374">sync</span><span class="op" id="3077378">.</span><span class="ident" id="3077379">RWMutex</span>&nbsp;<span class="comment" id="3077387">//&nbsp;protects&nbsp;the&nbsp;serviceMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077415">serviceMap</span>&nbsp;<span class="keyword" id="3077426">map</span><span class="op" id="3077429">[</span><span class="builtintype" id="3077430">string</span><span class="op" id="3077436">]</span><span class="op" id="3077437">*</span><span class="ident" id="3077438">service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077447">reqLock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3077458">sync</span><span class="op" id="3077462">.</span><span class="ident" id="3077463">Mutex</span>&nbsp;<span class="comment" id="3077469">//&nbsp;protects&nbsp;freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077490">freeReq</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3077501">*</span><span class="ident" id="3077502">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077511">respLock</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3077522">sync</span><span class="op" id="3077526">.</span><span class="ident" id="3077527">Mutex</span>&nbsp;<span class="comment" id="3077533">//&nbsp;protects&nbsp;freeResp</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077555">freeResp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3077566">*</span><span class="ident" id="3077567">Response</span><br>
<span class="lineno"></span><span class="op" id="3077576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3077579">//&nbsp;NewServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="3077614">func</span>&nbsp;<span class="ident" id="3077619">NewServer</span><span class="op" id="3077628">(</span><span class="op" id="3077629">)</span>&nbsp;<span class="op" id="3077631">*</span><span class="ident" id="3077632">Server</span>&nbsp;<span class="op" id="3077639">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077642">return</span>&nbsp;<span class="op" id="3077649">&amp;</span><span class="ident" id="3077650">Server</span><span class="op" id="3077656">{</span><span class="ident" id="3077657">serviceMap</span><span class="op" id="3077667">:</span>&nbsp;<span class="builtinfunc" id="3077669">make</span><span class="op" id="3077673">(</span><span class="keyword" id="3077674">map</span><span class="op" id="3077677">[</span><span class="builtintype" id="3077678">string</span><span class="op" id="3077684">]</span><span class="op" id="3077685">*</span><span class="ident" id="3077686">service</span><span class="op" id="3077693">)</span><span class="op" id="3077694">}</span><br>
<span class="lineno"></span><span class="op" id="3077696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3077699">//&nbsp;DefaultServer&nbsp;is&nbsp;the&nbsp;default&nbsp;instance&nbsp;of&nbsp;*Server.</span><br>
<span class="lineno"></span><span class="keyword" id="3077752">var</span>&nbsp;<span class="ident" id="3077756">DefaultServer</span>&nbsp;<span class="op" id="3077770">=</span>&nbsp;<span class="ident" id="3077772">NewServer</span><span class="op" id="3077781">(</span><span class="op" id="3077782">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="3077785">//&nbsp;Is&nbsp;this&nbsp;an&nbsp;exported&nbsp;-&nbsp;upper&nbsp;case&nbsp;-&nbsp;name?</span><br>
<span class="lineno"></span><span class="keyword" id="3077829">func</span>&nbsp;<span class="ident" id="3077834">isExported</span><span class="op" id="3077844">(</span><span class="ident" id="3077845">name</span>&nbsp;<span class="builtintype" id="3077850">string</span><span class="op" id="3077856">)</span>&nbsp;<span class="builtintype" id="3077858">bool</span>&nbsp;<span class="op" id="3077863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3077866">rune</span><span class="op" id="3077870">,</span>&nbsp;<span class="ident" id="3077872">_</span>&nbsp;<span class="op" id="3077874">:=</span>&nbsp;<span class="ident" id="3077877">utf8</span><span class="op" id="3077881">.</span><span class="ident" id="3077882">DecodeRuneInString</span><span class="op" id="3077900">(</span><span class="ident" id="3077901">name</span><span class="op" id="3077905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077908">return</span>&nbsp;<span class="ident" id="3077915">unicode</span><span class="op" id="3077922">.</span><span class="ident" id="3077923">IsUpper</span><span class="op" id="3077930">(</span><span class="builtintype" id="3077931">rune</span><span class="op" id="3077935">)</span><br>
<span class="lineno">205</span><span class="op" id="3077937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3077940">//&nbsp;Is&nbsp;this&nbsp;type&nbsp;exported&nbsp;or&nbsp;a&nbsp;builtin?</span><br>
<span class="lineno"></span><span class="keyword" id="3077979">func</span>&nbsp;<span class="ident" id="3077984">isExportedOrBuiltinType</span><span class="op" id="3078007">(</span><span class="ident" id="3078008">t</span>&nbsp;<span class="ident" id="3078010">reflect</span><span class="op" id="3078017">.</span><span class="ident" id="3078018">Type</span><span class="op" id="3078022">)</span>&nbsp;<span class="builtintype" id="3078024">bool</span>&nbsp;<span class="op" id="3078029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078032">for</span>&nbsp;<span class="ident" id="3078036">t</span><span class="op" id="3078037">.</span><span class="ident" id="3078038">Kind</span><span class="op" id="3078042">(</span><span class="op" id="3078043">)</span>&nbsp;<span class="op" id="3078045">==</span>&nbsp;<span class="ident" id="3078048">reflect</span><span class="op" id="3078055">.</span><span class="ident" id="3078056">Ptr</span>&nbsp;<span class="op" id="3078060">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078064">t</span>&nbsp;<span class="op" id="3078066">=</span>&nbsp;<span class="ident" id="3078068">t</span><span class="op" id="3078069">.</span><span class="ident" id="3078070">Elem</span><span class="op" id="3078074">(</span><span class="op" id="3078075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3078081">//&nbsp;PkgPath&nbsp;will&nbsp;be&nbsp;non-empty&nbsp;even&nbsp;for&nbsp;an&nbsp;exported&nbsp;type,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3078138">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;the&nbsp;type&nbsp;name&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078185">return</span>&nbsp;<span class="ident" id="3078192">isExported</span><span class="op" id="3078202">(</span><span class="ident" id="3078203">t</span><span class="op" id="3078204">.</span><span class="ident" id="3078205">Name</span><span class="op" id="3078209">(</span><span class="op" id="3078210">)</span><span class="op" id="3078211">)</span>&nbsp;<span class="op" id="3078213">||</span>&nbsp;<span class="ident" id="3078216">t</span><span class="op" id="3078217">.</span><span class="ident" id="3078218">PkgPath</span><span class="op" id="3078225">(</span><span class="op" id="3078226">)</span>&nbsp;<span class="op" id="3078228">==</span>&nbsp;<span class="string" id="3078231">&#34;&#34;</span><br>
<span class="lineno">215</span><span class="op" id="3078234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3078237">//&nbsp;Register&nbsp;publishes&nbsp;in&nbsp;the&nbsp;server&nbsp;the&nbsp;set&nbsp;of&nbsp;methods&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3078299">//&nbsp;receiver&nbsp;value&nbsp;that&nbsp;satisfy&nbsp;the&nbsp;following&nbsp;conditions:</span><br>
<span class="lineno"></span><span class="comment" id="3078356">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;exported&nbsp;method</span><br>
<span class="lineno">220</span><span class="comment" id="3078377">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;of&nbsp;exported&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="3078419">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span><span class="comment" id="3078457">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;one&nbsp;return&nbsp;value,&nbsp;of&nbsp;type&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3078494">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;receiver&nbsp;is&nbsp;not&nbsp;an&nbsp;exported&nbsp;type&nbsp;or&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="3078564">//&nbsp;no&nbsp;suitable&nbsp;methods.&nbsp;It&nbsp;also&nbsp;logs&nbsp;the&nbsp;error&nbsp;using&nbsp;package&nbsp;log.</span><br>
<span class="lineno">225</span><span class="comment" id="3078630">//&nbsp;The&nbsp;client&nbsp;accesses&nbsp;each&nbsp;method&nbsp;using&nbsp;a&nbsp;string&nbsp;of&nbsp;the&nbsp;form&nbsp;&#34;Type.Method&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="3078707">//&nbsp;where&nbsp;Type&nbsp;is&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3078754">func</span>&nbsp;<span class="op" id="3078759">(</span><span class="ident" id="3078760">server</span>&nbsp;<span class="op" id="3078767">*</span><span class="ident" id="3078768">Server</span><span class="op" id="3078774">)</span>&nbsp;<span class="ident" id="3078776">Register</span><span class="op" id="3078784">(</span><span class="ident" id="3078785">rcvr</span>&nbsp;<span class="keyword" id="3078790">interface</span><span class="op" id="3078799">{</span><span class="op" id="3078800">}</span><span class="op" id="3078801">)</span>&nbsp;<span class="builtintype" id="3078803">error</span>&nbsp;<span class="op" id="3078809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078812">return</span>&nbsp;<span class="ident" id="3078819">server</span><span class="op" id="3078825">.</span><span class="ident" id="3078826">register</span><span class="op" id="3078834">(</span><span class="ident" id="3078835">rcvr</span><span class="op" id="3078839">,</span>&nbsp;<span class="string" id="3078841">&#34;&#34;</span><span class="op" id="3078843">,</span>&nbsp;<span class="ident" id="3078845">false</span><span class="op" id="3078850">)</span><br>
<span class="lineno"></span><span class="op" id="3078852">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="3078855">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="3078928">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3078972">func</span>&nbsp;<span class="op" id="3078977">(</span><span class="ident" id="3078978">server</span>&nbsp;<span class="op" id="3078985">*</span><span class="ident" id="3078986">Server</span><span class="op" id="3078992">)</span>&nbsp;<span class="ident" id="3078994">RegisterName</span><span class="op" id="3079006">(</span><span class="ident" id="3079007">name</span>&nbsp;<span class="builtintype" id="3079012">string</span><span class="op" id="3079018">,</span>&nbsp;<span class="ident" id="3079020">rcvr</span>&nbsp;<span class="keyword" id="3079025">interface</span><span class="op" id="3079034">{</span><span class="op" id="3079035">}</span><span class="op" id="3079036">)</span>&nbsp;<span class="builtintype" id="3079038">error</span>&nbsp;<span class="op" id="3079044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079047">return</span>&nbsp;<span class="ident" id="3079054">server</span><span class="op" id="3079060">.</span><span class="ident" id="3079061">register</span><span class="op" id="3079069">(</span><span class="ident" id="3079070">rcvr</span><span class="op" id="3079074">,</span>&nbsp;<span class="ident" id="3079076">name</span><span class="op" id="3079080">,</span>&nbsp;<span class="ident" id="3079082">true</span><span class="op" id="3079086">)</span><br>
<span class="lineno">235</span><span class="op" id="3079088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3079091">func</span>&nbsp;<span class="op" id="3079096">(</span><span class="ident" id="3079097">server</span>&nbsp;<span class="op" id="3079104">*</span><span class="ident" id="3079105">Server</span><span class="op" id="3079111">)</span>&nbsp;<span class="ident" id="3079113">register</span><span class="op" id="3079121">(</span><span class="ident" id="3079122">rcvr</span>&nbsp;<span class="keyword" id="3079127">interface</span><span class="op" id="3079136">{</span><span class="op" id="3079137">}</span><span class="op" id="3079138">,</span>&nbsp;<span class="ident" id="3079140">name</span>&nbsp;<span class="builtintype" id="3079145">string</span><span class="op" id="3079151">,</span>&nbsp;<span class="ident" id="3079153">useName</span>&nbsp;<span class="builtintype" id="3079161">bool</span><span class="op" id="3079165">)</span>&nbsp;<span class="builtintype" id="3079167">error</span>&nbsp;<span class="op" id="3079173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079176">server</span><span class="op" id="3079182">.</span><span class="ident" id="3079183">mu</span><span class="op" id="3079185">.</span><span class="ident" id="3079186">Lock</span><span class="op" id="3079190">(</span><span class="op" id="3079191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079194">defer</span>&nbsp;<span class="ident" id="3079200">server</span><span class="op" id="3079206">.</span><span class="ident" id="3079207">mu</span><span class="op" id="3079209">.</span><span class="ident" id="3079210">Unlock</span><span class="op" id="3079216">(</span><span class="op" id="3079217">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079220">if</span>&nbsp;<span class="ident" id="3079223">server</span><span class="op" id="3079229">.</span><span class="ident" id="3079230">serviceMap</span>&nbsp;<span class="op" id="3079241">==</span>&nbsp;<span class="ident" id="3079244">nil</span>&nbsp;<span class="op" id="3079248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079252">server</span><span class="op" id="3079258">.</span><span class="ident" id="3079259">serviceMap</span>&nbsp;<span class="op" id="3079270">=</span>&nbsp;<span class="builtinfunc" id="3079272">make</span><span class="op" id="3079276">(</span><span class="keyword" id="3079277">map</span><span class="op" id="3079280">[</span><span class="builtintype" id="3079281">string</span><span class="op" id="3079287">]</span><span class="op" id="3079288">*</span><span class="ident" id="3079289">service</span><span class="op" id="3079296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079302">s</span>&nbsp;<span class="op" id="3079304">:=</span>&nbsp;<span class="builtinfunc" id="3079307">new</span><span class="op" id="3079310">(</span><span class="ident" id="3079311">service</span><span class="op" id="3079318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079321">s</span><span class="op" id="3079322">.</span><span class="ident" id="3079323">typ</span>&nbsp;<span class="op" id="3079327">=</span>&nbsp;<span class="ident" id="3079329">reflect</span><span class="op" id="3079336">.</span><span class="ident" id="3079337">TypeOf</span><span class="op" id="3079343">(</span><span class="ident" id="3079344">rcvr</span><span class="op" id="3079348">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079351">s</span><span class="op" id="3079352">.</span><span class="ident" id="3079353">rcvr</span>&nbsp;<span class="op" id="3079358">=</span>&nbsp;<span class="ident" id="3079360">reflect</span><span class="op" id="3079367">.</span><span class="ident" id="3079368">ValueOf</span><span class="op" id="3079375">(</span><span class="ident" id="3079376">rcvr</span><span class="op" id="3079380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079383">sname</span>&nbsp;<span class="op" id="3079389">:=</span>&nbsp;<span class="ident" id="3079392">reflect</span><span class="op" id="3079399">.</span><span class="ident" id="3079400">Indirect</span><span class="op" id="3079408">(</span><span class="ident" id="3079409">s</span><span class="op" id="3079410">.</span><span class="ident" id="3079411">rcvr</span><span class="op" id="3079415">)</span><span class="op" id="3079416">.</span><span class="ident" id="3079417">Type</span><span class="op" id="3079421">(</span><span class="op" id="3079422">)</span><span class="op" id="3079423">.</span><span class="ident" id="3079424">Name</span><span class="op" id="3079428">(</span><span class="op" id="3079429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079432">if</span>&nbsp;<span class="ident" id="3079435">useName</span>&nbsp;<span class="op" id="3079443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079447">sname</span>&nbsp;<span class="op" id="3079453">=</span>&nbsp;<span class="ident" id="3079455">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079461">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079464">if</span>&nbsp;<span class="ident" id="3079467">sname</span>&nbsp;<span class="op" id="3079473">==</span>&nbsp;<span class="string" id="3079476">&#34;&#34;</span>&nbsp;<span class="op" id="3079479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079483">s</span>&nbsp;<span class="op" id="3079485">:=</span>&nbsp;<span class="string" id="3079488">&#34;rpc.Register:&nbsp;no&nbsp;service&nbsp;name&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="3079530">+</span>&nbsp;<span class="ident" id="3079532">s</span><span class="op" id="3079533">.</span><span class="ident" id="3079534">typ</span><span class="op" id="3079537">.</span><span class="ident" id="3079538">String</span><span class="op" id="3079544">(</span><span class="op" id="3079545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079549">log</span><span class="op" id="3079552">.</span><span class="ident" id="3079553">Print</span><span class="op" id="3079558">(</span><span class="ident" id="3079559">s</span><span class="op" id="3079560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079564">return</span>&nbsp;<span class="ident" id="3079571">errors</span><span class="op" id="3079577">.</span><span class="ident" id="3079578">New</span><span class="op" id="3079581">(</span><span class="ident" id="3079582">s</span><span class="op" id="3079583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079586">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079589">if</span>&nbsp;<span class="op" id="3079592">!</span><span class="ident" id="3079593">isExported</span><span class="op" id="3079603">(</span><span class="ident" id="3079604">sname</span><span class="op" id="3079609">)</span>&nbsp;<span class="op" id="3079611">&amp;&amp;</span>&nbsp;<span class="op" id="3079614">!</span><span class="ident" id="3079615">useName</span>&nbsp;<span class="op" id="3079623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079627">s</span>&nbsp;<span class="op" id="3079629">:=</span>&nbsp;<span class="string" id="3079632">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="3079654">+</span>&nbsp;<span class="ident" id="3079656">sname</span>&nbsp;<span class="op" id="3079662">+</span>&nbsp;<span class="string" id="3079664">&#34;&nbsp;is&nbsp;not&nbsp;exported&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079685">log</span><span class="op" id="3079688">.</span><span class="ident" id="3079689">Print</span><span class="op" id="3079694">(</span><span class="ident" id="3079695">s</span><span class="op" id="3079696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079700">return</span>&nbsp;<span class="ident" id="3079707">errors</span><span class="op" id="3079713">.</span><span class="ident" id="3079714">New</span><span class="op" id="3079717">(</span><span class="ident" id="3079718">s</span><span class="op" id="3079719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079722">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079725">if</span>&nbsp;<span class="ident" id="3079728">_</span><span class="op" id="3079729">,</span>&nbsp;<span class="ident" id="3079731">present</span>&nbsp;<span class="op" id="3079739">:=</span>&nbsp;<span class="ident" id="3079742">server</span><span class="op" id="3079748">.</span><span class="ident" id="3079749">serviceMap</span><span class="op" id="3079759">[</span><span class="ident" id="3079760">sname</span><span class="op" id="3079765">]</span><span class="op" id="3079766">;</span>&nbsp;<span class="ident" id="3079768">present</span>&nbsp;<span class="op" id="3079776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079780">return</span>&nbsp;<span class="ident" id="3079787">errors</span><span class="op" id="3079793">.</span><span class="ident" id="3079794">New</span><span class="op" id="3079797">(</span><span class="string" id="3079798">&#34;rpc:&nbsp;service&nbsp;already&nbsp;defined:&nbsp;&#34;</span>&nbsp;<span class="op" id="3079831">+</span>&nbsp;<span class="ident" id="3079833">sname</span><span class="op" id="3079838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079844">s</span><span class="op" id="3079845">.</span><span class="ident" id="3079846">name</span>&nbsp;<span class="op" id="3079851">=</span>&nbsp;<span class="ident" id="3079853">sname</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3079861">//&nbsp;Install&nbsp;the&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079885">s</span><span class="op" id="3079886">.</span><span class="ident" id="3079887">method</span>&nbsp;<span class="op" id="3079894">=</span>&nbsp;<span class="ident" id="3079896">suitableMethods</span><span class="op" id="3079911">(</span><span class="ident" id="3079912">s</span><span class="op" id="3079913">.</span><span class="ident" id="3079914">typ</span><span class="op" id="3079917">,</span>&nbsp;<span class="ident" id="3079919">true</span><span class="op" id="3079923">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079927">if</span>&nbsp;<span class="builtinfunc" id="3079930">len</span><span class="op" id="3079933">(</span><span class="ident" id="3079934">s</span><span class="op" id="3079935">.</span><span class="ident" id="3079936">method</span><span class="op" id="3079942">)</span>&nbsp;<span class="op" id="3079944">==</span>&nbsp;<span class="num" id="3079947">0</span>&nbsp;<span class="op" id="3079949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079953">str</span>&nbsp;<span class="op" id="3079957">:=</span>&nbsp;<span class="string" id="3079960">&#34;&#34;</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3079966">//&nbsp;To&nbsp;help&nbsp;the&nbsp;user,&nbsp;see&nbsp;if&nbsp;a&nbsp;pointer&nbsp;receiver&nbsp;would&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080027">method</span>&nbsp;<span class="op" id="3080034">:=</span>&nbsp;<span class="ident" id="3080037">suitableMethods</span><span class="op" id="3080052">(</span><span class="ident" id="3080053">reflect</span><span class="op" id="3080060">.</span><span class="ident" id="3080061">PtrTo</span><span class="op" id="3080066">(</span><span class="ident" id="3080067">s</span><span class="op" id="3080068">.</span><span class="ident" id="3080069">typ</span><span class="op" id="3080072">)</span><span class="op" id="3080073">,</span>&nbsp;<span class="ident" id="3080075">false</span><span class="op" id="3080080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080084">if</span>&nbsp;<span class="builtinfunc" id="3080087">len</span><span class="op" id="3080090">(</span><span class="ident" id="3080091">method</span><span class="op" id="3080097">)</span>&nbsp;<span class="op" id="3080099">!=</span>&nbsp;<span class="num" id="3080102">0</span>&nbsp;<span class="op" id="3080104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080109">str</span>&nbsp;<span class="op" id="3080113">=</span>&nbsp;<span class="string" id="3080115">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="3080137">+</span>&nbsp;<span class="ident" id="3080139">sname</span>&nbsp;<span class="op" id="3080145">+</span>&nbsp;<span class="string" id="3080147">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&nbsp;(hint:&nbsp;pass&nbsp;a&nbsp;pointer&nbsp;to&nbsp;value&nbsp;of&nbsp;that&nbsp;type)&#34;</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3080238">}</span>&nbsp;<span class="keyword" id="3080240">else</span>&nbsp;<span class="op" id="3080245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080250">str</span>&nbsp;<span class="op" id="3080254">=</span>&nbsp;<span class="string" id="3080256">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="3080278">+</span>&nbsp;<span class="ident" id="3080280">sname</span>&nbsp;<span class="op" id="3080286">+</span>&nbsp;<span class="string" id="3080288">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3080334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080338">log</span><span class="op" id="3080341">.</span><span class="ident" id="3080342">Print</span><span class="op" id="3080347">(</span><span class="ident" id="3080348">str</span><span class="op" id="3080351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080355">return</span>&nbsp;<span class="ident" id="3080362">errors</span><span class="op" id="3080368">.</span><span class="ident" id="3080369">New</span><span class="op" id="3080372">(</span><span class="ident" id="3080373">str</span><span class="op" id="3080376">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3080379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080382">server</span><span class="op" id="3080388">.</span><span class="ident" id="3080389">serviceMap</span><span class="op" id="3080399">[</span><span class="ident" id="3080400">s</span><span class="op" id="3080401">.</span><span class="ident" id="3080402">name</span><span class="op" id="3080406">]</span>&nbsp;<span class="op" id="3080408">=</span>&nbsp;<span class="ident" id="3080410">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080413">return</span>&nbsp;<span class="ident" id="3080420">nil</span><br>
<span class="lineno"></span><span class="op" id="3080424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="3080427">//&nbsp;suitableMethods&nbsp;returns&nbsp;suitable&nbsp;Rpc&nbsp;methods&nbsp;of&nbsp;typ,&nbsp;it&nbsp;will&nbsp;report</span><br>
<span class="lineno"></span><span class="comment" id="3080498">//&nbsp;error&nbsp;using&nbsp;log&nbsp;if&nbsp;reportErr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="3080539">func</span>&nbsp;<span class="ident" id="3080544">suitableMethods</span><span class="op" id="3080559">(</span><span class="ident" id="3080560">typ</span>&nbsp;<span class="ident" id="3080564">reflect</span><span class="op" id="3080571">.</span><span class="ident" id="3080572">Type</span><span class="op" id="3080576">,</span>&nbsp;<span class="ident" id="3080578">reportErr</span>&nbsp;<span class="builtintype" id="3080588">bool</span><span class="op" id="3080592">)</span>&nbsp;<span class="keyword" id="3080594">map</span><span class="op" id="3080597">[</span><span class="builtintype" id="3080598">string</span><span class="op" id="3080604">]</span><span class="op" id="3080605">*</span><span class="ident" id="3080606">methodType</span>&nbsp;<span class="op" id="3080617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080620">methods</span>&nbsp;<span class="op" id="3080628">:=</span>&nbsp;<span class="builtinfunc" id="3080631">make</span><span class="op" id="3080635">(</span><span class="keyword" id="3080636">map</span><span class="op" id="3080639">[</span><span class="builtintype" id="3080640">string</span><span class="op" id="3080646">]</span><span class="op" id="3080647">*</span><span class="ident" id="3080648">methodType</span><span class="op" id="3080658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080661">for</span>&nbsp;<span class="ident" id="3080665">m</span>&nbsp;<span class="op" id="3080667">:=</span>&nbsp;<span class="num" id="3080670">0</span><span class="op" id="3080671">;</span>&nbsp;<span class="ident" id="3080673">m</span>&nbsp;<span class="op" id="3080675">&lt;</span>&nbsp;<span class="ident" id="3080677">typ</span><span class="op" id="3080680">.</span><span class="ident" id="3080681">NumMethod</span><span class="op" id="3080690">(</span><span class="op" id="3080691">)</span><span class="op" id="3080692">;</span>&nbsp;<span class="ident" id="3080694">m</span><span class="op" id="3080695">++</span>&nbsp;<span class="op" id="3080698">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080702">method</span>&nbsp;<span class="op" id="3080709">:=</span>&nbsp;<span class="ident" id="3080712">typ</span><span class="op" id="3080715">.</span><span class="ident" id="3080716">Method</span><span class="op" id="3080722">(</span><span class="ident" id="3080723">m</span><span class="op" id="3080724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080728">mtype</span>&nbsp;<span class="op" id="3080734">:=</span>&nbsp;<span class="ident" id="3080737">method</span><span class="op" id="3080743">.</span><span class="ident" id="3080744">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080751">mname</span>&nbsp;<span class="op" id="3080757">:=</span>&nbsp;<span class="ident" id="3080760">method</span><span class="op" id="3080766">.</span><span class="ident" id="3080767">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3080774">//&nbsp;Method&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080804">if</span>&nbsp;<span class="ident" id="3080807">method</span><span class="op" id="3080813">.</span><span class="ident" id="3080814">PkgPath</span>&nbsp;<span class="op" id="3080822">!=</span>&nbsp;<span class="string" id="3080825">&#34;&#34;</span>&nbsp;<span class="op" id="3080828">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080833">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3080844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3080848">//&nbsp;Method&nbsp;needs&nbsp;three&nbsp;ins:&nbsp;receiver,&nbsp;*args,&nbsp;*reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080902">if</span>&nbsp;<span class="ident" id="3080905">mtype</span><span class="op" id="3080910">.</span><span class="ident" id="3080911">NumIn</span><span class="op" id="3080916">(</span><span class="op" id="3080917">)</span>&nbsp;<span class="op" id="3080919">!=</span>&nbsp;<span class="num" id="3080922">3</span>&nbsp;<span class="op" id="3080924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080929">if</span>&nbsp;<span class="ident" id="3080932">reportErr</span>&nbsp;<span class="op" id="3080942">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080948">log</span><span class="op" id="3080951">.</span><span class="ident" id="3080952">Println</span><span class="op" id="3080959">(</span><span class="string" id="3080960">&#34;method&#34;</span><span class="op" id="3080968">,</span>&nbsp;<span class="ident" id="3080970">mname</span><span class="op" id="3080975">,</span>&nbsp;<span class="string" id="3080977">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;ins:&#34;</span><span class="op" id="3081003">,</span>&nbsp;<span class="ident" id="3081005">mtype</span><span class="op" id="3081010">.</span><span class="ident" id="3081011">NumIn</span><span class="op" id="3081016">(</span><span class="op" id="3081017">)</span><span class="op" id="3081018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081028">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3081043">//&nbsp;First&nbsp;arg&nbsp;need&nbsp;not&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081081">argType</span>&nbsp;<span class="op" id="3081089">:=</span>&nbsp;<span class="ident" id="3081092">mtype</span><span class="op" id="3081097">.</span><span class="ident" id="3081098">In</span><span class="op" id="3081100">(</span><span class="num" id="3081101">1</span><span class="op" id="3081102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081106">if</span>&nbsp;<span class="op" id="3081109">!</span><span class="ident" id="3081110">isExportedOrBuiltinType</span><span class="op" id="3081133">(</span><span class="ident" id="3081134">argType</span><span class="op" id="3081141">)</span>&nbsp;<span class="op" id="3081143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081148">if</span>&nbsp;<span class="ident" id="3081151">reportErr</span>&nbsp;<span class="op" id="3081161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081167">log</span><span class="op" id="3081170">.</span><span class="ident" id="3081171">Println</span><span class="op" id="3081178">(</span><span class="ident" id="3081179">mname</span><span class="op" id="3081184">,</span>&nbsp;<span class="string" id="3081186">&#34;argument&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="3081215">,</span>&nbsp;<span class="ident" id="3081217">argType</span><span class="op" id="3081224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081229">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081234">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3081249">//&nbsp;Second&nbsp;arg&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081284">replyType</span>&nbsp;<span class="op" id="3081294">:=</span>&nbsp;<span class="ident" id="3081297">mtype</span><span class="op" id="3081302">.</span><span class="ident" id="3081303">In</span><span class="op" id="3081305">(</span><span class="num" id="3081306">2</span><span class="op" id="3081307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081311">if</span>&nbsp;<span class="ident" id="3081314">replyType</span><span class="op" id="3081323">.</span><span class="ident" id="3081324">Kind</span><span class="op" id="3081328">(</span><span class="op" id="3081329">)</span>&nbsp;<span class="op" id="3081331">!=</span>&nbsp;<span class="ident" id="3081334">reflect</span><span class="op" id="3081341">.</span><span class="ident" id="3081342">Ptr</span>&nbsp;<span class="op" id="3081346">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081351">if</span>&nbsp;<span class="ident" id="3081354">reportErr</span>&nbsp;<span class="op" id="3081364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081370">log</span><span class="op" id="3081373">.</span><span class="ident" id="3081374">Println</span><span class="op" id="3081381">(</span><span class="string" id="3081382">&#34;method&#34;</span><span class="op" id="3081390">,</span>&nbsp;<span class="ident" id="3081392">mname</span><span class="op" id="3081397">,</span>&nbsp;<span class="string" id="3081399">&#34;reply&nbsp;type&nbsp;not&nbsp;a&nbsp;pointer:&#34;</span><span class="op" id="3081426">,</span>&nbsp;<span class="ident" id="3081428">replyType</span><span class="op" id="3081437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081447">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081458">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3081462">//&nbsp;Reply&nbsp;type&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081496">if</span>&nbsp;<span class="op" id="3081499">!</span><span class="ident" id="3081500">isExportedOrBuiltinType</span><span class="op" id="3081523">(</span><span class="ident" id="3081524">replyType</span><span class="op" id="3081533">)</span>&nbsp;<span class="op" id="3081535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081540">if</span>&nbsp;<span class="ident" id="3081543">reportErr</span>&nbsp;<span class="op" id="3081553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081559">log</span><span class="op" id="3081562">.</span><span class="ident" id="3081563">Println</span><span class="op" id="3081570">(</span><span class="string" id="3081571">&#34;method&#34;</span><span class="op" id="3081579">,</span>&nbsp;<span class="ident" id="3081581">mname</span><span class="op" id="3081586">,</span>&nbsp;<span class="string" id="3081588">&#34;reply&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="3081614">,</span>&nbsp;<span class="ident" id="3081616">replyType</span><span class="op" id="3081625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081630">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081635">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3081650">//&nbsp;Method&nbsp;needs&nbsp;one&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081677">if</span>&nbsp;<span class="ident" id="3081680">mtype</span><span class="op" id="3081685">.</span><span class="ident" id="3081686">NumOut</span><span class="op" id="3081692">(</span><span class="op" id="3081693">)</span>&nbsp;<span class="op" id="3081695">!=</span>&nbsp;<span class="num" id="3081698">1</span>&nbsp;<span class="op" id="3081700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081705">if</span>&nbsp;<span class="ident" id="3081708">reportErr</span>&nbsp;<span class="op" id="3081718">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081724">log</span><span class="op" id="3081727">.</span><span class="ident" id="3081728">Println</span><span class="op" id="3081735">(</span><span class="string" id="3081736">&#34;method&#34;</span><span class="op" id="3081744">,</span>&nbsp;<span class="ident" id="3081746">mname</span><span class="op" id="3081751">,</span>&nbsp;<span class="string" id="3081753">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;outs:&#34;</span><span class="op" id="3081780">,</span>&nbsp;<span class="ident" id="3081782">mtype</span><span class="op" id="3081787">.</span><span class="ident" id="3081788">NumOut</span><span class="op" id="3081794">(</span><span class="op" id="3081795">)</span><span class="op" id="3081796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081806">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3081821">//&nbsp;The&nbsp;return&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;must&nbsp;be&nbsp;error.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081871">if</span>&nbsp;<span class="ident" id="3081874">returnType</span>&nbsp;<span class="op" id="3081885">:=</span>&nbsp;<span class="ident" id="3081888">mtype</span><span class="op" id="3081893">.</span><span class="ident" id="3081894">Out</span><span class="op" id="3081897">(</span><span class="num" id="3081898">0</span><span class="op" id="3081899">)</span><span class="op" id="3081900">;</span>&nbsp;<span class="ident" id="3081902">returnType</span>&nbsp;<span class="op" id="3081913">!=</span>&nbsp;<span class="ident" id="3081916">typeOfError</span>&nbsp;<span class="op" id="3081928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081933">if</span>&nbsp;<span class="ident" id="3081936">reportErr</span>&nbsp;<span class="op" id="3081946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081952">log</span><span class="op" id="3081955">.</span><span class="ident" id="3081956">Println</span><span class="op" id="3081963">(</span><span class="string" id="3081964">&#34;method&#34;</span><span class="op" id="3081972">,</span>&nbsp;<span class="ident" id="3081974">mname</span><span class="op" id="3081979">,</span>&nbsp;<span class="string" id="3081981">&#34;returns&#34;</span><span class="op" id="3081990">,</span>&nbsp;<span class="ident" id="3081992">returnType</span><span class="op" id="3082002">.</span><span class="ident" id="3082003">String</span><span class="op" id="3082009">(</span><span class="op" id="3082010">)</span><span class="op" id="3082011">,</span>&nbsp;<span class="string" id="3082013">&#34;not&nbsp;error&#34;</span><span class="op" id="3082024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3082029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082034">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3082045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082049">methods</span><span class="op" id="3082056">[</span><span class="ident" id="3082057">mname</span><span class="op" id="3082062">]</span>&nbsp;<span class="op" id="3082064">=</span>&nbsp;<span class="op" id="3082066">&amp;</span><span class="ident" id="3082067">methodType</span><span class="op" id="3082077">{</span><span class="ident" id="3082078">method</span><span class="op" id="3082084">:</span>&nbsp;<span class="ident" id="3082086">method</span><span class="op" id="3082092">,</span>&nbsp;<span class="ident" id="3082094">ArgType</span><span class="op" id="3082101">:</span>&nbsp;<span class="ident" id="3082103">argType</span><span class="op" id="3082110">,</span>&nbsp;<span class="ident" id="3082112">ReplyType</span><span class="op" id="3082121">:</span>&nbsp;<span class="ident" id="3082123">replyType</span><span class="op" id="3082132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3082135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082138">return</span>&nbsp;<span class="ident" id="3082145">methods</span><br>
<span class="lineno"></span><span class="op" id="3082153">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span><span class="comment" id="3082156">//&nbsp;A&nbsp;value&nbsp;sent&nbsp;as&nbsp;a&nbsp;placeholder&nbsp;for&nbsp;the&nbsp;server&#39;s&nbsp;response&nbsp;value&nbsp;when&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="3082237">//&nbsp;receives&nbsp;an&nbsp;invalid&nbsp;request.&nbsp;It&nbsp;is&nbsp;never&nbsp;decoded&nbsp;by&nbsp;the&nbsp;client&nbsp;since&nbsp;the&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="3082322">//&nbsp;contains&nbsp;an&nbsp;error&nbsp;when&nbsp;it&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3082360">var</span>&nbsp;<span class="ident" id="3082364">invalidRequest</span>&nbsp;<span class="op" id="3082379">=</span>&nbsp;<span class="keyword" id="3082381">struct</span><span class="op" id="3082387">{</span><span class="op" id="3082388">}</span><span class="op" id="3082389">{</span><span class="op" id="3082390">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="3082393">func</span>&nbsp;<span class="op" id="3082398">(</span><span class="ident" id="3082399">server</span>&nbsp;<span class="op" id="3082406">*</span><span class="ident" id="3082407">Server</span><span class="op" id="3082413">)</span>&nbsp;<span class="ident" id="3082415">sendResponse</span><span class="op" id="3082427">(</span><span class="ident" id="3082428">sending</span>&nbsp;<span class="op" id="3082436">*</span><span class="ident" id="3082437">sync</span><span class="op" id="3082441">.</span><span class="ident" id="3082442">Mutex</span><span class="op" id="3082447">,</span>&nbsp;<span class="ident" id="3082449">req</span>&nbsp;<span class="op" id="3082453">*</span><span class="ident" id="3082454">Request</span><span class="op" id="3082461">,</span>&nbsp;<span class="ident" id="3082463">reply</span>&nbsp;<span class="keyword" id="3082469">interface</span><span class="op" id="3082478">{</span><span class="op" id="3082479">}</span><span class="op" id="3082480">,</span>&nbsp;<span class="ident" id="3082482">codec</span>&nbsp;<span class="ident" id="3082488">ServerCodec</span><span class="op" id="3082499">,</span>&nbsp;<span class="ident" id="3082501">errmsg</span>&nbsp;<span class="builtintype" id="3082508">string</span><span class="op" id="3082514">)</span>&nbsp;<span class="op" id="3082516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082519">resp</span>&nbsp;<span class="op" id="3082524">:=</span>&nbsp;<span class="ident" id="3082527">server</span><span class="op" id="3082533">.</span><span class="ident" id="3082534">getResponse</span><span class="op" id="3082545">(</span><span class="op" id="3082546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3082549">//&nbsp;Encode&nbsp;the&nbsp;response&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082580">resp</span><span class="op" id="3082584">.</span><span class="ident" id="3082585">ServiceMethod</span>&nbsp;<span class="op" id="3082599">=</span>&nbsp;<span class="ident" id="3082601">req</span><span class="op" id="3082604">.</span><span class="ident" id="3082605">ServiceMethod</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082620">if</span>&nbsp;<span class="ident" id="3082623">errmsg</span>&nbsp;<span class="op" id="3082630">!=</span>&nbsp;<span class="string" id="3082633">&#34;&#34;</span>&nbsp;<span class="op" id="3082636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082640">resp</span><span class="op" id="3082644">.</span><span class="ident" id="3082645">Error</span>&nbsp;<span class="op" id="3082651">=</span>&nbsp;<span class="ident" id="3082653">errmsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082662">reply</span>&nbsp;<span class="op" id="3082668">=</span>&nbsp;<span class="ident" id="3082670">invalidRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3082686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082689">resp</span><span class="op" id="3082693">.</span><span class="ident" id="3082694">Seq</span>&nbsp;<span class="op" id="3082698">=</span>&nbsp;<span class="ident" id="3082700">req</span><span class="op" id="3082703">.</span><span class="ident" id="3082704">Seq</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082709">sending</span><span class="op" id="3082716">.</span><span class="ident" id="3082717">Lock</span><span class="op" id="3082721">(</span><span class="op" id="3082722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082725">err</span>&nbsp;<span class="op" id="3082729">:=</span>&nbsp;<span class="ident" id="3082732">codec</span><span class="op" id="3082737">.</span><span class="ident" id="3082738">WriteResponse</span><span class="op" id="3082751">(</span><span class="ident" id="3082752">resp</span><span class="op" id="3082756">,</span>&nbsp;<span class="ident" id="3082758">reply</span><span class="op" id="3082763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082766">if</span>&nbsp;<span class="ident" id="3082769">debugLog</span>&nbsp;<span class="op" id="3082778">&amp;&amp;</span>&nbsp;<span class="ident" id="3082781">err</span>&nbsp;<span class="op" id="3082785">!=</span>&nbsp;<span class="ident" id="3082788">nil</span>&nbsp;<span class="op" id="3082792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082796">log</span><span class="op" id="3082799">.</span><span class="ident" id="3082800">Println</span><span class="op" id="3082807">(</span><span class="string" id="3082808">&#34;rpc:&nbsp;writing&nbsp;response:&#34;</span><span class="op" id="3082832">,</span>&nbsp;<span class="ident" id="3082834">err</span><span class="op" id="3082837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3082840">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082843">sending</span><span class="op" id="3082850">.</span><span class="ident" id="3082851">Unlock</span><span class="op" id="3082857">(</span><span class="op" id="3082858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082861">server</span><span class="op" id="3082867">.</span><span class="ident" id="3082868">freeResponse</span><span class="op" id="3082880">(</span><span class="ident" id="3082881">resp</span><span class="op" id="3082885">)</span><br>
<span class="lineno"></span><span class="op" id="3082887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3082890">func</span>&nbsp;<span class="op" id="3082895">(</span><span class="ident" id="3082896">m</span>&nbsp;<span class="op" id="3082898">*</span><span class="ident" id="3082899">methodType</span><span class="op" id="3082909">)</span>&nbsp;<span class="ident" id="3082911">NumCalls</span><span class="op" id="3082919">(</span><span class="op" id="3082920">)</span>&nbsp;<span class="op" id="3082922">(</span><span class="ident" id="3082923">n</span>&nbsp;<span class="builtintype" id="3082925">uint</span><span class="op" id="3082929">)</span>&nbsp;<span class="op" id="3082931">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082934">m</span><span class="op" id="3082935">.</span><span class="ident" id="3082936">Lock</span><span class="op" id="3082940">(</span><span class="op" id="3082941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082944">n</span>&nbsp;<span class="op" id="3082946">=</span>&nbsp;<span class="ident" id="3082948">m</span><span class="op" id="3082949">.</span><span class="ident" id="3082950">numCalls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3082960">m</span><span class="op" id="3082961">.</span><span class="ident" id="3082962">Unlock</span><span class="op" id="3082968">(</span><span class="op" id="3082969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3082972">return</span>&nbsp;<span class="ident" id="3082979">n</span><br>
<span class="lineno"></span><span class="op" id="3082981">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="3082984">func</span>&nbsp;<span class="op" id="3082989">(</span><span class="ident" id="3082990">s</span>&nbsp;<span class="op" id="3082992">*</span><span class="ident" id="3082993">service</span><span class="op" id="3083000">)</span>&nbsp;<span class="ident" id="3083002">call</span><span class="op" id="3083006">(</span><span class="ident" id="3083007">server</span>&nbsp;<span class="op" id="3083014">*</span><span class="ident" id="3083015">Server</span><span class="op" id="3083021">,</span>&nbsp;<span class="ident" id="3083023">sending</span>&nbsp;<span class="op" id="3083031">*</span><span class="ident" id="3083032">sync</span><span class="op" id="3083036">.</span><span class="ident" id="3083037">Mutex</span><span class="op" id="3083042">,</span>&nbsp;<span class="ident" id="3083044">mtype</span>&nbsp;<span class="op" id="3083050">*</span><span class="ident" id="3083051">methodType</span><span class="op" id="3083061">,</span>&nbsp;<span class="ident" id="3083063">req</span>&nbsp;<span class="op" id="3083067">*</span><span class="ident" id="3083068">Request</span><span class="op" id="3083075">,</span>&nbsp;<span class="ident" id="3083077">argv</span><span class="op" id="3083081">,</span>&nbsp;<span class="ident" id="3083083">replyv</span>&nbsp;<span class="ident" id="3083090">reflect</span><span class="op" id="3083097">.</span><span class="ident" id="3083098">Value</span><span class="op" id="3083103">,</span>&nbsp;<span class="ident" id="3083105">codec</span>&nbsp;<span class="ident" id="3083111">ServerCodec</span><span class="op" id="3083122">)</span>&nbsp;<span class="op" id="3083124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083127">mtype</span><span class="op" id="3083132">.</span><span class="ident" id="3083133">Lock</span><span class="op" id="3083137">(</span><span class="op" id="3083138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083141">mtype</span><span class="op" id="3083146">.</span><span class="ident" id="3083147">numCalls</span><span class="op" id="3083155">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083159">mtype</span><span class="op" id="3083164">.</span><span class="ident" id="3083165">Unlock</span><span class="op" id="3083171">(</span><span class="op" id="3083172">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083175">function</span>&nbsp;<span class="op" id="3083184">:=</span>&nbsp;<span class="ident" id="3083187">mtype</span><span class="op" id="3083192">.</span><span class="ident" id="3083193">method</span><span class="op" id="3083199">.</span><span class="ident" id="3083200">Func</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3083206">//&nbsp;Invoke&nbsp;the&nbsp;method,&nbsp;providing&nbsp;a&nbsp;new&nbsp;value&nbsp;for&nbsp;the&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083266">returnValues</span>&nbsp;<span class="op" id="3083279">:=</span>&nbsp;<span class="ident" id="3083282">function</span><span class="op" id="3083290">.</span><span class="ident" id="3083291">Call</span><span class="op" id="3083295">(</span><span class="op" id="3083296">[</span><span class="op" id="3083297">]</span><span class="ident" id="3083298">reflect</span><span class="op" id="3083305">.</span><span class="ident" id="3083306">Value</span><span class="op" id="3083311">{</span><span class="ident" id="3083312">s</span><span class="op" id="3083313">.</span><span class="ident" id="3083314">rcvr</span><span class="op" id="3083318">,</span>&nbsp;<span class="ident" id="3083320">argv</span><span class="op" id="3083324">,</span>&nbsp;<span class="ident" id="3083326">replyv</span><span class="op" id="3083332">}</span><span class="op" id="3083333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3083336">//&nbsp;The&nbsp;return&nbsp;value&nbsp;for&nbsp;the&nbsp;method&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083385">errInter</span>&nbsp;<span class="op" id="3083394">:=</span>&nbsp;<span class="ident" id="3083397">returnValues</span><span class="op" id="3083409">[</span><span class="num" id="3083410">0</span><span class="op" id="3083411">]</span><span class="op" id="3083412">.</span><span class="ident" id="3083413">Interface</span><span class="op" id="3083422">(</span><span class="op" id="3083423">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083426">errmsg</span>&nbsp;<span class="op" id="3083433">:=</span>&nbsp;<span class="string" id="3083436">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083440">if</span>&nbsp;<span class="ident" id="3083443">errInter</span>&nbsp;<span class="op" id="3083452">!=</span>&nbsp;<span class="ident" id="3083455">nil</span>&nbsp;<span class="op" id="3083459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083463">errmsg</span>&nbsp;<span class="op" id="3083470">=</span>&nbsp;<span class="ident" id="3083472">errInter</span><span class="op" id="3083480">.</span><span class="op" id="3083481">(</span><span class="builtintype" id="3083482">error</span><span class="op" id="3083487">)</span><span class="op" id="3083488">.</span><span class="ident" id="3083489">Error</span><span class="op" id="3083494">(</span><span class="op" id="3083495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3083498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083501">server</span><span class="op" id="3083507">.</span><span class="ident" id="3083508">sendResponse</span><span class="op" id="3083520">(</span><span class="ident" id="3083521">sending</span><span class="op" id="3083528">,</span>&nbsp;<span class="ident" id="3083530">req</span><span class="op" id="3083533">,</span>&nbsp;<span class="ident" id="3083535">replyv</span><span class="op" id="3083541">.</span><span class="ident" id="3083542">Interface</span><span class="op" id="3083551">(</span><span class="op" id="3083552">)</span><span class="op" id="3083553">,</span>&nbsp;<span class="ident" id="3083555">codec</span><span class="op" id="3083560">,</span>&nbsp;<span class="ident" id="3083562">errmsg</span><span class="op" id="3083568">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083571">server</span><span class="op" id="3083577">.</span><span class="ident" id="3083578">freeRequest</span><span class="op" id="3083589">(</span><span class="ident" id="3083590">req</span><span class="op" id="3083593">)</span><br>
<span class="lineno"></span><span class="op" id="3083595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3083598">type</span>&nbsp;<span class="ident" id="3083603">gobServerCodec</span>&nbsp;<span class="keyword" id="3083618">struct</span>&nbsp;<span class="op" id="3083625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083628">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3083635">io</span><span class="op" id="3083637">.</span><span class="ident" id="3083638">ReadWriteCloser</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083655">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3083662">*</span><span class="ident" id="3083663">gob</span><span class="op" id="3083666">.</span><span class="ident" id="3083667">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083676">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3083683">*</span><span class="ident" id="3083684">gob</span><span class="op" id="3083687">.</span><span class="ident" id="3083688">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083697">encBuf</span>&nbsp;<span class="op" id="3083704">*</span><span class="ident" id="3083705">bufio</span><span class="op" id="3083710">.</span><span class="ident" id="3083711">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083719">closed</span>&nbsp;<span class="builtintype" id="3083726">bool</span><br>
<span class="lineno"></span><span class="op" id="3083731">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="3083734">func</span>&nbsp;<span class="op" id="3083739">(</span><span class="ident" id="3083740">c</span>&nbsp;<span class="op" id="3083742">*</span><span class="ident" id="3083743">gobServerCodec</span><span class="op" id="3083757">)</span>&nbsp;<span class="ident" id="3083759">ReadRequestHeader</span><span class="op" id="3083776">(</span><span class="ident" id="3083777">r</span>&nbsp;<span class="op" id="3083779">*</span><span class="ident" id="3083780">Request</span><span class="op" id="3083787">)</span>&nbsp;<span class="builtintype" id="3083789">error</span>&nbsp;<span class="op" id="3083795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083798">return</span>&nbsp;<span class="ident" id="3083805">c</span><span class="op" id="3083806">.</span><span class="ident" id="3083807">dec</span><span class="op" id="3083810">.</span><span class="ident" id="3083811">Decode</span><span class="op" id="3083817">(</span><span class="ident" id="3083818">r</span><span class="op" id="3083819">)</span><br>
<span class="lineno"></span><span class="op" id="3083821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="3083824">func</span>&nbsp;<span class="op" id="3083829">(</span><span class="ident" id="3083830">c</span>&nbsp;<span class="op" id="3083832">*</span><span class="ident" id="3083833">gobServerCodec</span><span class="op" id="3083847">)</span>&nbsp;<span class="ident" id="3083849">ReadRequestBody</span><span class="op" id="3083864">(</span><span class="ident" id="3083865">body</span>&nbsp;<span class="keyword" id="3083870">interface</span><span class="op" id="3083879">{</span><span class="op" id="3083880">}</span><span class="op" id="3083881">)</span>&nbsp;<span class="builtintype" id="3083883">error</span>&nbsp;<span class="op" id="3083889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083892">return</span>&nbsp;<span class="ident" id="3083899">c</span><span class="op" id="3083900">.</span><span class="ident" id="3083901">dec</span><span class="op" id="3083904">.</span><span class="ident" id="3083905">Decode</span><span class="op" id="3083911">(</span><span class="ident" id="3083912">body</span><span class="op" id="3083916">)</span><br>
<span class="lineno"></span><span class="op" id="3083918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3083921">func</span>&nbsp;<span class="op" id="3083926">(</span><span class="ident" id="3083927">c</span>&nbsp;<span class="op" id="3083929">*</span><span class="ident" id="3083930">gobServerCodec</span><span class="op" id="3083944">)</span>&nbsp;<span class="ident" id="3083946">WriteResponse</span><span class="op" id="3083959">(</span><span class="ident" id="3083960">r</span>&nbsp;<span class="op" id="3083962">*</span><span class="ident" id="3083963">Response</span><span class="op" id="3083971">,</span>&nbsp;<span class="ident" id="3083973">body</span>&nbsp;<span class="keyword" id="3083978">interface</span><span class="op" id="3083987">{</span><span class="op" id="3083988">}</span><span class="op" id="3083989">)</span>&nbsp;<span class="op" id="3083991">(</span><span class="ident" id="3083992">err</span>&nbsp;<span class="builtintype" id="3083996">error</span><span class="op" id="3084001">)</span>&nbsp;<span class="op" id="3084003">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084006">if</span>&nbsp;<span class="ident" id="3084009">err</span>&nbsp;<span class="op" id="3084013">=</span>&nbsp;<span class="ident" id="3084015">c</span><span class="op" id="3084016">.</span><span class="ident" id="3084017">enc</span><span class="op" id="3084020">.</span><span class="ident" id="3084021">Encode</span><span class="op" id="3084027">(</span><span class="ident" id="3084028">r</span><span class="op" id="3084029">)</span><span class="op" id="3084030">;</span>&nbsp;<span class="ident" id="3084032">err</span>&nbsp;<span class="op" id="3084036">!=</span>&nbsp;<span class="ident" id="3084039">nil</span>&nbsp;<span class="op" id="3084043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084047">if</span>&nbsp;<span class="ident" id="3084050">c</span><span class="op" id="3084051">.</span><span class="ident" id="3084052">encBuf</span><span class="op" id="3084058">.</span><span class="ident" id="3084059">Flush</span><span class="op" id="3084064">(</span><span class="op" id="3084065">)</span>&nbsp;<span class="op" id="3084067">==</span>&nbsp;<span class="ident" id="3084070">nil</span>&nbsp;<span class="op" id="3084074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3084079">//&nbsp;Gob&nbsp;couldn&#39;t&nbsp;encode&nbsp;the&nbsp;header.&nbsp;Should&nbsp;not&nbsp;happen,&nbsp;so&nbsp;if&nbsp;it&nbsp;does,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3084151">//&nbsp;shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084223">log</span><span class="op" id="3084226">.</span><span class="ident" id="3084227">Println</span><span class="op" id="3084234">(</span><span class="string" id="3084235">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;response:&#34;</span><span class="op" id="3084270">,</span>&nbsp;<span class="ident" id="3084272">err</span><span class="op" id="3084275">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084280">c</span><span class="op" id="3084281">.</span><span class="ident" id="3084282">Close</span><span class="op" id="3084287">(</span><span class="op" id="3084288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084296">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084307">if</span>&nbsp;<span class="ident" id="3084310">err</span>&nbsp;<span class="op" id="3084314">=</span>&nbsp;<span class="ident" id="3084316">c</span><span class="op" id="3084317">.</span><span class="ident" id="3084318">enc</span><span class="op" id="3084321">.</span><span class="ident" id="3084322">Encode</span><span class="op" id="3084328">(</span><span class="ident" id="3084329">body</span><span class="op" id="3084333">)</span><span class="op" id="3084334">;</span>&nbsp;<span class="ident" id="3084336">err</span>&nbsp;<span class="op" id="3084340">!=</span>&nbsp;<span class="ident" id="3084343">nil</span>&nbsp;<span class="op" id="3084347">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084351">if</span>&nbsp;<span class="ident" id="3084354">c</span><span class="op" id="3084355">.</span><span class="ident" id="3084356">encBuf</span><span class="op" id="3084362">.</span><span class="ident" id="3084363">Flush</span><span class="op" id="3084368">(</span><span class="op" id="3084369">)</span>&nbsp;<span class="op" id="3084371">==</span>&nbsp;<span class="ident" id="3084374">nil</span>&nbsp;<span class="op" id="3084378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3084383">//&nbsp;Was&nbsp;a&nbsp;gob&nbsp;problem&nbsp;encoding&nbsp;the&nbsp;body&nbsp;but&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3084458">//&nbsp;Shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084530">log</span><span class="op" id="3084533">.</span><span class="ident" id="3084534">Println</span><span class="op" id="3084541">(</span><span class="string" id="3084542">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;body:&#34;</span><span class="op" id="3084573">,</span>&nbsp;<span class="ident" id="3084575">err</span><span class="op" id="3084578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084583">c</span><span class="op" id="3084584">.</span><span class="ident" id="3084585">Close</span><span class="op" id="3084590">(</span><span class="op" id="3084591">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084599">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084610">return</span>&nbsp;<span class="ident" id="3084617">c</span><span class="op" id="3084618">.</span><span class="ident" id="3084619">encBuf</span><span class="op" id="3084625">.</span><span class="ident" id="3084626">Flush</span><span class="op" id="3084631">(</span><span class="op" id="3084632">)</span><br>
<span class="lineno"></span><span class="op" id="3084634">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="3084637">func</span>&nbsp;<span class="op" id="3084642">(</span><span class="ident" id="3084643">c</span>&nbsp;<span class="op" id="3084645">*</span><span class="ident" id="3084646">gobServerCodec</span><span class="op" id="3084660">)</span>&nbsp;<span class="ident" id="3084662">Close</span><span class="op" id="3084667">(</span><span class="op" id="3084668">)</span>&nbsp;<span class="builtintype" id="3084670">error</span>&nbsp;<span class="op" id="3084676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084679">if</span>&nbsp;<span class="ident" id="3084682">c</span><span class="op" id="3084683">.</span><span class="ident" id="3084684">closed</span>&nbsp;<span class="op" id="3084691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3084695">//&nbsp;Only&nbsp;call&nbsp;c.rwc.Close&nbsp;once;&nbsp;otherwise&nbsp;the&nbsp;semantics&nbsp;are&nbsp;undefined.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084767">return</span>&nbsp;<span class="ident" id="3084774">nil</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084782">c</span><span class="op" id="3084783">.</span><span class="ident" id="3084784">closed</span>&nbsp;<span class="op" id="3084791">=</span>&nbsp;<span class="ident" id="3084793">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084799">return</span>&nbsp;<span class="ident" id="3084806">c</span><span class="op" id="3084807">.</span><span class="ident" id="3084808">rwc</span><span class="op" id="3084811">.</span><span class="ident" id="3084812">Close</span><span class="op" id="3084817">(</span><span class="op" id="3084818">)</span><br>
<span class="lineno"></span><span class="op" id="3084820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span><span class="comment" id="3084823">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3084876">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="3084947">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="3085008">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3085071">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">445</span><span class="keyword" id="3085130">func</span>&nbsp;<span class="op" id="3085135">(</span><span class="ident" id="3085136">server</span>&nbsp;<span class="op" id="3085143">*</span><span class="ident" id="3085144">Server</span><span class="op" id="3085150">)</span>&nbsp;<span class="ident" id="3085152">ServeConn</span><span class="op" id="3085161">(</span><span class="ident" id="3085162">conn</span>&nbsp;<span class="ident" id="3085167">io</span><span class="op" id="3085169">.</span><span class="ident" id="3085170">ReadWriteCloser</span><span class="op" id="3085185">)</span>&nbsp;<span class="op" id="3085187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085190">buf</span>&nbsp;<span class="op" id="3085194">:=</span>&nbsp;<span class="ident" id="3085197">bufio</span><span class="op" id="3085202">.</span><span class="ident" id="3085203">NewWriter</span><span class="op" id="3085212">(</span><span class="ident" id="3085213">conn</span><span class="op" id="3085217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085220">srv</span>&nbsp;<span class="op" id="3085224">:=</span>&nbsp;<span class="op" id="3085227">&amp;</span><span class="ident" id="3085228">gobServerCodec</span><span class="op" id="3085242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085246">rwc</span><span class="op" id="3085249">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085254">conn</span><span class="op" id="3085258">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085262">dec</span><span class="op" id="3085265">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085270">gob</span><span class="op" id="3085273">.</span><span class="ident" id="3085274">NewDecoder</span><span class="op" id="3085284">(</span><span class="ident" id="3085285">conn</span><span class="op" id="3085289">)</span><span class="op" id="3085290">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085294">enc</span><span class="op" id="3085297">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085302">gob</span><span class="op" id="3085305">.</span><span class="ident" id="3085306">NewEncoder</span><span class="op" id="3085316">(</span><span class="ident" id="3085317">buf</span><span class="op" id="3085320">)</span><span class="op" id="3085321">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085325">encBuf</span><span class="op" id="3085331">:</span>&nbsp;<span class="ident" id="3085333">buf</span><span class="op" id="3085336">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3085339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085342">server</span><span class="op" id="3085348">.</span><span class="ident" id="3085349">ServeCodec</span><span class="op" id="3085359">(</span><span class="ident" id="3085360">srv</span><span class="op" id="3085363">)</span><br>
<span class="lineno"></span><span class="op" id="3085365">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="3085368">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3085432">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="3085473">func</span>&nbsp;<span class="op" id="3085478">(</span><span class="ident" id="3085479">server</span>&nbsp;<span class="op" id="3085486">*</span><span class="ident" id="3085487">Server</span><span class="op" id="3085493">)</span>&nbsp;<span class="ident" id="3085495">ServeCodec</span><span class="op" id="3085505">(</span><span class="ident" id="3085506">codec</span>&nbsp;<span class="ident" id="3085512">ServerCodec</span><span class="op" id="3085523">)</span>&nbsp;<span class="op" id="3085525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085528">sending</span>&nbsp;<span class="op" id="3085536">:=</span>&nbsp;<span class="builtinfunc" id="3085539">new</span><span class="op" id="3085542">(</span><span class="ident" id="3085543">sync</span><span class="op" id="3085547">.</span><span class="ident" id="3085548">Mutex</span><span class="op" id="3085553">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3085556">for</span>&nbsp;<span class="op" id="3085560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085564">service</span><span class="op" id="3085571">,</span>&nbsp;<span class="ident" id="3085573">mtype</span><span class="op" id="3085578">,</span>&nbsp;<span class="ident" id="3085580">req</span><span class="op" id="3085583">,</span>&nbsp;<span class="ident" id="3085585">argv</span><span class="op" id="3085589">,</span>&nbsp;<span class="ident" id="3085591">replyv</span><span class="op" id="3085597">,</span>&nbsp;<span class="ident" id="3085599">keepReading</span><span class="op" id="3085610">,</span>&nbsp;<span class="ident" id="3085612">err</span>&nbsp;<span class="op" id="3085616">:=</span>&nbsp;<span class="ident" id="3085619">server</span><span class="op" id="3085625">.</span><span class="ident" id="3085626">readRequest</span><span class="op" id="3085637">(</span><span class="ident" id="3085638">codec</span><span class="op" id="3085643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3085647">if</span>&nbsp;<span class="ident" id="3085650">err</span>&nbsp;<span class="op" id="3085654">!=</span>&nbsp;<span class="ident" id="3085657">nil</span>&nbsp;<span class="op" id="3085661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3085666">if</span>&nbsp;<span class="ident" id="3085669">debugLog</span>&nbsp;<span class="op" id="3085678">&amp;&amp;</span>&nbsp;<span class="ident" id="3085681">err</span>&nbsp;<span class="op" id="3085685">!=</span>&nbsp;<span class="ident" id="3085688">io</span><span class="op" id="3085690">.</span><span class="ident" id="3085691">EOF</span>&nbsp;<span class="op" id="3085695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085701">log</span><span class="op" id="3085704">.</span><span class="ident" id="3085705">Println</span><span class="op" id="3085712">(</span><span class="string" id="3085713">&#34;rpc:&#34;</span><span class="op" id="3085719">,</span>&nbsp;<span class="ident" id="3085721">err</span><span class="op" id="3085724">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3085729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3085734">if</span>&nbsp;<span class="op" id="3085737">!</span><span class="ident" id="3085738">keepReading</span>&nbsp;<span class="op" id="3085750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3085756">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3085765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3085770">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3085833">if</span>&nbsp;<span class="ident" id="3085836">req</span>&nbsp;<span class="op" id="3085840">!=</span>&nbsp;<span class="ident" id="3085843">nil</span>&nbsp;<span class="op" id="3085847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085853">server</span><span class="op" id="3085859">.</span><span class="ident" id="3085860">sendResponse</span><span class="op" id="3085872">(</span><span class="ident" id="3085873">sending</span><span class="op" id="3085880">,</span>&nbsp;<span class="ident" id="3085882">req</span><span class="op" id="3085885">,</span>&nbsp;<span class="ident" id="3085887">invalidRequest</span><span class="op" id="3085901">,</span>&nbsp;<span class="ident" id="3085903">codec</span><span class="op" id="3085908">,</span>&nbsp;<span class="ident" id="3085910">err</span><span class="op" id="3085913">.</span><span class="ident" id="3085914">Error</span><span class="op" id="3085919">(</span><span class="op" id="3085920">)</span><span class="op" id="3085921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085927">server</span><span class="op" id="3085933">.</span><span class="ident" id="3085934">freeRequest</span><span class="op" id="3085945">(</span><span class="ident" id="3085946">req</span><span class="op" id="3085949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3085954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3085959">continue</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3085970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3085974">go</span>&nbsp;<span class="ident" id="3085977">service</span><span class="op" id="3085984">.</span><span class="ident" id="3085985">call</span><span class="op" id="3085989">(</span><span class="ident" id="3085990">server</span><span class="op" id="3085996">,</span>&nbsp;<span class="ident" id="3085998">sending</span><span class="op" id="3086005">,</span>&nbsp;<span class="ident" id="3086007">mtype</span><span class="op" id="3086012">,</span>&nbsp;<span class="ident" id="3086014">req</span><span class="op" id="3086017">,</span>&nbsp;<span class="ident" id="3086019">argv</span><span class="op" id="3086023">,</span>&nbsp;<span class="ident" id="3086025">replyv</span><span class="op" id="3086031">,</span>&nbsp;<span class="ident" id="3086033">codec</span><span class="op" id="3086038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3086041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086044">codec</span><span class="op" id="3086049">.</span><span class="ident" id="3086050">Close</span><span class="op" id="3086055">(</span><span class="op" id="3086056">)</span><br>
<span class="lineno"></span><span class="op" id="3086058">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="3086061">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3086139">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="3086187">func</span>&nbsp;<span class="op" id="3086192">(</span><span class="ident" id="3086193">server</span>&nbsp;<span class="op" id="3086200">*</span><span class="ident" id="3086201">Server</span><span class="op" id="3086207">)</span>&nbsp;<span class="ident" id="3086209">ServeRequest</span><span class="op" id="3086221">(</span><span class="ident" id="3086222">codec</span>&nbsp;<span class="ident" id="3086228">ServerCodec</span><span class="op" id="3086239">)</span>&nbsp;<span class="builtintype" id="3086241">error</span>&nbsp;<span class="op" id="3086247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086250">sending</span>&nbsp;<span class="op" id="3086258">:=</span>&nbsp;<span class="builtinfunc" id="3086261">new</span><span class="op" id="3086264">(</span><span class="ident" id="3086265">sync</span><span class="op" id="3086269">.</span><span class="ident" id="3086270">Mutex</span><span class="op" id="3086275">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086278">service</span><span class="op" id="3086285">,</span>&nbsp;<span class="ident" id="3086287">mtype</span><span class="op" id="3086292">,</span>&nbsp;<span class="ident" id="3086294">req</span><span class="op" id="3086297">,</span>&nbsp;<span class="ident" id="3086299">argv</span><span class="op" id="3086303">,</span>&nbsp;<span class="ident" id="3086305">replyv</span><span class="op" id="3086311">,</span>&nbsp;<span class="ident" id="3086313">keepReading</span><span class="op" id="3086324">,</span>&nbsp;<span class="ident" id="3086326">err</span>&nbsp;<span class="op" id="3086330">:=</span>&nbsp;<span class="ident" id="3086333">server</span><span class="op" id="3086339">.</span><span class="ident" id="3086340">readRequest</span><span class="op" id="3086351">(</span><span class="ident" id="3086352">codec</span><span class="op" id="3086357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086360">if</span>&nbsp;<span class="ident" id="3086363">err</span>&nbsp;<span class="op" id="3086367">!=</span>&nbsp;<span class="ident" id="3086370">nil</span>&nbsp;<span class="op" id="3086374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086378">if</span>&nbsp;<span class="op" id="3086381">!</span><span class="ident" id="3086382">keepReading</span>&nbsp;<span class="op" id="3086394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086399">return</span>&nbsp;<span class="ident" id="3086406">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3086412">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3086416">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086478">if</span>&nbsp;<span class="ident" id="3086481">req</span>&nbsp;<span class="op" id="3086485">!=</span>&nbsp;<span class="ident" id="3086488">nil</span>&nbsp;<span class="op" id="3086492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086497">server</span><span class="op" id="3086503">.</span><span class="ident" id="3086504">sendResponse</span><span class="op" id="3086516">(</span><span class="ident" id="3086517">sending</span><span class="op" id="3086524">,</span>&nbsp;<span class="ident" id="3086526">req</span><span class="op" id="3086529">,</span>&nbsp;<span class="ident" id="3086531">invalidRequest</span><span class="op" id="3086545">,</span>&nbsp;<span class="ident" id="3086547">codec</span><span class="op" id="3086552">,</span>&nbsp;<span class="ident" id="3086554">err</span><span class="op" id="3086557">.</span><span class="ident" id="3086558">Error</span><span class="op" id="3086563">(</span><span class="op" id="3086564">)</span><span class="op" id="3086565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086570">server</span><span class="op" id="3086576">.</span><span class="ident" id="3086577">freeRequest</span><span class="op" id="3086588">(</span><span class="ident" id="3086589">req</span><span class="op" id="3086592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3086596">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086600">return</span>&nbsp;<span class="ident" id="3086607">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3086612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086615">service</span><span class="op" id="3086622">.</span><span class="ident" id="3086623">call</span><span class="op" id="3086627">(</span><span class="ident" id="3086628">server</span><span class="op" id="3086634">,</span>&nbsp;<span class="ident" id="3086636">sending</span><span class="op" id="3086643">,</span>&nbsp;<span class="ident" id="3086645">mtype</span><span class="op" id="3086650">,</span>&nbsp;<span class="ident" id="3086652">req</span><span class="op" id="3086655">,</span>&nbsp;<span class="ident" id="3086657">argv</span><span class="op" id="3086661">,</span>&nbsp;<span class="ident" id="3086663">replyv</span><span class="op" id="3086669">,</span>&nbsp;<span class="ident" id="3086671">codec</span><span class="op" id="3086676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086679">return</span>&nbsp;<span class="ident" id="3086686">nil</span><br>
<span class="lineno"></span><span class="op" id="3086690">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="3086693">func</span>&nbsp;<span class="op" id="3086698">(</span><span class="ident" id="3086699">server</span>&nbsp;<span class="op" id="3086706">*</span><span class="ident" id="3086707">Server</span><span class="op" id="3086713">)</span>&nbsp;<span class="ident" id="3086715">getRequest</span><span class="op" id="3086725">(</span><span class="op" id="3086726">)</span>&nbsp;<span class="op" id="3086728">*</span><span class="ident" id="3086729">Request</span>&nbsp;<span class="op" id="3086737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086740">server</span><span class="op" id="3086746">.</span><span class="ident" id="3086747">reqLock</span><span class="op" id="3086754">.</span><span class="ident" id="3086755">Lock</span><span class="op" id="3086759">(</span><span class="op" id="3086760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086763">req</span>&nbsp;<span class="op" id="3086767">:=</span>&nbsp;<span class="ident" id="3086770">server</span><span class="op" id="3086776">.</span><span class="ident" id="3086777">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086786">if</span>&nbsp;<span class="ident" id="3086789">req</span>&nbsp;<span class="op" id="3086793">==</span>&nbsp;<span class="ident" id="3086796">nil</span>&nbsp;<span class="op" id="3086800">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086804">req</span>&nbsp;<span class="op" id="3086808">=</span>&nbsp;<span class="builtinfunc" id="3086810">new</span><span class="op" id="3086813">(</span><span class="ident" id="3086814">Request</span><span class="op" id="3086821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3086824">}</span>&nbsp;<span class="keyword" id="3086826">else</span>&nbsp;<span class="op" id="3086831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086835">server</span><span class="op" id="3086841">.</span><span class="ident" id="3086842">freeReq</span>&nbsp;<span class="op" id="3086850">=</span>&nbsp;<span class="ident" id="3086852">req</span><span class="op" id="3086855">.</span><span class="ident" id="3086856">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3086863">*</span><span class="ident" id="3086864">req</span>&nbsp;<span class="op" id="3086868">=</span>&nbsp;<span class="ident" id="3086870">Request</span><span class="op" id="3086877">{</span><span class="op" id="3086878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3086881">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086884">server</span><span class="op" id="3086890">.</span><span class="ident" id="3086891">reqLock</span><span class="op" id="3086898">.</span><span class="ident" id="3086899">Unlock</span><span class="op" id="3086905">(</span><span class="op" id="3086906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086909">return</span>&nbsp;<span class="ident" id="3086916">req</span><br>
<span class="lineno"></span><span class="op" id="3086920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3086923">func</span>&nbsp;<span class="op" id="3086928">(</span><span class="ident" id="3086929">server</span>&nbsp;<span class="op" id="3086936">*</span><span class="ident" id="3086937">Server</span><span class="op" id="3086943">)</span>&nbsp;<span class="ident" id="3086945">freeRequest</span><span class="op" id="3086956">(</span><span class="ident" id="3086957">req</span>&nbsp;<span class="op" id="3086961">*</span><span class="ident" id="3086962">Request</span><span class="op" id="3086969">)</span>&nbsp;<span class="op" id="3086971">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086974">server</span><span class="op" id="3086980">.</span><span class="ident" id="3086981">reqLock</span><span class="op" id="3086988">.</span><span class="ident" id="3086989">Lock</span><span class="op" id="3086993">(</span><span class="op" id="3086994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086997">req</span><span class="op" id="3087000">.</span><span class="ident" id="3087001">next</span>&nbsp;<span class="op" id="3087006">=</span>&nbsp;<span class="ident" id="3087008">server</span><span class="op" id="3087014">.</span><span class="ident" id="3087015">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087024">server</span><span class="op" id="3087030">.</span><span class="ident" id="3087031">freeReq</span>&nbsp;<span class="op" id="3087039">=</span>&nbsp;<span class="ident" id="3087041">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087046">server</span><span class="op" id="3087052">.</span><span class="ident" id="3087053">reqLock</span><span class="op" id="3087060">.</span><span class="ident" id="3087061">Unlock</span><span class="op" id="3087067">(</span><span class="op" id="3087068">)</span><br>
<span class="lineno"></span><span class="op" id="3087070">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span><span class="keyword" id="3087073">func</span>&nbsp;<span class="op" id="3087078">(</span><span class="ident" id="3087079">server</span>&nbsp;<span class="op" id="3087086">*</span><span class="ident" id="3087087">Server</span><span class="op" id="3087093">)</span>&nbsp;<span class="ident" id="3087095">getResponse</span><span class="op" id="3087106">(</span><span class="op" id="3087107">)</span>&nbsp;<span class="op" id="3087109">*</span><span class="ident" id="3087110">Response</span>&nbsp;<span class="op" id="3087119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087122">server</span><span class="op" id="3087128">.</span><span class="ident" id="3087129">respLock</span><span class="op" id="3087137">.</span><span class="ident" id="3087138">Lock</span><span class="op" id="3087142">(</span><span class="op" id="3087143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087146">resp</span>&nbsp;<span class="op" id="3087151">:=</span>&nbsp;<span class="ident" id="3087154">server</span><span class="op" id="3087160">.</span><span class="ident" id="3087161">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087171">if</span>&nbsp;<span class="ident" id="3087174">resp</span>&nbsp;<span class="op" id="3087179">==</span>&nbsp;<span class="ident" id="3087182">nil</span>&nbsp;<span class="op" id="3087186">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087190">resp</span>&nbsp;<span class="op" id="3087195">=</span>&nbsp;<span class="builtinfunc" id="3087197">new</span><span class="op" id="3087200">(</span><span class="ident" id="3087201">Response</span><span class="op" id="3087209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3087212">}</span>&nbsp;<span class="keyword" id="3087214">else</span>&nbsp;<span class="op" id="3087219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087223">server</span><span class="op" id="3087229">.</span><span class="ident" id="3087230">freeResp</span>&nbsp;<span class="op" id="3087239">=</span>&nbsp;<span class="ident" id="3087241">resp</span><span class="op" id="3087245">.</span><span class="ident" id="3087246">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3087253">*</span><span class="ident" id="3087254">resp</span>&nbsp;<span class="op" id="3087259">=</span>&nbsp;<span class="ident" id="3087261">Response</span><span class="op" id="3087269">{</span><span class="op" id="3087270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3087273">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087276">server</span><span class="op" id="3087282">.</span><span class="ident" id="3087283">respLock</span><span class="op" id="3087291">.</span><span class="ident" id="3087292">Unlock</span><span class="op" id="3087298">(</span><span class="op" id="3087299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087302">return</span>&nbsp;<span class="ident" id="3087309">resp</span><br>
<span class="lineno"></span><span class="op" id="3087314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3087317">func</span>&nbsp;<span class="op" id="3087322">(</span><span class="ident" id="3087323">server</span>&nbsp;<span class="op" id="3087330">*</span><span class="ident" id="3087331">Server</span><span class="op" id="3087337">)</span>&nbsp;<span class="ident" id="3087339">freeResponse</span><span class="op" id="3087351">(</span><span class="ident" id="3087352">resp</span>&nbsp;<span class="op" id="3087357">*</span><span class="ident" id="3087358">Response</span><span class="op" id="3087366">)</span>&nbsp;<span class="op" id="3087368">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087371">server</span><span class="op" id="3087377">.</span><span class="ident" id="3087378">respLock</span><span class="op" id="3087386">.</span><span class="ident" id="3087387">Lock</span><span class="op" id="3087391">(</span><span class="op" id="3087392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087395">resp</span><span class="op" id="3087399">.</span><span class="ident" id="3087400">next</span>&nbsp;<span class="op" id="3087405">=</span>&nbsp;<span class="ident" id="3087407">server</span><span class="op" id="3087413">.</span><span class="ident" id="3087414">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087424">server</span><span class="op" id="3087430">.</span><span class="ident" id="3087431">freeResp</span>&nbsp;<span class="op" id="3087440">=</span>&nbsp;<span class="ident" id="3087442">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087448">server</span><span class="op" id="3087454">.</span><span class="ident" id="3087455">respLock</span><span class="op" id="3087463">.</span><span class="ident" id="3087464">Unlock</span><span class="op" id="3087470">(</span><span class="op" id="3087471">)</span><br>
<span class="lineno"></span><span class="op" id="3087473">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="3087476">func</span>&nbsp;<span class="op" id="3087481">(</span><span class="ident" id="3087482">server</span>&nbsp;<span class="op" id="3087489">*</span><span class="ident" id="3087490">Server</span><span class="op" id="3087496">)</span>&nbsp;<span class="ident" id="3087498">readRequest</span><span class="op" id="3087509">(</span><span class="ident" id="3087510">codec</span>&nbsp;<span class="ident" id="3087516">ServerCodec</span><span class="op" id="3087527">)</span>&nbsp;<span class="op" id="3087529">(</span><span class="ident" id="3087530">service</span>&nbsp;<span class="op" id="3087538">*</span><span class="ident" id="3087539">service</span><span class="op" id="3087546">,</span>&nbsp;<span class="ident" id="3087548">mtype</span>&nbsp;<span class="op" id="3087554">*</span><span class="ident" id="3087555">methodType</span><span class="op" id="3087565">,</span>&nbsp;<span class="ident" id="3087567">req</span>&nbsp;<span class="op" id="3087571">*</span><span class="ident" id="3087572">Request</span><span class="op" id="3087579">,</span>&nbsp;<span class="ident" id="3087581">argv</span><span class="op" id="3087585">,</span>&nbsp;<span class="ident" id="3087587">replyv</span>&nbsp;<span class="ident" id="3087594">reflect</span><span class="op" id="3087601">.</span><span class="ident" id="3087602">Value</span><span class="op" id="3087607">,</span>&nbsp;<span class="ident" id="3087609">keepReading</span>&nbsp;<span class="builtintype" id="3087621">bool</span><span class="op" id="3087625">,</span>&nbsp;<span class="ident" id="3087627">err</span>&nbsp;<span class="builtintype" id="3087631">error</span><span class="op" id="3087636">)</span>&nbsp;<span class="op" id="3087638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087641">service</span><span class="op" id="3087648">,</span>&nbsp;<span class="ident" id="3087650">mtype</span><span class="op" id="3087655">,</span>&nbsp;<span class="ident" id="3087657">req</span><span class="op" id="3087660">,</span>&nbsp;<span class="ident" id="3087662">keepReading</span><span class="op" id="3087673">,</span>&nbsp;<span class="ident" id="3087675">err</span>&nbsp;<span class="op" id="3087679">=</span>&nbsp;<span class="ident" id="3087681">server</span><span class="op" id="3087687">.</span><span class="ident" id="3087688">readRequestHeader</span><span class="op" id="3087705">(</span><span class="ident" id="3087706">codec</span><span class="op" id="3087711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087714">if</span>&nbsp;<span class="ident" id="3087717">err</span>&nbsp;<span class="op" id="3087721">!=</span>&nbsp;<span class="ident" id="3087724">nil</span>&nbsp;<span class="op" id="3087728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087732">if</span>&nbsp;<span class="op" id="3087735">!</span><span class="ident" id="3087736">keepReading</span>&nbsp;<span class="op" id="3087748">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087753">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3087762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3087766">//&nbsp;discard&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087784">codec</span><span class="op" id="3087789">.</span><span class="ident" id="3087790">ReadRequestBody</span><span class="op" id="3087805">(</span><span class="ident" id="3087806">nil</span><span class="op" id="3087809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087813">return</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3087821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3087825">//&nbsp;Decode&nbsp;the&nbsp;argument&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087856">argIsValue</span>&nbsp;<span class="op" id="3087867">:=</span>&nbsp;<span class="ident" id="3087870">false</span>&nbsp;<span class="comment" id="3087876">//&nbsp;if&nbsp;true,&nbsp;need&nbsp;to&nbsp;indirect&nbsp;before&nbsp;calling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087922">if</span>&nbsp;<span class="ident" id="3087925">mtype</span><span class="op" id="3087930">.</span><span class="ident" id="3087931">ArgType</span><span class="op" id="3087938">.</span><span class="ident" id="3087939">Kind</span><span class="op" id="3087943">(</span><span class="op" id="3087944">)</span>&nbsp;<span class="op" id="3087946">==</span>&nbsp;<span class="ident" id="3087949">reflect</span><span class="op" id="3087956">.</span><span class="ident" id="3087957">Ptr</span>&nbsp;<span class="op" id="3087961">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087965">argv</span>&nbsp;<span class="op" id="3087970">=</span>&nbsp;<span class="ident" id="3087972">reflect</span><span class="op" id="3087979">.</span><span class="ident" id="3087980">New</span><span class="op" id="3087983">(</span><span class="ident" id="3087984">mtype</span><span class="op" id="3087989">.</span><span class="ident" id="3087990">ArgType</span><span class="op" id="3087997">.</span><span class="ident" id="3087998">Elem</span><span class="op" id="3088002">(</span><span class="op" id="3088003">)</span><span class="op" id="3088004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088007">}</span>&nbsp;<span class="keyword" id="3088009">else</span>&nbsp;<span class="op" id="3088014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088018">argv</span>&nbsp;<span class="op" id="3088023">=</span>&nbsp;<span class="ident" id="3088025">reflect</span><span class="op" id="3088032">.</span><span class="ident" id="3088033">New</span><span class="op" id="3088036">(</span><span class="ident" id="3088037">mtype</span><span class="op" id="3088042">.</span><span class="ident" id="3088043">ArgType</span><span class="op" id="3088050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088054">argIsValue</span>&nbsp;<span class="op" id="3088065">=</span>&nbsp;<span class="ident" id="3088067">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088073">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088076">//&nbsp;argv&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;a&nbsp;pointer&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088117">if</span>&nbsp;<span class="ident" id="3088120">err</span>&nbsp;<span class="op" id="3088124">=</span>&nbsp;<span class="ident" id="3088126">codec</span><span class="op" id="3088131">.</span><span class="ident" id="3088132">ReadRequestBody</span><span class="op" id="3088147">(</span><span class="ident" id="3088148">argv</span><span class="op" id="3088152">.</span><span class="ident" id="3088153">Interface</span><span class="op" id="3088162">(</span><span class="op" id="3088163">)</span><span class="op" id="3088164">)</span><span class="op" id="3088165">;</span>&nbsp;<span class="ident" id="3088167">err</span>&nbsp;<span class="op" id="3088171">!=</span>&nbsp;<span class="ident" id="3088174">nil</span>&nbsp;<span class="op" id="3088178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088182">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088193">if</span>&nbsp;<span class="ident" id="3088196">argIsValue</span>&nbsp;<span class="op" id="3088207">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088211">argv</span>&nbsp;<span class="op" id="3088216">=</span>&nbsp;<span class="ident" id="3088218">argv</span><span class="op" id="3088222">.</span><span class="ident" id="3088223">Elem</span><span class="op" id="3088227">(</span><span class="op" id="3088228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088235">replyv</span>&nbsp;<span class="op" id="3088242">=</span>&nbsp;<span class="ident" id="3088244">reflect</span><span class="op" id="3088251">.</span><span class="ident" id="3088252">New</span><span class="op" id="3088255">(</span><span class="ident" id="3088256">mtype</span><span class="op" id="3088261">.</span><span class="ident" id="3088262">ReplyType</span><span class="op" id="3088271">.</span><span class="ident" id="3088272">Elem</span><span class="op" id="3088276">(</span><span class="op" id="3088277">)</span><span class="op" id="3088278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088281">return</span><br>
<span class="lineno">570</span><span class="op" id="3088288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3088291">func</span>&nbsp;<span class="op" id="3088296">(</span><span class="ident" id="3088297">server</span>&nbsp;<span class="op" id="3088304">*</span><span class="ident" id="3088305">Server</span><span class="op" id="3088311">)</span>&nbsp;<span class="ident" id="3088313">readRequestHeader</span><span class="op" id="3088330">(</span><span class="ident" id="3088331">codec</span>&nbsp;<span class="ident" id="3088337">ServerCodec</span><span class="op" id="3088348">)</span>&nbsp;<span class="op" id="3088350">(</span><span class="ident" id="3088351">service</span>&nbsp;<span class="op" id="3088359">*</span><span class="ident" id="3088360">service</span><span class="op" id="3088367">,</span>&nbsp;<span class="ident" id="3088369">mtype</span>&nbsp;<span class="op" id="3088375">*</span><span class="ident" id="3088376">methodType</span><span class="op" id="3088386">,</span>&nbsp;<span class="ident" id="3088388">req</span>&nbsp;<span class="op" id="3088392">*</span><span class="ident" id="3088393">Request</span><span class="op" id="3088400">,</span>&nbsp;<span class="ident" id="3088402">keepReading</span>&nbsp;<span class="builtintype" id="3088414">bool</span><span class="op" id="3088418">,</span>&nbsp;<span class="ident" id="3088420">err</span>&nbsp;<span class="builtintype" id="3088424">error</span><span class="op" id="3088429">)</span>&nbsp;<span class="op" id="3088431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088434">//&nbsp;Grab&nbsp;the&nbsp;request&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088463">req</span>&nbsp;<span class="op" id="3088467">=</span>&nbsp;<span class="ident" id="3088469">server</span><span class="op" id="3088475">.</span><span class="ident" id="3088476">getRequest</span><span class="op" id="3088486">(</span><span class="op" id="3088487">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088490">err</span>&nbsp;<span class="op" id="3088494">=</span>&nbsp;<span class="ident" id="3088496">codec</span><span class="op" id="3088501">.</span><span class="ident" id="3088502">ReadRequestHeader</span><span class="op" id="3088519">(</span><span class="ident" id="3088520">req</span><span class="op" id="3088523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088526">if</span>&nbsp;<span class="ident" id="3088529">err</span>&nbsp;<span class="op" id="3088533">!=</span>&nbsp;<span class="ident" id="3088536">nil</span>&nbsp;<span class="op" id="3088540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088544">req</span>&nbsp;<span class="op" id="3088548">=</span>&nbsp;<span class="ident" id="3088550">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088556">if</span>&nbsp;<span class="ident" id="3088559">err</span>&nbsp;<span class="op" id="3088563">==</span>&nbsp;<span class="ident" id="3088566">io</span><span class="op" id="3088568">.</span><span class="ident" id="3088569">EOF</span>&nbsp;<span class="op" id="3088573">||</span>&nbsp;<span class="ident" id="3088576">err</span>&nbsp;<span class="op" id="3088580">==</span>&nbsp;<span class="ident" id="3088583">io</span><span class="op" id="3088585">.</span><span class="ident" id="3088586">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="3088603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088608">return</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088621">err</span>&nbsp;<span class="op" id="3088625">=</span>&nbsp;<span class="ident" id="3088627">errors</span><span class="op" id="3088633">.</span><span class="ident" id="3088634">New</span><span class="op" id="3088637">(</span><span class="string" id="3088638">&#34;rpc:&nbsp;server&nbsp;cannot&nbsp;decode&nbsp;request:&nbsp;&#34;</span>&nbsp;<span class="op" id="3088676">+</span>&nbsp;<span class="ident" id="3088678">err</span><span class="op" id="3088681">.</span><span class="ident" id="3088682">Error</span><span class="op" id="3088687">(</span><span class="op" id="3088688">)</span><span class="op" id="3088689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088693">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088705">//&nbsp;We&nbsp;read&nbsp;the&nbsp;header&nbsp;successfully.&nbsp;&nbsp;If&nbsp;we&nbsp;see&nbsp;an&nbsp;error&nbsp;now,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088767">//&nbsp;we&nbsp;can&nbsp;still&nbsp;recover&nbsp;and&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088825">keepReading</span>&nbsp;<span class="op" id="3088837">=</span>&nbsp;<span class="ident" id="3088839">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088846">dot</span>&nbsp;<span class="op" id="3088850">:=</span>&nbsp;<span class="ident" id="3088853">strings</span><span class="op" id="3088860">.</span><span class="ident" id="3088861">LastIndex</span><span class="op" id="3088870">(</span><span class="ident" id="3088871">req</span><span class="op" id="3088874">.</span><span class="ident" id="3088875">ServiceMethod</span><span class="op" id="3088888">,</span>&nbsp;<span class="string" id="3088890">&#34;.&#34;</span><span class="op" id="3088893">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088896">if</span>&nbsp;<span class="ident" id="3088899">dot</span>&nbsp;<span class="op" id="3088903">&lt;</span>&nbsp;<span class="num" id="3088905">0</span>&nbsp;<span class="op" id="3088907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088911">err</span>&nbsp;<span class="op" id="3088915">=</span>&nbsp;<span class="ident" id="3088917">errors</span><span class="op" id="3088923">.</span><span class="ident" id="3088924">New</span><span class="op" id="3088927">(</span><span class="string" id="3088928">&#34;rpc:&nbsp;service/method&nbsp;request&nbsp;ill-formed:&nbsp;&#34;</span>&nbsp;<span class="op" id="3088971">+</span>&nbsp;<span class="ident" id="3088973">req</span><span class="op" id="3088976">.</span><span class="ident" id="3088977">ServiceMethod</span><span class="op" id="3088990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088994">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089005">serviceName</span>&nbsp;<span class="op" id="3089017">:=</span>&nbsp;<span class="ident" id="3089020">req</span><span class="op" id="3089023">.</span><span class="ident" id="3089024">ServiceMethod</span><span class="op" id="3089037">[</span><span class="op" id="3089038">:</span><span class="ident" id="3089039">dot</span><span class="op" id="3089042">]</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089045">methodName</span>&nbsp;<span class="op" id="3089056">:=</span>&nbsp;<span class="ident" id="3089059">req</span><span class="op" id="3089062">.</span><span class="ident" id="3089063">ServiceMethod</span><span class="op" id="3089076">[</span><span class="ident" id="3089077">dot</span><span class="op" id="3089080">+</span><span class="num" id="3089081">1</span><span class="op" id="3089082">:</span><span class="op" id="3089083">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089087">//&nbsp;Look&nbsp;up&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089112">server</span><span class="op" id="3089118">.</span><span class="ident" id="3089119">mu</span><span class="op" id="3089121">.</span><span class="ident" id="3089122">RLock</span><span class="op" id="3089127">(</span><span class="op" id="3089128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089131">service</span>&nbsp;<span class="op" id="3089139">=</span>&nbsp;<span class="ident" id="3089141">server</span><span class="op" id="3089147">.</span><span class="ident" id="3089148">serviceMap</span><span class="op" id="3089158">[</span><span class="ident" id="3089159">serviceName</span><span class="op" id="3089170">]</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089173">server</span><span class="op" id="3089179">.</span><span class="ident" id="3089180">mu</span><span class="op" id="3089182">.</span><span class="ident" id="3089183">RUnlock</span><span class="op" id="3089190">(</span><span class="op" id="3089191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089194">if</span>&nbsp;<span class="ident" id="3089197">service</span>&nbsp;<span class="op" id="3089205">==</span>&nbsp;<span class="ident" id="3089208">nil</span>&nbsp;<span class="op" id="3089212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089216">err</span>&nbsp;<span class="op" id="3089220">=</span>&nbsp;<span class="ident" id="3089222">errors</span><span class="op" id="3089228">.</span><span class="ident" id="3089229">New</span><span class="op" id="3089232">(</span><span class="string" id="3089233">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;service&nbsp;&#34;</span>&nbsp;<span class="op" id="3089260">+</span>&nbsp;<span class="ident" id="3089262">req</span><span class="op" id="3089265">.</span><span class="ident" id="3089266">ServiceMethod</span><span class="op" id="3089279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089283">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089291">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089294">mtype</span>&nbsp;<span class="op" id="3089300">=</span>&nbsp;<span class="ident" id="3089302">service</span><span class="op" id="3089309">.</span><span class="ident" id="3089310">method</span><span class="op" id="3089316">[</span><span class="ident" id="3089317">methodName</span><span class="op" id="3089327">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089330">if</span>&nbsp;<span class="ident" id="3089333">mtype</span>&nbsp;<span class="op" id="3089339">==</span>&nbsp;<span class="ident" id="3089342">nil</span>&nbsp;<span class="op" id="3089346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089350">err</span>&nbsp;<span class="op" id="3089354">=</span>&nbsp;<span class="ident" id="3089356">errors</span><span class="op" id="3089362">.</span><span class="ident" id="3089363">New</span><span class="op" id="3089366">(</span><span class="string" id="3089367">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;method&nbsp;&#34;</span>&nbsp;<span class="op" id="3089393">+</span>&nbsp;<span class="ident" id="3089395">req</span><span class="op" id="3089398">.</span><span class="ident" id="3089399">ServiceMethod</span><span class="op" id="3089412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089418">return</span><br>
<span class="lineno">610</span><span class="op" id="3089425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3089428">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3089494">//&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.&nbsp;&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="3089564">//&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno">615</span><span class="keyword" id="3089597">func</span>&nbsp;<span class="op" id="3089602">(</span><span class="ident" id="3089603">server</span>&nbsp;<span class="op" id="3089610">*</span><span class="ident" id="3089611">Server</span><span class="op" id="3089617">)</span>&nbsp;<span class="ident" id="3089619">Accept</span><span class="op" id="3089625">(</span><span class="ident" id="3089626">lis</span>&nbsp;<span class="ident" id="3089630">net</span><span class="op" id="3089633">.</span><span class="ident" id="3089634">Listener</span><span class="op" id="3089642">)</span>&nbsp;<span class="op" id="3089644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089647">for</span>&nbsp;<span class="op" id="3089651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089655">conn</span><span class="op" id="3089659">,</span>&nbsp;<span class="ident" id="3089661">err</span>&nbsp;<span class="op" id="3089665">:=</span>&nbsp;<span class="ident" id="3089668">lis</span><span class="op" id="3089671">.</span><span class="ident" id="3089672">Accept</span><span class="op" id="3089678">(</span><span class="op" id="3089679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089683">if</span>&nbsp;<span class="ident" id="3089686">err</span>&nbsp;<span class="op" id="3089690">!=</span>&nbsp;<span class="ident" id="3089693">nil</span>&nbsp;<span class="op" id="3089697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089702">log</span><span class="op" id="3089705">.</span><span class="ident" id="3089706">Fatal</span><span class="op" id="3089711">(</span><span class="string" id="3089712">&#34;rpc.Serve:&nbsp;accept:&#34;</span><span class="op" id="3089732">,</span>&nbsp;<span class="ident" id="3089734">err</span><span class="op" id="3089737">.</span><span class="ident" id="3089738">Error</span><span class="op" id="3089743">(</span><span class="op" id="3089744">)</span><span class="op" id="3089745">)</span>&nbsp;<span class="comment" id="3089747">//&nbsp;TODO(r):&nbsp;exit?</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089771">go</span>&nbsp;<span class="ident" id="3089774">server</span><span class="op" id="3089780">.</span><span class="ident" id="3089781">ServeConn</span><span class="op" id="3089790">(</span><span class="ident" id="3089791">conn</span><span class="op" id="3089795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089798">}</span><br>
<span class="lineno"></span><span class="op" id="3089800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span><span class="comment" id="3089803">//&nbsp;Register&nbsp;publishes&nbsp;the&nbsp;receiver&#39;s&nbsp;methods&nbsp;in&nbsp;the&nbsp;DefaultServer.</span><br>
<span class="lineno"></span><span class="keyword" id="3089870">func</span>&nbsp;<span class="ident" id="3089875">Register</span><span class="op" id="3089883">(</span><span class="ident" id="3089884">rcvr</span>&nbsp;<span class="keyword" id="3089889">interface</span><span class="op" id="3089898">{</span><span class="op" id="3089899">}</span><span class="op" id="3089900">)</span>&nbsp;<span class="builtintype" id="3089902">error</span>&nbsp;<span class="op" id="3089908">{</span>&nbsp;<span class="keyword" id="3089910">return</span>&nbsp;<span class="ident" id="3089917">DefaultServer</span><span class="op" id="3089930">.</span><span class="ident" id="3089931">Register</span><span class="op" id="3089939">(</span><span class="ident" id="3089940">rcvr</span><span class="op" id="3089944">)</span>&nbsp;<span class="op" id="3089946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3089949">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="3090022">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno">630</span><span class="keyword" id="3090066">func</span>&nbsp;<span class="ident" id="3090071">RegisterName</span><span class="op" id="3090083">(</span><span class="ident" id="3090084">name</span>&nbsp;<span class="builtintype" id="3090089">string</span><span class="op" id="3090095">,</span>&nbsp;<span class="ident" id="3090097">rcvr</span>&nbsp;<span class="keyword" id="3090102">interface</span><span class="op" id="3090111">{</span><span class="op" id="3090112">}</span><span class="op" id="3090113">)</span>&nbsp;<span class="builtintype" id="3090115">error</span>&nbsp;<span class="op" id="3090121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3090124">return</span>&nbsp;<span class="ident" id="3090131">DefaultServer</span><span class="op" id="3090144">.</span><span class="ident" id="3090145">RegisterName</span><span class="op" id="3090157">(</span><span class="ident" id="3090158">name</span><span class="op" id="3090162">,</span>&nbsp;<span class="ident" id="3090164">rcvr</span><span class="op" id="3090168">)</span><br>
<span class="lineno"></span><span class="op" id="3090170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3090173">//&nbsp;A&nbsp;ServerCodec&nbsp;implements&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and&nbsp;writing&nbsp;of</span><br>
<span class="lineno">635</span><span class="comment" id="3090240">//&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment" id="3090296">//&nbsp;The&nbsp;server&nbsp;calls&nbsp;ReadRequestHeader&nbsp;and&nbsp;ReadRequestBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment" id="3090363">//&nbsp;to&nbsp;read&nbsp;requests&nbsp;from&nbsp;the&nbsp;connection,&nbsp;and&nbsp;it&nbsp;calls&nbsp;WriteResponse&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3090434">//&nbsp;write&nbsp;a&nbsp;response&nbsp;back.&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3090507">//&nbsp;connection.&nbsp;ReadRequestBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">640</span><span class="comment" id="3090563">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;request&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="3090634">type</span>&nbsp;<span class="ident" id="3090639">ServerCodec</span>&nbsp;<span class="keyword" id="3090651">interface</span>&nbsp;<span class="op" id="3090661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090664">ReadRequestHeader</span><span class="op" id="3090681">(</span><span class="op" id="3090682">*</span><span class="ident" id="3090683">Request</span><span class="op" id="3090690">)</span>&nbsp;<span class="builtintype" id="3090692">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090699">ReadRequestBody</span><span class="op" id="3090714">(</span><span class="keyword" id="3090715">interface</span><span class="op" id="3090724">{</span><span class="op" id="3090725">}</span><span class="op" id="3090726">)</span>&nbsp;<span class="builtintype" id="3090728">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3090735">//&nbsp;WriteResponse&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090809">WriteResponse</span><span class="op" id="3090822">(</span><span class="op" id="3090823">*</span><span class="ident" id="3090824">Response</span><span class="op" id="3090832">,</span>&nbsp;<span class="keyword" id="3090834">interface</span><span class="op" id="3090843">{</span><span class="op" id="3090844">}</span><span class="op" id="3090845">)</span>&nbsp;<span class="builtintype" id="3090847">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090855">Close</span><span class="op" id="3090860">(</span><span class="op" id="3090861">)</span>&nbsp;<span class="builtintype" id="3090863">error</span><br>
<span class="lineno"></span><span class="op" id="3090869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="3090872">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;DefaultServer&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3090932">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="3091003">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="3091064">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3091127">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">655</span><span class="keyword" id="3091186">func</span>&nbsp;<span class="ident" id="3091191">ServeConn</span><span class="op" id="3091200">(</span><span class="ident" id="3091201">conn</span>&nbsp;<span class="ident" id="3091206">io</span><span class="op" id="3091208">.</span><span class="ident" id="3091209">ReadWriteCloser</span><span class="op" id="3091224">)</span>&nbsp;<span class="op" id="3091226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3091229">DefaultServer</span><span class="op" id="3091242">.</span><span class="ident" id="3091243">ServeConn</span><span class="op" id="3091252">(</span><span class="ident" id="3091253">conn</span><span class="op" id="3091257">)</span><br>
<span class="lineno"></span><span class="op" id="3091259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3091262">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno">660</span><span class="comment" id="3091326">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="3091367">func</span>&nbsp;<span class="ident" id="3091372">ServeCodec</span><span class="op" id="3091382">(</span><span class="ident" id="3091383">codec</span>&nbsp;<span class="ident" id="3091389">ServerCodec</span><span class="op" id="3091400">)</span>&nbsp;<span class="op" id="3091402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3091405">DefaultServer</span><span class="op" id="3091418">.</span><span class="ident" id="3091419">ServeCodec</span><span class="op" id="3091429">(</span><span class="ident" id="3091430">codec</span><span class="op" id="3091435">)</span><br>
<span class="lineno"></span><span class="op" id="3091437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="3091440">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3091518">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="3091566">func</span>&nbsp;<span class="ident" id="3091571">ServeRequest</span><span class="op" id="3091583">(</span><span class="ident" id="3091584">codec</span>&nbsp;<span class="ident" id="3091590">ServerCodec</span><span class="op" id="3091601">)</span>&nbsp;<span class="builtintype" id="3091603">error</span>&nbsp;<span class="op" id="3091609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3091612">return</span>&nbsp;<span class="ident" id="3091619">DefaultServer</span><span class="op" id="3091632">.</span><span class="ident" id="3091633">ServeRequest</span><span class="op" id="3091645">(</span><span class="ident" id="3091646">codec</span><span class="op" id="3091651">)</span><br>
<span class="lineno"></span><span class="op" id="3091653">}</span><br>
<span class="lineno">670</span><br>
<span class="lineno"></span><span class="comment" id="3091656">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3091722">//&nbsp;to&nbsp;DefaultServer&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3091772">//&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="3091841">func</span>&nbsp;<span class="ident" id="3091846">Accept</span><span class="op" id="3091852">(</span><span class="ident" id="3091853">lis</span>&nbsp;<span class="ident" id="3091857">net</span><span class="op" id="3091860">.</span><span class="ident" id="3091861">Listener</span><span class="op" id="3091869">)</span>&nbsp;<span class="op" id="3091871">{</span>&nbsp;<span class="ident" id="3091873">DefaultServer</span><span class="op" id="3091886">.</span><span class="ident" id="3091887">Accept</span><span class="op" id="3091893">(</span><span class="ident" id="3091894">lis</span><span class="op" id="3091897">)</span>&nbsp;<span class="op" id="3091899">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="comment" id="3091902">//&nbsp;Can&nbsp;connect&nbsp;to&nbsp;RPC&nbsp;service&nbsp;using&nbsp;HTTP&nbsp;CONNECT&nbsp;to&nbsp;rpcPath.</span><br>
<span class="lineno"></span><span class="keyword" id="3091963">var</span>&nbsp;<span class="ident" id="3091967">connected</span>&nbsp;<span class="op" id="3091977">=</span>&nbsp;<span class="string" id="3091979">&#34;200&nbsp;Connected&nbsp;to&nbsp;Go&nbsp;RPC&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3092006">//&nbsp;ServeHTTP&nbsp;implements&nbsp;an&nbsp;http.Handler&nbsp;that&nbsp;answers&nbsp;RPC&nbsp;requests.</span><br>
<span class="lineno">680</span><span class="keyword" id="3092073">func</span>&nbsp;<span class="op" id="3092078">(</span><span class="ident" id="3092079">server</span>&nbsp;<span class="op" id="3092086">*</span><span class="ident" id="3092087">Server</span><span class="op" id="3092093">)</span>&nbsp;<span class="ident" id="3092095">ServeHTTP</span><span class="op" id="3092104">(</span><span class="ident" id="3092105">w</span>&nbsp;<span class="ident" id="3092107">http</span><span class="op" id="3092111">.</span><span class="ident" id="3092112">ResponseWriter</span><span class="op" id="3092126">,</span>&nbsp;<span class="ident" id="3092128">req</span>&nbsp;<span class="op" id="3092132">*</span><span class="ident" id="3092133">http</span><span class="op" id="3092137">.</span><span class="ident" id="3092138">Request</span><span class="op" id="3092145">)</span>&nbsp;<span class="op" id="3092147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092150">if</span>&nbsp;<span class="ident" id="3092153">req</span><span class="op" id="3092156">.</span><span class="ident" id="3092157">Method</span>&nbsp;<span class="op" id="3092164">!=</span>&nbsp;<span class="string" id="3092167">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="3092177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092181">w</span><span class="op" id="3092182">.</span><span class="ident" id="3092183">Header</span><span class="op" id="3092189">(</span><span class="op" id="3092190">)</span><span class="op" id="3092191">.</span><span class="ident" id="3092192">Set</span><span class="op" id="3092195">(</span><span class="string" id="3092196">&#34;Content-Type&#34;</span><span class="op" id="3092210">,</span>&nbsp;<span class="string" id="3092212">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="3092239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092243">w</span><span class="op" id="3092244">.</span><span class="ident" id="3092245">WriteHeader</span><span class="op" id="3092256">(</span><span class="ident" id="3092257">http</span><span class="op" id="3092261">.</span><span class="ident" id="3092262">StatusMethodNotAllowed</span><span class="op" id="3092284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092288">io</span><span class="op" id="3092290">.</span><span class="ident" id="3092291">WriteString</span><span class="op" id="3092302">(</span><span class="ident" id="3092303">w</span><span class="op" id="3092304">,</span>&nbsp;<span class="string" id="3092306">&#34;405&nbsp;must&nbsp;CONNECT\n&#34;</span><span class="op" id="3092326">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092330">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3092338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092341">conn</span><span class="op" id="3092345">,</span>&nbsp;<span class="ident" id="3092347">_</span><span class="op" id="3092348">,</span>&nbsp;<span class="ident" id="3092350">err</span>&nbsp;<span class="op" id="3092354">:=</span>&nbsp;<span class="ident" id="3092357">w</span><span class="op" id="3092358">.</span><span class="op" id="3092359">(</span><span class="ident" id="3092360">http</span><span class="op" id="3092364">.</span><span class="ident" id="3092365">Hijacker</span><span class="op" id="3092373">)</span><span class="op" id="3092374">.</span><span class="ident" id="3092375">Hijack</span><span class="op" id="3092381">(</span><span class="op" id="3092382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092385">if</span>&nbsp;<span class="ident" id="3092388">err</span>&nbsp;<span class="op" id="3092392">!=</span>&nbsp;<span class="ident" id="3092395">nil</span>&nbsp;<span class="op" id="3092399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092403">log</span><span class="op" id="3092406">.</span><span class="ident" id="3092407">Print</span><span class="op" id="3092412">(</span><span class="string" id="3092413">&#34;rpc&nbsp;hijacking&nbsp;&#34;</span><span class="op" id="3092429">,</span>&nbsp;<span class="ident" id="3092431">req</span><span class="op" id="3092434">.</span><span class="ident" id="3092435">RemoteAddr</span><span class="op" id="3092445">,</span>&nbsp;<span class="string" id="3092447">&#34;:&nbsp;&#34;</span><span class="op" id="3092451">,</span>&nbsp;<span class="ident" id="3092453">err</span><span class="op" id="3092456">.</span><span class="ident" id="3092457">Error</span><span class="op" id="3092462">(</span><span class="op" id="3092463">)</span><span class="op" id="3092464">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092468">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3092476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092479">io</span><span class="op" id="3092481">.</span><span class="ident" id="3092482">WriteString</span><span class="op" id="3092493">(</span><span class="ident" id="3092494">conn</span><span class="op" id="3092498">,</span>&nbsp;<span class="string" id="3092500">&#34;HTTP/1.0&nbsp;&#34;</span><span class="op" id="3092511">+</span><span class="ident" id="3092512">connected</span><span class="op" id="3092521">+</span><span class="string" id="3092522">&#34;\n\n&#34;</span><span class="op" id="3092528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092531">server</span><span class="op" id="3092537">.</span><span class="ident" id="3092538">ServeConn</span><span class="op" id="3092547">(</span><span class="ident" id="3092548">conn</span><span class="op" id="3092552">)</span><br>
<span class="lineno"></span><span class="op" id="3092554">}</span><br>
<span class="lineno">695</span><br>
<span class="lineno"></span><span class="comment" id="3092557">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;on&nbsp;rpcPath,</span><br>
<span class="lineno"></span><span class="comment" id="3092626">//&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;debugPath.</span><br>
<span class="lineno"></span><span class="comment" id="3092667">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="3092745">func</span>&nbsp;<span class="op" id="3092750">(</span><span class="ident" id="3092751">server</span>&nbsp;<span class="op" id="3092758">*</span><span class="ident" id="3092759">Server</span><span class="op" id="3092765">)</span>&nbsp;<span class="ident" id="3092767">HandleHTTP</span><span class="op" id="3092777">(</span><span class="ident" id="3092778">rpcPath</span><span class="op" id="3092785">,</span>&nbsp;<span class="ident" id="3092787">debugPath</span>&nbsp;<span class="builtintype" id="3092797">string</span><span class="op" id="3092803">)</span>&nbsp;<span class="op" id="3092805">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092808">http</span><span class="op" id="3092812">.</span><span class="ident" id="3092813">Handle</span><span class="op" id="3092819">(</span><span class="ident" id="3092820">rpcPath</span><span class="op" id="3092827">,</span>&nbsp;<span class="ident" id="3092829">server</span><span class="op" id="3092835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092838">http</span><span class="op" id="3092842">.</span><span class="ident" id="3092843">Handle</span><span class="op" id="3092849">(</span><span class="ident" id="3092850">debugPath</span><span class="op" id="3092859">,</span>&nbsp;<span class="ident" id="3092861">debugHTTP</span><span class="op" id="3092870">{</span><span class="ident" id="3092871">server</span><span class="op" id="3092877">}</span><span class="op" id="3092878">)</span><br>
<span class="lineno"></span><span class="op" id="3092880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3092883">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;to&nbsp;DefaultServer</span><br>
<span class="lineno">705</span><span class="comment" id="3092957">//&nbsp;on&nbsp;DefaultRPCPath&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;DefaultDebugPath.</span><br>
<span class="lineno"></span><span class="comment" id="3093023">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="3093101">func</span>&nbsp;<span class="ident" id="3093106">HandleHTTP</span><span class="op" id="3093116">(</span><span class="op" id="3093117">)</span>&nbsp;<span class="op" id="3093119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093122">DefaultServer</span><span class="op" id="3093135">.</span><span class="ident" id="3093136">HandleHTTP</span><span class="op" id="3093146">(</span><span class="ident" id="3093147">DefaultRPCPath</span><span class="op" id="3093161">,</span>&nbsp;<span class="ident" id="3093163">DefaultDebugPath</span><span class="op" id="3093179">)</span><br>
<span class="lineno"></span><span class="op" id="3093181">}</span>
</div>
</body>
</html>
