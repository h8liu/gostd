<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4181010">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4181065">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4181119">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4181170">package</span>&nbsp;<span class="ident" id="4181178">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4181183">import</span>&nbsp;<span class="op" id="4181190">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4181193">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4181202">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4181212">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4181228">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4181242">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4181259">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4181274">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4181284">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4181291">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4181297">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4181304">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="4181314">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4181317">type</span>&nbsp;<span class="ident" id="4181322">clientHandshakeState</span>&nbsp;<span class="keyword" id="4181343">struct</span>&nbsp;<span class="op" id="4181350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181353">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4181366">*</span><span class="ident" id="4181367">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181373">serverHello</span>&nbsp;&nbsp;<span class="op" id="4181386">*</span><span class="ident" id="4181387">serverHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181403">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4181416">*</span><span class="ident" id="4181417">clientHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181433">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4181446">*</span><span class="ident" id="4181447">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181460">finishedHash</span>&nbsp;<span class="ident" id="4181473">finishedHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181487">masterSecret</span>&nbsp;<span class="op" id="4181500">[</span><span class="op" id="4181501">]</span><span class="builtintype" id="4181502">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181508">session</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4181521">*</span><span class="ident" id="4181522">ClientSessionState</span><br>
<span class="lineno"></span><span class="op" id="4181541">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="4181544">func</span>&nbsp;<span class="op" id="4181549">(</span><span class="ident" id="4181550">c</span>&nbsp;<span class="op" id="4181552">*</span><span class="ident" id="4181553">Conn</span><span class="op" id="4181557">)</span>&nbsp;<span class="ident" id="4181559">clientHandshake</span><span class="op" id="4181574">(</span><span class="op" id="4181575">)</span>&nbsp;<span class="builtintype" id="4181577">error</span>&nbsp;<span class="op" id="4181583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181586">if</span>&nbsp;<span class="ident" id="4181589">c</span><span class="op" id="4181590">.</span><span class="ident" id="4181591">config</span>&nbsp;<span class="op" id="4181598">==</span>&nbsp;<span class="ident" id="4181601">nil</span>&nbsp;<span class="op" id="4181605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181609">c</span><span class="op" id="4181610">.</span><span class="ident" id="4181611">config</span>&nbsp;<span class="op" id="4181618">=</span>&nbsp;<span class="ident" id="4181620">defaultConfig</span><span class="op" id="4181633">(</span><span class="op" id="4181634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4181637">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181641">if</span>&nbsp;<span class="builtinfunc" id="4181644">len</span><span class="op" id="4181647">(</span><span class="ident" id="4181648">c</span><span class="op" id="4181649">.</span><span class="ident" id="4181650">config</span><span class="op" id="4181656">.</span><span class="ident" id="4181657">ServerName</span><span class="op" id="4181667">)</span>&nbsp;<span class="op" id="4181669">==</span>&nbsp;<span class="num" id="4181672">0</span>&nbsp;<span class="op" id="4181674">&amp;&amp;</span>&nbsp;<span class="op" id="4181677">!</span><span class="ident" id="4181678">c</span><span class="op" id="4181679">.</span><span class="ident" id="4181680">config</span><span class="op" id="4181686">.</span><span class="ident" id="4181687">InsecureSkipVerify</span>&nbsp;<span class="op" id="4181706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181710">return</span>&nbsp;<span class="ident" id="4181717">errors</span><span class="op" id="4181723">.</span><span class="ident" id="4181724">New</span><span class="op" id="4181727">(</span><span class="string" id="4181728">&#34;tls:&nbsp;either&nbsp;ServerName&nbsp;or&nbsp;InsecureSkipVerify&nbsp;must&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;tls.Config&#34;</span><span class="op" id="4181810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4181813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181817">nextProtosLength</span>&nbsp;<span class="op" id="4181834">:=</span>&nbsp;<span class="num" id="4181837">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181840">for</span>&nbsp;<span class="ident" id="4181844">_</span><span class="op" id="4181845">,</span>&nbsp;<span class="ident" id="4181847">proto</span>&nbsp;<span class="op" id="4181853">:=</span>&nbsp;<span class="keyword" id="4181856">range</span>&nbsp;<span class="ident" id="4181862">c</span><span class="op" id="4181863">.</span><span class="ident" id="4181864">config</span><span class="op" id="4181870">.</span><span class="ident" id="4181871">NextProtos</span>&nbsp;<span class="op" id="4181882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181886">if</span>&nbsp;<span class="ident" id="4181889">l</span>&nbsp;<span class="op" id="4181891">:=</span>&nbsp;<span class="builtinfunc" id="4181894">len</span><span class="op" id="4181897">(</span><span class="ident" id="4181898">proto</span><span class="op" id="4181903">)</span><span class="op" id="4181904">;</span>&nbsp;<span class="ident" id="4181906">l</span>&nbsp;<span class="op" id="4181908">==</span>&nbsp;<span class="num" id="4181911">0</span>&nbsp;<span class="op" id="4181913">||</span>&nbsp;<span class="ident" id="4181916">l</span>&nbsp;<span class="op" id="4181918">&gt;</span>&nbsp;<span class="num" id="4181920">255</span>&nbsp;<span class="op" id="4181924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181929">return</span>&nbsp;<span class="ident" id="4181936">errors</span><span class="op" id="4181942">.</span><span class="ident" id="4181943">New</span><span class="op" id="4181946">(</span><span class="string" id="4181947">&#34;tls:&nbsp;invalid&nbsp;NextProtos&nbsp;value&#34;</span><span class="op" id="4181978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4181982">}</span>&nbsp;<span class="keyword" id="4181984">else</span>&nbsp;<span class="op" id="4181989">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181994">nextProtosLength</span>&nbsp;<span class="op" id="4182011">+=</span>&nbsp;<span class="num" id="4182014">1</span>&nbsp;<span class="op" id="4182016">+</span>&nbsp;<span class="ident" id="4182018">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4182022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4182025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4182028">if</span>&nbsp;<span class="ident" id="4182031">nextProtosLength</span>&nbsp;<span class="op" id="4182048">&gt;</span>&nbsp;<span class="num" id="4182050">0xffff</span>&nbsp;<span class="op" id="4182057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4182061">return</span>&nbsp;<span class="ident" id="4182068">errors</span><span class="op" id="4182074">.</span><span class="ident" id="4182075">New</span><span class="op" id="4182078">(</span><span class="string" id="4182079">&#34;tls:&nbsp;NextProtos&nbsp;values&nbsp;too&nbsp;large&#34;</span><span class="op" id="4182113">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4182116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182120">hello</span>&nbsp;<span class="op" id="4182126">:=</span>&nbsp;<span class="op" id="4182129">&amp;</span><span class="ident" id="4182130">clientHelloMsg</span><span class="op" id="4182144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182148">vers</span><span class="op" id="4182152">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182169">c</span><span class="op" id="4182170">.</span><span class="ident" id="4182171">config</span><span class="op" id="4182177">.</span><span class="ident" id="4182178">maxVersion</span><span class="op" id="4182188">(</span><span class="op" id="4182189">)</span><span class="op" id="4182190">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182194">compressionMethods</span><span class="op" id="4182212">:</span>&nbsp;&nbsp;<span class="op" id="4182215">[</span><span class="op" id="4182216">]</span><span class="builtintype" id="4182217">uint8</span><span class="op" id="4182222">{</span><span class="ident" id="4182223">compressionNone</span><span class="op" id="4182238">}</span><span class="op" id="4182239">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182243">random</span><span class="op" id="4182249">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4182264">make</span><span class="op" id="4182268">(</span><span class="op" id="4182269">[</span><span class="op" id="4182270">]</span><span class="builtintype" id="4182271">byte</span><span class="op" id="4182275">,</span>&nbsp;<span class="num" id="4182277">32</span><span class="op" id="4182279">)</span><span class="op" id="4182280">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182284">ocspStapling</span><span class="op" id="4182296">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4182305">true</span><span class="op" id="4182309">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182313">serverName</span><span class="op" id="4182323">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182334">c</span><span class="op" id="4182335">.</span><span class="ident" id="4182336">config</span><span class="op" id="4182342">.</span><span class="ident" id="4182343">ServerName</span><span class="op" id="4182353">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182357">supportedCurves</span><span class="op" id="4182372">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182378">c</span><span class="op" id="4182379">.</span><span class="ident" id="4182380">config</span><span class="op" id="4182386">.</span><span class="ident" id="4182387">curvePreferences</span><span class="op" id="4182403">(</span><span class="op" id="4182404">)</span><span class="op" id="4182405">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182409">supportedPoints</span><span class="op" id="4182424">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4182430">[</span><span class="op" id="4182431">]</span><span class="builtintype" id="4182432">uint8</span><span class="op" id="4182437">{</span><span class="ident" id="4182438">pointFormatUncompressed</span><span class="op" id="4182461">}</span><span class="op" id="4182462">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182466">nextProtoNeg</span><span class="op" id="4182478">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4182487">len</span><span class="op" id="4182490">(</span><span class="ident" id="4182491">c</span><span class="op" id="4182492">.</span><span class="ident" id="4182493">config</span><span class="op" id="4182499">.</span><span class="ident" id="4182500">NextProtos</span><span class="op" id="4182510">)</span>&nbsp;<span class="op" id="4182512">&gt;</span>&nbsp;<span class="num" id="4182514">0</span><span class="op" id="4182515">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182519">secureRenegotiation</span><span class="op" id="4182538">:</span>&nbsp;<span class="builtintype" id="4182540">true</span><span class="op" id="4182544">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182548">alpnProtocols</span><span class="op" id="4182561">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182569">c</span><span class="op" id="4182570">.</span><span class="ident" id="4182571">config</span><span class="op" id="4182577">.</span><span class="ident" id="4182578">NextProtos</span><span class="op" id="4182588">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4182591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182595">possibleCipherSuites</span>&nbsp;<span class="op" id="4182616">:=</span>&nbsp;<span class="ident" id="4182619">c</span><span class="op" id="4182620">.</span><span class="ident" id="4182621">config</span><span class="op" id="4182627">.</span><span class="ident" id="4182628">cipherSuites</span><span class="op" id="4182640">(</span><span class="op" id="4182641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182644">hello</span><span class="op" id="4182649">.</span><span class="ident" id="4182650">cipherSuites</span>&nbsp;<span class="op" id="4182663">=</span>&nbsp;<span class="builtinfunc" id="4182665">make</span><span class="op" id="4182669">(</span><span class="op" id="4182670">[</span><span class="op" id="4182671">]</span><span class="builtintype" id="4182672">uint16</span><span class="op" id="4182678">,</span>&nbsp;<span class="num" id="4182680">0</span><span class="op" id="4182681">,</span>&nbsp;<span class="builtinfunc" id="4182683">len</span><span class="op" id="4182686">(</span><span class="ident" id="4182687">possibleCipherSuites</span><span class="op" id="4182707">)</span><span class="op" id="4182708">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4182711">NextCipherSuite</span><span class="op" id="4182726">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4182729">for</span>&nbsp;<span class="ident" id="4182733">_</span><span class="op" id="4182734">,</span>&nbsp;<span class="ident" id="4182736">suiteId</span>&nbsp;<span class="op" id="4182744">:=</span>&nbsp;<span class="keyword" id="4182747">range</span>&nbsp;<span class="ident" id="4182753">possibleCipherSuites</span>&nbsp;<span class="op" id="4182774">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4182778">for</span>&nbsp;<span class="ident" id="4182782">_</span><span class="op" id="4182783">,</span>&nbsp;<span class="ident" id="4182785">suite</span>&nbsp;<span class="op" id="4182791">:=</span>&nbsp;<span class="keyword" id="4182794">range</span>&nbsp;<span class="ident" id="4182800">cipherSuites</span>&nbsp;<span class="op" id="4182813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4182818">if</span>&nbsp;<span class="ident" id="4182821">suite</span><span class="op" id="4182826">.</span><span class="ident" id="4182827">id</span>&nbsp;<span class="op" id="4182830">!=</span>&nbsp;<span class="ident" id="4182833">suiteId</span>&nbsp;<span class="op" id="4182841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4182847">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4182859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4182864">//&nbsp;Don&#39;t&nbsp;advertise&nbsp;TLS&nbsp;1.2-only&nbsp;cipher&nbsp;suites&nbsp;unless</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4182920">//&nbsp;we&#39;re&nbsp;attempting&nbsp;TLS&nbsp;1.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4182952">if</span>&nbsp;<span class="ident" id="4182955">hello</span><span class="op" id="4182960">.</span><span class="ident" id="4182961">vers</span>&nbsp;<span class="op" id="4182966">&lt;</span>&nbsp;<span class="ident" id="4182968">VersionTLS12</span>&nbsp;<span class="op" id="4182981">&amp;&amp;</span>&nbsp;<span class="ident" id="4182984">suite</span><span class="op" id="4182989">.</span><span class="ident" id="4182990">flags</span><span class="op" id="4182995">&amp;</span><span class="ident" id="4182996">suiteTLS12</span>&nbsp;<span class="op" id="4183007">!=</span>&nbsp;<span class="num" id="4183010">0</span>&nbsp;<span class="op" id="4183012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183018">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4183030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183035">hello</span><span class="op" id="4183040">.</span><span class="ident" id="4183041">cipherSuites</span>&nbsp;<span class="op" id="4183054">=</span>&nbsp;<span class="builtinfunc" id="4183056">append</span><span class="op" id="4183062">(</span><span class="ident" id="4183063">hello</span><span class="op" id="4183068">.</span><span class="ident" id="4183069">cipherSuites</span><span class="op" id="4183081">,</span>&nbsp;<span class="ident" id="4183083">suiteId</span><span class="op" id="4183090">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183095">continue</span>&nbsp;<span class="ident" id="4183104">NextCipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4183122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4183125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183129">_</span><span class="op" id="4183130">,</span>&nbsp;<span class="ident" id="4183132">err</span>&nbsp;<span class="op" id="4183136">:=</span>&nbsp;<span class="ident" id="4183139">io</span><span class="op" id="4183141">.</span><span class="ident" id="4183142">ReadFull</span><span class="op" id="4183150">(</span><span class="ident" id="4183151">c</span><span class="op" id="4183152">.</span><span class="ident" id="4183153">config</span><span class="op" id="4183159">.</span><span class="ident" id="4183160">rand</span><span class="op" id="4183164">(</span><span class="op" id="4183165">)</span><span class="op" id="4183166">,</span>&nbsp;<span class="ident" id="4183168">hello</span><span class="op" id="4183173">.</span><span class="ident" id="4183174">random</span><span class="op" id="4183180">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183183">if</span>&nbsp;<span class="ident" id="4183186">err</span>&nbsp;<span class="op" id="4183190">!=</span>&nbsp;<span class="ident" id="4183193">nil</span>&nbsp;<span class="op" id="4183197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183201">c</span><span class="op" id="4183202">.</span><span class="ident" id="4183203">sendAlert</span><span class="op" id="4183212">(</span><span class="ident" id="4183213">alertInternalError</span><span class="op" id="4183231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183235">return</span>&nbsp;<span class="ident" id="4183242">errors</span><span class="op" id="4183248">.</span><span class="ident" id="4183249">New</span><span class="op" id="4183252">(</span><span class="string" id="4183253">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="4183283">+</span>&nbsp;<span class="ident" id="4183285">err</span><span class="op" id="4183288">.</span><span class="ident" id="4183289">Error</span><span class="op" id="4183294">(</span><span class="op" id="4183295">)</span><span class="op" id="4183296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4183299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183303">if</span>&nbsp;<span class="ident" id="4183306">hello</span><span class="op" id="4183311">.</span><span class="ident" id="4183312">vers</span>&nbsp;<span class="op" id="4183317">&gt;=</span>&nbsp;<span class="ident" id="4183320">VersionTLS12</span>&nbsp;<span class="op" id="4183333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183337">hello</span><span class="op" id="4183342">.</span><span class="ident" id="4183343">signatureAndHashes</span>&nbsp;<span class="op" id="4183362">=</span>&nbsp;<span class="ident" id="4183364">supportedSKXSignatureAlgorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4183397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183401">var</span>&nbsp;<span class="ident" id="4183405">session</span>&nbsp;<span class="op" id="4183413">*</span><span class="ident" id="4183414">ClientSessionState</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183434">var</span>&nbsp;<span class="ident" id="4183438">cacheKey</span>&nbsp;<span class="builtintype" id="4183447">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183455">sessionCache</span>&nbsp;<span class="op" id="4183468">:=</span>&nbsp;<span class="ident" id="4183471">c</span><span class="op" id="4183472">.</span><span class="ident" id="4183473">config</span><span class="op" id="4183479">.</span><span class="ident" id="4183480">ClientSessionCache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183500">if</span>&nbsp;<span class="ident" id="4183503">c</span><span class="op" id="4183504">.</span><span class="ident" id="4183505">config</span><span class="op" id="4183511">.</span><span class="ident" id="4183512">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4183535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183539">sessionCache</span>&nbsp;<span class="op" id="4183552">=</span>&nbsp;<span class="ident" id="4183554">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4183559">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183563">if</span>&nbsp;<span class="ident" id="4183566">sessionCache</span>&nbsp;<span class="op" id="4183579">!=</span>&nbsp;<span class="ident" id="4183582">nil</span>&nbsp;<span class="op" id="4183586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183590">hello</span><span class="op" id="4183595">.</span><span class="ident" id="4183596">ticketSupported</span>&nbsp;<span class="op" id="4183612">=</span>&nbsp;<span class="builtintype" id="4183614">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4183622">//&nbsp;Try&nbsp;to&nbsp;resume&nbsp;a&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;session,&nbsp;if</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4183681">//&nbsp;available.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183697">cacheKey</span>&nbsp;<span class="op" id="4183706">=</span>&nbsp;<span class="ident" id="4183708">clientSessionCacheKey</span><span class="op" id="4183729">(</span><span class="ident" id="4183730">c</span><span class="op" id="4183731">.</span><span class="ident" id="4183732">conn</span><span class="op" id="4183736">.</span><span class="ident" id="4183737">RemoteAddr</span><span class="op" id="4183747">(</span><span class="op" id="4183748">)</span><span class="op" id="4183749">,</span>&nbsp;<span class="ident" id="4183751">c</span><span class="op" id="4183752">.</span><span class="ident" id="4183753">config</span><span class="op" id="4183759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183763">candidateSession</span><span class="op" id="4183779">,</span>&nbsp;<span class="ident" id="4183781">ok</span>&nbsp;<span class="op" id="4183784">:=</span>&nbsp;<span class="ident" id="4183787">sessionCache</span><span class="op" id="4183799">.</span><span class="ident" id="4183800">Get</span><span class="op" id="4183803">(</span><span class="ident" id="4183804">cacheKey</span><span class="op" id="4183812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183816">if</span>&nbsp;<span class="ident" id="4183819">ok</span>&nbsp;<span class="op" id="4183822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4183827">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;ciphersuite/version&nbsp;used&nbsp;for&nbsp;the</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4183881">//&nbsp;previous&nbsp;session&nbsp;are&nbsp;still&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183921">cipherSuiteOk</span>&nbsp;<span class="op" id="4183935">:=</span>&nbsp;<span class="builtintype" id="4183938">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183947">for</span>&nbsp;<span class="ident" id="4183951">_</span><span class="op" id="4183952">,</span>&nbsp;<span class="ident" id="4183954">id</span>&nbsp;<span class="op" id="4183957">:=</span>&nbsp;<span class="keyword" id="4183960">range</span>&nbsp;<span class="ident" id="4183966">hello</span><span class="op" id="4183971">.</span><span class="ident" id="4183972">cipherSuites</span>&nbsp;<span class="op" id="4183985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183991">if</span>&nbsp;<span class="ident" id="4183994">id</span>&nbsp;<span class="op" id="4183997">==</span>&nbsp;<span class="ident" id="4184000">candidateSession</span><span class="op" id="4184016">.</span><span class="ident" id="4184017">cipherSuite</span>&nbsp;<span class="op" id="4184029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184036">cipherSuiteOk</span>&nbsp;<span class="op" id="4184050">=</span>&nbsp;<span class="builtintype" id="4184052">true</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184062">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4184072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4184077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184083">versOk</span>&nbsp;<span class="op" id="4184090">:=</span>&nbsp;<span class="ident" id="4184093">candidateSession</span><span class="op" id="4184109">.</span><span class="ident" id="4184110">vers</span>&nbsp;<span class="op" id="4184115">&gt;=</span>&nbsp;<span class="ident" id="4184118">c</span><span class="op" id="4184119">.</span><span class="ident" id="4184120">config</span><span class="op" id="4184126">.</span><span class="ident" id="4184127">minVersion</span><span class="op" id="4184137">(</span><span class="op" id="4184138">)</span>&nbsp;<span class="op" id="4184140">&amp;&amp;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184147">candidateSession</span><span class="op" id="4184163">.</span><span class="ident" id="4184164">vers</span>&nbsp;<span class="op" id="4184169">&lt;=</span>&nbsp;<span class="ident" id="4184172">c</span><span class="op" id="4184173">.</span><span class="ident" id="4184174">config</span><span class="op" id="4184180">.</span><span class="ident" id="4184181">maxVersion</span><span class="op" id="4184191">(</span><span class="op" id="4184192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184197">if</span>&nbsp;<span class="ident" id="4184200">versOk</span>&nbsp;<span class="op" id="4184207">&amp;&amp;</span>&nbsp;<span class="ident" id="4184210">cipherSuiteOk</span>&nbsp;<span class="op" id="4184224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184230">session</span>&nbsp;<span class="op" id="4184238">=</span>&nbsp;<span class="ident" id="4184240">candidateSession</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4184260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4184264">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4184267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184271">if</span>&nbsp;<span class="ident" id="4184274">session</span>&nbsp;<span class="op" id="4184282">!=</span>&nbsp;<span class="ident" id="4184285">nil</span>&nbsp;<span class="op" id="4184289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184293">hello</span><span class="op" id="4184298">.</span><span class="ident" id="4184299">sessionTicket</span>&nbsp;<span class="op" id="4184313">=</span>&nbsp;<span class="ident" id="4184315">session</span><span class="op" id="4184322">.</span><span class="ident" id="4184323">sessionTicket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4184339">//&nbsp;A&nbsp;random&nbsp;session&nbsp;ID&nbsp;is&nbsp;used&nbsp;to&nbsp;detect&nbsp;when&nbsp;the</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4184391">//&nbsp;server&nbsp;accepted&nbsp;the&nbsp;ticket&nbsp;and&nbsp;is&nbsp;resuming&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4184449">//&nbsp;(see&nbsp;RFC&nbsp;5077).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184470">hello</span><span class="op" id="4184475">.</span><span class="ident" id="4184476">sessionId</span>&nbsp;<span class="op" id="4184486">=</span>&nbsp;<span class="builtinfunc" id="4184488">make</span><span class="op" id="4184492">(</span><span class="op" id="4184493">[</span><span class="op" id="4184494">]</span><span class="builtintype" id="4184495">byte</span><span class="op" id="4184499">,</span>&nbsp;<span class="num" id="4184501">16</span><span class="op" id="4184503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184507">if</span>&nbsp;<span class="ident" id="4184510">_</span><span class="op" id="4184511">,</span>&nbsp;<span class="ident" id="4184513">err</span>&nbsp;<span class="op" id="4184517">:=</span>&nbsp;<span class="ident" id="4184520">io</span><span class="op" id="4184522">.</span><span class="ident" id="4184523">ReadFull</span><span class="op" id="4184531">(</span><span class="ident" id="4184532">c</span><span class="op" id="4184533">.</span><span class="ident" id="4184534">config</span><span class="op" id="4184540">.</span><span class="ident" id="4184541">rand</span><span class="op" id="4184545">(</span><span class="op" id="4184546">)</span><span class="op" id="4184547">,</span>&nbsp;<span class="ident" id="4184549">hello</span><span class="op" id="4184554">.</span><span class="ident" id="4184555">sessionId</span><span class="op" id="4184564">)</span><span class="op" id="4184565">;</span>&nbsp;<span class="ident" id="4184567">err</span>&nbsp;<span class="op" id="4184571">!=</span>&nbsp;<span class="ident" id="4184574">nil</span>&nbsp;<span class="op" id="4184578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184583">c</span><span class="op" id="4184584">.</span><span class="ident" id="4184585">sendAlert</span><span class="op" id="4184594">(</span><span class="ident" id="4184595">alertInternalError</span><span class="op" id="4184613">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184618">return</span>&nbsp;<span class="ident" id="4184625">errors</span><span class="op" id="4184631">.</span><span class="ident" id="4184632">New</span><span class="op" id="4184635">(</span><span class="string" id="4184636">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="4184666">+</span>&nbsp;<span class="ident" id="4184668">err</span><span class="op" id="4184671">.</span><span class="ident" id="4184672">Error</span><span class="op" id="4184677">(</span><span class="op" id="4184678">)</span><span class="op" id="4184679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4184683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4184686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184690">c</span><span class="op" id="4184691">.</span><span class="ident" id="4184692">writeRecord</span><span class="op" id="4184703">(</span><span class="ident" id="4184704">recordTypeHandshake</span><span class="op" id="4184723">,</span>&nbsp;<span class="ident" id="4184725">hello</span><span class="op" id="4184730">.</span><span class="ident" id="4184731">marshal</span><span class="op" id="4184738">(</span><span class="op" id="4184739">)</span><span class="op" id="4184740">)</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184744">msg</span><span class="op" id="4184747">,</span>&nbsp;<span class="ident" id="4184749">err</span>&nbsp;<span class="op" id="4184753">:=</span>&nbsp;<span class="ident" id="4184756">c</span><span class="op" id="4184757">.</span><span class="ident" id="4184758">readHandshake</span><span class="op" id="4184771">(</span><span class="op" id="4184772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184775">if</span>&nbsp;<span class="ident" id="4184778">err</span>&nbsp;<span class="op" id="4184782">!=</span>&nbsp;<span class="ident" id="4184785">nil</span>&nbsp;<span class="op" id="4184789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184793">return</span>&nbsp;<span class="ident" id="4184800">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4184805">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184808">serverHello</span><span class="op" id="4184819">,</span>&nbsp;<span class="ident" id="4184821">ok</span>&nbsp;<span class="op" id="4184824">:=</span>&nbsp;<span class="ident" id="4184827">msg</span><span class="op" id="4184830">.</span><span class="op" id="4184831">(</span><span class="op" id="4184832">*</span><span class="ident" id="4184833">serverHelloMsg</span><span class="op" id="4184847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184850">if</span>&nbsp;<span class="op" id="4184853">!</span><span class="ident" id="4184854">ok</span>&nbsp;<span class="op" id="4184857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184861">c</span><span class="op" id="4184862">.</span><span class="ident" id="4184863">sendAlert</span><span class="op" id="4184872">(</span><span class="ident" id="4184873">alertUnexpectedMessage</span><span class="op" id="4184895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184899">return</span>&nbsp;<span class="ident" id="4184906">unexpectedMessageError</span><span class="op" id="4184928">(</span><span class="ident" id="4184929">serverHello</span><span class="op" id="4184940">,</span>&nbsp;<span class="ident" id="4184942">msg</span><span class="op" id="4184945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4184948">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184952">vers</span><span class="op" id="4184956">,</span>&nbsp;<span class="ident" id="4184958">ok</span>&nbsp;<span class="op" id="4184961">:=</span>&nbsp;<span class="ident" id="4184964">c</span><span class="op" id="4184965">.</span><span class="ident" id="4184966">config</span><span class="op" id="4184972">.</span><span class="ident" id="4184973">mutualVersion</span><span class="op" id="4184986">(</span><span class="ident" id="4184987">serverHello</span><span class="op" id="4184998">.</span><span class="ident" id="4184999">vers</span><span class="op" id="4185003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185006">if</span>&nbsp;<span class="op" id="4185009">!</span><span class="ident" id="4185010">ok</span>&nbsp;<span class="op" id="4185013">||</span>&nbsp;<span class="ident" id="4185016">vers</span>&nbsp;<span class="op" id="4185021">&lt;</span>&nbsp;<span class="ident" id="4185023">VersionTLS10</span>&nbsp;<span class="op" id="4185036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4185040">//&nbsp;TLS&nbsp;1.0&nbsp;is&nbsp;the&nbsp;minimum&nbsp;version&nbsp;supported&nbsp;as&nbsp;a&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4185099">c</span><span class="op" id="4185100">.</span><span class="ident" id="4185101">sendAlert</span><span class="op" id="4185110">(</span><span class="ident" id="4185111">alertProtocolVersion</span><span class="op" id="4185131">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185135">return</span>&nbsp;<span class="ident" id="4185142">fmt</span><span class="op" id="4185145">.</span><span class="ident" id="4185146">Errorf</span><span class="op" id="4185152">(</span><span class="string" id="4185153">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;protocol&nbsp;version&nbsp;%x&#34;</span><span class="op" id="4185207">,</span>&nbsp;<span class="ident" id="4185209">serverHello</span><span class="op" id="4185220">.</span><span class="ident" id="4185221">vers</span><span class="op" id="4185225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4185228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4185231">c</span><span class="op" id="4185232">.</span><span class="ident" id="4185233">vers</span>&nbsp;<span class="op" id="4185238">=</span>&nbsp;<span class="ident" id="4185240">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4185246">c</span><span class="op" id="4185247">.</span><span class="ident" id="4185248">haveVers</span>&nbsp;<span class="op" id="4185257">=</span>&nbsp;<span class="builtintype" id="4185259">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4185266">suite</span>&nbsp;<span class="op" id="4185272">:=</span>&nbsp;<span class="ident" id="4185275">mutualCipherSuite</span><span class="op" id="4185292">(</span><span class="ident" id="4185293">c</span><span class="op" id="4185294">.</span><span class="ident" id="4185295">config</span><span class="op" id="4185301">.</span><span class="ident" id="4185302">cipherSuites</span><span class="op" id="4185314">(</span><span class="op" id="4185315">)</span><span class="op" id="4185316">,</span>&nbsp;<span class="ident" id="4185318">serverHello</span><span class="op" id="4185329">.</span><span class="ident" id="4185330">cipherSuite</span><span class="op" id="4185341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185344">if</span>&nbsp;<span class="ident" id="4185347">suite</span>&nbsp;<span class="op" id="4185353">==</span>&nbsp;<span class="ident" id="4185356">nil</span>&nbsp;<span class="op" id="4185360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4185364">c</span><span class="op" id="4185365">.</span><span class="ident" id="4185366">sendAlert</span><span class="op" id="4185375">(</span><span class="ident" id="4185376">alertHandshakeFailure</span><span class="op" id="4185397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185401">return</span>&nbsp;<span class="ident" id="4185408">fmt</span><span class="op" id="4185411">.</span><span class="ident" id="4185412">Errorf</span><span class="op" id="4185418">(</span><span class="string" id="4185419">&#34;tls:&nbsp;server&nbsp;selected&nbsp;an&nbsp;unsupported&nbsp;cipher&nbsp;suite&#34;</span><span class="op" id="4185469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4185472">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4185476">hs</span>&nbsp;<span class="op" id="4185479">:=</span>&nbsp;<span class="op" id="4185482">&amp;</span><span class="ident" id="4185483">clientHandshakeState</span><span class="op" id="4185503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4185507">c</span><span class="op" id="4185508">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185521">c</span><span class="op" id="4185522">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4185526">serverHello</span><span class="op" id="4185537">:</span>&nbsp;&nbsp;<span class="ident" id="4185540">serverHello</span><span class="op" id="4185551">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4185555">hello</span><span class="op" id="4185560">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185569">hello</span><span class="op" id="4185574">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4185578">suite</span><span class="op" id="4185583">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185592">suite</span><span class="op" id="4185597">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4185601">finishedHash</span><span class="op" id="4185613">:</span>&nbsp;<span class="ident" id="4185615">newFinishedHash</span><span class="op" id="4185630">(</span><span class="ident" id="4185631">c</span><span class="op" id="4185632">.</span><span class="ident" id="4185633">vers</span><span class="op" id="4185637">)</span><span class="op" id="4185638">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4185642">session</span><span class="op" id="4185649">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185656">session</span><span class="op" id="4185663">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4185666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4185670">hs</span><span class="op" id="4185672">.</span><span class="ident" id="4185673">finishedHash</span><span class="op" id="4185685">.</span><span class="ident" id="4185686">Write</span><span class="op" id="4185691">(</span><span class="ident" id="4185692">hs</span><span class="op" id="4185694">.</span><span class="ident" id="4185695">hello</span><span class="op" id="4185700">.</span><span class="ident" id="4185701">marshal</span><span class="op" id="4185708">(</span><span class="op" id="4185709">)</span><span class="op" id="4185710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4185713">hs</span><span class="op" id="4185715">.</span><span class="ident" id="4185716">finishedHash</span><span class="op" id="4185728">.</span><span class="ident" id="4185729">Write</span><span class="op" id="4185734">(</span><span class="ident" id="4185735">hs</span><span class="op" id="4185737">.</span><span class="ident" id="4185738">serverHello</span><span class="op" id="4185749">.</span><span class="ident" id="4185750">marshal</span><span class="op" id="4185757">(</span><span class="op" id="4185758">)</span><span class="op" id="4185759">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4185763">isResume</span><span class="op" id="4185771">,</span>&nbsp;<span class="ident" id="4185773">err</span>&nbsp;<span class="op" id="4185777">:=</span>&nbsp;<span class="ident" id="4185780">hs</span><span class="op" id="4185782">.</span><span class="ident" id="4185783">processServerHello</span><span class="op" id="4185801">(</span><span class="op" id="4185802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185805">if</span>&nbsp;<span class="ident" id="4185808">err</span>&nbsp;<span class="op" id="4185812">!=</span>&nbsp;<span class="ident" id="4185815">nil</span>&nbsp;<span class="op" id="4185819">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185823">return</span>&nbsp;<span class="ident" id="4185830">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4185835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185839">if</span>&nbsp;<span class="ident" id="4185842">isResume</span>&nbsp;<span class="op" id="4185851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185855">if</span>&nbsp;<span class="ident" id="4185858">err</span>&nbsp;<span class="op" id="4185862">:=</span>&nbsp;<span class="ident" id="4185865">hs</span><span class="op" id="4185867">.</span><span class="ident" id="4185868">establishKeys</span><span class="op" id="4185881">(</span><span class="op" id="4185882">)</span><span class="op" id="4185883">;</span>&nbsp;<span class="ident" id="4185885">err</span>&nbsp;<span class="op" id="4185889">!=</span>&nbsp;<span class="ident" id="4185892">nil</span>&nbsp;<span class="op" id="4185896">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185901">return</span>&nbsp;<span class="ident" id="4185908">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4185914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185918">if</span>&nbsp;<span class="ident" id="4185921">err</span>&nbsp;<span class="op" id="4185925">:=</span>&nbsp;<span class="ident" id="4185928">hs</span><span class="op" id="4185930">.</span><span class="ident" id="4185931">readSessionTicket</span><span class="op" id="4185948">(</span><span class="op" id="4185949">)</span><span class="op" id="4185950">;</span>&nbsp;<span class="ident" id="4185952">err</span>&nbsp;<span class="op" id="4185956">!=</span>&nbsp;<span class="ident" id="4185959">nil</span>&nbsp;<span class="op" id="4185963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185968">return</span>&nbsp;<span class="ident" id="4185975">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4185981">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185985">if</span>&nbsp;<span class="ident" id="4185988">err</span>&nbsp;<span class="op" id="4185992">:=</span>&nbsp;<span class="ident" id="4185995">hs</span><span class="op" id="4185997">.</span><span class="ident" id="4185998">readFinished</span><span class="op" id="4186010">(</span><span class="ident" id="4186011">c</span><span class="op" id="4186012">.</span><span class="ident" id="4186013">firstFinished</span><span class="op" id="4186026">[</span><span class="op" id="4186027">:</span><span class="op" id="4186028">]</span><span class="op" id="4186029">)</span><span class="op" id="4186030">;</span>&nbsp;<span class="ident" id="4186032">err</span>&nbsp;<span class="op" id="4186036">!=</span>&nbsp;<span class="ident" id="4186039">nil</span>&nbsp;<span class="op" id="4186043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186048">return</span>&nbsp;<span class="ident" id="4186055">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186065">if</span>&nbsp;<span class="ident" id="4186068">err</span>&nbsp;<span class="op" id="4186072">:=</span>&nbsp;<span class="ident" id="4186075">hs</span><span class="op" id="4186077">.</span><span class="ident" id="4186078">sendFinished</span><span class="op" id="4186090">(</span><span class="ident" id="4186091">nil</span><span class="op" id="4186094">)</span><span class="op" id="4186095">;</span>&nbsp;<span class="ident" id="4186097">err</span>&nbsp;<span class="op" id="4186101">!=</span>&nbsp;<span class="ident" id="4186104">nil</span>&nbsp;<span class="op" id="4186108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186113">return</span>&nbsp;<span class="ident" id="4186120">err</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186129">}</span>&nbsp;<span class="keyword" id="4186131">else</span>&nbsp;<span class="op" id="4186136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186140">if</span>&nbsp;<span class="ident" id="4186143">err</span>&nbsp;<span class="op" id="4186147">:=</span>&nbsp;<span class="ident" id="4186150">hs</span><span class="op" id="4186152">.</span><span class="ident" id="4186153">doFullHandshake</span><span class="op" id="4186168">(</span><span class="op" id="4186169">)</span><span class="op" id="4186170">;</span>&nbsp;<span class="ident" id="4186172">err</span>&nbsp;<span class="op" id="4186176">!=</span>&nbsp;<span class="ident" id="4186179">nil</span>&nbsp;<span class="op" id="4186183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186188">return</span>&nbsp;<span class="ident" id="4186195">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186201">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186205">if</span>&nbsp;<span class="ident" id="4186208">err</span>&nbsp;<span class="op" id="4186212">:=</span>&nbsp;<span class="ident" id="4186215">hs</span><span class="op" id="4186217">.</span><span class="ident" id="4186218">establishKeys</span><span class="op" id="4186231">(</span><span class="op" id="4186232">)</span><span class="op" id="4186233">;</span>&nbsp;<span class="ident" id="4186235">err</span>&nbsp;<span class="op" id="4186239">!=</span>&nbsp;<span class="ident" id="4186242">nil</span>&nbsp;<span class="op" id="4186246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186251">return</span>&nbsp;<span class="ident" id="4186258">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186268">if</span>&nbsp;<span class="ident" id="4186271">err</span>&nbsp;<span class="op" id="4186275">:=</span>&nbsp;<span class="ident" id="4186278">hs</span><span class="op" id="4186280">.</span><span class="ident" id="4186281">sendFinished</span><span class="op" id="4186293">(</span><span class="ident" id="4186294">c</span><span class="op" id="4186295">.</span><span class="ident" id="4186296">firstFinished</span><span class="op" id="4186309">[</span><span class="op" id="4186310">:</span><span class="op" id="4186311">]</span><span class="op" id="4186312">)</span><span class="op" id="4186313">;</span>&nbsp;<span class="ident" id="4186315">err</span>&nbsp;<span class="op" id="4186319">!=</span>&nbsp;<span class="ident" id="4186322">nil</span>&nbsp;<span class="op" id="4186326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186331">return</span>&nbsp;<span class="ident" id="4186338">err</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186348">if</span>&nbsp;<span class="ident" id="4186351">err</span>&nbsp;<span class="op" id="4186355">:=</span>&nbsp;<span class="ident" id="4186358">hs</span><span class="op" id="4186360">.</span><span class="ident" id="4186361">readSessionTicket</span><span class="op" id="4186378">(</span><span class="op" id="4186379">)</span><span class="op" id="4186380">;</span>&nbsp;<span class="ident" id="4186382">err</span>&nbsp;<span class="op" id="4186386">!=</span>&nbsp;<span class="ident" id="4186389">nil</span>&nbsp;<span class="op" id="4186393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186398">return</span>&nbsp;<span class="ident" id="4186405">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186415">if</span>&nbsp;<span class="ident" id="4186418">err</span>&nbsp;<span class="op" id="4186422">:=</span>&nbsp;<span class="ident" id="4186425">hs</span><span class="op" id="4186427">.</span><span class="ident" id="4186428">readFinished</span><span class="op" id="4186440">(</span><span class="ident" id="4186441">nil</span><span class="op" id="4186444">)</span><span class="op" id="4186445">;</span>&nbsp;<span class="ident" id="4186447">err</span>&nbsp;<span class="op" id="4186451">!=</span>&nbsp;<span class="ident" id="4186454">nil</span>&nbsp;<span class="op" id="4186458">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186463">return</span>&nbsp;<span class="ident" id="4186470">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186483">if</span>&nbsp;<span class="ident" id="4186486">sessionCache</span>&nbsp;<span class="op" id="4186499">!=</span>&nbsp;<span class="ident" id="4186502">nil</span>&nbsp;<span class="op" id="4186506">&amp;&amp;</span>&nbsp;<span class="ident" id="4186509">hs</span><span class="op" id="4186511">.</span><span class="ident" id="4186512">session</span>&nbsp;<span class="op" id="4186520">!=</span>&nbsp;<span class="ident" id="4186523">nil</span>&nbsp;<span class="op" id="4186527">&amp;&amp;</span>&nbsp;<span class="ident" id="4186530">session</span>&nbsp;<span class="op" id="4186538">!=</span>&nbsp;<span class="ident" id="4186541">hs</span><span class="op" id="4186543">.</span><span class="ident" id="4186544">session</span>&nbsp;<span class="op" id="4186552">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4186556">sessionCache</span><span class="op" id="4186568">.</span><span class="ident" id="4186569">Put</span><span class="op" id="4186572">(</span><span class="ident" id="4186573">cacheKey</span><span class="op" id="4186581">,</span>&nbsp;<span class="ident" id="4186583">hs</span><span class="op" id="4186585">.</span><span class="ident" id="4186586">session</span><span class="op" id="4186593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4186600">c</span><span class="op" id="4186601">.</span><span class="ident" id="4186602">didResume</span>&nbsp;<span class="op" id="4186612">=</span>&nbsp;<span class="ident" id="4186614">isResume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4186624">c</span><span class="op" id="4186625">.</span><span class="ident" id="4186626">handshakeComplete</span>&nbsp;<span class="op" id="4186644">=</span>&nbsp;<span class="builtintype" id="4186646">true</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4186652">c</span><span class="op" id="4186653">.</span><span class="ident" id="4186654">cipherSuite</span>&nbsp;<span class="op" id="4186666">=</span>&nbsp;<span class="ident" id="4186668">suite</span><span class="op" id="4186673">.</span><span class="ident" id="4186674">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186678">return</span>&nbsp;<span class="ident" id="4186685">nil</span><br>
<span class="lineno"></span><span class="op" id="4186689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4186692">func</span>&nbsp;<span class="op" id="4186697">(</span><span class="ident" id="4186698">hs</span>&nbsp;<span class="op" id="4186701">*</span><span class="ident" id="4186702">clientHandshakeState</span><span class="op" id="4186722">)</span>&nbsp;<span class="ident" id="4186724">doFullHandshake</span><span class="op" id="4186739">(</span><span class="op" id="4186740">)</span>&nbsp;<span class="builtintype" id="4186742">error</span>&nbsp;<span class="op" id="4186748">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4186751">c</span>&nbsp;<span class="op" id="4186753">:=</span>&nbsp;<span class="ident" id="4186756">hs</span><span class="op" id="4186758">.</span><span class="ident" id="4186759">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4186763">msg</span><span class="op" id="4186766">,</span>&nbsp;<span class="ident" id="4186768">err</span>&nbsp;<span class="op" id="4186772">:=</span>&nbsp;<span class="ident" id="4186775">c</span><span class="op" id="4186776">.</span><span class="ident" id="4186777">readHandshake</span><span class="op" id="4186790">(</span><span class="op" id="4186791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186794">if</span>&nbsp;<span class="ident" id="4186797">err</span>&nbsp;<span class="op" id="4186801">!=</span>&nbsp;<span class="ident" id="4186804">nil</span>&nbsp;<span class="op" id="4186808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186812">return</span>&nbsp;<span class="ident" id="4186819">err</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4186827">certMsg</span><span class="op" id="4186834">,</span>&nbsp;<span class="ident" id="4186836">ok</span>&nbsp;<span class="op" id="4186839">:=</span>&nbsp;<span class="ident" id="4186842">msg</span><span class="op" id="4186845">.</span><span class="op" id="4186846">(</span><span class="op" id="4186847">*</span><span class="ident" id="4186848">certificateMsg</span><span class="op" id="4186862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186865">if</span>&nbsp;<span class="op" id="4186868">!</span><span class="ident" id="4186869">ok</span>&nbsp;<span class="op" id="4186872">||</span>&nbsp;<span class="builtinfunc" id="4186875">len</span><span class="op" id="4186878">(</span><span class="ident" id="4186879">certMsg</span><span class="op" id="4186886">.</span><span class="ident" id="4186887">certificates</span><span class="op" id="4186899">)</span>&nbsp;<span class="op" id="4186901">==</span>&nbsp;<span class="num" id="4186904">0</span>&nbsp;<span class="op" id="4186906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4186910">c</span><span class="op" id="4186911">.</span><span class="ident" id="4186912">sendAlert</span><span class="op" id="4186921">(</span><span class="ident" id="4186922">alertUnexpectedMessage</span><span class="op" id="4186944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186948">return</span>&nbsp;<span class="ident" id="4186955">unexpectedMessageError</span><span class="op" id="4186977">(</span><span class="ident" id="4186978">certMsg</span><span class="op" id="4186985">,</span>&nbsp;<span class="ident" id="4186987">msg</span><span class="op" id="4186990">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4186996">hs</span><span class="op" id="4186998">.</span><span class="ident" id="4186999">finishedHash</span><span class="op" id="4187011">.</span><span class="ident" id="4187012">Write</span><span class="op" id="4187017">(</span><span class="ident" id="4187018">certMsg</span><span class="op" id="4187025">.</span><span class="ident" id="4187026">marshal</span><span class="op" id="4187033">(</span><span class="op" id="4187034">)</span><span class="op" id="4187035">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187039">certs</span>&nbsp;<span class="op" id="4187045">:=</span>&nbsp;<span class="builtinfunc" id="4187048">make</span><span class="op" id="4187052">(</span><span class="op" id="4187053">[</span><span class="op" id="4187054">]</span><span class="op" id="4187055">*</span><span class="ident" id="4187056">x509</span><span class="op" id="4187060">.</span><span class="ident" id="4187061">Certificate</span><span class="op" id="4187072">,</span>&nbsp;<span class="builtinfunc" id="4187074">len</span><span class="op" id="4187077">(</span><span class="ident" id="4187078">certMsg</span><span class="op" id="4187085">.</span><span class="ident" id="4187086">certificates</span><span class="op" id="4187098">)</span><span class="op" id="4187099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187102">for</span>&nbsp;<span class="ident" id="4187106">i</span><span class="op" id="4187107">,</span>&nbsp;<span class="ident" id="4187109">asn1Data</span>&nbsp;<span class="op" id="4187118">:=</span>&nbsp;<span class="keyword" id="4187121">range</span>&nbsp;<span class="ident" id="4187127">certMsg</span><span class="op" id="4187134">.</span><span class="ident" id="4187135">certificates</span>&nbsp;<span class="op" id="4187148">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187152">cert</span><span class="op" id="4187156">,</span>&nbsp;<span class="ident" id="4187158">err</span>&nbsp;<span class="op" id="4187162">:=</span>&nbsp;<span class="ident" id="4187165">x509</span><span class="op" id="4187169">.</span><span class="ident" id="4187170">ParseCertificate</span><span class="op" id="4187186">(</span><span class="ident" id="4187187">asn1Data</span><span class="op" id="4187195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187199">if</span>&nbsp;<span class="ident" id="4187202">err</span>&nbsp;<span class="op" id="4187206">!=</span>&nbsp;<span class="ident" id="4187209">nil</span>&nbsp;<span class="op" id="4187213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187218">c</span><span class="op" id="4187219">.</span><span class="ident" id="4187220">sendAlert</span><span class="op" id="4187229">(</span><span class="ident" id="4187230">alertBadCertificate</span><span class="op" id="4187249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187254">return</span>&nbsp;<span class="ident" id="4187261">errors</span><span class="op" id="4187267">.</span><span class="ident" id="4187268">New</span><span class="op" id="4187271">(</span><span class="string" id="4187272">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;from&nbsp;server:&nbsp;&#34;</span>&nbsp;<span class="op" id="4187321">+</span>&nbsp;<span class="ident" id="4187323">err</span><span class="op" id="4187326">.</span><span class="ident" id="4187327">Error</span><span class="op" id="4187332">(</span><span class="op" id="4187333">)</span><span class="op" id="4187334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4187338">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187342">certs</span><span class="op" id="4187347">[</span><span class="ident" id="4187348">i</span><span class="op" id="4187349">]</span>&nbsp;<span class="op" id="4187351">=</span>&nbsp;<span class="ident" id="4187353">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4187359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187363">if</span>&nbsp;<span class="op" id="4187366">!</span><span class="ident" id="4187367">c</span><span class="op" id="4187368">.</span><span class="ident" id="4187369">config</span><span class="op" id="4187375">.</span><span class="ident" id="4187376">InsecureSkipVerify</span>&nbsp;<span class="op" id="4187395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187399">opts</span>&nbsp;<span class="op" id="4187404">:=</span>&nbsp;<span class="ident" id="4187407">x509</span><span class="op" id="4187411">.</span><span class="ident" id="4187412">VerifyOptions</span><span class="op" id="4187425">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187430">Roots</span><span class="op" id="4187435">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187445">c</span><span class="op" id="4187446">.</span><span class="ident" id="4187447">config</span><span class="op" id="4187453">.</span><span class="ident" id="4187454">RootCAs</span><span class="op" id="4187461">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187466">CurrentTime</span><span class="op" id="4187477">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4187481">c</span><span class="op" id="4187482">.</span><span class="ident" id="4187483">config</span><span class="op" id="4187489">.</span><span class="ident" id="4187490">time</span><span class="op" id="4187494">(</span><span class="op" id="4187495">)</span><span class="op" id="4187496">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187501">DNSName</span><span class="op" id="4187508">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187516">c</span><span class="op" id="4187517">.</span><span class="ident" id="4187518">config</span><span class="op" id="4187524">.</span><span class="ident" id="4187525">ServerName</span><span class="op" id="4187535">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187540">Intermediates</span><span class="op" id="4187553">:</span>&nbsp;<span class="ident" id="4187555">x509</span><span class="op" id="4187559">.</span><span class="ident" id="4187560">NewCertPool</span><span class="op" id="4187571">(</span><span class="op" id="4187572">)</span><span class="op" id="4187573">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4187577">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187582">for</span>&nbsp;<span class="ident" id="4187586">i</span><span class="op" id="4187587">,</span>&nbsp;<span class="ident" id="4187589">cert</span>&nbsp;<span class="op" id="4187594">:=</span>&nbsp;<span class="keyword" id="4187597">range</span>&nbsp;<span class="ident" id="4187603">certs</span>&nbsp;<span class="op" id="4187609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187614">if</span>&nbsp;<span class="ident" id="4187617">i</span>&nbsp;<span class="op" id="4187619">==</span>&nbsp;<span class="num" id="4187622">0</span>&nbsp;<span class="op" id="4187624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187630">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4187642">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187647">opts</span><span class="op" id="4187651">.</span><span class="ident" id="4187652">Intermediates</span><span class="op" id="4187665">.</span><span class="ident" id="4187666">AddCert</span><span class="op" id="4187673">(</span><span class="ident" id="4187674">cert</span><span class="op" id="4187678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4187682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187686">c</span><span class="op" id="4187687">.</span><span class="ident" id="4187688">verifiedChains</span><span class="op" id="4187702">,</span>&nbsp;<span class="ident" id="4187704">err</span>&nbsp;<span class="op" id="4187708">=</span>&nbsp;<span class="ident" id="4187710">certs</span><span class="op" id="4187715">[</span><span class="num" id="4187716">0</span><span class="op" id="4187717">]</span><span class="op" id="4187718">.</span><span class="ident" id="4187719">Verify</span><span class="op" id="4187725">(</span><span class="ident" id="4187726">opts</span><span class="op" id="4187730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187734">if</span>&nbsp;<span class="ident" id="4187737">err</span>&nbsp;<span class="op" id="4187741">!=</span>&nbsp;<span class="ident" id="4187744">nil</span>&nbsp;<span class="op" id="4187748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187753">c</span><span class="op" id="4187754">.</span><span class="ident" id="4187755">sendAlert</span><span class="op" id="4187764">(</span><span class="ident" id="4187765">alertBadCertificate</span><span class="op" id="4187784">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187789">return</span>&nbsp;<span class="ident" id="4187796">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4187802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4187805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187809">switch</span>&nbsp;<span class="ident" id="4187816">certs</span><span class="op" id="4187821">[</span><span class="num" id="4187822">0</span><span class="op" id="4187823">]</span><span class="op" id="4187824">.</span><span class="ident" id="4187825">PublicKey</span><span class="op" id="4187834">.</span><span class="op" id="4187835">(</span><span class="keyword" id="4187836">type</span><span class="op" id="4187840">)</span>&nbsp;<span class="op" id="4187842">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187845">case</span>&nbsp;<span class="op" id="4187850">*</span><span class="ident" id="4187851">rsa</span><span class="op" id="4187854">.</span><span class="ident" id="4187855">PublicKey</span><span class="op" id="4187864">,</span>&nbsp;<span class="op" id="4187866">*</span><span class="ident" id="4187867">ecdsa</span><span class="op" id="4187872">.</span><span class="ident" id="4187873">PublicKey</span><span class="op" id="4187882">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187886">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187893">default</span><span class="op" id="4187900">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187904">c</span><span class="op" id="4187905">.</span><span class="ident" id="4187906">sendAlert</span><span class="op" id="4187915">(</span><span class="ident" id="4187916">alertUnsupportedCertificate</span><span class="op" id="4187943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187947">return</span>&nbsp;<span class="ident" id="4187954">fmt</span><span class="op" id="4187957">.</span><span class="ident" id="4187958">Errorf</span><span class="op" id="4187964">(</span><span class="string" id="4187965">&#34;tls:&nbsp;server&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;type&nbsp;of&nbsp;public&nbsp;key:&nbsp;%T&#34;</span><span class="op" id="4188039">,</span>&nbsp;<span class="ident" id="4188041">certs</span><span class="op" id="4188046">[</span><span class="num" id="4188047">0</span><span class="op" id="4188048">]</span><span class="op" id="4188049">.</span><span class="ident" id="4188050">PublicKey</span><span class="op" id="4188059">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4188062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188066">c</span><span class="op" id="4188067">.</span><span class="ident" id="4188068">peerCertificates</span>&nbsp;<span class="op" id="4188085">=</span>&nbsp;<span class="ident" id="4188087">certs</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188095">if</span>&nbsp;<span class="ident" id="4188098">hs</span><span class="op" id="4188100">.</span><span class="ident" id="4188101">serverHello</span><span class="op" id="4188112">.</span><span class="ident" id="4188113">ocspStapling</span>&nbsp;<span class="op" id="4188126">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188130">msg</span><span class="op" id="4188133">,</span>&nbsp;<span class="ident" id="4188135">err</span>&nbsp;<span class="op" id="4188139">=</span>&nbsp;<span class="ident" id="4188141">c</span><span class="op" id="4188142">.</span><span class="ident" id="4188143">readHandshake</span><span class="op" id="4188156">(</span><span class="op" id="4188157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188161">if</span>&nbsp;<span class="ident" id="4188164">err</span>&nbsp;<span class="op" id="4188168">!=</span>&nbsp;<span class="ident" id="4188171">nil</span>&nbsp;<span class="op" id="4188175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188180">return</span>&nbsp;<span class="ident" id="4188187">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4188193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188197">cs</span><span class="op" id="4188199">,</span>&nbsp;<span class="ident" id="4188201">ok</span>&nbsp;<span class="op" id="4188204">:=</span>&nbsp;<span class="ident" id="4188207">msg</span><span class="op" id="4188210">.</span><span class="op" id="4188211">(</span><span class="op" id="4188212">*</span><span class="ident" id="4188213">certificateStatusMsg</span><span class="op" id="4188233">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188237">if</span>&nbsp;<span class="op" id="4188240">!</span><span class="ident" id="4188241">ok</span>&nbsp;<span class="op" id="4188244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188249">c</span><span class="op" id="4188250">.</span><span class="ident" id="4188251">sendAlert</span><span class="op" id="4188260">(</span><span class="ident" id="4188261">alertUnexpectedMessage</span><span class="op" id="4188283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188288">return</span>&nbsp;<span class="ident" id="4188295">unexpectedMessageError</span><span class="op" id="4188317">(</span><span class="ident" id="4188318">cs</span><span class="op" id="4188320">,</span>&nbsp;<span class="ident" id="4188322">msg</span><span class="op" id="4188325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4188329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188333">hs</span><span class="op" id="4188335">.</span><span class="ident" id="4188336">finishedHash</span><span class="op" id="4188348">.</span><span class="ident" id="4188349">Write</span><span class="op" id="4188354">(</span><span class="ident" id="4188355">cs</span><span class="op" id="4188357">.</span><span class="ident" id="4188358">marshal</span><span class="op" id="4188365">(</span><span class="op" id="4188366">)</span><span class="op" id="4188367">)</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188372">if</span>&nbsp;<span class="ident" id="4188375">cs</span><span class="op" id="4188377">.</span><span class="ident" id="4188378">statusType</span>&nbsp;<span class="op" id="4188389">==</span>&nbsp;<span class="ident" id="4188392">statusTypeOCSP</span>&nbsp;<span class="op" id="4188407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188412">c</span><span class="op" id="4188413">.</span><span class="ident" id="4188414">ocspResponse</span>&nbsp;<span class="op" id="4188427">=</span>&nbsp;<span class="ident" id="4188429">cs</span><span class="op" id="4188431">.</span><span class="ident" id="4188432">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4188443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4188446">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188450">msg</span><span class="op" id="4188453">,</span>&nbsp;<span class="ident" id="4188455">err</span>&nbsp;<span class="op" id="4188459">=</span>&nbsp;<span class="ident" id="4188461">c</span><span class="op" id="4188462">.</span><span class="ident" id="4188463">readHandshake</span><span class="op" id="4188476">(</span><span class="op" id="4188477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188480">if</span>&nbsp;<span class="ident" id="4188483">err</span>&nbsp;<span class="op" id="4188487">!=</span>&nbsp;<span class="ident" id="4188490">nil</span>&nbsp;<span class="op" id="4188494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188498">return</span>&nbsp;<span class="ident" id="4188505">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4188510">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188514">keyAgreement</span>&nbsp;<span class="op" id="4188527">:=</span>&nbsp;<span class="ident" id="4188530">hs</span><span class="op" id="4188532">.</span><span class="ident" id="4188533">suite</span><span class="op" id="4188538">.</span><span class="ident" id="4188539">ka</span><span class="op" id="4188541">(</span><span class="ident" id="4188542">c</span><span class="op" id="4188543">.</span><span class="ident" id="4188544">vers</span><span class="op" id="4188548">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188552">skx</span><span class="op" id="4188555">,</span>&nbsp;<span class="ident" id="4188557">ok</span>&nbsp;<span class="op" id="4188560">:=</span>&nbsp;<span class="ident" id="4188563">msg</span><span class="op" id="4188566">.</span><span class="op" id="4188567">(</span><span class="op" id="4188568">*</span><span class="ident" id="4188569">serverKeyExchangeMsg</span><span class="op" id="4188589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188592">if</span>&nbsp;<span class="ident" id="4188595">ok</span>&nbsp;<span class="op" id="4188598">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188602">hs</span><span class="op" id="4188604">.</span><span class="ident" id="4188605">finishedHash</span><span class="op" id="4188617">.</span><span class="ident" id="4188618">Write</span><span class="op" id="4188623">(</span><span class="ident" id="4188624">skx</span><span class="op" id="4188627">.</span><span class="ident" id="4188628">marshal</span><span class="op" id="4188635">(</span><span class="op" id="4188636">)</span><span class="op" id="4188637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188641">err</span>&nbsp;<span class="op" id="4188645">=</span>&nbsp;<span class="ident" id="4188647">keyAgreement</span><span class="op" id="4188659">.</span><span class="ident" id="4188660">processServerKeyExchange</span><span class="op" id="4188684">(</span><span class="ident" id="4188685">c</span><span class="op" id="4188686">.</span><span class="ident" id="4188687">config</span><span class="op" id="4188693">,</span>&nbsp;<span class="ident" id="4188695">hs</span><span class="op" id="4188697">.</span><span class="ident" id="4188698">hello</span><span class="op" id="4188703">,</span>&nbsp;<span class="ident" id="4188705">hs</span><span class="op" id="4188707">.</span><span class="ident" id="4188708">serverHello</span><span class="op" id="4188719">,</span>&nbsp;<span class="ident" id="4188721">certs</span><span class="op" id="4188726">[</span><span class="num" id="4188727">0</span><span class="op" id="4188728">]</span><span class="op" id="4188729">,</span>&nbsp;<span class="ident" id="4188731">skx</span><span class="op" id="4188734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188738">if</span>&nbsp;<span class="ident" id="4188741">err</span>&nbsp;<span class="op" id="4188745">!=</span>&nbsp;<span class="ident" id="4188748">nil</span>&nbsp;<span class="op" id="4188752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188757">c</span><span class="op" id="4188758">.</span><span class="ident" id="4188759">sendAlert</span><span class="op" id="4188768">(</span><span class="ident" id="4188769">alertUnexpectedMessage</span><span class="op" id="4188791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188796">return</span>&nbsp;<span class="ident" id="4188803">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4188809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188814">msg</span><span class="op" id="4188817">,</span>&nbsp;<span class="ident" id="4188819">err</span>&nbsp;<span class="op" id="4188823">=</span>&nbsp;<span class="ident" id="4188825">c</span><span class="op" id="4188826">.</span><span class="ident" id="4188827">readHandshake</span><span class="op" id="4188840">(</span><span class="op" id="4188841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188845">if</span>&nbsp;<span class="ident" id="4188848">err</span>&nbsp;<span class="op" id="4188852">!=</span>&nbsp;<span class="ident" id="4188855">nil</span>&nbsp;<span class="op" id="4188859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188864">return</span>&nbsp;<span class="ident" id="4188871">err</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4188877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4188880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188884">var</span>&nbsp;<span class="ident" id="4188888">chainToSend</span>&nbsp;<span class="op" id="4188900">*</span><span class="ident" id="4188901">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188914">var</span>&nbsp;<span class="ident" id="4188918">certRequested</span>&nbsp;<span class="builtintype" id="4188932">bool</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188938">certReq</span><span class="op" id="4188945">,</span>&nbsp;<span class="ident" id="4188947">ok</span>&nbsp;<span class="op" id="4188950">:=</span>&nbsp;<span class="ident" id="4188953">msg</span><span class="op" id="4188956">.</span><span class="op" id="4188957">(</span><span class="op" id="4188958">*</span><span class="ident" id="4188959">certificateRequestMsg</span><span class="op" id="4188980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188983">if</span>&nbsp;<span class="ident" id="4188986">ok</span>&nbsp;<span class="op" id="4188989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188993">certRequested</span>&nbsp;<span class="op" id="4189007">=</span>&nbsp;<span class="builtintype" id="4189009">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4189017">//&nbsp;RFC&nbsp;4346&nbsp;on&nbsp;the&nbsp;certificateAuthorities&nbsp;field:</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4189068">//&nbsp;A&nbsp;list&nbsp;of&nbsp;the&nbsp;distinguished&nbsp;names&nbsp;of&nbsp;acceptable&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4189133">//&nbsp;authorities.&nbsp;These&nbsp;distinguished&nbsp;names&nbsp;may&nbsp;specify&nbsp;a&nbsp;desired</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4189199">//&nbsp;distinguished&nbsp;name&nbsp;for&nbsp;a&nbsp;root&nbsp;CA&nbsp;or&nbsp;for&nbsp;a&nbsp;subordinate&nbsp;CA;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4189262">//&nbsp;thus,&nbsp;this&nbsp;message&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;describe&nbsp;both&nbsp;known&nbsp;roots</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4189327">//&nbsp;and&nbsp;a&nbsp;desired&nbsp;authorization&nbsp;space.&nbsp;If&nbsp;the</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4189374">//&nbsp;certificate_authorities&nbsp;list&nbsp;is&nbsp;empty&nbsp;then&nbsp;the&nbsp;client&nbsp;MAY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4189437">//&nbsp;send&nbsp;any&nbsp;certificate&nbsp;of&nbsp;the&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4189482">//&nbsp;ClientCertificateType,&nbsp;unless&nbsp;there&nbsp;is&nbsp;some&nbsp;external</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4189540">//&nbsp;arrangement&nbsp;to&nbsp;the&nbsp;contrary.</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4189575">hs</span><span class="op" id="4189577">.</span><span class="ident" id="4189578">finishedHash</span><span class="op" id="4189590">.</span><span class="ident" id="4189591">Write</span><span class="op" id="4189596">(</span><span class="ident" id="4189597">certReq</span><span class="op" id="4189604">.</span><span class="ident" id="4189605">marshal</span><span class="op" id="4189612">(</span><span class="op" id="4189613">)</span><span class="op" id="4189614">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189619">var</span>&nbsp;<span class="ident" id="4189623">rsaAvail</span><span class="op" id="4189631">,</span>&nbsp;<span class="ident" id="4189633">ecdsaAvail</span>&nbsp;<span class="builtintype" id="4189644">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189651">for</span>&nbsp;<span class="ident" id="4189655">_</span><span class="op" id="4189656">,</span>&nbsp;<span class="ident" id="4189658">certType</span>&nbsp;<span class="op" id="4189667">:=</span>&nbsp;<span class="keyword" id="4189670">range</span>&nbsp;<span class="ident" id="4189676">certReq</span><span class="op" id="4189683">.</span><span class="ident" id="4189684">certificateTypes</span>&nbsp;<span class="op" id="4189701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189706">switch</span>&nbsp;<span class="ident" id="4189713">certType</span>&nbsp;<span class="op" id="4189722">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189727">case</span>&nbsp;<span class="ident" id="4189732">certTypeRSASign</span><span class="op" id="4189747">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4189753">rsaAvail</span>&nbsp;<span class="op" id="4189762">=</span>&nbsp;<span class="builtintype" id="4189764">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189772">case</span>&nbsp;<span class="ident" id="4189777">certTypeECDSASign</span><span class="op" id="4189794">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4189800">ecdsaAvail</span>&nbsp;<span class="op" id="4189811">=</span>&nbsp;<span class="builtintype" id="4189813">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4189821">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4189825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4189830">//&nbsp;We&nbsp;need&nbsp;to&nbsp;search&nbsp;our&nbsp;list&nbsp;of&nbsp;client&nbsp;certs&nbsp;for&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4189886">//&nbsp;where&nbsp;SignatureAlgorithm&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;the&nbsp;server&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4189952">//&nbsp;Issuer&nbsp;is&nbsp;in&nbsp;certReq.certificateAuthorities</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4190000">findCert</span><span class="op" id="4190008">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190012">for</span>&nbsp;<span class="ident" id="4190016">i</span><span class="op" id="4190017">,</span>&nbsp;<span class="ident" id="4190019">chain</span>&nbsp;<span class="op" id="4190025">:=</span>&nbsp;<span class="keyword" id="4190028">range</span>&nbsp;<span class="ident" id="4190034">c</span><span class="op" id="4190035">.</span><span class="ident" id="4190036">config</span><span class="op" id="4190042">.</span><span class="ident" id="4190043">Certificates</span>&nbsp;<span class="op" id="4190056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190061">if</span>&nbsp;<span class="op" id="4190064">!</span><span class="ident" id="4190065">rsaAvail</span>&nbsp;<span class="op" id="4190074">&amp;&amp;</span>&nbsp;<span class="op" id="4190077">!</span><span class="ident" id="4190078">ecdsaAvail</span>&nbsp;<span class="op" id="4190089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190095">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4190107">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190113">for</span>&nbsp;<span class="ident" id="4190117">j</span><span class="op" id="4190118">,</span>&nbsp;<span class="ident" id="4190120">cert</span>&nbsp;<span class="op" id="4190125">:=</span>&nbsp;<span class="keyword" id="4190128">range</span>&nbsp;<span class="ident" id="4190134">chain</span><span class="op" id="4190139">.</span><span class="ident" id="4190140">Certificate</span>&nbsp;<span class="op" id="4190152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4190158">x509Cert</span>&nbsp;<span class="op" id="4190167">:=</span>&nbsp;<span class="ident" id="4190170">chain</span><span class="op" id="4190175">.</span><span class="ident" id="4190176">Leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4190185">//&nbsp;parse&nbsp;the&nbsp;certificate&nbsp;if&nbsp;this&nbsp;isn&#39;t&nbsp;the&nbsp;leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4190237">//&nbsp;node,&nbsp;or&nbsp;if&nbsp;chain.Leaf&nbsp;was&nbsp;nil</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190275">if</span>&nbsp;<span class="ident" id="4190278">j</span>&nbsp;<span class="op" id="4190280">!=</span>&nbsp;<span class="num" id="4190283">0</span>&nbsp;<span class="op" id="4190285">||</span>&nbsp;<span class="ident" id="4190288">x509Cert</span>&nbsp;<span class="op" id="4190297">==</span>&nbsp;<span class="ident" id="4190300">nil</span>&nbsp;<span class="op" id="4190304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190311">if</span>&nbsp;<span class="ident" id="4190314">x509Cert</span><span class="op" id="4190322">,</span>&nbsp;<span class="ident" id="4190324">err</span>&nbsp;<span class="op" id="4190328">=</span>&nbsp;<span class="ident" id="4190330">x509</span><span class="op" id="4190334">.</span><span class="ident" id="4190335">ParseCertificate</span><span class="op" id="4190351">(</span><span class="ident" id="4190352">cert</span><span class="op" id="4190356">)</span><span class="op" id="4190357">;</span>&nbsp;<span class="ident" id="4190359">err</span>&nbsp;<span class="op" id="4190363">!=</span>&nbsp;<span class="ident" id="4190366">nil</span>&nbsp;<span class="op" id="4190370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4190378">c</span><span class="op" id="4190379">.</span><span class="ident" id="4190380">sendAlert</span><span class="op" id="4190389">(</span><span class="ident" id="4190390">alertInternalError</span><span class="op" id="4190408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190416">return</span>&nbsp;<span class="ident" id="4190423">errors</span><span class="op" id="4190429">.</span><span class="ident" id="4190430">New</span><span class="op" id="4190433">(</span><span class="string" id="4190434">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate&nbsp;#&#34;</span>&nbsp;<span class="op" id="4190478">+</span>&nbsp;<span class="ident" id="4190480">strconv</span><span class="op" id="4190487">.</span><span class="ident" id="4190488">Itoa</span><span class="op" id="4190492">(</span><span class="ident" id="4190493">i</span><span class="op" id="4190494">)</span>&nbsp;<span class="op" id="4190496">+</span>&nbsp;<span class="string" id="4190498">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="4190503">+</span>&nbsp;<span class="ident" id="4190505">err</span><span class="op" id="4190508">.</span><span class="ident" id="4190509">Error</span><span class="op" id="4190514">(</span><span class="op" id="4190515">)</span><span class="op" id="4190516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4190523">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4190529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190536">switch</span>&nbsp;<span class="op" id="4190543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190549">case</span>&nbsp;<span class="ident" id="4190554">rsaAvail</span>&nbsp;<span class="op" id="4190563">&amp;&amp;</span>&nbsp;<span class="ident" id="4190566">x509Cert</span><span class="op" id="4190574">.</span><span class="ident" id="4190575">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="4190594">==</span>&nbsp;<span class="ident" id="4190597">x509</span><span class="op" id="4190601">.</span><span class="ident" id="4190602">RSA</span><span class="op" id="4190605">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190611">case</span>&nbsp;<span class="ident" id="4190616">ecdsaAvail</span>&nbsp;<span class="op" id="4190627">&amp;&amp;</span>&nbsp;<span class="ident" id="4190630">x509Cert</span><span class="op" id="4190638">.</span><span class="ident" id="4190639">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="4190658">==</span>&nbsp;<span class="ident" id="4190661">x509</span><span class="op" id="4190665">.</span><span class="ident" id="4190666">ECDSA</span><span class="op" id="4190671">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190677">default</span><span class="op" id="4190684">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190691">continue</span>&nbsp;<span class="ident" id="4190700">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4190713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190720">if</span>&nbsp;<span class="builtinfunc" id="4190723">len</span><span class="op" id="4190726">(</span><span class="ident" id="4190727">certReq</span><span class="op" id="4190734">.</span><span class="ident" id="4190735">certificateAuthorities</span><span class="op" id="4190757">)</span>&nbsp;<span class="op" id="4190759">==</span>&nbsp;<span class="num" id="4190762">0</span>&nbsp;<span class="op" id="4190764">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4190771">//&nbsp;they&nbsp;gave&nbsp;us&nbsp;an&nbsp;empty&nbsp;list,&nbsp;so&nbsp;just&nbsp;take&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4190824">//&nbsp;first&nbsp;cert&nbsp;from&nbsp;c.config.Certificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4190870">chainToSend</span>&nbsp;<span class="op" id="4190882">=</span>&nbsp;<span class="op" id="4190884">&amp;</span><span class="ident" id="4190885">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190896">break</span>&nbsp;<span class="ident" id="4190902">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4190915">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190922">for</span>&nbsp;<span class="ident" id="4190926">_</span><span class="op" id="4190927">,</span>&nbsp;<span class="ident" id="4190929">ca</span>&nbsp;<span class="op" id="4190932">:=</span>&nbsp;<span class="keyword" id="4190935">range</span>&nbsp;<span class="ident" id="4190941">certReq</span><span class="op" id="4190948">.</span><span class="ident" id="4190949">certificateAuthorities</span>&nbsp;<span class="op" id="4190972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190979">if</span>&nbsp;<span class="ident" id="4190982">bytes</span><span class="op" id="4190987">.</span><span class="ident" id="4190988">Equal</span><span class="op" id="4190993">(</span><span class="ident" id="4190994">x509Cert</span><span class="op" id="4191002">.</span><span class="ident" id="4191003">RawIssuer</span><span class="op" id="4191012">,</span>&nbsp;<span class="ident" id="4191014">ca</span><span class="op" id="4191016">)</span>&nbsp;<span class="op" id="4191018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191026">chainToSend</span>&nbsp;<span class="op" id="4191038">=</span>&nbsp;<span class="op" id="4191040">&amp;</span><span class="ident" id="4191041">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191053">break</span>&nbsp;<span class="ident" id="4191059">findCert</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4191073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4191079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4191084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4191088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191093">msg</span><span class="op" id="4191096">,</span>&nbsp;<span class="ident" id="4191098">err</span>&nbsp;<span class="op" id="4191102">=</span>&nbsp;<span class="ident" id="4191104">c</span><span class="op" id="4191105">.</span><span class="ident" id="4191106">readHandshake</span><span class="op" id="4191119">(</span><span class="op" id="4191120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191124">if</span>&nbsp;<span class="ident" id="4191127">err</span>&nbsp;<span class="op" id="4191131">!=</span>&nbsp;<span class="ident" id="4191134">nil</span>&nbsp;<span class="op" id="4191138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191143">return</span>&nbsp;<span class="ident" id="4191150">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4191156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4191159">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191163">shd</span><span class="op" id="4191166">,</span>&nbsp;<span class="ident" id="4191168">ok</span>&nbsp;<span class="op" id="4191171">:=</span>&nbsp;<span class="ident" id="4191174">msg</span><span class="op" id="4191177">.</span><span class="op" id="4191178">(</span><span class="op" id="4191179">*</span><span class="ident" id="4191180">serverHelloDoneMsg</span><span class="op" id="4191198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191201">if</span>&nbsp;<span class="op" id="4191204">!</span><span class="ident" id="4191205">ok</span>&nbsp;<span class="op" id="4191208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191212">c</span><span class="op" id="4191213">.</span><span class="ident" id="4191214">sendAlert</span><span class="op" id="4191223">(</span><span class="ident" id="4191224">alertUnexpectedMessage</span><span class="op" id="4191246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191250">return</span>&nbsp;<span class="ident" id="4191257">unexpectedMessageError</span><span class="op" id="4191279">(</span><span class="ident" id="4191280">shd</span><span class="op" id="4191283">,</span>&nbsp;<span class="ident" id="4191285">msg</span><span class="op" id="4191288">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4191291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191294">hs</span><span class="op" id="4191296">.</span><span class="ident" id="4191297">finishedHash</span><span class="op" id="4191309">.</span><span class="ident" id="4191310">Write</span><span class="op" id="4191315">(</span><span class="ident" id="4191316">shd</span><span class="op" id="4191319">.</span><span class="ident" id="4191320">marshal</span><span class="op" id="4191327">(</span><span class="op" id="4191328">)</span><span class="op" id="4191329">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4191333">//&nbsp;If&nbsp;the&nbsp;server&nbsp;requested&nbsp;a&nbsp;certificate&nbsp;then&nbsp;we&nbsp;have&nbsp;to&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4191398">//&nbsp;Certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4191466">//&nbsp;certificate&nbsp;to&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191491">if</span>&nbsp;<span class="ident" id="4191494">certRequested</span>&nbsp;<span class="op" id="4191508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191512">certMsg</span>&nbsp;<span class="op" id="4191520">=</span>&nbsp;<span class="builtinfunc" id="4191522">new</span><span class="op" id="4191525">(</span><span class="ident" id="4191526">certificateMsg</span><span class="op" id="4191540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191544">if</span>&nbsp;<span class="ident" id="4191547">chainToSend</span>&nbsp;<span class="op" id="4191559">!=</span>&nbsp;<span class="ident" id="4191562">nil</span>&nbsp;<span class="op" id="4191566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191571">certMsg</span><span class="op" id="4191578">.</span><span class="ident" id="4191579">certificates</span>&nbsp;<span class="op" id="4191592">=</span>&nbsp;<span class="ident" id="4191594">chainToSend</span><span class="op" id="4191605">.</span><span class="ident" id="4191606">Certificate</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4191620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191624">hs</span><span class="op" id="4191626">.</span><span class="ident" id="4191627">finishedHash</span><span class="op" id="4191639">.</span><span class="ident" id="4191640">Write</span><span class="op" id="4191645">(</span><span class="ident" id="4191646">certMsg</span><span class="op" id="4191653">.</span><span class="ident" id="4191654">marshal</span><span class="op" id="4191661">(</span><span class="op" id="4191662">)</span><span class="op" id="4191663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191667">c</span><span class="op" id="4191668">.</span><span class="ident" id="4191669">writeRecord</span><span class="op" id="4191680">(</span><span class="ident" id="4191681">recordTypeHandshake</span><span class="op" id="4191700">,</span>&nbsp;<span class="ident" id="4191702">certMsg</span><span class="op" id="4191709">.</span><span class="ident" id="4191710">marshal</span><span class="op" id="4191717">(</span><span class="op" id="4191718">)</span><span class="op" id="4191719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4191722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191726">preMasterSecret</span><span class="op" id="4191741">,</span>&nbsp;<span class="ident" id="4191743">ckx</span><span class="op" id="4191746">,</span>&nbsp;<span class="ident" id="4191748">err</span>&nbsp;<span class="op" id="4191752">:=</span>&nbsp;<span class="ident" id="4191755">keyAgreement</span><span class="op" id="4191767">.</span><span class="ident" id="4191768">generateClientKeyExchange</span><span class="op" id="4191793">(</span><span class="ident" id="4191794">c</span><span class="op" id="4191795">.</span><span class="ident" id="4191796">config</span><span class="op" id="4191802">,</span>&nbsp;<span class="ident" id="4191804">hs</span><span class="op" id="4191806">.</span><span class="ident" id="4191807">hello</span><span class="op" id="4191812">,</span>&nbsp;<span class="ident" id="4191814">certs</span><span class="op" id="4191819">[</span><span class="num" id="4191820">0</span><span class="op" id="4191821">]</span><span class="op" id="4191822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191825">if</span>&nbsp;<span class="ident" id="4191828">err</span>&nbsp;<span class="op" id="4191832">!=</span>&nbsp;<span class="ident" id="4191835">nil</span>&nbsp;<span class="op" id="4191839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191843">c</span><span class="op" id="4191844">.</span><span class="ident" id="4191845">sendAlert</span><span class="op" id="4191854">(</span><span class="ident" id="4191855">alertInternalError</span><span class="op" id="4191873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191877">return</span>&nbsp;<span class="ident" id="4191884">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4191889">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191892">if</span>&nbsp;<span class="ident" id="4191895">ckx</span>&nbsp;<span class="op" id="4191899">!=</span>&nbsp;<span class="ident" id="4191902">nil</span>&nbsp;<span class="op" id="4191906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191910">hs</span><span class="op" id="4191912">.</span><span class="ident" id="4191913">finishedHash</span><span class="op" id="4191925">.</span><span class="ident" id="4191926">Write</span><span class="op" id="4191931">(</span><span class="ident" id="4191932">ckx</span><span class="op" id="4191935">.</span><span class="ident" id="4191936">marshal</span><span class="op" id="4191943">(</span><span class="op" id="4191944">)</span><span class="op" id="4191945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191949">c</span><span class="op" id="4191950">.</span><span class="ident" id="4191951">writeRecord</span><span class="op" id="4191962">(</span><span class="ident" id="4191963">recordTypeHandshake</span><span class="op" id="4191982">,</span>&nbsp;<span class="ident" id="4191984">ckx</span><span class="op" id="4191987">.</span><span class="ident" id="4191988">marshal</span><span class="op" id="4191995">(</span><span class="op" id="4191996">)</span><span class="op" id="4191997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4192000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192004">if</span>&nbsp;<span class="ident" id="4192007">chainToSend</span>&nbsp;<span class="op" id="4192019">!=</span>&nbsp;<span class="ident" id="4192022">nil</span>&nbsp;<span class="op" id="4192026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192030">var</span>&nbsp;<span class="ident" id="4192034">signed</span>&nbsp;<span class="op" id="4192041">[</span><span class="op" id="4192042">]</span><span class="builtintype" id="4192043">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192050">certVerify</span>&nbsp;<span class="op" id="4192061">:=</span>&nbsp;<span class="op" id="4192064">&amp;</span><span class="ident" id="4192065">certificateVerifyMsg</span><span class="op" id="4192085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192090">hasSignatureAndHash</span><span class="op" id="4192109">:</span>&nbsp;<span class="ident" id="4192111">c</span><span class="op" id="4192112">.</span><span class="ident" id="4192113">vers</span>&nbsp;<span class="op" id="4192118">&gt;=</span>&nbsp;<span class="ident" id="4192121">VersionTLS12</span><span class="op" id="4192133">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4192137">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192142">key</span><span class="op" id="4192145">,</span>&nbsp;<span class="ident" id="4192147">ok</span>&nbsp;<span class="op" id="4192150">:=</span>&nbsp;<span class="ident" id="4192153">chainToSend</span><span class="op" id="4192164">.</span><span class="ident" id="4192165">PrivateKey</span><span class="op" id="4192175">.</span><span class="op" id="4192176">(</span><span class="ident" id="4192177">crypto</span><span class="op" id="4192183">.</span><span class="ident" id="4192184">Signer</span><span class="op" id="4192190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192194">if</span>&nbsp;<span class="op" id="4192197">!</span><span class="ident" id="4192198">ok</span>&nbsp;<span class="op" id="4192201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192206">c</span><span class="op" id="4192207">.</span><span class="ident" id="4192208">sendAlert</span><span class="op" id="4192217">(</span><span class="ident" id="4192218">alertInternalError</span><span class="op" id="4192236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192241">return</span>&nbsp;<span class="ident" id="4192248">fmt</span><span class="op" id="4192251">.</span><span class="ident" id="4192252">Errorf</span><span class="op" id="4192258">(</span><span class="string" id="4192259">&#34;tls:&nbsp;client&nbsp;certificate&nbsp;private&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&nbsp;does&nbsp;not&nbsp;implement&nbsp;crypto.Signer&#34;</span><span class="op" id="4192340">,</span>&nbsp;<span class="ident" id="4192342">chainToSend</span><span class="op" id="4192353">.</span><span class="ident" id="4192354">PrivateKey</span><span class="op" id="4192364">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4192368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192372">switch</span>&nbsp;<span class="ident" id="4192379">key</span><span class="op" id="4192382">.</span><span class="ident" id="4192383">Public</span><span class="op" id="4192389">(</span><span class="op" id="4192390">)</span><span class="op" id="4192391">.</span><span class="op" id="4192392">(</span><span class="keyword" id="4192393">type</span><span class="op" id="4192397">)</span>&nbsp;<span class="op" id="4192399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192403">case</span>&nbsp;<span class="op" id="4192408">*</span><span class="ident" id="4192409">ecdsa</span><span class="op" id="4192414">.</span><span class="ident" id="4192415">PublicKey</span><span class="op" id="4192424">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192429">digest</span><span class="op" id="4192435">,</span>&nbsp;<span class="ident" id="4192437">hashFunc</span><span class="op" id="4192445">,</span>&nbsp;<span class="ident" id="4192447">hashId</span>&nbsp;<span class="op" id="4192454">:=</span>&nbsp;<span class="ident" id="4192457">hs</span><span class="op" id="4192459">.</span><span class="ident" id="4192460">finishedHash</span><span class="op" id="4192472">.</span><span class="ident" id="4192473">hashForClientCertificate</span><span class="op" id="4192497">(</span><span class="ident" id="4192498">signatureECDSA</span><span class="op" id="4192512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192517">signed</span><span class="op" id="4192523">,</span>&nbsp;<span class="ident" id="4192525">err</span>&nbsp;<span class="op" id="4192529">=</span>&nbsp;<span class="ident" id="4192531">key</span><span class="op" id="4192534">.</span><span class="ident" id="4192535">Sign</span><span class="op" id="4192539">(</span><span class="ident" id="4192540">c</span><span class="op" id="4192541">.</span><span class="ident" id="4192542">config</span><span class="op" id="4192548">.</span><span class="ident" id="4192549">rand</span><span class="op" id="4192553">(</span><span class="op" id="4192554">)</span><span class="op" id="4192555">,</span>&nbsp;<span class="ident" id="4192557">digest</span><span class="op" id="4192563">,</span>&nbsp;<span class="ident" id="4192565">hashFunc</span><span class="op" id="4192573">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192578">certVerify</span><span class="op" id="4192588">.</span><span class="ident" id="4192589">signatureAndHash</span><span class="op" id="4192605">.</span><span class="ident" id="4192606">signature</span>&nbsp;<span class="op" id="4192616">=</span>&nbsp;<span class="ident" id="4192618">signatureECDSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192636">certVerify</span><span class="op" id="4192646">.</span><span class="ident" id="4192647">signatureAndHash</span><span class="op" id="4192663">.</span><span class="ident" id="4192664">hash</span>&nbsp;<span class="op" id="4192669">=</span>&nbsp;<span class="ident" id="4192671">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192680">case</span>&nbsp;<span class="op" id="4192685">*</span><span class="ident" id="4192686">rsa</span><span class="op" id="4192689">.</span><span class="ident" id="4192690">PublicKey</span><span class="op" id="4192699">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192704">digest</span><span class="op" id="4192710">,</span>&nbsp;<span class="ident" id="4192712">hashFunc</span><span class="op" id="4192720">,</span>&nbsp;<span class="ident" id="4192722">hashId</span>&nbsp;<span class="op" id="4192729">:=</span>&nbsp;<span class="ident" id="4192732">hs</span><span class="op" id="4192734">.</span><span class="ident" id="4192735">finishedHash</span><span class="op" id="4192747">.</span><span class="ident" id="4192748">hashForClientCertificate</span><span class="op" id="4192772">(</span><span class="ident" id="4192773">signatureRSA</span><span class="op" id="4192785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192790">signed</span><span class="op" id="4192796">,</span>&nbsp;<span class="ident" id="4192798">err</span>&nbsp;<span class="op" id="4192802">=</span>&nbsp;<span class="ident" id="4192804">key</span><span class="op" id="4192807">.</span><span class="ident" id="4192808">Sign</span><span class="op" id="4192812">(</span><span class="ident" id="4192813">c</span><span class="op" id="4192814">.</span><span class="ident" id="4192815">config</span><span class="op" id="4192821">.</span><span class="ident" id="4192822">rand</span><span class="op" id="4192826">(</span><span class="op" id="4192827">)</span><span class="op" id="4192828">,</span>&nbsp;<span class="ident" id="4192830">digest</span><span class="op" id="4192836">,</span>&nbsp;<span class="ident" id="4192838">hashFunc</span><span class="op" id="4192846">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192851">certVerify</span><span class="op" id="4192861">.</span><span class="ident" id="4192862">signatureAndHash</span><span class="op" id="4192878">.</span><span class="ident" id="4192879">signature</span>&nbsp;<span class="op" id="4192889">=</span>&nbsp;<span class="ident" id="4192891">signatureRSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192907">certVerify</span><span class="op" id="4192917">.</span><span class="ident" id="4192918">signatureAndHash</span><span class="op" id="4192934">.</span><span class="ident" id="4192935">hash</span>&nbsp;<span class="op" id="4192940">=</span>&nbsp;<span class="ident" id="4192942">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192951">default</span><span class="op" id="4192958">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192963">err</span>&nbsp;<span class="op" id="4192967">=</span>&nbsp;<span class="ident" id="4192969">fmt</span><span class="op" id="4192972">.</span><span class="ident" id="4192973">Errorf</span><span class="op" id="4192979">(</span><span class="string" id="4192980">&#34;tls:&nbsp;unknown&nbsp;client&nbsp;certificate&nbsp;key&nbsp;type:&nbsp;%T&#34;</span><span class="op" id="4193026">,</span>&nbsp;<span class="ident" id="4193028">key</span><span class="op" id="4193031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4193035">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193039">if</span>&nbsp;<span class="ident" id="4193042">err</span>&nbsp;<span class="op" id="4193046">!=</span>&nbsp;<span class="ident" id="4193049">nil</span>&nbsp;<span class="op" id="4193053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193058">c</span><span class="op" id="4193059">.</span><span class="ident" id="4193060">sendAlert</span><span class="op" id="4193069">(</span><span class="ident" id="4193070">alertInternalError</span><span class="op" id="4193088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193093">return</span>&nbsp;<span class="ident" id="4193100">errors</span><span class="op" id="4193106">.</span><span class="ident" id="4193107">New</span><span class="op" id="4193110">(</span><span class="string" id="4193111">&#34;tls:&nbsp;failed&nbsp;to&nbsp;sign&nbsp;handshake&nbsp;with&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4193169">+</span>&nbsp;<span class="ident" id="4193171">err</span><span class="op" id="4193174">.</span><span class="ident" id="4193175">Error</span><span class="op" id="4193180">(</span><span class="op" id="4193181">)</span><span class="op" id="4193182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4193186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193190">certVerify</span><span class="op" id="4193200">.</span><span class="ident" id="4193201">signature</span>&nbsp;<span class="op" id="4193211">=</span>&nbsp;<span class="ident" id="4193213">signed</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193223">hs</span><span class="op" id="4193225">.</span><span class="ident" id="4193226">finishedHash</span><span class="op" id="4193238">.</span><span class="ident" id="4193239">Write</span><span class="op" id="4193244">(</span><span class="ident" id="4193245">certVerify</span><span class="op" id="4193255">.</span><span class="ident" id="4193256">marshal</span><span class="op" id="4193263">(</span><span class="op" id="4193264">)</span><span class="op" id="4193265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193269">c</span><span class="op" id="4193270">.</span><span class="ident" id="4193271">writeRecord</span><span class="op" id="4193282">(</span><span class="ident" id="4193283">recordTypeHandshake</span><span class="op" id="4193302">,</span>&nbsp;<span class="ident" id="4193304">certVerify</span><span class="op" id="4193314">.</span><span class="ident" id="4193315">marshal</span><span class="op" id="4193322">(</span><span class="op" id="4193323">)</span><span class="op" id="4193324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4193327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193331">hs</span><span class="op" id="4193333">.</span><span class="ident" id="4193334">masterSecret</span>&nbsp;<span class="op" id="4193347">=</span>&nbsp;<span class="ident" id="4193349">masterFromPreMasterSecret</span><span class="op" id="4193374">(</span><span class="ident" id="4193375">c</span><span class="op" id="4193376">.</span><span class="ident" id="4193377">vers</span><span class="op" id="4193381">,</span>&nbsp;<span class="ident" id="4193383">preMasterSecret</span><span class="op" id="4193398">,</span>&nbsp;<span class="ident" id="4193400">hs</span><span class="op" id="4193402">.</span><span class="ident" id="4193403">hello</span><span class="op" id="4193408">.</span><span class="ident" id="4193409">random</span><span class="op" id="4193415">,</span>&nbsp;<span class="ident" id="4193417">hs</span><span class="op" id="4193419">.</span><span class="ident" id="4193420">serverHello</span><span class="op" id="4193431">.</span><span class="ident" id="4193432">random</span><span class="op" id="4193438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193441">return</span>&nbsp;<span class="ident" id="4193448">nil</span><br>
<span class="lineno"></span><span class="op" id="4193452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4193455">func</span>&nbsp;<span class="op" id="4193460">(</span><span class="ident" id="4193461">hs</span>&nbsp;<span class="op" id="4193464">*</span><span class="ident" id="4193465">clientHandshakeState</span><span class="op" id="4193485">)</span>&nbsp;<span class="ident" id="4193487">establishKeys</span><span class="op" id="4193500">(</span><span class="op" id="4193501">)</span>&nbsp;<span class="builtintype" id="4193503">error</span>&nbsp;<span class="op" id="4193509">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193512">c</span>&nbsp;<span class="op" id="4193514">:=</span>&nbsp;<span class="ident" id="4193517">hs</span><span class="op" id="4193519">.</span><span class="ident" id="4193520">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193524">clientMAC</span><span class="op" id="4193533">,</span>&nbsp;<span class="ident" id="4193535">serverMAC</span><span class="op" id="4193544">,</span>&nbsp;<span class="ident" id="4193546">clientKey</span><span class="op" id="4193555">,</span>&nbsp;<span class="ident" id="4193557">serverKey</span><span class="op" id="4193566">,</span>&nbsp;<span class="ident" id="4193568">clientIV</span><span class="op" id="4193576">,</span>&nbsp;<span class="ident" id="4193578">serverIV</span>&nbsp;<span class="op" id="4193587">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193592">keysFromMasterSecret</span><span class="op" id="4193612">(</span><span class="ident" id="4193613">c</span><span class="op" id="4193614">.</span><span class="ident" id="4193615">vers</span><span class="op" id="4193619">,</span>&nbsp;<span class="ident" id="4193621">hs</span><span class="op" id="4193623">.</span><span class="ident" id="4193624">masterSecret</span><span class="op" id="4193636">,</span>&nbsp;<span class="ident" id="4193638">hs</span><span class="op" id="4193640">.</span><span class="ident" id="4193641">hello</span><span class="op" id="4193646">.</span><span class="ident" id="4193647">random</span><span class="op" id="4193653">,</span>&nbsp;<span class="ident" id="4193655">hs</span><span class="op" id="4193657">.</span><span class="ident" id="4193658">serverHello</span><span class="op" id="4193669">.</span><span class="ident" id="4193670">random</span><span class="op" id="4193676">,</span>&nbsp;<span class="ident" id="4193678">hs</span><span class="op" id="4193680">.</span><span class="ident" id="4193681">suite</span><span class="op" id="4193686">.</span><span class="ident" id="4193687">macLen</span><span class="op" id="4193693">,</span>&nbsp;<span class="ident" id="4193695">hs</span><span class="op" id="4193697">.</span><span class="ident" id="4193698">suite</span><span class="op" id="4193703">.</span><span class="ident" id="4193704">keyLen</span><span class="op" id="4193710">,</span>&nbsp;<span class="ident" id="4193712">hs</span><span class="op" id="4193714">.</span><span class="ident" id="4193715">suite</span><span class="op" id="4193720">.</span><span class="ident" id="4193721">ivLen</span><span class="op" id="4193726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193729">var</span>&nbsp;<span class="ident" id="4193733">clientCipher</span><span class="op" id="4193745">,</span>&nbsp;<span class="ident" id="4193747">serverCipher</span>&nbsp;<span class="keyword" id="4193760">interface</span><span class="op" id="4193769">{</span><span class="op" id="4193770">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193773">var</span>&nbsp;<span class="ident" id="4193777">clientHash</span><span class="op" id="4193787">,</span>&nbsp;<span class="ident" id="4193789">serverHash</span>&nbsp;<span class="ident" id="4193800">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193813">if</span>&nbsp;<span class="ident" id="4193816">hs</span><span class="op" id="4193818">.</span><span class="ident" id="4193819">suite</span><span class="op" id="4193824">.</span><span class="ident" id="4193825">cipher</span>&nbsp;<span class="op" id="4193832">!=</span>&nbsp;<span class="ident" id="4193835">nil</span>&nbsp;<span class="op" id="4193839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193843">clientCipher</span>&nbsp;<span class="op" id="4193856">=</span>&nbsp;<span class="ident" id="4193858">hs</span><span class="op" id="4193860">.</span><span class="ident" id="4193861">suite</span><span class="op" id="4193866">.</span><span class="ident" id="4193867">cipher</span><span class="op" id="4193873">(</span><span class="ident" id="4193874">clientKey</span><span class="op" id="4193883">,</span>&nbsp;<span class="ident" id="4193885">clientIV</span><span class="op" id="4193893">,</span>&nbsp;<span class="builtintype" id="4193895">false</span>&nbsp;<span class="comment" id="4193901">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4193922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193926">clientHash</span>&nbsp;<span class="op" id="4193937">=</span>&nbsp;<span class="ident" id="4193939">hs</span><span class="op" id="4193941">.</span><span class="ident" id="4193942">suite</span><span class="op" id="4193947">.</span><span class="ident" id="4193948">mac</span><span class="op" id="4193951">(</span><span class="ident" id="4193952">c</span><span class="op" id="4193953">.</span><span class="ident" id="4193954">vers</span><span class="op" id="4193958">,</span>&nbsp;<span class="ident" id="4193960">clientMAC</span><span class="op" id="4193969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193973">serverCipher</span>&nbsp;<span class="op" id="4193986">=</span>&nbsp;<span class="ident" id="4193988">hs</span><span class="op" id="4193990">.</span><span class="ident" id="4193991">suite</span><span class="op" id="4193996">.</span><span class="ident" id="4193997">cipher</span><span class="op" id="4194003">(</span><span class="ident" id="4194004">serverKey</span><span class="op" id="4194013">,</span>&nbsp;<span class="ident" id="4194015">serverIV</span><span class="op" id="4194023">,</span>&nbsp;<span class="builtintype" id="4194025">true</span>&nbsp;<span class="comment" id="4194030">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4194047">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4194051">serverHash</span>&nbsp;<span class="op" id="4194062">=</span>&nbsp;<span class="ident" id="4194064">hs</span><span class="op" id="4194066">.</span><span class="ident" id="4194067">suite</span><span class="op" id="4194072">.</span><span class="ident" id="4194073">mac</span><span class="op" id="4194076">(</span><span class="ident" id="4194077">c</span><span class="op" id="4194078">.</span><span class="ident" id="4194079">vers</span><span class="op" id="4194083">,</span>&nbsp;<span class="ident" id="4194085">serverMAC</span><span class="op" id="4194094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4194097">}</span>&nbsp;<span class="keyword" id="4194099">else</span>&nbsp;<span class="op" id="4194104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4194108">clientCipher</span>&nbsp;<span class="op" id="4194121">=</span>&nbsp;<span class="ident" id="4194123">hs</span><span class="op" id="4194125">.</span><span class="ident" id="4194126">suite</span><span class="op" id="4194131">.</span><span class="ident" id="4194132">aead</span><span class="op" id="4194136">(</span><span class="ident" id="4194137">clientKey</span><span class="op" id="4194146">,</span>&nbsp;<span class="ident" id="4194148">clientIV</span><span class="op" id="4194156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4194160">serverCipher</span>&nbsp;<span class="op" id="4194173">=</span>&nbsp;<span class="ident" id="4194175">hs</span><span class="op" id="4194177">.</span><span class="ident" id="4194178">suite</span><span class="op" id="4194183">.</span><span class="ident" id="4194184">aead</span><span class="op" id="4194188">(</span><span class="ident" id="4194189">serverKey</span><span class="op" id="4194198">,</span>&nbsp;<span class="ident" id="4194200">serverIV</span><span class="op" id="4194208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4194211">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4194215">c</span><span class="op" id="4194216">.</span><span class="ident" id="4194217">in</span><span class="op" id="4194219">.</span><span class="ident" id="4194220">prepareCipherSpec</span><span class="op" id="4194237">(</span><span class="ident" id="4194238">c</span><span class="op" id="4194239">.</span><span class="ident" id="4194240">vers</span><span class="op" id="4194244">,</span>&nbsp;<span class="ident" id="4194246">serverCipher</span><span class="op" id="4194258">,</span>&nbsp;<span class="ident" id="4194260">serverHash</span><span class="op" id="4194270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4194273">c</span><span class="op" id="4194274">.</span><span class="ident" id="4194275">out</span><span class="op" id="4194278">.</span><span class="ident" id="4194279">prepareCipherSpec</span><span class="op" id="4194296">(</span><span class="ident" id="4194297">c</span><span class="op" id="4194298">.</span><span class="ident" id="4194299">vers</span><span class="op" id="4194303">,</span>&nbsp;<span class="ident" id="4194305">clientCipher</span><span class="op" id="4194317">,</span>&nbsp;<span class="ident" id="4194319">clientHash</span><span class="op" id="4194329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4194332">return</span>&nbsp;<span class="ident" id="4194339">nil</span><br>
<span class="lineno"></span><span class="op" id="4194343">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="4194346">func</span>&nbsp;<span class="op" id="4194351">(</span><span class="ident" id="4194352">hs</span>&nbsp;<span class="op" id="4194355">*</span><span class="ident" id="4194356">clientHandshakeState</span><span class="op" id="4194376">)</span>&nbsp;<span class="ident" id="4194378">serverResumedSession</span><span class="op" id="4194398">(</span><span class="op" id="4194399">)</span>&nbsp;<span class="builtintype" id="4194401">bool</span>&nbsp;<span class="op" id="4194406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4194409">//&nbsp;If&nbsp;the&nbsp;server&nbsp;responded&nbsp;with&nbsp;the&nbsp;same&nbsp;sessionId&nbsp;then&nbsp;it&nbsp;means&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4194479">//&nbsp;sessionTicket&nbsp;is&nbsp;being&nbsp;used&nbsp;to&nbsp;resume&nbsp;a&nbsp;TLS&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4194536">return</span>&nbsp;<span class="ident" id="4194543">hs</span><span class="op" id="4194545">.</span><span class="ident" id="4194546">session</span>&nbsp;<span class="op" id="4194554">!=</span>&nbsp;<span class="ident" id="4194557">nil</span>&nbsp;<span class="op" id="4194561">&amp;&amp;</span>&nbsp;<span class="ident" id="4194564">hs</span><span class="op" id="4194566">.</span><span class="ident" id="4194567">hello</span><span class="op" id="4194572">.</span><span class="ident" id="4194573">sessionId</span>&nbsp;<span class="op" id="4194583">!=</span>&nbsp;<span class="ident" id="4194586">nil</span>&nbsp;<span class="op" id="4194590">&amp;&amp;</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4194595">bytes</span><span class="op" id="4194600">.</span><span class="ident" id="4194601">Equal</span><span class="op" id="4194606">(</span><span class="ident" id="4194607">hs</span><span class="op" id="4194609">.</span><span class="ident" id="4194610">serverHello</span><span class="op" id="4194621">.</span><span class="ident" id="4194622">sessionId</span><span class="op" id="4194631">,</span>&nbsp;<span class="ident" id="4194633">hs</span><span class="op" id="4194635">.</span><span class="ident" id="4194636">hello</span><span class="op" id="4194641">.</span><span class="ident" id="4194642">sessionId</span><span class="op" id="4194651">)</span><br>
<span class="lineno"></span><span class="op" id="4194653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4194656">func</span>&nbsp;<span class="op" id="4194661">(</span><span class="ident" id="4194662">hs</span>&nbsp;<span class="op" id="4194665">*</span><span class="ident" id="4194666">clientHandshakeState</span><span class="op" id="4194686">)</span>&nbsp;<span class="ident" id="4194688">processServerHello</span><span class="op" id="4194706">(</span><span class="op" id="4194707">)</span>&nbsp;<span class="op" id="4194709">(</span><span class="builtintype" id="4194710">bool</span><span class="op" id="4194714">,</span>&nbsp;<span class="builtintype" id="4194716">error</span><span class="op" id="4194721">)</span>&nbsp;<span class="op" id="4194723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4194726">c</span>&nbsp;<span class="op" id="4194728">:=</span>&nbsp;<span class="ident" id="4194731">hs</span><span class="op" id="4194733">.</span><span class="ident" id="4194734">c</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4194738">if</span>&nbsp;<span class="ident" id="4194741">hs</span><span class="op" id="4194743">.</span><span class="ident" id="4194744">serverHello</span><span class="op" id="4194755">.</span><span class="ident" id="4194756">compressionMethod</span>&nbsp;<span class="op" id="4194774">!=</span>&nbsp;<span class="ident" id="4194777">compressionNone</span>&nbsp;<span class="op" id="4194793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4194797">c</span><span class="op" id="4194798">.</span><span class="ident" id="4194799">sendAlert</span><span class="op" id="4194808">(</span><span class="ident" id="4194809">alertUnexpectedMessage</span><span class="op" id="4194831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4194835">return</span>&nbsp;<span class="builtintype" id="4194842">false</span><span class="op" id="4194847">,</span>&nbsp;<span class="ident" id="4194849">errors</span><span class="op" id="4194855">.</span><span class="ident" id="4194856">New</span><span class="op" id="4194859">(</span><span class="string" id="4194860">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;compression&nbsp;format&#34;</span><span class="op" id="4194913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4194916">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4194920">clientDidNPN</span>&nbsp;<span class="op" id="4194933">:=</span>&nbsp;<span class="ident" id="4194936">hs</span><span class="op" id="4194938">.</span><span class="ident" id="4194939">hello</span><span class="op" id="4194944">.</span><span class="ident" id="4194945">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4194959">clientDidALPN</span>&nbsp;<span class="op" id="4194973">:=</span>&nbsp;<span class="builtinfunc" id="4194976">len</span><span class="op" id="4194979">(</span><span class="ident" id="4194980">hs</span><span class="op" id="4194982">.</span><span class="ident" id="4194983">hello</span><span class="op" id="4194988">.</span><span class="ident" id="4194989">alpnProtocols</span><span class="op" id="4195002">)</span>&nbsp;<span class="op" id="4195004">&gt;</span>&nbsp;<span class="num" id="4195006">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195009">serverHasNPN</span>&nbsp;<span class="op" id="4195022">:=</span>&nbsp;<span class="ident" id="4195025">hs</span><span class="op" id="4195027">.</span><span class="ident" id="4195028">serverHello</span><span class="op" id="4195039">.</span><span class="ident" id="4195040">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195054">serverHasALPN</span>&nbsp;<span class="op" id="4195068">:=</span>&nbsp;<span class="builtinfunc" id="4195071">len</span><span class="op" id="4195074">(</span><span class="ident" id="4195075">hs</span><span class="op" id="4195077">.</span><span class="ident" id="4195078">serverHello</span><span class="op" id="4195089">.</span><span class="ident" id="4195090">alpnProtocol</span><span class="op" id="4195102">)</span>&nbsp;<span class="op" id="4195104">&gt;</span>&nbsp;<span class="num" id="4195106">0</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195110">if</span>&nbsp;<span class="op" id="4195113">!</span><span class="ident" id="4195114">clientDidNPN</span>&nbsp;<span class="op" id="4195127">&amp;&amp;</span>&nbsp;<span class="ident" id="4195130">serverHasNPN</span>&nbsp;<span class="op" id="4195143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195147">c</span><span class="op" id="4195148">.</span><span class="ident" id="4195149">sendAlert</span><span class="op" id="4195158">(</span><span class="ident" id="4195159">alertHandshakeFailure</span><span class="op" id="4195180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195184">return</span>&nbsp;<span class="builtintype" id="4195191">false</span><span class="op" id="4195196">,</span>&nbsp;<span class="ident" id="4195198">errors</span><span class="op" id="4195204">.</span><span class="ident" id="4195205">New</span><span class="op" id="4195208">(</span><span class="string" id="4195209">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;NPN&nbsp;extension&#34;</span><span class="op" id="4195254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4195257">}</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195261">if</span>&nbsp;<span class="op" id="4195264">!</span><span class="ident" id="4195265">clientDidALPN</span>&nbsp;<span class="op" id="4195279">&amp;&amp;</span>&nbsp;<span class="ident" id="4195282">serverHasALPN</span>&nbsp;<span class="op" id="4195296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195300">c</span><span class="op" id="4195301">.</span><span class="ident" id="4195302">sendAlert</span><span class="op" id="4195311">(</span><span class="ident" id="4195312">alertHandshakeFailure</span><span class="op" id="4195333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195337">return</span>&nbsp;<span class="builtintype" id="4195344">false</span><span class="op" id="4195349">,</span>&nbsp;<span class="ident" id="4195351">errors</span><span class="op" id="4195357">.</span><span class="ident" id="4195358">New</span><span class="op" id="4195361">(</span><span class="string" id="4195362">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;ALPN&nbsp;extension&#34;</span><span class="op" id="4195408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4195411">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195415">if</span>&nbsp;<span class="ident" id="4195418">serverHasNPN</span>&nbsp;<span class="op" id="4195431">&amp;&amp;</span>&nbsp;<span class="ident" id="4195434">serverHasALPN</span>&nbsp;<span class="op" id="4195448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195452">c</span><span class="op" id="4195453">.</span><span class="ident" id="4195454">sendAlert</span><span class="op" id="4195463">(</span><span class="ident" id="4195464">alertHandshakeFailure</span><span class="op" id="4195485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195489">return</span>&nbsp;<span class="builtintype" id="4195496">false</span><span class="op" id="4195501">,</span>&nbsp;<span class="ident" id="4195503">errors</span><span class="op" id="4195509">.</span><span class="ident" id="4195510">New</span><span class="op" id="4195513">(</span><span class="string" id="4195514">&#34;server&nbsp;advertised&nbsp;both&nbsp;NPN&nbsp;and&nbsp;ALPN&nbsp;extensions&#34;</span><span class="op" id="4195562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4195565">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195569">if</span>&nbsp;<span class="ident" id="4195572">serverHasALPN</span>&nbsp;<span class="op" id="4195586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195590">c</span><span class="op" id="4195591">.</span><span class="ident" id="4195592">clientProtocol</span>&nbsp;<span class="op" id="4195607">=</span>&nbsp;<span class="ident" id="4195609">hs</span><span class="op" id="4195611">.</span><span class="ident" id="4195612">serverHello</span><span class="op" id="4195623">.</span><span class="ident" id="4195624">alpnProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195639">c</span><span class="op" id="4195640">.</span><span class="ident" id="4195641">clientProtocolFallback</span>&nbsp;<span class="op" id="4195664">=</span>&nbsp;<span class="builtintype" id="4195666">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4195673">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195677">if</span>&nbsp;<span class="ident" id="4195680">hs</span><span class="op" id="4195682">.</span><span class="ident" id="4195683">serverResumedSession</span><span class="op" id="4195703">(</span><span class="op" id="4195704">)</span>&nbsp;<span class="op" id="4195706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4195710">//&nbsp;Restore&nbsp;masterSecret&nbsp;and&nbsp;peerCerts&nbsp;from&nbsp;previous&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195770">hs</span><span class="op" id="4195772">.</span><span class="ident" id="4195773">masterSecret</span>&nbsp;<span class="op" id="4195786">=</span>&nbsp;<span class="ident" id="4195788">hs</span><span class="op" id="4195790">.</span><span class="ident" id="4195791">session</span><span class="op" id="4195798">.</span><span class="ident" id="4195799">masterSecret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195814">c</span><span class="op" id="4195815">.</span><span class="ident" id="4195816">peerCertificates</span>&nbsp;<span class="op" id="4195833">=</span>&nbsp;<span class="ident" id="4195835">hs</span><span class="op" id="4195837">.</span><span class="ident" id="4195838">session</span><span class="op" id="4195845">.</span><span class="ident" id="4195846">serverCertificates</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195867">return</span>&nbsp;<span class="builtintype" id="4195874">true</span><span class="op" id="4195878">,</span>&nbsp;<span class="ident" id="4195880">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4195885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195888">return</span>&nbsp;<span class="builtintype" id="4195895">false</span><span class="op" id="4195900">,</span>&nbsp;<span class="ident" id="4195902">nil</span><br>
<span class="lineno"></span><span class="op" id="4195906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="4195909">func</span>&nbsp;<span class="op" id="4195914">(</span><span class="ident" id="4195915">hs</span>&nbsp;<span class="op" id="4195918">*</span><span class="ident" id="4195919">clientHandshakeState</span><span class="op" id="4195939">)</span>&nbsp;<span class="ident" id="4195941">readFinished</span><span class="op" id="4195953">(</span><span class="ident" id="4195954">out</span>&nbsp;<span class="op" id="4195958">[</span><span class="op" id="4195959">]</span><span class="builtintype" id="4195960">byte</span><span class="op" id="4195964">)</span>&nbsp;<span class="builtintype" id="4195966">error</span>&nbsp;<span class="op" id="4195972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195975">c</span>&nbsp;<span class="op" id="4195977">:=</span>&nbsp;<span class="ident" id="4195980">hs</span><span class="op" id="4195982">.</span><span class="ident" id="4195983">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195987">c</span><span class="op" id="4195988">.</span><span class="ident" id="4195989">readRecord</span><span class="op" id="4195999">(</span><span class="ident" id="4196000">recordTypeChangeCipherSpec</span><span class="op" id="4196026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196029">if</span>&nbsp;<span class="ident" id="4196032">err</span>&nbsp;<span class="op" id="4196036">:=</span>&nbsp;<span class="ident" id="4196039">c</span><span class="op" id="4196040">.</span><span class="ident" id="4196041">in</span><span class="op" id="4196043">.</span><span class="builtintype" id="4196044">error</span><span class="op" id="4196049">(</span><span class="op" id="4196050">)</span><span class="op" id="4196051">;</span>&nbsp;<span class="ident" id="4196053">err</span>&nbsp;<span class="op" id="4196057">!=</span>&nbsp;<span class="ident" id="4196060">nil</span>&nbsp;<span class="op" id="4196064">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196068">return</span>&nbsp;<span class="ident" id="4196075">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4196080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196084">msg</span><span class="op" id="4196087">,</span>&nbsp;<span class="ident" id="4196089">err</span>&nbsp;<span class="op" id="4196093">:=</span>&nbsp;<span class="ident" id="4196096">c</span><span class="op" id="4196097">.</span><span class="ident" id="4196098">readHandshake</span><span class="op" id="4196111">(</span><span class="op" id="4196112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196115">if</span>&nbsp;<span class="ident" id="4196118">err</span>&nbsp;<span class="op" id="4196122">!=</span>&nbsp;<span class="ident" id="4196125">nil</span>&nbsp;<span class="op" id="4196129">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196133">return</span>&nbsp;<span class="ident" id="4196140">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4196145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196148">serverFinished</span><span class="op" id="4196162">,</span>&nbsp;<span class="ident" id="4196164">ok</span>&nbsp;<span class="op" id="4196167">:=</span>&nbsp;<span class="ident" id="4196170">msg</span><span class="op" id="4196173">.</span><span class="op" id="4196174">(</span><span class="op" id="4196175">*</span><span class="ident" id="4196176">finishedMsg</span><span class="op" id="4196187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196190">if</span>&nbsp;<span class="op" id="4196193">!</span><span class="ident" id="4196194">ok</span>&nbsp;<span class="op" id="4196197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196201">c</span><span class="op" id="4196202">.</span><span class="ident" id="4196203">sendAlert</span><span class="op" id="4196212">(</span><span class="ident" id="4196213">alertUnexpectedMessage</span><span class="op" id="4196235">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196239">return</span>&nbsp;<span class="ident" id="4196246">unexpectedMessageError</span><span class="op" id="4196268">(</span><span class="ident" id="4196269">serverFinished</span><span class="op" id="4196283">,</span>&nbsp;<span class="ident" id="4196285">msg</span><span class="op" id="4196288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4196291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196295">verify</span>&nbsp;<span class="op" id="4196302">:=</span>&nbsp;<span class="ident" id="4196305">hs</span><span class="op" id="4196307">.</span><span class="ident" id="4196308">finishedHash</span><span class="op" id="4196320">.</span><span class="ident" id="4196321">serverSum</span><span class="op" id="4196330">(</span><span class="ident" id="4196331">hs</span><span class="op" id="4196333">.</span><span class="ident" id="4196334">masterSecret</span><span class="op" id="4196346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196349">if</span>&nbsp;<span class="builtinfunc" id="4196352">len</span><span class="op" id="4196355">(</span><span class="ident" id="4196356">verify</span><span class="op" id="4196362">)</span>&nbsp;<span class="op" id="4196364">!=</span>&nbsp;<span class="builtinfunc" id="4196367">len</span><span class="op" id="4196370">(</span><span class="ident" id="4196371">serverFinished</span><span class="op" id="4196385">.</span><span class="ident" id="4196386">verifyData</span><span class="op" id="4196396">)</span>&nbsp;<span class="op" id="4196398">||</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196403">subtle</span><span class="op" id="4196409">.</span><span class="ident" id="4196410">ConstantTimeCompare</span><span class="op" id="4196429">(</span><span class="ident" id="4196430">verify</span><span class="op" id="4196436">,</span>&nbsp;<span class="ident" id="4196438">serverFinished</span><span class="op" id="4196452">.</span><span class="ident" id="4196453">verifyData</span><span class="op" id="4196463">)</span>&nbsp;<span class="op" id="4196465">!=</span>&nbsp;<span class="num" id="4196468">1</span>&nbsp;<span class="op" id="4196470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196474">c</span><span class="op" id="4196475">.</span><span class="ident" id="4196476">sendAlert</span><span class="op" id="4196485">(</span><span class="ident" id="4196486">alertHandshakeFailure</span><span class="op" id="4196507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196511">return</span>&nbsp;<span class="ident" id="4196518">errors</span><span class="op" id="4196524">.</span><span class="ident" id="4196525">New</span><span class="op" id="4196528">(</span><span class="string" id="4196529">&#34;tls:&nbsp;server&#39;s&nbsp;Finished&nbsp;message&nbsp;was&nbsp;incorrect&#34;</span><span class="op" id="4196575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4196578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196581">hs</span><span class="op" id="4196583">.</span><span class="ident" id="4196584">finishedHash</span><span class="op" id="4196596">.</span><span class="ident" id="4196597">Write</span><span class="op" id="4196602">(</span><span class="ident" id="4196603">serverFinished</span><span class="op" id="4196617">.</span><span class="ident" id="4196618">marshal</span><span class="op" id="4196625">(</span><span class="op" id="4196626">)</span><span class="op" id="4196627">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4196630">copy</span><span class="op" id="4196634">(</span><span class="ident" id="4196635">out</span><span class="op" id="4196638">,</span>&nbsp;<span class="ident" id="4196640">verify</span><span class="op" id="4196646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196649">return</span>&nbsp;<span class="ident" id="4196656">nil</span><br>
<span class="lineno"></span><span class="op" id="4196660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4196663">func</span>&nbsp;<span class="op" id="4196668">(</span><span class="ident" id="4196669">hs</span>&nbsp;<span class="op" id="4196672">*</span><span class="ident" id="4196673">clientHandshakeState</span><span class="op" id="4196693">)</span>&nbsp;<span class="ident" id="4196695">readSessionTicket</span><span class="op" id="4196712">(</span><span class="op" id="4196713">)</span>&nbsp;<span class="builtintype" id="4196715">error</span>&nbsp;<span class="op" id="4196721">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196724">if</span>&nbsp;<span class="op" id="4196727">!</span><span class="ident" id="4196728">hs</span><span class="op" id="4196730">.</span><span class="ident" id="4196731">serverHello</span><span class="op" id="4196742">.</span><span class="ident" id="4196743">ticketSupported</span>&nbsp;<span class="op" id="4196759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196763">return</span>&nbsp;<span class="ident" id="4196770">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4196775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196779">c</span>&nbsp;<span class="op" id="4196781">:=</span>&nbsp;<span class="ident" id="4196784">hs</span><span class="op" id="4196786">.</span><span class="ident" id="4196787">c</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196790">msg</span><span class="op" id="4196793">,</span>&nbsp;<span class="ident" id="4196795">err</span>&nbsp;<span class="op" id="4196799">:=</span>&nbsp;<span class="ident" id="4196802">c</span><span class="op" id="4196803">.</span><span class="ident" id="4196804">readHandshake</span><span class="op" id="4196817">(</span><span class="op" id="4196818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196821">if</span>&nbsp;<span class="ident" id="4196824">err</span>&nbsp;<span class="op" id="4196828">!=</span>&nbsp;<span class="ident" id="4196831">nil</span>&nbsp;<span class="op" id="4196835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196839">return</span>&nbsp;<span class="ident" id="4196846">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4196851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196854">sessionTicketMsg</span><span class="op" id="4196870">,</span>&nbsp;<span class="ident" id="4196872">ok</span>&nbsp;<span class="op" id="4196875">:=</span>&nbsp;<span class="ident" id="4196878">msg</span><span class="op" id="4196881">.</span><span class="op" id="4196882">(</span><span class="op" id="4196883">*</span><span class="ident" id="4196884">newSessionTicketMsg</span><span class="op" id="4196903">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196906">if</span>&nbsp;<span class="op" id="4196909">!</span><span class="ident" id="4196910">ok</span>&nbsp;<span class="op" id="4196913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196917">c</span><span class="op" id="4196918">.</span><span class="ident" id="4196919">sendAlert</span><span class="op" id="4196928">(</span><span class="ident" id="4196929">alertUnexpectedMessage</span><span class="op" id="4196951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196955">return</span>&nbsp;<span class="ident" id="4196962">unexpectedMessageError</span><span class="op" id="4196984">(</span><span class="ident" id="4196985">sessionTicketMsg</span><span class="op" id="4197001">,</span>&nbsp;<span class="ident" id="4197003">msg</span><span class="op" id="4197006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4197009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197012">hs</span><span class="op" id="4197014">.</span><span class="ident" id="4197015">finishedHash</span><span class="op" id="4197027">.</span><span class="ident" id="4197028">Write</span><span class="op" id="4197033">(</span><span class="ident" id="4197034">sessionTicketMsg</span><span class="op" id="4197050">.</span><span class="ident" id="4197051">marshal</span><span class="op" id="4197058">(</span><span class="op" id="4197059">)</span><span class="op" id="4197060">)</span><br>
<span class="lineno">580</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197064">hs</span><span class="op" id="4197066">.</span><span class="ident" id="4197067">session</span>&nbsp;<span class="op" id="4197075">=</span>&nbsp;<span class="op" id="4197077">&amp;</span><span class="ident" id="4197078">ClientSessionState</span><span class="op" id="4197096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197100">sessionTicket</span><span class="op" id="4197113">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4197120">sessionTicketMsg</span><span class="op" id="4197136">.</span><span class="ident" id="4197137">ticket</span><span class="op" id="4197143">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197147">vers</span><span class="op" id="4197151">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4197167">c</span><span class="op" id="4197168">.</span><span class="ident" id="4197169">vers</span><span class="op" id="4197173">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197177">cipherSuite</span><span class="op" id="4197188">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4197197">hs</span><span class="op" id="4197199">.</span><span class="ident" id="4197200">suite</span><span class="op" id="4197205">.</span><span class="ident" id="4197206">id</span><span class="op" id="4197208">,</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197212">masterSecret</span><span class="op" id="4197224">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4197232">hs</span><span class="op" id="4197234">.</span><span class="ident" id="4197235">masterSecret</span><span class="op" id="4197247">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197251">serverCertificates</span><span class="op" id="4197269">:</span>&nbsp;<span class="ident" id="4197271">c</span><span class="op" id="4197272">.</span><span class="ident" id="4197273">peerCertificates</span><span class="op" id="4197289">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4197292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197296">return</span>&nbsp;<span class="ident" id="4197303">nil</span><br>
<span class="lineno">590</span><span class="op" id="4197307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4197310">func</span>&nbsp;<span class="op" id="4197315">(</span><span class="ident" id="4197316">hs</span>&nbsp;<span class="op" id="4197319">*</span><span class="ident" id="4197320">clientHandshakeState</span><span class="op" id="4197340">)</span>&nbsp;<span class="ident" id="4197342">sendFinished</span><span class="op" id="4197354">(</span><span class="ident" id="4197355">out</span>&nbsp;<span class="op" id="4197359">[</span><span class="op" id="4197360">]</span><span class="builtintype" id="4197361">byte</span><span class="op" id="4197365">)</span>&nbsp;<span class="builtintype" id="4197367">error</span>&nbsp;<span class="op" id="4197373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197376">c</span>&nbsp;<span class="op" id="4197378">:=</span>&nbsp;<span class="ident" id="4197381">hs</span><span class="op" id="4197383">.</span><span class="ident" id="4197384">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197388">c</span><span class="op" id="4197389">.</span><span class="ident" id="4197390">writeRecord</span><span class="op" id="4197401">(</span><span class="ident" id="4197402">recordTypeChangeCipherSpec</span><span class="op" id="4197428">,</span>&nbsp;<span class="op" id="4197430">[</span><span class="op" id="4197431">]</span><span class="builtintype" id="4197432">byte</span><span class="op" id="4197436">{</span><span class="num" id="4197437">1</span><span class="op" id="4197438">}</span><span class="op" id="4197439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197442">if</span>&nbsp;<span class="ident" id="4197445">hs</span><span class="op" id="4197447">.</span><span class="ident" id="4197448">serverHello</span><span class="op" id="4197459">.</span><span class="ident" id="4197460">nextProtoNeg</span>&nbsp;<span class="op" id="4197473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197477">nextProto</span>&nbsp;<span class="op" id="4197487">:=</span>&nbsp;<span class="builtinfunc" id="4197490">new</span><span class="op" id="4197493">(</span><span class="ident" id="4197494">nextProtoMsg</span><span class="op" id="4197506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197510">proto</span><span class="op" id="4197515">,</span>&nbsp;<span class="ident" id="4197517">fallback</span>&nbsp;<span class="op" id="4197526">:=</span>&nbsp;<span class="ident" id="4197529">mutualProtocol</span><span class="op" id="4197543">(</span><span class="ident" id="4197544">c</span><span class="op" id="4197545">.</span><span class="ident" id="4197546">config</span><span class="op" id="4197552">.</span><span class="ident" id="4197553">NextProtos</span><span class="op" id="4197563">,</span>&nbsp;<span class="ident" id="4197565">hs</span><span class="op" id="4197567">.</span><span class="ident" id="4197568">serverHello</span><span class="op" id="4197579">.</span><span class="ident" id="4197580">nextProtos</span><span class="op" id="4197590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197594">nextProto</span><span class="op" id="4197603">.</span><span class="ident" id="4197604">proto</span>&nbsp;<span class="op" id="4197610">=</span>&nbsp;<span class="ident" id="4197612">proto</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197620">c</span><span class="op" id="4197621">.</span><span class="ident" id="4197622">clientProtocol</span>&nbsp;<span class="op" id="4197637">=</span>&nbsp;<span class="ident" id="4197639">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197647">c</span><span class="op" id="4197648">.</span><span class="ident" id="4197649">clientProtocolFallback</span>&nbsp;<span class="op" id="4197672">=</span>&nbsp;<span class="ident" id="4197674">fallback</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197686">hs</span><span class="op" id="4197688">.</span><span class="ident" id="4197689">finishedHash</span><span class="op" id="4197701">.</span><span class="ident" id="4197702">Write</span><span class="op" id="4197707">(</span><span class="ident" id="4197708">nextProto</span><span class="op" id="4197717">.</span><span class="ident" id="4197718">marshal</span><span class="op" id="4197725">(</span><span class="op" id="4197726">)</span><span class="op" id="4197727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197731">c</span><span class="op" id="4197732">.</span><span class="ident" id="4197733">writeRecord</span><span class="op" id="4197744">(</span><span class="ident" id="4197745">recordTypeHandshake</span><span class="op" id="4197764">,</span>&nbsp;<span class="ident" id="4197766">nextProto</span><span class="op" id="4197775">.</span><span class="ident" id="4197776">marshal</span><span class="op" id="4197783">(</span><span class="op" id="4197784">)</span><span class="op" id="4197785">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4197788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197792">finished</span>&nbsp;<span class="op" id="4197801">:=</span>&nbsp;<span class="builtinfunc" id="4197804">new</span><span class="op" id="4197807">(</span><span class="ident" id="4197808">finishedMsg</span><span class="op" id="4197819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197822">finished</span><span class="op" id="4197830">.</span><span class="ident" id="4197831">verifyData</span>&nbsp;<span class="op" id="4197842">=</span>&nbsp;<span class="ident" id="4197844">hs</span><span class="op" id="4197846">.</span><span class="ident" id="4197847">finishedHash</span><span class="op" id="4197859">.</span><span class="ident" id="4197860">clientSum</span><span class="op" id="4197869">(</span><span class="ident" id="4197870">hs</span><span class="op" id="4197872">.</span><span class="ident" id="4197873">masterSecret</span><span class="op" id="4197885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197888">hs</span><span class="op" id="4197890">.</span><span class="ident" id="4197891">finishedHash</span><span class="op" id="4197903">.</span><span class="ident" id="4197904">Write</span><span class="op" id="4197909">(</span><span class="ident" id="4197910">finished</span><span class="op" id="4197918">.</span><span class="ident" id="4197919">marshal</span><span class="op" id="4197926">(</span><span class="op" id="4197927">)</span><span class="op" id="4197928">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197931">c</span><span class="op" id="4197932">.</span><span class="ident" id="4197933">writeRecord</span><span class="op" id="4197944">(</span><span class="ident" id="4197945">recordTypeHandshake</span><span class="op" id="4197964">,</span>&nbsp;<span class="ident" id="4197966">finished</span><span class="op" id="4197974">.</span><span class="ident" id="4197975">marshal</span><span class="op" id="4197982">(</span><span class="op" id="4197983">)</span><span class="op" id="4197984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4197987">copy</span><span class="op" id="4197991">(</span><span class="ident" id="4197992">out</span><span class="op" id="4197995">,</span>&nbsp;<span class="ident" id="4197997">finished</span><span class="op" id="4198005">.</span><span class="ident" id="4198006">verifyData</span><span class="op" id="4198016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4198019">return</span>&nbsp;<span class="ident" id="4198026">nil</span><br>
<span class="lineno"></span><span class="op" id="4198030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="comment" id="4198033">//&nbsp;clientSessionCacheKey&nbsp;returns&nbsp;a&nbsp;key&nbsp;used&nbsp;to&nbsp;cache&nbsp;sessionTickets&nbsp;that&nbsp;could</span><br>
<span class="lineno"></span><span class="comment" id="4198112">//&nbsp;be&nbsp;used&nbsp;to&nbsp;resume&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;sessions&nbsp;with&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="4198183">func</span>&nbsp;<span class="ident" id="4198188">clientSessionCacheKey</span><span class="op" id="4198209">(</span><span class="ident" id="4198210">serverAddr</span>&nbsp;<span class="ident" id="4198221">net</span><span class="op" id="4198224">.</span><span class="ident" id="4198225">Addr</span><span class="op" id="4198229">,</span>&nbsp;<span class="ident" id="4198231">config</span>&nbsp;<span class="op" id="4198238">*</span><span class="ident" id="4198239">Config</span><span class="op" id="4198245">)</span>&nbsp;<span class="builtintype" id="4198247">string</span>&nbsp;<span class="op" id="4198254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4198257">if</span>&nbsp;<span class="builtinfunc" id="4198260">len</span><span class="op" id="4198263">(</span><span class="ident" id="4198264">config</span><span class="op" id="4198270">.</span><span class="ident" id="4198271">ServerName</span><span class="op" id="4198281">)</span>&nbsp;<span class="op" id="4198283">&gt;</span>&nbsp;<span class="num" id="4198285">0</span>&nbsp;<span class="op" id="4198287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4198291">return</span>&nbsp;<span class="ident" id="4198298">config</span><span class="op" id="4198304">.</span><span class="ident" id="4198305">ServerName</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4198317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4198320">return</span>&nbsp;<span class="ident" id="4198327">serverAddr</span><span class="op" id="4198337">.</span><span class="ident" id="4198338">String</span><span class="op" id="4198344">(</span><span class="op" id="4198345">)</span><br>
<span class="lineno"></span><span class="op" id="4198347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4198350">//&nbsp;mutualProtocol&nbsp;finds&nbsp;the&nbsp;mutual&nbsp;Next&nbsp;Protocol&nbsp;Negotiation&nbsp;or&nbsp;ALPN&nbsp;protocol</span><br>
<span class="lineno">625</span><span class="comment" id="4198428">//&nbsp;given&nbsp;list&nbsp;of&nbsp;possible&nbsp;protocols&nbsp;and&nbsp;a&nbsp;list&nbsp;of&nbsp;the&nbsp;preference&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="4198504">//&nbsp;first&nbsp;list&nbsp;must&nbsp;not&nbsp;be&nbsp;empty.&nbsp;It&nbsp;returns&nbsp;the&nbsp;resulting&nbsp;protocol&nbsp;and&nbsp;flag</span><br>
<span class="lineno"></span><span class="comment" id="4198580">//&nbsp;indicating&nbsp;if&nbsp;the&nbsp;fallback&nbsp;case&nbsp;was&nbsp;reached.</span><br>
<span class="lineno"></span><span class="keyword" id="4198628">func</span>&nbsp;<span class="ident" id="4198633">mutualProtocol</span><span class="op" id="4198647">(</span><span class="ident" id="4198648">protos</span><span class="op" id="4198654">,</span>&nbsp;<span class="ident" id="4198656">preferenceProtos</span>&nbsp;<span class="op" id="4198673">[</span><span class="op" id="4198674">]</span><span class="builtintype" id="4198675">string</span><span class="op" id="4198681">)</span>&nbsp;<span class="op" id="4198683">(</span><span class="builtintype" id="4198684">string</span><span class="op" id="4198690">,</span>&nbsp;<span class="builtintype" id="4198692">bool</span><span class="op" id="4198696">)</span>&nbsp;<span class="op" id="4198698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4198701">for</span>&nbsp;<span class="ident" id="4198705">_</span><span class="op" id="4198706">,</span>&nbsp;<span class="ident" id="4198708">s</span>&nbsp;<span class="op" id="4198710">:=</span>&nbsp;<span class="keyword" id="4198713">range</span>&nbsp;<span class="ident" id="4198719">preferenceProtos</span>&nbsp;<span class="op" id="4198736">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4198740">for</span>&nbsp;<span class="ident" id="4198744">_</span><span class="op" id="4198745">,</span>&nbsp;<span class="ident" id="4198747">c</span>&nbsp;<span class="op" id="4198749">:=</span>&nbsp;<span class="keyword" id="4198752">range</span>&nbsp;<span class="ident" id="4198758">protos</span>&nbsp;<span class="op" id="4198765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4198770">if</span>&nbsp;<span class="ident" id="4198773">s</span>&nbsp;<span class="op" id="4198775">==</span>&nbsp;<span class="ident" id="4198778">c</span>&nbsp;<span class="op" id="4198780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4198786">return</span>&nbsp;<span class="ident" id="4198793">s</span><span class="op" id="4198794">,</span>&nbsp;<span class="builtintype" id="4198796">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4198805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4198809">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4198812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4198816">return</span>&nbsp;<span class="ident" id="4198823">protos</span><span class="op" id="4198829">[</span><span class="num" id="4198830">0</span><span class="op" id="4198831">]</span><span class="op" id="4198832">,</span>&nbsp;<span class="builtintype" id="4198834">true</span><br>
<span class="lineno"></span><span class="op" id="4198839">}</span>
</div>
</body>
</html>
