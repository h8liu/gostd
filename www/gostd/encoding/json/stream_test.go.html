<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/json</h2>
<ul>
<li><a href="/gostd/encoding/json/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/encoding/json/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/json/decode_test.go.html">decode_test.go</a></li>
<li><a href="/gostd/encoding/json/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/json/encode_test.go.html">encode_test.go</a></li>
<li><a href="/gostd/encoding/json/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/json/fold.go.html">fold.go</a></li>
<li><a href="/gostd/encoding/json/fold_test.go.html">fold_test.go</a></li>
<li><a href="/gostd/encoding/json/indent.go.html">indent.go</a></li>
<li><a href="/gostd/encoding/json/scanner.go.html">scanner.go</a></li>
<li><a href="/gostd/encoding/json/scanner_test.go.html">scanner_test.go</a></li>
<li><a href="/gostd/encoding/json/stream.go.html">stream.go</a></li>
<li><a href="/gostd/encoding/json/stream_test.go.html">stream_test.go</a></li>
<li><a href="/gostd/encoding/json/tagkey_test.go.html">tagkey_test.go</a></li>
<li><a href="/gostd/encoding/json/tags.go.html">tags.go</a></li>
<li><a href="/gostd/encoding/json/tags_test.go.html">tags_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8204685">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8204741">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8204795">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8204846">package</span>&nbsp;<span class="ident" id="8204854">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8204860">import</span>&nbsp;<span class="op" id="8204867">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8204870">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8204879">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8204892">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8204899">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8204910">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8204921">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="8204931">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="8204934">//&nbsp;Test&nbsp;values&nbsp;for&nbsp;the&nbsp;stream&nbsp;test.</span><br>
<span class="lineno"></span><span class="comment" id="8204970">//&nbsp;One&nbsp;of&nbsp;each&nbsp;JSON&nbsp;kind.</span><br>
<span class="lineno"></span><span class="keyword" id="8204996">var</span>&nbsp;<span class="ident" id="8205000">streamTest</span>&nbsp;<span class="op" id="8205011">=</span>&nbsp;<span class="op" id="8205013">[</span><span class="op" id="8205014">]</span><span class="keyword" id="8205015">interface</span><span class="op" id="8205024">{</span><span class="op" id="8205025">}</span><span class="op" id="8205026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="8205029">0.1</span><span class="op" id="8205032">,</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8205035">&#34;hello&#34;</span><span class="op" id="8205042">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205045">nil</span><span class="op" id="8205048">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="8205051">true</span><span class="op" id="8205055">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="8205058">false</span><span class="op" id="8205063">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8205066">[</span><span class="op" id="8205067">]</span><span class="keyword" id="8205068">interface</span><span class="op" id="8205077">{</span><span class="op" id="8205078">}</span><span class="op" id="8205079">{</span><span class="string" id="8205080">&#34;a&#34;</span><span class="op" id="8205083">,</span>&nbsp;<span class="string" id="8205085">&#34;b&#34;</span><span class="op" id="8205088">,</span>&nbsp;<span class="string" id="8205090">&#34;c&#34;</span><span class="op" id="8205093">}</span><span class="op" id="8205094">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205097">map</span><span class="op" id="8205100">[</span><span class="builtintype" id="8205101">string</span><span class="op" id="8205107">]</span><span class="keyword" id="8205108">interface</span><span class="op" id="8205117">{</span><span class="op" id="8205118">}</span><span class="op" id="8205119">{</span><span class="string" id="8205120">&#34;K&#34;</span><span class="op" id="8205125">:</span>&nbsp;<span class="string" id="8205127">&#34;Kelvin&#34;</span><span class="op" id="8205135">,</span>&nbsp;<span class="string" id="8205137">&#34;ß&#34;</span><span class="op" id="8205141">:</span>&nbsp;<span class="string" id="8205143">&#34;long&nbsp;s&#34;</span><span class="op" id="8205151">}</span><span class="op" id="8205152">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="8205155">3.14</span><span class="op" id="8205159">,</span>&nbsp;<span class="comment" id="8205161">//&nbsp;another&nbsp;value&nbsp;to&nbsp;make&nbsp;sure&nbsp;something&nbsp;can&nbsp;follow&nbsp;map</span><br>
<span class="lineno"></span><span class="op" id="8205216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8205219">var</span>&nbsp;<span class="ident" id="8205223">streamEncoded</span>&nbsp;<span class="op" id="8205237">=</span>&nbsp;<span class="string" id="8205239">`0.1<br>
<span class="lineno">30</span>&#34;hello&#34;<br>
<span class="lineno"></span>null<br>
<span class="lineno"></span>true<br>
<span class="lineno"></span>false<br>
<span class="lineno"></span>[&#34;a&#34;,&#34;b&#34;,&#34;c&#34;]<br>
<span class="lineno">35</span>{&#34;ß&#34;:&#34;long&nbsp;s&#34;,&#34;K&#34;:&#34;Kelvin&#34;}<br>
<span class="lineno"></span>3.14<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8205321">func</span>&nbsp;<span class="ident" id="8205326">TestEncoder</span><span class="op" id="8205337">(</span><span class="ident" id="8205338">t</span>&nbsp;<span class="op" id="8205340">*</span><span class="ident" id="8205341">testing</span><span class="op" id="8205348">.</span><span class="ident" id="8205349">T</span><span class="op" id="8205350">)</span>&nbsp;<span class="op" id="8205352">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205355">for</span>&nbsp;<span class="ident" id="8205359">i</span>&nbsp;<span class="op" id="8205361">:=</span>&nbsp;<span class="num" id="8205364">0</span><span class="op" id="8205365">;</span>&nbsp;<span class="ident" id="8205367">i</span>&nbsp;<span class="op" id="8205369">&lt;=</span>&nbsp;<span class="builtinfunc" id="8205372">len</span><span class="op" id="8205375">(</span><span class="ident" id="8205376">streamTest</span><span class="op" id="8205386">)</span><span class="op" id="8205387">;</span>&nbsp;<span class="ident" id="8205389">i</span><span class="op" id="8205390">++</span>&nbsp;<span class="op" id="8205393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205397">var</span>&nbsp;<span class="ident" id="8205401">buf</span>&nbsp;<span class="ident" id="8205405">bytes</span><span class="op" id="8205410">.</span><span class="ident" id="8205411">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205420">enc</span>&nbsp;<span class="op" id="8205424">:=</span>&nbsp;<span class="ident" id="8205427">NewEncoder</span><span class="op" id="8205437">(</span><span class="op" id="8205438">&amp;</span><span class="ident" id="8205439">buf</span><span class="op" id="8205442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205446">for</span>&nbsp;<span class="ident" id="8205450">j</span><span class="op" id="8205451">,</span>&nbsp;<span class="ident" id="8205453">v</span>&nbsp;<span class="op" id="8205455">:=</span>&nbsp;<span class="keyword" id="8205458">range</span>&nbsp;<span class="ident" id="8205464">streamTest</span><span class="op" id="8205474">[</span><span class="num" id="8205475">0</span><span class="op" id="8205476">:</span><span class="ident" id="8205477">i</span><span class="op" id="8205478">]</span>&nbsp;<span class="op" id="8205480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205485">if</span>&nbsp;<span class="ident" id="8205488">err</span>&nbsp;<span class="op" id="8205492">:=</span>&nbsp;<span class="ident" id="8205495">enc</span><span class="op" id="8205498">.</span><span class="ident" id="8205499">Encode</span><span class="op" id="8205505">(</span><span class="ident" id="8205506">v</span><span class="op" id="8205507">)</span><span class="op" id="8205508">;</span>&nbsp;<span class="ident" id="8205510">err</span>&nbsp;<span class="op" id="8205514">!=</span>&nbsp;<span class="ident" id="8205517">nil</span>&nbsp;<span class="op" id="8205521">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205527">t</span><span class="op" id="8205528">.</span><span class="ident" id="8205529">Fatalf</span><span class="op" id="8205535">(</span><span class="string" id="8205536">&#34;encode&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="8205552">,</span>&nbsp;<span class="ident" id="8205554">j</span><span class="op" id="8205555">,</span>&nbsp;<span class="ident" id="8205557">err</span><span class="op" id="8205560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8205565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8205569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205573">if</span>&nbsp;<span class="ident" id="8205576">have</span><span class="op" id="8205580">,</span>&nbsp;<span class="ident" id="8205582">want</span>&nbsp;<span class="op" id="8205587">:=</span>&nbsp;<span class="ident" id="8205590">buf</span><span class="op" id="8205593">.</span><span class="ident" id="8205594">String</span><span class="op" id="8205600">(</span><span class="op" id="8205601">)</span><span class="op" id="8205602">,</span>&nbsp;<span class="ident" id="8205604">nlines</span><span class="op" id="8205610">(</span><span class="ident" id="8205611">streamEncoded</span><span class="op" id="8205624">,</span>&nbsp;<span class="ident" id="8205626">i</span><span class="op" id="8205627">)</span><span class="op" id="8205628">;</span>&nbsp;<span class="ident" id="8205630">have</span>&nbsp;<span class="op" id="8205635">!=</span>&nbsp;<span class="ident" id="8205638">want</span>&nbsp;<span class="op" id="8205643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205648">t</span><span class="op" id="8205649">.</span><span class="ident" id="8205650">Errorf</span><span class="op" id="8205656">(</span><span class="string" id="8205657">&#34;encoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="8205686">,</span>&nbsp;<span class="ident" id="8205688">i</span><span class="op" id="8205689">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8205694">diff</span><span class="op" id="8205698">(</span><span class="ident" id="8205699">t</span><span class="op" id="8205700">,</span>&nbsp;<span class="op" id="8205702">[</span><span class="op" id="8205703">]</span><span class="builtintype" id="8205704">byte</span><span class="op" id="8205708">(</span><span class="ident" id="8205709">have</span><span class="op" id="8205713">)</span><span class="op" id="8205714">,</span>&nbsp;<span class="op" id="8205716">[</span><span class="op" id="8205717">]</span><span class="builtintype" id="8205718">byte</span><span class="op" id="8205722">(</span><span class="ident" id="8205723">want</span><span class="op" id="8205727">)</span><span class="op" id="8205728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205733">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8205741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8205744">}</span><br>
<span class="lineno"></span><span class="op" id="8205746">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="8205749">func</span>&nbsp;<span class="ident" id="8205754">TestDecoder</span><span class="op" id="8205765">(</span><span class="ident" id="8205766">t</span>&nbsp;<span class="op" id="8205768">*</span><span class="ident" id="8205769">testing</span><span class="op" id="8205776">.</span><span class="ident" id="8205777">T</span><span class="op" id="8205778">)</span>&nbsp;<span class="op" id="8205780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8205783">for</span>&nbsp;<span class="ident" id="8205787">i</span>&nbsp;<span class="op" id="8205789">:=</span>&nbsp;<span class="num" id="8205792">0</span><span class="op" id="8205793">;</span>&nbsp;<span class="ident" id="8205795">i</span>&nbsp;<span class="op" id="8205797">&lt;=</span>&nbsp;<span class="builtinfunc" id="8205800">len</span><span class="op" id="8205803">(</span><span class="ident" id="8205804">streamTest</span><span class="op" id="8205814">)</span><span class="op" id="8205815">;</span>&nbsp;<span class="ident" id="8205817">i</span><span class="op" id="8205818">++</span>&nbsp;<span class="op" id="8205821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8205825">//&nbsp;Use&nbsp;stream&nbsp;without&nbsp;newlines&nbsp;as&nbsp;input,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8205868">//&nbsp;just&nbsp;to&nbsp;stress&nbsp;the&nbsp;decoder&nbsp;even&nbsp;more.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8205911">//&nbsp;Our&nbsp;test&nbsp;input&nbsp;does&nbsp;not&nbsp;include&nbsp;back-to-back&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8205970">//&nbsp;Otherwise&nbsp;stripping&nbsp;the&nbsp;newlines&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8206014">//&nbsp;merge&nbsp;two&nbsp;adjacent&nbsp;JSON&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206051">var</span>&nbsp;<span class="ident" id="8206055">buf</span>&nbsp;<span class="ident" id="8206059">bytes</span><span class="op" id="8206064">.</span><span class="ident" id="8206065">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206074">for</span>&nbsp;<span class="ident" id="8206078">_</span><span class="op" id="8206079">,</span>&nbsp;<span class="ident" id="8206081">c</span>&nbsp;<span class="op" id="8206083">:=</span>&nbsp;<span class="keyword" id="8206086">range</span>&nbsp;<span class="ident" id="8206092">nlines</span><span class="op" id="8206098">(</span><span class="ident" id="8206099">streamEncoded</span><span class="op" id="8206112">,</span>&nbsp;<span class="ident" id="8206114">i</span><span class="op" id="8206115">)</span>&nbsp;<span class="op" id="8206117">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206122">if</span>&nbsp;<span class="ident" id="8206125">c</span>&nbsp;<span class="op" id="8206127">!=</span>&nbsp;<span class="string" id="8206130">&#39;\n&#39;</span>&nbsp;<span class="op" id="8206135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206141">buf</span><span class="op" id="8206144">.</span><span class="ident" id="8206145">WriteRune</span><span class="op" id="8206154">(</span><span class="ident" id="8206155">c</span><span class="op" id="8206156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206169">out</span>&nbsp;<span class="op" id="8206173">:=</span>&nbsp;<span class="builtinfunc" id="8206176">make</span><span class="op" id="8206180">(</span><span class="op" id="8206181">[</span><span class="op" id="8206182">]</span><span class="keyword" id="8206183">interface</span><span class="op" id="8206192">{</span><span class="op" id="8206193">}</span><span class="op" id="8206194">,</span>&nbsp;<span class="ident" id="8206196">i</span><span class="op" id="8206197">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206201">dec</span>&nbsp;<span class="op" id="8206205">:=</span>&nbsp;<span class="ident" id="8206208">NewDecoder</span><span class="op" id="8206218">(</span><span class="op" id="8206219">&amp;</span><span class="ident" id="8206220">buf</span><span class="op" id="8206223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206227">for</span>&nbsp;<span class="ident" id="8206231">j</span>&nbsp;<span class="op" id="8206233">:=</span>&nbsp;<span class="keyword" id="8206236">range</span>&nbsp;<span class="ident" id="8206242">out</span>&nbsp;<span class="op" id="8206246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206251">if</span>&nbsp;<span class="ident" id="8206254">err</span>&nbsp;<span class="op" id="8206258">:=</span>&nbsp;<span class="ident" id="8206261">dec</span><span class="op" id="8206264">.</span><span class="ident" id="8206265">Decode</span><span class="op" id="8206271">(</span><span class="op" id="8206272">&amp;</span><span class="ident" id="8206273">out</span><span class="op" id="8206276">[</span><span class="ident" id="8206277">j</span><span class="op" id="8206278">]</span><span class="op" id="8206279">)</span><span class="op" id="8206280">;</span>&nbsp;<span class="ident" id="8206282">err</span>&nbsp;<span class="op" id="8206286">!=</span>&nbsp;<span class="ident" id="8206289">nil</span>&nbsp;<span class="op" id="8206293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206299">t</span><span class="op" id="8206300">.</span><span class="ident" id="8206301">Fatalf</span><span class="op" id="8206307">(</span><span class="string" id="8206308">&#34;decode&nbsp;#%d/%d:&nbsp;%v&#34;</span><span class="op" id="8206327">,</span>&nbsp;<span class="ident" id="8206329">j</span><span class="op" id="8206330">,</span>&nbsp;<span class="ident" id="8206332">i</span><span class="op" id="8206333">,</span>&nbsp;<span class="ident" id="8206335">err</span><span class="op" id="8206338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206343">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206351">if</span>&nbsp;<span class="op" id="8206354">!</span><span class="ident" id="8206355">reflect</span><span class="op" id="8206362">.</span><span class="ident" id="8206363">DeepEqual</span><span class="op" id="8206372">(</span><span class="ident" id="8206373">out</span><span class="op" id="8206376">,</span>&nbsp;<span class="ident" id="8206378">streamTest</span><span class="op" id="8206388">[</span><span class="num" id="8206389">0</span><span class="op" id="8206390">:</span><span class="ident" id="8206391">i</span><span class="op" id="8206392">]</span><span class="op" id="8206393">)</span>&nbsp;<span class="op" id="8206395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206400">t</span><span class="op" id="8206401">.</span><span class="ident" id="8206402">Errorf</span><span class="op" id="8206408">(</span><span class="string" id="8206409">&#34;decoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="8206438">,</span>&nbsp;<span class="ident" id="8206440">i</span><span class="op" id="8206441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206446">for</span>&nbsp;<span class="ident" id="8206450">j</span>&nbsp;<span class="op" id="8206452">:=</span>&nbsp;<span class="keyword" id="8206455">range</span>&nbsp;<span class="ident" id="8206461">out</span>&nbsp;<span class="op" id="8206465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206471">if</span>&nbsp;<span class="op" id="8206474">!</span><span class="ident" id="8206475">reflect</span><span class="op" id="8206482">.</span><span class="ident" id="8206483">DeepEqual</span><span class="op" id="8206492">(</span><span class="ident" id="8206493">out</span><span class="op" id="8206496">[</span><span class="ident" id="8206497">j</span><span class="op" id="8206498">]</span><span class="op" id="8206499">,</span>&nbsp;<span class="ident" id="8206501">streamTest</span><span class="op" id="8206511">[</span><span class="ident" id="8206512">j</span><span class="op" id="8206513">]</span><span class="op" id="8206514">)</span>&nbsp;<span class="op" id="8206516">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206523">t</span><span class="op" id="8206524">.</span><span class="ident" id="8206525">Errorf</span><span class="op" id="8206531">(</span><span class="string" id="8206532">&#34;#%d:&nbsp;have&nbsp;%v&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8206554">,</span>&nbsp;<span class="ident" id="8206556">j</span><span class="op" id="8206557">,</span>&nbsp;<span class="ident" id="8206559">out</span><span class="op" id="8206562">[</span><span class="ident" id="8206563">j</span><span class="op" id="8206564">]</span><span class="op" id="8206565">,</span>&nbsp;<span class="ident" id="8206567">streamTest</span><span class="op" id="8206577">[</span><span class="ident" id="8206578">j</span><span class="op" id="8206579">]</span><span class="op" id="8206580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206596">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206604">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206607">}</span><br>
<span class="lineno"></span><span class="op" id="8206609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8206612">func</span>&nbsp;<span class="ident" id="8206617">TestDecoderBuffered</span><span class="op" id="8206636">(</span><span class="ident" id="8206637">t</span>&nbsp;<span class="op" id="8206639">*</span><span class="ident" id="8206640">testing</span><span class="op" id="8206647">.</span><span class="ident" id="8206648">T</span><span class="op" id="8206649">)</span>&nbsp;<span class="op" id="8206651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206654">r</span>&nbsp;<span class="op" id="8206656">:=</span>&nbsp;<span class="ident" id="8206659">strings</span><span class="op" id="8206666">.</span><span class="ident" id="8206667">NewReader</span><span class="op" id="8206676">(</span><span class="string" id="8206677">`{&#34;Name&#34;:&nbsp;&#34;Gopher&#34;}&nbsp;extra&nbsp;`</span><span class="op" id="8206704">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206707">var</span>&nbsp;<span class="ident" id="8206711">m</span>&nbsp;<span class="keyword" id="8206713">struct</span>&nbsp;<span class="op" id="8206720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206724">Name</span>&nbsp;<span class="builtintype" id="8206729">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206740">d</span>&nbsp;<span class="op" id="8206742">:=</span>&nbsp;<span class="ident" id="8206745">NewDecoder</span><span class="op" id="8206755">(</span><span class="ident" id="8206756">r</span><span class="op" id="8206757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206760">err</span>&nbsp;<span class="op" id="8206764">:=</span>&nbsp;<span class="ident" id="8206767">d</span><span class="op" id="8206768">.</span><span class="ident" id="8206769">Decode</span><span class="op" id="8206775">(</span><span class="op" id="8206776">&amp;</span><span class="ident" id="8206777">m</span><span class="op" id="8206778">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206781">if</span>&nbsp;<span class="ident" id="8206784">err</span>&nbsp;<span class="op" id="8206788">!=</span>&nbsp;<span class="ident" id="8206791">nil</span>&nbsp;<span class="op" id="8206795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206799">t</span><span class="op" id="8206800">.</span><span class="ident" id="8206801">Fatal</span><span class="op" id="8206806">(</span><span class="ident" id="8206807">err</span><span class="op" id="8206810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206816">if</span>&nbsp;<span class="ident" id="8206819">m</span><span class="op" id="8206820">.</span><span class="ident" id="8206821">Name</span>&nbsp;<span class="op" id="8206826">!=</span>&nbsp;<span class="string" id="8206829">&#34;Gopher&#34;</span>&nbsp;<span class="op" id="8206838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206842">t</span><span class="op" id="8206843">.</span><span class="ident" id="8206844">Errorf</span><span class="op" id="8206850">(</span><span class="string" id="8206851">&#34;Name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;Gopher&#34;</span><span class="op" id="8206875">,</span>&nbsp;<span class="ident" id="8206877">m</span><span class="op" id="8206878">.</span><span class="ident" id="8206879">Name</span><span class="op" id="8206883">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206889">rest</span><span class="op" id="8206893">,</span>&nbsp;<span class="ident" id="8206895">err</span>&nbsp;<span class="op" id="8206899">:=</span>&nbsp;<span class="ident" id="8206902">ioutil</span><span class="op" id="8206908">.</span><span class="ident" id="8206909">ReadAll</span><span class="op" id="8206916">(</span><span class="ident" id="8206917">d</span><span class="op" id="8206918">.</span><span class="ident" id="8206919">Buffered</span><span class="op" id="8206927">(</span><span class="op" id="8206928">)</span><span class="op" id="8206929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206932">if</span>&nbsp;<span class="ident" id="8206935">err</span>&nbsp;<span class="op" id="8206939">!=</span>&nbsp;<span class="ident" id="8206942">nil</span>&nbsp;<span class="op" id="8206946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8206950">t</span><span class="op" id="8206951">.</span><span class="ident" id="8206952">Fatal</span><span class="op" id="8206957">(</span><span class="ident" id="8206958">err</span><span class="op" id="8206961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8206964">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8206967">if</span>&nbsp;<span class="ident" id="8206970">g</span><span class="op" id="8206971">,</span>&nbsp;<span class="ident" id="8206973">w</span>&nbsp;<span class="op" id="8206975">:=</span>&nbsp;<span class="builtintype" id="8206978">string</span><span class="op" id="8206984">(</span><span class="ident" id="8206985">rest</span><span class="op" id="8206989">)</span><span class="op" id="8206990">,</span>&nbsp;<span class="string" id="8206992">&#34;&nbsp;extra&nbsp;&#34;</span><span class="op" id="8207001">;</span>&nbsp;<span class="ident" id="8207003">g</span>&nbsp;<span class="op" id="8207005">!=</span>&nbsp;<span class="ident" id="8207008">w</span>&nbsp;<span class="op" id="8207010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207014">t</span><span class="op" id="8207015">.</span><span class="ident" id="8207016">Errorf</span><span class="op" id="8207022">(</span><span class="string" id="8207023">&#34;Remaining&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8207048">,</span>&nbsp;<span class="ident" id="8207050">g</span><span class="op" id="8207051">,</span>&nbsp;<span class="ident" id="8207053">w</span><span class="op" id="8207054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207057">}</span><br>
<span class="lineno"></span><span class="op" id="8207059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="8207062">func</span>&nbsp;<span class="ident" id="8207067">nlines</span><span class="op" id="8207073">(</span><span class="ident" id="8207074">s</span>&nbsp;<span class="builtintype" id="8207076">string</span><span class="op" id="8207082">,</span>&nbsp;<span class="ident" id="8207084">n</span>&nbsp;<span class="builtintype" id="8207086">int</span><span class="op" id="8207089">)</span>&nbsp;<span class="builtintype" id="8207091">string</span>&nbsp;<span class="op" id="8207098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207101">if</span>&nbsp;<span class="ident" id="8207104">n</span>&nbsp;<span class="op" id="8207106">&lt;=</span>&nbsp;<span class="num" id="8207109">0</span>&nbsp;<span class="op" id="8207111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207115">return</span>&nbsp;<span class="string" id="8207122">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207129">for</span>&nbsp;<span class="ident" id="8207133">i</span><span class="op" id="8207134">,</span>&nbsp;<span class="ident" id="8207136">c</span>&nbsp;<span class="op" id="8207138">:=</span>&nbsp;<span class="keyword" id="8207141">range</span>&nbsp;<span class="ident" id="8207147">s</span>&nbsp;<span class="op" id="8207149">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207153">if</span>&nbsp;<span class="ident" id="8207156">c</span>&nbsp;<span class="op" id="8207158">==</span>&nbsp;<span class="string" id="8207161">&#39;\n&#39;</span>&nbsp;<span class="op" id="8207166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207171">if</span>&nbsp;<span class="ident" id="8207174">n</span><span class="op" id="8207175">--</span><span class="op" id="8207177">;</span>&nbsp;<span class="ident" id="8207179">n</span>&nbsp;<span class="op" id="8207181">==</span>&nbsp;<span class="num" id="8207184">0</span>&nbsp;<span class="op" id="8207186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207192">return</span>&nbsp;<span class="ident" id="8207199">s</span><span class="op" id="8207200">[</span><span class="num" id="8207201">0</span>&nbsp;<span class="op" id="8207203">:</span>&nbsp;<span class="ident" id="8207205">i</span><span class="op" id="8207206">+</span><span class="num" id="8207207">1</span><span class="op" id="8207208">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207217">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207223">return</span>&nbsp;<span class="ident" id="8207230">s</span><br>
<span class="lineno"></span><span class="op" id="8207232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8207235">func</span>&nbsp;<span class="ident" id="8207240">TestRawMessage</span><span class="op" id="8207254">(</span><span class="ident" id="8207255">t</span>&nbsp;<span class="op" id="8207257">*</span><span class="ident" id="8207258">testing</span><span class="op" id="8207265">.</span><span class="ident" id="8207266">T</span><span class="op" id="8207267">)</span>&nbsp;<span class="op" id="8207269">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8207272">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207324">var</span>&nbsp;<span class="ident" id="8207328">data</span>&nbsp;<span class="keyword" id="8207333">struct</span>&nbsp;<span class="op" id="8207340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207344">X</span>&nbsp;&nbsp;<span class="builtintype" id="8207347">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207357">Id</span>&nbsp;<span class="op" id="8207360">*</span><span class="ident" id="8207361">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207374">Y</span>&nbsp;&nbsp;<span class="builtintype" id="8207377">float32</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207389">const</span>&nbsp;<span class="ident" id="8207395">raw</span>&nbsp;<span class="op" id="8207399">=</span>&nbsp;<span class="string" id="8207401">`[&#34;\u0056&#34;,null]`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207420">const</span>&nbsp;<span class="ident" id="8207426">msg</span>&nbsp;<span class="op" id="8207430">=</span>&nbsp;<span class="string" id="8207432">`{&#34;X&#34;:0.1,&#34;Id&#34;:[&#34;\u0056&#34;,null],&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207474">err</span>&nbsp;<span class="op" id="8207478">:=</span>&nbsp;<span class="ident" id="8207481">Unmarshal</span><span class="op" id="8207490">(</span><span class="op" id="8207491">[</span><span class="op" id="8207492">]</span><span class="builtintype" id="8207493">byte</span><span class="op" id="8207497">(</span><span class="ident" id="8207498">msg</span><span class="op" id="8207501">)</span><span class="op" id="8207502">,</span>&nbsp;<span class="op" id="8207504">&amp;</span><span class="ident" id="8207505">data</span><span class="op" id="8207509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207512">if</span>&nbsp;<span class="ident" id="8207515">err</span>&nbsp;<span class="op" id="8207519">!=</span>&nbsp;<span class="ident" id="8207522">nil</span>&nbsp;<span class="op" id="8207526">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207530">t</span><span class="op" id="8207531">.</span><span class="ident" id="8207532">Fatalf</span><span class="op" id="8207538">(</span><span class="string" id="8207539">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="8207554">,</span>&nbsp;<span class="ident" id="8207556">err</span><span class="op" id="8207559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207565">if</span>&nbsp;<span class="builtintype" id="8207568">string</span><span class="op" id="8207574">(</span><span class="op" id="8207575">[</span><span class="op" id="8207576">]</span><span class="builtintype" id="8207577">byte</span><span class="op" id="8207581">(</span><span class="op" id="8207582">*</span><span class="ident" id="8207583">data</span><span class="op" id="8207587">.</span><span class="ident" id="8207588">Id</span><span class="op" id="8207590">)</span><span class="op" id="8207591">)</span>&nbsp;<span class="op" id="8207593">!=</span>&nbsp;<span class="ident" id="8207596">raw</span>&nbsp;<span class="op" id="8207600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207604">t</span><span class="op" id="8207605">.</span><span class="ident" id="8207606">Fatalf</span><span class="op" id="8207612">(</span><span class="string" id="8207613">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="8207646">,</span>&nbsp;<span class="op" id="8207648">[</span><span class="op" id="8207649">]</span><span class="builtintype" id="8207650">byte</span><span class="op" id="8207654">(</span><span class="op" id="8207655">*</span><span class="ident" id="8207656">data</span><span class="op" id="8207660">.</span><span class="ident" id="8207661">Id</span><span class="op" id="8207663">)</span><span class="op" id="8207664">,</span>&nbsp;<span class="ident" id="8207666">raw</span><span class="op" id="8207669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207672">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207675">b</span><span class="op" id="8207676">,</span>&nbsp;<span class="ident" id="8207678">err</span>&nbsp;<span class="op" id="8207682">:=</span>&nbsp;<span class="ident" id="8207685">Marshal</span><span class="op" id="8207692">(</span><span class="op" id="8207693">&amp;</span><span class="ident" id="8207694">data</span><span class="op" id="8207698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207701">if</span>&nbsp;<span class="ident" id="8207704">err</span>&nbsp;<span class="op" id="8207708">!=</span>&nbsp;<span class="ident" id="8207711">nil</span>&nbsp;<span class="op" id="8207715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207719">t</span><span class="op" id="8207720">.</span><span class="ident" id="8207721">Fatalf</span><span class="op" id="8207727">(</span><span class="string" id="8207728">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="8207741">,</span>&nbsp;<span class="ident" id="8207743">err</span><span class="op" id="8207746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207752">if</span>&nbsp;<span class="builtintype" id="8207755">string</span><span class="op" id="8207761">(</span><span class="ident" id="8207762">b</span><span class="op" id="8207763">)</span>&nbsp;<span class="op" id="8207765">!=</span>&nbsp;<span class="ident" id="8207768">msg</span>&nbsp;<span class="op" id="8207772">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207776">t</span><span class="op" id="8207777">.</span><span class="ident" id="8207778">Fatalf</span><span class="op" id="8207784">(</span><span class="string" id="8207785">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="8207813">,</span>&nbsp;<span class="ident" id="8207815">b</span><span class="op" id="8207816">,</span>&nbsp;<span class="ident" id="8207818">msg</span><span class="op" id="8207821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207824">}</span><br>
<span class="lineno"></span><span class="op" id="8207826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8207829">func</span>&nbsp;<span class="ident" id="8207834">TestNullRawMessage</span><span class="op" id="8207852">(</span><span class="ident" id="8207853">t</span>&nbsp;<span class="op" id="8207855">*</span><span class="ident" id="8207856">testing</span><span class="op" id="8207863">.</span><span class="ident" id="8207864">T</span><span class="op" id="8207865">)</span>&nbsp;<span class="op" id="8207867">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8207870">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207922">var</span>&nbsp;<span class="ident" id="8207926">data</span>&nbsp;<span class="keyword" id="8207931">struct</span>&nbsp;<span class="op" id="8207938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207942">X</span>&nbsp;&nbsp;<span class="builtintype" id="8207945">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207955">Id</span>&nbsp;<span class="op" id="8207958">*</span><span class="ident" id="8207959">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207972">Y</span>&nbsp;&nbsp;<span class="builtintype" id="8207975">float32</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207987">data</span><span class="op" id="8207991">.</span><span class="ident" id="8207992">Id</span>&nbsp;<span class="op" id="8207995">=</span>&nbsp;<span class="builtinfunc" id="8207997">new</span><span class="op" id="8208000">(</span><span class="ident" id="8208001">RawMessage</span><span class="op" id="8208011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208014">const</span>&nbsp;<span class="ident" id="8208020">msg</span>&nbsp;<span class="op" id="8208024">=</span>&nbsp;<span class="string" id="8208026">`{&#34;X&#34;:0.1,&#34;Id&#34;:null,&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208057">err</span>&nbsp;<span class="op" id="8208061">:=</span>&nbsp;<span class="ident" id="8208064">Unmarshal</span><span class="op" id="8208073">(</span><span class="op" id="8208074">[</span><span class="op" id="8208075">]</span><span class="builtintype" id="8208076">byte</span><span class="op" id="8208080">(</span><span class="ident" id="8208081">msg</span><span class="op" id="8208084">)</span><span class="op" id="8208085">,</span>&nbsp;<span class="op" id="8208087">&amp;</span><span class="ident" id="8208088">data</span><span class="op" id="8208092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208095">if</span>&nbsp;<span class="ident" id="8208098">err</span>&nbsp;<span class="op" id="8208102">!=</span>&nbsp;<span class="ident" id="8208105">nil</span>&nbsp;<span class="op" id="8208109">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208113">t</span><span class="op" id="8208114">.</span><span class="ident" id="8208115">Fatalf</span><span class="op" id="8208121">(</span><span class="string" id="8208122">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="8208137">,</span>&nbsp;<span class="ident" id="8208139">err</span><span class="op" id="8208142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8208145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208148">if</span>&nbsp;<span class="ident" id="8208151">data</span><span class="op" id="8208155">.</span><span class="ident" id="8208156">Id</span>&nbsp;<span class="op" id="8208159">!=</span>&nbsp;<span class="ident" id="8208162">nil</span>&nbsp;<span class="op" id="8208166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208170">t</span><span class="op" id="8208171">.</span><span class="ident" id="8208172">Fatalf</span><span class="op" id="8208178">(</span><span class="string" id="8208179">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;non-nil,&nbsp;want&nbsp;nil&#34;</span><span class="op" id="8208217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8208220">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208223">b</span><span class="op" id="8208224">,</span>&nbsp;<span class="ident" id="8208226">err</span>&nbsp;<span class="op" id="8208230">:=</span>&nbsp;<span class="ident" id="8208233">Marshal</span><span class="op" id="8208240">(</span><span class="op" id="8208241">&amp;</span><span class="ident" id="8208242">data</span><span class="op" id="8208246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208249">if</span>&nbsp;<span class="ident" id="8208252">err</span>&nbsp;<span class="op" id="8208256">!=</span>&nbsp;<span class="ident" id="8208259">nil</span>&nbsp;<span class="op" id="8208263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208267">t</span><span class="op" id="8208268">.</span><span class="ident" id="8208269">Fatalf</span><span class="op" id="8208275">(</span><span class="string" id="8208276">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="8208289">,</span>&nbsp;<span class="ident" id="8208291">err</span><span class="op" id="8208294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8208297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208300">if</span>&nbsp;<span class="builtintype" id="8208303">string</span><span class="op" id="8208309">(</span><span class="ident" id="8208310">b</span><span class="op" id="8208311">)</span>&nbsp;<span class="op" id="8208313">!=</span>&nbsp;<span class="ident" id="8208316">msg</span>&nbsp;<span class="op" id="8208320">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208324">t</span><span class="op" id="8208325">.</span><span class="ident" id="8208326">Fatalf</span><span class="op" id="8208332">(</span><span class="string" id="8208333">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="8208361">,</span>&nbsp;<span class="ident" id="8208363">b</span><span class="op" id="8208364">,</span>&nbsp;<span class="ident" id="8208366">msg</span><span class="op" id="8208369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8208372">}</span><br>
<span class="lineno"></span><span class="op" id="8208374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8208377">var</span>&nbsp;<span class="ident" id="8208381">blockingTests</span>&nbsp;<span class="op" id="8208395">=</span>&nbsp;<span class="op" id="8208397">[</span><span class="op" id="8208398">]</span><span class="builtintype" id="8208399">string</span><span class="op" id="8208405">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208408">`{&#34;x&#34;:&nbsp;1}`</span><span class="op" id="8208418">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208421">`[1,&nbsp;2,&nbsp;3]`</span><span class="op" id="8208432">,</span><br>
<span class="lineno"></span><span class="op" id="8208434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8208437">func</span>&nbsp;<span class="ident" id="8208442">TestBlocking</span><span class="op" id="8208454">(</span><span class="ident" id="8208455">t</span>&nbsp;<span class="op" id="8208457">*</span><span class="ident" id="8208458">testing</span><span class="op" id="8208465">.</span><span class="ident" id="8208466">T</span><span class="op" id="8208467">)</span>&nbsp;<span class="op" id="8208469">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208472">for</span>&nbsp;<span class="ident" id="8208476">_</span><span class="op" id="8208477">,</span>&nbsp;<span class="ident" id="8208479">enc</span>&nbsp;<span class="op" id="8208483">:=</span>&nbsp;<span class="keyword" id="8208486">range</span>&nbsp;<span class="ident" id="8208492">blockingTests</span>&nbsp;<span class="op" id="8208506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208510">r</span><span class="op" id="8208511">,</span>&nbsp;<span class="ident" id="8208513">w</span>&nbsp;<span class="op" id="8208515">:=</span>&nbsp;<span class="ident" id="8208518">net</span><span class="op" id="8208521">.</span><span class="ident" id="8208522">Pipe</span><span class="op" id="8208526">(</span><span class="op" id="8208527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208531">go</span>&nbsp;<span class="ident" id="8208534">w</span><span class="op" id="8208535">.</span><span class="ident" id="8208536">Write</span><span class="op" id="8208541">(</span><span class="op" id="8208542">[</span><span class="op" id="8208543">]</span><span class="builtintype" id="8208544">byte</span><span class="op" id="8208548">(</span><span class="ident" id="8208549">enc</span><span class="op" id="8208552">)</span><span class="op" id="8208553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208557">var</span>&nbsp;<span class="ident" id="8208561">val</span>&nbsp;<span class="keyword" id="8208565">interface</span><span class="op" id="8208574">{</span><span class="op" id="8208575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8208580">//&nbsp;If&nbsp;Decode&nbsp;reads&nbsp;beyond&nbsp;what&nbsp;w.Write&nbsp;writes&nbsp;above,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8208635">//&nbsp;it&nbsp;will&nbsp;block,&nbsp;and&nbsp;the&nbsp;test&nbsp;will&nbsp;deadlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208683">if</span>&nbsp;<span class="ident" id="8208686">err</span>&nbsp;<span class="op" id="8208690">:=</span>&nbsp;<span class="ident" id="8208693">NewDecoder</span><span class="op" id="8208703">(</span><span class="ident" id="8208704">r</span><span class="op" id="8208705">)</span><span class="op" id="8208706">.</span><span class="ident" id="8208707">Decode</span><span class="op" id="8208713">(</span><span class="op" id="8208714">&amp;</span><span class="ident" id="8208715">val</span><span class="op" id="8208718">)</span><span class="op" id="8208719">;</span>&nbsp;<span class="ident" id="8208721">err</span>&nbsp;<span class="op" id="8208725">!=</span>&nbsp;<span class="ident" id="8208728">nil</span>&nbsp;<span class="op" id="8208732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208737">t</span><span class="op" id="8208738">.</span><span class="ident" id="8208739">Errorf</span><span class="op" id="8208745">(</span><span class="string" id="8208746">&#34;decoding&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="8208763">,</span>&nbsp;<span class="ident" id="8208765">enc</span><span class="op" id="8208768">,</span>&nbsp;<span class="ident" id="8208770">err</span><span class="op" id="8208773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8208777">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208781">r</span><span class="op" id="8208782">.</span><span class="ident" id="8208783">Close</span><span class="op" id="8208788">(</span><span class="op" id="8208789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208793">w</span><span class="op" id="8208794">.</span><span class="ident" id="8208795">Close</span><span class="op" id="8208800">(</span><span class="op" id="8208801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8208804">}</span><br>
<span class="lineno"></span><span class="op" id="8208806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="8208809">func</span>&nbsp;<span class="ident" id="8208814">BenchmarkEncoderEncode</span><span class="op" id="8208836">(</span><span class="ident" id="8208837">b</span>&nbsp;<span class="op" id="8208839">*</span><span class="ident" id="8208840">testing</span><span class="op" id="8208847">.</span><span class="ident" id="8208848">B</span><span class="op" id="8208849">)</span>&nbsp;<span class="op" id="8208851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208854">b</span><span class="op" id="8208855">.</span><span class="ident" id="8208856">ReportAllocs</span><span class="op" id="8208868">(</span><span class="op" id="8208869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208872">type</span>&nbsp;<span class="ident" id="8208877">T</span>&nbsp;<span class="keyword" id="8208879">struct</span>&nbsp;<span class="op" id="8208886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208890">X</span><span class="op" id="8208891">,</span>&nbsp;<span class="ident" id="8208893">Y</span>&nbsp;<span class="builtintype" id="8208895">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8208903">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208906">v</span>&nbsp;<span class="op" id="8208908">:=</span>&nbsp;<span class="op" id="8208911">&amp;</span><span class="ident" id="8208912">T</span><span class="op" id="8208913">{</span><span class="string" id="8208914">&#34;foo&#34;</span><span class="op" id="8208919">,</span>&nbsp;<span class="string" id="8208921">&#34;bar&#34;</span><span class="op" id="8208926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208929">for</span>&nbsp;<span class="ident" id="8208933">i</span>&nbsp;<span class="op" id="8208935">:=</span>&nbsp;<span class="num" id="8208938">0</span><span class="op" id="8208939">;</span>&nbsp;<span class="ident" id="8208941">i</span>&nbsp;<span class="op" id="8208943">&lt;</span>&nbsp;<span class="ident" id="8208945">b</span><span class="op" id="8208946">.</span><span class="ident" id="8208947">N</span><span class="op" id="8208948">;</span>&nbsp;<span class="ident" id="8208950">i</span><span class="op" id="8208951">++</span>&nbsp;<span class="op" id="8208954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208958">if</span>&nbsp;<span class="ident" id="8208961">err</span>&nbsp;<span class="op" id="8208965">:=</span>&nbsp;<span class="ident" id="8208968">NewEncoder</span><span class="op" id="8208978">(</span><span class="ident" id="8208979">ioutil</span><span class="op" id="8208985">.</span><span class="ident" id="8208986">Discard</span><span class="op" id="8208993">)</span><span class="op" id="8208994">.</span><span class="ident" id="8208995">Encode</span><span class="op" id="8209001">(</span><span class="ident" id="8209002">v</span><span class="op" id="8209003">)</span><span class="op" id="8209004">;</span>&nbsp;<span class="ident" id="8209006">err</span>&nbsp;<span class="op" id="8209010">!=</span>&nbsp;<span class="ident" id="8209013">nil</span>&nbsp;<span class="op" id="8209017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209022">b</span><span class="op" id="8209023">.</span><span class="ident" id="8209024">Fatal</span><span class="op" id="8209029">(</span><span class="ident" id="8209030">err</span><span class="op" id="8209033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209037">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209040">}</span><br>
<span class="lineno"></span><span class="op" id="8209042">}</span>
</div>
</body>
</html>
