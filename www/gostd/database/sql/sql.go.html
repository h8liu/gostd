<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3841657">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3841712">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3841766">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3841817">//&nbsp;Package&nbsp;sql&nbsp;provides&nbsp;a&nbsp;generic&nbsp;interface&nbsp;around&nbsp;SQL&nbsp;(or&nbsp;SQL-like)</span><br>
<span class="lineno"></span><span class="comment" id="3841886">//&nbsp;databases.</span><br>
<span class="lineno"></span><span class="comment" id="3841900">//</span><br>
<span class="lineno"></span><span class="comment" id="3841903">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;must&nbsp;be&nbsp;used&nbsp;in&nbsp;conjunction&nbsp;with&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="3841974">//&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for&nbsp;a&nbsp;list&nbsp;of&nbsp;drivers.</span><br>
<span class="lineno">10</span><span class="comment" id="3842035">//</span><br>
<span class="lineno"></span><span class="comment" id="3842038">//&nbsp;For&nbsp;more&nbsp;usage&nbsp;examples,&nbsp;see&nbsp;the&nbsp;wiki&nbsp;page&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="3842087">//&nbsp;http://golang.org/s/sqlwiki.</span><br>
<span class="lineno"></span><span class="keyword" id="3842119">package</span>&nbsp;<span class="ident" id="3842127">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="3842132">import</span>&nbsp;<span class="op" id="3842139">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842142">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842165">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842175">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842182">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842188">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842199">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842207">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="3842214">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="3842217">var</span>&nbsp;<span class="ident" id="3842221">drivers</span>&nbsp;<span class="op" id="3842229">=</span>&nbsp;<span class="builtinfunc" id="3842231">make</span><span class="op" id="3842235">(</span><span class="keyword" id="3842236">map</span><span class="op" id="3842239">[</span><span class="builtintype" id="3842240">string</span><span class="op" id="3842246">]</span><span class="ident" id="3842247">driver</span><span class="op" id="3842253">.</span><span class="ident" id="3842254">Driver</span><span class="op" id="3842260">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3842263">//&nbsp;Register&nbsp;makes&nbsp;a&nbsp;database&nbsp;driver&nbsp;available&nbsp;by&nbsp;the&nbsp;provided&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="3842331">//&nbsp;If&nbsp;Register&nbsp;is&nbsp;called&nbsp;twice&nbsp;with&nbsp;the&nbsp;same&nbsp;name&nbsp;or&nbsp;if&nbsp;driver&nbsp;is&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="3842402">//&nbsp;it&nbsp;panics.</span><br>
<span class="lineno">30</span><span class="keyword" id="3842416">func</span>&nbsp;<span class="ident" id="3842421">Register</span><span class="op" id="3842429">(</span><span class="ident" id="3842430">name</span>&nbsp;<span class="builtintype" id="3842435">string</span><span class="op" id="3842441">,</span>&nbsp;<span class="ident" id="3842443">driver</span>&nbsp;<span class="ident" id="3842450">driver</span><span class="op" id="3842456">.</span><span class="ident" id="3842457">Driver</span><span class="op" id="3842463">)</span>&nbsp;<span class="op" id="3842465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842468">if</span>&nbsp;<span class="ident" id="3842471">driver</span>&nbsp;<span class="op" id="3842478">==</span>&nbsp;<span class="ident" id="3842481">nil</span>&nbsp;<span class="op" id="3842485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3842489">panic</span><span class="op" id="3842494">(</span><span class="string" id="3842495">&#34;sql:&nbsp;Register&nbsp;driver&nbsp;is&nbsp;nil&#34;</span><span class="op" id="3842524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842530">if</span>&nbsp;<span class="ident" id="3842533">_</span><span class="op" id="3842534">,</span>&nbsp;<span class="ident" id="3842536">dup</span>&nbsp;<span class="op" id="3842540">:=</span>&nbsp;<span class="ident" id="3842543">drivers</span><span class="op" id="3842550">[</span><span class="ident" id="3842551">name</span><span class="op" id="3842555">]</span><span class="op" id="3842556">;</span>&nbsp;<span class="ident" id="3842558">dup</span>&nbsp;<span class="op" id="3842562">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3842566">panic</span><span class="op" id="3842571">(</span><span class="string" id="3842572">&#34;sql:&nbsp;Register&nbsp;called&nbsp;twice&nbsp;for&nbsp;driver&nbsp;&#34;</span>&nbsp;<span class="op" id="3842613">+</span>&nbsp;<span class="ident" id="3842615">name</span><span class="op" id="3842619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842625">drivers</span><span class="op" id="3842632">[</span><span class="ident" id="3842633">name</span><span class="op" id="3842637">]</span>&nbsp;<span class="op" id="3842639">=</span>&nbsp;<span class="ident" id="3842641">driver</span><br>
<span class="lineno"></span><span class="op" id="3842648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="3842651">func</span>&nbsp;<span class="ident" id="3842656">unregisterAllDrivers</span><span class="op" id="3842676">(</span><span class="op" id="3842677">)</span>&nbsp;<span class="op" id="3842679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3842682">//&nbsp;For&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842697">drivers</span>&nbsp;<span class="op" id="3842705">=</span>&nbsp;<span class="builtinfunc" id="3842707">make</span><span class="op" id="3842711">(</span><span class="keyword" id="3842712">map</span><span class="op" id="3842715">[</span><span class="builtintype" id="3842716">string</span><span class="op" id="3842722">]</span><span class="ident" id="3842723">driver</span><span class="op" id="3842729">.</span><span class="ident" id="3842730">Driver</span><span class="op" id="3842736">)</span><br>
<span class="lineno"></span><span class="op" id="3842738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="3842741">//&nbsp;Drivers&nbsp;returns&nbsp;a&nbsp;sorted&nbsp;list&nbsp;of&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;registered&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="keyword" id="3842814">func</span>&nbsp;<span class="ident" id="3842819">Drivers</span><span class="op" id="3842826">(</span><span class="op" id="3842827">)</span>&nbsp;<span class="op" id="3842829">[</span><span class="op" id="3842830">]</span><span class="builtintype" id="3842831">string</span>&nbsp;<span class="op" id="3842838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842841">var</span>&nbsp;<span class="ident" id="3842845">list</span>&nbsp;<span class="op" id="3842850">[</span><span class="op" id="3842851">]</span><span class="builtintype" id="3842852">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842860">for</span>&nbsp;<span class="ident" id="3842864">name</span>&nbsp;<span class="op" id="3842869">:=</span>&nbsp;<span class="keyword" id="3842872">range</span>&nbsp;<span class="ident" id="3842878">drivers</span>&nbsp;<span class="op" id="3842886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842890">list</span>&nbsp;<span class="op" id="3842895">=</span>&nbsp;<span class="builtinfunc" id="3842897">append</span><span class="op" id="3842903">(</span><span class="ident" id="3842904">list</span><span class="op" id="3842908">,</span>&nbsp;<span class="ident" id="3842910">name</span><span class="op" id="3842914">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842920">sort</span><span class="op" id="3842924">.</span><span class="ident" id="3842925">Strings</span><span class="op" id="3842932">(</span><span class="ident" id="3842933">list</span><span class="op" id="3842937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842940">return</span>&nbsp;<span class="ident" id="3842947">list</span><br>
<span class="lineno"></span><span class="op" id="3842952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3842955">//&nbsp;RawBytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;slice&nbsp;that&nbsp;holds&nbsp;a&nbsp;reference&nbsp;to&nbsp;memory&nbsp;owned&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3843025">//&nbsp;the&nbsp;database&nbsp;itself.&nbsp;After&nbsp;a&nbsp;Scan&nbsp;into&nbsp;a&nbsp;RawBytes,&nbsp;the&nbsp;slice&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="3843097">//&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;Next,&nbsp;Scan,&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3843151">type</span>&nbsp;<span class="ident" id="3843156">RawBytes</span>&nbsp;<span class="op" id="3843165">[</span><span class="op" id="3843166">]</span><span class="builtintype" id="3843167">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="3843173">//&nbsp;NullString&nbsp;represents&nbsp;a&nbsp;string&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="3843225">//&nbsp;NullString&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="3843275">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination:</span><br>
<span class="lineno"></span><span class="comment" id="3843316">//</span><br>
<span class="lineno"></span><span class="comment" id="3843319">//&nbsp;&nbsp;var&nbsp;s&nbsp;NullString</span><br>
<span class="lineno">65</span><span class="comment" id="3843340">//&nbsp;&nbsp;err&nbsp;:=&nbsp;db.QueryRow(&#34;SELECT&nbsp;name&nbsp;FROM&nbsp;foo&nbsp;WHERE&nbsp;id=?&#34;,&nbsp;id).Scan(&amp;s)</span><br>
<span class="lineno"></span><span class="comment" id="3843411">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="3843419">//&nbsp;&nbsp;if&nbsp;s.Valid&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3843436">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;use&nbsp;s.String</span><br>
<span class="lineno"></span><span class="comment" id="3843459">//&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno">70</span><span class="comment" id="3843472">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;NULL&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3843493">//&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3843499">//</span><br>
<span class="lineno"></span><span class="keyword" id="3843502">type</span>&nbsp;<span class="ident" id="3843507">NullString</span>&nbsp;<span class="keyword" id="3843518">struct</span>&nbsp;<span class="op" id="3843525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843528">String</span>&nbsp;<span class="builtintype" id="3843535">string</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843543">Valid</span>&nbsp;&nbsp;<span class="builtintype" id="3843550">bool</span>&nbsp;<span class="comment" id="3843555">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;String&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="3843594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3843597">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3843639">func</span>&nbsp;<span class="op" id="3843644">(</span><span class="ident" id="3843645">ns</span>&nbsp;<span class="op" id="3843648">*</span><span class="ident" id="3843649">NullString</span><span class="op" id="3843659">)</span>&nbsp;<span class="ident" id="3843661">Scan</span><span class="op" id="3843665">(</span><span class="ident" id="3843666">value</span>&nbsp;<span class="keyword" id="3843672">interface</span><span class="op" id="3843681">{</span><span class="op" id="3843682">}</span><span class="op" id="3843683">)</span>&nbsp;<span class="builtintype" id="3843685">error</span>&nbsp;<span class="op" id="3843691">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843694">if</span>&nbsp;<span class="ident" id="3843697">value</span>&nbsp;<span class="op" id="3843703">==</span>&nbsp;<span class="ident" id="3843706">nil</span>&nbsp;<span class="op" id="3843710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843714">ns</span><span class="op" id="3843716">.</span><span class="ident" id="3843717">String</span><span class="op" id="3843723">,</span>&nbsp;<span class="ident" id="3843725">ns</span><span class="op" id="3843727">.</span><span class="ident" id="3843728">Valid</span>&nbsp;<span class="op" id="3843734">=</span>&nbsp;<span class="string" id="3843736">&#34;&#34;</span><span class="op" id="3843738">,</span>&nbsp;<span class="builtintype" id="3843740">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843748">return</span>&nbsp;<span class="ident" id="3843755">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3843760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843763">ns</span><span class="op" id="3843765">.</span><span class="ident" id="3843766">Valid</span>&nbsp;<span class="op" id="3843772">=</span>&nbsp;<span class="builtintype" id="3843774">true</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843780">return</span>&nbsp;<span class="ident" id="3843787">convertAssign</span><span class="op" id="3843800">(</span><span class="op" id="3843801">&amp;</span><span class="ident" id="3843802">ns</span><span class="op" id="3843804">.</span><span class="ident" id="3843805">String</span><span class="op" id="3843811">,</span>&nbsp;<span class="ident" id="3843813">value</span><span class="op" id="3843818">)</span><br>
<span class="lineno"></span><span class="op" id="3843820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3843823">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3843872">func</span>&nbsp;<span class="op" id="3843877">(</span><span class="ident" id="3843878">ns</span>&nbsp;<span class="ident" id="3843881">NullString</span><span class="op" id="3843891">)</span>&nbsp;<span class="ident" id="3843893">Value</span><span class="op" id="3843898">(</span><span class="op" id="3843899">)</span>&nbsp;<span class="op" id="3843901">(</span><span class="ident" id="3843902">driver</span><span class="op" id="3843908">.</span><span class="ident" id="3843909">Value</span><span class="op" id="3843914">,</span>&nbsp;<span class="builtintype" id="3843916">error</span><span class="op" id="3843921">)</span>&nbsp;<span class="op" id="3843923">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843926">if</span>&nbsp;<span class="op" id="3843929">!</span><span class="ident" id="3843930">ns</span><span class="op" id="3843932">.</span><span class="ident" id="3843933">Valid</span>&nbsp;<span class="op" id="3843939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843943">return</span>&nbsp;<span class="ident" id="3843950">nil</span><span class="op" id="3843953">,</span>&nbsp;<span class="ident" id="3843955">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3843960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843963">return</span>&nbsp;<span class="ident" id="3843970">ns</span><span class="op" id="3843972">.</span><span class="ident" id="3843973">String</span><span class="op" id="3843979">,</span>&nbsp;<span class="ident" id="3843981">nil</span><br>
<span class="lineno"></span><span class="op" id="3843985">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="3843988">//&nbsp;NullInt64&nbsp;represents&nbsp;an&nbsp;int64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="3844039">//&nbsp;NullInt64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="3844088">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="3844152">type</span>&nbsp;<span class="ident" id="3844157">NullInt64</span>&nbsp;<span class="keyword" id="3844167">struct</span>&nbsp;<span class="op" id="3844174">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844177">Int64</span>&nbsp;<span class="ident" id="3844183">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844190">Valid</span>&nbsp;<span class="builtintype" id="3844196">bool</span>&nbsp;<span class="comment" id="3844201">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Int64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="3844239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3844242">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno">105</span><span class="keyword" id="3844284">func</span>&nbsp;<span class="op" id="3844289">(</span><span class="ident" id="3844290">n</span>&nbsp;<span class="op" id="3844292">*</span><span class="ident" id="3844293">NullInt64</span><span class="op" id="3844302">)</span>&nbsp;<span class="ident" id="3844304">Scan</span><span class="op" id="3844308">(</span><span class="ident" id="3844309">value</span>&nbsp;<span class="keyword" id="3844315">interface</span><span class="op" id="3844324">{</span><span class="op" id="3844325">}</span><span class="op" id="3844326">)</span>&nbsp;<span class="builtintype" id="3844328">error</span>&nbsp;<span class="op" id="3844334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844337">if</span>&nbsp;<span class="ident" id="3844340">value</span>&nbsp;<span class="op" id="3844346">==</span>&nbsp;<span class="ident" id="3844349">nil</span>&nbsp;<span class="op" id="3844353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844357">n</span><span class="op" id="3844358">.</span><span class="ident" id="3844359">Int64</span><span class="op" id="3844364">,</span>&nbsp;<span class="ident" id="3844366">n</span><span class="op" id="3844367">.</span><span class="ident" id="3844368">Valid</span>&nbsp;<span class="op" id="3844374">=</span>&nbsp;<span class="num" id="3844376">0</span><span class="op" id="3844377">,</span>&nbsp;<span class="builtintype" id="3844379">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844387">return</span>&nbsp;<span class="ident" id="3844394">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3844399">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844402">n</span><span class="op" id="3844403">.</span><span class="ident" id="3844404">Valid</span>&nbsp;<span class="op" id="3844410">=</span>&nbsp;<span class="builtintype" id="3844412">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844418">return</span>&nbsp;<span class="ident" id="3844425">convertAssign</span><span class="op" id="3844438">(</span><span class="op" id="3844439">&amp;</span><span class="ident" id="3844440">n</span><span class="op" id="3844441">.</span><span class="ident" id="3844442">Int64</span><span class="op" id="3844447">,</span>&nbsp;<span class="ident" id="3844449">value</span><span class="op" id="3844454">)</span><br>
<span class="lineno"></span><span class="op" id="3844456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3844459">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno">115</span><span class="keyword" id="3844508">func</span>&nbsp;<span class="op" id="3844513">(</span><span class="ident" id="3844514">n</span>&nbsp;<span class="ident" id="3844516">NullInt64</span><span class="op" id="3844525">)</span>&nbsp;<span class="ident" id="3844527">Value</span><span class="op" id="3844532">(</span><span class="op" id="3844533">)</span>&nbsp;<span class="op" id="3844535">(</span><span class="ident" id="3844536">driver</span><span class="op" id="3844542">.</span><span class="ident" id="3844543">Value</span><span class="op" id="3844548">,</span>&nbsp;<span class="builtintype" id="3844550">error</span><span class="op" id="3844555">)</span>&nbsp;<span class="op" id="3844557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844560">if</span>&nbsp;<span class="op" id="3844563">!</span><span class="ident" id="3844564">n</span><span class="op" id="3844565">.</span><span class="ident" id="3844566">Valid</span>&nbsp;<span class="op" id="3844572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844576">return</span>&nbsp;<span class="ident" id="3844583">nil</span><span class="op" id="3844586">,</span>&nbsp;<span class="ident" id="3844588">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3844593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844596">return</span>&nbsp;<span class="ident" id="3844603">n</span><span class="op" id="3844604">.</span><span class="ident" id="3844605">Int64</span><span class="op" id="3844610">,</span>&nbsp;<span class="ident" id="3844612">nil</span><br>
<span class="lineno">120</span><span class="op" id="3844616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3844619">//&nbsp;NullFloat64&nbsp;represents&nbsp;a&nbsp;float64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="3844673">//&nbsp;NullFloat64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="3844724">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno">125</span><span class="keyword" id="3844788">type</span>&nbsp;<span class="ident" id="3844793">NullFloat64</span>&nbsp;<span class="keyword" id="3844805">struct</span>&nbsp;<span class="op" id="3844812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844815">Float64</span>&nbsp;<span class="builtintype" id="3844823">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844832">Valid</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3844840">bool</span>&nbsp;<span class="comment" id="3844845">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Float64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="3844885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="3844888">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3844930">func</span>&nbsp;<span class="op" id="3844935">(</span><span class="ident" id="3844936">n</span>&nbsp;<span class="op" id="3844938">*</span><span class="ident" id="3844939">NullFloat64</span><span class="op" id="3844950">)</span>&nbsp;<span class="ident" id="3844952">Scan</span><span class="op" id="3844956">(</span><span class="ident" id="3844957">value</span>&nbsp;<span class="keyword" id="3844963">interface</span><span class="op" id="3844972">{</span><span class="op" id="3844973">}</span><span class="op" id="3844974">)</span>&nbsp;<span class="builtintype" id="3844976">error</span>&nbsp;<span class="op" id="3844982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844985">if</span>&nbsp;<span class="ident" id="3844988">value</span>&nbsp;<span class="op" id="3844994">==</span>&nbsp;<span class="ident" id="3844997">nil</span>&nbsp;<span class="op" id="3845001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845005">n</span><span class="op" id="3845006">.</span><span class="ident" id="3845007">Float64</span><span class="op" id="3845014">,</span>&nbsp;<span class="ident" id="3845016">n</span><span class="op" id="3845017">.</span><span class="ident" id="3845018">Valid</span>&nbsp;<span class="op" id="3845024">=</span>&nbsp;<span class="num" id="3845026">0</span><span class="op" id="3845027">,</span>&nbsp;<span class="builtintype" id="3845029">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845037">return</span>&nbsp;<span class="ident" id="3845044">nil</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3845049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845052">n</span><span class="op" id="3845053">.</span><span class="ident" id="3845054">Valid</span>&nbsp;<span class="op" id="3845060">=</span>&nbsp;<span class="builtintype" id="3845062">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845068">return</span>&nbsp;<span class="ident" id="3845075">convertAssign</span><span class="op" id="3845088">(</span><span class="op" id="3845089">&amp;</span><span class="ident" id="3845090">n</span><span class="op" id="3845091">.</span><span class="ident" id="3845092">Float64</span><span class="op" id="3845099">,</span>&nbsp;<span class="ident" id="3845101">value</span><span class="op" id="3845106">)</span><br>
<span class="lineno"></span><span class="op" id="3845108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3845111">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3845160">func</span>&nbsp;<span class="op" id="3845165">(</span><span class="ident" id="3845166">n</span>&nbsp;<span class="ident" id="3845168">NullFloat64</span><span class="op" id="3845179">)</span>&nbsp;<span class="ident" id="3845181">Value</span><span class="op" id="3845186">(</span><span class="op" id="3845187">)</span>&nbsp;<span class="op" id="3845189">(</span><span class="ident" id="3845190">driver</span><span class="op" id="3845196">.</span><span class="ident" id="3845197">Value</span><span class="op" id="3845202">,</span>&nbsp;<span class="builtintype" id="3845204">error</span><span class="op" id="3845209">)</span>&nbsp;<span class="op" id="3845211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845214">if</span>&nbsp;<span class="op" id="3845217">!</span><span class="ident" id="3845218">n</span><span class="op" id="3845219">.</span><span class="ident" id="3845220">Valid</span>&nbsp;<span class="op" id="3845226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845230">return</span>&nbsp;<span class="ident" id="3845237">nil</span><span class="op" id="3845240">,</span>&nbsp;<span class="ident" id="3845242">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3845247">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845250">return</span>&nbsp;<span class="ident" id="3845257">n</span><span class="op" id="3845258">.</span><span class="ident" id="3845259">Float64</span><span class="op" id="3845266">,</span>&nbsp;<span class="ident" id="3845268">nil</span><br>
<span class="lineno"></span><span class="op" id="3845272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3845275">//&nbsp;NullBool&nbsp;represents&nbsp;a&nbsp;bool&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="3845323">//&nbsp;NullBool&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="3845371">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="3845435">type</span>&nbsp;<span class="ident" id="3845440">NullBool</span>&nbsp;<span class="keyword" id="3845449">struct</span>&nbsp;<span class="op" id="3845456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845459">Bool</span>&nbsp;&nbsp;<span class="builtintype" id="3845465">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845471">Valid</span>&nbsp;<span class="builtintype" id="3845477">bool</span>&nbsp;<span class="comment" id="3845482">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Bool&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="3845519">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="3845522">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3845564">func</span>&nbsp;<span class="op" id="3845569">(</span><span class="ident" id="3845570">n</span>&nbsp;<span class="op" id="3845572">*</span><span class="ident" id="3845573">NullBool</span><span class="op" id="3845581">)</span>&nbsp;<span class="ident" id="3845583">Scan</span><span class="op" id="3845587">(</span><span class="ident" id="3845588">value</span>&nbsp;<span class="keyword" id="3845594">interface</span><span class="op" id="3845603">{</span><span class="op" id="3845604">}</span><span class="op" id="3845605">)</span>&nbsp;<span class="builtintype" id="3845607">error</span>&nbsp;<span class="op" id="3845613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845616">if</span>&nbsp;<span class="ident" id="3845619">value</span>&nbsp;<span class="op" id="3845625">==</span>&nbsp;<span class="ident" id="3845628">nil</span>&nbsp;<span class="op" id="3845632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845636">n</span><span class="op" id="3845637">.</span><span class="ident" id="3845638">Bool</span><span class="op" id="3845642">,</span>&nbsp;<span class="ident" id="3845644">n</span><span class="op" id="3845645">.</span><span class="ident" id="3845646">Valid</span>&nbsp;<span class="op" id="3845652">=</span>&nbsp;<span class="builtintype" id="3845654">false</span><span class="op" id="3845659">,</span>&nbsp;<span class="builtintype" id="3845661">false</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845669">return</span>&nbsp;<span class="ident" id="3845676">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3845681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845684">n</span><span class="op" id="3845685">.</span><span class="ident" id="3845686">Valid</span>&nbsp;<span class="op" id="3845692">=</span>&nbsp;<span class="builtintype" id="3845694">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845700">return</span>&nbsp;<span class="ident" id="3845707">convertAssign</span><span class="op" id="3845720">(</span><span class="op" id="3845721">&amp;</span><span class="ident" id="3845722">n</span><span class="op" id="3845723">.</span><span class="ident" id="3845724">Bool</span><span class="op" id="3845728">,</span>&nbsp;<span class="ident" id="3845730">value</span><span class="op" id="3845735">)</span><br>
<span class="lineno"></span><span class="op" id="3845737">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3845740">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3845789">func</span>&nbsp;<span class="op" id="3845794">(</span><span class="ident" id="3845795">n</span>&nbsp;<span class="ident" id="3845797">NullBool</span><span class="op" id="3845805">)</span>&nbsp;<span class="ident" id="3845807">Value</span><span class="op" id="3845812">(</span><span class="op" id="3845813">)</span>&nbsp;<span class="op" id="3845815">(</span><span class="ident" id="3845816">driver</span><span class="op" id="3845822">.</span><span class="ident" id="3845823">Value</span><span class="op" id="3845828">,</span>&nbsp;<span class="builtintype" id="3845830">error</span><span class="op" id="3845835">)</span>&nbsp;<span class="op" id="3845837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845840">if</span>&nbsp;<span class="op" id="3845843">!</span><span class="ident" id="3845844">n</span><span class="op" id="3845845">.</span><span class="ident" id="3845846">Valid</span>&nbsp;<span class="op" id="3845852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845856">return</span>&nbsp;<span class="ident" id="3845863">nil</span><span class="op" id="3845866">,</span>&nbsp;<span class="ident" id="3845868">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3845873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845876">return</span>&nbsp;<span class="ident" id="3845883">n</span><span class="op" id="3845884">.</span><span class="ident" id="3845885">Bool</span><span class="op" id="3845889">,</span>&nbsp;<span class="ident" id="3845891">nil</span><br>
<span class="lineno"></span><span class="op" id="3845895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3845898">//&nbsp;Scanner&nbsp;is&nbsp;an&nbsp;interface&nbsp;used&nbsp;by&nbsp;Scan.</span><br>
<span class="lineno">175</span><span class="keyword" id="3845939">type</span>&nbsp;<span class="ident" id="3845944">Scanner</span>&nbsp;<span class="keyword" id="3845952">interface</span>&nbsp;<span class="op" id="3845962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845965">//&nbsp;Scan&nbsp;assigns&nbsp;a&nbsp;value&nbsp;from&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846014">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846018">//&nbsp;The&nbsp;src&nbsp;value&nbsp;will&nbsp;be&nbsp;of&nbsp;one&nbsp;of&nbsp;the&nbsp;following&nbsp;restricted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846079">//&nbsp;set&nbsp;of&nbsp;types:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846097">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846101">//&nbsp;&nbsp;&nbsp;&nbsp;int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846114">//&nbsp;&nbsp;&nbsp;&nbsp;float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846129">//&nbsp;&nbsp;&nbsp;&nbsp;bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846141">//&nbsp;&nbsp;&nbsp;&nbsp;[]byte</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846155">//&nbsp;&nbsp;&nbsp;&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846169">//&nbsp;&nbsp;&nbsp;&nbsp;time.Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846186">//&nbsp;&nbsp;&nbsp;&nbsp;nil&nbsp;-&nbsp;for&nbsp;NULL&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846215">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846219">//&nbsp;An&nbsp;error&nbsp;should&nbsp;be&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;can&nbsp;not&nbsp;be&nbsp;stored</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846282">//&nbsp;without&nbsp;loss&nbsp;of&nbsp;information.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846315">Scan</span><span class="op" id="3846319">(</span><span class="ident" id="3846320">src</span>&nbsp;<span class="keyword" id="3846324">interface</span><span class="op" id="3846333">{</span><span class="op" id="3846334">}</span><span class="op" id="3846335">)</span>&nbsp;<span class="builtintype" id="3846337">error</span><br>
<span class="lineno"></span><span class="op" id="3846343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3846346">//&nbsp;ErrNoRows&nbsp;is&nbsp;returned&nbsp;by&nbsp;Scan&nbsp;when&nbsp;QueryRow&nbsp;doesn&#39;t&nbsp;return&nbsp;a</span><br>
<span class="lineno">195</span><span class="comment" id="3846410">//&nbsp;row.&nbsp;In&nbsp;such&nbsp;a&nbsp;case,&nbsp;QueryRow&nbsp;returns&nbsp;a&nbsp;placeholder&nbsp;*Row&nbsp;value&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3846481">//&nbsp;defers&nbsp;this&nbsp;error&nbsp;until&nbsp;a&nbsp;Scan.</span><br>
<span class="lineno"></span><span class="keyword" id="3846516">var</span>&nbsp;<span class="ident" id="3846520">ErrNoRows</span>&nbsp;<span class="op" id="3846530">=</span>&nbsp;<span class="ident" id="3846532">errors</span><span class="op" id="3846538">.</span><span class="ident" id="3846539">New</span><span class="op" id="3846542">(</span><span class="string" id="3846543">&#34;sql:&nbsp;no&nbsp;rows&nbsp;in&nbsp;result&nbsp;set&#34;</span><span class="op" id="3846571">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3846574">//&nbsp;DB&nbsp;is&nbsp;a&nbsp;database&nbsp;handle&nbsp;representing&nbsp;a&nbsp;pool&nbsp;of&nbsp;zero&nbsp;or&nbsp;more</span><br>
<span class="lineno">200</span><span class="comment" id="3846637">//&nbsp;underlying&nbsp;connections.&nbsp;It&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple</span><br>
<span class="lineno"></span><span class="comment" id="3846705">//&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="3846720">//</span><br>
<span class="lineno"></span><span class="comment" id="3846723">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;creates&nbsp;and&nbsp;frees&nbsp;connections&nbsp;automatically;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3846790">//&nbsp;also&nbsp;maintains&nbsp;a&nbsp;free&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;If&nbsp;the&nbsp;database&nbsp;has</span><br>
<span class="lineno">205</span><span class="comment" id="3846861">//&nbsp;a&nbsp;concept&nbsp;of&nbsp;per-connection&nbsp;state,&nbsp;such&nbsp;state&nbsp;can&nbsp;only&nbsp;be&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="3846931">//&nbsp;observed&nbsp;within&nbsp;a&nbsp;transaction.&nbsp;Once&nbsp;DB.Begin&nbsp;is&nbsp;called,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3846994">//&nbsp;returned&nbsp;Tx&nbsp;is&nbsp;bound&nbsp;to&nbsp;a&nbsp;single&nbsp;connection.&nbsp;Once&nbsp;Commit&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3847057">//&nbsp;Rollback&nbsp;is&nbsp;called&nbsp;on&nbsp;the&nbsp;transaction,&nbsp;that&nbsp;transaction&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3847118">//&nbsp;connection&nbsp;is&nbsp;returned&nbsp;to&nbsp;DB&#39;s&nbsp;idle&nbsp;connection&nbsp;pool.&nbsp;The&nbsp;pool&nbsp;size</span><br>
<span class="lineno">210</span><span class="comment" id="3847188">//&nbsp;can&nbsp;be&nbsp;controlled&nbsp;with&nbsp;SetMaxIdleConns.</span><br>
<span class="lineno"></span><span class="keyword" id="3847231">type</span>&nbsp;<span class="ident" id="3847236">DB</span>&nbsp;<span class="keyword" id="3847239">struct</span>&nbsp;<span class="op" id="3847246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847249">driver</span>&nbsp;<span class="ident" id="3847256">driver</span><span class="op" id="3847262">.</span><span class="ident" id="3847263">Driver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847271">dsn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3847278">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847287">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3847300">sync</span><span class="op" id="3847304">.</span><span class="ident" id="3847305">Mutex</span>&nbsp;<span class="comment" id="3847311">//&nbsp;protects&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847341">freeConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3847354">[</span><span class="op" id="3847355">]</span><span class="op" id="3847356">*</span><span class="ident" id="3847357">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847369">connRequests</span>&nbsp;<span class="op" id="3847382">[</span><span class="op" id="3847383">]</span><span class="keyword" id="3847384">chan</span>&nbsp;<span class="ident" id="3847389">connRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847402">numOpen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3847415">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847420">pendingOpens</span>&nbsp;<span class="builtintype" id="3847433">int</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847438">//&nbsp;Used&nbsp;to&nbsp;signal&nbsp;the&nbsp;need&nbsp;for&nbsp;new&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847486">//&nbsp;a&nbsp;goroutine&nbsp;running&nbsp;connectionOpener()&nbsp;reads&nbsp;on&nbsp;this&nbsp;chan&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847552">//&nbsp;maybeOpenNewConnections&nbsp;sends&nbsp;on&nbsp;the&nbsp;chan&nbsp;(one&nbsp;send&nbsp;per&nbsp;needed&nbsp;connection)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847631">//&nbsp;It&nbsp;is&nbsp;closed&nbsp;during&nbsp;db.Close().&nbsp;The&nbsp;close&nbsp;tells&nbsp;the&nbsp;connectionOpener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847704">//&nbsp;goroutine&nbsp;to&nbsp;exit.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847727">openerCh</span>&nbsp;<span class="keyword" id="3847736">chan</span>&nbsp;<span class="keyword" id="3847741">struct</span><span class="op" id="3847747">{</span><span class="op" id="3847748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847751">closed</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3847760">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847766">dep</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3847775">map</span><span class="op" id="3847778">[</span><span class="ident" id="3847779">finalCloser</span><span class="op" id="3847790">]</span><span class="ident" id="3847791">depSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847799">lastPut</span>&nbsp;&nbsp;<span class="keyword" id="3847808">map</span><span class="op" id="3847811">[</span><span class="op" id="3847812">*</span><span class="ident" id="3847813">driverConn</span><span class="op" id="3847823">]</span><span class="builtintype" id="3847824">string</span>&nbsp;<span class="comment" id="3847831">//&nbsp;stacktrace&nbsp;of&nbsp;last&nbsp;conn&#39;s&nbsp;put;&nbsp;debug&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847877">maxIdle</span>&nbsp;&nbsp;<span class="builtintype" id="3847886">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3847909">//&nbsp;zero&nbsp;means&nbsp;defaultMaxIdleConns;&nbsp;negative&nbsp;means&nbsp;0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847962">maxOpen</span>&nbsp;&nbsp;<span class="builtintype" id="3847971">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3847994">//&nbsp;&lt;=&nbsp;0&nbsp;means&nbsp;unlimited</span><br>
<span class="lineno"></span><span class="op" id="3848018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3848021">//&nbsp;driverConn&nbsp;wraps&nbsp;a&nbsp;driver.Conn&nbsp;with&nbsp;a&nbsp;mutex,&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3848072">//&nbsp;be&nbsp;held&nbsp;during&nbsp;all&nbsp;calls&nbsp;into&nbsp;the&nbsp;Conn.&nbsp;(including&nbsp;any&nbsp;calls&nbsp;onto</span><br>
<span class="lineno">235</span><span class="comment" id="3848141">//&nbsp;interfaces&nbsp;returned&nbsp;via&nbsp;that&nbsp;Conn,&nbsp;such&nbsp;as&nbsp;calls&nbsp;on&nbsp;Tx,&nbsp;Stmt,</span><br>
<span class="lineno"></span><span class="comment" id="3848206">//&nbsp;Result,&nbsp;Rows)</span><br>
<span class="lineno"></span><span class="keyword" id="3848223">type</span>&nbsp;<span class="ident" id="3848228">driverConn</span>&nbsp;<span class="keyword" id="3848239">struct</span>&nbsp;<span class="op" id="3848246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848249">db</span>&nbsp;<span class="op" id="3848252">*</span><span class="ident" id="3848253">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848258">sync</span><span class="op" id="3848262">.</span><span class="ident" id="3848263">Mutex</span>&nbsp;&nbsp;<span class="comment" id="3848270">//&nbsp;guards&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848291">ci</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3848303">driver</span><span class="op" id="3848309">.</span><span class="ident" id="3848310">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848316">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3848328">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848334">finalClosed</span>&nbsp;<span class="builtintype" id="3848346">bool</span>&nbsp;<span class="comment" id="3848351">//&nbsp;ci.Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848380">openStmt</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3848392">map</span><span class="op" id="3848395">[</span><span class="ident" id="3848396">driver</span><span class="op" id="3848402">.</span><span class="ident" id="3848403">Stmt</span><span class="op" id="3848407">]</span><span class="builtintype" id="3848408">bool</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3848415">//&nbsp;guarded&nbsp;by&nbsp;db.mu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848436">inUse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3848447">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848453">onPut</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3848464">[</span><span class="op" id="3848465">]</span><span class="keyword" id="3848466">func</span><span class="op" id="3848470">(</span><span class="op" id="3848471">)</span>&nbsp;<span class="comment" id="3848473">//&nbsp;code&nbsp;(with&nbsp;db.mu&nbsp;held)&nbsp;run&nbsp;when&nbsp;conn&nbsp;is&nbsp;next&nbsp;returned</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848531">dbmuClosed</span>&nbsp;<span class="builtintype" id="3848542">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3848551">//&nbsp;same&nbsp;as&nbsp;closed,&nbsp;but&nbsp;guarded&nbsp;by&nbsp;db.mu,&nbsp;for&nbsp;connIfFree</span><br>
<span class="lineno">250</span><span class="op" id="3848607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3848610">func</span>&nbsp;<span class="op" id="3848615">(</span><span class="ident" id="3848616">dc</span>&nbsp;<span class="op" id="3848619">*</span><span class="ident" id="3848620">driverConn</span><span class="op" id="3848630">)</span>&nbsp;<span class="ident" id="3848632">releaseConn</span><span class="op" id="3848643">(</span><span class="ident" id="3848644">err</span>&nbsp;<span class="builtintype" id="3848648">error</span><span class="op" id="3848653">)</span>&nbsp;<span class="op" id="3848655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848658">dc</span><span class="op" id="3848660">.</span><span class="ident" id="3848661">db</span><span class="op" id="3848663">.</span><span class="ident" id="3848664">putConn</span><span class="op" id="3848671">(</span><span class="ident" id="3848672">dc</span><span class="op" id="3848674">,</span>&nbsp;<span class="ident" id="3848676">err</span><span class="op" id="3848679">)</span><br>
<span class="lineno"></span><span class="op" id="3848681">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="3848684">func</span>&nbsp;<span class="op" id="3848689">(</span><span class="ident" id="3848690">dc</span>&nbsp;<span class="op" id="3848693">*</span><span class="ident" id="3848694">driverConn</span><span class="op" id="3848704">)</span>&nbsp;<span class="ident" id="3848706">removeOpenStmt</span><span class="op" id="3848720">(</span><span class="ident" id="3848721">si</span>&nbsp;<span class="ident" id="3848724">driver</span><span class="op" id="3848730">.</span><span class="ident" id="3848731">Stmt</span><span class="op" id="3848735">)</span>&nbsp;<span class="op" id="3848737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848740">dc</span><span class="op" id="3848742">.</span><span class="ident" id="3848743">Lock</span><span class="op" id="3848747">(</span><span class="op" id="3848748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848751">defer</span>&nbsp;<span class="ident" id="3848757">dc</span><span class="op" id="3848759">.</span><span class="ident" id="3848760">Unlock</span><span class="op" id="3848766">(</span><span class="op" id="3848767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3848770">delete</span><span class="op" id="3848776">(</span><span class="ident" id="3848777">dc</span><span class="op" id="3848779">.</span><span class="ident" id="3848780">openStmt</span><span class="op" id="3848788">,</span>&nbsp;<span class="ident" id="3848790">si</span><span class="op" id="3848792">)</span><br>
<span class="lineno">260</span><span class="op" id="3848794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3848797">func</span>&nbsp;<span class="op" id="3848802">(</span><span class="ident" id="3848803">dc</span>&nbsp;<span class="op" id="3848806">*</span><span class="ident" id="3848807">driverConn</span><span class="op" id="3848817">)</span>&nbsp;<span class="ident" id="3848819">prepareLocked</span><span class="op" id="3848832">(</span><span class="ident" id="3848833">query</span>&nbsp;<span class="builtintype" id="3848839">string</span><span class="op" id="3848845">)</span>&nbsp;<span class="op" id="3848847">(</span><span class="ident" id="3848848">driver</span><span class="op" id="3848854">.</span><span class="ident" id="3848855">Stmt</span><span class="op" id="3848859">,</span>&nbsp;<span class="builtintype" id="3848861">error</span><span class="op" id="3848866">)</span>&nbsp;<span class="op" id="3848868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848871">si</span><span class="op" id="3848873">,</span>&nbsp;<span class="ident" id="3848875">err</span>&nbsp;<span class="op" id="3848879">:=</span>&nbsp;<span class="ident" id="3848882">dc</span><span class="op" id="3848884">.</span><span class="ident" id="3848885">ci</span><span class="op" id="3848887">.</span><span class="ident" id="3848888">Prepare</span><span class="op" id="3848895">(</span><span class="ident" id="3848896">query</span><span class="op" id="3848901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848904">if</span>&nbsp;<span class="ident" id="3848907">err</span>&nbsp;<span class="op" id="3848911">==</span>&nbsp;<span class="ident" id="3848914">nil</span>&nbsp;<span class="op" id="3848918">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3848922">//&nbsp;Track&nbsp;each&nbsp;driverConn&#39;s&nbsp;open&nbsp;statements,&nbsp;so&nbsp;we&nbsp;can&nbsp;close&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3848989">//&nbsp;before&nbsp;closing&nbsp;the&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849019">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849024">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;drivers&nbsp;opt&nbsp;out&nbsp;of&nbsp;caring&nbsp;about</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849081">//&nbsp;stmt&nbsp;closes&nbsp;if&nbsp;the&nbsp;conn&nbsp;is&nbsp;about&nbsp;to&nbsp;close&nbsp;anyway?&nbsp;For&nbsp;now</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849144">//&nbsp;do&nbsp;the&nbsp;safe&nbsp;thing,&nbsp;in&nbsp;case&nbsp;stmts&nbsp;need&nbsp;to&nbsp;be&nbsp;closed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849201">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849206">//&nbsp;TODO(bradfitz):&nbsp;after&nbsp;Go&nbsp;1.2,&nbsp;closing&nbsp;driver.Stmts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849262">//&nbsp;should&nbsp;be&nbsp;moved&nbsp;to&nbsp;driverStmt,&nbsp;using&nbsp;unique</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849311">//&nbsp;*driverStmts&nbsp;everywhere&nbsp;(including&nbsp;from</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849356">//&nbsp;*Stmt.connStmt,&nbsp;instead&nbsp;of&nbsp;returning&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849400">//&nbsp;driver.Stmt),&nbsp;using&nbsp;driverStmt&nbsp;as&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849449">//&nbsp;everywhere,&nbsp;and&nbsp;making&nbsp;it&nbsp;a&nbsp;finalCloser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849495">if</span>&nbsp;<span class="ident" id="3849498">dc</span><span class="op" id="3849500">.</span><span class="ident" id="3849501">openStmt</span>&nbsp;<span class="op" id="3849510">==</span>&nbsp;<span class="ident" id="3849513">nil</span>&nbsp;<span class="op" id="3849517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849522">dc</span><span class="op" id="3849524">.</span><span class="ident" id="3849525">openStmt</span>&nbsp;<span class="op" id="3849534">=</span>&nbsp;<span class="builtinfunc" id="3849536">make</span><span class="op" id="3849540">(</span><span class="keyword" id="3849541">map</span><span class="op" id="3849544">[</span><span class="ident" id="3849545">driver</span><span class="op" id="3849551">.</span><span class="ident" id="3849552">Stmt</span><span class="op" id="3849556">]</span><span class="builtintype" id="3849557">bool</span><span class="op" id="3849561">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849569">dc</span><span class="op" id="3849571">.</span><span class="ident" id="3849572">openStmt</span><span class="op" id="3849580">[</span><span class="ident" id="3849581">si</span><span class="op" id="3849583">]</span>&nbsp;<span class="op" id="3849585">=</span>&nbsp;<span class="builtintype" id="3849587">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849596">return</span>&nbsp;<span class="ident" id="3849603">si</span><span class="op" id="3849605">,</span>&nbsp;<span class="ident" id="3849607">err</span><br>
<span class="lineno"></span><span class="op" id="3849611">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="3849614">//&nbsp;the&nbsp;dc.db&#39;s&nbsp;Mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="3849644">func</span>&nbsp;<span class="op" id="3849649">(</span><span class="ident" id="3849650">dc</span>&nbsp;<span class="op" id="3849653">*</span><span class="ident" id="3849654">driverConn</span><span class="op" id="3849664">)</span>&nbsp;<span class="ident" id="3849666">closeDBLocked</span><span class="op" id="3849679">(</span><span class="op" id="3849680">)</span>&nbsp;<span class="keyword" id="3849682">func</span><span class="op" id="3849686">(</span><span class="op" id="3849687">)</span>&nbsp;<span class="builtintype" id="3849689">error</span>&nbsp;<span class="op" id="3849695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849698">dc</span><span class="op" id="3849700">.</span><span class="ident" id="3849701">Lock</span><span class="op" id="3849705">(</span><span class="op" id="3849706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849709">defer</span>&nbsp;<span class="ident" id="3849715">dc</span><span class="op" id="3849717">.</span><span class="ident" id="3849718">Unlock</span><span class="op" id="3849724">(</span><span class="op" id="3849725">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849728">if</span>&nbsp;<span class="ident" id="3849731">dc</span><span class="op" id="3849733">.</span><span class="ident" id="3849734">closed</span>&nbsp;<span class="op" id="3849741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849745">return</span>&nbsp;<span class="keyword" id="3849752">func</span><span class="op" id="3849756">(</span><span class="op" id="3849757">)</span>&nbsp;<span class="builtintype" id="3849759">error</span>&nbsp;<span class="op" id="3849765">{</span>&nbsp;<span class="keyword" id="3849767">return</span>&nbsp;<span class="ident" id="3849774">errors</span><span class="op" id="3849780">.</span><span class="ident" id="3849781">New</span><span class="op" id="3849784">(</span><span class="string" id="3849785">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="3849818">)</span>&nbsp;<span class="op" id="3849820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849826">dc</span><span class="op" id="3849828">.</span><span class="ident" id="3849829">closed</span>&nbsp;<span class="op" id="3849836">=</span>&nbsp;<span class="builtintype" id="3849838">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849844">return</span>&nbsp;<span class="ident" id="3849851">dc</span><span class="op" id="3849853">.</span><span class="ident" id="3849854">db</span><span class="op" id="3849856">.</span><span class="ident" id="3849857">removeDepLocked</span><span class="op" id="3849872">(</span><span class="ident" id="3849873">dc</span><span class="op" id="3849875">,</span>&nbsp;<span class="ident" id="3849877">dc</span><span class="op" id="3849879">)</span><br>
<span class="lineno">295</span><span class="op" id="3849881">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3849884">func</span>&nbsp;<span class="op" id="3849889">(</span><span class="ident" id="3849890">dc</span>&nbsp;<span class="op" id="3849893">*</span><span class="ident" id="3849894">driverConn</span><span class="op" id="3849904">)</span>&nbsp;<span class="ident" id="3849906">Close</span><span class="op" id="3849911">(</span><span class="op" id="3849912">)</span>&nbsp;<span class="builtintype" id="3849914">error</span>&nbsp;<span class="op" id="3849920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849923">dc</span><span class="op" id="3849925">.</span><span class="ident" id="3849926">Lock</span><span class="op" id="3849930">(</span><span class="op" id="3849931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849934">if</span>&nbsp;<span class="ident" id="3849937">dc</span><span class="op" id="3849939">.</span><span class="ident" id="3849940">closed</span>&nbsp;<span class="op" id="3849947">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849951">dc</span><span class="op" id="3849953">.</span><span class="ident" id="3849954">Unlock</span><span class="op" id="3849960">(</span><span class="op" id="3849961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849965">return</span>&nbsp;<span class="ident" id="3849972">errors</span><span class="op" id="3849978">.</span><span class="ident" id="3849979">New</span><span class="op" id="3849982">(</span><span class="string" id="3849983">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="3850016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850022">dc</span><span class="op" id="3850024">.</span><span class="ident" id="3850025">closed</span>&nbsp;<span class="op" id="3850032">=</span>&nbsp;<span class="builtintype" id="3850034">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850040">dc</span><span class="op" id="3850042">.</span><span class="ident" id="3850043">Unlock</span><span class="op" id="3850049">(</span><span class="op" id="3850050">)</span>&nbsp;<span class="comment" id="3850052">//&nbsp;not&nbsp;defer;&nbsp;removeDep&nbsp;finalClose&nbsp;calls&nbsp;may&nbsp;need&nbsp;to&nbsp;lock</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850112">//&nbsp;And&nbsp;now&nbsp;updates&nbsp;that&nbsp;require&nbsp;holding&nbsp;dc.mu.Lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850165">dc</span><span class="op" id="3850167">.</span><span class="ident" id="3850168">db</span><span class="op" id="3850170">.</span><span class="ident" id="3850171">mu</span><span class="op" id="3850173">.</span><span class="ident" id="3850174">Lock</span><span class="op" id="3850178">(</span><span class="op" id="3850179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850182">dc</span><span class="op" id="3850184">.</span><span class="ident" id="3850185">dbmuClosed</span>&nbsp;<span class="op" id="3850196">=</span>&nbsp;<span class="builtintype" id="3850198">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850204">fn</span>&nbsp;<span class="op" id="3850207">:=</span>&nbsp;<span class="ident" id="3850210">dc</span><span class="op" id="3850212">.</span><span class="ident" id="3850213">db</span><span class="op" id="3850215">.</span><span class="ident" id="3850216">removeDepLocked</span><span class="op" id="3850231">(</span><span class="ident" id="3850232">dc</span><span class="op" id="3850234">,</span>&nbsp;<span class="ident" id="3850236">dc</span><span class="op" id="3850238">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850241">dc</span><span class="op" id="3850243">.</span><span class="ident" id="3850244">db</span><span class="op" id="3850246">.</span><span class="ident" id="3850247">mu</span><span class="op" id="3850249">.</span><span class="ident" id="3850250">Unlock</span><span class="op" id="3850256">(</span><span class="op" id="3850257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850260">return</span>&nbsp;<span class="ident" id="3850267">fn</span><span class="op" id="3850269">(</span><span class="op" id="3850270">)</span><br>
<span class="lineno"></span><span class="op" id="3850272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3850275">func</span>&nbsp;<span class="op" id="3850280">(</span><span class="ident" id="3850281">dc</span>&nbsp;<span class="op" id="3850284">*</span><span class="ident" id="3850285">driverConn</span><span class="op" id="3850295">)</span>&nbsp;<span class="ident" id="3850297">finalClose</span><span class="op" id="3850307">(</span><span class="op" id="3850308">)</span>&nbsp;<span class="builtintype" id="3850310">error</span>&nbsp;<span class="op" id="3850316">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850319">dc</span><span class="op" id="3850321">.</span><span class="ident" id="3850322">Lock</span><span class="op" id="3850326">(</span><span class="op" id="3850327">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850331">for</span>&nbsp;<span class="ident" id="3850335">si</span>&nbsp;<span class="op" id="3850338">:=</span>&nbsp;<span class="keyword" id="3850341">range</span>&nbsp;<span class="ident" id="3850347">dc</span><span class="op" id="3850349">.</span><span class="ident" id="3850350">openStmt</span>&nbsp;<span class="op" id="3850359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850363">si</span><span class="op" id="3850365">.</span><span class="ident" id="3850366">Close</span><span class="op" id="3850371">(</span><span class="op" id="3850372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850375">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850378">dc</span><span class="op" id="3850380">.</span><span class="ident" id="3850381">openStmt</span>&nbsp;<span class="op" id="3850390">=</span>&nbsp;<span class="ident" id="3850392">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850398">err</span>&nbsp;<span class="op" id="3850402">:=</span>&nbsp;<span class="ident" id="3850405">dc</span><span class="op" id="3850407">.</span><span class="ident" id="3850408">ci</span><span class="op" id="3850410">.</span><span class="ident" id="3850411">Close</span><span class="op" id="3850416">(</span><span class="op" id="3850417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850420">dc</span><span class="op" id="3850422">.</span><span class="ident" id="3850423">ci</span>&nbsp;<span class="op" id="3850426">=</span>&nbsp;<span class="ident" id="3850428">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850433">dc</span><span class="op" id="3850435">.</span><span class="ident" id="3850436">finalClosed</span>&nbsp;<span class="op" id="3850448">=</span>&nbsp;<span class="builtintype" id="3850450">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850456">dc</span><span class="op" id="3850458">.</span><span class="ident" id="3850459">Unlock</span><span class="op" id="3850465">(</span><span class="op" id="3850466">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850470">dc</span><span class="op" id="3850472">.</span><span class="ident" id="3850473">db</span><span class="op" id="3850475">.</span><span class="ident" id="3850476">mu</span><span class="op" id="3850478">.</span><span class="ident" id="3850479">Lock</span><span class="op" id="3850483">(</span><span class="op" id="3850484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850487">dc</span><span class="op" id="3850489">.</span><span class="ident" id="3850490">db</span><span class="op" id="3850492">.</span><span class="ident" id="3850493">numOpen</span><span class="op" id="3850500">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850504">dc</span><span class="op" id="3850506">.</span><span class="ident" id="3850507">db</span><span class="op" id="3850509">.</span><span class="ident" id="3850510">maybeOpenNewConnections</span><span class="op" id="3850533">(</span><span class="op" id="3850534">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850537">dc</span><span class="op" id="3850539">.</span><span class="ident" id="3850540">db</span><span class="op" id="3850542">.</span><span class="ident" id="3850543">mu</span><span class="op" id="3850545">.</span><span class="ident" id="3850546">Unlock</span><span class="op" id="3850552">(</span><span class="op" id="3850553">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850557">return</span>&nbsp;<span class="ident" id="3850564">err</span><br>
<span class="lineno"></span><span class="op" id="3850568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="3850571">//&nbsp;driverStmt&nbsp;associates&nbsp;a&nbsp;driver.Stmt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3850619">//&nbsp;*driverConn&nbsp;from&nbsp;which&nbsp;it&nbsp;came,&nbsp;so&nbsp;the&nbsp;driverConn&#39;s&nbsp;lock&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3850686">//&nbsp;held&nbsp;during&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="3850708">type</span>&nbsp;<span class="ident" id="3850713">driverStmt</span>&nbsp;<span class="keyword" id="3850724">struct</span>&nbsp;<span class="op" id="3850731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850734">sync</span><span class="op" id="3850738">.</span><span class="ident" id="3850739">Locker</span>&nbsp;<span class="comment" id="3850746">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850766">si</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3850778">driver</span><span class="op" id="3850784">.</span><span class="ident" id="3850785">Stmt</span><br>
<span class="lineno"></span><span class="op" id="3850790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3850793">func</span>&nbsp;<span class="op" id="3850798">(</span><span class="ident" id="3850799">ds</span>&nbsp;<span class="op" id="3850802">*</span><span class="ident" id="3850803">driverStmt</span><span class="op" id="3850813">)</span>&nbsp;<span class="ident" id="3850815">Close</span><span class="op" id="3850820">(</span><span class="op" id="3850821">)</span>&nbsp;<span class="builtintype" id="3850823">error</span>&nbsp;<span class="op" id="3850829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850832">ds</span><span class="op" id="3850834">.</span><span class="ident" id="3850835">Lock</span><span class="op" id="3850839">(</span><span class="op" id="3850840">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850843">defer</span>&nbsp;<span class="ident" id="3850849">ds</span><span class="op" id="3850851">.</span><span class="ident" id="3850852">Unlock</span><span class="op" id="3850858">(</span><span class="op" id="3850859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850862">return</span>&nbsp;<span class="ident" id="3850869">ds</span><span class="op" id="3850871">.</span><span class="ident" id="3850872">si</span><span class="op" id="3850874">.</span><span class="ident" id="3850875">Close</span><span class="op" id="3850880">(</span><span class="op" id="3850881">)</span><br>
<span class="lineno"></span><span class="op" id="3850883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3850886">//&nbsp;depSet&nbsp;is&nbsp;a&nbsp;finalCloser&#39;s&nbsp;outstanding&nbsp;dependencies</span><br>
<span class="lineno">350</span><span class="keyword" id="3850940">type</span>&nbsp;<span class="ident" id="3850945">depSet</span>&nbsp;<span class="keyword" id="3850952">map</span><span class="op" id="3850955">[</span><span class="keyword" id="3850956">interface</span><span class="op" id="3850965">{</span><span class="op" id="3850966">}</span><span class="op" id="3850967">]</span><span class="builtintype" id="3850968">bool</span>&nbsp;<span class="comment" id="3850973">//&nbsp;set&nbsp;of&nbsp;true&nbsp;bools</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3850995">//&nbsp;The&nbsp;finalCloser&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;(*DB).addDep&nbsp;and&nbsp;related</span><br>
<span class="lineno"></span><span class="comment" id="3851060">//&nbsp;dependency&nbsp;reference&nbsp;counting.</span><br>
<span class="lineno"></span><span class="keyword" id="3851094">type</span>&nbsp;<span class="ident" id="3851099">finalCloser</span>&nbsp;<span class="keyword" id="3851111">interface</span>&nbsp;<span class="op" id="3851121">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3851124">//&nbsp;finalClose&nbsp;is&nbsp;called&nbsp;when&nbsp;the&nbsp;reference&nbsp;count&nbsp;of&nbsp;an&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3851187">//&nbsp;goes&nbsp;to&nbsp;zero.&nbsp;(*DB).mu&nbsp;is&nbsp;not&nbsp;held&nbsp;while&nbsp;calling&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851244">finalClose</span><span class="op" id="3851254">(</span><span class="op" id="3851255">)</span>&nbsp;<span class="builtintype" id="3851257">error</span><br>
<span class="lineno"></span><span class="op" id="3851263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="comment" id="3851266">//&nbsp;addDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;now&nbsp;depends&nbsp;on&nbsp;dep,&nbsp;and&nbsp;x&#39;s&nbsp;finalClose&nbsp;won&#39;t&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3851337">//&nbsp;called&nbsp;until&nbsp;all&nbsp;of&nbsp;x&#39;s&nbsp;dependencies&nbsp;are&nbsp;removed&nbsp;with&nbsp;removeDep.</span><br>
<span class="lineno"></span><span class="keyword" id="3851405">func</span>&nbsp;<span class="op" id="3851410">(</span><span class="ident" id="3851411">db</span>&nbsp;<span class="op" id="3851414">*</span><span class="ident" id="3851415">DB</span><span class="op" id="3851417">)</span>&nbsp;<span class="ident" id="3851419">addDep</span><span class="op" id="3851425">(</span><span class="ident" id="3851426">x</span>&nbsp;<span class="ident" id="3851428">finalCloser</span><span class="op" id="3851439">,</span>&nbsp;<span class="ident" id="3851441">dep</span>&nbsp;<span class="keyword" id="3851445">interface</span><span class="op" id="3851454">{</span><span class="op" id="3851455">}</span><span class="op" id="3851456">)</span>&nbsp;<span class="op" id="3851458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3851461">//println(fmt.Sprintf(&#34;addDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851525">db</span><span class="op" id="3851527">.</span><span class="ident" id="3851528">mu</span><span class="op" id="3851530">.</span><span class="ident" id="3851531">Lock</span><span class="op" id="3851535">(</span><span class="op" id="3851536">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851539">defer</span>&nbsp;<span class="ident" id="3851545">db</span><span class="op" id="3851547">.</span><span class="ident" id="3851548">mu</span><span class="op" id="3851550">.</span><span class="ident" id="3851551">Unlock</span><span class="op" id="3851557">(</span><span class="op" id="3851558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851561">db</span><span class="op" id="3851563">.</span><span class="ident" id="3851564">addDepLocked</span><span class="op" id="3851576">(</span><span class="ident" id="3851577">x</span><span class="op" id="3851578">,</span>&nbsp;<span class="ident" id="3851580">dep</span><span class="op" id="3851583">)</span><br>
<span class="lineno"></span><span class="op" id="3851585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3851588">func</span>&nbsp;<span class="op" id="3851593">(</span><span class="ident" id="3851594">db</span>&nbsp;<span class="op" id="3851597">*</span><span class="ident" id="3851598">DB</span><span class="op" id="3851600">)</span>&nbsp;<span class="ident" id="3851602">addDepLocked</span><span class="op" id="3851614">(</span><span class="ident" id="3851615">x</span>&nbsp;<span class="ident" id="3851617">finalCloser</span><span class="op" id="3851628">,</span>&nbsp;<span class="ident" id="3851630">dep</span>&nbsp;<span class="keyword" id="3851634">interface</span><span class="op" id="3851643">{</span><span class="op" id="3851644">}</span><span class="op" id="3851645">)</span>&nbsp;<span class="op" id="3851647">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851650">if</span>&nbsp;<span class="ident" id="3851653">db</span><span class="op" id="3851655">.</span><span class="ident" id="3851656">dep</span>&nbsp;<span class="op" id="3851660">==</span>&nbsp;<span class="ident" id="3851663">nil</span>&nbsp;<span class="op" id="3851667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851671">db</span><span class="op" id="3851673">.</span><span class="ident" id="3851674">dep</span>&nbsp;<span class="op" id="3851678">=</span>&nbsp;<span class="builtinfunc" id="3851680">make</span><span class="op" id="3851684">(</span><span class="keyword" id="3851685">map</span><span class="op" id="3851688">[</span><span class="ident" id="3851689">finalCloser</span><span class="op" id="3851700">]</span><span class="ident" id="3851701">depSet</span><span class="op" id="3851707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3851710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851713">xdep</span>&nbsp;<span class="op" id="3851718">:=</span>&nbsp;<span class="ident" id="3851721">db</span><span class="op" id="3851723">.</span><span class="ident" id="3851724">dep</span><span class="op" id="3851727">[</span><span class="ident" id="3851728">x</span><span class="op" id="3851729">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851732">if</span>&nbsp;<span class="ident" id="3851735">xdep</span>&nbsp;<span class="op" id="3851740">==</span>&nbsp;<span class="ident" id="3851743">nil</span>&nbsp;<span class="op" id="3851747">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851751">xdep</span>&nbsp;<span class="op" id="3851756">=</span>&nbsp;<span class="builtinfunc" id="3851758">make</span><span class="op" id="3851762">(</span><span class="ident" id="3851763">depSet</span><span class="op" id="3851769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851773">db</span><span class="op" id="3851775">.</span><span class="ident" id="3851776">dep</span><span class="op" id="3851779">[</span><span class="ident" id="3851780">x</span><span class="op" id="3851781">]</span>&nbsp;<span class="op" id="3851783">=</span>&nbsp;<span class="ident" id="3851785">xdep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3851791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851794">xdep</span><span class="op" id="3851798">[</span><span class="ident" id="3851799">dep</span><span class="op" id="3851802">]</span>&nbsp;<span class="op" id="3851804">=</span>&nbsp;<span class="builtintype" id="3851806">true</span><br>
<span class="lineno"></span><span class="op" id="3851811">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="3851814">//&nbsp;removeDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;no&nbsp;longer&nbsp;depends&nbsp;on&nbsp;dep.</span><br>
<span class="lineno"></span><span class="comment" id="3851866">//&nbsp;If&nbsp;x&nbsp;still&nbsp;has&nbsp;dependencies,&nbsp;nil&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="3851915">//&nbsp;If&nbsp;x&nbsp;no&nbsp;longer&nbsp;has&nbsp;any&nbsp;dependencies,&nbsp;its&nbsp;finalClose&nbsp;method&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3851985">//&nbsp;called&nbsp;and&nbsp;its&nbsp;error&nbsp;value&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno">385</span><span class="keyword" id="3852033">func</span>&nbsp;<span class="op" id="3852038">(</span><span class="ident" id="3852039">db</span>&nbsp;<span class="op" id="3852042">*</span><span class="ident" id="3852043">DB</span><span class="op" id="3852045">)</span>&nbsp;<span class="ident" id="3852047">removeDep</span><span class="op" id="3852056">(</span><span class="ident" id="3852057">x</span>&nbsp;<span class="ident" id="3852059">finalCloser</span><span class="op" id="3852070">,</span>&nbsp;<span class="ident" id="3852072">dep</span>&nbsp;<span class="keyword" id="3852076">interface</span><span class="op" id="3852085">{</span><span class="op" id="3852086">}</span><span class="op" id="3852087">)</span>&nbsp;<span class="builtintype" id="3852089">error</span>&nbsp;<span class="op" id="3852095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852098">db</span><span class="op" id="3852100">.</span><span class="ident" id="3852101">mu</span><span class="op" id="3852103">.</span><span class="ident" id="3852104">Lock</span><span class="op" id="3852108">(</span><span class="op" id="3852109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852112">fn</span>&nbsp;<span class="op" id="3852115">:=</span>&nbsp;<span class="ident" id="3852118">db</span><span class="op" id="3852120">.</span><span class="ident" id="3852121">removeDepLocked</span><span class="op" id="3852136">(</span><span class="ident" id="3852137">x</span><span class="op" id="3852138">,</span>&nbsp;<span class="ident" id="3852140">dep</span><span class="op" id="3852143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852146">db</span><span class="op" id="3852148">.</span><span class="ident" id="3852149">mu</span><span class="op" id="3852151">.</span><span class="ident" id="3852152">Unlock</span><span class="op" id="3852158">(</span><span class="op" id="3852159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852162">return</span>&nbsp;<span class="ident" id="3852169">fn</span><span class="op" id="3852171">(</span><span class="op" id="3852172">)</span><br>
<span class="lineno">390</span><span class="op" id="3852174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3852177">func</span>&nbsp;<span class="op" id="3852182">(</span><span class="ident" id="3852183">db</span>&nbsp;<span class="op" id="3852186">*</span><span class="ident" id="3852187">DB</span><span class="op" id="3852189">)</span>&nbsp;<span class="ident" id="3852191">removeDepLocked</span><span class="op" id="3852206">(</span><span class="ident" id="3852207">x</span>&nbsp;<span class="ident" id="3852209">finalCloser</span><span class="op" id="3852220">,</span>&nbsp;<span class="ident" id="3852222">dep</span>&nbsp;<span class="keyword" id="3852226">interface</span><span class="op" id="3852235">{</span><span class="op" id="3852236">}</span><span class="op" id="3852237">)</span>&nbsp;<span class="keyword" id="3852239">func</span><span class="op" id="3852243">(</span><span class="op" id="3852244">)</span>&nbsp;<span class="builtintype" id="3852246">error</span>&nbsp;<span class="op" id="3852252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3852255">//println(fmt.Sprintf(&#34;removeDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852323">xdep</span><span class="op" id="3852327">,</span>&nbsp;<span class="ident" id="3852329">ok</span>&nbsp;<span class="op" id="3852332">:=</span>&nbsp;<span class="ident" id="3852335">db</span><span class="op" id="3852337">.</span><span class="ident" id="3852338">dep</span><span class="op" id="3852341">[</span><span class="ident" id="3852342">x</span><span class="op" id="3852343">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852346">if</span>&nbsp;<span class="op" id="3852349">!</span><span class="ident" id="3852350">ok</span>&nbsp;<span class="op" id="3852353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3852357">panic</span><span class="op" id="3852362">(</span><span class="ident" id="3852363">fmt</span><span class="op" id="3852366">.</span><span class="ident" id="3852367">Sprintf</span><span class="op" id="3852374">(</span><span class="string" id="3852375">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;deps&nbsp;for&nbsp;%T&#34;</span><span class="op" id="3852411">,</span>&nbsp;<span class="ident" id="3852413">x</span><span class="op" id="3852414">)</span><span class="op" id="3852415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3852418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852422">l0</span>&nbsp;<span class="op" id="3852425">:=</span>&nbsp;<span class="builtinfunc" id="3852428">len</span><span class="op" id="3852431">(</span><span class="ident" id="3852432">xdep</span><span class="op" id="3852436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3852439">delete</span><span class="op" id="3852445">(</span><span class="ident" id="3852446">xdep</span><span class="op" id="3852450">,</span>&nbsp;<span class="ident" id="3852452">dep</span><span class="op" id="3852455">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852459">switch</span>&nbsp;<span class="builtinfunc" id="3852466">len</span><span class="op" id="3852469">(</span><span class="ident" id="3852470">xdep</span><span class="op" id="3852474">)</span>&nbsp;<span class="op" id="3852476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852479">case</span>&nbsp;<span class="ident" id="3852484">l0</span><span class="op" id="3852486">:</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3852490">//&nbsp;Nothing&nbsp;removed.&nbsp;Shouldn&#39;t&nbsp;happen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3852530">panic</span><span class="op" id="3852535">(</span><span class="ident" id="3852536">fmt</span><span class="op" id="3852539">.</span><span class="ident" id="3852540">Sprintf</span><span class="op" id="3852547">(</span><span class="string" id="3852548">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;%T&nbsp;dep&nbsp;on&nbsp;%T&#34;</span><span class="op" id="3852585">,</span>&nbsp;<span class="ident" id="3852587">dep</span><span class="op" id="3852590">,</span>&nbsp;<span class="ident" id="3852592">x</span><span class="op" id="3852593">)</span><span class="op" id="3852594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852597">case</span>&nbsp;<span class="num" id="3852602">0</span><span class="op" id="3852603">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3852607">//&nbsp;No&nbsp;more&nbsp;dependencies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3852634">delete</span><span class="op" id="3852640">(</span><span class="ident" id="3852641">db</span><span class="op" id="3852643">.</span><span class="ident" id="3852644">dep</span><span class="op" id="3852647">,</span>&nbsp;<span class="ident" id="3852649">x</span><span class="op" id="3852650">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852654">return</span>&nbsp;<span class="ident" id="3852661">x</span><span class="op" id="3852662">.</span><span class="ident" id="3852663">finalClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852675">default</span><span class="op" id="3852682">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3852686">//&nbsp;Dependencies&nbsp;remain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852712">return</span>&nbsp;<span class="keyword" id="3852719">func</span><span class="op" id="3852723">(</span><span class="op" id="3852724">)</span>&nbsp;<span class="builtintype" id="3852726">error</span>&nbsp;<span class="op" id="3852732">{</span>&nbsp;<span class="keyword" id="3852734">return</span>&nbsp;<span class="ident" id="3852741">nil</span>&nbsp;<span class="op" id="3852745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3852748">}</span><br>
<span class="lineno">415</span><span class="op" id="3852750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3852753">//&nbsp;This&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;connectionOpener&nbsp;request&nbsp;chan&nbsp;(dn.openerCh).</span><br>
<span class="lineno"></span><span class="comment" id="3852825">//&nbsp;This&nbsp;value&nbsp;should&nbsp;be&nbsp;larger&nbsp;than&nbsp;the&nbsp;maximum&nbsp;typical&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3852887">//&nbsp;used&nbsp;for&nbsp;db.maxOpen.&nbsp;If&nbsp;maxOpen&nbsp;is&nbsp;significantly&nbsp;larger&nbsp;than</span><br>
<span class="lineno">420</span><span class="comment" id="3852951">//&nbsp;connectionRequestQueueSize&nbsp;then&nbsp;it&nbsp;is&nbsp;possible&nbsp;for&nbsp;ALL&nbsp;calls&nbsp;into&nbsp;the&nbsp;*DB</span><br>
<span class="lineno"></span><span class="comment" id="3853028">//&nbsp;to&nbsp;block&nbsp;until&nbsp;the&nbsp;connectionOpener&nbsp;can&nbsp;satisfy&nbsp;the&nbsp;backlog&nbsp;of&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3853104">var</span>&nbsp;<span class="ident" id="3853108">connectionRequestQueueSize</span>&nbsp;<span class="op" id="3853135">=</span>&nbsp;<span class="num" id="3853137">1000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3853146">//&nbsp;Open&nbsp;opens&nbsp;a&nbsp;database&nbsp;specified&nbsp;by&nbsp;its&nbsp;database&nbsp;driver&nbsp;name&nbsp;and&nbsp;a</span><br>
<span class="lineno">425</span><span class="comment" id="3853215">//&nbsp;driver-specific&nbsp;data&nbsp;source&nbsp;name,&nbsp;usually&nbsp;consisting&nbsp;of&nbsp;at&nbsp;least&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3853285">//&nbsp;database&nbsp;name&nbsp;and&nbsp;connection&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="3853330">//</span><br>
<span class="lineno"></span><span class="comment" id="3853333">//&nbsp;Most&nbsp;users&nbsp;will&nbsp;open&nbsp;a&nbsp;database&nbsp;via&nbsp;a&nbsp;driver-specific&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="3853401">//&nbsp;helper&nbsp;function&nbsp;that&nbsp;returns&nbsp;a&nbsp;*DB.&nbsp;No&nbsp;database&nbsp;drivers&nbsp;are&nbsp;included</span><br>
<span class="lineno">430</span><span class="comment" id="3853473">//&nbsp;in&nbsp;the&nbsp;Go&nbsp;standard&nbsp;library.&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3853543">//&nbsp;a&nbsp;list&nbsp;of&nbsp;third-party&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="comment" id="3853577">//</span><br>
<span class="lineno"></span><span class="comment" id="3853580">//&nbsp;Open&nbsp;may&nbsp;just&nbsp;validate&nbsp;its&nbsp;arguments&nbsp;without&nbsp;creating&nbsp;a&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="3853650">//&nbsp;to&nbsp;the&nbsp;database.&nbsp;To&nbsp;verify&nbsp;that&nbsp;the&nbsp;data&nbsp;source&nbsp;name&nbsp;is&nbsp;valid,&nbsp;call</span><br>
<span class="lineno">435</span><span class="comment" id="3853721">//&nbsp;Ping.</span><br>
<span class="lineno"></span><span class="comment" id="3853730">//</span><br>
<span class="lineno"></span><span class="comment" id="3853733">//&nbsp;The&nbsp;returned&nbsp;DB&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="3853802">//&nbsp;and&nbsp;maintains&nbsp;its&nbsp;own&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;Thus,&nbsp;the&nbsp;Open</span><br>
<span class="lineno"></span><span class="comment" id="3853868">//&nbsp;function&nbsp;should&nbsp;be&nbsp;called&nbsp;just&nbsp;once.&nbsp;It&nbsp;is&nbsp;rarely&nbsp;necessary&nbsp;to</span><br>
<span class="lineno">440</span><span class="comment" id="3853934">//&nbsp;close&nbsp;a&nbsp;DB.</span><br>
<span class="lineno"></span><span class="keyword" id="3853949">func</span>&nbsp;<span class="ident" id="3853954">Open</span><span class="op" id="3853958">(</span><span class="ident" id="3853959">driverName</span><span class="op" id="3853969">,</span>&nbsp;<span class="ident" id="3853971">dataSourceName</span>&nbsp;<span class="builtintype" id="3853986">string</span><span class="op" id="3853992">)</span>&nbsp;<span class="op" id="3853994">(</span><span class="op" id="3853995">*</span><span class="ident" id="3853996">DB</span><span class="op" id="3853998">,</span>&nbsp;<span class="builtintype" id="3854000">error</span><span class="op" id="3854005">)</span>&nbsp;<span class="op" id="3854007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854010">driveri</span><span class="op" id="3854017">,</span>&nbsp;<span class="ident" id="3854019">ok</span>&nbsp;<span class="op" id="3854022">:=</span>&nbsp;<span class="ident" id="3854025">drivers</span><span class="op" id="3854032">[</span><span class="ident" id="3854033">driverName</span><span class="op" id="3854043">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854046">if</span>&nbsp;<span class="op" id="3854049">!</span><span class="ident" id="3854050">ok</span>&nbsp;<span class="op" id="3854053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854057">return</span>&nbsp;<span class="ident" id="3854064">nil</span><span class="op" id="3854067">,</span>&nbsp;<span class="ident" id="3854069">fmt</span><span class="op" id="3854072">.</span><span class="ident" id="3854073">Errorf</span><span class="op" id="3854079">(</span><span class="string" id="3854080">&#34;sql:&nbsp;unknown&nbsp;driver&nbsp;%q&nbsp;(forgotten&nbsp;import?)&#34;</span><span class="op" id="3854124">,</span>&nbsp;<span class="ident" id="3854126">driverName</span><span class="op" id="3854136">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854142">db</span>&nbsp;<span class="op" id="3854145">:=</span>&nbsp;<span class="op" id="3854148">&amp;</span><span class="ident" id="3854149">DB</span><span class="op" id="3854151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854155">driver</span><span class="op" id="3854161">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3854165">driveri</span><span class="op" id="3854172">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854176">dsn</span><span class="op" id="3854179">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3854186">dataSourceName</span><span class="op" id="3854200">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854204">openerCh</span><span class="op" id="3854212">:</span>&nbsp;<span class="builtinfunc" id="3854214">make</span><span class="op" id="3854218">(</span><span class="keyword" id="3854219">chan</span>&nbsp;<span class="keyword" id="3854224">struct</span><span class="op" id="3854230">{</span><span class="op" id="3854231">}</span><span class="op" id="3854232">,</span>&nbsp;<span class="ident" id="3854234">connectionRequestQueueSize</span><span class="op" id="3854260">)</span><span class="op" id="3854261">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854265">lastPut</span><span class="op" id="3854272">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="3854275">make</span><span class="op" id="3854279">(</span><span class="keyword" id="3854280">map</span><span class="op" id="3854283">[</span><span class="op" id="3854284">*</span><span class="ident" id="3854285">driverConn</span><span class="op" id="3854295">]</span><span class="builtintype" id="3854296">string</span><span class="op" id="3854302">)</span><span class="op" id="3854303">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854309">go</span>&nbsp;<span class="ident" id="3854312">db</span><span class="op" id="3854314">.</span><span class="ident" id="3854315">connectionOpener</span><span class="op" id="3854331">(</span><span class="op" id="3854332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854335">return</span>&nbsp;<span class="ident" id="3854342">db</span><span class="op" id="3854344">,</span>&nbsp;<span class="ident" id="3854346">nil</span><br>
<span class="lineno"></span><span class="op" id="3854350">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="3854353">//&nbsp;Ping&nbsp;verifies&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;database&nbsp;is&nbsp;still&nbsp;alive,</span><br>
<span class="lineno"></span><span class="comment" id="3854415">//&nbsp;establishing&nbsp;a&nbsp;connection&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3854458">func</span>&nbsp;<span class="op" id="3854463">(</span><span class="ident" id="3854464">db</span>&nbsp;<span class="op" id="3854467">*</span><span class="ident" id="3854468">DB</span><span class="op" id="3854470">)</span>&nbsp;<span class="ident" id="3854472">Ping</span><span class="op" id="3854476">(</span><span class="op" id="3854477">)</span>&nbsp;<span class="builtintype" id="3854479">error</span>&nbsp;<span class="op" id="3854485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3854488">//&nbsp;TODO(bradfitz):&nbsp;give&nbsp;drivers&nbsp;an&nbsp;optional&nbsp;hook&nbsp;to&nbsp;implement</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3854551">//&nbsp;this&nbsp;in&nbsp;a&nbsp;more&nbsp;efficient&nbsp;or&nbsp;more&nbsp;reliable&nbsp;way,&nbsp;if&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3854610">//&nbsp;have&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854624">dc</span><span class="op" id="3854626">,</span>&nbsp;<span class="ident" id="3854628">err</span>&nbsp;<span class="op" id="3854632">:=</span>&nbsp;<span class="ident" id="3854635">db</span><span class="op" id="3854637">.</span><span class="ident" id="3854638">conn</span><span class="op" id="3854642">(</span><span class="op" id="3854643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854646">if</span>&nbsp;<span class="ident" id="3854649">err</span>&nbsp;<span class="op" id="3854653">!=</span>&nbsp;<span class="ident" id="3854656">nil</span>&nbsp;<span class="op" id="3854660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854664">return</span>&nbsp;<span class="ident" id="3854671">err</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854679">db</span><span class="op" id="3854681">.</span><span class="ident" id="3854682">putConn</span><span class="op" id="3854689">(</span><span class="ident" id="3854690">dc</span><span class="op" id="3854692">,</span>&nbsp;<span class="ident" id="3854694">nil</span><span class="op" id="3854697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854700">return</span>&nbsp;<span class="ident" id="3854707">nil</span><br>
<span class="lineno"></span><span class="op" id="3854711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="comment" id="3854714">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;database,&nbsp;releasing&nbsp;any&nbsp;open&nbsp;resources.</span><br>
<span class="lineno"></span><span class="comment" id="3854774">//</span><br>
<span class="lineno"></span><span class="comment" id="3854777">//&nbsp;It&nbsp;is&nbsp;rare&nbsp;to&nbsp;Close&nbsp;a&nbsp;DB,&nbsp;as&nbsp;the&nbsp;DB&nbsp;handle&nbsp;is&nbsp;meant&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3854838">//&nbsp;long-lived&nbsp;and&nbsp;shared&nbsp;between&nbsp;many&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="3854888">func</span>&nbsp;<span class="op" id="3854893">(</span><span class="ident" id="3854894">db</span>&nbsp;<span class="op" id="3854897">*</span><span class="ident" id="3854898">DB</span><span class="op" id="3854900">)</span>&nbsp;<span class="ident" id="3854902">Close</span><span class="op" id="3854907">(</span><span class="op" id="3854908">)</span>&nbsp;<span class="builtintype" id="3854910">error</span>&nbsp;<span class="op" id="3854916">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854919">db</span><span class="op" id="3854921">.</span><span class="ident" id="3854922">mu</span><span class="op" id="3854924">.</span><span class="ident" id="3854925">Lock</span><span class="op" id="3854929">(</span><span class="op" id="3854930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854933">if</span>&nbsp;<span class="ident" id="3854936">db</span><span class="op" id="3854938">.</span><span class="ident" id="3854939">closed</span>&nbsp;<span class="op" id="3854946">{</span>&nbsp;<span class="comment" id="3854948">//&nbsp;Make&nbsp;DB.Close&nbsp;idempotent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854978">db</span><span class="op" id="3854980">.</span><span class="ident" id="3854981">mu</span><span class="op" id="3854983">.</span><span class="ident" id="3854984">Unlock</span><span class="op" id="3854990">(</span><span class="op" id="3854991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854995">return</span>&nbsp;<span class="ident" id="3855002">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3855007">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3855010">close</span><span class="op" id="3855015">(</span><span class="ident" id="3855016">db</span><span class="op" id="3855018">.</span><span class="ident" id="3855019">openerCh</span><span class="op" id="3855027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855030">var</span>&nbsp;<span class="ident" id="3855034">err</span>&nbsp;<span class="builtintype" id="3855038">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855045">fns</span>&nbsp;<span class="op" id="3855049">:=</span>&nbsp;<span class="builtinfunc" id="3855052">make</span><span class="op" id="3855056">(</span><span class="op" id="3855057">[</span><span class="op" id="3855058">]</span><span class="keyword" id="3855059">func</span><span class="op" id="3855063">(</span><span class="op" id="3855064">)</span>&nbsp;<span class="builtintype" id="3855066">error</span><span class="op" id="3855071">,</span>&nbsp;<span class="num" id="3855073">0</span><span class="op" id="3855074">,</span>&nbsp;<span class="builtinfunc" id="3855076">len</span><span class="op" id="3855079">(</span><span class="ident" id="3855080">db</span><span class="op" id="3855082">.</span><span class="ident" id="3855083">freeConn</span><span class="op" id="3855091">)</span><span class="op" id="3855092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855095">for</span>&nbsp;<span class="ident" id="3855099">_</span><span class="op" id="3855100">,</span>&nbsp;<span class="ident" id="3855102">dc</span>&nbsp;<span class="op" id="3855105">:=</span>&nbsp;<span class="keyword" id="3855108">range</span>&nbsp;<span class="ident" id="3855114">db</span><span class="op" id="3855116">.</span><span class="ident" id="3855117">freeConn</span>&nbsp;<span class="op" id="3855126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855130">fns</span>&nbsp;<span class="op" id="3855134">=</span>&nbsp;<span class="builtinfunc" id="3855136">append</span><span class="op" id="3855142">(</span><span class="ident" id="3855143">fns</span><span class="op" id="3855146">,</span>&nbsp;<span class="ident" id="3855148">dc</span><span class="op" id="3855150">.</span><span class="ident" id="3855151">closeDBLocked</span><span class="op" id="3855164">(</span><span class="op" id="3855165">)</span><span class="op" id="3855166">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3855169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855172">db</span><span class="op" id="3855174">.</span><span class="ident" id="3855175">freeConn</span>&nbsp;<span class="op" id="3855184">=</span>&nbsp;<span class="ident" id="3855186">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855191">db</span><span class="op" id="3855193">.</span><span class="ident" id="3855194">closed</span>&nbsp;<span class="op" id="3855201">=</span>&nbsp;<span class="builtintype" id="3855203">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855209">for</span>&nbsp;<span class="ident" id="3855213">_</span><span class="op" id="3855214">,</span>&nbsp;<span class="ident" id="3855216">req</span>&nbsp;<span class="op" id="3855220">:=</span>&nbsp;<span class="keyword" id="3855223">range</span>&nbsp;<span class="ident" id="3855229">db</span><span class="op" id="3855231">.</span><span class="ident" id="3855232">connRequests</span>&nbsp;<span class="op" id="3855245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3855249">close</span><span class="op" id="3855254">(</span><span class="ident" id="3855255">req</span><span class="op" id="3855258">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3855261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855264">db</span><span class="op" id="3855266">.</span><span class="ident" id="3855267">mu</span><span class="op" id="3855269">.</span><span class="ident" id="3855270">Unlock</span><span class="op" id="3855276">(</span><span class="op" id="3855277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855280">for</span>&nbsp;<span class="ident" id="3855284">_</span><span class="op" id="3855285">,</span>&nbsp;<span class="ident" id="3855287">fn</span>&nbsp;<span class="op" id="3855290">:=</span>&nbsp;<span class="keyword" id="3855293">range</span>&nbsp;<span class="ident" id="3855299">fns</span>&nbsp;<span class="op" id="3855303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855307">err1</span>&nbsp;<span class="op" id="3855312">:=</span>&nbsp;<span class="ident" id="3855315">fn</span><span class="op" id="3855317">(</span><span class="op" id="3855318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855322">if</span>&nbsp;<span class="ident" id="3855325">err1</span>&nbsp;<span class="op" id="3855330">!=</span>&nbsp;<span class="ident" id="3855333">nil</span>&nbsp;<span class="op" id="3855337">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855342">err</span>&nbsp;<span class="op" id="3855346">=</span>&nbsp;<span class="ident" id="3855348">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3855355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3855358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855361">return</span>&nbsp;<span class="ident" id="3855368">err</span><br>
<span class="lineno"></span><span class="op" id="3855372">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="3855375">const</span>&nbsp;<span class="ident" id="3855381">defaultMaxIdleConns</span>&nbsp;<span class="op" id="3855401">=</span>&nbsp;<span class="num" id="3855403">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3855406">func</span>&nbsp;<span class="op" id="3855411">(</span><span class="ident" id="3855412">db</span>&nbsp;<span class="op" id="3855415">*</span><span class="ident" id="3855416">DB</span><span class="op" id="3855418">)</span>&nbsp;<span class="ident" id="3855420">maxIdleConnsLocked</span><span class="op" id="3855438">(</span><span class="op" id="3855439">)</span>&nbsp;<span class="builtintype" id="3855441">int</span>&nbsp;<span class="op" id="3855445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855448">n</span>&nbsp;<span class="op" id="3855450">:=</span>&nbsp;<span class="ident" id="3855453">db</span><span class="op" id="3855455">.</span><span class="ident" id="3855456">maxIdle</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855465">switch</span>&nbsp;<span class="op" id="3855472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855475">case</span>&nbsp;<span class="ident" id="3855480">n</span>&nbsp;<span class="op" id="3855482">==</span>&nbsp;<span class="num" id="3855485">0</span><span class="op" id="3855486">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3855490">//&nbsp;TODO(bradfitz):&nbsp;ask&nbsp;driver,&nbsp;if&nbsp;supported,&nbsp;for&nbsp;its&nbsp;default&nbsp;preference</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855564">return</span>&nbsp;<span class="ident" id="3855571">defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855592">case</span>&nbsp;<span class="ident" id="3855597">n</span>&nbsp;<span class="op" id="3855599">&lt;</span>&nbsp;<span class="num" id="3855601">0</span><span class="op" id="3855602">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855606">return</span>&nbsp;<span class="num" id="3855613">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855616">default</span><span class="op" id="3855623">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855627">return</span>&nbsp;<span class="ident" id="3855634">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3855637">}</span><br>
<span class="lineno"></span><span class="op" id="3855639">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span><span class="comment" id="3855642">//&nbsp;SetMaxIdleConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;connections&nbsp;in&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="3855712">//&nbsp;connection&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="3855732">//</span><br>
<span class="lineno"></span><span class="comment" id="3855735">//&nbsp;If&nbsp;MaxOpenConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;but&nbsp;less&nbsp;than&nbsp;the&nbsp;new&nbsp;MaxIdleConns</span><br>
<span class="lineno">520</span><span class="comment" id="3855807">//&nbsp;then&nbsp;the&nbsp;new&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="3855884">//</span><br>
<span class="lineno"></span><span class="comment" id="3855887">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;no&nbsp;idle&nbsp;connections&nbsp;are&nbsp;retained.</span><br>
<span class="lineno"></span><span class="keyword" id="3855935">func</span>&nbsp;<span class="op" id="3855940">(</span><span class="ident" id="3855941">db</span>&nbsp;<span class="op" id="3855944">*</span><span class="ident" id="3855945">DB</span><span class="op" id="3855947">)</span>&nbsp;<span class="ident" id="3855949">SetMaxIdleConns</span><span class="op" id="3855964">(</span><span class="ident" id="3855965">n</span>&nbsp;<span class="builtintype" id="3855967">int</span><span class="op" id="3855970">)</span>&nbsp;<span class="op" id="3855972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855975">db</span><span class="op" id="3855977">.</span><span class="ident" id="3855978">mu</span><span class="op" id="3855980">.</span><span class="ident" id="3855981">Lock</span><span class="op" id="3855985">(</span><span class="op" id="3855986">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855989">if</span>&nbsp;<span class="ident" id="3855992">n</span>&nbsp;<span class="op" id="3855994">&gt;</span>&nbsp;<span class="num" id="3855996">0</span>&nbsp;<span class="op" id="3855998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856002">db</span><span class="op" id="3856004">.</span><span class="ident" id="3856005">maxIdle</span>&nbsp;<span class="op" id="3856013">=</span>&nbsp;<span class="ident" id="3856015">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856018">}</span>&nbsp;<span class="keyword" id="3856020">else</span>&nbsp;<span class="op" id="3856025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3856029">//&nbsp;No&nbsp;idle&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856055">db</span><span class="op" id="3856057">.</span><span class="ident" id="3856058">maxIdle</span>&nbsp;<span class="op" id="3856066">=</span>&nbsp;<span class="op" id="3856068">-</span><span class="num" id="3856069">1</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3856075">//&nbsp;Make&nbsp;sure&nbsp;maxIdle&nbsp;doesn&#39;t&nbsp;exceed&nbsp;maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856120">if</span>&nbsp;<span class="ident" id="3856123">db</span><span class="op" id="3856125">.</span><span class="ident" id="3856126">maxOpen</span>&nbsp;<span class="op" id="3856134">&gt;</span>&nbsp;<span class="num" id="3856136">0</span>&nbsp;<span class="op" id="3856138">&amp;&amp;</span>&nbsp;<span class="ident" id="3856141">db</span><span class="op" id="3856143">.</span><span class="ident" id="3856144">maxIdleConnsLocked</span><span class="op" id="3856162">(</span><span class="op" id="3856163">)</span>&nbsp;<span class="op" id="3856165">&gt;</span>&nbsp;<span class="ident" id="3856167">db</span><span class="op" id="3856169">.</span><span class="ident" id="3856170">maxOpen</span>&nbsp;<span class="op" id="3856178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856182">db</span><span class="op" id="3856184">.</span><span class="ident" id="3856185">maxIdle</span>&nbsp;<span class="op" id="3856193">=</span>&nbsp;<span class="ident" id="3856195">db</span><span class="op" id="3856197">.</span><span class="ident" id="3856198">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856207">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856210">var</span>&nbsp;<span class="ident" id="3856214">closing</span>&nbsp;<span class="op" id="3856222">[</span><span class="op" id="3856223">]</span><span class="op" id="3856224">*</span><span class="ident" id="3856225">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856237">idleCount</span>&nbsp;<span class="op" id="3856247">:=</span>&nbsp;<span class="builtinfunc" id="3856250">len</span><span class="op" id="3856253">(</span><span class="ident" id="3856254">db</span><span class="op" id="3856256">.</span><span class="ident" id="3856257">freeConn</span><span class="op" id="3856265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856268">maxIdle</span>&nbsp;<span class="op" id="3856276">:=</span>&nbsp;<span class="ident" id="3856279">db</span><span class="op" id="3856281">.</span><span class="ident" id="3856282">maxIdleConnsLocked</span><span class="op" id="3856300">(</span><span class="op" id="3856301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856304">if</span>&nbsp;<span class="ident" id="3856307">idleCount</span>&nbsp;<span class="op" id="3856317">&gt;</span>&nbsp;<span class="ident" id="3856319">maxIdle</span>&nbsp;<span class="op" id="3856327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856331">closing</span>&nbsp;<span class="op" id="3856339">=</span>&nbsp;<span class="ident" id="3856341">db</span><span class="op" id="3856343">.</span><span class="ident" id="3856344">freeConn</span><span class="op" id="3856352">[</span><span class="ident" id="3856353">maxIdle</span><span class="op" id="3856360">:</span><span class="op" id="3856361">]</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856365">db</span><span class="op" id="3856367">.</span><span class="ident" id="3856368">freeConn</span>&nbsp;<span class="op" id="3856377">=</span>&nbsp;<span class="ident" id="3856379">db</span><span class="op" id="3856381">.</span><span class="ident" id="3856382">freeConn</span><span class="op" id="3856390">[</span><span class="op" id="3856391">:</span><span class="ident" id="3856392">maxIdle</span><span class="op" id="3856399">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856405">db</span><span class="op" id="3856407">.</span><span class="ident" id="3856408">mu</span><span class="op" id="3856410">.</span><span class="ident" id="3856411">Unlock</span><span class="op" id="3856417">(</span><span class="op" id="3856418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856421">for</span>&nbsp;<span class="ident" id="3856425">_</span><span class="op" id="3856426">,</span>&nbsp;<span class="ident" id="3856428">c</span>&nbsp;<span class="op" id="3856430">:=</span>&nbsp;<span class="keyword" id="3856433">range</span>&nbsp;<span class="ident" id="3856439">closing</span>&nbsp;<span class="op" id="3856447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856451">c</span><span class="op" id="3856452">.</span><span class="ident" id="3856453">Close</span><span class="op" id="3856458">(</span><span class="op" id="3856459">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856462">}</span><br>
<span class="lineno"></span><span class="op" id="3856464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3856467">//&nbsp;SetMaxOpenConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;the&nbsp;database.</span><br>
<span class="lineno"></span><span class="comment" id="3856547">//</span><br>
<span class="lineno">550</span><span class="comment" id="3856550">//&nbsp;If&nbsp;MaxIdleConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;and&nbsp;the&nbsp;new&nbsp;MaxOpenConns&nbsp;is&nbsp;less&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="3856625">//&nbsp;MaxIdleConns,&nbsp;then&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="3856693">//&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="3856715">//</span><br>
<span class="lineno"></span><span class="comment" id="3856718">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;limit&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections.</span><br>
<span class="lineno">555</span><span class="comment" id="3856790">//&nbsp;The&nbsp;default&nbsp;is&nbsp;0&nbsp;(unlimited).</span><br>
<span class="lineno"></span><span class="keyword" id="3856823">func</span>&nbsp;<span class="op" id="3856828">(</span><span class="ident" id="3856829">db</span>&nbsp;<span class="op" id="3856832">*</span><span class="ident" id="3856833">DB</span><span class="op" id="3856835">)</span>&nbsp;<span class="ident" id="3856837">SetMaxOpenConns</span><span class="op" id="3856852">(</span><span class="ident" id="3856853">n</span>&nbsp;<span class="builtintype" id="3856855">int</span><span class="op" id="3856858">)</span>&nbsp;<span class="op" id="3856860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856863">db</span><span class="op" id="3856865">.</span><span class="ident" id="3856866">mu</span><span class="op" id="3856868">.</span><span class="ident" id="3856869">Lock</span><span class="op" id="3856873">(</span><span class="op" id="3856874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856877">db</span><span class="op" id="3856879">.</span><span class="ident" id="3856880">maxOpen</span>&nbsp;<span class="op" id="3856888">=</span>&nbsp;<span class="ident" id="3856890">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856893">if</span>&nbsp;<span class="ident" id="3856896">n</span>&nbsp;<span class="op" id="3856898">&lt;</span>&nbsp;<span class="num" id="3856900">0</span>&nbsp;<span class="op" id="3856902">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856906">db</span><span class="op" id="3856908">.</span><span class="ident" id="3856909">maxOpen</span>&nbsp;<span class="op" id="3856917">=</span>&nbsp;<span class="num" id="3856919">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856925">syncMaxIdle</span>&nbsp;<span class="op" id="3856937">:=</span>&nbsp;<span class="ident" id="3856940">db</span><span class="op" id="3856942">.</span><span class="ident" id="3856943">maxOpen</span>&nbsp;<span class="op" id="3856951">&gt;</span>&nbsp;<span class="num" id="3856953">0</span>&nbsp;<span class="op" id="3856955">&amp;&amp;</span>&nbsp;<span class="ident" id="3856958">db</span><span class="op" id="3856960">.</span><span class="ident" id="3856961">maxIdleConnsLocked</span><span class="op" id="3856979">(</span><span class="op" id="3856980">)</span>&nbsp;<span class="op" id="3856982">&gt;</span>&nbsp;<span class="ident" id="3856984">db</span><span class="op" id="3856986">.</span><span class="ident" id="3856987">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856996">db</span><span class="op" id="3856998">.</span><span class="ident" id="3856999">mu</span><span class="op" id="3857001">.</span><span class="ident" id="3857002">Unlock</span><span class="op" id="3857008">(</span><span class="op" id="3857009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857012">if</span>&nbsp;<span class="ident" id="3857015">syncMaxIdle</span>&nbsp;<span class="op" id="3857027">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857031">db</span><span class="op" id="3857033">.</span><span class="ident" id="3857034">SetMaxIdleConns</span><span class="op" id="3857049">(</span><span class="ident" id="3857050">n</span><span class="op" id="3857051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857054">}</span><br>
<span class="lineno"></span><span class="op" id="3857056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3857059">//&nbsp;Assumes&nbsp;db.mu&nbsp;is&nbsp;locked.</span><br>
<span class="lineno">570</span><span class="comment" id="3857087">//&nbsp;If&nbsp;there&nbsp;are&nbsp;connRequests&nbsp;and&nbsp;the&nbsp;connection&nbsp;limit&nbsp;hasn&#39;t&nbsp;been&nbsp;reached,</span><br>
<span class="lineno"></span><span class="comment" id="3857162">//&nbsp;then&nbsp;tell&nbsp;the&nbsp;connectionOpener&nbsp;to&nbsp;open&nbsp;new&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3857221">func</span>&nbsp;<span class="op" id="3857226">(</span><span class="ident" id="3857227">db</span>&nbsp;<span class="op" id="3857230">*</span><span class="ident" id="3857231">DB</span><span class="op" id="3857233">)</span>&nbsp;<span class="ident" id="3857235">maybeOpenNewConnections</span><span class="op" id="3857258">(</span><span class="op" id="3857259">)</span>&nbsp;<span class="op" id="3857261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857264">numRequests</span>&nbsp;<span class="op" id="3857276">:=</span>&nbsp;<span class="builtinfunc" id="3857279">len</span><span class="op" id="3857282">(</span><span class="ident" id="3857283">db</span><span class="op" id="3857285">.</span><span class="ident" id="3857286">connRequests</span><span class="op" id="3857298">)</span>&nbsp;<span class="op" id="3857300">-</span>&nbsp;<span class="ident" id="3857302">db</span><span class="op" id="3857304">.</span><span class="ident" id="3857305">pendingOpens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857319">if</span>&nbsp;<span class="ident" id="3857322">db</span><span class="op" id="3857324">.</span><span class="ident" id="3857325">maxOpen</span>&nbsp;<span class="op" id="3857333">&gt;</span>&nbsp;<span class="num" id="3857335">0</span>&nbsp;<span class="op" id="3857337">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857341">numCanOpen</span>&nbsp;<span class="op" id="3857352">:=</span>&nbsp;<span class="ident" id="3857355">db</span><span class="op" id="3857357">.</span><span class="ident" id="3857358">maxOpen</span>&nbsp;<span class="op" id="3857366">-</span>&nbsp;<span class="op" id="3857368">(</span><span class="ident" id="3857369">db</span><span class="op" id="3857371">.</span><span class="ident" id="3857372">numOpen</span>&nbsp;<span class="op" id="3857380">+</span>&nbsp;<span class="ident" id="3857382">db</span><span class="op" id="3857384">.</span><span class="ident" id="3857385">pendingOpens</span><span class="op" id="3857397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857401">if</span>&nbsp;<span class="ident" id="3857404">numRequests</span>&nbsp;<span class="op" id="3857416">&gt;</span>&nbsp;<span class="ident" id="3857418">numCanOpen</span>&nbsp;<span class="op" id="3857429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857434">numRequests</span>&nbsp;<span class="op" id="3857446">=</span>&nbsp;<span class="ident" id="3857448">numCanOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857464">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857467">for</span>&nbsp;<span class="ident" id="3857471">numRequests</span>&nbsp;<span class="op" id="3857483">&gt;</span>&nbsp;<span class="num" id="3857485">0</span>&nbsp;<span class="op" id="3857487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857491">db</span><span class="op" id="3857493">.</span><span class="ident" id="3857494">pendingOpens</span><span class="op" id="3857506">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857511">numRequests</span><span class="op" id="3857522">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857527">db</span><span class="op" id="3857529">.</span><span class="ident" id="3857530">openerCh</span>&nbsp;<span class="op" id="3857539">&lt;-</span>&nbsp;<span class="keyword" id="3857542">struct</span><span class="op" id="3857548">{</span><span class="op" id="3857549">}</span><span class="op" id="3857550">{</span><span class="op" id="3857551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857554">}</span><br>
<span class="lineno">585</span><span class="op" id="3857556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3857559">//&nbsp;Runs&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine,&nbsp;opens&nbsp;new&nbsp;connections&nbsp;when&nbsp;requested.</span><br>
<span class="lineno"></span><span class="keyword" id="3857630">func</span>&nbsp;<span class="op" id="3857635">(</span><span class="ident" id="3857636">db</span>&nbsp;<span class="op" id="3857639">*</span><span class="ident" id="3857640">DB</span><span class="op" id="3857642">)</span>&nbsp;<span class="ident" id="3857644">connectionOpener</span><span class="op" id="3857660">(</span><span class="op" id="3857661">)</span>&nbsp;<span class="op" id="3857663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857666">for</span>&nbsp;<span class="keyword" id="3857670">range</span>&nbsp;<span class="ident" id="3857676">db</span><span class="op" id="3857678">.</span><span class="ident" id="3857679">openerCh</span>&nbsp;<span class="op" id="3857688">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857692">db</span><span class="op" id="3857694">.</span><span class="ident" id="3857695">openNewConnection</span><span class="op" id="3857712">(</span><span class="op" id="3857713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857716">}</span><br>
<span class="lineno"></span><span class="op" id="3857718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3857721">//&nbsp;Open&nbsp;one&nbsp;new&nbsp;connection</span><br>
<span class="lineno">595</span><span class="keyword" id="3857748">func</span>&nbsp;<span class="op" id="3857753">(</span><span class="ident" id="3857754">db</span>&nbsp;<span class="op" id="3857757">*</span><span class="ident" id="3857758">DB</span><span class="op" id="3857760">)</span>&nbsp;<span class="ident" id="3857762">openNewConnection</span><span class="op" id="3857779">(</span><span class="op" id="3857780">)</span>&nbsp;<span class="op" id="3857782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857785">ci</span><span class="op" id="3857787">,</span>&nbsp;<span class="ident" id="3857789">err</span>&nbsp;<span class="op" id="3857793">:=</span>&nbsp;<span class="ident" id="3857796">db</span><span class="op" id="3857798">.</span><span class="ident" id="3857799">driver</span><span class="op" id="3857805">.</span><span class="ident" id="3857806">Open</span><span class="op" id="3857810">(</span><span class="ident" id="3857811">db</span><span class="op" id="3857813">.</span><span class="ident" id="3857814">dsn</span><span class="op" id="3857817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857820">db</span><span class="op" id="3857822">.</span><span class="ident" id="3857823">mu</span><span class="op" id="3857825">.</span><span class="ident" id="3857826">Lock</span><span class="op" id="3857830">(</span><span class="op" id="3857831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857834">defer</span>&nbsp;<span class="ident" id="3857840">db</span><span class="op" id="3857842">.</span><span class="ident" id="3857843">mu</span><span class="op" id="3857845">.</span><span class="ident" id="3857846">Unlock</span><span class="op" id="3857852">(</span><span class="op" id="3857853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857856">if</span>&nbsp;<span class="ident" id="3857859">db</span><span class="op" id="3857861">.</span><span class="ident" id="3857862">closed</span>&nbsp;<span class="op" id="3857869">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857873">if</span>&nbsp;<span class="ident" id="3857876">err</span>&nbsp;<span class="op" id="3857880">==</span>&nbsp;<span class="ident" id="3857883">nil</span>&nbsp;<span class="op" id="3857887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857892">ci</span><span class="op" id="3857894">.</span><span class="ident" id="3857895">Close</span><span class="op" id="3857900">(</span><span class="op" id="3857901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857909">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857917">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857920">db</span><span class="op" id="3857922">.</span><span class="ident" id="3857923">pendingOpens</span><span class="op" id="3857935">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857939">if</span>&nbsp;<span class="ident" id="3857942">err</span>&nbsp;<span class="op" id="3857946">!=</span>&nbsp;<span class="ident" id="3857949">nil</span>&nbsp;<span class="op" id="3857953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857957">db</span><span class="op" id="3857959">.</span><span class="ident" id="3857960">putConnDBLocked</span><span class="op" id="3857975">(</span><span class="ident" id="3857976">nil</span><span class="op" id="3857979">,</span>&nbsp;<span class="ident" id="3857981">err</span><span class="op" id="3857984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857988">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857996">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857999">dc</span>&nbsp;<span class="op" id="3858002">:=</span>&nbsp;<span class="op" id="3858005">&amp;</span><span class="ident" id="3858006">driverConn</span><span class="op" id="3858016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858020">db</span><span class="op" id="3858022">:</span>&nbsp;<span class="ident" id="3858024">db</span><span class="op" id="3858026">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858030">ci</span><span class="op" id="3858032">:</span>&nbsp;<span class="ident" id="3858034">ci</span><span class="op" id="3858036">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3858039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858042">if</span>&nbsp;<span class="ident" id="3858045">db</span><span class="op" id="3858047">.</span><span class="ident" id="3858048">putConnDBLocked</span><span class="op" id="3858063">(</span><span class="ident" id="3858064">dc</span><span class="op" id="3858066">,</span>&nbsp;<span class="ident" id="3858068">err</span><span class="op" id="3858071">)</span>&nbsp;<span class="op" id="3858073">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858077">db</span><span class="op" id="3858079">.</span><span class="ident" id="3858080">addDepLocked</span><span class="op" id="3858092">(</span><span class="ident" id="3858093">dc</span><span class="op" id="3858095">,</span>&nbsp;<span class="ident" id="3858097">dc</span><span class="op" id="3858099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858103">db</span><span class="op" id="3858105">.</span><span class="ident" id="3858106">numOpen</span><span class="op" id="3858113">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3858117">}</span>&nbsp;<span class="keyword" id="3858119">else</span>&nbsp;<span class="op" id="3858124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858128">ci</span><span class="op" id="3858130">.</span><span class="ident" id="3858131">Close</span><span class="op" id="3858136">(</span><span class="op" id="3858137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3858140">}</span><br>
<span class="lineno">620</span><span class="op" id="3858142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3858145">//&nbsp;connRequest&nbsp;represents&nbsp;one&nbsp;request&nbsp;for&nbsp;a&nbsp;new&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="3858204">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;idle&nbsp;connections&nbsp;available,&nbsp;DB.conn&nbsp;will&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="3858273">//&nbsp;a&nbsp;new&nbsp;connRequest&nbsp;and&nbsp;put&nbsp;it&nbsp;on&nbsp;the&nbsp;db.connRequests&nbsp;list.</span><br>
<span class="lineno">625</span><span class="keyword" id="3858334">type</span>&nbsp;<span class="ident" id="3858339">connRequest</span>&nbsp;<span class="keyword" id="3858351">struct</span>&nbsp;<span class="op" id="3858358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858361">conn</span>&nbsp;<span class="op" id="3858366">*</span><span class="ident" id="3858367">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858379">err</span>&nbsp;&nbsp;<span class="builtintype" id="3858384">error</span><br>
<span class="lineno"></span><span class="op" id="3858390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="3858393">var</span>&nbsp;<span class="ident" id="3858397">errDBClosed</span>&nbsp;<span class="op" id="3858409">=</span>&nbsp;<span class="ident" id="3858411">errors</span><span class="op" id="3858417">.</span><span class="ident" id="3858418">New</span><span class="op" id="3858421">(</span><span class="string" id="3858422">&#34;sql:&nbsp;database&nbsp;is&nbsp;closed&#34;</span><span class="op" id="3858447">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3858450">//&nbsp;conn&nbsp;returns&nbsp;a&nbsp;newly-opened&nbsp;or&nbsp;cached&nbsp;*driverConn</span><br>
<span class="lineno"></span><span class="keyword" id="3858503">func</span>&nbsp;<span class="op" id="3858508">(</span><span class="ident" id="3858509">db</span>&nbsp;<span class="op" id="3858512">*</span><span class="ident" id="3858513">DB</span><span class="op" id="3858515">)</span>&nbsp;<span class="ident" id="3858517">conn</span><span class="op" id="3858521">(</span><span class="op" id="3858522">)</span>&nbsp;<span class="op" id="3858524">(</span><span class="op" id="3858525">*</span><span class="ident" id="3858526">driverConn</span><span class="op" id="3858536">,</span>&nbsp;<span class="builtintype" id="3858538">error</span><span class="op" id="3858543">)</span>&nbsp;<span class="op" id="3858545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858548">db</span><span class="op" id="3858550">.</span><span class="ident" id="3858551">mu</span><span class="op" id="3858553">.</span><span class="ident" id="3858554">Lock</span><span class="op" id="3858558">(</span><span class="op" id="3858559">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858562">if</span>&nbsp;<span class="ident" id="3858565">db</span><span class="op" id="3858567">.</span><span class="ident" id="3858568">closed</span>&nbsp;<span class="op" id="3858575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858579">db</span><span class="op" id="3858581">.</span><span class="ident" id="3858582">mu</span><span class="op" id="3858584">.</span><span class="ident" id="3858585">Unlock</span><span class="op" id="3858591">(</span><span class="op" id="3858592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858596">return</span>&nbsp;<span class="ident" id="3858603">nil</span><span class="op" id="3858606">,</span>&nbsp;<span class="ident" id="3858608">errDBClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3858621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858625">//&nbsp;If&nbsp;db.maxOpen&nbsp;&gt;&nbsp;0&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;is&nbsp;over&nbsp;the&nbsp;limit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858700">//&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;free&nbsp;connection,&nbsp;make&nbsp;a&nbsp;request&nbsp;and&nbsp;wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858763">if</span>&nbsp;<span class="ident" id="3858766">db</span><span class="op" id="3858768">.</span><span class="ident" id="3858769">maxOpen</span>&nbsp;<span class="op" id="3858777">&gt;</span>&nbsp;<span class="num" id="3858779">0</span>&nbsp;<span class="op" id="3858781">&amp;&amp;</span>&nbsp;<span class="ident" id="3858784">db</span><span class="op" id="3858786">.</span><span class="ident" id="3858787">numOpen</span>&nbsp;<span class="op" id="3858795">&gt;=</span>&nbsp;<span class="ident" id="3858798">db</span><span class="op" id="3858800">.</span><span class="ident" id="3858801">maxOpen</span>&nbsp;<span class="op" id="3858809">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3858812">len</span><span class="op" id="3858815">(</span><span class="ident" id="3858816">db</span><span class="op" id="3858818">.</span><span class="ident" id="3858819">freeConn</span><span class="op" id="3858827">)</span>&nbsp;<span class="op" id="3858829">==</span>&nbsp;<span class="num" id="3858832">0</span>&nbsp;<span class="op" id="3858834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858838">//&nbsp;Make&nbsp;the&nbsp;connRequest&nbsp;channel.&nbsp;It&#39;s&nbsp;buffered&nbsp;so&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858899">//&nbsp;connectionOpener&nbsp;doesn&#39;t&nbsp;block&nbsp;while&nbsp;waiting&nbsp;for&nbsp;the&nbsp;req&nbsp;to&nbsp;be&nbsp;read.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858973">req</span>&nbsp;<span class="op" id="3858977">:=</span>&nbsp;<span class="builtinfunc" id="3858980">make</span><span class="op" id="3858984">(</span><span class="keyword" id="3858985">chan</span>&nbsp;<span class="ident" id="3858990">connRequest</span><span class="op" id="3859001">,</span>&nbsp;<span class="num" id="3859003">1</span><span class="op" id="3859004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859008">db</span><span class="op" id="3859010">.</span><span class="ident" id="3859011">connRequests</span>&nbsp;<span class="op" id="3859024">=</span>&nbsp;<span class="builtinfunc" id="3859026">append</span><span class="op" id="3859032">(</span><span class="ident" id="3859033">db</span><span class="op" id="3859035">.</span><span class="ident" id="3859036">connRequests</span><span class="op" id="3859048">,</span>&nbsp;<span class="ident" id="3859050">req</span><span class="op" id="3859053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859057">db</span><span class="op" id="3859059">.</span><span class="ident" id="3859060">maybeOpenNewConnections</span><span class="op" id="3859083">(</span><span class="op" id="3859084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859088">db</span><span class="op" id="3859090">.</span><span class="ident" id="3859091">mu</span><span class="op" id="3859093">.</span><span class="ident" id="3859094">Unlock</span><span class="op" id="3859100">(</span><span class="op" id="3859101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859105">ret</span>&nbsp;<span class="op" id="3859109">:=</span>&nbsp;<span class="op" id="3859112">&lt;-</span><span class="ident" id="3859114">req</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859120">return</span>&nbsp;<span class="ident" id="3859127">ret</span><span class="op" id="3859130">.</span><span class="ident" id="3859131">conn</span><span class="op" id="3859135">,</span>&nbsp;<span class="ident" id="3859137">ret</span><span class="op" id="3859140">.</span><span class="ident" id="3859141">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859150">if</span>&nbsp;<span class="ident" id="3859153">c</span>&nbsp;<span class="op" id="3859155">:=</span>&nbsp;<span class="builtinfunc" id="3859158">len</span><span class="op" id="3859161">(</span><span class="ident" id="3859162">db</span><span class="op" id="3859164">.</span><span class="ident" id="3859165">freeConn</span><span class="op" id="3859173">)</span><span class="op" id="3859174">;</span>&nbsp;<span class="ident" id="3859176">c</span>&nbsp;<span class="op" id="3859178">&gt;</span>&nbsp;<span class="num" id="3859180">0</span>&nbsp;<span class="op" id="3859182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859186">conn</span>&nbsp;<span class="op" id="3859191">:=</span>&nbsp;<span class="ident" id="3859194">db</span><span class="op" id="3859196">.</span><span class="ident" id="3859197">freeConn</span><span class="op" id="3859205">[</span><span class="num" id="3859206">0</span><span class="op" id="3859207">]</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3859211">copy</span><span class="op" id="3859215">(</span><span class="ident" id="3859216">db</span><span class="op" id="3859218">.</span><span class="ident" id="3859219">freeConn</span><span class="op" id="3859227">,</span>&nbsp;<span class="ident" id="3859229">db</span><span class="op" id="3859231">.</span><span class="ident" id="3859232">freeConn</span><span class="op" id="3859240">[</span><span class="num" id="3859241">1</span><span class="op" id="3859242">:</span><span class="op" id="3859243">]</span><span class="op" id="3859244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859248">db</span><span class="op" id="3859250">.</span><span class="ident" id="3859251">freeConn</span>&nbsp;<span class="op" id="3859260">=</span>&nbsp;<span class="ident" id="3859262">db</span><span class="op" id="3859264">.</span><span class="ident" id="3859265">freeConn</span><span class="op" id="3859273">[</span><span class="op" id="3859274">:</span><span class="ident" id="3859275">c</span><span class="op" id="3859276">-</span><span class="num" id="3859277">1</span><span class="op" id="3859278">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859282">conn</span><span class="op" id="3859286">.</span><span class="ident" id="3859287">inUse</span>&nbsp;<span class="op" id="3859293">=</span>&nbsp;<span class="builtintype" id="3859295">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859302">db</span><span class="op" id="3859304">.</span><span class="ident" id="3859305">mu</span><span class="op" id="3859307">.</span><span class="ident" id="3859308">Unlock</span><span class="op" id="3859314">(</span><span class="op" id="3859315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859319">return</span>&nbsp;<span class="ident" id="3859326">conn</span><span class="op" id="3859330">,</span>&nbsp;<span class="ident" id="3859332">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859341">db</span><span class="op" id="3859343">.</span><span class="ident" id="3859344">numOpen</span><span class="op" id="3859351">++</span>&nbsp;<span class="comment" id="3859354">//&nbsp;optimistically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859373">db</span><span class="op" id="3859375">.</span><span class="ident" id="3859376">mu</span><span class="op" id="3859378">.</span><span class="ident" id="3859379">Unlock</span><span class="op" id="3859385">(</span><span class="op" id="3859386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859389">ci</span><span class="op" id="3859391">,</span>&nbsp;<span class="ident" id="3859393">err</span>&nbsp;<span class="op" id="3859397">:=</span>&nbsp;<span class="ident" id="3859400">db</span><span class="op" id="3859402">.</span><span class="ident" id="3859403">driver</span><span class="op" id="3859409">.</span><span class="ident" id="3859410">Open</span><span class="op" id="3859414">(</span><span class="ident" id="3859415">db</span><span class="op" id="3859417">.</span><span class="ident" id="3859418">dsn</span><span class="op" id="3859421">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859424">if</span>&nbsp;<span class="ident" id="3859427">err</span>&nbsp;<span class="op" id="3859431">!=</span>&nbsp;<span class="ident" id="3859434">nil</span>&nbsp;<span class="op" id="3859438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859442">db</span><span class="op" id="3859444">.</span><span class="ident" id="3859445">mu</span><span class="op" id="3859447">.</span><span class="ident" id="3859448">Lock</span><span class="op" id="3859452">(</span><span class="op" id="3859453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859457">db</span><span class="op" id="3859459">.</span><span class="ident" id="3859460">numOpen</span><span class="op" id="3859467">--</span>&nbsp;<span class="comment" id="3859470">//&nbsp;correct&nbsp;for&nbsp;earlier&nbsp;optimism</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859504">db</span><span class="op" id="3859506">.</span><span class="ident" id="3859507">mu</span><span class="op" id="3859509">.</span><span class="ident" id="3859510">Unlock</span><span class="op" id="3859516">(</span><span class="op" id="3859517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859521">return</span>&nbsp;<span class="ident" id="3859528">nil</span><span class="op" id="3859531">,</span>&nbsp;<span class="ident" id="3859533">err</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859541">db</span><span class="op" id="3859543">.</span><span class="ident" id="3859544">mu</span><span class="op" id="3859546">.</span><span class="ident" id="3859547">Lock</span><span class="op" id="3859551">(</span><span class="op" id="3859552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859555">dc</span>&nbsp;<span class="op" id="3859558">:=</span>&nbsp;<span class="op" id="3859561">&amp;</span><span class="ident" id="3859562">driverConn</span><span class="op" id="3859572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859576">db</span><span class="op" id="3859578">:</span>&nbsp;<span class="ident" id="3859580">db</span><span class="op" id="3859582">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859586">ci</span><span class="op" id="3859588">:</span>&nbsp;<span class="ident" id="3859590">ci</span><span class="op" id="3859592">,</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859598">db</span><span class="op" id="3859600">.</span><span class="ident" id="3859601">addDepLocked</span><span class="op" id="3859613">(</span><span class="ident" id="3859614">dc</span><span class="op" id="3859616">,</span>&nbsp;<span class="ident" id="3859618">dc</span><span class="op" id="3859620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859623">dc</span><span class="op" id="3859625">.</span><span class="ident" id="3859626">inUse</span>&nbsp;<span class="op" id="3859632">=</span>&nbsp;<span class="builtintype" id="3859634">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859640">db</span><span class="op" id="3859642">.</span><span class="ident" id="3859643">mu</span><span class="op" id="3859645">.</span><span class="ident" id="3859646">Unlock</span><span class="op" id="3859652">(</span><span class="op" id="3859653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859656">return</span>&nbsp;<span class="ident" id="3859663">dc</span><span class="op" id="3859665">,</span>&nbsp;<span class="ident" id="3859667">nil</span><br>
<span class="lineno">680</span><span class="op" id="3859671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3859674">var</span>&nbsp;<span class="op" id="3859678">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859681">errConnClosed</span>&nbsp;<span class="op" id="3859695">=</span>&nbsp;<span class="ident" id="3859697">errors</span><span class="op" id="3859703">.</span><span class="ident" id="3859704">New</span><span class="op" id="3859707">(</span><span class="string" id="3859708">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;closed&#34;</span><span class="op" id="3859763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859766">errConnBusy</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3859780">=</span>&nbsp;<span class="ident" id="3859782">errors</span><span class="op" id="3859788">.</span><span class="ident" id="3859789">New</span><span class="op" id="3859792">(</span><span class="string" id="3859793">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;busy&#34;</span><span class="op" id="3859846">)</span><br>
<span class="lineno">685</span><span class="op" id="3859848">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3859851">//&nbsp;connIfFree&nbsp;returns&nbsp;(wanted,&nbsp;nil)&nbsp;if&nbsp;wanted&nbsp;is&nbsp;still&nbsp;a&nbsp;valid&nbsp;conn&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3859923">//&nbsp;isn&#39;t&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="comment" id="3859940">//</span><br>
<span class="lineno">690</span><span class="comment" id="3859943">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnClosed&nbsp;if&nbsp;the&nbsp;connection&nbsp;if&nbsp;the&nbsp;requested&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="3860019">//&nbsp;is&nbsp;invalid&nbsp;because&nbsp;it&#39;s&nbsp;been&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="3860059">//</span><br>
<span class="lineno"></span><span class="comment" id="3860062">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnBusy&nbsp;if&nbsp;the&nbsp;connection&nbsp;is&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3860119">func</span>&nbsp;<span class="op" id="3860124">(</span><span class="ident" id="3860125">db</span>&nbsp;<span class="op" id="3860128">*</span><span class="ident" id="3860129">DB</span><span class="op" id="3860131">)</span>&nbsp;<span class="ident" id="3860133">connIfFree</span><span class="op" id="3860143">(</span><span class="ident" id="3860144">wanted</span>&nbsp;<span class="op" id="3860151">*</span><span class="ident" id="3860152">driverConn</span><span class="op" id="3860162">)</span>&nbsp;<span class="op" id="3860164">(</span><span class="op" id="3860165">*</span><span class="ident" id="3860166">driverConn</span><span class="op" id="3860176">,</span>&nbsp;<span class="builtintype" id="3860178">error</span><span class="op" id="3860183">)</span>&nbsp;<span class="op" id="3860185">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860188">db</span><span class="op" id="3860190">.</span><span class="ident" id="3860191">mu</span><span class="op" id="3860193">.</span><span class="ident" id="3860194">Lock</span><span class="op" id="3860198">(</span><span class="op" id="3860199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860202">defer</span>&nbsp;<span class="ident" id="3860208">db</span><span class="op" id="3860210">.</span><span class="ident" id="3860211">mu</span><span class="op" id="3860213">.</span><span class="ident" id="3860214">Unlock</span><span class="op" id="3860220">(</span><span class="op" id="3860221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860224">if</span>&nbsp;<span class="ident" id="3860227">wanted</span><span class="op" id="3860233">.</span><span class="ident" id="3860234">dbmuClosed</span>&nbsp;<span class="op" id="3860245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860249">return</span>&nbsp;<span class="ident" id="3860256">nil</span><span class="op" id="3860259">,</span>&nbsp;<span class="ident" id="3860261">errConnClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860276">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860279">if</span>&nbsp;<span class="ident" id="3860282">wanted</span><span class="op" id="3860288">.</span><span class="ident" id="3860289">inUse</span>&nbsp;<span class="op" id="3860295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860299">return</span>&nbsp;<span class="ident" id="3860306">nil</span><span class="op" id="3860309">,</span>&nbsp;<span class="ident" id="3860311">errConnBusy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860327">idx</span>&nbsp;<span class="op" id="3860331">:=</span>&nbsp;<span class="op" id="3860334">-</span><span class="num" id="3860335">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860338">for</span>&nbsp;<span class="ident" id="3860342">ii</span><span class="op" id="3860344">,</span>&nbsp;<span class="ident" id="3860346">v</span>&nbsp;<span class="op" id="3860348">:=</span>&nbsp;<span class="keyword" id="3860351">range</span>&nbsp;<span class="ident" id="3860357">db</span><span class="op" id="3860359">.</span><span class="ident" id="3860360">freeConn</span>&nbsp;<span class="op" id="3860369">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860373">if</span>&nbsp;<span class="ident" id="3860376">v</span>&nbsp;<span class="op" id="3860378">==</span>&nbsp;<span class="ident" id="3860381">wanted</span>&nbsp;<span class="op" id="3860388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860393">idx</span>&nbsp;<span class="op" id="3860397">=</span>&nbsp;<span class="ident" id="3860399">ii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860405">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860416">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860419">if</span>&nbsp;<span class="ident" id="3860422">idx</span>&nbsp;<span class="op" id="3860426">&gt;=</span>&nbsp;<span class="num" id="3860429">0</span>&nbsp;<span class="op" id="3860431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860435">db</span><span class="op" id="3860437">.</span><span class="ident" id="3860438">freeConn</span>&nbsp;<span class="op" id="3860447">=</span>&nbsp;<span class="builtinfunc" id="3860449">append</span><span class="op" id="3860455">(</span><span class="ident" id="3860456">db</span><span class="op" id="3860458">.</span><span class="ident" id="3860459">freeConn</span><span class="op" id="3860467">[</span><span class="op" id="3860468">:</span><span class="ident" id="3860469">idx</span><span class="op" id="3860472">]</span><span class="op" id="3860473">,</span>&nbsp;<span class="ident" id="3860475">db</span><span class="op" id="3860477">.</span><span class="ident" id="3860478">freeConn</span><span class="op" id="3860486">[</span><span class="ident" id="3860487">idx</span><span class="op" id="3860490">+</span><span class="num" id="3860491">1</span><span class="op" id="3860492">:</span><span class="op" id="3860493">]</span><span class="op" id="3860494">...</span><span class="op" id="3860497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860501">wanted</span><span class="op" id="3860507">.</span><span class="ident" id="3860508">inUse</span>&nbsp;<span class="op" id="3860514">=</span>&nbsp;<span class="builtintype" id="3860516">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860523">return</span>&nbsp;<span class="ident" id="3860530">wanted</span><span class="op" id="3860536">,</span>&nbsp;<span class="ident" id="3860538">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860543">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860546">//&nbsp;TODO(bradfitz):&nbsp;shouldn&#39;t&nbsp;get&nbsp;here.&nbsp;After&nbsp;Go&nbsp;1.1,&nbsp;change&nbsp;this&nbsp;to:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860616">//&nbsp;panic(&#34;connIfFree&nbsp;call&nbsp;requested&nbsp;a&nbsp;non-closed,&nbsp;non-busy,&nbsp;non-free&nbsp;conn&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860693">//&nbsp;Which&nbsp;passes&nbsp;all&nbsp;the&nbsp;tests,&nbsp;but&nbsp;I&#39;m&nbsp;too&nbsp;paranoid&nbsp;to&nbsp;include&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860762">//&nbsp;late&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860782">//&nbsp;Instead,&nbsp;treat&nbsp;it&nbsp;like&nbsp;a&nbsp;busy&nbsp;connection:</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860828">return</span>&nbsp;<span class="ident" id="3860835">nil</span><span class="op" id="3860838">,</span>&nbsp;<span class="ident" id="3860840">errConnBusy</span><br>
<span class="lineno"></span><span class="op" id="3860852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3860855">//&nbsp;putConnHook&nbsp;is&nbsp;a&nbsp;hook&nbsp;for&nbsp;testing.</span><br>
<span class="lineno"></span><span class="keyword" id="3860893">var</span>&nbsp;<span class="ident" id="3860897">putConnHook</span>&nbsp;<span class="keyword" id="3860909">func</span><span class="op" id="3860913">(</span><span class="op" id="3860914">*</span><span class="ident" id="3860915">DB</span><span class="op" id="3860917">,</span>&nbsp;<span class="op" id="3860919">*</span><span class="ident" id="3860920">driverConn</span><span class="op" id="3860930">)</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="3860933">//&nbsp;noteUnusedDriverStatement&nbsp;notes&nbsp;that&nbsp;si&nbsp;is&nbsp;no&nbsp;longer&nbsp;used&nbsp;and&nbsp;should</span><br>
<span class="lineno"></span><span class="comment" id="3861005">//&nbsp;be&nbsp;closed&nbsp;whenever&nbsp;possible&nbsp;(when&nbsp;c&nbsp;is&nbsp;next&nbsp;not&nbsp;in&nbsp;use),&nbsp;unless&nbsp;c&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3861077">//&nbsp;already&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="3861096">func</span>&nbsp;<span class="op" id="3861101">(</span><span class="ident" id="3861102">db</span>&nbsp;<span class="op" id="3861105">*</span><span class="ident" id="3861106">DB</span><span class="op" id="3861108">)</span>&nbsp;<span class="ident" id="3861110">noteUnusedDriverStatement</span><span class="op" id="3861135">(</span><span class="ident" id="3861136">c</span>&nbsp;<span class="op" id="3861138">*</span><span class="ident" id="3861139">driverConn</span><span class="op" id="3861149">,</span>&nbsp;<span class="ident" id="3861151">si</span>&nbsp;<span class="ident" id="3861154">driver</span><span class="op" id="3861160">.</span><span class="ident" id="3861161">Stmt</span><span class="op" id="3861165">)</span>&nbsp;<span class="op" id="3861167">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861170">db</span><span class="op" id="3861172">.</span><span class="ident" id="3861173">mu</span><span class="op" id="3861175">.</span><span class="ident" id="3861176">Lock</span><span class="op" id="3861180">(</span><span class="op" id="3861181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861184">defer</span>&nbsp;<span class="ident" id="3861190">db</span><span class="op" id="3861192">.</span><span class="ident" id="3861193">mu</span><span class="op" id="3861195">.</span><span class="ident" id="3861196">Unlock</span><span class="op" id="3861202">(</span><span class="op" id="3861203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861206">if</span>&nbsp;<span class="ident" id="3861209">c</span><span class="op" id="3861210">.</span><span class="ident" id="3861211">inUse</span>&nbsp;<span class="op" id="3861217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861221">c</span><span class="op" id="3861222">.</span><span class="ident" id="3861223">onPut</span>&nbsp;<span class="op" id="3861229">=</span>&nbsp;<span class="builtinfunc" id="3861231">append</span><span class="op" id="3861237">(</span><span class="ident" id="3861238">c</span><span class="op" id="3861239">.</span><span class="ident" id="3861240">onPut</span><span class="op" id="3861245">,</span>&nbsp;<span class="keyword" id="3861247">func</span><span class="op" id="3861251">(</span><span class="op" id="3861252">)</span>&nbsp;<span class="op" id="3861254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861259">si</span><span class="op" id="3861261">.</span><span class="ident" id="3861262">Close</span><span class="op" id="3861267">(</span><span class="op" id="3861268">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861272">}</span><span class="op" id="3861273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861276">}</span>&nbsp;<span class="keyword" id="3861278">else</span>&nbsp;<span class="op" id="3861283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861287">c</span><span class="op" id="3861288">.</span><span class="ident" id="3861289">Lock</span><span class="op" id="3861293">(</span><span class="op" id="3861294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861298">defer</span>&nbsp;<span class="ident" id="3861304">c</span><span class="op" id="3861305">.</span><span class="ident" id="3861306">Unlock</span><span class="op" id="3861312">(</span><span class="op" id="3861313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861317">if</span>&nbsp;<span class="op" id="3861320">!</span><span class="ident" id="3861321">c</span><span class="op" id="3861322">.</span><span class="ident" id="3861323">finalClosed</span>&nbsp;<span class="op" id="3861335">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861340">si</span><span class="op" id="3861342">.</span><span class="ident" id="3861343">Close</span><span class="op" id="3861348">(</span><span class="op" id="3861349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861356">}</span><br>
<span class="lineno"></span><span class="op" id="3861358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">745</span><span class="comment" id="3861361">//&nbsp;debugGetPut&nbsp;determines&nbsp;whether&nbsp;getConn&nbsp;&amp;&nbsp;putConn&nbsp;calls&#39;&nbsp;stack&nbsp;traces</span><br>
<span class="lineno"></span><span class="comment" id="3861433">//&nbsp;are&nbsp;returned&nbsp;for&nbsp;more&nbsp;verbose&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="3861475">const</span>&nbsp;<span class="ident" id="3861481">debugGetPut</span>&nbsp;<span class="op" id="3861493">=</span>&nbsp;<span class="builtintype" id="3861495">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3861502">//&nbsp;putConn&nbsp;adds&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;db&#39;s&nbsp;free&nbsp;pool.</span><br>
<span class="lineno">750</span><span class="comment" id="3861554">//&nbsp;err&nbsp;is&nbsp;optionally&nbsp;the&nbsp;last&nbsp;error&nbsp;that&nbsp;occurred&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3861624">func</span>&nbsp;<span class="op" id="3861629">(</span><span class="ident" id="3861630">db</span>&nbsp;<span class="op" id="3861633">*</span><span class="ident" id="3861634">DB</span><span class="op" id="3861636">)</span>&nbsp;<span class="ident" id="3861638">putConn</span><span class="op" id="3861645">(</span><span class="ident" id="3861646">dc</span>&nbsp;<span class="op" id="3861649">*</span><span class="ident" id="3861650">driverConn</span><span class="op" id="3861660">,</span>&nbsp;<span class="ident" id="3861662">err</span>&nbsp;<span class="builtintype" id="3861666">error</span><span class="op" id="3861671">)</span>&nbsp;<span class="op" id="3861673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861676">db</span><span class="op" id="3861678">.</span><span class="ident" id="3861679">mu</span><span class="op" id="3861681">.</span><span class="ident" id="3861682">Lock</span><span class="op" id="3861686">(</span><span class="op" id="3861687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861690">if</span>&nbsp;<span class="op" id="3861693">!</span><span class="ident" id="3861694">dc</span><span class="op" id="3861696">.</span><span class="ident" id="3861697">inUse</span>&nbsp;<span class="op" id="3861703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861707">if</span>&nbsp;<span class="ident" id="3861710">debugGetPut</span>&nbsp;<span class="op" id="3861722">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861727">fmt</span><span class="op" id="3861730">.</span><span class="ident" id="3861731">Printf</span><span class="op" id="3861737">(</span><span class="string" id="3861738">&#34;putConn(%v)&nbsp;DUPLICATE&nbsp;was:&nbsp;%s\n\nPREVIOUS&nbsp;was:&nbsp;%s&#34;</span><span class="op" id="3861789">,</span>&nbsp;<span class="ident" id="3861791">dc</span><span class="op" id="3861793">,</span>&nbsp;<span class="ident" id="3861795">stack</span><span class="op" id="3861800">(</span><span class="op" id="3861801">)</span><span class="op" id="3861802">,</span>&nbsp;<span class="ident" id="3861804">db</span><span class="op" id="3861806">.</span><span class="ident" id="3861807">lastPut</span><span class="op" id="3861814">[</span><span class="ident" id="3861815">dc</span><span class="op" id="3861817">]</span><span class="op" id="3861818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3861826">panic</span><span class="op" id="3861831">(</span><span class="string" id="3861832">&#34;sql:&nbsp;connection&nbsp;returned&nbsp;that&nbsp;was&nbsp;never&nbsp;out&#34;</span><span class="op" id="3861877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861883">if</span>&nbsp;<span class="ident" id="3861886">debugGetPut</span>&nbsp;<span class="op" id="3861898">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861902">db</span><span class="op" id="3861904">.</span><span class="ident" id="3861905">lastPut</span><span class="op" id="3861912">[</span><span class="ident" id="3861913">dc</span><span class="op" id="3861915">]</span>&nbsp;<span class="op" id="3861917">=</span>&nbsp;<span class="ident" id="3861919">stack</span><span class="op" id="3861924">(</span><span class="op" id="3861925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861931">dc</span><span class="op" id="3861933">.</span><span class="ident" id="3861934">inUse</span>&nbsp;<span class="op" id="3861940">=</span>&nbsp;<span class="builtintype" id="3861942">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861950">for</span>&nbsp;<span class="ident" id="3861954">_</span><span class="op" id="3861955">,</span>&nbsp;<span class="ident" id="3861957">fn</span>&nbsp;<span class="op" id="3861960">:=</span>&nbsp;<span class="keyword" id="3861963">range</span>&nbsp;<span class="ident" id="3861969">dc</span><span class="op" id="3861971">.</span><span class="ident" id="3861972">onPut</span>&nbsp;<span class="op" id="3861978">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861982">fn</span><span class="op" id="3861984">(</span><span class="op" id="3861985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861991">dc</span><span class="op" id="3861993">.</span><span class="ident" id="3861994">onPut</span>&nbsp;<span class="op" id="3862000">=</span>&nbsp;<span class="ident" id="3862002">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862008">if</span>&nbsp;<span class="ident" id="3862011">err</span>&nbsp;<span class="op" id="3862015">==</span>&nbsp;<span class="ident" id="3862018">driver</span><span class="op" id="3862024">.</span><span class="ident" id="3862025">ErrBadConn</span>&nbsp;<span class="op" id="3862036">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862040">//&nbsp;Don&#39;t&nbsp;reuse&nbsp;bad&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862074">//&nbsp;Since&nbsp;the&nbsp;conn&nbsp;is&nbsp;considered&nbsp;bad&nbsp;and&nbsp;is&nbsp;being&nbsp;discarded,&nbsp;treat&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862145">//&nbsp;as&nbsp;closed.&nbsp;Don&#39;t&nbsp;decrement&nbsp;the&nbsp;open&nbsp;count&nbsp;here,&nbsp;finalClose&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862214">//&nbsp;take&nbsp;care&nbsp;of&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862238">db</span><span class="op" id="3862240">.</span><span class="ident" id="3862241">maybeOpenNewConnections</span><span class="op" id="3862264">(</span><span class="op" id="3862265">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862269">db</span><span class="op" id="3862271">.</span><span class="ident" id="3862272">mu</span><span class="op" id="3862274">.</span><span class="ident" id="3862275">Unlock</span><span class="op" id="3862281">(</span><span class="op" id="3862282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862286">dc</span><span class="op" id="3862288">.</span><span class="ident" id="3862289">Close</span><span class="op" id="3862294">(</span><span class="op" id="3862295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862299">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862310">if</span>&nbsp;<span class="ident" id="3862313">putConnHook</span>&nbsp;<span class="op" id="3862325">!=</span>&nbsp;<span class="ident" id="3862328">nil</span>&nbsp;<span class="op" id="3862332">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862336">putConnHook</span><span class="op" id="3862347">(</span><span class="ident" id="3862348">db</span><span class="op" id="3862350">,</span>&nbsp;<span class="ident" id="3862352">dc</span><span class="op" id="3862354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862360">added</span>&nbsp;<span class="op" id="3862366">:=</span>&nbsp;<span class="ident" id="3862369">db</span><span class="op" id="3862371">.</span><span class="ident" id="3862372">putConnDBLocked</span><span class="op" id="3862387">(</span><span class="ident" id="3862388">dc</span><span class="op" id="3862390">,</span>&nbsp;<span class="ident" id="3862392">nil</span><span class="op" id="3862395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862398">db</span><span class="op" id="3862400">.</span><span class="ident" id="3862401">mu</span><span class="op" id="3862403">.</span><span class="ident" id="3862404">Unlock</span><span class="op" id="3862410">(</span><span class="op" id="3862411">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862415">if</span>&nbsp;<span class="op" id="3862418">!</span><span class="ident" id="3862419">added</span>&nbsp;<span class="op" id="3862425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862429">dc</span><span class="op" id="3862431">.</span><span class="ident" id="3862432">Close</span><span class="op" id="3862437">(</span><span class="op" id="3862438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862441">}</span><br>
<span class="lineno"></span><span class="op" id="3862443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">790</span><span class="comment" id="3862446">//&nbsp;Satisfy&nbsp;a&nbsp;connRequest&nbsp;or&nbsp;put&nbsp;the&nbsp;driverConn&nbsp;in&nbsp;the&nbsp;idle&nbsp;pool&nbsp;and&nbsp;return&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="3862526">//&nbsp;or&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="3862546">//&nbsp;putConnDBLocked&nbsp;will&nbsp;satisfy&nbsp;a&nbsp;connRequest&nbsp;if&nbsp;there&nbsp;is&nbsp;one,&nbsp;or&nbsp;it&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="3862620">//&nbsp;return&nbsp;the&nbsp;*driverConn&nbsp;to&nbsp;the&nbsp;freeConn&nbsp;list&nbsp;if&nbsp;err&nbsp;==&nbsp;nil&nbsp;and&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="3862694">//&nbsp;connection&nbsp;limit&nbsp;will&nbsp;not&nbsp;be&nbsp;exceeded.</span><br>
<span class="lineno">795</span><span class="comment" id="3862736">//&nbsp;If&nbsp;err&nbsp;!=&nbsp;nil,&nbsp;the&nbsp;value&nbsp;of&nbsp;dc&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="3862782">//&nbsp;If&nbsp;err&nbsp;==&nbsp;nil,&nbsp;then&nbsp;dc&nbsp;must&nbsp;not&nbsp;equal&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="3862828">//&nbsp;If&nbsp;a&nbsp;connRequest&nbsp;was&nbsp;fulfilled&nbsp;or&nbsp;the&nbsp;*driverConn&nbsp;was&nbsp;placed&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3862899">//&nbsp;freeConn&nbsp;list,&nbsp;then&nbsp;true&nbsp;is&nbsp;returned,&nbsp;otherwise&nbsp;false&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3862969">func</span>&nbsp;<span class="op" id="3862974">(</span><span class="ident" id="3862975">db</span>&nbsp;<span class="op" id="3862978">*</span><span class="ident" id="3862979">DB</span><span class="op" id="3862981">)</span>&nbsp;<span class="ident" id="3862983">putConnDBLocked</span><span class="op" id="3862998">(</span><span class="ident" id="3862999">dc</span>&nbsp;<span class="op" id="3863002">*</span><span class="ident" id="3863003">driverConn</span><span class="op" id="3863013">,</span>&nbsp;<span class="ident" id="3863015">err</span>&nbsp;<span class="builtintype" id="3863019">error</span><span class="op" id="3863024">)</span>&nbsp;<span class="builtintype" id="3863026">bool</span>&nbsp;<span class="op" id="3863031">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863034">if</span>&nbsp;<span class="ident" id="3863037">c</span>&nbsp;<span class="op" id="3863039">:=</span>&nbsp;<span class="builtinfunc" id="3863042">len</span><span class="op" id="3863045">(</span><span class="ident" id="3863046">db</span><span class="op" id="3863048">.</span><span class="ident" id="3863049">connRequests</span><span class="op" id="3863061">)</span><span class="op" id="3863062">;</span>&nbsp;<span class="ident" id="3863064">c</span>&nbsp;<span class="op" id="3863066">&gt;</span>&nbsp;<span class="num" id="3863068">0</span>&nbsp;<span class="op" id="3863070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863074">req</span>&nbsp;<span class="op" id="3863078">:=</span>&nbsp;<span class="ident" id="3863081">db</span><span class="op" id="3863083">.</span><span class="ident" id="3863084">connRequests</span><span class="op" id="3863096">[</span><span class="num" id="3863097">0</span><span class="op" id="3863098">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863102">//&nbsp;This&nbsp;copy&nbsp;is&nbsp;O(n)&nbsp;but&nbsp;in&nbsp;practice&nbsp;faster&nbsp;than&nbsp;a&nbsp;linked&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863168">//&nbsp;TODO:&nbsp;consider&nbsp;compacting&nbsp;it&nbsp;down&nbsp;less&nbsp;often&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863222">//&nbsp;moving&nbsp;the&nbsp;base&nbsp;instead?</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3863252">copy</span><span class="op" id="3863256">(</span><span class="ident" id="3863257">db</span><span class="op" id="3863259">.</span><span class="ident" id="3863260">connRequests</span><span class="op" id="3863272">,</span>&nbsp;<span class="ident" id="3863274">db</span><span class="op" id="3863276">.</span><span class="ident" id="3863277">connRequests</span><span class="op" id="3863289">[</span><span class="num" id="3863290">1</span><span class="op" id="3863291">:</span><span class="op" id="3863292">]</span><span class="op" id="3863293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863297">db</span><span class="op" id="3863299">.</span><span class="ident" id="3863300">connRequests</span>&nbsp;<span class="op" id="3863313">=</span>&nbsp;<span class="ident" id="3863315">db</span><span class="op" id="3863317">.</span><span class="ident" id="3863318">connRequests</span><span class="op" id="3863330">[</span><span class="op" id="3863331">:</span><span class="ident" id="3863332">c</span><span class="op" id="3863333">-</span><span class="num" id="3863334">1</span><span class="op" id="3863335">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863339">if</span>&nbsp;<span class="ident" id="3863342">err</span>&nbsp;<span class="op" id="3863346">==</span>&nbsp;<span class="ident" id="3863349">nil</span>&nbsp;<span class="op" id="3863353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863358">dc</span><span class="op" id="3863360">.</span><span class="ident" id="3863361">inUse</span>&nbsp;<span class="op" id="3863367">=</span>&nbsp;<span class="builtintype" id="3863369">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863376">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863380">req</span>&nbsp;<span class="op" id="3863384">&lt;-</span>&nbsp;<span class="ident" id="3863387">connRequest</span><span class="op" id="3863398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863403">conn</span><span class="op" id="3863407">:</span>&nbsp;<span class="ident" id="3863409">dc</span><span class="op" id="3863411">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863416">err</span><span class="op" id="3863419">:</span>&nbsp;&nbsp;<span class="ident" id="3863422">err</span><span class="op" id="3863425">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863433">return</span>&nbsp;<span class="builtintype" id="3863440">true</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863446">}</span>&nbsp;<span class="keyword" id="3863448">else</span>&nbsp;<span class="keyword" id="3863453">if</span>&nbsp;<span class="ident" id="3863456">err</span>&nbsp;<span class="op" id="3863460">==</span>&nbsp;<span class="ident" id="3863463">nil</span>&nbsp;<span class="op" id="3863467">&amp;&amp;</span>&nbsp;<span class="op" id="3863470">!</span><span class="ident" id="3863471">db</span><span class="op" id="3863473">.</span><span class="ident" id="3863474">closed</span>&nbsp;<span class="op" id="3863481">&amp;&amp;</span>&nbsp;<span class="ident" id="3863484">db</span><span class="op" id="3863486">.</span><span class="ident" id="3863487">maxIdleConnsLocked</span><span class="op" id="3863505">(</span><span class="op" id="3863506">)</span>&nbsp;<span class="op" id="3863508">&gt;</span>&nbsp;<span class="builtinfunc" id="3863510">len</span><span class="op" id="3863513">(</span><span class="ident" id="3863514">db</span><span class="op" id="3863516">.</span><span class="ident" id="3863517">freeConn</span><span class="op" id="3863525">)</span>&nbsp;<span class="op" id="3863527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863531">db</span><span class="op" id="3863533">.</span><span class="ident" id="3863534">freeConn</span>&nbsp;<span class="op" id="3863543">=</span>&nbsp;<span class="builtinfunc" id="3863545">append</span><span class="op" id="3863551">(</span><span class="ident" id="3863552">db</span><span class="op" id="3863554">.</span><span class="ident" id="3863555">freeConn</span><span class="op" id="3863563">,</span>&nbsp;<span class="ident" id="3863565">dc</span><span class="op" id="3863567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863571">return</span>&nbsp;<span class="builtintype" id="3863578">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863587">return</span>&nbsp;<span class="builtintype" id="3863594">false</span><br>
<span class="lineno">820</span><span class="op" id="3863600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3863603">//&nbsp;maxBadConnRetries&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;maximum&nbsp;retries&nbsp;if&nbsp;the&nbsp;driver&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="3863679">//&nbsp;driver.ErrBadConn&nbsp;to&nbsp;signal&nbsp;a&nbsp;broken&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3863731">const</span>&nbsp;<span class="ident" id="3863737">maxBadConnRetries</span>&nbsp;<span class="op" id="3863755">=</span>&nbsp;<span class="num" id="3863757">10</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="comment" id="3863761">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;later&nbsp;queries&nbsp;or&nbsp;executions.</span><br>
<span class="lineno"></span><span class="comment" id="3863834">//&nbsp;Multiple&nbsp;queries&nbsp;or&nbsp;executions&nbsp;may&nbsp;be&nbsp;run&nbsp;concurrently&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3863901">//&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="3863924">func</span>&nbsp;<span class="op" id="3863929">(</span><span class="ident" id="3863930">db</span>&nbsp;<span class="op" id="3863933">*</span><span class="ident" id="3863934">DB</span><span class="op" id="3863936">)</span>&nbsp;<span class="ident" id="3863938">Prepare</span><span class="op" id="3863945">(</span><span class="ident" id="3863946">query</span>&nbsp;<span class="builtintype" id="3863952">string</span><span class="op" id="3863958">)</span>&nbsp;<span class="op" id="3863960">(</span><span class="op" id="3863961">*</span><span class="ident" id="3863962">Stmt</span><span class="op" id="3863966">,</span>&nbsp;<span class="builtintype" id="3863968">error</span><span class="op" id="3863973">)</span>&nbsp;<span class="op" id="3863975">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863978">var</span>&nbsp;<span class="ident" id="3863982">stmt</span>&nbsp;<span class="op" id="3863987">*</span><span class="ident" id="3863988">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863994">var</span>&nbsp;<span class="ident" id="3863998">err</span>&nbsp;<span class="builtintype" id="3864002">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864009">for</span>&nbsp;<span class="ident" id="3864013">i</span>&nbsp;<span class="op" id="3864015">:=</span>&nbsp;<span class="num" id="3864018">0</span><span class="op" id="3864019">;</span>&nbsp;<span class="ident" id="3864021">i</span>&nbsp;<span class="op" id="3864023">&lt;</span>&nbsp;<span class="ident" id="3864025">maxBadConnRetries</span><span class="op" id="3864042">;</span>&nbsp;<span class="ident" id="3864044">i</span><span class="op" id="3864045">++</span>&nbsp;<span class="op" id="3864048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864052">stmt</span><span class="op" id="3864056">,</span>&nbsp;<span class="ident" id="3864058">err</span>&nbsp;<span class="op" id="3864062">=</span>&nbsp;<span class="ident" id="3864064">db</span><span class="op" id="3864066">.</span><span class="ident" id="3864067">prepare</span><span class="op" id="3864074">(</span><span class="ident" id="3864075">query</span><span class="op" id="3864080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864084">if</span>&nbsp;<span class="ident" id="3864087">err</span>&nbsp;<span class="op" id="3864091">!=</span>&nbsp;<span class="ident" id="3864094">driver</span><span class="op" id="3864100">.</span><span class="ident" id="3864101">ErrBadConn</span>&nbsp;<span class="op" id="3864112">{</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864117">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864131">return</span>&nbsp;<span class="ident" id="3864138">stmt</span><span class="op" id="3864142">,</span>&nbsp;<span class="ident" id="3864144">err</span><br>
<span class="lineno"></span><span class="op" id="3864148">}</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span><span class="keyword" id="3864151">func</span>&nbsp;<span class="op" id="3864156">(</span><span class="ident" id="3864157">db</span>&nbsp;<span class="op" id="3864160">*</span><span class="ident" id="3864161">DB</span><span class="op" id="3864163">)</span>&nbsp;<span class="ident" id="3864165">prepare</span><span class="op" id="3864172">(</span><span class="ident" id="3864173">query</span>&nbsp;<span class="builtintype" id="3864179">string</span><span class="op" id="3864185">)</span>&nbsp;<span class="op" id="3864187">(</span><span class="op" id="3864188">*</span><span class="ident" id="3864189">Stmt</span><span class="op" id="3864193">,</span>&nbsp;<span class="builtintype" id="3864195">error</span><span class="op" id="3864200">)</span>&nbsp;<span class="op" id="3864202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3864205">//&nbsp;TODO:&nbsp;check&nbsp;if&nbsp;db.driver&nbsp;supports&nbsp;an&nbsp;optional</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3864255">//&nbsp;driver.Preparer&nbsp;interface&nbsp;and&nbsp;call&nbsp;that&nbsp;instead,&nbsp;if&nbsp;so,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3864315">//&nbsp;otherwise&nbsp;we&nbsp;make&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;that&#39;s&nbsp;bound</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3864371">//&nbsp;to&nbsp;a&nbsp;connection,&nbsp;and&nbsp;to&nbsp;execute&nbsp;this&nbsp;prepared&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3864431">//&nbsp;we&nbsp;either&nbsp;need&nbsp;to&nbsp;use&nbsp;this&nbsp;connection&nbsp;(if&nbsp;it&#39;s&nbsp;free),&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3864494">//&nbsp;get&nbsp;a&nbsp;new&nbsp;connection&nbsp;+&nbsp;re-prepare&nbsp;+&nbsp;execute&nbsp;on&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864555">dc</span><span class="op" id="3864557">,</span>&nbsp;<span class="ident" id="3864559">err</span>&nbsp;<span class="op" id="3864563">:=</span>&nbsp;<span class="ident" id="3864566">db</span><span class="op" id="3864568">.</span><span class="ident" id="3864569">conn</span><span class="op" id="3864573">(</span><span class="op" id="3864574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864577">if</span>&nbsp;<span class="ident" id="3864580">err</span>&nbsp;<span class="op" id="3864584">!=</span>&nbsp;<span class="ident" id="3864587">nil</span>&nbsp;<span class="op" id="3864591">{</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864595">return</span>&nbsp;<span class="ident" id="3864602">nil</span><span class="op" id="3864605">,</span>&nbsp;<span class="ident" id="3864607">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864615">dc</span><span class="op" id="3864617">.</span><span class="ident" id="3864618">Lock</span><span class="op" id="3864622">(</span><span class="op" id="3864623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864626">si</span><span class="op" id="3864628">,</span>&nbsp;<span class="ident" id="3864630">err</span>&nbsp;<span class="op" id="3864634">:=</span>&nbsp;<span class="ident" id="3864637">dc</span><span class="op" id="3864639">.</span><span class="ident" id="3864640">prepareLocked</span><span class="op" id="3864653">(</span><span class="ident" id="3864654">query</span><span class="op" id="3864659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864662">dc</span><span class="op" id="3864664">.</span><span class="ident" id="3864665">Unlock</span><span class="op" id="3864671">(</span><span class="op" id="3864672">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864675">if</span>&nbsp;<span class="ident" id="3864678">err</span>&nbsp;<span class="op" id="3864682">!=</span>&nbsp;<span class="ident" id="3864685">nil</span>&nbsp;<span class="op" id="3864689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864693">db</span><span class="op" id="3864695">.</span><span class="ident" id="3864696">putConn</span><span class="op" id="3864703">(</span><span class="ident" id="3864704">dc</span><span class="op" id="3864706">,</span>&nbsp;<span class="ident" id="3864708">err</span><span class="op" id="3864711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864715">return</span>&nbsp;<span class="ident" id="3864722">nil</span><span class="op" id="3864725">,</span>&nbsp;<span class="ident" id="3864727">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864735">stmt</span>&nbsp;<span class="op" id="3864740">:=</span>&nbsp;<span class="op" id="3864743">&amp;</span><span class="ident" id="3864744">Stmt</span><span class="op" id="3864748">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864752">db</span><span class="op" id="3864754">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3864759">db</span><span class="op" id="3864761">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864765">query</span><span class="op" id="3864770">:</span>&nbsp;<span class="ident" id="3864772">query</span><span class="op" id="3864777">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864781">css</span><span class="op" id="3864784">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3864788">[</span><span class="op" id="3864789">]</span><span class="ident" id="3864790">connStmt</span><span class="op" id="3864798">{</span><span class="op" id="3864799">{</span><span class="ident" id="3864800">dc</span><span class="op" id="3864802">,</span>&nbsp;<span class="ident" id="3864804">si</span><span class="op" id="3864806">}</span><span class="op" id="3864807">}</span><span class="op" id="3864808">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864814">db</span><span class="op" id="3864816">.</span><span class="ident" id="3864817">addDep</span><span class="op" id="3864823">(</span><span class="ident" id="3864824">stmt</span><span class="op" id="3864828">,</span>&nbsp;<span class="ident" id="3864830">stmt</span><span class="op" id="3864834">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864837">db</span><span class="op" id="3864839">.</span><span class="ident" id="3864840">putConn</span><span class="op" id="3864847">(</span><span class="ident" id="3864848">dc</span><span class="op" id="3864850">,</span>&nbsp;<span class="ident" id="3864852">nil</span><span class="op" id="3864855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864858">return</span>&nbsp;<span class="ident" id="3864865">stmt</span><span class="op" id="3864869">,</span>&nbsp;<span class="ident" id="3864871">nil</span><br>
<span class="lineno"></span><span class="op" id="3864875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3864878">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;without&nbsp;returning&nbsp;any&nbsp;rows.</span><br>
<span class="lineno">870</span><span class="comment" id="3864931">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno"></span><span class="keyword" id="3864992">func</span>&nbsp;<span class="op" id="3864997">(</span><span class="ident" id="3864998">db</span>&nbsp;<span class="op" id="3865001">*</span><span class="ident" id="3865002">DB</span><span class="op" id="3865004">)</span>&nbsp;<span class="ident" id="3865006">Exec</span><span class="op" id="3865010">(</span><span class="ident" id="3865011">query</span>&nbsp;<span class="builtintype" id="3865017">string</span><span class="op" id="3865023">,</span>&nbsp;<span class="ident" id="3865025">args</span>&nbsp;<span class="op" id="3865030">...</span><span class="keyword" id="3865033">interface</span><span class="op" id="3865042">{</span><span class="op" id="3865043">}</span><span class="op" id="3865044">)</span>&nbsp;<span class="op" id="3865046">(</span><span class="ident" id="3865047">Result</span><span class="op" id="3865053">,</span>&nbsp;<span class="builtintype" id="3865055">error</span><span class="op" id="3865060">)</span>&nbsp;<span class="op" id="3865062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865065">var</span>&nbsp;<span class="ident" id="3865069">res</span>&nbsp;<span class="ident" id="3865073">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865081">var</span>&nbsp;<span class="ident" id="3865085">err</span>&nbsp;<span class="builtintype" id="3865089">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865096">for</span>&nbsp;<span class="ident" id="3865100">i</span>&nbsp;<span class="op" id="3865102">:=</span>&nbsp;<span class="num" id="3865105">0</span><span class="op" id="3865106">;</span>&nbsp;<span class="ident" id="3865108">i</span>&nbsp;<span class="op" id="3865110">&lt;</span>&nbsp;<span class="ident" id="3865112">maxBadConnRetries</span><span class="op" id="3865129">;</span>&nbsp;<span class="ident" id="3865131">i</span><span class="op" id="3865132">++</span>&nbsp;<span class="op" id="3865135">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3865139">res</span><span class="op" id="3865142">,</span>&nbsp;<span class="ident" id="3865144">err</span>&nbsp;<span class="op" id="3865148">=</span>&nbsp;<span class="ident" id="3865150">db</span><span class="op" id="3865152">.</span><span class="ident" id="3865153">exec</span><span class="op" id="3865157">(</span><span class="ident" id="3865158">query</span><span class="op" id="3865163">,</span>&nbsp;<span class="ident" id="3865165">args</span><span class="op" id="3865169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865173">if</span>&nbsp;<span class="ident" id="3865176">err</span>&nbsp;<span class="op" id="3865180">!=</span>&nbsp;<span class="ident" id="3865183">driver</span><span class="op" id="3865189">.</span><span class="ident" id="3865190">ErrBadConn</span>&nbsp;<span class="op" id="3865201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865206">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865217">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865220">return</span>&nbsp;<span class="ident" id="3865227">res</span><span class="op" id="3865230">,</span>&nbsp;<span class="ident" id="3865232">err</span><br>
<span class="lineno"></span><span class="op" id="3865236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3865239">func</span>&nbsp;<span class="op" id="3865244">(</span><span class="ident" id="3865245">db</span>&nbsp;<span class="op" id="3865248">*</span><span class="ident" id="3865249">DB</span><span class="op" id="3865251">)</span>&nbsp;<span class="ident" id="3865253">exec</span><span class="op" id="3865257">(</span><span class="ident" id="3865258">query</span>&nbsp;<span class="builtintype" id="3865264">string</span><span class="op" id="3865270">,</span>&nbsp;<span class="ident" id="3865272">args</span>&nbsp;<span class="op" id="3865277">[</span><span class="op" id="3865278">]</span><span class="keyword" id="3865279">interface</span><span class="op" id="3865288">{</span><span class="op" id="3865289">}</span><span class="op" id="3865290">)</span>&nbsp;<span class="op" id="3865292">(</span><span class="ident" id="3865293">res</span>&nbsp;<span class="ident" id="3865297">Result</span><span class="op" id="3865303">,</span>&nbsp;<span class="ident" id="3865305">err</span>&nbsp;<span class="builtintype" id="3865309">error</span><span class="op" id="3865314">)</span>&nbsp;<span class="op" id="3865316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3865319">dc</span><span class="op" id="3865321">,</span>&nbsp;<span class="ident" id="3865323">err</span>&nbsp;<span class="op" id="3865327">:=</span>&nbsp;<span class="ident" id="3865330">db</span><span class="op" id="3865332">.</span><span class="ident" id="3865333">conn</span><span class="op" id="3865337">(</span><span class="op" id="3865338">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865341">if</span>&nbsp;<span class="ident" id="3865344">err</span>&nbsp;<span class="op" id="3865348">!=</span>&nbsp;<span class="ident" id="3865351">nil</span>&nbsp;<span class="op" id="3865355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865359">return</span>&nbsp;<span class="ident" id="3865366">nil</span><span class="op" id="3865369">,</span>&nbsp;<span class="ident" id="3865371">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865379">defer</span>&nbsp;<span class="keyword" id="3865385">func</span><span class="op" id="3865389">(</span><span class="op" id="3865390">)</span>&nbsp;<span class="op" id="3865392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3865396">db</span><span class="op" id="3865398">.</span><span class="ident" id="3865399">putConn</span><span class="op" id="3865406">(</span><span class="ident" id="3865407">dc</span><span class="op" id="3865409">,</span>&nbsp;<span class="ident" id="3865411">err</span><span class="op" id="3865414">)</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865417">}</span><span class="op" id="3865418">(</span><span class="op" id="3865419">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865423">if</span>&nbsp;<span class="ident" id="3865426">execer</span><span class="op" id="3865432">,</span>&nbsp;<span class="ident" id="3865434">ok</span>&nbsp;<span class="op" id="3865437">:=</span>&nbsp;<span class="ident" id="3865440">dc</span><span class="op" id="3865442">.</span><span class="ident" id="3865443">ci</span><span class="op" id="3865445">.</span><span class="op" id="3865446">(</span><span class="ident" id="3865447">driver</span><span class="op" id="3865453">.</span><span class="ident" id="3865454">Execer</span><span class="op" id="3865460">)</span><span class="op" id="3865461">;</span>&nbsp;<span class="ident" id="3865463">ok</span>&nbsp;<span class="op" id="3865466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3865470">dargs</span><span class="op" id="3865475">,</span>&nbsp;<span class="ident" id="3865477">err</span>&nbsp;<span class="op" id="3865481">:=</span>&nbsp;<span class="ident" id="3865484">driverArgs</span><span class="op" id="3865494">(</span><span class="ident" id="3865495">nil</span><span class="op" id="3865498">,</span>&nbsp;<span class="ident" id="3865500">args</span><span class="op" id="3865504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865508">if</span>&nbsp;<span class="ident" id="3865511">err</span>&nbsp;<span class="op" id="3865515">!=</span>&nbsp;<span class="ident" id="3865518">nil</span>&nbsp;<span class="op" id="3865522">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865527">return</span>&nbsp;<span class="ident" id="3865534">nil</span><span class="op" id="3865537">,</span>&nbsp;<span class="ident" id="3865539">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3865549">dc</span><span class="op" id="3865551">.</span><span class="ident" id="3865552">Lock</span><span class="op" id="3865556">(</span><span class="op" id="3865557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3865561">resi</span><span class="op" id="3865565">,</span>&nbsp;<span class="ident" id="3865567">err</span>&nbsp;<span class="op" id="3865571">:=</span>&nbsp;<span class="ident" id="3865574">execer</span><span class="op" id="3865580">.</span><span class="ident" id="3865581">Exec</span><span class="op" id="3865585">(</span><span class="ident" id="3865586">query</span><span class="op" id="3865591">,</span>&nbsp;<span class="ident" id="3865593">dargs</span><span class="op" id="3865598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3865602">dc</span><span class="op" id="3865604">.</span><span class="ident" id="3865605">Unlock</span><span class="op" id="3865611">(</span><span class="op" id="3865612">)</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865616">if</span>&nbsp;<span class="ident" id="3865619">err</span>&nbsp;<span class="op" id="3865623">!=</span>&nbsp;<span class="ident" id="3865626">driver</span><span class="op" id="3865632">.</span><span class="ident" id="3865633">ErrSkip</span>&nbsp;<span class="op" id="3865641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865646">if</span>&nbsp;<span class="ident" id="3865649">err</span>&nbsp;<span class="op" id="3865653">!=</span>&nbsp;<span class="ident" id="3865656">nil</span>&nbsp;<span class="op" id="3865660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865666">return</span>&nbsp;<span class="ident" id="3865673">nil</span><span class="op" id="3865676">,</span>&nbsp;<span class="ident" id="3865678">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865690">return</span>&nbsp;<span class="ident" id="3865697">driverResult</span><span class="op" id="3865709">{</span><span class="ident" id="3865710">dc</span><span class="op" id="3865712">,</span>&nbsp;<span class="ident" id="3865714">resi</span><span class="op" id="3865718">}</span><span class="op" id="3865719">,</span>&nbsp;<span class="ident" id="3865721">nil</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3865734">dc</span><span class="op" id="3865736">.</span><span class="ident" id="3865737">Lock</span><span class="op" id="3865741">(</span><span class="op" id="3865742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3865745">si</span><span class="op" id="3865747">,</span>&nbsp;<span class="ident" id="3865749">err</span>&nbsp;<span class="op" id="3865753">:=</span>&nbsp;<span class="ident" id="3865756">dc</span><span class="op" id="3865758">.</span><span class="ident" id="3865759">ci</span><span class="op" id="3865761">.</span><span class="ident" id="3865762">Prepare</span><span class="op" id="3865769">(</span><span class="ident" id="3865770">query</span><span class="op" id="3865775">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3865778">dc</span><span class="op" id="3865780">.</span><span class="ident" id="3865781">Unlock</span><span class="op" id="3865787">(</span><span class="op" id="3865788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865791">if</span>&nbsp;<span class="ident" id="3865794">err</span>&nbsp;<span class="op" id="3865798">!=</span>&nbsp;<span class="ident" id="3865801">nil</span>&nbsp;<span class="op" id="3865805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865809">return</span>&nbsp;<span class="ident" id="3865816">nil</span><span class="op" id="3865819">,</span>&nbsp;<span class="ident" id="3865821">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865829">defer</span>&nbsp;<span class="ident" id="3865835">withLock</span><span class="op" id="3865843">(</span><span class="ident" id="3865844">dc</span><span class="op" id="3865846">,</span>&nbsp;<span class="keyword" id="3865848">func</span><span class="op" id="3865852">(</span><span class="op" id="3865853">)</span>&nbsp;<span class="op" id="3865855">{</span>&nbsp;<span class="ident" id="3865857">si</span><span class="op" id="3865859">.</span><span class="ident" id="3865860">Close</span><span class="op" id="3865865">(</span><span class="op" id="3865866">)</span>&nbsp;<span class="op" id="3865868">}</span><span class="op" id="3865869">)</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865872">return</span>&nbsp;<span class="ident" id="3865879">resultFromStatement</span><span class="op" id="3865898">(</span><span class="ident" id="3865899">driverStmt</span><span class="op" id="3865909">{</span><span class="ident" id="3865910">dc</span><span class="op" id="3865912">,</span>&nbsp;<span class="ident" id="3865914">si</span><span class="op" id="3865916">}</span><span class="op" id="3865917">,</span>&nbsp;<span class="ident" id="3865919">args</span><span class="op" id="3865923">...</span><span class="op" id="3865926">)</span><br>
<span class="lineno"></span><span class="op" id="3865928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3865931">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="comment" id="3865996">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno">920</span><span class="keyword" id="3866057">func</span>&nbsp;<span class="op" id="3866062">(</span><span class="ident" id="3866063">db</span>&nbsp;<span class="op" id="3866066">*</span><span class="ident" id="3866067">DB</span><span class="op" id="3866069">)</span>&nbsp;<span class="ident" id="3866071">Query</span><span class="op" id="3866076">(</span><span class="ident" id="3866077">query</span>&nbsp;<span class="builtintype" id="3866083">string</span><span class="op" id="3866089">,</span>&nbsp;<span class="ident" id="3866091">args</span>&nbsp;<span class="op" id="3866096">...</span><span class="keyword" id="3866099">interface</span><span class="op" id="3866108">{</span><span class="op" id="3866109">}</span><span class="op" id="3866110">)</span>&nbsp;<span class="op" id="3866112">(</span><span class="op" id="3866113">*</span><span class="ident" id="3866114">Rows</span><span class="op" id="3866118">,</span>&nbsp;<span class="builtintype" id="3866120">error</span><span class="op" id="3866125">)</span>&nbsp;<span class="op" id="3866127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866130">var</span>&nbsp;<span class="ident" id="3866134">rows</span>&nbsp;<span class="op" id="3866139">*</span><span class="ident" id="3866140">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866146">var</span>&nbsp;<span class="ident" id="3866150">err</span>&nbsp;<span class="builtintype" id="3866154">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866161">for</span>&nbsp;<span class="ident" id="3866165">i</span>&nbsp;<span class="op" id="3866167">:=</span>&nbsp;<span class="num" id="3866170">0</span><span class="op" id="3866171">;</span>&nbsp;<span class="ident" id="3866173">i</span>&nbsp;<span class="op" id="3866175">&lt;</span>&nbsp;<span class="ident" id="3866177">maxBadConnRetries</span><span class="op" id="3866194">;</span>&nbsp;<span class="ident" id="3866196">i</span><span class="op" id="3866197">++</span>&nbsp;<span class="op" id="3866200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866204">rows</span><span class="op" id="3866208">,</span>&nbsp;<span class="ident" id="3866210">err</span>&nbsp;<span class="op" id="3866214">=</span>&nbsp;<span class="ident" id="3866216">db</span><span class="op" id="3866218">.</span><span class="ident" id="3866219">query</span><span class="op" id="3866224">(</span><span class="ident" id="3866225">query</span><span class="op" id="3866230">,</span>&nbsp;<span class="ident" id="3866232">args</span><span class="op" id="3866236">)</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866240">if</span>&nbsp;<span class="ident" id="3866243">err</span>&nbsp;<span class="op" id="3866247">!=</span>&nbsp;<span class="ident" id="3866250">driver</span><span class="op" id="3866256">.</span><span class="ident" id="3866257">ErrBadConn</span>&nbsp;<span class="op" id="3866268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866273">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866287">return</span>&nbsp;<span class="ident" id="3866294">rows</span><span class="op" id="3866298">,</span>&nbsp;<span class="ident" id="3866300">err</span><br>
<span class="lineno">930</span><span class="op" id="3866304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3866307">func</span>&nbsp;<span class="op" id="3866312">(</span><span class="ident" id="3866313">db</span>&nbsp;<span class="op" id="3866316">*</span><span class="ident" id="3866317">DB</span><span class="op" id="3866319">)</span>&nbsp;<span class="ident" id="3866321">query</span><span class="op" id="3866326">(</span><span class="ident" id="3866327">query</span>&nbsp;<span class="builtintype" id="3866333">string</span><span class="op" id="3866339">,</span>&nbsp;<span class="ident" id="3866341">args</span>&nbsp;<span class="op" id="3866346">[</span><span class="op" id="3866347">]</span><span class="keyword" id="3866348">interface</span><span class="op" id="3866357">{</span><span class="op" id="3866358">}</span><span class="op" id="3866359">)</span>&nbsp;<span class="op" id="3866361">(</span><span class="op" id="3866362">*</span><span class="ident" id="3866363">Rows</span><span class="op" id="3866367">,</span>&nbsp;<span class="builtintype" id="3866369">error</span><span class="op" id="3866374">)</span>&nbsp;<span class="op" id="3866376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866379">ci</span><span class="op" id="3866381">,</span>&nbsp;<span class="ident" id="3866383">err</span>&nbsp;<span class="op" id="3866387">:=</span>&nbsp;<span class="ident" id="3866390">db</span><span class="op" id="3866392">.</span><span class="ident" id="3866393">conn</span><span class="op" id="3866397">(</span><span class="op" id="3866398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866401">if</span>&nbsp;<span class="ident" id="3866404">err</span>&nbsp;<span class="op" id="3866408">!=</span>&nbsp;<span class="ident" id="3866411">nil</span>&nbsp;<span class="op" id="3866415">{</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866419">return</span>&nbsp;<span class="ident" id="3866426">nil</span><span class="op" id="3866429">,</span>&nbsp;<span class="ident" id="3866431">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866440">return</span>&nbsp;<span class="ident" id="3866447">db</span><span class="op" id="3866449">.</span><span class="ident" id="3866450">queryConn</span><span class="op" id="3866459">(</span><span class="ident" id="3866460">ci</span><span class="op" id="3866462">,</span>&nbsp;<span class="ident" id="3866464">ci</span><span class="op" id="3866466">.</span><span class="ident" id="3866467">releaseConn</span><span class="op" id="3866478">,</span>&nbsp;<span class="ident" id="3866480">query</span><span class="op" id="3866485">,</span>&nbsp;<span class="ident" id="3866487">args</span><span class="op" id="3866491">)</span><br>
<span class="lineno"></span><span class="op" id="3866493">}</span><br>
<span class="lineno">940</span><br>
<span class="lineno"></span><span class="comment" id="3866496">//&nbsp;queryConn&nbsp;executes&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;given&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3866551">//&nbsp;The&nbsp;connection&nbsp;gets&nbsp;released&nbsp;by&nbsp;the&nbsp;releaseConn&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="3866612">func</span>&nbsp;<span class="op" id="3866617">(</span><span class="ident" id="3866618">db</span>&nbsp;<span class="op" id="3866621">*</span><span class="ident" id="3866622">DB</span><span class="op" id="3866624">)</span>&nbsp;<span class="ident" id="3866626">queryConn</span><span class="op" id="3866635">(</span><span class="ident" id="3866636">dc</span>&nbsp;<span class="op" id="3866639">*</span><span class="ident" id="3866640">driverConn</span><span class="op" id="3866650">,</span>&nbsp;<span class="ident" id="3866652">releaseConn</span>&nbsp;<span class="keyword" id="3866664">func</span><span class="op" id="3866668">(</span><span class="builtintype" id="3866669">error</span><span class="op" id="3866674">)</span><span class="op" id="3866675">,</span>&nbsp;<span class="ident" id="3866677">query</span>&nbsp;<span class="builtintype" id="3866683">string</span><span class="op" id="3866689">,</span>&nbsp;<span class="ident" id="3866691">args</span>&nbsp;<span class="op" id="3866696">[</span><span class="op" id="3866697">]</span><span class="keyword" id="3866698">interface</span><span class="op" id="3866707">{</span><span class="op" id="3866708">}</span><span class="op" id="3866709">)</span>&nbsp;<span class="op" id="3866711">(</span><span class="op" id="3866712">*</span><span class="ident" id="3866713">Rows</span><span class="op" id="3866717">,</span>&nbsp;<span class="builtintype" id="3866719">error</span><span class="op" id="3866724">)</span>&nbsp;<span class="op" id="3866726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866729">if</span>&nbsp;<span class="ident" id="3866732">queryer</span><span class="op" id="3866739">,</span>&nbsp;<span class="ident" id="3866741">ok</span>&nbsp;<span class="op" id="3866744">:=</span>&nbsp;<span class="ident" id="3866747">dc</span><span class="op" id="3866749">.</span><span class="ident" id="3866750">ci</span><span class="op" id="3866752">.</span><span class="op" id="3866753">(</span><span class="ident" id="3866754">driver</span><span class="op" id="3866760">.</span><span class="ident" id="3866761">Queryer</span><span class="op" id="3866768">)</span><span class="op" id="3866769">;</span>&nbsp;<span class="ident" id="3866771">ok</span>&nbsp;<span class="op" id="3866774">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866778">dargs</span><span class="op" id="3866783">,</span>&nbsp;<span class="ident" id="3866785">err</span>&nbsp;<span class="op" id="3866789">:=</span>&nbsp;<span class="ident" id="3866792">driverArgs</span><span class="op" id="3866802">(</span><span class="ident" id="3866803">nil</span><span class="op" id="3866806">,</span>&nbsp;<span class="ident" id="3866808">args</span><span class="op" id="3866812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866816">if</span>&nbsp;<span class="ident" id="3866819">err</span>&nbsp;<span class="op" id="3866823">!=</span>&nbsp;<span class="ident" id="3866826">nil</span>&nbsp;<span class="op" id="3866830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866835">releaseConn</span><span class="op" id="3866846">(</span><span class="ident" id="3866847">err</span><span class="op" id="3866850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866855">return</span>&nbsp;<span class="ident" id="3866862">nil</span><span class="op" id="3866865">,</span>&nbsp;<span class="ident" id="3866867">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866873">}</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866877">dc</span><span class="op" id="3866879">.</span><span class="ident" id="3866880">Lock</span><span class="op" id="3866884">(</span><span class="op" id="3866885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866889">rowsi</span><span class="op" id="3866894">,</span>&nbsp;<span class="ident" id="3866896">err</span>&nbsp;<span class="op" id="3866900">:=</span>&nbsp;<span class="ident" id="3866903">queryer</span><span class="op" id="3866910">.</span><span class="ident" id="3866911">Query</span><span class="op" id="3866916">(</span><span class="ident" id="3866917">query</span><span class="op" id="3866922">,</span>&nbsp;<span class="ident" id="3866924">dargs</span><span class="op" id="3866929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866933">dc</span><span class="op" id="3866935">.</span><span class="ident" id="3866936">Unlock</span><span class="op" id="3866942">(</span><span class="op" id="3866943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866947">if</span>&nbsp;<span class="ident" id="3866950">err</span>&nbsp;<span class="op" id="3866954">!=</span>&nbsp;<span class="ident" id="3866957">driver</span><span class="op" id="3866963">.</span><span class="ident" id="3866964">ErrSkip</span>&nbsp;<span class="op" id="3866972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866977">if</span>&nbsp;<span class="ident" id="3866980">err</span>&nbsp;<span class="op" id="3866984">!=</span>&nbsp;<span class="ident" id="3866987">nil</span>&nbsp;<span class="op" id="3866991">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866997">releaseConn</span><span class="op" id="3867008">(</span><span class="ident" id="3867009">err</span><span class="op" id="3867012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867018">return</span>&nbsp;<span class="ident" id="3867025">nil</span><span class="op" id="3867028">,</span>&nbsp;<span class="ident" id="3867030">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867042">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;dc&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867103">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867127">rows</span>&nbsp;<span class="op" id="3867132">:=</span>&nbsp;<span class="op" id="3867135">&amp;</span><span class="ident" id="3867136">Rows</span><span class="op" id="3867140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867146">dc</span><span class="op" id="3867148">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3867159">dc</span><span class="op" id="3867161">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867167">releaseConn</span><span class="op" id="3867178">:</span>&nbsp;<span class="ident" id="3867180">releaseConn</span><span class="op" id="3867191">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867197">rowsi</span><span class="op" id="3867202">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3867210">rowsi</span><span class="op" id="3867215">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867220">}</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867225">return</span>&nbsp;<span class="ident" id="3867232">rows</span><span class="op" id="3867236">,</span>&nbsp;<span class="ident" id="3867238">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867251">dc</span><span class="op" id="3867253">.</span><span class="ident" id="3867254">Lock</span><span class="op" id="3867258">(</span><span class="op" id="3867259">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867262">si</span><span class="op" id="3867264">,</span>&nbsp;<span class="ident" id="3867266">err</span>&nbsp;<span class="op" id="3867270">:=</span>&nbsp;<span class="ident" id="3867273">dc</span><span class="op" id="3867275">.</span><span class="ident" id="3867276">ci</span><span class="op" id="3867278">.</span><span class="ident" id="3867279">Prepare</span><span class="op" id="3867286">(</span><span class="ident" id="3867287">query</span><span class="op" id="3867292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867295">dc</span><span class="op" id="3867297">.</span><span class="ident" id="3867298">Unlock</span><span class="op" id="3867304">(</span><span class="op" id="3867305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867308">if</span>&nbsp;<span class="ident" id="3867311">err</span>&nbsp;<span class="op" id="3867315">!=</span>&nbsp;<span class="ident" id="3867318">nil</span>&nbsp;<span class="op" id="3867322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867326">releaseConn</span><span class="op" id="3867337">(</span><span class="ident" id="3867338">err</span><span class="op" id="3867341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867345">return</span>&nbsp;<span class="ident" id="3867352">nil</span><span class="op" id="3867355">,</span>&nbsp;<span class="ident" id="3867357">err</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867366">ds</span>&nbsp;<span class="op" id="3867369">:=</span>&nbsp;<span class="ident" id="3867372">driverStmt</span><span class="op" id="3867382">{</span><span class="ident" id="3867383">dc</span><span class="op" id="3867385">,</span>&nbsp;<span class="ident" id="3867387">si</span><span class="op" id="3867389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867392">rowsi</span><span class="op" id="3867397">,</span>&nbsp;<span class="ident" id="3867399">err</span>&nbsp;<span class="op" id="3867403">:=</span>&nbsp;<span class="ident" id="3867406">rowsiFromStatement</span><span class="op" id="3867424">(</span><span class="ident" id="3867425">ds</span><span class="op" id="3867427">,</span>&nbsp;<span class="ident" id="3867429">args</span><span class="op" id="3867433">...</span><span class="op" id="3867436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867439">if</span>&nbsp;<span class="ident" id="3867442">err</span>&nbsp;<span class="op" id="3867446">!=</span>&nbsp;<span class="ident" id="3867449">nil</span>&nbsp;<span class="op" id="3867453">{</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867457">dc</span><span class="op" id="3867459">.</span><span class="ident" id="3867460">Lock</span><span class="op" id="3867464">(</span><span class="op" id="3867465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867469">si</span><span class="op" id="3867471">.</span><span class="ident" id="3867472">Close</span><span class="op" id="3867477">(</span><span class="op" id="3867478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867482">dc</span><span class="op" id="3867484">.</span><span class="ident" id="3867485">Unlock</span><span class="op" id="3867491">(</span><span class="op" id="3867492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867496">releaseConn</span><span class="op" id="3867507">(</span><span class="ident" id="3867508">err</span><span class="op" id="3867511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867515">return</span>&nbsp;<span class="ident" id="3867522">nil</span><span class="op" id="3867525">,</span>&nbsp;<span class="ident" id="3867527">err</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867536">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867595">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867617">rows</span>&nbsp;<span class="op" id="3867622">:=</span>&nbsp;<span class="op" id="3867625">&amp;</span><span class="ident" id="3867626">Rows</span><span class="op" id="3867630">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867634">dc</span><span class="op" id="3867636">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3867647">dc</span><span class="op" id="3867649">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867653">releaseConn</span><span class="op" id="3867664">:</span>&nbsp;<span class="ident" id="3867666">releaseConn</span><span class="op" id="3867677">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867681">rowsi</span><span class="op" id="3867686">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3867694">rowsi</span><span class="op" id="3867699">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867703">closeStmt</span><span class="op" id="3867712">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3867716">si</span><span class="op" id="3867718">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867721">}</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867724">return</span>&nbsp;<span class="ident" id="3867731">rows</span><span class="op" id="3867735">,</span>&nbsp;<span class="ident" id="3867737">nil</span><br>
<span class="lineno"></span><span class="op" id="3867741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3867744">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="3867817">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno">1000</span><span class="comment" id="3867886">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="3867918">func</span>&nbsp;<span class="op" id="3867923">(</span><span class="ident" id="3867924">db</span>&nbsp;<span class="op" id="3867927">*</span><span class="ident" id="3867928">DB</span><span class="op" id="3867930">)</span>&nbsp;<span class="ident" id="3867932">QueryRow</span><span class="op" id="3867940">(</span><span class="ident" id="3867941">query</span>&nbsp;<span class="builtintype" id="3867947">string</span><span class="op" id="3867953">,</span>&nbsp;<span class="ident" id="3867955">args</span>&nbsp;<span class="op" id="3867960">...</span><span class="keyword" id="3867963">interface</span><span class="op" id="3867972">{</span><span class="op" id="3867973">}</span><span class="op" id="3867974">)</span>&nbsp;<span class="op" id="3867976">*</span><span class="ident" id="3867977">Row</span>&nbsp;<span class="op" id="3867981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867984">rows</span><span class="op" id="3867988">,</span>&nbsp;<span class="ident" id="3867990">err</span>&nbsp;<span class="op" id="3867994">:=</span>&nbsp;<span class="ident" id="3867997">db</span><span class="op" id="3867999">.</span><span class="ident" id="3868000">Query</span><span class="op" id="3868005">(</span><span class="ident" id="3868006">query</span><span class="op" id="3868011">,</span>&nbsp;<span class="ident" id="3868013">args</span><span class="op" id="3868017">...</span><span class="op" id="3868020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868023">return</span>&nbsp;<span class="op" id="3868030">&amp;</span><span class="ident" id="3868031">Row</span><span class="op" id="3868034">{</span><span class="ident" id="3868035">rows</span><span class="op" id="3868039">:</span>&nbsp;<span class="ident" id="3868041">rows</span><span class="op" id="3868045">,</span>&nbsp;<span class="ident" id="3868047">err</span><span class="op" id="3868050">:</span>&nbsp;<span class="ident" id="3868052">err</span><span class="op" id="3868055">}</span><br>
<span class="lineno"></span><span class="op" id="3868057">}</span><br>
<span class="lineno">1005</span><br>
<span class="lineno"></span><span class="comment" id="3868060">//&nbsp;Begin&nbsp;starts&nbsp;a&nbsp;transaction.&nbsp;The&nbsp;isolation&nbsp;level&nbsp;is&nbsp;dependent&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3868127">//&nbsp;the&nbsp;driver.</span><br>
<span class="lineno"></span><span class="keyword" id="3868142">func</span>&nbsp;<span class="op" id="3868147">(</span><span class="ident" id="3868148">db</span>&nbsp;<span class="op" id="3868151">*</span><span class="ident" id="3868152">DB</span><span class="op" id="3868154">)</span>&nbsp;<span class="ident" id="3868156">Begin</span><span class="op" id="3868161">(</span><span class="op" id="3868162">)</span>&nbsp;<span class="op" id="3868164">(</span><span class="op" id="3868165">*</span><span class="ident" id="3868166">Tx</span><span class="op" id="3868168">,</span>&nbsp;<span class="builtintype" id="3868170">error</span><span class="op" id="3868175">)</span>&nbsp;<span class="op" id="3868177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868180">var</span>&nbsp;<span class="ident" id="3868184">tx</span>&nbsp;<span class="op" id="3868187">*</span><span class="ident" id="3868188">Tx</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868192">var</span>&nbsp;<span class="ident" id="3868196">err</span>&nbsp;<span class="builtintype" id="3868200">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868207">for</span>&nbsp;<span class="ident" id="3868211">i</span>&nbsp;<span class="op" id="3868213">:=</span>&nbsp;<span class="num" id="3868216">0</span><span class="op" id="3868217">;</span>&nbsp;<span class="ident" id="3868219">i</span>&nbsp;<span class="op" id="3868221">&lt;</span>&nbsp;<span class="ident" id="3868223">maxBadConnRetries</span><span class="op" id="3868240">;</span>&nbsp;<span class="ident" id="3868242">i</span><span class="op" id="3868243">++</span>&nbsp;<span class="op" id="3868246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868250">tx</span><span class="op" id="3868252">,</span>&nbsp;<span class="ident" id="3868254">err</span>&nbsp;<span class="op" id="3868258">=</span>&nbsp;<span class="ident" id="3868260">db</span><span class="op" id="3868262">.</span><span class="ident" id="3868263">begin</span><span class="op" id="3868268">(</span><span class="op" id="3868269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868273">if</span>&nbsp;<span class="ident" id="3868276">err</span>&nbsp;<span class="op" id="3868280">!=</span>&nbsp;<span class="ident" id="3868283">driver</span><span class="op" id="3868289">.</span><span class="ident" id="3868290">ErrBadConn</span>&nbsp;<span class="op" id="3868301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868306">break</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868320">return</span>&nbsp;<span class="ident" id="3868327">tx</span><span class="op" id="3868329">,</span>&nbsp;<span class="ident" id="3868331">err</span><br>
<span class="lineno"></span><span class="op" id="3868335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1020</span><span class="keyword" id="3868338">func</span>&nbsp;<span class="op" id="3868343">(</span><span class="ident" id="3868344">db</span>&nbsp;<span class="op" id="3868347">*</span><span class="ident" id="3868348">DB</span><span class="op" id="3868350">)</span>&nbsp;<span class="ident" id="3868352">begin</span><span class="op" id="3868357">(</span><span class="op" id="3868358">)</span>&nbsp;<span class="op" id="3868360">(</span><span class="ident" id="3868361">tx</span>&nbsp;<span class="op" id="3868364">*</span><span class="ident" id="3868365">Tx</span><span class="op" id="3868367">,</span>&nbsp;<span class="ident" id="3868369">err</span>&nbsp;<span class="builtintype" id="3868373">error</span><span class="op" id="3868378">)</span>&nbsp;<span class="op" id="3868380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868383">dc</span><span class="op" id="3868385">,</span>&nbsp;<span class="ident" id="3868387">err</span>&nbsp;<span class="op" id="3868391">:=</span>&nbsp;<span class="ident" id="3868394">db</span><span class="op" id="3868396">.</span><span class="ident" id="3868397">conn</span><span class="op" id="3868401">(</span><span class="op" id="3868402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868405">if</span>&nbsp;<span class="ident" id="3868408">err</span>&nbsp;<span class="op" id="3868412">!=</span>&nbsp;<span class="ident" id="3868415">nil</span>&nbsp;<span class="op" id="3868419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868423">return</span>&nbsp;<span class="ident" id="3868430">nil</span><span class="op" id="3868433">,</span>&nbsp;<span class="ident" id="3868435">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868440">}</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868443">dc</span><span class="op" id="3868445">.</span><span class="ident" id="3868446">Lock</span><span class="op" id="3868450">(</span><span class="op" id="3868451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868454">txi</span><span class="op" id="3868457">,</span>&nbsp;<span class="ident" id="3868459">err</span>&nbsp;<span class="op" id="3868463">:=</span>&nbsp;<span class="ident" id="3868466">dc</span><span class="op" id="3868468">.</span><span class="ident" id="3868469">ci</span><span class="op" id="3868471">.</span><span class="ident" id="3868472">Begin</span><span class="op" id="3868477">(</span><span class="op" id="3868478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868481">dc</span><span class="op" id="3868483">.</span><span class="ident" id="3868484">Unlock</span><span class="op" id="3868490">(</span><span class="op" id="3868491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868494">if</span>&nbsp;<span class="ident" id="3868497">err</span>&nbsp;<span class="op" id="3868501">!=</span>&nbsp;<span class="ident" id="3868504">nil</span>&nbsp;<span class="op" id="3868508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868512">db</span><span class="op" id="3868514">.</span><span class="ident" id="3868515">putConn</span><span class="op" id="3868522">(</span><span class="ident" id="3868523">dc</span><span class="op" id="3868525">,</span>&nbsp;<span class="ident" id="3868527">err</span><span class="op" id="3868530">)</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868534">return</span>&nbsp;<span class="ident" id="3868541">nil</span><span class="op" id="3868544">,</span>&nbsp;<span class="ident" id="3868546">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868554">return</span>&nbsp;<span class="op" id="3868561">&amp;</span><span class="ident" id="3868562">Tx</span><span class="op" id="3868564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868568">db</span><span class="op" id="3868570">:</span>&nbsp;&nbsp;<span class="ident" id="3868573">db</span><span class="op" id="3868575">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868579">dc</span><span class="op" id="3868581">:</span>&nbsp;&nbsp;<span class="ident" id="3868584">dc</span><span class="op" id="3868586">,</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868590">txi</span><span class="op" id="3868593">:</span>&nbsp;<span class="ident" id="3868595">txi</span><span class="op" id="3868598">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868601">}</span><span class="op" id="3868602">,</span>&nbsp;<span class="ident" id="3868604">nil</span><br>
<span class="lineno"></span><span class="op" id="3868608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3868611">//&nbsp;Driver&nbsp;returns&nbsp;the&nbsp;database&#39;s&nbsp;underlying&nbsp;driver.</span><br>
<span class="lineno">1040</span><span class="keyword" id="3868663">func</span>&nbsp;<span class="op" id="3868668">(</span><span class="ident" id="3868669">db</span>&nbsp;<span class="op" id="3868672">*</span><span class="ident" id="3868673">DB</span><span class="op" id="3868675">)</span>&nbsp;<span class="ident" id="3868677">Driver</span><span class="op" id="3868683">(</span><span class="op" id="3868684">)</span>&nbsp;<span class="ident" id="3868686">driver</span><span class="op" id="3868692">.</span><span class="ident" id="3868693">Driver</span>&nbsp;<span class="op" id="3868700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868703">return</span>&nbsp;<span class="ident" id="3868710">db</span><span class="op" id="3868712">.</span><span class="ident" id="3868713">driver</span><br>
<span class="lineno"></span><span class="op" id="3868720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3868723">//&nbsp;Tx&nbsp;is&nbsp;an&nbsp;in-progress&nbsp;database&nbsp;transaction.</span><br>
<span class="lineno">1045</span><span class="comment" id="3868769">//</span><br>
<span class="lineno"></span><span class="comment" id="3868772">//&nbsp;A&nbsp;transaction&nbsp;must&nbsp;end&nbsp;with&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback.</span><br>
<span class="lineno"></span><span class="comment" id="3868833">//</span><br>
<span class="lineno"></span><span class="comment" id="3868836">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;all&nbsp;operations&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3868897">//&nbsp;transaction&nbsp;fail&nbsp;with&nbsp;ErrTxDone.</span><br>
<span class="lineno">1050</span><span class="keyword" id="3868933">type</span>&nbsp;<span class="ident" id="3868938">Tx</span>&nbsp;<span class="keyword" id="3868941">struct</span>&nbsp;<span class="op" id="3868948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868951">db</span>&nbsp;<span class="op" id="3868954">*</span><span class="ident" id="3868955">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3868960">//&nbsp;dc&nbsp;is&nbsp;owned&nbsp;exclusively&nbsp;until&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;at&nbsp;which&nbsp;point</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3869029">//&nbsp;it&#39;s&nbsp;returned&nbsp;with&nbsp;putConn.</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869061">dc</span>&nbsp;&nbsp;<span class="op" id="3869065">*</span><span class="ident" id="3869066">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869078">txi</span>&nbsp;<span class="ident" id="3869082">driver</span><span class="op" id="3869088">.</span><span class="ident" id="3869089">Tx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3869094">//&nbsp;done&nbsp;transitions&nbsp;from&nbsp;false&nbsp;to&nbsp;true&nbsp;exactly&nbsp;once,&nbsp;on&nbsp;Commit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3869158">//&nbsp;or&nbsp;Rollback.&nbsp;once&nbsp;done,&nbsp;all&nbsp;operations&nbsp;fail&nbsp;with</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3869211">//&nbsp;ErrTxDone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869226">done</span>&nbsp;<span class="builtintype" id="3869231">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3869238">//&nbsp;All&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.&nbsp;&nbsp;These&nbsp;will&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3869315">//&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869366">stmts</span>&nbsp;<span class="keyword" id="3869372">struct</span>&nbsp;<span class="op" id="3869379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869383">sync</span><span class="op" id="3869387">.</span><span class="ident" id="3869388">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869396">v</span>&nbsp;<span class="op" id="3869398">[</span><span class="op" id="3869399">]</span><span class="op" id="3869400">*</span><span class="ident" id="3869401">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869407">}</span><br>
<span class="lineno"></span><span class="op" id="3869409">}</span><br>
<span class="lineno">1070</span><br>
<span class="lineno"></span><span class="keyword" id="3869412">var</span>&nbsp;<span class="ident" id="3869416">ErrTxDone</span>&nbsp;<span class="op" id="3869426">=</span>&nbsp;<span class="ident" id="3869428">errors</span><span class="op" id="3869434">.</span><span class="ident" id="3869435">New</span><span class="op" id="3869438">(</span><span class="string" id="3869439">&#34;sql:&nbsp;Transaction&nbsp;has&nbsp;already&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back&#34;</span><span class="op" id="3869499">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3869502">func</span>&nbsp;<span class="op" id="3869507">(</span><span class="ident" id="3869508">tx</span>&nbsp;<span class="op" id="3869511">*</span><span class="ident" id="3869512">Tx</span><span class="op" id="3869514">)</span>&nbsp;<span class="builtinfunc" id="3869516">close</span><span class="op" id="3869521">(</span><span class="op" id="3869522">)</span>&nbsp;<span class="op" id="3869524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869527">if</span>&nbsp;<span class="ident" id="3869530">tx</span><span class="op" id="3869532">.</span><span class="ident" id="3869533">done</span>&nbsp;<span class="op" id="3869538">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3869542">panic</span><span class="op" id="3869547">(</span><span class="string" id="3869548">&#34;double&nbsp;close&#34;</span><span class="op" id="3869562">)</span>&nbsp;<span class="comment" id="3869564">//&nbsp;internal&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869586">tx</span><span class="op" id="3869588">.</span><span class="ident" id="3869589">done</span>&nbsp;<span class="op" id="3869594">=</span>&nbsp;<span class="builtintype" id="3869596">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869602">tx</span><span class="op" id="3869604">.</span><span class="ident" id="3869605">db</span><span class="op" id="3869607">.</span><span class="ident" id="3869608">putConn</span><span class="op" id="3869615">(</span><span class="ident" id="3869616">tx</span><span class="op" id="3869618">.</span><span class="ident" id="3869619">dc</span><span class="op" id="3869621">,</span>&nbsp;<span class="ident" id="3869623">nil</span><span class="op" id="3869626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869629">tx</span><span class="op" id="3869631">.</span><span class="ident" id="3869632">dc</span>&nbsp;<span class="op" id="3869635">=</span>&nbsp;<span class="ident" id="3869637">nil</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869642">tx</span><span class="op" id="3869644">.</span><span class="ident" id="3869645">txi</span>&nbsp;<span class="op" id="3869649">=</span>&nbsp;<span class="ident" id="3869651">nil</span><br>
<span class="lineno"></span><span class="op" id="3869655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3869658">func</span>&nbsp;<span class="op" id="3869663">(</span><span class="ident" id="3869664">tx</span>&nbsp;<span class="op" id="3869667">*</span><span class="ident" id="3869668">Tx</span><span class="op" id="3869670">)</span>&nbsp;<span class="ident" id="3869672">grabConn</span><span class="op" id="3869680">(</span><span class="op" id="3869681">)</span>&nbsp;<span class="op" id="3869683">(</span><span class="op" id="3869684">*</span><span class="ident" id="3869685">driverConn</span><span class="op" id="3869695">,</span>&nbsp;<span class="builtintype" id="3869697">error</span><span class="op" id="3869702">)</span>&nbsp;<span class="op" id="3869704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869707">if</span>&nbsp;<span class="ident" id="3869710">tx</span><span class="op" id="3869712">.</span><span class="ident" id="3869713">done</span>&nbsp;<span class="op" id="3869718">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869722">return</span>&nbsp;<span class="ident" id="3869729">nil</span><span class="op" id="3869732">,</span>&nbsp;<span class="ident" id="3869734">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869748">return</span>&nbsp;<span class="ident" id="3869755">tx</span><span class="op" id="3869757">.</span><span class="ident" id="3869758">dc</span><span class="op" id="3869760">,</span>&nbsp;<span class="ident" id="3869762">nil</span><br>
<span class="lineno"></span><span class="op" id="3869766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1090</span><span class="comment" id="3869769">//&nbsp;Closes&nbsp;all&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.</span><br>
<span class="lineno"></span><span class="keyword" id="3869820">func</span>&nbsp;<span class="op" id="3869825">(</span><span class="ident" id="3869826">tx</span>&nbsp;<span class="op" id="3869829">*</span><span class="ident" id="3869830">Tx</span><span class="op" id="3869832">)</span>&nbsp;<span class="ident" id="3869834">closePrepared</span><span class="op" id="3869847">(</span><span class="op" id="3869848">)</span>&nbsp;<span class="op" id="3869850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869853">tx</span><span class="op" id="3869855">.</span><span class="ident" id="3869856">stmts</span><span class="op" id="3869861">.</span><span class="ident" id="3869862">Lock</span><span class="op" id="3869866">(</span><span class="op" id="3869867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869870">for</span>&nbsp;<span class="ident" id="3869874">_</span><span class="op" id="3869875">,</span>&nbsp;<span class="ident" id="3869877">stmt</span>&nbsp;<span class="op" id="3869882">:=</span>&nbsp;<span class="keyword" id="3869885">range</span>&nbsp;<span class="ident" id="3869891">tx</span><span class="op" id="3869893">.</span><span class="ident" id="3869894">stmts</span><span class="op" id="3869899">.</span><span class="ident" id="3869900">v</span>&nbsp;<span class="op" id="3869902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869906">stmt</span><span class="op" id="3869910">.</span><span class="ident" id="3869911">Close</span><span class="op" id="3869916">(</span><span class="op" id="3869917">)</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869923">tx</span><span class="op" id="3869925">.</span><span class="ident" id="3869926">stmts</span><span class="op" id="3869931">.</span><span class="ident" id="3869932">Unlock</span><span class="op" id="3869938">(</span><span class="op" id="3869939">)</span><br>
<span class="lineno"></span><span class="op" id="3869941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3869944">//&nbsp;Commit&nbsp;commits&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1100</span><span class="keyword" id="3869979">func</span>&nbsp;<span class="op" id="3869984">(</span><span class="ident" id="3869985">tx</span>&nbsp;<span class="op" id="3869988">*</span><span class="ident" id="3869989">Tx</span><span class="op" id="3869991">)</span>&nbsp;<span class="ident" id="3869993">Commit</span><span class="op" id="3869999">(</span><span class="op" id="3870000">)</span>&nbsp;<span class="builtintype" id="3870002">error</span>&nbsp;<span class="op" id="3870008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870011">if</span>&nbsp;<span class="ident" id="3870014">tx</span><span class="op" id="3870016">.</span><span class="ident" id="3870017">done</span>&nbsp;<span class="op" id="3870022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870026">return</span>&nbsp;<span class="ident" id="3870033">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870047">defer</span>&nbsp;<span class="ident" id="3870053">tx</span><span class="op" id="3870055">.</span><span class="builtinfunc" id="3870056">close</span><span class="op" id="3870061">(</span><span class="op" id="3870062">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870065">tx</span><span class="op" id="3870067">.</span><span class="ident" id="3870068">dc</span><span class="op" id="3870070">.</span><span class="ident" id="3870071">Lock</span><span class="op" id="3870075">(</span><span class="op" id="3870076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870079">err</span>&nbsp;<span class="op" id="3870083">:=</span>&nbsp;<span class="ident" id="3870086">tx</span><span class="op" id="3870088">.</span><span class="ident" id="3870089">txi</span><span class="op" id="3870092">.</span><span class="ident" id="3870093">Commit</span><span class="op" id="3870099">(</span><span class="op" id="3870100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870103">tx</span><span class="op" id="3870105">.</span><span class="ident" id="3870106">dc</span><span class="op" id="3870108">.</span><span class="ident" id="3870109">Unlock</span><span class="op" id="3870115">(</span><span class="op" id="3870116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870119">if</span>&nbsp;<span class="ident" id="3870122">err</span>&nbsp;<span class="op" id="3870126">!=</span>&nbsp;<span class="ident" id="3870129">driver</span><span class="op" id="3870135">.</span><span class="ident" id="3870136">ErrBadConn</span>&nbsp;<span class="op" id="3870147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870151">tx</span><span class="op" id="3870153">.</span><span class="ident" id="3870154">closePrepared</span><span class="op" id="3870167">(</span><span class="op" id="3870168">)</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870174">return</span>&nbsp;<span class="ident" id="3870181">err</span><br>
<span class="lineno"></span><span class="op" id="3870185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3870188">//&nbsp;Rollback&nbsp;aborts&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1115</span><span class="keyword" id="3870224">func</span>&nbsp;<span class="op" id="3870229">(</span><span class="ident" id="3870230">tx</span>&nbsp;<span class="op" id="3870233">*</span><span class="ident" id="3870234">Tx</span><span class="op" id="3870236">)</span>&nbsp;<span class="ident" id="3870238">Rollback</span><span class="op" id="3870246">(</span><span class="op" id="3870247">)</span>&nbsp;<span class="builtintype" id="3870249">error</span>&nbsp;<span class="op" id="3870255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870258">if</span>&nbsp;<span class="ident" id="3870261">tx</span><span class="op" id="3870263">.</span><span class="ident" id="3870264">done</span>&nbsp;<span class="op" id="3870269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870273">return</span>&nbsp;<span class="ident" id="3870280">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870294">defer</span>&nbsp;<span class="ident" id="3870300">tx</span><span class="op" id="3870302">.</span><span class="builtinfunc" id="3870303">close</span><span class="op" id="3870308">(</span><span class="op" id="3870309">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870312">tx</span><span class="op" id="3870314">.</span><span class="ident" id="3870315">dc</span><span class="op" id="3870317">.</span><span class="ident" id="3870318">Lock</span><span class="op" id="3870322">(</span><span class="op" id="3870323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870326">err</span>&nbsp;<span class="op" id="3870330">:=</span>&nbsp;<span class="ident" id="3870333">tx</span><span class="op" id="3870335">.</span><span class="ident" id="3870336">txi</span><span class="op" id="3870339">.</span><span class="ident" id="3870340">Rollback</span><span class="op" id="3870348">(</span><span class="op" id="3870349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870352">tx</span><span class="op" id="3870354">.</span><span class="ident" id="3870355">dc</span><span class="op" id="3870357">.</span><span class="ident" id="3870358">Unlock</span><span class="op" id="3870364">(</span><span class="op" id="3870365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870368">if</span>&nbsp;<span class="ident" id="3870371">err</span>&nbsp;<span class="op" id="3870375">!=</span>&nbsp;<span class="ident" id="3870378">driver</span><span class="op" id="3870384">.</span><span class="ident" id="3870385">ErrBadConn</span>&nbsp;<span class="op" id="3870396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870400">tx</span><span class="op" id="3870402">.</span><span class="ident" id="3870403">closePrepared</span><span class="op" id="3870416">(</span><span class="op" id="3870417">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870423">return</span>&nbsp;<span class="ident" id="3870430">err</span><br>
<span class="lineno"></span><span class="op" id="3870434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3870437">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;use&nbsp;within&nbsp;a&nbsp;transaction.</span><br>
<span class="lineno">1130</span><span class="comment" id="3870507">//</span><br>
<span class="lineno"></span><span class="comment" id="3870510">//&nbsp;The&nbsp;returned&nbsp;statement&nbsp;operates&nbsp;within&nbsp;the&nbsp;transaction&nbsp;and&nbsp;can&nbsp;no&nbsp;longer</span><br>
<span class="lineno"></span><span class="comment" id="3870586">//&nbsp;be&nbsp;used&nbsp;once&nbsp;the&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno"></span><span class="comment" id="3870653">//</span><br>
<span class="lineno"></span><span class="comment" id="3870656">//&nbsp;To&nbsp;use&nbsp;an&nbsp;existing&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;this&nbsp;transaction,&nbsp;see&nbsp;Tx.Stmt.</span><br>
<span class="lineno">1135</span><span class="keyword" id="3870731">func</span>&nbsp;<span class="op" id="3870736">(</span><span class="ident" id="3870737">tx</span>&nbsp;<span class="op" id="3870740">*</span><span class="ident" id="3870741">Tx</span><span class="op" id="3870743">)</span>&nbsp;<span class="ident" id="3870745">Prepare</span><span class="op" id="3870752">(</span><span class="ident" id="3870753">query</span>&nbsp;<span class="builtintype" id="3870759">string</span><span class="op" id="3870765">)</span>&nbsp;<span class="op" id="3870767">(</span><span class="op" id="3870768">*</span><span class="ident" id="3870769">Stmt</span><span class="op" id="3870773">,</span>&nbsp;<span class="builtintype" id="3870775">error</span><span class="op" id="3870780">)</span>&nbsp;<span class="op" id="3870782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3870785">//&nbsp;TODO(bradfitz):&nbsp;We&nbsp;could&nbsp;be&nbsp;more&nbsp;efficient&nbsp;here&nbsp;and&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3870848">//&nbsp;provide&nbsp;a&nbsp;method&nbsp;to&nbsp;take&nbsp;an&nbsp;existing&nbsp;Stmt&nbsp;(created&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3870906">//&nbsp;perhaps&nbsp;a&nbsp;different&nbsp;Conn),&nbsp;and&nbsp;re-create&nbsp;it&nbsp;on&nbsp;this&nbsp;Conn&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3870970">//&nbsp;necessary.&nbsp;Or,&nbsp;better:&nbsp;keep&nbsp;a&nbsp;map&nbsp;in&nbsp;DB&nbsp;of&nbsp;query&nbsp;string&nbsp;to</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871033">//&nbsp;Stmts,&nbsp;and&nbsp;have&nbsp;Stmt.Execute&nbsp;do&nbsp;the&nbsp;right&nbsp;thing&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871089">//&nbsp;re-prepare&nbsp;if&nbsp;the&nbsp;Conn&nbsp;in&nbsp;use&nbsp;doesn&#39;t&nbsp;have&nbsp;that&nbsp;prepared</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871150">//&nbsp;statement.&nbsp;&nbsp;But&nbsp;we&#39;ll&nbsp;want&nbsp;to&nbsp;avoid&nbsp;caching&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871212">//&nbsp;in&nbsp;the&nbsp;case&nbsp;where&nbsp;we&nbsp;only&nbsp;call&nbsp;conn.Prepare&nbsp;implicitly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871271">//&nbsp;(such&nbsp;as&nbsp;in&nbsp;db.Exec&nbsp;or&nbsp;tx.Exec),&nbsp;but&nbsp;the&nbsp;caller&nbsp;package</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871331">//&nbsp;can&#39;t&nbsp;be&nbsp;holding&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871391">//&nbsp;Perhaps&nbsp;just&nbsp;looking&nbsp;at&nbsp;the&nbsp;reference&nbsp;count&nbsp;(by&nbsp;noting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871450">//&nbsp;Stmt.Close)&nbsp;would&nbsp;be&nbsp;enough.&nbsp;We&nbsp;might&nbsp;also&nbsp;want&nbsp;a&nbsp;finalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871514">//&nbsp;on&nbsp;Stmt&nbsp;to&nbsp;drop&nbsp;the&nbsp;reference&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871555">dc</span><span class="op" id="3871557">,</span>&nbsp;<span class="ident" id="3871559">err</span>&nbsp;<span class="op" id="3871563">:=</span>&nbsp;<span class="ident" id="3871566">tx</span><span class="op" id="3871568">.</span><span class="ident" id="3871569">grabConn</span><span class="op" id="3871577">(</span><span class="op" id="3871578">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871581">if</span>&nbsp;<span class="ident" id="3871584">err</span>&nbsp;<span class="op" id="3871588">!=</span>&nbsp;<span class="ident" id="3871591">nil</span>&nbsp;<span class="op" id="3871595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871599">return</span>&nbsp;<span class="ident" id="3871606">nil</span><span class="op" id="3871609">,</span>&nbsp;<span class="ident" id="3871611">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3871616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871620">dc</span><span class="op" id="3871622">.</span><span class="ident" id="3871623">Lock</span><span class="op" id="3871627">(</span><span class="op" id="3871628">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871631">si</span><span class="op" id="3871633">,</span>&nbsp;<span class="ident" id="3871635">err</span>&nbsp;<span class="op" id="3871639">:=</span>&nbsp;<span class="ident" id="3871642">dc</span><span class="op" id="3871644">.</span><span class="ident" id="3871645">ci</span><span class="op" id="3871647">.</span><span class="ident" id="3871648">Prepare</span><span class="op" id="3871655">(</span><span class="ident" id="3871656">query</span><span class="op" id="3871661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871664">dc</span><span class="op" id="3871666">.</span><span class="ident" id="3871667">Unlock</span><span class="op" id="3871673">(</span><span class="op" id="3871674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871677">if</span>&nbsp;<span class="ident" id="3871680">err</span>&nbsp;<span class="op" id="3871684">!=</span>&nbsp;<span class="ident" id="3871687">nil</span>&nbsp;<span class="op" id="3871691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871695">return</span>&nbsp;<span class="ident" id="3871702">nil</span><span class="op" id="3871705">,</span>&nbsp;<span class="ident" id="3871707">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3871712">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871716">stmt</span>&nbsp;<span class="op" id="3871721">:=</span>&nbsp;<span class="op" id="3871724">&amp;</span><span class="ident" id="3871725">Stmt</span><span class="op" id="3871729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871733">db</span><span class="op" id="3871735">:</span>&nbsp;<span class="ident" id="3871737">tx</span><span class="op" id="3871739">.</span><span class="ident" id="3871740">db</span><span class="op" id="3871742">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871746">tx</span><span class="op" id="3871748">:</span>&nbsp;<span class="ident" id="3871750">tx</span><span class="op" id="3871752">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871756">txsi</span><span class="op" id="3871760">:</span>&nbsp;<span class="op" id="3871762">&amp;</span><span class="ident" id="3871763">driverStmt</span><span class="op" id="3871773">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871778">Locker</span><span class="op" id="3871784">:</span>&nbsp;<span class="ident" id="3871786">dc</span><span class="op" id="3871788">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871793">si</span><span class="op" id="3871795">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3871801">si</span><span class="op" id="3871803">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3871807">}</span><span class="op" id="3871808">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871812">query</span><span class="op" id="3871817">:</span>&nbsp;<span class="ident" id="3871819">query</span><span class="op" id="3871824">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3871827">}</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871830">tx</span><span class="op" id="3871832">.</span><span class="ident" id="3871833">stmts</span><span class="op" id="3871838">.</span><span class="ident" id="3871839">Lock</span><span class="op" id="3871843">(</span><span class="op" id="3871844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871847">tx</span><span class="op" id="3871849">.</span><span class="ident" id="3871850">stmts</span><span class="op" id="3871855">.</span><span class="ident" id="3871856">v</span>&nbsp;<span class="op" id="3871858">=</span>&nbsp;<span class="builtinfunc" id="3871860">append</span><span class="op" id="3871866">(</span><span class="ident" id="3871867">tx</span><span class="op" id="3871869">.</span><span class="ident" id="3871870">stmts</span><span class="op" id="3871875">.</span><span class="ident" id="3871876">v</span><span class="op" id="3871877">,</span>&nbsp;<span class="ident" id="3871879">stmt</span><span class="op" id="3871883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871886">tx</span><span class="op" id="3871888">.</span><span class="ident" id="3871889">stmts</span><span class="op" id="3871894">.</span><span class="ident" id="3871895">Unlock</span><span class="op" id="3871901">(</span><span class="op" id="3871902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871905">return</span>&nbsp;<span class="ident" id="3871912">stmt</span><span class="op" id="3871916">,</span>&nbsp;<span class="ident" id="3871918">nil</span><br>
<span class="lineno"></span><span class="op" id="3871922">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span><span class="comment" id="3871925">//&nbsp;Stmt&nbsp;returns&nbsp;a&nbsp;transaction-specific&nbsp;prepared&nbsp;statement&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="3871988">//&nbsp;an&nbsp;existing&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="3872014">//</span><br>
<span class="lineno"></span><span class="comment" id="3872017">//&nbsp;Example:</span><br>
<span class="lineno">1180</span><span class="comment" id="3872029">//&nbsp;&nbsp;updateMoney,&nbsp;err&nbsp;:=&nbsp;db.Prepare(&#34;UPDATE&nbsp;balance&nbsp;SET&nbsp;money=money+?&nbsp;WHERE&nbsp;id=?&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3872111">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="3872119">//&nbsp;&nbsp;tx,&nbsp;err&nbsp;:=&nbsp;db.Begin()</span><br>
<span class="lineno"></span><span class="comment" id="3872145">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="3872153">//&nbsp;&nbsp;res,&nbsp;err&nbsp;:=&nbsp;tx.Stmt(updateMoney).Exec(123.45,&nbsp;98293203)</span><br>
<span class="lineno">1185</span><span class="keyword" id="3872213">func</span>&nbsp;<span class="op" id="3872218">(</span><span class="ident" id="3872219">tx</span>&nbsp;<span class="op" id="3872222">*</span><span class="ident" id="3872223">Tx</span><span class="op" id="3872225">)</span>&nbsp;<span class="ident" id="3872227">Stmt</span><span class="op" id="3872231">(</span><span class="ident" id="3872232">stmt</span>&nbsp;<span class="op" id="3872237">*</span><span class="ident" id="3872238">Stmt</span><span class="op" id="3872242">)</span>&nbsp;<span class="op" id="3872244">*</span><span class="ident" id="3872245">Stmt</span>&nbsp;<span class="op" id="3872250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3872253">//&nbsp;TODO(bradfitz):&nbsp;optimize&nbsp;this.&nbsp;Currently&nbsp;this&nbsp;re-prepares</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3872315">//&nbsp;each&nbsp;time.&nbsp;&nbsp;This&nbsp;is&nbsp;fine&nbsp;for&nbsp;now&nbsp;to&nbsp;illustrate&nbsp;the&nbsp;API&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3872378">//&nbsp;we&nbsp;should&nbsp;really&nbsp;cache&nbsp;already-prepared&nbsp;statements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3872433">//&nbsp;per-Conn.&nbsp;See&nbsp;also&nbsp;the&nbsp;big&nbsp;comment&nbsp;in&nbsp;Tx.Prepare.</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3872488">if</span>&nbsp;<span class="ident" id="3872491">tx</span><span class="op" id="3872493">.</span><span class="ident" id="3872494">db</span>&nbsp;<span class="op" id="3872497">!=</span>&nbsp;<span class="ident" id="3872500">stmt</span><span class="op" id="3872504">.</span><span class="ident" id="3872505">db</span>&nbsp;<span class="op" id="3872508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3872512">return</span>&nbsp;<span class="op" id="3872519">&amp;</span><span class="ident" id="3872520">Stmt</span><span class="op" id="3872524">{</span><span class="ident" id="3872525">stickyErr</span><span class="op" id="3872534">:</span>&nbsp;<span class="ident" id="3872536">errors</span><span class="op" id="3872542">.</span><span class="ident" id="3872543">New</span><span class="op" id="3872546">(</span><span class="string" id="3872547">&#34;sql:&nbsp;Tx.Stmt:&nbsp;statement&nbsp;from&nbsp;different&nbsp;database&nbsp;used&#34;</span><span class="op" id="3872601">)</span><span class="op" id="3872602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3872605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872608">dc</span><span class="op" id="3872610">,</span>&nbsp;<span class="ident" id="3872612">err</span>&nbsp;<span class="op" id="3872616">:=</span>&nbsp;<span class="ident" id="3872619">tx</span><span class="op" id="3872621">.</span><span class="ident" id="3872622">grabConn</span><span class="op" id="3872630">(</span><span class="op" id="3872631">)</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3872634">if</span>&nbsp;<span class="ident" id="3872637">err</span>&nbsp;<span class="op" id="3872641">!=</span>&nbsp;<span class="ident" id="3872644">nil</span>&nbsp;<span class="op" id="3872648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3872652">return</span>&nbsp;<span class="op" id="3872659">&amp;</span><span class="ident" id="3872660">Stmt</span><span class="op" id="3872664">{</span><span class="ident" id="3872665">stickyErr</span><span class="op" id="3872674">:</span>&nbsp;<span class="ident" id="3872676">err</span><span class="op" id="3872679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3872682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872685">dc</span><span class="op" id="3872687">.</span><span class="ident" id="3872688">Lock</span><span class="op" id="3872692">(</span><span class="op" id="3872693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872696">si</span><span class="op" id="3872698">,</span>&nbsp;<span class="ident" id="3872700">err</span>&nbsp;<span class="op" id="3872704">:=</span>&nbsp;<span class="ident" id="3872707">dc</span><span class="op" id="3872709">.</span><span class="ident" id="3872710">ci</span><span class="op" id="3872712">.</span><span class="ident" id="3872713">Prepare</span><span class="op" id="3872720">(</span><span class="ident" id="3872721">stmt</span><span class="op" id="3872725">.</span><span class="ident" id="3872726">query</span><span class="op" id="3872731">)</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872734">dc</span><span class="op" id="3872736">.</span><span class="ident" id="3872737">Unlock</span><span class="op" id="3872743">(</span><span class="op" id="3872744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872747">txs</span>&nbsp;<span class="op" id="3872751">:=</span>&nbsp;<span class="op" id="3872754">&amp;</span><span class="ident" id="3872755">Stmt</span><span class="op" id="3872759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872763">db</span><span class="op" id="3872765">:</span>&nbsp;<span class="ident" id="3872767">tx</span><span class="op" id="3872769">.</span><span class="ident" id="3872770">db</span><span class="op" id="3872772">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872776">tx</span><span class="op" id="3872778">:</span>&nbsp;<span class="ident" id="3872780">tx</span><span class="op" id="3872782">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872786">txsi</span><span class="op" id="3872790">:</span>&nbsp;<span class="op" id="3872792">&amp;</span><span class="ident" id="3872793">driverStmt</span><span class="op" id="3872803">{</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872808">Locker</span><span class="op" id="3872814">:</span>&nbsp;<span class="ident" id="3872816">dc</span><span class="op" id="3872818">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872823">si</span><span class="op" id="3872825">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3872831">si</span><span class="op" id="3872833">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3872837">}</span><span class="op" id="3872838">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872842">query</span><span class="op" id="3872847">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3872853">stmt</span><span class="op" id="3872857">.</span><span class="ident" id="3872858">query</span><span class="op" id="3872863">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872867">stickyErr</span><span class="op" id="3872876">:</span>&nbsp;<span class="ident" id="3872878">err</span><span class="op" id="3872881">,</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3872884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872887">tx</span><span class="op" id="3872889">.</span><span class="ident" id="3872890">stmts</span><span class="op" id="3872895">.</span><span class="ident" id="3872896">Lock</span><span class="op" id="3872900">(</span><span class="op" id="3872901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872904">tx</span><span class="op" id="3872906">.</span><span class="ident" id="3872907">stmts</span><span class="op" id="3872912">.</span><span class="ident" id="3872913">v</span>&nbsp;<span class="op" id="3872915">=</span>&nbsp;<span class="builtinfunc" id="3872917">append</span><span class="op" id="3872923">(</span><span class="ident" id="3872924">tx</span><span class="op" id="3872926">.</span><span class="ident" id="3872927">stmts</span><span class="op" id="3872932">.</span><span class="ident" id="3872933">v</span><span class="op" id="3872934">,</span>&nbsp;<span class="ident" id="3872936">txs</span><span class="op" id="3872939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872942">tx</span><span class="op" id="3872944">.</span><span class="ident" id="3872945">stmts</span><span class="op" id="3872950">.</span><span class="ident" id="3872951">Unlock</span><span class="op" id="3872957">(</span><span class="op" id="3872958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3872961">return</span>&nbsp;<span class="ident" id="3872968">txs</span><br>
<span class="lineno">1215</span><span class="op" id="3872972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3872975">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;doesn&#39;t&nbsp;return&nbsp;rows.</span><br>
<span class="lineno"></span><span class="comment" id="3873026">//&nbsp;For&nbsp;example:&nbsp;an&nbsp;INSERT&nbsp;and&nbsp;UPDATE.</span><br>
<span class="lineno"></span><span class="keyword" id="3873064">func</span>&nbsp;<span class="op" id="3873069">(</span><span class="ident" id="3873070">tx</span>&nbsp;<span class="op" id="3873073">*</span><span class="ident" id="3873074">Tx</span><span class="op" id="3873076">)</span>&nbsp;<span class="ident" id="3873078">Exec</span><span class="op" id="3873082">(</span><span class="ident" id="3873083">query</span>&nbsp;<span class="builtintype" id="3873089">string</span><span class="op" id="3873095">,</span>&nbsp;<span class="ident" id="3873097">args</span>&nbsp;<span class="op" id="3873102">...</span><span class="keyword" id="3873105">interface</span><span class="op" id="3873114">{</span><span class="op" id="3873115">}</span><span class="op" id="3873116">)</span>&nbsp;<span class="op" id="3873118">(</span><span class="ident" id="3873119">Result</span><span class="op" id="3873125">,</span>&nbsp;<span class="builtintype" id="3873127">error</span><span class="op" id="3873132">)</span>&nbsp;<span class="op" id="3873134">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873137">dc</span><span class="op" id="3873139">,</span>&nbsp;<span class="ident" id="3873141">err</span>&nbsp;<span class="op" id="3873145">:=</span>&nbsp;<span class="ident" id="3873148">tx</span><span class="op" id="3873150">.</span><span class="ident" id="3873151">grabConn</span><span class="op" id="3873159">(</span><span class="op" id="3873160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873163">if</span>&nbsp;<span class="ident" id="3873166">err</span>&nbsp;<span class="op" id="3873170">!=</span>&nbsp;<span class="ident" id="3873173">nil</span>&nbsp;<span class="op" id="3873177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873181">return</span>&nbsp;<span class="ident" id="3873188">nil</span><span class="op" id="3873191">,</span>&nbsp;<span class="ident" id="3873193">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3873198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873202">if</span>&nbsp;<span class="ident" id="3873205">execer</span><span class="op" id="3873211">,</span>&nbsp;<span class="ident" id="3873213">ok</span>&nbsp;<span class="op" id="3873216">:=</span>&nbsp;<span class="ident" id="3873219">dc</span><span class="op" id="3873221">.</span><span class="ident" id="3873222">ci</span><span class="op" id="3873224">.</span><span class="op" id="3873225">(</span><span class="ident" id="3873226">driver</span><span class="op" id="3873232">.</span><span class="ident" id="3873233">Execer</span><span class="op" id="3873239">)</span><span class="op" id="3873240">;</span>&nbsp;<span class="ident" id="3873242">ok</span>&nbsp;<span class="op" id="3873245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873249">dargs</span><span class="op" id="3873254">,</span>&nbsp;<span class="ident" id="3873256">err</span>&nbsp;<span class="op" id="3873260">:=</span>&nbsp;<span class="ident" id="3873263">driverArgs</span><span class="op" id="3873273">(</span><span class="ident" id="3873274">nil</span><span class="op" id="3873277">,</span>&nbsp;<span class="ident" id="3873279">args</span><span class="op" id="3873283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873287">if</span>&nbsp;<span class="ident" id="3873290">err</span>&nbsp;<span class="op" id="3873294">!=</span>&nbsp;<span class="ident" id="3873297">nil</span>&nbsp;<span class="op" id="3873301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873306">return</span>&nbsp;<span class="ident" id="3873313">nil</span><span class="op" id="3873316">,</span>&nbsp;<span class="ident" id="3873318">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3873324">}</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873328">dc</span><span class="op" id="3873330">.</span><span class="ident" id="3873331">Lock</span><span class="op" id="3873335">(</span><span class="op" id="3873336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873340">resi</span><span class="op" id="3873344">,</span>&nbsp;<span class="ident" id="3873346">err</span>&nbsp;<span class="op" id="3873350">:=</span>&nbsp;<span class="ident" id="3873353">execer</span><span class="op" id="3873359">.</span><span class="ident" id="3873360">Exec</span><span class="op" id="3873364">(</span><span class="ident" id="3873365">query</span><span class="op" id="3873370">,</span>&nbsp;<span class="ident" id="3873372">dargs</span><span class="op" id="3873377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873381">dc</span><span class="op" id="3873383">.</span><span class="ident" id="3873384">Unlock</span><span class="op" id="3873390">(</span><span class="op" id="3873391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873395">if</span>&nbsp;<span class="ident" id="3873398">err</span>&nbsp;<span class="op" id="3873402">==</span>&nbsp;<span class="ident" id="3873405">nil</span>&nbsp;<span class="op" id="3873409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873414">return</span>&nbsp;<span class="ident" id="3873421">driverResult</span><span class="op" id="3873433">{</span><span class="ident" id="3873434">dc</span><span class="op" id="3873436">,</span>&nbsp;<span class="ident" id="3873438">resi</span><span class="op" id="3873442">}</span><span class="op" id="3873443">,</span>&nbsp;<span class="ident" id="3873445">nil</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3873451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873455">if</span>&nbsp;<span class="ident" id="3873458">err</span>&nbsp;<span class="op" id="3873462">!=</span>&nbsp;<span class="ident" id="3873465">driver</span><span class="op" id="3873471">.</span><span class="ident" id="3873472">ErrSkip</span>&nbsp;<span class="op" id="3873480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873485">return</span>&nbsp;<span class="ident" id="3873492">nil</span><span class="op" id="3873495">,</span>&nbsp;<span class="ident" id="3873497">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3873503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3873506">}</span><br>
<span class="lineno">1240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873510">dc</span><span class="op" id="3873512">.</span><span class="ident" id="3873513">Lock</span><span class="op" id="3873517">(</span><span class="op" id="3873518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873521">si</span><span class="op" id="3873523">,</span>&nbsp;<span class="ident" id="3873525">err</span>&nbsp;<span class="op" id="3873529">:=</span>&nbsp;<span class="ident" id="3873532">dc</span><span class="op" id="3873534">.</span><span class="ident" id="3873535">ci</span><span class="op" id="3873537">.</span><span class="ident" id="3873538">Prepare</span><span class="op" id="3873545">(</span><span class="ident" id="3873546">query</span><span class="op" id="3873551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873554">dc</span><span class="op" id="3873556">.</span><span class="ident" id="3873557">Unlock</span><span class="op" id="3873563">(</span><span class="op" id="3873564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873567">if</span>&nbsp;<span class="ident" id="3873570">err</span>&nbsp;<span class="op" id="3873574">!=</span>&nbsp;<span class="ident" id="3873577">nil</span>&nbsp;<span class="op" id="3873581">{</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873585">return</span>&nbsp;<span class="ident" id="3873592">nil</span><span class="op" id="3873595">,</span>&nbsp;<span class="ident" id="3873597">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3873602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873605">defer</span>&nbsp;<span class="ident" id="3873611">withLock</span><span class="op" id="3873619">(</span><span class="ident" id="3873620">dc</span><span class="op" id="3873622">,</span>&nbsp;<span class="keyword" id="3873624">func</span><span class="op" id="3873628">(</span><span class="op" id="3873629">)</span>&nbsp;<span class="op" id="3873631">{</span>&nbsp;<span class="ident" id="3873633">si</span><span class="op" id="3873635">.</span><span class="ident" id="3873636">Close</span><span class="op" id="3873641">(</span><span class="op" id="3873642">)</span>&nbsp;<span class="op" id="3873644">}</span><span class="op" id="3873645">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873649">return</span>&nbsp;<span class="ident" id="3873656">resultFromStatement</span><span class="op" id="3873675">(</span><span class="ident" id="3873676">driverStmt</span><span class="op" id="3873686">{</span><span class="ident" id="3873687">dc</span><span class="op" id="3873689">,</span>&nbsp;<span class="ident" id="3873691">si</span><span class="op" id="3873693">}</span><span class="op" id="3873694">,</span>&nbsp;<span class="ident" id="3873696">args</span><span class="op" id="3873700">...</span><span class="op" id="3873703">)</span><br>
<span class="lineno">1250</span><span class="op" id="3873705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3873708">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="keyword" id="3873773">func</span>&nbsp;<span class="op" id="3873778">(</span><span class="ident" id="3873779">tx</span>&nbsp;<span class="op" id="3873782">*</span><span class="ident" id="3873783">Tx</span><span class="op" id="3873785">)</span>&nbsp;<span class="ident" id="3873787">Query</span><span class="op" id="3873792">(</span><span class="ident" id="3873793">query</span>&nbsp;<span class="builtintype" id="3873799">string</span><span class="op" id="3873805">,</span>&nbsp;<span class="ident" id="3873807">args</span>&nbsp;<span class="op" id="3873812">...</span><span class="keyword" id="3873815">interface</span><span class="op" id="3873824">{</span><span class="op" id="3873825">}</span><span class="op" id="3873826">)</span>&nbsp;<span class="op" id="3873828">(</span><span class="op" id="3873829">*</span><span class="ident" id="3873830">Rows</span><span class="op" id="3873834">,</span>&nbsp;<span class="builtintype" id="3873836">error</span><span class="op" id="3873841">)</span>&nbsp;<span class="op" id="3873843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873846">dc</span><span class="op" id="3873848">,</span>&nbsp;<span class="ident" id="3873850">err</span>&nbsp;<span class="op" id="3873854">:=</span>&nbsp;<span class="ident" id="3873857">tx</span><span class="op" id="3873859">.</span><span class="ident" id="3873860">grabConn</span><span class="op" id="3873868">(</span><span class="op" id="3873869">)</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873872">if</span>&nbsp;<span class="ident" id="3873875">err</span>&nbsp;<span class="op" id="3873879">!=</span>&nbsp;<span class="ident" id="3873882">nil</span>&nbsp;<span class="op" id="3873886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873890">return</span>&nbsp;<span class="ident" id="3873897">nil</span><span class="op" id="3873900">,</span>&nbsp;<span class="ident" id="3873902">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3873907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873910">releaseConn</span>&nbsp;<span class="op" id="3873922">:=</span>&nbsp;<span class="keyword" id="3873925">func</span><span class="op" id="3873929">(</span><span class="builtintype" id="3873930">error</span><span class="op" id="3873935">)</span>&nbsp;<span class="op" id="3873937">{</span><span class="op" id="3873938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873941">return</span>&nbsp;<span class="ident" id="3873948">tx</span><span class="op" id="3873950">.</span><span class="ident" id="3873951">db</span><span class="op" id="3873953">.</span><span class="ident" id="3873954">queryConn</span><span class="op" id="3873963">(</span><span class="ident" id="3873964">dc</span><span class="op" id="3873966">,</span>&nbsp;<span class="ident" id="3873968">releaseConn</span><span class="op" id="3873979">,</span>&nbsp;<span class="ident" id="3873981">query</span><span class="op" id="3873986">,</span>&nbsp;<span class="ident" id="3873988">args</span><span class="op" id="3873992">)</span><br>
<span class="lineno">1260</span><span class="op" id="3873994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3873997">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="3874070">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="3874139">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno">1265</span><span class="keyword" id="3874171">func</span>&nbsp;<span class="op" id="3874176">(</span><span class="ident" id="3874177">tx</span>&nbsp;<span class="op" id="3874180">*</span><span class="ident" id="3874181">Tx</span><span class="op" id="3874183">)</span>&nbsp;<span class="ident" id="3874185">QueryRow</span><span class="op" id="3874193">(</span><span class="ident" id="3874194">query</span>&nbsp;<span class="builtintype" id="3874200">string</span><span class="op" id="3874206">,</span>&nbsp;<span class="ident" id="3874208">args</span>&nbsp;<span class="op" id="3874213">...</span><span class="keyword" id="3874216">interface</span><span class="op" id="3874225">{</span><span class="op" id="3874226">}</span><span class="op" id="3874227">)</span>&nbsp;<span class="op" id="3874229">*</span><span class="ident" id="3874230">Row</span>&nbsp;<span class="op" id="3874234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874237">rows</span><span class="op" id="3874241">,</span>&nbsp;<span class="ident" id="3874243">err</span>&nbsp;<span class="op" id="3874247">:=</span>&nbsp;<span class="ident" id="3874250">tx</span><span class="op" id="3874252">.</span><span class="ident" id="3874253">Query</span><span class="op" id="3874258">(</span><span class="ident" id="3874259">query</span><span class="op" id="3874264">,</span>&nbsp;<span class="ident" id="3874266">args</span><span class="op" id="3874270">...</span><span class="op" id="3874273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3874276">return</span>&nbsp;<span class="op" id="3874283">&amp;</span><span class="ident" id="3874284">Row</span><span class="op" id="3874287">{</span><span class="ident" id="3874288">rows</span><span class="op" id="3874292">:</span>&nbsp;<span class="ident" id="3874294">rows</span><span class="op" id="3874298">,</span>&nbsp;<span class="ident" id="3874300">err</span><span class="op" id="3874303">:</span>&nbsp;<span class="ident" id="3874305">err</span><span class="op" id="3874308">}</span><br>
<span class="lineno"></span><span class="op" id="3874310">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="3874313">//&nbsp;connStmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;a&nbsp;particular&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3874377">type</span>&nbsp;<span class="ident" id="3874382">connStmt</span>&nbsp;<span class="keyword" id="3874391">struct</span>&nbsp;<span class="op" id="3874398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874401">dc</span>&nbsp;<span class="op" id="3874404">*</span><span class="ident" id="3874405">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874417">si</span>&nbsp;<span class="ident" id="3874420">driver</span><span class="op" id="3874426">.</span><span class="ident" id="3874427">Stmt</span><br>
<span class="lineno"></span><span class="op" id="3874432">}</span><br>
<span class="lineno">1275</span><br>
<span class="lineno"></span><span class="comment" id="3874435">//&nbsp;Stmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement.&nbsp;Stmt&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="3874524">type</span>&nbsp;<span class="ident" id="3874529">Stmt</span>&nbsp;<span class="keyword" id="3874534">struct</span>&nbsp;<span class="op" id="3874541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874544">//&nbsp;Immutable:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874559">db</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3874569">*</span><span class="ident" id="3874570">DB</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3874576">//&nbsp;where&nbsp;we&nbsp;came&nbsp;from</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874599">query</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3874609">string</span>&nbsp;<span class="comment" id="3874616">//&nbsp;that&nbsp;created&nbsp;the&nbsp;Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874642">stickyErr</span>&nbsp;<span class="builtintype" id="3874652">error</span>&nbsp;&nbsp;<span class="comment" id="3874659">//&nbsp;if&nbsp;non-nil,&nbsp;this&nbsp;error&nbsp;is&nbsp;returned&nbsp;for&nbsp;all&nbsp;operations</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874718">closemu</span>&nbsp;<span class="ident" id="3874726">sync</span><span class="op" id="3874730">.</span><span class="ident" id="3874731">RWMutex</span>&nbsp;<span class="comment" id="3874739">//&nbsp;held&nbsp;exclusively&nbsp;during&nbsp;close,&nbsp;for&nbsp;read&nbsp;otherwise.</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874795">//&nbsp;If&nbsp;in&nbsp;a&nbsp;transaction,&nbsp;else&nbsp;both&nbsp;nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874835">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3874840">*</span><span class="ident" id="3874841">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874845">txsi</span>&nbsp;<span class="op" id="3874850">*</span><span class="ident" id="3874851">driverStmt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874864">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3874871">sync</span><span class="op" id="3874875">.</span><span class="ident" id="3874876">Mutex</span>&nbsp;<span class="comment" id="3874882">//&nbsp;protects&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;fields</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874918">closed</span>&nbsp;<span class="builtintype" id="3874925">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874932">//&nbsp;css&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;underlying&nbsp;driver&nbsp;statement&nbsp;interfaces</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874992">//&nbsp;that&nbsp;are&nbsp;valid&nbsp;on&nbsp;particular&nbsp;connections.&nbsp;&nbsp;This&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3875052">//&nbsp;used&nbsp;if&nbsp;tx&nbsp;==&nbsp;nil&nbsp;and&nbsp;one&nbsp;is&nbsp;found&nbsp;that&nbsp;has&nbsp;idle</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3875105">//&nbsp;connections.&nbsp;&nbsp;If&nbsp;tx&nbsp;!=&nbsp;nil,&nbsp;txsi&nbsp;is&nbsp;always&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875158">css</span>&nbsp;<span class="op" id="3875162">[</span><span class="op" id="3875163">]</span><span class="ident" id="3875164">connStmt</span><br>
<span class="lineno"></span><span class="op" id="3875173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3875176">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments&nbsp;and</span><br>
<span class="lineno">1300</span><span class="comment" id="3875243">//&nbsp;returns&nbsp;a&nbsp;Result&nbsp;summarizing&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="3875304">func</span>&nbsp;<span class="op" id="3875309">(</span><span class="ident" id="3875310">s</span>&nbsp;<span class="op" id="3875312">*</span><span class="ident" id="3875313">Stmt</span><span class="op" id="3875317">)</span>&nbsp;<span class="ident" id="3875319">Exec</span><span class="op" id="3875323">(</span><span class="ident" id="3875324">args</span>&nbsp;<span class="op" id="3875329">...</span><span class="keyword" id="3875332">interface</span><span class="op" id="3875341">{</span><span class="op" id="3875342">}</span><span class="op" id="3875343">)</span>&nbsp;<span class="op" id="3875345">(</span><span class="ident" id="3875346">Result</span><span class="op" id="3875352">,</span>&nbsp;<span class="builtintype" id="3875354">error</span><span class="op" id="3875359">)</span>&nbsp;<span class="op" id="3875361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875364">s</span><span class="op" id="3875365">.</span><span class="ident" id="3875366">closemu</span><span class="op" id="3875373">.</span><span class="ident" id="3875374">RLock</span><span class="op" id="3875379">(</span><span class="op" id="3875380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875383">defer</span>&nbsp;<span class="ident" id="3875389">s</span><span class="op" id="3875390">.</span><span class="ident" id="3875391">closemu</span><span class="op" id="3875398">.</span><span class="ident" id="3875399">RUnlock</span><span class="op" id="3875406">(</span><span class="op" id="3875407">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875411">var</span>&nbsp;<span class="ident" id="3875415">res</span>&nbsp;<span class="ident" id="3875419">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875427">for</span>&nbsp;<span class="ident" id="3875431">i</span>&nbsp;<span class="op" id="3875433">:=</span>&nbsp;<span class="num" id="3875436">0</span><span class="op" id="3875437">;</span>&nbsp;<span class="ident" id="3875439">i</span>&nbsp;<span class="op" id="3875441">&lt;</span>&nbsp;<span class="ident" id="3875443">maxBadConnRetries</span><span class="op" id="3875460">;</span>&nbsp;<span class="ident" id="3875462">i</span><span class="op" id="3875463">++</span>&nbsp;<span class="op" id="3875466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875470">dc</span><span class="op" id="3875472">,</span>&nbsp;<span class="ident" id="3875474">releaseConn</span><span class="op" id="3875485">,</span>&nbsp;<span class="ident" id="3875487">si</span><span class="op" id="3875489">,</span>&nbsp;<span class="ident" id="3875491">err</span>&nbsp;<span class="op" id="3875495">:=</span>&nbsp;<span class="ident" id="3875498">s</span><span class="op" id="3875499">.</span><span class="ident" id="3875500">connStmt</span><span class="op" id="3875508">(</span><span class="op" id="3875509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875513">if</span>&nbsp;<span class="ident" id="3875516">err</span>&nbsp;<span class="op" id="3875520">!=</span>&nbsp;<span class="ident" id="3875523">nil</span>&nbsp;<span class="op" id="3875527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875532">if</span>&nbsp;<span class="ident" id="3875535">err</span>&nbsp;<span class="op" id="3875539">==</span>&nbsp;<span class="ident" id="3875542">driver</span><span class="op" id="3875548">.</span><span class="ident" id="3875549">ErrBadConn</span>&nbsp;<span class="op" id="3875560">{</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875566">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3875578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875583">return</span>&nbsp;<span class="ident" id="3875590">nil</span><span class="op" id="3875593">,</span>&nbsp;<span class="ident" id="3875595">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3875601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875606">res</span><span class="op" id="3875609">,</span>&nbsp;<span class="ident" id="3875611">err</span>&nbsp;<span class="op" id="3875615">=</span>&nbsp;<span class="ident" id="3875617">resultFromStatement</span><span class="op" id="3875636">(</span><span class="ident" id="3875637">driverStmt</span><span class="op" id="3875647">{</span><span class="ident" id="3875648">dc</span><span class="op" id="3875650">,</span>&nbsp;<span class="ident" id="3875652">si</span><span class="op" id="3875654">}</span><span class="op" id="3875655">,</span>&nbsp;<span class="ident" id="3875657">args</span><span class="op" id="3875661">...</span><span class="op" id="3875664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875668">releaseConn</span><span class="op" id="3875679">(</span><span class="ident" id="3875680">err</span><span class="op" id="3875683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875687">if</span>&nbsp;<span class="ident" id="3875690">err</span>&nbsp;<span class="op" id="3875694">!=</span>&nbsp;<span class="ident" id="3875697">driver</span><span class="op" id="3875703">.</span><span class="ident" id="3875704">ErrBadConn</span>&nbsp;<span class="op" id="3875715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875720">return</span>&nbsp;<span class="ident" id="3875727">res</span><span class="op" id="3875730">,</span>&nbsp;<span class="ident" id="3875732">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3875738">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3875741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875744">return</span>&nbsp;<span class="ident" id="3875751">nil</span><span class="op" id="3875754">,</span>&nbsp;<span class="ident" id="3875756">driver</span><span class="op" id="3875762">.</span><span class="ident" id="3875763">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="3875774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3875777">func</span>&nbsp;<span class="ident" id="3875782">resultFromStatement</span><span class="op" id="3875801">(</span><span class="ident" id="3875802">ds</span>&nbsp;<span class="ident" id="3875805">driverStmt</span><span class="op" id="3875815">,</span>&nbsp;<span class="ident" id="3875817">args</span>&nbsp;<span class="op" id="3875822">...</span><span class="keyword" id="3875825">interface</span><span class="op" id="3875834">{</span><span class="op" id="3875835">}</span><span class="op" id="3875836">)</span>&nbsp;<span class="op" id="3875838">(</span><span class="ident" id="3875839">Result</span><span class="op" id="3875845">,</span>&nbsp;<span class="builtintype" id="3875847">error</span><span class="op" id="3875852">)</span>&nbsp;<span class="op" id="3875854">{</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875857">ds</span><span class="op" id="3875859">.</span><span class="ident" id="3875860">Lock</span><span class="op" id="3875864">(</span><span class="op" id="3875865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875868">want</span>&nbsp;<span class="op" id="3875873">:=</span>&nbsp;<span class="ident" id="3875876">ds</span><span class="op" id="3875878">.</span><span class="ident" id="3875879">si</span><span class="op" id="3875881">.</span><span class="ident" id="3875882">NumInput</span><span class="op" id="3875890">(</span><span class="op" id="3875891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875894">ds</span><span class="op" id="3875896">.</span><span class="ident" id="3875897">Unlock</span><span class="op" id="3875903">(</span><span class="op" id="3875904">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3875908">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3875972">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3876046">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876075">if</span>&nbsp;<span class="ident" id="3876078">want</span>&nbsp;<span class="op" id="3876083">!=</span>&nbsp;<span class="op" id="3876086">-</span><span class="num" id="3876087">1</span>&nbsp;<span class="op" id="3876089">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3876092">len</span><span class="op" id="3876095">(</span><span class="ident" id="3876096">args</span><span class="op" id="3876100">)</span>&nbsp;<span class="op" id="3876102">!=</span>&nbsp;<span class="ident" id="3876105">want</span>&nbsp;<span class="op" id="3876110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876114">return</span>&nbsp;<span class="ident" id="3876121">nil</span><span class="op" id="3876124">,</span>&nbsp;<span class="ident" id="3876126">fmt</span><span class="op" id="3876129">.</span><span class="ident" id="3876130">Errorf</span><span class="op" id="3876136">(</span><span class="string" id="3876137">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;arguments,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="3876173">,</span>&nbsp;<span class="ident" id="3876175">want</span><span class="op" id="3876179">,</span>&nbsp;<span class="builtinfunc" id="3876181">len</span><span class="op" id="3876184">(</span><span class="ident" id="3876185">args</span><span class="op" id="3876189">)</span><span class="op" id="3876190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876193">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876197">dargs</span><span class="op" id="3876202">,</span>&nbsp;<span class="ident" id="3876204">err</span>&nbsp;<span class="op" id="3876208">:=</span>&nbsp;<span class="ident" id="3876211">driverArgs</span><span class="op" id="3876221">(</span><span class="op" id="3876222">&amp;</span><span class="ident" id="3876223">ds</span><span class="op" id="3876225">,</span>&nbsp;<span class="ident" id="3876227">args</span><span class="op" id="3876231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876234">if</span>&nbsp;<span class="ident" id="3876237">err</span>&nbsp;<span class="op" id="3876241">!=</span>&nbsp;<span class="ident" id="3876244">nil</span>&nbsp;<span class="op" id="3876248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876252">return</span>&nbsp;<span class="ident" id="3876259">nil</span><span class="op" id="3876262">,</span>&nbsp;<span class="ident" id="3876264">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876269">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876273">ds</span><span class="op" id="3876275">.</span><span class="ident" id="3876276">Lock</span><span class="op" id="3876280">(</span><span class="op" id="3876281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876284">resi</span><span class="op" id="3876288">,</span>&nbsp;<span class="ident" id="3876290">err</span>&nbsp;<span class="op" id="3876294">:=</span>&nbsp;<span class="ident" id="3876297">ds</span><span class="op" id="3876299">.</span><span class="ident" id="3876300">si</span><span class="op" id="3876302">.</span><span class="ident" id="3876303">Exec</span><span class="op" id="3876307">(</span><span class="ident" id="3876308">dargs</span><span class="op" id="3876313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876316">ds</span><span class="op" id="3876318">.</span><span class="ident" id="3876319">Unlock</span><span class="op" id="3876325">(</span><span class="op" id="3876326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876329">if</span>&nbsp;<span class="ident" id="3876332">err</span>&nbsp;<span class="op" id="3876336">!=</span>&nbsp;<span class="ident" id="3876339">nil</span>&nbsp;<span class="op" id="3876343">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876347">return</span>&nbsp;<span class="ident" id="3876354">nil</span><span class="op" id="3876357">,</span>&nbsp;<span class="ident" id="3876359">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876367">return</span>&nbsp;<span class="ident" id="3876374">driverResult</span><span class="op" id="3876386">{</span><span class="ident" id="3876387">ds</span><span class="op" id="3876389">.</span><span class="ident" id="3876390">Locker</span><span class="op" id="3876396">,</span>&nbsp;<span class="ident" id="3876398">resi</span><span class="op" id="3876402">}</span><span class="op" id="3876403">,</span>&nbsp;<span class="ident" id="3876405">nil</span><br>
<span class="lineno"></span><span class="op" id="3876409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1350</span><span class="comment" id="3876412">//&nbsp;connStmt&nbsp;returns&nbsp;a&nbsp;free&nbsp;driver&nbsp;connection&nbsp;on&nbsp;which&nbsp;to&nbsp;execute&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3876481">//&nbsp;statement,&nbsp;a&nbsp;function&nbsp;to&nbsp;call&nbsp;to&nbsp;release&nbsp;the&nbsp;connection,&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3876547">//&nbsp;statement&nbsp;bound&nbsp;to&nbsp;that&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3876586">func</span>&nbsp;<span class="op" id="3876591">(</span><span class="ident" id="3876592">s</span>&nbsp;<span class="op" id="3876594">*</span><span class="ident" id="3876595">Stmt</span><span class="op" id="3876599">)</span>&nbsp;<span class="ident" id="3876601">connStmt</span><span class="op" id="3876609">(</span><span class="op" id="3876610">)</span>&nbsp;<span class="op" id="3876612">(</span><span class="ident" id="3876613">ci</span>&nbsp;<span class="op" id="3876616">*</span><span class="ident" id="3876617">driverConn</span><span class="op" id="3876627">,</span>&nbsp;<span class="ident" id="3876629">releaseConn</span>&nbsp;<span class="keyword" id="3876641">func</span><span class="op" id="3876645">(</span><span class="builtintype" id="3876646">error</span><span class="op" id="3876651">)</span><span class="op" id="3876652">,</span>&nbsp;<span class="ident" id="3876654">si</span>&nbsp;<span class="ident" id="3876657">driver</span><span class="op" id="3876663">.</span><span class="ident" id="3876664">Stmt</span><span class="op" id="3876668">,</span>&nbsp;<span class="ident" id="3876670">err</span>&nbsp;<span class="builtintype" id="3876674">error</span><span class="op" id="3876679">)</span>&nbsp;<span class="op" id="3876681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876684">if</span>&nbsp;<span class="ident" id="3876687">err</span>&nbsp;<span class="op" id="3876691">=</span>&nbsp;<span class="ident" id="3876693">s</span><span class="op" id="3876694">.</span><span class="ident" id="3876695">stickyErr</span><span class="op" id="3876704">;</span>&nbsp;<span class="ident" id="3876706">err</span>&nbsp;<span class="op" id="3876710">!=</span>&nbsp;<span class="ident" id="3876713">nil</span>&nbsp;<span class="op" id="3876717">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876721">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876732">s</span><span class="op" id="3876733">.</span><span class="ident" id="3876734">mu</span><span class="op" id="3876736">.</span><span class="ident" id="3876737">Lock</span><span class="op" id="3876741">(</span><span class="op" id="3876742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876745">if</span>&nbsp;<span class="ident" id="3876748">s</span><span class="op" id="3876749">.</span><span class="ident" id="3876750">closed</span>&nbsp;<span class="op" id="3876757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876761">s</span><span class="op" id="3876762">.</span><span class="ident" id="3876763">mu</span><span class="op" id="3876765">.</span><span class="ident" id="3876766">Unlock</span><span class="op" id="3876772">(</span><span class="op" id="3876773">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876777">err</span>&nbsp;<span class="op" id="3876781">=</span>&nbsp;<span class="ident" id="3876783">errors</span><span class="op" id="3876789">.</span><span class="ident" id="3876790">New</span><span class="op" id="3876793">(</span><span class="string" id="3876794">&#34;sql:&nbsp;statement&nbsp;is&nbsp;closed&#34;</span><span class="op" id="3876820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876824">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3876836">//&nbsp;In&nbsp;a&nbsp;transaction,&nbsp;we&nbsp;always&nbsp;use&nbsp;the&nbsp;connection&nbsp;that&nbsp;the</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3876896">//&nbsp;transaction&nbsp;was&nbsp;created&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876928">if</span>&nbsp;<span class="ident" id="3876931">s</span><span class="op" id="3876932">.</span><span class="ident" id="3876933">tx</span>&nbsp;<span class="op" id="3876936">!=</span>&nbsp;<span class="ident" id="3876939">nil</span>&nbsp;<span class="op" id="3876943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876947">s</span><span class="op" id="3876948">.</span><span class="ident" id="3876949">mu</span><span class="op" id="3876951">.</span><span class="ident" id="3876952">Unlock</span><span class="op" id="3876958">(</span><span class="op" id="3876959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876963">ci</span><span class="op" id="3876965">,</span>&nbsp;<span class="ident" id="3876967">err</span>&nbsp;<span class="op" id="3876971">=</span>&nbsp;<span class="ident" id="3876973">s</span><span class="op" id="3876974">.</span><span class="ident" id="3876975">tx</span><span class="op" id="3876977">.</span><span class="ident" id="3876978">grabConn</span><span class="op" id="3876986">(</span><span class="op" id="3876987">)</span>&nbsp;<span class="comment" id="3876989">//&nbsp;blocks,&nbsp;waiting&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877030">if</span>&nbsp;<span class="ident" id="3877033">err</span>&nbsp;<span class="op" id="3877037">!=</span>&nbsp;<span class="ident" id="3877040">nil</span>&nbsp;<span class="op" id="3877044">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877049">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877062">releaseConn</span>&nbsp;<span class="op" id="3877074">=</span>&nbsp;<span class="keyword" id="3877076">func</span><span class="op" id="3877080">(</span><span class="builtintype" id="3877081">error</span><span class="op" id="3877086">)</span>&nbsp;<span class="op" id="3877088">{</span><span class="op" id="3877089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877093">return</span>&nbsp;<span class="ident" id="3877100">ci</span><span class="op" id="3877102">,</span>&nbsp;<span class="ident" id="3877104">releaseConn</span><span class="op" id="3877115">,</span>&nbsp;<span class="ident" id="3877117">s</span><span class="op" id="3877118">.</span><span class="ident" id="3877119">txsi</span><span class="op" id="3877123">.</span><span class="ident" id="3877124">si</span><span class="op" id="3877126">,</span>&nbsp;<span class="ident" id="3877128">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877133">}</span><br>
<span class="lineno">1375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877137">for</span>&nbsp;<span class="ident" id="3877141">i</span>&nbsp;<span class="op" id="3877143">:=</span>&nbsp;<span class="num" id="3877146">0</span><span class="op" id="3877147">;</span>&nbsp;<span class="ident" id="3877149">i</span>&nbsp;<span class="op" id="3877151">&lt;</span>&nbsp;<span class="builtinfunc" id="3877153">len</span><span class="op" id="3877156">(</span><span class="ident" id="3877157">s</span><span class="op" id="3877158">.</span><span class="ident" id="3877159">css</span><span class="op" id="3877162">)</span><span class="op" id="3877163">;</span>&nbsp;<span class="ident" id="3877165">i</span><span class="op" id="3877166">++</span>&nbsp;<span class="op" id="3877169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877173">v</span>&nbsp;<span class="op" id="3877175">:=</span>&nbsp;<span class="ident" id="3877178">s</span><span class="op" id="3877179">.</span><span class="ident" id="3877180">css</span><span class="op" id="3877183">[</span><span class="ident" id="3877184">i</span><span class="op" id="3877185">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877189">_</span><span class="op" id="3877190">,</span>&nbsp;<span class="ident" id="3877192">err</span>&nbsp;<span class="op" id="3877196">:=</span>&nbsp;<span class="ident" id="3877199">s</span><span class="op" id="3877200">.</span><span class="ident" id="3877201">db</span><span class="op" id="3877203">.</span><span class="ident" id="3877204">connIfFree</span><span class="op" id="3877214">(</span><span class="ident" id="3877215">v</span><span class="op" id="3877216">.</span><span class="ident" id="3877217">dc</span><span class="op" id="3877219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877223">if</span>&nbsp;<span class="ident" id="3877226">err</span>&nbsp;<span class="op" id="3877230">==</span>&nbsp;<span class="ident" id="3877233">nil</span>&nbsp;<span class="op" id="3877237">{</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877242">s</span><span class="op" id="3877243">.</span><span class="ident" id="3877244">mu</span><span class="op" id="3877246">.</span><span class="ident" id="3877247">Unlock</span><span class="op" id="3877253">(</span><span class="op" id="3877254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877259">return</span>&nbsp;<span class="ident" id="3877266">v</span><span class="op" id="3877267">.</span><span class="ident" id="3877268">dc</span><span class="op" id="3877270">,</span>&nbsp;<span class="ident" id="3877272">v</span><span class="op" id="3877273">.</span><span class="ident" id="3877274">dc</span><span class="op" id="3877276">.</span><span class="ident" id="3877277">releaseConn</span><span class="op" id="3877288">,</span>&nbsp;<span class="ident" id="3877290">v</span><span class="op" id="3877291">.</span><span class="ident" id="3877292">si</span><span class="op" id="3877294">,</span>&nbsp;<span class="ident" id="3877296">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877306">if</span>&nbsp;<span class="ident" id="3877309">err</span>&nbsp;<span class="op" id="3877313">==</span>&nbsp;<span class="ident" id="3877316">errConnClosed</span>&nbsp;<span class="op" id="3877330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877335">//&nbsp;Lazily&nbsp;remove&nbsp;dead&nbsp;conn&nbsp;from&nbsp;our&nbsp;freelist.</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877384">s</span><span class="op" id="3877385">.</span><span class="ident" id="3877386">css</span><span class="op" id="3877389">[</span><span class="ident" id="3877390">i</span><span class="op" id="3877391">]</span>&nbsp;<span class="op" id="3877393">=</span>&nbsp;<span class="ident" id="3877395">s</span><span class="op" id="3877396">.</span><span class="ident" id="3877397">css</span><span class="op" id="3877400">[</span><span class="builtinfunc" id="3877401">len</span><span class="op" id="3877404">(</span><span class="ident" id="3877405">s</span><span class="op" id="3877406">.</span><span class="ident" id="3877407">css</span><span class="op" id="3877410">)</span><span class="op" id="3877411">-</span><span class="num" id="3877412">1</span><span class="op" id="3877413">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877418">s</span><span class="op" id="3877419">.</span><span class="ident" id="3877420">css</span>&nbsp;<span class="op" id="3877424">=</span>&nbsp;<span class="ident" id="3877426">s</span><span class="op" id="3877427">.</span><span class="ident" id="3877428">css</span><span class="op" id="3877431">[</span><span class="op" id="3877432">:</span><span class="builtinfunc" id="3877433">len</span><span class="op" id="3877436">(</span><span class="ident" id="3877437">s</span><span class="op" id="3877438">.</span><span class="ident" id="3877439">css</span><span class="op" id="3877442">)</span><span class="op" id="3877443">-</span><span class="num" id="3877444">1</span><span class="op" id="3877445">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877450">i</span><span class="op" id="3877451">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877463">s</span><span class="op" id="3877464">.</span><span class="ident" id="3877465">mu</span><span class="op" id="3877467">.</span><span class="ident" id="3877468">Unlock</span><span class="op" id="3877474">(</span><span class="op" id="3877475">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877479">//&nbsp;If&nbsp;all&nbsp;connections&nbsp;are&nbsp;busy,&nbsp;either&nbsp;wait&nbsp;for&nbsp;one&nbsp;to&nbsp;become&nbsp;available&nbsp;(if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877556">//&nbsp;we&#39;ve&nbsp;already&nbsp;hit&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections)&nbsp;or&nbsp;create&nbsp;a</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877630">//&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877643">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877647">//&nbsp;TODO(bradfitz):&nbsp;or&nbsp;always&nbsp;wait&nbsp;for&nbsp;one?&nbsp;make&nbsp;configurable&nbsp;later?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877716">dc</span><span class="op" id="3877718">,</span>&nbsp;<span class="ident" id="3877720">err</span>&nbsp;<span class="op" id="3877724">:=</span>&nbsp;<span class="ident" id="3877727">s</span><span class="op" id="3877728">.</span><span class="ident" id="3877729">db</span><span class="op" id="3877731">.</span><span class="ident" id="3877732">conn</span><span class="op" id="3877736">(</span><span class="op" id="3877737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877740">if</span>&nbsp;<span class="ident" id="3877743">err</span>&nbsp;<span class="op" id="3877747">!=</span>&nbsp;<span class="ident" id="3877750">nil</span>&nbsp;<span class="op" id="3877754">{</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877758">return</span>&nbsp;<span class="ident" id="3877765">nil</span><span class="op" id="3877768">,</span>&nbsp;<span class="ident" id="3877770">nil</span><span class="op" id="3877773">,</span>&nbsp;<span class="ident" id="3877775">nil</span><span class="op" id="3877778">,</span>&nbsp;<span class="ident" id="3877780">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877789">//&nbsp;Do&nbsp;another&nbsp;pass&nbsp;over&nbsp;the&nbsp;list&nbsp;to&nbsp;see&nbsp;whether&nbsp;this&nbsp;statement&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877857">//&nbsp;already&nbsp;been&nbsp;prepared&nbsp;on&nbsp;the&nbsp;connection&nbsp;assigned&nbsp;to&nbsp;us.</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877917">s</span><span class="op" id="3877918">.</span><span class="ident" id="3877919">mu</span><span class="op" id="3877921">.</span><span class="ident" id="3877922">Lock</span><span class="op" id="3877926">(</span><span class="op" id="3877927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877930">for</span>&nbsp;<span class="ident" id="3877934">_</span><span class="op" id="3877935">,</span>&nbsp;<span class="ident" id="3877937">v</span>&nbsp;<span class="op" id="3877939">:=</span>&nbsp;<span class="keyword" id="3877942">range</span>&nbsp;<span class="ident" id="3877948">s</span><span class="op" id="3877949">.</span><span class="ident" id="3877950">css</span>&nbsp;<span class="op" id="3877954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877958">if</span>&nbsp;<span class="ident" id="3877961">v</span><span class="op" id="3877962">.</span><span class="ident" id="3877963">dc</span>&nbsp;<span class="op" id="3877966">==</span>&nbsp;<span class="ident" id="3877969">dc</span>&nbsp;<span class="op" id="3877972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877977">s</span><span class="op" id="3877978">.</span><span class="ident" id="3877979">mu</span><span class="op" id="3877981">.</span><span class="ident" id="3877982">Unlock</span><span class="op" id="3877988">(</span><span class="op" id="3877989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877994">return</span>&nbsp;<span class="ident" id="3878001">dc</span><span class="op" id="3878003">,</span>&nbsp;<span class="ident" id="3878005">dc</span><span class="op" id="3878007">.</span><span class="ident" id="3878008">releaseConn</span><span class="op" id="3878019">,</span>&nbsp;<span class="ident" id="3878021">v</span><span class="op" id="3878022">.</span><span class="ident" id="3878023">si</span><span class="op" id="3878025">,</span>&nbsp;<span class="ident" id="3878027">nil</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878039">s</span><span class="op" id="3878040">.</span><span class="ident" id="3878041">mu</span><span class="op" id="3878043">.</span><span class="ident" id="3878044">Unlock</span><span class="op" id="3878050">(</span><span class="op" id="3878051">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878055">//&nbsp;No&nbsp;luck;&nbsp;we&nbsp;need&nbsp;to&nbsp;prepare&nbsp;the&nbsp;statement&nbsp;on&nbsp;this&nbsp;connection</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878120">dc</span><span class="op" id="3878122">.</span><span class="ident" id="3878123">Lock</span><span class="op" id="3878127">(</span><span class="op" id="3878128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878131">si</span><span class="op" id="3878133">,</span>&nbsp;<span class="ident" id="3878135">err</span>&nbsp;<span class="op" id="3878139">=</span>&nbsp;<span class="ident" id="3878141">dc</span><span class="op" id="3878143">.</span><span class="ident" id="3878144">prepareLocked</span><span class="op" id="3878157">(</span><span class="ident" id="3878158">s</span><span class="op" id="3878159">.</span><span class="ident" id="3878160">query</span><span class="op" id="3878165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878168">dc</span><span class="op" id="3878170">.</span><span class="ident" id="3878171">Unlock</span><span class="op" id="3878177">(</span><span class="op" id="3878178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878181">if</span>&nbsp;<span class="ident" id="3878184">err</span>&nbsp;<span class="op" id="3878188">!=</span>&nbsp;<span class="ident" id="3878191">nil</span>&nbsp;<span class="op" id="3878195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878199">s</span><span class="op" id="3878200">.</span><span class="ident" id="3878201">db</span><span class="op" id="3878203">.</span><span class="ident" id="3878204">putConn</span><span class="op" id="3878211">(</span><span class="ident" id="3878212">dc</span><span class="op" id="3878214">,</span>&nbsp;<span class="ident" id="3878216">err</span><span class="op" id="3878219">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878223">return</span>&nbsp;<span class="ident" id="3878230">nil</span><span class="op" id="3878233">,</span>&nbsp;<span class="ident" id="3878235">nil</span><span class="op" id="3878238">,</span>&nbsp;<span class="ident" id="3878240">nil</span><span class="op" id="3878243">,</span>&nbsp;<span class="ident" id="3878245">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878253">s</span><span class="op" id="3878254">.</span><span class="ident" id="3878255">mu</span><span class="op" id="3878257">.</span><span class="ident" id="3878258">Lock</span><span class="op" id="3878262">(</span><span class="op" id="3878263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878266">cs</span>&nbsp;<span class="op" id="3878269">:=</span>&nbsp;<span class="ident" id="3878272">connStmt</span><span class="op" id="3878280">{</span><span class="ident" id="3878281">dc</span><span class="op" id="3878283">,</span>&nbsp;<span class="ident" id="3878285">si</span><span class="op" id="3878287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878290">s</span><span class="op" id="3878291">.</span><span class="ident" id="3878292">css</span>&nbsp;<span class="op" id="3878296">=</span>&nbsp;<span class="builtinfunc" id="3878298">append</span><span class="op" id="3878304">(</span><span class="ident" id="3878305">s</span><span class="op" id="3878306">.</span><span class="ident" id="3878307">css</span><span class="op" id="3878310">,</span>&nbsp;<span class="ident" id="3878312">cs</span><span class="op" id="3878314">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878317">s</span><span class="op" id="3878318">.</span><span class="ident" id="3878319">mu</span><span class="op" id="3878321">.</span><span class="ident" id="3878322">Unlock</span><span class="op" id="3878328">(</span><span class="op" id="3878329">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878333">return</span>&nbsp;<span class="ident" id="3878340">dc</span><span class="op" id="3878342">,</span>&nbsp;<span class="ident" id="3878344">dc</span><span class="op" id="3878346">.</span><span class="ident" id="3878347">releaseConn</span><span class="op" id="3878358">,</span>&nbsp;<span class="ident" id="3878360">si</span><span class="op" id="3878362">,</span>&nbsp;<span class="ident" id="3878364">nil</span><br>
<span class="lineno"></span><span class="op" id="3878368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1430</span><span class="comment" id="3878371">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments</span><br>
<span class="lineno"></span><span class="comment" id="3878441">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;query&nbsp;results&nbsp;as&nbsp;a&nbsp;*Rows.</span><br>
<span class="lineno"></span><span class="keyword" id="3878486">func</span>&nbsp;<span class="op" id="3878491">(</span><span class="ident" id="3878492">s</span>&nbsp;<span class="op" id="3878494">*</span><span class="ident" id="3878495">Stmt</span><span class="op" id="3878499">)</span>&nbsp;<span class="ident" id="3878501">Query</span><span class="op" id="3878506">(</span><span class="ident" id="3878507">args</span>&nbsp;<span class="op" id="3878512">...</span><span class="keyword" id="3878515">interface</span><span class="op" id="3878524">{</span><span class="op" id="3878525">}</span><span class="op" id="3878526">)</span>&nbsp;<span class="op" id="3878528">(</span><span class="op" id="3878529">*</span><span class="ident" id="3878530">Rows</span><span class="op" id="3878534">,</span>&nbsp;<span class="builtintype" id="3878536">error</span><span class="op" id="3878541">)</span>&nbsp;<span class="op" id="3878543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878546">s</span><span class="op" id="3878547">.</span><span class="ident" id="3878548">closemu</span><span class="op" id="3878555">.</span><span class="ident" id="3878556">RLock</span><span class="op" id="3878561">(</span><span class="op" id="3878562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878565">defer</span>&nbsp;<span class="ident" id="3878571">s</span><span class="op" id="3878572">.</span><span class="ident" id="3878573">closemu</span><span class="op" id="3878580">.</span><span class="ident" id="3878581">RUnlock</span><span class="op" id="3878588">(</span><span class="op" id="3878589">)</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878593">var</span>&nbsp;<span class="ident" id="3878597">rowsi</span>&nbsp;<span class="ident" id="3878603">driver</span><span class="op" id="3878609">.</span><span class="ident" id="3878610">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878616">for</span>&nbsp;<span class="ident" id="3878620">i</span>&nbsp;<span class="op" id="3878622">:=</span>&nbsp;<span class="num" id="3878625">0</span><span class="op" id="3878626">;</span>&nbsp;<span class="ident" id="3878628">i</span>&nbsp;<span class="op" id="3878630">&lt;</span>&nbsp;<span class="ident" id="3878632">maxBadConnRetries</span><span class="op" id="3878649">;</span>&nbsp;<span class="ident" id="3878651">i</span><span class="op" id="3878652">++</span>&nbsp;<span class="op" id="3878655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878659">dc</span><span class="op" id="3878661">,</span>&nbsp;<span class="ident" id="3878663">releaseConn</span><span class="op" id="3878674">,</span>&nbsp;<span class="ident" id="3878676">si</span><span class="op" id="3878678">,</span>&nbsp;<span class="ident" id="3878680">err</span>&nbsp;<span class="op" id="3878684">:=</span>&nbsp;<span class="ident" id="3878687">s</span><span class="op" id="3878688">.</span><span class="ident" id="3878689">connStmt</span><span class="op" id="3878697">(</span><span class="op" id="3878698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878702">if</span>&nbsp;<span class="ident" id="3878705">err</span>&nbsp;<span class="op" id="3878709">!=</span>&nbsp;<span class="ident" id="3878712">nil</span>&nbsp;<span class="op" id="3878716">{</span><br>
<span class="lineno">1440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878721">if</span>&nbsp;<span class="ident" id="3878724">err</span>&nbsp;<span class="op" id="3878728">==</span>&nbsp;<span class="ident" id="3878731">driver</span><span class="op" id="3878737">.</span><span class="ident" id="3878738">ErrBadConn</span>&nbsp;<span class="op" id="3878749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878755">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878772">return</span>&nbsp;<span class="ident" id="3878779">nil</span><span class="op" id="3878782">,</span>&nbsp;<span class="ident" id="3878784">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878790">}</span><br>
<span class="lineno">1445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878795">rowsi</span><span class="op" id="3878800">,</span>&nbsp;<span class="ident" id="3878802">err</span>&nbsp;<span class="op" id="3878806">=</span>&nbsp;<span class="ident" id="3878808">rowsiFromStatement</span><span class="op" id="3878826">(</span><span class="ident" id="3878827">driverStmt</span><span class="op" id="3878837">{</span><span class="ident" id="3878838">dc</span><span class="op" id="3878840">,</span>&nbsp;<span class="ident" id="3878842">si</span><span class="op" id="3878844">}</span><span class="op" id="3878845">,</span>&nbsp;<span class="ident" id="3878847">args</span><span class="op" id="3878851">...</span><span class="op" id="3878854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878858">if</span>&nbsp;<span class="ident" id="3878861">err</span>&nbsp;<span class="op" id="3878865">==</span>&nbsp;<span class="ident" id="3878868">nil</span>&nbsp;<span class="op" id="3878872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878877">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878938">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878962">rows</span>&nbsp;<span class="op" id="3878967">:=</span>&nbsp;<span class="op" id="3878970">&amp;</span><span class="ident" id="3878971">Rows</span><span class="op" id="3878975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878981">dc</span><span class="op" id="3878983">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3878988">dc</span><span class="op" id="3878990">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878996">rowsi</span><span class="op" id="3879001">:</span>&nbsp;<span class="ident" id="3879003">rowsi</span><span class="op" id="3879008">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3879014">//&nbsp;releaseConn&nbsp;set&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879042">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879047">s</span><span class="op" id="3879048">.</span><span class="ident" id="3879049">db</span><span class="op" id="3879051">.</span><span class="ident" id="3879052">addDep</span><span class="op" id="3879058">(</span><span class="ident" id="3879059">s</span><span class="op" id="3879060">,</span>&nbsp;<span class="ident" id="3879062">rows</span><span class="op" id="3879066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879071">rows</span><span class="op" id="3879075">.</span><span class="ident" id="3879076">releaseConn</span>&nbsp;<span class="op" id="3879088">=</span>&nbsp;<span class="keyword" id="3879090">func</span><span class="op" id="3879094">(</span><span class="ident" id="3879095">err</span>&nbsp;<span class="builtintype" id="3879099">error</span><span class="op" id="3879104">)</span>&nbsp;<span class="op" id="3879106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879112">releaseConn</span><span class="op" id="3879123">(</span><span class="ident" id="3879124">err</span><span class="op" id="3879127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879133">s</span><span class="op" id="3879134">.</span><span class="ident" id="3879135">db</span><span class="op" id="3879137">.</span><span class="ident" id="3879138">removeDep</span><span class="op" id="3879147">(</span><span class="ident" id="3879148">s</span><span class="op" id="3879149">,</span>&nbsp;<span class="ident" id="3879151">rows</span><span class="op" id="3879155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879160">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879165">return</span>&nbsp;<span class="ident" id="3879172">rows</span><span class="op" id="3879176">,</span>&nbsp;<span class="ident" id="3879178">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879189">releaseConn</span><span class="op" id="3879200">(</span><span class="ident" id="3879201">err</span><span class="op" id="3879204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879208">if</span>&nbsp;<span class="ident" id="3879211">err</span>&nbsp;<span class="op" id="3879215">!=</span>&nbsp;<span class="ident" id="3879218">driver</span><span class="op" id="3879224">.</span><span class="ident" id="3879225">ErrBadConn</span>&nbsp;<span class="op" id="3879236">{</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879241">return</span>&nbsp;<span class="ident" id="3879248">nil</span><span class="op" id="3879251">,</span>&nbsp;<span class="ident" id="3879253">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879265">return</span>&nbsp;<span class="ident" id="3879272">nil</span><span class="op" id="3879275">,</span>&nbsp;<span class="ident" id="3879277">driver</span><span class="op" id="3879283">.</span><span class="ident" id="3879284">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="3879295">}</span><br>
<span class="lineno">1470</span><br>
<span class="lineno"></span><span class="keyword" id="3879298">func</span>&nbsp;<span class="ident" id="3879303">rowsiFromStatement</span><span class="op" id="3879321">(</span><span class="ident" id="3879322">ds</span>&nbsp;<span class="ident" id="3879325">driverStmt</span><span class="op" id="3879335">,</span>&nbsp;<span class="ident" id="3879337">args</span>&nbsp;<span class="op" id="3879342">...</span><span class="keyword" id="3879345">interface</span><span class="op" id="3879354">{</span><span class="op" id="3879355">}</span><span class="op" id="3879356">)</span>&nbsp;<span class="op" id="3879358">(</span><span class="ident" id="3879359">driver</span><span class="op" id="3879365">.</span><span class="ident" id="3879366">Rows</span><span class="op" id="3879370">,</span>&nbsp;<span class="builtintype" id="3879372">error</span><span class="op" id="3879377">)</span>&nbsp;<span class="op" id="3879379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879382">ds</span><span class="op" id="3879384">.</span><span class="ident" id="3879385">Lock</span><span class="op" id="3879389">(</span><span class="op" id="3879390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879393">want</span>&nbsp;<span class="op" id="3879398">:=</span>&nbsp;<span class="ident" id="3879401">ds</span><span class="op" id="3879403">.</span><span class="ident" id="3879404">si</span><span class="op" id="3879406">.</span><span class="ident" id="3879407">NumInput</span><span class="op" id="3879415">(</span><span class="op" id="3879416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879419">ds</span><span class="op" id="3879421">.</span><span class="ident" id="3879422">Unlock</span><span class="op" id="3879428">(</span><span class="op" id="3879429">)</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3879433">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3879497">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3879571">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879600">if</span>&nbsp;<span class="ident" id="3879603">want</span>&nbsp;<span class="op" id="3879608">!=</span>&nbsp;<span class="op" id="3879611">-</span><span class="num" id="3879612">1</span>&nbsp;<span class="op" id="3879614">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3879617">len</span><span class="op" id="3879620">(</span><span class="ident" id="3879621">args</span><span class="op" id="3879625">)</span>&nbsp;<span class="op" id="3879627">!=</span>&nbsp;<span class="ident" id="3879630">want</span>&nbsp;<span class="op" id="3879635">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879639">return</span>&nbsp;<span class="ident" id="3879646">nil</span><span class="op" id="3879649">,</span>&nbsp;<span class="ident" id="3879651">fmt</span><span class="op" id="3879654">.</span><span class="ident" id="3879655">Errorf</span><span class="op" id="3879661">(</span><span class="string" id="3879662">&#34;sql:&nbsp;statement&nbsp;expects&nbsp;%d&nbsp;inputs;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="3879704">,</span>&nbsp;<span class="ident" id="3879706">want</span><span class="op" id="3879710">,</span>&nbsp;<span class="builtinfunc" id="3879712">len</span><span class="op" id="3879715">(</span><span class="ident" id="3879716">args</span><span class="op" id="3879720">)</span><span class="op" id="3879721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879728">dargs</span><span class="op" id="3879733">,</span>&nbsp;<span class="ident" id="3879735">err</span>&nbsp;<span class="op" id="3879739">:=</span>&nbsp;<span class="ident" id="3879742">driverArgs</span><span class="op" id="3879752">(</span><span class="op" id="3879753">&amp;</span><span class="ident" id="3879754">ds</span><span class="op" id="3879756">,</span>&nbsp;<span class="ident" id="3879758">args</span><span class="op" id="3879762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879765">if</span>&nbsp;<span class="ident" id="3879768">err</span>&nbsp;<span class="op" id="3879772">!=</span>&nbsp;<span class="ident" id="3879775">nil</span>&nbsp;<span class="op" id="3879779">{</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879783">return</span>&nbsp;<span class="ident" id="3879790">nil</span><span class="op" id="3879793">,</span>&nbsp;<span class="ident" id="3879795">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879804">ds</span><span class="op" id="3879806">.</span><span class="ident" id="3879807">Lock</span><span class="op" id="3879811">(</span><span class="op" id="3879812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879815">rowsi</span><span class="op" id="3879820">,</span>&nbsp;<span class="ident" id="3879822">err</span>&nbsp;<span class="op" id="3879826">:=</span>&nbsp;<span class="ident" id="3879829">ds</span><span class="op" id="3879831">.</span><span class="ident" id="3879832">si</span><span class="op" id="3879834">.</span><span class="ident" id="3879835">Query</span><span class="op" id="3879840">(</span><span class="ident" id="3879841">dargs</span><span class="op" id="3879846">)</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879849">ds</span><span class="op" id="3879851">.</span><span class="ident" id="3879852">Unlock</span><span class="op" id="3879858">(</span><span class="op" id="3879859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879862">if</span>&nbsp;<span class="ident" id="3879865">err</span>&nbsp;<span class="op" id="3879869">!=</span>&nbsp;<span class="ident" id="3879872">nil</span>&nbsp;<span class="op" id="3879876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879880">return</span>&nbsp;<span class="ident" id="3879887">nil</span><span class="op" id="3879890">,</span>&nbsp;<span class="ident" id="3879892">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879900">return</span>&nbsp;<span class="ident" id="3879907">rowsi</span><span class="op" id="3879912">,</span>&nbsp;<span class="ident" id="3879914">nil</span><br>
<span class="lineno">1495</span><span class="op" id="3879918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3879921">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="3879995">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;statement,&nbsp;that&nbsp;error&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="3880072">//&nbsp;be&nbsp;returned&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Scan&nbsp;on&nbsp;the&nbsp;returned&nbsp;*Row,&nbsp;which&nbsp;is&nbsp;always&nbsp;non-nil.</span><br>
<span class="lineno">1500</span><span class="comment" id="3880152">//&nbsp;If&nbsp;the&nbsp;query&nbsp;selects&nbsp;no&nbsp;rows,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;will&nbsp;return&nbsp;ErrNoRows.</span><br>
<span class="lineno"></span><span class="comment" id="3880224">//&nbsp;Otherwise,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;scans&nbsp;the&nbsp;first&nbsp;selected&nbsp;row&nbsp;and&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="3880296">//&nbsp;the&nbsp;rest.</span><br>
<span class="lineno"></span><span class="comment" id="3880309">//</span><br>
<span class="lineno"></span><span class="comment" id="3880312">//&nbsp;Example&nbsp;usage:</span><br>
<span class="lineno">1505</span><span class="comment" id="3880330">//</span><br>
<span class="lineno"></span><span class="comment" id="3880333">//&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3880353">//&nbsp;&nbsp;err&nbsp;:=&nbsp;nameByUseridStmt.QueryRow(id).Scan(&amp;name)</span><br>
<span class="lineno"></span><span class="keyword" id="3880406">func</span>&nbsp;<span class="op" id="3880411">(</span><span class="ident" id="3880412">s</span>&nbsp;<span class="op" id="3880414">*</span><span class="ident" id="3880415">Stmt</span><span class="op" id="3880419">)</span>&nbsp;<span class="ident" id="3880421">QueryRow</span><span class="op" id="3880429">(</span><span class="ident" id="3880430">args</span>&nbsp;<span class="op" id="3880435">...</span><span class="keyword" id="3880438">interface</span><span class="op" id="3880447">{</span><span class="op" id="3880448">}</span><span class="op" id="3880449">)</span>&nbsp;<span class="op" id="3880451">*</span><span class="ident" id="3880452">Row</span>&nbsp;<span class="op" id="3880456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880459">rows</span><span class="op" id="3880463">,</span>&nbsp;<span class="ident" id="3880465">err</span>&nbsp;<span class="op" id="3880469">:=</span>&nbsp;<span class="ident" id="3880472">s</span><span class="op" id="3880473">.</span><span class="ident" id="3880474">Query</span><span class="op" id="3880479">(</span><span class="ident" id="3880480">args</span><span class="op" id="3880484">...</span><span class="op" id="3880487">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880490">if</span>&nbsp;<span class="ident" id="3880493">err</span>&nbsp;<span class="op" id="3880497">!=</span>&nbsp;<span class="ident" id="3880500">nil</span>&nbsp;<span class="op" id="3880504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880508">return</span>&nbsp;<span class="op" id="3880515">&amp;</span><span class="ident" id="3880516">Row</span><span class="op" id="3880519">{</span><span class="ident" id="3880520">err</span><span class="op" id="3880523">:</span>&nbsp;<span class="ident" id="3880525">err</span><span class="op" id="3880528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3880531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880534">return</span>&nbsp;<span class="op" id="3880541">&amp;</span><span class="ident" id="3880542">Row</span><span class="op" id="3880545">{</span><span class="ident" id="3880546">rows</span><span class="op" id="3880550">:</span>&nbsp;<span class="ident" id="3880552">rows</span><span class="op" id="3880556">}</span><br>
<span class="lineno"></span><span class="op" id="3880558">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="3880561">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="3880592">func</span>&nbsp;<span class="op" id="3880597">(</span><span class="ident" id="3880598">s</span>&nbsp;<span class="op" id="3880600">*</span><span class="ident" id="3880601">Stmt</span><span class="op" id="3880605">)</span>&nbsp;<span class="ident" id="3880607">Close</span><span class="op" id="3880612">(</span><span class="op" id="3880613">)</span>&nbsp;<span class="builtintype" id="3880615">error</span>&nbsp;<span class="op" id="3880621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880624">s</span><span class="op" id="3880625">.</span><span class="ident" id="3880626">closemu</span><span class="op" id="3880633">.</span><span class="ident" id="3880634">Lock</span><span class="op" id="3880638">(</span><span class="op" id="3880639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880642">defer</span>&nbsp;<span class="ident" id="3880648">s</span><span class="op" id="3880649">.</span><span class="ident" id="3880650">closemu</span><span class="op" id="3880657">.</span><span class="ident" id="3880658">Unlock</span><span class="op" id="3880664">(</span><span class="op" id="3880665">)</span><br>
<span class="lineno">1520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880669">if</span>&nbsp;<span class="ident" id="3880672">s</span><span class="op" id="3880673">.</span><span class="ident" id="3880674">stickyErr</span>&nbsp;<span class="op" id="3880684">!=</span>&nbsp;<span class="ident" id="3880687">nil</span>&nbsp;<span class="op" id="3880691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880695">return</span>&nbsp;<span class="ident" id="3880702">s</span><span class="op" id="3880703">.</span><span class="ident" id="3880704">stickyErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3880715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880718">s</span><span class="op" id="3880719">.</span><span class="ident" id="3880720">mu</span><span class="op" id="3880722">.</span><span class="ident" id="3880723">Lock</span><span class="op" id="3880727">(</span><span class="op" id="3880728">)</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880731">if</span>&nbsp;<span class="ident" id="3880734">s</span><span class="op" id="3880735">.</span><span class="ident" id="3880736">closed</span>&nbsp;<span class="op" id="3880743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880747">s</span><span class="op" id="3880748">.</span><span class="ident" id="3880749">mu</span><span class="op" id="3880751">.</span><span class="ident" id="3880752">Unlock</span><span class="op" id="3880758">(</span><span class="op" id="3880759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880763">return</span>&nbsp;<span class="ident" id="3880770">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3880775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880778">s</span><span class="op" id="3880779">.</span><span class="ident" id="3880780">closed</span>&nbsp;<span class="op" id="3880787">=</span>&nbsp;<span class="builtintype" id="3880789">true</span><br>
<span class="lineno">1530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880796">if</span>&nbsp;<span class="ident" id="3880799">s</span><span class="op" id="3880800">.</span><span class="ident" id="3880801">tx</span>&nbsp;<span class="op" id="3880804">!=</span>&nbsp;<span class="ident" id="3880807">nil</span>&nbsp;<span class="op" id="3880811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880815">s</span><span class="op" id="3880816">.</span><span class="ident" id="3880817">txsi</span><span class="op" id="3880821">.</span><span class="ident" id="3880822">Close</span><span class="op" id="3880827">(</span><span class="op" id="3880828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880832">s</span><span class="op" id="3880833">.</span><span class="ident" id="3880834">mu</span><span class="op" id="3880836">.</span><span class="ident" id="3880837">Unlock</span><span class="op" id="3880843">(</span><span class="op" id="3880844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880848">return</span>&nbsp;<span class="ident" id="3880855">nil</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3880860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880863">s</span><span class="op" id="3880864">.</span><span class="ident" id="3880865">mu</span><span class="op" id="3880867">.</span><span class="ident" id="3880868">Unlock</span><span class="op" id="3880874">(</span><span class="op" id="3880875">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880879">return</span>&nbsp;<span class="ident" id="3880886">s</span><span class="op" id="3880887">.</span><span class="ident" id="3880888">db</span><span class="op" id="3880890">.</span><span class="ident" id="3880891">removeDep</span><span class="op" id="3880900">(</span><span class="ident" id="3880901">s</span><span class="op" id="3880902">,</span>&nbsp;<span class="ident" id="3880904">s</span><span class="op" id="3880905">)</span><br>
<span class="lineno"></span><span class="op" id="3880907">}</span><br>
<span class="lineno">1540</span><br>
<span class="lineno"></span><span class="keyword" id="3880910">func</span>&nbsp;<span class="op" id="3880915">(</span><span class="ident" id="3880916">s</span>&nbsp;<span class="op" id="3880918">*</span><span class="ident" id="3880919">Stmt</span><span class="op" id="3880923">)</span>&nbsp;<span class="ident" id="3880925">finalClose</span><span class="op" id="3880935">(</span><span class="op" id="3880936">)</span>&nbsp;<span class="builtintype" id="3880938">error</span>&nbsp;<span class="op" id="3880944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880947">s</span><span class="op" id="3880948">.</span><span class="ident" id="3880949">mu</span><span class="op" id="3880951">.</span><span class="ident" id="3880952">Lock</span><span class="op" id="3880956">(</span><span class="op" id="3880957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880960">defer</span>&nbsp;<span class="ident" id="3880966">s</span><span class="op" id="3880967">.</span><span class="ident" id="3880968">mu</span><span class="op" id="3880970">.</span><span class="ident" id="3880971">Unlock</span><span class="op" id="3880977">(</span><span class="op" id="3880978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880981">if</span>&nbsp;<span class="ident" id="3880984">s</span><span class="op" id="3880985">.</span><span class="ident" id="3880986">css</span>&nbsp;<span class="op" id="3880990">!=</span>&nbsp;<span class="ident" id="3880993">nil</span>&nbsp;<span class="op" id="3880997">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881001">for</span>&nbsp;<span class="ident" id="3881005">_</span><span class="op" id="3881006">,</span>&nbsp;<span class="ident" id="3881008">v</span>&nbsp;<span class="op" id="3881010">:=</span>&nbsp;<span class="keyword" id="3881013">range</span>&nbsp;<span class="ident" id="3881019">s</span><span class="op" id="3881020">.</span><span class="ident" id="3881021">css</span>&nbsp;<span class="op" id="3881025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881030">s</span><span class="op" id="3881031">.</span><span class="ident" id="3881032">db</span><span class="op" id="3881034">.</span><span class="ident" id="3881035">noteUnusedDriverStatement</span><span class="op" id="3881060">(</span><span class="ident" id="3881061">v</span><span class="op" id="3881062">.</span><span class="ident" id="3881063">dc</span><span class="op" id="3881065">,</span>&nbsp;<span class="ident" id="3881067">v</span><span class="op" id="3881068">.</span><span class="ident" id="3881069">si</span><span class="op" id="3881071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881076">v</span><span class="op" id="3881077">.</span><span class="ident" id="3881078">dc</span><span class="op" id="3881080">.</span><span class="ident" id="3881081">removeOpenStmt</span><span class="op" id="3881095">(</span><span class="ident" id="3881096">v</span><span class="op" id="3881097">.</span><span class="ident" id="3881098">si</span><span class="op" id="3881100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3881104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881108">s</span><span class="op" id="3881109">.</span><span class="ident" id="3881110">css</span>&nbsp;<span class="op" id="3881114">=</span>&nbsp;<span class="ident" id="3881116">nil</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3881121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881124">return</span>&nbsp;<span class="ident" id="3881131">nil</span><br>
<span class="lineno"></span><span class="op" id="3881135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3881138">//&nbsp;Rows&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;query.&nbsp;Its&nbsp;cursor&nbsp;starts&nbsp;before&nbsp;the&nbsp;first&nbsp;row</span><br>
<span class="lineno">1555</span><span class="comment" id="3881211">//&nbsp;of&nbsp;the&nbsp;result&nbsp;set.&nbsp;Use&nbsp;Next&nbsp;to&nbsp;advance&nbsp;through&nbsp;the&nbsp;rows:</span><br>
<span class="lineno"></span><span class="comment" id="3881271">//</span><br>
<span class="lineno"></span><span class="comment" id="3881274">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rows,&nbsp;err&nbsp;:=&nbsp;db.Query(&#34;SELECT&nbsp;...&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3881317">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="3881328">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defer&nbsp;rows.Close()</span><br>
<span class="lineno">1560</span><span class="comment" id="3881354">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;rows.Next()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3881379">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;id&nbsp;int</span><br>
<span class="lineno"></span><span class="comment" id="3881401">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3881428">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Scan(&amp;id,&nbsp;&amp;name)</span><br>
<span class="lineno"></span><span class="comment" id="3881467">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno">1565</span><span class="comment" id="3881482">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3881491">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Err()&nbsp;//&nbsp;get&nbsp;any&nbsp;error&nbsp;encountered&nbsp;during&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="3881561">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="keyword" id="3881572">type</span>&nbsp;<span class="ident" id="3881577">Rows</span>&nbsp;<span class="keyword" id="3881582">struct</span>&nbsp;<span class="op" id="3881589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881592">dc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3881604">*</span><span class="ident" id="3881605">driverConn</span>&nbsp;<span class="comment" id="3881616">//&nbsp;owned;&nbsp;must&nbsp;call&nbsp;releaseConn&nbsp;when&nbsp;closed&nbsp;to&nbsp;release</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881672">releaseConn</span>&nbsp;<span class="keyword" id="3881684">func</span><span class="op" id="3881688">(</span><span class="builtintype" id="3881689">error</span><span class="op" id="3881694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881697">rowsi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3881709">driver</span><span class="op" id="3881715">.</span><span class="ident" id="3881716">Rows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881723">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3881733">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881739">lastcols</span>&nbsp;&nbsp;<span class="op" id="3881749">[</span><span class="op" id="3881750">]</span><span class="ident" id="3881751">driver</span><span class="op" id="3881757">.</span><span class="ident" id="3881758">Value</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881765">lasterr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3881775">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3881787">//&nbsp;non-nil&nbsp;only&nbsp;if&nbsp;closed&nbsp;is&nbsp;true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881822">closeStmt</span>&nbsp;<span class="ident" id="3881832">driver</span><span class="op" id="3881838">.</span><span class="ident" id="3881839">Stmt</span>&nbsp;<span class="comment" id="3881844">//&nbsp;if&nbsp;non-nil,&nbsp;statement&nbsp;to&nbsp;Close&nbsp;on&nbsp;close</span><br>
<span class="lineno"></span><span class="op" id="3881887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3881890">//&nbsp;Next&nbsp;prepares&nbsp;the&nbsp;next&nbsp;result&nbsp;row&nbsp;for&nbsp;reading&nbsp;with&nbsp;the&nbsp;Scan&nbsp;method.&nbsp;&nbsp;It</span><br>
<span class="lineno">1580</span><span class="comment" id="3881965">//&nbsp;returns&nbsp;true&nbsp;on&nbsp;success,&nbsp;or&nbsp;false&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;next&nbsp;result&nbsp;row&nbsp;or&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3882045">//&nbsp;happened&nbsp;while&nbsp;preparing&nbsp;it.&nbsp;&nbsp;Err&nbsp;should&nbsp;be&nbsp;consulted&nbsp;to&nbsp;distinguish&nbsp;between</span><br>
<span class="lineno"></span><span class="comment" id="3882125">//&nbsp;the&nbsp;two&nbsp;cases.</span><br>
<span class="lineno"></span><span class="comment" id="3882143">//</span><br>
<span class="lineno"></span><span class="comment" id="3882146">//&nbsp;Every&nbsp;call&nbsp;to&nbsp;Scan,&nbsp;even&nbsp;the&nbsp;first&nbsp;one,&nbsp;must&nbsp;be&nbsp;preceded&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Next.</span><br>
<span class="lineno">1585</span><span class="keyword" id="3882225">func</span>&nbsp;<span class="op" id="3882230">(</span><span class="ident" id="3882231">rs</span>&nbsp;<span class="op" id="3882234">*</span><span class="ident" id="3882235">Rows</span><span class="op" id="3882239">)</span>&nbsp;<span class="ident" id="3882241">Next</span><span class="op" id="3882245">(</span><span class="op" id="3882246">)</span>&nbsp;<span class="builtintype" id="3882248">bool</span>&nbsp;<span class="op" id="3882253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882256">if</span>&nbsp;<span class="ident" id="3882259">rs</span><span class="op" id="3882261">.</span><span class="ident" id="3882262">closed</span>&nbsp;<span class="op" id="3882269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882273">return</span>&nbsp;<span class="builtintype" id="3882280">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882290">if</span>&nbsp;<span class="ident" id="3882293">rs</span><span class="op" id="3882295">.</span><span class="ident" id="3882296">lastcols</span>&nbsp;<span class="op" id="3882305">==</span>&nbsp;<span class="ident" id="3882308">nil</span>&nbsp;<span class="op" id="3882312">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882316">rs</span><span class="op" id="3882318">.</span><span class="ident" id="3882319">lastcols</span>&nbsp;<span class="op" id="3882328">=</span>&nbsp;<span class="builtinfunc" id="3882330">make</span><span class="op" id="3882334">(</span><span class="op" id="3882335">[</span><span class="op" id="3882336">]</span><span class="ident" id="3882337">driver</span><span class="op" id="3882343">.</span><span class="ident" id="3882344">Value</span><span class="op" id="3882349">,</span>&nbsp;<span class="builtinfunc" id="3882351">len</span><span class="op" id="3882354">(</span><span class="ident" id="3882355">rs</span><span class="op" id="3882357">.</span><span class="ident" id="3882358">rowsi</span><span class="op" id="3882363">.</span><span class="ident" id="3882364">Columns</span><span class="op" id="3882371">(</span><span class="op" id="3882372">)</span><span class="op" id="3882373">)</span><span class="op" id="3882374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882380">rs</span><span class="op" id="3882382">.</span><span class="ident" id="3882383">lasterr</span>&nbsp;<span class="op" id="3882391">=</span>&nbsp;<span class="ident" id="3882393">rs</span><span class="op" id="3882395">.</span><span class="ident" id="3882396">rowsi</span><span class="op" id="3882401">.</span><span class="ident" id="3882402">Next</span><span class="op" id="3882406">(</span><span class="ident" id="3882407">rs</span><span class="op" id="3882409">.</span><span class="ident" id="3882410">lastcols</span><span class="op" id="3882418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882421">if</span>&nbsp;<span class="ident" id="3882424">rs</span><span class="op" id="3882426">.</span><span class="ident" id="3882427">lasterr</span>&nbsp;<span class="op" id="3882435">!=</span>&nbsp;<span class="ident" id="3882438">nil</span>&nbsp;<span class="op" id="3882442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882446">rs</span><span class="op" id="3882448">.</span><span class="ident" id="3882449">Close</span><span class="op" id="3882454">(</span><span class="op" id="3882455">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882459">return</span>&nbsp;<span class="builtintype" id="3882466">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882476">return</span>&nbsp;<span class="builtintype" id="3882483">true</span><br>
<span class="lineno"></span><span class="op" id="3882488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="3882491">//&nbsp;Err&nbsp;returns&nbsp;the&nbsp;error,&nbsp;if&nbsp;any,&nbsp;that&nbsp;was&nbsp;encountered&nbsp;during&nbsp;iteration.</span><br>
<span class="lineno"></span><span class="comment" id="3882564">//&nbsp;Err&nbsp;may&nbsp;be&nbsp;called&nbsp;after&nbsp;an&nbsp;explicit&nbsp;or&nbsp;implicit&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3882622">func</span>&nbsp;<span class="op" id="3882627">(</span><span class="ident" id="3882628">rs</span>&nbsp;<span class="op" id="3882631">*</span><span class="ident" id="3882632">Rows</span><span class="op" id="3882636">)</span>&nbsp;<span class="ident" id="3882638">Err</span><span class="op" id="3882641">(</span><span class="op" id="3882642">)</span>&nbsp;<span class="builtintype" id="3882644">error</span>&nbsp;<span class="op" id="3882650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882653">if</span>&nbsp;<span class="ident" id="3882656">rs</span><span class="op" id="3882658">.</span><span class="ident" id="3882659">lasterr</span>&nbsp;<span class="op" id="3882667">==</span>&nbsp;<span class="ident" id="3882670">io</span><span class="op" id="3882672">.</span><span class="ident" id="3882673">EOF</span>&nbsp;<span class="op" id="3882677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882681">return</span>&nbsp;<span class="ident" id="3882688">nil</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882696">return</span>&nbsp;<span class="ident" id="3882703">rs</span><span class="op" id="3882705">.</span><span class="ident" id="3882706">lasterr</span><br>
<span class="lineno"></span><span class="op" id="3882714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3882717">//&nbsp;Columns&nbsp;returns&nbsp;the&nbsp;column&nbsp;names.</span><br>
<span class="lineno">1610</span><span class="comment" id="3882754">//&nbsp;Columns&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;rows&nbsp;are&nbsp;closed,&nbsp;or&nbsp;if&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span><span class="comment" id="3882821">//&nbsp;are&nbsp;from&nbsp;QueryRow&nbsp;and&nbsp;there&nbsp;was&nbsp;a&nbsp;deferred&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3882874">func</span>&nbsp;<span class="op" id="3882879">(</span><span class="ident" id="3882880">rs</span>&nbsp;<span class="op" id="3882883">*</span><span class="ident" id="3882884">Rows</span><span class="op" id="3882888">)</span>&nbsp;<span class="ident" id="3882890">Columns</span><span class="op" id="3882897">(</span><span class="op" id="3882898">)</span>&nbsp;<span class="op" id="3882900">(</span><span class="op" id="3882901">[</span><span class="op" id="3882902">]</span><span class="builtintype" id="3882903">string</span><span class="op" id="3882909">,</span>&nbsp;<span class="builtintype" id="3882911">error</span><span class="op" id="3882916">)</span>&nbsp;<span class="op" id="3882918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882921">if</span>&nbsp;<span class="ident" id="3882924">rs</span><span class="op" id="3882926">.</span><span class="ident" id="3882927">closed</span>&nbsp;<span class="op" id="3882934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882938">return</span>&nbsp;<span class="ident" id="3882945">nil</span><span class="op" id="3882948">,</span>&nbsp;<span class="ident" id="3882950">errors</span><span class="op" id="3882956">.</span><span class="ident" id="3882957">New</span><span class="op" id="3882960">(</span><span class="string" id="3882961">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="3882983">)</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882989">if</span>&nbsp;<span class="ident" id="3882992">rs</span><span class="op" id="3882994">.</span><span class="ident" id="3882995">rowsi</span>&nbsp;<span class="op" id="3883001">==</span>&nbsp;<span class="ident" id="3883004">nil</span>&nbsp;<span class="op" id="3883008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883012">return</span>&nbsp;<span class="ident" id="3883019">nil</span><span class="op" id="3883022">,</span>&nbsp;<span class="ident" id="3883024">errors</span><span class="op" id="3883030">.</span><span class="ident" id="3883031">New</span><span class="op" id="3883034">(</span><span class="string" id="3883035">&#34;sql:&nbsp;no&nbsp;Rows&nbsp;available&#34;</span><span class="op" id="3883059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3883062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883065">return</span>&nbsp;<span class="ident" id="3883072">rs</span><span class="op" id="3883074">.</span><span class="ident" id="3883075">rowsi</span><span class="op" id="3883080">.</span><span class="ident" id="3883081">Columns</span><span class="op" id="3883088">(</span><span class="op" id="3883089">)</span><span class="op" id="3883090">,</span>&nbsp;<span class="ident" id="3883092">nil</span><br>
<span class="lineno">1620</span><span class="op" id="3883096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3883099">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;in&nbsp;the&nbsp;current&nbsp;row&nbsp;into&nbsp;the&nbsp;values&nbsp;pointed</span><br>
<span class="lineno"></span><span class="comment" id="3883169">//&nbsp;at&nbsp;by&nbsp;dest.</span><br>
<span class="lineno"></span><span class="comment" id="3883184">//</span><br>
<span class="lineno">1625</span><span class="comment" id="3883187">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*[]byte,&nbsp;Scan&nbsp;saves&nbsp;in&nbsp;that&nbsp;argument&nbsp;a&nbsp;copy</span><br>
<span class="lineno"></span><span class="comment" id="3883258">//&nbsp;of&nbsp;the&nbsp;corresponding&nbsp;data.&nbsp;The&nbsp;copy&nbsp;is&nbsp;owned&nbsp;by&nbsp;the&nbsp;caller&nbsp;and&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="3883328">//&nbsp;be&nbsp;modified&nbsp;and&nbsp;held&nbsp;indefinitely.&nbsp;The&nbsp;copy&nbsp;can&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using</span><br>
<span class="lineno"></span><span class="comment" id="3883399">//&nbsp;an&nbsp;argument&nbsp;of&nbsp;type&nbsp;*RawBytes&nbsp;instead;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3883467">//&nbsp;RawBytes&nbsp;for&nbsp;restrictions&nbsp;on&nbsp;its&nbsp;use.</span><br>
<span class="lineno">1630</span><span class="comment" id="3883508">//</span><br>
<span class="lineno"></span><span class="comment" id="3883511">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*interface{},&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3883574">//&nbsp;provided&nbsp;by&nbsp;the&nbsp;underlying&nbsp;driver&nbsp;without&nbsp;conversion.&nbsp;If&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3883644">//&nbsp;is&nbsp;of&nbsp;type&nbsp;[]byte,&nbsp;a&nbsp;copy&nbsp;is&nbsp;made&nbsp;and&nbsp;the&nbsp;caller&nbsp;owns&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span><span class="keyword" id="3883713">func</span>&nbsp;<span class="op" id="3883718">(</span><span class="ident" id="3883719">rs</span>&nbsp;<span class="op" id="3883722">*</span><span class="ident" id="3883723">Rows</span><span class="op" id="3883727">)</span>&nbsp;<span class="ident" id="3883729">Scan</span><span class="op" id="3883733">(</span><span class="ident" id="3883734">dest</span>&nbsp;<span class="op" id="3883739">...</span><span class="keyword" id="3883742">interface</span><span class="op" id="3883751">{</span><span class="op" id="3883752">}</span><span class="op" id="3883753">)</span>&nbsp;<span class="builtintype" id="3883755">error</span>&nbsp;<span class="op" id="3883761">{</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883764">if</span>&nbsp;<span class="ident" id="3883767">rs</span><span class="op" id="3883769">.</span><span class="ident" id="3883770">closed</span>&nbsp;<span class="op" id="3883777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883781">return</span>&nbsp;<span class="ident" id="3883788">errors</span><span class="op" id="3883794">.</span><span class="ident" id="3883795">New</span><span class="op" id="3883798">(</span><span class="string" id="3883799">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="3883821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3883824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883827">if</span>&nbsp;<span class="ident" id="3883830">rs</span><span class="op" id="3883832">.</span><span class="ident" id="3883833">lastcols</span>&nbsp;<span class="op" id="3883842">==</span>&nbsp;<span class="ident" id="3883845">nil</span>&nbsp;<span class="op" id="3883849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883853">return</span>&nbsp;<span class="ident" id="3883860">errors</span><span class="op" id="3883866">.</span><span class="ident" id="3883867">New</span><span class="op" id="3883870">(</span><span class="string" id="3883871">&#34;sql:&nbsp;Scan&nbsp;called&nbsp;without&nbsp;calling&nbsp;Next&#34;</span><span class="op" id="3883910">)</span><br>
<span class="lineno">1640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3883913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883916">if</span>&nbsp;<span class="builtinfunc" id="3883919">len</span><span class="op" id="3883922">(</span><span class="ident" id="3883923">dest</span><span class="op" id="3883927">)</span>&nbsp;<span class="op" id="3883929">!=</span>&nbsp;<span class="builtinfunc" id="3883932">len</span><span class="op" id="3883935">(</span><span class="ident" id="3883936">rs</span><span class="op" id="3883938">.</span><span class="ident" id="3883939">lastcols</span><span class="op" id="3883947">)</span>&nbsp;<span class="op" id="3883949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883953">return</span>&nbsp;<span class="ident" id="3883960">fmt</span><span class="op" id="3883963">.</span><span class="ident" id="3883964">Errorf</span><span class="op" id="3883970">(</span><span class="string" id="3883971">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;destination&nbsp;arguments&nbsp;in&nbsp;Scan,&nbsp;not&nbsp;%d&#34;</span><span class="op" id="3884027">,</span>&nbsp;<span class="builtinfunc" id="3884029">len</span><span class="op" id="3884032">(</span><span class="ident" id="3884033">rs</span><span class="op" id="3884035">.</span><span class="ident" id="3884036">lastcols</span><span class="op" id="3884044">)</span><span class="op" id="3884045">,</span>&nbsp;<span class="builtinfunc" id="3884047">len</span><span class="op" id="3884050">(</span><span class="ident" id="3884051">dest</span><span class="op" id="3884055">)</span><span class="op" id="3884056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884062">for</span>&nbsp;<span class="ident" id="3884066">i</span><span class="op" id="3884067">,</span>&nbsp;<span class="ident" id="3884069">sv</span>&nbsp;<span class="op" id="3884072">:=</span>&nbsp;<span class="keyword" id="3884075">range</span>&nbsp;<span class="ident" id="3884081">rs</span><span class="op" id="3884083">.</span><span class="ident" id="3884084">lastcols</span>&nbsp;<span class="op" id="3884093">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884097">err</span>&nbsp;<span class="op" id="3884101">:=</span>&nbsp;<span class="ident" id="3884104">convertAssign</span><span class="op" id="3884117">(</span><span class="ident" id="3884118">dest</span><span class="op" id="3884122">[</span><span class="ident" id="3884123">i</span><span class="op" id="3884124">]</span><span class="op" id="3884125">,</span>&nbsp;<span class="ident" id="3884127">sv</span><span class="op" id="3884129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884133">if</span>&nbsp;<span class="ident" id="3884136">err</span>&nbsp;<span class="op" id="3884140">!=</span>&nbsp;<span class="ident" id="3884143">nil</span>&nbsp;<span class="op" id="3884147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884152">return</span>&nbsp;<span class="ident" id="3884159">fmt</span><span class="op" id="3884162">.</span><span class="ident" id="3884163">Errorf</span><span class="op" id="3884169">(</span><span class="string" id="3884170">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="3884210">,</span>&nbsp;<span class="ident" id="3884212">i</span><span class="op" id="3884213">,</span>&nbsp;<span class="ident" id="3884215">err</span><span class="op" id="3884218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884225">}</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884228">return</span>&nbsp;<span class="ident" id="3884235">nil</span><br>
<span class="lineno"></span><span class="op" id="3884239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3884242">var</span>&nbsp;<span class="ident" id="3884246">rowsCloseHook</span>&nbsp;<span class="keyword" id="3884260">func</span><span class="op" id="3884264">(</span><span class="op" id="3884265">*</span><span class="ident" id="3884266">Rows</span><span class="op" id="3884270">,</span>&nbsp;<span class="op" id="3884272">*</span><span class="builtintype" id="3884273">error</span><span class="op" id="3884278">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1655</span><span class="comment" id="3884281">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;Rows,&nbsp;preventing&nbsp;further&nbsp;enumeration.&nbsp;If&nbsp;Next&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="3884355">//&nbsp;false,&nbsp;the&nbsp;Rows&nbsp;are&nbsp;closed&nbsp;automatically&nbsp;and&nbsp;it&nbsp;will&nbsp;suffice&nbsp;to&nbsp;check&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3884432">//&nbsp;result&nbsp;of&nbsp;Err.&nbsp;Close&nbsp;is&nbsp;idempotent&nbsp;and&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;result&nbsp;of&nbsp;Err.</span><br>
<span class="lineno"></span><span class="keyword" id="3884509">func</span>&nbsp;<span class="op" id="3884514">(</span><span class="ident" id="3884515">rs</span>&nbsp;<span class="op" id="3884518">*</span><span class="ident" id="3884519">Rows</span><span class="op" id="3884523">)</span>&nbsp;<span class="ident" id="3884525">Close</span><span class="op" id="3884530">(</span><span class="op" id="3884531">)</span>&nbsp;<span class="builtintype" id="3884533">error</span>&nbsp;<span class="op" id="3884539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884542">if</span>&nbsp;<span class="ident" id="3884545">rs</span><span class="op" id="3884547">.</span><span class="ident" id="3884548">closed</span>&nbsp;<span class="op" id="3884555">{</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884559">return</span>&nbsp;<span class="ident" id="3884566">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884574">rs</span><span class="op" id="3884576">.</span><span class="ident" id="3884577">closed</span>&nbsp;<span class="op" id="3884584">=</span>&nbsp;<span class="builtintype" id="3884586">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884592">err</span>&nbsp;<span class="op" id="3884596">:=</span>&nbsp;<span class="ident" id="3884599">rs</span><span class="op" id="3884601">.</span><span class="ident" id="3884602">rowsi</span><span class="op" id="3884607">.</span><span class="ident" id="3884608">Close</span><span class="op" id="3884613">(</span><span class="op" id="3884614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884617">if</span>&nbsp;<span class="ident" id="3884620">fn</span>&nbsp;<span class="op" id="3884623">:=</span>&nbsp;<span class="ident" id="3884626">rowsCloseHook</span><span class="op" id="3884639">;</span>&nbsp;<span class="ident" id="3884641">fn</span>&nbsp;<span class="op" id="3884644">!=</span>&nbsp;<span class="ident" id="3884647">nil</span>&nbsp;<span class="op" id="3884651">{</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884655">fn</span><span class="op" id="3884657">(</span><span class="ident" id="3884658">rs</span><span class="op" id="3884660">,</span>&nbsp;<span class="op" id="3884662">&amp;</span><span class="ident" id="3884663">err</span><span class="op" id="3884666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884672">if</span>&nbsp;<span class="ident" id="3884675">rs</span><span class="op" id="3884677">.</span><span class="ident" id="3884678">closeStmt</span>&nbsp;<span class="op" id="3884688">!=</span>&nbsp;<span class="ident" id="3884691">nil</span>&nbsp;<span class="op" id="3884695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884699">rs</span><span class="op" id="3884701">.</span><span class="ident" id="3884702">closeStmt</span><span class="op" id="3884711">.</span><span class="ident" id="3884712">Close</span><span class="op" id="3884717">(</span><span class="op" id="3884718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884721">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884724">rs</span><span class="op" id="3884726">.</span><span class="ident" id="3884727">releaseConn</span><span class="op" id="3884738">(</span><span class="ident" id="3884739">err</span><span class="op" id="3884742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884745">return</span>&nbsp;<span class="ident" id="3884752">err</span><br>
<span class="lineno"></span><span class="op" id="3884756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3884759">//&nbsp;Row&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;QueryRow&nbsp;to&nbsp;select&nbsp;a&nbsp;single&nbsp;row.</span><br>
<span class="lineno">1675</span><span class="keyword" id="3884824">type</span>&nbsp;<span class="ident" id="3884829">Row</span>&nbsp;<span class="keyword" id="3884833">struct</span>&nbsp;<span class="op" id="3884840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3884843">//&nbsp;One&nbsp;of&nbsp;these&nbsp;two&nbsp;will&nbsp;be&nbsp;non-nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884881">err</span>&nbsp;&nbsp;<span class="builtintype" id="3884886">error</span>&nbsp;<span class="comment" id="3884892">//&nbsp;deferred&nbsp;error&nbsp;for&nbsp;easy&nbsp;chaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884929">rows</span>&nbsp;<span class="op" id="3884934">*</span><span class="ident" id="3884935">Rows</span><br>
<span class="lineno"></span><span class="op" id="3884940">}</span><br>
<span class="lineno">1680</span><br>
<span class="lineno"></span><span class="comment" id="3884943">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;from&nbsp;the&nbsp;matched&nbsp;row&nbsp;into&nbsp;the&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="3885007">//&nbsp;pointed&nbsp;at&nbsp;by&nbsp;dest.&nbsp;&nbsp;If&nbsp;more&nbsp;than&nbsp;one&nbsp;row&nbsp;matches&nbsp;the&nbsp;query,</span><br>
<span class="lineno"></span><span class="comment" id="3885071">//&nbsp;Scan&nbsp;uses&nbsp;the&nbsp;first&nbsp;row&nbsp;and&nbsp;discards&nbsp;the&nbsp;rest.&nbsp;&nbsp;If&nbsp;no&nbsp;row&nbsp;matches</span><br>
<span class="lineno"></span><span class="comment" id="3885140">//&nbsp;the&nbsp;query,&nbsp;Scan&nbsp;returns&nbsp;ErrNoRows.</span><br>
<span class="lineno">1685</span><span class="keyword" id="3885178">func</span>&nbsp;<span class="op" id="3885183">(</span><span class="ident" id="3885184">r</span>&nbsp;<span class="op" id="3885186">*</span><span class="ident" id="3885187">Row</span><span class="op" id="3885190">)</span>&nbsp;<span class="ident" id="3885192">Scan</span><span class="op" id="3885196">(</span><span class="ident" id="3885197">dest</span>&nbsp;<span class="op" id="3885202">...</span><span class="keyword" id="3885205">interface</span><span class="op" id="3885214">{</span><span class="op" id="3885215">}</span><span class="op" id="3885216">)</span>&nbsp;<span class="builtintype" id="3885218">error</span>&nbsp;<span class="op" id="3885224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885227">if</span>&nbsp;<span class="ident" id="3885230">r</span><span class="op" id="3885231">.</span><span class="ident" id="3885232">err</span>&nbsp;<span class="op" id="3885236">!=</span>&nbsp;<span class="ident" id="3885239">nil</span>&nbsp;<span class="op" id="3885243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885247">return</span>&nbsp;<span class="ident" id="3885254">r</span><span class="op" id="3885255">.</span><span class="ident" id="3885256">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3885261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885265">//&nbsp;TODO(bradfitz):&nbsp;for&nbsp;now&nbsp;we&nbsp;need&nbsp;to&nbsp;defensively&nbsp;clone&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885326">//&nbsp;[]byte&nbsp;that&nbsp;the&nbsp;driver&nbsp;returned&nbsp;(not&nbsp;permitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885378">//&nbsp;*RawBytes&nbsp;in&nbsp;Rows.Scan),&nbsp;since&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885434">//&nbsp;the&nbsp;Rows&nbsp;in&nbsp;our&nbsp;defer,&nbsp;when&nbsp;we&nbsp;return&nbsp;from&nbsp;this&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885496">//&nbsp;the&nbsp;contract&nbsp;with&nbsp;the&nbsp;driver.Next(...)&nbsp;interface&nbsp;is&nbsp;that&nbsp;it</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885560">//&nbsp;can&nbsp;return&nbsp;slices&nbsp;into&nbsp;read-only&nbsp;temporary&nbsp;memory&nbsp;that&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885621">//&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;Scan/Close.&nbsp;&nbsp;But&nbsp;the&nbsp;TODO&nbsp;is&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885685">//&nbsp;for&nbsp;a&nbsp;lot&nbsp;of&nbsp;drivers,&nbsp;this&nbsp;copy&nbsp;will&nbsp;be&nbsp;unnecessary.&nbsp;&nbsp;We</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885746">//&nbsp;should&nbsp;provide&nbsp;an&nbsp;optional&nbsp;interface&nbsp;for&nbsp;drivers&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885802">//&nbsp;implement&nbsp;to&nbsp;say,&nbsp;&#34;don&#39;t&nbsp;worry,&nbsp;the&nbsp;[]bytes&nbsp;that&nbsp;I&nbsp;return</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885864">//&nbsp;from&nbsp;Next&nbsp;will&nbsp;not&nbsp;be&nbsp;modified&nbsp;again.&#34;&nbsp;(for&nbsp;instance,&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885925">//&nbsp;they&nbsp;were&nbsp;obtained&nbsp;from&nbsp;the&nbsp;network&nbsp;anyway)&nbsp;But&nbsp;for&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885988">//&nbsp;don&#39;t&nbsp;care.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886004">defer</span>&nbsp;<span class="ident" id="3886010">r</span><span class="op" id="3886011">.</span><span class="ident" id="3886012">rows</span><span class="op" id="3886016">.</span><span class="ident" id="3886017">Close</span><span class="op" id="3886022">(</span><span class="op" id="3886023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886026">for</span>&nbsp;<span class="ident" id="3886030">_</span><span class="op" id="3886031">,</span>&nbsp;<span class="ident" id="3886033">dp</span>&nbsp;<span class="op" id="3886036">:=</span>&nbsp;<span class="keyword" id="3886039">range</span>&nbsp;<span class="ident" id="3886045">dest</span>&nbsp;<span class="op" id="3886050">{</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886054">if</span>&nbsp;<span class="ident" id="3886057">_</span><span class="op" id="3886058">,</span>&nbsp;<span class="ident" id="3886060">ok</span>&nbsp;<span class="op" id="3886063">:=</span>&nbsp;<span class="ident" id="3886066">dp</span><span class="op" id="3886068">.</span><span class="op" id="3886069">(</span><span class="op" id="3886070">*</span><span class="ident" id="3886071">RawBytes</span><span class="op" id="3886079">)</span><span class="op" id="3886080">;</span>&nbsp;<span class="ident" id="3886082">ok</span>&nbsp;<span class="op" id="3886085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886090">return</span>&nbsp;<span class="ident" id="3886097">errors</span><span class="op" id="3886103">.</span><span class="ident" id="3886104">New</span><span class="op" id="3886107">(</span><span class="string" id="3886108">&#34;sql:&nbsp;RawBytes&nbsp;isn&#39;t&nbsp;allowed&nbsp;on&nbsp;Row.Scan&#34;</span><span class="op" id="3886149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3886153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3886156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886160">if</span>&nbsp;<span class="op" id="3886163">!</span><span class="ident" id="3886164">r</span><span class="op" id="3886165">.</span><span class="ident" id="3886166">rows</span><span class="op" id="3886170">.</span><span class="ident" id="3886171">Next</span><span class="op" id="3886175">(</span><span class="op" id="3886176">)</span>&nbsp;<span class="op" id="3886178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886182">if</span>&nbsp;<span class="ident" id="3886185">err</span>&nbsp;<span class="op" id="3886189">:=</span>&nbsp;<span class="ident" id="3886192">r</span><span class="op" id="3886193">.</span><span class="ident" id="3886194">rows</span><span class="op" id="3886198">.</span><span class="ident" id="3886199">Err</span><span class="op" id="3886202">(</span><span class="op" id="3886203">)</span><span class="op" id="3886204">;</span>&nbsp;<span class="ident" id="3886206">err</span>&nbsp;<span class="op" id="3886210">!=</span>&nbsp;<span class="ident" id="3886213">nil</span>&nbsp;<span class="op" id="3886217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886222">return</span>&nbsp;<span class="ident" id="3886229">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3886235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886239">return</span>&nbsp;<span class="ident" id="3886246">ErrNoRows</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3886257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886260">err</span>&nbsp;<span class="op" id="3886264">:=</span>&nbsp;<span class="ident" id="3886267">r</span><span class="op" id="3886268">.</span><span class="ident" id="3886269">rows</span><span class="op" id="3886273">.</span><span class="ident" id="3886274">Scan</span><span class="op" id="3886278">(</span><span class="ident" id="3886279">dest</span><span class="op" id="3886283">...</span><span class="op" id="3886286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886289">if</span>&nbsp;<span class="ident" id="3886292">err</span>&nbsp;<span class="op" id="3886296">!=</span>&nbsp;<span class="ident" id="3886299">nil</span>&nbsp;<span class="op" id="3886303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886307">return</span>&nbsp;<span class="ident" id="3886314">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3886319">}</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886322">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;query&nbsp;can&nbsp;be&nbsp;processed&nbsp;to&nbsp;completion&nbsp;with&nbsp;no&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886393">if</span>&nbsp;<span class="ident" id="3886396">err</span>&nbsp;<span class="op" id="3886400">:=</span>&nbsp;<span class="ident" id="3886403">r</span><span class="op" id="3886404">.</span><span class="ident" id="3886405">rows</span><span class="op" id="3886409">.</span><span class="ident" id="3886410">Close</span><span class="op" id="3886415">(</span><span class="op" id="3886416">)</span><span class="op" id="3886417">;</span>&nbsp;<span class="ident" id="3886419">err</span>&nbsp;<span class="op" id="3886423">!=</span>&nbsp;<span class="ident" id="3886426">nil</span>&nbsp;<span class="op" id="3886430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886434">return</span>&nbsp;<span class="ident" id="3886441">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3886446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886450">return</span>&nbsp;<span class="ident" id="3886457">nil</span><br>
<span class="lineno"></span><span class="op" id="3886461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3886464">//&nbsp;A&nbsp;Result&nbsp;summarizes&nbsp;an&nbsp;executed&nbsp;SQL&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="3886512">type</span>&nbsp;<span class="ident" id="3886517">Result</span>&nbsp;<span class="keyword" id="3886524">interface</span>&nbsp;<span class="op" id="3886534">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886537">//&nbsp;LastInsertId&nbsp;returns&nbsp;the&nbsp;integer&nbsp;generated&nbsp;by&nbsp;the&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886600">//&nbsp;in&nbsp;response&nbsp;to&nbsp;a&nbsp;command.&nbsp;Typically&nbsp;this&nbsp;will&nbsp;be&nbsp;from&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886661">//&nbsp;&#34;auto&nbsp;increment&#34;&nbsp;column&nbsp;when&nbsp;inserting&nbsp;a&nbsp;new&nbsp;row.&nbsp;Not&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886723">//&nbsp;databases&nbsp;support&nbsp;this&nbsp;feature,&nbsp;and&nbsp;the&nbsp;syntax&nbsp;of&nbsp;such</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886782">//&nbsp;statements&nbsp;varies.</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886805">LastInsertId</span><span class="op" id="3886817">(</span><span class="op" id="3886818">)</span>&nbsp;<span class="op" id="3886820">(</span><span class="ident" id="3886821">int64</span><span class="op" id="3886826">,</span>&nbsp;<span class="builtintype" id="3886828">error</span><span class="op" id="3886833">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886837">//&nbsp;RowsAffected&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;rows&nbsp;affected&nbsp;by&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886896">//&nbsp;update,&nbsp;insert,&nbsp;or&nbsp;delete.&nbsp;Not&nbsp;every&nbsp;database&nbsp;or&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886958">//&nbsp;driver&nbsp;may&nbsp;support&nbsp;this.</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886987">RowsAffected</span><span class="op" id="3886999">(</span><span class="op" id="3887000">)</span>&nbsp;<span class="op" id="3887002">(</span><span class="ident" id="3887003">int64</span><span class="op" id="3887008">,</span>&nbsp;<span class="builtintype" id="3887010">error</span><span class="op" id="3887015">)</span><br>
<span class="lineno"></span><span class="op" id="3887017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3887020">type</span>&nbsp;<span class="ident" id="3887025">driverResult</span>&nbsp;<span class="keyword" id="3887038">struct</span>&nbsp;<span class="op" id="3887045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887048">sync</span><span class="op" id="3887052">.</span><span class="ident" id="3887053">Locker</span>&nbsp;<span class="comment" id="3887060">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887080">resi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887092">driver</span><span class="op" id="3887098">.</span><span class="ident" id="3887099">Result</span><br>
<span class="lineno"></span><span class="op" id="3887106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3887109">func</span>&nbsp;<span class="op" id="3887114">(</span><span class="ident" id="3887115">dr</span>&nbsp;<span class="ident" id="3887118">driverResult</span><span class="op" id="3887130">)</span>&nbsp;<span class="ident" id="3887132">LastInsertId</span><span class="op" id="3887144">(</span><span class="op" id="3887145">)</span>&nbsp;<span class="op" id="3887147">(</span><span class="ident" id="3887148">int64</span><span class="op" id="3887153">,</span>&nbsp;<span class="builtintype" id="3887155">error</span><span class="op" id="3887160">)</span>&nbsp;<span class="op" id="3887162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887165">dr</span><span class="op" id="3887167">.</span><span class="ident" id="3887168">Lock</span><span class="op" id="3887172">(</span><span class="op" id="3887173">)</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887176">defer</span>&nbsp;<span class="ident" id="3887182">dr</span><span class="op" id="3887184">.</span><span class="ident" id="3887185">Unlock</span><span class="op" id="3887191">(</span><span class="op" id="3887192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887195">return</span>&nbsp;<span class="ident" id="3887202">dr</span><span class="op" id="3887204">.</span><span class="ident" id="3887205">resi</span><span class="op" id="3887209">.</span><span class="ident" id="3887210">LastInsertId</span><span class="op" id="3887222">(</span><span class="op" id="3887223">)</span><br>
<span class="lineno"></span><span class="op" id="3887225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3887228">func</span>&nbsp;<span class="op" id="3887233">(</span><span class="ident" id="3887234">dr</span>&nbsp;<span class="ident" id="3887237">driverResult</span><span class="op" id="3887249">)</span>&nbsp;<span class="ident" id="3887251">RowsAffected</span><span class="op" id="3887263">(</span><span class="op" id="3887264">)</span>&nbsp;<span class="op" id="3887266">(</span><span class="ident" id="3887267">int64</span><span class="op" id="3887272">,</span>&nbsp;<span class="builtintype" id="3887274">error</span><span class="op" id="3887279">)</span>&nbsp;<span class="op" id="3887281">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887284">dr</span><span class="op" id="3887286">.</span><span class="ident" id="3887287">Lock</span><span class="op" id="3887291">(</span><span class="op" id="3887292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887295">defer</span>&nbsp;<span class="ident" id="3887301">dr</span><span class="op" id="3887303">.</span><span class="ident" id="3887304">Unlock</span><span class="op" id="3887310">(</span><span class="op" id="3887311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887314">return</span>&nbsp;<span class="ident" id="3887321">dr</span><span class="op" id="3887323">.</span><span class="ident" id="3887324">resi</span><span class="op" id="3887328">.</span><span class="ident" id="3887329">RowsAffected</span><span class="op" id="3887341">(</span><span class="op" id="3887342">)</span><br>
<span class="lineno"></span><span class="op" id="3887344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span><span class="keyword" id="3887347">func</span>&nbsp;<span class="ident" id="3887352">stack</span><span class="op" id="3887357">(</span><span class="op" id="3887358">)</span>&nbsp;<span class="builtintype" id="3887360">string</span>&nbsp;<span class="op" id="3887367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887370">var</span>&nbsp;<span class="ident" id="3887374">buf</span>&nbsp;<span class="op" id="3887378">[</span><span class="num" id="3887379">2</span>&nbsp;<span class="op" id="3887381">&lt;&lt;</span>&nbsp;<span class="num" id="3887384">10</span><span class="op" id="3887386">]</span><span class="builtintype" id="3887387">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887393">return</span>&nbsp;<span class="builtintype" id="3887400">string</span><span class="op" id="3887406">(</span><span class="ident" id="3887407">buf</span><span class="op" id="3887410">[</span><span class="op" id="3887411">:</span><span class="ident" id="3887412">runtime</span><span class="op" id="3887419">.</span><span class="ident" id="3887420">Stack</span><span class="op" id="3887425">(</span><span class="ident" id="3887426">buf</span><span class="op" id="3887429">[</span><span class="op" id="3887430">:</span><span class="op" id="3887431">]</span><span class="op" id="3887432">,</span>&nbsp;<span class="builtintype" id="3887434">false</span><span class="op" id="3887439">)</span><span class="op" id="3887440">]</span><span class="op" id="3887441">)</span><br>
<span class="lineno"></span><span class="op" id="3887443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1765</span><span class="comment" id="3887446">//&nbsp;withLock&nbsp;runs&nbsp;while&nbsp;holding&nbsp;lk.</span><br>
<span class="lineno"></span><span class="keyword" id="3887481">func</span>&nbsp;<span class="ident" id="3887486">withLock</span><span class="op" id="3887494">(</span><span class="ident" id="3887495">lk</span>&nbsp;<span class="ident" id="3887498">sync</span><span class="op" id="3887502">.</span><span class="ident" id="3887503">Locker</span><span class="op" id="3887509">,</span>&nbsp;<span class="ident" id="3887511">fn</span>&nbsp;<span class="keyword" id="3887514">func</span><span class="op" id="3887518">(</span><span class="op" id="3887519">)</span><span class="op" id="3887520">)</span>&nbsp;<span class="op" id="3887522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887525">lk</span><span class="op" id="3887527">.</span><span class="ident" id="3887528">Lock</span><span class="op" id="3887532">(</span><span class="op" id="3887533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887536">fn</span><span class="op" id="3887538">(</span><span class="op" id="3887539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887542">lk</span><span class="op" id="3887544">.</span><span class="ident" id="3887545">Unlock</span><span class="op" id="3887551">(</span><span class="op" id="3887552">)</span><br>
<span class="lineno">1770</span><span class="op" id="3887554">}</span>
</div>
</body>
</html>
