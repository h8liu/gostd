<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rand</h2>
<ul>
<li><a href="/gostd/crypto/rand/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand.go.html">rand.go</a></li>
<li><a href="/gostd/crypto/rand/rand_linux.go.html" class="current">rand_linux.go</a></li>
<li><a href="/gostd/crypto/rand/rand_test.go.html">rand_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand_unix.go.html">rand_unix.go</a></li>
<li><a href="/gostd/crypto/rand/util.go.html">util.go</a></li>
<li><a href="/gostd/crypto/rand/util_test.go.html">util_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3526879">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3526935">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3526989">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3527040">package</span>&nbsp;<span class="ident" id="3527048">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3527054">import</span>&nbsp;<span class="op" id="3527061">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3527064">&#34;internal/syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3527084">&#34;sync&#34;</span><br>
<span class="lineno">10</span><span class="op" id="3527091">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3527094">func</span>&nbsp;<span class="ident" id="3527099">init</span><span class="op" id="3527103">(</span><span class="op" id="3527104">)</span>&nbsp;<span class="op" id="3527106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527109">altGetRandom</span>&nbsp;<span class="op" id="3527122">=</span>&nbsp;<span class="ident" id="3527124">getRandomLinux</span><br>
<span class="lineno"></span><span class="op" id="3527139">}</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3527142">var</span>&nbsp;<span class="op" id="3527146">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527149">once</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527160">sync</span><span class="op" id="3527164">.</span><span class="ident" id="3527165">Once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527171">useSyscall</span>&nbsp;<span class="builtintype" id="3527182">bool</span><br>
<span class="lineno"></span><span class="op" id="3527187">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3527190">func</span>&nbsp;<span class="ident" id="3527195">pickStrategy</span><span class="op" id="3527207">(</span><span class="op" id="3527208">)</span>&nbsp;<span class="op" id="3527210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3527213">//&nbsp;Test&nbsp;whether&nbsp;we&nbsp;should&nbsp;use&nbsp;the&nbsp;system&nbsp;call&nbsp;or&nbsp;/dev/urandom.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3527277">//&nbsp;We&#39;ll&nbsp;fall&nbsp;back&nbsp;to&nbsp;urandom&nbsp;if:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3527312">//&nbsp;-&nbsp;the&nbsp;kernel&nbsp;is&nbsp;too&nbsp;old&nbsp;(before&nbsp;3.17)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3527354">//&nbsp;-&nbsp;the&nbsp;machine&nbsp;has&nbsp;no&nbsp;entropy&nbsp;available&nbsp;(early&nbsp;boot&nbsp;+&nbsp;no&nbsp;hardware</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3527423">//&nbsp;&nbsp;&nbsp;entropy&nbsp;source?)&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;avoid&nbsp;blocking&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3527483">var</span>&nbsp;<span class="ident" id="3527487">buf</span>&nbsp;<span class="op" id="3527491">[</span><span class="num" id="3527492">1</span><span class="op" id="3527493">]</span><span class="builtintype" id="3527494">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527500">n</span><span class="op" id="3527501">,</span>&nbsp;<span class="ident" id="3527503">err</span>&nbsp;<span class="op" id="3527507">:=</span>&nbsp;<span class="ident" id="3527510">syscall</span><span class="op" id="3527517">.</span><span class="ident" id="3527518">GetRandom</span><span class="op" id="3527527">(</span><span class="ident" id="3527528">buf</span><span class="op" id="3527531">[</span><span class="op" id="3527532">:</span><span class="op" id="3527533">]</span><span class="op" id="3527534">,</span>&nbsp;<span class="ident" id="3527536">syscall</span><span class="op" id="3527543">.</span><span class="ident" id="3527544">GRND_NONBLOCK</span><span class="op" id="3527557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527560">useSyscall</span>&nbsp;<span class="op" id="3527571">=</span>&nbsp;<span class="ident" id="3527573">n</span>&nbsp;<span class="op" id="3527575">==</span>&nbsp;<span class="num" id="3527578">1</span>&nbsp;<span class="op" id="3527580">&amp;&amp;</span>&nbsp;<span class="ident" id="3527583">err</span>&nbsp;<span class="op" id="3527587">==</span>&nbsp;<span class="builtintype" id="3527590">nil</span><br>
<span class="lineno">30</span><span class="op" id="3527594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3527597">func</span>&nbsp;<span class="ident" id="3527602">getRandomLinux</span><span class="op" id="3527616">(</span><span class="ident" id="3527617">p</span>&nbsp;<span class="op" id="3527619">[</span><span class="op" id="3527620">]</span><span class="builtintype" id="3527621">byte</span><span class="op" id="3527625">)</span>&nbsp;<span class="op" id="3527627">(</span><span class="ident" id="3527628">ok</span>&nbsp;<span class="builtintype" id="3527631">bool</span><span class="op" id="3527635">)</span>&nbsp;<span class="op" id="3527637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527640">once</span><span class="op" id="3527644">.</span><span class="ident" id="3527645">Do</span><span class="op" id="3527647">(</span><span class="ident" id="3527648">pickStrategy</span><span class="op" id="3527660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3527663">if</span>&nbsp;<span class="op" id="3527666">!</span><span class="ident" id="3527667">useSyscall</span>&nbsp;<span class="op" id="3527678">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3527682">return</span>&nbsp;<span class="builtintype" id="3527689">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3527696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527699">n</span><span class="op" id="3527700">,</span>&nbsp;<span class="ident" id="3527702">err</span>&nbsp;<span class="op" id="3527706">:=</span>&nbsp;<span class="ident" id="3527709">syscall</span><span class="op" id="3527716">.</span><span class="ident" id="3527717">GetRandom</span><span class="op" id="3527726">(</span><span class="ident" id="3527727">p</span><span class="op" id="3527728">,</span>&nbsp;<span class="num" id="3527730">0</span><span class="op" id="3527731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3527734">return</span>&nbsp;<span class="ident" id="3527741">n</span>&nbsp;<span class="op" id="3527743">==</span>&nbsp;<span class="builtinfunc" id="3527746">len</span><span class="op" id="3527749">(</span><span class="ident" id="3527750">p</span><span class="op" id="3527751">)</span>&nbsp;<span class="op" id="3527753">&amp;&amp;</span>&nbsp;<span class="ident" id="3527756">err</span>&nbsp;<span class="op" id="3527760">==</span>&nbsp;<span class="builtintype" id="3527763">nil</span><br>
<span class="lineno"></span><span class="op" id="3527767">}</span>
</div>
</body>
</html>
