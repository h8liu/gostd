<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5068796">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5068851">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5068905">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5068956">//go:generate&nbsp;go&nbsp;run&nbsp;encgen.go&nbsp;-output&nbsp;enc_helpers.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5069011">package</span>&nbsp;<span class="ident" id="5069019">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5069024">import</span>&nbsp;<span class="op" id="5069031">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5069034">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5069046">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5069054">&#34;reflect&#34;</span><br>
<span class="lineno"></span><span class="op" id="5069064">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5069067">const</span>&nbsp;<span class="ident" id="5069073">uint64Size</span>&nbsp;<span class="op" id="5069084">=</span>&nbsp;<span class="num" id="5069086">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5069089">type</span>&nbsp;<span class="ident" id="5069094">encHelper</span>&nbsp;<span class="keyword" id="5069104">func</span><span class="op" id="5069108">(</span><span class="ident" id="5069109">state</span>&nbsp;<span class="op" id="5069115">*</span><span class="ident" id="5069116">encoderState</span><span class="op" id="5069128">,</span>&nbsp;<span class="ident" id="5069130">v</span>&nbsp;<span class="ident" id="5069132">reflect</span><span class="op" id="5069139">.</span><span class="ident" id="5069140">Value</span><span class="op" id="5069145">)</span>&nbsp;<span class="builtintype" id="5069147">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5069153">//&nbsp;encoderState&nbsp;is&nbsp;the&nbsp;global&nbsp;execution&nbsp;state&nbsp;of&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno">20</span><span class="comment" id="5069230">//&nbsp;Field&nbsp;numbers&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;and&nbsp;always&nbsp;increase.&nbsp;The&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="5069296">//&nbsp;number&nbsp;is&nbsp;initialized&nbsp;to&nbsp;-1&nbsp;so&nbsp;0&nbsp;comes&nbsp;out&nbsp;as&nbsp;delta(1).&nbsp;A&nbsp;delta&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5069366">//&nbsp;0&nbsp;terminates&nbsp;the&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="5069397">type</span>&nbsp;<span class="ident" id="5069402">encoderState</span>&nbsp;<span class="keyword" id="5069415">struct</span>&nbsp;<span class="op" id="5069422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069425">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5069434">*</span><span class="ident" id="5069435">Encoder</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069444">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5069453">*</span><span class="ident" id="5069454">encBuffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069465">sendZero</span>&nbsp;<span class="builtintype" id="5069474">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5069495">//&nbsp;encoding&nbsp;an&nbsp;array&nbsp;element&nbsp;or&nbsp;map&nbsp;key/value&nbsp;pair;&nbsp;send&nbsp;zero&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069565">fieldnum</span>&nbsp;<span class="builtintype" id="5069574">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5069595">//&nbsp;the&nbsp;last&nbsp;field&nbsp;number&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069630">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5069639">[</span><span class="num" id="5069640">1</span>&nbsp;<span class="op" id="5069642">+</span>&nbsp;<span class="ident" id="5069644">uint64Size</span><span class="op" id="5069654">]</span><span class="builtintype" id="5069655">byte</span>&nbsp;<span class="comment" id="5069660">//&nbsp;buffer&nbsp;used&nbsp;by&nbsp;the&nbsp;encoder;&nbsp;here&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069718">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5069727">*</span><span class="ident" id="5069728">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5069748">//&nbsp;for&nbsp;free&nbsp;list</span><br>
<span class="lineno">30</span><span class="op" id="5069765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5069768">//&nbsp;encBuffer&nbsp;is&nbsp;an&nbsp;extremely&nbsp;simple,&nbsp;fast&nbsp;implementation&nbsp;of&nbsp;a&nbsp;write-only&nbsp;byte&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="5069854">//&nbsp;It&nbsp;never&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;but&nbsp;Write&nbsp;returns&nbsp;an&nbsp;error&nbsp;value&nbsp;so&nbsp;it&nbsp;matches&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5069949">type</span>&nbsp;<span class="ident" id="5069954">encBuffer</span>&nbsp;<span class="keyword" id="5069964">struct</span>&nbsp;<span class="op" id="5069971">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069974">data</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5069982">[</span><span class="op" id="5069983">]</span><span class="builtintype" id="5069984">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069990">scratch</span>&nbsp;<span class="op" id="5069998">[</span><span class="num" id="5069999">64</span><span class="op" id="5070001">]</span><span class="builtintype" id="5070002">byte</span><br>
<span class="lineno"></span><span class="op" id="5070007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5070010">func</span>&nbsp;<span class="op" id="5070015">(</span><span class="ident" id="5070016">e</span>&nbsp;<span class="op" id="5070018">*</span><span class="ident" id="5070019">encBuffer</span><span class="op" id="5070028">)</span>&nbsp;<span class="ident" id="5070030">WriteByte</span><span class="op" id="5070039">(</span><span class="ident" id="5070040">c</span>&nbsp;<span class="builtintype" id="5070042">byte</span><span class="op" id="5070046">)</span>&nbsp;<span class="op" id="5070048">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070051">e</span><span class="op" id="5070052">.</span><span class="ident" id="5070053">data</span>&nbsp;<span class="op" id="5070058">=</span>&nbsp;<span class="builtinfunc" id="5070060">append</span><span class="op" id="5070066">(</span><span class="ident" id="5070067">e</span><span class="op" id="5070068">.</span><span class="ident" id="5070069">data</span><span class="op" id="5070073">,</span>&nbsp;<span class="ident" id="5070075">c</span><span class="op" id="5070076">)</span><br>
<span class="lineno"></span><span class="op" id="5070078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5070081">func</span>&nbsp;<span class="op" id="5070086">(</span><span class="ident" id="5070087">e</span>&nbsp;<span class="op" id="5070089">*</span><span class="ident" id="5070090">encBuffer</span><span class="op" id="5070099">)</span>&nbsp;<span class="ident" id="5070101">Write</span><span class="op" id="5070106">(</span><span class="ident" id="5070107">p</span>&nbsp;<span class="op" id="5070109">[</span><span class="op" id="5070110">]</span><span class="builtintype" id="5070111">byte</span><span class="op" id="5070115">)</span>&nbsp;<span class="op" id="5070117">(</span><span class="builtintype" id="5070118">int</span><span class="op" id="5070121">,</span>&nbsp;<span class="builtintype" id="5070123">error</span><span class="op" id="5070128">)</span>&nbsp;<span class="op" id="5070130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070133">e</span><span class="op" id="5070134">.</span><span class="ident" id="5070135">data</span>&nbsp;<span class="op" id="5070140">=</span>&nbsp;<span class="builtinfunc" id="5070142">append</span><span class="op" id="5070148">(</span><span class="ident" id="5070149">e</span><span class="op" id="5070150">.</span><span class="ident" id="5070151">data</span><span class="op" id="5070155">,</span>&nbsp;<span class="ident" id="5070157">p</span><span class="op" id="5070158">...</span><span class="op" id="5070161">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070164">return</span>&nbsp;<span class="builtinfunc" id="5070171">len</span><span class="op" id="5070174">(</span><span class="ident" id="5070175">p</span><span class="op" id="5070176">)</span><span class="op" id="5070177">,</span>&nbsp;<span class="ident" id="5070179">nil</span><br>
<span class="lineno"></span><span class="op" id="5070183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5070186">func</span>&nbsp;<span class="op" id="5070191">(</span><span class="ident" id="5070192">e</span>&nbsp;<span class="op" id="5070194">*</span><span class="ident" id="5070195">encBuffer</span><span class="op" id="5070204">)</span>&nbsp;<span class="ident" id="5070206">WriteString</span><span class="op" id="5070217">(</span><span class="ident" id="5070218">s</span>&nbsp;<span class="builtintype" id="5070220">string</span><span class="op" id="5070226">)</span>&nbsp;<span class="op" id="5070228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070231">e</span><span class="op" id="5070232">.</span><span class="ident" id="5070233">data</span>&nbsp;<span class="op" id="5070238">=</span>&nbsp;<span class="builtinfunc" id="5070240">append</span><span class="op" id="5070246">(</span><span class="ident" id="5070247">e</span><span class="op" id="5070248">.</span><span class="ident" id="5070249">data</span><span class="op" id="5070253">,</span>&nbsp;<span class="ident" id="5070255">s</span><span class="op" id="5070256">...</span><span class="op" id="5070259">)</span><br>
<span class="lineno">50</span><span class="op" id="5070261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5070264">func</span>&nbsp;<span class="op" id="5070269">(</span><span class="ident" id="5070270">e</span>&nbsp;<span class="op" id="5070272">*</span><span class="ident" id="5070273">encBuffer</span><span class="op" id="5070282">)</span>&nbsp;<span class="ident" id="5070284">Len</span><span class="op" id="5070287">(</span><span class="op" id="5070288">)</span>&nbsp;<span class="builtintype" id="5070290">int</span>&nbsp;<span class="op" id="5070294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070297">return</span>&nbsp;<span class="builtinfunc" id="5070304">len</span><span class="op" id="5070307">(</span><span class="ident" id="5070308">e</span><span class="op" id="5070309">.</span><span class="ident" id="5070310">data</span><span class="op" id="5070314">)</span><br>
<span class="lineno"></span><span class="op" id="5070316">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="5070319">func</span>&nbsp;<span class="op" id="5070324">(</span><span class="ident" id="5070325">e</span>&nbsp;<span class="op" id="5070327">*</span><span class="ident" id="5070328">encBuffer</span><span class="op" id="5070337">)</span>&nbsp;<span class="ident" id="5070339">Bytes</span><span class="op" id="5070344">(</span><span class="op" id="5070345">)</span>&nbsp;<span class="op" id="5070347">[</span><span class="op" id="5070348">]</span><span class="builtintype" id="5070349">byte</span>&nbsp;<span class="op" id="5070354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070357">return</span>&nbsp;<span class="ident" id="5070364">e</span><span class="op" id="5070365">.</span><span class="ident" id="5070366">data</span><br>
<span class="lineno"></span><span class="op" id="5070371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5070374">func</span>&nbsp;<span class="op" id="5070379">(</span><span class="ident" id="5070380">e</span>&nbsp;<span class="op" id="5070382">*</span><span class="ident" id="5070383">encBuffer</span><span class="op" id="5070392">)</span>&nbsp;<span class="ident" id="5070394">Reset</span><span class="op" id="5070399">(</span><span class="op" id="5070400">)</span>&nbsp;<span class="op" id="5070402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070405">e</span><span class="op" id="5070406">.</span><span class="ident" id="5070407">data</span>&nbsp;<span class="op" id="5070412">=</span>&nbsp;<span class="ident" id="5070414">e</span><span class="op" id="5070415">.</span><span class="ident" id="5070416">data</span><span class="op" id="5070420">[</span><span class="num" id="5070421">0</span><span class="op" id="5070422">:</span><span class="num" id="5070423">0</span><span class="op" id="5070424">]</span><br>
<span class="lineno"></span><span class="op" id="5070426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5070429">func</span>&nbsp;<span class="op" id="5070434">(</span><span class="ident" id="5070435">enc</span>&nbsp;<span class="op" id="5070439">*</span><span class="ident" id="5070440">Encoder</span><span class="op" id="5070447">)</span>&nbsp;<span class="ident" id="5070449">newEncoderState</span><span class="op" id="5070464">(</span><span class="ident" id="5070465">b</span>&nbsp;<span class="op" id="5070467">*</span><span class="ident" id="5070468">encBuffer</span><span class="op" id="5070477">)</span>&nbsp;<span class="op" id="5070479">*</span><span class="ident" id="5070480">encoderState</span>&nbsp;<span class="op" id="5070493">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070496">e</span>&nbsp;<span class="op" id="5070498">:=</span>&nbsp;<span class="ident" id="5070501">enc</span><span class="op" id="5070504">.</span><span class="ident" id="5070505">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070515">if</span>&nbsp;<span class="ident" id="5070518">e</span>&nbsp;<span class="op" id="5070520">==</span>&nbsp;<span class="ident" id="5070523">nil</span>&nbsp;<span class="op" id="5070527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070531">e</span>&nbsp;<span class="op" id="5070533">=</span>&nbsp;<span class="builtinfunc" id="5070535">new</span><span class="op" id="5070538">(</span><span class="ident" id="5070539">encoderState</span><span class="op" id="5070551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070555">e</span><span class="op" id="5070556">.</span><span class="ident" id="5070557">enc</span>&nbsp;<span class="op" id="5070561">=</span>&nbsp;<span class="ident" id="5070563">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070568">}</span>&nbsp;<span class="keyword" id="5070570">else</span>&nbsp;<span class="op" id="5070575">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070579">enc</span><span class="op" id="5070582">.</span><span class="ident" id="5070583">freeList</span>&nbsp;<span class="op" id="5070592">=</span>&nbsp;<span class="ident" id="5070594">e</span><span class="op" id="5070595">.</span><span class="ident" id="5070596">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070605">e</span><span class="op" id="5070606">.</span><span class="ident" id="5070607">sendZero</span>&nbsp;<span class="op" id="5070616">=</span>&nbsp;<span class="builtintype" id="5070618">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070625">e</span><span class="op" id="5070626">.</span><span class="ident" id="5070627">fieldnum</span>&nbsp;<span class="op" id="5070636">=</span>&nbsp;<span class="num" id="5070638">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070641">e</span><span class="op" id="5070642">.</span><span class="ident" id="5070643">b</span>&nbsp;<span class="op" id="5070645">=</span>&nbsp;<span class="ident" id="5070647">b</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070650">if</span>&nbsp;<span class="builtinfunc" id="5070653">len</span><span class="op" id="5070656">(</span><span class="ident" id="5070657">b</span><span class="op" id="5070658">.</span><span class="ident" id="5070659">data</span><span class="op" id="5070663">)</span>&nbsp;<span class="op" id="5070665">==</span>&nbsp;<span class="num" id="5070668">0</span>&nbsp;<span class="op" id="5070670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070674">b</span><span class="op" id="5070675">.</span><span class="ident" id="5070676">data</span>&nbsp;<span class="op" id="5070681">=</span>&nbsp;<span class="ident" id="5070683">b</span><span class="op" id="5070684">.</span><span class="ident" id="5070685">scratch</span><span class="op" id="5070692">[</span><span class="num" id="5070693">0</span><span class="op" id="5070694">:</span><span class="num" id="5070695">0</span><span class="op" id="5070696">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070702">return</span>&nbsp;<span class="ident" id="5070709">e</span><br>
<span class="lineno"></span><span class="op" id="5070711">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="5070714">func</span>&nbsp;<span class="op" id="5070719">(</span><span class="ident" id="5070720">enc</span>&nbsp;<span class="op" id="5070724">*</span><span class="ident" id="5070725">Encoder</span><span class="op" id="5070732">)</span>&nbsp;<span class="ident" id="5070734">freeEncoderState</span><span class="op" id="5070750">(</span><span class="ident" id="5070751">e</span>&nbsp;<span class="op" id="5070753">*</span><span class="ident" id="5070754">encoderState</span><span class="op" id="5070766">)</span>&nbsp;<span class="op" id="5070768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070771">e</span><span class="op" id="5070772">.</span><span class="ident" id="5070773">next</span>&nbsp;<span class="op" id="5070778">=</span>&nbsp;<span class="ident" id="5070780">enc</span><span class="op" id="5070783">.</span><span class="ident" id="5070784">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070794">enc</span><span class="op" id="5070797">.</span><span class="ident" id="5070798">freeList</span>&nbsp;<span class="op" id="5070807">=</span>&nbsp;<span class="ident" id="5070809">e</span><br>
<span class="lineno"></span><span class="op" id="5070811">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="5070814">//&nbsp;Unsigned&nbsp;integers&nbsp;have&nbsp;a&nbsp;two-state&nbsp;encoding.&nbsp;&nbsp;If&nbsp;the&nbsp;number&nbsp;is&nbsp;less</span><br>
<span class="lineno"></span><span class="comment" id="5070885">//&nbsp;than&nbsp;128&nbsp;(0&nbsp;through&nbsp;0x7F),&nbsp;its&nbsp;value&nbsp;is&nbsp;written&nbsp;directly.</span><br>
<span class="lineno"></span><span class="comment" id="5070946">//&nbsp;Otherwise&nbsp;the&nbsp;value&nbsp;is&nbsp;written&nbsp;in&nbsp;big-endian&nbsp;byte&nbsp;order&nbsp;preceded</span><br>
<span class="lineno"></span><span class="comment" id="5071014">//&nbsp;by&nbsp;the&nbsp;byte&nbsp;length,&nbsp;negated.</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="5071047">//&nbsp;encodeUint&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;to&nbsp;state.b.</span><br>
<span class="lineno"></span><span class="keyword" id="5071108">func</span>&nbsp;<span class="op" id="5071113">(</span><span class="ident" id="5071114">state</span>&nbsp;<span class="op" id="5071120">*</span><span class="ident" id="5071121">encoderState</span><span class="op" id="5071133">)</span>&nbsp;<span class="ident" id="5071135">encodeUint</span><span class="op" id="5071145">(</span><span class="ident" id="5071146">x</span>&nbsp;<span class="ident" id="5071148">uint64</span><span class="op" id="5071154">)</span>&nbsp;<span class="op" id="5071156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071159">if</span>&nbsp;<span class="ident" id="5071162">x</span>&nbsp;<span class="op" id="5071164">&lt;=</span>&nbsp;<span class="num" id="5071167">0x7F</span>&nbsp;<span class="op" id="5071172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071176">state</span><span class="op" id="5071181">.</span><span class="ident" id="5071182">b</span><span class="op" id="5071183">.</span><span class="ident" id="5071184">WriteByte</span><span class="op" id="5071193">(</span><span class="builtintype" id="5071194">uint8</span><span class="op" id="5071199">(</span><span class="ident" id="5071200">x</span><span class="op" id="5071201">)</span><span class="op" id="5071202">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071206">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071217">i</span>&nbsp;<span class="op" id="5071219">:=</span>&nbsp;<span class="ident" id="5071222">uint64Size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071234">for</span>&nbsp;<span class="ident" id="5071238">x</span>&nbsp;<span class="op" id="5071240">&gt;</span>&nbsp;<span class="num" id="5071242">0</span>&nbsp;<span class="op" id="5071244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071248">state</span><span class="op" id="5071253">.</span><span class="ident" id="5071254">buf</span><span class="op" id="5071257">[</span><span class="ident" id="5071258">i</span><span class="op" id="5071259">]</span>&nbsp;<span class="op" id="5071261">=</span>&nbsp;<span class="builtintype" id="5071263">uint8</span><span class="op" id="5071268">(</span><span class="ident" id="5071269">x</span><span class="op" id="5071270">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071274">x</span>&nbsp;<span class="op" id="5071276">&gt;&gt;=</span>&nbsp;<span class="num" id="5071280">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071284">i</span><span class="op" id="5071285">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071292">state</span><span class="op" id="5071297">.</span><span class="ident" id="5071298">buf</span><span class="op" id="5071301">[</span><span class="ident" id="5071302">i</span><span class="op" id="5071303">]</span>&nbsp;<span class="op" id="5071305">=</span>&nbsp;<span class="builtintype" id="5071307">uint8</span><span class="op" id="5071312">(</span><span class="ident" id="5071313">i</span>&nbsp;<span class="op" id="5071315">-</span>&nbsp;<span class="ident" id="5071317">uint64Size</span><span class="op" id="5071327">)</span>&nbsp;<span class="comment" id="5071329">//&nbsp;=&nbsp;loop&nbsp;count,&nbsp;negated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071355">state</span><span class="op" id="5071360">.</span><span class="ident" id="5071361">b</span><span class="op" id="5071362">.</span><span class="ident" id="5071363">Write</span><span class="op" id="5071368">(</span><span class="ident" id="5071369">state</span><span class="op" id="5071374">.</span><span class="ident" id="5071375">buf</span><span class="op" id="5071378">[</span><span class="ident" id="5071379">i</span>&nbsp;<span class="op" id="5071381">:</span>&nbsp;<span class="ident" id="5071383">uint64Size</span><span class="op" id="5071393">+</span><span class="num" id="5071394">1</span><span class="op" id="5071395">]</span><span class="op" id="5071396">)</span><br>
<span class="lineno">105</span><span class="op" id="5071398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5071401">//&nbsp;encodeInt&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;to&nbsp;state.w.</span><br>
<span class="lineno"></span><span class="comment" id="5071459">//&nbsp;The&nbsp;low&nbsp;bit&nbsp;of&nbsp;the&nbsp;encoding&nbsp;says&nbsp;whether&nbsp;to&nbsp;bit&nbsp;complement&nbsp;the&nbsp;(other&nbsp;bits&nbsp;of&nbsp;the)</span><br>
<span class="lineno"></span><span class="comment" id="5071545">//&nbsp;uint&nbsp;to&nbsp;recover&nbsp;the&nbsp;int.</span><br>
<span class="lineno">110</span><span class="keyword" id="5071573">func</span>&nbsp;<span class="op" id="5071578">(</span><span class="ident" id="5071579">state</span>&nbsp;<span class="op" id="5071585">*</span><span class="ident" id="5071586">encoderState</span><span class="op" id="5071598">)</span>&nbsp;<span class="ident" id="5071600">encodeInt</span><span class="op" id="5071609">(</span><span class="ident" id="5071610">i</span>&nbsp;<span class="ident" id="5071612">int64</span><span class="op" id="5071617">)</span>&nbsp;<span class="op" id="5071619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071622">var</span>&nbsp;<span class="ident" id="5071626">x</span>&nbsp;<span class="ident" id="5071628">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071636">if</span>&nbsp;<span class="ident" id="5071639">i</span>&nbsp;<span class="op" id="5071641">&lt;</span>&nbsp;<span class="num" id="5071643">0</span>&nbsp;<span class="op" id="5071645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071649">x</span>&nbsp;<span class="op" id="5071651">=</span>&nbsp;<span class="ident" id="5071653">uint64</span><span class="op" id="5071659">(</span><span class="op" id="5071660">^</span><span class="ident" id="5071661">i</span><span class="op" id="5071662">&lt;&lt;</span><span class="num" id="5071664">1</span><span class="op" id="5071665">)</span>&nbsp;<span class="op" id="5071667">|</span>&nbsp;<span class="num" id="5071669">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071672">}</span>&nbsp;<span class="keyword" id="5071674">else</span>&nbsp;<span class="op" id="5071679">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071683">x</span>&nbsp;<span class="op" id="5071685">=</span>&nbsp;<span class="ident" id="5071687">uint64</span><span class="op" id="5071693">(</span><span class="ident" id="5071694">i</span>&nbsp;<span class="op" id="5071696">&lt;&lt;</span>&nbsp;<span class="num" id="5071699">1</span><span class="op" id="5071700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071706">state</span><span class="op" id="5071711">.</span><span class="ident" id="5071712">encodeUint</span><span class="op" id="5071722">(</span><span class="ident" id="5071723">uint64</span><span class="op" id="5071729">(</span><span class="ident" id="5071730">x</span><span class="op" id="5071731">)</span><span class="op" id="5071732">)</span><br>
<span class="lineno"></span><span class="op" id="5071734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="5071737">//&nbsp;encOp&nbsp;is&nbsp;the&nbsp;signature&nbsp;of&nbsp;an&nbsp;encoding&nbsp;operator&nbsp;for&nbsp;a&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5071805">type</span>&nbsp;<span class="ident" id="5071810">encOp</span>&nbsp;<span class="keyword" id="5071816">func</span><span class="op" id="5071820">(</span><span class="ident" id="5071821">i</span>&nbsp;<span class="op" id="5071823">*</span><span class="ident" id="5071824">encInstr</span><span class="op" id="5071832">,</span>&nbsp;<span class="ident" id="5071834">state</span>&nbsp;<span class="op" id="5071840">*</span><span class="ident" id="5071841">encoderState</span><span class="op" id="5071853">,</span>&nbsp;<span class="ident" id="5071855">v</span>&nbsp;<span class="ident" id="5071857">reflect</span><span class="op" id="5071864">.</span><span class="ident" id="5071865">Value</span><span class="op" id="5071870">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5071873">//&nbsp;The&nbsp;&#39;instructions&#39;&nbsp;of&nbsp;the&nbsp;encoding&nbsp;machine</span><br>
<span class="lineno"></span><span class="keyword" id="5071919">type</span>&nbsp;<span class="ident" id="5071924">encInstr</span>&nbsp;<span class="keyword" id="5071933">struct</span>&nbsp;<span class="op" id="5071940">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071943">op</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5071949">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071956">field</span>&nbsp;<span class="builtintype" id="5071962">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5071968">//&nbsp;field&nbsp;number&nbsp;in&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071994">index</span>&nbsp;<span class="op" id="5072000">[</span><span class="op" id="5072001">]</span><span class="builtintype" id="5072002">int</span>&nbsp;<span class="comment" id="5072006">//&nbsp;struct&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072023">indir</span>&nbsp;<span class="builtintype" id="5072029">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5072035">//&nbsp;how&nbsp;many&nbsp;pointer&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;struct</span><br>
<span class="lineno"></span><span class="op" id="5072101">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="5072104">//&nbsp;update&nbsp;emits&nbsp;a&nbsp;field&nbsp;number&nbsp;and&nbsp;updates&nbsp;the&nbsp;state&nbsp;to&nbsp;record&nbsp;its&nbsp;value&nbsp;for&nbsp;delta&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment" id="5072197">//&nbsp;If&nbsp;the&nbsp;instruction&nbsp;pointer&nbsp;is&nbsp;nil,&nbsp;it&nbsp;does&nbsp;nothing</span><br>
<span class="lineno"></span><span class="keyword" id="5072251">func</span>&nbsp;<span class="op" id="5072256">(</span><span class="ident" id="5072257">state</span>&nbsp;<span class="op" id="5072263">*</span><span class="ident" id="5072264">encoderState</span><span class="op" id="5072276">)</span>&nbsp;<span class="ident" id="5072278">update</span><span class="op" id="5072284">(</span><span class="ident" id="5072285">instr</span>&nbsp;<span class="op" id="5072291">*</span><span class="ident" id="5072292">encInstr</span><span class="op" id="5072300">)</span>&nbsp;<span class="op" id="5072302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072305">if</span>&nbsp;<span class="ident" id="5072308">instr</span>&nbsp;<span class="op" id="5072314">!=</span>&nbsp;<span class="ident" id="5072317">nil</span>&nbsp;<span class="op" id="5072321">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072325">state</span><span class="op" id="5072330">.</span><span class="ident" id="5072331">encodeUint</span><span class="op" id="5072341">(</span><span class="ident" id="5072342">uint64</span><span class="op" id="5072348">(</span><span class="ident" id="5072349">instr</span><span class="op" id="5072354">.</span><span class="ident" id="5072355">field</span>&nbsp;<span class="op" id="5072361">-</span>&nbsp;<span class="ident" id="5072363">state</span><span class="op" id="5072368">.</span><span class="ident" id="5072369">fieldnum</span><span class="op" id="5072377">)</span><span class="op" id="5072378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072382">state</span><span class="op" id="5072387">.</span><span class="ident" id="5072388">fieldnum</span>&nbsp;<span class="op" id="5072397">=</span>&nbsp;<span class="ident" id="5072399">instr</span><span class="op" id="5072404">.</span><span class="ident" id="5072405">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5072412">}</span><br>
<span class="lineno"></span><span class="op" id="5072414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="5072417">//&nbsp;Each&nbsp;encoder&nbsp;for&nbsp;a&nbsp;composite&nbsp;is&nbsp;responsible&nbsp;for&nbsp;handling&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="5072481">//&nbsp;indirections&nbsp;associated&nbsp;with&nbsp;the&nbsp;elements&nbsp;of&nbsp;the&nbsp;data&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="5072549">//&nbsp;If&nbsp;any&nbsp;pointer&nbsp;so&nbsp;reached&nbsp;is&nbsp;nil,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5072616">//&nbsp;data&nbsp;item&nbsp;is&nbsp;zero,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;Single&nbsp;values&nbsp;-&nbsp;ints,</span><br>
<span class="lineno"></span><span class="comment" id="5072683">//&nbsp;strings&nbsp;etc.&nbsp;-&nbsp;are&nbsp;indirected&nbsp;before&nbsp;calling&nbsp;their&nbsp;encoders.</span><br>
<span class="lineno">145</span><span class="comment" id="5072747">//&nbsp;Otherwise,&nbsp;the&nbsp;output&nbsp;(for&nbsp;a&nbsp;scalar)&nbsp;is&nbsp;the&nbsp;field&nbsp;number,&nbsp;as&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5072814">//&nbsp;encoded&nbsp;integer,&nbsp;followed&nbsp;by&nbsp;the&nbsp;field&nbsp;data&nbsp;in&nbsp;its&nbsp;appropriate</span><br>
<span class="lineno"></span><span class="comment" id="5072880">//&nbsp;format.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5072892">//&nbsp;encIndirect&nbsp;dereferences&nbsp;pv&nbsp;indir&nbsp;times&nbsp;and&nbsp;returns&nbsp;the&nbsp;result.</span><br>
<span class="lineno">150</span><span class="keyword" id="5072959">func</span>&nbsp;<span class="ident" id="5072964">encIndirect</span><span class="op" id="5072975">(</span><span class="ident" id="5072976">pv</span>&nbsp;<span class="ident" id="5072979">reflect</span><span class="op" id="5072986">.</span><span class="ident" id="5072987">Value</span><span class="op" id="5072992">,</span>&nbsp;<span class="ident" id="5072994">indir</span>&nbsp;<span class="builtintype" id="5073000">int</span><span class="op" id="5073003">)</span>&nbsp;<span class="ident" id="5073005">reflect</span><span class="op" id="5073012">.</span><span class="ident" id="5073013">Value</span>&nbsp;<span class="op" id="5073019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073022">for</span>&nbsp;<span class="op" id="5073026">;</span>&nbsp;<span class="ident" id="5073028">indir</span>&nbsp;<span class="op" id="5073034">&gt;</span>&nbsp;<span class="num" id="5073036">0</span><span class="op" id="5073037">;</span>&nbsp;<span class="ident" id="5073039">indir</span><span class="op" id="5073044">--</span>&nbsp;<span class="op" id="5073047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073051">if</span>&nbsp;<span class="ident" id="5073054">pv</span><span class="op" id="5073056">.</span><span class="ident" id="5073057">IsNil</span><span class="op" id="5073062">(</span><span class="op" id="5073063">)</span>&nbsp;<span class="op" id="5073065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073070">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5073078">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073082">pv</span>&nbsp;<span class="op" id="5073085">=</span>&nbsp;<span class="ident" id="5073087">pv</span><span class="op" id="5073089">.</span><span class="ident" id="5073090">Elem</span><span class="op" id="5073094">(</span><span class="op" id="5073095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5073098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073101">return</span>&nbsp;<span class="ident" id="5073108">pv</span><br>
<span class="lineno"></span><span class="op" id="5073111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="5073114">//&nbsp;encBool&nbsp;encodes&nbsp;the&nbsp;bool&nbsp;referenced&nbsp;by&nbsp;v&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;0&nbsp;or&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="5073181">func</span>&nbsp;<span class="ident" id="5073186">encBool</span><span class="op" id="5073193">(</span><span class="ident" id="5073194">i</span>&nbsp;<span class="op" id="5073196">*</span><span class="ident" id="5073197">encInstr</span><span class="op" id="5073205">,</span>&nbsp;<span class="ident" id="5073207">state</span>&nbsp;<span class="op" id="5073213">*</span><span class="ident" id="5073214">encoderState</span><span class="op" id="5073226">,</span>&nbsp;<span class="ident" id="5073228">v</span>&nbsp;<span class="ident" id="5073230">reflect</span><span class="op" id="5073237">.</span><span class="ident" id="5073238">Value</span><span class="op" id="5073243">)</span>&nbsp;<span class="op" id="5073245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073248">b</span>&nbsp;<span class="op" id="5073250">:=</span>&nbsp;<span class="ident" id="5073253">v</span><span class="op" id="5073254">.</span><span class="ident" id="5073255">Bool</span><span class="op" id="5073259">(</span><span class="op" id="5073260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073263">if</span>&nbsp;<span class="ident" id="5073266">b</span>&nbsp;<span class="op" id="5073268">||</span>&nbsp;<span class="ident" id="5073271">state</span><span class="op" id="5073276">.</span><span class="ident" id="5073277">sendZero</span>&nbsp;<span class="op" id="5073286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073290">state</span><span class="op" id="5073295">.</span><span class="ident" id="5073296">update</span><span class="op" id="5073302">(</span><span class="ident" id="5073303">i</span><span class="op" id="5073304">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073308">if</span>&nbsp;<span class="ident" id="5073311">b</span>&nbsp;<span class="op" id="5073313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073318">state</span><span class="op" id="5073323">.</span><span class="ident" id="5073324">encodeUint</span><span class="op" id="5073334">(</span><span class="num" id="5073335">1</span><span class="op" id="5073336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5073340">}</span>&nbsp;<span class="keyword" id="5073342">else</span>&nbsp;<span class="op" id="5073347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073352">state</span><span class="op" id="5073357">.</span><span class="ident" id="5073358">encodeUint</span><span class="op" id="5073368">(</span><span class="num" id="5073369">0</span><span class="op" id="5073370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5073374">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5073377">}</span><br>
<span class="lineno"></span><span class="op" id="5073379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5073382">//&nbsp;encInt&nbsp;encodes&nbsp;the&nbsp;signed&nbsp;integer&nbsp;(int&nbsp;int8&nbsp;int16&nbsp;int32&nbsp;int64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5073465">func</span>&nbsp;<span class="ident" id="5073470">encInt</span><span class="op" id="5073476">(</span><span class="ident" id="5073477">i</span>&nbsp;<span class="op" id="5073479">*</span><span class="ident" id="5073480">encInstr</span><span class="op" id="5073488">,</span>&nbsp;<span class="ident" id="5073490">state</span>&nbsp;<span class="op" id="5073496">*</span><span class="ident" id="5073497">encoderState</span><span class="op" id="5073509">,</span>&nbsp;<span class="ident" id="5073511">v</span>&nbsp;<span class="ident" id="5073513">reflect</span><span class="op" id="5073520">.</span><span class="ident" id="5073521">Value</span><span class="op" id="5073526">)</span>&nbsp;<span class="op" id="5073528">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073531">value</span>&nbsp;<span class="op" id="5073537">:=</span>&nbsp;<span class="ident" id="5073540">v</span><span class="op" id="5073541">.</span><span class="ident" id="5073542">Int</span><span class="op" id="5073545">(</span><span class="op" id="5073546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073549">if</span>&nbsp;<span class="ident" id="5073552">value</span>&nbsp;<span class="op" id="5073558">!=</span>&nbsp;<span class="num" id="5073561">0</span>&nbsp;<span class="op" id="5073563">||</span>&nbsp;<span class="ident" id="5073566">state</span><span class="op" id="5073571">.</span><span class="ident" id="5073572">sendZero</span>&nbsp;<span class="op" id="5073581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073585">state</span><span class="op" id="5073590">.</span><span class="ident" id="5073591">update</span><span class="op" id="5073597">(</span><span class="ident" id="5073598">i</span><span class="op" id="5073599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073603">state</span><span class="op" id="5073608">.</span><span class="ident" id="5073609">encodeInt</span><span class="op" id="5073618">(</span><span class="ident" id="5073619">value</span><span class="op" id="5073624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5073627">}</span><br>
<span class="lineno">180</span><span class="op" id="5073629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5073632">//&nbsp;encUint&nbsp;encodes&nbsp;the&nbsp;unsigned&nbsp;integer&nbsp;(uint&nbsp;uint8&nbsp;uint16&nbsp;uint32&nbsp;uint64&nbsp;uintptr)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5073731">func</span>&nbsp;<span class="ident" id="5073736">encUint</span><span class="op" id="5073743">(</span><span class="ident" id="5073744">i</span>&nbsp;<span class="op" id="5073746">*</span><span class="ident" id="5073747">encInstr</span><span class="op" id="5073755">,</span>&nbsp;<span class="ident" id="5073757">state</span>&nbsp;<span class="op" id="5073763">*</span><span class="ident" id="5073764">encoderState</span><span class="op" id="5073776">,</span>&nbsp;<span class="ident" id="5073778">v</span>&nbsp;<span class="ident" id="5073780">reflect</span><span class="op" id="5073787">.</span><span class="ident" id="5073788">Value</span><span class="op" id="5073793">)</span>&nbsp;<span class="op" id="5073795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073798">value</span>&nbsp;<span class="op" id="5073804">:=</span>&nbsp;<span class="ident" id="5073807">v</span><span class="op" id="5073808">.</span><span class="ident" id="5073809">Uint</span><span class="op" id="5073813">(</span><span class="op" id="5073814">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073817">if</span>&nbsp;<span class="ident" id="5073820">value</span>&nbsp;<span class="op" id="5073826">!=</span>&nbsp;<span class="num" id="5073829">0</span>&nbsp;<span class="op" id="5073831">||</span>&nbsp;<span class="ident" id="5073834">state</span><span class="op" id="5073839">.</span><span class="ident" id="5073840">sendZero</span>&nbsp;<span class="op" id="5073849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073853">state</span><span class="op" id="5073858">.</span><span class="ident" id="5073859">update</span><span class="op" id="5073865">(</span><span class="ident" id="5073866">i</span><span class="op" id="5073867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073871">state</span><span class="op" id="5073876">.</span><span class="ident" id="5073877">encodeUint</span><span class="op" id="5073887">(</span><span class="ident" id="5073888">value</span><span class="op" id="5073893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5073896">}</span><br>
<span class="lineno"></span><span class="op" id="5073898">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5073901">//&nbsp;floatBits&nbsp;returns&nbsp;a&nbsp;uint64&nbsp;holding&nbsp;the&nbsp;bits&nbsp;of&nbsp;a&nbsp;floating-point&nbsp;number.</span><br>
<span class="lineno"></span><span class="comment" id="5073976">//&nbsp;Floating-point&nbsp;numbers&nbsp;are&nbsp;transmitted&nbsp;as&nbsp;uint64s&nbsp;holding&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="5074046">//&nbsp;of&nbsp;the&nbsp;underlying&nbsp;representation.&nbsp;&nbsp;They&nbsp;are&nbsp;sent&nbsp;byte-reversed,&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="5074118">//&nbsp;the&nbsp;exponent&nbsp;end&nbsp;coming&nbsp;out&nbsp;first,&nbsp;so&nbsp;integer&nbsp;floating&nbsp;point&nbsp;numbers</span><br>
<span class="lineno">195</span><span class="comment" id="5074190">//&nbsp;(for&nbsp;example)&nbsp;transmit&nbsp;more&nbsp;compactly.&nbsp;&nbsp;This&nbsp;routine&nbsp;does&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5074255">//&nbsp;swizzling.</span><br>
<span class="lineno"></span><span class="keyword" id="5074269">func</span>&nbsp;<span class="ident" id="5074274">floatBits</span><span class="op" id="5074283">(</span><span class="ident" id="5074284">f</span>&nbsp;<span class="builtintype" id="5074286">float64</span><span class="op" id="5074293">)</span>&nbsp;<span class="ident" id="5074295">uint64</span>&nbsp;<span class="op" id="5074302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5074305">u</span>&nbsp;<span class="op" id="5074307">:=</span>&nbsp;<span class="ident" id="5074310">math</span><span class="op" id="5074314">.</span><span class="ident" id="5074315">Float64bits</span><span class="op" id="5074326">(</span><span class="ident" id="5074327">f</span><span class="op" id="5074328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5074331">var</span>&nbsp;<span class="ident" id="5074335">v</span>&nbsp;<span class="ident" id="5074337">uint64</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5074345">for</span>&nbsp;<span class="ident" id="5074349">i</span>&nbsp;<span class="op" id="5074351">:=</span>&nbsp;<span class="num" id="5074354">0</span><span class="op" id="5074355">;</span>&nbsp;<span class="ident" id="5074357">i</span>&nbsp;<span class="op" id="5074359">&lt;</span>&nbsp;<span class="num" id="5074361">8</span><span class="op" id="5074362">;</span>&nbsp;<span class="ident" id="5074364">i</span><span class="op" id="5074365">++</span>&nbsp;<span class="op" id="5074368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5074372">v</span>&nbsp;<span class="op" id="5074374">&lt;&lt;=</span>&nbsp;<span class="num" id="5074378">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5074382">v</span>&nbsp;<span class="op" id="5074384">|=</span>&nbsp;<span class="ident" id="5074387">u</span>&nbsp;<span class="op" id="5074389">&amp;</span>&nbsp;<span class="num" id="5074391">0xFF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5074398">u</span>&nbsp;<span class="op" id="5074400">&gt;&gt;=</span>&nbsp;<span class="num" id="5074404">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5074407">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5074410">return</span>&nbsp;<span class="ident" id="5074417">v</span><br>
<span class="lineno"></span><span class="op" id="5074419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5074422">//&nbsp;encFloat&nbsp;encodes&nbsp;the&nbsp;floating&nbsp;point&nbsp;value&nbsp;(float32&nbsp;float64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5074502">func</span>&nbsp;<span class="ident" id="5074507">encFloat</span><span class="op" id="5074515">(</span><span class="ident" id="5074516">i</span>&nbsp;<span class="op" id="5074518">*</span><span class="ident" id="5074519">encInstr</span><span class="op" id="5074527">,</span>&nbsp;<span class="ident" id="5074529">state</span>&nbsp;<span class="op" id="5074535">*</span><span class="ident" id="5074536">encoderState</span><span class="op" id="5074548">,</span>&nbsp;<span class="ident" id="5074550">v</span>&nbsp;<span class="ident" id="5074552">reflect</span><span class="op" id="5074559">.</span><span class="ident" id="5074560">Value</span><span class="op" id="5074565">)</span>&nbsp;<span class="op" id="5074567">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5074570">f</span>&nbsp;<span class="op" id="5074572">:=</span>&nbsp;<span class="ident" id="5074575">v</span><span class="op" id="5074576">.</span><span class="ident" id="5074577">Float</span><span class="op" id="5074582">(</span><span class="op" id="5074583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5074586">if</span>&nbsp;<span class="ident" id="5074589">f</span>&nbsp;<span class="op" id="5074591">!=</span>&nbsp;<span class="num" id="5074594">0</span>&nbsp;<span class="op" id="5074596">||</span>&nbsp;<span class="ident" id="5074599">state</span><span class="op" id="5074604">.</span><span class="ident" id="5074605">sendZero</span>&nbsp;<span class="op" id="5074614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5074618">bits</span>&nbsp;<span class="op" id="5074623">:=</span>&nbsp;<span class="ident" id="5074626">floatBits</span><span class="op" id="5074635">(</span><span class="ident" id="5074636">f</span><span class="op" id="5074637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5074641">state</span><span class="op" id="5074646">.</span><span class="ident" id="5074647">update</span><span class="op" id="5074653">(</span><span class="ident" id="5074654">i</span><span class="op" id="5074655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5074659">state</span><span class="op" id="5074664">.</span><span class="ident" id="5074665">encodeUint</span><span class="op" id="5074675">(</span><span class="ident" id="5074676">bits</span><span class="op" id="5074680">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5074683">}</span><br>
<span class="lineno"></span><span class="op" id="5074685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5074688">//&nbsp;encComplex&nbsp;encodes&nbsp;the&nbsp;complex&nbsp;value&nbsp;(complex64&nbsp;complex128)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5074768">//&nbsp;Complex&nbsp;numbers&nbsp;are&nbsp;just&nbsp;a&nbsp;pair&nbsp;of&nbsp;floating-point&nbsp;numbers,&nbsp;real&nbsp;part&nbsp;first.</span><br>
<span class="lineno">220</span><span class="keyword" id="5074847">func</span>&nbsp;<span class="ident" id="5074852">encComplex</span><span class="op" id="5074862">(</span><span class="ident" id="5074863">i</span>&nbsp;<span class="op" id="5074865">*</span><span class="ident" id="5074866">encInstr</span><span class="op" id="5074874">,</span>&nbsp;<span class="ident" id="5074876">state</span>&nbsp;<span class="op" id="5074882">*</span><span class="ident" id="5074883">encoderState</span><span class="op" id="5074895">,</span>&nbsp;<span class="ident" id="5074897">v</span>&nbsp;<span class="ident" id="5074899">reflect</span><span class="op" id="5074906">.</span><span class="ident" id="5074907">Value</span><span class="op" id="5074912">)</span>&nbsp;<span class="op" id="5074914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5074917">c</span>&nbsp;<span class="op" id="5074919">:=</span>&nbsp;<span class="ident" id="5074922">v</span><span class="op" id="5074923">.</span><span class="ident" id="5074924">Complex</span><span class="op" id="5074931">(</span><span class="op" id="5074932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5074935">if</span>&nbsp;<span class="ident" id="5074938">c</span>&nbsp;<span class="op" id="5074940">!=</span>&nbsp;<span class="num" id="5074943">0</span><span class="op" id="5074944">+</span><span class="num" id="5074945">0i</span>&nbsp;<span class="op" id="5074948">||</span>&nbsp;<span class="ident" id="5074951">state</span><span class="op" id="5074956">.</span><span class="ident" id="5074957">sendZero</span>&nbsp;<span class="op" id="5074966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5074970">rpart</span>&nbsp;<span class="op" id="5074976">:=</span>&nbsp;<span class="ident" id="5074979">floatBits</span><span class="op" id="5074988">(</span><span class="builtinfunc" id="5074989">real</span><span class="op" id="5074993">(</span><span class="ident" id="5074994">c</span><span class="op" id="5074995">)</span><span class="op" id="5074996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075000">ipart</span>&nbsp;<span class="op" id="5075006">:=</span>&nbsp;<span class="ident" id="5075009">floatBits</span><span class="op" id="5075018">(</span><span class="builtinfunc" id="5075019">imag</span><span class="op" id="5075023">(</span><span class="ident" id="5075024">c</span><span class="op" id="5075025">)</span><span class="op" id="5075026">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075030">state</span><span class="op" id="5075035">.</span><span class="ident" id="5075036">update</span><span class="op" id="5075042">(</span><span class="ident" id="5075043">i</span><span class="op" id="5075044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075048">state</span><span class="op" id="5075053">.</span><span class="ident" id="5075054">encodeUint</span><span class="op" id="5075064">(</span><span class="ident" id="5075065">rpart</span><span class="op" id="5075070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075074">state</span><span class="op" id="5075079">.</span><span class="ident" id="5075080">encodeUint</span><span class="op" id="5075090">(</span><span class="ident" id="5075091">ipart</span><span class="op" id="5075096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5075099">}</span><br>
<span class="lineno"></span><span class="op" id="5075101">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="5075104">//&nbsp;encUint8Array&nbsp;encodes&nbsp;the&nbsp;byte&nbsp;array&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5075161">//&nbsp;Byte&nbsp;arrays&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5075236">func</span>&nbsp;<span class="ident" id="5075241">encUint8Array</span><span class="op" id="5075254">(</span><span class="ident" id="5075255">i</span>&nbsp;<span class="op" id="5075257">*</span><span class="ident" id="5075258">encInstr</span><span class="op" id="5075266">,</span>&nbsp;<span class="ident" id="5075268">state</span>&nbsp;<span class="op" id="5075274">*</span><span class="ident" id="5075275">encoderState</span><span class="op" id="5075287">,</span>&nbsp;<span class="ident" id="5075289">v</span>&nbsp;<span class="ident" id="5075291">reflect</span><span class="op" id="5075298">.</span><span class="ident" id="5075299">Value</span><span class="op" id="5075304">)</span>&nbsp;<span class="op" id="5075306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075309">b</span>&nbsp;<span class="op" id="5075311">:=</span>&nbsp;<span class="ident" id="5075314">v</span><span class="op" id="5075315">.</span><span class="ident" id="5075316">Bytes</span><span class="op" id="5075321">(</span><span class="op" id="5075322">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5075325">if</span>&nbsp;<span class="builtinfunc" id="5075328">len</span><span class="op" id="5075331">(</span><span class="ident" id="5075332">b</span><span class="op" id="5075333">)</span>&nbsp;<span class="op" id="5075335">&gt;</span>&nbsp;<span class="num" id="5075337">0</span>&nbsp;<span class="op" id="5075339">||</span>&nbsp;<span class="ident" id="5075342">state</span><span class="op" id="5075347">.</span><span class="ident" id="5075348">sendZero</span>&nbsp;<span class="op" id="5075357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075361">state</span><span class="op" id="5075366">.</span><span class="ident" id="5075367">update</span><span class="op" id="5075373">(</span><span class="ident" id="5075374">i</span><span class="op" id="5075375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075379">state</span><span class="op" id="5075384">.</span><span class="ident" id="5075385">encodeUint</span><span class="op" id="5075395">(</span><span class="ident" id="5075396">uint64</span><span class="op" id="5075402">(</span><span class="builtinfunc" id="5075403">len</span><span class="op" id="5075406">(</span><span class="ident" id="5075407">b</span><span class="op" id="5075408">)</span><span class="op" id="5075409">)</span><span class="op" id="5075410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075414">state</span><span class="op" id="5075419">.</span><span class="ident" id="5075420">b</span><span class="op" id="5075421">.</span><span class="ident" id="5075422">Write</span><span class="op" id="5075427">(</span><span class="ident" id="5075428">b</span><span class="op" id="5075429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5075432">}</span><br>
<span class="lineno">240</span><span class="op" id="5075434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5075437">//&nbsp;encString&nbsp;encodes&nbsp;the&nbsp;string&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5075486">//&nbsp;Strings&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5075557">func</span>&nbsp;<span class="ident" id="5075562">encString</span><span class="op" id="5075571">(</span><span class="ident" id="5075572">i</span>&nbsp;<span class="op" id="5075574">*</span><span class="ident" id="5075575">encInstr</span><span class="op" id="5075583">,</span>&nbsp;<span class="ident" id="5075585">state</span>&nbsp;<span class="op" id="5075591">*</span><span class="ident" id="5075592">encoderState</span><span class="op" id="5075604">,</span>&nbsp;<span class="ident" id="5075606">v</span>&nbsp;<span class="ident" id="5075608">reflect</span><span class="op" id="5075615">.</span><span class="ident" id="5075616">Value</span><span class="op" id="5075621">)</span>&nbsp;<span class="op" id="5075623">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075626">s</span>&nbsp;<span class="op" id="5075628">:=</span>&nbsp;<span class="ident" id="5075631">v</span><span class="op" id="5075632">.</span><span class="ident" id="5075633">String</span><span class="op" id="5075639">(</span><span class="op" id="5075640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5075643">if</span>&nbsp;<span class="builtinfunc" id="5075646">len</span><span class="op" id="5075649">(</span><span class="ident" id="5075650">s</span><span class="op" id="5075651">)</span>&nbsp;<span class="op" id="5075653">&gt;</span>&nbsp;<span class="num" id="5075655">0</span>&nbsp;<span class="op" id="5075657">||</span>&nbsp;<span class="ident" id="5075660">state</span><span class="op" id="5075665">.</span><span class="ident" id="5075666">sendZero</span>&nbsp;<span class="op" id="5075675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075679">state</span><span class="op" id="5075684">.</span><span class="ident" id="5075685">update</span><span class="op" id="5075691">(</span><span class="ident" id="5075692">i</span><span class="op" id="5075693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075697">state</span><span class="op" id="5075702">.</span><span class="ident" id="5075703">encodeUint</span><span class="op" id="5075713">(</span><span class="ident" id="5075714">uint64</span><span class="op" id="5075720">(</span><span class="builtinfunc" id="5075721">len</span><span class="op" id="5075724">(</span><span class="ident" id="5075725">s</span><span class="op" id="5075726">)</span><span class="op" id="5075727">)</span><span class="op" id="5075728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075732">state</span><span class="op" id="5075737">.</span><span class="ident" id="5075738">b</span><span class="op" id="5075739">.</span><span class="ident" id="5075740">WriteString</span><span class="op" id="5075751">(</span><span class="ident" id="5075752">s</span><span class="op" id="5075753">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5075756">}</span><br>
<span class="lineno"></span><span class="op" id="5075758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5075761">//&nbsp;encStructTerminator&nbsp;encodes&nbsp;the&nbsp;end&nbsp;of&nbsp;an&nbsp;encoded&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="5075821">//&nbsp;as&nbsp;delta&nbsp;field&nbsp;number&nbsp;of&nbsp;0.</span><br>
<span class="lineno">255</span><span class="keyword" id="5075852">func</span>&nbsp;<span class="ident" id="5075857">encStructTerminator</span><span class="op" id="5075876">(</span><span class="ident" id="5075877">i</span>&nbsp;<span class="op" id="5075879">*</span><span class="ident" id="5075880">encInstr</span><span class="op" id="5075888">,</span>&nbsp;<span class="ident" id="5075890">state</span>&nbsp;<span class="op" id="5075896">*</span><span class="ident" id="5075897">encoderState</span><span class="op" id="5075909">,</span>&nbsp;<span class="ident" id="5075911">v</span>&nbsp;<span class="ident" id="5075913">reflect</span><span class="op" id="5075920">.</span><span class="ident" id="5075921">Value</span><span class="op" id="5075926">)</span>&nbsp;<span class="op" id="5075928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5075931">state</span><span class="op" id="5075936">.</span><span class="ident" id="5075937">encodeUint</span><span class="op" id="5075947">(</span><span class="num" id="5075948">0</span><span class="op" id="5075949">)</span><br>
<span class="lineno"></span><span class="op" id="5075951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5075954">//&nbsp;Execution&nbsp;engine</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="5075975">//&nbsp;encEngine&nbsp;an&nbsp;array&nbsp;of&nbsp;instructions&nbsp;indexed&nbsp;by&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;encoding</span><br>
<span class="lineno"></span><span class="comment" id="5076053">//&nbsp;data,&nbsp;typically&nbsp;a&nbsp;struct.&nbsp;&nbsp;It&nbsp;is&nbsp;executed&nbsp;top&nbsp;to&nbsp;bottom,&nbsp;walking&nbsp;the&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="5076133">type</span>&nbsp;<span class="ident" id="5076138">encEngine</span>&nbsp;<span class="keyword" id="5076148">struct</span>&nbsp;<span class="op" id="5076155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5076158">instr</span>&nbsp;<span class="op" id="5076164">[</span><span class="op" id="5076165">]</span><span class="ident" id="5076166">encInstr</span><br>
<span class="lineno">265</span><span class="op" id="5076175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5076178">const</span>&nbsp;<span class="ident" id="5076184">singletonField</span>&nbsp;<span class="op" id="5076199">=</span>&nbsp;<span class="num" id="5076201">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5076204">//&nbsp;valid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;valid&nbsp;and&nbsp;a&nbsp;non-nil&nbsp;pointer.</span><br>
<span class="lineno">270</span><span class="comment" id="5076271">//&nbsp;(Slices,&nbsp;maps,&nbsp;and&nbsp;chans&nbsp;take&nbsp;care&nbsp;of&nbsp;themselves.)</span><br>
<span class="lineno"></span><span class="keyword" id="5076325">func</span>&nbsp;<span class="ident" id="5076330">valid</span><span class="op" id="5076335">(</span><span class="ident" id="5076336">v</span>&nbsp;<span class="ident" id="5076338">reflect</span><span class="op" id="5076345">.</span><span class="ident" id="5076346">Value</span><span class="op" id="5076351">)</span>&nbsp;<span class="builtintype" id="5076353">bool</span>&nbsp;<span class="op" id="5076358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5076361">switch</span>&nbsp;<span class="ident" id="5076368">v</span><span class="op" id="5076369">.</span><span class="ident" id="5076370">Kind</span><span class="op" id="5076374">(</span><span class="op" id="5076375">)</span>&nbsp;<span class="op" id="5076377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5076380">case</span>&nbsp;<span class="ident" id="5076385">reflect</span><span class="op" id="5076392">.</span><span class="ident" id="5076393">Invalid</span><span class="op" id="5076400">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5076404">return</span>&nbsp;<span class="builtintype" id="5076411">false</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5076418">case</span>&nbsp;<span class="ident" id="5076423">reflect</span><span class="op" id="5076430">.</span><span class="ident" id="5076431">Ptr</span><span class="op" id="5076434">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5076438">return</span>&nbsp;<span class="op" id="5076445">!</span><span class="ident" id="5076446">v</span><span class="op" id="5076447">.</span><span class="ident" id="5076448">IsNil</span><span class="op" id="5076453">(</span><span class="op" id="5076454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5076457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5076460">return</span>&nbsp;<span class="builtintype" id="5076467">true</span><br>
<span class="lineno"></span><span class="op" id="5076472">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="5076475">//&nbsp;encodeSingle&nbsp;encodes&nbsp;a&nbsp;single&nbsp;top-level&nbsp;non-struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5076536">func</span>&nbsp;<span class="op" id="5076541">(</span><span class="ident" id="5076542">enc</span>&nbsp;<span class="op" id="5076546">*</span><span class="ident" id="5076547">Encoder</span><span class="op" id="5076554">)</span>&nbsp;<span class="ident" id="5076556">encodeSingle</span><span class="op" id="5076568">(</span><span class="ident" id="5076569">b</span>&nbsp;<span class="op" id="5076571">*</span><span class="ident" id="5076572">encBuffer</span><span class="op" id="5076581">,</span>&nbsp;<span class="ident" id="5076583">engine</span>&nbsp;<span class="op" id="5076590">*</span><span class="ident" id="5076591">encEngine</span><span class="op" id="5076600">,</span>&nbsp;<span class="ident" id="5076602">value</span>&nbsp;<span class="ident" id="5076608">reflect</span><span class="op" id="5076615">.</span><span class="ident" id="5076616">Value</span><span class="op" id="5076621">)</span>&nbsp;<span class="op" id="5076623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5076626">state</span>&nbsp;<span class="op" id="5076632">:=</span>&nbsp;<span class="ident" id="5076635">enc</span><span class="op" id="5076638">.</span><span class="ident" id="5076639">newEncoderState</span><span class="op" id="5076654">(</span><span class="ident" id="5076655">b</span><span class="op" id="5076656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5076659">defer</span>&nbsp;<span class="ident" id="5076665">enc</span><span class="op" id="5076668">.</span><span class="ident" id="5076669">freeEncoderState</span><span class="op" id="5076685">(</span><span class="ident" id="5076686">state</span><span class="op" id="5076691">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5076694">state</span><span class="op" id="5076699">.</span><span class="ident" id="5076700">fieldnum</span>&nbsp;<span class="op" id="5076709">=</span>&nbsp;<span class="ident" id="5076711">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5076727">//&nbsp;There&nbsp;is&nbsp;no&nbsp;surrounding&nbsp;struct&nbsp;to&nbsp;frame&nbsp;the&nbsp;transmission,&nbsp;so&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5076800">//&nbsp;generate&nbsp;data&nbsp;even&nbsp;if&nbsp;the&nbsp;item&nbsp;is&nbsp;zero.&nbsp;&nbsp;To&nbsp;do&nbsp;this,&nbsp;set&nbsp;sendZero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5076871">state</span><span class="op" id="5076876">.</span><span class="ident" id="5076877">sendZero</span>&nbsp;<span class="op" id="5076886">=</span>&nbsp;<span class="builtintype" id="5076888">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5076894">instr</span>&nbsp;<span class="op" id="5076900">:=</span>&nbsp;<span class="op" id="5076903">&amp;</span><span class="ident" id="5076904">engine</span><span class="op" id="5076910">.</span><span class="ident" id="5076911">instr</span><span class="op" id="5076916">[</span><span class="ident" id="5076917">singletonField</span><span class="op" id="5076931">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5076934">if</span>&nbsp;<span class="ident" id="5076937">instr</span><span class="op" id="5076942">.</span><span class="ident" id="5076943">indir</span>&nbsp;<span class="op" id="5076949">&gt;</span>&nbsp;<span class="num" id="5076951">0</span>&nbsp;<span class="op" id="5076953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5076957">value</span>&nbsp;<span class="op" id="5076963">=</span>&nbsp;<span class="ident" id="5076965">encIndirect</span><span class="op" id="5076976">(</span><span class="ident" id="5076977">value</span><span class="op" id="5076982">,</span>&nbsp;<span class="ident" id="5076984">instr</span><span class="op" id="5076989">.</span><span class="ident" id="5076990">indir</span><span class="op" id="5076995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5076998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077001">if</span>&nbsp;<span class="ident" id="5077004">valid</span><span class="op" id="5077009">(</span><span class="ident" id="5077010">value</span><span class="op" id="5077015">)</span>&nbsp;<span class="op" id="5077017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077021">instr</span><span class="op" id="5077026">.</span><span class="ident" id="5077027">op</span><span class="op" id="5077029">(</span><span class="ident" id="5077030">instr</span><span class="op" id="5077035">,</span>&nbsp;<span class="ident" id="5077037">state</span><span class="op" id="5077042">,</span>&nbsp;<span class="ident" id="5077044">value</span><span class="op" id="5077049">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077052">}</span><br>
<span class="lineno"></span><span class="op" id="5077054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5077057">//&nbsp;encodeStruct&nbsp;encodes&nbsp;a&nbsp;single&nbsp;struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5077104">func</span>&nbsp;<span class="op" id="5077109">(</span><span class="ident" id="5077110">enc</span>&nbsp;<span class="op" id="5077114">*</span><span class="ident" id="5077115">Encoder</span><span class="op" id="5077122">)</span>&nbsp;<span class="ident" id="5077124">encodeStruct</span><span class="op" id="5077136">(</span><span class="ident" id="5077137">b</span>&nbsp;<span class="op" id="5077139">*</span><span class="ident" id="5077140">encBuffer</span><span class="op" id="5077149">,</span>&nbsp;<span class="ident" id="5077151">engine</span>&nbsp;<span class="op" id="5077158">*</span><span class="ident" id="5077159">encEngine</span><span class="op" id="5077168">,</span>&nbsp;<span class="ident" id="5077170">value</span>&nbsp;<span class="ident" id="5077176">reflect</span><span class="op" id="5077183">.</span><span class="ident" id="5077184">Value</span><span class="op" id="5077189">)</span>&nbsp;<span class="op" id="5077191">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077194">if</span>&nbsp;<span class="op" id="5077197">!</span><span class="ident" id="5077198">valid</span><span class="op" id="5077203">(</span><span class="ident" id="5077204">value</span><span class="op" id="5077209">)</span>&nbsp;<span class="op" id="5077211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077215">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077226">state</span>&nbsp;<span class="op" id="5077232">:=</span>&nbsp;<span class="ident" id="5077235">enc</span><span class="op" id="5077238">.</span><span class="ident" id="5077239">newEncoderState</span><span class="op" id="5077254">(</span><span class="ident" id="5077255">b</span><span class="op" id="5077256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077259">defer</span>&nbsp;<span class="ident" id="5077265">enc</span><span class="op" id="5077268">.</span><span class="ident" id="5077269">freeEncoderState</span><span class="op" id="5077285">(</span><span class="ident" id="5077286">state</span><span class="op" id="5077291">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077294">state</span><span class="op" id="5077299">.</span><span class="ident" id="5077300">fieldnum</span>&nbsp;<span class="op" id="5077309">=</span>&nbsp;<span class="op" id="5077311">-</span><span class="num" id="5077312">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077315">for</span>&nbsp;<span class="ident" id="5077319">i</span>&nbsp;<span class="op" id="5077321">:=</span>&nbsp;<span class="num" id="5077324">0</span><span class="op" id="5077325">;</span>&nbsp;<span class="ident" id="5077327">i</span>&nbsp;<span class="op" id="5077329">&lt;</span>&nbsp;<span class="builtinfunc" id="5077331">len</span><span class="op" id="5077334">(</span><span class="ident" id="5077335">engine</span><span class="op" id="5077341">.</span><span class="ident" id="5077342">instr</span><span class="op" id="5077347">)</span><span class="op" id="5077348">;</span>&nbsp;<span class="ident" id="5077350">i</span><span class="op" id="5077351">++</span>&nbsp;<span class="op" id="5077354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077358">instr</span>&nbsp;<span class="op" id="5077364">:=</span>&nbsp;<span class="op" id="5077367">&amp;</span><span class="ident" id="5077368">engine</span><span class="op" id="5077374">.</span><span class="ident" id="5077375">instr</span><span class="op" id="5077380">[</span><span class="ident" id="5077381">i</span><span class="op" id="5077382">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077386">if</span>&nbsp;<span class="ident" id="5077389">i</span>&nbsp;<span class="op" id="5077391">&gt;=</span>&nbsp;<span class="ident" id="5077394">value</span><span class="op" id="5077399">.</span><span class="ident" id="5077400">NumField</span><span class="op" id="5077408">(</span><span class="op" id="5077409">)</span>&nbsp;<span class="op" id="5077411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5077416">//&nbsp;encStructTerminator</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077442">instr</span><span class="op" id="5077447">.</span><span class="ident" id="5077448">op</span><span class="op" id="5077450">(</span><span class="ident" id="5077451">instr</span><span class="op" id="5077456">,</span>&nbsp;<span class="ident" id="5077458">state</span><span class="op" id="5077463">,</span>&nbsp;<span class="ident" id="5077465">reflect</span><span class="op" id="5077472">.</span><span class="ident" id="5077473">Value</span><span class="op" id="5077478">{</span><span class="op" id="5077479">}</span><span class="op" id="5077480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077485">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077497">field</span>&nbsp;<span class="op" id="5077503">:=</span>&nbsp;<span class="ident" id="5077506">value</span><span class="op" id="5077511">.</span><span class="ident" id="5077512">FieldByIndex</span><span class="op" id="5077524">(</span><span class="ident" id="5077525">instr</span><span class="op" id="5077530">.</span><span class="ident" id="5077531">index</span><span class="op" id="5077536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077540">if</span>&nbsp;<span class="ident" id="5077543">instr</span><span class="op" id="5077548">.</span><span class="ident" id="5077549">indir</span>&nbsp;<span class="op" id="5077555">&gt;</span>&nbsp;<span class="num" id="5077557">0</span>&nbsp;<span class="op" id="5077559">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077564">field</span>&nbsp;<span class="op" id="5077570">=</span>&nbsp;<span class="ident" id="5077572">encIndirect</span><span class="op" id="5077583">(</span><span class="ident" id="5077584">field</span><span class="op" id="5077589">,</span>&nbsp;<span class="ident" id="5077591">instr</span><span class="op" id="5077596">.</span><span class="ident" id="5077597">indir</span><span class="op" id="5077602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5077607">//&nbsp;TODO:&nbsp;Is&nbsp;field&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077679">if</span>&nbsp;<span class="op" id="5077682">!</span><span class="ident" id="5077683">valid</span><span class="op" id="5077688">(</span><span class="ident" id="5077689">field</span><span class="op" id="5077694">)</span>&nbsp;<span class="op" id="5077696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077702">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077714">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077722">instr</span><span class="op" id="5077727">.</span><span class="ident" id="5077728">op</span><span class="op" id="5077730">(</span><span class="ident" id="5077731">instr</span><span class="op" id="5077736">,</span>&nbsp;<span class="ident" id="5077738">state</span><span class="op" id="5077743">,</span>&nbsp;<span class="ident" id="5077745">field</span><span class="op" id="5077750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077753">}</span><br>
<span class="lineno"></span><span class="op" id="5077755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="5077758">//&nbsp;encodeArray&nbsp;encodes&nbsp;an&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="5077791">func</span>&nbsp;<span class="op" id="5077796">(</span><span class="ident" id="5077797">enc</span>&nbsp;<span class="op" id="5077801">*</span><span class="ident" id="5077802">Encoder</span><span class="op" id="5077809">)</span>&nbsp;<span class="ident" id="5077811">encodeArray</span><span class="op" id="5077822">(</span><span class="ident" id="5077823">b</span>&nbsp;<span class="op" id="5077825">*</span><span class="ident" id="5077826">encBuffer</span><span class="op" id="5077835">,</span>&nbsp;<span class="ident" id="5077837">value</span>&nbsp;<span class="ident" id="5077843">reflect</span><span class="op" id="5077850">.</span><span class="ident" id="5077851">Value</span><span class="op" id="5077856">,</span>&nbsp;<span class="ident" id="5077858">op</span>&nbsp;<span class="ident" id="5077861">encOp</span><span class="op" id="5077866">,</span>&nbsp;<span class="ident" id="5077868">elemIndir</span>&nbsp;<span class="builtintype" id="5077878">int</span><span class="op" id="5077881">,</span>&nbsp;<span class="ident" id="5077883">length</span>&nbsp;<span class="builtintype" id="5077890">int</span><span class="op" id="5077893">,</span>&nbsp;<span class="ident" id="5077895">helper</span>&nbsp;<span class="ident" id="5077902">encHelper</span><span class="op" id="5077911">)</span>&nbsp;<span class="op" id="5077913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077916">state</span>&nbsp;<span class="op" id="5077922">:=</span>&nbsp;<span class="ident" id="5077925">enc</span><span class="op" id="5077928">.</span><span class="ident" id="5077929">newEncoderState</span><span class="op" id="5077944">(</span><span class="ident" id="5077945">b</span><span class="op" id="5077946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077949">defer</span>&nbsp;<span class="ident" id="5077955">enc</span><span class="op" id="5077958">.</span><span class="ident" id="5077959">freeEncoderState</span><span class="op" id="5077975">(</span><span class="ident" id="5077976">state</span><span class="op" id="5077981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077984">state</span><span class="op" id="5077989">.</span><span class="ident" id="5077990">fieldnum</span>&nbsp;<span class="op" id="5077999">=</span>&nbsp;<span class="op" id="5078001">-</span><span class="num" id="5078002">1</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078005">state</span><span class="op" id="5078010">.</span><span class="ident" id="5078011">sendZero</span>&nbsp;<span class="op" id="5078020">=</span>&nbsp;<span class="builtintype" id="5078022">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078028">state</span><span class="op" id="5078033">.</span><span class="ident" id="5078034">encodeUint</span><span class="op" id="5078044">(</span><span class="ident" id="5078045">uint64</span><span class="op" id="5078051">(</span><span class="ident" id="5078052">length</span><span class="op" id="5078058">)</span><span class="op" id="5078059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078062">if</span>&nbsp;<span class="ident" id="5078065">helper</span>&nbsp;<span class="op" id="5078072">!=</span>&nbsp;<span class="ident" id="5078075">nil</span>&nbsp;<span class="op" id="5078079">&amp;&amp;</span>&nbsp;<span class="ident" id="5078082">helper</span><span class="op" id="5078088">(</span><span class="ident" id="5078089">state</span><span class="op" id="5078094">,</span>&nbsp;<span class="ident" id="5078096">value</span><span class="op" id="5078101">)</span>&nbsp;<span class="op" id="5078103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078107">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5078115">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078118">for</span>&nbsp;<span class="ident" id="5078122">i</span>&nbsp;<span class="op" id="5078124">:=</span>&nbsp;<span class="num" id="5078127">0</span><span class="op" id="5078128">;</span>&nbsp;<span class="ident" id="5078130">i</span>&nbsp;<span class="op" id="5078132">&lt;</span>&nbsp;<span class="ident" id="5078134">length</span><span class="op" id="5078140">;</span>&nbsp;<span class="ident" id="5078142">i</span><span class="op" id="5078143">++</span>&nbsp;<span class="op" id="5078146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078150">elem</span>&nbsp;<span class="op" id="5078155">:=</span>&nbsp;<span class="ident" id="5078158">value</span><span class="op" id="5078163">.</span><span class="ident" id="5078164">Index</span><span class="op" id="5078169">(</span><span class="ident" id="5078170">i</span><span class="op" id="5078171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078175">if</span>&nbsp;<span class="ident" id="5078178">elemIndir</span>&nbsp;<span class="op" id="5078188">&gt;</span>&nbsp;<span class="num" id="5078190">0</span>&nbsp;<span class="op" id="5078192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078197">elem</span>&nbsp;<span class="op" id="5078202">=</span>&nbsp;<span class="ident" id="5078204">encIndirect</span><span class="op" id="5078215">(</span><span class="ident" id="5078216">elem</span><span class="op" id="5078220">,</span>&nbsp;<span class="ident" id="5078222">elemIndir</span><span class="op" id="5078231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5078236">//&nbsp;TODO:&nbsp;Is&nbsp;elem&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078307">if</span>&nbsp;<span class="op" id="5078310">!</span><span class="ident" id="5078311">valid</span><span class="op" id="5078316">(</span><span class="ident" id="5078317">elem</span><span class="op" id="5078321">)</span>&nbsp;<span class="op" id="5078323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078329">errorf</span><span class="op" id="5078335">(</span><span class="string" id="5078336">&#34;encodeArray:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="5078362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5078367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5078371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078375">op</span><span class="op" id="5078377">(</span><span class="ident" id="5078378">nil</span><span class="op" id="5078381">,</span>&nbsp;<span class="ident" id="5078383">state</span><span class="op" id="5078388">,</span>&nbsp;<span class="ident" id="5078390">elem</span><span class="op" id="5078394">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5078397">}</span><br>
<span class="lineno"></span><span class="op" id="5078399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5078402">//&nbsp;encodeReflectValue&nbsp;is&nbsp;a&nbsp;helper&nbsp;for&nbsp;maps.&nbsp;It&nbsp;encodes&nbsp;the&nbsp;value&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5078470">func</span>&nbsp;<span class="ident" id="5078475">encodeReflectValue</span><span class="op" id="5078493">(</span><span class="ident" id="5078494">state</span>&nbsp;<span class="op" id="5078500">*</span><span class="ident" id="5078501">encoderState</span><span class="op" id="5078513">,</span>&nbsp;<span class="ident" id="5078515">v</span>&nbsp;<span class="ident" id="5078517">reflect</span><span class="op" id="5078524">.</span><span class="ident" id="5078525">Value</span><span class="op" id="5078530">,</span>&nbsp;<span class="ident" id="5078532">op</span>&nbsp;<span class="ident" id="5078535">encOp</span><span class="op" id="5078540">,</span>&nbsp;<span class="ident" id="5078542">indir</span>&nbsp;<span class="builtintype" id="5078548">int</span><span class="op" id="5078551">)</span>&nbsp;<span class="op" id="5078553">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078556">for</span>&nbsp;<span class="ident" id="5078560">i</span>&nbsp;<span class="op" id="5078562">:=</span>&nbsp;<span class="num" id="5078565">0</span><span class="op" id="5078566">;</span>&nbsp;<span class="ident" id="5078568">i</span>&nbsp;<span class="op" id="5078570">&lt;</span>&nbsp;<span class="ident" id="5078572">indir</span>&nbsp;<span class="op" id="5078578">&amp;&amp;</span>&nbsp;<span class="ident" id="5078581">v</span><span class="op" id="5078582">.</span><span class="ident" id="5078583">IsValid</span><span class="op" id="5078590">(</span><span class="op" id="5078591">)</span><span class="op" id="5078592">;</span>&nbsp;<span class="ident" id="5078594">i</span><span class="op" id="5078595">++</span>&nbsp;<span class="op" id="5078598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078602">v</span>&nbsp;<span class="op" id="5078604">=</span>&nbsp;<span class="ident" id="5078606">reflect</span><span class="op" id="5078613">.</span><span class="ident" id="5078614">Indirect</span><span class="op" id="5078622">(</span><span class="ident" id="5078623">v</span><span class="op" id="5078624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5078627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5078630">if</span>&nbsp;<span class="op" id="5078633">!</span><span class="ident" id="5078634">v</span><span class="op" id="5078635">.</span><span class="ident" id="5078636">IsValid</span><span class="op" id="5078643">(</span><span class="op" id="5078644">)</span>&nbsp;<span class="op" id="5078646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078650">errorf</span><span class="op" id="5078656">(</span><span class="string" id="5078657">&#34;encodeReflectValue:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="5078690">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5078693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078696">op</span><span class="op" id="5078698">(</span><span class="ident" id="5078699">nil</span><span class="op" id="5078702">,</span>&nbsp;<span class="ident" id="5078704">state</span><span class="op" id="5078709">,</span>&nbsp;<span class="ident" id="5078711">v</span><span class="op" id="5078712">)</span><br>
<span class="lineno"></span><span class="op" id="5078714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5078717">//&nbsp;encodeMap&nbsp;encodes&nbsp;a&nbsp;map&nbsp;as&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;key:value&nbsp;pairs.</span><br>
<span class="lineno">360</span><span class="keyword" id="5078791">func</span>&nbsp;<span class="op" id="5078796">(</span><span class="ident" id="5078797">enc</span>&nbsp;<span class="op" id="5078801">*</span><span class="ident" id="5078802">Encoder</span><span class="op" id="5078809">)</span>&nbsp;<span class="ident" id="5078811">encodeMap</span><span class="op" id="5078820">(</span><span class="ident" id="5078821">b</span>&nbsp;<span class="op" id="5078823">*</span><span class="ident" id="5078824">encBuffer</span><span class="op" id="5078833">,</span>&nbsp;<span class="ident" id="5078835">mv</span>&nbsp;<span class="ident" id="5078838">reflect</span><span class="op" id="5078845">.</span><span class="ident" id="5078846">Value</span><span class="op" id="5078851">,</span>&nbsp;<span class="ident" id="5078853">keyOp</span><span class="op" id="5078858">,</span>&nbsp;<span class="ident" id="5078860">elemOp</span>&nbsp;<span class="ident" id="5078867">encOp</span><span class="op" id="5078872">,</span>&nbsp;<span class="ident" id="5078874">keyIndir</span><span class="op" id="5078882">,</span>&nbsp;<span class="ident" id="5078884">elemIndir</span>&nbsp;<span class="builtintype" id="5078894">int</span><span class="op" id="5078897">)</span>&nbsp;<span class="op" id="5078899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078902">state</span>&nbsp;<span class="op" id="5078908">:=</span>&nbsp;<span class="ident" id="5078911">enc</span><span class="op" id="5078914">.</span><span class="ident" id="5078915">newEncoderState</span><span class="op" id="5078930">(</span><span class="ident" id="5078931">b</span><span class="op" id="5078932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078935">state</span><span class="op" id="5078940">.</span><span class="ident" id="5078941">fieldnum</span>&nbsp;<span class="op" id="5078950">=</span>&nbsp;<span class="op" id="5078952">-</span><span class="num" id="5078953">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078956">state</span><span class="op" id="5078961">.</span><span class="ident" id="5078962">sendZero</span>&nbsp;<span class="op" id="5078971">=</span>&nbsp;<span class="builtintype" id="5078973">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5078979">keys</span>&nbsp;<span class="op" id="5078984">:=</span>&nbsp;<span class="ident" id="5078987">mv</span><span class="op" id="5078989">.</span><span class="ident" id="5078990">MapKeys</span><span class="op" id="5078997">(</span><span class="op" id="5078998">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5079001">state</span><span class="op" id="5079006">.</span><span class="ident" id="5079007">encodeUint</span><span class="op" id="5079017">(</span><span class="ident" id="5079018">uint64</span><span class="op" id="5079024">(</span><span class="builtinfunc" id="5079025">len</span><span class="op" id="5079028">(</span><span class="ident" id="5079029">keys</span><span class="op" id="5079033">)</span><span class="op" id="5079034">)</span><span class="op" id="5079035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5079038">for</span>&nbsp;<span class="ident" id="5079042">_</span><span class="op" id="5079043">,</span>&nbsp;<span class="ident" id="5079045">key</span>&nbsp;<span class="op" id="5079049">:=</span>&nbsp;<span class="keyword" id="5079052">range</span>&nbsp;<span class="ident" id="5079058">keys</span>&nbsp;<span class="op" id="5079063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5079067">encodeReflectValue</span><span class="op" id="5079085">(</span><span class="ident" id="5079086">state</span><span class="op" id="5079091">,</span>&nbsp;<span class="ident" id="5079093">key</span><span class="op" id="5079096">,</span>&nbsp;<span class="ident" id="5079098">keyOp</span><span class="op" id="5079103">,</span>&nbsp;<span class="ident" id="5079105">keyIndir</span><span class="op" id="5079113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5079117">encodeReflectValue</span><span class="op" id="5079135">(</span><span class="ident" id="5079136">state</span><span class="op" id="5079141">,</span>&nbsp;<span class="ident" id="5079143">mv</span><span class="op" id="5079145">.</span><span class="ident" id="5079146">MapIndex</span><span class="op" id="5079154">(</span><span class="ident" id="5079155">key</span><span class="op" id="5079158">)</span><span class="op" id="5079159">,</span>&nbsp;<span class="ident" id="5079161">elemOp</span><span class="op" id="5079167">,</span>&nbsp;<span class="ident" id="5079169">elemIndir</span><span class="op" id="5079178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5079181">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5079184">enc</span><span class="op" id="5079187">.</span><span class="ident" id="5079188">freeEncoderState</span><span class="op" id="5079204">(</span><span class="ident" id="5079205">state</span><span class="op" id="5079210">)</span><br>
<span class="lineno"></span><span class="op" id="5079212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5079215">//&nbsp;encodeInterface&nbsp;encodes&nbsp;the&nbsp;interface&nbsp;value&nbsp;iv.</span><br>
<span class="lineno"></span><span class="comment" id="5079266">//&nbsp;To&nbsp;send&nbsp;an&nbsp;interface,&nbsp;we&nbsp;send&nbsp;a&nbsp;string&nbsp;identifying&nbsp;the&nbsp;concrete&nbsp;type,&nbsp;followed</span><br>
<span class="lineno">375</span><span class="comment" id="5079348">//&nbsp;by&nbsp;the&nbsp;type&nbsp;identifier&nbsp;(which&nbsp;might&nbsp;require&nbsp;defining&nbsp;that&nbsp;type&nbsp;right&nbsp;now),&nbsp;followed</span><br>
<span class="lineno"></span><span class="comment" id="5079435">//&nbsp;by&nbsp;the&nbsp;concrete&nbsp;value.&nbsp;&nbsp;A&nbsp;nil&nbsp;value&nbsp;gets&nbsp;sent&nbsp;as&nbsp;the&nbsp;empty&nbsp;string&nbsp;for&nbsp;the&nbsp;name,</span><br>
<span class="lineno"></span><span class="comment" id="5079518">//&nbsp;followed&nbsp;by&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5079543">func</span>&nbsp;<span class="op" id="5079548">(</span><span class="ident" id="5079549">enc</span>&nbsp;<span class="op" id="5079553">*</span><span class="ident" id="5079554">Encoder</span><span class="op" id="5079561">)</span>&nbsp;<span class="ident" id="5079563">encodeInterface</span><span class="op" id="5079578">(</span><span class="ident" id="5079579">b</span>&nbsp;<span class="op" id="5079581">*</span><span class="ident" id="5079582">encBuffer</span><span class="op" id="5079591">,</span>&nbsp;<span class="ident" id="5079593">iv</span>&nbsp;<span class="ident" id="5079596">reflect</span><span class="op" id="5079603">.</span><span class="ident" id="5079604">Value</span><span class="op" id="5079609">)</span>&nbsp;<span class="op" id="5079611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5079614">//&nbsp;Gobs&nbsp;can&nbsp;encode&nbsp;nil&nbsp;interface&nbsp;values&nbsp;but&nbsp;not&nbsp;typed&nbsp;interface</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5079679">//&nbsp;values&nbsp;holding&nbsp;nil&nbsp;pointers,&nbsp;since&nbsp;nil&nbsp;pointers&nbsp;point&nbsp;to&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5079750">elem</span>&nbsp;<span class="op" id="5079755">:=</span>&nbsp;<span class="ident" id="5079758">iv</span><span class="op" id="5079760">.</span><span class="ident" id="5079761">Elem</span><span class="op" id="5079765">(</span><span class="op" id="5079766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5079769">if</span>&nbsp;<span class="ident" id="5079772">elem</span><span class="op" id="5079776">.</span><span class="ident" id="5079777">Kind</span><span class="op" id="5079781">(</span><span class="op" id="5079782">)</span>&nbsp;<span class="op" id="5079784">==</span>&nbsp;<span class="ident" id="5079787">reflect</span><span class="op" id="5079794">.</span><span class="ident" id="5079795">Ptr</span>&nbsp;<span class="op" id="5079799">&amp;&amp;</span>&nbsp;<span class="ident" id="5079802">elem</span><span class="op" id="5079806">.</span><span class="ident" id="5079807">IsNil</span><span class="op" id="5079812">(</span><span class="op" id="5079813">)</span>&nbsp;<span class="op" id="5079815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5079819">errorf</span><span class="op" id="5079825">(</span><span class="string" id="5079826">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;%s&nbsp;inside&nbsp;interface&#34;</span><span class="op" id="5079886">,</span>&nbsp;<span class="ident" id="5079888">iv</span><span class="op" id="5079890">.</span><span class="ident" id="5079891">Elem</span><span class="op" id="5079895">(</span><span class="op" id="5079896">)</span><span class="op" id="5079897">.</span><span class="ident" id="5079898">Type</span><span class="op" id="5079902">(</span><span class="op" id="5079903">)</span><span class="op" id="5079904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5079907">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5079910">state</span>&nbsp;<span class="op" id="5079916">:=</span>&nbsp;<span class="ident" id="5079919">enc</span><span class="op" id="5079922">.</span><span class="ident" id="5079923">newEncoderState</span><span class="op" id="5079938">(</span><span class="ident" id="5079939">b</span><span class="op" id="5079940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5079943">state</span><span class="op" id="5079948">.</span><span class="ident" id="5079949">fieldnum</span>&nbsp;<span class="op" id="5079958">=</span>&nbsp;<span class="op" id="5079960">-</span><span class="num" id="5079961">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5079964">state</span><span class="op" id="5079969">.</span><span class="ident" id="5079970">sendZero</span>&nbsp;<span class="op" id="5079979">=</span>&nbsp;<span class="builtintype" id="5079981">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5079987">if</span>&nbsp;<span class="ident" id="5079990">iv</span><span class="op" id="5079992">.</span><span class="ident" id="5079993">IsNil</span><span class="op" id="5079998">(</span><span class="op" id="5079999">)</span>&nbsp;<span class="op" id="5080001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080005">state</span><span class="op" id="5080010">.</span><span class="ident" id="5080011">encodeUint</span><span class="op" id="5080021">(</span><span class="num" id="5080022">0</span><span class="op" id="5080023">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5080027">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5080035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080039">ut</span>&nbsp;<span class="op" id="5080042">:=</span>&nbsp;<span class="ident" id="5080045">userType</span><span class="op" id="5080053">(</span><span class="ident" id="5080054">iv</span><span class="op" id="5080056">.</span><span class="ident" id="5080057">Elem</span><span class="op" id="5080061">(</span><span class="op" id="5080062">)</span><span class="op" id="5080063">.</span><span class="ident" id="5080064">Type</span><span class="op" id="5080068">(</span><span class="op" id="5080069">)</span><span class="op" id="5080070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080073">registerLock</span><span class="op" id="5080085">.</span><span class="ident" id="5080086">RLock</span><span class="op" id="5080091">(</span><span class="op" id="5080092">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080095">name</span><span class="op" id="5080099">,</span>&nbsp;<span class="ident" id="5080101">ok</span>&nbsp;<span class="op" id="5080104">:=</span>&nbsp;<span class="ident" id="5080107">concreteTypeToName</span><span class="op" id="5080125">[</span><span class="ident" id="5080126">ut</span><span class="op" id="5080128">.</span><span class="ident" id="5080129">base</span><span class="op" id="5080133">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080136">registerLock</span><span class="op" id="5080148">.</span><span class="ident" id="5080149">RUnlock</span><span class="op" id="5080156">(</span><span class="op" id="5080157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5080160">if</span>&nbsp;<span class="op" id="5080163">!</span><span class="ident" id="5080164">ok</span>&nbsp;<span class="op" id="5080167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080171">errorf</span><span class="op" id="5080177">(</span><span class="string" id="5080178">&#34;type&nbsp;not&nbsp;registered&nbsp;for&nbsp;interface:&nbsp;%s&#34;</span><span class="op" id="5080217">,</span>&nbsp;<span class="ident" id="5080219">ut</span><span class="op" id="5080221">.</span><span class="ident" id="5080222">base</span><span class="op" id="5080226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5080229">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5080232">//&nbsp;Send&nbsp;the&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080251">state</span><span class="op" id="5080256">.</span><span class="ident" id="5080257">encodeUint</span><span class="op" id="5080267">(</span><span class="ident" id="5080268">uint64</span><span class="op" id="5080274">(</span><span class="builtinfunc" id="5080275">len</span><span class="op" id="5080278">(</span><span class="ident" id="5080279">name</span><span class="op" id="5080283">)</span><span class="op" id="5080284">)</span><span class="op" id="5080285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080288">state</span><span class="op" id="5080293">.</span><span class="ident" id="5080294">b</span><span class="op" id="5080295">.</span><span class="ident" id="5080296">WriteString</span><span class="op" id="5080307">(</span><span class="ident" id="5080308">name</span><span class="op" id="5080312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5080315">//&nbsp;Define&nbsp;the&nbsp;type&nbsp;id&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080352">enc</span><span class="op" id="5080355">.</span><span class="ident" id="5080356">sendTypeDescriptor</span><span class="op" id="5080374">(</span><span class="ident" id="5080375">enc</span><span class="op" id="5080378">.</span><span class="ident" id="5080379">writer</span><span class="op" id="5080385">(</span><span class="op" id="5080386">)</span><span class="op" id="5080387">,</span>&nbsp;<span class="ident" id="5080389">state</span><span class="op" id="5080394">,</span>&nbsp;<span class="ident" id="5080396">ut</span><span class="op" id="5080398">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5080401">//&nbsp;Send&nbsp;the&nbsp;type&nbsp;id.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080423">enc</span><span class="op" id="5080426">.</span><span class="ident" id="5080427">sendTypeId</span><span class="op" id="5080437">(</span><span class="ident" id="5080438">state</span><span class="op" id="5080443">,</span>&nbsp;<span class="ident" id="5080445">ut</span><span class="op" id="5080447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5080450">//&nbsp;Encode&nbsp;the&nbsp;value&nbsp;into&nbsp;a&nbsp;new&nbsp;buffer.&nbsp;&nbsp;Any&nbsp;nested&nbsp;type&nbsp;definitions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5080519">//&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;b,&nbsp;before&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080573">enc</span><span class="op" id="5080576">.</span><span class="ident" id="5080577">pushWriter</span><span class="op" id="5080587">(</span><span class="ident" id="5080588">b</span><span class="op" id="5080589">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080592">data</span>&nbsp;<span class="op" id="5080597">:=</span>&nbsp;<span class="builtinfunc" id="5080600">new</span><span class="op" id="5080603">(</span><span class="ident" id="5080604">encBuffer</span><span class="op" id="5080613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080616">data</span><span class="op" id="5080620">.</span><span class="ident" id="5080621">Write</span><span class="op" id="5080626">(</span><span class="ident" id="5080627">spaceForLength</span><span class="op" id="5080641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080644">enc</span><span class="op" id="5080647">.</span><span class="ident" id="5080648">encode</span><span class="op" id="5080654">(</span><span class="ident" id="5080655">data</span><span class="op" id="5080659">,</span>&nbsp;<span class="ident" id="5080661">elem</span><span class="op" id="5080665">,</span>&nbsp;<span class="ident" id="5080667">ut</span><span class="op" id="5080669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5080672">if</span>&nbsp;<span class="ident" id="5080675">enc</span><span class="op" id="5080678">.</span><span class="ident" id="5080679">err</span>&nbsp;<span class="op" id="5080683">!=</span>&nbsp;<span class="ident" id="5080686">nil</span>&nbsp;<span class="op" id="5080690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080694">error_</span><span class="op" id="5080700">(</span><span class="ident" id="5080701">enc</span><span class="op" id="5080704">.</span><span class="ident" id="5080705">err</span><span class="op" id="5080708">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5080711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080714">enc</span><span class="op" id="5080717">.</span><span class="ident" id="5080718">popWriter</span><span class="op" id="5080727">(</span><span class="op" id="5080728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080731">enc</span><span class="op" id="5080734">.</span><span class="ident" id="5080735">writeMessage</span><span class="op" id="5080747">(</span><span class="ident" id="5080748">b</span><span class="op" id="5080749">,</span>&nbsp;<span class="ident" id="5080751">data</span><span class="op" id="5080755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5080758">if</span>&nbsp;<span class="ident" id="5080761">enc</span><span class="op" id="5080764">.</span><span class="ident" id="5080765">err</span>&nbsp;<span class="op" id="5080769">!=</span>&nbsp;<span class="ident" id="5080772">nil</span>&nbsp;<span class="op" id="5080776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080780">error_</span><span class="op" id="5080786">(</span><span class="ident" id="5080787">enc</span><span class="op" id="5080790">.</span><span class="ident" id="5080791">err</span><span class="op" id="5080794">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5080797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5080800">enc</span><span class="op" id="5080803">.</span><span class="ident" id="5080804">freeEncoderState</span><span class="op" id="5080820">(</span><span class="ident" id="5080821">state</span><span class="op" id="5080826">)</span><br>
<span class="lineno"></span><span class="op" id="5080828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5080831">//&nbsp;isZero&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;the&nbsp;zero&nbsp;of&nbsp;its&nbsp;type.</span><br>
<span class="lineno">425</span><span class="keyword" id="5080892">func</span>&nbsp;<span class="ident" id="5080897">isZero</span><span class="op" id="5080903">(</span><span class="ident" id="5080904">val</span>&nbsp;<span class="ident" id="5080908">reflect</span><span class="op" id="5080915">.</span><span class="ident" id="5080916">Value</span><span class="op" id="5080921">)</span>&nbsp;<span class="builtintype" id="5080923">bool</span>&nbsp;<span class="op" id="5080928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5080931">switch</span>&nbsp;<span class="ident" id="5080938">val</span><span class="op" id="5080941">.</span><span class="ident" id="5080942">Kind</span><span class="op" id="5080946">(</span><span class="op" id="5080947">)</span>&nbsp;<span class="op" id="5080949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5080952">case</span>&nbsp;<span class="ident" id="5080957">reflect</span><span class="op" id="5080964">.</span><span class="ident" id="5080965">Array</span><span class="op" id="5080970">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5080974">for</span>&nbsp;<span class="ident" id="5080978">i</span>&nbsp;<span class="op" id="5080980">:=</span>&nbsp;<span class="num" id="5080983">0</span><span class="op" id="5080984">;</span>&nbsp;<span class="ident" id="5080986">i</span>&nbsp;<span class="op" id="5080988">&lt;</span>&nbsp;<span class="ident" id="5080990">val</span><span class="op" id="5080993">.</span><span class="ident" id="5080994">Len</span><span class="op" id="5080997">(</span><span class="op" id="5080998">)</span><span class="op" id="5080999">;</span>&nbsp;<span class="ident" id="5081001">i</span><span class="op" id="5081002">++</span>&nbsp;<span class="op" id="5081005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081010">if</span>&nbsp;<span class="op" id="5081013">!</span><span class="ident" id="5081014">isZero</span><span class="op" id="5081020">(</span><span class="ident" id="5081021">val</span><span class="op" id="5081024">.</span><span class="ident" id="5081025">Index</span><span class="op" id="5081030">(</span><span class="ident" id="5081031">i</span><span class="op" id="5081032">)</span><span class="op" id="5081033">)</span>&nbsp;<span class="op" id="5081035">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081041">return</span>&nbsp;<span class="builtintype" id="5081048">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5081057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5081061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081065">return</span>&nbsp;<span class="builtintype" id="5081072">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081078">case</span>&nbsp;<span class="ident" id="5081083">reflect</span><span class="op" id="5081090">.</span><span class="ident" id="5081091">Map</span><span class="op" id="5081094">,</span>&nbsp;<span class="ident" id="5081096">reflect</span><span class="op" id="5081103">.</span><span class="ident" id="5081104">Slice</span><span class="op" id="5081109">,</span>&nbsp;<span class="ident" id="5081111">reflect</span><span class="op" id="5081118">.</span><span class="ident" id="5081119">String</span><span class="op" id="5081125">:</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081129">return</span>&nbsp;<span class="ident" id="5081136">val</span><span class="op" id="5081139">.</span><span class="ident" id="5081140">Len</span><span class="op" id="5081143">(</span><span class="op" id="5081144">)</span>&nbsp;<span class="op" id="5081146">==</span>&nbsp;<span class="num" id="5081149">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081152">case</span>&nbsp;<span class="ident" id="5081157">reflect</span><span class="op" id="5081164">.</span><span class="ident" id="5081165">Bool</span><span class="op" id="5081169">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081173">return</span>&nbsp;<span class="op" id="5081180">!</span><span class="ident" id="5081181">val</span><span class="op" id="5081184">.</span><span class="ident" id="5081185">Bool</span><span class="op" id="5081189">(</span><span class="op" id="5081190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081193">case</span>&nbsp;<span class="ident" id="5081198">reflect</span><span class="op" id="5081205">.</span><span class="ident" id="5081206">Complex64</span><span class="op" id="5081215">,</span>&nbsp;<span class="ident" id="5081217">reflect</span><span class="op" id="5081224">.</span><span class="ident" id="5081225">Complex128</span><span class="op" id="5081235">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081239">return</span>&nbsp;<span class="ident" id="5081246">val</span><span class="op" id="5081249">.</span><span class="ident" id="5081250">Complex</span><span class="op" id="5081257">(</span><span class="op" id="5081258">)</span>&nbsp;<span class="op" id="5081260">==</span>&nbsp;<span class="num" id="5081263">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081266">case</span>&nbsp;<span class="ident" id="5081271">reflect</span><span class="op" id="5081278">.</span><span class="ident" id="5081279">Chan</span><span class="op" id="5081283">,</span>&nbsp;<span class="ident" id="5081285">reflect</span><span class="op" id="5081292">.</span><span class="ident" id="5081293">Func</span><span class="op" id="5081297">,</span>&nbsp;<span class="ident" id="5081299">reflect</span><span class="op" id="5081306">.</span><span class="ident" id="5081307">Interface</span><span class="op" id="5081316">,</span>&nbsp;<span class="ident" id="5081318">reflect</span><span class="op" id="5081325">.</span><span class="ident" id="5081326">Ptr</span><span class="op" id="5081329">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081333">return</span>&nbsp;<span class="ident" id="5081340">val</span><span class="op" id="5081343">.</span><span class="ident" id="5081344">IsNil</span><span class="op" id="5081349">(</span><span class="op" id="5081350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081353">case</span>&nbsp;<span class="ident" id="5081358">reflect</span><span class="op" id="5081365">.</span><span class="ident" id="5081366">Int</span><span class="op" id="5081369">,</span>&nbsp;<span class="ident" id="5081371">reflect</span><span class="op" id="5081378">.</span><span class="ident" id="5081379">Int8</span><span class="op" id="5081383">,</span>&nbsp;<span class="ident" id="5081385">reflect</span><span class="op" id="5081392">.</span><span class="ident" id="5081393">Int16</span><span class="op" id="5081398">,</span>&nbsp;<span class="ident" id="5081400">reflect</span><span class="op" id="5081407">.</span><span class="ident" id="5081408">Int32</span><span class="op" id="5081413">,</span>&nbsp;<span class="ident" id="5081415">reflect</span><span class="op" id="5081422">.</span><span class="ident" id="5081423">Int64</span><span class="op" id="5081428">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081432">return</span>&nbsp;<span class="ident" id="5081439">val</span><span class="op" id="5081442">.</span><span class="ident" id="5081443">Int</span><span class="op" id="5081446">(</span><span class="op" id="5081447">)</span>&nbsp;<span class="op" id="5081449">==</span>&nbsp;<span class="num" id="5081452">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081455">case</span>&nbsp;<span class="ident" id="5081460">reflect</span><span class="op" id="5081467">.</span><span class="ident" id="5081468">Float32</span><span class="op" id="5081475">,</span>&nbsp;<span class="ident" id="5081477">reflect</span><span class="op" id="5081484">.</span><span class="ident" id="5081485">Float64</span><span class="op" id="5081492">:</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081496">return</span>&nbsp;<span class="ident" id="5081503">val</span><span class="op" id="5081506">.</span><span class="ident" id="5081507">Float</span><span class="op" id="5081512">(</span><span class="op" id="5081513">)</span>&nbsp;<span class="op" id="5081515">==</span>&nbsp;<span class="num" id="5081518">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081521">case</span>&nbsp;<span class="ident" id="5081526">reflect</span><span class="op" id="5081533">.</span><span class="ident" id="5081534">Uint</span><span class="op" id="5081538">,</span>&nbsp;<span class="ident" id="5081540">reflect</span><span class="op" id="5081547">.</span><span class="ident" id="5081548">Uint8</span><span class="op" id="5081553">,</span>&nbsp;<span class="ident" id="5081555">reflect</span><span class="op" id="5081562">.</span><span class="ident" id="5081563">Uint16</span><span class="op" id="5081569">,</span>&nbsp;<span class="ident" id="5081571">reflect</span><span class="op" id="5081578">.</span><span class="ident" id="5081579">Uint32</span><span class="op" id="5081585">,</span>&nbsp;<span class="ident" id="5081587">reflect</span><span class="op" id="5081594">.</span><span class="ident" id="5081595">Uint64</span><span class="op" id="5081601">,</span>&nbsp;<span class="ident" id="5081603">reflect</span><span class="op" id="5081610">.</span><span class="ident" id="5081611">Uintptr</span><span class="op" id="5081618">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081622">return</span>&nbsp;<span class="ident" id="5081629">val</span><span class="op" id="5081632">.</span><span class="ident" id="5081633">Uint</span><span class="op" id="5081637">(</span><span class="op" id="5081638">)</span>&nbsp;<span class="op" id="5081640">==</span>&nbsp;<span class="num" id="5081643">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081646">case</span>&nbsp;<span class="ident" id="5081651">reflect</span><span class="op" id="5081658">.</span><span class="ident" id="5081659">Struct</span><span class="op" id="5081665">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081669">for</span>&nbsp;<span class="ident" id="5081673">i</span>&nbsp;<span class="op" id="5081675">:=</span>&nbsp;<span class="num" id="5081678">0</span><span class="op" id="5081679">;</span>&nbsp;<span class="ident" id="5081681">i</span>&nbsp;<span class="op" id="5081683">&lt;</span>&nbsp;<span class="ident" id="5081685">val</span><span class="op" id="5081688">.</span><span class="ident" id="5081689">NumField</span><span class="op" id="5081697">(</span><span class="op" id="5081698">)</span><span class="op" id="5081699">;</span>&nbsp;<span class="ident" id="5081701">i</span><span class="op" id="5081702">++</span>&nbsp;<span class="op" id="5081705">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081710">if</span>&nbsp;<span class="op" id="5081713">!</span><span class="ident" id="5081714">isZero</span><span class="op" id="5081720">(</span><span class="ident" id="5081721">val</span><span class="op" id="5081724">.</span><span class="ident" id="5081725">Field</span><span class="op" id="5081730">(</span><span class="ident" id="5081731">i</span><span class="op" id="5081732">)</span><span class="op" id="5081733">)</span>&nbsp;<span class="op" id="5081735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081741">return</span>&nbsp;<span class="builtintype" id="5081748">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5081757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5081761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5081765">return</span>&nbsp;<span class="builtintype" id="5081772">true</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5081778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5081781">panic</span><span class="op" id="5081786">(</span><span class="string" id="5081787">&#34;unknown&nbsp;type&nbsp;in&nbsp;isZero&nbsp;&#34;</span>&nbsp;<span class="op" id="5081813">+</span>&nbsp;<span class="ident" id="5081815">val</span><span class="op" id="5081818">.</span><span class="ident" id="5081819">Type</span><span class="op" id="5081823">(</span><span class="op" id="5081824">)</span><span class="op" id="5081825">.</span><span class="ident" id="5081826">String</span><span class="op" id="5081832">(</span><span class="op" id="5081833">)</span><span class="op" id="5081834">)</span><br>
<span class="lineno"></span><span class="op" id="5081836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5081839">//&nbsp;encGobEncoder&nbsp;encodes&nbsp;a&nbsp;value&nbsp;that&nbsp;implements&nbsp;the&nbsp;GobEncoder&nbsp;interface.</span><br>
<span class="lineno">460</span><span class="comment" id="5081914">//&nbsp;The&nbsp;data&nbsp;is&nbsp;sent&nbsp;as&nbsp;a&nbsp;byte&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="5081951">func</span>&nbsp;<span class="op" id="5081956">(</span><span class="ident" id="5081957">enc</span>&nbsp;<span class="op" id="5081961">*</span><span class="ident" id="5081962">Encoder</span><span class="op" id="5081969">)</span>&nbsp;<span class="ident" id="5081971">encodeGobEncoder</span><span class="op" id="5081987">(</span><span class="ident" id="5081988">b</span>&nbsp;<span class="op" id="5081990">*</span><span class="ident" id="5081991">encBuffer</span><span class="op" id="5082000">,</span>&nbsp;<span class="ident" id="5082002">ut</span>&nbsp;<span class="op" id="5082005">*</span><span class="ident" id="5082006">userTypeInfo</span><span class="op" id="5082018">,</span>&nbsp;<span class="ident" id="5082020">v</span>&nbsp;<span class="ident" id="5082022">reflect</span><span class="op" id="5082029">.</span><span class="ident" id="5082030">Value</span><span class="op" id="5082035">)</span>&nbsp;<span class="op" id="5082037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5082040">//&nbsp;TODO:&nbsp;should&nbsp;we&nbsp;catch&nbsp;panics&nbsp;from&nbsp;the&nbsp;called&nbsp;method?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5082098">var</span>&nbsp;<span class="ident" id="5082102">data</span>&nbsp;<span class="op" id="5082107">[</span><span class="op" id="5082108">]</span><span class="builtintype" id="5082109">byte</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5082115">var</span>&nbsp;<span class="ident" id="5082119">err</span>&nbsp;<span class="builtintype" id="5082123">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5082130">//&nbsp;We&nbsp;know&nbsp;it&#39;s&nbsp;one&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5082161">switch</span>&nbsp;<span class="ident" id="5082168">ut</span><span class="op" id="5082170">.</span><span class="ident" id="5082171">externalEnc</span>&nbsp;<span class="op" id="5082183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5082186">case</span>&nbsp;<span class="ident" id="5082191">xGob</span><span class="op" id="5082195">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082199">data</span><span class="op" id="5082203">,</span>&nbsp;<span class="ident" id="5082205">err</span>&nbsp;<span class="op" id="5082209">=</span>&nbsp;<span class="ident" id="5082211">v</span><span class="op" id="5082212">.</span><span class="ident" id="5082213">Interface</span><span class="op" id="5082222">(</span><span class="op" id="5082223">)</span><span class="op" id="5082224">.</span><span class="op" id="5082225">(</span><span class="ident" id="5082226">GobEncoder</span><span class="op" id="5082236">)</span><span class="op" id="5082237">.</span><span class="ident" id="5082238">GobEncode</span><span class="op" id="5082247">(</span><span class="op" id="5082248">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5082251">case</span>&nbsp;<span class="ident" id="5082256">xBinary</span><span class="op" id="5082263">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082267">data</span><span class="op" id="5082271">,</span>&nbsp;<span class="ident" id="5082273">err</span>&nbsp;<span class="op" id="5082277">=</span>&nbsp;<span class="ident" id="5082279">v</span><span class="op" id="5082280">.</span><span class="ident" id="5082281">Interface</span><span class="op" id="5082290">(</span><span class="op" id="5082291">)</span><span class="op" id="5082292">.</span><span class="op" id="5082293">(</span><span class="ident" id="5082294">encoding</span><span class="op" id="5082302">.</span><span class="ident" id="5082303">BinaryMarshaler</span><span class="op" id="5082318">)</span><span class="op" id="5082319">.</span><span class="ident" id="5082320">MarshalBinary</span><span class="op" id="5082333">(</span><span class="op" id="5082334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5082337">case</span>&nbsp;<span class="ident" id="5082342">xText</span><span class="op" id="5082347">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082351">data</span><span class="op" id="5082355">,</span>&nbsp;<span class="ident" id="5082357">err</span>&nbsp;<span class="op" id="5082361">=</span>&nbsp;<span class="ident" id="5082363">v</span><span class="op" id="5082364">.</span><span class="ident" id="5082365">Interface</span><span class="op" id="5082374">(</span><span class="op" id="5082375">)</span><span class="op" id="5082376">.</span><span class="op" id="5082377">(</span><span class="ident" id="5082378">encoding</span><span class="op" id="5082386">.</span><span class="ident" id="5082387">TextMarshaler</span><span class="op" id="5082400">)</span><span class="op" id="5082401">.</span><span class="ident" id="5082402">MarshalText</span><span class="op" id="5082413">(</span><span class="op" id="5082414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5082417">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5082420">if</span>&nbsp;<span class="ident" id="5082423">err</span>&nbsp;<span class="op" id="5082427">!=</span>&nbsp;<span class="ident" id="5082430">nil</span>&nbsp;<span class="op" id="5082434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082438">error_</span><span class="op" id="5082444">(</span><span class="ident" id="5082445">err</span><span class="op" id="5082448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5082451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082454">state</span>&nbsp;<span class="op" id="5082460">:=</span>&nbsp;<span class="ident" id="5082463">enc</span><span class="op" id="5082466">.</span><span class="ident" id="5082467">newEncoderState</span><span class="op" id="5082482">(</span><span class="ident" id="5082483">b</span><span class="op" id="5082484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082487">state</span><span class="op" id="5082492">.</span><span class="ident" id="5082493">fieldnum</span>&nbsp;<span class="op" id="5082502">=</span>&nbsp;<span class="op" id="5082504">-</span><span class="num" id="5082505">1</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082508">state</span><span class="op" id="5082513">.</span><span class="ident" id="5082514">encodeUint</span><span class="op" id="5082524">(</span><span class="ident" id="5082525">uint64</span><span class="op" id="5082531">(</span><span class="builtinfunc" id="5082532">len</span><span class="op" id="5082535">(</span><span class="ident" id="5082536">data</span><span class="op" id="5082540">)</span><span class="op" id="5082541">)</span><span class="op" id="5082542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082545">state</span><span class="op" id="5082550">.</span><span class="ident" id="5082551">b</span><span class="op" id="5082552">.</span><span class="ident" id="5082553">Write</span><span class="op" id="5082558">(</span><span class="ident" id="5082559">data</span><span class="op" id="5082563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082566">enc</span><span class="op" id="5082569">.</span><span class="ident" id="5082570">freeEncoderState</span><span class="op" id="5082586">(</span><span class="ident" id="5082587">state</span><span class="op" id="5082592">)</span><br>
<span class="lineno"></span><span class="op" id="5082594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span><span class="keyword" id="5082597">var</span>&nbsp;<span class="ident" id="5082601">encOpTable</span>&nbsp;<span class="op" id="5082612">=</span>&nbsp;<span class="op" id="5082614">[</span><span class="op" id="5082615">...</span><span class="op" id="5082618">]</span><span class="ident" id="5082619">encOp</span><span class="op" id="5082624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082627">reflect</span><span class="op" id="5082634">.</span><span class="ident" id="5082635">Bool</span><span class="op" id="5082639">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5082647">encBool</span><span class="op" id="5082654">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082657">reflect</span><span class="op" id="5082664">.</span><span class="ident" id="5082665">Int</span><span class="op" id="5082668">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5082677">encInt</span><span class="op" id="5082683">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082686">reflect</span><span class="op" id="5082693">.</span><span class="ident" id="5082694">Int8</span><span class="op" id="5082698">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5082706">encInt</span><span class="op" id="5082712">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082715">reflect</span><span class="op" id="5082722">.</span><span class="ident" id="5082723">Int16</span><span class="op" id="5082728">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5082735">encInt</span><span class="op" id="5082741">,</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082744">reflect</span><span class="op" id="5082751">.</span><span class="ident" id="5082752">Int32</span><span class="op" id="5082757">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5082764">encInt</span><span class="op" id="5082770">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082773">reflect</span><span class="op" id="5082780">.</span><span class="ident" id="5082781">Int64</span><span class="op" id="5082786">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5082793">encInt</span><span class="op" id="5082799">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082802">reflect</span><span class="op" id="5082809">.</span><span class="ident" id="5082810">Uint</span><span class="op" id="5082814">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5082822">encUint</span><span class="op" id="5082829">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082832">reflect</span><span class="op" id="5082839">.</span><span class="ident" id="5082840">Uint8</span><span class="op" id="5082845">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5082852">encUint</span><span class="op" id="5082859">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082862">reflect</span><span class="op" id="5082869">.</span><span class="ident" id="5082870">Uint16</span><span class="op" id="5082876">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5082882">encUint</span><span class="op" id="5082889">,</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082892">reflect</span><span class="op" id="5082899">.</span><span class="ident" id="5082900">Uint32</span><span class="op" id="5082906">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5082912">encUint</span><span class="op" id="5082919">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082922">reflect</span><span class="op" id="5082929">.</span><span class="ident" id="5082930">Uint64</span><span class="op" id="5082936">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5082942">encUint</span><span class="op" id="5082949">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082952">reflect</span><span class="op" id="5082959">.</span><span class="ident" id="5082960">Uintptr</span><span class="op" id="5082967">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5082972">encUint</span><span class="op" id="5082979">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5082982">reflect</span><span class="op" id="5082989">.</span><span class="ident" id="5082990">Float32</span><span class="op" id="5082997">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5083002">encFloat</span><span class="op" id="5083010">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5083013">reflect</span><span class="op" id="5083020">.</span><span class="ident" id="5083021">Float64</span><span class="op" id="5083028">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5083033">encFloat</span><span class="op" id="5083041">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5083044">reflect</span><span class="op" id="5083051">.</span><span class="ident" id="5083052">Complex64</span><span class="op" id="5083061">:</span>&nbsp;&nbsp;<span class="ident" id="5083064">encComplex</span><span class="op" id="5083074">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5083077">reflect</span><span class="op" id="5083084">.</span><span class="ident" id="5083085">Complex128</span><span class="op" id="5083095">:</span>&nbsp;<span class="ident" id="5083097">encComplex</span><span class="op" id="5083107">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5083110">reflect</span><span class="op" id="5083117">.</span><span class="ident" id="5083118">String</span><span class="op" id="5083124">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5083130">encString</span><span class="op" id="5083139">,</span><br>
<span class="lineno"></span><span class="op" id="5083141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="comment" id="5083144">//&nbsp;encOpFor&nbsp;returns&nbsp;(a&nbsp;pointer&nbsp;to)&nbsp;the&nbsp;encoding&nbsp;op&nbsp;for&nbsp;the&nbsp;base&nbsp;type&nbsp;under&nbsp;rt&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5083226">//&nbsp;the&nbsp;indirection&nbsp;count&nbsp;to&nbsp;reach&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5083264">func</span>&nbsp;<span class="ident" id="5083269">encOpFor</span><span class="op" id="5083277">(</span><span class="ident" id="5083278">rt</span>&nbsp;<span class="ident" id="5083281">reflect</span><span class="op" id="5083288">.</span><span class="ident" id="5083289">Type</span><span class="op" id="5083293">,</span>&nbsp;<span class="ident" id="5083295">inProgress</span>&nbsp;<span class="keyword" id="5083306">map</span><span class="op" id="5083309">[</span><span class="ident" id="5083310">reflect</span><span class="op" id="5083317">.</span><span class="ident" id="5083318">Type</span><span class="op" id="5083322">]</span><span class="op" id="5083323">*</span><span class="ident" id="5083324">encOp</span><span class="op" id="5083329">,</span>&nbsp;<span class="ident" id="5083331">building</span>&nbsp;<span class="keyword" id="5083340">map</span><span class="op" id="5083343">[</span><span class="op" id="5083344">*</span><span class="ident" id="5083345">typeInfo</span><span class="op" id="5083353">]</span><span class="builtintype" id="5083354">bool</span><span class="op" id="5083358">)</span>&nbsp;<span class="op" id="5083360">(</span><span class="op" id="5083361">*</span><span class="ident" id="5083362">encOp</span><span class="op" id="5083367">,</span>&nbsp;<span class="builtintype" id="5083369">int</span><span class="op" id="5083372">)</span>&nbsp;<span class="op" id="5083374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5083377">ut</span>&nbsp;<span class="op" id="5083380">:=</span>&nbsp;<span class="ident" id="5083383">userType</span><span class="op" id="5083391">(</span><span class="ident" id="5083392">rt</span><span class="op" id="5083394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5083397">//&nbsp;If&nbsp;the&nbsp;type&nbsp;implements&nbsp;GobEncoder,&nbsp;we&nbsp;handle&nbsp;it&nbsp;without&nbsp;further&nbsp;processing.</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5083477">if</span>&nbsp;<span class="ident" id="5083480">ut</span><span class="op" id="5083482">.</span><span class="ident" id="5083483">externalEnc</span>&nbsp;<span class="op" id="5083495">!=</span>&nbsp;<span class="num" id="5083498">0</span>&nbsp;<span class="op" id="5083500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5083504">return</span>&nbsp;<span class="ident" id="5083511">gobEncodeOpFor</span><span class="op" id="5083525">(</span><span class="ident" id="5083526">ut</span><span class="op" id="5083528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5083531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5083534">//&nbsp;If&nbsp;this&nbsp;type&nbsp;is&nbsp;already&nbsp;in&nbsp;progress,&nbsp;it&#39;s&nbsp;a&nbsp;recursive&nbsp;type&nbsp;(e.g.&nbsp;map[string]*T).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5083619">//&nbsp;Return&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;op&nbsp;we&#39;re&nbsp;already&nbsp;building.</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5083676">if</span>&nbsp;<span class="ident" id="5083679">opPtr</span>&nbsp;<span class="op" id="5083685">:=</span>&nbsp;<span class="ident" id="5083688">inProgress</span><span class="op" id="5083698">[</span><span class="ident" id="5083699">rt</span><span class="op" id="5083701">]</span><span class="op" id="5083702">;</span>&nbsp;<span class="ident" id="5083704">opPtr</span>&nbsp;<span class="op" id="5083710">!=</span>&nbsp;<span class="ident" id="5083713">nil</span>&nbsp;<span class="op" id="5083717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5083721">return</span>&nbsp;<span class="ident" id="5083728">opPtr</span><span class="op" id="5083733">,</span>&nbsp;<span class="ident" id="5083735">ut</span><span class="op" id="5083737">.</span><span class="ident" id="5083738">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5083745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5083748">typ</span>&nbsp;<span class="op" id="5083752">:=</span>&nbsp;<span class="ident" id="5083755">ut</span><span class="op" id="5083757">.</span><span class="ident" id="5083758">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5083764">indir</span>&nbsp;<span class="op" id="5083770">:=</span>&nbsp;<span class="ident" id="5083773">ut</span><span class="op" id="5083775">.</span><span class="ident" id="5083776">indir</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5083783">k</span>&nbsp;<span class="op" id="5083785">:=</span>&nbsp;<span class="ident" id="5083788">typ</span><span class="op" id="5083791">.</span><span class="ident" id="5083792">Kind</span><span class="op" id="5083796">(</span><span class="op" id="5083797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5083800">var</span>&nbsp;<span class="ident" id="5083804">op</span>&nbsp;<span class="ident" id="5083807">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5083814">if</span>&nbsp;<span class="builtintype" id="5083817">int</span><span class="op" id="5083820">(</span><span class="ident" id="5083821">k</span><span class="op" id="5083822">)</span>&nbsp;<span class="op" id="5083824">&lt;</span>&nbsp;<span class="builtinfunc" id="5083826">len</span><span class="op" id="5083829">(</span><span class="ident" id="5083830">encOpTable</span><span class="op" id="5083840">)</span>&nbsp;<span class="op" id="5083842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5083846">op</span>&nbsp;<span class="op" id="5083849">=</span>&nbsp;<span class="ident" id="5083851">encOpTable</span><span class="op" id="5083861">[</span><span class="ident" id="5083862">k</span><span class="op" id="5083863">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5083866">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5083869">if</span>&nbsp;<span class="ident" id="5083872">op</span>&nbsp;<span class="op" id="5083875">==</span>&nbsp;<span class="ident" id="5083878">nil</span>&nbsp;<span class="op" id="5083882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5083886">inProgress</span><span class="op" id="5083896">[</span><span class="ident" id="5083897">rt</span><span class="op" id="5083899">]</span>&nbsp;<span class="op" id="5083901">=</span>&nbsp;<span class="op" id="5083903">&amp;</span><span class="ident" id="5083904">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5083909">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5083928">switch</span>&nbsp;<span class="ident" id="5083935">t</span>&nbsp;<span class="op" id="5083937">:=</span>&nbsp;<span class="ident" id="5083940">typ</span><span class="op" id="5083943">;</span>&nbsp;<span class="ident" id="5083945">t</span><span class="op" id="5083946">.</span><span class="ident" id="5083947">Kind</span><span class="op" id="5083951">(</span><span class="op" id="5083952">)</span>&nbsp;<span class="op" id="5083954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5083958">case</span>&nbsp;<span class="ident" id="5083963">reflect</span><span class="op" id="5083970">.</span><span class="ident" id="5083971">Slice</span><span class="op" id="5083976">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5083981">if</span>&nbsp;<span class="ident" id="5083984">t</span><span class="op" id="5083985">.</span><span class="ident" id="5083986">Elem</span><span class="op" id="5083990">(</span><span class="op" id="5083991">)</span><span class="op" id="5083992">.</span><span class="ident" id="5083993">Kind</span><span class="op" id="5083997">(</span><span class="op" id="5083998">)</span>&nbsp;<span class="op" id="5084000">==</span>&nbsp;<span class="ident" id="5084003">reflect</span><span class="op" id="5084010">.</span><span class="ident" id="5084011">Uint8</span>&nbsp;<span class="op" id="5084017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084023">op</span>&nbsp;<span class="op" id="5084026">=</span>&nbsp;<span class="ident" id="5084028">encUint8Array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5084046">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5084055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5084060">//&nbsp;Slices&nbsp;have&nbsp;a&nbsp;header;&nbsp;we&nbsp;decode&nbsp;it&nbsp;to&nbsp;find&nbsp;the&nbsp;underlying&nbsp;array.</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084131">elemOp</span><span class="op" id="5084137">,</span>&nbsp;<span class="ident" id="5084139">elemIndir</span>&nbsp;<span class="op" id="5084149">:=</span>&nbsp;<span class="ident" id="5084152">encOpFor</span><span class="op" id="5084160">(</span><span class="ident" id="5084161">t</span><span class="op" id="5084162">.</span><span class="ident" id="5084163">Elem</span><span class="op" id="5084167">(</span><span class="op" id="5084168">)</span><span class="op" id="5084169">,</span>&nbsp;<span class="ident" id="5084171">inProgress</span><span class="op" id="5084181">,</span>&nbsp;<span class="ident" id="5084183">building</span><span class="op" id="5084191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084196">helper</span>&nbsp;<span class="op" id="5084203">:=</span>&nbsp;<span class="ident" id="5084206">encSliceHelper</span><span class="op" id="5084220">[</span><span class="ident" id="5084221">t</span><span class="op" id="5084222">.</span><span class="ident" id="5084223">Elem</span><span class="op" id="5084227">(</span><span class="op" id="5084228">)</span><span class="op" id="5084229">.</span><span class="ident" id="5084230">Kind</span><span class="op" id="5084234">(</span><span class="op" id="5084235">)</span><span class="op" id="5084236">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084241">op</span>&nbsp;<span class="op" id="5084244">=</span>&nbsp;<span class="keyword" id="5084246">func</span><span class="op" id="5084250">(</span><span class="ident" id="5084251">i</span>&nbsp;<span class="op" id="5084253">*</span><span class="ident" id="5084254">encInstr</span><span class="op" id="5084262">,</span>&nbsp;<span class="ident" id="5084264">state</span>&nbsp;<span class="op" id="5084270">*</span><span class="ident" id="5084271">encoderState</span><span class="op" id="5084283">,</span>&nbsp;<span class="ident" id="5084285">slice</span>&nbsp;<span class="ident" id="5084291">reflect</span><span class="op" id="5084298">.</span><span class="ident" id="5084299">Value</span><span class="op" id="5084304">)</span>&nbsp;<span class="op" id="5084306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5084312">if</span>&nbsp;<span class="op" id="5084315">!</span><span class="ident" id="5084316">state</span><span class="op" id="5084321">.</span><span class="ident" id="5084322">sendZero</span>&nbsp;<span class="op" id="5084331">&amp;&amp;</span>&nbsp;<span class="ident" id="5084334">slice</span><span class="op" id="5084339">.</span><span class="ident" id="5084340">Len</span><span class="op" id="5084343">(</span><span class="op" id="5084344">)</span>&nbsp;<span class="op" id="5084346">==</span>&nbsp;<span class="num" id="5084349">0</span>&nbsp;<span class="op" id="5084351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5084358">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5084369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084375">state</span><span class="op" id="5084380">.</span><span class="ident" id="5084381">update</span><span class="op" id="5084387">(</span><span class="ident" id="5084388">i</span><span class="op" id="5084389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084395">state</span><span class="op" id="5084400">.</span><span class="ident" id="5084401">enc</span><span class="op" id="5084404">.</span><span class="ident" id="5084405">encodeArray</span><span class="op" id="5084416">(</span><span class="ident" id="5084417">state</span><span class="op" id="5084422">.</span><span class="ident" id="5084423">b</span><span class="op" id="5084424">,</span>&nbsp;<span class="ident" id="5084426">slice</span><span class="op" id="5084431">,</span>&nbsp;<span class="op" id="5084433">*</span><span class="ident" id="5084434">elemOp</span><span class="op" id="5084440">,</span>&nbsp;<span class="ident" id="5084442">elemIndir</span><span class="op" id="5084451">,</span>&nbsp;<span class="ident" id="5084453">slice</span><span class="op" id="5084458">.</span><span class="ident" id="5084459">Len</span><span class="op" id="5084462">(</span><span class="op" id="5084463">)</span><span class="op" id="5084464">,</span>&nbsp;<span class="ident" id="5084466">helper</span><span class="op" id="5084472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5084477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5084481">case</span>&nbsp;<span class="ident" id="5084486">reflect</span><span class="op" id="5084493">.</span><span class="ident" id="5084494">Array</span><span class="op" id="5084499">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5084504">//&nbsp;True&nbsp;arrays&nbsp;have&nbsp;size&nbsp;in&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084545">elemOp</span><span class="op" id="5084551">,</span>&nbsp;<span class="ident" id="5084553">elemIndir</span>&nbsp;<span class="op" id="5084563">:=</span>&nbsp;<span class="ident" id="5084566">encOpFor</span><span class="op" id="5084574">(</span><span class="ident" id="5084575">t</span><span class="op" id="5084576">.</span><span class="ident" id="5084577">Elem</span><span class="op" id="5084581">(</span><span class="op" id="5084582">)</span><span class="op" id="5084583">,</span>&nbsp;<span class="ident" id="5084585">inProgress</span><span class="op" id="5084595">,</span>&nbsp;<span class="ident" id="5084597">building</span><span class="op" id="5084605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084610">helper</span>&nbsp;<span class="op" id="5084617">:=</span>&nbsp;<span class="ident" id="5084620">encArrayHelper</span><span class="op" id="5084634">[</span><span class="ident" id="5084635">t</span><span class="op" id="5084636">.</span><span class="ident" id="5084637">Elem</span><span class="op" id="5084641">(</span><span class="op" id="5084642">)</span><span class="op" id="5084643">.</span><span class="ident" id="5084644">Kind</span><span class="op" id="5084648">(</span><span class="op" id="5084649">)</span><span class="op" id="5084650">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084655">op</span>&nbsp;<span class="op" id="5084658">=</span>&nbsp;<span class="keyword" id="5084660">func</span><span class="op" id="5084664">(</span><span class="ident" id="5084665">i</span>&nbsp;<span class="op" id="5084667">*</span><span class="ident" id="5084668">encInstr</span><span class="op" id="5084676">,</span>&nbsp;<span class="ident" id="5084678">state</span>&nbsp;<span class="op" id="5084684">*</span><span class="ident" id="5084685">encoderState</span><span class="op" id="5084697">,</span>&nbsp;<span class="ident" id="5084699">array</span>&nbsp;<span class="ident" id="5084705">reflect</span><span class="op" id="5084712">.</span><span class="ident" id="5084713">Value</span><span class="op" id="5084718">)</span>&nbsp;<span class="op" id="5084720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084726">state</span><span class="op" id="5084731">.</span><span class="ident" id="5084732">update</span><span class="op" id="5084738">(</span><span class="ident" id="5084739">i</span><span class="op" id="5084740">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084746">state</span><span class="op" id="5084751">.</span><span class="ident" id="5084752">enc</span><span class="op" id="5084755">.</span><span class="ident" id="5084756">encodeArray</span><span class="op" id="5084767">(</span><span class="ident" id="5084768">state</span><span class="op" id="5084773">.</span><span class="ident" id="5084774">b</span><span class="op" id="5084775">,</span>&nbsp;<span class="ident" id="5084777">array</span><span class="op" id="5084782">,</span>&nbsp;<span class="op" id="5084784">*</span><span class="ident" id="5084785">elemOp</span><span class="op" id="5084791">,</span>&nbsp;<span class="ident" id="5084793">elemIndir</span><span class="op" id="5084802">,</span>&nbsp;<span class="ident" id="5084804">array</span><span class="op" id="5084809">.</span><span class="ident" id="5084810">Len</span><span class="op" id="5084813">(</span><span class="op" id="5084814">)</span><span class="op" id="5084815">,</span>&nbsp;<span class="ident" id="5084817">helper</span><span class="op" id="5084823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5084828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5084832">case</span>&nbsp;<span class="ident" id="5084837">reflect</span><span class="op" id="5084844">.</span><span class="ident" id="5084845">Map</span><span class="op" id="5084848">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084853">keyOp</span><span class="op" id="5084858">,</span>&nbsp;<span class="ident" id="5084860">keyIndir</span>&nbsp;<span class="op" id="5084869">:=</span>&nbsp;<span class="ident" id="5084872">encOpFor</span><span class="op" id="5084880">(</span><span class="ident" id="5084881">t</span><span class="op" id="5084882">.</span><span class="ident" id="5084883">Key</span><span class="op" id="5084886">(</span><span class="op" id="5084887">)</span><span class="op" id="5084888">,</span>&nbsp;<span class="ident" id="5084890">inProgress</span><span class="op" id="5084900">,</span>&nbsp;<span class="ident" id="5084902">building</span><span class="op" id="5084910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084915">elemOp</span><span class="op" id="5084921">,</span>&nbsp;<span class="ident" id="5084923">elemIndir</span>&nbsp;<span class="op" id="5084933">:=</span>&nbsp;<span class="ident" id="5084936">encOpFor</span><span class="op" id="5084944">(</span><span class="ident" id="5084945">t</span><span class="op" id="5084946">.</span><span class="ident" id="5084947">Elem</span><span class="op" id="5084951">(</span><span class="op" id="5084952">)</span><span class="op" id="5084953">,</span>&nbsp;<span class="ident" id="5084955">inProgress</span><span class="op" id="5084965">,</span>&nbsp;<span class="ident" id="5084967">building</span><span class="op" id="5084975">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084980">op</span>&nbsp;<span class="op" id="5084983">=</span>&nbsp;<span class="keyword" id="5084985">func</span><span class="op" id="5084989">(</span><span class="ident" id="5084990">i</span>&nbsp;<span class="op" id="5084992">*</span><span class="ident" id="5084993">encInstr</span><span class="op" id="5085001">,</span>&nbsp;<span class="ident" id="5085003">state</span>&nbsp;<span class="op" id="5085009">*</span><span class="ident" id="5085010">encoderState</span><span class="op" id="5085022">,</span>&nbsp;<span class="ident" id="5085024">mv</span>&nbsp;<span class="ident" id="5085027">reflect</span><span class="op" id="5085034">.</span><span class="ident" id="5085035">Value</span><span class="op" id="5085040">)</span>&nbsp;<span class="op" id="5085042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5085048">//&nbsp;We&nbsp;send&nbsp;zero-length&nbsp;(but&nbsp;non-nil)&nbsp;maps&nbsp;because&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5085106">//&nbsp;receiver&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;map.&nbsp;&nbsp;(Maps&nbsp;don&#39;t&nbsp;use&nbsp;append.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5085175">if</span>&nbsp;<span class="op" id="5085178">!</span><span class="ident" id="5085179">state</span><span class="op" id="5085184">.</span><span class="ident" id="5085185">sendZero</span>&nbsp;<span class="op" id="5085194">&amp;&amp;</span>&nbsp;<span class="ident" id="5085197">mv</span><span class="op" id="5085199">.</span><span class="ident" id="5085200">IsNil</span><span class="op" id="5085205">(</span><span class="op" id="5085206">)</span>&nbsp;<span class="op" id="5085208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5085215">return</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5085226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085232">state</span><span class="op" id="5085237">.</span><span class="ident" id="5085238">update</span><span class="op" id="5085244">(</span><span class="ident" id="5085245">i</span><span class="op" id="5085246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085252">state</span><span class="op" id="5085257">.</span><span class="ident" id="5085258">enc</span><span class="op" id="5085261">.</span><span class="ident" id="5085262">encodeMap</span><span class="op" id="5085271">(</span><span class="ident" id="5085272">state</span><span class="op" id="5085277">.</span><span class="ident" id="5085278">b</span><span class="op" id="5085279">,</span>&nbsp;<span class="ident" id="5085281">mv</span><span class="op" id="5085283">,</span>&nbsp;<span class="op" id="5085285">*</span><span class="ident" id="5085286">keyOp</span><span class="op" id="5085291">,</span>&nbsp;<span class="op" id="5085293">*</span><span class="ident" id="5085294">elemOp</span><span class="op" id="5085300">,</span>&nbsp;<span class="ident" id="5085302">keyIndir</span><span class="op" id="5085310">,</span>&nbsp;<span class="ident" id="5085312">elemIndir</span><span class="op" id="5085321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5085326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5085330">case</span>&nbsp;<span class="ident" id="5085335">reflect</span><span class="op" id="5085342">.</span><span class="ident" id="5085343">Struct</span><span class="op" id="5085349">:</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5085354">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085429">getEncEngine</span><span class="op" id="5085441">(</span><span class="ident" id="5085442">userType</span><span class="op" id="5085450">(</span><span class="ident" id="5085451">typ</span><span class="op" id="5085454">)</span><span class="op" id="5085455">,</span>&nbsp;<span class="ident" id="5085457">building</span><span class="op" id="5085465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085470">info</span>&nbsp;<span class="op" id="5085475">:=</span>&nbsp;<span class="ident" id="5085478">mustGetTypeInfo</span><span class="op" id="5085493">(</span><span class="ident" id="5085494">typ</span><span class="op" id="5085497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085502">op</span>&nbsp;<span class="op" id="5085505">=</span>&nbsp;<span class="keyword" id="5085507">func</span><span class="op" id="5085511">(</span><span class="ident" id="5085512">i</span>&nbsp;<span class="op" id="5085514">*</span><span class="ident" id="5085515">encInstr</span><span class="op" id="5085523">,</span>&nbsp;<span class="ident" id="5085525">state</span>&nbsp;<span class="op" id="5085531">*</span><span class="ident" id="5085532">encoderState</span><span class="op" id="5085544">,</span>&nbsp;<span class="ident" id="5085546">sv</span>&nbsp;<span class="ident" id="5085549">reflect</span><span class="op" id="5085556">.</span><span class="ident" id="5085557">Value</span><span class="op" id="5085562">)</span>&nbsp;<span class="op" id="5085564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085570">state</span><span class="op" id="5085575">.</span><span class="ident" id="5085576">update</span><span class="op" id="5085582">(</span><span class="ident" id="5085583">i</span><span class="op" id="5085584">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5085590">//&nbsp;indirect&nbsp;through&nbsp;info&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085661">enc</span>&nbsp;<span class="op" id="5085665">:=</span>&nbsp;<span class="ident" id="5085668">info</span><span class="op" id="5085672">.</span><span class="ident" id="5085673">encoder</span><span class="op" id="5085680">.</span><span class="ident" id="5085681">Load</span><span class="op" id="5085685">(</span><span class="op" id="5085686">)</span><span class="op" id="5085687">.</span><span class="op" id="5085688">(</span><span class="op" id="5085689">*</span><span class="ident" id="5085690">encEngine</span><span class="op" id="5085699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085705">state</span><span class="op" id="5085710">.</span><span class="ident" id="5085711">enc</span><span class="op" id="5085714">.</span><span class="ident" id="5085715">encodeStruct</span><span class="op" id="5085727">(</span><span class="ident" id="5085728">state</span><span class="op" id="5085733">.</span><span class="ident" id="5085734">b</span><span class="op" id="5085735">,</span>&nbsp;<span class="ident" id="5085737">enc</span><span class="op" id="5085740">,</span>&nbsp;<span class="ident" id="5085742">sv</span><span class="op" id="5085744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5085749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5085753">case</span>&nbsp;<span class="ident" id="5085758">reflect</span><span class="op" id="5085765">.</span><span class="ident" id="5085766">Interface</span><span class="op" id="5085775">:</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085780">op</span>&nbsp;<span class="op" id="5085783">=</span>&nbsp;<span class="keyword" id="5085785">func</span><span class="op" id="5085789">(</span><span class="ident" id="5085790">i</span>&nbsp;<span class="op" id="5085792">*</span><span class="ident" id="5085793">encInstr</span><span class="op" id="5085801">,</span>&nbsp;<span class="ident" id="5085803">state</span>&nbsp;<span class="op" id="5085809">*</span><span class="ident" id="5085810">encoderState</span><span class="op" id="5085822">,</span>&nbsp;<span class="ident" id="5085824">iv</span>&nbsp;<span class="ident" id="5085827">reflect</span><span class="op" id="5085834">.</span><span class="ident" id="5085835">Value</span><span class="op" id="5085840">)</span>&nbsp;<span class="op" id="5085842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5085848">if</span>&nbsp;<span class="op" id="5085851">!</span><span class="ident" id="5085852">state</span><span class="op" id="5085857">.</span><span class="ident" id="5085858">sendZero</span>&nbsp;<span class="op" id="5085867">&amp;&amp;</span>&nbsp;<span class="op" id="5085870">(</span><span class="op" id="5085871">!</span><span class="ident" id="5085872">iv</span><span class="op" id="5085874">.</span><span class="ident" id="5085875">IsValid</span><span class="op" id="5085882">(</span><span class="op" id="5085883">)</span>&nbsp;<span class="op" id="5085885">||</span>&nbsp;<span class="ident" id="5085888">iv</span><span class="op" id="5085890">.</span><span class="ident" id="5085891">IsNil</span><span class="op" id="5085896">(</span><span class="op" id="5085897">)</span><span class="op" id="5085898">)</span>&nbsp;<span class="op" id="5085900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5085907">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5085918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085924">state</span><span class="op" id="5085929">.</span><span class="ident" id="5085930">update</span><span class="op" id="5085936">(</span><span class="ident" id="5085937">i</span><span class="op" id="5085938">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085944">state</span><span class="op" id="5085949">.</span><span class="ident" id="5085950">enc</span><span class="op" id="5085953">.</span><span class="ident" id="5085954">encodeInterface</span><span class="op" id="5085969">(</span><span class="ident" id="5085970">state</span><span class="op" id="5085975">.</span><span class="ident" id="5085976">b</span><span class="op" id="5085977">,</span>&nbsp;<span class="ident" id="5085979">iv</span><span class="op" id="5085981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5085986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5085990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5085993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5085996">if</span>&nbsp;<span class="ident" id="5085999">op</span>&nbsp;<span class="op" id="5086002">==</span>&nbsp;<span class="ident" id="5086005">nil</span>&nbsp;<span class="op" id="5086009">{</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5086013">errorf</span><span class="op" id="5086019">(</span><span class="string" id="5086020">&#34;can&#39;t&nbsp;happen:&nbsp;encode&nbsp;type&nbsp;%s&#34;</span><span class="op" id="5086050">,</span>&nbsp;<span class="ident" id="5086052">rt</span><span class="op" id="5086054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5086057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5086060">return</span>&nbsp;<span class="op" id="5086067">&amp;</span><span class="ident" id="5086068">op</span><span class="op" id="5086070">,</span>&nbsp;<span class="ident" id="5086072">indir</span><br>
<span class="lineno"></span><span class="op" id="5086078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="comment" id="5086081">//&nbsp;gobEncodeOpFor&nbsp;returns&nbsp;the&nbsp;op&nbsp;for&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;known&nbsp;to&nbsp;implement&nbsp;GobEncoder.</span><br>
<span class="lineno"></span><span class="keyword" id="5086164">func</span>&nbsp;<span class="ident" id="5086169">gobEncodeOpFor</span><span class="op" id="5086183">(</span><span class="ident" id="5086184">ut</span>&nbsp;<span class="op" id="5086187">*</span><span class="ident" id="5086188">userTypeInfo</span><span class="op" id="5086200">)</span>&nbsp;<span class="op" id="5086202">(</span><span class="op" id="5086203">*</span><span class="ident" id="5086204">encOp</span><span class="op" id="5086209">,</span>&nbsp;<span class="builtintype" id="5086211">int</span><span class="op" id="5086214">)</span>&nbsp;<span class="op" id="5086216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5086219">rt</span>&nbsp;<span class="op" id="5086222">:=</span>&nbsp;<span class="ident" id="5086225">ut</span><span class="op" id="5086227">.</span><span class="ident" id="5086228">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5086234">if</span>&nbsp;<span class="ident" id="5086237">ut</span><span class="op" id="5086239">.</span><span class="ident" id="5086240">encIndir</span>&nbsp;<span class="op" id="5086249">==</span>&nbsp;<span class="op" id="5086252">-</span><span class="num" id="5086253">1</span>&nbsp;<span class="op" id="5086255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5086259">rt</span>&nbsp;<span class="op" id="5086262">=</span>&nbsp;<span class="ident" id="5086264">reflect</span><span class="op" id="5086271">.</span><span class="ident" id="5086272">PtrTo</span><span class="op" id="5086277">(</span><span class="ident" id="5086278">rt</span><span class="op" id="5086280">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5086283">}</span>&nbsp;<span class="keyword" id="5086285">else</span>&nbsp;<span class="keyword" id="5086290">if</span>&nbsp;<span class="ident" id="5086293">ut</span><span class="op" id="5086295">.</span><span class="ident" id="5086296">encIndir</span>&nbsp;<span class="op" id="5086305">&gt;</span>&nbsp;<span class="num" id="5086307">0</span>&nbsp;<span class="op" id="5086309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5086313">for</span>&nbsp;<span class="ident" id="5086317">i</span>&nbsp;<span class="op" id="5086319">:=</span>&nbsp;<span class="builtintype" id="5086322">int8</span><span class="op" id="5086326">(</span><span class="num" id="5086327">0</span><span class="op" id="5086328">)</span><span class="op" id="5086329">;</span>&nbsp;<span class="ident" id="5086331">i</span>&nbsp;<span class="op" id="5086333">&lt;</span>&nbsp;<span class="ident" id="5086335">ut</span><span class="op" id="5086337">.</span><span class="ident" id="5086338">encIndir</span><span class="op" id="5086346">;</span>&nbsp;<span class="ident" id="5086348">i</span><span class="op" id="5086349">++</span>&nbsp;<span class="op" id="5086352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5086357">rt</span>&nbsp;<span class="op" id="5086360">=</span>&nbsp;<span class="ident" id="5086362">rt</span><span class="op" id="5086364">.</span><span class="ident" id="5086365">Elem</span><span class="op" id="5086369">(</span><span class="op" id="5086370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5086374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5086377">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5086380">var</span>&nbsp;<span class="ident" id="5086384">op</span>&nbsp;<span class="ident" id="5086387">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5086394">op</span>&nbsp;<span class="op" id="5086397">=</span>&nbsp;<span class="keyword" id="5086399">func</span><span class="op" id="5086403">(</span><span class="ident" id="5086404">i</span>&nbsp;<span class="op" id="5086406">*</span><span class="ident" id="5086407">encInstr</span><span class="op" id="5086415">,</span>&nbsp;<span class="ident" id="5086417">state</span>&nbsp;<span class="op" id="5086423">*</span><span class="ident" id="5086424">encoderState</span><span class="op" id="5086436">,</span>&nbsp;<span class="ident" id="5086438">v</span>&nbsp;<span class="ident" id="5086440">reflect</span><span class="op" id="5086447">.</span><span class="ident" id="5086448">Value</span><span class="op" id="5086453">)</span>&nbsp;<span class="op" id="5086455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5086459">if</span>&nbsp;<span class="ident" id="5086462">ut</span><span class="op" id="5086464">.</span><span class="ident" id="5086465">encIndir</span>&nbsp;<span class="op" id="5086474">==</span>&nbsp;<span class="op" id="5086477">-</span><span class="num" id="5086478">1</span>&nbsp;<span class="op" id="5086480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5086485">//&nbsp;Need&nbsp;to&nbsp;climb&nbsp;up&nbsp;one&nbsp;level&nbsp;to&nbsp;turn&nbsp;value&nbsp;into&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5086546">if</span>&nbsp;<span class="op" id="5086549">!</span><span class="ident" id="5086550">v</span><span class="op" id="5086551">.</span><span class="ident" id="5086552">CanAddr</span><span class="op" id="5086559">(</span><span class="op" id="5086560">)</span>&nbsp;<span class="op" id="5086562">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5086568">errorf</span><span class="op" id="5086574">(</span><span class="string" id="5086575">&#34;unaddressable&nbsp;value&nbsp;of&nbsp;type&nbsp;%s&#34;</span><span class="op" id="5086607">,</span>&nbsp;<span class="ident" id="5086609">rt</span><span class="op" id="5086611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5086616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5086621">v</span>&nbsp;<span class="op" id="5086623">=</span>&nbsp;<span class="ident" id="5086625">v</span><span class="op" id="5086626">.</span><span class="ident" id="5086627">Addr</span><span class="op" id="5086631">(</span><span class="op" id="5086632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5086636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5086640">if</span>&nbsp;<span class="op" id="5086643">!</span><span class="ident" id="5086644">state</span><span class="op" id="5086649">.</span><span class="ident" id="5086650">sendZero</span>&nbsp;<span class="op" id="5086659">&amp;&amp;</span>&nbsp;<span class="ident" id="5086662">isZero</span><span class="op" id="5086668">(</span><span class="ident" id="5086669">v</span><span class="op" id="5086670">)</span>&nbsp;<span class="op" id="5086672">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5086677">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5086686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5086690">state</span><span class="op" id="5086695">.</span><span class="ident" id="5086696">update</span><span class="op" id="5086702">(</span><span class="ident" id="5086703">i</span><span class="op" id="5086704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5086708">state</span><span class="op" id="5086713">.</span><span class="ident" id="5086714">enc</span><span class="op" id="5086717">.</span><span class="ident" id="5086718">encodeGobEncoder</span><span class="op" id="5086734">(</span><span class="ident" id="5086735">state</span><span class="op" id="5086740">.</span><span class="ident" id="5086741">b</span><span class="op" id="5086742">,</span>&nbsp;<span class="ident" id="5086744">ut</span><span class="op" id="5086746">,</span>&nbsp;<span class="ident" id="5086748">v</span><span class="op" id="5086749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5086752">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5086755">return</span>&nbsp;<span class="op" id="5086762">&amp;</span><span class="ident" id="5086763">op</span><span class="op" id="5086765">,</span>&nbsp;<span class="builtintype" id="5086767">int</span><span class="op" id="5086770">(</span><span class="ident" id="5086771">ut</span><span class="op" id="5086773">.</span><span class="ident" id="5086774">encIndir</span><span class="op" id="5086782">)</span>&nbsp;<span class="comment" id="5086784">//&nbsp;encIndir:&nbsp;op&nbsp;will&nbsp;get&nbsp;called&nbsp;with&nbsp;p&nbsp;==&nbsp;address&nbsp;of&nbsp;receiver.</span><br>
<span class="lineno"></span><span class="op" id="5086847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5086850">//&nbsp;compileEnc&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5086904">func</span>&nbsp;<span class="ident" id="5086909">compileEnc</span><span class="op" id="5086919">(</span><span class="ident" id="5086920">ut</span>&nbsp;<span class="op" id="5086923">*</span><span class="ident" id="5086924">userTypeInfo</span><span class="op" id="5086936">,</span>&nbsp;<span class="ident" id="5086938">building</span>&nbsp;<span class="keyword" id="5086947">map</span><span class="op" id="5086950">[</span><span class="op" id="5086951">*</span><span class="ident" id="5086952">typeInfo</span><span class="op" id="5086960">]</span><span class="builtintype" id="5086961">bool</span><span class="op" id="5086965">)</span>&nbsp;<span class="op" id="5086967">*</span><span class="ident" id="5086968">encEngine</span>&nbsp;<span class="op" id="5086978">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5086981">srt</span>&nbsp;<span class="op" id="5086985">:=</span>&nbsp;<span class="ident" id="5086988">ut</span><span class="op" id="5086990">.</span><span class="ident" id="5086991">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5086997">engine</span>&nbsp;<span class="op" id="5087004">:=</span>&nbsp;<span class="builtinfunc" id="5087007">new</span><span class="op" id="5087010">(</span><span class="ident" id="5087011">encEngine</span><span class="op" id="5087020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087023">seen</span>&nbsp;<span class="op" id="5087028">:=</span>&nbsp;<span class="builtinfunc" id="5087031">make</span><span class="op" id="5087035">(</span><span class="keyword" id="5087036">map</span><span class="op" id="5087039">[</span><span class="ident" id="5087040">reflect</span><span class="op" id="5087047">.</span><span class="ident" id="5087048">Type</span><span class="op" id="5087052">]</span><span class="op" id="5087053">*</span><span class="ident" id="5087054">encOp</span><span class="op" id="5087059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087062">rt</span>&nbsp;<span class="op" id="5087065">:=</span>&nbsp;<span class="ident" id="5087068">ut</span><span class="op" id="5087070">.</span><span class="ident" id="5087071">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087077">if</span>&nbsp;<span class="ident" id="5087080">ut</span><span class="op" id="5087082">.</span><span class="ident" id="5087083">externalEnc</span>&nbsp;<span class="op" id="5087095">!=</span>&nbsp;<span class="num" id="5087098">0</span>&nbsp;<span class="op" id="5087100">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087104">rt</span>&nbsp;<span class="op" id="5087107">=</span>&nbsp;<span class="ident" id="5087109">ut</span><span class="op" id="5087111">.</span><span class="ident" id="5087112">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5087118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087121">if</span>&nbsp;<span class="ident" id="5087124">ut</span><span class="op" id="5087126">.</span><span class="ident" id="5087127">externalEnc</span>&nbsp;<span class="op" id="5087139">==</span>&nbsp;<span class="num" id="5087142">0</span>&nbsp;<span class="op" id="5087144">&amp;&amp;</span>&nbsp;<span class="ident" id="5087147">srt</span><span class="op" id="5087150">.</span><span class="ident" id="5087151">Kind</span><span class="op" id="5087155">(</span><span class="op" id="5087156">)</span>&nbsp;<span class="op" id="5087158">==</span>&nbsp;<span class="ident" id="5087161">reflect</span><span class="op" id="5087168">.</span><span class="ident" id="5087169">Struct</span>&nbsp;<span class="op" id="5087176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087180">for</span>&nbsp;<span class="ident" id="5087184">fieldNum</span><span class="op" id="5087192">,</span>&nbsp;<span class="ident" id="5087194">wireFieldNum</span>&nbsp;<span class="op" id="5087207">:=</span>&nbsp;<span class="num" id="5087210">0</span><span class="op" id="5087211">,</span>&nbsp;<span class="num" id="5087213">0</span><span class="op" id="5087214">;</span>&nbsp;<span class="ident" id="5087216">fieldNum</span>&nbsp;<span class="op" id="5087225">&lt;</span>&nbsp;<span class="ident" id="5087227">srt</span><span class="op" id="5087230">.</span><span class="ident" id="5087231">NumField</span><span class="op" id="5087239">(</span><span class="op" id="5087240">)</span><span class="op" id="5087241">;</span>&nbsp;<span class="ident" id="5087243">fieldNum</span><span class="op" id="5087251">++</span>&nbsp;<span class="op" id="5087254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087259">f</span>&nbsp;<span class="op" id="5087261">:=</span>&nbsp;<span class="ident" id="5087264">srt</span><span class="op" id="5087267">.</span><span class="ident" id="5087268">Field</span><span class="op" id="5087273">(</span><span class="ident" id="5087274">fieldNum</span><span class="op" id="5087282">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087287">if</span>&nbsp;<span class="op" id="5087290">!</span><span class="ident" id="5087291">isSent</span><span class="op" id="5087297">(</span><span class="op" id="5087298">&amp;</span><span class="ident" id="5087299">f</span><span class="op" id="5087300">)</span>&nbsp;<span class="op" id="5087302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087308">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5087320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087325">op</span><span class="op" id="5087327">,</span>&nbsp;<span class="ident" id="5087329">indir</span>&nbsp;<span class="op" id="5087335">:=</span>&nbsp;<span class="ident" id="5087338">encOpFor</span><span class="op" id="5087346">(</span><span class="ident" id="5087347">f</span><span class="op" id="5087348">.</span><span class="ident" id="5087349">Type</span><span class="op" id="5087353">,</span>&nbsp;<span class="ident" id="5087355">seen</span><span class="op" id="5087359">,</span>&nbsp;<span class="ident" id="5087361">building</span><span class="op" id="5087369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087374">engine</span><span class="op" id="5087380">.</span><span class="ident" id="5087381">instr</span>&nbsp;<span class="op" id="5087387">=</span>&nbsp;<span class="builtinfunc" id="5087389">append</span><span class="op" id="5087395">(</span><span class="ident" id="5087396">engine</span><span class="op" id="5087402">.</span><span class="ident" id="5087403">instr</span><span class="op" id="5087408">,</span>&nbsp;<span class="ident" id="5087410">encInstr</span><span class="op" id="5087418">{</span><span class="op" id="5087419">*</span><span class="ident" id="5087420">op</span><span class="op" id="5087422">,</span>&nbsp;<span class="ident" id="5087424">wireFieldNum</span><span class="op" id="5087436">,</span>&nbsp;<span class="ident" id="5087438">f</span><span class="op" id="5087439">.</span><span class="ident" id="5087440">Index</span><span class="op" id="5087445">,</span>&nbsp;<span class="ident" id="5087447">indir</span><span class="op" id="5087452">}</span><span class="op" id="5087453">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087458">wireFieldNum</span><span class="op" id="5087470">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5087475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087479">if</span>&nbsp;<span class="ident" id="5087482">srt</span><span class="op" id="5087485">.</span><span class="ident" id="5087486">NumField</span><span class="op" id="5087494">(</span><span class="op" id="5087495">)</span>&nbsp;<span class="op" id="5087497">&gt;</span>&nbsp;<span class="num" id="5087499">0</span>&nbsp;<span class="op" id="5087501">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5087504">len</span><span class="op" id="5087507">(</span><span class="ident" id="5087508">engine</span><span class="op" id="5087514">.</span><span class="ident" id="5087515">instr</span><span class="op" id="5087520">)</span>&nbsp;<span class="op" id="5087522">==</span>&nbsp;<span class="num" id="5087525">0</span>&nbsp;<span class="op" id="5087527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087532">errorf</span><span class="op" id="5087538">(</span><span class="string" id="5087539">&#34;type&nbsp;%s&nbsp;has&nbsp;no&nbsp;exported&nbsp;fields&#34;</span><span class="op" id="5087571">,</span>&nbsp;<span class="ident" id="5087573">rt</span><span class="op" id="5087575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5087579">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087583">engine</span><span class="op" id="5087589">.</span><span class="ident" id="5087590">instr</span>&nbsp;<span class="op" id="5087596">=</span>&nbsp;<span class="builtinfunc" id="5087598">append</span><span class="op" id="5087604">(</span><span class="ident" id="5087605">engine</span><span class="op" id="5087611">.</span><span class="ident" id="5087612">instr</span><span class="op" id="5087617">,</span>&nbsp;<span class="ident" id="5087619">encInstr</span><span class="op" id="5087627">{</span><span class="ident" id="5087628">encStructTerminator</span><span class="op" id="5087647">,</span>&nbsp;<span class="num" id="5087649">0</span><span class="op" id="5087650">,</span>&nbsp;<span class="ident" id="5087652">nil</span><span class="op" id="5087655">,</span>&nbsp;<span class="num" id="5087657">0</span><span class="op" id="5087658">}</span><span class="op" id="5087659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5087662">}</span>&nbsp;<span class="keyword" id="5087664">else</span>&nbsp;<span class="op" id="5087669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087673">engine</span><span class="op" id="5087679">.</span><span class="ident" id="5087680">instr</span>&nbsp;<span class="op" id="5087686">=</span>&nbsp;<span class="builtinfunc" id="5087688">make</span><span class="op" id="5087692">(</span><span class="op" id="5087693">[</span><span class="op" id="5087694">]</span><span class="ident" id="5087695">encInstr</span><span class="op" id="5087703">,</span>&nbsp;<span class="num" id="5087705">1</span><span class="op" id="5087706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087710">op</span><span class="op" id="5087712">,</span>&nbsp;<span class="ident" id="5087714">indir</span>&nbsp;<span class="op" id="5087720">:=</span>&nbsp;<span class="ident" id="5087723">encOpFor</span><span class="op" id="5087731">(</span><span class="ident" id="5087732">rt</span><span class="op" id="5087734">,</span>&nbsp;<span class="ident" id="5087736">seen</span><span class="op" id="5087740">,</span>&nbsp;<span class="ident" id="5087742">building</span><span class="op" id="5087750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087754">engine</span><span class="op" id="5087760">.</span><span class="ident" id="5087761">instr</span><span class="op" id="5087766">[</span><span class="num" id="5087767">0</span><span class="op" id="5087768">]</span>&nbsp;<span class="op" id="5087770">=</span>&nbsp;<span class="ident" id="5087772">encInstr</span><span class="op" id="5087780">{</span><span class="op" id="5087781">*</span><span class="ident" id="5087782">op</span><span class="op" id="5087784">,</span>&nbsp;<span class="ident" id="5087786">singletonField</span><span class="op" id="5087800">,</span>&nbsp;<span class="ident" id="5087802">nil</span><span class="op" id="5087805">,</span>&nbsp;<span class="ident" id="5087807">indir</span><span class="op" id="5087812">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5087815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087818">return</span>&nbsp;<span class="ident" id="5087825">engine</span><br>
<span class="lineno"></span><span class="op" id="5087832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5087835">//&nbsp;getEncEngine&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno">650</span><span class="keyword" id="5087891">func</span>&nbsp;<span class="ident" id="5087896">getEncEngine</span><span class="op" id="5087908">(</span><span class="ident" id="5087909">ut</span>&nbsp;<span class="op" id="5087912">*</span><span class="ident" id="5087913">userTypeInfo</span><span class="op" id="5087925">,</span>&nbsp;<span class="ident" id="5087927">building</span>&nbsp;<span class="keyword" id="5087936">map</span><span class="op" id="5087939">[</span><span class="op" id="5087940">*</span><span class="ident" id="5087941">typeInfo</span><span class="op" id="5087949">]</span><span class="builtintype" id="5087950">bool</span><span class="op" id="5087954">)</span>&nbsp;<span class="op" id="5087956">*</span><span class="ident" id="5087957">encEngine</span>&nbsp;<span class="op" id="5087967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087970">info</span><span class="op" id="5087974">,</span>&nbsp;<span class="ident" id="5087976">err</span>&nbsp;<span class="op" id="5087980">:=</span>&nbsp;<span class="ident" id="5087983">getTypeInfo</span><span class="op" id="5087994">(</span><span class="ident" id="5087995">ut</span><span class="op" id="5087997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088000">if</span>&nbsp;<span class="ident" id="5088003">err</span>&nbsp;<span class="op" id="5088007">!=</span>&nbsp;<span class="ident" id="5088010">nil</span>&nbsp;<span class="op" id="5088014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088018">error_</span><span class="op" id="5088024">(</span><span class="ident" id="5088025">err</span><span class="op" id="5088028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5088031">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088034">enc</span><span class="op" id="5088037">,</span>&nbsp;<span class="ident" id="5088039">ok</span>&nbsp;<span class="op" id="5088042">:=</span>&nbsp;<span class="ident" id="5088045">info</span><span class="op" id="5088049">.</span><span class="ident" id="5088050">encoder</span><span class="op" id="5088057">.</span><span class="ident" id="5088058">Load</span><span class="op" id="5088062">(</span><span class="op" id="5088063">)</span><span class="op" id="5088064">.</span><span class="op" id="5088065">(</span><span class="op" id="5088066">*</span><span class="ident" id="5088067">encEngine</span><span class="op" id="5088076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088079">if</span>&nbsp;<span class="op" id="5088082">!</span><span class="ident" id="5088083">ok</span>&nbsp;<span class="op" id="5088086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088090">enc</span>&nbsp;<span class="op" id="5088094">=</span>&nbsp;<span class="ident" id="5088096">buildEncEngine</span><span class="op" id="5088110">(</span><span class="ident" id="5088111">info</span><span class="op" id="5088115">,</span>&nbsp;<span class="ident" id="5088117">ut</span><span class="op" id="5088119">,</span>&nbsp;<span class="ident" id="5088121">building</span><span class="op" id="5088129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5088132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088135">return</span>&nbsp;<span class="ident" id="5088142">enc</span><br>
<span class="lineno">660</span><span class="op" id="5088146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5088149">func</span>&nbsp;<span class="ident" id="5088154">buildEncEngine</span><span class="op" id="5088168">(</span><span class="ident" id="5088169">info</span>&nbsp;<span class="op" id="5088174">*</span><span class="ident" id="5088175">typeInfo</span><span class="op" id="5088183">,</span>&nbsp;<span class="ident" id="5088185">ut</span>&nbsp;<span class="op" id="5088188">*</span><span class="ident" id="5088189">userTypeInfo</span><span class="op" id="5088201">,</span>&nbsp;<span class="ident" id="5088203">building</span>&nbsp;<span class="keyword" id="5088212">map</span><span class="op" id="5088215">[</span><span class="op" id="5088216">*</span><span class="ident" id="5088217">typeInfo</span><span class="op" id="5088225">]</span><span class="builtintype" id="5088226">bool</span><span class="op" id="5088230">)</span>&nbsp;<span class="op" id="5088232">*</span><span class="ident" id="5088233">encEngine</span>&nbsp;<span class="op" id="5088243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5088246">//&nbsp;Check&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088277">if</span>&nbsp;<span class="ident" id="5088280">building</span>&nbsp;<span class="op" id="5088289">!=</span>&nbsp;<span class="ident" id="5088292">nil</span>&nbsp;<span class="op" id="5088296">&amp;&amp;</span>&nbsp;<span class="ident" id="5088299">building</span><span class="op" id="5088307">[</span><span class="ident" id="5088308">info</span><span class="op" id="5088312">]</span>&nbsp;<span class="op" id="5088314">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088318">return</span>&nbsp;<span class="ident" id="5088325">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5088330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088333">info</span><span class="op" id="5088337">.</span><span class="ident" id="5088338">encInit</span><span class="op" id="5088345">.</span><span class="ident" id="5088346">Lock</span><span class="op" id="5088350">(</span><span class="op" id="5088351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088354">defer</span>&nbsp;<span class="ident" id="5088360">info</span><span class="op" id="5088364">.</span><span class="ident" id="5088365">encInit</span><span class="op" id="5088372">.</span><span class="ident" id="5088373">Unlock</span><span class="op" id="5088379">(</span><span class="op" id="5088380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088383">enc</span><span class="op" id="5088386">,</span>&nbsp;<span class="ident" id="5088388">ok</span>&nbsp;<span class="op" id="5088391">:=</span>&nbsp;<span class="ident" id="5088394">info</span><span class="op" id="5088398">.</span><span class="ident" id="5088399">encoder</span><span class="op" id="5088406">.</span><span class="ident" id="5088407">Load</span><span class="op" id="5088411">(</span><span class="op" id="5088412">)</span><span class="op" id="5088413">.</span><span class="op" id="5088414">(</span><span class="op" id="5088415">*</span><span class="ident" id="5088416">encEngine</span><span class="op" id="5088425">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088428">if</span>&nbsp;<span class="op" id="5088431">!</span><span class="ident" id="5088432">ok</span>&nbsp;<span class="op" id="5088435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088439">if</span>&nbsp;<span class="ident" id="5088442">building</span>&nbsp;<span class="op" id="5088451">==</span>&nbsp;<span class="ident" id="5088454">nil</span>&nbsp;<span class="op" id="5088458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088463">building</span>&nbsp;<span class="op" id="5088472">=</span>&nbsp;<span class="builtinfunc" id="5088474">make</span><span class="op" id="5088478">(</span><span class="keyword" id="5088479">map</span><span class="op" id="5088482">[</span><span class="op" id="5088483">*</span><span class="ident" id="5088484">typeInfo</span><span class="op" id="5088492">]</span><span class="builtintype" id="5088493">bool</span><span class="op" id="5088497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5088501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088505">building</span><span class="op" id="5088513">[</span><span class="ident" id="5088514">info</span><span class="op" id="5088518">]</span>&nbsp;<span class="op" id="5088520">=</span>&nbsp;<span class="builtintype" id="5088522">true</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088529">enc</span>&nbsp;<span class="op" id="5088533">=</span>&nbsp;<span class="ident" id="5088535">compileEnc</span><span class="op" id="5088545">(</span><span class="ident" id="5088546">ut</span><span class="op" id="5088548">,</span>&nbsp;<span class="ident" id="5088550">building</span><span class="op" id="5088558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088562">info</span><span class="op" id="5088566">.</span><span class="ident" id="5088567">encoder</span><span class="op" id="5088574">.</span><span class="ident" id="5088575">Store</span><span class="op" id="5088580">(</span><span class="ident" id="5088581">enc</span><span class="op" id="5088584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5088587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088590">return</span>&nbsp;<span class="ident" id="5088597">enc</span><br>
<span class="lineno"></span><span class="op" id="5088601">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="5088604">func</span>&nbsp;<span class="op" id="5088609">(</span><span class="ident" id="5088610">enc</span>&nbsp;<span class="op" id="5088614">*</span><span class="ident" id="5088615">Encoder</span><span class="op" id="5088622">)</span>&nbsp;<span class="ident" id="5088624">encode</span><span class="op" id="5088630">(</span><span class="ident" id="5088631">b</span>&nbsp;<span class="op" id="5088633">*</span><span class="ident" id="5088634">encBuffer</span><span class="op" id="5088643">,</span>&nbsp;<span class="ident" id="5088645">value</span>&nbsp;<span class="ident" id="5088651">reflect</span><span class="op" id="5088658">.</span><span class="ident" id="5088659">Value</span><span class="op" id="5088664">,</span>&nbsp;<span class="ident" id="5088666">ut</span>&nbsp;<span class="op" id="5088669">*</span><span class="ident" id="5088670">userTypeInfo</span><span class="op" id="5088682">)</span>&nbsp;<span class="op" id="5088684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088687">defer</span>&nbsp;<span class="ident" id="5088693">catchError</span><span class="op" id="5088703">(</span><span class="op" id="5088704">&amp;</span><span class="ident" id="5088705">enc</span><span class="op" id="5088708">.</span><span class="ident" id="5088709">err</span><span class="op" id="5088712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088715">engine</span>&nbsp;<span class="op" id="5088722">:=</span>&nbsp;<span class="ident" id="5088725">getEncEngine</span><span class="op" id="5088737">(</span><span class="ident" id="5088738">ut</span><span class="op" id="5088740">,</span>&nbsp;<span class="ident" id="5088742">nil</span><span class="op" id="5088745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088748">indir</span>&nbsp;<span class="op" id="5088754">:=</span>&nbsp;<span class="ident" id="5088757">ut</span><span class="op" id="5088759">.</span><span class="ident" id="5088760">indir</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088767">if</span>&nbsp;<span class="ident" id="5088770">ut</span><span class="op" id="5088772">.</span><span class="ident" id="5088773">externalEnc</span>&nbsp;<span class="op" id="5088785">!=</span>&nbsp;<span class="num" id="5088788">0</span>&nbsp;<span class="op" id="5088790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088794">indir</span>&nbsp;<span class="op" id="5088800">=</span>&nbsp;<span class="builtintype" id="5088802">int</span><span class="op" id="5088805">(</span><span class="ident" id="5088806">ut</span><span class="op" id="5088808">.</span><span class="ident" id="5088809">encIndir</span><span class="op" id="5088817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5088820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088823">for</span>&nbsp;<span class="ident" id="5088827">i</span>&nbsp;<span class="op" id="5088829">:=</span>&nbsp;<span class="num" id="5088832">0</span><span class="op" id="5088833">;</span>&nbsp;<span class="ident" id="5088835">i</span>&nbsp;<span class="op" id="5088837">&lt;</span>&nbsp;<span class="ident" id="5088839">indir</span><span class="op" id="5088844">;</span>&nbsp;<span class="ident" id="5088846">i</span><span class="op" id="5088847">++</span>&nbsp;<span class="op" id="5088850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088854">value</span>&nbsp;<span class="op" id="5088860">=</span>&nbsp;<span class="ident" id="5088862">reflect</span><span class="op" id="5088869">.</span><span class="ident" id="5088870">Indirect</span><span class="op" id="5088878">(</span><span class="ident" id="5088879">value</span><span class="op" id="5088884">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5088887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088890">if</span>&nbsp;<span class="ident" id="5088893">ut</span><span class="op" id="5088895">.</span><span class="ident" id="5088896">externalEnc</span>&nbsp;<span class="op" id="5088908">==</span>&nbsp;<span class="num" id="5088911">0</span>&nbsp;<span class="op" id="5088913">&amp;&amp;</span>&nbsp;<span class="ident" id="5088916">value</span><span class="op" id="5088921">.</span><span class="ident" id="5088922">Type</span><span class="op" id="5088926">(</span><span class="op" id="5088927">)</span><span class="op" id="5088928">.</span><span class="ident" id="5088929">Kind</span><span class="op" id="5088933">(</span><span class="op" id="5088934">)</span>&nbsp;<span class="op" id="5088936">==</span>&nbsp;<span class="ident" id="5088939">reflect</span><span class="op" id="5088946">.</span><span class="ident" id="5088947">Struct</span>&nbsp;<span class="op" id="5088954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088958">enc</span><span class="op" id="5088961">.</span><span class="ident" id="5088962">encodeStruct</span><span class="op" id="5088974">(</span><span class="ident" id="5088975">b</span><span class="op" id="5088976">,</span>&nbsp;<span class="ident" id="5088978">engine</span><span class="op" id="5088984">,</span>&nbsp;<span class="ident" id="5088986">value</span><span class="op" id="5088991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5088994">}</span>&nbsp;<span class="keyword" id="5088996">else</span>&nbsp;<span class="op" id="5089001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5089005">enc</span><span class="op" id="5089008">.</span><span class="ident" id="5089009">encodeSingle</span><span class="op" id="5089021">(</span><span class="ident" id="5089022">b</span><span class="op" id="5089023">,</span>&nbsp;<span class="ident" id="5089025">engine</span><span class="op" id="5089031">,</span>&nbsp;<span class="ident" id="5089033">value</span><span class="op" id="5089038">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5089041">}</span><br>
<span class="lineno"></span><span class="op" id="5089043">}</span>
</div>
</body>
</html>
