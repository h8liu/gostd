<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html" class="current">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1635830">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1635885">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1635939">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1635990">package</span>&nbsp;<span class="ident" id="1635998">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1636007">import</span>&nbsp;<span class="string" id="1636014">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1636024">func</span>&nbsp;<span class="ident" id="1636029">newsysmon</span><span class="op" id="1636038">(</span><span class="op" id="1636039">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1636042">func</span>&nbsp;<span class="ident" id="1636047">runtime_init</span><span class="op" id="1636059">(</span><span class="op" id="1636060">)</span><br>
<span class="lineno"></span><span class="keyword" id="1636062">func</span>&nbsp;<span class="ident" id="1636067">main_init</span><span class="op" id="1636076">(</span><span class="op" id="1636077">)</span><br>
<span class="lineno"></span><span class="keyword" id="1636079">func</span>&nbsp;<span class="ident" id="1636084">main_main</span><span class="op" id="1636093">(</span><span class="op" id="1636094">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="1636097">//&nbsp;The&nbsp;main&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1636120">func</span>&nbsp;<span class="ident" id="1636125">main</span><span class="op" id="1636129">(</span><span class="op" id="1636130">)</span>&nbsp;<span class="op" id="1636132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636135">g</span>&nbsp;<span class="op" id="1636137">:=</span>&nbsp;<span class="ident" id="1636140">getg</span><span class="op" id="1636144">(</span><span class="op" id="1636145">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636149">//&nbsp;Racectx&nbsp;of&nbsp;m0-&gt;g0&nbsp;is&nbsp;used&nbsp;only&nbsp;as&nbsp;the&nbsp;parent&nbsp;of&nbsp;the&nbsp;main&nbsp;goroutine.</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636221">//&nbsp;It&nbsp;must&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;anything&nbsp;else.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636264">g</span><span class="op" id="1636265">.</span><span class="ident" id="1636266">m</span><span class="op" id="1636267">.</span><span class="ident" id="1636268">g0</span><span class="op" id="1636270">.</span><span class="ident" id="1636271">racectx</span>&nbsp;<span class="op" id="1636279">=</span>&nbsp;<span class="num" id="1636281">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636285">//&nbsp;Max&nbsp;stack&nbsp;size&nbsp;is&nbsp;1&nbsp;GB&nbsp;on&nbsp;64-bit,&nbsp;250&nbsp;MB&nbsp;on&nbsp;32-bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636341">//&nbsp;Using&nbsp;decimal&nbsp;instead&nbsp;of&nbsp;binary&nbsp;GB&nbsp;and&nbsp;MB&nbsp;because</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636395">//&nbsp;they&nbsp;look&nbsp;nicer&nbsp;in&nbsp;the&nbsp;stack&nbsp;overflow&nbsp;failure&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1636454">if</span>&nbsp;<span class="ident" id="1636457">ptrSize</span>&nbsp;<span class="op" id="1636465">==</span>&nbsp;<span class="num" id="1636468">8</span>&nbsp;<span class="op" id="1636470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636474">maxstacksize</span>&nbsp;<span class="op" id="1636487">=</span>&nbsp;<span class="num" id="1636489">1000000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1636501">}</span>&nbsp;<span class="keyword" id="1636503">else</span>&nbsp;<span class="op" id="1636508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636512">maxstacksize</span>&nbsp;<span class="op" id="1636525">=</span>&nbsp;<span class="num" id="1636527">250000000</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1636538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636542">onM</span><span class="op" id="1636545">(</span><span class="ident" id="1636546">newsysmon</span><span class="op" id="1636555">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636559">//&nbsp;Lock&nbsp;the&nbsp;main&nbsp;goroutine&nbsp;onto&nbsp;this,&nbsp;the&nbsp;main&nbsp;OS&nbsp;thread,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636618">//&nbsp;during&nbsp;initialization.&nbsp;&nbsp;Most&nbsp;programs&nbsp;won&#39;t&nbsp;care,&nbsp;but&nbsp;a&nbsp;few</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636682">//&nbsp;do&nbsp;require&nbsp;certain&nbsp;calls&nbsp;to&nbsp;be&nbsp;made&nbsp;by&nbsp;the&nbsp;main&nbsp;thread.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636742">//&nbsp;Those&nbsp;can&nbsp;arrange&nbsp;for&nbsp;main.main&nbsp;to&nbsp;run&nbsp;in&nbsp;the&nbsp;main&nbsp;thread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636804">//&nbsp;by&nbsp;calling&nbsp;runtime.LockOSThread&nbsp;during&nbsp;initialization</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636862">//&nbsp;to&nbsp;preserve&nbsp;the&nbsp;lock.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636888">lockOSThread</span><span class="op" id="1636900">(</span><span class="op" id="1636901">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1636905">if</span>&nbsp;<span class="ident" id="1636908">g</span><span class="op" id="1636909">.</span><span class="ident" id="1636910">m</span>&nbsp;<span class="op" id="1636912">!=</span>&nbsp;<span class="op" id="1636915">&amp;</span><span class="ident" id="1636916">m0</span>&nbsp;<span class="op" id="1636919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636923">gothrow</span><span class="op" id="1636930">(</span><span class="string" id="1636931">&#34;runtime.main&nbsp;not&nbsp;on&nbsp;m0&#34;</span><span class="op" id="1636955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1636958">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636962">runtime_init</span><span class="op" id="1636974">(</span><span class="op" id="1636975">)</span>&nbsp;<span class="comment" id="1636977">//&nbsp;must&nbsp;be&nbsp;before&nbsp;defer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1637003">//&nbsp;Defer&nbsp;unlock&nbsp;so&nbsp;that&nbsp;runtime.Goexit&nbsp;during&nbsp;init&nbsp;does&nbsp;the&nbsp;unlock&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637076">needUnlock</span>&nbsp;<span class="op" id="1637087">:=</span>&nbsp;<span class="builtintype" id="1637090">true</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1637096">defer</span>&nbsp;<span class="keyword" id="1637102">func</span><span class="op" id="1637106">(</span><span class="op" id="1637107">)</span>&nbsp;<span class="op" id="1637109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1637113">if</span>&nbsp;<span class="ident" id="1637116">needUnlock</span>&nbsp;<span class="op" id="1637127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637132">unlockOSThread</span><span class="op" id="1637146">(</span><span class="op" id="1637147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1637151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1637154">}</span><span class="op" id="1637155">(</span><span class="op" id="1637156">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637160">memstats</span><span class="op" id="1637168">.</span><span class="ident" id="1637169">enablegc</span>&nbsp;<span class="op" id="1637178">=</span>&nbsp;<span class="builtintype" id="1637180">true</span>&nbsp;<span class="comment" id="1637185">//&nbsp;now&nbsp;that&nbsp;runtime&nbsp;is&nbsp;initialized,&nbsp;GC&nbsp;is&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637234">main_init</span><span class="op" id="1637243">(</span><span class="op" id="1637244">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637248">needUnlock</span>&nbsp;<span class="op" id="1637259">=</span>&nbsp;<span class="builtintype" id="1637261">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637268">unlockOSThread</span><span class="op" id="1637282">(</span><span class="op" id="1637283">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637287">main_main</span><span class="op" id="1637296">(</span><span class="op" id="1637297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1637300">if</span>&nbsp;<span class="ident" id="1637303">raceenabled</span>&nbsp;<span class="op" id="1637315">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637319">racefini</span><span class="op" id="1637327">(</span><span class="op" id="1637328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1637331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1637335">//&nbsp;Make&nbsp;racy&nbsp;client&nbsp;program&nbsp;work:&nbsp;if&nbsp;panicking&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1637386">//&nbsp;another&nbsp;goroutine&nbsp;at&nbsp;the&nbsp;same&nbsp;time&nbsp;as&nbsp;main&nbsp;returns,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1637442">//&nbsp;let&nbsp;the&nbsp;other&nbsp;goroutine&nbsp;finish&nbsp;printing&nbsp;the&nbsp;panic&nbsp;trace.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1637503">//&nbsp;Once&nbsp;it&nbsp;does,&nbsp;it&nbsp;will&nbsp;exit.&nbsp;See&nbsp;issue&nbsp;3934.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1637551">if</span>&nbsp;<span class="ident" id="1637554">panicking</span>&nbsp;<span class="op" id="1637564">!=</span>&nbsp;<span class="num" id="1637567">0</span>&nbsp;<span class="op" id="1637569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637573">gopark</span><span class="op" id="1637579">(</span><span class="builtintype" id="1637580">nil</span><span class="op" id="1637583">,</span>&nbsp;<span class="builtintype" id="1637585">nil</span><span class="op" id="1637588">,</span>&nbsp;<span class="string" id="1637590">&#34;panicwait&#34;</span><span class="op" id="1637601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1637604">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637608">exit</span><span class="op" id="1637612">(</span><span class="num" id="1637613">0</span><span class="op" id="1637614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1637617">for</span>&nbsp;<span class="op" id="1637621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1637625">var</span>&nbsp;<span class="ident" id="1637629">x</span>&nbsp;<span class="op" id="1637631">*</span><span class="builtintype" id="1637632">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1637640">*</span><span class="ident" id="1637641">x</span>&nbsp;<span class="op" id="1637643">=</span>&nbsp;<span class="num" id="1637645">0</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1637648">}</span><br>
<span class="lineno"></span><span class="op" id="1637650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1637653">var</span>&nbsp;<span class="ident" id="1637657">parkunlock_c</span>&nbsp;<span class="builtintype" id="1637670">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="1637676">//&nbsp;start&nbsp;forcegc&nbsp;helper&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="keyword" id="1637710">func</span>&nbsp;<span class="ident" id="1637715">init</span><span class="op" id="1637719">(</span><span class="op" id="1637720">)</span>&nbsp;<span class="op" id="1637722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1637725">go</span>&nbsp;<span class="ident" id="1637728">forcegchelper</span><span class="op" id="1637741">(</span><span class="op" id="1637742">)</span><br>
<span class="lineno"></span><span class="op" id="1637744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="1637747">func</span>&nbsp;<span class="ident" id="1637752">forcegchelper</span><span class="op" id="1637765">(</span><span class="op" id="1637766">)</span>&nbsp;<span class="op" id="1637768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637771">forcegc</span><span class="op" id="1637778">.</span><span class="ident" id="1637779">g</span>&nbsp;<span class="op" id="1637781">=</span>&nbsp;<span class="ident" id="1637783">getg</span><span class="op" id="1637787">(</span><span class="op" id="1637788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637791">forcegc</span><span class="op" id="1637798">.</span><span class="ident" id="1637799">g</span><span class="op" id="1637800">.</span><span class="ident" id="1637801">issystem</span>&nbsp;<span class="op" id="1637810">=</span>&nbsp;<span class="builtintype" id="1637812">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1637818">for</span>&nbsp;<span class="op" id="1637822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637826">lock</span><span class="op" id="1637830">(</span><span class="op" id="1637831">&amp;</span><span class="ident" id="1637832">forcegc</span><span class="op" id="1637839">.</span><span class="ident" id="1637840">lock</span><span class="op" id="1637844">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1637848">if</span>&nbsp;<span class="ident" id="1637851">forcegc</span><span class="op" id="1637858">.</span><span class="ident" id="1637859">idle</span>&nbsp;<span class="op" id="1637864">!=</span>&nbsp;<span class="num" id="1637867">0</span>&nbsp;<span class="op" id="1637869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637874">gothrow</span><span class="op" id="1637881">(</span><span class="string" id="1637882">&#34;forcegc:&nbsp;phase&nbsp;error&#34;</span><span class="op" id="1637904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1637908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637912">atomicstore</span><span class="op" id="1637923">(</span><span class="op" id="1637924">&amp;</span><span class="ident" id="1637925">forcegc</span><span class="op" id="1637932">.</span><span class="ident" id="1637933">idle</span><span class="op" id="1637937">,</span>&nbsp;<span class="num" id="1637939">1</span><span class="op" id="1637940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637944">goparkunlock</span><span class="op" id="1637956">(</span><span class="op" id="1637957">&amp;</span><span class="ident" id="1637958">forcegc</span><span class="op" id="1637965">.</span><span class="ident" id="1637966">lock</span><span class="op" id="1637970">,</span>&nbsp;<span class="string" id="1637972">&#34;force&nbsp;gc&nbsp;(idle)&#34;</span><span class="op" id="1637989">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1637993">//&nbsp;this&nbsp;goroutine&nbsp;is&nbsp;explicitly&nbsp;resumed&nbsp;by&nbsp;sysmon</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1638045">if</span>&nbsp;<span class="ident" id="1638048">debug</span><span class="op" id="1638053">.</span><span class="ident" id="1638054">gctrace</span>&nbsp;<span class="op" id="1638062">&gt;</span>&nbsp;<span class="num" id="1638064">0</span>&nbsp;<span class="op" id="1638066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1638071">println</span><span class="op" id="1638078">(</span><span class="string" id="1638079">&#34;GC&nbsp;forced&#34;</span><span class="op" id="1638090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1638094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638098">gogc</span><span class="op" id="1638102">(</span><span class="num" id="1638103">1</span><span class="op" id="1638104">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1638107">}</span><br>
<span class="lineno"></span><span class="op" id="1638109">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1638112">//go:nosplit</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="1638126">//&nbsp;Gosched&nbsp;yields&nbsp;the&nbsp;processor,&nbsp;allowing&nbsp;other&nbsp;goroutines&nbsp;to&nbsp;run.&nbsp;&nbsp;It&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1638206">//&nbsp;suspend&nbsp;the&nbsp;current&nbsp;goroutine,&nbsp;so&nbsp;execution&nbsp;resumes&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="1638276">func</span>&nbsp;<span class="ident" id="1638281">Gosched</span><span class="op" id="1638288">(</span><span class="op" id="1638289">)</span>&nbsp;<span class="op" id="1638291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638294">mcall</span><span class="op" id="1638299">(</span><span class="ident" id="1638300">gosched_m</span><span class="op" id="1638309">)</span><br>
<span class="lineno"></span><span class="op" id="1638311">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="1638314">//&nbsp;Puts&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;into&nbsp;a&nbsp;waiting&nbsp;state&nbsp;and&nbsp;calls&nbsp;unlockf.</span><br>
<span class="lineno"></span><span class="comment" id="1638384">//&nbsp;If&nbsp;unlockf&nbsp;returns&nbsp;false,&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;resumed.</span><br>
<span class="lineno"></span><span class="keyword" id="1638439">func</span>&nbsp;<span class="ident" id="1638444">gopark</span><span class="op" id="1638450">(</span><span class="ident" id="1638451">unlockf</span>&nbsp;<span class="ident" id="1638459">unsafe</span><span class="op" id="1638465">.</span><span class="ident" id="1638466">Pointer</span><span class="op" id="1638473">,</span>&nbsp;<span class="ident" id="1638475">lock</span>&nbsp;<span class="ident" id="1638480">unsafe</span><span class="op" id="1638486">.</span><span class="ident" id="1638487">Pointer</span><span class="op" id="1638494">,</span>&nbsp;<span class="ident" id="1638496">reason</span>&nbsp;<span class="builtintype" id="1638503">string</span><span class="op" id="1638509">)</span>&nbsp;<span class="op" id="1638511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638514">mp</span>&nbsp;<span class="op" id="1638517">:=</span>&nbsp;<span class="ident" id="1638520">acquirem</span><span class="op" id="1638528">(</span><span class="op" id="1638529">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638532">gp</span>&nbsp;<span class="op" id="1638535">:=</span>&nbsp;<span class="ident" id="1638538">mp</span><span class="op" id="1638540">.</span><span class="ident" id="1638541">curg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638547">status</span>&nbsp;<span class="op" id="1638554">:=</span>&nbsp;<span class="ident" id="1638557">readgstatus</span><span class="op" id="1638568">(</span><span class="ident" id="1638569">gp</span><span class="op" id="1638571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1638574">if</span>&nbsp;<span class="ident" id="1638577">status</span>&nbsp;<span class="op" id="1638584">!=</span>&nbsp;<span class="ident" id="1638587">_Grunning</span>&nbsp;<span class="op" id="1638597">&amp;&amp;</span>&nbsp;<span class="ident" id="1638600">status</span>&nbsp;<span class="op" id="1638607">!=</span>&nbsp;<span class="ident" id="1638610">_Gscanrunning</span>&nbsp;<span class="op" id="1638624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638628">gothrow</span><span class="op" id="1638635">(</span><span class="string" id="1638636">&#34;gopark:&nbsp;bad&nbsp;g&nbsp;status&#34;</span><span class="op" id="1638658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1638661">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638664">mp</span><span class="op" id="1638666">.</span><span class="ident" id="1638667">waitlock</span>&nbsp;<span class="op" id="1638676">=</span>&nbsp;<span class="ident" id="1638678">lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638684">mp</span><span class="op" id="1638686">.</span><span class="ident" id="1638687">waitunlockf</span>&nbsp;<span class="op" id="1638699">=</span>&nbsp;<span class="ident" id="1638701">unlockf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638710">gp</span><span class="op" id="1638712">.</span><span class="ident" id="1638713">waitreason</span>&nbsp;<span class="op" id="1638724">=</span>&nbsp;<span class="ident" id="1638726">reason</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638734">releasem</span><span class="op" id="1638742">(</span><span class="ident" id="1638743">mp</span><span class="op" id="1638745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1638748">//&nbsp;can&#39;t&nbsp;do&nbsp;anything&nbsp;that&nbsp;might&nbsp;move&nbsp;the&nbsp;G&nbsp;between&nbsp;Ms&nbsp;here.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638809">mcall</span><span class="op" id="1638814">(</span><span class="ident" id="1638815">park_m</span><span class="op" id="1638821">)</span><br>
<span class="lineno"></span><span class="op" id="1638823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1638826">//&nbsp;Puts&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;into&nbsp;a&nbsp;waiting&nbsp;state&nbsp;and&nbsp;unlocks&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1638899">//&nbsp;The&nbsp;goroutine&nbsp;can&nbsp;be&nbsp;made&nbsp;runnable&nbsp;again&nbsp;by&nbsp;calling&nbsp;goready(gp).</span><br>
<span class="lineno">135</span><span class="keyword" id="1638967">func</span>&nbsp;<span class="ident" id="1638972">goparkunlock</span><span class="op" id="1638984">(</span><span class="ident" id="1638985">lock</span>&nbsp;<span class="op" id="1638990">*</span><span class="ident" id="1638991">mutex</span><span class="op" id="1638996">,</span>&nbsp;<span class="ident" id="1638998">reason</span>&nbsp;<span class="builtintype" id="1639005">string</span><span class="op" id="1639011">)</span>&nbsp;<span class="op" id="1639013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639016">gopark</span><span class="op" id="1639022">(</span><span class="ident" id="1639023">unsafe</span><span class="op" id="1639029">.</span><span class="ident" id="1639030">Pointer</span><span class="op" id="1639037">(</span><span class="op" id="1639038">&amp;</span><span class="ident" id="1639039">parkunlock_c</span><span class="op" id="1639051">)</span><span class="op" id="1639052">,</span>&nbsp;<span class="ident" id="1639054">unsafe</span><span class="op" id="1639060">.</span><span class="ident" id="1639061">Pointer</span><span class="op" id="1639068">(</span><span class="ident" id="1639069">lock</span><span class="op" id="1639073">)</span><span class="op" id="1639074">,</span>&nbsp;<span class="ident" id="1639076">reason</span><span class="op" id="1639082">)</span><br>
<span class="lineno"></span><span class="op" id="1639084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1639087">func</span>&nbsp;<span class="ident" id="1639092">goready</span><span class="op" id="1639099">(</span><span class="ident" id="1639100">gp</span>&nbsp;<span class="op" id="1639103">*</span><span class="ident" id="1639104">g</span><span class="op" id="1639105">)</span>&nbsp;<span class="op" id="1639107">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639110">mp</span>&nbsp;<span class="op" id="1639113">:=</span>&nbsp;<span class="ident" id="1639116">acquirem</span><span class="op" id="1639124">(</span><span class="op" id="1639125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639128">mp</span><span class="op" id="1639130">.</span><span class="ident" id="1639131">ptrarg</span><span class="op" id="1639137">[</span><span class="num" id="1639138">0</span><span class="op" id="1639139">]</span>&nbsp;<span class="op" id="1639141">=</span>&nbsp;<span class="ident" id="1639143">unsafe</span><span class="op" id="1639149">.</span><span class="ident" id="1639150">Pointer</span><span class="op" id="1639157">(</span><span class="ident" id="1639158">gp</span><span class="op" id="1639160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639163">onM</span><span class="op" id="1639166">(</span><span class="ident" id="1639167">ready_m</span><span class="op" id="1639174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639177">releasem</span><span class="op" id="1639185">(</span><span class="ident" id="1639186">mp</span><span class="op" id="1639188">)</span><br>
<span class="lineno"></span><span class="op" id="1639190">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment" id="1639193">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1639206">func</span>&nbsp;<span class="ident" id="1639211">acquireSudog</span><span class="op" id="1639223">(</span><span class="op" id="1639224">)</span>&nbsp;<span class="op" id="1639226">*</span><span class="ident" id="1639227">sudog</span>&nbsp;<span class="op" id="1639233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639236">c</span>&nbsp;<span class="op" id="1639238">:=</span>&nbsp;<span class="ident" id="1639241">gomcache</span><span class="op" id="1639249">(</span><span class="op" id="1639250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639253">s</span>&nbsp;<span class="op" id="1639255">:=</span>&nbsp;<span class="ident" id="1639258">c</span><span class="op" id="1639259">.</span><span class="ident" id="1639260">sudogcache</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1639272">if</span>&nbsp;<span class="ident" id="1639275">s</span>&nbsp;<span class="op" id="1639277">!=</span>&nbsp;<span class="builtintype" id="1639280">nil</span>&nbsp;<span class="op" id="1639284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1639288">if</span>&nbsp;<span class="ident" id="1639291">s</span><span class="op" id="1639292">.</span><span class="ident" id="1639293">elem</span>&nbsp;<span class="op" id="1639298">!=</span>&nbsp;<span class="builtintype" id="1639301">nil</span>&nbsp;<span class="op" id="1639305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639310">gothrow</span><span class="op" id="1639317">(</span><span class="string" id="1639318">&#34;acquireSudog:&nbsp;found&nbsp;s.elem&nbsp;!=&nbsp;nil&nbsp;in&nbsp;cache&#34;</span><span class="op" id="1639362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1639366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639370">c</span><span class="op" id="1639371">.</span><span class="ident" id="1639372">sudogcache</span>&nbsp;<span class="op" id="1639383">=</span>&nbsp;<span class="ident" id="1639385">s</span><span class="op" id="1639386">.</span><span class="ident" id="1639387">next</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639394">s</span><span class="op" id="1639395">.</span><span class="ident" id="1639396">next</span>&nbsp;<span class="op" id="1639401">=</span>&nbsp;<span class="builtintype" id="1639403">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1639409">return</span>&nbsp;<span class="ident" id="1639416">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1639419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1639423">//&nbsp;Delicate&nbsp;dance:&nbsp;the&nbsp;semaphore&nbsp;implementation&nbsp;calls</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1639478">//&nbsp;acquireSudog,&nbsp;acquireSudog&nbsp;calls&nbsp;new(sudog),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1639527">//&nbsp;new&nbsp;calls&nbsp;malloc,&nbsp;malloc&nbsp;can&nbsp;call&nbsp;the&nbsp;garbage&nbsp;collector,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1639588">//&nbsp;and&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;calls&nbsp;the&nbsp;semaphore&nbsp;implementation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1639653">//&nbsp;in&nbsp;stoptheworld.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1639674">//&nbsp;Break&nbsp;the&nbsp;cycle&nbsp;by&nbsp;doing&nbsp;acquirem/releasem&nbsp;around&nbsp;new(sudog).</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1639740">//&nbsp;The&nbsp;acquirem/releasem&nbsp;increments&nbsp;m.locks&nbsp;during&nbsp;new(sudog),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1639804">//&nbsp;which&nbsp;keeps&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;from&nbsp;being&nbsp;invoked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639862">mp</span>&nbsp;<span class="op" id="1639865">:=</span>&nbsp;<span class="ident" id="1639868">acquirem</span><span class="op" id="1639876">(</span><span class="op" id="1639877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639880">p</span>&nbsp;<span class="op" id="1639882">:=</span>&nbsp;<span class="builtinfunc" id="1639885">new</span><span class="op" id="1639888">(</span><span class="ident" id="1639889">sudog</span><span class="op" id="1639894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639897">releasem</span><span class="op" id="1639905">(</span><span class="ident" id="1639906">mp</span><span class="op" id="1639908">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1639911">return</span>&nbsp;<span class="ident" id="1639918">p</span><br>
<span class="lineno"></span><span class="op" id="1639920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1639923">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1639936">func</span>&nbsp;<span class="ident" id="1639941">releaseSudog</span><span class="op" id="1639953">(</span><span class="ident" id="1639954">s</span>&nbsp;<span class="op" id="1639956">*</span><span class="ident" id="1639957">sudog</span><span class="op" id="1639962">)</span>&nbsp;<span class="op" id="1639964">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1639967">if</span>&nbsp;<span class="ident" id="1639970">s</span><span class="op" id="1639971">.</span><span class="ident" id="1639972">elem</span>&nbsp;<span class="op" id="1639977">!=</span>&nbsp;<span class="builtintype" id="1639980">nil</span>&nbsp;<span class="op" id="1639984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639988">gothrow</span><span class="op" id="1639995">(</span><span class="string" id="1639996">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;elem&#34;</span><span class="op" id="1640030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640036">if</span>&nbsp;<span class="ident" id="1640039">s</span><span class="op" id="1640040">.</span><span class="ident" id="1640041">selectdone</span>&nbsp;<span class="op" id="1640052">!=</span>&nbsp;<span class="builtintype" id="1640055">nil</span>&nbsp;<span class="op" id="1640059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640063">gothrow</span><span class="op" id="1640070">(</span><span class="string" id="1640071">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;selectdone&#34;</span><span class="op" id="1640111">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640117">if</span>&nbsp;<span class="ident" id="1640120">s</span><span class="op" id="1640121">.</span><span class="ident" id="1640122">next</span>&nbsp;<span class="op" id="1640127">!=</span>&nbsp;<span class="builtintype" id="1640130">nil</span>&nbsp;<span class="op" id="1640134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640138">gothrow</span><span class="op" id="1640145">(</span><span class="string" id="1640146">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;next&#34;</span><span class="op" id="1640180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640186">if</span>&nbsp;<span class="ident" id="1640189">s</span><span class="op" id="1640190">.</span><span class="ident" id="1640191">prev</span>&nbsp;<span class="op" id="1640196">!=</span>&nbsp;<span class="builtintype" id="1640199">nil</span>&nbsp;<span class="op" id="1640203">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640207">gothrow</span><span class="op" id="1640214">(</span><span class="string" id="1640215">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;prev&#34;</span><span class="op" id="1640249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640255">if</span>&nbsp;<span class="ident" id="1640258">s</span><span class="op" id="1640259">.</span><span class="ident" id="1640260">waitlink</span>&nbsp;<span class="op" id="1640269">!=</span>&nbsp;<span class="builtintype" id="1640272">nil</span>&nbsp;<span class="op" id="1640276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640280">gothrow</span><span class="op" id="1640287">(</span><span class="string" id="1640288">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;waitlink&#34;</span><span class="op" id="1640326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640329">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640332">gp</span>&nbsp;<span class="op" id="1640335">:=</span>&nbsp;<span class="ident" id="1640338">getg</span><span class="op" id="1640342">(</span><span class="op" id="1640343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640346">if</span>&nbsp;<span class="ident" id="1640349">gp</span><span class="op" id="1640351">.</span><span class="ident" id="1640352">param</span>&nbsp;<span class="op" id="1640358">!=</span>&nbsp;<span class="builtintype" id="1640361">nil</span>&nbsp;<span class="op" id="1640365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640369">gothrow</span><span class="op" id="1640376">(</span><span class="string" id="1640377">&#34;runtime:&nbsp;releaseSudog&nbsp;with&nbsp;non-nil&nbsp;gp.param&#34;</span><span class="op" id="1640422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640428">c</span>&nbsp;<span class="op" id="1640430">:=</span>&nbsp;<span class="ident" id="1640433">gomcache</span><span class="op" id="1640441">(</span><span class="op" id="1640442">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640445">s</span><span class="op" id="1640446">.</span><span class="ident" id="1640447">next</span>&nbsp;<span class="op" id="1640452">=</span>&nbsp;<span class="ident" id="1640454">c</span><span class="op" id="1640455">.</span><span class="ident" id="1640456">sudogcache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640468">c</span><span class="op" id="1640469">.</span><span class="ident" id="1640470">sudogcache</span>&nbsp;<span class="op" id="1640481">=</span>&nbsp;<span class="ident" id="1640483">s</span><br>
<span class="lineno"></span><span class="op" id="1640485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1640488">//&nbsp;funcPC&nbsp;returns&nbsp;the&nbsp;entry&nbsp;PC&nbsp;of&nbsp;the&nbsp;function&nbsp;f.</span><br>
<span class="lineno">200</span><span class="comment" id="1640538">//&nbsp;It&nbsp;assumes&nbsp;that&nbsp;f&nbsp;is&nbsp;a&nbsp;func&nbsp;value.&nbsp;Otherwise&nbsp;the&nbsp;behavior&nbsp;is&nbsp;undefined.</span><br>
<span class="lineno"></span><span class="comment" id="1640613">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1640626">func</span>&nbsp;<span class="ident" id="1640631">funcPC</span><span class="op" id="1640637">(</span><span class="ident" id="1640638">f</span>&nbsp;<span class="keyword" id="1640640">interface</span><span class="op" id="1640649">{</span><span class="op" id="1640650">}</span><span class="op" id="1640651">)</span>&nbsp;<span class="builtintype" id="1640653">uintptr</span>&nbsp;<span class="op" id="1640661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640664">return</span>&nbsp;<span class="op" id="1640671">*</span><span class="op" id="1640672">*</span><span class="op" id="1640673">(</span><span class="op" id="1640674">*</span><span class="op" id="1640675">*</span><span class="builtintype" id="1640676">uintptr</span><span class="op" id="1640683">)</span><span class="op" id="1640684">(</span><span class="ident" id="1640685">add</span><span class="op" id="1640688">(</span><span class="ident" id="1640689">unsafe</span><span class="op" id="1640695">.</span><span class="ident" id="1640696">Pointer</span><span class="op" id="1640703">(</span><span class="op" id="1640704">&amp;</span><span class="ident" id="1640705">f</span><span class="op" id="1640706">)</span><span class="op" id="1640707">,</span>&nbsp;<span class="ident" id="1640709">ptrSize</span><span class="op" id="1640716">)</span><span class="op" id="1640717">)</span><br>
<span class="lineno"></span><span class="op" id="1640719">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="1640722">//&nbsp;called&nbsp;from&nbsp;assembly</span><br>
<span class="lineno"></span><span class="keyword" id="1640746">func</span>&nbsp;<span class="ident" id="1640751">badmcall</span><span class="op" id="1640759">(</span><span class="ident" id="1640760">fn</span>&nbsp;<span class="keyword" id="1640763">func</span><span class="op" id="1640767">(</span><span class="op" id="1640768">*</span><span class="ident" id="1640769">g</span><span class="op" id="1640770">)</span><span class="op" id="1640771">)</span>&nbsp;<span class="op" id="1640773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640776">gothrow</span><span class="op" id="1640783">(</span><span class="string" id="1640784">&#34;runtime:&nbsp;mcall&nbsp;called&nbsp;on&nbsp;m-&gt;g0&nbsp;stack&#34;</span><span class="op" id="1640822">)</span><br>
<span class="lineno"></span><span class="op" id="1640824">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="keyword" id="1640827">func</span>&nbsp;<span class="ident" id="1640832">badmcall2</span><span class="op" id="1640841">(</span><span class="ident" id="1640842">fn</span>&nbsp;<span class="keyword" id="1640845">func</span><span class="op" id="1640849">(</span><span class="op" id="1640850">*</span><span class="ident" id="1640851">g</span><span class="op" id="1640852">)</span><span class="op" id="1640853">)</span>&nbsp;<span class="op" id="1640855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640858">gothrow</span><span class="op" id="1640865">(</span><span class="string" id="1640866">&#34;runtime:&nbsp;mcall&nbsp;function&nbsp;returned&#34;</span><span class="op" id="1640900">)</span><br>
<span class="lineno"></span><span class="op" id="1640902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="1640905">func</span>&nbsp;<span class="ident" id="1640910">badreflectcall</span><span class="op" id="1640924">(</span><span class="op" id="1640925">)</span>&nbsp;<span class="op" id="1640927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1640930">panic</span><span class="op" id="1640935">(</span><span class="string" id="1640936">&#34;runtime:&nbsp;arg&nbsp;size&nbsp;to&nbsp;reflect.call&nbsp;more&nbsp;than&nbsp;1GB&#34;</span><span class="op" id="1640985">)</span><br>
<span class="lineno"></span><span class="op" id="1640987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1640990">func</span>&nbsp;<span class="ident" id="1640995">lockedOSThread</span><span class="op" id="1641009">(</span><span class="op" id="1641010">)</span>&nbsp;<span class="builtintype" id="1641012">bool</span>&nbsp;<span class="op" id="1641017">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641020">gp</span>&nbsp;<span class="op" id="1641023">:=</span>&nbsp;<span class="ident" id="1641026">getg</span><span class="op" id="1641030">(</span><span class="op" id="1641031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641034">return</span>&nbsp;<span class="ident" id="1641041">gp</span><span class="op" id="1641043">.</span><span class="ident" id="1641044">lockedm</span>&nbsp;<span class="op" id="1641052">!=</span>&nbsp;<span class="builtintype" id="1641055">nil</span>&nbsp;<span class="op" id="1641059">&amp;&amp;</span>&nbsp;<span class="ident" id="1641062">gp</span><span class="op" id="1641064">.</span><span class="ident" id="1641065">m</span><span class="op" id="1641066">.</span><span class="ident" id="1641067">lockedg</span>&nbsp;<span class="op" id="1641075">!=</span>&nbsp;<span class="builtintype" id="1641078">nil</span><br>
<span class="lineno"></span><span class="op" id="1641082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1641085">func</span>&nbsp;<span class="ident" id="1641090">newP</span><span class="op" id="1641094">(</span><span class="op" id="1641095">)</span>&nbsp;<span class="op" id="1641097">*</span><span class="ident" id="1641098">p</span>&nbsp;<span class="op" id="1641100">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641103">return</span>&nbsp;<span class="builtinfunc" id="1641110">new</span><span class="op" id="1641113">(</span><span class="ident" id="1641114">p</span><span class="op" id="1641115">)</span><br>
<span class="lineno"></span><span class="op" id="1641117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1641120">func</span>&nbsp;<span class="ident" id="1641125">newM</span><span class="op" id="1641129">(</span><span class="op" id="1641130">)</span>&nbsp;<span class="op" id="1641132">*</span><span class="ident" id="1641133">m</span>&nbsp;<span class="op" id="1641135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641138">return</span>&nbsp;<span class="builtinfunc" id="1641145">new</span><span class="op" id="1641148">(</span><span class="ident" id="1641149">m</span><span class="op" id="1641150">)</span><br>
<span class="lineno">230</span><span class="op" id="1641152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1641155">func</span>&nbsp;<span class="ident" id="1641160">newG</span><span class="op" id="1641164">(</span><span class="op" id="1641165">)</span>&nbsp;<span class="op" id="1641167">*</span><span class="ident" id="1641168">g</span>&nbsp;<span class="op" id="1641170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641173">return</span>&nbsp;<span class="builtinfunc" id="1641180">new</span><span class="op" id="1641183">(</span><span class="ident" id="1641184">g</span><span class="op" id="1641185">)</span><br>
<span class="lineno"></span><span class="op" id="1641187">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="keyword" id="1641190">func</span>&nbsp;<span class="ident" id="1641195">allgadd</span><span class="op" id="1641202">(</span><span class="ident" id="1641203">gp</span>&nbsp;<span class="op" id="1641206">*</span><span class="ident" id="1641207">g</span><span class="op" id="1641208">)</span>&nbsp;<span class="op" id="1641210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641213">if</span>&nbsp;<span class="ident" id="1641216">readgstatus</span><span class="op" id="1641227">(</span><span class="ident" id="1641228">gp</span><span class="op" id="1641230">)</span>&nbsp;<span class="op" id="1641232">==</span>&nbsp;<span class="ident" id="1641235">_Gidle</span>&nbsp;<span class="op" id="1641242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641246">gothrow</span><span class="op" id="1641253">(</span><span class="string" id="1641254">&#34;allgadd:&nbsp;bad&nbsp;status&nbsp;Gidle&#34;</span><span class="op" id="1641281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1641284">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641288">lock</span><span class="op" id="1641292">(</span><span class="op" id="1641293">&amp;</span><span class="ident" id="1641294">allglock</span><span class="op" id="1641302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641305">allgs</span>&nbsp;<span class="op" id="1641311">=</span>&nbsp;<span class="builtinfunc" id="1641313">append</span><span class="op" id="1641319">(</span><span class="ident" id="1641320">allgs</span><span class="op" id="1641325">,</span>&nbsp;<span class="ident" id="1641327">gp</span><span class="op" id="1641329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641332">allg</span>&nbsp;<span class="op" id="1641337">=</span>&nbsp;<span class="op" id="1641339">&amp;</span><span class="ident" id="1641340">allgs</span><span class="op" id="1641345">[</span><span class="num" id="1641346">0</span><span class="op" id="1641347">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641350">allglen</span>&nbsp;<span class="op" id="1641358">=</span>&nbsp;<span class="builtintype" id="1641360">uintptr</span><span class="op" id="1641367">(</span><span class="builtinfunc" id="1641368">len</span><span class="op" id="1641371">(</span><span class="ident" id="1641372">allgs</span><span class="op" id="1641377">)</span><span class="op" id="1641378">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641381">unlock</span><span class="op" id="1641387">(</span><span class="op" id="1641388">&amp;</span><span class="ident" id="1641389">allglock</span><span class="op" id="1641397">)</span><br>
<span class="lineno"></span><span class="op" id="1641399">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
