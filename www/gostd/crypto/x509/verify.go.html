<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3957668">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3957723">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3957777">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3957828">package</span>&nbsp;<span class="ident" id="3957836">x509</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3957842">import</span>&nbsp;<span class="op" id="3957849">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3957852">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3957859">&#34;net&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3957866">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3957877">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3957888">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3957896">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="3957911">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3957914">type</span>&nbsp;<span class="ident" id="3957919">InvalidReason</span>&nbsp;<span class="builtintype" id="3957933">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3957938">const</span>&nbsp;<span class="op" id="3957944">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3957947">//&nbsp;NotAuthorizedToSign&nbsp;results&nbsp;when&nbsp;a&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;another</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3958019">//&nbsp;which&nbsp;isn&#39;t&nbsp;marked&nbsp;as&nbsp;a&nbsp;CA&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958063">NotAuthorizedToSign</span>&nbsp;<span class="ident" id="3958083">InvalidReason</span>&nbsp;<span class="op" id="3958097">=</span>&nbsp;<span class="ident" id="3958099">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3958105">//&nbsp;Expired&nbsp;results&nbsp;when&nbsp;a&nbsp;certificate&nbsp;has&nbsp;expired,&nbsp;based&nbsp;on&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3958175">//&nbsp;given&nbsp;in&nbsp;the&nbsp;VerifyOptions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958207">Expired</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3958216">//&nbsp;CANotAuthorizedForThisName&nbsp;results&nbsp;when&nbsp;an&nbsp;intermediate&nbsp;or&nbsp;root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3958284">//&nbsp;certificate&nbsp;has&nbsp;a&nbsp;name&nbsp;constraint&nbsp;which&nbsp;doesn&#39;t&nbsp;include&nbsp;the&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3958353">//&nbsp;being&nbsp;checked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958372">CANotAuthorizedForThisName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3958400">//&nbsp;TooManyIntermediates&nbsp;results&nbsp;when&nbsp;a&nbsp;path&nbsp;length&nbsp;constraint&nbsp;is</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3958466">//&nbsp;violated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958480">TooManyIntermediates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3958502">//&nbsp;IncompatibleUsage&nbsp;results&nbsp;when&nbsp;the&nbsp;certificate&#39;s&nbsp;key&nbsp;usage&nbsp;indicates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3958575">//&nbsp;that&nbsp;it&nbsp;may&nbsp;only&nbsp;be&nbsp;used&nbsp;for&nbsp;a&nbsp;different&nbsp;purpose.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958629">IncompatibleUsage</span><br>
<span class="lineno">35</span><span class="op" id="3958647">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3958650">//&nbsp;CertificateInvalidError&nbsp;results&nbsp;when&nbsp;an&nbsp;odd&nbsp;error&nbsp;occurs.&nbsp;Users&nbsp;of&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="3958725">//&nbsp;library&nbsp;probably&nbsp;want&nbsp;to&nbsp;handle&nbsp;all&nbsp;these&nbsp;errors&nbsp;uniformly.</span><br>
<span class="lineno"></span><span class="keyword" id="3958788">type</span>&nbsp;<span class="ident" id="3958793">CertificateInvalidError</span>&nbsp;<span class="keyword" id="3958817">struct</span>&nbsp;<span class="op" id="3958824">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958827">Cert</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3958834">*</span><span class="ident" id="3958835">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958848">Reason</span>&nbsp;<span class="ident" id="3958855">InvalidReason</span><br>
<span class="lineno"></span><span class="op" id="3958869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3958872">func</span>&nbsp;<span class="op" id="3958877">(</span><span class="ident" id="3958878">e</span>&nbsp;<span class="ident" id="3958880">CertificateInvalidError</span><span class="op" id="3958903">)</span>&nbsp;<span class="ident" id="3958905">Error</span><span class="op" id="3958910">(</span><span class="op" id="3958911">)</span>&nbsp;<span class="builtintype" id="3958913">string</span>&nbsp;<span class="op" id="3958920">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3958923">switch</span>&nbsp;<span class="ident" id="3958930">e</span><span class="op" id="3958931">.</span><span class="ident" id="3958932">Reason</span>&nbsp;<span class="op" id="3958939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3958942">case</span>&nbsp;<span class="ident" id="3958947">NotAuthorizedToSign</span><span class="op" id="3958966">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3958970">return</span>&nbsp;<span class="string" id="3958977">&#34;x509:&nbsp;certificate&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;sign&nbsp;other&nbsp;certificates&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959043">case</span>&nbsp;<span class="ident" id="3959048">Expired</span><span class="op" id="3959055">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959059">return</span>&nbsp;<span class="string" id="3959066">&#34;x509:&nbsp;certificate&nbsp;has&nbsp;expired&nbsp;or&nbsp;is&nbsp;not&nbsp;yet&nbsp;valid&#34;</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959119">case</span>&nbsp;<span class="ident" id="3959124">CANotAuthorizedForThisName</span><span class="op" id="3959150">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959154">return</span>&nbsp;<span class="string" id="3959161">&#34;x509:&nbsp;a&nbsp;root&nbsp;or&nbsp;intermediate&nbsp;certificate&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;sign&nbsp;in&nbsp;this&nbsp;domain&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959246">case</span>&nbsp;<span class="ident" id="3959251">TooManyIntermediates</span><span class="op" id="3959271">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959275">return</span>&nbsp;<span class="string" id="3959282">&#34;x509:&nbsp;too&nbsp;many&nbsp;intermediates&nbsp;for&nbsp;path&nbsp;length&nbsp;constraint&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959341">case</span>&nbsp;<span class="ident" id="3959346">IncompatibleUsage</span><span class="op" id="3959363">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959367">return</span>&nbsp;<span class="string" id="3959374">&#34;x509:&nbsp;certificate&nbsp;specifies&nbsp;an&nbsp;incompatible&nbsp;key&nbsp;usage&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3959431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959434">return</span>&nbsp;<span class="string" id="3959441">&#34;x509:&nbsp;unknown&nbsp;error&#34;</span><br>
<span class="lineno"></span><span class="op" id="3959463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="3959466">//&nbsp;HostnameError&nbsp;results&nbsp;when&nbsp;the&nbsp;set&nbsp;of&nbsp;authorized&nbsp;names&nbsp;doesn&#39;t&nbsp;match&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3959542">//&nbsp;requested&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="3959561">type</span>&nbsp;<span class="ident" id="3959566">HostnameError</span>&nbsp;<span class="keyword" id="3959580">struct</span>&nbsp;<span class="op" id="3959587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3959590">Certificate</span>&nbsp;<span class="op" id="3959602">*</span><span class="ident" id="3959603">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3959616">Host</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3959628">string</span><br>
<span class="lineno">65</span><span class="op" id="3959635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3959638">func</span>&nbsp;<span class="op" id="3959643">(</span><span class="ident" id="3959644">h</span>&nbsp;<span class="ident" id="3959646">HostnameError</span><span class="op" id="3959659">)</span>&nbsp;<span class="ident" id="3959661">Error</span><span class="op" id="3959666">(</span><span class="op" id="3959667">)</span>&nbsp;<span class="builtintype" id="3959669">string</span>&nbsp;<span class="op" id="3959676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3959679">c</span>&nbsp;<span class="op" id="3959681">:=</span>&nbsp;<span class="ident" id="3959684">h</span><span class="op" id="3959685">.</span><span class="ident" id="3959686">Certificate</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959700">var</span>&nbsp;<span class="ident" id="3959704">valid</span>&nbsp;<span class="builtintype" id="3959710">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959718">if</span>&nbsp;<span class="ident" id="3959721">ip</span>&nbsp;<span class="op" id="3959724">:=</span>&nbsp;<span class="ident" id="3959727">net</span><span class="op" id="3959730">.</span><span class="ident" id="3959731">ParseIP</span><span class="op" id="3959738">(</span><span class="ident" id="3959739">h</span><span class="op" id="3959740">.</span><span class="ident" id="3959741">Host</span><span class="op" id="3959745">)</span><span class="op" id="3959746">;</span>&nbsp;<span class="ident" id="3959748">ip</span>&nbsp;<span class="op" id="3959751">!=</span>&nbsp;<span class="ident" id="3959754">nil</span>&nbsp;<span class="op" id="3959758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3959762">//&nbsp;Trying&nbsp;to&nbsp;validate&nbsp;an&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959792">if</span>&nbsp;<span class="builtinfunc" id="3959795">len</span><span class="op" id="3959798">(</span><span class="ident" id="3959799">c</span><span class="op" id="3959800">.</span><span class="ident" id="3959801">IPAddresses</span><span class="op" id="3959812">)</span>&nbsp;<span class="op" id="3959814">==</span>&nbsp;<span class="num" id="3959817">0</span>&nbsp;<span class="op" id="3959819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959824">return</span>&nbsp;<span class="string" id="3959831">&#34;x509:&nbsp;cannot&nbsp;validate&nbsp;certificate&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="3959872">+</span>&nbsp;<span class="ident" id="3959874">h</span><span class="op" id="3959875">.</span><span class="ident" id="3959876">Host</span>&nbsp;<span class="op" id="3959881">+</span>&nbsp;<span class="string" id="3959883">&#34;&nbsp;because&nbsp;it&nbsp;doesn&#39;t&nbsp;contain&nbsp;any&nbsp;IP&nbsp;SANs&#34;</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3959927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959931">for</span>&nbsp;<span class="ident" id="3959935">_</span><span class="op" id="3959936">,</span>&nbsp;<span class="ident" id="3959938">san</span>&nbsp;<span class="op" id="3959942">:=</span>&nbsp;<span class="keyword" id="3959945">range</span>&nbsp;<span class="ident" id="3959951">c</span><span class="op" id="3959952">.</span><span class="ident" id="3959953">IPAddresses</span>&nbsp;<span class="op" id="3959965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959970">if</span>&nbsp;<span class="builtinfunc" id="3959973">len</span><span class="op" id="3959976">(</span><span class="ident" id="3959977">valid</span><span class="op" id="3959982">)</span>&nbsp;<span class="op" id="3959984">&gt;</span>&nbsp;<span class="num" id="3959986">0</span>&nbsp;<span class="op" id="3959988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3959994">valid</span>&nbsp;<span class="op" id="3960000">+=</span>&nbsp;<span class="string" id="3960003">&#34;,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960011">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3960016">valid</span>&nbsp;<span class="op" id="3960022">+=</span>&nbsp;<span class="ident" id="3960025">san</span><span class="op" id="3960028">.</span><span class="ident" id="3960029">String</span><span class="op" id="3960035">(</span><span class="op" id="3960036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960043">}</span>&nbsp;<span class="keyword" id="3960045">else</span>&nbsp;<span class="op" id="3960050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960054">if</span>&nbsp;<span class="builtinfunc" id="3960057">len</span><span class="op" id="3960060">(</span><span class="ident" id="3960061">c</span><span class="op" id="3960062">.</span><span class="ident" id="3960063">DNSNames</span><span class="op" id="3960071">)</span>&nbsp;<span class="op" id="3960073">&gt;</span>&nbsp;<span class="num" id="3960075">0</span>&nbsp;<span class="op" id="3960077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3960082">valid</span>&nbsp;<span class="op" id="3960088">=</span>&nbsp;<span class="ident" id="3960090">strings</span><span class="op" id="3960097">.</span><span class="ident" id="3960098">Join</span><span class="op" id="3960102">(</span><span class="ident" id="3960103">c</span><span class="op" id="3960104">.</span><span class="ident" id="3960105">DNSNames</span><span class="op" id="3960113">,</span>&nbsp;<span class="string" id="3960115">&#34;,&nbsp;&#34;</span><span class="op" id="3960119">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960123">}</span>&nbsp;<span class="keyword" id="3960125">else</span>&nbsp;<span class="op" id="3960130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3960135">valid</span>&nbsp;<span class="op" id="3960141">=</span>&nbsp;<span class="ident" id="3960143">c</span><span class="op" id="3960144">.</span><span class="ident" id="3960145">Subject</span><span class="op" id="3960152">.</span><span class="ident" id="3960153">CommonName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960172">return</span>&nbsp;<span class="string" id="3960179">&#34;x509:&nbsp;certificate&nbsp;is&nbsp;valid&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="3960213">+</span>&nbsp;<span class="ident" id="3960215">valid</span>&nbsp;<span class="op" id="3960221">+</span>&nbsp;<span class="string" id="3960223">&#34;,&nbsp;not&nbsp;&#34;</span>&nbsp;<span class="op" id="3960232">+</span>&nbsp;<span class="ident" id="3960234">h</span><span class="op" id="3960235">.</span><span class="ident" id="3960236">Host</span><br>
<span class="lineno">90</span><span class="op" id="3960241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3960244">//&nbsp;UnknownAuthorityError&nbsp;results&nbsp;when&nbsp;the&nbsp;certificate&nbsp;issuer&nbsp;is&nbsp;unknown</span><br>
<span class="lineno"></span><span class="keyword" id="3960316">type</span>&nbsp;<span class="ident" id="3960321">UnknownAuthorityError</span>&nbsp;<span class="keyword" id="3960343">struct</span>&nbsp;<span class="op" id="3960350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3960353">cert</span>&nbsp;<span class="op" id="3960358">*</span><span class="ident" id="3960359">Certificate</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3960372">//&nbsp;hintErr&nbsp;contains&nbsp;an&nbsp;error&nbsp;that&nbsp;may&nbsp;be&nbsp;helpful&nbsp;in&nbsp;determining&nbsp;why&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3960444">//&nbsp;authority&nbsp;wasn&#39;t&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3960472">hintErr</span>&nbsp;<span class="builtintype" id="3960480">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3960487">//&nbsp;hintCert&nbsp;contains&nbsp;a&nbsp;possible&nbsp;authority&nbsp;certificate&nbsp;that&nbsp;was&nbsp;rejected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3960560">//&nbsp;because&nbsp;of&nbsp;the&nbsp;error&nbsp;in&nbsp;hintErr.</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3960597">hintCert</span>&nbsp;<span class="op" id="3960606">*</span><span class="ident" id="3960607">Certificate</span><br>
<span class="lineno"></span><span class="op" id="3960619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3960622">func</span>&nbsp;<span class="op" id="3960627">(</span><span class="ident" id="3960628">e</span>&nbsp;<span class="ident" id="3960630">UnknownAuthorityError</span><span class="op" id="3960651">)</span>&nbsp;<span class="ident" id="3960653">Error</span><span class="op" id="3960658">(</span><span class="op" id="3960659">)</span>&nbsp;<span class="builtintype" id="3960661">string</span>&nbsp;<span class="op" id="3960668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3960671">s</span>&nbsp;<span class="op" id="3960673">:=</span>&nbsp;<span class="string" id="3960676">&#34;x509:&nbsp;certificate&nbsp;signed&nbsp;by&nbsp;unknown&nbsp;authority&#34;</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960725">if</span>&nbsp;<span class="ident" id="3960728">e</span><span class="op" id="3960729">.</span><span class="ident" id="3960730">hintErr</span>&nbsp;<span class="op" id="3960738">!=</span>&nbsp;<span class="ident" id="3960741">nil</span>&nbsp;<span class="op" id="3960745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3960749">certName</span>&nbsp;<span class="op" id="3960758">:=</span>&nbsp;<span class="ident" id="3960761">e</span><span class="op" id="3960762">.</span><span class="ident" id="3960763">hintCert</span><span class="op" id="3960771">.</span><span class="ident" id="3960772">Subject</span><span class="op" id="3960779">.</span><span class="ident" id="3960780">CommonName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960793">if</span>&nbsp;<span class="builtinfunc" id="3960796">len</span><span class="op" id="3960799">(</span><span class="ident" id="3960800">certName</span><span class="op" id="3960808">)</span>&nbsp;<span class="op" id="3960810">==</span>&nbsp;<span class="num" id="3960813">0</span>&nbsp;<span class="op" id="3960815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960820">if</span>&nbsp;<span class="builtinfunc" id="3960823">len</span><span class="op" id="3960826">(</span><span class="ident" id="3960827">e</span><span class="op" id="3960828">.</span><span class="ident" id="3960829">hintCert</span><span class="op" id="3960837">.</span><span class="ident" id="3960838">Subject</span><span class="op" id="3960845">.</span><span class="ident" id="3960846">Organization</span><span class="op" id="3960858">)</span>&nbsp;<span class="op" id="3960860">&gt;</span>&nbsp;<span class="num" id="3960862">0</span>&nbsp;<span class="op" id="3960864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3960870">certName</span>&nbsp;<span class="op" id="3960879">=</span>&nbsp;<span class="ident" id="3960881">e</span><span class="op" id="3960882">.</span><span class="ident" id="3960883">hintCert</span><span class="op" id="3960891">.</span><span class="ident" id="3960892">Subject</span><span class="op" id="3960899">.</span><span class="ident" id="3960900">Organization</span><span class="op" id="3960912">[</span><span class="num" id="3960913">0</span><span class="op" id="3960914">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3960924">certName</span>&nbsp;<span class="op" id="3960933">=</span>&nbsp;<span class="string" id="3960935">&#34;serial:&#34;</span>&nbsp;<span class="op" id="3960945">+</span>&nbsp;<span class="ident" id="3960947">e</span><span class="op" id="3960948">.</span><span class="ident" id="3960949">hintCert</span><span class="op" id="3960957">.</span><span class="ident" id="3960958">SerialNumber</span><span class="op" id="3960970">.</span><span class="ident" id="3960971">String</span><span class="op" id="3960977">(</span><span class="op" id="3960978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3960986">s</span>&nbsp;<span class="op" id="3960988">+=</span>&nbsp;<span class="ident" id="3960991">fmt</span><span class="op" id="3960994">.</span><span class="ident" id="3960995">Sprintf</span><span class="op" id="3961002">(</span><span class="string" id="3961003">&#34;&nbsp;(possibly&nbsp;because&nbsp;of&nbsp;%q&nbsp;while&nbsp;trying&nbsp;to&nbsp;verify&nbsp;candidate&nbsp;authority&nbsp;certificate&nbsp;%q)&#34;</span><span class="op" id="3961088">,</span>&nbsp;<span class="ident" id="3961090">e</span><span class="op" id="3961091">.</span><span class="ident" id="3961092">hintErr</span><span class="op" id="3961099">,</span>&nbsp;<span class="ident" id="3961101">certName</span><span class="op" id="3961109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3961112">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3961115">return</span>&nbsp;<span class="ident" id="3961122">s</span><br>
<span class="lineno"></span><span class="op" id="3961124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3961127">//&nbsp;SystemRootsError&nbsp;results&nbsp;when&nbsp;we&nbsp;fail&nbsp;to&nbsp;load&nbsp;the&nbsp;system&nbsp;root&nbsp;certificates.</span><br>
<span class="lineno"></span><span class="keyword" id="3961206">type</span>&nbsp;<span class="ident" id="3961211">SystemRootsError</span>&nbsp;<span class="keyword" id="3961228">struct</span><span class="op" id="3961234">{</span><span class="op" id="3961235">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="keyword" id="3961238">func</span>&nbsp;<span class="op" id="3961243">(</span><span class="ident" id="3961244">SystemRootsError</span><span class="op" id="3961260">)</span>&nbsp;<span class="ident" id="3961262">Error</span><span class="op" id="3961267">(</span><span class="op" id="3961268">)</span>&nbsp;<span class="builtintype" id="3961270">string</span>&nbsp;<span class="op" id="3961277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3961280">return</span>&nbsp;<span class="string" id="3961287">&#34;x509:&nbsp;failed&nbsp;to&nbsp;load&nbsp;system&nbsp;roots&nbsp;and&nbsp;no&nbsp;roots&nbsp;provided&#34;</span><br>
<span class="lineno"></span><span class="op" id="3961345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="3961348">//&nbsp;VerifyOptions&nbsp;contains&nbsp;parameters&nbsp;for&nbsp;Certificate.Verify.&nbsp;It&#39;s&nbsp;a&nbsp;structure</span><br>
<span class="lineno"></span><span class="comment" id="3961426">//&nbsp;because&nbsp;other&nbsp;PKIX&nbsp;verification&nbsp;APIs&nbsp;have&nbsp;ended&nbsp;up&nbsp;needing&nbsp;many&nbsp;options.</span><br>
<span class="lineno"></span><span class="keyword" id="3961502">type</span>&nbsp;<span class="ident" id="3961507">VerifyOptions</span>&nbsp;<span class="keyword" id="3961521">struct</span>&nbsp;<span class="op" id="3961528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3961531">DNSName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3961545">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3961553">Intermediates</span>&nbsp;<span class="op" id="3961567">*</span><span class="ident" id="3961568">CertPool</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3961578">Roots</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3961592">*</span><span class="ident" id="3961593">CertPool</span>&nbsp;<span class="comment" id="3961602">//&nbsp;if&nbsp;nil,&nbsp;the&nbsp;system&nbsp;roots&nbsp;are&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3961640">CurrentTime</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3961654">time</span><span class="op" id="3961658">.</span><span class="ident" id="3961659">Time</span>&nbsp;<span class="comment" id="3961664">//&nbsp;if&nbsp;zero,&nbsp;the&nbsp;current&nbsp;time&nbsp;is&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3961702">//&nbsp;KeyUsage&nbsp;specifies&nbsp;which&nbsp;Extended&nbsp;Key&nbsp;Usage&nbsp;values&nbsp;are&nbsp;acceptable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3961773">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;means&nbsp;ExtKeyUsageServerAuth.&nbsp;Key&nbsp;usage&nbsp;is&nbsp;considered&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3961846">//&nbsp;constraint&nbsp;down&nbsp;the&nbsp;chain&nbsp;which&nbsp;mirrors&nbsp;Windows&nbsp;CryptoAPI&nbsp;behaviour,</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3961919">//&nbsp;but&nbsp;not&nbsp;the&nbsp;spec.&nbsp;To&nbsp;accept&nbsp;any&nbsp;key&nbsp;usage,&nbsp;include&nbsp;ExtKeyUsageAny.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3961990">KeyUsages</span>&nbsp;<span class="op" id="3962000">[</span><span class="op" id="3962001">]</span><span class="ident" id="3962002">ExtKeyUsage</span><br>
<span class="lineno"></span><span class="op" id="3962014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3962017">const</span>&nbsp;<span class="op" id="3962023">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962026">leafCertificate</span>&nbsp;<span class="op" id="3962042">=</span>&nbsp;<span class="ident" id="3962044">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962050">intermediateCertificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962075">rootCertificate</span><br>
<span class="lineno"></span><span class="op" id="3962091">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="3962094">//&nbsp;isValid&nbsp;performs&nbsp;validity&nbsp;checks&nbsp;on&nbsp;the&nbsp;c.</span><br>
<span class="lineno"></span><span class="keyword" id="3962140">func</span>&nbsp;<span class="op" id="3962145">(</span><span class="ident" id="3962146">c</span>&nbsp;<span class="op" id="3962148">*</span><span class="ident" id="3962149">Certificate</span><span class="op" id="3962160">)</span>&nbsp;<span class="ident" id="3962162">isValid</span><span class="op" id="3962169">(</span><span class="ident" id="3962170">certType</span>&nbsp;<span class="builtintype" id="3962179">int</span><span class="op" id="3962182">,</span>&nbsp;<span class="ident" id="3962184">currentChain</span>&nbsp;<span class="op" id="3962197">[</span><span class="op" id="3962198">]</span><span class="op" id="3962199">*</span><span class="ident" id="3962200">Certificate</span><span class="op" id="3962211">,</span>&nbsp;<span class="ident" id="3962213">opts</span>&nbsp;<span class="op" id="3962218">*</span><span class="ident" id="3962219">VerifyOptions</span><span class="op" id="3962232">)</span>&nbsp;<span class="builtintype" id="3962234">error</span>&nbsp;<span class="op" id="3962240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962243">now</span>&nbsp;<span class="op" id="3962247">:=</span>&nbsp;<span class="ident" id="3962250">opts</span><span class="op" id="3962254">.</span><span class="ident" id="3962255">CurrentTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962268">if</span>&nbsp;<span class="ident" id="3962271">now</span><span class="op" id="3962274">.</span><span class="ident" id="3962275">IsZero</span><span class="op" id="3962281">(</span><span class="op" id="3962282">)</span>&nbsp;<span class="op" id="3962284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962288">now</span>&nbsp;<span class="op" id="3962292">=</span>&nbsp;<span class="ident" id="3962294">time</span><span class="op" id="3962298">.</span><span class="ident" id="3962299">Now</span><span class="op" id="3962302">(</span><span class="op" id="3962303">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3962306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962309">if</span>&nbsp;<span class="ident" id="3962312">now</span><span class="op" id="3962315">.</span><span class="ident" id="3962316">Before</span><span class="op" id="3962322">(</span><span class="ident" id="3962323">c</span><span class="op" id="3962324">.</span><span class="ident" id="3962325">NotBefore</span><span class="op" id="3962334">)</span>&nbsp;<span class="op" id="3962336">||</span>&nbsp;<span class="ident" id="3962339">now</span><span class="op" id="3962342">.</span><span class="ident" id="3962343">After</span><span class="op" id="3962348">(</span><span class="ident" id="3962349">c</span><span class="op" id="3962350">.</span><span class="ident" id="3962351">NotAfter</span><span class="op" id="3962359">)</span>&nbsp;<span class="op" id="3962361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962365">return</span>&nbsp;<span class="ident" id="3962372">CertificateInvalidError</span><span class="op" id="3962395">{</span><span class="ident" id="3962396">c</span><span class="op" id="3962397">,</span>&nbsp;<span class="ident" id="3962399">Expired</span><span class="op" id="3962406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3962409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962413">if</span>&nbsp;<span class="builtinfunc" id="3962416">len</span><span class="op" id="3962419">(</span><span class="ident" id="3962420">c</span><span class="op" id="3962421">.</span><span class="ident" id="3962422">PermittedDNSDomains</span><span class="op" id="3962441">)</span>&nbsp;<span class="op" id="3962443">&gt;</span>&nbsp;<span class="num" id="3962445">0</span>&nbsp;<span class="op" id="3962447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962451">ok</span>&nbsp;<span class="op" id="3962454">:=</span>&nbsp;<span class="builtintype" id="3962457">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962465">for</span>&nbsp;<span class="ident" id="3962469">_</span><span class="op" id="3962470">,</span>&nbsp;<span class="ident" id="3962472">domain</span>&nbsp;<span class="op" id="3962479">:=</span>&nbsp;<span class="keyword" id="3962482">range</span>&nbsp;<span class="ident" id="3962488">c</span><span class="op" id="3962489">.</span><span class="ident" id="3962490">PermittedDNSDomains</span>&nbsp;<span class="op" id="3962510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962515">if</span>&nbsp;<span class="ident" id="3962518">opts</span><span class="op" id="3962522">.</span><span class="ident" id="3962523">DNSName</span>&nbsp;<span class="op" id="3962531">==</span>&nbsp;<span class="ident" id="3962534">domain</span>&nbsp;<span class="op" id="3962541">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3962548">(</span><span class="ident" id="3962549">strings</span><span class="op" id="3962556">.</span><span class="ident" id="3962557">HasSuffix</span><span class="op" id="3962566">(</span><span class="ident" id="3962567">opts</span><span class="op" id="3962571">.</span><span class="ident" id="3962572">DNSName</span><span class="op" id="3962579">,</span>&nbsp;<span class="ident" id="3962581">domain</span><span class="op" id="3962587">)</span>&nbsp;<span class="op" id="3962589">&amp;&amp;</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3962597">len</span><span class="op" id="3962600">(</span><span class="ident" id="3962601">opts</span><span class="op" id="3962605">.</span><span class="ident" id="3962606">DNSName</span><span class="op" id="3962613">)</span>&nbsp;<span class="op" id="3962615">&gt;=</span>&nbsp;<span class="num" id="3962618">1</span><span class="op" id="3962619">+</span><span class="builtinfunc" id="3962620">len</span><span class="op" id="3962623">(</span><span class="ident" id="3962624">domain</span><span class="op" id="3962630">)</span>&nbsp;<span class="op" id="3962632">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962640">opts</span><span class="op" id="3962644">.</span><span class="ident" id="3962645">DNSName</span><span class="op" id="3962652">[</span><span class="builtinfunc" id="3962653">len</span><span class="op" id="3962656">(</span><span class="ident" id="3962657">opts</span><span class="op" id="3962661">.</span><span class="ident" id="3962662">DNSName</span><span class="op" id="3962669">)</span><span class="op" id="3962670">-</span><span class="builtinfunc" id="3962671">len</span><span class="op" id="3962674">(</span><span class="ident" id="3962675">domain</span><span class="op" id="3962681">)</span><span class="op" id="3962682">-</span><span class="num" id="3962683">1</span><span class="op" id="3962684">]</span>&nbsp;<span class="op" id="3962686">==</span>&nbsp;<span class="string" id="3962689">&#39;.&#39;</span><span class="op" id="3962692">)</span>&nbsp;<span class="op" id="3962694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962700">ok</span>&nbsp;<span class="op" id="3962703">=</span>&nbsp;<span class="builtintype" id="3962705">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962714">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3962723">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3962727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962732">if</span>&nbsp;<span class="op" id="3962735">!</span><span class="ident" id="3962736">ok</span>&nbsp;<span class="op" id="3962739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962744">return</span>&nbsp;<span class="ident" id="3962751">CertificateInvalidError</span><span class="op" id="3962774">{</span><span class="ident" id="3962775">c</span><span class="op" id="3962776">,</span>&nbsp;<span class="ident" id="3962778">CANotAuthorizedForThisName</span><span class="op" id="3962804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3962808">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3962811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3962815">//&nbsp;KeyUsage&nbsp;status&nbsp;flags&nbsp;are&nbsp;ignored.&nbsp;From&nbsp;Engineering&nbsp;Security,&nbsp;Peter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3962887">//&nbsp;Gutmann:&nbsp;A&nbsp;European&nbsp;government&nbsp;CA&nbsp;marked&nbsp;its&nbsp;signing&nbsp;certificates&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3962960">//&nbsp;being&nbsp;valid&nbsp;for&nbsp;encryption&nbsp;only,&nbsp;but&nbsp;no-one&nbsp;noticed.&nbsp;Another</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963025">//&nbsp;European&nbsp;CA&nbsp;marked&nbsp;its&nbsp;signature&nbsp;keys&nbsp;as&nbsp;not&nbsp;being&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963090">//&nbsp;signatures.&nbsp;A&nbsp;different&nbsp;CA&nbsp;marked&nbsp;its&nbsp;own&nbsp;trusted&nbsp;root&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963161">//&nbsp;as&nbsp;being&nbsp;invalid&nbsp;for&nbsp;certificate&nbsp;signing.&nbsp;&nbsp;Another&nbsp;national&nbsp;CA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963228">//&nbsp;distributed&nbsp;a&nbsp;certificate&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;data&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963293">//&nbsp;country’s&nbsp;tax&nbsp;authority&nbsp;that&nbsp;was&nbsp;marked&nbsp;as&nbsp;only&nbsp;being&nbsp;usable&nbsp;for</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963364">//&nbsp;digital&nbsp;signatures&nbsp;but&nbsp;not&nbsp;for&nbsp;encryption.&nbsp;Yet&nbsp;another&nbsp;CA&nbsp;reversed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963435">//&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bit&nbsp;flags&nbsp;in&nbsp;the&nbsp;keyUsage&nbsp;due&nbsp;to&nbsp;confusion&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963504">//&nbsp;encoding&nbsp;endianness,&nbsp;essentially&nbsp;setting&nbsp;a&nbsp;random&nbsp;keyUsage&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963570">//&nbsp;certificates&nbsp;that&nbsp;it&nbsp;issued.&nbsp;Another&nbsp;CA&nbsp;created&nbsp;a&nbsp;self-invalidating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963642">//&nbsp;certificate&nbsp;by&nbsp;adding&nbsp;a&nbsp;certificate&nbsp;policy&nbsp;statement&nbsp;stipulating</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963711">//&nbsp;that&nbsp;the&nbsp;certificate&nbsp;had&nbsp;to&nbsp;be&nbsp;used&nbsp;strictly&nbsp;as&nbsp;specified&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963780">//&nbsp;keyUsage,&nbsp;and&nbsp;a&nbsp;keyUsage&nbsp;containing&nbsp;a&nbsp;flag&nbsp;indicating&nbsp;that&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963851">//&nbsp;encryption&nbsp;key&nbsp;could&nbsp;only&nbsp;be&nbsp;used&nbsp;for&nbsp;Diffie-Hellman&nbsp;key&nbsp;agreement.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3963924">if</span>&nbsp;<span class="ident" id="3963927">certType</span>&nbsp;<span class="op" id="3963936">==</span>&nbsp;<span class="ident" id="3963939">intermediateCertificate</span>&nbsp;<span class="op" id="3963963">&amp;&amp;</span>&nbsp;<span class="op" id="3963966">(</span><span class="op" id="3963967">!</span><span class="ident" id="3963968">c</span><span class="op" id="3963969">.</span><span class="ident" id="3963970">BasicConstraintsValid</span>&nbsp;<span class="op" id="3963992">||</span>&nbsp;<span class="op" id="3963995">!</span><span class="ident" id="3963996">c</span><span class="op" id="3963997">.</span><span class="ident" id="3963998">IsCA</span><span class="op" id="3964002">)</span>&nbsp;<span class="op" id="3964004">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964008">return</span>&nbsp;<span class="ident" id="3964015">CertificateInvalidError</span><span class="op" id="3964038">{</span><span class="ident" id="3964039">c</span><span class="op" id="3964040">,</span>&nbsp;<span class="ident" id="3964042">NotAuthorizedToSign</span><span class="op" id="3964061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3964064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964068">if</span>&nbsp;<span class="ident" id="3964071">c</span><span class="op" id="3964072">.</span><span class="ident" id="3964073">BasicConstraintsValid</span>&nbsp;<span class="op" id="3964095">&amp;&amp;</span>&nbsp;<span class="ident" id="3964098">c</span><span class="op" id="3964099">.</span><span class="ident" id="3964100">MaxPathLen</span>&nbsp;<span class="op" id="3964111">&gt;=</span>&nbsp;<span class="num" id="3964114">0</span>&nbsp;<span class="op" id="3964116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3964120">numIntermediates</span>&nbsp;<span class="op" id="3964137">:=</span>&nbsp;<span class="builtinfunc" id="3964140">len</span><span class="op" id="3964143">(</span><span class="ident" id="3964144">currentChain</span><span class="op" id="3964156">)</span>&nbsp;<span class="op" id="3964158">-</span>&nbsp;<span class="num" id="3964160">1</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964164">if</span>&nbsp;<span class="ident" id="3964167">numIntermediates</span>&nbsp;<span class="op" id="3964184">&gt;</span>&nbsp;<span class="ident" id="3964186">c</span><span class="op" id="3964187">.</span><span class="ident" id="3964188">MaxPathLen</span>&nbsp;<span class="op" id="3964199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964204">return</span>&nbsp;<span class="ident" id="3964211">CertificateInvalidError</span><span class="op" id="3964234">{</span><span class="ident" id="3964235">c</span><span class="op" id="3964236">,</span>&nbsp;<span class="ident" id="3964238">TooManyIntermediates</span><span class="op" id="3964258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3964262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3964265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964269">return</span>&nbsp;<span class="ident" id="3964276">nil</span><br>
<span class="lineno"></span><span class="op" id="3964280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3964283">//&nbsp;Verify&nbsp;attempts&nbsp;to&nbsp;verify&nbsp;c&nbsp;by&nbsp;building&nbsp;one&nbsp;or&nbsp;more&nbsp;chains&nbsp;from&nbsp;c&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3964357">//&nbsp;certificate&nbsp;in&nbsp;opts.Roots,&nbsp;using&nbsp;certificates&nbsp;in&nbsp;opts.Intermediates&nbsp;if</span><br>
<span class="lineno">205</span><span class="comment" id="3964431">//&nbsp;needed.&nbsp;If&nbsp;successful,&nbsp;it&nbsp;returns&nbsp;one&nbsp;or&nbsp;more&nbsp;chains&nbsp;where&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="3964503">//&nbsp;element&nbsp;of&nbsp;the&nbsp;chain&nbsp;is&nbsp;c&nbsp;and&nbsp;the&nbsp;last&nbsp;element&nbsp;is&nbsp;from&nbsp;opts.Roots.</span><br>
<span class="lineno"></span><span class="comment" id="3964573">//</span><br>
<span class="lineno"></span><span class="comment" id="3964576">//&nbsp;If&nbsp;opts.Roots&nbsp;is&nbsp;nil&nbsp;and&nbsp;system&nbsp;roots&nbsp;are&nbsp;unavailable&nbsp;the&nbsp;returned&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3964652">//&nbsp;will&nbsp;be&nbsp;of&nbsp;type&nbsp;SystemRootsError.</span><br>
<span class="lineno">210</span><span class="comment" id="3964689">//</span><br>
<span class="lineno"></span><span class="comment" id="3964692">//&nbsp;WARNING:&nbsp;this&nbsp;doesn&#39;t&nbsp;do&nbsp;any&nbsp;revocation&nbsp;checking.</span><br>
<span class="lineno"></span><span class="keyword" id="3964745">func</span>&nbsp;<span class="op" id="3964750">(</span><span class="ident" id="3964751">c</span>&nbsp;<span class="op" id="3964753">*</span><span class="ident" id="3964754">Certificate</span><span class="op" id="3964765">)</span>&nbsp;<span class="ident" id="3964767">Verify</span><span class="op" id="3964773">(</span><span class="ident" id="3964774">opts</span>&nbsp;<span class="ident" id="3964779">VerifyOptions</span><span class="op" id="3964792">)</span>&nbsp;<span class="op" id="3964794">(</span><span class="ident" id="3964795">chains</span>&nbsp;<span class="op" id="3964802">[</span><span class="op" id="3964803">]</span><span class="op" id="3964804">[</span><span class="op" id="3964805">]</span><span class="op" id="3964806">*</span><span class="ident" id="3964807">Certificate</span><span class="op" id="3964818">,</span>&nbsp;<span class="ident" id="3964820">err</span>&nbsp;<span class="builtintype" id="3964824">error</span><span class="op" id="3964829">)</span>&nbsp;<span class="op" id="3964831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3964834">//&nbsp;Use&nbsp;Windows&#39;s&nbsp;own&nbsp;verification&nbsp;and&nbsp;chain&nbsp;building.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964889">if</span>&nbsp;<span class="ident" id="3964892">opts</span><span class="op" id="3964896">.</span><span class="ident" id="3964897">Roots</span>&nbsp;<span class="op" id="3964903">==</span>&nbsp;<span class="ident" id="3964906">nil</span>&nbsp;<span class="op" id="3964910">&amp;&amp;</span>&nbsp;<span class="ident" id="3964913">runtime</span><span class="op" id="3964920">.</span><span class="ident" id="3964921">GOOS</span>&nbsp;<span class="op" id="3964926">==</span>&nbsp;<span class="string" id="3964929">&#34;windows&#34;</span>&nbsp;<span class="op" id="3964939">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964943">return</span>&nbsp;<span class="ident" id="3964950">c</span><span class="op" id="3964951">.</span><span class="ident" id="3964952">systemVerify</span><span class="op" id="3964964">(</span><span class="op" id="3964965">&amp;</span><span class="ident" id="3964966">opts</span><span class="op" id="3964970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3964973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964977">if</span>&nbsp;<span class="ident" id="3964980">opts</span><span class="op" id="3964984">.</span><span class="ident" id="3964985">Roots</span>&nbsp;<span class="op" id="3964991">==</span>&nbsp;<span class="ident" id="3964994">nil</span>&nbsp;<span class="op" id="3964998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965002">opts</span><span class="op" id="3965006">.</span><span class="ident" id="3965007">Roots</span>&nbsp;<span class="op" id="3965013">=</span>&nbsp;<span class="ident" id="3965015">systemRootsPool</span><span class="op" id="3965030">(</span><span class="op" id="3965031">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965035">if</span>&nbsp;<span class="ident" id="3965038">opts</span><span class="op" id="3965042">.</span><span class="ident" id="3965043">Roots</span>&nbsp;<span class="op" id="3965049">==</span>&nbsp;<span class="ident" id="3965052">nil</span>&nbsp;<span class="op" id="3965056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965061">return</span>&nbsp;<span class="ident" id="3965068">nil</span><span class="op" id="3965071">,</span>&nbsp;<span class="ident" id="3965073">SystemRootsError</span><span class="op" id="3965089">{</span><span class="op" id="3965090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965101">err</span>&nbsp;<span class="op" id="3965105">=</span>&nbsp;<span class="ident" id="3965107">c</span><span class="op" id="3965108">.</span><span class="ident" id="3965109">isValid</span><span class="op" id="3965116">(</span><span class="ident" id="3965117">leafCertificate</span><span class="op" id="3965132">,</span>&nbsp;<span class="ident" id="3965134">nil</span><span class="op" id="3965137">,</span>&nbsp;<span class="op" id="3965139">&amp;</span><span class="ident" id="3965140">opts</span><span class="op" id="3965144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965147">if</span>&nbsp;<span class="ident" id="3965150">err</span>&nbsp;<span class="op" id="3965154">!=</span>&nbsp;<span class="ident" id="3965157">nil</span>&nbsp;<span class="op" id="3965161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965165">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965177">if</span>&nbsp;<span class="builtinfunc" id="3965180">len</span><span class="op" id="3965183">(</span><span class="ident" id="3965184">opts</span><span class="op" id="3965188">.</span><span class="ident" id="3965189">DNSName</span><span class="op" id="3965196">)</span>&nbsp;<span class="op" id="3965198">&gt;</span>&nbsp;<span class="num" id="3965200">0</span>&nbsp;<span class="op" id="3965202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965206">err</span>&nbsp;<span class="op" id="3965210">=</span>&nbsp;<span class="ident" id="3965212">c</span><span class="op" id="3965213">.</span><span class="ident" id="3965214">VerifyHostname</span><span class="op" id="3965228">(</span><span class="ident" id="3965229">opts</span><span class="op" id="3965233">.</span><span class="ident" id="3965234">DNSName</span><span class="op" id="3965241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965245">if</span>&nbsp;<span class="ident" id="3965248">err</span>&nbsp;<span class="op" id="3965252">!=</span>&nbsp;<span class="ident" id="3965255">nil</span>&nbsp;<span class="op" id="3965259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965264">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965273">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965280">candidateChains</span><span class="op" id="3965295">,</span>&nbsp;<span class="ident" id="3965297">err</span>&nbsp;<span class="op" id="3965301">:=</span>&nbsp;<span class="ident" id="3965304">c</span><span class="op" id="3965305">.</span><span class="ident" id="3965306">buildChains</span><span class="op" id="3965317">(</span><span class="builtinfunc" id="3965318">make</span><span class="op" id="3965322">(</span><span class="keyword" id="3965323">map</span><span class="op" id="3965326">[</span><span class="builtintype" id="3965327">int</span><span class="op" id="3965330">]</span><span class="op" id="3965331">[</span><span class="op" id="3965332">]</span><span class="op" id="3965333">[</span><span class="op" id="3965334">]</span><span class="op" id="3965335">*</span><span class="ident" id="3965336">Certificate</span><span class="op" id="3965347">)</span><span class="op" id="3965348">,</span>&nbsp;<span class="op" id="3965350">[</span><span class="op" id="3965351">]</span><span class="op" id="3965352">*</span><span class="ident" id="3965353">Certificate</span><span class="op" id="3965364">{</span><span class="ident" id="3965365">c</span><span class="op" id="3965366">}</span><span class="op" id="3965367">,</span>&nbsp;<span class="op" id="3965369">&amp;</span><span class="ident" id="3965370">opts</span><span class="op" id="3965374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965377">if</span>&nbsp;<span class="ident" id="3965380">err</span>&nbsp;<span class="op" id="3965384">!=</span>&nbsp;<span class="ident" id="3965387">nil</span>&nbsp;<span class="op" id="3965391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965395">return</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965407">keyUsages</span>&nbsp;<span class="op" id="3965417">:=</span>&nbsp;<span class="ident" id="3965420">opts</span><span class="op" id="3965424">.</span><span class="ident" id="3965425">KeyUsages</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965436">if</span>&nbsp;<span class="builtinfunc" id="3965439">len</span><span class="op" id="3965442">(</span><span class="ident" id="3965443">keyUsages</span><span class="op" id="3965452">)</span>&nbsp;<span class="op" id="3965454">==</span>&nbsp;<span class="num" id="3965457">0</span>&nbsp;<span class="op" id="3965459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965463">keyUsages</span>&nbsp;<span class="op" id="3965473">=</span>&nbsp;<span class="op" id="3965475">[</span><span class="op" id="3965476">]</span><span class="ident" id="3965477">ExtKeyUsage</span><span class="op" id="3965488">{</span><span class="ident" id="3965489">ExtKeyUsageServerAuth</span><span class="op" id="3965510">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3965517">//&nbsp;If&nbsp;any&nbsp;key&nbsp;usage&nbsp;is&nbsp;acceptable&nbsp;then&nbsp;we&#39;re&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965569">for</span>&nbsp;<span class="ident" id="3965573">_</span><span class="op" id="3965574">,</span>&nbsp;<span class="ident" id="3965576">usage</span>&nbsp;<span class="op" id="3965582">:=</span>&nbsp;<span class="keyword" id="3965585">range</span>&nbsp;<span class="ident" id="3965591">keyUsages</span>&nbsp;<span class="op" id="3965601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965605">if</span>&nbsp;<span class="ident" id="3965608">usage</span>&nbsp;<span class="op" id="3965614">==</span>&nbsp;<span class="ident" id="3965617">ExtKeyUsageAny</span>&nbsp;<span class="op" id="3965632">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965637">chains</span>&nbsp;<span class="op" id="3965644">=</span>&nbsp;<span class="ident" id="3965646">candidateChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965665">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965681">for</span>&nbsp;<span class="ident" id="3965685">_</span><span class="op" id="3965686">,</span>&nbsp;<span class="ident" id="3965688">candidate</span>&nbsp;<span class="op" id="3965698">:=</span>&nbsp;<span class="keyword" id="3965701">range</span>&nbsp;<span class="ident" id="3965707">candidateChains</span>&nbsp;<span class="op" id="3965723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965727">if</span>&nbsp;<span class="ident" id="3965730">checkChainForKeyUsage</span><span class="op" id="3965751">(</span><span class="ident" id="3965752">candidate</span><span class="op" id="3965761">,</span>&nbsp;<span class="ident" id="3965763">keyUsages</span><span class="op" id="3965772">)</span>&nbsp;<span class="op" id="3965774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965779">chains</span>&nbsp;<span class="op" id="3965786">=</span>&nbsp;<span class="builtinfunc" id="3965788">append</span><span class="op" id="3965794">(</span><span class="ident" id="3965795">chains</span><span class="op" id="3965801">,</span>&nbsp;<span class="ident" id="3965803">candidate</span><span class="op" id="3965812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965819">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965823">if</span>&nbsp;<span class="builtinfunc" id="3965826">len</span><span class="op" id="3965829">(</span><span class="ident" id="3965830">chains</span><span class="op" id="3965836">)</span>&nbsp;<span class="op" id="3965838">==</span>&nbsp;<span class="num" id="3965841">0</span>&nbsp;<span class="op" id="3965843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965847">err</span>&nbsp;<span class="op" id="3965851">=</span>&nbsp;<span class="ident" id="3965853">CertificateInvalidError</span><span class="op" id="3965876">{</span><span class="ident" id="3965877">c</span><span class="op" id="3965878">,</span>&nbsp;<span class="ident" id="3965880">IncompatibleUsage</span><span class="op" id="3965897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965904">return</span><br>
<span class="lineno"></span><span class="op" id="3965911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3965914">func</span>&nbsp;<span class="ident" id="3965919">appendToFreshChain</span><span class="op" id="3965937">(</span><span class="ident" id="3965938">chain</span>&nbsp;<span class="op" id="3965944">[</span><span class="op" id="3965945">]</span><span class="op" id="3965946">*</span><span class="ident" id="3965947">Certificate</span><span class="op" id="3965958">,</span>&nbsp;<span class="ident" id="3965960">cert</span>&nbsp;<span class="op" id="3965965">*</span><span class="ident" id="3965966">Certificate</span><span class="op" id="3965977">)</span>&nbsp;<span class="op" id="3965979">[</span><span class="op" id="3965980">]</span><span class="op" id="3965981">*</span><span class="ident" id="3965982">Certificate</span>&nbsp;<span class="op" id="3965994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965997">n</span>&nbsp;<span class="op" id="3965999">:=</span>&nbsp;<span class="builtinfunc" id="3966002">make</span><span class="op" id="3966006">(</span><span class="op" id="3966007">[</span><span class="op" id="3966008">]</span><span class="op" id="3966009">*</span><span class="ident" id="3966010">Certificate</span><span class="op" id="3966021">,</span>&nbsp;<span class="builtinfunc" id="3966023">len</span><span class="op" id="3966026">(</span><span class="ident" id="3966027">chain</span><span class="op" id="3966032">)</span><span class="op" id="3966033">+</span><span class="num" id="3966034">1</span><span class="op" id="3966035">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3966038">copy</span><span class="op" id="3966042">(</span><span class="ident" id="3966043">n</span><span class="op" id="3966044">,</span>&nbsp;<span class="ident" id="3966046">chain</span><span class="op" id="3966051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966054">n</span><span class="op" id="3966055">[</span><span class="builtinfunc" id="3966056">len</span><span class="op" id="3966059">(</span><span class="ident" id="3966060">chain</span><span class="op" id="3966065">)</span><span class="op" id="3966066">]</span>&nbsp;<span class="op" id="3966068">=</span>&nbsp;<span class="ident" id="3966070">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966076">return</span>&nbsp;<span class="ident" id="3966083">n</span><br>
<span class="lineno"></span><span class="op" id="3966085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="3966088">func</span>&nbsp;<span class="op" id="3966093">(</span><span class="ident" id="3966094">c</span>&nbsp;<span class="op" id="3966096">*</span><span class="ident" id="3966097">Certificate</span><span class="op" id="3966108">)</span>&nbsp;<span class="ident" id="3966110">buildChains</span><span class="op" id="3966121">(</span><span class="ident" id="3966122">cache</span>&nbsp;<span class="keyword" id="3966128">map</span><span class="op" id="3966131">[</span><span class="builtintype" id="3966132">int</span><span class="op" id="3966135">]</span><span class="op" id="3966136">[</span><span class="op" id="3966137">]</span><span class="op" id="3966138">[</span><span class="op" id="3966139">]</span><span class="op" id="3966140">*</span><span class="ident" id="3966141">Certificate</span><span class="op" id="3966152">,</span>&nbsp;<span class="ident" id="3966154">currentChain</span>&nbsp;<span class="op" id="3966167">[</span><span class="op" id="3966168">]</span><span class="op" id="3966169">*</span><span class="ident" id="3966170">Certificate</span><span class="op" id="3966181">,</span>&nbsp;<span class="ident" id="3966183">opts</span>&nbsp;<span class="op" id="3966188">*</span><span class="ident" id="3966189">VerifyOptions</span><span class="op" id="3966202">)</span>&nbsp;<span class="op" id="3966204">(</span><span class="ident" id="3966205">chains</span>&nbsp;<span class="op" id="3966212">[</span><span class="op" id="3966213">]</span><span class="op" id="3966214">[</span><span class="op" id="3966215">]</span><span class="op" id="3966216">*</span><span class="ident" id="3966217">Certificate</span><span class="op" id="3966228">,</span>&nbsp;<span class="ident" id="3966230">err</span>&nbsp;<span class="builtintype" id="3966234">error</span><span class="op" id="3966239">)</span>&nbsp;<span class="op" id="3966241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966244">possibleRoots</span><span class="op" id="3966257">,</span>&nbsp;<span class="ident" id="3966259">failedRoot</span><span class="op" id="3966269">,</span>&nbsp;<span class="ident" id="3966271">rootErr</span>&nbsp;<span class="op" id="3966279">:=</span>&nbsp;<span class="ident" id="3966282">opts</span><span class="op" id="3966286">.</span><span class="ident" id="3966287">Roots</span><span class="op" id="3966292">.</span><span class="ident" id="3966293">findVerifiedParents</span><span class="op" id="3966312">(</span><span class="ident" id="3966313">c</span><span class="op" id="3966314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966317">for</span>&nbsp;<span class="ident" id="3966321">_</span><span class="op" id="3966322">,</span>&nbsp;<span class="ident" id="3966324">rootNum</span>&nbsp;<span class="op" id="3966332">:=</span>&nbsp;<span class="keyword" id="3966335">range</span>&nbsp;<span class="ident" id="3966341">possibleRoots</span>&nbsp;<span class="op" id="3966355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966359">root</span>&nbsp;<span class="op" id="3966364">:=</span>&nbsp;<span class="ident" id="3966367">opts</span><span class="op" id="3966371">.</span><span class="ident" id="3966372">Roots</span><span class="op" id="3966377">.</span><span class="ident" id="3966378">certs</span><span class="op" id="3966383">[</span><span class="ident" id="3966384">rootNum</span><span class="op" id="3966391">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966395">err</span>&nbsp;<span class="op" id="3966399">=</span>&nbsp;<span class="ident" id="3966401">root</span><span class="op" id="3966405">.</span><span class="ident" id="3966406">isValid</span><span class="op" id="3966413">(</span><span class="ident" id="3966414">rootCertificate</span><span class="op" id="3966429">,</span>&nbsp;<span class="ident" id="3966431">currentChain</span><span class="op" id="3966443">,</span>&nbsp;<span class="ident" id="3966445">opts</span><span class="op" id="3966449">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966453">if</span>&nbsp;<span class="ident" id="3966456">err</span>&nbsp;<span class="op" id="3966460">!=</span>&nbsp;<span class="ident" id="3966463">nil</span>&nbsp;<span class="op" id="3966467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966472">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966487">chains</span>&nbsp;<span class="op" id="3966494">=</span>&nbsp;<span class="builtinfunc" id="3966496">append</span><span class="op" id="3966502">(</span><span class="ident" id="3966503">chains</span><span class="op" id="3966509">,</span>&nbsp;<span class="ident" id="3966511">appendToFreshChain</span><span class="op" id="3966529">(</span><span class="ident" id="3966530">currentChain</span><span class="op" id="3966542">,</span>&nbsp;<span class="ident" id="3966544">root</span><span class="op" id="3966548">)</span><span class="op" id="3966549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966552">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966556">possibleIntermediates</span><span class="op" id="3966577">,</span>&nbsp;<span class="ident" id="3966579">failedIntermediate</span><span class="op" id="3966597">,</span>&nbsp;<span class="ident" id="3966599">intermediateErr</span>&nbsp;<span class="op" id="3966615">:=</span>&nbsp;<span class="ident" id="3966618">opts</span><span class="op" id="3966622">.</span><span class="ident" id="3966623">Intermediates</span><span class="op" id="3966636">.</span><span class="ident" id="3966637">findVerifiedParents</span><span class="op" id="3966656">(</span><span class="ident" id="3966657">c</span><span class="op" id="3966658">)</span><br>
<span class="lineno"></span><span class="ident" id="3966660">nextIntermediate</span><span class="op" id="3966676">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966679">for</span>&nbsp;<span class="ident" id="3966683">_</span><span class="op" id="3966684">,</span>&nbsp;<span class="ident" id="3966686">intermediateNum</span>&nbsp;<span class="op" id="3966702">:=</span>&nbsp;<span class="keyword" id="3966705">range</span>&nbsp;<span class="ident" id="3966711">possibleIntermediates</span>&nbsp;<span class="op" id="3966733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966737">intermediate</span>&nbsp;<span class="op" id="3966750">:=</span>&nbsp;<span class="ident" id="3966753">opts</span><span class="op" id="3966757">.</span><span class="ident" id="3966758">Intermediates</span><span class="op" id="3966771">.</span><span class="ident" id="3966772">certs</span><span class="op" id="3966777">[</span><span class="ident" id="3966778">intermediateNum</span><span class="op" id="3966793">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966797">for</span>&nbsp;<span class="ident" id="3966801">_</span><span class="op" id="3966802">,</span>&nbsp;<span class="ident" id="3966804">cert</span>&nbsp;<span class="op" id="3966809">:=</span>&nbsp;<span class="keyword" id="3966812">range</span>&nbsp;<span class="ident" id="3966818">currentChain</span>&nbsp;<span class="op" id="3966831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966836">if</span>&nbsp;<span class="ident" id="3966839">cert</span>&nbsp;<span class="op" id="3966844">==</span>&nbsp;<span class="ident" id="3966847">intermediate</span>&nbsp;<span class="op" id="3966860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966866">continue</span>&nbsp;<span class="ident" id="3966875">nextIntermediate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966899">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966903">err</span>&nbsp;<span class="op" id="3966907">=</span>&nbsp;<span class="ident" id="3966909">intermediate</span><span class="op" id="3966921">.</span><span class="ident" id="3966922">isValid</span><span class="op" id="3966929">(</span><span class="ident" id="3966930">intermediateCertificate</span><span class="op" id="3966953">,</span>&nbsp;<span class="ident" id="3966955">currentChain</span><span class="op" id="3966967">,</span>&nbsp;<span class="ident" id="3966969">opts</span><span class="op" id="3966973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966977">if</span>&nbsp;<span class="ident" id="3966980">err</span>&nbsp;<span class="op" id="3966984">!=</span>&nbsp;<span class="ident" id="3966987">nil</span>&nbsp;<span class="op" id="3966991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966996">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3967007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967011">var</span>&nbsp;<span class="ident" id="3967015">childChains</span>&nbsp;<span class="op" id="3967027">[</span><span class="op" id="3967028">]</span><span class="op" id="3967029">[</span><span class="op" id="3967030">]</span><span class="op" id="3967031">*</span><span class="ident" id="3967032">Certificate</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967046">childChains</span><span class="op" id="3967057">,</span>&nbsp;<span class="ident" id="3967059">ok</span>&nbsp;<span class="op" id="3967062">:=</span>&nbsp;<span class="ident" id="3967065">cache</span><span class="op" id="3967070">[</span><span class="ident" id="3967071">intermediateNum</span><span class="op" id="3967086">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967090">if</span>&nbsp;<span class="op" id="3967093">!</span><span class="ident" id="3967094">ok</span>&nbsp;<span class="op" id="3967097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967102">childChains</span><span class="op" id="3967113">,</span>&nbsp;<span class="ident" id="3967115">err</span>&nbsp;<span class="op" id="3967119">=</span>&nbsp;<span class="ident" id="3967121">intermediate</span><span class="op" id="3967133">.</span><span class="ident" id="3967134">buildChains</span><span class="op" id="3967145">(</span><span class="ident" id="3967146">cache</span><span class="op" id="3967151">,</span>&nbsp;<span class="ident" id="3967153">appendToFreshChain</span><span class="op" id="3967171">(</span><span class="ident" id="3967172">currentChain</span><span class="op" id="3967184">,</span>&nbsp;<span class="ident" id="3967186">intermediate</span><span class="op" id="3967198">)</span><span class="op" id="3967199">,</span>&nbsp;<span class="ident" id="3967201">opts</span><span class="op" id="3967205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967210">cache</span><span class="op" id="3967215">[</span><span class="ident" id="3967216">intermediateNum</span><span class="op" id="3967231">]</span>&nbsp;<span class="op" id="3967233">=</span>&nbsp;<span class="ident" id="3967235">childChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3967249">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967253">chains</span>&nbsp;<span class="op" id="3967260">=</span>&nbsp;<span class="builtinfunc" id="3967262">append</span><span class="op" id="3967268">(</span><span class="ident" id="3967269">chains</span><span class="op" id="3967275">,</span>&nbsp;<span class="ident" id="3967277">childChains</span><span class="op" id="3967288">...</span><span class="op" id="3967291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3967294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967298">if</span>&nbsp;<span class="builtinfunc" id="3967301">len</span><span class="op" id="3967304">(</span><span class="ident" id="3967305">chains</span><span class="op" id="3967311">)</span>&nbsp;<span class="op" id="3967313">&gt;</span>&nbsp;<span class="num" id="3967315">0</span>&nbsp;<span class="op" id="3967317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967321">err</span>&nbsp;<span class="op" id="3967325">=</span>&nbsp;<span class="ident" id="3967327">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3967332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967336">if</span>&nbsp;<span class="builtinfunc" id="3967339">len</span><span class="op" id="3967342">(</span><span class="ident" id="3967343">chains</span><span class="op" id="3967349">)</span>&nbsp;<span class="op" id="3967351">==</span>&nbsp;<span class="num" id="3967354">0</span>&nbsp;<span class="op" id="3967356">&amp;&amp;</span>&nbsp;<span class="ident" id="3967359">err</span>&nbsp;<span class="op" id="3967363">==</span>&nbsp;<span class="ident" id="3967366">nil</span>&nbsp;<span class="op" id="3967370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967374">hintErr</span>&nbsp;<span class="op" id="3967382">:=</span>&nbsp;<span class="ident" id="3967385">rootErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967395">hintCert</span>&nbsp;<span class="op" id="3967404">:=</span>&nbsp;<span class="ident" id="3967407">failedRoot</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967420">if</span>&nbsp;<span class="ident" id="3967423">hintErr</span>&nbsp;<span class="op" id="3967431">==</span>&nbsp;<span class="ident" id="3967434">nil</span>&nbsp;<span class="op" id="3967438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967443">hintErr</span>&nbsp;<span class="op" id="3967451">=</span>&nbsp;<span class="ident" id="3967453">intermediateErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967472">hintCert</span>&nbsp;<span class="op" id="3967481">=</span>&nbsp;<span class="ident" id="3967483">failedIntermediate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3967504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967508">err</span>&nbsp;<span class="op" id="3967512">=</span>&nbsp;<span class="ident" id="3967514">UnknownAuthorityError</span><span class="op" id="3967535">{</span><span class="ident" id="3967536">c</span><span class="op" id="3967537">,</span>&nbsp;<span class="ident" id="3967539">hintErr</span><span class="op" id="3967546">,</span>&nbsp;<span class="ident" id="3967548">hintCert</span><span class="op" id="3967556">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3967559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967563">return</span><br>
<span class="lineno"></span><span class="op" id="3967570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="keyword" id="3967573">func</span>&nbsp;<span class="ident" id="3967578">matchHostnames</span><span class="op" id="3967592">(</span><span class="ident" id="3967593">pattern</span><span class="op" id="3967600">,</span>&nbsp;<span class="ident" id="3967602">host</span>&nbsp;<span class="builtintype" id="3967607">string</span><span class="op" id="3967613">)</span>&nbsp;<span class="builtintype" id="3967615">bool</span>&nbsp;<span class="op" id="3967620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967623">if</span>&nbsp;<span class="builtinfunc" id="3967626">len</span><span class="op" id="3967629">(</span><span class="ident" id="3967630">pattern</span><span class="op" id="3967637">)</span>&nbsp;<span class="op" id="3967639">==</span>&nbsp;<span class="num" id="3967642">0</span>&nbsp;<span class="op" id="3967644">||</span>&nbsp;<span class="builtinfunc" id="3967647">len</span><span class="op" id="3967650">(</span><span class="ident" id="3967651">host</span><span class="op" id="3967655">)</span>&nbsp;<span class="op" id="3967657">==</span>&nbsp;<span class="num" id="3967660">0</span>&nbsp;<span class="op" id="3967662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967666">return</span>&nbsp;<span class="builtintype" id="3967673">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3967680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967684">patternParts</span>&nbsp;<span class="op" id="3967697">:=</span>&nbsp;<span class="ident" id="3967700">strings</span><span class="op" id="3967707">.</span><span class="ident" id="3967708">Split</span><span class="op" id="3967713">(</span><span class="ident" id="3967714">pattern</span><span class="op" id="3967721">,</span>&nbsp;<span class="string" id="3967723">&#34;.&#34;</span><span class="op" id="3967726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967729">hostParts</span>&nbsp;<span class="op" id="3967739">:=</span>&nbsp;<span class="ident" id="3967742">strings</span><span class="op" id="3967749">.</span><span class="ident" id="3967750">Split</span><span class="op" id="3967755">(</span><span class="ident" id="3967756">host</span><span class="op" id="3967760">,</span>&nbsp;<span class="string" id="3967762">&#34;.&#34;</span><span class="op" id="3967765">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967769">if</span>&nbsp;<span class="builtinfunc" id="3967772">len</span><span class="op" id="3967775">(</span><span class="ident" id="3967776">patternParts</span><span class="op" id="3967788">)</span>&nbsp;<span class="op" id="3967790">!=</span>&nbsp;<span class="builtinfunc" id="3967793">len</span><span class="op" id="3967796">(</span><span class="ident" id="3967797">hostParts</span><span class="op" id="3967806">)</span>&nbsp;<span class="op" id="3967808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967812">return</span>&nbsp;<span class="builtintype" id="3967819">false</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3967826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967830">for</span>&nbsp;<span class="ident" id="3967834">i</span><span class="op" id="3967835">,</span>&nbsp;<span class="ident" id="3967837">patternPart</span>&nbsp;<span class="op" id="3967849">:=</span>&nbsp;<span class="keyword" id="3967852">range</span>&nbsp;<span class="ident" id="3967858">patternParts</span>&nbsp;<span class="op" id="3967871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967875">if</span>&nbsp;<span class="ident" id="3967878">patternPart</span>&nbsp;<span class="op" id="3967890">==</span>&nbsp;<span class="string" id="3967893">&#34;*&#34;</span>&nbsp;<span class="op" id="3967897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967902">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3967913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967917">if</span>&nbsp;<span class="ident" id="3967920">patternPart</span>&nbsp;<span class="op" id="3967932">!=</span>&nbsp;<span class="ident" id="3967935">hostParts</span><span class="op" id="3967944">[</span><span class="ident" id="3967945">i</span><span class="op" id="3967946">]</span>&nbsp;<span class="op" id="3967948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967953">return</span>&nbsp;<span class="builtintype" id="3967960">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3967968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3967971">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967975">return</span>&nbsp;<span class="builtintype" id="3967982">true</span><br>
<span class="lineno"></span><span class="op" id="3967987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3967990">//&nbsp;toLowerCaseASCII&nbsp;returns&nbsp;a&nbsp;lower-case&nbsp;version&nbsp;of&nbsp;in.&nbsp;See&nbsp;RFC&nbsp;6125&nbsp;6.4.1.&nbsp;We&nbsp;use</span><br>
<span class="lineno">350</span><span class="comment" id="3968073">//&nbsp;an&nbsp;explicitly&nbsp;ASCII&nbsp;function&nbsp;to&nbsp;avoid&nbsp;any&nbsp;sharp&nbsp;corners&nbsp;resulting&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="3968147">//&nbsp;performing&nbsp;Unicode&nbsp;operations&nbsp;on&nbsp;DNS&nbsp;labels.</span><br>
<span class="lineno"></span><span class="keyword" id="3968195">func</span>&nbsp;<span class="ident" id="3968200">toLowerCaseASCII</span><span class="op" id="3968216">(</span><span class="ident" id="3968217">in</span>&nbsp;<span class="builtintype" id="3968220">string</span><span class="op" id="3968226">)</span>&nbsp;<span class="builtintype" id="3968228">string</span>&nbsp;<span class="op" id="3968235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3968238">//&nbsp;If&nbsp;the&nbsp;string&nbsp;is&nbsp;already&nbsp;lower-case&nbsp;then&nbsp;there&#39;s&nbsp;nothing&nbsp;to&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968306">isAlreadyLowerCase</span>&nbsp;<span class="op" id="3968325">:=</span>&nbsp;<span class="builtintype" id="3968328">true</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968334">for</span>&nbsp;<span class="ident" id="3968338">_</span><span class="op" id="3968339">,</span>&nbsp;<span class="ident" id="3968341">c</span>&nbsp;<span class="op" id="3968343">:=</span>&nbsp;<span class="keyword" id="3968346">range</span>&nbsp;<span class="ident" id="3968352">in</span>&nbsp;<span class="op" id="3968355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968359">if</span>&nbsp;<span class="ident" id="3968362">c</span>&nbsp;<span class="op" id="3968364">==</span>&nbsp;<span class="ident" id="3968367">utf8</span><span class="op" id="3968371">.</span><span class="ident" id="3968372">RuneError</span>&nbsp;<span class="op" id="3968382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3968387">//&nbsp;If&nbsp;we&nbsp;get&nbsp;a&nbsp;UTF-8&nbsp;error&nbsp;then&nbsp;there&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3968437">//&nbsp;upper-case&nbsp;ASCII&nbsp;bytes&nbsp;in&nbsp;the&nbsp;invalid&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968491">isAlreadyLowerCase</span>&nbsp;<span class="op" id="3968510">=</span>&nbsp;<span class="builtintype" id="3968512">false</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968521">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3968529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968533">if</span>&nbsp;<span class="string" id="3968536">&#39;A&#39;</span>&nbsp;<span class="op" id="3968540">&lt;=</span>&nbsp;<span class="ident" id="3968543">c</span>&nbsp;<span class="op" id="3968545">&amp;&amp;</span>&nbsp;<span class="ident" id="3968548">c</span>&nbsp;<span class="op" id="3968550">&lt;=</span>&nbsp;<span class="string" id="3968553">&#39;Z&#39;</span>&nbsp;<span class="op" id="3968557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968562">isAlreadyLowerCase</span>&nbsp;<span class="op" id="3968581">=</span>&nbsp;<span class="builtintype" id="3968583">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968592">break</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3968600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3968603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968607">if</span>&nbsp;<span class="ident" id="3968610">isAlreadyLowerCase</span>&nbsp;<span class="op" id="3968629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968633">return</span>&nbsp;<span class="ident" id="3968640">in</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3968644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968648">out</span>&nbsp;<span class="op" id="3968652">:=</span>&nbsp;<span class="op" id="3968655">[</span><span class="op" id="3968656">]</span><span class="builtintype" id="3968657">byte</span><span class="op" id="3968661">(</span><span class="ident" id="3968662">in</span><span class="op" id="3968664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968667">for</span>&nbsp;<span class="ident" id="3968671">i</span><span class="op" id="3968672">,</span>&nbsp;<span class="ident" id="3968674">c</span>&nbsp;<span class="op" id="3968676">:=</span>&nbsp;<span class="keyword" id="3968679">range</span>&nbsp;<span class="ident" id="3968685">out</span>&nbsp;<span class="op" id="3968689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968693">if</span>&nbsp;<span class="string" id="3968696">&#39;A&#39;</span>&nbsp;<span class="op" id="3968700">&lt;=</span>&nbsp;<span class="ident" id="3968703">c</span>&nbsp;<span class="op" id="3968705">&amp;&amp;</span>&nbsp;<span class="ident" id="3968708">c</span>&nbsp;<span class="op" id="3968710">&lt;=</span>&nbsp;<span class="string" id="3968713">&#39;Z&#39;</span>&nbsp;<span class="op" id="3968717">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968722">out</span><span class="op" id="3968725">[</span><span class="ident" id="3968726">i</span><span class="op" id="3968727">]</span>&nbsp;<span class="op" id="3968729">+=</span>&nbsp;<span class="string" id="3968732">&#39;a&#39;</span>&nbsp;<span class="op" id="3968736">-</span>&nbsp;<span class="string" id="3968738">&#39;A&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3968744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3968747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968750">return</span>&nbsp;<span class="builtintype" id="3968757">string</span><span class="op" id="3968763">(</span><span class="ident" id="3968764">out</span><span class="op" id="3968767">)</span><br>
<span class="lineno"></span><span class="op" id="3968769">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="3968772">//&nbsp;VerifyHostname&nbsp;returns&nbsp;nil&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;valid&nbsp;certificate&nbsp;for&nbsp;the&nbsp;named&nbsp;host.</span><br>
<span class="lineno"></span><span class="comment" id="3968850">//&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;an&nbsp;error&nbsp;describing&nbsp;the&nbsp;mismatch.</span><br>
<span class="lineno"></span><span class="keyword" id="3968908">func</span>&nbsp;<span class="op" id="3968913">(</span><span class="ident" id="3968914">c</span>&nbsp;<span class="op" id="3968916">*</span><span class="ident" id="3968917">Certificate</span><span class="op" id="3968928">)</span>&nbsp;<span class="ident" id="3968930">VerifyHostname</span><span class="op" id="3968944">(</span><span class="ident" id="3968945">h</span>&nbsp;<span class="builtintype" id="3968947">string</span><span class="op" id="3968953">)</span>&nbsp;<span class="builtintype" id="3968955">error</span>&nbsp;<span class="op" id="3968961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3968964">//&nbsp;IP&nbsp;addresses&nbsp;may&nbsp;be&nbsp;written&nbsp;in&nbsp;[&nbsp;].</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3969004">candidateIP</span>&nbsp;<span class="op" id="3969016">:=</span>&nbsp;<span class="ident" id="3969019">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969022">if</span>&nbsp;<span class="builtinfunc" id="3969025">len</span><span class="op" id="3969028">(</span><span class="ident" id="3969029">h</span><span class="op" id="3969030">)</span>&nbsp;<span class="op" id="3969032">&gt;=</span>&nbsp;<span class="num" id="3969035">3</span>&nbsp;<span class="op" id="3969037">&amp;&amp;</span>&nbsp;<span class="ident" id="3969040">h</span><span class="op" id="3969041">[</span><span class="num" id="3969042">0</span><span class="op" id="3969043">]</span>&nbsp;<span class="op" id="3969045">==</span>&nbsp;<span class="string" id="3969048">&#39;[&#39;</span>&nbsp;<span class="op" id="3969052">&amp;&amp;</span>&nbsp;<span class="ident" id="3969055">h</span><span class="op" id="3969056">[</span><span class="builtinfunc" id="3969057">len</span><span class="op" id="3969060">(</span><span class="ident" id="3969061">h</span><span class="op" id="3969062">)</span><span class="op" id="3969063">-</span><span class="num" id="3969064">1</span><span class="op" id="3969065">]</span>&nbsp;<span class="op" id="3969067">==</span>&nbsp;<span class="string" id="3969070">&#39;]&#39;</span>&nbsp;<span class="op" id="3969074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3969078">candidateIP</span>&nbsp;<span class="op" id="3969090">=</span>&nbsp;<span class="ident" id="3969092">h</span><span class="op" id="3969093">[</span><span class="num" id="3969094">1</span>&nbsp;<span class="op" id="3969096">:</span>&nbsp;<span class="builtinfunc" id="3969098">len</span><span class="op" id="3969101">(</span><span class="ident" id="3969102">h</span><span class="op" id="3969103">)</span><span class="op" id="3969104">-</span><span class="num" id="3969105">1</span><span class="op" id="3969106">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3969109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969112">if</span>&nbsp;<span class="ident" id="3969115">ip</span>&nbsp;<span class="op" id="3969118">:=</span>&nbsp;<span class="ident" id="3969121">net</span><span class="op" id="3969124">.</span><span class="ident" id="3969125">ParseIP</span><span class="op" id="3969132">(</span><span class="ident" id="3969133">candidateIP</span><span class="op" id="3969144">)</span><span class="op" id="3969145">;</span>&nbsp;<span class="ident" id="3969147">ip</span>&nbsp;<span class="op" id="3969150">!=</span>&nbsp;<span class="ident" id="3969153">nil</span>&nbsp;<span class="op" id="3969157">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969161">//&nbsp;We&nbsp;only&nbsp;match&nbsp;IP&nbsp;addresses&nbsp;against&nbsp;IP&nbsp;SANs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969210">//&nbsp;https://tools.ietf.org/html/rfc6125#appendix-B.2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969264">for</span>&nbsp;<span class="ident" id="3969268">_</span><span class="op" id="3969269">,</span>&nbsp;<span class="ident" id="3969271">candidate</span>&nbsp;<span class="op" id="3969281">:=</span>&nbsp;<span class="keyword" id="3969284">range</span>&nbsp;<span class="ident" id="3969290">c</span><span class="op" id="3969291">.</span><span class="ident" id="3969292">IPAddresses</span>&nbsp;<span class="op" id="3969304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969309">if</span>&nbsp;<span class="ident" id="3969312">ip</span><span class="op" id="3969314">.</span><span class="ident" id="3969315">Equal</span><span class="op" id="3969320">(</span><span class="ident" id="3969321">candidate</span><span class="op" id="3969330">)</span>&nbsp;<span class="op" id="3969332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969338">return</span>&nbsp;<span class="ident" id="3969345">nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3969352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3969356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969360">return</span>&nbsp;<span class="ident" id="3969367">HostnameError</span><span class="op" id="3969380">{</span><span class="ident" id="3969381">c</span><span class="op" id="3969382">,</span>&nbsp;<span class="ident" id="3969384">candidateIP</span><span class="op" id="3969395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3969398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3969402">lowered</span>&nbsp;<span class="op" id="3969410">:=</span>&nbsp;<span class="ident" id="3969413">toLowerCaseASCII</span><span class="op" id="3969429">(</span><span class="ident" id="3969430">h</span><span class="op" id="3969431">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969435">if</span>&nbsp;<span class="builtinfunc" id="3969438">len</span><span class="op" id="3969441">(</span><span class="ident" id="3969442">c</span><span class="op" id="3969443">.</span><span class="ident" id="3969444">DNSNames</span><span class="op" id="3969452">)</span>&nbsp;<span class="op" id="3969454">&gt;</span>&nbsp;<span class="num" id="3969456">0</span>&nbsp;<span class="op" id="3969458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969462">for</span>&nbsp;<span class="ident" id="3969466">_</span><span class="op" id="3969467">,</span>&nbsp;<span class="ident" id="3969469">match</span>&nbsp;<span class="op" id="3969475">:=</span>&nbsp;<span class="keyword" id="3969478">range</span>&nbsp;<span class="ident" id="3969484">c</span><span class="op" id="3969485">.</span><span class="ident" id="3969486">DNSNames</span>&nbsp;<span class="op" id="3969495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969500">if</span>&nbsp;<span class="ident" id="3969503">matchHostnames</span><span class="op" id="3969517">(</span><span class="ident" id="3969518">toLowerCaseASCII</span><span class="op" id="3969534">(</span><span class="ident" id="3969535">match</span><span class="op" id="3969540">)</span><span class="op" id="3969541">,</span>&nbsp;<span class="ident" id="3969543">lowered</span><span class="op" id="3969550">)</span>&nbsp;<span class="op" id="3969552">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969558">return</span>&nbsp;<span class="ident" id="3969565">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3969572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3969576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969580">//&nbsp;If&nbsp;Subject&nbsp;Alt&nbsp;Name&nbsp;is&nbsp;given,&nbsp;we&nbsp;ignore&nbsp;the&nbsp;common&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3969641">}</span>&nbsp;<span class="keyword" id="3969643">else</span>&nbsp;<span class="keyword" id="3969648">if</span>&nbsp;<span class="ident" id="3969651">matchHostnames</span><span class="op" id="3969665">(</span><span class="ident" id="3969666">toLowerCaseASCII</span><span class="op" id="3969682">(</span><span class="ident" id="3969683">c</span><span class="op" id="3969684">.</span><span class="ident" id="3969685">Subject</span><span class="op" id="3969692">.</span><span class="ident" id="3969693">CommonName</span><span class="op" id="3969703">)</span><span class="op" id="3969704">,</span>&nbsp;<span class="ident" id="3969706">lowered</span><span class="op" id="3969713">)</span>&nbsp;<span class="op" id="3969715">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969719">return</span>&nbsp;<span class="ident" id="3969726">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3969731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969735">return</span>&nbsp;<span class="ident" id="3969742">HostnameError</span><span class="op" id="3969755">{</span><span class="ident" id="3969756">c</span><span class="op" id="3969757">,</span>&nbsp;<span class="ident" id="3969759">h</span><span class="op" id="3969760">}</span><br>
<span class="lineno"></span><span class="op" id="3969762">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span><span class="keyword" id="3969765">func</span>&nbsp;<span class="ident" id="3969770">checkChainForKeyUsage</span><span class="op" id="3969791">(</span><span class="ident" id="3969792">chain</span>&nbsp;<span class="op" id="3969798">[</span><span class="op" id="3969799">]</span><span class="op" id="3969800">*</span><span class="ident" id="3969801">Certificate</span><span class="op" id="3969812">,</span>&nbsp;<span class="ident" id="3969814">keyUsages</span>&nbsp;<span class="op" id="3969824">[</span><span class="op" id="3969825">]</span><span class="ident" id="3969826">ExtKeyUsage</span><span class="op" id="3969837">)</span>&nbsp;<span class="builtintype" id="3969839">bool</span>&nbsp;<span class="op" id="3969844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3969847">usages</span>&nbsp;<span class="op" id="3969854">:=</span>&nbsp;<span class="builtinfunc" id="3969857">make</span><span class="op" id="3969861">(</span><span class="op" id="3969862">[</span><span class="op" id="3969863">]</span><span class="ident" id="3969864">ExtKeyUsage</span><span class="op" id="3969875">,</span>&nbsp;<span class="builtinfunc" id="3969877">len</span><span class="op" id="3969880">(</span><span class="ident" id="3969881">keyUsages</span><span class="op" id="3969890">)</span><span class="op" id="3969891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3969894">copy</span><span class="op" id="3969898">(</span><span class="ident" id="3969899">usages</span><span class="op" id="3969905">,</span>&nbsp;<span class="ident" id="3969907">keyUsages</span><span class="op" id="3969916">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969920">if</span>&nbsp;<span class="builtinfunc" id="3969923">len</span><span class="op" id="3969926">(</span><span class="ident" id="3969927">chain</span><span class="op" id="3969932">)</span>&nbsp;<span class="op" id="3969934">==</span>&nbsp;<span class="num" id="3969937">0</span>&nbsp;<span class="op" id="3969939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969943">return</span>&nbsp;<span class="builtintype" id="3969950">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3969957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3969961">usagesRemaining</span>&nbsp;<span class="op" id="3969977">:=</span>&nbsp;<span class="builtinfunc" id="3969980">len</span><span class="op" id="3969983">(</span><span class="ident" id="3969984">usages</span><span class="op" id="3969990">)</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969994">//&nbsp;We&nbsp;walk&nbsp;down&nbsp;the&nbsp;list&nbsp;and&nbsp;cross&nbsp;out&nbsp;any&nbsp;usages&nbsp;that&nbsp;aren&#39;t&nbsp;supported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970067">//&nbsp;by&nbsp;each&nbsp;certificate.&nbsp;If&nbsp;we&nbsp;cross&nbsp;out&nbsp;all&nbsp;the&nbsp;usages,&nbsp;then&nbsp;the&nbsp;chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970139">//&nbsp;is&nbsp;unacceptable.</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="ident" id="3970160">NextCert</span><span class="op" id="3970168">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970171">for</span>&nbsp;<span class="ident" id="3970175">i</span>&nbsp;<span class="op" id="3970177">:=</span>&nbsp;<span class="builtinfunc" id="3970180">len</span><span class="op" id="3970183">(</span><span class="ident" id="3970184">chain</span><span class="op" id="3970189">)</span>&nbsp;<span class="op" id="3970191">-</span>&nbsp;<span class="num" id="3970193">1</span><span class="op" id="3970194">;</span>&nbsp;<span class="ident" id="3970196">i</span>&nbsp;<span class="op" id="3970198">&gt;=</span>&nbsp;<span class="num" id="3970201">0</span><span class="op" id="3970202">;</span>&nbsp;<span class="ident" id="3970204">i</span><span class="op" id="3970205">--</span>&nbsp;<span class="op" id="3970208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970212">cert</span>&nbsp;<span class="op" id="3970217">:=</span>&nbsp;<span class="ident" id="3970220">chain</span><span class="op" id="3970225">[</span><span class="ident" id="3970226">i</span><span class="op" id="3970227">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970231">if</span>&nbsp;<span class="builtinfunc" id="3970234">len</span><span class="op" id="3970237">(</span><span class="ident" id="3970238">cert</span><span class="op" id="3970242">.</span><span class="ident" id="3970243">ExtKeyUsage</span><span class="op" id="3970254">)</span>&nbsp;<span class="op" id="3970256">==</span>&nbsp;<span class="num" id="3970259">0</span>&nbsp;<span class="op" id="3970261">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3970264">len</span><span class="op" id="3970267">(</span><span class="ident" id="3970268">cert</span><span class="op" id="3970272">.</span><span class="ident" id="3970273">UnknownExtKeyUsage</span><span class="op" id="3970291">)</span>&nbsp;<span class="op" id="3970293">==</span>&nbsp;<span class="num" id="3970296">0</span>&nbsp;<span class="op" id="3970298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970303">//&nbsp;The&nbsp;certificate&nbsp;doesn&#39;t&nbsp;have&nbsp;any&nbsp;extended&nbsp;key&nbsp;usage&nbsp;specified.</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970372">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3970383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970388">for</span>&nbsp;<span class="ident" id="3970392">_</span><span class="op" id="3970393">,</span>&nbsp;<span class="ident" id="3970395">usage</span>&nbsp;<span class="op" id="3970401">:=</span>&nbsp;<span class="keyword" id="3970404">range</span>&nbsp;<span class="ident" id="3970410">cert</span><span class="op" id="3970414">.</span><span class="ident" id="3970415">ExtKeyUsage</span>&nbsp;<span class="op" id="3970427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970432">if</span>&nbsp;<span class="ident" id="3970435">usage</span>&nbsp;<span class="op" id="3970441">==</span>&nbsp;<span class="ident" id="3970444">ExtKeyUsageAny</span>&nbsp;<span class="op" id="3970459">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970465">//&nbsp;The&nbsp;certificate&nbsp;is&nbsp;explicitly&nbsp;good&nbsp;for&nbsp;any&nbsp;usage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970522">continue</span>&nbsp;<span class="ident" id="3970531">NextCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3970543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3970547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970552">const</span>&nbsp;<span class="ident" id="3970558">invalidUsage</span>&nbsp;<span class="ident" id="3970571">ExtKeyUsage</span>&nbsp;<span class="op" id="3970583">=</span>&nbsp;<span class="op" id="3970585">-</span><span class="num" id="3970586">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970590">NextRequestedUsage</span><span class="op" id="3970608">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970612">for</span>&nbsp;<span class="ident" id="3970616">i</span><span class="op" id="3970617">,</span>&nbsp;<span class="ident" id="3970619">requestedUsage</span>&nbsp;<span class="op" id="3970634">:=</span>&nbsp;<span class="keyword" id="3970637">range</span>&nbsp;<span class="ident" id="3970643">usages</span>&nbsp;<span class="op" id="3970650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970655">if</span>&nbsp;<span class="ident" id="3970658">requestedUsage</span>&nbsp;<span class="op" id="3970673">==</span>&nbsp;<span class="ident" id="3970676">invalidUsage</span>&nbsp;<span class="op" id="3970689">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970695">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3970707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970713">for</span>&nbsp;<span class="ident" id="3970717">_</span><span class="op" id="3970718">,</span>&nbsp;<span class="ident" id="3970720">usage</span>&nbsp;<span class="op" id="3970726">:=</span>&nbsp;<span class="keyword" id="3970729">range</span>&nbsp;<span class="ident" id="3970735">cert</span><span class="op" id="3970739">.</span><span class="ident" id="3970740">ExtKeyUsage</span>&nbsp;<span class="op" id="3970752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970758">if</span>&nbsp;<span class="ident" id="3970761">requestedUsage</span>&nbsp;<span class="op" id="3970776">==</span>&nbsp;<span class="ident" id="3970779">usage</span>&nbsp;<span class="op" id="3970785">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970792">continue</span>&nbsp;<span class="ident" id="3970801">NextRequestedUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3970824">}</span>&nbsp;<span class="keyword" id="3970826">else</span>&nbsp;<span class="keyword" id="3970831">if</span>&nbsp;<span class="ident" id="3970834">requestedUsage</span>&nbsp;<span class="op" id="3970849">==</span>&nbsp;<span class="ident" id="3970852">ExtKeyUsageServerAuth</span>&nbsp;<span class="op" id="3970874">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3970882">(</span><span class="ident" id="3970883">usage</span>&nbsp;<span class="op" id="3970889">==</span>&nbsp;<span class="ident" id="3970892">ExtKeyUsageNetscapeServerGatedCrypto</span>&nbsp;<span class="op" id="3970929">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970938">usage</span>&nbsp;<span class="op" id="3970944">==</span>&nbsp;<span class="ident" id="3970947">ExtKeyUsageMicrosoftServerGatedCrypto</span><span class="op" id="3970984">)</span>&nbsp;<span class="op" id="3970986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970993">//&nbsp;In&nbsp;order&nbsp;to&nbsp;support&nbsp;COMODO</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3971028">//&nbsp;certificate&nbsp;chains,&nbsp;we&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3971067">//&nbsp;accept&nbsp;Netscape&nbsp;or&nbsp;Microsoft&nbsp;SGC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3971108">//&nbsp;usages&nbsp;as&nbsp;equal&nbsp;to&nbsp;ServerAuth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971147">continue</span>&nbsp;<span class="ident" id="3971156">NextRequestedUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3971179">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3971184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3971190">usages</span><span class="op" id="3971196">[</span><span class="ident" id="3971197">i</span><span class="op" id="3971198">]</span>&nbsp;<span class="op" id="3971200">=</span>&nbsp;<span class="ident" id="3971202">invalidUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3971218">usagesRemaining</span><span class="op" id="3971233">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971239">if</span>&nbsp;<span class="ident" id="3971242">usagesRemaining</span>&nbsp;<span class="op" id="3971258">==</span>&nbsp;<span class="num" id="3971261">0</span>&nbsp;<span class="op" id="3971263">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971269">return</span>&nbsp;<span class="builtintype" id="3971276">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3971285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3971289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3971292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971296">return</span>&nbsp;<span class="builtintype" id="3971303">true</span><br>
<span class="lineno"></span><span class="op" id="3971308">}</span>
</div>
</body>
</html>
