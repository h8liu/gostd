<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc/jsonrpc</h2>
<ul>
<li><a href="/gostd/net/rpc/jsonrpc/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/server.go.html">server.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5753766">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5753822">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5753876">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5753927">//&nbsp;Package&nbsp;jsonrpc&nbsp;implements&nbsp;a&nbsp;JSON-RPC&nbsp;ClientCodec&nbsp;and&nbsp;ServerCodec</span><br>
<span class="lineno"></span><span class="comment" id="5753996">//&nbsp;for&nbsp;the&nbsp;rpc&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5754020">package</span>&nbsp;<span class="ident" id="5754028">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5754037">import</span>&nbsp;<span class="op" id="5754044">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5754047">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5754064">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5754071">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5754077">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5754084">&#34;net/rpc&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5754095">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5754102">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5754105">type</span>&nbsp;<span class="ident" id="5754110">clientCodec</span>&nbsp;<span class="keyword" id="5754122">struct</span>&nbsp;<span class="op" id="5754129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5754132">dec</span>&nbsp;<span class="op" id="5754136">*</span><span class="ident" id="5754137">json</span><span class="op" id="5754141">.</span><span class="ident" id="5754142">Decoder</span>&nbsp;<span class="comment" id="5754150">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5754178">enc</span>&nbsp;<span class="op" id="5754182">*</span><span class="ident" id="5754183">json</span><span class="op" id="5754187">.</span><span class="ident" id="5754188">Encoder</span>&nbsp;<span class="comment" id="5754196">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5754224">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5754228">io</span><span class="op" id="5754230">.</span><span class="ident" id="5754231">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5754240">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5754265">req</span>&nbsp;&nbsp;<span class="ident" id="5754270">clientRequest</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5754285">resp</span>&nbsp;<span class="ident" id="5754290">clientResponse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5754307">//&nbsp;JSON-RPC&nbsp;responses&nbsp;include&nbsp;the&nbsp;request&nbsp;id&nbsp;but&nbsp;not&nbsp;the&nbsp;request&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5754381">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;both.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5754411">//&nbsp;We&nbsp;save&nbsp;the&nbsp;request&nbsp;method&nbsp;in&nbsp;pending&nbsp;when&nbsp;sending&nbsp;a&nbsp;request</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5754476">//&nbsp;and&nbsp;then&nbsp;look&nbsp;it&nbsp;up&nbsp;by&nbsp;request&nbsp;ID&nbsp;when&nbsp;filling&nbsp;out&nbsp;the&nbsp;rpc&nbsp;Response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5754549">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5754557">sync</span><span class="op" id="5754561">.</span><span class="ident" id="5754562">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5754575">//&nbsp;protects&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5754596">pending</span>&nbsp;<span class="keyword" id="5754604">map</span><span class="op" id="5754607">[</span><span class="ident" id="5754608">uint64</span><span class="op" id="5754614">]</span><span class="builtintype" id="5754615">string</span>&nbsp;<span class="comment" id="5754622">//&nbsp;map&nbsp;request&nbsp;id&nbsp;to&nbsp;method&nbsp;name</span><br>
<span class="lineno"></span><span class="op" id="5754655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="5754658">//&nbsp;NewClientCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ClientCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="5754730">func</span>&nbsp;<span class="ident" id="5754735">NewClientCodec</span><span class="op" id="5754749">(</span><span class="ident" id="5754750">conn</span>&nbsp;<span class="ident" id="5754755">io</span><span class="op" id="5754757">.</span><span class="ident" id="5754758">ReadWriteCloser</span><span class="op" id="5754773">)</span>&nbsp;<span class="ident" id="5754775">rpc</span><span class="op" id="5754778">.</span><span class="ident" id="5754779">ClientCodec</span>&nbsp;<span class="op" id="5754791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5754794">return</span>&nbsp;<span class="op" id="5754801">&amp;</span><span class="ident" id="5754802">clientCodec</span><span class="op" id="5754813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5754817">dec</span><span class="op" id="5754820">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5754826">json</span><span class="op" id="5754830">.</span><span class="ident" id="5754831">NewDecoder</span><span class="op" id="5754841">(</span><span class="ident" id="5754842">conn</span><span class="op" id="5754846">)</span><span class="op" id="5754847">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5754851">enc</span><span class="op" id="5754854">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5754860">json</span><span class="op" id="5754864">.</span><span class="ident" id="5754865">NewEncoder</span><span class="op" id="5754875">(</span><span class="ident" id="5754876">conn</span><span class="op" id="5754880">)</span><span class="op" id="5754881">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5754885">c</span><span class="op" id="5754886">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5754894">conn</span><span class="op" id="5754898">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5754902">pending</span><span class="op" id="5754909">:</span>&nbsp;<span class="builtinfunc" id="5754911">make</span><span class="op" id="5754915">(</span><span class="keyword" id="5754916">map</span><span class="op" id="5754919">[</span><span class="ident" id="5754920">uint64</span><span class="op" id="5754926">]</span><span class="builtintype" id="5754927">string</span><span class="op" id="5754933">)</span><span class="op" id="5754934">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5754937">}</span><br>
<span class="lineno"></span><span class="op" id="5754939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="5754942">type</span>&nbsp;<span class="ident" id="5754947">clientRequest</span>&nbsp;<span class="keyword" id="5754961">struct</span>&nbsp;<span class="op" id="5754968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5754971">Method</span>&nbsp;<span class="builtintype" id="5754978">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5754993">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755010">Params</span>&nbsp;<span class="op" id="5755017">[</span><span class="num" id="5755018">1</span><span class="op" id="5755019">]</span><span class="keyword" id="5755020">interface</span><span class="op" id="5755029">{</span><span class="op" id="5755030">}</span>&nbsp;<span class="string" id="5755032">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755049">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5755056">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5755071">`json:&#34;id&#34;`</span><br>
<span class="lineno"></span><span class="op" id="5755083">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="5755086">func</span>&nbsp;<span class="op" id="5755091">(</span><span class="ident" id="5755092">c</span>&nbsp;<span class="op" id="5755094">*</span><span class="ident" id="5755095">clientCodec</span><span class="op" id="5755106">)</span>&nbsp;<span class="ident" id="5755108">WriteRequest</span><span class="op" id="5755120">(</span><span class="ident" id="5755121">r</span>&nbsp;<span class="op" id="5755123">*</span><span class="ident" id="5755124">rpc</span><span class="op" id="5755127">.</span><span class="ident" id="5755128">Request</span><span class="op" id="5755135">,</span>&nbsp;<span class="ident" id="5755137">param</span>&nbsp;<span class="keyword" id="5755143">interface</span><span class="op" id="5755152">{</span><span class="op" id="5755153">}</span><span class="op" id="5755154">)</span>&nbsp;<span class="builtintype" id="5755156">error</span>&nbsp;<span class="op" id="5755162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755165">c</span><span class="op" id="5755166">.</span><span class="ident" id="5755167">mutex</span><span class="op" id="5755172">.</span><span class="ident" id="5755173">Lock</span><span class="op" id="5755177">(</span><span class="op" id="5755178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755181">c</span><span class="op" id="5755182">.</span><span class="ident" id="5755183">pending</span><span class="op" id="5755190">[</span><span class="ident" id="5755191">r</span><span class="op" id="5755192">.</span><span class="ident" id="5755193">Seq</span><span class="op" id="5755196">]</span>&nbsp;<span class="op" id="5755198">=</span>&nbsp;<span class="ident" id="5755200">r</span><span class="op" id="5755201">.</span><span class="ident" id="5755202">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755217">c</span><span class="op" id="5755218">.</span><span class="ident" id="5755219">mutex</span><span class="op" id="5755224">.</span><span class="ident" id="5755225">Unlock</span><span class="op" id="5755231">(</span><span class="op" id="5755232">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755235">c</span><span class="op" id="5755236">.</span><span class="ident" id="5755237">req</span><span class="op" id="5755240">.</span><span class="ident" id="5755241">Method</span>&nbsp;<span class="op" id="5755248">=</span>&nbsp;<span class="ident" id="5755250">r</span><span class="op" id="5755251">.</span><span class="ident" id="5755252">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755267">c</span><span class="op" id="5755268">.</span><span class="ident" id="5755269">req</span><span class="op" id="5755272">.</span><span class="ident" id="5755273">Params</span><span class="op" id="5755279">[</span><span class="num" id="5755280">0</span><span class="op" id="5755281">]</span>&nbsp;<span class="op" id="5755283">=</span>&nbsp;<span class="ident" id="5755285">param</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755292">c</span><span class="op" id="5755293">.</span><span class="ident" id="5755294">req</span><span class="op" id="5755297">.</span><span class="ident" id="5755298">Id</span>&nbsp;<span class="op" id="5755301">=</span>&nbsp;<span class="ident" id="5755303">r</span><span class="op" id="5755304">.</span><span class="ident" id="5755305">Seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755310">return</span>&nbsp;<span class="ident" id="5755317">c</span><span class="op" id="5755318">.</span><span class="ident" id="5755319">enc</span><span class="op" id="5755322">.</span><span class="ident" id="5755323">Encode</span><span class="op" id="5755329">(</span><span class="op" id="5755330">&amp;</span><span class="ident" id="5755331">c</span><span class="op" id="5755332">.</span><span class="ident" id="5755333">req</span><span class="op" id="5755336">)</span><br>
<span class="lineno"></span><span class="op" id="5755338">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5755341">type</span>&nbsp;<span class="ident" id="5755346">clientResponse</span>&nbsp;<span class="keyword" id="5755361">struct</span>&nbsp;<span class="op" id="5755368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755371">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5755378">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5755395">`json:&#34;id&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755408">Result</span>&nbsp;<span class="op" id="5755415">*</span><span class="ident" id="5755416">json</span><span class="op" id="5755420">.</span><span class="ident" id="5755421">RawMessage</span>&nbsp;<span class="string" id="5755432">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755449">Error</span>&nbsp;&nbsp;<span class="keyword" id="5755456">interface</span><span class="op" id="5755465">{</span><span class="op" id="5755466">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5755473">`json:&#34;error&#34;`</span><br>
<span class="lineno">65</span><span class="op" id="5755488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5755491">func</span>&nbsp;<span class="op" id="5755496">(</span><span class="ident" id="5755497">r</span>&nbsp;<span class="op" id="5755499">*</span><span class="ident" id="5755500">clientResponse</span><span class="op" id="5755514">)</span>&nbsp;<span class="ident" id="5755516">reset</span><span class="op" id="5755521">(</span><span class="op" id="5755522">)</span>&nbsp;<span class="op" id="5755524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755527">r</span><span class="op" id="5755528">.</span><span class="ident" id="5755529">Id</span>&nbsp;<span class="op" id="5755532">=</span>&nbsp;<span class="num" id="5755534">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755537">r</span><span class="op" id="5755538">.</span><span class="ident" id="5755539">Result</span>&nbsp;<span class="op" id="5755546">=</span>&nbsp;<span class="ident" id="5755548">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755553">r</span><span class="op" id="5755554">.</span><span class="ident" id="5755555">Error</span>&nbsp;<span class="op" id="5755561">=</span>&nbsp;<span class="ident" id="5755563">nil</span><br>
<span class="lineno"></span><span class="op" id="5755567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5755570">func</span>&nbsp;<span class="op" id="5755575">(</span><span class="ident" id="5755576">c</span>&nbsp;<span class="op" id="5755578">*</span><span class="ident" id="5755579">clientCodec</span><span class="op" id="5755590">)</span>&nbsp;<span class="ident" id="5755592">ReadResponseHeader</span><span class="op" id="5755610">(</span><span class="ident" id="5755611">r</span>&nbsp;<span class="op" id="5755613">*</span><span class="ident" id="5755614">rpc</span><span class="op" id="5755617">.</span><span class="ident" id="5755618">Response</span><span class="op" id="5755626">)</span>&nbsp;<span class="builtintype" id="5755628">error</span>&nbsp;<span class="op" id="5755634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755637">c</span><span class="op" id="5755638">.</span><span class="ident" id="5755639">resp</span><span class="op" id="5755643">.</span><span class="ident" id="5755644">reset</span><span class="op" id="5755649">(</span><span class="op" id="5755650">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755653">if</span>&nbsp;<span class="ident" id="5755656">err</span>&nbsp;<span class="op" id="5755660">:=</span>&nbsp;<span class="ident" id="5755663">c</span><span class="op" id="5755664">.</span><span class="ident" id="5755665">dec</span><span class="op" id="5755668">.</span><span class="ident" id="5755669">Decode</span><span class="op" id="5755675">(</span><span class="op" id="5755676">&amp;</span><span class="ident" id="5755677">c</span><span class="op" id="5755678">.</span><span class="ident" id="5755679">resp</span><span class="op" id="5755683">)</span><span class="op" id="5755684">;</span>&nbsp;<span class="ident" id="5755686">err</span>&nbsp;<span class="op" id="5755690">!=</span>&nbsp;<span class="ident" id="5755693">nil</span>&nbsp;<span class="op" id="5755697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755701">return</span>&nbsp;<span class="ident" id="5755708">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5755713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755717">c</span><span class="op" id="5755718">.</span><span class="ident" id="5755719">mutex</span><span class="op" id="5755724">.</span><span class="ident" id="5755725">Lock</span><span class="op" id="5755729">(</span><span class="op" id="5755730">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755733">r</span><span class="op" id="5755734">.</span><span class="ident" id="5755735">ServiceMethod</span>&nbsp;<span class="op" id="5755749">=</span>&nbsp;<span class="ident" id="5755751">c</span><span class="op" id="5755752">.</span><span class="ident" id="5755753">pending</span><span class="op" id="5755760">[</span><span class="ident" id="5755761">c</span><span class="op" id="5755762">.</span><span class="ident" id="5755763">resp</span><span class="op" id="5755767">.</span><span class="ident" id="5755768">Id</span><span class="op" id="5755770">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5755773">delete</span><span class="op" id="5755779">(</span><span class="ident" id="5755780">c</span><span class="op" id="5755781">.</span><span class="ident" id="5755782">pending</span><span class="op" id="5755789">,</span>&nbsp;<span class="ident" id="5755791">c</span><span class="op" id="5755792">.</span><span class="ident" id="5755793">resp</span><span class="op" id="5755797">.</span><span class="ident" id="5755798">Id</span><span class="op" id="5755800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755803">c</span><span class="op" id="5755804">.</span><span class="ident" id="5755805">mutex</span><span class="op" id="5755810">.</span><span class="ident" id="5755811">Unlock</span><span class="op" id="5755817">(</span><span class="op" id="5755818">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755822">r</span><span class="op" id="5755823">.</span><span class="ident" id="5755824">Error</span>&nbsp;<span class="op" id="5755830">=</span>&nbsp;<span class="string" id="5755832">&#34;&#34;</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755836">r</span><span class="op" id="5755837">.</span><span class="ident" id="5755838">Seq</span>&nbsp;<span class="op" id="5755842">=</span>&nbsp;<span class="ident" id="5755844">c</span><span class="op" id="5755845">.</span><span class="ident" id="5755846">resp</span><span class="op" id="5755850">.</span><span class="ident" id="5755851">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755855">if</span>&nbsp;<span class="ident" id="5755858">c</span><span class="op" id="5755859">.</span><span class="ident" id="5755860">resp</span><span class="op" id="5755864">.</span><span class="ident" id="5755865">Error</span>&nbsp;<span class="op" id="5755871">!=</span>&nbsp;<span class="ident" id="5755874">nil</span>&nbsp;<span class="op" id="5755878">||</span>&nbsp;<span class="ident" id="5755881">c</span><span class="op" id="5755882">.</span><span class="ident" id="5755883">resp</span><span class="op" id="5755887">.</span><span class="ident" id="5755888">Result</span>&nbsp;<span class="op" id="5755895">==</span>&nbsp;<span class="ident" id="5755898">nil</span>&nbsp;<span class="op" id="5755902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755906">x</span><span class="op" id="5755907">,</span>&nbsp;<span class="ident" id="5755909">ok</span>&nbsp;<span class="op" id="5755912">:=</span>&nbsp;<span class="ident" id="5755915">c</span><span class="op" id="5755916">.</span><span class="ident" id="5755917">resp</span><span class="op" id="5755921">.</span><span class="ident" id="5755922">Error</span><span class="op" id="5755927">.</span><span class="op" id="5755928">(</span><span class="builtintype" id="5755929">string</span><span class="op" id="5755935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755939">if</span>&nbsp;<span class="op" id="5755942">!</span><span class="ident" id="5755943">ok</span>&nbsp;<span class="op" id="5755946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755951">return</span>&nbsp;<span class="ident" id="5755958">fmt</span><span class="op" id="5755961">.</span><span class="ident" id="5755962">Errorf</span><span class="op" id="5755968">(</span><span class="string" id="5755969">&#34;invalid&nbsp;error&nbsp;%v&#34;</span><span class="op" id="5755987">,</span>&nbsp;<span class="ident" id="5755989">c</span><span class="op" id="5755990">.</span><span class="ident" id="5755991">resp</span><span class="op" id="5755995">.</span><span class="ident" id="5755996">Error</span><span class="op" id="5756001">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5756005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756009">if</span>&nbsp;<span class="ident" id="5756012">x</span>&nbsp;<span class="op" id="5756014">==</span>&nbsp;<span class="string" id="5756017">&#34;&#34;</span>&nbsp;<span class="op" id="5756020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5756025">x</span>&nbsp;<span class="op" id="5756027">=</span>&nbsp;<span class="string" id="5756029">&#34;unspecified&nbsp;error&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5756051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5756055">r</span><span class="op" id="5756056">.</span><span class="ident" id="5756057">Error</span>&nbsp;<span class="op" id="5756063">=</span>&nbsp;<span class="ident" id="5756065">x</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5756068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756071">return</span>&nbsp;<span class="ident" id="5756078">nil</span><br>
<span class="lineno"></span><span class="op" id="5756082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5756085">func</span>&nbsp;<span class="op" id="5756090">(</span><span class="ident" id="5756091">c</span>&nbsp;<span class="op" id="5756093">*</span><span class="ident" id="5756094">clientCodec</span><span class="op" id="5756105">)</span>&nbsp;<span class="ident" id="5756107">ReadResponseBody</span><span class="op" id="5756123">(</span><span class="ident" id="5756124">x</span>&nbsp;<span class="keyword" id="5756126">interface</span><span class="op" id="5756135">{</span><span class="op" id="5756136">}</span><span class="op" id="5756137">)</span>&nbsp;<span class="builtintype" id="5756139">error</span>&nbsp;<span class="op" id="5756145">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756148">if</span>&nbsp;<span class="ident" id="5756151">x</span>&nbsp;<span class="op" id="5756153">==</span>&nbsp;<span class="ident" id="5756156">nil</span>&nbsp;<span class="op" id="5756160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756164">return</span>&nbsp;<span class="ident" id="5756171">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5756176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756179">return</span>&nbsp;<span class="ident" id="5756186">json</span><span class="op" id="5756190">.</span><span class="ident" id="5756191">Unmarshal</span><span class="op" id="5756200">(</span><span class="op" id="5756201">*</span><span class="ident" id="5756202">c</span><span class="op" id="5756203">.</span><span class="ident" id="5756204">resp</span><span class="op" id="5756208">.</span><span class="ident" id="5756209">Result</span><span class="op" id="5756215">,</span>&nbsp;<span class="ident" id="5756217">x</span><span class="op" id="5756218">)</span><br>
<span class="lineno"></span><span class="op" id="5756220">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="5756223">func</span>&nbsp;<span class="op" id="5756228">(</span><span class="ident" id="5756229">c</span>&nbsp;<span class="op" id="5756231">*</span><span class="ident" id="5756232">clientCodec</span><span class="op" id="5756243">)</span>&nbsp;<span class="ident" id="5756245">Close</span><span class="op" id="5756250">(</span><span class="op" id="5756251">)</span>&nbsp;<span class="builtintype" id="5756253">error</span>&nbsp;<span class="op" id="5756259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756262">return</span>&nbsp;<span class="ident" id="5756269">c</span><span class="op" id="5756270">.</span><span class="ident" id="5756271">c</span><span class="op" id="5756272">.</span><span class="ident" id="5756273">Close</span><span class="op" id="5756278">(</span><span class="op" id="5756279">)</span><br>
<span class="lineno"></span><span class="op" id="5756281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="5756284">//&nbsp;NewClient&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.Client&nbsp;to&nbsp;handle&nbsp;requests&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5756348">//&nbsp;set&nbsp;of&nbsp;services&nbsp;at&nbsp;the&nbsp;other&nbsp;end&nbsp;of&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5756403">func</span>&nbsp;<span class="ident" id="5756408">NewClient</span><span class="op" id="5756417">(</span><span class="ident" id="5756418">conn</span>&nbsp;<span class="ident" id="5756423">io</span><span class="op" id="5756425">.</span><span class="ident" id="5756426">ReadWriteCloser</span><span class="op" id="5756441">)</span>&nbsp;<span class="op" id="5756443">*</span><span class="ident" id="5756444">rpc</span><span class="op" id="5756447">.</span><span class="ident" id="5756448">Client</span>&nbsp;<span class="op" id="5756455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756458">return</span>&nbsp;<span class="ident" id="5756465">rpc</span><span class="op" id="5756468">.</span><span class="ident" id="5756469">NewClientWithCodec</span><span class="op" id="5756487">(</span><span class="ident" id="5756488">NewClientCodec</span><span class="op" id="5756502">(</span><span class="ident" id="5756503">conn</span><span class="op" id="5756507">)</span><span class="op" id="5756508">)</span><br>
<span class="lineno"></span><span class="op" id="5756510">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="5756513">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;a&nbsp;JSON-RPC&nbsp;server&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="5756585">func</span>&nbsp;<span class="ident" id="5756590">Dial</span><span class="op" id="5756594">(</span><span class="ident" id="5756595">network</span><span class="op" id="5756602">,</span>&nbsp;<span class="ident" id="5756604">address</span>&nbsp;<span class="builtintype" id="5756612">string</span><span class="op" id="5756618">)</span>&nbsp;<span class="op" id="5756620">(</span><span class="op" id="5756621">*</span><span class="ident" id="5756622">rpc</span><span class="op" id="5756625">.</span><span class="ident" id="5756626">Client</span><span class="op" id="5756632">,</span>&nbsp;<span class="builtintype" id="5756634">error</span><span class="op" id="5756639">)</span>&nbsp;<span class="op" id="5756641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5756644">conn</span><span class="op" id="5756648">,</span>&nbsp;<span class="ident" id="5756650">err</span>&nbsp;<span class="op" id="5756654">:=</span>&nbsp;<span class="ident" id="5756657">net</span><span class="op" id="5756660">.</span><span class="ident" id="5756661">Dial</span><span class="op" id="5756665">(</span><span class="ident" id="5756666">network</span><span class="op" id="5756673">,</span>&nbsp;<span class="ident" id="5756675">address</span><span class="op" id="5756682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756685">if</span>&nbsp;<span class="ident" id="5756688">err</span>&nbsp;<span class="op" id="5756692">!=</span>&nbsp;<span class="ident" id="5756695">nil</span>&nbsp;<span class="op" id="5756699">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756703">return</span>&nbsp;<span class="ident" id="5756710">nil</span><span class="op" id="5756713">,</span>&nbsp;<span class="ident" id="5756715">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5756720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756723">return</span>&nbsp;<span class="ident" id="5756730">NewClient</span><span class="op" id="5756739">(</span><span class="ident" id="5756740">conn</span><span class="op" id="5756744">)</span><span class="op" id="5756745">,</span>&nbsp;<span class="ident" id="5756747">err</span><br>
<span class="lineno"></span><span class="op" id="5756751">}</span>
</div>
</body>
</html>
