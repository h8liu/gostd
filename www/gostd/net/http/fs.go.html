<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html" class="current">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3490712">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3490767">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3490821">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3490872">//&nbsp;HTTP&nbsp;file&nbsp;system&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3490909">package</span>&nbsp;<span class="ident" id="3490917">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3490923">import</span>&nbsp;<span class="op" id="3490930">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3490933">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3490943">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3490950">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3490956">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3490964">&#34;mime/multipart&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3490982">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3490999">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3491010">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3491016">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3491024">&#34;path/filepath&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3491041">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3491052">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3491063">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3491070">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3491073">//&nbsp;A&nbsp;Dir&nbsp;implements&nbsp;FileSystem&nbsp;using&nbsp;the&nbsp;native&nbsp;file&nbsp;system&nbsp;restricted&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3491149">//&nbsp;specific&nbsp;directory&nbsp;tree.</span><br>
<span class="lineno"></span><span class="comment" id="3491177">//</span><br>
<span class="lineno"></span><span class="comment" id="3491180">//&nbsp;While&nbsp;the&nbsp;FileSystem.Open&nbsp;method&nbsp;takes&nbsp;&#39;/&#39;-separated&nbsp;paths,&nbsp;a&nbsp;Dir&#39;s&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3491258">//&nbsp;value&nbsp;is&nbsp;a&nbsp;filename&nbsp;on&nbsp;the&nbsp;native&nbsp;file&nbsp;system,&nbsp;not&nbsp;a&nbsp;URL,&nbsp;so&nbsp;it&nbsp;is&nbsp;separated</span><br>
<span class="lineno">30</span><span class="comment" id="3491338">//&nbsp;by&nbsp;filepath.Separator,&nbsp;which&nbsp;isn&#39;t&nbsp;necessarily&nbsp;&#39;/&#39;.</span><br>
<span class="lineno"></span><span class="comment" id="3491393">//</span><br>
<span class="lineno"></span><span class="comment" id="3491396">//&nbsp;An&nbsp;empty&nbsp;Dir&nbsp;is&nbsp;treated&nbsp;as&nbsp;&#34;.&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3491431">type</span>&nbsp;<span class="ident" id="3491436">Dir</span>&nbsp;<span class="builtintype" id="3491440">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="3491448">func</span>&nbsp;<span class="op" id="3491453">(</span><span class="ident" id="3491454">d</span>&nbsp;<span class="ident" id="3491456">Dir</span><span class="op" id="3491459">)</span>&nbsp;<span class="ident" id="3491461">Open</span><span class="op" id="3491465">(</span><span class="ident" id="3491466">name</span>&nbsp;<span class="builtintype" id="3491471">string</span><span class="op" id="3491477">)</span>&nbsp;<span class="op" id="3491479">(</span><span class="ident" id="3491480">File</span><span class="op" id="3491484">,</span>&nbsp;<span class="builtintype" id="3491486">error</span><span class="op" id="3491491">)</span>&nbsp;<span class="op" id="3491493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3491496">if</span>&nbsp;<span class="ident" id="3491499">filepath</span><span class="op" id="3491507">.</span><span class="ident" id="3491508">Separator</span>&nbsp;<span class="op" id="3491518">!=</span>&nbsp;<span class="string" id="3491521">&#39;/&#39;</span>&nbsp;<span class="op" id="3491525">&amp;&amp;</span>&nbsp;<span class="ident" id="3491528">strings</span><span class="op" id="3491535">.</span><span class="ident" id="3491536">IndexRune</span><span class="op" id="3491545">(</span><span class="ident" id="3491546">name</span><span class="op" id="3491550">,</span>&nbsp;<span class="ident" id="3491552">filepath</span><span class="op" id="3491560">.</span><span class="ident" id="3491561">Separator</span><span class="op" id="3491570">)</span>&nbsp;<span class="op" id="3491572">&gt;=</span>&nbsp;<span class="num" id="3491575">0</span>&nbsp;<span class="op" id="3491577">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3491582">strings</span><span class="op" id="3491589">.</span><span class="ident" id="3491590">Contains</span><span class="op" id="3491598">(</span><span class="ident" id="3491599">name</span><span class="op" id="3491603">,</span>&nbsp;<span class="string" id="3491605">&#34;\x00&#34;</span><span class="op" id="3491611">)</span>&nbsp;<span class="op" id="3491613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3491617">return</span>&nbsp;<span class="builtintype" id="3491624">nil</span><span class="op" id="3491627">,</span>&nbsp;<span class="ident" id="3491629">errors</span><span class="op" id="3491635">.</span><span class="ident" id="3491636">New</span><span class="op" id="3491639">(</span><span class="string" id="3491640">&#34;http:&nbsp;invalid&nbsp;character&nbsp;in&nbsp;file&nbsp;path&#34;</span><span class="op" id="3491678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3491681">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3491684">dir</span>&nbsp;<span class="op" id="3491688">:=</span>&nbsp;<span class="builtintype" id="3491691">string</span><span class="op" id="3491697">(</span><span class="ident" id="3491698">d</span><span class="op" id="3491699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3491702">if</span>&nbsp;<span class="ident" id="3491705">dir</span>&nbsp;<span class="op" id="3491709">==</span>&nbsp;<span class="string" id="3491712">&#34;&#34;</span>&nbsp;<span class="op" id="3491715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3491719">dir</span>&nbsp;<span class="op" id="3491723">=</span>&nbsp;<span class="string" id="3491725">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3491730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3491733">f</span><span class="op" id="3491734">,</span>&nbsp;<span class="ident" id="3491736">err</span>&nbsp;<span class="op" id="3491740">:=</span>&nbsp;<span class="ident" id="3491743">os</span><span class="op" id="3491745">.</span><span class="ident" id="3491746">Open</span><span class="op" id="3491750">(</span><span class="ident" id="3491751">filepath</span><span class="op" id="3491759">.</span><span class="ident" id="3491760">Join</span><span class="op" id="3491764">(</span><span class="ident" id="3491765">dir</span><span class="op" id="3491768">,</span>&nbsp;<span class="ident" id="3491770">filepath</span><span class="op" id="3491778">.</span><span class="ident" id="3491779">FromSlash</span><span class="op" id="3491788">(</span><span class="ident" id="3491789">path</span><span class="op" id="3491793">.</span><span class="ident" id="3491794">Clean</span><span class="op" id="3491799">(</span><span class="string" id="3491800">&#34;/&#34;</span><span class="op" id="3491803">+</span><span class="ident" id="3491804">name</span><span class="op" id="3491808">)</span><span class="op" id="3491809">)</span><span class="op" id="3491810">)</span><span class="op" id="3491811">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3491814">if</span>&nbsp;<span class="ident" id="3491817">err</span>&nbsp;<span class="op" id="3491821">!=</span>&nbsp;<span class="builtintype" id="3491824">nil</span>&nbsp;<span class="op" id="3491828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3491832">return</span>&nbsp;<span class="builtintype" id="3491839">nil</span><span class="op" id="3491842">,</span>&nbsp;<span class="ident" id="3491844">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3491849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3491852">return</span>&nbsp;<span class="ident" id="3491859">f</span><span class="op" id="3491860">,</span>&nbsp;<span class="builtintype" id="3491862">nil</span><br>
<span class="lineno"></span><span class="op" id="3491866">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="3491869">//&nbsp;A&nbsp;FileSystem&nbsp;implements&nbsp;access&nbsp;to&nbsp;a&nbsp;collection&nbsp;of&nbsp;named&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="3491935">//&nbsp;The&nbsp;elements&nbsp;in&nbsp;a&nbsp;file&nbsp;path&nbsp;are&nbsp;separated&nbsp;by&nbsp;slash&nbsp;(&#39;/&#39;,&nbsp;U+002F)</span><br>
<span class="lineno"></span><span class="comment" id="3492003">//&nbsp;characters,&nbsp;regardless&nbsp;of&nbsp;host&nbsp;operating&nbsp;system&nbsp;convention.</span><br>
<span class="lineno"></span><span class="keyword" id="3492066">type</span>&nbsp;<span class="ident" id="3492071">FileSystem</span>&nbsp;<span class="keyword" id="3492082">interface</span>&nbsp;<span class="op" id="3492092">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3492095">Open</span><span class="op" id="3492099">(</span><span class="ident" id="3492100">name</span>&nbsp;<span class="builtintype" id="3492105">string</span><span class="op" id="3492111">)</span>&nbsp;<span class="op" id="3492113">(</span><span class="ident" id="3492114">File</span><span class="op" id="3492118">,</span>&nbsp;<span class="builtintype" id="3492120">error</span><span class="op" id="3492125">)</span><br>
<span class="lineno"></span><span class="op" id="3492127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3492130">//&nbsp;A&nbsp;File&nbsp;is&nbsp;returned&nbsp;by&nbsp;a&nbsp;FileSystem&#39;s&nbsp;Open&nbsp;method&nbsp;and&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3492193">//&nbsp;served&nbsp;by&nbsp;the&nbsp;FileServer&nbsp;implementation.</span><br>
<span class="lineno">60</span><span class="comment" id="3492237">//</span><br>
<span class="lineno"></span><span class="comment" id="3492240">//&nbsp;The&nbsp;methods&nbsp;should&nbsp;behave&nbsp;the&nbsp;same&nbsp;as&nbsp;those&nbsp;on&nbsp;an&nbsp;*os.File.</span><br>
<span class="lineno"></span><span class="keyword" id="3492303">type</span>&nbsp;<span class="ident" id="3492308">File</span>&nbsp;<span class="keyword" id="3492313">interface</span>&nbsp;<span class="op" id="3492323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3492326">io</span><span class="op" id="3492328">.</span><span class="ident" id="3492329">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3492337">io</span><span class="op" id="3492339">.</span><span class="ident" id="3492340">Reader</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3492348">Readdir</span><span class="op" id="3492355">(</span><span class="ident" id="3492356">count</span>&nbsp;<span class="builtintype" id="3492362">int</span><span class="op" id="3492365">)</span>&nbsp;<span class="op" id="3492367">(</span><span class="op" id="3492368">[</span><span class="op" id="3492369">]</span><span class="ident" id="3492370">os</span><span class="op" id="3492372">.</span><span class="ident" id="3492373">FileInfo</span><span class="op" id="3492381">,</span>&nbsp;<span class="builtintype" id="3492383">error</span><span class="op" id="3492388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3492391">Seek</span><span class="op" id="3492395">(</span><span class="ident" id="3492396">offset</span>&nbsp;<span class="builtintype" id="3492403">int64</span><span class="op" id="3492408">,</span>&nbsp;<span class="ident" id="3492410">whence</span>&nbsp;<span class="builtintype" id="3492417">int</span><span class="op" id="3492420">)</span>&nbsp;<span class="op" id="3492422">(</span><span class="builtintype" id="3492423">int64</span><span class="op" id="3492428">,</span>&nbsp;<span class="builtintype" id="3492430">error</span><span class="op" id="3492435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3492438">Stat</span><span class="op" id="3492442">(</span><span class="op" id="3492443">)</span>&nbsp;<span class="op" id="3492445">(</span><span class="ident" id="3492446">os</span><span class="op" id="3492448">.</span><span class="ident" id="3492449">FileInfo</span><span class="op" id="3492457">,</span>&nbsp;<span class="builtintype" id="3492459">error</span><span class="op" id="3492464">)</span><br>
<span class="lineno"></span><span class="op" id="3492466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3492469">func</span>&nbsp;<span class="ident" id="3492474">dirList</span><span class="op" id="3492481">(</span><span class="ident" id="3492482">w</span>&nbsp;<span class="ident" id="3492484">ResponseWriter</span><span class="op" id="3492498">,</span>&nbsp;<span class="ident" id="3492500">f</span>&nbsp;<span class="ident" id="3492502">File</span><span class="op" id="3492506">)</span>&nbsp;<span class="op" id="3492508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3492511">w</span><span class="op" id="3492512">.</span><span class="ident" id="3492513">Header</span><span class="op" id="3492519">(</span><span class="op" id="3492520">)</span><span class="op" id="3492521">.</span><span class="ident" id="3492522">Set</span><span class="op" id="3492525">(</span><span class="string" id="3492526">&#34;Content-Type&#34;</span><span class="op" id="3492540">,</span>&nbsp;<span class="string" id="3492542">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="3492568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3492571">fmt</span><span class="op" id="3492574">.</span><span class="ident" id="3492575">Fprintf</span><span class="op" id="3492582">(</span><span class="ident" id="3492583">w</span><span class="op" id="3492584">,</span>&nbsp;<span class="string" id="3492586">&#34;&lt;pre&gt;\n&#34;</span><span class="op" id="3492595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3492598">for</span>&nbsp;<span class="op" id="3492602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3492606">dirs</span><span class="op" id="3492610">,</span>&nbsp;<span class="ident" id="3492612">err</span>&nbsp;<span class="op" id="3492616">:=</span>&nbsp;<span class="ident" id="3492619">f</span><span class="op" id="3492620">.</span><span class="ident" id="3492621">Readdir</span><span class="op" id="3492628">(</span><span class="num" id="3492629">100</span><span class="op" id="3492632">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3492636">if</span>&nbsp;<span class="ident" id="3492639">err</span>&nbsp;<span class="op" id="3492643">!=</span>&nbsp;<span class="builtintype" id="3492646">nil</span>&nbsp;<span class="op" id="3492650">||</span>&nbsp;<span class="builtinfunc" id="3492653">len</span><span class="op" id="3492656">(</span><span class="ident" id="3492657">dirs</span><span class="op" id="3492661">)</span>&nbsp;<span class="op" id="3492663">==</span>&nbsp;<span class="num" id="3492666">0</span>&nbsp;<span class="op" id="3492668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3492673">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3492681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3492685">for</span>&nbsp;<span class="ident" id="3492689">_</span><span class="op" id="3492690">,</span>&nbsp;<span class="ident" id="3492692">d</span>&nbsp;<span class="op" id="3492694">:=</span>&nbsp;<span class="keyword" id="3492697">range</span>&nbsp;<span class="ident" id="3492703">dirs</span>&nbsp;<span class="op" id="3492708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3492713">name</span>&nbsp;<span class="op" id="3492718">:=</span>&nbsp;<span class="ident" id="3492721">d</span><span class="op" id="3492722">.</span><span class="ident" id="3492723">Name</span><span class="op" id="3492727">(</span><span class="op" id="3492728">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3492733">if</span>&nbsp;<span class="ident" id="3492736">d</span><span class="op" id="3492737">.</span><span class="ident" id="3492738">IsDir</span><span class="op" id="3492743">(</span><span class="op" id="3492744">)</span>&nbsp;<span class="op" id="3492746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3492752">name</span>&nbsp;<span class="op" id="3492757">+=</span>&nbsp;<span class="string" id="3492760">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3492767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3492772">//&nbsp;name&nbsp;may&nbsp;contain&nbsp;&#39;?&#39;&nbsp;or&nbsp;&#39;#&#39;,&nbsp;which&nbsp;must&nbsp;be&nbsp;escaped&nbsp;to&nbsp;remain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3492839">//&nbsp;part&nbsp;of&nbsp;the&nbsp;URL&nbsp;path,&nbsp;and&nbsp;not&nbsp;indicate&nbsp;the&nbsp;start&nbsp;of&nbsp;a&nbsp;query</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3492905">//&nbsp;string&nbsp;or&nbsp;fragment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3492931">url</span>&nbsp;<span class="op" id="3492935">:=</span>&nbsp;<span class="ident" id="3492938">url</span><span class="op" id="3492941">.</span><span class="ident" id="3492942">URL</span><span class="op" id="3492945">{</span><span class="ident" id="3492946">Path</span><span class="op" id="3492950">:</span>&nbsp;<span class="ident" id="3492952">name</span><span class="op" id="3492956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3492961">fmt</span><span class="op" id="3492964">.</span><span class="ident" id="3492965">Fprintf</span><span class="op" id="3492972">(</span><span class="ident" id="3492973">w</span><span class="op" id="3492974">,</span>&nbsp;<span class="string" id="3492976">&#34;&lt;a&nbsp;href=\&#34;%s\&#34;&gt;%s&lt;/a&gt;\n&#34;</span><span class="op" id="3493001">,</span>&nbsp;<span class="ident" id="3493003">url</span><span class="op" id="3493006">.</span><span class="ident" id="3493007">String</span><span class="op" id="3493013">(</span><span class="op" id="3493014">)</span><span class="op" id="3493015">,</span>&nbsp;<span class="ident" id="3493017">htmlReplacer</span><span class="op" id="3493029">.</span><span class="ident" id="3493030">Replace</span><span class="op" id="3493037">(</span><span class="ident" id="3493038">name</span><span class="op" id="3493042">)</span><span class="op" id="3493043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3493047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3493050">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3493053">fmt</span><span class="op" id="3493056">.</span><span class="ident" id="3493057">Fprintf</span><span class="op" id="3493064">(</span><span class="ident" id="3493065">w</span><span class="op" id="3493066">,</span>&nbsp;<span class="string" id="3493068">&#34;&lt;/pre&gt;\n&#34;</span><span class="op" id="3493078">)</span><br>
<span class="lineno"></span><span class="op" id="3493080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3493083">//&nbsp;ServeContent&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;using&nbsp;the&nbsp;content&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3493147">//&nbsp;provided&nbsp;ReadSeeker.&nbsp;&nbsp;The&nbsp;main&nbsp;benefit&nbsp;of&nbsp;ServeContent&nbsp;over&nbsp;io.Copy</span><br>
<span class="lineno">95</span><span class="comment" id="3493218">//&nbsp;is&nbsp;that&nbsp;it&nbsp;handles&nbsp;Range&nbsp;requests&nbsp;properly,&nbsp;sets&nbsp;the&nbsp;MIME&nbsp;type,&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3493289">//&nbsp;handles&nbsp;If-Modified-Since&nbsp;requests.</span><br>
<span class="lineno"></span><span class="comment" id="3493328">//</span><br>
<span class="lineno"></span><span class="comment" id="3493331">//&nbsp;If&nbsp;the&nbsp;response&#39;s&nbsp;Content-Type&nbsp;header&nbsp;is&nbsp;not&nbsp;set,&nbsp;ServeContent</span><br>
<span class="lineno"></span><span class="comment" id="3493397">//&nbsp;first&nbsp;tries&nbsp;to&nbsp;deduce&nbsp;the&nbsp;type&nbsp;from&nbsp;name&#39;s&nbsp;file&nbsp;extension&nbsp;and,</span><br>
<span class="lineno">100</span><span class="comment" id="3493463">//&nbsp;if&nbsp;that&nbsp;fails,&nbsp;falls&nbsp;back&nbsp;to&nbsp;reading&nbsp;the&nbsp;first&nbsp;block&nbsp;of&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="3493534">//&nbsp;and&nbsp;passing&nbsp;it&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span><span class="comment" id="3493574">//&nbsp;The&nbsp;name&nbsp;is&nbsp;otherwise&nbsp;unused;&nbsp;in&nbsp;particular&nbsp;it&nbsp;can&nbsp;be&nbsp;empty&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3493644">//&nbsp;never&nbsp;sent&nbsp;in&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3493675">//</span><br>
<span class="lineno">105</span><span class="comment" id="3493678">//&nbsp;If&nbsp;modtime&nbsp;is&nbsp;not&nbsp;the&nbsp;zero&nbsp;time,&nbsp;ServeContent&nbsp;includes&nbsp;it&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3493744">//&nbsp;Last-Modified&nbsp;header&nbsp;in&nbsp;the&nbsp;response.&nbsp;&nbsp;If&nbsp;the&nbsp;request&nbsp;includes&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3493813">//&nbsp;If-Modified-Since&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;modtime&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span><span class="comment" id="3493878">//&nbsp;whether&nbsp;the&nbsp;content&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span><span class="comment" id="3493926">//</span><br>
<span class="lineno">110</span><span class="comment" id="3493929">//&nbsp;The&nbsp;content&#39;s&nbsp;Seek&nbsp;method&nbsp;must&nbsp;work:&nbsp;ServeContent&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="3493987">//&nbsp;a&nbsp;seek&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;content&nbsp;to&nbsp;determine&nbsp;its&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="3494046">//</span><br>
<span class="lineno"></span><span class="comment" id="3494049">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;has&nbsp;set&nbsp;w&#39;s&nbsp;ETag&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3494115">//&nbsp;handle&nbsp;requests&nbsp;using&nbsp;If-Range&nbsp;and&nbsp;If-None-Match.</span><br>
<span class="lineno">115</span><span class="comment" id="3494168">//</span><br>
<span class="lineno"></span><span class="comment" id="3494171">//&nbsp;Note&nbsp;that&nbsp;*os.File&nbsp;implements&nbsp;the&nbsp;io.ReadSeeker&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3494233">func</span>&nbsp;<span class="ident" id="3494238">ServeContent</span><span class="op" id="3494250">(</span><span class="ident" id="3494251">w</span>&nbsp;<span class="ident" id="3494253">ResponseWriter</span><span class="op" id="3494267">,</span>&nbsp;<span class="ident" id="3494269">req</span>&nbsp;<span class="op" id="3494273">*</span><span class="ident" id="3494274">Request</span><span class="op" id="3494281">,</span>&nbsp;<span class="ident" id="3494283">name</span>&nbsp;<span class="builtintype" id="3494288">string</span><span class="op" id="3494294">,</span>&nbsp;<span class="ident" id="3494296">modtime</span>&nbsp;<span class="ident" id="3494304">time</span><span class="op" id="3494308">.</span><span class="ident" id="3494309">Time</span><span class="op" id="3494313">,</span>&nbsp;<span class="ident" id="3494315">content</span>&nbsp;<span class="ident" id="3494323">io</span><span class="op" id="3494325">.</span><span class="ident" id="3494326">ReadSeeker</span><span class="op" id="3494336">)</span>&nbsp;<span class="op" id="3494338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3494341">sizeFunc</span>&nbsp;<span class="op" id="3494350">:=</span>&nbsp;<span class="keyword" id="3494353">func</span><span class="op" id="3494357">(</span><span class="op" id="3494358">)</span>&nbsp;<span class="op" id="3494360">(</span><span class="builtintype" id="3494361">int64</span><span class="op" id="3494366">,</span>&nbsp;<span class="builtintype" id="3494368">error</span><span class="op" id="3494373">)</span>&nbsp;<span class="op" id="3494375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3494379">size</span><span class="op" id="3494383">,</span>&nbsp;<span class="ident" id="3494385">err</span>&nbsp;<span class="op" id="3494389">:=</span>&nbsp;<span class="ident" id="3494392">content</span><span class="op" id="3494399">.</span><span class="ident" id="3494400">Seek</span><span class="op" id="3494404">(</span><span class="num" id="3494405">0</span><span class="op" id="3494406">,</span>&nbsp;<span class="ident" id="3494408">os</span><span class="op" id="3494410">.</span><span class="ident" id="3494411">SEEK_END</span><span class="op" id="3494419">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3494423">if</span>&nbsp;<span class="ident" id="3494426">err</span>&nbsp;<span class="op" id="3494430">!=</span>&nbsp;<span class="builtintype" id="3494433">nil</span>&nbsp;<span class="op" id="3494437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3494442">return</span>&nbsp;<span class="num" id="3494449">0</span><span class="op" id="3494450">,</span>&nbsp;<span class="ident" id="3494452">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3494464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3494468">_</span><span class="op" id="3494469">,</span>&nbsp;<span class="ident" id="3494471">err</span>&nbsp;<span class="op" id="3494475">=</span>&nbsp;<span class="ident" id="3494477">content</span><span class="op" id="3494484">.</span><span class="ident" id="3494485">Seek</span><span class="op" id="3494489">(</span><span class="num" id="3494490">0</span><span class="op" id="3494491">,</span>&nbsp;<span class="ident" id="3494493">os</span><span class="op" id="3494495">.</span><span class="ident" id="3494496">SEEK_SET</span><span class="op" id="3494504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3494508">if</span>&nbsp;<span class="ident" id="3494511">err</span>&nbsp;<span class="op" id="3494515">!=</span>&nbsp;<span class="builtintype" id="3494518">nil</span>&nbsp;<span class="op" id="3494522">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3494527">return</span>&nbsp;<span class="num" id="3494534">0</span><span class="op" id="3494535">,</span>&nbsp;<span class="ident" id="3494537">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3494549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3494553">return</span>&nbsp;<span class="ident" id="3494560">size</span><span class="op" id="3494564">,</span>&nbsp;<span class="builtintype" id="3494566">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3494571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3494574">serveContent</span><span class="op" id="3494586">(</span><span class="ident" id="3494587">w</span><span class="op" id="3494588">,</span>&nbsp;<span class="ident" id="3494590">req</span><span class="op" id="3494593">,</span>&nbsp;<span class="ident" id="3494595">name</span><span class="op" id="3494599">,</span>&nbsp;<span class="ident" id="3494601">modtime</span><span class="op" id="3494608">,</span>&nbsp;<span class="ident" id="3494610">sizeFunc</span><span class="op" id="3494618">,</span>&nbsp;<span class="ident" id="3494620">content</span><span class="op" id="3494627">)</span><br>
<span class="lineno">130</span><span class="op" id="3494629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3494632">//&nbsp;errSeeker&nbsp;is&nbsp;returned&nbsp;by&nbsp;ServeContent&#39;s&nbsp;sizeFunc&nbsp;when&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="3494701">//&nbsp;doesn&#39;t&nbsp;seek&nbsp;properly.&nbsp;The&nbsp;underlying&nbsp;Seeker&#39;s&nbsp;error&nbsp;text&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3494768">//&nbsp;included&nbsp;in&nbsp;the&nbsp;sizeFunc&nbsp;reply&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;sent&nbsp;over&nbsp;HTTP&nbsp;to&nbsp;end</span><br>
<span class="lineno">135</span><span class="comment" id="3494836">//&nbsp;users.</span><br>
<span class="lineno"></span><span class="keyword" id="3494846">var</span>&nbsp;<span class="ident" id="3494850">errSeeker</span>&nbsp;<span class="op" id="3494860">=</span>&nbsp;<span class="ident" id="3494862">errors</span><span class="op" id="3494868">.</span><span class="ident" id="3494869">New</span><span class="op" id="3494872">(</span><span class="string" id="3494873">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="3494892">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3494895">//&nbsp;if&nbsp;name&nbsp;is&nbsp;empty,&nbsp;filename&nbsp;is&nbsp;unknown.&nbsp;(used&nbsp;for&nbsp;mime&nbsp;type,&nbsp;before&nbsp;sniffing)</span><br>
<span class="lineno"></span><span class="comment" id="3494975">//&nbsp;if&nbsp;modtime.IsZero(),&nbsp;modtime&nbsp;is&nbsp;unknown.</span><br>
<span class="lineno">140</span><span class="comment" id="3495019">//&nbsp;content&nbsp;must&nbsp;be&nbsp;seeked&nbsp;to&nbsp;the&nbsp;beginning&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="3495075">//&nbsp;The&nbsp;sizeFunc&nbsp;is&nbsp;called&nbsp;at&nbsp;most&nbsp;once.&nbsp;Its&nbsp;error,&nbsp;if&nbsp;any,&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3495164">func</span>&nbsp;<span class="ident" id="3495169">serveContent</span><span class="op" id="3495181">(</span><span class="ident" id="3495182">w</span>&nbsp;<span class="ident" id="3495184">ResponseWriter</span><span class="op" id="3495198">,</span>&nbsp;<span class="ident" id="3495200">r</span>&nbsp;<span class="op" id="3495202">*</span><span class="ident" id="3495203">Request</span><span class="op" id="3495210">,</span>&nbsp;<span class="ident" id="3495212">name</span>&nbsp;<span class="builtintype" id="3495217">string</span><span class="op" id="3495223">,</span>&nbsp;<span class="ident" id="3495225">modtime</span>&nbsp;<span class="ident" id="3495233">time</span><span class="op" id="3495237">.</span><span class="ident" id="3495238">Time</span><span class="op" id="3495242">,</span>&nbsp;<span class="ident" id="3495244">sizeFunc</span>&nbsp;<span class="keyword" id="3495253">func</span><span class="op" id="3495257">(</span><span class="op" id="3495258">)</span>&nbsp;<span class="op" id="3495260">(</span><span class="builtintype" id="3495261">int64</span><span class="op" id="3495266">,</span>&nbsp;<span class="builtintype" id="3495268">error</span><span class="op" id="3495273">)</span><span class="op" id="3495274">,</span>&nbsp;<span class="ident" id="3495276">content</span>&nbsp;<span class="ident" id="3495284">io</span><span class="op" id="3495286">.</span><span class="ident" id="3495287">ReadSeeker</span><span class="op" id="3495297">)</span>&nbsp;<span class="op" id="3495299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3495302">if</span>&nbsp;<span class="ident" id="3495305">checkLastModified</span><span class="op" id="3495322">(</span><span class="ident" id="3495323">w</span><span class="op" id="3495324">,</span>&nbsp;<span class="ident" id="3495326">r</span><span class="op" id="3495327">,</span>&nbsp;<span class="ident" id="3495329">modtime</span><span class="op" id="3495336">)</span>&nbsp;<span class="op" id="3495338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3495342">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3495350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3495353">rangeReq</span><span class="op" id="3495361">,</span>&nbsp;<span class="ident" id="3495363">done</span>&nbsp;<span class="op" id="3495368">:=</span>&nbsp;<span class="ident" id="3495371">checkETag</span><span class="op" id="3495380">(</span><span class="ident" id="3495381">w</span><span class="op" id="3495382">,</span>&nbsp;<span class="ident" id="3495384">r</span><span class="op" id="3495385">,</span>&nbsp;<span class="ident" id="3495387">modtime</span><span class="op" id="3495394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3495397">if</span>&nbsp;<span class="ident" id="3495400">done</span>&nbsp;<span class="op" id="3495405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3495409">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3495417">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3495421">code</span>&nbsp;<span class="op" id="3495426">:=</span>&nbsp;<span class="ident" id="3495429">StatusOK</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3495440">//&nbsp;If&nbsp;Content-Type&nbsp;isn&#39;t&nbsp;set,&nbsp;use&nbsp;the&nbsp;file&#39;s&nbsp;extension&nbsp;to&nbsp;find&nbsp;it,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3495512">//&nbsp;if&nbsp;the&nbsp;Content-Type&nbsp;is&nbsp;unset&nbsp;explicitly,&nbsp;do&nbsp;not&nbsp;sniff&nbsp;the&nbsp;type.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3495580">ctypes</span><span class="op" id="3495586">,</span>&nbsp;<span class="ident" id="3495588">haveType</span>&nbsp;<span class="op" id="3495597">:=</span>&nbsp;<span class="ident" id="3495600">w</span><span class="op" id="3495601">.</span><span class="ident" id="3495602">Header</span><span class="op" id="3495608">(</span><span class="op" id="3495609">)</span><span class="op" id="3495610">[</span><span class="string" id="3495611">&#34;Content-Type&#34;</span><span class="op" id="3495625">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3495628">var</span>&nbsp;<span class="ident" id="3495632">ctype</span>&nbsp;<span class="builtintype" id="3495638">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3495646">if</span>&nbsp;<span class="op" id="3495649">!</span><span class="ident" id="3495650">haveType</span>&nbsp;<span class="op" id="3495659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3495663">ctype</span>&nbsp;<span class="op" id="3495669">=</span>&nbsp;<span class="ident" id="3495671">mime</span><span class="op" id="3495675">.</span><span class="ident" id="3495676">TypeByExtension</span><span class="op" id="3495691">(</span><span class="ident" id="3495692">filepath</span><span class="op" id="3495700">.</span><span class="ident" id="3495701">Ext</span><span class="op" id="3495704">(</span><span class="ident" id="3495705">name</span><span class="op" id="3495709">)</span><span class="op" id="3495710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3495714">if</span>&nbsp;<span class="ident" id="3495717">ctype</span>&nbsp;<span class="op" id="3495723">==</span>&nbsp;<span class="string" id="3495726">&#34;&#34;</span>&nbsp;<span class="op" id="3495729">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3495734">//&nbsp;read&nbsp;a&nbsp;chunk&nbsp;to&nbsp;decide&nbsp;between&nbsp;utf-8&nbsp;text&nbsp;and&nbsp;binary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3495793">var</span>&nbsp;<span class="ident" id="3495797">buf</span>&nbsp;<span class="op" id="3495801">[</span><span class="ident" id="3495802">sniffLen</span><span class="op" id="3495810">]</span><span class="builtintype" id="3495811">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3495819">n</span><span class="op" id="3495820">,</span>&nbsp;<span class="ident" id="3495822">_</span>&nbsp;<span class="op" id="3495824">:=</span>&nbsp;<span class="ident" id="3495827">io</span><span class="op" id="3495829">.</span><span class="ident" id="3495830">ReadFull</span><span class="op" id="3495838">(</span><span class="ident" id="3495839">content</span><span class="op" id="3495846">,</span>&nbsp;<span class="ident" id="3495848">buf</span><span class="op" id="3495851">[</span><span class="op" id="3495852">:</span><span class="op" id="3495853">]</span><span class="op" id="3495854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3495859">ctype</span>&nbsp;<span class="op" id="3495865">=</span>&nbsp;<span class="ident" id="3495867">DetectContentType</span><span class="op" id="3495884">(</span><span class="ident" id="3495885">buf</span><span class="op" id="3495888">[</span><span class="op" id="3495889">:</span><span class="ident" id="3495890">n</span><span class="op" id="3495891">]</span><span class="op" id="3495892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3495897">_</span><span class="op" id="3495898">,</span>&nbsp;<span class="ident" id="3495900">err</span>&nbsp;<span class="op" id="3495904">:=</span>&nbsp;<span class="ident" id="3495907">content</span><span class="op" id="3495914">.</span><span class="ident" id="3495915">Seek</span><span class="op" id="3495919">(</span><span class="num" id="3495920">0</span><span class="op" id="3495921">,</span>&nbsp;<span class="ident" id="3495923">os</span><span class="op" id="3495925">.</span><span class="ident" id="3495926">SEEK_SET</span><span class="op" id="3495934">)</span>&nbsp;<span class="comment" id="3495936">//&nbsp;rewind&nbsp;to&nbsp;output&nbsp;whole&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3495970">if</span>&nbsp;<span class="ident" id="3495973">err</span>&nbsp;<span class="op" id="3495977">!=</span>&nbsp;<span class="builtintype" id="3495980">nil</span>&nbsp;<span class="op" id="3495984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3495990">Error</span><span class="op" id="3495995">(</span><span class="ident" id="3495996">w</span><span class="op" id="3495997">,</span>&nbsp;<span class="string" id="3495999">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="3496018">,</span>&nbsp;<span class="ident" id="3496020">StatusInternalServerError</span><span class="op" id="3496045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3496051">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3496061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3496065">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3496069">w</span><span class="op" id="3496070">.</span><span class="ident" id="3496071">Header</span><span class="op" id="3496077">(</span><span class="op" id="3496078">)</span><span class="op" id="3496079">.</span><span class="ident" id="3496080">Set</span><span class="op" id="3496083">(</span><span class="string" id="3496084">&#34;Content-Type&#34;</span><span class="op" id="3496098">,</span>&nbsp;<span class="ident" id="3496100">ctype</span><span class="op" id="3496105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3496108">}</span>&nbsp;<span class="keyword" id="3496110">else</span>&nbsp;<span class="keyword" id="3496115">if</span>&nbsp;<span class="builtinfunc" id="3496118">len</span><span class="op" id="3496121">(</span><span class="ident" id="3496122">ctypes</span><span class="op" id="3496128">)</span>&nbsp;<span class="op" id="3496130">&gt;</span>&nbsp;<span class="num" id="3496132">0</span>&nbsp;<span class="op" id="3496134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3496138">ctype</span>&nbsp;<span class="op" id="3496144">=</span>&nbsp;<span class="ident" id="3496146">ctypes</span><span class="op" id="3496152">[</span><span class="num" id="3496153">0</span><span class="op" id="3496154">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3496157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3496161">size</span><span class="op" id="3496165">,</span>&nbsp;<span class="ident" id="3496167">err</span>&nbsp;<span class="op" id="3496171">:=</span>&nbsp;<span class="ident" id="3496174">sizeFunc</span><span class="op" id="3496182">(</span><span class="op" id="3496183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3496186">if</span>&nbsp;<span class="ident" id="3496189">err</span>&nbsp;<span class="op" id="3496193">!=</span>&nbsp;<span class="builtintype" id="3496196">nil</span>&nbsp;<span class="op" id="3496200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3496204">Error</span><span class="op" id="3496209">(</span><span class="ident" id="3496210">w</span><span class="op" id="3496211">,</span>&nbsp;<span class="ident" id="3496213">err</span><span class="op" id="3496216">.</span><span class="ident" id="3496217">Error</span><span class="op" id="3496222">(</span><span class="op" id="3496223">)</span><span class="op" id="3496224">,</span>&nbsp;<span class="ident" id="3496226">StatusInternalServerError</span><span class="op" id="3496251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3496255">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3496263">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3496267">//&nbsp;handle&nbsp;Content-Range&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3496300">sendSize</span>&nbsp;<span class="op" id="3496309">:=</span>&nbsp;<span class="ident" id="3496312">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3496318">var</span>&nbsp;<span class="ident" id="3496322">sendContent</span>&nbsp;<span class="ident" id="3496334">io</span><span class="op" id="3496336">.</span><span class="ident" id="3496337">Reader</span>&nbsp;<span class="op" id="3496344">=</span>&nbsp;<span class="ident" id="3496346">content</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3496355">if</span>&nbsp;<span class="ident" id="3496358">size</span>&nbsp;<span class="op" id="3496363">&gt;=</span>&nbsp;<span class="num" id="3496366">0</span>&nbsp;<span class="op" id="3496368">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3496372">ranges</span><span class="op" id="3496378">,</span>&nbsp;<span class="ident" id="3496380">err</span>&nbsp;<span class="op" id="3496384">:=</span>&nbsp;<span class="ident" id="3496387">parseRange</span><span class="op" id="3496397">(</span><span class="ident" id="3496398">rangeReq</span><span class="op" id="3496406">,</span>&nbsp;<span class="ident" id="3496408">size</span><span class="op" id="3496412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3496416">if</span>&nbsp;<span class="ident" id="3496419">err</span>&nbsp;<span class="op" id="3496423">!=</span>&nbsp;<span class="builtintype" id="3496426">nil</span>&nbsp;<span class="op" id="3496430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3496435">Error</span><span class="op" id="3496440">(</span><span class="ident" id="3496441">w</span><span class="op" id="3496442">,</span>&nbsp;<span class="ident" id="3496444">err</span><span class="op" id="3496447">.</span><span class="ident" id="3496448">Error</span><span class="op" id="3496453">(</span><span class="op" id="3496454">)</span><span class="op" id="3496455">,</span>&nbsp;<span class="ident" id="3496457">StatusRequestedRangeNotSatisfiable</span><span class="op" id="3496491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3496496">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3496505">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3496509">if</span>&nbsp;<span class="ident" id="3496512">sumRangesSize</span><span class="op" id="3496525">(</span><span class="ident" id="3496526">ranges</span><span class="op" id="3496532">)</span>&nbsp;<span class="op" id="3496534">&gt;</span>&nbsp;<span class="ident" id="3496536">size</span>&nbsp;<span class="op" id="3496541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3496546">//&nbsp;The&nbsp;total&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;all&nbsp;the&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3496596">//&nbsp;is&nbsp;larger&nbsp;than&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;file&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3496641">//&nbsp;itself,&nbsp;so&nbsp;this&nbsp;is&nbsp;probably&nbsp;an&nbsp;attack,&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3496691">//&nbsp;dumb&nbsp;client.&nbsp;&nbsp;Ignore&nbsp;the&nbsp;range&nbsp;request.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3496737">ranges</span>&nbsp;<span class="op" id="3496744">=</span>&nbsp;<span class="builtintype" id="3496746">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3496752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3496756">switch</span>&nbsp;<span class="op" id="3496763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3496767">case</span>&nbsp;<span class="builtinfunc" id="3496772">len</span><span class="op" id="3496775">(</span><span class="ident" id="3496776">ranges</span><span class="op" id="3496782">)</span>&nbsp;<span class="op" id="3496784">==</span>&nbsp;<span class="num" id="3496787">1</span><span class="op" id="3496788">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3496793">//&nbsp;RFC&nbsp;2616,&nbsp;Section&nbsp;14.16:</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3496824">//&nbsp;&#34;When&nbsp;an&nbsp;HTTP&nbsp;message&nbsp;includes&nbsp;the&nbsp;content&nbsp;of&nbsp;a&nbsp;single</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3496885">//&nbsp;range&nbsp;(for&nbsp;example,&nbsp;a&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3496941">//&nbsp;single&nbsp;range,&nbsp;or&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;set&nbsp;of&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3496997">//&nbsp;that&nbsp;overlap&nbsp;without&nbsp;any&nbsp;holes),&nbsp;this&nbsp;content&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3497052">//&nbsp;transmitted&nbsp;with&nbsp;a&nbsp;Content-Range&nbsp;header,&nbsp;and&nbsp;a</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3497105">//&nbsp;Content-Length&nbsp;header&nbsp;showing&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3497161">//&nbsp;actually&nbsp;transferred.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3497189">//&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3497199">//&nbsp;A&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;single&nbsp;range&nbsp;MUST&nbsp;NOT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3497257">//&nbsp;be&nbsp;sent&nbsp;using&nbsp;the&nbsp;multipart/byteranges&nbsp;media&nbsp;type.&#34;</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3497315">ra</span>&nbsp;<span class="op" id="3497318">:=</span>&nbsp;<span class="ident" id="3497321">ranges</span><span class="op" id="3497327">[</span><span class="num" id="3497328">0</span><span class="op" id="3497329">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3497334">if</span>&nbsp;<span class="ident" id="3497337">_</span><span class="op" id="3497338">,</span>&nbsp;<span class="ident" id="3497340">err</span>&nbsp;<span class="op" id="3497344">:=</span>&nbsp;<span class="ident" id="3497347">content</span><span class="op" id="3497354">.</span><span class="ident" id="3497355">Seek</span><span class="op" id="3497359">(</span><span class="ident" id="3497360">ra</span><span class="op" id="3497362">.</span><span class="ident" id="3497363">start</span><span class="op" id="3497368">,</span>&nbsp;<span class="ident" id="3497370">os</span><span class="op" id="3497372">.</span><span class="ident" id="3497373">SEEK_SET</span><span class="op" id="3497381">)</span><span class="op" id="3497382">;</span>&nbsp;<span class="ident" id="3497384">err</span>&nbsp;<span class="op" id="3497388">!=</span>&nbsp;<span class="builtintype" id="3497391">nil</span>&nbsp;<span class="op" id="3497395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3497401">Error</span><span class="op" id="3497406">(</span><span class="ident" id="3497407">w</span><span class="op" id="3497408">,</span>&nbsp;<span class="ident" id="3497410">err</span><span class="op" id="3497413">.</span><span class="ident" id="3497414">Error</span><span class="op" id="3497419">(</span><span class="op" id="3497420">)</span><span class="op" id="3497421">,</span>&nbsp;<span class="ident" id="3497423">StatusRequestedRangeNotSatisfiable</span><span class="op" id="3497457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3497463">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3497473">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3497478">sendSize</span>&nbsp;<span class="op" id="3497487">=</span>&nbsp;<span class="ident" id="3497489">ra</span><span class="op" id="3497491">.</span><span class="ident" id="3497492">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3497502">code</span>&nbsp;<span class="op" id="3497507">=</span>&nbsp;<span class="ident" id="3497509">StatusPartialContent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3497533">w</span><span class="op" id="3497534">.</span><span class="ident" id="3497535">Header</span><span class="op" id="3497541">(</span><span class="op" id="3497542">)</span><span class="op" id="3497543">.</span><span class="ident" id="3497544">Set</span><span class="op" id="3497547">(</span><span class="string" id="3497548">&#34;Content-Range&#34;</span><span class="op" id="3497563">,</span>&nbsp;<span class="ident" id="3497565">ra</span><span class="op" id="3497567">.</span><span class="ident" id="3497568">contentRange</span><span class="op" id="3497580">(</span><span class="ident" id="3497581">size</span><span class="op" id="3497585">)</span><span class="op" id="3497586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3497590">case</span>&nbsp;<span class="builtinfunc" id="3497595">len</span><span class="op" id="3497598">(</span><span class="ident" id="3497599">ranges</span><span class="op" id="3497605">)</span>&nbsp;<span class="op" id="3497607">&gt;</span>&nbsp;<span class="num" id="3497609">1</span><span class="op" id="3497610">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3497615">sendSize</span>&nbsp;<span class="op" id="3497624">=</span>&nbsp;<span class="ident" id="3497626">rangesMIMESize</span><span class="op" id="3497640">(</span><span class="ident" id="3497641">ranges</span><span class="op" id="3497647">,</span>&nbsp;<span class="ident" id="3497649">ctype</span><span class="op" id="3497654">,</span>&nbsp;<span class="ident" id="3497656">size</span><span class="op" id="3497660">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3497665">code</span>&nbsp;<span class="op" id="3497670">=</span>&nbsp;<span class="ident" id="3497672">StatusPartialContent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3497697">pr</span><span class="op" id="3497699">,</span>&nbsp;<span class="ident" id="3497701">pw</span>&nbsp;<span class="op" id="3497704">:=</span>&nbsp;<span class="ident" id="3497707">io</span><span class="op" id="3497709">.</span><span class="ident" id="3497710">Pipe</span><span class="op" id="3497714">(</span><span class="op" id="3497715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3497720">mw</span>&nbsp;<span class="op" id="3497723">:=</span>&nbsp;<span class="ident" id="3497726">multipart</span><span class="op" id="3497735">.</span><span class="ident" id="3497736">NewWriter</span><span class="op" id="3497745">(</span><span class="ident" id="3497746">pw</span><span class="op" id="3497748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3497753">w</span><span class="op" id="3497754">.</span><span class="ident" id="3497755">Header</span><span class="op" id="3497761">(</span><span class="op" id="3497762">)</span><span class="op" id="3497763">.</span><span class="ident" id="3497764">Set</span><span class="op" id="3497767">(</span><span class="string" id="3497768">&#34;Content-Type&#34;</span><span class="op" id="3497782">,</span>&nbsp;<span class="string" id="3497784">&#34;multipart/byteranges;&nbsp;boundary=&#34;</span><span class="op" id="3497817">+</span><span class="ident" id="3497818">mw</span><span class="op" id="3497820">.</span><span class="ident" id="3497821">Boundary</span><span class="op" id="3497829">(</span><span class="op" id="3497830">)</span><span class="op" id="3497831">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3497836">sendContent</span>&nbsp;<span class="op" id="3497848">=</span>&nbsp;<span class="ident" id="3497850">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3497856">defer</span>&nbsp;<span class="ident" id="3497862">pr</span><span class="op" id="3497864">.</span><span class="ident" id="3497865">Close</span><span class="op" id="3497870">(</span><span class="op" id="3497871">)</span>&nbsp;<span class="comment" id="3497873">//&nbsp;cause&nbsp;writing&nbsp;goroutine&nbsp;to&nbsp;fail&nbsp;and&nbsp;exit&nbsp;if&nbsp;CopyN&nbsp;doesn&#39;t&nbsp;finish.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3497945">go</span>&nbsp;<span class="keyword" id="3497948">func</span><span class="op" id="3497952">(</span><span class="op" id="3497953">)</span>&nbsp;<span class="op" id="3497955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3497961">for</span>&nbsp;<span class="ident" id="3497965">_</span><span class="op" id="3497966">,</span>&nbsp;<span class="ident" id="3497968">ra</span>&nbsp;<span class="op" id="3497971">:=</span>&nbsp;<span class="keyword" id="3497974">range</span>&nbsp;<span class="ident" id="3497980">ranges</span>&nbsp;<span class="op" id="3497987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3497994">part</span><span class="op" id="3497998">,</span>&nbsp;<span class="ident" id="3498000">err</span>&nbsp;<span class="op" id="3498004">:=</span>&nbsp;<span class="ident" id="3498007">mw</span><span class="op" id="3498009">.</span><span class="ident" id="3498010">CreatePart</span><span class="op" id="3498020">(</span><span class="ident" id="3498021">ra</span><span class="op" id="3498023">.</span><span class="ident" id="3498024">mimeHeader</span><span class="op" id="3498034">(</span><span class="ident" id="3498035">ctype</span><span class="op" id="3498040">,</span>&nbsp;<span class="ident" id="3498042">size</span><span class="op" id="3498046">)</span><span class="op" id="3498047">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3498054">if</span>&nbsp;<span class="ident" id="3498057">err</span>&nbsp;<span class="op" id="3498061">!=</span>&nbsp;<span class="builtintype" id="3498064">nil</span>&nbsp;<span class="op" id="3498068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3498076">pw</span><span class="op" id="3498078">.</span><span class="ident" id="3498079">CloseWithError</span><span class="op" id="3498093">(</span><span class="ident" id="3498094">err</span><span class="op" id="3498097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3498105">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3498117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3498124">if</span>&nbsp;<span class="ident" id="3498127">_</span><span class="op" id="3498128">,</span>&nbsp;<span class="ident" id="3498130">err</span>&nbsp;<span class="op" id="3498134">:=</span>&nbsp;<span class="ident" id="3498137">content</span><span class="op" id="3498144">.</span><span class="ident" id="3498145">Seek</span><span class="op" id="3498149">(</span><span class="ident" id="3498150">ra</span><span class="op" id="3498152">.</span><span class="ident" id="3498153">start</span><span class="op" id="3498158">,</span>&nbsp;<span class="ident" id="3498160">os</span><span class="op" id="3498162">.</span><span class="ident" id="3498163">SEEK_SET</span><span class="op" id="3498171">)</span><span class="op" id="3498172">;</span>&nbsp;<span class="ident" id="3498174">err</span>&nbsp;<span class="op" id="3498178">!=</span>&nbsp;<span class="builtintype" id="3498181">nil</span>&nbsp;<span class="op" id="3498185">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3498193">pw</span><span class="op" id="3498195">.</span><span class="ident" id="3498196">CloseWithError</span><span class="op" id="3498210">(</span><span class="ident" id="3498211">err</span><span class="op" id="3498214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3498222">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3498234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3498241">if</span>&nbsp;<span class="ident" id="3498244">_</span><span class="op" id="3498245">,</span>&nbsp;<span class="ident" id="3498247">err</span>&nbsp;<span class="op" id="3498251">:=</span>&nbsp;<span class="ident" id="3498254">io</span><span class="op" id="3498256">.</span><span class="ident" id="3498257">CopyN</span><span class="op" id="3498262">(</span><span class="ident" id="3498263">part</span><span class="op" id="3498267">,</span>&nbsp;<span class="ident" id="3498269">content</span><span class="op" id="3498276">,</span>&nbsp;<span class="ident" id="3498278">ra</span><span class="op" id="3498280">.</span><span class="ident" id="3498281">length</span><span class="op" id="3498287">)</span><span class="op" id="3498288">;</span>&nbsp;<span class="ident" id="3498290">err</span>&nbsp;<span class="op" id="3498294">!=</span>&nbsp;<span class="builtintype" id="3498297">nil</span>&nbsp;<span class="op" id="3498301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3498309">pw</span><span class="op" id="3498311">.</span><span class="ident" id="3498312">CloseWithError</span><span class="op" id="3498326">(</span><span class="ident" id="3498327">err</span><span class="op" id="3498330">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3498338">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3498350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3498356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3498362">mw</span><span class="op" id="3498364">.</span><span class="ident" id="3498365">Close</span><span class="op" id="3498370">(</span><span class="op" id="3498371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3498377">pw</span><span class="op" id="3498379">.</span><span class="ident" id="3498380">Close</span><span class="op" id="3498385">(</span><span class="op" id="3498386">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3498391">}</span><span class="op" id="3498392">(</span><span class="op" id="3498393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3498397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3498402">w</span><span class="op" id="3498403">.</span><span class="ident" id="3498404">Header</span><span class="op" id="3498410">(</span><span class="op" id="3498411">)</span><span class="op" id="3498412">.</span><span class="ident" id="3498413">Set</span><span class="op" id="3498416">(</span><span class="string" id="3498417">&#34;Accept-Ranges&#34;</span><span class="op" id="3498432">,</span>&nbsp;<span class="string" id="3498434">&#34;bytes&#34;</span><span class="op" id="3498441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3498445">if</span>&nbsp;<span class="ident" id="3498448">w</span><span class="op" id="3498449">.</span><span class="ident" id="3498450">Header</span><span class="op" id="3498456">(</span><span class="op" id="3498457">)</span><span class="op" id="3498458">.</span><span class="ident" id="3498459">Get</span><span class="op" id="3498462">(</span><span class="string" id="3498463">&#34;Content-Encoding&#34;</span><span class="op" id="3498481">)</span>&nbsp;<span class="op" id="3498483">==</span>&nbsp;<span class="string" id="3498486">&#34;&#34;</span>&nbsp;<span class="op" id="3498489">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3498494">w</span><span class="op" id="3498495">.</span><span class="ident" id="3498496">Header</span><span class="op" id="3498502">(</span><span class="op" id="3498503">)</span><span class="op" id="3498504">.</span><span class="ident" id="3498505">Set</span><span class="op" id="3498508">(</span><span class="string" id="3498509">&#34;Content-Length&#34;</span><span class="op" id="3498525">,</span>&nbsp;<span class="ident" id="3498527">strconv</span><span class="op" id="3498534">.</span><span class="ident" id="3498535">FormatInt</span><span class="op" id="3498544">(</span><span class="ident" id="3498545">sendSize</span><span class="op" id="3498553">,</span>&nbsp;<span class="num" id="3498555">10</span><span class="op" id="3498557">)</span><span class="op" id="3498558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3498562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3498565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3498569">w</span><span class="op" id="3498570">.</span><span class="ident" id="3498571">WriteHeader</span><span class="op" id="3498582">(</span><span class="ident" id="3498583">code</span><span class="op" id="3498587">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3498591">if</span>&nbsp;<span class="ident" id="3498594">r</span><span class="op" id="3498595">.</span><span class="ident" id="3498596">Method</span>&nbsp;<span class="op" id="3498603">!=</span>&nbsp;<span class="string" id="3498606">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3498613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3498617">io</span><span class="op" id="3498619">.</span><span class="ident" id="3498620">CopyN</span><span class="op" id="3498625">(</span><span class="ident" id="3498626">w</span><span class="op" id="3498627">,</span>&nbsp;<span class="ident" id="3498629">sendContent</span><span class="op" id="3498640">,</span>&nbsp;<span class="ident" id="3498642">sendSize</span><span class="op" id="3498650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3498653">}</span><br>
<span class="lineno"></span><span class="op" id="3498655">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="3498658">//&nbsp;modtime&nbsp;is&nbsp;the&nbsp;modification&nbsp;time&nbsp;of&nbsp;the&nbsp;resource&nbsp;to&nbsp;be&nbsp;served,&nbsp;or&nbsp;IsZero().</span><br>
<span class="lineno"></span><span class="comment" id="3498737">//&nbsp;return&nbsp;value&nbsp;is&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;complete.</span><br>
<span class="lineno"></span><span class="keyword" id="3498794">func</span>&nbsp;<span class="ident" id="3498799">checkLastModified</span><span class="op" id="3498816">(</span><span class="ident" id="3498817">w</span>&nbsp;<span class="ident" id="3498819">ResponseWriter</span><span class="op" id="3498833">,</span>&nbsp;<span class="ident" id="3498835">r</span>&nbsp;<span class="op" id="3498837">*</span><span class="ident" id="3498838">Request</span><span class="op" id="3498845">,</span>&nbsp;<span class="ident" id="3498847">modtime</span>&nbsp;<span class="ident" id="3498855">time</span><span class="op" id="3498859">.</span><span class="ident" id="3498860">Time</span><span class="op" id="3498864">)</span>&nbsp;<span class="builtintype" id="3498866">bool</span>&nbsp;<span class="op" id="3498871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3498874">if</span>&nbsp;<span class="ident" id="3498877">modtime</span><span class="op" id="3498884">.</span><span class="ident" id="3498885">IsZero</span><span class="op" id="3498891">(</span><span class="op" id="3498892">)</span>&nbsp;<span class="op" id="3498894">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3498898">return</span>&nbsp;<span class="builtintype" id="3498905">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3498912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3498916">//&nbsp;The&nbsp;Date-Modified&nbsp;header&nbsp;truncates&nbsp;sub-second&nbsp;precision,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3498980">//&nbsp;use&nbsp;mtime&nbsp;&lt;&nbsp;t+1s&nbsp;instead&nbsp;of&nbsp;mtime&nbsp;&lt;=&nbsp;t&nbsp;to&nbsp;check&nbsp;for&nbsp;unmodified.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3499048">if</span>&nbsp;<span class="ident" id="3499051">t</span><span class="op" id="3499052">,</span>&nbsp;<span class="ident" id="3499054">err</span>&nbsp;<span class="op" id="3499058">:=</span>&nbsp;<span class="ident" id="3499061">time</span><span class="op" id="3499065">.</span><span class="ident" id="3499066">Parse</span><span class="op" id="3499071">(</span><span class="ident" id="3499072">TimeFormat</span><span class="op" id="3499082">,</span>&nbsp;<span class="ident" id="3499084">r</span><span class="op" id="3499085">.</span><span class="ident" id="3499086">Header</span><span class="op" id="3499092">.</span><span class="ident" id="3499093">Get</span><span class="op" id="3499096">(</span><span class="string" id="3499097">&#34;If-Modified-Since&#34;</span><span class="op" id="3499116">)</span><span class="op" id="3499117">)</span><span class="op" id="3499118">;</span>&nbsp;<span class="ident" id="3499120">err</span>&nbsp;<span class="op" id="3499124">==</span>&nbsp;<span class="builtintype" id="3499127">nil</span>&nbsp;<span class="op" id="3499131">&amp;&amp;</span>&nbsp;<span class="ident" id="3499134">modtime</span><span class="op" id="3499141">.</span><span class="ident" id="3499142">Before</span><span class="op" id="3499148">(</span><span class="ident" id="3499149">t</span><span class="op" id="3499150">.</span><span class="ident" id="3499151">Add</span><span class="op" id="3499154">(</span><span class="num" id="3499155">1</span><span class="op" id="3499156">*</span><span class="ident" id="3499157">time</span><span class="op" id="3499161">.</span><span class="ident" id="3499162">Second</span><span class="op" id="3499168">)</span><span class="op" id="3499169">)</span>&nbsp;<span class="op" id="3499171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3499175">h</span>&nbsp;<span class="op" id="3499177">:=</span>&nbsp;<span class="ident" id="3499180">w</span><span class="op" id="3499181">.</span><span class="ident" id="3499182">Header</span><span class="op" id="3499188">(</span><span class="op" id="3499189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3499193">delete</span><span class="op" id="3499199">(</span><span class="ident" id="3499200">h</span><span class="op" id="3499201">,</span>&nbsp;<span class="string" id="3499203">&#34;Content-Type&#34;</span><span class="op" id="3499217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3499221">delete</span><span class="op" id="3499227">(</span><span class="ident" id="3499228">h</span><span class="op" id="3499229">,</span>&nbsp;<span class="string" id="3499231">&#34;Content-Length&#34;</span><span class="op" id="3499247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3499251">w</span><span class="op" id="3499252">.</span><span class="ident" id="3499253">WriteHeader</span><span class="op" id="3499264">(</span><span class="ident" id="3499265">StatusNotModified</span><span class="op" id="3499282">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3499286">return</span>&nbsp;<span class="builtintype" id="3499293">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3499299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3499302">w</span><span class="op" id="3499303">.</span><span class="ident" id="3499304">Header</span><span class="op" id="3499310">(</span><span class="op" id="3499311">)</span><span class="op" id="3499312">.</span><span class="ident" id="3499313">Set</span><span class="op" id="3499316">(</span><span class="string" id="3499317">&#34;Last-Modified&#34;</span><span class="op" id="3499332">,</span>&nbsp;<span class="ident" id="3499334">modtime</span><span class="op" id="3499341">.</span><span class="ident" id="3499342">UTC</span><span class="op" id="3499345">(</span><span class="op" id="3499346">)</span><span class="op" id="3499347">.</span><span class="ident" id="3499348">Format</span><span class="op" id="3499354">(</span><span class="ident" id="3499355">TimeFormat</span><span class="op" id="3499365">)</span><span class="op" id="3499366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3499369">return</span>&nbsp;<span class="builtintype" id="3499376">false</span><br>
<span class="lineno"></span><span class="op" id="3499382">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3499385">//&nbsp;checkETag&nbsp;implements&nbsp;If-None-Match&nbsp;and&nbsp;If-Range&nbsp;checks.</span><br>
<span class="lineno"></span><span class="comment" id="3499444">//</span><br>
<span class="lineno"></span><span class="comment" id="3499447">//&nbsp;The&nbsp;ETag&nbsp;or&nbsp;modtime&nbsp;must&nbsp;have&nbsp;been&nbsp;previously&nbsp;set&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3499507">//&nbsp;ResponseWriter&#39;s&nbsp;headers.&nbsp;&nbsp;The&nbsp;modtime&nbsp;is&nbsp;only&nbsp;compared&nbsp;at&nbsp;second</span><br>
<span class="lineno">285</span><span class="comment" id="3499576">//&nbsp;granularity&nbsp;and&nbsp;may&nbsp;be&nbsp;the&nbsp;zero&nbsp;value&nbsp;to&nbsp;mean&nbsp;unknown.</span><br>
<span class="lineno"></span><span class="comment" id="3499634">//</span><br>
<span class="lineno"></span><span class="comment" id="3499637">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;effective&nbsp;request&nbsp;&#34;Range&#34;&nbsp;header&nbsp;to&nbsp;use&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3499708">//&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;considered&nbsp;done.</span><br>
<span class="lineno"></span><span class="keyword" id="3499756">func</span>&nbsp;<span class="ident" id="3499761">checkETag</span><span class="op" id="3499770">(</span><span class="ident" id="3499771">w</span>&nbsp;<span class="ident" id="3499773">ResponseWriter</span><span class="op" id="3499787">,</span>&nbsp;<span class="ident" id="3499789">r</span>&nbsp;<span class="op" id="3499791">*</span><span class="ident" id="3499792">Request</span><span class="op" id="3499799">,</span>&nbsp;<span class="ident" id="3499801">modtime</span>&nbsp;<span class="ident" id="3499809">time</span><span class="op" id="3499813">.</span><span class="ident" id="3499814">Time</span><span class="op" id="3499818">)</span>&nbsp;<span class="op" id="3499820">(</span><span class="ident" id="3499821">rangeReq</span>&nbsp;<span class="builtintype" id="3499830">string</span><span class="op" id="3499836">,</span>&nbsp;<span class="ident" id="3499838">done</span>&nbsp;<span class="builtintype" id="3499843">bool</span><span class="op" id="3499847">)</span>&nbsp;<span class="op" id="3499849">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3499852">etag</span>&nbsp;<span class="op" id="3499857">:=</span>&nbsp;<span class="ident" id="3499860">w</span><span class="op" id="3499861">.</span><span class="ident" id="3499862">Header</span><span class="op" id="3499868">(</span><span class="op" id="3499869">)</span><span class="op" id="3499870">.</span><span class="ident" id="3499871">get</span><span class="op" id="3499874">(</span><span class="string" id="3499875">&#34;Etag&#34;</span><span class="op" id="3499881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3499884">rangeReq</span>&nbsp;<span class="op" id="3499893">=</span>&nbsp;<span class="ident" id="3499895">r</span><span class="op" id="3499896">.</span><span class="ident" id="3499897">Header</span><span class="op" id="3499903">.</span><span class="ident" id="3499904">get</span><span class="op" id="3499907">(</span><span class="string" id="3499908">&#34;Range&#34;</span><span class="op" id="3499915">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3499919">//&nbsp;Invalidate&nbsp;the&nbsp;range&nbsp;request&nbsp;if&nbsp;the&nbsp;entity&nbsp;doesn&#39;t&nbsp;match&nbsp;the&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3499988">//&nbsp;the&nbsp;client&nbsp;was&nbsp;expecting.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3500018">//&nbsp;&#34;If-Range:&nbsp;version&#34;&nbsp;means&nbsp;&#34;ignore&nbsp;the&nbsp;Range:&nbsp;header&nbsp;unless&nbsp;version&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3500101">//&nbsp;current&nbsp;file.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3500120">//&nbsp;We&nbsp;only&nbsp;support&nbsp;ETag&nbsp;versions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3500155">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;have&nbsp;set&nbsp;the&nbsp;ETag&nbsp;on&nbsp;the&nbsp;response&nbsp;already.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3500218">if</span>&nbsp;<span class="ident" id="3500221">ir</span>&nbsp;<span class="op" id="3500224">:=</span>&nbsp;<span class="ident" id="3500227">r</span><span class="op" id="3500228">.</span><span class="ident" id="3500229">Header</span><span class="op" id="3500235">.</span><span class="ident" id="3500236">get</span><span class="op" id="3500239">(</span><span class="string" id="3500240">&#34;If-Range&#34;</span><span class="op" id="3500250">)</span><span class="op" id="3500251">;</span>&nbsp;<span class="ident" id="3500253">ir</span>&nbsp;<span class="op" id="3500256">!=</span>&nbsp;<span class="string" id="3500259">&#34;&#34;</span>&nbsp;<span class="op" id="3500262">&amp;&amp;</span>&nbsp;<span class="ident" id="3500265">ir</span>&nbsp;<span class="op" id="3500268">!=</span>&nbsp;<span class="ident" id="3500271">etag</span>&nbsp;<span class="op" id="3500276">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3500280">//&nbsp;The&nbsp;If-Range&nbsp;value&nbsp;is&nbsp;typically&nbsp;the&nbsp;ETag&nbsp;value,&nbsp;but&nbsp;it&nbsp;may&nbsp;also&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3500352">//&nbsp;the&nbsp;modtime&nbsp;date.&nbsp;See&nbsp;golang.org/issue/8367.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3500402">timeMatches</span>&nbsp;<span class="op" id="3500414">:=</span>&nbsp;<span class="builtintype" id="3500417">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3500425">if</span>&nbsp;<span class="op" id="3500428">!</span><span class="ident" id="3500429">modtime</span><span class="op" id="3500436">.</span><span class="ident" id="3500437">IsZero</span><span class="op" id="3500443">(</span><span class="op" id="3500444">)</span>&nbsp;<span class="op" id="3500446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3500451">if</span>&nbsp;<span class="ident" id="3500454">t</span><span class="op" id="3500455">,</span>&nbsp;<span class="ident" id="3500457">err</span>&nbsp;<span class="op" id="3500461">:=</span>&nbsp;<span class="ident" id="3500464">ParseTime</span><span class="op" id="3500473">(</span><span class="ident" id="3500474">ir</span><span class="op" id="3500476">)</span><span class="op" id="3500477">;</span>&nbsp;<span class="ident" id="3500479">err</span>&nbsp;<span class="op" id="3500483">==</span>&nbsp;<span class="builtintype" id="3500486">nil</span>&nbsp;<span class="op" id="3500490">&amp;&amp;</span>&nbsp;<span class="ident" id="3500493">t</span><span class="op" id="3500494">.</span><span class="ident" id="3500495">Unix</span><span class="op" id="3500499">(</span><span class="op" id="3500500">)</span>&nbsp;<span class="op" id="3500502">==</span>&nbsp;<span class="ident" id="3500505">modtime</span><span class="op" id="3500512">.</span><span class="ident" id="3500513">Unix</span><span class="op" id="3500517">(</span><span class="op" id="3500518">)</span>&nbsp;<span class="op" id="3500520">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3500526">timeMatches</span>&nbsp;<span class="op" id="3500538">=</span>&nbsp;<span class="builtintype" id="3500540">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3500548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3500552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3500556">if</span>&nbsp;<span class="op" id="3500559">!</span><span class="ident" id="3500560">timeMatches</span>&nbsp;<span class="op" id="3500572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3500577">rangeReq</span>&nbsp;<span class="op" id="3500586">=</span>&nbsp;<span class="string" id="3500588">&#34;&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3500593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3500596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3500600">if</span>&nbsp;<span class="ident" id="3500603">inm</span>&nbsp;<span class="op" id="3500607">:=</span>&nbsp;<span class="ident" id="3500610">r</span><span class="op" id="3500611">.</span><span class="ident" id="3500612">Header</span><span class="op" id="3500618">.</span><span class="ident" id="3500619">get</span><span class="op" id="3500622">(</span><span class="string" id="3500623">&#34;If-None-Match&#34;</span><span class="op" id="3500638">)</span><span class="op" id="3500639">;</span>&nbsp;<span class="ident" id="3500641">inm</span>&nbsp;<span class="op" id="3500645">!=</span>&nbsp;<span class="string" id="3500648">&#34;&#34;</span>&nbsp;<span class="op" id="3500651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3500655">//&nbsp;Must&nbsp;know&nbsp;ETag.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3500676">if</span>&nbsp;<span class="ident" id="3500679">etag</span>&nbsp;<span class="op" id="3500684">==</span>&nbsp;<span class="string" id="3500687">&#34;&#34;</span>&nbsp;<span class="op" id="3500690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3500695">return</span>&nbsp;<span class="ident" id="3500702">rangeReq</span><span class="op" id="3500710">,</span>&nbsp;<span class="builtintype" id="3500712">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3500720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3500725">//&nbsp;TODO(bradfitz):&nbsp;non-GET/HEAD&nbsp;requests&nbsp;require&nbsp;more&nbsp;work:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3500787">//&nbsp;sending&nbsp;a&nbsp;different&nbsp;status&nbsp;code&nbsp;on&nbsp;matches,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3500840">//&nbsp;also&nbsp;can&#39;t&nbsp;use&nbsp;weak&nbsp;cache&nbsp;validators&nbsp;(those&nbsp;with&nbsp;a&nbsp;&#34;W/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3500900">//&nbsp;prefix).&nbsp;&nbsp;But&nbsp;most&nbsp;users&nbsp;of&nbsp;ServeContent&nbsp;will&nbsp;be&nbsp;using</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3500960">//&nbsp;it&nbsp;on&nbsp;GET&nbsp;or&nbsp;HEAD,&nbsp;so&nbsp;only&nbsp;support&nbsp;those&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3501015">if</span>&nbsp;<span class="ident" id="3501018">r</span><span class="op" id="3501019">.</span><span class="ident" id="3501020">Method</span>&nbsp;<span class="op" id="3501027">!=</span>&nbsp;<span class="string" id="3501030">&#34;GET&#34;</span>&nbsp;<span class="op" id="3501036">&amp;&amp;</span>&nbsp;<span class="ident" id="3501039">r</span><span class="op" id="3501040">.</span><span class="ident" id="3501041">Method</span>&nbsp;<span class="op" id="3501048">!=</span>&nbsp;<span class="string" id="3501051">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3501058">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3501063">return</span>&nbsp;<span class="ident" id="3501070">rangeReq</span><span class="op" id="3501078">,</span>&nbsp;<span class="builtintype" id="3501080">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3501088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3501093">//&nbsp;TODO(bradfitz):&nbsp;deal&nbsp;with&nbsp;comma-separated&nbsp;or&nbsp;multiple-valued</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3501159">//&nbsp;list&nbsp;of&nbsp;If-None-match&nbsp;values.&nbsp;&nbsp;For&nbsp;now&nbsp;just&nbsp;handle&nbsp;the&nbsp;common</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3501226">//&nbsp;case&nbsp;of&nbsp;a&nbsp;single&nbsp;item.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3501254">if</span>&nbsp;<span class="ident" id="3501257">inm</span>&nbsp;<span class="op" id="3501261">==</span>&nbsp;<span class="ident" id="3501264">etag</span>&nbsp;<span class="op" id="3501269">||</span>&nbsp;<span class="ident" id="3501272">inm</span>&nbsp;<span class="op" id="3501276">==</span>&nbsp;<span class="string" id="3501279">&#34;*&#34;</span>&nbsp;<span class="op" id="3501283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501288">h</span>&nbsp;<span class="op" id="3501290">:=</span>&nbsp;<span class="ident" id="3501293">w</span><span class="op" id="3501294">.</span><span class="ident" id="3501295">Header</span><span class="op" id="3501301">(</span><span class="op" id="3501302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3501307">delete</span><span class="op" id="3501313">(</span><span class="ident" id="3501314">h</span><span class="op" id="3501315">,</span>&nbsp;<span class="string" id="3501317">&#34;Content-Type&#34;</span><span class="op" id="3501331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3501336">delete</span><span class="op" id="3501342">(</span><span class="ident" id="3501343">h</span><span class="op" id="3501344">,</span>&nbsp;<span class="string" id="3501346">&#34;Content-Length&#34;</span><span class="op" id="3501362">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501367">w</span><span class="op" id="3501368">.</span><span class="ident" id="3501369">WriteHeader</span><span class="op" id="3501380">(</span><span class="ident" id="3501381">StatusNotModified</span><span class="op" id="3501398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3501403">return</span>&nbsp;<span class="string" id="3501410">&#34;&#34;</span><span class="op" id="3501412">,</span>&nbsp;<span class="builtintype" id="3501414">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3501421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3501424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3501427">return</span>&nbsp;<span class="ident" id="3501434">rangeReq</span><span class="op" id="3501442">,</span>&nbsp;<span class="builtintype" id="3501444">false</span><br>
<span class="lineno">340</span><span class="op" id="3501450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3501453">//&nbsp;name&nbsp;is&nbsp;&#39;/&#39;-separated,&nbsp;not&nbsp;filepath.Separator.</span><br>
<span class="lineno"></span><span class="keyword" id="3501503">func</span>&nbsp;<span class="ident" id="3501508">serveFile</span><span class="op" id="3501517">(</span><span class="ident" id="3501518">w</span>&nbsp;<span class="ident" id="3501520">ResponseWriter</span><span class="op" id="3501534">,</span>&nbsp;<span class="ident" id="3501536">r</span>&nbsp;<span class="op" id="3501538">*</span><span class="ident" id="3501539">Request</span><span class="op" id="3501546">,</span>&nbsp;<span class="ident" id="3501548">fs</span>&nbsp;<span class="ident" id="3501551">FileSystem</span><span class="op" id="3501561">,</span>&nbsp;<span class="ident" id="3501563">name</span>&nbsp;<span class="builtintype" id="3501568">string</span><span class="op" id="3501574">,</span>&nbsp;<span class="ident" id="3501576">redirect</span>&nbsp;<span class="builtintype" id="3501585">bool</span><span class="op" id="3501589">)</span>&nbsp;<span class="op" id="3501591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3501594">const</span>&nbsp;<span class="ident" id="3501600">indexPage</span>&nbsp;<span class="op" id="3501610">=</span>&nbsp;<span class="string" id="3501612">&#34;/index.html&#34;</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3501628">//&nbsp;redirect&nbsp;.../index.html&nbsp;to&nbsp;.../</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3501664">//&nbsp;can&#39;t&nbsp;use&nbsp;Redirect()&nbsp;because&nbsp;that&nbsp;would&nbsp;make&nbsp;the&nbsp;path&nbsp;absolute,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3501732">//&nbsp;which&nbsp;would&nbsp;be&nbsp;a&nbsp;problem&nbsp;running&nbsp;under&nbsp;StripPrefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3501787">if</span>&nbsp;<span class="ident" id="3501790">strings</span><span class="op" id="3501797">.</span><span class="ident" id="3501798">HasSuffix</span><span class="op" id="3501807">(</span><span class="ident" id="3501808">r</span><span class="op" id="3501809">.</span><span class="ident" id="3501810">URL</span><span class="op" id="3501813">.</span><span class="ident" id="3501814">Path</span><span class="op" id="3501818">,</span>&nbsp;<span class="ident" id="3501820">indexPage</span><span class="op" id="3501829">)</span>&nbsp;<span class="op" id="3501831">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501835">localRedirect</span><span class="op" id="3501848">(</span><span class="ident" id="3501849">w</span><span class="op" id="3501850">,</span>&nbsp;<span class="ident" id="3501852">r</span><span class="op" id="3501853">,</span>&nbsp;<span class="string" id="3501855">&#34;./&#34;</span><span class="op" id="3501859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3501863">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3501871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501875">f</span><span class="op" id="3501876">,</span>&nbsp;<span class="ident" id="3501878">err</span>&nbsp;<span class="op" id="3501882">:=</span>&nbsp;<span class="ident" id="3501885">fs</span><span class="op" id="3501887">.</span><span class="ident" id="3501888">Open</span><span class="op" id="3501892">(</span><span class="ident" id="3501893">name</span><span class="op" id="3501897">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3501900">if</span>&nbsp;<span class="ident" id="3501903">err</span>&nbsp;<span class="op" id="3501907">!=</span>&nbsp;<span class="builtintype" id="3501910">nil</span>&nbsp;<span class="op" id="3501914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3501918">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501949">NotFound</span><span class="op" id="3501957">(</span><span class="ident" id="3501958">w</span><span class="op" id="3501959">,</span>&nbsp;<span class="ident" id="3501961">r</span><span class="op" id="3501962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3501966">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3501974">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3501977">defer</span>&nbsp;<span class="ident" id="3501983">f</span><span class="op" id="3501984">.</span><span class="ident" id="3501985">Close</span><span class="op" id="3501990">(</span><span class="op" id="3501991">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501995">d</span><span class="op" id="3501996">,</span>&nbsp;<span class="ident" id="3501998">err1</span>&nbsp;<span class="op" id="3502003">:=</span>&nbsp;<span class="ident" id="3502006">f</span><span class="op" id="3502007">.</span><span class="ident" id="3502008">Stat</span><span class="op" id="3502012">(</span><span class="op" id="3502013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502016">if</span>&nbsp;<span class="ident" id="3502019">err1</span>&nbsp;<span class="op" id="3502024">!=</span>&nbsp;<span class="builtintype" id="3502027">nil</span>&nbsp;<span class="op" id="3502031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3502035">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502066">NotFound</span><span class="op" id="3502074">(</span><span class="ident" id="3502075">w</span><span class="op" id="3502076">,</span>&nbsp;<span class="ident" id="3502078">r</span><span class="op" id="3502079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502083">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3502091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502095">if</span>&nbsp;<span class="ident" id="3502098">redirect</span>&nbsp;<span class="op" id="3502107">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3502111">//&nbsp;redirect&nbsp;to&nbsp;canonical&nbsp;path:&nbsp;/&nbsp;at&nbsp;end&nbsp;of&nbsp;directory&nbsp;url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3502170">//&nbsp;r.URL.Path&nbsp;always&nbsp;begins&nbsp;with&nbsp;/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502207">url</span>&nbsp;<span class="op" id="3502211">:=</span>&nbsp;<span class="ident" id="3502214">r</span><span class="op" id="3502215">.</span><span class="ident" id="3502216">URL</span><span class="op" id="3502219">.</span><span class="ident" id="3502220">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502227">if</span>&nbsp;<span class="ident" id="3502230">d</span><span class="op" id="3502231">.</span><span class="ident" id="3502232">IsDir</span><span class="op" id="3502237">(</span><span class="op" id="3502238">)</span>&nbsp;<span class="op" id="3502240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502245">if</span>&nbsp;<span class="ident" id="3502248">url</span><span class="op" id="3502251">[</span><span class="builtinfunc" id="3502252">len</span><span class="op" id="3502255">(</span><span class="ident" id="3502256">url</span><span class="op" id="3502259">)</span><span class="op" id="3502260">-</span><span class="num" id="3502261">1</span><span class="op" id="3502262">]</span>&nbsp;<span class="op" id="3502264">!=</span>&nbsp;<span class="string" id="3502267">&#39;/&#39;</span>&nbsp;<span class="op" id="3502271">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502277">localRedirect</span><span class="op" id="3502290">(</span><span class="ident" id="3502291">w</span><span class="op" id="3502292">,</span>&nbsp;<span class="ident" id="3502294">r</span><span class="op" id="3502295">,</span>&nbsp;<span class="ident" id="3502297">path</span><span class="op" id="3502301">.</span><span class="ident" id="3502302">Base</span><span class="op" id="3502306">(</span><span class="ident" id="3502307">url</span><span class="op" id="3502310">)</span><span class="op" id="3502311">+</span><span class="string" id="3502312">&#34;/&#34;</span><span class="op" id="3502315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502321">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3502331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3502335">}</span>&nbsp;<span class="keyword" id="3502337">else</span>&nbsp;<span class="op" id="3502342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502347">if</span>&nbsp;<span class="ident" id="3502350">url</span><span class="op" id="3502353">[</span><span class="builtinfunc" id="3502354">len</span><span class="op" id="3502357">(</span><span class="ident" id="3502358">url</span><span class="op" id="3502361">)</span><span class="op" id="3502362">-</span><span class="num" id="3502363">1</span><span class="op" id="3502364">]</span>&nbsp;<span class="op" id="3502366">==</span>&nbsp;<span class="string" id="3502369">&#39;/&#39;</span>&nbsp;<span class="op" id="3502373">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502379">localRedirect</span><span class="op" id="3502392">(</span><span class="ident" id="3502393">w</span><span class="op" id="3502394">,</span>&nbsp;<span class="ident" id="3502396">r</span><span class="op" id="3502397">,</span>&nbsp;<span class="string" id="3502399">&#34;../&#34;</span><span class="op" id="3502404">+</span><span class="ident" id="3502405">path</span><span class="op" id="3502409">.</span><span class="ident" id="3502410">Base</span><span class="op" id="3502414">(</span><span class="ident" id="3502415">url</span><span class="op" id="3502418">)</span><span class="op" id="3502419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502425">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3502435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3502439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3502442">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3502446">//&nbsp;use&nbsp;contents&nbsp;of&nbsp;index.html&nbsp;for&nbsp;directory,&nbsp;if&nbsp;present</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502503">if</span>&nbsp;<span class="ident" id="3502506">d</span><span class="op" id="3502507">.</span><span class="ident" id="3502508">IsDir</span><span class="op" id="3502513">(</span><span class="op" id="3502514">)</span>&nbsp;<span class="op" id="3502516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502520">index</span>&nbsp;<span class="op" id="3502526">:=</span>&nbsp;<span class="ident" id="3502529">strings</span><span class="op" id="3502536">.</span><span class="ident" id="3502537">TrimSuffix</span><span class="op" id="3502547">(</span><span class="ident" id="3502548">name</span><span class="op" id="3502552">,</span>&nbsp;<span class="string" id="3502554">&#34;/&#34;</span><span class="op" id="3502557">)</span>&nbsp;<span class="op" id="3502559">+</span>&nbsp;<span class="ident" id="3502561">indexPage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502573">ff</span><span class="op" id="3502575">,</span>&nbsp;<span class="ident" id="3502577">err</span>&nbsp;<span class="op" id="3502581">:=</span>&nbsp;<span class="ident" id="3502584">fs</span><span class="op" id="3502586">.</span><span class="ident" id="3502587">Open</span><span class="op" id="3502591">(</span><span class="ident" id="3502592">index</span><span class="op" id="3502597">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502601">if</span>&nbsp;<span class="ident" id="3502604">err</span>&nbsp;<span class="op" id="3502608">==</span>&nbsp;<span class="builtintype" id="3502611">nil</span>&nbsp;<span class="op" id="3502615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502620">defer</span>&nbsp;<span class="ident" id="3502626">ff</span><span class="op" id="3502628">.</span><span class="ident" id="3502629">Close</span><span class="op" id="3502634">(</span><span class="op" id="3502635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502640">dd</span><span class="op" id="3502642">,</span>&nbsp;<span class="ident" id="3502644">err</span>&nbsp;<span class="op" id="3502648">:=</span>&nbsp;<span class="ident" id="3502651">ff</span><span class="op" id="3502653">.</span><span class="ident" id="3502654">Stat</span><span class="op" id="3502658">(</span><span class="op" id="3502659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502664">if</span>&nbsp;<span class="ident" id="3502667">err</span>&nbsp;<span class="op" id="3502671">==</span>&nbsp;<span class="builtintype" id="3502674">nil</span>&nbsp;<span class="op" id="3502678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502684">name</span>&nbsp;<span class="op" id="3502689">=</span>&nbsp;<span class="ident" id="3502691">index</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502701">d</span>&nbsp;<span class="op" id="3502703">=</span>&nbsp;<span class="ident" id="3502705">dd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502712">f</span>&nbsp;<span class="op" id="3502714">=</span>&nbsp;<span class="ident" id="3502716">ff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3502722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3502726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3502729">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3502733">//&nbsp;Still&nbsp;a&nbsp;directory?&nbsp;(we&nbsp;didn&#39;t&nbsp;find&nbsp;an&nbsp;index.html&nbsp;file)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502792">if</span>&nbsp;<span class="ident" id="3502795">d</span><span class="op" id="3502796">.</span><span class="ident" id="3502797">IsDir</span><span class="op" id="3502802">(</span><span class="op" id="3502803">)</span>&nbsp;<span class="op" id="3502805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502809">if</span>&nbsp;<span class="ident" id="3502812">checkLastModified</span><span class="op" id="3502829">(</span><span class="ident" id="3502830">w</span><span class="op" id="3502831">,</span>&nbsp;<span class="ident" id="3502833">r</span><span class="op" id="3502834">,</span>&nbsp;<span class="ident" id="3502836">d</span><span class="op" id="3502837">.</span><span class="ident" id="3502838">ModTime</span><span class="op" id="3502845">(</span><span class="op" id="3502846">)</span><span class="op" id="3502847">)</span>&nbsp;<span class="op" id="3502849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502854">return</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3502863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502867">dirList</span><span class="op" id="3502874">(</span><span class="ident" id="3502875">w</span><span class="op" id="3502876">,</span>&nbsp;<span class="ident" id="3502878">f</span><span class="op" id="3502879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502883">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3502891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3502895">//&nbsp;serveContent&nbsp;will&nbsp;check&nbsp;modification&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502941">sizeFunc</span>&nbsp;<span class="op" id="3502950">:=</span>&nbsp;<span class="keyword" id="3502953">func</span><span class="op" id="3502957">(</span><span class="op" id="3502958">)</span>&nbsp;<span class="op" id="3502960">(</span><span class="builtintype" id="3502961">int64</span><span class="op" id="3502966">,</span>&nbsp;<span class="builtintype" id="3502968">error</span><span class="op" id="3502973">)</span>&nbsp;<span class="op" id="3502975">{</span>&nbsp;<span class="keyword" id="3502977">return</span>&nbsp;<span class="ident" id="3502984">d</span><span class="op" id="3502985">.</span><span class="ident" id="3502986">Size</span><span class="op" id="3502990">(</span><span class="op" id="3502991">)</span><span class="op" id="3502992">,</span>&nbsp;<span class="builtintype" id="3502994">nil</span>&nbsp;<span class="op" id="3502998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503001">serveContent</span><span class="op" id="3503013">(</span><span class="ident" id="3503014">w</span><span class="op" id="3503015">,</span>&nbsp;<span class="ident" id="3503017">r</span><span class="op" id="3503018">,</span>&nbsp;<span class="ident" id="3503020">d</span><span class="op" id="3503021">.</span><span class="ident" id="3503022">Name</span><span class="op" id="3503026">(</span><span class="op" id="3503027">)</span><span class="op" id="3503028">,</span>&nbsp;<span class="ident" id="3503030">d</span><span class="op" id="3503031">.</span><span class="ident" id="3503032">ModTime</span><span class="op" id="3503039">(</span><span class="op" id="3503040">)</span><span class="op" id="3503041">,</span>&nbsp;<span class="ident" id="3503043">sizeFunc</span><span class="op" id="3503051">,</span>&nbsp;<span class="ident" id="3503053">f</span><span class="op" id="3503054">)</span><br>
<span class="lineno"></span><span class="op" id="3503056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3503059">//&nbsp;localRedirect&nbsp;gives&nbsp;a&nbsp;Moved&nbsp;Permanently&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3503112">//&nbsp;It&nbsp;does&nbsp;not&nbsp;convert&nbsp;relative&nbsp;paths&nbsp;to&nbsp;absolute&nbsp;paths&nbsp;like&nbsp;Redirect&nbsp;does.</span><br>
<span class="lineno"></span><span class="keyword" id="3503188">func</span>&nbsp;<span class="ident" id="3503193">localRedirect</span><span class="op" id="3503206">(</span><span class="ident" id="3503207">w</span>&nbsp;<span class="ident" id="3503209">ResponseWriter</span><span class="op" id="3503223">,</span>&nbsp;<span class="ident" id="3503225">r</span>&nbsp;<span class="op" id="3503227">*</span><span class="ident" id="3503228">Request</span><span class="op" id="3503235">,</span>&nbsp;<span class="ident" id="3503237">newPath</span>&nbsp;<span class="builtintype" id="3503245">string</span><span class="op" id="3503251">)</span>&nbsp;<span class="op" id="3503253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3503256">if</span>&nbsp;<span class="ident" id="3503259">q</span>&nbsp;<span class="op" id="3503261">:=</span>&nbsp;<span class="ident" id="3503264">r</span><span class="op" id="3503265">.</span><span class="ident" id="3503266">URL</span><span class="op" id="3503269">.</span><span class="ident" id="3503270">RawQuery</span><span class="op" id="3503278">;</span>&nbsp;<span class="ident" id="3503280">q</span>&nbsp;<span class="op" id="3503282">!=</span>&nbsp;<span class="string" id="3503285">&#34;&#34;</span>&nbsp;<span class="op" id="3503288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503292">newPath</span>&nbsp;<span class="op" id="3503300">+=</span>&nbsp;<span class="string" id="3503303">&#34;?&#34;</span>&nbsp;<span class="op" id="3503307">+</span>&nbsp;<span class="ident" id="3503309">q</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3503312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503315">w</span><span class="op" id="3503316">.</span><span class="ident" id="3503317">Header</span><span class="op" id="3503323">(</span><span class="op" id="3503324">)</span><span class="op" id="3503325">.</span><span class="ident" id="3503326">Set</span><span class="op" id="3503329">(</span><span class="string" id="3503330">&#34;Location&#34;</span><span class="op" id="3503340">,</span>&nbsp;<span class="ident" id="3503342">newPath</span><span class="op" id="3503349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503352">w</span><span class="op" id="3503353">.</span><span class="ident" id="3503354">WriteHeader</span><span class="op" id="3503365">(</span><span class="ident" id="3503366">StatusMovedPermanently</span><span class="op" id="3503388">)</span><br>
<span class="lineno"></span><span class="op" id="3503390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span><span class="comment" id="3503393">//&nbsp;ServeFile&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;named&nbsp;file&nbsp;or&nbsp;directory.</span><br>
<span class="lineno"></span><span class="keyword" id="3503479">func</span>&nbsp;<span class="ident" id="3503484">ServeFile</span><span class="op" id="3503493">(</span><span class="ident" id="3503494">w</span>&nbsp;<span class="ident" id="3503496">ResponseWriter</span><span class="op" id="3503510">,</span>&nbsp;<span class="ident" id="3503512">r</span>&nbsp;<span class="op" id="3503514">*</span><span class="ident" id="3503515">Request</span><span class="op" id="3503522">,</span>&nbsp;<span class="ident" id="3503524">name</span>&nbsp;<span class="builtintype" id="3503529">string</span><span class="op" id="3503535">)</span>&nbsp;<span class="op" id="3503537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503540">dir</span><span class="op" id="3503543">,</span>&nbsp;<span class="ident" id="3503545">file</span>&nbsp;<span class="op" id="3503550">:=</span>&nbsp;<span class="ident" id="3503553">filepath</span><span class="op" id="3503561">.</span><span class="ident" id="3503562">Split</span><span class="op" id="3503567">(</span><span class="ident" id="3503568">name</span><span class="op" id="3503572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503575">serveFile</span><span class="op" id="3503584">(</span><span class="ident" id="3503585">w</span><span class="op" id="3503586">,</span>&nbsp;<span class="ident" id="3503588">r</span><span class="op" id="3503589">,</span>&nbsp;<span class="ident" id="3503591">Dir</span><span class="op" id="3503594">(</span><span class="ident" id="3503595">dir</span><span class="op" id="3503598">)</span><span class="op" id="3503599">,</span>&nbsp;<span class="ident" id="3503601">file</span><span class="op" id="3503605">,</span>&nbsp;<span class="builtintype" id="3503607">false</span><span class="op" id="3503612">)</span><br>
<span class="lineno"></span><span class="op" id="3503614">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="3503617">type</span>&nbsp;<span class="ident" id="3503622">fileHandler</span>&nbsp;<span class="keyword" id="3503634">struct</span>&nbsp;<span class="op" id="3503641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503644">root</span>&nbsp;<span class="ident" id="3503649">FileSystem</span><br>
<span class="lineno"></span><span class="op" id="3503660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="comment" id="3503663">//&nbsp;FileServer&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3503721">//&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;file&nbsp;system&nbsp;rooted&nbsp;at&nbsp;root.</span><br>
<span class="lineno"></span><span class="comment" id="3503777">//</span><br>
<span class="lineno"></span><span class="comment" id="3503780">//&nbsp;To&nbsp;use&nbsp;the&nbsp;operating&nbsp;system&#39;s&nbsp;file&nbsp;system&nbsp;implementation,</span><br>
<span class="lineno"></span><span class="comment" id="3503841">//&nbsp;use&nbsp;http.Dir:</span><br>
<span class="lineno">440</span><span class="comment" id="3503858">//</span><br>
<span class="lineno"></span><span class="comment" id="3503861">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.Handle(&#34;/&#34;,&nbsp;http.FileServer(http.Dir(&#34;/tmp&#34;)))</span><br>
<span class="lineno"></span><span class="keyword" id="3503920">func</span>&nbsp;<span class="ident" id="3503925">FileServer</span><span class="op" id="3503935">(</span><span class="ident" id="3503936">root</span>&nbsp;<span class="ident" id="3503941">FileSystem</span><span class="op" id="3503951">)</span>&nbsp;<span class="ident" id="3503953">Handler</span>&nbsp;<span class="op" id="3503961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3503964">return</span>&nbsp;<span class="op" id="3503971">&amp;</span><span class="ident" id="3503972">fileHandler</span><span class="op" id="3503983">{</span><span class="ident" id="3503984">root</span><span class="op" id="3503988">}</span><br>
<span class="lineno"></span><span class="op" id="3503990">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span><span class="keyword" id="3503993">func</span>&nbsp;<span class="op" id="3503998">(</span><span class="ident" id="3503999">f</span>&nbsp;<span class="op" id="3504001">*</span><span class="ident" id="3504002">fileHandler</span><span class="op" id="3504013">)</span>&nbsp;<span class="ident" id="3504015">ServeHTTP</span><span class="op" id="3504024">(</span><span class="ident" id="3504025">w</span>&nbsp;<span class="ident" id="3504027">ResponseWriter</span><span class="op" id="3504041">,</span>&nbsp;<span class="ident" id="3504043">r</span>&nbsp;<span class="op" id="3504045">*</span><span class="ident" id="3504046">Request</span><span class="op" id="3504053">)</span>&nbsp;<span class="op" id="3504055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3504058">upath</span>&nbsp;<span class="op" id="3504064">:=</span>&nbsp;<span class="ident" id="3504067">r</span><span class="op" id="3504068">.</span><span class="ident" id="3504069">URL</span><span class="op" id="3504072">.</span><span class="ident" id="3504073">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3504079">if</span>&nbsp;<span class="op" id="3504082">!</span><span class="ident" id="3504083">strings</span><span class="op" id="3504090">.</span><span class="ident" id="3504091">HasPrefix</span><span class="op" id="3504100">(</span><span class="ident" id="3504101">upath</span><span class="op" id="3504106">,</span>&nbsp;<span class="string" id="3504108">&#34;/&#34;</span><span class="op" id="3504111">)</span>&nbsp;<span class="op" id="3504113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3504117">upath</span>&nbsp;<span class="op" id="3504123">=</span>&nbsp;<span class="string" id="3504125">&#34;/&#34;</span>&nbsp;<span class="op" id="3504129">+</span>&nbsp;<span class="ident" id="3504131">upath</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3504139">r</span><span class="op" id="3504140">.</span><span class="ident" id="3504141">URL</span><span class="op" id="3504144">.</span><span class="ident" id="3504145">Path</span>&nbsp;<span class="op" id="3504150">=</span>&nbsp;<span class="ident" id="3504152">upath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3504159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3504162">serveFile</span><span class="op" id="3504171">(</span><span class="ident" id="3504172">w</span><span class="op" id="3504173">,</span>&nbsp;<span class="ident" id="3504175">r</span><span class="op" id="3504176">,</span>&nbsp;<span class="ident" id="3504178">f</span><span class="op" id="3504179">.</span><span class="ident" id="3504180">root</span><span class="op" id="3504184">,</span>&nbsp;<span class="ident" id="3504186">path</span><span class="op" id="3504190">.</span><span class="ident" id="3504191">Clean</span><span class="op" id="3504196">(</span><span class="ident" id="3504197">upath</span><span class="op" id="3504202">)</span><span class="op" id="3504203">,</span>&nbsp;<span class="builtintype" id="3504205">true</span><span class="op" id="3504209">)</span><br>
<span class="lineno"></span><span class="op" id="3504211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="3504214">//&nbsp;httpRange&nbsp;specifies&nbsp;the&nbsp;byte&nbsp;range&nbsp;to&nbsp;be&nbsp;sent&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3504278">type</span>&nbsp;<span class="ident" id="3504283">httpRange</span>&nbsp;<span class="keyword" id="3504293">struct</span>&nbsp;<span class="op" id="3504300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3504303">start</span><span class="op" id="3504308">,</span>&nbsp;<span class="ident" id="3504310">length</span>&nbsp;<span class="builtintype" id="3504317">int64</span><br>
<span class="lineno"></span><span class="op" id="3504323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="keyword" id="3504326">func</span>&nbsp;<span class="op" id="3504331">(</span><span class="ident" id="3504332">r</span>&nbsp;<span class="ident" id="3504334">httpRange</span><span class="op" id="3504343">)</span>&nbsp;<span class="ident" id="3504345">contentRange</span><span class="op" id="3504357">(</span><span class="ident" id="3504358">size</span>&nbsp;<span class="builtintype" id="3504363">int64</span><span class="op" id="3504368">)</span>&nbsp;<span class="builtintype" id="3504370">string</span>&nbsp;<span class="op" id="3504377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3504380">return</span>&nbsp;<span class="ident" id="3504387">fmt</span><span class="op" id="3504390">.</span><span class="ident" id="3504391">Sprintf</span><span class="op" id="3504398">(</span><span class="string" id="3504399">&#34;bytes&nbsp;%d-%d/%d&#34;</span><span class="op" id="3504415">,</span>&nbsp;<span class="ident" id="3504417">r</span><span class="op" id="3504418">.</span><span class="ident" id="3504419">start</span><span class="op" id="3504424">,</span>&nbsp;<span class="ident" id="3504426">r</span><span class="op" id="3504427">.</span><span class="ident" id="3504428">start</span><span class="op" id="3504433">+</span><span class="ident" id="3504434">r</span><span class="op" id="3504435">.</span><span class="ident" id="3504436">length</span><span class="op" id="3504442">-</span><span class="num" id="3504443">1</span><span class="op" id="3504444">,</span>&nbsp;<span class="ident" id="3504446">size</span><span class="op" id="3504450">)</span><br>
<span class="lineno"></span><span class="op" id="3504452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3504455">func</span>&nbsp;<span class="op" id="3504460">(</span><span class="ident" id="3504461">r</span>&nbsp;<span class="ident" id="3504463">httpRange</span><span class="op" id="3504472">)</span>&nbsp;<span class="ident" id="3504474">mimeHeader</span><span class="op" id="3504484">(</span><span class="ident" id="3504485">contentType</span>&nbsp;<span class="builtintype" id="3504497">string</span><span class="op" id="3504503">,</span>&nbsp;<span class="ident" id="3504505">size</span>&nbsp;<span class="builtintype" id="3504510">int64</span><span class="op" id="3504515">)</span>&nbsp;<span class="ident" id="3504517">textproto</span><span class="op" id="3504526">.</span><span class="ident" id="3504527">MIMEHeader</span>&nbsp;<span class="op" id="3504538">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3504541">return</span>&nbsp;<span class="ident" id="3504548">textproto</span><span class="op" id="3504557">.</span><span class="ident" id="3504558">MIMEHeader</span><span class="op" id="3504568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504572">&#34;Content-Range&#34;</span><span class="op" id="3504587">:</span>&nbsp;<span class="op" id="3504589">{</span><span class="ident" id="3504590">r</span><span class="op" id="3504591">.</span><span class="ident" id="3504592">contentRange</span><span class="op" id="3504604">(</span><span class="ident" id="3504605">size</span><span class="op" id="3504609">)</span><span class="op" id="3504610">}</span><span class="op" id="3504611">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504615">&#34;Content-Type&#34;</span><span class="op" id="3504629">:</span>&nbsp;&nbsp;<span class="op" id="3504632">{</span><span class="ident" id="3504633">contentType</span><span class="op" id="3504644">}</span><span class="op" id="3504645">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3504648">}</span><br>
<span class="lineno"></span><span class="op" id="3504650">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="3504653">//&nbsp;parseRange&nbsp;parses&nbsp;a&nbsp;Range&nbsp;header&nbsp;string&nbsp;as&nbsp;per&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="keyword" id="3504713">func</span>&nbsp;<span class="ident" id="3504718">parseRange</span><span class="op" id="3504728">(</span><span class="ident" id="3504729">s</span>&nbsp;<span class="builtintype" id="3504731">string</span><span class="op" id="3504737">,</span>&nbsp;<span class="ident" id="3504739">size</span>&nbsp;<span class="builtintype" id="3504744">int64</span><span class="op" id="3504749">)</span>&nbsp;<span class="op" id="3504751">(</span><span class="op" id="3504752">[</span><span class="op" id="3504753">]</span><span class="ident" id="3504754">httpRange</span><span class="op" id="3504763">,</span>&nbsp;<span class="builtintype" id="3504765">error</span><span class="op" id="3504770">)</span>&nbsp;<span class="op" id="3504772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3504775">if</span>&nbsp;<span class="ident" id="3504778">s</span>&nbsp;<span class="op" id="3504780">==</span>&nbsp;<span class="string" id="3504783">&#34;&#34;</span>&nbsp;<span class="op" id="3504786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3504790">return</span>&nbsp;<span class="builtintype" id="3504797">nil</span><span class="op" id="3504800">,</span>&nbsp;<span class="builtintype" id="3504802">nil</span>&nbsp;<span class="comment" id="3504806">//&nbsp;header&nbsp;not&nbsp;present</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3504829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3504832">const</span>&nbsp;<span class="ident" id="3504838">b</span>&nbsp;<span class="op" id="3504840">=</span>&nbsp;<span class="string" id="3504842">&#34;bytes=&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3504852">if</span>&nbsp;<span class="op" id="3504855">!</span><span class="ident" id="3504856">strings</span><span class="op" id="3504863">.</span><span class="ident" id="3504864">HasPrefix</span><span class="op" id="3504873">(</span><span class="ident" id="3504874">s</span><span class="op" id="3504875">,</span>&nbsp;<span class="ident" id="3504877">b</span><span class="op" id="3504878">)</span>&nbsp;<span class="op" id="3504880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3504884">return</span>&nbsp;<span class="builtintype" id="3504891">nil</span><span class="op" id="3504894">,</span>&nbsp;<span class="ident" id="3504896">errors</span><span class="op" id="3504902">.</span><span class="ident" id="3504903">New</span><span class="op" id="3504906">(</span><span class="string" id="3504907">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3504922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3504925">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3504928">var</span>&nbsp;<span class="ident" id="3504932">ranges</span>&nbsp;<span class="op" id="3504939">[</span><span class="op" id="3504940">]</span><span class="ident" id="3504941">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3504952">for</span>&nbsp;<span class="ident" id="3504956">_</span><span class="op" id="3504957">,</span>&nbsp;<span class="ident" id="3504959">ra</span>&nbsp;<span class="op" id="3504962">:=</span>&nbsp;<span class="keyword" id="3504965">range</span>&nbsp;<span class="ident" id="3504971">strings</span><span class="op" id="3504978">.</span><span class="ident" id="3504979">Split</span><span class="op" id="3504984">(</span><span class="ident" id="3504985">s</span><span class="op" id="3504986">[</span><span class="builtinfunc" id="3504987">len</span><span class="op" id="3504990">(</span><span class="ident" id="3504991">b</span><span class="op" id="3504992">)</span><span class="op" id="3504993">:</span><span class="op" id="3504994">]</span><span class="op" id="3504995">,</span>&nbsp;<span class="string" id="3504997">&#34;,&#34;</span><span class="op" id="3505000">)</span>&nbsp;<span class="op" id="3505002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3505006">ra</span>&nbsp;<span class="op" id="3505009">=</span>&nbsp;<span class="ident" id="3505011">strings</span><span class="op" id="3505018">.</span><span class="ident" id="3505019">TrimSpace</span><span class="op" id="3505028">(</span><span class="ident" id="3505029">ra</span><span class="op" id="3505031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3505035">if</span>&nbsp;<span class="ident" id="3505038">ra</span>&nbsp;<span class="op" id="3505041">==</span>&nbsp;<span class="string" id="3505044">&#34;&#34;</span>&nbsp;<span class="op" id="3505047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3505052">continue</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3505063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3505067">i</span>&nbsp;<span class="op" id="3505069">:=</span>&nbsp;<span class="ident" id="3505072">strings</span><span class="op" id="3505079">.</span><span class="ident" id="3505080">Index</span><span class="op" id="3505085">(</span><span class="ident" id="3505086">ra</span><span class="op" id="3505088">,</span>&nbsp;<span class="string" id="3505090">&#34;-&#34;</span><span class="op" id="3505093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3505097">if</span>&nbsp;<span class="ident" id="3505100">i</span>&nbsp;<span class="op" id="3505102">&lt;</span>&nbsp;<span class="num" id="3505104">0</span>&nbsp;<span class="op" id="3505106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3505111">return</span>&nbsp;<span class="builtintype" id="3505118">nil</span><span class="op" id="3505121">,</span>&nbsp;<span class="ident" id="3505123">errors</span><span class="op" id="3505129">.</span><span class="ident" id="3505130">New</span><span class="op" id="3505133">(</span><span class="string" id="3505134">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3505149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3505153">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3505157">start</span><span class="op" id="3505162">,</span>&nbsp;<span class="ident" id="3505164">end</span>&nbsp;<span class="op" id="3505168">:=</span>&nbsp;<span class="ident" id="3505171">strings</span><span class="op" id="3505178">.</span><span class="ident" id="3505179">TrimSpace</span><span class="op" id="3505188">(</span><span class="ident" id="3505189">ra</span><span class="op" id="3505191">[</span><span class="op" id="3505192">:</span><span class="ident" id="3505193">i</span><span class="op" id="3505194">]</span><span class="op" id="3505195">)</span><span class="op" id="3505196">,</span>&nbsp;<span class="ident" id="3505198">strings</span><span class="op" id="3505205">.</span><span class="ident" id="3505206">TrimSpace</span><span class="op" id="3505215">(</span><span class="ident" id="3505216">ra</span><span class="op" id="3505218">[</span><span class="ident" id="3505219">i</span><span class="op" id="3505220">+</span><span class="num" id="3505221">1</span><span class="op" id="3505222">:</span><span class="op" id="3505223">]</span><span class="op" id="3505224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3505228">var</span>&nbsp;<span class="ident" id="3505232">r</span>&nbsp;<span class="ident" id="3505234">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3505246">if</span>&nbsp;<span class="ident" id="3505249">start</span>&nbsp;<span class="op" id="3505255">==</span>&nbsp;<span class="string" id="3505258">&#34;&#34;</span>&nbsp;<span class="op" id="3505261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3505266">//&nbsp;If&nbsp;no&nbsp;start&nbsp;is&nbsp;specified,&nbsp;end&nbsp;specifies&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3505316">//&nbsp;range&nbsp;start&nbsp;relative&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3505367">i</span><span class="op" id="3505368">,</span>&nbsp;<span class="ident" id="3505370">err</span>&nbsp;<span class="op" id="3505374">:=</span>&nbsp;<span class="ident" id="3505377">strconv</span><span class="op" id="3505384">.</span><span class="ident" id="3505385">ParseInt</span><span class="op" id="3505393">(</span><span class="ident" id="3505394">end</span><span class="op" id="3505397">,</span>&nbsp;<span class="num" id="3505399">10</span><span class="op" id="3505401">,</span>&nbsp;<span class="num" id="3505403">64</span><span class="op" id="3505405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3505410">if</span>&nbsp;<span class="ident" id="3505413">err</span>&nbsp;<span class="op" id="3505417">!=</span>&nbsp;<span class="builtintype" id="3505420">nil</span>&nbsp;<span class="op" id="3505424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3505430">return</span>&nbsp;<span class="builtintype" id="3505437">nil</span><span class="op" id="3505440">,</span>&nbsp;<span class="ident" id="3505442">errors</span><span class="op" id="3505448">.</span><span class="ident" id="3505449">New</span><span class="op" id="3505452">(</span><span class="string" id="3505453">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3505468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3505473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3505478">if</span>&nbsp;<span class="ident" id="3505481">i</span>&nbsp;<span class="op" id="3505483">&gt;</span>&nbsp;<span class="ident" id="3505485">size</span>&nbsp;<span class="op" id="3505490">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3505496">i</span>&nbsp;<span class="op" id="3505498">=</span>&nbsp;<span class="ident" id="3505500">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3505508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3505513">r</span><span class="op" id="3505514">.</span><span class="ident" id="3505515">start</span>&nbsp;<span class="op" id="3505521">=</span>&nbsp;<span class="ident" id="3505523">size</span>&nbsp;<span class="op" id="3505528">-</span>&nbsp;<span class="ident" id="3505530">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3505535">r</span><span class="op" id="3505536">.</span><span class="ident" id="3505537">length</span>&nbsp;<span class="op" id="3505544">=</span>&nbsp;<span class="ident" id="3505546">size</span>&nbsp;<span class="op" id="3505551">-</span>&nbsp;<span class="ident" id="3505553">r</span><span class="op" id="3505554">.</span><span class="ident" id="3505555">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3505563">}</span>&nbsp;<span class="keyword" id="3505565">else</span>&nbsp;<span class="op" id="3505570">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3505575">i</span><span class="op" id="3505576">,</span>&nbsp;<span class="ident" id="3505578">err</span>&nbsp;<span class="op" id="3505582">:=</span>&nbsp;<span class="ident" id="3505585">strconv</span><span class="op" id="3505592">.</span><span class="ident" id="3505593">ParseInt</span><span class="op" id="3505601">(</span><span class="ident" id="3505602">start</span><span class="op" id="3505607">,</span>&nbsp;<span class="num" id="3505609">10</span><span class="op" id="3505611">,</span>&nbsp;<span class="num" id="3505613">64</span><span class="op" id="3505615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3505620">if</span>&nbsp;<span class="ident" id="3505623">err</span>&nbsp;<span class="op" id="3505627">!=</span>&nbsp;<span class="builtintype" id="3505630">nil</span>&nbsp;<span class="op" id="3505634">||</span>&nbsp;<span class="ident" id="3505637">i</span>&nbsp;<span class="op" id="3505639">&gt;</span>&nbsp;<span class="ident" id="3505641">size</span>&nbsp;<span class="op" id="3505646">||</span>&nbsp;<span class="ident" id="3505649">i</span>&nbsp;<span class="op" id="3505651">&lt;</span>&nbsp;<span class="num" id="3505653">0</span>&nbsp;<span class="op" id="3505655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3505661">return</span>&nbsp;<span class="builtintype" id="3505668">nil</span><span class="op" id="3505671">,</span>&nbsp;<span class="ident" id="3505673">errors</span><span class="op" id="3505679">.</span><span class="ident" id="3505680">New</span><span class="op" id="3505683">(</span><span class="string" id="3505684">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3505699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3505704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3505709">r</span><span class="op" id="3505710">.</span><span class="ident" id="3505711">start</span>&nbsp;<span class="op" id="3505717">=</span>&nbsp;<span class="ident" id="3505719">i</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3505724">if</span>&nbsp;<span class="ident" id="3505727">end</span>&nbsp;<span class="op" id="3505731">==</span>&nbsp;<span class="string" id="3505734">&#34;&#34;</span>&nbsp;<span class="op" id="3505737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3505743">//&nbsp;If&nbsp;no&nbsp;end&nbsp;is&nbsp;specified,&nbsp;range&nbsp;extends&nbsp;to&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3505808">r</span><span class="op" id="3505809">.</span><span class="ident" id="3505810">length</span>&nbsp;<span class="op" id="3505817">=</span>&nbsp;<span class="ident" id="3505819">size</span>&nbsp;<span class="op" id="3505824">-</span>&nbsp;<span class="ident" id="3505826">r</span><span class="op" id="3505827">.</span><span class="ident" id="3505828">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3505837">}</span>&nbsp;<span class="keyword" id="3505839">else</span>&nbsp;<span class="op" id="3505844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3505850">i</span><span class="op" id="3505851">,</span>&nbsp;<span class="ident" id="3505853">err</span>&nbsp;<span class="op" id="3505857">:=</span>&nbsp;<span class="ident" id="3505860">strconv</span><span class="op" id="3505867">.</span><span class="ident" id="3505868">ParseInt</span><span class="op" id="3505876">(</span><span class="ident" id="3505877">end</span><span class="op" id="3505880">,</span>&nbsp;<span class="num" id="3505882">10</span><span class="op" id="3505884">,</span>&nbsp;<span class="num" id="3505886">64</span><span class="op" id="3505888">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3505894">if</span>&nbsp;<span class="ident" id="3505897">err</span>&nbsp;<span class="op" id="3505901">!=</span>&nbsp;<span class="builtintype" id="3505904">nil</span>&nbsp;<span class="op" id="3505908">||</span>&nbsp;<span class="ident" id="3505911">r</span><span class="op" id="3505912">.</span><span class="ident" id="3505913">start</span>&nbsp;<span class="op" id="3505919">&gt;</span>&nbsp;<span class="ident" id="3505921">i</span>&nbsp;<span class="op" id="3505923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3505930">return</span>&nbsp;<span class="builtintype" id="3505937">nil</span><span class="op" id="3505940">,</span>&nbsp;<span class="ident" id="3505942">errors</span><span class="op" id="3505948">.</span><span class="ident" id="3505949">New</span><span class="op" id="3505952">(</span><span class="string" id="3505953">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3505968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3505974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3505980">if</span>&nbsp;<span class="ident" id="3505983">i</span>&nbsp;<span class="op" id="3505985">&gt;=</span>&nbsp;<span class="ident" id="3505988">size</span>&nbsp;<span class="op" id="3505993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506000">i</span>&nbsp;<span class="op" id="3506002">=</span>&nbsp;<span class="ident" id="3506004">size</span>&nbsp;<span class="op" id="3506009">-</span>&nbsp;<span class="num" id="3506011">1</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3506017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506023">r</span><span class="op" id="3506024">.</span><span class="ident" id="3506025">length</span>&nbsp;<span class="op" id="3506032">=</span>&nbsp;<span class="ident" id="3506034">i</span>&nbsp;<span class="op" id="3506036">-</span>&nbsp;<span class="ident" id="3506038">r</span><span class="op" id="3506039">.</span><span class="ident" id="3506040">start</span>&nbsp;<span class="op" id="3506046">+</span>&nbsp;<span class="num" id="3506048">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3506053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3506057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506061">ranges</span>&nbsp;<span class="op" id="3506068">=</span>&nbsp;<span class="builtinfunc" id="3506070">append</span><span class="op" id="3506076">(</span><span class="ident" id="3506077">ranges</span><span class="op" id="3506083">,</span>&nbsp;<span class="ident" id="3506085">r</span><span class="op" id="3506086">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3506089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3506092">return</span>&nbsp;<span class="ident" id="3506099">ranges</span><span class="op" id="3506105">,</span>&nbsp;<span class="builtintype" id="3506107">nil</span><br>
<span class="lineno"></span><span class="op" id="3506111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3506114">//&nbsp;countingWriter&nbsp;counts&nbsp;how&nbsp;many&nbsp;bytes&nbsp;have&nbsp;been&nbsp;written&nbsp;to&nbsp;it.</span><br>
<span class="lineno">530</span><span class="keyword" id="3506179">type</span>&nbsp;<span class="ident" id="3506184">countingWriter</span>&nbsp;<span class="builtintype" id="3506199">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3506206">func</span>&nbsp;<span class="op" id="3506211">(</span><span class="ident" id="3506212">w</span>&nbsp;<span class="op" id="3506214">*</span><span class="ident" id="3506215">countingWriter</span><span class="op" id="3506229">)</span>&nbsp;<span class="ident" id="3506231">Write</span><span class="op" id="3506236">(</span><span class="ident" id="3506237">p</span>&nbsp;<span class="op" id="3506239">[</span><span class="op" id="3506240">]</span><span class="builtintype" id="3506241">byte</span><span class="op" id="3506245">)</span>&nbsp;<span class="op" id="3506247">(</span><span class="ident" id="3506248">n</span>&nbsp;<span class="builtintype" id="3506250">int</span><span class="op" id="3506253">,</span>&nbsp;<span class="ident" id="3506255">err</span>&nbsp;<span class="builtintype" id="3506259">error</span><span class="op" id="3506264">)</span>&nbsp;<span class="op" id="3506266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3506269">*</span><span class="ident" id="3506270">w</span>&nbsp;<span class="op" id="3506272">+=</span>&nbsp;<span class="ident" id="3506275">countingWriter</span><span class="op" id="3506289">(</span><span class="builtinfunc" id="3506290">len</span><span class="op" id="3506293">(</span><span class="ident" id="3506294">p</span><span class="op" id="3506295">)</span><span class="op" id="3506296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3506299">return</span>&nbsp;<span class="builtinfunc" id="3506306">len</span><span class="op" id="3506309">(</span><span class="ident" id="3506310">p</span><span class="op" id="3506311">)</span><span class="op" id="3506312">,</span>&nbsp;<span class="builtintype" id="3506314">nil</span><br>
<span class="lineno">535</span><span class="op" id="3506318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3506321">//&nbsp;rangesMIMESize&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;it&nbsp;takes&nbsp;to&nbsp;encode&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3506390">//&nbsp;provided&nbsp;ranges&nbsp;as&nbsp;a&nbsp;multipart&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3506434">func</span>&nbsp;<span class="ident" id="3506439">rangesMIMESize</span><span class="op" id="3506453">(</span><span class="ident" id="3506454">ranges</span>&nbsp;<span class="op" id="3506461">[</span><span class="op" id="3506462">]</span><span class="ident" id="3506463">httpRange</span><span class="op" id="3506472">,</span>&nbsp;<span class="ident" id="3506474">contentType</span>&nbsp;<span class="builtintype" id="3506486">string</span><span class="op" id="3506492">,</span>&nbsp;<span class="ident" id="3506494">contentSize</span>&nbsp;<span class="builtintype" id="3506506">int64</span><span class="op" id="3506511">)</span>&nbsp;<span class="op" id="3506513">(</span><span class="ident" id="3506514">encSize</span>&nbsp;<span class="builtintype" id="3506522">int64</span><span class="op" id="3506527">)</span>&nbsp;<span class="op" id="3506529">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3506532">var</span>&nbsp;<span class="ident" id="3506536">w</span>&nbsp;<span class="ident" id="3506538">countingWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506554">mw</span>&nbsp;<span class="op" id="3506557">:=</span>&nbsp;<span class="ident" id="3506560">multipart</span><span class="op" id="3506569">.</span><span class="ident" id="3506570">NewWriter</span><span class="op" id="3506579">(</span><span class="op" id="3506580">&amp;</span><span class="ident" id="3506581">w</span><span class="op" id="3506582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3506585">for</span>&nbsp;<span class="ident" id="3506589">_</span><span class="op" id="3506590">,</span>&nbsp;<span class="ident" id="3506592">ra</span>&nbsp;<span class="op" id="3506595">:=</span>&nbsp;<span class="keyword" id="3506598">range</span>&nbsp;<span class="ident" id="3506604">ranges</span>&nbsp;<span class="op" id="3506611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506615">mw</span><span class="op" id="3506617">.</span><span class="ident" id="3506618">CreatePart</span><span class="op" id="3506628">(</span><span class="ident" id="3506629">ra</span><span class="op" id="3506631">.</span><span class="ident" id="3506632">mimeHeader</span><span class="op" id="3506642">(</span><span class="ident" id="3506643">contentType</span><span class="op" id="3506654">,</span>&nbsp;<span class="ident" id="3506656">contentSize</span><span class="op" id="3506667">)</span><span class="op" id="3506668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506672">encSize</span>&nbsp;<span class="op" id="3506680">+=</span>&nbsp;<span class="ident" id="3506683">ra</span><span class="op" id="3506685">.</span><span class="ident" id="3506686">length</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3506694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506697">mw</span><span class="op" id="3506699">.</span><span class="ident" id="3506700">Close</span><span class="op" id="3506705">(</span><span class="op" id="3506706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506709">encSize</span>&nbsp;<span class="op" id="3506717">+=</span>&nbsp;<span class="builtintype" id="3506720">int64</span><span class="op" id="3506725">(</span><span class="ident" id="3506726">w</span><span class="op" id="3506727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3506730">return</span><br>
<span class="lineno"></span><span class="op" id="3506737">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="3506740">func</span>&nbsp;<span class="ident" id="3506745">sumRangesSize</span><span class="op" id="3506758">(</span><span class="ident" id="3506759">ranges</span>&nbsp;<span class="op" id="3506766">[</span><span class="op" id="3506767">]</span><span class="ident" id="3506768">httpRange</span><span class="op" id="3506777">)</span>&nbsp;<span class="op" id="3506779">(</span><span class="ident" id="3506780">size</span>&nbsp;<span class="builtintype" id="3506785">int64</span><span class="op" id="3506790">)</span>&nbsp;<span class="op" id="3506792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3506795">for</span>&nbsp;<span class="ident" id="3506799">_</span><span class="op" id="3506800">,</span>&nbsp;<span class="ident" id="3506802">ra</span>&nbsp;<span class="op" id="3506805">:=</span>&nbsp;<span class="keyword" id="3506808">range</span>&nbsp;<span class="ident" id="3506814">ranges</span>&nbsp;<span class="op" id="3506821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506825">size</span>&nbsp;<span class="op" id="3506830">+=</span>&nbsp;<span class="ident" id="3506833">ra</span><span class="op" id="3506835">.</span><span class="ident" id="3506836">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3506844">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3506847">return</span><br>
<span class="lineno"></span><span class="op" id="3506854">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
