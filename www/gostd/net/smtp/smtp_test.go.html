<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/smtp</h2>
<ul>
<li><a href="/gostd/net/smtp/auth.go.html">auth.go</a></li>
<li><a href="/gostd/net/smtp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/smtp/smtp.go.html">smtp.go</a></li>
<li><a href="/gostd/net/smtp/smtp_test.go.html">smtp_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8638505">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8638560">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8638614">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8638665">package</span>&nbsp;<span class="ident" id="8638673">smtp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8638679">import</span>&nbsp;<span class="op" id="8638686">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638689">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638698">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638707">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638721">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638736">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638742">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638749">&#34;net/textproto&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638766">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638777">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638788">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8638795">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="8638798">type</span>&nbsp;<span class="ident" id="8638803">authTest</span>&nbsp;<span class="keyword" id="8638812">struct</span>&nbsp;<span class="op" id="8638819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8638822">auth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8638833">Auth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8638839">challenges</span>&nbsp;<span class="op" id="8638850">[</span><span class="op" id="8638851">]</span><span class="builtintype" id="8638852">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8638860">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8638871">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8638879">responses</span>&nbsp;&nbsp;<span class="op" id="8638890">[</span><span class="op" id="8638891">]</span><span class="builtintype" id="8638892">string</span><br>
<span class="lineno">25</span><span class="op" id="8638899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8638902">var</span>&nbsp;<span class="ident" id="8638906">authTests</span>&nbsp;<span class="op" id="8638916">=</span>&nbsp;<span class="op" id="8638918">[</span><span class="op" id="8638919">]</span><span class="ident" id="8638920">authTest</span><span class="op" id="8638928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8638931">{</span><span class="ident" id="8638932">PlainAuth</span><span class="op" id="8638941">(</span><span class="string" id="8638942">&#34;&#34;</span><span class="op" id="8638944">,</span>&nbsp;<span class="string" id="8638946">&#34;user&#34;</span><span class="op" id="8638952">,</span>&nbsp;<span class="string" id="8638954">&#34;pass&#34;</span><span class="op" id="8638960">,</span>&nbsp;<span class="string" id="8638962">&#34;testserver&#34;</span><span class="op" id="8638974">)</span><span class="op" id="8638975">,</span>&nbsp;<span class="op" id="8638977">[</span><span class="op" id="8638978">]</span><span class="builtintype" id="8638979">string</span><span class="op" id="8638985">{</span><span class="op" id="8638986">}</span><span class="op" id="8638987">,</span>&nbsp;<span class="string" id="8638989">&#34;PLAIN&#34;</span><span class="op" id="8638996">,</span>&nbsp;<span class="op" id="8638998">[</span><span class="op" id="8638999">]</span><span class="builtintype" id="8639000">string</span><span class="op" id="8639006">{</span><span class="string" id="8639007">&#34;\x00user\x00pass&#34;</span><span class="op" id="8639025">}</span><span class="op" id="8639026">}</span><span class="op" id="8639027">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8639030">{</span><span class="ident" id="8639031">PlainAuth</span><span class="op" id="8639040">(</span><span class="string" id="8639041">&#34;foo&#34;</span><span class="op" id="8639046">,</span>&nbsp;<span class="string" id="8639048">&#34;bar&#34;</span><span class="op" id="8639053">,</span>&nbsp;<span class="string" id="8639055">&#34;baz&#34;</span><span class="op" id="8639060">,</span>&nbsp;<span class="string" id="8639062">&#34;testserver&#34;</span><span class="op" id="8639074">)</span><span class="op" id="8639075">,</span>&nbsp;<span class="op" id="8639077">[</span><span class="op" id="8639078">]</span><span class="builtintype" id="8639079">string</span><span class="op" id="8639085">{</span><span class="op" id="8639086">}</span><span class="op" id="8639087">,</span>&nbsp;<span class="string" id="8639089">&#34;PLAIN&#34;</span><span class="op" id="8639096">,</span>&nbsp;<span class="op" id="8639098">[</span><span class="op" id="8639099">]</span><span class="builtintype" id="8639100">string</span><span class="op" id="8639106">{</span><span class="string" id="8639107">&#34;foo\x00bar\x00baz&#34;</span><span class="op" id="8639126">}</span><span class="op" id="8639127">}</span><span class="op" id="8639128">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8639131">{</span><span class="ident" id="8639132">CRAMMD5Auth</span><span class="op" id="8639143">(</span><span class="string" id="8639144">&#34;user&#34;</span><span class="op" id="8639150">,</span>&nbsp;<span class="string" id="8639152">&#34;pass&#34;</span><span class="op" id="8639158">)</span><span class="op" id="8639159">,</span>&nbsp;<span class="op" id="8639161">[</span><span class="op" id="8639162">]</span><span class="builtintype" id="8639163">string</span><span class="op" id="8639169">{</span><span class="string" id="8639170">&#34;&lt;123456.1322876914@testserver&gt;&#34;</span><span class="op" id="8639202">}</span><span class="op" id="8639203">,</span>&nbsp;<span class="string" id="8639205">&#34;CRAM-MD5&#34;</span><span class="op" id="8639215">,</span>&nbsp;<span class="op" id="8639217">[</span><span class="op" id="8639218">]</span><span class="builtintype" id="8639219">string</span><span class="op" id="8639225">{</span><span class="string" id="8639226">&#34;&#34;</span><span class="op" id="8639228">,</span>&nbsp;<span class="string" id="8639230">&#34;user&nbsp;287eb355114cf5c471c26a875f1ca4ae&#34;</span><span class="op" id="8639269">}</span><span class="op" id="8639270">}</span><span class="op" id="8639271">,</span><br>
<span class="lineno"></span><span class="op" id="8639273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8639276">func</span>&nbsp;<span class="ident" id="8639281">TestAuth</span><span class="op" id="8639289">(</span><span class="ident" id="8639290">t</span>&nbsp;<span class="op" id="8639292">*</span><span class="ident" id="8639293">testing</span><span class="op" id="8639300">.</span><span class="ident" id="8639301">T</span><span class="op" id="8639302">)</span>&nbsp;<span class="op" id="8639304">{</span><br>
<span class="lineno"></span><span class="ident" id="8639306">testLoop</span><span class="op" id="8639314">:</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639317">for</span>&nbsp;<span class="ident" id="8639321">i</span><span class="op" id="8639322">,</span>&nbsp;<span class="ident" id="8639324">test</span>&nbsp;<span class="op" id="8639329">:=</span>&nbsp;<span class="keyword" id="8639332">range</span>&nbsp;<span class="ident" id="8639338">authTests</span>&nbsp;<span class="op" id="8639348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8639352">name</span><span class="op" id="8639356">,</span>&nbsp;<span class="ident" id="8639358">resp</span><span class="op" id="8639362">,</span>&nbsp;<span class="ident" id="8639364">err</span>&nbsp;<span class="op" id="8639368">:=</span>&nbsp;<span class="ident" id="8639371">test</span><span class="op" id="8639375">.</span><span class="ident" id="8639376">auth</span><span class="op" id="8639380">.</span><span class="ident" id="8639381">Start</span><span class="op" id="8639386">(</span><span class="op" id="8639387">&amp;</span><span class="ident" id="8639388">ServerInfo</span><span class="op" id="8639398">{</span><span class="string" id="8639399">&#34;testserver&#34;</span><span class="op" id="8639411">,</span>&nbsp;<span class="builtintype" id="8639413">true</span><span class="op" id="8639417">,</span>&nbsp;<span class="ident" id="8639419">nil</span><span class="op" id="8639422">}</span><span class="op" id="8639423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639427">if</span>&nbsp;<span class="ident" id="8639430">name</span>&nbsp;<span class="op" id="8639435">!=</span>&nbsp;<span class="ident" id="8639438">test</span><span class="op" id="8639442">.</span><span class="ident" id="8639443">name</span>&nbsp;<span class="op" id="8639448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8639453">t</span><span class="op" id="8639454">.</span><span class="ident" id="8639455">Errorf</span><span class="op" id="8639461">(</span><span class="string" id="8639462">&#34;#%d&nbsp;got&nbsp;name&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="8639492">,</span>&nbsp;<span class="ident" id="8639494">i</span><span class="op" id="8639495">,</span>&nbsp;<span class="ident" id="8639497">name</span><span class="op" id="8639501">,</span>&nbsp;<span class="ident" id="8639503">test</span><span class="op" id="8639507">.</span><span class="ident" id="8639508">name</span><span class="op" id="8639512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8639516">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639520">if</span>&nbsp;<span class="op" id="8639523">!</span><span class="ident" id="8639524">bytes</span><span class="op" id="8639529">.</span><span class="ident" id="8639530">Equal</span><span class="op" id="8639535">(</span><span class="ident" id="8639536">resp</span><span class="op" id="8639540">,</span>&nbsp;<span class="op" id="8639542">[</span><span class="op" id="8639543">]</span><span class="builtintype" id="8639544">byte</span><span class="op" id="8639548">(</span><span class="ident" id="8639549">test</span><span class="op" id="8639553">.</span><span class="ident" id="8639554">responses</span><span class="op" id="8639563">[</span><span class="num" id="8639564">0</span><span class="op" id="8639565">]</span><span class="op" id="8639566">)</span><span class="op" id="8639567">)</span>&nbsp;<span class="op" id="8639569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8639574">t</span><span class="op" id="8639575">.</span><span class="ident" id="8639576">Errorf</span><span class="op" id="8639582">(</span><span class="string" id="8639583">&#34;#%d&nbsp;got&nbsp;response&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="8639617">,</span>&nbsp;<span class="ident" id="8639619">i</span><span class="op" id="8639620">,</span>&nbsp;<span class="ident" id="8639622">resp</span><span class="op" id="8639626">,</span>&nbsp;<span class="ident" id="8639628">test</span><span class="op" id="8639632">.</span><span class="ident" id="8639633">responses</span><span class="op" id="8639642">[</span><span class="num" id="8639643">0</span><span class="op" id="8639644">]</span><span class="op" id="8639645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8639649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639653">if</span>&nbsp;<span class="ident" id="8639656">err</span>&nbsp;<span class="op" id="8639660">!=</span>&nbsp;<span class="ident" id="8639663">nil</span>&nbsp;<span class="op" id="8639667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8639672">t</span><span class="op" id="8639673">.</span><span class="ident" id="8639674">Errorf</span><span class="op" id="8639680">(</span><span class="string" id="8639681">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="8639696">,</span>&nbsp;<span class="ident" id="8639698">i</span><span class="op" id="8639699">,</span>&nbsp;<span class="ident" id="8639701">err</span><span class="op" id="8639704">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8639708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639712">for</span>&nbsp;<span class="ident" id="8639716">j</span>&nbsp;<span class="op" id="8639718">:=</span>&nbsp;<span class="keyword" id="8639721">range</span>&nbsp;<span class="ident" id="8639727">test</span><span class="op" id="8639731">.</span><span class="ident" id="8639732">challenges</span>&nbsp;<span class="op" id="8639743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8639748">challenge</span>&nbsp;<span class="op" id="8639758">:=</span>&nbsp;<span class="op" id="8639761">[</span><span class="op" id="8639762">]</span><span class="builtintype" id="8639763">byte</span><span class="op" id="8639767">(</span><span class="ident" id="8639768">test</span><span class="op" id="8639772">.</span><span class="ident" id="8639773">challenges</span><span class="op" id="8639783">[</span><span class="ident" id="8639784">j</span><span class="op" id="8639785">]</span><span class="op" id="8639786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8639791">expected</span>&nbsp;<span class="op" id="8639800">:=</span>&nbsp;<span class="op" id="8639803">[</span><span class="op" id="8639804">]</span><span class="builtintype" id="8639805">byte</span><span class="op" id="8639809">(</span><span class="ident" id="8639810">test</span><span class="op" id="8639814">.</span><span class="ident" id="8639815">responses</span><span class="op" id="8639824">[</span><span class="ident" id="8639825">j</span><span class="op" id="8639826">+</span><span class="num" id="8639827">1</span><span class="op" id="8639828">]</span><span class="op" id="8639829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8639834">resp</span><span class="op" id="8639838">,</span>&nbsp;<span class="ident" id="8639840">err</span>&nbsp;<span class="op" id="8639844">:=</span>&nbsp;<span class="ident" id="8639847">test</span><span class="op" id="8639851">.</span><span class="ident" id="8639852">auth</span><span class="op" id="8639856">.</span><span class="ident" id="8639857">Next</span><span class="op" id="8639861">(</span><span class="ident" id="8639862">challenge</span><span class="op" id="8639871">,</span>&nbsp;<span class="builtintype" id="8639873">true</span><span class="op" id="8639877">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639882">if</span>&nbsp;<span class="ident" id="8639885">err</span>&nbsp;<span class="op" id="8639889">!=</span>&nbsp;<span class="ident" id="8639892">nil</span>&nbsp;<span class="op" id="8639896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8639902">t</span><span class="op" id="8639903">.</span><span class="ident" id="8639904">Errorf</span><span class="op" id="8639910">(</span><span class="string" id="8639911">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="8639926">,</span>&nbsp;<span class="ident" id="8639928">i</span><span class="op" id="8639929">,</span>&nbsp;<span class="ident" id="8639931">err</span><span class="op" id="8639934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639940">continue</span>&nbsp;<span class="ident" id="8639949">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8639961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639966">if</span>&nbsp;<span class="op" id="8639969">!</span><span class="ident" id="8639970">bytes</span><span class="op" id="8639975">.</span><span class="ident" id="8639976">Equal</span><span class="op" id="8639981">(</span><span class="ident" id="8639982">resp</span><span class="op" id="8639986">,</span>&nbsp;<span class="ident" id="8639988">expected</span><span class="op" id="8639996">)</span>&nbsp;<span class="op" id="8639998">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640004">t</span><span class="op" id="8640005">.</span><span class="ident" id="8640006">Errorf</span><span class="op" id="8640012">(</span><span class="string" id="8640013">&#34;#%d&nbsp;got&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="8640038">,</span>&nbsp;<span class="ident" id="8640040">i</span><span class="op" id="8640041">,</span>&nbsp;<span class="ident" id="8640043">resp</span><span class="op" id="8640047">,</span>&nbsp;<span class="ident" id="8640049">expected</span><span class="op" id="8640057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640063">continue</span>&nbsp;<span class="ident" id="8640072">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640091">}</span><br>
<span class="lineno">60</span><span class="op" id="8640093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8640096">func</span>&nbsp;<span class="ident" id="8640101">TestAuthPlain</span><span class="op" id="8640114">(</span><span class="ident" id="8640115">t</span>&nbsp;<span class="op" id="8640117">*</span><span class="ident" id="8640118">testing</span><span class="op" id="8640125">.</span><span class="ident" id="8640126">T</span><span class="op" id="8640127">)</span>&nbsp;<span class="op" id="8640129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640132">auth</span>&nbsp;<span class="op" id="8640137">:=</span>&nbsp;<span class="ident" id="8640140">PlainAuth</span><span class="op" id="8640149">(</span><span class="string" id="8640150">&#34;foo&#34;</span><span class="op" id="8640155">,</span>&nbsp;<span class="string" id="8640157">&#34;bar&#34;</span><span class="op" id="8640162">,</span>&nbsp;<span class="string" id="8640164">&#34;baz&#34;</span><span class="op" id="8640169">,</span>&nbsp;<span class="string" id="8640171">&#34;servername&#34;</span><span class="op" id="8640183">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640187">tests</span>&nbsp;<span class="op" id="8640193">:=</span>&nbsp;<span class="op" id="8640196">[</span><span class="op" id="8640197">]</span><span class="keyword" id="8640198">struct</span>&nbsp;<span class="op" id="8640205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640209">server</span>&nbsp;<span class="op" id="8640216">*</span><span class="ident" id="8640217">ServerInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640230">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8640237">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640245">}</span><span class="op" id="8640246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640250">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640255">server</span><span class="op" id="8640261">:</span>&nbsp;<span class="op" id="8640263">&amp;</span><span class="ident" id="8640264">ServerInfo</span><span class="op" id="8640274">{</span><span class="ident" id="8640275">Name</span><span class="op" id="8640279">:</span>&nbsp;<span class="string" id="8640281">&#34;servername&#34;</span><span class="op" id="8640293">,</span>&nbsp;<span class="ident" id="8640295">TLS</span><span class="op" id="8640298">:</span>&nbsp;<span class="builtintype" id="8640300">true</span><span class="op" id="8640304">}</span><span class="op" id="8640305">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640309">}</span><span class="op" id="8640310">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8640319">//&nbsp;Okay;&nbsp;explicitly&nbsp;advertised&nbsp;by&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640364">server</span><span class="op" id="8640370">:</span>&nbsp;<span class="op" id="8640372">&amp;</span><span class="ident" id="8640373">ServerInfo</span><span class="op" id="8640383">{</span><span class="ident" id="8640384">Name</span><span class="op" id="8640388">:</span>&nbsp;<span class="string" id="8640390">&#34;servername&#34;</span><span class="op" id="8640402">,</span>&nbsp;<span class="ident" id="8640404">Auth</span><span class="op" id="8640408">:</span>&nbsp;<span class="op" id="8640410">[</span><span class="op" id="8640411">]</span><span class="builtintype" id="8640412">string</span><span class="op" id="8640418">{</span><span class="string" id="8640419">&#34;PLAIN&#34;</span><span class="op" id="8640426">}</span><span class="op" id="8640427">}</span><span class="op" id="8640428">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640432">}</span><span class="op" id="8640433">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640442">server</span><span class="op" id="8640448">:</span>&nbsp;<span class="op" id="8640450">&amp;</span><span class="ident" id="8640451">ServerInfo</span><span class="op" id="8640461">{</span><span class="ident" id="8640462">Name</span><span class="op" id="8640466">:</span>&nbsp;<span class="string" id="8640468">&#34;servername&#34;</span><span class="op" id="8640480">,</span>&nbsp;<span class="ident" id="8640482">Auth</span><span class="op" id="8640486">:</span>&nbsp;<span class="op" id="8640488">[</span><span class="op" id="8640489">]</span><span class="builtintype" id="8640490">string</span><span class="op" id="8640496">{</span><span class="string" id="8640497">&#34;CRAM-MD5&#34;</span><span class="op" id="8640507">}</span><span class="op" id="8640508">}</span><span class="op" id="8640509">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640514">err</span><span class="op" id="8640517">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8640522">&#34;unencrypted&nbsp;connection&#34;</span><span class="op" id="8640546">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640550">}</span><span class="op" id="8640551">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640560">server</span><span class="op" id="8640566">:</span>&nbsp;<span class="op" id="8640568">&amp;</span><span class="ident" id="8640569">ServerInfo</span><span class="op" id="8640579">{</span><span class="ident" id="8640580">Name</span><span class="op" id="8640584">:</span>&nbsp;<span class="string" id="8640586">&#34;attacker&#34;</span><span class="op" id="8640596">,</span>&nbsp;<span class="ident" id="8640598">TLS</span><span class="op" id="8640601">:</span>&nbsp;<span class="builtintype" id="8640603">true</span><span class="op" id="8640607">}</span><span class="op" id="8640608">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640613">err</span><span class="op" id="8640616">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8640621">&#34;wrong&nbsp;host&nbsp;name&#34;</span><span class="op" id="8640638">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640642">}</span><span class="op" id="8640643">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640646">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640649">for</span>&nbsp;<span class="ident" id="8640653">i</span><span class="op" id="8640654">,</span>&nbsp;<span class="ident" id="8640656">tt</span>&nbsp;<span class="op" id="8640659">:=</span>&nbsp;<span class="keyword" id="8640662">range</span>&nbsp;<span class="ident" id="8640668">tests</span>&nbsp;<span class="op" id="8640674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640678">_</span><span class="op" id="8640679">,</span>&nbsp;<span class="ident" id="8640681">_</span><span class="op" id="8640682">,</span>&nbsp;<span class="ident" id="8640684">err</span>&nbsp;<span class="op" id="8640688">:=</span>&nbsp;<span class="ident" id="8640691">auth</span><span class="op" id="8640695">.</span><span class="ident" id="8640696">Start</span><span class="op" id="8640701">(</span><span class="ident" id="8640702">tt</span><span class="op" id="8640704">.</span><span class="ident" id="8640705">server</span><span class="op" id="8640711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640715">got</span>&nbsp;<span class="op" id="8640719">:=</span>&nbsp;<span class="string" id="8640722">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640727">if</span>&nbsp;<span class="ident" id="8640730">err</span>&nbsp;<span class="op" id="8640734">!=</span>&nbsp;<span class="ident" id="8640737">nil</span>&nbsp;<span class="op" id="8640741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640746">got</span>&nbsp;<span class="op" id="8640750">=</span>&nbsp;<span class="ident" id="8640752">err</span><span class="op" id="8640755">.</span><span class="ident" id="8640756">Error</span><span class="op" id="8640761">(</span><span class="op" id="8640762">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640770">if</span>&nbsp;<span class="ident" id="8640773">got</span>&nbsp;<span class="op" id="8640777">!=</span>&nbsp;<span class="ident" id="8640780">tt</span><span class="op" id="8640782">.</span><span class="ident" id="8640783">err</span>&nbsp;<span class="op" id="8640787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640792">t</span><span class="op" id="8640793">.</span><span class="ident" id="8640794">Errorf</span><span class="op" id="8640800">(</span><span class="string" id="8640801">&#34;%d.&nbsp;got&nbsp;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8640830">,</span>&nbsp;<span class="ident" id="8640832">i</span><span class="op" id="8640833">,</span>&nbsp;<span class="ident" id="8640835">got</span><span class="op" id="8640838">,</span>&nbsp;<span class="ident" id="8640840">tt</span><span class="op" id="8640842">.</span><span class="ident" id="8640843">err</span><span class="op" id="8640846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640853">}</span><br>
<span class="lineno">95</span><span class="op" id="8640855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8640858">type</span>&nbsp;<span class="ident" id="8640863">faker</span>&nbsp;<span class="keyword" id="8640869">struct</span>&nbsp;<span class="op" id="8640876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640879">io</span><span class="op" id="8640881">.</span><span class="ident" id="8640882">ReadWriter</span><br>
<span class="lineno"></span><span class="op" id="8640893">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="8640896">func</span>&nbsp;<span class="op" id="8640901">(</span><span class="ident" id="8640902">f</span>&nbsp;<span class="ident" id="8640904">faker</span><span class="op" id="8640909">)</span>&nbsp;<span class="ident" id="8640911">Close</span><span class="op" id="8640916">(</span><span class="op" id="8640917">)</span>&nbsp;<span class="builtintype" id="8640919">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8640945">{</span>&nbsp;<span class="keyword" id="8640947">return</span>&nbsp;<span class="ident" id="8640954">nil</span>&nbsp;<span class="op" id="8640958">}</span><br>
<span class="lineno"></span><span class="keyword" id="8640960">func</span>&nbsp;<span class="op" id="8640965">(</span><span class="ident" id="8640966">f</span>&nbsp;<span class="ident" id="8640968">faker</span><span class="op" id="8640973">)</span>&nbsp;<span class="ident" id="8640975">LocalAddr</span><span class="op" id="8640984">(</span><span class="op" id="8640985">)</span>&nbsp;<span class="ident" id="8640987">net</span><span class="op" id="8640990">.</span><span class="ident" id="8640991">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8641009">{</span>&nbsp;<span class="keyword" id="8641011">return</span>&nbsp;<span class="ident" id="8641018">nil</span>&nbsp;<span class="op" id="8641022">}</span><br>
<span class="lineno"></span><span class="keyword" id="8641024">func</span>&nbsp;<span class="op" id="8641029">(</span><span class="ident" id="8641030">f</span>&nbsp;<span class="ident" id="8641032">faker</span><span class="op" id="8641037">)</span>&nbsp;<span class="ident" id="8641039">RemoteAddr</span><span class="op" id="8641049">(</span><span class="op" id="8641050">)</span>&nbsp;<span class="ident" id="8641052">net</span><span class="op" id="8641055">.</span><span class="ident" id="8641056">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8641073">{</span>&nbsp;<span class="keyword" id="8641075">return</span>&nbsp;<span class="ident" id="8641082">nil</span>&nbsp;<span class="op" id="8641086">}</span><br>
<span class="lineno"></span><span class="keyword" id="8641088">func</span>&nbsp;<span class="op" id="8641093">(</span><span class="ident" id="8641094">f</span>&nbsp;<span class="ident" id="8641096">faker</span><span class="op" id="8641101">)</span>&nbsp;<span class="ident" id="8641103">SetDeadline</span><span class="op" id="8641114">(</span><span class="ident" id="8641115">time</span><span class="op" id="8641119">.</span><span class="ident" id="8641120">Time</span><span class="op" id="8641124">)</span>&nbsp;<span class="builtintype" id="8641126">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8641137">{</span>&nbsp;<span class="keyword" id="8641139">return</span>&nbsp;<span class="ident" id="8641146">nil</span>&nbsp;<span class="op" id="8641150">}</span><br>
<span class="lineno">105</span><span class="keyword" id="8641152">func</span>&nbsp;<span class="op" id="8641157">(</span><span class="ident" id="8641158">f</span>&nbsp;<span class="ident" id="8641160">faker</span><span class="op" id="8641165">)</span>&nbsp;<span class="ident" id="8641167">SetReadDeadline</span><span class="op" id="8641182">(</span><span class="ident" id="8641183">time</span><span class="op" id="8641187">.</span><span class="ident" id="8641188">Time</span><span class="op" id="8641192">)</span>&nbsp;<span class="builtintype" id="8641194">error</span>&nbsp;&nbsp;<span class="op" id="8641201">{</span>&nbsp;<span class="keyword" id="8641203">return</span>&nbsp;<span class="ident" id="8641210">nil</span>&nbsp;<span class="op" id="8641214">}</span><br>
<span class="lineno"></span><span class="keyword" id="8641216">func</span>&nbsp;<span class="op" id="8641221">(</span><span class="ident" id="8641222">f</span>&nbsp;<span class="ident" id="8641224">faker</span><span class="op" id="8641229">)</span>&nbsp;<span class="ident" id="8641231">SetWriteDeadline</span><span class="op" id="8641247">(</span><span class="ident" id="8641248">time</span><span class="op" id="8641252">.</span><span class="ident" id="8641253">Time</span><span class="op" id="8641257">)</span>&nbsp;<span class="builtintype" id="8641259">error</span>&nbsp;<span class="op" id="8641265">{</span>&nbsp;<span class="keyword" id="8641267">return</span>&nbsp;<span class="ident" id="8641274">nil</span>&nbsp;<span class="op" id="8641278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8641281">func</span>&nbsp;<span class="ident" id="8641286">TestBasic</span><span class="op" id="8641295">(</span><span class="ident" id="8641296">t</span>&nbsp;<span class="op" id="8641298">*</span><span class="ident" id="8641299">testing</span><span class="op" id="8641306">.</span><span class="ident" id="8641307">T</span><span class="op" id="8641308">)</span>&nbsp;<span class="op" id="8641310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641313">server</span>&nbsp;<span class="op" id="8641320">:=</span>&nbsp;<span class="ident" id="8641323">strings</span><span class="op" id="8641330">.</span><span class="ident" id="8641331">Join</span><span class="op" id="8641335">(</span><span class="ident" id="8641336">strings</span><span class="op" id="8641343">.</span><span class="ident" id="8641344">Split</span><span class="op" id="8641349">(</span><span class="ident" id="8641350">basicServer</span><span class="op" id="8641361">,</span>&nbsp;<span class="string" id="8641363">&#34;\n&#34;</span><span class="op" id="8641367">)</span><span class="op" id="8641368">,</span>&nbsp;<span class="string" id="8641370">&#34;\r\n&#34;</span><span class="op" id="8641376">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641379">client</span>&nbsp;<span class="op" id="8641386">:=</span>&nbsp;<span class="ident" id="8641389">strings</span><span class="op" id="8641396">.</span><span class="ident" id="8641397">Join</span><span class="op" id="8641401">(</span><span class="ident" id="8641402">strings</span><span class="op" id="8641409">.</span><span class="ident" id="8641410">Split</span><span class="op" id="8641415">(</span><span class="ident" id="8641416">basicClient</span><span class="op" id="8641427">,</span>&nbsp;<span class="string" id="8641429">&#34;\n&#34;</span><span class="op" id="8641433">)</span><span class="op" id="8641434">,</span>&nbsp;<span class="string" id="8641436">&#34;\r\n&#34;</span><span class="op" id="8641442">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641446">var</span>&nbsp;<span class="ident" id="8641450">cmdbuf</span>&nbsp;<span class="ident" id="8641457">bytes</span><span class="op" id="8641462">.</span><span class="ident" id="8641463">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641471">bcmdbuf</span>&nbsp;<span class="op" id="8641479">:=</span>&nbsp;<span class="ident" id="8641482">bufio</span><span class="op" id="8641487">.</span><span class="ident" id="8641488">NewWriter</span><span class="op" id="8641497">(</span><span class="op" id="8641498">&amp;</span><span class="ident" id="8641499">cmdbuf</span><span class="op" id="8641505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641508">var</span>&nbsp;<span class="ident" id="8641512">fake</span>&nbsp;<span class="ident" id="8641517">faker</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641524">fake</span><span class="op" id="8641528">.</span><span class="ident" id="8641529">ReadWriter</span>&nbsp;<span class="op" id="8641540">=</span>&nbsp;<span class="ident" id="8641542">bufio</span><span class="op" id="8641547">.</span><span class="ident" id="8641548">NewReadWriter</span><span class="op" id="8641561">(</span><span class="ident" id="8641562">bufio</span><span class="op" id="8641567">.</span><span class="ident" id="8641568">NewReader</span><span class="op" id="8641577">(</span><span class="ident" id="8641578">strings</span><span class="op" id="8641585">.</span><span class="ident" id="8641586">NewReader</span><span class="op" id="8641595">(</span><span class="ident" id="8641596">server</span><span class="op" id="8641602">)</span><span class="op" id="8641603">)</span><span class="op" id="8641604">,</span>&nbsp;<span class="ident" id="8641606">bcmdbuf</span><span class="op" id="8641613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641616">c</span>&nbsp;<span class="op" id="8641618">:=</span>&nbsp;<span class="op" id="8641621">&amp;</span><span class="ident" id="8641622">Client</span><span class="op" id="8641628">{</span><span class="ident" id="8641629">Text</span><span class="op" id="8641633">:</span>&nbsp;<span class="ident" id="8641635">textproto</span><span class="op" id="8641644">.</span><span class="ident" id="8641645">NewConn</span><span class="op" id="8641652">(</span><span class="ident" id="8641653">fake</span><span class="op" id="8641657">)</span><span class="op" id="8641658">,</span>&nbsp;<span class="ident" id="8641660">localName</span><span class="op" id="8641669">:</span>&nbsp;<span class="string" id="8641671">&#34;localhost&#34;</span><span class="op" id="8641682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641686">if</span>&nbsp;<span class="ident" id="8641689">err</span>&nbsp;<span class="op" id="8641693">:=</span>&nbsp;<span class="ident" id="8641696">c</span><span class="op" id="8641697">.</span><span class="ident" id="8641698">helo</span><span class="op" id="8641702">(</span><span class="op" id="8641703">)</span><span class="op" id="8641704">;</span>&nbsp;<span class="ident" id="8641706">err</span>&nbsp;<span class="op" id="8641710">!=</span>&nbsp;<span class="ident" id="8641713">nil</span>&nbsp;<span class="op" id="8641717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641721">t</span><span class="op" id="8641722">.</span><span class="ident" id="8641723">Fatalf</span><span class="op" id="8641729">(</span><span class="string" id="8641730">&#34;HELO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8641747">,</span>&nbsp;<span class="ident" id="8641749">err</span><span class="op" id="8641752">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8641755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641758">if</span>&nbsp;<span class="ident" id="8641761">err</span>&nbsp;<span class="op" id="8641765">:=</span>&nbsp;<span class="ident" id="8641768">c</span><span class="op" id="8641769">.</span><span class="ident" id="8641770">ehlo</span><span class="op" id="8641774">(</span><span class="op" id="8641775">)</span><span class="op" id="8641776">;</span>&nbsp;<span class="ident" id="8641778">err</span>&nbsp;<span class="op" id="8641782">==</span>&nbsp;<span class="ident" id="8641785">nil</span>&nbsp;<span class="op" id="8641789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641793">t</span><span class="op" id="8641794">.</span><span class="ident" id="8641795">Fatalf</span><span class="op" id="8641801">(</span><span class="string" id="8641802">&#34;Expected&nbsp;first&nbsp;EHLO&nbsp;to&nbsp;fail&#34;</span><span class="op" id="8641831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8641834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641837">if</span>&nbsp;<span class="ident" id="8641840">err</span>&nbsp;<span class="op" id="8641844">:=</span>&nbsp;<span class="ident" id="8641847">c</span><span class="op" id="8641848">.</span><span class="ident" id="8641849">ehlo</span><span class="op" id="8641853">(</span><span class="op" id="8641854">)</span><span class="op" id="8641855">;</span>&nbsp;<span class="ident" id="8641857">err</span>&nbsp;<span class="op" id="8641861">!=</span>&nbsp;<span class="ident" id="8641864">nil</span>&nbsp;<span class="op" id="8641868">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641872">t</span><span class="op" id="8641873">.</span><span class="ident" id="8641874">Fatalf</span><span class="op" id="8641880">(</span><span class="string" id="8641881">&#34;Second&nbsp;EHLO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8641905">,</span>&nbsp;<span class="ident" id="8641907">err</span><span class="op" id="8641910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8641913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641917">c</span><span class="op" id="8641918">.</span><span class="ident" id="8641919">didHello</span>&nbsp;<span class="op" id="8641928">=</span>&nbsp;<span class="builtintype" id="8641930">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641936">if</span>&nbsp;<span class="ident" id="8641939">ok</span><span class="op" id="8641941">,</span>&nbsp;<span class="ident" id="8641943">args</span>&nbsp;<span class="op" id="8641948">:=</span>&nbsp;<span class="ident" id="8641951">c</span><span class="op" id="8641952">.</span><span class="ident" id="8641953">Extension</span><span class="op" id="8641962">(</span><span class="string" id="8641963">&#34;aUtH&#34;</span><span class="op" id="8641969">)</span><span class="op" id="8641970">;</span>&nbsp;<span class="op" id="8641972">!</span><span class="ident" id="8641973">ok</span>&nbsp;<span class="op" id="8641976">||</span>&nbsp;<span class="ident" id="8641979">args</span>&nbsp;<span class="op" id="8641984">!=</span>&nbsp;<span class="string" id="8641987">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="8642001">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642005">t</span><span class="op" id="8642006">.</span><span class="ident" id="8642007">Fatalf</span><span class="op" id="8642013">(</span><span class="string" id="8642014">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="8642039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642045">if</span>&nbsp;<span class="ident" id="8642048">ok</span><span class="op" id="8642050">,</span>&nbsp;<span class="ident" id="8642052">_</span>&nbsp;<span class="op" id="8642054">:=</span>&nbsp;<span class="ident" id="8642057">c</span><span class="op" id="8642058">.</span><span class="ident" id="8642059">Extension</span><span class="op" id="8642068">(</span><span class="string" id="8642069">&#34;DSN&#34;</span><span class="op" id="8642074">)</span><span class="op" id="8642075">;</span>&nbsp;<span class="ident" id="8642077">ok</span>&nbsp;<span class="op" id="8642080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642084">t</span><span class="op" id="8642085">.</span><span class="ident" id="8642086">Fatalf</span><span class="op" id="8642092">(</span><span class="string" id="8642093">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="8642116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642119">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642123">if</span>&nbsp;<span class="ident" id="8642126">err</span>&nbsp;<span class="op" id="8642130">:=</span>&nbsp;<span class="ident" id="8642133">c</span><span class="op" id="8642134">.</span><span class="ident" id="8642135">Mail</span><span class="op" id="8642139">(</span><span class="string" id="8642140">&#34;user@gmail.com&#34;</span><span class="op" id="8642156">)</span><span class="op" id="8642157">;</span>&nbsp;<span class="ident" id="8642159">err</span>&nbsp;<span class="op" id="8642163">==</span>&nbsp;<span class="ident" id="8642166">nil</span>&nbsp;<span class="op" id="8642170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642174">t</span><span class="op" id="8642175">.</span><span class="ident" id="8642176">Fatalf</span><span class="op" id="8642182">(</span><span class="string" id="8642183">&#34;MAIL&nbsp;should&nbsp;require&nbsp;authentication&#34;</span><span class="op" id="8642219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642226">if</span>&nbsp;<span class="ident" id="8642229">err</span>&nbsp;<span class="op" id="8642233">:=</span>&nbsp;<span class="ident" id="8642236">c</span><span class="op" id="8642237">.</span><span class="ident" id="8642238">Verify</span><span class="op" id="8642244">(</span><span class="string" id="8642245">&#34;user1@gmail.com&#34;</span><span class="op" id="8642262">)</span><span class="op" id="8642263">;</span>&nbsp;<span class="ident" id="8642265">err</span>&nbsp;<span class="op" id="8642269">==</span>&nbsp;<span class="ident" id="8642272">nil</span>&nbsp;<span class="op" id="8642276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642280">t</span><span class="op" id="8642281">.</span><span class="ident" id="8642282">Fatalf</span><span class="op" id="8642288">(</span><span class="string" id="8642289">&#34;First&nbsp;VRFY:&nbsp;expected&nbsp;no&nbsp;verification&#34;</span><span class="op" id="8642327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642333">if</span>&nbsp;<span class="ident" id="8642336">err</span>&nbsp;<span class="op" id="8642340">:=</span>&nbsp;<span class="ident" id="8642343">c</span><span class="op" id="8642344">.</span><span class="ident" id="8642345">Verify</span><span class="op" id="8642351">(</span><span class="string" id="8642352">&#34;user2@gmail.com&#34;</span><span class="op" id="8642369">)</span><span class="op" id="8642370">;</span>&nbsp;<span class="ident" id="8642372">err</span>&nbsp;<span class="op" id="8642376">!=</span>&nbsp;<span class="ident" id="8642379">nil</span>&nbsp;<span class="op" id="8642383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642387">t</span><span class="op" id="8642388">.</span><span class="ident" id="8642389">Fatalf</span><span class="op" id="8642395">(</span><span class="string" id="8642396">&#34;Second&nbsp;VRFY:&nbsp;expected&nbsp;verification,&nbsp;got&nbsp;%s&#34;</span><span class="op" id="8642440">,</span>&nbsp;<span class="ident" id="8642442">err</span><span class="op" id="8642445">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8642452">//&nbsp;fake&nbsp;TLS&nbsp;so&nbsp;authentication&nbsp;won&#39;t&nbsp;complain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642498">c</span><span class="op" id="8642499">.</span><span class="ident" id="8642500">tls</span>&nbsp;<span class="op" id="8642504">=</span>&nbsp;<span class="builtintype" id="8642506">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642512">c</span><span class="op" id="8642513">.</span><span class="ident" id="8642514">serverName</span>&nbsp;<span class="op" id="8642525">=</span>&nbsp;<span class="string" id="8642527">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642546">if</span>&nbsp;<span class="ident" id="8642549">err</span>&nbsp;<span class="op" id="8642553">:=</span>&nbsp;<span class="ident" id="8642556">c</span><span class="op" id="8642557">.</span><span class="ident" id="8642558">Auth</span><span class="op" id="8642562">(</span><span class="ident" id="8642563">PlainAuth</span><span class="op" id="8642572">(</span><span class="string" id="8642573">&#34;&#34;</span><span class="op" id="8642575">,</span>&nbsp;<span class="string" id="8642577">&#34;user&#34;</span><span class="op" id="8642583">,</span>&nbsp;<span class="string" id="8642585">&#34;pass&#34;</span><span class="op" id="8642591">,</span>&nbsp;<span class="string" id="8642593">&#34;smtp.google.com&#34;</span><span class="op" id="8642610">)</span><span class="op" id="8642611">)</span><span class="op" id="8642612">;</span>&nbsp;<span class="ident" id="8642614">err</span>&nbsp;<span class="op" id="8642618">!=</span>&nbsp;<span class="ident" id="8642621">nil</span>&nbsp;<span class="op" id="8642625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642629">t</span><span class="op" id="8642630">.</span><span class="ident" id="8642631">Fatalf</span><span class="op" id="8642637">(</span><span class="string" id="8642638">&#34;AUTH&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8642655">,</span>&nbsp;<span class="ident" id="8642657">err</span><span class="op" id="8642660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642667">if</span>&nbsp;<span class="ident" id="8642670">err</span>&nbsp;<span class="op" id="8642674">:=</span>&nbsp;<span class="ident" id="8642677">c</span><span class="op" id="8642678">.</span><span class="ident" id="8642679">Mail</span><span class="op" id="8642683">(</span><span class="string" id="8642684">&#34;user@gmail.com&#34;</span><span class="op" id="8642700">)</span><span class="op" id="8642701">;</span>&nbsp;<span class="ident" id="8642703">err</span>&nbsp;<span class="op" id="8642707">!=</span>&nbsp;<span class="ident" id="8642710">nil</span>&nbsp;<span class="op" id="8642714">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642718">t</span><span class="op" id="8642719">.</span><span class="ident" id="8642720">Fatalf</span><span class="op" id="8642726">(</span><span class="string" id="8642727">&#34;MAIL&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8642744">,</span>&nbsp;<span class="ident" id="8642746">err</span><span class="op" id="8642749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642755">if</span>&nbsp;<span class="ident" id="8642758">err</span>&nbsp;<span class="op" id="8642762">:=</span>&nbsp;<span class="ident" id="8642765">c</span><span class="op" id="8642766">.</span><span class="ident" id="8642767">Rcpt</span><span class="op" id="8642771">(</span><span class="string" id="8642772">&#34;golang-nuts@googlegroups.com&#34;</span><span class="op" id="8642802">)</span><span class="op" id="8642803">;</span>&nbsp;<span class="ident" id="8642805">err</span>&nbsp;<span class="op" id="8642809">!=</span>&nbsp;<span class="ident" id="8642812">nil</span>&nbsp;<span class="op" id="8642816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642820">t</span><span class="op" id="8642821">.</span><span class="ident" id="8642822">Fatalf</span><span class="op" id="8642828">(</span><span class="string" id="8642829">&#34;RCPT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8642846">,</span>&nbsp;<span class="ident" id="8642848">err</span><span class="op" id="8642851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642854">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642857">msg</span>&nbsp;<span class="op" id="8642861">:=</span>&nbsp;<span class="string" id="8642864">`From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno"></span>Line&nbsp;1<br>
<span class="lineno">165</span>.Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642981">w</span><span class="op" id="8642982">,</span>&nbsp;<span class="ident" id="8642984">err</span>&nbsp;<span class="op" id="8642988">:=</span>&nbsp;<span class="ident" id="8642991">c</span><span class="op" id="8642992">.</span><span class="ident" id="8642993">Data</span><span class="op" id="8642997">(</span><span class="op" id="8642998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8643001">if</span>&nbsp;<span class="ident" id="8643004">err</span>&nbsp;<span class="op" id="8643008">!=</span>&nbsp;<span class="ident" id="8643011">nil</span>&nbsp;<span class="op" id="8643015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8643019">t</span><span class="op" id="8643020">.</span><span class="ident" id="8643021">Fatalf</span><span class="op" id="8643027">(</span><span class="string" id="8643028">&#34;DATA&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8643045">,</span>&nbsp;<span class="ident" id="8643047">err</span><span class="op" id="8643050">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8643053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8643056">if</span>&nbsp;<span class="ident" id="8643059">_</span><span class="op" id="8643060">,</span>&nbsp;<span class="ident" id="8643062">err</span>&nbsp;<span class="op" id="8643066">:=</span>&nbsp;<span class="ident" id="8643069">w</span><span class="op" id="8643070">.</span><span class="ident" id="8643071">Write</span><span class="op" id="8643076">(</span><span class="op" id="8643077">[</span><span class="op" id="8643078">]</span><span class="builtintype" id="8643079">byte</span><span class="op" id="8643083">(</span><span class="ident" id="8643084">msg</span><span class="op" id="8643087">)</span><span class="op" id="8643088">)</span><span class="op" id="8643089">;</span>&nbsp;<span class="ident" id="8643091">err</span>&nbsp;<span class="op" id="8643095">!=</span>&nbsp;<span class="ident" id="8643098">nil</span>&nbsp;<span class="op" id="8643102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8643106">t</span><span class="op" id="8643107">.</span><span class="ident" id="8643108">Fatalf</span><span class="op" id="8643114">(</span><span class="string" id="8643115">&#34;Data&nbsp;write&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8643138">,</span>&nbsp;<span class="ident" id="8643140">err</span><span class="op" id="8643143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8643146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8643149">if</span>&nbsp;<span class="ident" id="8643152">err</span>&nbsp;<span class="op" id="8643156">:=</span>&nbsp;<span class="ident" id="8643159">w</span><span class="op" id="8643160">.</span><span class="ident" id="8643161">Close</span><span class="op" id="8643166">(</span><span class="op" id="8643167">)</span><span class="op" id="8643168">;</span>&nbsp;<span class="ident" id="8643170">err</span>&nbsp;<span class="op" id="8643174">!=</span>&nbsp;<span class="ident" id="8643177">nil</span>&nbsp;<span class="op" id="8643181">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8643185">t</span><span class="op" id="8643186">.</span><span class="ident" id="8643187">Fatalf</span><span class="op" id="8643193">(</span><span class="string" id="8643194">&#34;Bad&nbsp;data&nbsp;response:&nbsp;%s&#34;</span><span class="op" id="8643217">,</span>&nbsp;<span class="ident" id="8643219">err</span><span class="op" id="8643222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8643225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8643229">if</span>&nbsp;<span class="ident" id="8643232">err</span>&nbsp;<span class="op" id="8643236">:=</span>&nbsp;<span class="ident" id="8643239">c</span><span class="op" id="8643240">.</span><span class="ident" id="8643241">Quit</span><span class="op" id="8643245">(</span><span class="op" id="8643246">)</span><span class="op" id="8643247">;</span>&nbsp;<span class="ident" id="8643249">err</span>&nbsp;<span class="op" id="8643253">!=</span>&nbsp;<span class="ident" id="8643256">nil</span>&nbsp;<span class="op" id="8643260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8643264">t</span><span class="op" id="8643265">.</span><span class="ident" id="8643266">Fatalf</span><span class="op" id="8643272">(</span><span class="string" id="8643273">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8643290">,</span>&nbsp;<span class="ident" id="8643292">err</span><span class="op" id="8643295">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8643298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8643302">bcmdbuf</span><span class="op" id="8643309">.</span><span class="ident" id="8643310">Flush</span><span class="op" id="8643315">(</span><span class="op" id="8643316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8643319">actualcmds</span>&nbsp;<span class="op" id="8643330">:=</span>&nbsp;<span class="ident" id="8643333">cmdbuf</span><span class="op" id="8643339">.</span><span class="ident" id="8643340">String</span><span class="op" id="8643346">(</span><span class="op" id="8643347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8643350">if</span>&nbsp;<span class="ident" id="8643353">client</span>&nbsp;<span class="op" id="8643360">!=</span>&nbsp;<span class="ident" id="8643363">actualcmds</span>&nbsp;<span class="op" id="8643374">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8643378">t</span><span class="op" id="8643379">.</span><span class="ident" id="8643380">Fatalf</span><span class="op" id="8643386">(</span><span class="string" id="8643387">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8643412">,</span>&nbsp;<span class="ident" id="8643414">actualcmds</span><span class="op" id="8643424">,</span>&nbsp;<span class="ident" id="8643426">client</span><span class="op" id="8643432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8643435">}</span><br>
<span class="lineno"></span><span class="op" id="8643437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8643440">var</span>&nbsp;<span class="ident" id="8643444">basicServer</span>&nbsp;<span class="op" id="8643456">=</span>&nbsp;<span class="string" id="8643458">`250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno">190</span>502&nbsp;Unrecognized&nbsp;command.<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">195</span>530&nbsp;Authentication&nbsp;required<br>
<span class="lineno"></span>252&nbsp;Send&nbsp;some&nbsp;mail,&nbsp;I&#39;ll&nbsp;try&nbsp;my&nbsp;best<br>
<span class="lineno"></span>250&nbsp;User&nbsp;is&nbsp;valid<br>
<span class="lineno"></span>235&nbsp;Accepted<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;OK<br>
<span class="lineno">200</span>250&nbsp;Receiver&nbsp;OK<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;OK<br>
<span class="lineno"></span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="8643766">var</span>&nbsp;<span class="ident" id="8643770">basicClient</span>&nbsp;<span class="op" id="8643782">=</span>&nbsp;<span class="string" id="8643784">`HELO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno">210</span>VRFY&nbsp;user1@gmail.com<br>
<span class="lineno"></span>VRFY&nbsp;user2@gmail.com<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;golang-nuts@googlegroups.com&gt;<br>
<span class="lineno">215</span>DATA<br>
<span class="lineno"></span>From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno">220</span>Line&nbsp;1<br>
<span class="lineno"></span>..Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">225</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8644151">func</span>&nbsp;<span class="ident" id="8644156">TestNewClient</span><span class="op" id="8644169">(</span><span class="ident" id="8644170">t</span>&nbsp;<span class="op" id="8644172">*</span><span class="ident" id="8644173">testing</span><span class="op" id="8644180">.</span><span class="ident" id="8644181">T</span><span class="op" id="8644182">)</span>&nbsp;<span class="op" id="8644184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8644187">server</span>&nbsp;<span class="op" id="8644194">:=</span>&nbsp;<span class="ident" id="8644197">strings</span><span class="op" id="8644204">.</span><span class="ident" id="8644205">Join</span><span class="op" id="8644209">(</span><span class="ident" id="8644210">strings</span><span class="op" id="8644217">.</span><span class="ident" id="8644218">Split</span><span class="op" id="8644223">(</span><span class="ident" id="8644224">newClientServer</span><span class="op" id="8644239">,</span>&nbsp;<span class="string" id="8644241">&#34;\n&#34;</span><span class="op" id="8644245">)</span><span class="op" id="8644246">,</span>&nbsp;<span class="string" id="8644248">&#34;\r\n&#34;</span><span class="op" id="8644254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8644257">client</span>&nbsp;<span class="op" id="8644264">:=</span>&nbsp;<span class="ident" id="8644267">strings</span><span class="op" id="8644274">.</span><span class="ident" id="8644275">Join</span><span class="op" id="8644279">(</span><span class="ident" id="8644280">strings</span><span class="op" id="8644287">.</span><span class="ident" id="8644288">Split</span><span class="op" id="8644293">(</span><span class="ident" id="8644294">newClientClient</span><span class="op" id="8644309">,</span>&nbsp;<span class="string" id="8644311">&#34;\n&#34;</span><span class="op" id="8644315">)</span><span class="op" id="8644316">,</span>&nbsp;<span class="string" id="8644318">&#34;\r\n&#34;</span><span class="op" id="8644324">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8644328">var</span>&nbsp;<span class="ident" id="8644332">cmdbuf</span>&nbsp;<span class="ident" id="8644339">bytes</span><span class="op" id="8644344">.</span><span class="ident" id="8644345">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8644353">bcmdbuf</span>&nbsp;<span class="op" id="8644361">:=</span>&nbsp;<span class="ident" id="8644364">bufio</span><span class="op" id="8644369">.</span><span class="ident" id="8644370">NewWriter</span><span class="op" id="8644379">(</span><span class="op" id="8644380">&amp;</span><span class="ident" id="8644381">cmdbuf</span><span class="op" id="8644387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8644390">out</span>&nbsp;<span class="op" id="8644394">:=</span>&nbsp;<span class="keyword" id="8644397">func</span><span class="op" id="8644401">(</span><span class="op" id="8644402">)</span>&nbsp;<span class="builtintype" id="8644404">string</span>&nbsp;<span class="op" id="8644411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8644415">bcmdbuf</span><span class="op" id="8644422">.</span><span class="ident" id="8644423">Flush</span><span class="op" id="8644428">(</span><span class="op" id="8644429">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8644433">return</span>&nbsp;<span class="ident" id="8644440">cmdbuf</span><span class="op" id="8644446">.</span><span class="ident" id="8644447">String</span><span class="op" id="8644453">(</span><span class="op" id="8644454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8644457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8644460">var</span>&nbsp;<span class="ident" id="8644464">fake</span>&nbsp;<span class="ident" id="8644469">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8644476">fake</span><span class="op" id="8644480">.</span><span class="ident" id="8644481">ReadWriter</span>&nbsp;<span class="op" id="8644492">=</span>&nbsp;<span class="ident" id="8644494">bufio</span><span class="op" id="8644499">.</span><span class="ident" id="8644500">NewReadWriter</span><span class="op" id="8644513">(</span><span class="ident" id="8644514">bufio</span><span class="op" id="8644519">.</span><span class="ident" id="8644520">NewReader</span><span class="op" id="8644529">(</span><span class="ident" id="8644530">strings</span><span class="op" id="8644537">.</span><span class="ident" id="8644538">NewReader</span><span class="op" id="8644547">(</span><span class="ident" id="8644548">server</span><span class="op" id="8644554">)</span><span class="op" id="8644555">)</span><span class="op" id="8644556">,</span>&nbsp;<span class="ident" id="8644558">bcmdbuf</span><span class="op" id="8644565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8644568">c</span><span class="op" id="8644569">,</span>&nbsp;<span class="ident" id="8644571">err</span>&nbsp;<span class="op" id="8644575">:=</span>&nbsp;<span class="ident" id="8644578">NewClient</span><span class="op" id="8644587">(</span><span class="ident" id="8644588">fake</span><span class="op" id="8644592">,</span>&nbsp;<span class="string" id="8644594">&#34;fake.host&#34;</span><span class="op" id="8644605">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8644608">if</span>&nbsp;<span class="ident" id="8644611">err</span>&nbsp;<span class="op" id="8644615">!=</span>&nbsp;<span class="ident" id="8644618">nil</span>&nbsp;<span class="op" id="8644622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8644626">t</span><span class="op" id="8644627">.</span><span class="ident" id="8644628">Fatalf</span><span class="op" id="8644634">(</span><span class="string" id="8644635">&#34;NewClient:&nbsp;%v\n(after&nbsp;%v)&#34;</span><span class="op" id="8644662">,</span>&nbsp;<span class="ident" id="8644664">err</span><span class="op" id="8644667">,</span>&nbsp;<span class="ident" id="8644669">out</span><span class="op" id="8644672">(</span><span class="op" id="8644673">)</span><span class="op" id="8644674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8644677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8644680">defer</span>&nbsp;<span class="ident" id="8644686">c</span><span class="op" id="8644687">.</span><span class="ident" id="8644688">Close</span><span class="op" id="8644693">(</span><span class="op" id="8644694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8644697">if</span>&nbsp;<span class="ident" id="8644700">ok</span><span class="op" id="8644702">,</span>&nbsp;<span class="ident" id="8644704">args</span>&nbsp;<span class="op" id="8644709">:=</span>&nbsp;<span class="ident" id="8644712">c</span><span class="op" id="8644713">.</span><span class="ident" id="8644714">Extension</span><span class="op" id="8644723">(</span><span class="string" id="8644724">&#34;aUtH&#34;</span><span class="op" id="8644730">)</span><span class="op" id="8644731">;</span>&nbsp;<span class="op" id="8644733">!</span><span class="ident" id="8644734">ok</span>&nbsp;<span class="op" id="8644737">||</span>&nbsp;<span class="ident" id="8644740">args</span>&nbsp;<span class="op" id="8644745">!=</span>&nbsp;<span class="string" id="8644748">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="8644762">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8644766">t</span><span class="op" id="8644767">.</span><span class="ident" id="8644768">Fatalf</span><span class="op" id="8644774">(</span><span class="string" id="8644775">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="8644800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8644803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8644806">if</span>&nbsp;<span class="ident" id="8644809">ok</span><span class="op" id="8644811">,</span>&nbsp;<span class="ident" id="8644813">_</span>&nbsp;<span class="op" id="8644815">:=</span>&nbsp;<span class="ident" id="8644818">c</span><span class="op" id="8644819">.</span><span class="ident" id="8644820">Extension</span><span class="op" id="8644829">(</span><span class="string" id="8644830">&#34;DSN&#34;</span><span class="op" id="8644835">)</span><span class="op" id="8644836">;</span>&nbsp;<span class="ident" id="8644838">ok</span>&nbsp;<span class="op" id="8644841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8644845">t</span><span class="op" id="8644846">.</span><span class="ident" id="8644847">Fatalf</span><span class="op" id="8644853">(</span><span class="string" id="8644854">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="8644877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8644880">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8644883">if</span>&nbsp;<span class="ident" id="8644886">err</span>&nbsp;<span class="op" id="8644890">:=</span>&nbsp;<span class="ident" id="8644893">c</span><span class="op" id="8644894">.</span><span class="ident" id="8644895">Quit</span><span class="op" id="8644899">(</span><span class="op" id="8644900">)</span><span class="op" id="8644901">;</span>&nbsp;<span class="ident" id="8644903">err</span>&nbsp;<span class="op" id="8644907">!=</span>&nbsp;<span class="ident" id="8644910">nil</span>&nbsp;<span class="op" id="8644914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8644918">t</span><span class="op" id="8644919">.</span><span class="ident" id="8644920">Fatalf</span><span class="op" id="8644926">(</span><span class="string" id="8644927">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8644944">,</span>&nbsp;<span class="ident" id="8644946">err</span><span class="op" id="8644949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8644952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8644956">actualcmds</span>&nbsp;<span class="op" id="8644967">:=</span>&nbsp;<span class="ident" id="8644970">out</span><span class="op" id="8644973">(</span><span class="op" id="8644974">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8644977">if</span>&nbsp;<span class="ident" id="8644980">client</span>&nbsp;<span class="op" id="8644987">!=</span>&nbsp;<span class="ident" id="8644990">actualcmds</span>&nbsp;<span class="op" id="8645001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8645005">t</span><span class="op" id="8645006">.</span><span class="ident" id="8645007">Fatalf</span><span class="op" id="8645013">(</span><span class="string" id="8645014">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8645039">,</span>&nbsp;<span class="ident" id="8645041">actualcmds</span><span class="op" id="8645051">,</span>&nbsp;<span class="ident" id="8645053">client</span><span class="op" id="8645059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8645062">}</span><br>
<span class="lineno"></span><span class="op" id="8645064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword" id="8645067">var</span>&nbsp;<span class="ident" id="8645071">newClientServer</span>&nbsp;<span class="op" id="8645087">=</span>&nbsp;<span class="string" id="8645089">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">265</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8645202">var</span>&nbsp;<span class="ident" id="8645206">newClientClient</span>&nbsp;<span class="op" id="8645222">=</span>&nbsp;<span class="string" id="8645224">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">270</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8645248">func</span>&nbsp;<span class="ident" id="8645253">TestNewClient2</span><span class="op" id="8645267">(</span><span class="ident" id="8645268">t</span>&nbsp;<span class="op" id="8645270">*</span><span class="ident" id="8645271">testing</span><span class="op" id="8645278">.</span><span class="ident" id="8645279">T</span><span class="op" id="8645280">)</span>&nbsp;<span class="op" id="8645282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8645285">server</span>&nbsp;<span class="op" id="8645292">:=</span>&nbsp;<span class="ident" id="8645295">strings</span><span class="op" id="8645302">.</span><span class="ident" id="8645303">Join</span><span class="op" id="8645307">(</span><span class="ident" id="8645308">strings</span><span class="op" id="8645315">.</span><span class="ident" id="8645316">Split</span><span class="op" id="8645321">(</span><span class="ident" id="8645322">newClient2Server</span><span class="op" id="8645338">,</span>&nbsp;<span class="string" id="8645340">&#34;\n&#34;</span><span class="op" id="8645344">)</span><span class="op" id="8645345">,</span>&nbsp;<span class="string" id="8645347">&#34;\r\n&#34;</span><span class="op" id="8645353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8645356">client</span>&nbsp;<span class="op" id="8645363">:=</span>&nbsp;<span class="ident" id="8645366">strings</span><span class="op" id="8645373">.</span><span class="ident" id="8645374">Join</span><span class="op" id="8645378">(</span><span class="ident" id="8645379">strings</span><span class="op" id="8645386">.</span><span class="ident" id="8645387">Split</span><span class="op" id="8645392">(</span><span class="ident" id="8645393">newClient2Client</span><span class="op" id="8645409">,</span>&nbsp;<span class="string" id="8645411">&#34;\n&#34;</span><span class="op" id="8645415">)</span><span class="op" id="8645416">,</span>&nbsp;<span class="string" id="8645418">&#34;\r\n&#34;</span><span class="op" id="8645424">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8645428">var</span>&nbsp;<span class="ident" id="8645432">cmdbuf</span>&nbsp;<span class="ident" id="8645439">bytes</span><span class="op" id="8645444">.</span><span class="ident" id="8645445">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8645453">bcmdbuf</span>&nbsp;<span class="op" id="8645461">:=</span>&nbsp;<span class="ident" id="8645464">bufio</span><span class="op" id="8645469">.</span><span class="ident" id="8645470">NewWriter</span><span class="op" id="8645479">(</span><span class="op" id="8645480">&amp;</span><span class="ident" id="8645481">cmdbuf</span><span class="op" id="8645487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8645490">var</span>&nbsp;<span class="ident" id="8645494">fake</span>&nbsp;<span class="ident" id="8645499">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8645506">fake</span><span class="op" id="8645510">.</span><span class="ident" id="8645511">ReadWriter</span>&nbsp;<span class="op" id="8645522">=</span>&nbsp;<span class="ident" id="8645524">bufio</span><span class="op" id="8645529">.</span><span class="ident" id="8645530">NewReadWriter</span><span class="op" id="8645543">(</span><span class="ident" id="8645544">bufio</span><span class="op" id="8645549">.</span><span class="ident" id="8645550">NewReader</span><span class="op" id="8645559">(</span><span class="ident" id="8645560">strings</span><span class="op" id="8645567">.</span><span class="ident" id="8645568">NewReader</span><span class="op" id="8645577">(</span><span class="ident" id="8645578">server</span><span class="op" id="8645584">)</span><span class="op" id="8645585">)</span><span class="op" id="8645586">,</span>&nbsp;<span class="ident" id="8645588">bcmdbuf</span><span class="op" id="8645595">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8645598">c</span><span class="op" id="8645599">,</span>&nbsp;<span class="ident" id="8645601">err</span>&nbsp;<span class="op" id="8645605">:=</span>&nbsp;<span class="ident" id="8645608">NewClient</span><span class="op" id="8645617">(</span><span class="ident" id="8645618">fake</span><span class="op" id="8645622">,</span>&nbsp;<span class="string" id="8645624">&#34;fake.host&#34;</span><span class="op" id="8645635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8645638">if</span>&nbsp;<span class="ident" id="8645641">err</span>&nbsp;<span class="op" id="8645645">!=</span>&nbsp;<span class="ident" id="8645648">nil</span>&nbsp;<span class="op" id="8645652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8645656">t</span><span class="op" id="8645657">.</span><span class="ident" id="8645658">Fatalf</span><span class="op" id="8645664">(</span><span class="string" id="8645665">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="8645680">,</span>&nbsp;<span class="ident" id="8645682">err</span><span class="op" id="8645685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8645688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8645691">defer</span>&nbsp;<span class="ident" id="8645697">c</span><span class="op" id="8645698">.</span><span class="ident" id="8645699">Close</span><span class="op" id="8645704">(</span><span class="op" id="8645705">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8645708">if</span>&nbsp;<span class="ident" id="8645711">ok</span><span class="op" id="8645713">,</span>&nbsp;<span class="ident" id="8645715">_</span>&nbsp;<span class="op" id="8645717">:=</span>&nbsp;<span class="ident" id="8645720">c</span><span class="op" id="8645721">.</span><span class="ident" id="8645722">Extension</span><span class="op" id="8645731">(</span><span class="string" id="8645732">&#34;DSN&#34;</span><span class="op" id="8645737">)</span><span class="op" id="8645738">;</span>&nbsp;<span class="ident" id="8645740">ok</span>&nbsp;<span class="op" id="8645743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8645747">t</span><span class="op" id="8645748">.</span><span class="ident" id="8645749">Fatalf</span><span class="op" id="8645755">(</span><span class="string" id="8645756">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="8645779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8645782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8645785">if</span>&nbsp;<span class="ident" id="8645788">err</span>&nbsp;<span class="op" id="8645792">:=</span>&nbsp;<span class="ident" id="8645795">c</span><span class="op" id="8645796">.</span><span class="ident" id="8645797">Quit</span><span class="op" id="8645801">(</span><span class="op" id="8645802">)</span><span class="op" id="8645803">;</span>&nbsp;<span class="ident" id="8645805">err</span>&nbsp;<span class="op" id="8645809">!=</span>&nbsp;<span class="ident" id="8645812">nil</span>&nbsp;<span class="op" id="8645816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8645820">t</span><span class="op" id="8645821">.</span><span class="ident" id="8645822">Fatalf</span><span class="op" id="8645828">(</span><span class="string" id="8645829">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8645846">,</span>&nbsp;<span class="ident" id="8645848">err</span><span class="op" id="8645851">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8645854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8645858">bcmdbuf</span><span class="op" id="8645865">.</span><span class="ident" id="8645866">Flush</span><span class="op" id="8645871">(</span><span class="op" id="8645872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8645875">actualcmds</span>&nbsp;<span class="op" id="8645886">:=</span>&nbsp;<span class="ident" id="8645889">cmdbuf</span><span class="op" id="8645895">.</span><span class="ident" id="8645896">String</span><span class="op" id="8645902">(</span><span class="op" id="8645903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8645906">if</span>&nbsp;<span class="ident" id="8645909">client</span>&nbsp;<span class="op" id="8645916">!=</span>&nbsp;<span class="ident" id="8645919">actualcmds</span>&nbsp;<span class="op" id="8645930">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8645934">t</span><span class="op" id="8645935">.</span><span class="ident" id="8645936">Fatalf</span><span class="op" id="8645942">(</span><span class="string" id="8645943">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8645968">,</span>&nbsp;<span class="ident" id="8645970">actualcmds</span><span class="op" id="8645980">,</span>&nbsp;<span class="ident" id="8645982">client</span><span class="op" id="8645988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8645991">}</span><br>
<span class="lineno"></span><span class="op" id="8645993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8645996">var</span>&nbsp;<span class="ident" id="8646000">newClient2Server</span>&nbsp;<span class="op" id="8646017">=</span>&nbsp;<span class="string" id="8646019">`220&nbsp;hello&nbsp;world<br>
<span class="lineno">300</span>502&nbsp;EH?<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">305</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8646140">var</span>&nbsp;<span class="ident" id="8646144">newClient2Client</span>&nbsp;<span class="op" id="8646161">=</span>&nbsp;<span class="string" id="8646163">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno">310</span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8646202">func</span>&nbsp;<span class="ident" id="8646207">TestHello</span><span class="op" id="8646216">(</span><span class="ident" id="8646217">t</span>&nbsp;<span class="op" id="8646219">*</span><span class="ident" id="8646220">testing</span><span class="op" id="8646227">.</span><span class="ident" id="8646228">T</span><span class="op" id="8646229">)</span>&nbsp;<span class="op" id="8646231">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8646235">if</span>&nbsp;<span class="builtinfunc" id="8646238">len</span><span class="op" id="8646241">(</span><span class="ident" id="8646242">helloServer</span><span class="op" id="8646253">)</span>&nbsp;<span class="op" id="8646255">!=</span>&nbsp;<span class="builtinfunc" id="8646258">len</span><span class="op" id="8646261">(</span><span class="ident" id="8646262">helloClient</span><span class="op" id="8646273">)</span>&nbsp;<span class="op" id="8646275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8646279">t</span><span class="op" id="8646280">.</span><span class="ident" id="8646281">Fatalf</span><span class="op" id="8646287">(</span><span class="string" id="8646288">&#34;Hello&nbsp;server&nbsp;and&nbsp;client&nbsp;size&nbsp;mismatch&#34;</span><span class="op" id="8646327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8646330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8646334">for</span>&nbsp;<span class="ident" id="8646338">i</span>&nbsp;<span class="op" id="8646340">:=</span>&nbsp;<span class="num" id="8646343">0</span><span class="op" id="8646344">;</span>&nbsp;<span class="ident" id="8646346">i</span>&nbsp;<span class="op" id="8646348">&lt;</span>&nbsp;<span class="builtinfunc" id="8646350">len</span><span class="op" id="8646353">(</span><span class="ident" id="8646354">helloServer</span><span class="op" id="8646365">)</span><span class="op" id="8646366">;</span>&nbsp;<span class="ident" id="8646368">i</span><span class="op" id="8646369">++</span>&nbsp;<span class="op" id="8646372">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8646376">server</span>&nbsp;<span class="op" id="8646383">:=</span>&nbsp;<span class="ident" id="8646386">strings</span><span class="op" id="8646393">.</span><span class="ident" id="8646394">Join</span><span class="op" id="8646398">(</span><span class="ident" id="8646399">strings</span><span class="op" id="8646406">.</span><span class="ident" id="8646407">Split</span><span class="op" id="8646412">(</span><span class="ident" id="8646413">baseHelloServer</span><span class="op" id="8646428">+</span><span class="ident" id="8646429">helloServer</span><span class="op" id="8646440">[</span><span class="ident" id="8646441">i</span><span class="op" id="8646442">]</span><span class="op" id="8646443">,</span>&nbsp;<span class="string" id="8646445">&#34;\n&#34;</span><span class="op" id="8646449">)</span><span class="op" id="8646450">,</span>&nbsp;<span class="string" id="8646452">&#34;\r\n&#34;</span><span class="op" id="8646458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8646462">client</span>&nbsp;<span class="op" id="8646469">:=</span>&nbsp;<span class="ident" id="8646472">strings</span><span class="op" id="8646479">.</span><span class="ident" id="8646480">Join</span><span class="op" id="8646484">(</span><span class="ident" id="8646485">strings</span><span class="op" id="8646492">.</span><span class="ident" id="8646493">Split</span><span class="op" id="8646498">(</span><span class="ident" id="8646499">baseHelloClient</span><span class="op" id="8646514">+</span><span class="ident" id="8646515">helloClient</span><span class="op" id="8646526">[</span><span class="ident" id="8646527">i</span><span class="op" id="8646528">]</span><span class="op" id="8646529">,</span>&nbsp;<span class="string" id="8646531">&#34;\n&#34;</span><span class="op" id="8646535">)</span><span class="op" id="8646536">,</span>&nbsp;<span class="string" id="8646538">&#34;\r\n&#34;</span><span class="op" id="8646544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8646548">var</span>&nbsp;<span class="ident" id="8646552">cmdbuf</span>&nbsp;<span class="ident" id="8646559">bytes</span><span class="op" id="8646564">.</span><span class="ident" id="8646565">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8646574">bcmdbuf</span>&nbsp;<span class="op" id="8646582">:=</span>&nbsp;<span class="ident" id="8646585">bufio</span><span class="op" id="8646590">.</span><span class="ident" id="8646591">NewWriter</span><span class="op" id="8646600">(</span><span class="op" id="8646601">&amp;</span><span class="ident" id="8646602">cmdbuf</span><span class="op" id="8646608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8646612">var</span>&nbsp;<span class="ident" id="8646616">fake</span>&nbsp;<span class="ident" id="8646621">faker</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8646629">fake</span><span class="op" id="8646633">.</span><span class="ident" id="8646634">ReadWriter</span>&nbsp;<span class="op" id="8646645">=</span>&nbsp;<span class="ident" id="8646647">bufio</span><span class="op" id="8646652">.</span><span class="ident" id="8646653">NewReadWriter</span><span class="op" id="8646666">(</span><span class="ident" id="8646667">bufio</span><span class="op" id="8646672">.</span><span class="ident" id="8646673">NewReader</span><span class="op" id="8646682">(</span><span class="ident" id="8646683">strings</span><span class="op" id="8646690">.</span><span class="ident" id="8646691">NewReader</span><span class="op" id="8646700">(</span><span class="ident" id="8646701">server</span><span class="op" id="8646707">)</span><span class="op" id="8646708">)</span><span class="op" id="8646709">,</span>&nbsp;<span class="ident" id="8646711">bcmdbuf</span><span class="op" id="8646718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8646722">c</span><span class="op" id="8646723">,</span>&nbsp;<span class="ident" id="8646725">err</span>&nbsp;<span class="op" id="8646729">:=</span>&nbsp;<span class="ident" id="8646732">NewClient</span><span class="op" id="8646741">(</span><span class="ident" id="8646742">fake</span><span class="op" id="8646746">,</span>&nbsp;<span class="string" id="8646748">&#34;fake.host&#34;</span><span class="op" id="8646759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8646763">if</span>&nbsp;<span class="ident" id="8646766">err</span>&nbsp;<span class="op" id="8646770">!=</span>&nbsp;<span class="ident" id="8646773">nil</span>&nbsp;<span class="op" id="8646777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8646782">t</span><span class="op" id="8646783">.</span><span class="ident" id="8646784">Fatalf</span><span class="op" id="8646790">(</span><span class="string" id="8646791">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="8646806">,</span>&nbsp;<span class="ident" id="8646808">err</span><span class="op" id="8646811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8646815">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8646819">defer</span>&nbsp;<span class="ident" id="8646825">c</span><span class="op" id="8646826">.</span><span class="ident" id="8646827">Close</span><span class="op" id="8646832">(</span><span class="op" id="8646833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8646837">c</span><span class="op" id="8646838">.</span><span class="ident" id="8646839">localName</span>&nbsp;<span class="op" id="8646849">=</span>&nbsp;<span class="string" id="8646851">&#34;customhost&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8646866">err</span>&nbsp;<span class="op" id="8646870">=</span>&nbsp;<span class="ident" id="8646872">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8646879">switch</span>&nbsp;<span class="ident" id="8646886">i</span>&nbsp;<span class="op" id="8646888">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8646892">case</span>&nbsp;<span class="num" id="8646897">0</span><span class="op" id="8646898">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8646903">err</span>&nbsp;<span class="op" id="8646907">=</span>&nbsp;<span class="ident" id="8646909">c</span><span class="op" id="8646910">.</span><span class="ident" id="8646911">Hello</span><span class="op" id="8646916">(</span><span class="string" id="8646917">&#34;customhost&#34;</span><span class="op" id="8646929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8646933">case</span>&nbsp;<span class="num" id="8646938">1</span><span class="op" id="8646939">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8646944">err</span>&nbsp;<span class="op" id="8646948">=</span>&nbsp;<span class="ident" id="8646950">c</span><span class="op" id="8646951">.</span><span class="ident" id="8646952">StartTLS</span><span class="op" id="8646960">(</span><span class="ident" id="8646961">nil</span><span class="op" id="8646964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8646969">if</span>&nbsp;<span class="ident" id="8646972">err</span><span class="op" id="8646975">.</span><span class="ident" id="8646976">Error</span><span class="op" id="8646981">(</span><span class="op" id="8646982">)</span>&nbsp;<span class="op" id="8646984">==</span>&nbsp;<span class="string" id="8646987">&#34;502&nbsp;Not&nbsp;implemented&#34;</span>&nbsp;<span class="op" id="8647009">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647015">err</span>&nbsp;<span class="op" id="8647019">=</span>&nbsp;<span class="ident" id="8647021">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8647028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8647032">case</span>&nbsp;<span class="num" id="8647037">2</span><span class="op" id="8647038">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647043">err</span>&nbsp;<span class="op" id="8647047">=</span>&nbsp;<span class="ident" id="8647049">c</span><span class="op" id="8647050">.</span><span class="ident" id="8647051">Verify</span><span class="op" id="8647057">(</span><span class="string" id="8647058">&#34;test@example.com&#34;</span><span class="op" id="8647076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8647080">case</span>&nbsp;<span class="num" id="8647085">3</span><span class="op" id="8647086">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647091">c</span><span class="op" id="8647092">.</span><span class="ident" id="8647093">tls</span>&nbsp;<span class="op" id="8647097">=</span>&nbsp;<span class="builtintype" id="8647099">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647107">c</span><span class="op" id="8647108">.</span><span class="ident" id="8647109">serverName</span>&nbsp;<span class="op" id="8647120">=</span>&nbsp;<span class="string" id="8647122">&#34;smtp.google.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647143">err</span>&nbsp;<span class="op" id="8647147">=</span>&nbsp;<span class="ident" id="8647149">c</span><span class="op" id="8647150">.</span><span class="ident" id="8647151">Auth</span><span class="op" id="8647155">(</span><span class="ident" id="8647156">PlainAuth</span><span class="op" id="8647165">(</span><span class="string" id="8647166">&#34;&#34;</span><span class="op" id="8647168">,</span>&nbsp;<span class="string" id="8647170">&#34;user&#34;</span><span class="op" id="8647176">,</span>&nbsp;<span class="string" id="8647178">&#34;pass&#34;</span><span class="op" id="8647184">,</span>&nbsp;<span class="string" id="8647186">&#34;smtp.google.com&#34;</span><span class="op" id="8647203">)</span><span class="op" id="8647204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8647208">case</span>&nbsp;<span class="num" id="8647213">4</span><span class="op" id="8647214">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647219">err</span>&nbsp;<span class="op" id="8647223">=</span>&nbsp;<span class="ident" id="8647225">c</span><span class="op" id="8647226">.</span><span class="ident" id="8647227">Mail</span><span class="op" id="8647231">(</span><span class="string" id="8647232">&#34;test@example.com&#34;</span><span class="op" id="8647250">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8647254">case</span>&nbsp;<span class="num" id="8647259">5</span><span class="op" id="8647260">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647265">ok</span><span class="op" id="8647267">,</span>&nbsp;<span class="ident" id="8647269">_</span>&nbsp;<span class="op" id="8647271">:=</span>&nbsp;<span class="ident" id="8647274">c</span><span class="op" id="8647275">.</span><span class="ident" id="8647276">Extension</span><span class="op" id="8647285">(</span><span class="string" id="8647286">&#34;feature&#34;</span><span class="op" id="8647295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8647300">if</span>&nbsp;<span class="ident" id="8647303">ok</span>&nbsp;<span class="op" id="8647306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647312">t</span><span class="op" id="8647313">.</span><span class="ident" id="8647314">Errorf</span><span class="op" id="8647320">(</span><span class="string" id="8647321">&#34;Expected&nbsp;FEATURE&nbsp;not&nbsp;to&nbsp;be&nbsp;supported&#34;</span><span class="op" id="8647359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8647364">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8647368">case</span>&nbsp;<span class="num" id="8647373">6</span><span class="op" id="8647374">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647379">err</span>&nbsp;<span class="op" id="8647383">=</span>&nbsp;<span class="ident" id="8647385">c</span><span class="op" id="8647386">.</span><span class="ident" id="8647387">Reset</span><span class="op" id="8647392">(</span><span class="op" id="8647393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8647397">case</span>&nbsp;<span class="num" id="8647402">7</span><span class="op" id="8647403">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647408">err</span>&nbsp;<span class="op" id="8647412">=</span>&nbsp;<span class="ident" id="8647414">c</span><span class="op" id="8647415">.</span><span class="ident" id="8647416">Quit</span><span class="op" id="8647420">(</span><span class="op" id="8647421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8647425">case</span>&nbsp;<span class="num" id="8647430">8</span><span class="op" id="8647431">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647436">err</span>&nbsp;<span class="op" id="8647440">=</span>&nbsp;<span class="ident" id="8647442">c</span><span class="op" id="8647443">.</span><span class="ident" id="8647444">Verify</span><span class="op" id="8647450">(</span><span class="string" id="8647451">&#34;test@example.com&#34;</span><span class="op" id="8647469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8647474">if</span>&nbsp;<span class="ident" id="8647477">err</span>&nbsp;<span class="op" id="8647481">!=</span>&nbsp;<span class="ident" id="8647484">nil</span>&nbsp;<span class="op" id="8647488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647494">err</span>&nbsp;<span class="op" id="8647498">=</span>&nbsp;<span class="ident" id="8647500">c</span><span class="op" id="8647501">.</span><span class="ident" id="8647502">Hello</span><span class="op" id="8647507">(</span><span class="string" id="8647508">&#34;customhost&#34;</span><span class="op" id="8647520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8647526">if</span>&nbsp;<span class="ident" id="8647529">err</span>&nbsp;<span class="op" id="8647533">!=</span>&nbsp;<span class="ident" id="8647536">nil</span>&nbsp;<span class="op" id="8647540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647547">t</span><span class="op" id="8647548">.</span><span class="ident" id="8647549">Errorf</span><span class="op" id="8647555">(</span><span class="string" id="8647556">&#34;Want&nbsp;error,&nbsp;got&nbsp;none&#34;</span><span class="op" id="8647578">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8647584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8647589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8647593">default</span><span class="op" id="8647600">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647605">t</span><span class="op" id="8647606">.</span><span class="ident" id="8647607">Fatalf</span><span class="op" id="8647613">(</span><span class="string" id="8647614">&#34;Unhandled&nbsp;command&#34;</span><span class="op" id="8647633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8647637">}</span><br>
<span class="lineno">370</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8647642">if</span>&nbsp;<span class="ident" id="8647645">err</span>&nbsp;<span class="op" id="8647649">!=</span>&nbsp;<span class="ident" id="8647652">nil</span>&nbsp;<span class="op" id="8647656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647661">t</span><span class="op" id="8647662">.</span><span class="ident" id="8647663">Errorf</span><span class="op" id="8647669">(</span><span class="string" id="8647670">&#34;Command&nbsp;%d&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8647693">,</span>&nbsp;<span class="ident" id="8647695">i</span><span class="op" id="8647696">,</span>&nbsp;<span class="ident" id="8647698">err</span><span class="op" id="8647701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8647705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647710">bcmdbuf</span><span class="op" id="8647717">.</span><span class="ident" id="8647718">Flush</span><span class="op" id="8647723">(</span><span class="op" id="8647724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647728">actualcmds</span>&nbsp;<span class="op" id="8647739">:=</span>&nbsp;<span class="ident" id="8647742">cmdbuf</span><span class="op" id="8647748">.</span><span class="ident" id="8647749">String</span><span class="op" id="8647755">(</span><span class="op" id="8647756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8647760">if</span>&nbsp;<span class="ident" id="8647763">client</span>&nbsp;<span class="op" id="8647770">!=</span>&nbsp;<span class="ident" id="8647773">actualcmds</span>&nbsp;<span class="op" id="8647784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8647789">t</span><span class="op" id="8647790">.</span><span class="ident" id="8647791">Errorf</span><span class="op" id="8647797">(</span><span class="string" id="8647798">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8647823">,</span>&nbsp;<span class="ident" id="8647825">actualcmds</span><span class="op" id="8647835">,</span>&nbsp;<span class="ident" id="8647837">client</span><span class="op" id="8647843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8647847">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8647850">}</span><br>
<span class="lineno"></span><span class="op" id="8647852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8647855">var</span>&nbsp;<span class="ident" id="8647859">baseHelloServer</span>&nbsp;<span class="op" id="8647875">=</span>&nbsp;<span class="string" id="8647877">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno">385</span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;FEATURE<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8647951">var</span>&nbsp;<span class="ident" id="8647955">helloServer</span>&nbsp;<span class="op" id="8647967">=</span>&nbsp;<span class="op" id="8647969">[</span><span class="op" id="8647970">]</span><span class="builtintype" id="8647971">string</span><span class="op" id="8647977">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8647980">&#34;&#34;</span><span class="op" id="8647982">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8647985">&#34;502&nbsp;Not&nbsp;implemented\n&#34;</span><span class="op" id="8648008">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648011">&#34;250&nbsp;User&nbsp;is&nbsp;valid\n&#34;</span><span class="op" id="8648032">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648035">&#34;235&nbsp;Accepted\n&#34;</span><span class="op" id="8648051">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648054">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="8648071">,</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648074">&#34;&#34;</span><span class="op" id="8648076">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648079">&#34;250&nbsp;Reset&nbsp;ok\n&#34;</span><span class="op" id="8648095">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648098">&#34;221&nbsp;Goodbye\n&#34;</span><span class="op" id="8648113">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648116">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="8648133">,</span><br>
<span class="lineno"></span><span class="op" id="8648135">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="8648138">var</span>&nbsp;<span class="ident" id="8648142">baseHelloClient</span>&nbsp;<span class="op" id="8648158">=</span>&nbsp;<span class="string" id="8648160">`EHLO&nbsp;customhost<br>
<span class="lineno"></span>HELO&nbsp;customhost<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="8648196">var</span>&nbsp;<span class="ident" id="8648200">helloClient</span>&nbsp;<span class="op" id="8648212">=</span>&nbsp;<span class="op" id="8648214">[</span><span class="op" id="8648215">]</span><span class="builtintype" id="8648216">string</span><span class="op" id="8648222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648225">&#34;&#34;</span><span class="op" id="8648227">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648230">&#34;STARTTLS\n&#34;</span><span class="op" id="8648242">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648245">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="8648270">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648273">&#34;AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==\n&#34;</span><span class="op" id="8648304">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648307">&#34;MAIL&nbsp;FROM:&lt;test@example.com&gt;\n&#34;</span><span class="op" id="8648339">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648342">&#34;&#34;</span><span class="op" id="8648344">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648347">&#34;RSET\n&#34;</span><span class="op" id="8648355">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648358">&#34;QUIT\n&#34;</span><span class="op" id="8648366">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648369">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="8648394">,</span><br>
<span class="lineno">415</span><span class="op" id="8648396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8648399">func</span>&nbsp;<span class="ident" id="8648404">TestSendMail</span><span class="op" id="8648416">(</span><span class="ident" id="8648417">t</span>&nbsp;<span class="op" id="8648419">*</span><span class="ident" id="8648420">testing</span><span class="op" id="8648427">.</span><span class="ident" id="8648428">T</span><span class="op" id="8648429">)</span>&nbsp;<span class="op" id="8648431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8648434">server</span>&nbsp;<span class="op" id="8648441">:=</span>&nbsp;<span class="ident" id="8648444">strings</span><span class="op" id="8648451">.</span><span class="ident" id="8648452">Join</span><span class="op" id="8648456">(</span><span class="ident" id="8648457">strings</span><span class="op" id="8648464">.</span><span class="ident" id="8648465">Split</span><span class="op" id="8648470">(</span><span class="ident" id="8648471">sendMailServer</span><span class="op" id="8648485">,</span>&nbsp;<span class="string" id="8648487">&#34;\n&#34;</span><span class="op" id="8648491">)</span><span class="op" id="8648492">,</span>&nbsp;<span class="string" id="8648494">&#34;\r\n&#34;</span><span class="op" id="8648500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8648503">client</span>&nbsp;<span class="op" id="8648510">:=</span>&nbsp;<span class="ident" id="8648513">strings</span><span class="op" id="8648520">.</span><span class="ident" id="8648521">Join</span><span class="op" id="8648525">(</span><span class="ident" id="8648526">strings</span><span class="op" id="8648533">.</span><span class="ident" id="8648534">Split</span><span class="op" id="8648539">(</span><span class="ident" id="8648540">sendMailClient</span><span class="op" id="8648554">,</span>&nbsp;<span class="string" id="8648556">&#34;\n&#34;</span><span class="op" id="8648560">)</span><span class="op" id="8648561">,</span>&nbsp;<span class="string" id="8648563">&#34;\r\n&#34;</span><span class="op" id="8648569">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8648572">var</span>&nbsp;<span class="ident" id="8648576">cmdbuf</span>&nbsp;<span class="ident" id="8648583">bytes</span><span class="op" id="8648588">.</span><span class="ident" id="8648589">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8648597">bcmdbuf</span>&nbsp;<span class="op" id="8648605">:=</span>&nbsp;<span class="ident" id="8648608">bufio</span><span class="op" id="8648613">.</span><span class="ident" id="8648614">NewWriter</span><span class="op" id="8648623">(</span><span class="op" id="8648624">&amp;</span><span class="ident" id="8648625">cmdbuf</span><span class="op" id="8648631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8648634">l</span><span class="op" id="8648635">,</span>&nbsp;<span class="ident" id="8648637">err</span>&nbsp;<span class="op" id="8648641">:=</span>&nbsp;<span class="ident" id="8648644">net</span><span class="op" id="8648647">.</span><span class="ident" id="8648648">Listen</span><span class="op" id="8648654">(</span><span class="string" id="8648655">&#34;tcp&#34;</span><span class="op" id="8648660">,</span>&nbsp;<span class="string" id="8648662">&#34;127.0.0.1:0&#34;</span><span class="op" id="8648675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8648678">if</span>&nbsp;<span class="ident" id="8648681">err</span>&nbsp;<span class="op" id="8648685">!=</span>&nbsp;<span class="ident" id="8648688">nil</span>&nbsp;<span class="op" id="8648692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8648696">t</span><span class="op" id="8648697">.</span><span class="ident" id="8648698">Fatalf</span><span class="op" id="8648704">(</span><span class="string" id="8648705">&#34;Unable&nbsp;to&nbsp;to&nbsp;create&nbsp;listener:&nbsp;%v&#34;</span><span class="op" id="8648739">,</span>&nbsp;<span class="ident" id="8648741">err</span><span class="op" id="8648744">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8648747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8648750">defer</span>&nbsp;<span class="ident" id="8648756">l</span><span class="op" id="8648757">.</span><span class="ident" id="8648758">Close</span><span class="op" id="8648763">(</span><span class="op" id="8648764">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8648768">//&nbsp;prevent&nbsp;data&nbsp;race&nbsp;on&nbsp;bcmdbuf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8648801">var</span>&nbsp;<span class="ident" id="8648805">done</span>&nbsp;<span class="op" id="8648810">=</span>&nbsp;<span class="builtinfunc" id="8648812">make</span><span class="op" id="8648816">(</span><span class="keyword" id="8648817">chan</span>&nbsp;<span class="keyword" id="8648822">struct</span><span class="op" id="8648828">{</span><span class="op" id="8648829">}</span><span class="op" id="8648830">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8648833">go</span>&nbsp;<span class="keyword" id="8648836">func</span><span class="op" id="8648840">(</span><span class="ident" id="8648841">data</span>&nbsp;<span class="op" id="8648846">[</span><span class="op" id="8648847">]</span><span class="builtintype" id="8648848">string</span><span class="op" id="8648854">)</span>&nbsp;<span class="op" id="8648856">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8648861">defer</span>&nbsp;<span class="builtinfunc" id="8648867">close</span><span class="op" id="8648872">(</span><span class="ident" id="8648873">done</span><span class="op" id="8648877">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8648882">conn</span><span class="op" id="8648886">,</span>&nbsp;<span class="ident" id="8648888">err</span>&nbsp;<span class="op" id="8648892">:=</span>&nbsp;<span class="ident" id="8648895">l</span><span class="op" id="8648896">.</span><span class="ident" id="8648897">Accept</span><span class="op" id="8648903">(</span><span class="op" id="8648904">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8648908">if</span>&nbsp;<span class="ident" id="8648911">err</span>&nbsp;<span class="op" id="8648915">!=</span>&nbsp;<span class="ident" id="8648918">nil</span>&nbsp;<span class="op" id="8648922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8648927">t</span><span class="op" id="8648928">.</span><span class="ident" id="8648929">Errorf</span><span class="op" id="8648935">(</span><span class="string" id="8648936">&#34;Accept&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8648954">,</span>&nbsp;<span class="ident" id="8648956">err</span><span class="op" id="8648959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8648964">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8648973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8648977">defer</span>&nbsp;<span class="ident" id="8648983">conn</span><span class="op" id="8648987">.</span><span class="ident" id="8648988">Close</span><span class="op" id="8648993">(</span><span class="op" id="8648994">)</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8648999">tc</span>&nbsp;<span class="op" id="8649002">:=</span>&nbsp;<span class="ident" id="8649005">textproto</span><span class="op" id="8649014">.</span><span class="ident" id="8649015">NewConn</span><span class="op" id="8649022">(</span><span class="ident" id="8649023">conn</span><span class="op" id="8649027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649031">for</span>&nbsp;<span class="ident" id="8649035">i</span>&nbsp;<span class="op" id="8649037">:=</span>&nbsp;<span class="num" id="8649040">0</span><span class="op" id="8649041">;</span>&nbsp;<span class="ident" id="8649043">i</span>&nbsp;<span class="op" id="8649045">&lt;</span>&nbsp;<span class="builtinfunc" id="8649047">len</span><span class="op" id="8649050">(</span><span class="ident" id="8649051">data</span><span class="op" id="8649055">)</span>&nbsp;<span class="op" id="8649057">&amp;&amp;</span>&nbsp;<span class="ident" id="8649060">data</span><span class="op" id="8649064">[</span><span class="ident" id="8649065">i</span><span class="op" id="8649066">]</span>&nbsp;<span class="op" id="8649068">!=</span>&nbsp;<span class="string" id="8649071">&#34;&#34;</span><span class="op" id="8649073">;</span>&nbsp;<span class="ident" id="8649075">i</span><span class="op" id="8649076">++</span>&nbsp;<span class="op" id="8649079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649084">tc</span><span class="op" id="8649086">.</span><span class="ident" id="8649087">PrintfLine</span><span class="op" id="8649097">(</span><span class="ident" id="8649098">data</span><span class="op" id="8649102">[</span><span class="ident" id="8649103">i</span><span class="op" id="8649104">]</span><span class="op" id="8649105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649110">for</span>&nbsp;<span class="builtinfunc" id="8649114">len</span><span class="op" id="8649117">(</span><span class="ident" id="8649118">data</span><span class="op" id="8649122">[</span><span class="ident" id="8649123">i</span><span class="op" id="8649124">]</span><span class="op" id="8649125">)</span>&nbsp;<span class="op" id="8649127">&gt;=</span>&nbsp;<span class="num" id="8649130">4</span>&nbsp;<span class="op" id="8649132">&amp;&amp;</span>&nbsp;<span class="ident" id="8649135">data</span><span class="op" id="8649139">[</span><span class="ident" id="8649140">i</span><span class="op" id="8649141">]</span><span class="op" id="8649142">[</span><span class="num" id="8649143">3</span><span class="op" id="8649144">]</span>&nbsp;<span class="op" id="8649146">==</span>&nbsp;<span class="string" id="8649149">&#39;-&#39;</span>&nbsp;<span class="op" id="8649153">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649159">i</span><span class="op" id="8649160">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649167">tc</span><span class="op" id="8649169">.</span><span class="ident" id="8649170">PrintfLine</span><span class="op" id="8649180">(</span><span class="ident" id="8649181">data</span><span class="op" id="8649185">[</span><span class="ident" id="8649186">i</span><span class="op" id="8649187">]</span><span class="op" id="8649188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8649193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649198">if</span>&nbsp;<span class="ident" id="8649201">data</span><span class="op" id="8649205">[</span><span class="ident" id="8649206">i</span><span class="op" id="8649207">]</span>&nbsp;<span class="op" id="8649209">==</span>&nbsp;<span class="string" id="8649212">&#34;221&nbsp;Goodbye&#34;</span>&nbsp;<span class="op" id="8649226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649232">return</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8649242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649247">read</span>&nbsp;<span class="op" id="8649252">:=</span>&nbsp;<span class="builtintype" id="8649255">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649264">for</span>&nbsp;<span class="op" id="8649268">!</span><span class="ident" id="8649269">read</span>&nbsp;<span class="op" id="8649274">||</span>&nbsp;<span class="ident" id="8649277">data</span><span class="op" id="8649281">[</span><span class="ident" id="8649282">i</span><span class="op" id="8649283">]</span>&nbsp;<span class="op" id="8649285">==</span>&nbsp;<span class="string" id="8649288">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="8649303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649309">msg</span><span class="op" id="8649312">,</span>&nbsp;<span class="ident" id="8649314">err</span>&nbsp;<span class="op" id="8649318">:=</span>&nbsp;<span class="ident" id="8649321">tc</span><span class="op" id="8649323">.</span><span class="ident" id="8649324">ReadLine</span><span class="op" id="8649332">(</span><span class="op" id="8649333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649339">bcmdbuf</span><span class="op" id="8649346">.</span><span class="ident" id="8649347">Write</span><span class="op" id="8649352">(</span><span class="op" id="8649353">[</span><span class="op" id="8649354">]</span><span class="builtintype" id="8649355">byte</span><span class="op" id="8649359">(</span><span class="ident" id="8649360">msg</span>&nbsp;<span class="op" id="8649364">+</span>&nbsp;<span class="string" id="8649366">&#34;\r\n&#34;</span><span class="op" id="8649372">)</span><span class="op" id="8649373">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649379">read</span>&nbsp;<span class="op" id="8649384">=</span>&nbsp;<span class="builtintype" id="8649386">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649395">if</span>&nbsp;<span class="ident" id="8649398">err</span>&nbsp;<span class="op" id="8649402">!=</span>&nbsp;<span class="ident" id="8649405">nil</span>&nbsp;<span class="op" id="8649409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649416">t</span><span class="op" id="8649417">.</span><span class="ident" id="8649418">Errorf</span><span class="op" id="8649424">(</span><span class="string" id="8649425">&#34;Read&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8649441">,</span>&nbsp;<span class="ident" id="8649443">err</span><span class="op" id="8649446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649453">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8649464">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649470">if</span>&nbsp;<span class="ident" id="8649473">data</span><span class="op" id="8649477">[</span><span class="ident" id="8649478">i</span><span class="op" id="8649479">]</span>&nbsp;<span class="op" id="8649481">==</span>&nbsp;<span class="string" id="8649484">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="8649499">&amp;&amp;</span>&nbsp;<span class="ident" id="8649502">msg</span>&nbsp;<span class="op" id="8649506">==</span>&nbsp;<span class="string" id="8649509">&#34;.&#34;</span>&nbsp;<span class="op" id="8649513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649520">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8649530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8649535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8649539">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8649542">}</span><span class="op" id="8649543">(</span><span class="ident" id="8649544">strings</span><span class="op" id="8649551">.</span><span class="ident" id="8649552">Split</span><span class="op" id="8649557">(</span><span class="ident" id="8649558">server</span><span class="op" id="8649564">,</span>&nbsp;<span class="string" id="8649566">&#34;\r\n&#34;</span><span class="op" id="8649572">)</span><span class="op" id="8649573">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649577">err</span>&nbsp;<span class="op" id="8649581">=</span>&nbsp;<span class="ident" id="8649583">SendMail</span><span class="op" id="8649591">(</span><span class="ident" id="8649592">l</span><span class="op" id="8649593">.</span><span class="ident" id="8649594">Addr</span><span class="op" id="8649598">(</span><span class="op" id="8649599">)</span><span class="op" id="8649600">.</span><span class="ident" id="8649601">String</span><span class="op" id="8649607">(</span><span class="op" id="8649608">)</span><span class="op" id="8649609">,</span>&nbsp;<span class="ident" id="8649611">nil</span><span class="op" id="8649614">,</span>&nbsp;<span class="string" id="8649616">&#34;test@example.com&#34;</span><span class="op" id="8649634">,</span>&nbsp;<span class="op" id="8649636">[</span><span class="op" id="8649637">]</span><span class="builtintype" id="8649638">string</span><span class="op" id="8649644">{</span><span class="string" id="8649645">&#34;other@example.com&#34;</span><span class="op" id="8649664">}</span><span class="op" id="8649665">,</span>&nbsp;<span class="op" id="8649667">[</span><span class="op" id="8649668">]</span><span class="builtintype" id="8649669">byte</span><span class="op" id="8649673">(</span><span class="ident" id="8649674">strings</span><span class="op" id="8649681">.</span><span class="ident" id="8649682">Replace</span><span class="op" id="8649689">(</span><span class="string" id="8649690">`From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno">470</span><br>
<span class="lineno"></span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>`</span><span class="op" id="8649789">,</span>&nbsp;<span class="string" id="8649791">&#34;\n&#34;</span><span class="op" id="8649795">,</span>&nbsp;<span class="string" id="8649797">&#34;\r\n&#34;</span><span class="op" id="8649803">,</span>&nbsp;<span class="op" id="8649805">-</span><span class="num" id="8649806">1</span><span class="op" id="8649807">)</span><span class="op" id="8649808">)</span><span class="op" id="8649809">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649813">if</span>&nbsp;<span class="ident" id="8649816">err</span>&nbsp;<span class="op" id="8649820">!=</span>&nbsp;<span class="ident" id="8649823">nil</span>&nbsp;<span class="op" id="8649827">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649831">t</span><span class="op" id="8649832">.</span><span class="ident" id="8649833">Errorf</span><span class="op" id="8649839">(</span><span class="string" id="8649840">&#34;%v&#34;</span><span class="op" id="8649844">,</span>&nbsp;<span class="ident" id="8649846">err</span><span class="op" id="8649849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8649852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8649856">&lt;-</span><span class="ident" id="8649858">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649864">bcmdbuf</span><span class="op" id="8649871">.</span><span class="ident" id="8649872">Flush</span><span class="op" id="8649877">(</span><span class="op" id="8649878">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649881">actualcmds</span>&nbsp;<span class="op" id="8649892">:=</span>&nbsp;<span class="ident" id="8649895">cmdbuf</span><span class="op" id="8649901">.</span><span class="ident" id="8649902">String</span><span class="op" id="8649908">(</span><span class="op" id="8649909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649912">if</span>&nbsp;<span class="ident" id="8649915">client</span>&nbsp;<span class="op" id="8649922">!=</span>&nbsp;<span class="ident" id="8649925">actualcmds</span>&nbsp;<span class="op" id="8649936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649940">t</span><span class="op" id="8649941">.</span><span class="ident" id="8649942">Errorf</span><span class="op" id="8649948">(</span><span class="string" id="8649949">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8649974">,</span>&nbsp;<span class="ident" id="8649976">actualcmds</span><span class="op" id="8649986">,</span>&nbsp;<span class="ident" id="8649988">client</span><span class="op" id="8649994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8649997">}</span><br>
<span class="lineno"></span><span class="op" id="8649999">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="8650002">var</span>&nbsp;<span class="ident" id="8650006">sendMailServer</span>&nbsp;<span class="op" id="8650021">=</span>&nbsp;<span class="string" id="8650023">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno"></span>250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;ok<br>
<span class="lineno">490</span>250&nbsp;Receiver&nbsp;ok<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;ok<br>
<span class="lineno"></span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="keyword" id="8650152">var</span>&nbsp;<span class="ident" id="8650156">sendMailClient</span>&nbsp;<span class="op" id="8650171">=</span>&nbsp;<span class="string" id="8650173">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;test@example.com&gt;<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;other@example.com&gt;<br>
<span class="lineno">500</span>DATA<br>
<span class="lineno"></span>From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno"></span><br>
<span class="lineno">505</span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="8650373">func</span>&nbsp;<span class="ident" id="8650378">TestAuthFailed</span><span class="op" id="8650392">(</span><span class="ident" id="8650393">t</span>&nbsp;<span class="op" id="8650395">*</span><span class="ident" id="8650396">testing</span><span class="op" id="8650403">.</span><span class="ident" id="8650404">T</span><span class="op" id="8650405">)</span>&nbsp;<span class="op" id="8650407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650410">server</span>&nbsp;<span class="op" id="8650417">:=</span>&nbsp;<span class="ident" id="8650420">strings</span><span class="op" id="8650427">.</span><span class="ident" id="8650428">Join</span><span class="op" id="8650432">(</span><span class="ident" id="8650433">strings</span><span class="op" id="8650440">.</span><span class="ident" id="8650441">Split</span><span class="op" id="8650446">(</span><span class="ident" id="8650447">authFailedServer</span><span class="op" id="8650463">,</span>&nbsp;<span class="string" id="8650465">&#34;\n&#34;</span><span class="op" id="8650469">)</span><span class="op" id="8650470">,</span>&nbsp;<span class="string" id="8650472">&#34;\r\n&#34;</span><span class="op" id="8650478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650481">client</span>&nbsp;<span class="op" id="8650488">:=</span>&nbsp;<span class="ident" id="8650491">strings</span><span class="op" id="8650498">.</span><span class="ident" id="8650499">Join</span><span class="op" id="8650503">(</span><span class="ident" id="8650504">strings</span><span class="op" id="8650511">.</span><span class="ident" id="8650512">Split</span><span class="op" id="8650517">(</span><span class="ident" id="8650518">authFailedClient</span><span class="op" id="8650534">,</span>&nbsp;<span class="string" id="8650536">&#34;\n&#34;</span><span class="op" id="8650540">)</span><span class="op" id="8650541">,</span>&nbsp;<span class="string" id="8650543">&#34;\r\n&#34;</span><span class="op" id="8650549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650552">var</span>&nbsp;<span class="ident" id="8650556">cmdbuf</span>&nbsp;<span class="ident" id="8650563">bytes</span><span class="op" id="8650568">.</span><span class="ident" id="8650569">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650577">bcmdbuf</span>&nbsp;<span class="op" id="8650585">:=</span>&nbsp;<span class="ident" id="8650588">bufio</span><span class="op" id="8650593">.</span><span class="ident" id="8650594">NewWriter</span><span class="op" id="8650603">(</span><span class="op" id="8650604">&amp;</span><span class="ident" id="8650605">cmdbuf</span><span class="op" id="8650611">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650614">var</span>&nbsp;<span class="ident" id="8650618">fake</span>&nbsp;<span class="ident" id="8650623">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650630">fake</span><span class="op" id="8650634">.</span><span class="ident" id="8650635">ReadWriter</span>&nbsp;<span class="op" id="8650646">=</span>&nbsp;<span class="ident" id="8650648">bufio</span><span class="op" id="8650653">.</span><span class="ident" id="8650654">NewReadWriter</span><span class="op" id="8650667">(</span><span class="ident" id="8650668">bufio</span><span class="op" id="8650673">.</span><span class="ident" id="8650674">NewReader</span><span class="op" id="8650683">(</span><span class="ident" id="8650684">strings</span><span class="op" id="8650691">.</span><span class="ident" id="8650692">NewReader</span><span class="op" id="8650701">(</span><span class="ident" id="8650702">server</span><span class="op" id="8650708">)</span><span class="op" id="8650709">)</span><span class="op" id="8650710">,</span>&nbsp;<span class="ident" id="8650712">bcmdbuf</span><span class="op" id="8650719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650722">c</span><span class="op" id="8650723">,</span>&nbsp;<span class="ident" id="8650725">err</span>&nbsp;<span class="op" id="8650729">:=</span>&nbsp;<span class="ident" id="8650732">NewClient</span><span class="op" id="8650741">(</span><span class="ident" id="8650742">fake</span><span class="op" id="8650746">,</span>&nbsp;<span class="string" id="8650748">&#34;fake.host&#34;</span><span class="op" id="8650759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650762">if</span>&nbsp;<span class="ident" id="8650765">err</span>&nbsp;<span class="op" id="8650769">!=</span>&nbsp;<span class="ident" id="8650772">nil</span>&nbsp;<span class="op" id="8650776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650780">t</span><span class="op" id="8650781">.</span><span class="ident" id="8650782">Fatalf</span><span class="op" id="8650788">(</span><span class="string" id="8650789">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="8650804">,</span>&nbsp;<span class="ident" id="8650806">err</span><span class="op" id="8650809">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8650812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650815">defer</span>&nbsp;<span class="ident" id="8650821">c</span><span class="op" id="8650822">.</span><span class="ident" id="8650823">Close</span><span class="op" id="8650828">(</span><span class="op" id="8650829">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650833">c</span><span class="op" id="8650834">.</span><span class="ident" id="8650835">tls</span>&nbsp;<span class="op" id="8650839">=</span>&nbsp;<span class="builtintype" id="8650841">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650847">c</span><span class="op" id="8650848">.</span><span class="ident" id="8650849">serverName</span>&nbsp;<span class="op" id="8650860">=</span>&nbsp;<span class="string" id="8650862">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650881">err</span>&nbsp;<span class="op" id="8650885">=</span>&nbsp;<span class="ident" id="8650887">c</span><span class="op" id="8650888">.</span><span class="ident" id="8650889">Auth</span><span class="op" id="8650893">(</span><span class="ident" id="8650894">PlainAuth</span><span class="op" id="8650903">(</span><span class="string" id="8650904">&#34;&#34;</span><span class="op" id="8650906">,</span>&nbsp;<span class="string" id="8650908">&#34;user&#34;</span><span class="op" id="8650914">,</span>&nbsp;<span class="string" id="8650916">&#34;pass&#34;</span><span class="op" id="8650922">,</span>&nbsp;<span class="string" id="8650924">&#34;smtp.google.com&#34;</span><span class="op" id="8650941">)</span><span class="op" id="8650942">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650946">if</span>&nbsp;<span class="ident" id="8650949">err</span>&nbsp;<span class="op" id="8650953">==</span>&nbsp;<span class="ident" id="8650956">nil</span>&nbsp;<span class="op" id="8650960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650964">t</span><span class="op" id="8650965">.</span><span class="ident" id="8650966">Error</span><span class="op" id="8650971">(</span><span class="string" id="8650972">&#34;Auth:&nbsp;expected&nbsp;error;&nbsp;got&nbsp;none&#34;</span><span class="op" id="8651004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651007">}</span>&nbsp;<span class="keyword" id="8651009">else</span>&nbsp;<span class="keyword" id="8651014">if</span>&nbsp;<span class="ident" id="8651017">err</span><span class="op" id="8651020">.</span><span class="ident" id="8651021">Error</span><span class="op" id="8651026">(</span><span class="op" id="8651027">)</span>&nbsp;<span class="op" id="8651029">!=</span>&nbsp;<span class="string" id="8651032">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span>&nbsp;<span class="op" id="8651086">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651090">t</span><span class="op" id="8651091">.</span><span class="ident" id="8651092">Errorf</span><span class="op" id="8651098">(</span><span class="string" id="8651099">&#34;Auth:&nbsp;got&nbsp;error:&nbsp;%v,&nbsp;want:&nbsp;%s&#34;</span><span class="op" id="8651130">,</span>&nbsp;<span class="ident" id="8651132">err</span><span class="op" id="8651135">,</span>&nbsp;<span class="string" id="8651137">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span><span class="op" id="8651190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651197">bcmdbuf</span><span class="op" id="8651204">.</span><span class="ident" id="8651205">Flush</span><span class="op" id="8651210">(</span><span class="op" id="8651211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651214">actualcmds</span>&nbsp;<span class="op" id="8651225">:=</span>&nbsp;<span class="ident" id="8651228">cmdbuf</span><span class="op" id="8651234">.</span><span class="ident" id="8651235">String</span><span class="op" id="8651241">(</span><span class="op" id="8651242">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651245">if</span>&nbsp;<span class="ident" id="8651248">client</span>&nbsp;<span class="op" id="8651255">!=</span>&nbsp;<span class="ident" id="8651258">actualcmds</span>&nbsp;<span class="op" id="8651269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651273">t</span><span class="op" id="8651274">.</span><span class="ident" id="8651275">Errorf</span><span class="op" id="8651281">(</span><span class="string" id="8651282">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8651307">,</span>&nbsp;<span class="ident" id="8651309">actualcmds</span><span class="op" id="8651319">,</span>&nbsp;<span class="ident" id="8651321">client</span><span class="op" id="8651327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651330">}</span><br>
<span class="lineno"></span><span class="op" id="8651332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">540</span><span class="keyword" id="8651335">var</span>&nbsp;<span class="ident" id="8651339">authFailedServer</span>&nbsp;<span class="op" id="8651356">=</span>&nbsp;<span class="string" id="8651358">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>535-Invalid&nbsp;credentials<br>
<span class="lineno"></span>535&nbsp;please&nbsp;see&nbsp;www.example.com<br>
<span class="lineno">545</span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8651500">var</span>&nbsp;<span class="ident" id="8651504">authFailedClient</span>&nbsp;<span class="op" id="8651521">=</span>&nbsp;<span class="string" id="8651523">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno">550</span>*<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8651577">func</span>&nbsp;<span class="ident" id="8651582">TestTLSClient</span><span class="op" id="8651595">(</span><span class="ident" id="8651596">t</span>&nbsp;<span class="op" id="8651598">*</span><span class="ident" id="8651599">testing</span><span class="op" id="8651606">.</span><span class="ident" id="8651607">T</span><span class="op" id="8651608">)</span>&nbsp;<span class="op" id="8651610">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651613">ln</span>&nbsp;<span class="op" id="8651616">:=</span>&nbsp;<span class="ident" id="8651619">newLocalListener</span><span class="op" id="8651635">(</span><span class="ident" id="8651636">t</span><span class="op" id="8651637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651640">defer</span>&nbsp;<span class="ident" id="8651646">ln</span><span class="op" id="8651648">.</span><span class="ident" id="8651649">Close</span><span class="op" id="8651654">(</span><span class="op" id="8651655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651658">errc</span>&nbsp;<span class="op" id="8651663">:=</span>&nbsp;<span class="builtinfunc" id="8651666">make</span><span class="op" id="8651670">(</span><span class="keyword" id="8651671">chan</span>&nbsp;<span class="builtintype" id="8651676">error</span><span class="op" id="8651681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651684">go</span>&nbsp;<span class="keyword" id="8651687">func</span><span class="op" id="8651691">(</span><span class="op" id="8651692">)</span>&nbsp;<span class="op" id="8651694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651698">errc</span>&nbsp;<span class="op" id="8651703">&lt;-</span>&nbsp;<span class="ident" id="8651706">sendMail</span><span class="op" id="8651714">(</span><span class="ident" id="8651715">ln</span><span class="op" id="8651717">.</span><span class="ident" id="8651718">Addr</span><span class="op" id="8651722">(</span><span class="op" id="8651723">)</span><span class="op" id="8651724">.</span><span class="ident" id="8651725">String</span><span class="op" id="8651731">(</span><span class="op" id="8651732">)</span><span class="op" id="8651733">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651736">}</span><span class="op" id="8651737">(</span><span class="op" id="8651738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651741">conn</span><span class="op" id="8651745">,</span>&nbsp;<span class="ident" id="8651747">err</span>&nbsp;<span class="op" id="8651751">:=</span>&nbsp;<span class="ident" id="8651754">ln</span><span class="op" id="8651756">.</span><span class="ident" id="8651757">Accept</span><span class="op" id="8651763">(</span><span class="op" id="8651764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651767">if</span>&nbsp;<span class="ident" id="8651770">err</span>&nbsp;<span class="op" id="8651774">!=</span>&nbsp;<span class="ident" id="8651777">nil</span>&nbsp;<span class="op" id="8651781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651785">t</span><span class="op" id="8651786">.</span><span class="ident" id="8651787">Fatalf</span><span class="op" id="8651793">(</span><span class="string" id="8651794">&#34;failed&nbsp;to&nbsp;accept&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="8651827">,</span>&nbsp;<span class="ident" id="8651829">err</span><span class="op" id="8651832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651835">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651838">defer</span>&nbsp;<span class="ident" id="8651844">conn</span><span class="op" id="8651848">.</span><span class="ident" id="8651849">Close</span><span class="op" id="8651854">(</span><span class="op" id="8651855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651858">if</span>&nbsp;<span class="ident" id="8651861">err</span>&nbsp;<span class="op" id="8651865">:=</span>&nbsp;<span class="ident" id="8651868">serverHandle</span><span class="op" id="8651880">(</span><span class="ident" id="8651881">conn</span><span class="op" id="8651885">,</span>&nbsp;<span class="ident" id="8651887">t</span><span class="op" id="8651888">)</span><span class="op" id="8651889">;</span>&nbsp;<span class="ident" id="8651891">err</span>&nbsp;<span class="op" id="8651895">!=</span>&nbsp;<span class="ident" id="8651898">nil</span>&nbsp;<span class="op" id="8651902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651906">t</span><span class="op" id="8651907">.</span><span class="ident" id="8651908">Fatalf</span><span class="op" id="8651914">(</span><span class="string" id="8651915">&#34;failed&nbsp;to&nbsp;handle&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="8651948">,</span>&nbsp;<span class="ident" id="8651950">err</span><span class="op" id="8651953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651959">if</span>&nbsp;<span class="ident" id="8651962">err</span>&nbsp;<span class="op" id="8651966">:=</span>&nbsp;<span class="op" id="8651969">&lt;-</span><span class="ident" id="8651971">errc</span><span class="op" id="8651975">;</span>&nbsp;<span class="ident" id="8651977">err</span>&nbsp;<span class="op" id="8651981">!=</span>&nbsp;<span class="ident" id="8651984">nil</span>&nbsp;<span class="op" id="8651988">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651992">t</span><span class="op" id="8651993">.</span><span class="ident" id="8651994">Fatalf</span><span class="op" id="8652000">(</span><span class="string" id="8652001">&#34;client&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8652019">,</span>&nbsp;<span class="ident" id="8652021">err</span><span class="op" id="8652024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8652027">}</span><br>
<span class="lineno"></span><span class="op" id="8652029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8652032">func</span>&nbsp;<span class="ident" id="8652037">newLocalListener</span><span class="op" id="8652053">(</span><span class="ident" id="8652054">t</span>&nbsp;<span class="op" id="8652056">*</span><span class="ident" id="8652057">testing</span><span class="op" id="8652064">.</span><span class="ident" id="8652065">T</span><span class="op" id="8652066">)</span>&nbsp;<span class="ident" id="8652068">net</span><span class="op" id="8652071">.</span><span class="ident" id="8652072">Listener</span>&nbsp;<span class="op" id="8652081">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652084">ln</span><span class="op" id="8652086">,</span>&nbsp;<span class="ident" id="8652088">err</span>&nbsp;<span class="op" id="8652092">:=</span>&nbsp;<span class="ident" id="8652095">net</span><span class="op" id="8652098">.</span><span class="ident" id="8652099">Listen</span><span class="op" id="8652105">(</span><span class="string" id="8652106">&#34;tcp&#34;</span><span class="op" id="8652111">,</span>&nbsp;<span class="string" id="8652113">&#34;127.0.0.1:0&#34;</span><span class="op" id="8652126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652129">if</span>&nbsp;<span class="ident" id="8652132">err</span>&nbsp;<span class="op" id="8652136">!=</span>&nbsp;<span class="ident" id="8652139">nil</span>&nbsp;<span class="op" id="8652143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652147">ln</span><span class="op" id="8652149">,</span>&nbsp;<span class="ident" id="8652151">err</span>&nbsp;<span class="op" id="8652155">=</span>&nbsp;<span class="ident" id="8652157">net</span><span class="op" id="8652160">.</span><span class="ident" id="8652161">Listen</span><span class="op" id="8652167">(</span><span class="string" id="8652168">&#34;tcp6&#34;</span><span class="op" id="8652174">,</span>&nbsp;<span class="string" id="8652176">&#34;[::1]:0&#34;</span><span class="op" id="8652185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8652188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652191">if</span>&nbsp;<span class="ident" id="8652194">err</span>&nbsp;<span class="op" id="8652198">!=</span>&nbsp;<span class="ident" id="8652201">nil</span>&nbsp;<span class="op" id="8652205">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652209">t</span><span class="op" id="8652210">.</span><span class="ident" id="8652211">Fatal</span><span class="op" id="8652216">(</span><span class="ident" id="8652217">err</span><span class="op" id="8652220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8652223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652226">return</span>&nbsp;<span class="ident" id="8652233">ln</span><br>
<span class="lineno"></span><span class="op" id="8652236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span><span class="keyword" id="8652239">type</span>&nbsp;<span class="ident" id="8652244">smtpSender</span>&nbsp;<span class="keyword" id="8652255">struct</span>&nbsp;<span class="op" id="8652262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652265">w</span>&nbsp;<span class="ident" id="8652267">io</span><span class="op" id="8652269">.</span><span class="ident" id="8652270">Writer</span><br>
<span class="lineno"></span><span class="op" id="8652277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8652280">func</span>&nbsp;<span class="op" id="8652285">(</span><span class="ident" id="8652286">s</span>&nbsp;<span class="ident" id="8652288">smtpSender</span><span class="op" id="8652298">)</span>&nbsp;<span class="ident" id="8652300">send</span><span class="op" id="8652304">(</span><span class="ident" id="8652305">f</span>&nbsp;<span class="builtintype" id="8652307">string</span><span class="op" id="8652313">)</span>&nbsp;<span class="op" id="8652315">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652318">s</span><span class="op" id="8652319">.</span><span class="ident" id="8652320">w</span><span class="op" id="8652321">.</span><span class="ident" id="8652322">Write</span><span class="op" id="8652327">(</span><span class="op" id="8652328">[</span><span class="op" id="8652329">]</span><span class="builtintype" id="8652330">byte</span><span class="op" id="8652334">(</span><span class="ident" id="8652335">f</span>&nbsp;<span class="op" id="8652337">+</span>&nbsp;<span class="string" id="8652339">&#34;\r\n&#34;</span><span class="op" id="8652345">)</span><span class="op" id="8652346">)</span><br>
<span class="lineno"></span><span class="op" id="8652348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8652351">//&nbsp;smtp&nbsp;server,&nbsp;finely&nbsp;tailored&nbsp;to&nbsp;deal&nbsp;with&nbsp;our&nbsp;own&nbsp;client&nbsp;only!</span><br>
<span class="lineno"></span><span class="keyword" id="8652417">func</span>&nbsp;<span class="ident" id="8652422">serverHandle</span><span class="op" id="8652434">(</span><span class="ident" id="8652435">c</span>&nbsp;<span class="ident" id="8652437">net</span><span class="op" id="8652440">.</span><span class="ident" id="8652441">Conn</span><span class="op" id="8652445">,</span>&nbsp;<span class="ident" id="8652447">t</span>&nbsp;<span class="op" id="8652449">*</span><span class="ident" id="8652450">testing</span><span class="op" id="8652457">.</span><span class="ident" id="8652458">T</span><span class="op" id="8652459">)</span>&nbsp;<span class="builtintype" id="8652461">error</span>&nbsp;<span class="op" id="8652467">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652470">send</span>&nbsp;<span class="op" id="8652475">:=</span>&nbsp;<span class="ident" id="8652478">smtpSender</span><span class="op" id="8652488">{</span><span class="ident" id="8652489">c</span><span class="op" id="8652490">}</span><span class="op" id="8652491">.</span><span class="ident" id="8652492">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652498">send</span><span class="op" id="8652502">(</span><span class="string" id="8652503">&#34;220&nbsp;127.0.0.1&nbsp;ESMTP&nbsp;service&nbsp;ready&#34;</span><span class="op" id="8652538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652541">s</span>&nbsp;<span class="op" id="8652543">:=</span>&nbsp;<span class="ident" id="8652546">bufio</span><span class="op" id="8652551">.</span><span class="ident" id="8652552">NewScanner</span><span class="op" id="8652562">(</span><span class="ident" id="8652563">c</span><span class="op" id="8652564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652567">for</span>&nbsp;<span class="ident" id="8652571">s</span><span class="op" id="8652572">.</span><span class="ident" id="8652573">Scan</span><span class="op" id="8652577">(</span><span class="op" id="8652578">)</span>&nbsp;<span class="op" id="8652580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652584">switch</span>&nbsp;<span class="ident" id="8652591">s</span><span class="op" id="8652592">.</span><span class="ident" id="8652593">Text</span><span class="op" id="8652597">(</span><span class="op" id="8652598">)</span>&nbsp;<span class="op" id="8652600">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652604">case</span>&nbsp;<span class="string" id="8652609">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="8652625">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652630">send</span><span class="op" id="8652634">(</span><span class="string" id="8652635">&#34;250-127.0.0.1&nbsp;ESMTP&nbsp;offers&nbsp;a&nbsp;warm&nbsp;hug&nbsp;of&nbsp;welcome&#34;</span><span class="op" id="8652685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652690">send</span><span class="op" id="8652694">(</span><span class="string" id="8652695">&#34;250-STARTTLS&#34;</span><span class="op" id="8652709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652714">send</span><span class="op" id="8652718">(</span><span class="string" id="8652719">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8652727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652731">case</span>&nbsp;<span class="string" id="8652736">&#34;STARTTLS&#34;</span><span class="op" id="8652746">:</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652751">send</span><span class="op" id="8652755">(</span><span class="string" id="8652756">&#34;220&nbsp;Go&nbsp;ahead&#34;</span><span class="op" id="8652770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652775">keypair</span><span class="op" id="8652782">,</span>&nbsp;<span class="ident" id="8652784">err</span>&nbsp;<span class="op" id="8652788">:=</span>&nbsp;<span class="ident" id="8652791">tls</span><span class="op" id="8652794">.</span><span class="ident" id="8652795">X509KeyPair</span><span class="op" id="8652806">(</span><span class="ident" id="8652807">localhostCert</span><span class="op" id="8652820">,</span>&nbsp;<span class="ident" id="8652822">localhostKey</span><span class="op" id="8652834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652839">if</span>&nbsp;<span class="ident" id="8652842">err</span>&nbsp;<span class="op" id="8652846">!=</span>&nbsp;<span class="ident" id="8652849">nil</span>&nbsp;<span class="op" id="8652853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652859">return</span>&nbsp;<span class="ident" id="8652866">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8652873">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652878">config</span>&nbsp;<span class="op" id="8652885">:=</span>&nbsp;<span class="op" id="8652888">&amp;</span><span class="ident" id="8652889">tls</span><span class="op" id="8652892">.</span><span class="ident" id="8652893">Config</span><span class="op" id="8652899">{</span><span class="ident" id="8652900">Certificates</span><span class="op" id="8652912">:</span>&nbsp;<span class="op" id="8652914">[</span><span class="op" id="8652915">]</span><span class="ident" id="8652916">tls</span><span class="op" id="8652919">.</span><span class="ident" id="8652920">Certificate</span><span class="op" id="8652931">{</span><span class="ident" id="8652932">keypair</span><span class="op" id="8652939">}</span><span class="op" id="8652940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652945">c</span>&nbsp;<span class="op" id="8652947">=</span>&nbsp;<span class="ident" id="8652949">tls</span><span class="op" id="8652952">.</span><span class="ident" id="8652953">Server</span><span class="op" id="8652959">(</span><span class="ident" id="8652960">c</span><span class="op" id="8652961">,</span>&nbsp;<span class="ident" id="8652963">config</span><span class="op" id="8652969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652974">defer</span>&nbsp;<span class="ident" id="8652980">c</span><span class="op" id="8652981">.</span><span class="ident" id="8652982">Close</span><span class="op" id="8652987">(</span><span class="op" id="8652988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652993">return</span>&nbsp;<span class="ident" id="8653000">serverHandleTLS</span><span class="op" id="8653015">(</span><span class="ident" id="8653016">c</span><span class="op" id="8653017">,</span>&nbsp;<span class="ident" id="8653019">t</span><span class="op" id="8653020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653024">default</span><span class="op" id="8653031">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653036">t</span><span class="op" id="8653037">.</span><span class="ident" id="8653038">Fatalf</span><span class="op" id="8653044">(</span><span class="string" id="8653045">&#34;unrecognized&nbsp;command:&nbsp;%q&#34;</span><span class="op" id="8653071">,</span>&nbsp;<span class="ident" id="8653073">s</span><span class="op" id="8653074">.</span><span class="ident" id="8653075">Text</span><span class="op" id="8653079">(</span><span class="op" id="8653080">)</span><span class="op" id="8653081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8653085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8653088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653091">return</span>&nbsp;<span class="ident" id="8653098">s</span><span class="op" id="8653099">.</span><span class="ident" id="8653100">Err</span><span class="op" id="8653103">(</span><span class="op" id="8653104">)</span><br>
<span class="lineno"></span><span class="op" id="8653106">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="8653109">func</span>&nbsp;<span class="ident" id="8653114">serverHandleTLS</span><span class="op" id="8653129">(</span><span class="ident" id="8653130">c</span>&nbsp;<span class="ident" id="8653132">net</span><span class="op" id="8653135">.</span><span class="ident" id="8653136">Conn</span><span class="op" id="8653140">,</span>&nbsp;<span class="ident" id="8653142">t</span>&nbsp;<span class="op" id="8653144">*</span><span class="ident" id="8653145">testing</span><span class="op" id="8653152">.</span><span class="ident" id="8653153">T</span><span class="op" id="8653154">)</span>&nbsp;<span class="builtintype" id="8653156">error</span>&nbsp;<span class="op" id="8653162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653165">send</span>&nbsp;<span class="op" id="8653170">:=</span>&nbsp;<span class="ident" id="8653173">smtpSender</span><span class="op" id="8653183">{</span><span class="ident" id="8653184">c</span><span class="op" id="8653185">}</span><span class="op" id="8653186">.</span><span class="ident" id="8653187">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653193">s</span>&nbsp;<span class="op" id="8653195">:=</span>&nbsp;<span class="ident" id="8653198">bufio</span><span class="op" id="8653203">.</span><span class="ident" id="8653204">NewScanner</span><span class="op" id="8653214">(</span><span class="ident" id="8653215">c</span><span class="op" id="8653216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653219">for</span>&nbsp;<span class="ident" id="8653223">s</span><span class="op" id="8653224">.</span><span class="ident" id="8653225">Scan</span><span class="op" id="8653229">(</span><span class="op" id="8653230">)</span>&nbsp;<span class="op" id="8653232">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653236">switch</span>&nbsp;<span class="ident" id="8653243">s</span><span class="op" id="8653244">.</span><span class="ident" id="8653245">Text</span><span class="op" id="8653249">(</span><span class="op" id="8653250">)</span>&nbsp;<span class="op" id="8653252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653256">case</span>&nbsp;<span class="string" id="8653261">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="8653277">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653282">send</span><span class="op" id="8653286">(</span><span class="string" id="8653287">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8653295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653299">case</span>&nbsp;<span class="string" id="8653304">&#34;MAIL&nbsp;FROM:&lt;joe1@example.com&gt;&#34;</span><span class="op" id="8653334">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653339">send</span><span class="op" id="8653343">(</span><span class="string" id="8653344">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8653352">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653356">case</span>&nbsp;<span class="string" id="8653361">&#34;RCPT&nbsp;TO:&lt;joe2@example.com&gt;&#34;</span><span class="op" id="8653389">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653394">send</span><span class="op" id="8653398">(</span><span class="string" id="8653399">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8653407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653411">case</span>&nbsp;<span class="string" id="8653416">&#34;DATA&#34;</span><span class="op" id="8653422">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653427">send</span><span class="op" id="8653431">(</span><span class="string" id="8653432">&#34;354&nbsp;send&nbsp;the&nbsp;mail&nbsp;data,&nbsp;end&nbsp;with&nbsp;.&#34;</span><span class="op" id="8653468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653473">send</span><span class="op" id="8653477">(</span><span class="string" id="8653478">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8653486">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653490">case</span>&nbsp;<span class="string" id="8653495">&#34;Subject:&nbsp;test&#34;</span><span class="op" id="8653510">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653514">case</span>&nbsp;<span class="string" id="8653519">&#34;&#34;</span><span class="op" id="8653521">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653525">case</span>&nbsp;<span class="string" id="8653530">&#34;howdy!&#34;</span><span class="op" id="8653538">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653542">case</span>&nbsp;<span class="string" id="8653547">&#34;.&#34;</span><span class="op" id="8653550">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653554">case</span>&nbsp;<span class="string" id="8653559">&#34;QUIT&#34;</span><span class="op" id="8653565">:</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653570">send</span><span class="op" id="8653574">(</span><span class="string" id="8653575">&#34;221&nbsp;127.0.0.1&nbsp;Service&nbsp;closing&nbsp;transmission&nbsp;channel&#34;</span><span class="op" id="8653627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653632">return</span>&nbsp;<span class="ident" id="8653639">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653645">default</span><span class="op" id="8653652">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653657">t</span><span class="op" id="8653658">.</span><span class="ident" id="8653659">Fatalf</span><span class="op" id="8653665">(</span><span class="string" id="8653666">&#34;unrecognized&nbsp;command&nbsp;during&nbsp;TLS:&nbsp;%q&#34;</span><span class="op" id="8653703">,</span>&nbsp;<span class="ident" id="8653705">s</span><span class="op" id="8653706">.</span><span class="ident" id="8653707">Text</span><span class="op" id="8653711">(</span><span class="op" id="8653712">)</span><span class="op" id="8653713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8653717">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8653720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653723">return</span>&nbsp;<span class="ident" id="8653730">s</span><span class="op" id="8653731">.</span><span class="ident" id="8653732">Err</span><span class="op" id="8653735">(</span><span class="op" id="8653736">)</span><br>
<span class="lineno"></span><span class="op" id="8653738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8653741">func</span>&nbsp;<span class="ident" id="8653746">init</span><span class="op" id="8653750">(</span><span class="op" id="8653751">)</span>&nbsp;<span class="op" id="8653753">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653756">testRootCAs</span>&nbsp;<span class="op" id="8653768">:=</span>&nbsp;<span class="ident" id="8653771">x509</span><span class="op" id="8653775">.</span><span class="ident" id="8653776">NewCertPool</span><span class="op" id="8653787">(</span><span class="op" id="8653788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653791">testRootCAs</span><span class="op" id="8653802">.</span><span class="ident" id="8653803">AppendCertsFromPEM</span><span class="op" id="8653821">(</span><span class="ident" id="8653822">localhostCert</span><span class="op" id="8653835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653838">testHookStartTLS</span>&nbsp;<span class="op" id="8653855">=</span>&nbsp;<span class="keyword" id="8653857">func</span><span class="op" id="8653861">(</span><span class="ident" id="8653862">config</span>&nbsp;<span class="op" id="8653869">*</span><span class="ident" id="8653870">tls</span><span class="op" id="8653873">.</span><span class="ident" id="8653874">Config</span><span class="op" id="8653880">)</span>&nbsp;<span class="op" id="8653882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653886">config</span><span class="op" id="8653892">.</span><span class="ident" id="8653893">RootCAs</span>&nbsp;<span class="op" id="8653901">=</span>&nbsp;<span class="ident" id="8653903">testRootCAs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8653916">}</span><br>
<span class="lineno">655</span><span class="op" id="8653918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8653921">func</span>&nbsp;<span class="ident" id="8653926">sendMail</span><span class="op" id="8653934">(</span><span class="ident" id="8653935">hostPort</span>&nbsp;<span class="builtintype" id="8653944">string</span><span class="op" id="8653950">)</span>&nbsp;<span class="builtintype" id="8653952">error</span>&nbsp;<span class="op" id="8653958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653961">host</span><span class="op" id="8653965">,</span>&nbsp;<span class="ident" id="8653967">_</span><span class="op" id="8653968">,</span>&nbsp;<span class="ident" id="8653970">err</span>&nbsp;<span class="op" id="8653974">:=</span>&nbsp;<span class="ident" id="8653977">net</span><span class="op" id="8653980">.</span><span class="ident" id="8653981">SplitHostPort</span><span class="op" id="8653994">(</span><span class="ident" id="8653995">hostPort</span><span class="op" id="8654003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8654006">if</span>&nbsp;<span class="ident" id="8654009">err</span>&nbsp;<span class="op" id="8654013">!=</span>&nbsp;<span class="ident" id="8654016">nil</span>&nbsp;<span class="op" id="8654020">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8654024">return</span>&nbsp;<span class="ident" id="8654031">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8654036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8654039">auth</span>&nbsp;<span class="op" id="8654044">:=</span>&nbsp;<span class="ident" id="8654047">PlainAuth</span><span class="op" id="8654056">(</span><span class="string" id="8654057">&#34;&#34;</span><span class="op" id="8654059">,</span>&nbsp;<span class="string" id="8654061">&#34;&#34;</span><span class="op" id="8654063">,</span>&nbsp;<span class="string" id="8654065">&#34;&#34;</span><span class="op" id="8654067">,</span>&nbsp;<span class="ident" id="8654069">host</span><span class="op" id="8654073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8654076">from</span>&nbsp;<span class="op" id="8654081">:=</span>&nbsp;<span class="string" id="8654084">&#34;joe1@example.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8654104">to</span>&nbsp;<span class="op" id="8654107">:=</span>&nbsp;<span class="op" id="8654110">[</span><span class="op" id="8654111">]</span><span class="builtintype" id="8654112">string</span><span class="op" id="8654118">{</span><span class="string" id="8654119">&#34;joe2@example.com&#34;</span><span class="op" id="8654137">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8654140">return</span>&nbsp;<span class="ident" id="8654147">SendMail</span><span class="op" id="8654155">(</span><span class="ident" id="8654156">hostPort</span><span class="op" id="8654164">,</span>&nbsp;<span class="ident" id="8654166">auth</span><span class="op" id="8654170">,</span>&nbsp;<span class="ident" id="8654172">from</span><span class="op" id="8654176">,</span>&nbsp;<span class="ident" id="8654178">to</span><span class="op" id="8654180">,</span>&nbsp;<span class="op" id="8654182">[</span><span class="op" id="8654183">]</span><span class="builtintype" id="8654184">byte</span><span class="op" id="8654188">(</span><span class="string" id="8654189">&#34;Subject:&nbsp;test\n\nhowdy!&#34;</span><span class="op" id="8654214">)</span><span class="op" id="8654215">)</span><br>
<span class="lineno"></span><span class="op" id="8654217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8654220">//&nbsp;(copied&nbsp;from&nbsp;net/http/httptest)</span><br>
<span class="lineno"></span><span class="comment" id="8654255">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno">670</span><span class="comment" id="8654311">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno"></span><span class="comment" id="8654384">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="8654403">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="8654437">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="8654573">var</span>&nbsp;<span class="ident" id="8654577">localhostCert</span>&nbsp;<span class="op" id="8654591">=</span>&nbsp;<span class="op" id="8654593">[</span><span class="op" id="8654594">]</span><span class="builtintype" id="8654595">byte</span><span class="op" id="8654599">(</span><span class="string" id="8654600">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno">675</span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno"></span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno">680</span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno"></span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="8655171">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span><span class="comment" id="8655174">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno"></span><span class="keyword" id="8655228">var</span>&nbsp;<span class="ident" id="8655232">localhostKey</span>&nbsp;<span class="op" id="8655245">=</span>&nbsp;<span class="op" id="8655247">[</span><span class="op" id="8655248">]</span><span class="builtintype" id="8655249">byte</span><span class="op" id="8655253">(</span><span class="string" id="8655254">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno">690</span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno"></span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="8655752">)</span>
</div>
</body>
</html>
